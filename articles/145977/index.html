<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Groovy and AST Transformations on Application Security Service</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 We develop a small portal on Grails and use Spring Security to manage security. The spring-security plugin for Grails is quite convenient...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Groovy and AST Transformations on Application Security Service</h1><div class="post__text post__text-html js-mediator-article"><h4>  Prehistory </h4><br>  We develop a small portal on Grails and use Spring Security to manage security.  The spring-security plugin for Grails is quite convenient and until the last moment it did not require sophisticated functionality. <br><br>  An embarrassing moment has recently been discovered in using @Secured annotations for Grails controller methods.  The problem is that annotations are processed at runtime and are converted into rules for addresses ‚ÄúAddress -&gt; Required Roles‚Äù.  Such an approach causes a number of problems in Grails controllers in the data saving / deleting actions, since they send data to the controller's main URL, you have to first annotate the controller, and secondly, it is impossible to set various restrictions for such requests. <br><br>  It will be about how to solve the problem and get a good tool for managing safety rules. <br><a name="habracut"></a><br><h4>  Possible solutions </h4><br>  I don‚Äôt understand why the developers of the Grails plugin acted so carelessly about users, it‚Äôs probably just easier for them. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Alternative solutions: <br><ul><li>  AOP for controllers (difficult to configure a large number of rules) </li><li>  Bytecode generation from annotations at compile time </li></ul><br>  The second approach is unpleasant to implement in Java, since the assembly steps need to be organized.  But not in Groovy.  In Groovy, Meta programming or AST (Abastract Syntax Tree) Transformations are used for such purposes. <br><br>  We will not consider meta-programming for filtering requests to controllers, since this is more like a hack than a stable solution. <br><br><h4>  Transformations </h4><br>  Transformations are widely used in Grails, for example, to add id and version fields to model classes.  We will use them to filter calls to controller methods. <br><br>  Transformation is a simple Java class that implements the ASTTransformation interface and annotated @GroovyASTTransformation, which contains only one visit method - and in fact is a typical representative of the Visitor pattern.  For transformation, you can set the compilation phase at which it is applied.  And to select the nodes that come to the visitor, an annotation class annotated by GroovyASTTransformationClass is required.  As a result, the transformation changes the syntax tree, can add / change / delete nodes, affecting the resulting byte code. <br><br>  Total we need some annotation and transformation class.  For simplicity, let's call them @SuperSecured and SuperSecuredTransformation. <br><br>  The annotation contains in the value an array of strings ‚Äî the necessary roles for accessing the method. <br>  @Retention (RetentionPolicy.SOURCE) indicates that the summary will not be present in the resulting bytecode. <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.example; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.transform.GroovyASTTransformationClass; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.annotation.*; <span class="hljs-meta"><span class="hljs-meta">@Target</span></span>({ElementType.METHOD}) <span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RetentionPolicy.SOURCE) <span class="hljs-meta"><span class="hljs-meta">@GroovyASTTransformationClass</span></span>(<span class="hljs-string"><span class="hljs-string">"com.example.SuperSecuredTransformation"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> SuperSecured { String[] value() <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> {}; }</code> </pre> <br><br>  Transformation: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.example; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.expr.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.stmt.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.control.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.transform.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-meta"><span class="hljs-meta">@GroovyASTTransformation</span></span>(phase = CompilePhase.SEMANTIC_ANALYSIS) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SuperSecuredTransformation</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ASTTransformation</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ASTNode[] astNodes, SourceUnit sourceUnit)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (astNodes != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (ASTNode node : astNodes) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> MethodNode) { MethodNode methodNode = (MethodNode) node; List&lt;AnnotationNode&gt; annotations = methodNode.getAnnotations(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassNode(SuperSecured.class)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (annotations != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; !annotations.isEmpty()) { injectRolesCheck(methodNode, annotations); } } } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">injectRolesCheck</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MethodNode method, List&lt;AnnotationNode&gt; annotations)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (AnnotationNode annotationNode : annotations) { BlockStatement code = (BlockStatement) method.getCode(); Expression rolesValue = annotationNode.getMember(<span class="hljs-string"><span class="hljs-string">"value"</span></span>); Expression checkRolesExpression = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StaticMethodCallExpression( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassNode(SuperSecuredInspector.class), <span class="hljs-string"><span class="hljs-string">"rejectByRoles"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentListExpression( rolesValue ) ); code.getStatements().add(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExpressionStatement(checkRolesExpression)); } } }</code> </pre><br>  The following happened: the transformation takes the syntax tree nodes annotated as @SuperSecured and, if it is a method, adds to the beginning a call to the static method SuperSecuredInspector.rejectByRoles with a list of roles in the annotation value.  This method throws an AccessDeniedException exception if the current user does not satisfy the security conditions. <br><br>  To use such annotations in the end is a pleasure. <br><br><h4>  Conclusion </h4><br>  This approach allows you to select complex rules of access to objects and not duplicate them in the code.  Annotations are quite expressive, and code generation is statically typed, which allows to avoid errors during execution. <br><br>  Transformations are a worthy alternative to Groovy AOP. <br><br><h4>  Links </h4><br><ul><li>  <a href="http://groovy.codehaus.org/Annotations%2Bwith%2BGroovy">Annotations with Groovy</a> </li><li>  <a href="http://groovy.codehaus.org/Local%2BAST%2BTransformations">Local AST Transformations</a> </li></ul><br><br>  PS Habra-developers, please fix the display of the @ sign in the source tag. </div><p>Source: <a href="https://habr.com/ru/post/145977/">https://habr.com/ru/post/145977/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145970/index.html">A simple site with the possibility of authorization on node.js</a></li>
<li><a href="../145971/index.html">Circos Review: The Circle Is Good</a></li>
<li><a href="../145972/index.html">WikiWars: Wikipedia Search Fights</a></li>
<li><a href="../145973/index.html">Stream radio or police wave online</a></li>
<li><a href="../145974/index.html">Testing: Manual or Automated?</a></li>
<li><a href="../145980/index.html">Setting up a correct shutdown of guest Windows 2003 in qemu-kvm Linux</a></li>
<li><a href="../145981/index.html">Does your VDS / VPS / Dedicated hoster alert you about reboots and shutdowns?</a></li>
<li><a href="../145982/index.html">Trigger Timer for Nikon</a></li>
<li><a href="../145983/index.html">In Scotland, plan to create an underwater power plant</a></li>
<li><a href="../145984/index.html">Wind noise can also be "copyright material"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>