<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JSR 133 (Java Memory Model) FAQ (translation)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 
 As part of the recruitment course for ‚ÄúMulticore programming in Java‚Äù, I am doing a series of translations of classic articles on multithr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JSR 133 (Java Memory Model) FAQ (translation)</h1><div class="post__text post__text-html js-mediator-article">  Good day. <br>  As part of the recruitment course for <a href="http://habrahabr.ru/company/golovachcourses/blog/217051/">‚ÄúMulticore programming in Java‚Äù,</a> I am doing a series of translations of classic articles on multithreading in Java.  Every study of multithreading should begin with an introduction to the Java memory model (New JMM), the main source from the authors of the model is <a href="http://www.cs.umd.edu/~pugh/java/memoryModel/">‚ÄúThe Java Memory Model‚Äù home page</a> , where it is proposed to get acquainted with the <a href="http://www.cs.umd.edu/~pugh/java/memoryModel/jsr-133-faq.html">JSR 133 (Java Memory Model) FAQ</a> .  That's with the translation of this article, I decided to start the series. <br>  I allowed myself a few inserts "from myself", which, in my opinion, clarify the situation. <br>  I am an expert in Java and multithreading, not a philologist or translator, therefore I allow certain liberties or reformulations during translation.  In case you offer the best option, I‚Äôm happy to edit it. <br>  This article is also suitable as an educational material for the lecture <a href="http://habrahabr.ru/company/golovachcourses/blog/218841/">‚ÄúLecture # 5.2: JMM (volatile, final, synchronized)‚Äù</a> . <br><br>  I also teach <a href="https://www.udemy.com/scala-for-java-developers-ru/%3FcouponCode%3DHABR-JSR133-FAQ">Scala for Java Developers</a> on the udemy.com online education platform (equivalent to Coursera / EdX). <br><br>  Well, yes, come to study with me! <br><hr><br><h4>  JSR 133 (Java Memory Model) FAQ </h4><br>  Jeremy Manson and Brian Goetz, February 2004 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Content: <br>  <a href="https://habr.com/ru/company/golovachcourses/blog/221133/">What is a memory model, after all?</a> <br>  <a href="https://habr.com/ru/company/golovachcourses/blog/221133/">Do other languages ‚Äã‚Äãlike C ++ have a memory model?</a> <br>  <a href="https://habr.com/ru/company/golovachcourses/blog/221133/">What is JSR 133?</a> <br>  <a href="https://habr.com/ru/company/golovachcourses/blog/221133/">What is meant by ‚Äúreordering‚Äù?</a> <br>  <a href="https://habr.com/ru/company/golovachcourses/blog/221133/">What was wrong with the old memory model?</a> <br>  <a href="https://habr.com/ru/company/golovachcourses/blog/221133/">What do you mean by "incorrectly synchronized"?</a> <br>  <a href="https://habr.com/ru/company/golovachcourses/blog/221133/">What does synchronization do?</a> <br>  <a href="https://habr.com/ru/company/golovachcourses/blog/221133/">How can it happen that the final fields change values?</a> <br>  <a href="https://habr.com/ru/company/golovachcourses/blog/221133/">How do the final fields work under the new JMM?</a> <br>  <a href="https://habr.com/ru/company/golovachcourses/blog/221133/">What does volatile do?</a> <br>  <a href="https://habr.com/ru/company/golovachcourses/blog/221133/">Has the new memory model "double-checked locking" solved the problem?</a> <br>  <a href="https://habr.com/ru/company/golovachcourses/blog/221133/">What if I write a virtual machine?</a> <br>  <a href="https://habr.com/ru/company/golovachcourses/blog/221133/">Why should I worry?</a> <br><a name="habracut"></a><br><a name="1"></a><br><h4>  What is a memory model, after all? </h4><br>  In multiprocessor systems, processors usually have one or more cache layers, which improves performance by either speeding up data access (because the data is closer to the processor) or by reducing traffic on the shared memory bus (since many memory operations can be satisfied with local caches.) Caches can dramatically improve performance, but their use throws many new challenges.  What, for example, happens when two processors view the same memory cell at the same time?  Under what conditions will they see the same values? <br><br>  At the processor level, the memory model defines the necessary and sufficient conditions to ensure that the other processors' memory records are visible to the current processor, and the current processor's records are visible to other processors.  Some processors demonstrate a strong memory model, where all processors always see exactly the same values ‚Äã‚Äãfor any given memory location.  Other processors demonstrate a weaker memory model, where special instructions, called memory barriers, are required to ‚Äúflush‚Äù or invalidate data in the processor‚Äôs local cache in order to make the processor‚Äôs records visible to others or to see the records made other processors.  These memory barriers are usually executed when locking (lock) and releasing (unlock) the lock;  they are invisible to programmers in high-level languages. <br><br>  Sometimes it is easier to write programs for strong memory models, because of the reduced need for barriers.  However, even on the strongest memory models, barriers are often necessary;  quite often their placement is contrary to intuition.  Recent processor design trends encourage weaker memory models, because the cuts that they make to cache consistency provide increased scalability across multiple processors and large amounts of memory. <br><br>  The question of when a record becomes visible to another thread is compounded by the reordering of instructions by the compiler.  For example, the compiler may decide that it is more efficient to move the write operation further in the program;  as long as moving the code does not change the semantics of the program, he can do it freely.  If the compiler delays the operation, the other thread will not see until it is implemented;  This demonstrates the effect of caching. <br><br>  In addition, an entry in memory can be moved earlier in the program;  in this case, other threads may see the recording before it actually "happens."  All this flexibility is a design feature ‚Äî by giving the compiler, runtime, and hardware the flexibility to perform operations in an optimal order within the memory model, we can achieve higher performance. <br><br>  A simple example of this can be seen in the following code snippet: <br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Reordering</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = <span class="hljs-number"><span class="hljs-number">0</span></span>, y = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { x = <span class="hljs-number"><span class="hljs-number">1</span></span>; y = <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reader</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> r1 = y; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> r2 = x; } }</code> </pre> <br><br>  Let's assume that this code is executed in two threads at the same time and reading 'y' returns a value of 2. Because this record is located after writing in 'x', the programmer may assume that reading 'x' should return value 1. However, writing The 'x' and 'y' may have been reordered.  If this was the case, then writing to 'y' could occur, then reading both variables, and only then writing to 'x'. The result is that r1 is 2, and r2 is 0. <br><div class="spoiler">  <b class="spoiler_title">Translator comment</b> <div class="spoiler_text">  It is assumed that in the same object the reader () method and the writer () method ‚Äúalmost simultaneously‚Äù are called from different streams. <br></div></div><br>  The Java memory model describes which behavior is legal in multi-threaded code and how threads can interact through memory.  It describes the relationships between variables in the program and the low-level details of storing and retrieving them to and from memory or registers in a real computer system.  The model defines it in such a way that it can be implemented correctly using a wide range of hardware and a wide variety of compiler optimizations. <br><br>  Java includes several language constructs, including volatile, final, and synchronized, which are intended to help the programmer to describe to the compiler the requirements for concurrency in the program.  The Java memory model defines volatile and synchronized behavior, and, more importantly, ensures that a correctly synchronized Java program works correctly on all processor architectures. <br><a name="2"></a><br><h4>  Do other languages ‚Äã‚Äãlike C ++ have a memory model? </h4><br>  Most other programming languages, such as C and C ++, were not designed with direct support for multithreading.  The protective measures that these languages ‚Äã‚Äãoffer against various types of reordering occurring in compilers and processors largely depend on the guarantees offered by the parallelization libraries used (for example, pthreads) used by the compiler and the platform on which the code is run. <br><div class="spoiler">  <b class="spoiler_title">Translator comment</b> <div class="spoiler_text">  Java has set the trend for introducing a memory model into a language specification and the latest C ++ standard <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2011/n3242.pdf">already has a memory model (Chapter 1.7, ‚ÄúThe C ++ Memory Model‚Äù)</a> .  It seems it is already in C11. <br></div></div><br><a name="3"></a><br><h4>  What is JSR 133? </h4><br>  Since 1997, several serious flaws have been discovered in the Java memory model, which is defined in chapter 17 of the language specification.  These flaws allowed shocking behavior (for example, changing the value of a final-field was allowed) and prevented the compiler from using typical optimizations. <br><div class="spoiler">  <b class="spoiler_title">Translator comment</b> <div class="spoiler_text">  The old memory model (Old JMM, before Java 5) was described exclusively in Chapter 17 of the ‚ÄúChapter 17. Threads and Locks‚Äù language specification. <br>  The new memory model (New JMM, starting with Java 5) is described both in Chapter 17 ‚ÄúChapter 17. Threads and Locks‚Äù in the language specification and is expanded in a separate document (JSR-133). <br>  <b><u>New jmm</u></b> <br><ul><li>  <a href="http://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html">Java Language Specification (Java SE 8 Edition), "Chapter 17. Threads and Locks"</a> </li><li>  <a href="http://docs.oracle.com/javase/specs/jls/se7/html/jls-17.html">Java Language Specification (Java SE 7 Edition), "Chapter 17. Threads and Locks"</a> </li><li>  <a href="http://docs.oracle.com/javase/specs/jls/se5.0/html/memory.html">Java Language Specification (Third Edition, Java SE 5.0 / SE 6), "Chapter 17. Threads and Locks"</a> </li><li>  <a href="http://www.cs.umd.edu/~pugh/java/memoryModel/jsr133.pdf">JSR-133: JavaTM Memory Model and Thread Specification, 2004</a> </li></ul>  <b><u>Old JMM:</u></b> <br><ul><li>  <a href="http://cs.au.dk/~mis/dOvs/javaspec/memory.doc.html">Java Language Specification (Second Edition, Java SE 2.0), "Chapter 17. Threads and Locks"</a> </li><li>  <a href="http://titanium.cs.berkeley.edu/doc/java-langspec-1.0/17.doc.html">Java Language Specification (First edition), "Chapter 17. Threads and Locks"</a> </li></ul><br></div></div><br>  The Java memory model was an ambitious project;  for the first time, a programming language specification attempted to include a memory model that can provide consistent semantics for parallelism among various processor architectures.  Unfortunately, defining a memory model that is both consistent and intuitive has proven to be much more difficult than expected.  JSR 133 defines a new memory model for Java that corrects the flaws of the previous model.  In order to do this, the semantics of final and volatile has been changed. <br><br>  A full description of the semantics is available at <a href="http://www.cs.umd.edu/users/pugh/java/memoryModel">http://www.cs.umd.edu/users/pugh/java/memoryModel</a> , but the formal description is not for the timid.  It is surprising and sobering when you find out how difficult such a simple concept as synchronization really is.  Fortunately, you do not need to understand all the details of formal semantics ‚Äî the goal of JSR 133 was to create a set of rules that provides an intuitive understanding of how volatile, synchronized, and final work. <br><div class="spoiler">  <b class="spoiler_title">Translator comment</b> <div class="spoiler_text">  The author gives a link to the ‚Äúhome page‚Äù of the Java Memory Model - the main source of information on the Internet. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Translator comment</b> <div class="spoiler_text">  Formal semantics makes <u>it possible</u> to calculate <u>all possible</u> scenarios for the behavior of an arbitrary, both correctly synchronized and incorrectly synchronized program. <br>  In this article, the details of the formal semantics will not be considered, only some intuitive description will be given. <br></div></div><br>  The objectives of JSR 133 include: <br><ul><li>  Preservation of existing security guarantees, such as type safety (type safety), as well as strengthening others.  For example, the values ‚Äã‚Äãof variables cannot appear ‚Äúout of thin air‚Äù: each value of a variable observed by any one stream must be a value that was recorded by some other stream. </li><li>  The semantics of correctly synchronized programs should be as simple and intuitive as possible. </li><li>  The semantics of incomplete or incorrectly synchronized programs should be defined so that potential security threats are minimized. </li><li>  Programmers should be able to confidently talk about how multi-threaded programs interact with memory. </li><li>  It should be possible to develop valid and high-performance JVMs over a wide range of popular hardware architectures. </li><li>  A new security guarantee of initialization must be provided.  If the object is properly constructed (there were no ‚Äúleaks‚Äù of references to it during construction), then all the threads that see the link to this object also without the need for synchronization will see the values ‚Äã‚Äãof the final-fields that were set in the constructor. </li><li>  There should be minimal impact on existing code. </li></ul><br><a name="4"></a><br><h4>  What is meant by ‚Äúreordering‚Äù? </h4><br>  There are a number of cases in which access to variables (fields of objects, static fields, and array elements) can be performed in a different order than specified in the program.  The compiler is free to arrange instructions for optimization.  Processors may execute instructions in a different order in some cases.  Data can be moved between registers, processor caches and RAM in a different order than specified in the program. <br><div class="spoiler">  <b class="spoiler_title">Translator comment</b> <div class="spoiler_text">  Further, the term <b>variables</b> will refer to the fields of objects, static fields and array elements. <br></div></div><br>  For example, if a thread writes in the 'a' field and then in the 'b' field and the value of 'b' does not depend on the value of 'a', then the compiler is free to change the order of these operations, and the cache has the right to flush the 'b' into RAM earlier than 'a'.  There are several potential sources of reordering, such as the compiler, JIT and cache memory. <br><br>  The compiler, runtime, and hardware allow for reordering of instructions while maintaining the illusion of how-if-serial (as-if-serial) semantics, which means that single-threaded programs should not observe the effects of reordering.  However, reordering may come into play in incorrectly synchronized multi-threaded programs, where one thread can observe the effects produced by other threads, and such programs may be able to detect that variables become visible to other threads in a different order than specified in source code. <br><br>  Most of the time, threads do not take into account what other threads are doing.  But when they need it, synchronization comes into play. <br><a name="5"></a><br><h4>  What was wrong with the old memory model? </h4><br>  There were several serious problems with the old memory model.  She was difficult to understand and therefore often violated.  For example, the old model in many cases did not allow many types of reordering, which were implemented in each JVM.  This confusion with the meaning of the old model led to the fact that they were forced to create a JSR-133. <br><br>  It was widely believed that when using the final-field there was no need for synchronization between the threads to ensure that the other stream would see the value of the field.  Although this is a reasonable assumption about rational behavior, and indeed we would like everything to work that way, but under the old memory model, this was simply not true.  Nothing in the old memory model distinguishes the final-field from any other data in memory ‚Äî this means that synchronization was the only way to ensure that all threads see the value of the final-field written in the constructor.  As a result, it was possible that you would see the default value of the field, and then after a while you would see the assigned value.  This means, for example, that immutable objects, such as strings, can change their value ‚Äî a disturbing perspective. <br><div class="spoiler">  <b class="spoiler_title">Translator comment</b> <div class="spoiler_text">  An example of strings will be explained in detail below. </div></div><br>  The old memory model made it possible to change the order between writing to volatile and reading / writing normal variables, which is inconsistent with most developers' understanding of volatile and therefore confusing. <br><div class="spoiler">  <b class="spoiler_title">Translator comment</b> <div class="spoiler_text">  Below are examples with volatile </div></div><br>  Finally, the assumptions of programmers about what can happen if their programs are incorrectly synchronized are often erroneous.  One of the goals of JSR-133 is to pay attention to this fact. <br><a name="6"></a><br><h4>  What do you mean by "incorrectly synchronized"? </h4><br>  By incorrectly synchronized code, different people mean different things.  When we talk about incorrectly synchronized code in the context of the Java memory model, we mean any code in which: <br><ol><li>  there is a variable record in one stream, </li><li>  there is a reading of the same variable by another thread and </li><li>  read and write are not ordered by synchronization (are not ordered by synchronization) </li></ol><br>  When this happens, we say that there is a data race on this variable.  Programs with race streams are incorrectly synchronized programs. <br><div class="spoiler">  <b class="spoiler_title">Translator comment</b> <div class="spoiler_text">  We must understand that incorrectly synchronized programs are not Absolute Evil.  Although their behavior is non-deterministic, all possible scenarios are fully described in JSR-133.  These behaviors are often non-intuitive.  The search for all possible results is algorithmically very complicated and relies, among other things, on such new concepts as the commitment protocol and causality loops. <br>  But in some cases, the use of incorrectly synchronized programs seems to be justified.  As an example, it suffices to give an implementation of java.lang.String.hashCode () <br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Comparable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CharSequence</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** Cache the hash code for the string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> hash; <span class="hljs-comment"><span class="hljs-comment">// Default to 0 ... public int hashCode() { int h = hash; if (h == 0 &amp;&amp; count &gt; 0) { ... hash = h; } return h; } ... }</span></span></code> </pre><br>  When the hashCode () method is called, one instance of java.lang.String from different streams will have a data race across the hash field. <br><br>  Interesting article Hans-J.  Boehm, <a href="http://www.hpl.hp.com/techreports/2012/HPL-2012-218.pdf">"Nondeterminism is unavoidable, but data races are pure evil"</a> <br>  And its discussion in Russian <br>  Ruslan Cheremin, <a href="http://cheremin.blogspot.com/2013/07/data-races-is-pure-evil.html">"Data races is pure evil"</a> <br></div></div><br><a name="7"></a><br><h4>  What does synchronization do? </h4><br>  Synchronization has several aspects.  The most well understood is mutual exclusion - only one thread can own the monitor, so synchronization on the monitor means that as soon as one stream enters the synchronized block protected by the monitor, no other stream can enter the block protected by this monitor until the first thread exits the synchronized block. <br><br>  But synchronization is more than just mutual exclusion.  Synchronization ensures that data stored in memory before or in a synchronized block becomes predictably visible to other threads that are synchronized on the same monitor.  After we exit the synchronized block, we release the monitor, which has the effect of flushing the cache into RAM, so the recordings made by our stream may be visible to other threads.  Before we can enter the synchronized block, we capture (asquire) the monitor, which has the effect of invalidating the local processor cache data, so the variables will be loaded from the main memory.  Then we will be able to see all the records made visible by the previous release of the monitor. <br><br>  Discussing the situation in terms of caches, it may seem that these issues affect only multiprocessor machines.  However, the effects of reordering can easily be seen on a single processor.  The compiler cannot move your code until the monitor is captured or after it is released.  When we say that capturing and releasing monitors affects caches, we use an abbreviation for a number of possible effects. <br><br>  The semantics of the new model of memory imposes a partial order on memory operations (reading a field, writing a field, locking a lock (lock), releasing a lock (unlock)) and other operations with threads (start (), join ()).  Some actions, as they say, ‚Äúoccur before‚Äù (happens before) others.  When one action ‚Äúhappens before‚Äù (happens before) another, the first will be guaranteed to be located before and visible to the second.  The rules for this ordering are: <br><div class="spoiler">  <b class="spoiler_title">Translator comment</b> <div class="spoiler_text">  <a href="http://ru.wikipedia.org/wiki/%25D0%259E%25D1%2582%25D0%25BD%25D0%25BE%25D1%2588%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25BF%25D0%25BE%25D1%2580%25D1%258F%25D0%25B4%25D0%25BA%25D0%25B0">Partial order</a> is not a turn of speech, but a mathematical concept. </div></div><br><ol><li>  Each action in the stream ‚Äúhappens before‚Äù (happens before) any other action in this stream that goes ‚Äúbelow‚Äù in the code of this stream. </li><li>  The release of the monitor ‚Äúhappens before‚Äù (happens before) each subsequent capture of <b>the same monitor</b> . </li><li>  Writing to the volatile-field occurs ‚Äúhappens before‚Äù (happens before) each subsequent reading of <b>the same volatile-field</b> . </li><li>  Calling the start () method of the thread ‚Äúhappens before‚Äù (happens before) any actions in the launched thread. </li><li>  All actions in the stream ‚Äúoccur before‚Äù (happens before) any actions of any other stream that successfully completed the wait on join () on the first thread. </li></ol><br>  This means that any memory operations that were visible in the stream before exiting the synchronized block are visible to any other stream after it enters the synchronized block protected by the same monitor, since all memory operations "will occur before" the monitor is released , and the release of the monitor "occurs before" capture. <br><div class="spoiler">  <b class="spoiler_title">Translator comment</b> <div class="spoiler_text">  This program (data - volatile, run - volatile) is guaranteed to stop and print 1 And in the old And in the new memory models <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> data = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> boolean run = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { data = <span class="hljs-number"><span class="hljs-number">1</span></span>; run = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }).start(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (run) {<span class="hljs-comment"><span class="hljs-comment">/*NOP*/</span></span>}; System.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(data); } }</code> </pre><br><br>  This program (data - NOT volatile, run - volatile) is guaranteed to stop And in the old And in the new memory model, but in the old it can print both 0 and 1, and in the new one it will guarantee 1. This is due to the fact that in the new memory model It is possible to ‚Äúraise‚Äù an entry in non-volatile, ‚Äúhigher‚Äù entries in volatile, but not ‚Äúlower down‚Äù.  And in the old one it was possible to both ‚Äúraise‚Äù and ‚Äúlower down‚Äù. <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> data = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> boolean run = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { data = <span class="hljs-number"><span class="hljs-number">1</span></span>; run = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }).start(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (run) {<span class="hljs-comment"><span class="hljs-comment">/*NOP*/</span></span>}; System.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(data); } }</code> </pre><br><br>  This program (data - volatile, run - NOT volatile) can either stop or not in both models.  In the case of a stop, it can print both 0 and 1 in both the old and new memory models.  This is due to the fact that in both models it is possible to ‚Äúraise‚Äù an entry in the non-volatile above the entry in the volatile. <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> data = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> boolean run = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { data = <span class="hljs-number"><span class="hljs-number">1</span></span>; run = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }).start(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (run) {<span class="hljs-comment"><span class="hljs-comment">/*NOP*/</span></span>}; System.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(data); } }</code> </pre><br><br>  This program (data - NOT volatile, run - NOT volatile) may or may not stop in both models.  In the case of a stop, it can print both 0 and 1 in both the old and new memory models. <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> data = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> boolean run = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { data = <span class="hljs-number"><span class="hljs-number">1</span></span>; run = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }).start(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (run) {<span class="hljs-comment"><span class="hljs-comment">/*NOP*/</span></span>}; System.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(data); } }</code> </pre><br></div></div><br>  Another consequence is that the following pattern, which some people use to install a memory barrier, does not work: <br><pre> <code class="hljs pgsql">synchronized (<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Object</span></span>()) {}</code> </pre><br>  This construction is actually a ‚Äúdummy‚Äù (no-op), and your compiler can delete it completely, because the compiler knows that no other stream will be synchronized on the same monitor.  You must establish a ‚Äúgoing before‚Äù relationship for one thread to see the results of another. <br><br>  <b>Important note</b> : Please note that it is important for both streams to synchronize on the same monitor in order to establish the relationship ‚Äúhappens before‚Äù properly.  This is not the case when everything visible to thread A, when it is synchronized on object X, becomes visible to stream B after it synchronizes on object Y. Release and capture must ‚Äúmatch‚Äù (that is, be performed with the same monitor ) to ensure proper semantics.  Otherwise, the code contains a data race. <br><div class="spoiler">  <b class="spoiler_title">Translator comment</b> <div class="spoiler_text">  The next program can either stop or not stop within the framework of both memory models (since monitors of various objects are captured and released in different threads - lockA / lockB) <br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Object lockA = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Object lockB = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> run = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (lockA) { run = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } }).start(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (lockB) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!run) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } }</code> </pre><br></div></div><br><a name="8"></a><br><h4>  How can it happen that the final fields change values? </h4><br>  One of the best examples of how final-field values ‚Äã‚Äãcan change includes one specific implementation of the String class. <br><br>  A string can be implemented as an object with three fields ‚Äî an array of characters, an offset in this array, and a length.  The reason for choosing a String implementation in this way instead of being implemented as a single char [] type field may be that it allows several strings and StringBuffer objects to share the same character array and avoid additional object allocation and memory copying.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, for example, the String.substring () method can be implemented by creating a new string that shares the same array of characters with the original string and is simply distinguished by the length and offset fields. </font><font style="vertical-align: inherit;">String has all three fields - final.</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Translator comment</font></font></b> <div class="spoiler_text">  update 6  JRE 7  Oracle java.lang.String    <br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Comparable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CharSequence</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[] value; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> offset; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>; .... }</code> </pre><br>    update 6  JRE 7  Oracle java.lang.String     (  offset  count) <br>      <a href="http://habrahabr.ru/post/218961/"></a> .      ,   ¬´¬ª   value   ¬´  ¬ª (   ).    : <br> 1.      null,   value ‚Äî  null <br> 2.      null,  value   null,     char[] value   char-,   0-. <br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Translator comment</font></font></b> <div class="spoiler_text">  ‚Äî   String.substring(),         char[] value <br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Comparable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CharSequence</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[] value; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> offset; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String substring(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> beginIndex, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> endIndex) { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String(offset + beginIndex, endIndex - beginIndex, value); } .... }</code> </pre><br><br>  ‚Äî   StringBuffer.toString(),    String    StringBuffer   char[] value <br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractStringBuilder</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Appendable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CharSequence</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[] value; ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StringBuffer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractStringBuilder</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CharSequence</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[] value; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> offset; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> synchronized String toString() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String(value, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>); } .... }</code> </pre><br></div></div><br><pre> <code class="hljs vbscript"><span class="hljs-built_in"><span class="hljs-built_in">String</span></span> s1 = <span class="hljs-string"><span class="hljs-string">"/usr/tmp"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> s2 = s1.substring(<span class="hljs-number"><span class="hljs-number">4</span></span>);</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Line s2 will have an offset (offset) of 4 and a length (length) of 4. But within the old memory model, it was possible for another thread to see the default value of the offset (offset) (0), and later see the correct value of 4. It will seem as if the string "/ usr" has changed to "/ tmp". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The original memory model allowed this behavior and some JVMs demonstrated it. </font><font style="vertical-align: inherit;">The new memory model prohibits it.</font></font><br><a name="9"></a><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How do final-fields work with a new memory model? </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Values ‚Äã‚Äãfor the object's final-fields are specified in the constructor. </font><font style="vertical-align: inherit;">If we assume that the object is built ‚Äúcorrectly‚Äù, then as soon as the object is built, the values ‚Äã‚Äãassigned to the final-fields in the constructor will be visible to all other threads without synchronization. </font><font style="vertical-align: inherit;">In addition, the visible values ‚Äã‚Äãfor any other object or array referenced by these final-fields will be at least as ‚Äúfresh‚Äù as the values ‚Äã‚Äãof the final-fields.</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Translator comment</font></font></b> <div class="spoiler_text">   final-     <b> </b> . <br>  So <br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> k; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">App10</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> k)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.k = k; } }</code> </pre><br>   <br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> k; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.k = <span class="hljs-number"><span class="hljs-number">42</span></span>; } }</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Translator comment</font></font></b> <div class="spoiler_text">     ,     ( instance ‚Äî volatile,    ).   ,    "[1, 2]" <br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Arrays; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] data; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">App</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[]{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>}; } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> App instance; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> App(); } }).start(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (instance == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {<span class="hljs-comment"><span class="hljs-comment">/*NOP*/</span></span>} System.out.println(Arrays.toString(instance.data)); } }</code> </pre><br><br>       ,    .   ,    <b> "[1, 0]"   "[1, 2]"</b> .    ,      1  <b></b>   final-. <br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Arrays; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] data; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">App</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[]{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> App instance; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> App(); } }).start(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (instance == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {<span class="hljs-comment"><span class="hljs-comment">/*NOP*/</span></span>} System.out.println(Arrays.toString(instance.data)); } }</code> </pre><br><br>          ,    .   ,    "[1, 2]".       1  <b></b>   final-. <br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Arrays; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] data; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">App</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] tmp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[]{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>}; tmp[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data = tmp; } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> App instance; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> App(); } }).start(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (instance == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {<span class="hljs-comment"><span class="hljs-comment">/*NOP*/</span></span>} System.out.println(Arrays.toString(instance.data)); } }</code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What does it mean for an object to be ‚Äúproperly built‚Äù? </font><font style="vertical-align: inherit;">This simply means that the reference to the object ‚Äúdoes not leak‚Äù until the end of the instance building process (see </font></font><a href="https://www.ibm.com/developerworks/library/j-jtp0618/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Safe Construction Techniques</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for examples).</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Translator comment</font></font></b> <div class="spoiler_text">       (  ): <a href="https://www.ibm.com/developerworks/ru/library/j-jtp0618/">¬´  ¬ª</a> . </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In other words, do not place a link to an object under construction at any place in which another thread can see it. </font><font style="vertical-align: inherit;">Do not assign it to a static field, do not register the object as a listener in any other object, and so on. </font><font style="vertical-align: inherit;">These tasks must be done upon completion of the constructor (outside the constructor, after its call), not in it.</font></font><br><pre> <code class="hljs java"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FinalFieldExample</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> FinalFieldExample f; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FinalFieldExample</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ x = <span class="hljs-number"><span class="hljs-number">3</span></span>; y = <span class="hljs-number"><span class="hljs-number">4</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ f = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FinalFieldExample(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (f != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = fx; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = fy; } } }</code> </pre><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Translator comment</font></font></b> <div class="spoiler_text"> ,    reader()  writer()   ¬´ ¬ª   . </div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This class is an example of how final-fields should be used. </font><font style="vertical-align: inherit;">The thread calling the reader () method is guaranteed to read 3 into fx, since this is a final field. </font><font style="vertical-align: inherit;">But there is no guarantee that it will read 4 in y, since it is a non-final-field. </font><font style="vertical-align: inherit;">If the constructor for the FinalFieldExample class looked like this:</font></font><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> FinalFieldExample() { // bad! x = <span class="hljs-number"><span class="hljs-number">3</span></span>; y = <span class="hljs-number"><span class="hljs-number">4</span></span>; // bad construction - allowing this <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">escape</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span>.obj = this; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">then there is no guarantee that the thread reading the link to this object from global.obj will read 3 of x. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The ability to see a properly constructed value for a field is good, but if the field itself is a link, then you also want your code to see the ‚Äúfresh‚Äù value in the referenced object (or array). You get this guarantee if your field is final. Thus, you can have a final-link to an array and not worry that other threads will see the correct value for the link to the array, but incorrect values ‚Äã‚Äãfor the content of the array. Again, by ‚Äúcorrect‚Äù here, we mean ‚Äúat the time of the end of the object constructor‚Äù, and not ‚Äúthe last saved value‚Äù.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After all of the above, I want to make the remark that even after constructing an immutable object (an object containing only final-fields), if you want to make sure that all other threads see your link, you still need to use synchronization. </font><font style="vertical-align: inherit;">There is no other way to ensure that a reference to an immutable object is visible in another thread. </font><font style="vertical-align: inherit;">The guarantees received by your code from using final-fields should be deeply and carefully aligned with an understanding of how you deal with concurrency in your code. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you use JNI to modify the final-field, then the behavior is undefined.</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Translator comment</font></font></b> <div class="spoiler_text">   ,         Reflection API. </div></div><br><a name="10"></a><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> What does volatile do? </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">volatile-fields are special fields that are used to transfer state between threads. Each read from volatile will return the result of the last write by any other stream; in fact, they are specified by the programmer as fields for which it is not acceptable to see the ‚Äústale‚Äù value as a result of caching or reordering. The compiler and runtime environment are prohibited from placing them in registers. They also need to make sure that after writing to volatile, data is ‚Äúpushed‚Äù (flushed) from the cache to main memory, so they are immediately visible to other threads. Similarly, before reading the volatile-field, the cache must be freed, so that we will see the value in the RAM, and not in the cache. There are also additional restrictions on changing the order in which volatile variables are accessed.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With the old memory model, access to volatile variables could not be reordered with each other, but they could be reordered with non-volatile variables. This negated the usefulness of volatile fields as a means of transmitting a signal from one stream to another.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">According to the new memory model, it is still true that volatile variables cannot be reordered with each other. </font><font style="vertical-align: inherit;">The difference is that now it‚Äôs not so easy to change the order between regular fields located alongside volatile. </font><font style="vertical-align: inherit;">Writing to a volatile field has the same memory effect as a monitor release, and reading from a volatile field has the same memory effect as monitor acquire. </font><font style="vertical-align: inherit;">In essence, since the new model imposes more stringent restrictions on the reordering between access to volatile fields and other fields (volatile or normal), everything that was visible to flow A when he wrote in volatile f becomes visible to flow B, when he will read f.</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Translator comment</font></font></b> <div class="spoiler_text">              1 (data ‚Äî volatile, run ‚Äî volatile) <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> data = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> boolean run = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { data = <span class="hljs-number"><span class="hljs-number">1</span></span>; run = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }).start(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (run) {<span class="hljs-comment"><span class="hljs-comment">/*NOP*/</span></span>}; System.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(data); } }</code> </pre><br>           .      1,    0  1 (data ‚Äî  volatile, run ‚Äî volatile),        -volatile ¬´¬ª    volatile,    ‚Äî  <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> data = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> boolean run = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { data = <span class="hljs-number"><span class="hljs-number">1</span></span>; run = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }).start(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (run) {<span class="hljs-comment"><span class="hljs-comment">/*NOP*/</span></span>}; System.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(data); } }</code> </pre><br>             (run ‚Äî  volatile   ¬´¬ª  ).     ,     1,   0 (data ‚Äî  volatile, run ‚Äî  volatile),         -volatile  <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> data = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> boolean run = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { data = <span class="hljs-number"><span class="hljs-number">1</span></span>; run = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }).start(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (run) {<span class="hljs-comment"><span class="hljs-comment">/*NOP*/</span></span>}; System.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(data); } }</code> </pre><br>           .             (run ‚Äî  volatile   ¬´¬ª  ).           1 <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> data = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> boolean run = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { data = <span class="hljs-number"><span class="hljs-number">1</span></span>; run = (data != <span class="hljs-number"><span class="hljs-number">1</span></span>); } }).start(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (run) {<span class="hljs-comment"><span class="hljs-comment">/*NOP*/</span></span>}; System.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(data); } }</code> </pre><br>            .     ,     1,   0 (data ‚Äî volatile, run ‚Äî  volatile),       -volatile ¬´¬ª    volatile <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">App</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> data = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> boolean run = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { data = <span class="hljs-number"><span class="hljs-number">1</span></span>; run = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }).start(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (run) {<span class="hljs-comment"><span class="hljs-comment">/*NOP*/</span></span>}; System.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(data); } }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Here is a simple example of how volatile fields can be used. </font></font><br><pre> <code class="hljs java"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VolatileExample</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> v = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ x = <span class="hljs-number"><span class="hljs-number">42</span></span>; v = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//uses x - guaranteed to see 42. } } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's call one thread a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">writer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and the other a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reader</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Writing in v in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">writer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äúflushes‚Äù x data into RAM, and reading v ‚Äúcaptures‚Äù this value from memory. </font><font style="vertical-align: inherit;">Thus, if the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reader</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sees the true value of the v field, it is also guaranteed to see the value 42 in x. </font><font style="vertical-align: inherit;">This was not true for the old memory model (in the old one, it was possible to ‚Äúlower‚Äù the record in the non-volatile ‚Äúbelow‚Äù record in the volatile). </font><font style="vertical-align: inherit;">If v were not volatile, the compiler could change the writing order in the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">writer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reader</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> could see 0 in x.</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Translator comment</font></font></b> <div class="spoiler_text">       Joshua Bloch <a href="http://www.amazon.com/Effective-Java-Edition-Joshua-Bloch/dp/0321356683/">¬´Effective Java¬ª</a> 2nd edition (Item 66: Synchronize access to shared mutable data)      <a href="http://www.ozon.ru/context/detail/id/21724143/">¬´Java.  ¬ª</a> 1  ( 48.        ) </div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The semantics of volatile has been significantly enhanced, almost to the synchronized level. </font><font style="vertical-align: inherit;">Each volatile read or write acts as a ‚Äúhalf‚Äù synchronized in terms of visibility. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Important note:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Please note that it is important that both threads do a read-write on the same volatile variable in order to achieve a relationship happens before. </font><font style="vertical-align: inherit;">This is not the case when all that is visible to the stream A, when he writes a volatile-field f becomes visible to the stream B after he considers the volatile-field g. </font><font style="vertical-align: inherit;">Reading and writing must refer </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the same volatile variable</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in order to have proper semantics.</font></font><br><a name="11"></a><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Has the new memory model "double-checked locking" solved the problem? </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The (infamous) double-checked locking idiom (also called the multithreaded singleton pattern) is a trick designed to support lazy initialization in the absence of synchronization overhead. </font><font style="vertical-align: inherit;">In the earliest JVMs, synchronization was slow and the developers sought to remove it, perhaps too zealously. </font><font style="vertical-align: inherit;">Double-checked locking idiom looks like this:</font></font><br><pre> <code class="hljs haskell">// double-checked-locking - don't <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> this! private static <span class="hljs-type"><span class="hljs-type">Something</span></span> <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> = null; public <span class="hljs-type"><span class="hljs-type">Something</span></span> getInstance() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> == null) { synchronized (this) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> == null) <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> = new <span class="hljs-type"><span class="hljs-type">Something</span></span>(); } } return <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span>; }</code> </pre><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Translator comment</font></font></b> <div class="spoiler_text">      (    ,   ¬´ ¬ª  getInstance() ‚Äî ,        this) <br><pre> <code class="hljs haskell">// double-checked-locking - don't <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> this! public <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-type"><span class="hljs-type">Something</span></span> { private static <span class="hljs-type"><span class="hljs-type">Something</span></span> <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> = null; public static <span class="hljs-type"><span class="hljs-type">Something</span></span> getInstance() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> == null) { synchronized (<span class="hljs-type"><span class="hljs-type">Something</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> == null) <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> = new <span class="hljs-type"><span class="hljs-type">Something</span></span>(); } } return <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span>; } .... }</code> </pre><br>     <a href="http://c2.com/cgi/wiki%3FPrivateMutex">Private Mutex</a> <br><pre> <code class="hljs haskell">// double-checked-locking - don't <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> this! public <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-type"><span class="hljs-type">Something</span></span> { private static final <span class="hljs-type"><span class="hljs-type">Object</span></span> lock = new <span class="hljs-type"><span class="hljs-type">Object</span></span>(); private static <span class="hljs-type"><span class="hljs-type">Something</span></span> <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> = null; public static <span class="hljs-type"><span class="hljs-type">Something</span></span> getInstance() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> == null) { synchronized (lock) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> == null) <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> = new <span class="hljs-type"><span class="hljs-type">Something</span></span>(); } } return <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span>; } .... }</code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It looks awfully clever - we avoid syncing on the most frequent execution path. </font><font style="vertical-align: inherit;">There is only one problem with this - the idiom does not work.</font></font> Why?<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The most obvious reason is that the data record initializing the instance and writing the reference to the instance in a static field can be reordered by the compiler or cache, which will have the effect of returning something ‚Äúpartially constructed‚Äù. The result will be that we read an uninitialized object. There are many other reasons why both this idiom and algorithmic corrections to it are incorrect. There is no way to fix this in the old java memory model. More information can be found in </font></font><a href="http://www.javaworld.com/article/2074979/java-concurrency/double-checked-locking--clever--but-broken.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúDouble-checked locking: Clever, but broken‚Äù</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and then </font></font><a href="http://www.cs.umd.edu/~pugh/java/memoryModel/DoubleCheckedLocking.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúThe 'Double Checked Locking is broken' declaration‚Äù</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br>  ,     volatile   ,       double-checked-locking.     1.5, volatile       .      ,    volatile ¬´¬ª   double-checked-locking,      ¬´ ¬ª (happens before)   Something      . <br><br> <s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, for lovers of double-checked locking (and we really hope that they are not left), the news is still not very good. The whole point of double-checked locking was to avoid synchronization overhead. Not only is the short-term synchronization now MUCH cheaper than in Java 1.0, but also in the new memory model, the drop in performance when using volatile almost reached the level of synchronization cost. So there is still no good reason to use double-checked locking.</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Edited: volatile is cheap on most platforms. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instead, use the Initialization On Demand Holder idiom, which is safe and much easier to understand:</font></font><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LazySomethingHolder</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Something something = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Something(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Something </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LazySomethingHolder.something; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This code is guaranteed to be correct, which follows from the initialization guarantees for static fields; </font><font style="vertical-align: inherit;">if the field is set in a static initializer, it is guaranteed to make it correctly visible, for any stream that refers to this class.</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Translator comment</font></font></b> <div class="spoiler_text">      <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Something</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Something instance = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Something </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LazySomethingHolder.something; } .... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LazySomethingHolder</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Something something = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Something(); } }</code> </pre><br>     <br><ul><li>     LazySomethingHolder.something </li><li>    ¬´¬ª </li></ul><br>       ( <a href="http://docs.oracle.com/javase/specs/jls/se8/html/jls-12.html">¬´12.4.1. When Initialization Occurs¬ª</a> ): <br> A class or interface type T will be initialized immediately before the first occurrence of any one of the following: <br><ul><li>  ... </li><li> A static field declared by T is assigned. </li><li>  ... </li></ul><br> A class or interface will not be initialized under any other circumstance. <br><br>            <a href="http://docs.oracle.com/javase/specs/jls/se8/html/jls-12.html">¬´12.4.2. Detailed Initialization Procedure¬ª</a> . <br></div></div><br><a name="12"></a><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> What if I write a virtual machine? </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You should look at </font></font><a href="http://gee.cs.oswego.edu/dl/jmm/cookbook.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://gee.cs.oswego.edu/dl/jmm/cookbook.html</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><a name="13"></a><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Why should I worry? </font></font></h4><br>    ?     .      ,  ,           .      ,  ,     ;       ,   ,      . <br><hr><br><h4>  Contacts </h4><br><br>  I do Java online training (here <a href="http://golovachcourses.com/">are the programming courses</a> ) and publish some of the training materials as part of the reworking <a href="http://habrahabr.ru/company/golovachcourses/blog/218841/">of the Java Core course</a> .  You can see videos of lectures in the audience on the <a href="http://www.youtube.com/user/KharkovITCourses">youtube channel</a> , perhaps the video of the channel is better organized in <a href="http://habrahabr.ru/company/golovachcourses/blog/215275/">this article</a> . <br><br>  skype: GolovachCourses <br>  email: GolovachCourses@gmail.com </div><p>Source: <a href="https://habr.com/ru/post/221133/">https://habr.com/ru/post/221133/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../221117/index.html">Clash of Clans - mechanisms for monetizing game time</a></li>
<li><a href="../221119/index.html">Home Connect - one app for all brands</a></li>
<li><a href="../221121/index.html">Trends in online education</a></li>
<li><a href="../221123/index.html">Why do we need reflection in C ++ 1y</a></li>
<li><a href="../221129/index.html">EMET, prevention of operation and non-obvious settings</a></li>
<li><a href="../221135/index.html">Viewaide: now web service</a></li>
<li><a href="../221137/index.html">Genetic algorithms in faces</a></li>
<li><a href="../221139/index.html">Bad advice from the creators of the Yandex.Maps API. How to make everything so bad</a></li>
<li><a href="../221141/index.html">Torrent Updater - OS X Open Source program for checking new versions of .torrent files on popular trackers</a></li>
<li><a href="../221143/index.html">New Dedicated Server: Acceptance and Verification</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>