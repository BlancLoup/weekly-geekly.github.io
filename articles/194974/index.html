<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Django doesn't work the way you think</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When I read the list of buns that a framework provides for me, I imagine what they mean by about. When I read the documentation on the buns - I am con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Django doesn't work the way you think</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage3/489/75a/0e2/48975a0e203e4681cd0c999d4dcbb895.png" align="right"><br>  When I read the list of buns that a framework provides for me, I imagine what they mean by about.  When I read the documentation on the buns - I am convinced that everything in general is really the way I thought.  When I write code, I comprehend the dao.  Because everything is really not at all like that. <br><br>  Many of the mistakes that I made were due to the fact that <b>I was sure that it worked the way I thought</b> .  I believed in it and did not allow the possibility that it could be otherwise.  Of course, Captain Obvious will say that you do not need to believe - you need to read the documentation.  And we read, read, memorize, memorize.  Is it possible to keep all the little things in memory?  And is it right to shift them to the developer, and not to the framework? <br><br>  Well, in order not to be unfounded - let's move on to examples.  Waiting for us: <br><ol><li>  Undelete models that we remove </li><li>  Validated fields that are not validated </li><li>  Two admins that spoil the data </li></ol><br><a name="habracut"></a><br><h4>  1. Deleting objects in admin panel </h4><br>  Imagine that you have a model for which you want to override the delete method.  The simplest example is that you do not want the model with <code>name == 'Root'</code> be deleted.  The first thing that comes to mind is to simply override the delete () method for the desired model: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeModel</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> name = models.CharField(<span class="hljs-string"><span class="hljs-string">'name'</span></span>, max_length=<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.name == <span class="hljs-string"><span class="hljs-string">'Root'</span></span>: print(<span class="hljs-string"><span class="hljs-string">'No, man, i am not deletable! Give up!'</span></span>) <span class="hljs-comment"><span class="hljs-comment">#   "Root"    else: super(SomeModel, self).delete(*args, **kwargs) #    -   delete()</span></span></code> </pre><br>  Check? <br><br><img src="https://habrastorage.org/storage3/9d9/ffb/4de/9d9ffb4ded63f678cd98d61743b26ac5.jpg"><br><br>  Works!  And now let's do the same, but from the model list page: <br><br><img src="https://habrastorage.org/storage3/f35/19c/d8e/f3519cd8e318aacd0f618a7e366b6cb0.jpg"><br><br>  Delete () is not called, the model is deleted. <br>  <b>Is this described in the documentation?</b>  <a href="https://docs.djangoproject.com/en/1.5/ref/contrib/admin/actions/">Yes</a> <br>  <b>Why is this done?</b>  For efficiency. <br>  <b>Is this efficiency worth getting implicit behavior?</b>  Hardly. <br>  <b>What to do?</b>  For example, generally disable bulk deletion (from the model list page): <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeModelAdmin</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(admin.ModelAdmin)</span></span></span><span class="hljs-class">:</span></span> model = SomeModel <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_actions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, request)</span></span></span><span class="hljs-function">:</span></span> actions = super(self.__class__, self).get_actions(request) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'delete_selected'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> actions: <span class="hljs-keyword"><span class="hljs-keyword">del</span></span> actions[<span class="hljs-string"><span class="hljs-string">'delete_selected'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actions</code> </pre><br><br>  These were the first django-rakes that I stepped on.  And in every new project I have to keep this behavior in my head and not forget about it. <br><br><h4>  2. Validators </h4><br><blockquote>  A validator is a function that takes a value in throws a ValidationError if the value does not match by some criterion.  Validators can be useful if you need to reuse some kind of check on different types of fields. </blockquote><br>  For example, checking a field against a regular expression: <a href="https://docs.djangoproject.com/en/1.5/ref/validators/">RegexValidator</a> . <br>  Let's allow only letters in the <code>name</code> field: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeModel</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> name = models.CharField(<span class="hljs-string"><span class="hljs-string">'name'</span></span>, max_length=<span class="hljs-number"><span class="hljs-number">100</span></span>, validators=[RegexValidator(regex=<span class="hljs-string"><span class="hljs-string">r'^[a-zA-Z]+$'</span></span>)])</code> </pre><br><img src="https://habrastorage.org/storage3/3cb/8f3/63b/3cb8f363b30a96f3ccd0c74df06e117d.jpg"><br><br>  In the admin validation works.  And if so: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># views.py def main(request): new_model = SomeModel.objects.create(name='Whatever you want: 1, 2, 3, etc. Either #&amp;*@^%!)(_') return render( request, 'app/main.html', { 'new_model': new_model, } )</span></span></code> </pre><br>  Through create () you can specify any name, and <u>validation is not called</u> . <br><br>  <b>Is this described in the documentation?</b>  <a href="https://docs.djangoproject.com/en/1.5/ref/validators/">Yes.</a> <br><blockquote>  Note that validators will not be automatically called when the model is saved, but if you use ModelForm, your validators will work for the fields that are included in the form. </blockquote><br>  <b>Is this obvious?</b>  I honestly tried to imagine a situation where I need to validate a field in a form, but not validate it in other cases.  And I have no ideas.  It is more logical to make a validation for the global field - that is, if it is specified that only letters are, then everything, the enemy will not pass, no pasaran - in no way can this be circumvented.  If you want to remove such a restriction, override model.save () and disable validation in necessary cases. <br>  <b>What to do?</b>  Call validation explicitly before saving: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@receiver(pre_save, sender=SomeModel) def validate_some_model(instance, **kwargs): instance.full_clean()</span></span></code> </pre><br><br><h4>  3. Two admins </h4><br>  Misha and Petya adminyat site.  After the thousandth record, Misha left the form for editing the record # 1001 (‚ÄúWhat is the meaning of life‚Äù) and left to drink tea.  At this time, Peter opened the same record # 1001 and renamed it (‚ÄúThere is no meaning‚Äù).  Misha returned (the ‚Äúold‚Äù post ‚ÄúWhat is the meaning of life‚Äù is still open) and clicked ‚ÄúSave‚Äù.  Petya's works are stuck. <br><br>  This is called the absence of " <a href="https://en.wikipedia.org/wiki/Optimistic_concurrency_control">Optimistic Locking / Optimistic Concurrency Control</a> ". <br><br>  If you think that for such a collision it is necessary to have two administrators working simultaneously, and you support the site alone and therefore in the house, then I hurry to upset you: it works, even if there is one admin.  For example, the admin edits the product, and the user bought the product at that moment, reducing the value in the <code>quantity</code> field.  The admin field <code>quantity</code> contains the old value, so that as soon as he clicks to save ... <br><br>  What does django have to do with it?  And because <u>django provides admin panel, but does not provide optimistic locking</u> .  And believe me, when you start working with the admin panel, you don‚Äôt even think about this problem - exactly until the strange ‚Äúmashing‚Äù of data and inconsistencies in quantities begin.  Well, then - an exciting debag. <br><br>  <b>Is this described in the documentation?</b>  Not. <br>  <b>What to do?</b> <br><ul><li>  <a href="https://github.com/gavinwahl/django-optimistic-lock">django-optimistic-lock</a> </li><li>  <a href="https://github.com/saxix/django-concurrency">django-concurrency</a> </li></ul><br>  In short, we create a <code>version</code> field for each model, while saving, check that the version has not changed, and increase its value by 1. If it has changed, we throw an exception (it means that someone else has already changed the record). <br><br><h4>  Morality </h4><br>  In conclusion, I will repeat what I started with: <br>  <u>Django doesn't work the way you think.</u>  <u>Django works exactly as written in its documentation.</u>  <u>No more, no less.</u> <br><br>  You can not be sure of the existing functionality until you read the entire section of the documentation about it.  You can not rely on the presence of functionality, if it is not written explicitly in the documentation.  These are the obvious truths ... exactly until you get caught. </div><p>Source: <a href="https://habr.com/ru/post/194974/">https://habr.com/ru/post/194974/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../194962/index.html">RailsClub'Moscow 2013. Interview with Dmitry Vorotilin</a></li>
<li><a href="../194966/index.html">Myths about clouds</a></li>
<li><a href="../194968/index.html">The asset_path method in javascript application rails code</a></li>
<li><a href="../194970/index.html">Scalable fault tolerant file service based on CTDB, GlusterFS</a></li>
<li><a href="../194972/index.html">Password hashing in PHP 5.5 using the new API</a></li>
<li><a href="../194978/index.html">The State Duma opened the electronic Veche. A set of experts and the beginning of the discussion of bills</a></li>
<li><a href="../194980/index.html">We monitor CPU cores in Zabbix and create random counters in Low-level discovery</a></li>
<li><a href="../194982/index.html">Winners of Duke's Choice Awards 2013</a></li>
<li><a href="../194984/index.html">The Internet is always and everywhere. Lexand LXR-Mini Mini Review</a></li>
<li><a href="../194988/index.html">Font Filing and Translation Quest 1996 - I Have no Mouth, and I Must Scream</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>