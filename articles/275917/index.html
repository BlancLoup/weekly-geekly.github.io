<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Amnesia FreeBSD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I never understood how memory allocation works in FreeBSD. Of the variety of documentation useful remembered only 

 This is not a true hilarion, but ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Amnesia FreeBSD</h1><div class="post__text post__text-html js-mediator-article">  I never understood how memory allocation works in FreeBSD.  Of the variety of documentation useful remembered only <br><br><blockquote>  This is not a true hilarion, but it was not true.  It was keeping track of what was going on. </blockquote><br><img align="right" width="50%" src="https://habrastorage.org/getpro/habr/post_images/20b/e23/149/20be2314990f8cdf3009281f2911880d.png"><br>  Well, better than Linux, and so be it.  I'm not against.  But worse than the most incomprehensible process of memory allocation, I was killed by <i>Inactive</i> memory.  What is it and is it possible to use ‚Äúit‚Äù painlessly?  Is this memory available for use by the application? <br><br>  Under the cut'om more questions than answers. <br><a name="habracut"></a><br>  The FreeBSD FAQ reports that <br><blockquote>  16.2. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Why doesn‚Äôt it show very little free running memory even when I have very few programs running? <br><br>  The simplest answer.  Any memory that has been used for the FreeBSD kernel as disk cache.  The values ‚Äã‚Äãare shown by top, (1) labeled as Inact, Cache, and Buf  It has been recently received, it has recently been received.  In general, it is shown that it is not very low. </blockquote><br><br>  Well, let it be some level cache, but why not put this <i>Inact</i> memory in <i>Cache</i> ?  Maybe because it is available for use (as claimed by numerous members of the forum) and even if not immediately, but can be allocated on request? <br><br>  Let's try to figure it out in a practical way.  We have: <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># top -b 0 last pid: 1019; load averages: 0.21, 0.45, 0.24 up 0+00:03:33 14:26:30 28 processes: 1 running, 27 sleeping Mem: 18M Active, 17M Inact, 130M Wired, 24M Buf, 3756M Free Swap: 3852M Total, 3852M Free</span></span></code> </pre> <br>  That is, almost all memory is Free and the swap is completely free. <br>  Now, to use the available memory, create a tmpfs partition. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mkdir /tmp/gb # mount -t tmpfs -o mode=01777,size=3221225472 tmpfs /tmp/gb # df -h | egrep "(Filesystem|tmpfs)" Filesystem Size Used Avail Capacity Mounted on tmpfs 3.0G 4.0K 3.0G 0% /tmp/gb</span></span></code> </pre><br><br>  Wherein <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># top -b 0 last pid: 1028; load averages: 0.09, 0.19, 0.17 up 0+00:09:30 14:32:27 28 processes: 1 running, 27 sleeping Mem: 18M Active, 17M Inact, 130M Wired, 24M Buf, 3756M Free Swap: 3852M Total, 3852M Free</span></span></code> </pre><br>  I agree, since the section is simply created / mounted, but free, there is no need to allocate memory to it. <br>  Put the file in it. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># dd if=/dev/urandom of=/tmp/gb/file.txt bs=1M count=3k 3072+0 records in 3071+0 records out 3220176896 bytes transferred in 53.334672 secs (60376801 bytes/sec) # df -h | egrep "(Filesystem|tmpfs)" Filesystem Size Used Avail Capacity Mounted on tmpfs 3.0G 3.0G 1.0M 100% /tmp/gb</span></span></code> </pre><br>  3 gigabytes of memory is busy, but at the same time <br><pre> <code class="bash hljs"> <span class="hljs-comment"><span class="hljs-comment"># top -b 0 last pid: 1040; load averages: 0.19, 0.26, 0.20 up 0+00:16:40 14:39:37 28 processes: 1 running, 27 sleeping Mem: 18M Active, 3088M Inact, 137M Wired, 24M Buf, 677M Free Swap: 3852M Total, 3852M Free</span></span></code> </pre><br>  for some reason they are considered <i>Inact</i> .  But since it is not Active, then we will try to set it up.  Sketch a small ‚ÄúHello, world!‚Äù To allocate memory and then free it: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;unistd.h&gt; #include &lt;string.h&gt; int main (int argc, char *argv[]) { int i; char *buffer[64]; long lSize = 1024*1024*1024; int iMB = argc &lt; 2 ? 1 : atoi(argv[1]); printf("iMB:\t%d\n", iMB); for(i=0; i &lt; iMB; i++) { buffer[i] = (char*) malloc (lSize); if(buffer[i] != NULL) { printf("Alloc: %d\n", i); memset(buffer[i], 127, lSize); } else printf("Error!\n"); sleep(1); } sleep(10); for(i=0; i &lt; iMB; i++) { printf("Free: %d\n", i); free (buffer[i]); } return 0; }</span></span></span></span></code> </pre><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># time ./a.out 3 iMB: 3 Alloc: 0 Alloc: 1 Alloc: 2 Free: 0 Free: 1 Free: 2 0.915u 1.475s 1:00.16 3.9% 5+168k 0+0io 0pf+0w</span></span></code> </pre><br>  Why so long?  Probably our tmpfs, supposedly in Inactive, were being squeezed into a swap. <br><br>  Indeed, when allocating memory (the moment <i>‚Äúsleep (10);‚Äù</i> in the code) we see: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># top -b 0 last pid: 1128; load averages: 0.02, 0.11, 0.14 up 0+00:28:34 14:51:31 37 processes: 1 running, 36 sleeping Mem: 3106M Active, 621M Inact, 155M Wired, 26M Cache, 27M Buf, 14M Free Swap: 3852M Total, 2502M Used, 1350M Free, 64% Inuse</span></span></code> </pre><br>  But worse is another.  After freeing the memory by the application: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># top -b 0 last pid: 1129; load averages: 0.09, 0.12, 0.15 up 0+00:28:48 14:51:45 36 processes: 1 running, 35 sleeping Mem: 33M Active, 621M Inact, 145M Wired, 26M Cache, 27M Buf, 3095M Free Swap: 3852M Total, 2502M Used, 1350M Free, 64% Inuse</span></span></code> </pre><br>  swap remained involved. <br>  File <i>accesses are</i> back to <i>Inact</i> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># time dd of=/dev/zero if=/tmp/gb/file.txt bs=1M count=3k 3071+0 records in 3071+0 records out 3220176896 bytes transferred in 40.265654 secs (79973292 bytes/sec) 0.008u 3.796s 0:40.26 9.4% 22+154k 0+0io 0pf+0w # time dd of=/dev/zero if=/tmp/gb/file.txt bs=1M count=3k 3071+0 records in 3071+0 records out 3220176896 bytes transferred in 1.242623 secs (2591434941 bytes/sec) 0.000u 1.241s 0:01.24 100.0% 25+173k 0+0io 0pf+0w # top -b 0 last pid: 1144; load averages: 0.09, 0.12, 0.14 up 0+00:36:22 14:59:19 36 processes: 1 running, 35 sleeping Mem: 29M Active, 3077M Inact, 146M Wired, 4K Cache, 27M Buf, 669M Free Swap: 3852M Total, 2502M Used, 1350M Free, 64% Inuse</span></span></code> </pre><br>  At the same time, it is not clear why there was <i>Swap: 2502M Used</i> <br><br>  But, let's say, this is normal and, if there is a free swap, you can consider this involved memory as inactive and mark it as <i>Inact</i> .  What happens if we don't have a swap?  Hopefully now the memory involved will now be <i>Active</i> . <br>  We remove the swap, similarly mount the 3Gb tmpfs section and fill it. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># top -b 0 last pid: 1013; load averages: 0.58, 0.53, 0.29 up 0+00:05:03 15:11:46 34 processes: 1 running, 33 sleeping Mem: 21M Active, 3089M Inact, 138M Wired, 24M Buf, 673M Free Swap:</span></span></code> </pre><br>  To clear your conscience, make sure that top doesn't lie: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># expr `sysctl -n vm.stats.vm.v_inactive_count` \* `sysctl -n vm.stats.vm.v_page_size` 3239620608</span></span></code> </pre><br>  And, despite the lack of a swap, our busy memory is still not quite active ... Since it is not active, we will try to reuse it with our application. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ./a.out 3 iMB: 3 Alloc: 0 Killed</span></span></code> </pre><br>  PM  and finally: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># top -b 0 last pid: 1026; load averages: 0.15, 0.22, 0.21 up 0+00:11:37 15:18:20 34 processes: 1 running, 33 sleeping Mem: 3102M Active, 1524K Inact, 138M Wired, 200K Cache, 24M Buf, 679M Free Swap: # expr `sysctl -n vm.stats.vm.v_inactive_count` \* `sysctl -n vm.stats.vm.v_page_size` 1720320</span></span></code> </pre><br><br>  There must be some conclusion, but it is not ... </div><p>Source: <a href="https://habr.com/ru/post/275917/">https://habr.com/ru/post/275917/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275907/index.html">Project Updates Hosting Cafe</a></li>
<li><a href="../275909/index.html">Ten Popular SEO Myths About Google Promotion</a></li>
<li><a href="../275911/index.html">Swift dictionary implementation</a></li>
<li><a href="../275913/index.html">Patties in distribution semantics</a></li>
<li><a href="../275915/index.html">Cisco Nexus at the core of the corporate network</a></li>
<li><a href="../275919/index.html">Color in design</a></li>
<li><a href="../275921/index.html">Data centers without people as a new trend</a></li>
<li><a href="../275923/index.html">Welcome to the meeting Moscow.pm February 4</a></li>
<li><a href="../275927/index.html">Optimization of Android-games created on Unity for the Intel platform: an example from life</a></li>
<li><a href="../275929/index.html">Setting color tabs in the new assembly Vivaldi 1.0.380.2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>