<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>BLE under the microscope</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="BLE under the microscope. Part 1  part 2 , part 3 
 In the world there is a wide variety of ways to transmit information "over the air." Recently, the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>BLE under the microscope</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a83/5a3/c2a/a835a3c2a2189e44940ed8b484a4ce18.jpg" alt="image"></div><br><h2>  BLE under the microscope.  Part 1 </h2>  <a href="https://habrahabr.ru/post/319388/">part 2</a> , <a href="https://habrahabr.ru/post/321052/">part 3</a> <br>  In the world there is a wide variety of ways to transmit information "over the air."  Recently, the BLE format has become increasingly popular.  Today we will look at the features of this protocol and talk about why it is so in demand in the modern world.  We also consider the development tools and features of the work of auxiliary applications on windows, android from the company Nordic. <br><a name="habracut"></a><br><h3>  Why came up with BLE </h3><br>  As soon as people learned to transmit information without the aid of wires, the problem of data transmission arose using a battery-powered device.  The problem is that he should be helped by another device that will constantly either listen to the broadcast or transmit data.  The problem arises if both the receiver and the transmitter are battery powered.  In this case, BlueTooth Low Energy (BLE) comes to the rescue.  He first entered into the protocol BlueTooth 4.0.  At the moment, the BlueTooth 5.0 specification has already been released, but we will mainly consider the BlueTooth 4.0 format, sometimes specifying innovations for the 5.0 format.  As one of the devices is usually a smartphone, and the second - the battery gadget.  Android supports BLE from version 4.3. <br><br>  For data transmission and reception, energy is needed, so they increase the data transfer rate in order to be able to transmit more information per unit of time.  For this purpose, the information transfer rate in BLE is 1 Mbit / c.  However, not only data transfer speed is important.  The most important thing in BLE is that communication devices are able to go into synchronous operation.  In other words, the devices sleep 99% of the time, then wake up for a very short time, exchange information and fall asleep again.  However, before entering this mode, you must go through the synchronization procedure.  For this there is a mode of "advertising".  We will look at it later.  And before plunging into the BLE protocol description, I would like to touch upon the topic of tools for working with the BLE protocol. <br><br><h3>  Instruments </h3><br>  In order to understand the diversity of packages and requests, we need tools.  With their help, we could see the contents of the packages and control the mechanism of interaction between devices.  For these purposes, we will use the nRF51822 Development Dongle (PCA10000), a sniffer program and, to display the results, the Wireshark program, which is well known to all sysadmins. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ece/07b/038/ece07b038f05c45a8d352b84607dc053.jpg" alt="image"></div><br>  Programs are free, but getting yourself a dongle can be a problem.  However, without the tools, it will be very problematic to develop such complex devices.  At the first stage, the program on the android ‚ÄúnRF Connect‚Äù can help. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b36/66b/573/b3666b5737e8a1789a50f2c79f884131.jpg" alt="image"></div><br>  It allows you to scan the air, find and parse the parcels of both attachable and non-attachable devices.  Nordic has more tools for developing BLE devices, but these will be enough for us.  At the Russian market there is a representative of the company Nordic - the firm ‚ÄúRutronik‚Äù (rutronik24.com, rutronik.com).  Through its representatives, you can purchase the necessary chips, debug boards, etc.  In addition, there is a <a href="https://devzone.nordicsemi.com/questions/">forum</a> on the Internet in which representatives of the firm answer the questions of developers. <br><br>  First, let's talk briefly about how to use our tools.  Insert our dongle into the USB connector and launch the ble_sniffer_win program.  We will see the next window. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5dd/988/1ca/5dd9881ca89874aa7cf8b228f3c38e63.jpg" alt="image"></div><br>  If the dongle sees the BLE device, then information about them will appear below.  In this case, there is one device on the air with the name "TestBLE".  Its signal level, MAC address and the fact that this address is random is also displayed.  Looking ahead, I would like to note that here lies one of the pitfalls for developers.  Some phones (LG G3S, Samsung S6) work only with devices whose MAC addresses are registered (public). <br><br>  The sniffer has two modes of operation.  If we press the ‚Äúw‚Äù button on the keyboard, the ‚ÄúWireshark‚Äù program will start.  The sniffer will scan three ad channels and display information about all ad devices.  If we first press the number on the keyboard, the same as in front of the device of interest to us, then another mode of operation will turn on.  In it, the sniffer will monitor the traffic of only one selected device, both on the ad channels and on the working channels. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d31/f1a/d92/d31f1ad92dda2e22d224882867a6ffcf.jpg" alt="image"></div><br>  Using Wireshark, it is easy to get all the information about the package.  The program consists of three windows.  All received parcels are displayed at the top, detailed information about the selected package is displayed in the second window, and the frame itself is displayed in the third window.  In turn, in the second window there are three blocks of information.  At the top - the time values ‚Äã‚Äãof the selected frame, in the second (Nordic BLE sniffer meta) - general information about the frame, such as signal level, frequency channel and some others.  The most interesting for us is the third block of information (Bluetooth Low Energy Link Layer).  In it you can see the analysis of the frame itself.  In the future we will talk about this block of information.  First, we analyze the formation of advertising packages. <br><br><h3>  Advertising </h3><br>  Let's look at the picture below.  It shows the frequency distribution of channels for BLE.  Advertising channels are 37 (2402 MHz), 38 (2426 MHz) and 39 (2480 MHz) channels.  This distribution of advertising channels was not chosen randomly.  First, advertising channels fall between Wi-Fi channels (1, 6, 11 channels), which allows even with a low power level to be heard by other devices.  Secondly, when we distribute advertising channels far from each other, we receive guaranteed message delivery.  This is due to the interference of the signal in the premises.  It is known that as a result of reflection of radio signals from the walls, a situation may occur when the receiver and transmitter do not hear each other.  However, in our case, when the transmission of advertizing packages goes consistently on three different channels, as far as possible from each other in frequency, this effect is absent. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/de2/d5b/7c7/de2d5b7c71249dad12a0de850bce29a1.jpg" alt="image"></div><br>  Now let's consider the format of the advertising package itself.  In the specification, data length is measured in octets.  For us, this is bytes.  The very first byte is the preamble.  It consists of alternating zeros and ones.  It is necessary to synchronize the transmitter and receiver.  Following the preamble are four bytes of the access address (Access Address).  After it comes a data packet (PDU).  In specification 4.0, the maximum PDU length is 39 bytes, and in version 5.0, the data packet length is increased to 257 bytes.  At the end of each ad package are three bytes of checksum (CRC). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/21a/ca5/b70/21aca5b709f0af5006a09f10e044dc0c.jpg" alt="image"></div><br>  Here it should be noted that the Access Address serves to ensure that the devices understand for whom the BLE package is intended.  This is a unique access code.  If this access code is not familiar to the device, then the packet is ignored.  On all advertising channels, unlike workers, it is the same (0x8E89BED6), so all devices on the ad channels see each other. <br><br>  Consider now the format of the data block PDU.  At the very beginning of the PDU packet, there is a 16-bit header.  It contains the packet type, the TxAdd, RxAdd flags, as well as the length of the entire PDU field in bytes.  RFUs are reserved fields.  For the 4.0 specification, it looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cc7/dc9/6ff/cc7dc96ff8ad5de16dbd83ea2e670f3c.jpg" alt="image"></div><br>  Title: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/973/494/4ae/9734944ae3de02add244930781156bb0.jpg" alt="image"></div><br>  For specification 5.0, the length of the Payload field has been increased to 255 bytes, and new fields have been added to the header: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/82a/7ac/7f8/82a7ac7f8a6f0c31c8c12dbbf845ef9d.jpg" alt="image"></div><br>  Title: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/15d/6dd/382/15d6dd38262b946f0259c56547e3bd0e.jpg" alt="image"></div><br>  The TxAdd field is just responsible for how the device MAC address will be seen.  If this field is one, then the device's MAC will be visible as random.  Consider now what are the types of advertising packages.  The figure shows a list for specification 4.0.  In the 5.0 format, their number is increased, but we will consider what is in both formats. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6a5/a05/d51/6a5a05d5165dec14866a916b88605e3b.jpg" alt="image"></div><br>  ADV_IND are non-directional packets that send devices ready to join.  Most of the gadgets when sending advertising packages use them. <br><br>  ADV_DIRECT_IND - directed advertising packages of attached devices.  Only a specific device with a previously known MAC address can attach and exchange data with them. <br><br>  ADV_NONCONN_IND - advertising packages that send non-attachable devices.  These are lighthouses (beacon).  Usually they are used to obtain any reference information.  For example, at the entrance to the store may inform about promotions.  In addition, by measuring the level of signals from beacons and knowing the map of their location, it is possible to carry out automatic positioning inside buildings.  This is true for automated warehouses. <br><br>  SCAN_REQ, SCAN_RSP, CONNECT_REQ - packets that exchange the device to be connected and the phone in the process of establishing a synchronous connection.  These packages and the process of accession will be discussed in the second part of the article. <br><br>  ADV_SCAN_IND ‚Äî These packets are sent by a non-attachable device, which can provide additional information in response to a scan request. <br><br><hr><br>  In the second part of the article, we will look at the various modes of operation of BLE devices, as well as the mechanism of "connecting" the device to the phone and switching to operating frequencies. <br><br>  Pecherskikh Vladimir </div><p>Source: <a href="https://habr.com/ru/post/319244/">https://habr.com/ru/post/319244/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319232/index.html">The reverse side of Agile</a></li>
<li><a href="../319234/index.html">Browsers and app specific security mitigation. Part 3. Google Chrome</a></li>
<li><a href="../319238/index.html">FloatingActionMode - contextual action panel for Android</a></li>
<li><a href="../319240/index.html">iOS: Work with the gallery (Photos framework). Part 2</a></li>
<li><a href="../319242/index.html">Mobile OCR. How it all began (part 2)</a></li>
<li><a href="../319246/index.html">How can I save on taxes 13.3 times</a></li>
<li><a href="../319248/index.html">Skype Out vs Out vs Tviggo vs Signal</a></li>
<li><a href="../319250/index.html">Why are VR shots so lame, and what to do about it?</a></li>
<li><a href="../319252/index.html">Puzzle on STL associative containers or How to solve one problem in eight very different ways</a></li>
<li><a href="../319254/index.html">"How do games": a two-hour talk about the monetization of online games</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>