<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CD Changer Control Protocol</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue the begun . This time I will talk about what is contained in the payload of the I / K-bus frame, briefly about the device of the infotainm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CD Changer Control Protocol</h1><div class="post__text post__text-html js-mediator-article"> We continue the <a href="http://habrahabr.ru/post/260831/">begun</a> .  This time I will talk about what is contained in the payload of the I / K-bus frame, briefly about the device of the infotainment system BMW e38, e39, e46, e53, and consider in more detail how the protocol works on the example of a CD changer. <br><a name="habracut"></a><br>  Logically, the data link layer contains higher level protocols in its data.  This happens in I / K-bus, only there are no network and transport protocols like TCP / IP in it.  Nowhere is the network address information in the frame, but interworking is possible.  It is performed by means of a gateway, which is made in the instrument cluster block.  The essence of the gateway is simple - it knows in which network this or that block is located, accordingly it sends the frame to another network if the sender and the receiver are in different ones.  Thus, interconnection on the data link layer is provided as if it is a single network segment.  The figure below illustrates the connection of networks in a common system of interaction between control units. <br><br><img src="https://habrastorage.org/files/58d/8bf/afc/58d8bfafc02e4f75be8e250944d41a7b.png"><br><br>  It should be clarified that the left scheme is valid for the e38 and e39, e53 bodies with the instrument cluster of increased functionality (IKE high).  In the e39, e53 with the base of the instrument cluster (KOMBI), as well as in the e46, the I-bus and K-bus are physically combined into one. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      D-bus is a diagnostic bus (k-line).  It connects diagnostic equipment.  This bus does not have a physical connection to all control units, but through the gateway in IKE / KOMBI the task of interaction is fully provided.  For example, the navigation unit is only connected to the I-bus, but with the help of service / diagnostic equipment, we can read service information, errors, and perform coding. <br><br>  What is contained in the I / K-bus frame payload, I will call the application layer protocol.  Basically, it consists of two parts.  MSG ID - message identifier, takes one character.  MSG DATA - information that supplements the message, may be absent altogether or take up to 32 characters.  The following image shows what it looks like: <br><br><img src="https://habrastorage.org/files/0fd/212/456/0fd212456725475ab585dcf05db6eb61.png"><br><br>  Since the symbol consists of 8 bits, it turns out possible command variations (CMD ID) 256. Quite a lot, probably even with a margin, and I know not all.  But on some key I will focus. <br><br>  The message with the identifier MSG ID = <b>01</b> is a request for the device status.  Before interacting with any device, you must make sure that it is present and in good condition.  This command is sent to the device that you want to verify.  In this case, the MSG DATA field is not filled.  So that information on the status of devices is relevant all the time, the command is repeated periodically.  Consider this type of message on the example of the frame <b>68 03 18 01 72</b> (hereinafter, the contents of the frame will be denoted by numbers in hexadecimal).  The frame is sent from the radio (device identifier <b>68</b> ) to the CD changer ( <b>18</b> ) with a status request (message identifier MSG ID = <b>01</b> ).  The CD changer, if it exists and is healthy, responds with a message confirming the readiness status (MSG ID = <b>02</b> ).  The complete fragment of the response frame <b>18 04 FF 02 00 E1</b> .  The answer is broadcast to everyone in the local network, as the address of the recipient is <b>FF</b> .  Here, in addition to the message identifier, additional data is transmitted - MSG DATA = <b>00</b> .  If the data value is <b>01</b> , then this means that the device has just turned on and this is its first readiness message.  This type of dialogue is observed between many control units. <br><br>  You can control the playback of music tracks, radio stations or change the volume level from the steering wheel or from the center console.  These controls transmit information to the radio via the same I-bus.  Messages volume control is identified by the number <b>32</b> , and the data contains control information.  The following is the structure of this message. <br><br><img src="https://habrastorage.org/files/3a6/968/fdd/3a6968fdd38c45198d98f1a3054e43a4.png"><br><br>  The data consists of one byte, in which the blue bit is responsible for the direction of the level change: 0 - subtract, 1 - add.  And the green bits show the strength of the relative change from 1 to 15 discrete levels.  For example, the frame sent when the ‚Äú+‚Äù key is pressed on the steering wheel looks like this <b>50 04 68 32 11 1F</b> .  This message causes the radio to increase the volume by 1 discrete level.  If the clock on the center console is turned sharply clockwise, a frame will be sent to the bus <b>C0 04 68 32 91 0F</b> .  Here, the multi-information display reports the requirement to increase the volume by 9 discrete levels. <br><br>  There are three types of message for button control: the button is pressed, the button is held for a long time and the button is released.  In the message data, except for the button state, its identifier is transmitted.  For example, a message with MSG ID = <b>3B</b> means that information is transmitted on the change in the state of the buttons on the steering wheel, which are responsible for controlling the radio receiver and telephone.  The MSG DATA consists of one character and contains information about the affected button. <br><br><img src="https://habrastorage.org/files/0bd/87b/e7c/0bd87be7c7bd47849bb39accb1575618.png"><br><br>  In bits of blue color the button is designated.  If this is the 0th bit, then there was an impact on the "search up" button.  If the 1st bit, then the button "R / T".  If the 3rd bit, then the "search down" button.  In the green bit area, the state of the button is indicated.  If all bits are 0, then this means that the button is pressed.  If the 4th bit is 1, then there was a long button hold.  If 5-bit is 1, then the button has been released.  Consider the situation when we switch the music track to the next when you press a button on the steering wheel.  Two frames will be sent to the bus with a small interval: <b>50 04 68 3B 01 06</b> and <b>50 04 68 3B 21 26</b> .  The first frame reports that the ‚Äúsearch up‚Äù button was pressed.  The second reports that the search up button has been released. <br><br>  For push-button controls on the center console, be it a multi-information display or an on-board monitor, the approach is the same ‚Äî information about the button's identifier and its state is transmitted.  But the message structure is different. <br><br>  Now we will consider in general how the infotainment system is arranged on e38, e39, e53 cars.  Namely, that part of it that is responsible for playing music and radio.  In the figure below I have schematically represented the device of this part of the system. <br><br><img src="https://habrastorage.org/files/4d9/bc5/606/4d9bc56062454e1c9cf94ff92cb7299d.png"><br><br>  The central role here is taken by the radio (RAD).  The fact is that in addition to the functions of receiving radio stations, this unit performs the functions of an amplifier.  If the car is not equipped with an on-board monitor, then a cassette or CD player is located in the case of the radio.  In this embodiment, it is located in the center console.  If the car is equipped with an on-board monitor, the radio is located in the luggage compartment and an audio input for the cassette player is upgraded.  The cassette player is mounted in the on-board monitor. <br><br>  The speaker system can be in three versions: a simple stereo system, Hi-Fi or Top Hi-Fi.  In the first case, the radio is directly connected to the speakers.  In the Hi-Fi speaker system, the speakers are larger and they are connected to the radio through an additional amplifier.  Such an amplifier, in addition to increasing the power of the audio signal, performs the functions of active equalization for car acoustics and splits the sound into ranges for the respective speakers.  The top hi-fi system is even cooler.  In addition to all of the above, it has a subwoofer, and the silica gel performs equalization depending on the speed of the car, thereby compensating for the noise of the cabin.  The system is also supplemented with surround sound effect. <br><br>  Information on the selected playback source, track number, radio station frequency, etc., as well as management is performed on the center console via the on-board monitor or multi-information display or something else.  In order not to be distracted from driving, audio control can be performed on the multifunction steering wheel (MFL) mentioned above. <br><br>  The CD changer (CDC) is designed as an addition to the radio.  The exchange of control commands and answers is made only between the radio and the CD changer.  This is done on the I-bus, like wine in the diagram.  The audio signal in analog form is transmitted to the line input of the radio receiver, where it is amplified and fed further to the speaker system.  If the top hi-fi speaker system, the signal from the CDC is fed directly to the amplifier in digital form. <br><br>  Now let's take a closer look at the dialogue between the CD changer and the radio on the I / K-bus.  As described earlier, the radio periodically sends requests for the status of the CD changer.  If this is present in the car and it is in good condition, then a presence response will be immediately sent to the bus.  Having received the answer, the radio receiver forms an additional playback mode in the menu on the central console, in which the source is the CD changer.  The driver needs only to press the corresponding button so that the radio starts playing from the CD changer, gets information about the loaded CD, track number and displays this information on the center console. <br><br>  The CD changer playback control is performed by a message with the MSG ID = <b>38</b> .  The message structure is as follows: <br><br><img src="https://habrastorage.org/files/356/5ef/c10/3565efc10ba94783970f58e738af2b0e.png"><br><br>  As you can see, the message is simple in structure and contains two key parameters: CMD and ARG.  The code of the required playback mode is transmitted to CMD, and additional data is transmitted to ARG.  For clarity and ease of understanding, below is a table that summarizes the well-known commands to me: <br><br><img src="https://habrastorage.org/files/be2/019/899/be2019899ebd4e55b8210ab39df9e747.png"><br><br>  Thus, the control of the CD changer is performed, and the latter, in turn, supports the feedback with messages with the identifier 39: <br><br><img src="https://habrastorage.org/files/76a/bd1/10f/76abd110fa0a4d189a6a85366b6bef80.png"><br><br>  In this message, the status of the CD changer and its playback mode are transmitted.  In more detail about each character of the message in the following table: <br><br><img src="https://habrastorage.org/files/9db/919/d0b/9db919d0bf2e43078bd5230485d65d76.png"><br><br>  It should be noted that there are control commands from the radio receiver, to which the CD changer should send an immediate response, as confirmation of the acceptance of the command, otherwise the commands will be sent over a 500 ms timeout.  Such commands include: ‚Äústart playback‚Äù, ‚Äústop playback‚Äù, ‚Äúrewind‚Äù, ‚Äúrandom track selection mode‚Äù and ‚Äútrack scanning mode‚Äù.  Having received a command with the corresponding CMD identifier, the CD changer changes the status indicator to the required request and sends a message to the radio receiver.  In the case of the ‚Äúrewind‚Äù command, the indicator remains in the simple playback mode, only the status changes to ‚ÄúFAST FORWARD‚Äù or ‚ÄúREWIND‚Äù.  The radio receiver calms down, that the command is accepted successfully and ceases to bomb by repeated messages. <br><br>  Next, I want to give an I / K-bus traffic log, where three devices are connected to the bus: a multi-information display, a radio receiver, and a software changer for the CD changer.  I gathered this simple network on my desk to analyze the interaction of control units and debug a software CD changer. <br><br><img src="https://habrastorage.org/files/500/c15/19d/500c1519d6964be6982d27b7d773f299.png"><br><br>  The color here highlights the CD changer control messages and responses. <br><ul><li>  Yellow is a switch to the previous track. </li><li>  Green - on and off rewind </li><li>  Blue - turn on and off the mode of playing tracks in random order. </li></ul><br><br>  Summing up, I want to say that by applying this protocol on the simplest hardware and software solution, you can ‚Äúlegally‚Äù penetrate into the regular infotainment system of the car.  As the simplest example, you can create your own media player that is functional by modern standards and that will receive control commands from the steering wheel, center console and produce sound using a standard speaker system. <br><br>  Sources used: <br><ul><li>  Bus System Troubleshooting, 2001 </li><li>  I-BUS Inside, Franck Touanen, 2002 </li></ul></div><p>Source: <a href="https://habr.com/ru/post/303144/">https://habr.com/ru/post/303144/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303134/index.html">The value of multi-font design</a></li>
<li><a href="../303136/index.html">The digest of fresh materials from the world of the frontend for the last week No. 215 (June 6 - 12, 2016)</a></li>
<li><a href="../303138/index.html">What makes us go to work every morning?</a></li>
<li><a href="../303140/index.html">Matrix procrastination (postponing cases "for later")</a></li>
<li><a href="../303142/index.html">OpenGL ES 2.0. One million particles</a></li>
<li><a href="../303146/index.html">NetApp SDS: ONTAP Select</a></li>
<li><a href="../303150/index.html">We automate the purchase of railway tickets Ukrzal—ñznits—ñ</a></li>
<li><a href="../303156/index.html">Delayed Durability or a story about how to speed up the execution of autotests from 11 to 2.5 minutes</a></li>
<li><a href="../303158/index.html">The digest of interesting materials for the mobile # 157 developer (June 6-13)</a></li>
<li><a href="../303160/index.html">10 rules that allow NASA to write millions of lines of code with minimal errors</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>