<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Parse "Opposition - Military Chronicle" (1996-1997, Doc)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Good to everyone, I want to tell you about the warm and lamp strategy of childhood - Confrontation. The game was released in 1996-98 by...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Parse "Opposition - Military Chronicle" (1996-1997, Doc)</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  Good to everyone, I want to tell you about the warm and lamp strategy of childhood - Confrontation.  The game was released in 1996-98 by our Russian company Doc. <br>  The game is a real-time strategy game about the second world war.  After many years, I decided to first go through it and record the passage, and then try to maximize the enjoyment of the game, unpacking resources and trying to understand the game logic. <br><br>  Under the cut, I will describe the process of extracting music, graphics and a little bit I will not reach the map editor. <br>  Also in the description will be a reference to the 8-bit color palette, pseudo archives, RLE-compression and a bit of a HEX editor.  In the code itself, I only looked at the decoding algorithm for images compressed with RLE. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/177/064/a8b/177064a8b1f7a49fc1a9b90d5be937c7.png" alt="image"><br><a name="habracut"></a><br>  The original plan was to get the music and turn off the fog of war, then got a little carried away and unpacked 9 files (.ADW, .DAW, .RUS). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I play and recommend the full 2v1 version ( <a href="http://www.old-games.ru/forum/showthread.php%3Ft%3D34633">Confrontation: Military Chronicle</a> ) with five cd-audio tracks, that is, a full rip of the latest version of the game all-in-one. <br>  If I had the opportunity, I would have bought it again, since my original disc, purchased in 98g, was not preserved. <br><br><h4>  Music </h4><br>  The obvious and simple solution is to run the game under the dosbox and record all the music, which I did in the first place.  <a href="http://video.yandex.ru/users/jack7277/collection/1/playlist/">Playlist with music</a> . <br><br>  Then I thought it was wrong.  It turns out that this music is not original, but passed through dosbox filters.  Decided to unpack to wav state, taking the original data. <br>  Opened music.dat file in winhex.  Since there are voice inserts in the music, I assumed that there is a digital stream. <br>  Thanks to the old-games forum where I was told that most often for audio, we used uncompressed raw data stream, just sound with certain parameters (11025 Hz / 22050 Hz as the most frequently used, 8-16 bits, mono / stereo, Intel / Motorola ) which was sent directly to the sound card. <br><br>  Opening in hex saw the following: <br><img src="https://habrastorage.org/getpro/habr/post_images/6f4/de0/7ad/6f4de07ad05d18696e27aff6d3f9f549.png" alt="image"><br>  The beginning of the file - 4 bytes contain the number 20 (00 00 00 14h).  There are 20 tracks in the game. Then the next 20 groups of 4 bytes are the beginnings of the melodies.  The last 4 bytes (33 A5 4B 01 = 01 4B A5 33h) are equal to the size of the music.dat file, the size of each track is equal to the difference between the two offsets.  Everything turned out nice and easy. <br><br>  The offset table is easy to determine - it can be incrementing digits, but sometimes the file table contains non-consecutive offsets (for example, the table of fonts of the game I have no mouth and I must scream).  The offset number ranges from 0 to file size.  In this case, the table goes to increase. <br><br>  In the header of each track, track names are traced by a fixed offset of +16: Maintune, Technoish, Terrible, Requiem, Track 0, Lazy reggae, U97: Scramble, Gone, Rainman, Guitar song, Cool Jazz, Fir plates plant, REGRET. <br>  Experiments with pieces in the program Game Audio Player (GAP) showed that the music is played with the following parameters - 22 kHz, 8 bit, mono, unsigned.  Moreover, if you set 11kHz, the music will still play, but 2 times slower.  Mono / stereo also changes the playback tempo. <br><br>  Inspired by the result, I started listening to all the files of the game ... I listened to them for three days.  The sound is very similar to downloading games from tapes on the Spectrum or the noise of an analog modem.  I found out that the sounds in the game are reproduced as 11kHz, 8 bits, mono.  I also found out that all the sounds in the game, the sound in the video sequences, the music are raw, raw data with pointers. <br>  The title of each track is 68 bytes, it needs to be discarded, otherwise a click in front of the music is obtained. <br>  The result was a music.dat parser-parser. <br>  The resulting files can be heard in GAP and converted to any format. <br>  Quest to extract the original music was completed. <br><br><h4>  Graphics </h4><br>  With graphics everything was a bit more confusing.  Some images turned out to be RLE-compressed, some are not compressed, a part of the file header has image resolution, and the sequence can be caught as X, Y or Y, X.  Some images did not contain any titles and were 32x32 pixels in size. <br><br>  Content pseudo-archive and RLE compression: <br><img src="https://habrastorage.org/getpro/habr/post_images/2d3/862/3a3/2d38623a3a2b45f2b8f97d868059e7c3.png" alt="image"><br><br>  At first there is a header - these are groups of four bytes, where the offsets to the beginning of the data block are indicated. <br>  The last numbers 67 A9 07 00 are equal to the file length, the number of the end of the first block. <br>  Then comes the second block of data, specifically for the file adddata.adw - this is a ‚Äúinsert disk‚Äù image for a normal campaign and burnt snow. <br>  (number of files) and 4 offsets <br>  04 00 00 00 - 10 00 00 00 - C3 A3 01 00 - C3 A6 01 00 - 52 40 03 00 - 8002 E001 <br>  The last numbers 0280h and 01E0h are the numbers 640 and 480, that is, the resolution.  Numbers define a loop for the decoding procedure of a block with RLE compression. <br>  Decoding algorithm: <br>  A number less than or equal to 7Fh (127) specifies the number of repetitions of the next byte in the example above ‚Äî this is 7Fh (127), repeat zero. <br>  If the first number is more than 80h, then the following (X-80h) bytes are just bytes that need to be copied to a new place. <br>  The sequence 82h 01 02 means that these are the numbers 01 and 02 without any compression. <br>  If in place of the number of repetitions gets zero, skip. <br>  As for the fate of the number 80h, I did not understand, it should not occur, because  a difference of 80 and 80 will give zero). <br><br>  In theory, we need 2 blocks - the image itself and the palette. <br>  The beginning of block 2 is taken as zero and all further displacements point from zero.  That is, if you look in the hex editor, then you need to add the initial 24 bytes, plus 4 bytes (04 00 00 00).  Total +28 bytes or + 1Ch <br><br>  04 00 00 00 - 4 files. <br>  10 00 00 00 + 1Ch which indicates the beginning of the image block 8002 (640), E001 (480), that is, we set the decoding cycle, not longer than 640 √ó 480 <br>  C3 A3 01 00 + 1Ch indicates a 256 RGB color palette, 768 bytes.  <a href="http://habrahabr.ru/post/184986/">Read more here</a> . <br>  C3 A6 01 00 + 1Ch points to the images, again 640x480 <br>  52 40 03 00 + 1Ch indicates the palette <br><br>  The case remains for small, to disassemble files into blocks, unpack the compressed sections and glue with a palette. <br>  Decoded compressed image: <br><img src="https://habrastorage.org/getpro/habr/post_images/0dc/c66/4b5/0dcc664b55e09bfb8bcb07dd0587b145.jpg" alt="image"><br><br>  Game sprites: <br><img src="https://habrastorage.org/getpro/habr/post_images/7e3/ce1/061/7e3ce10617fd80c6cd5796a45c4a38a2.jpg" alt="image"><br><br>  Images taken out of resources turned out to be dark, you need to make a bit shift to the left by 2 on each channel R, G, B. <br>  r = r shl 2;  (well, or multiply by 4, who likes) <br>  g = g shl2; <br>  b = b shl 2; <br><br>  Some pictures for relaxation.  Original, without filters, tru. <br>  These pictures are drawn on the right of the panel when you select a unit. <br><img src="https://habrastorage.org/getpro/habr/post_images/893/1fd/a9d/8931fda9d9872952c20c75635eb9dd18.png" alt="image"><br><br><h4>  Video </h4><br>  From the video, the next file came out, there are also raw data streams, pictures (questionable in what format), mixed with sound.  He took out the first video from movie.adw at 1.64MB, stuck it in GAP (22kHz, 8bit, mono, unsigned) - noise, sounds, noise, sounds go together, where noise is a stream of pictures in 320x200x256 and sound in raw. <br>  I suppose that if you rummage around the file attentively, the sound should be separated by some offsets.  The video begins with the letters DLM, it is easy to find, plus if you check the starting offset table in movie.adw, they will point to DLM. <br><br>  Video: <br>  - Header 4 bytes - "DLM" + 00 <br>  - Video size + sound - 4 bytes (It coincides with a torn videoku) <br>  - Unclear 4 bytes (type, E3 00 00 00 = 227, the number of offsets) <br>  - Horizontal size, 4 bytes, 40 01 00 00 = 320 <br>  - Vertical size, 4 bytes, C8 00 00 00 = 200 <br>  - Some separator in 4 bytes = 04 00 00 00 <br>  - then 227 file byte offsets of 4 bytes <br>  - Then again separator 04 00 00 00 <br>  - And it seems to end the data stream <br><br>  And on this with all the video. <br><br><h4>  Little map editor </h4><br>  Picked the file CD: \ DATA \ MISSIONS \ 73 \ UNITS.DAT, found out the following <br>  [DEUTCHE] <br>  [TIGER] <br>  6,80,3,50,100,0,142 <br><br>  Information about units on the map: <br>  - The first two numbers separated by commas are the X and Y coordinates of the unit, zero begins in the upper left corner.  The maximum is 128, the size of the card is 128x128, seemingly fixed;  integer, 0-128 <br>  - The third number is the sprite of the unit turning, in 8 directions should be + the turn of the tower is also animated;  integer 0-7.  The tower is turned in the direction of the unit view. <br>  - The fourth number - the number of life of a unit, an integer of 0-100, it looks like a percentage of the maximum of each unit; <br>  - The fifth number - the amount of ammunition, it seems as a percentage of the maximum.  0-100. <br>  - The last two did not understand what the numbers, changed to 1, 142 and 2, 12, in a unit, nothing has changed.  Not attack / defense, checked.  (the sixth, the penultimate - in enemy units indicates visibility, 0 - not visible to the player, 1 - see) <br>  - The last seventh number is xs.  It seems somehow connected with patrols, from the beginning of the game, enemy tanks drive in different ways.  It looks like a behavior script, by number.  From 0 to xs 255 <br><br>  For houses, the parameters are as follows: <br>  [DOMES] <br>  29,33,70,100,1 <br><br>  1) Building type, values ‚Äã‚Äãfrom 0 to 35. <br>  2,3) The X, Y coordinates of the upper left building start are drawn to the right and down.  Values ‚Äã‚Äãfrom approximately 1 to 128. <br>  4) The number of "lives" of the building, in%.  0-100.  Tried and 1000%, then the building can be destroyed with 6 dynamites, instead of 2 for the usual large. <br>  5) The condition is whether to destroy the building to win the mission.  1 - an ordinary building, for the destruction there are no bonuses, 2 - the building must be destroyed to win the mission. <br><br>  description of units from units.dat <br>  [RUSSIAN] - Russian unit description branch, section <br>  [RBTANK] - Soviet T34, medium tank, <img src="https://habrastorage.org/getpro/habr/post_images/156/7d3/bf5/1567d3bf5673798eba435f070bbb30f0.png" alt="image"><br>  [RLTANK] - Light tank, T26, <img src="https://habrastorage.org/getpro/habr/post_images/538/2d4/bae/5382d4bae3ed00696d87d8e71f7ca6cb.png" alt="image"><br>  [RGUN] - Russian cannon against infantry and tanks, <img src="https://habrastorage.org/getpro/habr/post_images/b5b/040/a5f/b5b040a5f0e16753ecd7dc579c9c0f2c.png" alt="image"><br>  [RTROOP] - Russian infantry, <img src="https://habrastorage.org/getpro/habr/post_images/892/eaa/d33/892eaad3337d8c1782764b66e2d07332.png" alt="image"><br>  [RSAMO] - Russian PT, type su100 <br>  [IS] - heavy Russian tank IS <br>  [BAT] - quick-fire uncontrolled gun, <img src="https://habrastorage.org/getpro/habr/post_images/abd/9f5/db5/abd9f5db577911560f5d29659a369ca2.png" alt="image"><br>  [RGAUB] - Russian controlled howitzer, <br>  [KATYA] - Katyusha, <br>  [RBTR] - machine gun btr, small machine, <br>  [RFURG] - infantry truck, <br>  [TOWER] - tower with a machine gun, <br>  [RZENIT] - Russian anti-aircraft gun against aircraft, <br>  [CAR] - car with vip persona, <br>  [RMZ] - Russian mobile anti-aircraft gun with aircraft <br><br>  [DEUTCHE] - German unit description branch, section <br>  [DGUN] - German cannon, <br>  [DLTANK] - German light tank, <br>  [DBTANK] - German medium tank, <br>  [TIGER] - Tiger, <br>  [DBIKE] - motorcycle, <br>  [DTROOP] - infantry, <br>  [RFURG] - van-truck, Russian, you can capture or use as your own. <br>  [DBTR] - machine gun btr-machine <br>  [DSAMO] - German Fri, such as Ferdinand <br>  [DGAUB] - German controlled howitzer <br>  [ART] - High-speed, accurate gun that can be controlled. <img src="https://habrastorage.org/getpro/habr/post_images/ae8/d8c/221/ae8d8c221868e4b582e18daa963a1756.png" alt="image"><br>  [DZENIT] - Anti-aircraft guns against aircraft, <img src="https://habrastorage.org/getpro/habr/post_images/b67/f33/fe9/b67f33fe9dd7b59b01f7dcc0c4b0472e.png" alt="image"><br>  [DMZ] - Mobile anti-aircraft gun against aircraft, <img src="https://habrastorage.org/getpro/habr/post_images/7d8/5f8/3cc/7d85f83cce445e3b8d0cf48bea2029f5.png" alt="image"><br>  [STIG] - German Uber-tank with a powerful gun and weak armor, Sturmtigr, <img src="https://habrastorage.org/getpro/habr/post_images/071/eb1/fc6/071eb1fc6f6bb89b40bec798b9a980c0.png" alt="image"><br><br>  And, for example, if you play for the Germans, you put a branch of descriptions of Isov under your description, under [DEUTCHE], then all the ISs are under your control. <br><br>  As a result, he sketched a miniature - Friendship of Peoples <br><img src="https://habrastorage.org/getpro/habr/post_images/d0c/388/e46/d0c388e46b9e36862091ba5ed532614f.png" alt="image"><br><br>  And crazy video: <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/SftOlUlTTQk%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700190,15700253&amp;usg=ALkJrhgtBPe_yaZMq5RG3SQMKe_GqbI2eA" frameborder="0" allowfullscreen=""></iframe><br><br>  But in the end, the editor didn‚Äôt finish it, because the format of the maps was not fully understood. <br><br>  <a href="http://www.old-games.ru/forum/showthread.php%3Ft%3D56330">Subject on the forum old-games</a> , suddenly someone will help finish the unfinished.  The source code is available, unfortunately, on Delphi7. <br><br>  Passage playlists: <br>  - <a href="http://www.youtube.com/playlist%3Flist%3DPLV52GDR82dy0aaxInr3X14ZNan8XtSSYY">Campaign for the USSR</a> , <br>  - <a href="http://www.youtube.com/playlist%3Flist%3DPLV52GDR82dy0rMKTFGNJr_gBoDQROsnI-">Campaign for Germany</a> , <br>  - <a href="http://www.youtube.com/playlist%3Flist%3DPLV52GDR82dy2t3jVjzFr_vxyEiPmoaoLG">Additional missions - scorched snow</a> . </div><p>Source: <a href="https://habr.com/ru/post/186990/">https://habr.com/ru/post/186990/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../186968/index.html">Google fixed a vulnerability that allowed to get full remote access to Glass</a></li>
<li><a href="../186976/index.html">HideOut: games with augmented reality</a></li>
<li><a href="../186978/index.html">Radioastron rips templates</a></li>
<li><a href="../186980/index.html">STM32F4Discovery - we connect the camera via DCMI interface</a></li>
<li><a href="../186988/index.html">Difficult in the obvious: how we made the call interface to Yandex.Shell</a></li>
<li><a href="../186992/index.html">Good morning</a></li>
<li><a href="../186994/index.html">New API HeadHunter and termination of support for API 1.0</a></li>
<li><a href="../186998/index.html">Why you should not overclock the timer Windows or megawatts wasted</a></li>
<li><a href="../187002/index.html">Meet IBM Tivoli Netcool / OMNIbus</a></li>
<li><a href="../187004/index.html">Build 2013 for designers. Updates in the Windows 8.1 interface and a review of useful reports for designers and designers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>