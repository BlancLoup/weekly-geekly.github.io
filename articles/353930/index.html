<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to move from BuddyBuild to GitLab CI in 4 hours</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 A year and a half ago, the iOS FunCorp team moved to a new service for a simple CI organization in iOS and Android projects. 

 Before th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to move from BuddyBuild to GitLab CI in 4 hours</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/ni/lc/pd/nilcpdwtl7pvwkzu9cg0maemahq.jpeg"><br><br><h3>  Prehistory </h3><br>  A year and a half ago, the iOS FunCorp team moved to a new service for a simple CI organization in iOS and Android projects. <br><br>  Before that, we used CI on Bamboo, but there were a lot of problems with it, so we completely abandoned it and switched to BuddyBuild. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It worked so simply that you could not even know what CI is and how to upload the application in the AppStore, but calmly deal with code, tests and product development. <br>  But times have changed, and BuddhuBuild is not the same, so we began to search for alternatives. <br>  In this article we will talk about the new solution that our team has chosen, and give a few scripts for organizing CI on our own. <br><a name="habracut"></a><br><h3>  Just means good </h3><br>  In BuddyBuild, we were attracted by simplicity.  First you need to take a few steps: <br><br><ol><li>  Log in with GitHub / GitLab / BitBucket. </li><li>  Specify the repository with the project. </li><li>  Give service account and distribution-certificate. </li><li>  Wait until ‚Äúmagic happens‚Äù on the service side. </li></ol><br>  And right after that, you can get tests and artifacts on all branches, customize build rules using a clear UI, quickly switch between XCode versions and release in AppStore / TestFlight directly from the service. <br><br>  When we started working with BuddyBuild, it could be used for free, but after a few months it was over.  Now the starting package costs $ 79 per month.  For ourselves, we chose a plan with three competitive assemblies for $ 279. <br><br>  BuddyBuild worked well, but it did not last long. <br><br>  With the growing popularity of the service, as well as the increase in the amount of code in iFunny, the build time increased from a stable 20 minutes to tests and an artifact assembly to 70 minutes. <br><br>  We tried to find a solution for caching by means of the service, but nothing worthy was found in simple settings. <br><br>  Meanwhile, the service was bought by Apple, and we made the final decision to abandon it. <br><br><h3>  CI / CD requirements </h3><br>  Based on previous experience with CI, we had several requirements for the new system. <br><br><ol><li>  It should quickly deploy the agents and build environment with the minimum number of visits to the agents UI. </li><li>  Update Xcode without logging into the agent UI and having the ability to switch between multiple versions. </li><li>  Integrate with the system pull requests. </li><li>  Use a minimum of third-party dependencies for assembly and unloading in the AppStore. </li><li>  Have the ability to customize and customize build steps for different branches. </li><li>  Run the assembly of the artifact only by a button from the UI. </li></ol><br><h3>  Gitlab ci </h3><br>  Together with the decision to abandon BuddyBuild, the idea was to migrate from GitHub to GitLab, and it already has a built-in CI / CD system, that is, we have the necessary integration with merge requests. <br><br><h4>  Installing the working environment on the agent </h4><br>  First of all, you need to enable the ability to access the agent via SSH using Screen Sharing.  This is done in the Sharing settings: <br><br><img src="https://habrastorage.org/webt/fl/cm/us/flcmusfxtwiuqg0xnzki-axnntc.png"><br><br>  Now, to connect to the CI agent, we can use the terminal and the SSH client: <br><br><pre><code class="bash hljs">ssh user@local.ip</code> </pre> <br>  After a successful SSH connection, you must disable the use of the password for the sudo command.  It may seem like it is insecure, but given that all agents are available only within the local network, for better automation we disable the password for sudo.  For this: <br><br><pre> <code class="bash hljs">sudo visudo</code> </pre> <br>  A standard Vim editor will open, in which you need to change the line: <br><br><pre> <code class="bash hljs">%admin ALL = (ALL) ALL</code> </pre> <br>  on line <br><br><pre> <code class="bash hljs">%admin ALL = (ALL) NOPASSWD: ALL</code> </pre> <br>  Many iOS developers do not like to dig into the console and rarely use Vim, so keep step-by-step instructions on how to change these lines: <br><br><ol><li>  Press i, enter insert mode. </li><li>  Arrows find the desired string and change it. </li><li>  Next esc. </li><li>  Enter: w to save. </li><li>  Enter: q to exit visudo. </li></ol><br>  First of all, on each agent, we need the Homebrew package manager, which can be installed with the following command: <br><br><pre> <code class="bash hljs">sudo <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> | ruby -e <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span></span></span><span class="hljs-string">"</span></span></code> </pre> <br>  The echo command is used here to prevent the confirmation of the installation. <br>  After that, you can set the required minimum dependencies from Homebrew.  Here is what we chose: <br><br><ul><li>  <b>XCPretty</b> .  It allows you to beautifully format the output of the standard command for the xcodebuild iOS project build; <br><br><pre> <code class="bash hljs">sudo gem install xcpretty</code> </pre> </li><li>  <b>fastlane</b> .  We use its capabilities to a minimum, since we do not want the project build to be highly dependent on something third-party; <br><br><pre> <code class="bash hljs">sudo gem install fastlane</code> </pre> </li><li>  <b>xcode-install</b> .  This tool will allow you to install Xcode without stopping in the AppStore and switch between multiple versions; <br><br><pre> <code class="bash hljs">sudo gem install xcode-install</code> </pre> </li><li>  <b>CocoaPods</b> .  This dependency manager is familiar to every iOS developer. <br><br><pre> <code class="bash hljs">sudo gem install cocoapods</code> </pre> <br></li></ul><br>  Now you can install Xcode by running the following commands in sequence: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> FASTLANE_USER=<span class="hljs-string"><span class="hljs-string">"your@account.todevapple"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> FASTLANE_PASSWORD=<span class="hljs-string"><span class="hljs-string">"yourpasswordtoaccont"</span></span> xcversion install 9.2</code> </pre> <br>  You can not export, but then the Apple ID and password will be requested during the installation process. <br><br>  After these simple steps, the agent is ready to collect most of the iOS projects. <br><br><h4>  Agent registration </h4><br>  In order for the project to be seen by your agent on Gitlab CI, you need to install it and register it. <br><br>  This can also be done using SSH and the command line on the agent: <br>  First, download and install the agent: <br><br><pre> <code class="bash hljs">curl --output /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-darwin-amd64</code> </pre> <br>  We give the right to perform: <br><br><pre> <code class="bash hljs">chmod +x /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/gitlab-runner</code> </pre> <br>  Install gitlab-runner as a service and run it: <br><br><pre> <code class="bash hljs">gitlab-runner install gitlab-runner start</code> </pre> <br>  Now you need to register the runner to CI, this is done by the command: <br><br><pre> <code class="bash hljs">gitlab-runner register -n --url CI_URL --registration-token TOKEN --tag-list fastlane,cocoapods,osx_10-13,xcode_9-2 --executor shell</code> </pre> <br>  This is a command that should be explained in detail. <br>  CI_URL and TOKEN can be taken in the project settings on GitLab: <br>  Settings -&gt; CI / CD -&gt; Runners -&gt; Setup block of a specific Runner manually <br>  <i>--tag-list</i> : specifies the tags that we will need further when setting up the project itself. <br><br>  They can also be changed, for example, depending on which versions of Xcode are installed on the agent or what type of tasks we plan to perform on it. <br>  <i>--executor shell</i> : specify that the agent must perform actions on the command line. <br><br>  In order to avoid problems with CocoaPods, you also need to run the following commands: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'export LC_ALL="en_US.UTF-8"'</span></span> &gt;&gt; ~/.bash_profile <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'export LANG=en_US.UTF-8'</span></span> &gt;&gt; ~/.bash_profile</code> </pre> <br>  It is necessary that when installing the pods there were no errors with the encoding. <br>  After successful registration of the agent, it can be seen in the settings. <br>  Settings -&gt; CI / CD -&gt; Runners <br><br><img width="291" src="https://habrastorage.org/webt/bs/id/rj/bsidrjf8zcueh2e41k-c7blcvx4.png"><br><br><h4>  Project Setup </h4><br>  It remains to configure the Xcode project to work with GitLab CI. <br><br>  It is quite simple to do this: you need to put a .gitlab-ci.yml file with a description in the root of the project. <br><br>  After this file is added to the repository, the CI system will start executing the commands specified in it. <br><br>  An example of our yml file: <br><br><pre> <code class="hljs mel">stages: - test - archive before_script: - git submodule init - git submodule update --recursive - pod install --repo-update archive_project: stage: archive script: - fastlane <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> appstore - xcodebuild -<span class="hljs-keyword"><span class="hljs-keyword">workspace</span></span> iFunny.xcworkspace -scheme iFunny archive -archivePath build/iFunny.xcarchive | xcpretty only: - master - triggers - web artifacts: paths: - build/iFunny.xcarchive tags: - xcode_9<span class="hljs-number"><span class="hljs-number">-2</span></span> - osx_10<span class="hljs-number"><span class="hljs-number">-13</span></span> - cocoapods - fastlane test_project: stage: test script: - xcodebuild test -<span class="hljs-keyword"><span class="hljs-keyword">workspace</span></span> iFunny.xcworkspace -scheme iFunny -destination <span class="hljs-string"><span class="hljs-string">'platform=iOS Simulator,name=iPhone 7,OS=11.2'</span></span> | xcpretty tags: - xcode_9<span class="hljs-number"><span class="hljs-number">-2</span></span> - osx_10<span class="hljs-number"><span class="hljs-number">-13</span></span> - cocoapods - fastlane</code> </pre><br>  The yml format for GitLab CI is fairly well described <a href="https://docs.gitlab.com/ee/ci/yaml/">here</a> . <br><br>  So that you can easily use the sample file, I will describe the main points that we use: <br><br><ul><li>  <i>before_script</i> - describe the set of instructions that must be performed before each work on the CI.  For us, this is a standard set of submodule updates and installation of hearths; </li><li>  <i>archive_project</i> is the name used to get the artifact from xcarchive. </li></ul><br>  In the script we indicate all the instructions that need to be executed: <br><br><pre> <code class="bash hljs">fastlane match appstore</code> </pre> <br>  To synchronize certificates, fastlane has a good match command (for more information about using match, see <a href="https://docs.fastlane.tools/actions/match/">the fastlane website</a> ). <br><br>  The main command to run the archive build: <br><br><pre> <code class="bash hljs">xcodebuild -workspace Project.xcworkspace -scheme ProjectScheme archive -archivePath build/Project.xcarchive | xcpretty</code> </pre><br>  <i>Project.xcworkspace</i> - file with workspace. <br>  <i>ProjectScheme</i> - scheme with the main target. <br>  <i>build / Project.xcarchive</i> is the path where the working artifact will be assembled.  Further, this path is used in artifacts: it indicates the CI, from where you need to pick up the archive. <br><br>  In the block <i>only</i> , we indicate that this work should be done only on the master branch or when launched from the web, that is, when launched by the Run Pipeline button in CI / CD. <br><br>  <i>tags</i> are those tags that must be assigned to the agent in order for it to run this work.  Now they completely repeat what we indicated when registering an agent. <br>  Next in the file is a description of the <i>test_project</i> . <br><br>  From the interesting here - the test run line: <br><br><pre> <code class="bash hljs">xcodebuild <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> -workspace Project.xcworkspace -scheme ProjectScheme -destination <span class="hljs-string"><span class="hljs-string">'platform=iOS Simulator,name=iPhone 7,OS=11.2'</span></span> | xcpretty</code> </pre><br>  In the <i>-destination</i> setting, <i>we</i> specify the simulator that is exactly available on the agents. <br><br>  You can view the list of available devices on the agent via the SSH command: <br><br><pre> <code class="bash hljs">instruments -s list</code> </pre> <br>  After the <i>.gitlab-ci.yml</i> file has <i>been configured</i> , you can add it to the repository and the tests will be run automatically in the branch containing the file. <br><br><h3>  Conclusion </h3><br>  To set up the entire GitLab bundle and the embedded CI / CD system, we spent about half a working day, which is slightly more than 20 minutes spent setting up BuddyBuild. <br>  But what we got from the move: <br><br><ul><li>  own agents for assembling projects and a system for working with them; </li><li>  it was possible to reduce from 70 to 6 minutes the time for assembly with tests, or to 30 minutes for a full assembly with tests and archives; </li><li>  opportunities to optimize build time; </li><li>  we can access any customization and integration with any service. </li></ul><br>  For our team, GitLab CI is a temporary solution, now we are preparing to move to Jenkins, in which we will add even more automation to the project. <br><br>  Perhaps the experience described in the article will allow readers to move to GitLab CI in less than 4 hours. <br><br>  And to make it easier to do, here are a couple of scripts with the commands described in the article: <br><br><ul><li>  installation of dependencies; <br>  <a href="https://gist.github.com/amyhametov/7906bd811d683d14f19e75d6b6782852">install_dependencies.sh</a> <br></li><li>  installation and registration of agents. <br>  <a href="https://gist.github.com/amyhametov/b8aa204d762403183ddecbfd2bfe3944">install_agent.sh</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/353930/">https://habr.com/ru/post/353930/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353918/index.html">Concept: logo for Yekaterinburg from "Log machines"</a></li>
<li><a href="../353920/index.html">Fight for a smooth display in the video surveillance system: find jerks and neutralize</a></li>
<li><a href="../353924/index.html">9 Tips to Improve React Application Code Quality</a></li>
<li><a href="../353926/index.html">The most terrible mistakes that make DS. Meeting at Avito's office on April 24</a></li>
<li><a href="../353928/index.html">"Calendar of the tester" for April. Metrics in QA service</a></li>
<li><a href="../353932/index.html">Information Retrieval Course at the Winter Pushchino School: we teach high school students to create search engines</a></li>
<li><a href="../353936/index.html">Google Analytics: create remarketing lists from old users without limits</a></li>
<li><a href="../353938/index.html">Services for the selection of keywords on the App Store: a comparative characteristic</a></li>
<li><a href="../353940/index.html">The C ++ Standardization Committee rips the shackles off</a></li>
<li><a href="../353942/index.html">Modular development of Android applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>