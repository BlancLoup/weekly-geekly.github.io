<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What is Protected Mode and what it is eaten with</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In order to write an operating system, you need to understand many details. So let me enlighten you a little bit (but let's agree that you will read m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What is Protected Mode and what it is eaten with</h1><div class="post__text post__text-html js-mediator-article"> In order to write an operating system, you need to understand many details.  So let me enlighten you a little bit (but let's agree that you will read mana yourself so that there is something to talk about). <br>  Honestly, in the open spaces of the network there is a cloud of obese materials on PM, and <a href="https://habrahabr.ru/users/iley/" class="user_link">iley</a> and <a href="https://habrahabr.ru/users/pehat/" class="user_link">pehat</a> told <a href="https://habrahabr.ru/users/pehat/" class="user_link">us a</a> little about this mode, but I was asked to describe it anyway in the general framework.  Now we will briefly give out the theory (in general, specially for this Intel wrote mana), then we will begin to write code. <br><a name="habracut"></a><br><br>  <b>Introduction to protected mode.</b> <br>  So, PM is significantly different from all the usual since the days of DOS'a real mode (RM).  Now we have to get used to it: there are no static, 64 kilobyte segments, interrupt tables in the 1st kilobyte, addresses of the bases of the segments in the segment registers, in general a completely new world. <br>  Segments are now described in the <b>Global Descriptor Table (GDT)</b> .  This table can be only in one copy.  She is a structure in mind.  Not a segment!  It can be located in memory anywhere, but its address and limit are written to the GDTR register.  Here is its structure: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e29/2ca/b10/e292cab10ac895e659e6c3401af2a027.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The table itself consists of the entries of the following structure (by the way, the zero entry is empty. This is important. When accessing the memory, described by the null descriptor, get #GP - General Protection Fault): <br>  Let's take a closer look at this structure. <br><img src="https://habrastorage.org/getpro/habr/post_images/221/f01/8ce/221f018ce501cc497a5968c305282fe1.png" alt="image"><br><br>  <b>1. Segment Limit:</b> <br>  The purpose of this field is understandable by name, but there is subtlety.  The dog is buried in bit G (Granularity). <br>  If it is not installed, the memory is 'counted' in bytes.  In this case, the size of the segment can vary from 1 byte to 1 megabyte in size to 1 byte. <br>  If we set it to 1, then memory paging will be entered.  Then we can address from 4 kilobytes to 4 gigabytes of RAM with resizing by 4 kilobytes (page size).  In general, paged addressing is preferable (compare (1MB + 64Kb-16Byte) and 4GB).  Let's talk in this post only about segment addressing.  Paging deserves a separate discussion. <br><br>  <b>2. Base Address:</b> <br>  Here we indicate the physical address of the database. <br><br>  <b>3. Type field:</b> <br>  Bit combinations determine the type of segment: <br><img src="https://habrastorage.org/getpro/habr/post_images/6f2/5e5/b6d/6f25e5b6dfa5a70c4b257ac869302710.gif" alt="image"><br><br>  <b>4. S (descriptor type):</b> <br>  The Intel‚Äôs documentation says that if this bit is not set, then this descriptor is for the system segment, otherwise it is code or data.  Under the system means LDT, TSS, Interrupt Gates and others like them (about them later). <br><br>  <b>5. DPL (Descriptor Privilege Level):</b> <br>  Privileges of the described segment.  All familiar Rings. <br><br>  <b>6. P (segment present):</b> <br>  If this bit is set, the processor "knows" that the segment is already in memory (although it is better to say valid).  If you load into the segment register a descriptor selector with the P bit not set, then the exception #NP (not present) will occur.  In general, the meaning of this flowery phrase will explain later. <br><br>  <b>7. D / B:</b> <br>  For segments of different types is interpreted differently. <br>  <b>1. For code segments:</b> <br>  32 or 16 bit effective address length and operand dimension. <br>  (1-32; 0-16); <br>  <b>2. For the stack:</b> <br>  The stack pointer is 32 or 16 bit.  (1-32; 0-16); <br><br>  <b>8. G:</b> <br>  It affects the units in which (bytes, pages) the segment limit is measured.  In general, Paging can be enabled when switching to PM by setting the 31 bits of the CR0 register. <br><br>  <b>Some more info:</b> <br>  We guess that the word Global was set not in vain.  So there is still some kind of label.  True, there is also a <b>Local Descriptor Table</b> .  There may be a great many.  For example, they can be used in the implementation of tasks, etc.  But <b>LDT is</b> already a segment!  So get used to the phrases like 'descriptor segment of the local descriptor table'. <br><br>  After we describe the table, it needs to be loaded into the <b>GDTR register</b> .  This is done by no means mov.  <b>GDTR is</b> filled with the <b>lgdt fword command (value)</b> .  That is, it is necessary to form this structure independently and load it into the aforementioned register.  There are more teams working with this register, but we are galloping across Europe. <br><br>  One more thing.  In PM, segment registers are stored not in the base segment addresses (as in RM), but in specially trained pieces, called <b>selectors</b> .  Their structure is as follows: <br><img src="https://habrastorage.org/getpro/habr/post_images/30a/77e/a96/30a77ea9623f452b11a8e9b4932b93b1.png" alt="image"><br>  Here Index is the sequence number of the descriptor in the table. <br>  TI shows where to look for a descriptor (in <b>GDT</b> or <b>LDT</b> ). <br><br>  Now, when it is already clear how to build a table, let's talk about how to go to PM (I note that this can only be done from RM).  In general ... you just need to set bit 0 of the control register CR0.  While lying.  First you need to disable all interrupts ( <b>NMI</b> ( <b>Non Maskable Interrupts</b> ) including), open the <b>A20</b> address line (so that 32-bit addressing is available), load <b>GDTR</b> , and jump to the start flag. <br><br>  Let's use the bootloader (you can take KOLIBRI), which will load our code to the address 1000h: 0 (RM'ovsky, I note, the address). <br>  Not everything will be as smooth here as in the manners when they go straight to PM from bootloader.  Everything is a little more complicated.  But first, let's analyze the code that the bootloader will load (we write everything on FASM).  This is a kind of helloworld.  Boot in, go to PM and print a greeting.  Everything. <br><br> <code>format binary <br> xor ax,ax <br> cli ;   <br> mov ss,ax <br> xor sp,sp <br> sti <br> mov ax,3 <br> int 10h <br> <br> jmp 1000h:r_start <br> <br> r_start: <br> <br> mov ax,1000h;  <br> mov ds,ax <br> mov es,ax <br> <br> in al, 0x92; A20 <br> or al, 2 <br> out 0x92, al <br> <br> cli ;  <br> mov al,8Fh; NMI <br> out 70h,al <br> in al,71h <br> <br> lgdt fword [GDTR];  GDTR <br> mov eax,cr0 <br> or al,1; 0-  <br> mov cr0,eax; PM <br> <br> jmp fword 08h:Startup32;   PM <br> <br> align 8 ;      <br> GDT: <br> dq 0 ; <br> db 0FFh,0FFh,0,0,0,9Ah,0CFh,0 ; <br> db 0FFh,0FFh,0,0,0,92h,0CFh,0; <br> db 0FFh,0FFh,0,80h,0Bh,92h,40h,0 ; <br> label GDT_SIZE at $-GDT <br> GDTR: <br> dw GDT_SIZE-1 <br> dd GDT+10000h <br> ;   32- .      1000h,   1000h*10h ( ; ) =&gt;   GDTR (!) = 10000h (   )+offset <br> <br> virtual ;, ,      <br> rb 10000h-$; <br> end virtual <br> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;PM32 Entry;;;;;;;;;;;;;;;;;;; <br> use32 <br> org $+10000h;  :  PM    Flat-,      ; PM  org',  ;      Flat .  . <br> <br> Startup32: ;   PM <br> mov ax,10h ;  .  (!       <br> mov es,ax ;)    - 08h.  - 10h,  - 18h <br> mov ds,ax <br> mov fs,ax <br> mov ss,ax <br> mov esp,10000h; <br> mov ax,18h <br> mov gs,ax <br> <br> mov esi,hi_string ;,     <br> call print <br> jmp $ <br> <br> ;ESI -   <br> print: <br> pushad <br> xor ebx,ebx <br> mov ah,07h; <br> puts: <br> mov al,[esi+ebx] <br> mov [gs:(ebx*2)],ax <br> inc ebx <br> test al,al <br> jnz puts <br> popad <br> ret <br> hi_string db 'Welcome to PM, dude',0 <br></code> <br><br>  What have we done?  The loader successfully loaded us at the address 1000h: 0, from where we continued execution.  First, they turned on <b>A20</b> , banned all interruptions, loaded a suitable value into <b>GDTR</b> , jumped to the input label.  I note that we jumped on <br> <code>jmp fword 08h:Startup32</code> <br>  Ie 08h - code descriptor selector.  Get used to it. <br><br>  Now how to run this miracle.  I personally use WinImage and VirtualBox.  We push the bootloader into the floppy disk sector and put the .bin file in the root.  We save in .vfd, set the path to the floppy image in the properties of the virtual machine, run and see the result. <br><br>  In the next issue we will look at interrupts, faults, traps, aborts and how they work, are caught and debugged.  Let's start talking about architecture. <br><br>  Information sources. <br>  1) Just want to express my gratitude to Phantom_84 aka egos for pointing the right path and helping me in the very beginning.  Without it, it would be much harder for me to figure it out. <br>  2) <a href="http://www.wasm.ru/publist.php%3Flist%3D24">BrokenSword</a> Articles BrokenSword Articles.  They should pay attention. <br>  3) <a href="http://www.intel.com/products/processor/manuals/">Intel System Programming Guides</a> </div><p>Source: <a href="https://habr.com/ru/post/118881/">https://habr.com/ru/post/118881/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../118871/index.html">Usability usa</a></li>
<li><a href="../118873/index.html">Efficient labor organization</a></li>
<li><a href="../118878/index.html">ITsrach.ru - do not keep in yourself!</a></li>
<li><a href="../118879/index.html">0day vulnerability in Skype for Mac OS X version</a></li>
<li><a href="../118880/index.html">Review of online sound editors and sequencers</a></li>
<li><a href="../118885/index.html">Google introduced the open platform WebGL Globe</a></li>
<li><a href="../118886/index.html">LastPass: ‚ÄúXmarks was not hurt‚Äù</a></li>
<li><a href="../118887/index.html">Apple nuance</a></li>
<li><a href="../118889/index.html">Google added Flash support in Instant Preview</a></li>
<li><a href="../118892/index.html">News 2.0.1-beta</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>