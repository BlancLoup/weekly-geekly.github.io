<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Determining that you are at home using a WiFi router (to automate the smart home)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In a previous article, I described the climate control device on the ESP8266 . The question arises, and under what events should we carry out this man...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Determining that you are at home using a WiFi router (to automate the smart home)</h1><div class="post__text post__text-html js-mediator-article">  In a previous article, I described the <a href="https://geektimes.ru/post/285942/">climate control device on the ESP8266</a> .  The question arises, and under what events should we carry out this management?  The simplest is when a certain time comes. <br><br>  The second thing that comes to mind is a presence in the house.  If you are not at home, then there is no sense (or is there?) To air, heat and condition the room. <br><br>  In this article we will consider the possibility of determining presence using a wifi router.  No, we will not <a href="https://habrahabr.ru/post/149293/">track people through the walls using the wifi signal</a> , but use the status page in the wifi router's web interface, and by the presence of your smartphone in the list, we can understand whether you are at home or not. <br><a name="habracut"></a><br>  Naturally, this method will not work if you, or someone from your family, does not use a smartphone, disables wifi, if you do not have wifi, when leaving, leave the device at home.  The article also describes a ‚Äúrecipe‚Äù for a specific dlink router.  If you have another model - it is likely that you will have to "modify the file." 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A page displaying a <a href="http://support.dlink.com/emulators/dir615_revC/310NA/st_wireless.htm">list of wifi clients</a> looks like this: <br><br><img src="https://habrastorage.org/files/794/49f/7f8/79449f7f80144438b4ccd373826df90b.png"><br><br>  To access this page, we need to log in to the router.  We study the source code of the password entry page and see: <br><br>  1) in the password entry page the router sends salt and authid. <br>  2) the router takes the first 16 digits from the password, combines them with salt, ‚Äúfinishes‚Äù the string with the chr (1) symbol up to 64 characters. <br>  3) For the resulting 64x character string counts MD5. <br>  4) combines salt + md5 <br>  5) forms a string like <br><br><pre><code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">//192.168.0.1/post_login.xml?hash=a33403f9aded48e57FF9e09d37d9009026e1ce85&amp;auth_code=&amp;auth_id=09CFF</span></span></code> </pre> <br>  where hash is a string obtained in p4., auth_id is a string obtained in n1. <br><br>  6) if the authorization was successful, the router returns xml with the page address for the redirect. <br><br>  Code about the following: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> salt = <span class="hljs-string"><span class="hljs-string">'a33403f9'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> password = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.forms.myform.old_password.value; password = password.substr(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = password.length; i &lt; <span class="hljs-number"><span class="hljs-number">16</span></span>; i++) { password += <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> input = salt + password; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = input.length; i &lt; <span class="hljs-number"><span class="hljs-number">63</span></span>; i++) { input += <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(<span class="hljs-number"><span class="hljs-number">1</span></span>); } input += (<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.forms.myform.old_username.value == <span class="hljs-string"><span class="hljs-string">'user'</span></span>) ? <span class="hljs-string"><span class="hljs-string">'U'</span></span> : <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hash = hex_md5(input); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> login_hash = salt.concat(hash); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> auth_url = <span class="hljs-string"><span class="hljs-string">''</span></span>; auth_url = <span class="hljs-string"><span class="hljs-string">'&amp;auth_code='</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.forms.myform.auth_code.value + <span class="hljs-string"><span class="hljs-string">'&amp;auth_id=09C05'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xml_loader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ajax_xmlhttp(<span class="hljs-string"><span class="hljs-string">'/post_login.xml?hash='</span></span> + login_hash + auth_url, xml_ready, xml_timeout);</code> </pre><br>  After we logged in to the router‚Äôs page, it‚Äôs enough to request: <br><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">//192.168.0.1/wifi_assoc.xml</span></span></code> </pre> <br>  and we get an XML of the form: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wifi_assoc</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">radio</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">assoc</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mac</span></span></span><span class="hljs-tag">&gt;</span></span>18FEFFFFCCFF<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mac</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ssid</span></span></span><span class="hljs-tag">&gt;</span></span>bingo<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ssid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">channel</span></span></span><span class="hljs-tag">&gt;</span></span>8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">channel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rate</span></span></span><span class="hljs-tag">&gt;</span></span>65<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">quality</span></span></span><span class="hljs-tag">&gt;</span></span>100<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">quality</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span>802.11n (2.4GHz)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip_address</span></span></span><span class="hljs-tag">&gt;</span></span>192.168.0.3<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip_address</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">assoc</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">assoc</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mac</span></span></span><span class="hljs-tag">&gt;</span></span>001DFEFF70FF<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mac</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ssid</span></span></span><span class="hljs-tag">&gt;</span></span>bingo<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ssid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">channel</span></span></span><span class="hljs-tag">&gt;</span></span>8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">channel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rate</span></span></span><span class="hljs-tag">&gt;</span></span>65<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">quality</span></span></span><span class="hljs-tag">&gt;</span></span>84<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">quality</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span>802.11n (2.4GHz)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip_address</span></span></span><span class="hljs-tag">&gt;</span></span>192.168.0.4<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip_address</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">assoc</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">assoc</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mac</span></span></span><span class="hljs-tag">&gt;</span></span>AC37FFFFDCFF<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mac</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ssid</span></span></span><span class="hljs-tag">&gt;</span></span>bingo<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ssid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">channel</span></span></span><span class="hljs-tag">&gt;</span></span>8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">channel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rate</span></span></span><span class="hljs-tag">&gt;</span></span>104<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">quality</span></span></span><span class="hljs-tag">&gt;</span></span>100<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">quality</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span>802.11n (2.4GHz)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip_address</span></span></span><span class="hljs-tag">&gt;</span></span>192.168.0.5<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip_address</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">assoc</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">assoc</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mac</span></span></span><span class="hljs-tag">&gt;</span></span>18FEFFFFFFDF<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mac</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ssid</span></span></span><span class="hljs-tag">&gt;</span></span>bingo<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ssid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">channel</span></span></span><span class="hljs-tag">&gt;</span></span>8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">channel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rate</span></span></span><span class="hljs-tag">&gt;</span></span>58<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">quality</span></span></span><span class="hljs-tag">&gt;</span></span>100<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">quality</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span>802.11n (2.4GHz)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip_address</span></span></span><span class="hljs-tag">&gt;</span></span>192.168.0.6<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip_address</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">assoc</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">radio</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wifi_assoc</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Having checked the availability of the MAC of your smartphone in this list, we can easily determine whether you * are at home or not. <br><br><div class="spoiler">  <b class="spoiler_title">The firmware for ESP8266 was such</b> <div class="spoiler_text">  * Due to restrictions on the amount of available memory, you cannot simply load pages into memory as a whole and perform search / parsing in memory.  I had to use a primitive scanner to search for a pattern.  I apologize in advance for the code from experts and thank you for the constructive suggestions for modification. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266WiFi.h&gt; #include &lt;ESP8266HTTPClient.h&gt; #include &lt;MD5Builder.h&gt; MD5Builder _md5; HTTPClient http; const char* ssid = "bingo"; const char* password = "qqq_zzz_xxx"; const char* ap_ssid = "esp"; const char* ap_password = "espqw3454#1"; // salt const char* patternSalt = "var salt = \""; const int patternsaltLen = strlen(patternSalt); int patternsaltPos = 0; char salt[20] = ""; int saltLen = sizeof(salt); int saltPos = 0; // auth const char* patternAuthID = "\"&amp;auth_id="; const int patternAuthIDLen = strlen(patternAuthID); int patternAuthIDPos = 0; char authID[20] = ""; int authIDLen = sizeof(authID); int authIDPos = 0; // mac const char* patternMac = "&lt;mac&gt;"; const int patternMacLen = strlen(patternMac); int patternMacPos = 0; char mac[20] = ""; int macLen = sizeof(mac); int macPos = 0; typedef void (*patternSearchFinishedHandler)(); void patternSearchFinishedDummy() {} void patternSearchFinishedMac() { Serial.print("mac="); Serial.println(mac); mac[0] = (char) 0; macPos = 0; } void setup() { Serial.begin(115200); WiFi.softAP(ap_ssid, ap_password); WiFi.mode(WIFI_AP_STA); WiFi.begin(ssid, password); Serial.println("Setup Completed"); } void charBuf_to_u8buf(const char buf1[128], uint8_t buf2[128], int buffSize){ for (int i=0; i &lt; buffSize; i++){ buf2[i] = (uint8_t)buf1[i]; } } void u8buf_to_charBuf(const uint8_t buf1[128], char buf2[128], int buffSize){ for (int i=0; i &lt; buffSize; i++){ buf2[i] = (char)buf1[i]; } } void checkPattern(int* tpos, int tlen, char c, const char* templ, char* data, int* datapos, int datalen, char finishChar, patternSearchFinishedHandler handler){ if (*tpos == tlen) { if (finishChar == c){ if (patternSearchFinishedDummy != handler){ delay(10); handler(); } *tpos = 0; } else { if (*datapos &lt; datalen-2){ data[*datapos] = c; data[*datapos + 1] = (char) 0; *datapos += 1; } } } else { if (templ[*tpos] == c){ *tpos += 1; }else{ *tpos = 0; } } } void processBuffer(uint8_t buff[128], int buffSize){ char cbuf[128] = {}; u8buf_to_charBuf(buff, cbuf, buffSize); for (int i=0; i &lt; buffSize; i++){ checkPattern(&amp;patternsaltPos, patternsaltLen, cbuf[i], patternSalt, salt, &amp;saltPos, saltLen, '"', patternSearchFinishedDummy); checkPattern(&amp;patternAuthIDPos, patternAuthIDLen, cbuf[i], patternAuthID, authID, &amp;authIDPos, authIDLen, '"', patternSearchFinishedDummy); checkPattern(&amp;patternMacPos, patternMacLen, cbuf[i], patternMac, mac, &amp;macPos, macLen, '&lt;', patternSearchFinishedMac); } } String md5(String str) { _md5.begin(); _md5.add(String(str)); _md5.calculate(); return _md5.toString(); } void intVars() { // init vars salt[0] = (char) 0; saltPos = 0; authID[0] = (char) 0; authIDPos = 0; mac[0] = (char) 0; macPos = 0; } void queryAddress(String address, bool dumpOutput, bool doProcessBuffer){ delay(10); // configure server and url http.begin(address); // Serial.print("[HTTP] GET...\n"); // start connection and send HTTP header int httpCode = http.GET(); if(httpCode &gt; 0) { // HTTP header has been send and Server response header has been handled Serial.printf("[HTTP] GET... code: %d\n", httpCode); // file found at server if(httpCode == HTTP_CODE_OK) { // get lenght of document (is -1 when Server sends no Content-Length header) int len = http.getSize(); // create buffer for read uint8_t buff[128] = { 0 }; // get tcp stream WiFiClient * stream = http.getStreamPtr(); // read all data from server while(http.connected() &amp;&amp; (len &gt; 0 || len == -1)) { // get available data size size_t size = stream-&gt;available(); if(size) { // read up to 128 byte int c = stream-&gt;readBytes(buff, ((size &gt; sizeof(buff)) ? sizeof(buff) : size)); if (doProcessBuffer){ processBuffer(buff,c); } // write it to Serial if (dumpOutput){ Serial.write(buff, c); } if(len &gt; 0) { len -= c; } } delay(10); } Serial.println(); Serial.print("[HTTP] connection closed or file end.\n"); } } else { Serial.printf("[HTTP] GET... failed, error: %s\n", http.errorToString(httpCode).c_str()); } http.end(); } void queryData(){ intVars(); queryAddress("http://192.168.0.1/", false, true); Serial.print("salt="); Serial.println(salt); Serial.print("authID="); Serial.println(authID); String data = ""; data.concat(salt); // password data.concat("bingo_fff#xxx "); data = md5(data); String addr = "http://192.168.0.1/post_login.xml?hash="; addr.concat(salt); addr.concat(data); addr.concat("&amp;auth_code=&amp;auth_id="); addr.concat(authID); queryAddress(addr, false, false); queryAddress("http://192.168.0.1/wifi_assoc.xml", false, true); delay(10000); } void loop() { // Wait for connection if (WiFi.status() == WL_CONNECTED) { queryData(); } else { delay(500); Serial.print("."); } }</span></span></span></span></code> </pre><br>  The firmware periodically displays a list of connected devices in the console. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/357916/">https://habr.com/ru/post/357916/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../357906/index.html">Arduino C ++ 11 library for managing LED arrays</a></li>
<li><a href="../357908/index.html">All lessons on Arduino</a></li>
<li><a href="../357910/index.html">Using Template Metaprogramming for AVR Microcontrollers</a></li>
<li><a href="../357912/index.html">We program Arduino using Sublime + Stino on MacOS</a></li>
<li><a href="../357914/index.html">Software graphic coprocessor on STM32</a></li>
<li><a href="../357918/index.html">I2C sniffer</a></li>
<li><a href="../357920/index.html">Arduino <-> STM32 HAL, or there and back</a></li>
<li><a href="../357922/index.html">As I wrote code for Arduino using Python</a></li>
<li><a href="../357924/index.html">Keyboard layout indicator in the form of a color cube on the table using Arduino</a></li>
<li><a href="../357928/index.html">On power up</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>