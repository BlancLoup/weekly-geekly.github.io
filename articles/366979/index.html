<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Management of a curtain on the RS-485 interface</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About the benefits of controlling the curtain through rs-485 
 Some time ago I had an electric carriage for sliding curtains AKKO AM72E. It‚Äôs not that...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Management of a curtain on the RS-485 interface</h1><div class="post__text post__text-html js-mediator-article"><h2>  About the benefits of controlling the curtain through rs-485 </h2><br>  Some time ago I had an electric carriage for sliding curtains AKKO AM72E.  It‚Äôs not that I‚Äôm too lazy to move the curtains with my hands, but progress is going forward and I try to go after it.  The electric motor can be controlled both by dry contacts and from the radio control.  But who needs this commonplace, if the motor supports the RS485 interface, which allows not only to give commands, but also to read the condition of the curtains.  And in general, the ultimate goal to manage the eaves from your phone, and why not. <br><br>  The easiest way would be to find a USB-RS485 adapter and start testing.  But there was no such adapter nearby.  If ordered, it would take some time to wait.  Faster to do.  I have several USB-UART adapters on all popular microcircuits, but I mostly use a pair of adapters for the CP2103.  They look like this: <br><br><img src="https://habrastorage.org/files/d9a/f2c/2a1/d9af2c2a169e43eab8f770864492b860.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Approximately, because the connectors are installed and additional signals are output.  All you need to do adapter UART-RS485.  The store bought several MAX485.  It might be easier to use something like the MAX13487 with automatic gearshift and reception.  But I didn‚Äôt find one at a local store (maybe I was just looking bad).  Honestly, I was too lazy to go to the store for MAX485.  Initially, there was a desire to make reception at the OS, and a transmitter on transistors - it‚Äôs so easy to test whether the AM72E electric screen works using this protocol or not. <br><a name="habracut"></a><br><h2>  Back to "Modern Electronics" </h2><br>  The case for the scheme.  For the basis, I took the scheme from the magazine "Modern Electronics" ‚Ññ1 for 2007.  Everything looked rosy.  The article says that the CP2103 microcontroller pins are programmed by default as control outputs and correspond to their use in the USB-RS485 adapter circuit.  It turned out that this is not my case.  I have adapters for a long time.  A rare thing that fell into my hands is not subjected to "improvement."  The firmware in the adapters was not an exception, and even if the girlhood could pester the RS485, now these skills have been completely canceled. <br><br>  The evening stopped being languid.  It was necessary that something that will switch the MAX485 from transmission to reception.  By the way, the transfer adapter worked fine.  In general, this could be enough, since there is nothing special to read with the AM72E. <br><br>  There were many options.  MAX485 on the board is mounted on the panel, and can easily be replaced with a microcircuit, with auto-switching transmit and receive.  But this is not an option at all, because you have to go to the store.  I also have adapters for FT232, and these chips can switch the MAX485.  Too easy.  And I already had a plan, how can I have some fun with AM72E and for FT232 there was no place in it.  It is necessary to supplement the circuit so that when the start bit appears on the TX UART, MAX485 switches from reception to transmission and is in this state at the time of transmission of the entire byte, and then again switched to reception.  Referring to the experience gained through me through google, I found out that this problem is solved with the help of the timer NE555.  Indeed, why wise.  But I didn‚Äôt have anything from the NE555 family timers.  Further you know: shop - laziness. <br><br><h2>  Odometer for lazy ... not needed </h2><br>  Make one-shot in a million ways.  I even wanted to quickly remake the board and put the STM8S003 for these purposes.  At first glance, this may look like a cannon on sparrows, but if you compare the circuits on the NE555 and STM8S003, then the circuit on the MC will be even simpler, because of the external elements only one capacitor is needed.  The program is literally a few lines in assembler.  With the price, too, everything is not bad - it is cheaper than the MAX485 in our store.  There is one problem with the hardware timer (on the NE555).  It will work fine at the same speed.  As soon as you need to change the exchange rate, you will have to rebuild the timer.  I often come across devices that, when launched, give out debugging information to the UART at one speed, and after loading, they switch to exchange mode for another.  And you never know why you may need to change the speed!  Each time you do not want to climb into the scheme.  This is where the timer on STM8 can help - you can write the program so that the necessary timings are set on-signal and do not require intervention.  It is not very difficult.  I don‚Äôt understand why I need to know something about the UART exchange rate.  Many years ago, I came across UART devices that automatically determined the speed at which another device was connected and were tuned to it on the fly. <br><br>  I know that you would like to see the scheme without STM8S003.  Okay, I'll go to meet you.  And without this, I can make something interesting out of a simple test.  There will be no one-shot in the circuit: <br><br><img src="https://habrastorage.org/files/6a0/2bb/921/6a02bb9213694859a673b6407069efa6.jpg"><br><br>  What and how it works here, I will not explain - everything is standard and obvious.  I can only say that I did not install the jumpers near the resistors R5 and R7, that is, the circuit can be made easier by removing all the jumpers and these two resistors.  The maximum you may need is R5.  There are devices that, when answered, simply release the line when transmitting the last bits, if they are ones.  Then, without R5, the last byte can be distorted.  In our case, this is not important.  the last byte of the most significant byte of the response checksum.  The scheme will work without R1, but we will need it later. <br><br>  It looks like this to me: <br><br><img src="https://habrastorage.org/files/819/d52/1b3/819d521b35af438abf43a42134f768bc.jpg"><br><br>  Do not be discouraged if you do not see all the elements that are on the diagram.  At first I made the board according to the scheme from the article, and then experimented with the transfer-pickup scheme.  The transistor (DTC143 in SOT23, immediately with the base resistor) and SMD resistors are soldered directly to the tracks on the back side of the board. <br><br>  If you put the MAX13487, then nothing will be left of the circuit at all.  Even better, get a standard USB-RS485 adapter.  But then you will be tied with wires to the curtains.  Stupid sight.  Would I bother with the UART-RS485 adapter if I didn‚Äôt have a cunning plan? <br><br><h2>  Lua to help us </h2><br>  With iron on this finish.  Need to write a program.  The program is only for the test.  Nothing complicated.  It is necessary to send commands for AM72E to a serial port.  Well, you can still read that he is responsible for us there.  For the experiences take a computer with Windows.  We must choose the language in which we will write.  The first thing that came to my mind was powershell.  No, I will not torture you powershell.  Then python.  Python is good for everyone - the code on it is portable to any OSes, it‚Äôs understandable, you can immediately bolt the GUI, and for Windows you can also package it as an executable so that few people will understand that the program is in python.  And still not python.  There are many examples of working with a serial port on Python and without it - anyone can find it on their own.  The program will write on Lua.  Yeah, a strange choice.  Actually, I had no big choice.  Either C or Lua.  Why - more on that later.  It is possible and C. But no, not this time.  Just because in C I write the code in such a way that after a couple of months I can‚Äôt understand it myself without accepting substances that expand consciousness.  Just kidding  So I write in any language. <br><br>  Lua needs to be installed.  We take from here: <a href="https://code.google.com/p/luaforwindows/downloads/list">https://code.google.com/p/luaforwindows/downloads/list</a> .  It is installed in almost one click.  Includes a sufficient number of modules.  There is everything you need.  Including for the graphical interface - iup.  If you decide that you need it - use on health.  But we will manage the command line.  We are only for testing.  And we need a module to work with the serial port.  If we decided to conduct testing under Linux or Mac OS, then it would be possible to work with a serial port without an additional module - just as with a file.  To access the UART for Windows, we need the luars232 module.  In the assembly it is already there.  In addition, nothing to search and install is not necessary. <br><br>  The file with the program - curtain.lua - only a few dozen lines.  If desired, you can still reduce.  How to use, I will not explain.  I will show the picture: <br><br><img src="https://habrastorage.org/files/aa7/9c1/805/aa79c18056dc410aacc650f824b31a98.jpg"><br><br>  I will make only one explanation.  This is obvious, but if the line starts with a ‚Äú&gt;‚Äù character, then this line is entered from the keyboard.  If this character is not at the beginning of the line, the line is received from the program. <br><br>  I did not expect that everything will be clear to everyone.  The command line, like the wires, we do not need.  What matters now is that the RS485 on the AM72E works great.  No, I had a moment when I gathered and checked everything, and I started sending commands to the AM72E, but he didn‚Äôt react at all.  The idea that the RS485 still does not work flashed through my mind.  But then I looked under the table, where I had a network extension cable, and saw that the AM72E should still be connected to the network.  After that, when I sent the ‚ÄúClose‚Äù command, I heard a cheerful buzzing of the engine - everything works. <br><br>  I‚Äôll take a little rest and move on to implementing my ‚Äúcunning plan‚Äù - I‚Äôll teach my electric carnet to accept commands via WiFi.  What will report in the next article. </div><p>Source: <a href="https://habr.com/ru/post/366979/">https://habr.com/ru/post/366979/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../366965/index.html">"Pirate" sites are preparing for perpetual blocking</a></li>
<li><a href="../366969/index.html">Ultrasound helped for the first time to overcome the blood-brain barrier: the technique will increase the effectiveness of chemotherapy for brain tumors</a></li>
<li><a href="../366971/index.html">7 questions to the broker or what the ruble suffers</a></li>
<li><a href="../366973/index.html">MPAA: online privacy hurts anti-piracy initiatives</a></li>
<li><a href="../366975/index.html">Dawn - mission in the asteroid belt</a></li>
<li><a href="../366981/index.html">Mystick Review: A post that could be written with a piece of banana</a></li>
<li><a href="../366983/index.html">The new Google tool aggregates in one place all the user's personal information.</a></li>
<li><a href="../366985/index.html">Google‚Äôs phishing anti-phishing extension turned out to be useless</a></li>
<li><a href="../366987/index.html">Nvidia has released a new mobile supercomputer: 1 teraflops on a small board</a></li>
<li><a href="../366989/index.html">School children discovered the largest known double neutron star systems.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>