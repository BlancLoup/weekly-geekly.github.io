<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Setting up server operation on CentOS with 2 gateways and balancing between them</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Instead of intro 
 The earlier article I read on Habr√© was taken as a basis, which I personally found enough to understand the mechanism of policy rou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Setting up server operation on CentOS with 2 gateways and balancing between them</h1><div class="post__text post__text-html js-mediator-article"><h4>  Instead of intro </h4><br>  The <a href="http://habrahabr.ru/post/108690/">earlier article I read on Habr√© was</a> taken as a basis, which I personally found enough to understand the mechanism of policy routing as a whole - and it‚Äôs catastrophically not enough to implement this type of routing on the company's server.  There were 2 serious pitfalls that I had to work on independently, and which cannot be ignored: <br><br><ul><li>  <b>Saving settings in general</b> </li><li>  <b>Breaking the settings with the Network Manager utility</b> </li></ul><br><br>  I will write my article in the form of the instruction that I wrote for future generations of IT people in my company - so I will give some points from the <b>main article</b> either unchanged or re-told to myself.  <i>They will be in italics</i> .  For a full understanding of what is written here, I recommend to <a href="http://habrahabr.ru/post/108690/">read</a> it in full. <br><a name="habracut"></a><br><h5>  A little practice, or what we want </h5><br>  And we want to get a routing that: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  <i>will send data to the same gateway from which the request came</i> </li><li>  <i>will control load balancing between gateways using so-called</i>  <i>"Weight" (weight) gateways</i> </li></ul>  <i>For these purposes, we will use the iproute2 utility, included in the standard distribution of all Linux distributions.</i> <i><br><br></i>  <i><b>We issue IP addresses:</b></i> <br><pre><code class="bash hljs">ip aa 11.11.11.11/22 dev eth6 ip aa 22.22.22.22/28 dev eth5</code> </pre> <br><br>  <i><b>Define the tables:</b></i> <i><br></i>  <i>To use more than one route, static routing is no longer enough.</i>  <i>For OSPF, our scheme is too simple, so let's focus on dynamic routing using tables.</i> <br><br><pre> <code class="bash hljs">ip route add default via 22.22.22.17 table 101 ip route add default via 11.11.8.1 table 102</code> </pre><br><br>  <b>Wrap outgoing traffic to the gateways from which the incoming came:</b> <br><br><pre> <code class="bash hljs">ip rule add from 22.22.22.17 table 101 ip rule add from 11.11.8.1 table 102</code> </pre><br><br>  <i>I think now it is not necessary to explain the meaning of these lines.</i>  <i>Similarly, server availability can be made at more than two gateways.</i> <br><br>  <b>Balancing traffic between uplinks</b> <br>  <i>It is done by one elegant team:</i> <br><br><pre> <code class="bash hljs">ip route replace default scope global \ nexthop via 22.22.22.17 dev eth5 weight 3 \ nexthop via 11.11.8.1 dev eth6 weight 7</code> </pre><br><br>  <i>This entry will replace the existing default routing in the main table.</i>  <i>In this case, the route will be selected depending on the weight of the gateway (weight).</i>  <i>For example, when specifying weights 7 and 3, 70% of the connections go through the first gateway, and 30% through the second gateway.</i>  <i>There is one thing that must be taken into account: the kernel caches routes, and the route for a host through a certain gateway will hang in the table for some time after the last access to this entry.</i>  <i>A route to frequently used hosts may not have time to be reset and will be updated all the time in the cache, remaining on the same gateway.</i>  <i>If this is a problem, you can sometimes clear the cache manually with the ip route flush cache command.</i> <br><br>  <b>Result</b> <br>  After running this command, you can check the availability of the server  In principle, it could be said that our work was over.  However, there is one problem - after a reboot, all settings will be reset. <br><br><h5>  Saving settings in general </h5><br>  Now it is necessary to force the system to apply the obtained settings after a reboot. <br><br>  <b>IP addresses</b> <br>  First, we find out which mac-address belongs to which interface.  Execute the command: <br><br><pre> <code class="bash hljs">ip a</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">And we see the adapter settings (mac-addresses consist of the letters a or b):</b> <div class="spoiler_text"><pre> <code class="bash hljs">2: eth6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000 link/ether aa:aa:aa:aa:aa:aa brd ff:ff:ff:ff:ff:ff inet 11.11.11.11/22 brd 11.11.11.255 scope global eth6 3: eth5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000 link/ether bb:bb:bb:bb:bb:bb brd ff:ff:ff:ff:ff:ff inet 22.22.22.22/28 brd 22.22.22.31 scope global eth5</code> </pre> </div></div><br>  Next, create ifconfig configuration configuration files using the received mac-addresses.  To do this, create files with the prefix ifcfg and the name of the interface in the folder <br><br><div class="spoiler">  <b class="spoiler_title">/ etc / sysconfig / network-scripts:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-eth5 DEVICE=eth5 TYPE=Ethernet ONBOOT=yes NM_CONTROLLED=yes BOOTPROTO=none IPV6INIT=no IPADDR=22.22.22.22 PREFIX=28 HWADDR=bb:bb:bb:bb:bb:bb GATEWAY=22.22.22.17 DEFROUTE=yes NAME=eth5 # cat /etc/sysconfig/network-scripts/ifcfg-eth6 DEVICE=eth6 TYPE=Ethernet ONBOOT=yes NM_CONTROLLED=yes BOOTPROTO=none IPV6INIT=no IPADDR=11.11.11.11 PREFIX=22 HWADDR=aa:aa:aa:aa:aa:aa</span></span></code> </pre><br></div></div><br><br>  <b>Create routing tables</b> <br>  Next, you need to create permanent tables, assign names to them (to make it easier to navigate) and set the rules for using these tables: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/iproute2/ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"101 int"</span></span> &gt;&gt; rt_tables <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"102 ext"</span></span> &gt;&gt; rt_tables</code> </pre><br><br>  Now go back to the <code>/etc/sysconfig/network-scripts</code> directory and continue working there. <br>  Create the contents of the tables: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat route-eth5 default via 22.22.22.17 table ext # cat route-eth6 default via 11.11.8.1 table int</span></span></code> </pre><br><br>  Create rules for processing these tables: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat rule-eth5 from 22.22.22.22 lookup ext # cat rule-eth6 from 11.11.11.11 lookup int</span></span></code> </pre><br><br>  <b>Balancing</b> <br>  Next, replace the static dynamics.  Not without a file, because  The startup scripts described above are bound to interfaces, and in our case, the rule is written immediately about 2 interfaces.  Therefore, it was decided to create a separate script and set it to autoload using the standard Linux autorun mechanism - <code>/etc/rc.local</code> .  Script content: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /etc/network.sh #!/bin/bash /sbin/ip route replace default scope global nexthop via 11.11.8.1 dev eth6 weight 7 nexthop via 22.22.22.17 dev eth5 weight 3 exit 0</span></span></code> </pre><br><br>  His path to autoload: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /etc/rc.local #!/bin/sh touch /var/lock/subsys/local /bin/bash /etc/network.sh</span></span></code> </pre><br><br>  For those who have not earned the execution of the file rc.local, please run the following commands: <br><pre> <code class="bash hljs">chmod u+x /etc/rc.d/rc.local systemctl start rc-local</code> </pre><br><br>  <s>As a result, after a reboot, we get a working system using 2 independent uplinks, the traffic between which is balanced by the weight.</s>  And now the sad news: none of this will work. <br><br><h5>  Breaking the settings with the Network Manager utility </h5><br>  The smaller problem of those that were on my way, but which nevertheless, pretty much spoiled my nerves.  The problem with this utility is that it saves and uses settings not from the main configuration files of the system, but from its internal ones.  Since it starts along with X11, that is, at the very last moment, when the network is already running, it overwrites the network settings, and it will not be possible to build some complicated configurations on it. <br><br>  To disable it, you need to run in the console: <br><br><pre> <code class="bash hljs">sudo /etc/init.d/NetworkManager stop chkconfig NetworkManager off</code> </pre><br><br>  Also, you can go the other way and use the systemctl: <br><pre> <code class="bash hljs">systemctl <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span> NetworkManager systemctl stop NetworkManager</code> </pre><br>  <b>Result</b> <br>  And after performing this action and rebooting, we get a working system using 2 independent uplinks, the traffic between which is balanced with the help of weight. </div><p>Source: <a href="https://habr.com/ru/post/225965/">https://habr.com/ru/post/225965/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../225945/index.html">We kill the "bell" from Google Chrome in the tray</a></li>
<li><a href="../225947/index.html">SwiftKey for Android. Now free</a></li>
<li><a href="../225951/index.html">Google bought Skybox microsatellite company for 500 million</a></li>
<li><a href="../225961/index.html">Managing Mozilla Firefox via GPO</a></li>
<li><a href="../225963/index.html">Attack on the black box. Reverse engineering of virtualized and mutated code</a></li>
<li><a href="../225969/index.html">Understanding NSURL / NSURLComponents</a></li>
<li><a href="../225971/index.html">From linux admin to python programmer or how and why I changed my profession</a></li>
<li><a href="../225973/index.html">Nintendo announced the designer "make your game Super Mario"</a></li>
<li><a href="../225975/index.html">Revealing the secret. Secret Architecture</a></li>
<li><a href="../225979/index.html">Sphinx indexing from a remote server using PHP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>