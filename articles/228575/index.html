<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Effective median estimation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, you have some kind of data stream. A big such stream. Or already ready set. And I want to determine some of its characteristics. Even non-programm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Effective median estimation</h1><div class="post__text post__text-html js-mediator-article">  So, you have some kind of data stream.  A big such stream.  Or already ready set.  And I want to determine some of its characteristics.  Even non-programmers can come up with an algorithm for determining the minimum and maximum values.  Calculating the average is already a little more difficult, but it also presents no difficulties - know how to calculate the amount and increment the counter for each new value.  Standard deviation is all the same, only the numbers are different.  What about the median? <br><br>  For those who have forgotten what it is, I recall that the median (the 50th percentile) of the data sample is the value that divides this sample in half - the data from one half have a value not less than the median, and from the second one no more.  Its value lies in the fact that its value does not depend on the magnitude of random bursts, which can greatly affect the average. <br><br>  Strictly speaking, from the definition it follows that in order to calculate the exact value of the median, we need to store the entire sample, otherwise there are no guarantees that we counted exactly what we wanted.  But for continuous and large data streams, the exact value still does not make much sense - now it‚Äôs one, and after 100 new samples it‚Äôs another.  Therefore, an effective method of estimating the median, which will not require a lot of memory and CPU resources, and will give an accuracy of the order of one percent or better - just what you need. <br><a name="habracut"></a><br>  Immediately warn you - the proposed method has several limitations.  In particular, it works very poorly on sorted samples (but it works very well on more or less evenly distributed samples).  Further, a simpler case of non-negative values ‚Äã‚Äãis considered, for the general case additional calculations are needed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The idea of ‚Äã‚Äãthe method is to build a calculation process that converges to the actual value of the median.  If we have already processed some amount of data and have some estimate of the median, then about the receipt of a new volume (with almost the same median, which is important), our estimate should be improved.  More precisely, the assessment should be improved more likely than degraded. <br><br>  You can use various types of median calculation windows, for example, calculate the exact median of the last 100 values, and average it with a constantly decreasing weight with the previous estimate.  Such a method will work well, but there is a much easier and almost the same exact.  Namely, simply shift the current estimate of the median to a new value by some small constant delta.  If the previous estimate was not accurate, then when processing a new amount of data, it will approach the actual value, i.e.  will become more accurate.  And if the estimate is already accurate, then on the processing of the new data volume, on half of the values ‚Äã‚Äãthere will be a shift in one direction, and in the other half - in the other, as a result, the estimate will return to the exact value. <br><br>  It is important that the delta should have the same absolute value for shifts both upwards and downwards, otherwise we will get not the 50th percentile.  But now the problem arises of choosing the delta value ‚Äî too small will give slow convergence, and too much will result in a large error, especially if the delta is comparable to the median value itself.  Automatic calculation of the delta already deprives of its title of a constant, but it doesn‚Äôt matter if we end up with the best result. <br><br>  It makes sense to make the delta constantly decreasing in order to improve convergence.  But not too fast, otherwise, under adverse conditions, the assessment risks never catching up with the real value of the median.  The 1 / count ratio fits perfectly - it is easy to calculate, and the sum (1 / n) series is divergent, so that in the end, the estimate will reach the real median, no matter how bad it was originally. <br><br>  Linking the delta value to the current median estimate is risky.  In unfortunate conditions, too low an estimate will be difficult to grow.  It is best to calculate the delta based on another quite stable characteristic of the sample - the average value.  With a 1 / count ratio, the delta value will constantly decrease (except for a few cases when the current average grows too much compared to the previous one).  For data that can take not only non-negative values, this approach will not work anymore, but we can easily get out of the situation, if we take two average values, positive and negative values, and use the sum of their absolute values. <br><br>  The final algorithm for estimating the median is almost as simple as the algorithm for calculating the average value: <br><pre><code class="go hljs">sum += value count ++ delta = sum / count / count <span class="hljs-comment"><span class="hljs-comment">// delta = average/count if value &lt; median { median -= delta } else { median += delta }</span></span></code> </pre> <br><br>  The error and speed of convergence, in my opinion, it is excellent - on a sample of 100 values, the error is usually about 10-20%, by 1000 - already about 1-3%, and then the error decreases even more. <br><br>  For those who want to independently assess the quality of the algorithm, a small script on perl is: <br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl -s $N = shift || 100000; for (1 .. $N) { push @a, (rand(1)*rand(1))**2; } @t = sort { $a &lt;=&gt; $b } @a; $MEDIAN = $t[$N/2-1]; median_init(); for (@a) { median_update($_); } $diff = ($MEDIAN-$median)/$MEDIAN*100; $avg = $sum/$count; print "Real:\t\t$MEDIAN Estimated:\t$median Difference:\t$diff \% Average: $avg "; sub median_init() { $count = $sum = $median = 0; } sub median_update($) { $value = $_[0]; $sum += $value; $count ++; $delta = $sum / $count / $count; if($median &lt;= $value) { $median += $delta; $s2 = '+'; } else { $median -= $delta; $s2 = '-'; } if($debug) { $s = ($value &gt; $MEDIAN) ? '+' : '-'; printf "%s %.5f\t%d\t%.7f\t %s %e\n", $s, $value, $count, $median, $s2, $delta; } }</span></span></code> </pre><br><br>  Statistics for different distributions: <br><br>  rand (1) - median 0.5, average 0.5: <br><table><tbody><tr><th>  sample size </th><th>  values ‚Äã‚Äãof deviations in percent on 10 different samples </th></tr><tr><td>  100 </td><td>  -0.06568 -0.06159 -0.02009 -0.00372 -0.00177 -0.00012 0.00441 0.00503 0.01287 2.46360 </td></tr><tr><td>  1000 </td><td>  -0.01196 -0.00462 -0.00415 -0.00240 0.00187 0.00948 0.01446 0.01787 0.02734 0.04150 </td></tr><tr><td>  10,000 </td><td>  -0.04025 -0.03712 -0.00983 -0.00512 0.00632 0.00768 0.01212 0.01267 0.05422 0.07043 </td></tr></tbody></table><br><br>  rand (1) ^ 2 - median 0.25, average 1/3: <br><table><tbody><tr><th>  the size </th><th>  10 percent deviation values </th></tr><tr><td>  100 </td><td>  -0.80813 -0.38749 -0.38348 -0.32599 -0.31828 -0.13034 -0.12811 0.06157 0.28336 6.07339 </td></tr><tr><td>  1000 </td><td>  -2.98383 -0.32917 -0.27234 -0.22337 -0.09080 0.03338 0.06851 0.30257 0.30286 0.31563 </td></tr><tr><td>  10,000 </td><td>  -0.97752 -0.51781 -0.44970 -0.39834 -0.17945 0.02517 0.06729 0.13353 0.31976 0.44967 </td></tr></tbody></table><br><br>  rand (1) * rand (1) - median 0.187 .., average 0.25: <br><table><tbody><tr><th>  the size </th><th>  10 percent deviation values </th></tr><tr><td>  100 </td><td>  -3.84694 -0.08139 -0.06980 -0.04138 -0.02477 0.01441 0.02042 0.03998 0.16999 0.17690 </td></tr><tr><td>  1000 </td><td>  -0.38108 -0.08865 -0.06287 -0.00716 0.01326 0.02373 0.05510 0.06785 0.09153 0.14421 </td></tr><tr><td>  10,000 </td><td>  -0.44392 -0.26293 -0.10081 -0.05271 0.02870 0.03629 0.09319 0.14522 0.14807 0.20980 </td></tr></tbody></table><br><br>  -log (rand (1)) - median 0.69 ..., average 1 <br><table><tbody><tr><th>  the size </th><th>  10 percent deviation values </th></tr><tr><td>  100 </td><td>  -15.40835 -0.07608 -0.06993 -0.05958 -0.03355 -0.02186 -0.00486 0.01619 0.10614 0.11928 </td></tr><tr><td>  1000 </td><td>  -3.05399 -0.06109 -0.05757 -0.04758 -0.01636 -0.01522 0.01376 0.03155 0.05036 0.06091 </td></tr><tr><td>  10,000 </td><td>  -0.24191 -0.10548 -0.09042 -0.04264 -0.03507 -0.01219 -0.01158 0.00481 0.04048 0.07969 </td></tr></tbody></table><br><br>  -log (rand (1) ^ 4) - median 2.76 .., average 4 <br><table><tbody><tr><th>  the size </th><th>  10 percent deviation values </th></tr><tr><td>  100 </td><td>  -4.20326 -0.06970 -0.05433 -0.04191 -0.01110 -0.00353 0.02933 0.05837 0.06381 0.08264 </td></tr><tr><td>  1000 </td><td>  -0.01198 -0.01090 -0.00719 0.01424 0.01454 0.01905 0.03147 0.03237 0.05578 0.89456 </td></tr><tr><td>  10,000 </td><td>  -0.45039 -0.06332 -0.02954 -0.02589 -0.01358 -0.01100 0.00229 0.01811 0.02675 0.05882 </td></tr></tbody></table></div><p>Source: <a href="https://habr.com/ru/post/228575/">https://habr.com/ru/post/228575/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../228563/index.html">IDEF0 Webinar and Modeling in 3SL Cradle</a></li>
<li><a href="../228565/index.html">Comparison of the speed characteristics of disk arrays firms DotHill and NetApp</a></li>
<li><a href="../228569/index.html">New Yandex.Metrica through API: report designer and API support for other standards</a></li>
<li><a href="../228571/index.html">Show Sound # 11 - Podcast about audio equipment, components, formats and technologies</a></li>
<li><a href="../228573/index.html">Meta-counters and meta-analysis became available in Openstat</a></li>
<li><a href="../228577/index.html">"Do no harm", or How not to become a corporation</a></li>
<li><a href="../228581/index.html">Overview of Visual Studio Extensions for Web Developers</a></li>
<li><a href="../228583/index.html">Russian army will get a shockproof tablet based on domestic OS</a></li>
<li><a href="../228585/index.html">Tesla Model S: close acquaintance</a></li>
<li><a href="../228587/index.html">Cisco 802.11ac access points: Gigabit Wi-Fi threshold passed</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>