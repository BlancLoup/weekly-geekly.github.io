<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Electron application notarization procedure for macOS 10.14.5</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="With the release of macOS 10.14.5, Apple added the mandatory Notarization process for applications before distributing them. What is this and what dif...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Electron application notarization procedure for macOS 10.14.5</h1><div class="post__text post__text-html js-mediator-article"><p>  With the release of macOS 10.14.5, Apple added the mandatory Notarization process for applications before distributing them.  What is this and what difficulties have arisen with this update when developing on Electron.js I would like to tell you. </p><br><p><img src="https://habrastorage.org/webt/7c/vo/qz/7cvoqzkecwn_jtlk82d33eghvda.png"></p><a name="habracut"></a><br><h2 id="vvedenie">  Introduction </h2><br><p>  2 years after the Electron.js boom, all the hot holivars about how bad he is and why they are needed are silenced.  Let's not rekindle them again in the comments.  Thank. </p><br><p>  On our project, electron-builder is used to build the application, but for electron-packager this procedure will be approximately the same. </p><br><p>  The project itself is a cloud gaming launcher through which a native client is launched to access a remote computer. </p><br><p>  Signing an application with the electron-builder does not look complicated, but for the sake of completeness, I will briefly describe this procedure.  If you have no problem signing the application, you can skip this chapter. </p><br><h3 id="podpisanie-prilozheniya">  Signing application </h3><br><p>  To sign the application, we need to export certificates from the Apple developer account.  We will need: </p><br><ul><li>  Developer ID Application </li><li>  Developer ID Installer </li><li>  * 3rd Party Mac Developer Application and 3rd Party Mac Developer Installer (If you plan to publish the application in the AppStore) </li></ul><br><p>  The Developer ID Installer certificate is issued for a specific application, this requires the bundleID.  For electron-builder, it is set by the "appId" parameter in package.json </p><br><p><img src="https://habrastorage.org/webt/pz/xc/ut/pzxcutr2ad_xxln6bqd5dlegi1q.png"></p><br><p>  Certificates need to be collected in a single file.  To do this, add them to the keychain (2 clicks on the certificate). <br>  Then go to keychain, select the necessary certificates and in the context menu click "export items".  After export, we get one file with the extension .p12. </p><br><p><img src="https://habrastorage.org/webt/uq/si/no/uqsinodlzfxhbrk0y3eqcyw2igi.png"></p><br><p>  After receiving the certificate file, add the following entries to the environment variables </p><br><ul><li>  CSC_LINK (path to the .p12 certificate file) </li><li>  CSC_KEY_PASSWORD (certificate access password) </li></ul><br><p>  If you do not add these variables, the collector will automatically search for the appropriate keys in the keychain repository.  Adding these records allows you to pinpoint the certificates you want to use for signing. </p><br><p>  After these operations, you can start the build process and everything should go smoothly. </p><br><p>  Smoothly this worked until the release of macOS 10.14.5 .... </p><br><h2 id="chto-izmenilos-s-vyhodom-macos-10145">  What has changed with the release of macOS 10.14.5 </h2><br><p>  A small digression.  Performing the last work on the new patch at night, I decided to leave the build production version for the morning.  Noticing that the update came on macOS launched it and went to sleep. </p><br><p>  The next morning, I was surprised to see that the build falls from an unfamiliar error at the time of signing the application - "Unnotarized Developer ID". </p><br><blockquote>  Do not postpone for tomorrow what you can do today.  Benjamin Franklin </blockquote><br><h4 id="sut-problemy">  The essence of the problem </h4><br><p>  Starting with macOS 10.14.5, Apple introduced a mandatory notarization procedure.  Apple‚Äôs first article on this was in 2018, but it was with this update that this procedure became mandatory.  How she looks like. </p><br><p>  You build the application -&gt; send it to the Apple server -&gt; Apple assures it -&gt; Returns the status of a successful assurance -&gt; The command for setting the assurance stamp is executed. </p><br><p>  For developers on Xcode, you just need to tick the notary </p><br><p><img src="https://habrastorage.org/webt/-x/sa/t4/-xsat4hgljlntg9x36agif_k13c.png"></p><br><p>  The process of notarizing the collected application can also be performed by a command in the terminal. </p><br><pre><code class="plaintext hljs">$ xcrun altool --notarize-app --primary-bundle-id "com.example.ote.zip" --username "AC_USERNAME" --password "@keychain:AC_PASSWORD" --file OvernightTextEditor_11.6.8.zip</code> </pre> <br><ul><li>  primary-bundle-id - application bundleID </li><li>  username - username on <a href="https://developer.apple.com/">developer.apple.com</a> </li><li>  password - "app-specific password".  It can be created in your account <a href="https://appleid.apple.com/">appleid.apple.com</a> under the account of the developer. </li></ul><br><p>  If you do not perform the procedure of notarization, then when the user tries to install the application, a window with an error flies.  The gatekeeper is responsible for checking the security of the application.  It was he who broke the application build on the electron-builder. </p><br><p><img src="https://habrastorage.org/webt/v6/gm/-a/v6gm-azhc2cgsxtvrqylh4hz_l0.jpeg"></p><br><h4 id="kak-vyglyadel-process-sborki-electron-builder">  What did the build process of electron-builder look like? </h4><br><p>  After the application was assembled into the .app file, the application was signed using the electron-osx-sign utility.  After signing with the certificate, the process of checking the application with the gatekepper was launched.  But with the release of the update, the gatekeeper began to check the correct notarization of the application, this did not allow to successfully complete the application signing procedure. </p><br><p><img src="https://habrastorage.org/webt/gs/-v/g0/gs-vg0zydktmqzserrjzfqrjmi0.png"></p><br><h4 id="patch-dlya-vozmozhnosti-notarizacii">  Patch for the possibility of notarization </h4><br><p>  Github user <a href="https://github.com/Kilian">Kallin</a> quite quickly proposed a commit solution, with the addition of two new parameters to the settings.  The first is "gatekeeperAssess" - disables assembly validation after signing and the second "sign" - which disables signing with the certificate of the installation file (dmg).  This commit is included in the release of electron-builder 20.43.0. </p><br><p>  For the very notarization process, electron-userland has an electron-notarize module that performs this task; you just need to write a small script and run it using the afterSign hook. </p><br><h2 id="process-podpisaniya-i-notarizacii-prilozheniya">  The process of signing and notarizing the application </h2><br><p><img src="https://habrastorage.org/webt/mc/qg/n5/mcqgn5yehovsqcheiyq_5a1b-qo.png"></p><br><p>  Initially, you need to check that you have the electron-builder version&gt; = 20.43.0 installed and install the electron-notarize package. </p><br><p>  Add 2 entries to the environment variables: </p><br><ul><li>  appleId - login <a href="https://developer.apple.com/">developer.apple.com</a> </li><li>  appleASP - "app-specific password", which can be created in the <a href="https://appleid.apple.com/">appleid.apple.com</a> personal account. </li></ul><br><p><img src="https://habrastorage.org/webt/q0/co/bv/q0cobvddzumimcg6kzffx9hzjkg.png"></p><br><p>  Now we will create a notarization script that will be executed after the application is signed. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> notarize = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'electron-notarize'</span></span>).notarize; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (context) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { electronPlatformName } = context; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (electronPlatformName === <span class="hljs-string"><span class="hljs-string">'darwin'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Try notarize app'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> notarize({ <span class="hljs-attr"><span class="hljs-attr">appBundleId</span></span>: <span class="hljs-string"><span class="hljs-string">'APP_BUNDLE_ID'</span></span>, <span class="hljs-attr"><span class="hljs-attr">appPath</span></span>: <span class="hljs-string"><span class="hljs-string">'./dist/mac/APP_NAME.app'</span></span>, <span class="hljs-attr"><span class="hljs-attr">appleId</span></span>: process.env.appleId, <span class="hljs-attr"><span class="hljs-attr">appleIdPassword</span></span>: process.env.appleASP, }); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Success notarize'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(err); } } };</code> </pre> <br><p>  We keep it in a convenient place for you. </p><br><p>  Also for correct notarization we will need to determine access rights. <br>  to system resources for our application.  To do this, create the file build / entitlements.mac.inherit.plist </p><br><pre> <code class="plaintext hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt; &lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt; &lt;plist version="1.0"&gt; &lt;dict&gt; &lt;key&gt;com.apple.security.cs.allow-jit&lt;/key&gt; &lt;true/&gt; &lt;key&gt;com.apple.security.cs.allow-unsigned-executable-memory&lt;/key&gt; &lt;true/&gt; &lt;key&gt;com.apple.security.cs.allow-dyld-environment-variables&lt;/key&gt; &lt;true/&gt; &lt;key&gt;com.apple.security.cs.disable-library-validation&lt;/key&gt; &lt;true/&gt; &lt;key&gt;com.apple.security.cs.disable-executable-page-protection&lt;/key&gt; &lt;true/&gt; &lt;key&gt;com.apple.security.cs.debugger&lt;/key&gt; &lt;true/&gt; &lt;key&gt;com.apple.security.automation.apple-events&lt;/key&gt; &lt;true/&gt; &lt;/dict&gt; &lt;/plist&gt;</code> </pre> <br><p>  The contents of the file in my case.  There may be another configuration for you.  <a href="https://developer.apple.com/documentation/security/hardened_runtime_entitlements">Description of all fields</a> . <br>  Required for Electron.js is - com.apple.security.cs.allow-unsigned-executable-memory. </p><br><p>  Now update the settings in package.json </p><br><p>  In the section for macOS: </p><br><p><img src="https://habrastorage.org/webt/lg/-2/tn/lg-2tnabm6hagn1s17mrcfgzhbw.png"></p><br><ul><li>  gatekeeperAssess (disables application validation on the electron-osx-sign side) </li><li>  hardenedRuntime (allows you to create a list of permissions for security and access to system resources) </li><li>  entitlements (path to access permission file for our application) </li></ul><br><p>  In the general settings section of the electron-builder: </p><br><p><img src="https://habrastorage.org/webt/jb/6e/ek/jb6eekoqrg9qvfm2wxhilunfdjk.png"></p><br><ul><li>  afterSign (path to the notarial script, which will be executed after signing the application) </li></ul><br><p>  Run the build process.  It may seem that it is slightly suspended, but transferring the file to the Apple server and waiting for a response takes some time (from 3 to 10 minutes) </p><br><p>  The status of notarization can be viewed in the terminal by running the command: </p><br><p> <code>$ xcrun altool --notarization-history 0 -u $appleId -p $appleASP</code> </p> <br><p>  The answer will be represented by a table.  The status field can be 'process', 'approved', 'invalid' </p><br><p><img src="https://habrastorage.org/webt/lf/-c/gt/lf-cgtkjf3jwkwses9dnbaztnig.png"></p><br><p>  With the status 'invalid' by the request number, you can see what exactly went wrong. </p><br><p> <code>$ xcrun altool --notarization-info "RequestUUID" -u $appleId</code> </p> <br><p>  That's the whole process of signing and notarization.  I hope my article will be useful to you.  Thank. </p><br><h4 id="nebolshoe-dopolnenie">  Small addition </h4><br><p>  When transferring the application for testing, an interesting bug was found.  The application received through Telegram simply refused to start.  When viewing the logs, it was found that the application was quarantined by Telegram.  For what reason and how did it happen, I could not find the answer.  When you send a file through Yandex.Disk (or any other way to download via a browser), this problem does not occur. </p><br><p><img src="https://habrastorage.org/webt/ww/3j/4k/ww3j4kakytwimj8uvz89d0jm2l0.png"></p><br><h3 id="poleznye-ssylki">  useful links </h3><br><ul><li>  <a href="https://github.com/electron-userland/electron-notarize">Electron-notarize repository</a> </li><li>  <a href="https://developer.apple.com/documentation/security/notarizing_your_app_before_distribution">Apple's application notarization article</a> </li><li>  <a href="https://kilianvalkhof.com/2019/electron/notarizing-your-electron-application/">Kallin's article on the process of notarization, I found it when I finished writing my</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/455874/">https://habr.com/ru/post/455874/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../455854/index.html">How to implement context menus (Context Menu) in iOS 13</a></li>
<li><a href="../455856/index.html">Wireless temperature, humidity and atmospheric pressure sensor on the nRF52832</a></li>
<li><a href="../455862/index.html">What's New in AWS: DATA API, Kinesis Data Analytics, S3 Path</a></li>
<li><a href="../455868/index.html">"Overcoming" Moore's Law: Transistor Technologies of the Future</a></li>
<li><a href="../45587/index.html">Magnetic Flying Globe</a></li>
<li><a href="../455876/index.html">Performance Comparison: JavaScript vs Compiled Languages</a></li>
<li><a href="../455878/index.html">Scenarios of video analytics in retail. In the footsteps of "Video Analytics in Retail"</a></li>
<li><a href="../45588/index.html">Interview with Nikita Sherman (Odnoklassniki.Ru)</a></li>
<li><a href="../455880/index.html">New serialization may appear in java</a></li>
<li><a href="../455882/index.html">Network factory for the data center Cisco ACI - to help admin</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>