<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Swift + CoreData + A bit of a file</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I combed my hands here to find out what kind of animal this Swift is and what it is actually eaten with. As expected, there were a lot of problems and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Swift + CoreData + A bit of a file</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/9a0/809/6a4/9a08096a4f4e0811f3708e0d80c2a053.png" alt="image"><br><br>  I combed my hands here to find out what kind of animal this Swift is and what it is actually eaten with.  As expected, there were a lot of problems and pitfalls, but either I don‚Äôt know how to cook this Swift at all.  The biggest problem awaited me when I tried to make friends with this Swift with CoreData - the thing basically refused to work.  Abundant googling did not lead to at least any good results - the information was either extremely fragile or smacked with crutches.  Therefore, on the first evening of tormenting, I capitulated and decided to use the most stupid solution when working with CoreData in the old-fashioned way - to keep all the code in the good old Objective-C and to access it from Swift (for example, in interfaces).  However, perfectionism in the soul did not give rest and it was necessary to implement a pure monolingual solution, which I actually could do, although I must admit that it was not without crutches too.  Who is interested in the process please under the cat.  Also along the way I propose to collect bugs and not the most convenient things in my opinion that came along with the new language.  Perhaps something I did crookedly - I will be grateful for comments and amendments, as well as a discussion of best practices. <br><a name="habracut"></a><br><h4>  To whom time is precious </h4><br>  Without reading the article, you can immediately download the example from here <a href="">https://github.com/KoNEW/CoreDataTest.git</a> and smoke everything yourself. <br><br><h4>  Synthetic example </h4><br><h5>  What are we going to pick </h5><br>  Hereinafter, we will use a synthetic project to analyze all the problems and examples - we will make an application for viewing and managing the classic entities ‚ÄúDepartment‚Äù and ‚ÄúEmployee‚Äù. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the same time, the department will be characterized by such fields as: <br><br><ul><li>  name (string - mandatory) </li><li>  internal number (number - mandatory) </li><li>  phone number (line - optional, we will not do any number validation checks) </li></ul><br><br>  And the employee, respectively: <br><br><ul><li>  Name (string - required) </li><li>  Last name (string - required) </li><li>  Gender (number - required) </li><li>  Age (number - optional) </li></ul><br><br><h5>  Data management manager </h5><br>  Actually, the first step is to open Xcode and create a trivial project using CoreData and exposed Swift language.  The only edit we will make at this stage is to cut out all the work with CoreData from the application delegate and transfer it to a separate class, which will work as a singleton for us.  I just got used to doing this when I used to work on code, and here I‚Äôll repeat it - at the same time you can look at how to make a singleton on Swift.  For all of our classes, we will use the prefix here and hereafter CS (CoreData + Swift). <br><br><div class="spoiler">  <b class="spoiler_title">Jamb ‚Ññ1</b> <div class="spoiler_text">  I don‚Äôt know this bug in Xcode 6 Beta or a feature, but the prefixes for the classes of their own, in order not to write them every time, now you need to set them manually.  This can be done in the File Inspector tab if you select a project file. </div></div><br><br>  So, what we do: <br><ul><li>  Cutting out all the work with CoreData from AppDelegate </li><li>  Create a class CSDataManager </li><li>  In it, we create properties for working with the model, context, and direct data storage. </li><li>  Create a method to work as a singleton. </li></ul><br><br>  According to the results, the AppDelegate.swift file is as follows: <br><br><pre><code class="objectivec hljs">import <span class="hljs-built_in"><span class="hljs-built_in">UIKit</span></span> import CoreData @<span class="hljs-built_in"><span class="hljs-built_in">UIApplicationMain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> AppDelegate: <span class="hljs-built_in"><span class="hljs-built_in">UIResponder</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">UIApplicationDelegate</span></span> { var window: <span class="hljs-built_in"><span class="hljs-built_in">UIWindow</span></span>? func application(application: <span class="hljs-built_in"><span class="hljs-built_in">UIApplication</span></span>, didFinishLaunchingWithOptions launchOptions: <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span>?) -&gt; Bool { <span class="hljs-comment"><span class="hljs-comment">// Override point for customization after application launch. return true } }</span></span></code> </pre> <br>  And the CSDataManager.swft file is as follows: <br><pre> <code class="objectivec hljs">import <span class="hljs-built_in"><span class="hljs-built_in">UIKit</span></span> import Foundation import CoreData let kCSErrorDomain = <span class="hljs-string"><span class="hljs-string">"ru.novilab-mobile.cstest"</span></span> let kCSErrorLocalStorageCode = <span class="hljs-number"><span class="hljs-number">-1000</span></span> @objc(CSDataManager) <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CSDataManager:<span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> { <span class="hljs-comment"><span class="hljs-comment">//Managed Model var _managedModel: NSManagedObjectModel? var managedModel: NSManagedObjectModel{ if !_managedModel{ _managedModel = NSManagedObjectModel.mergedModelFromBundles(nil) } return _managedModel! } //Store coordinator var _storeCoordinator: NSPersistentStoreCoordinator? var storeCoordinator: NSPersistentStoreCoordinator{ if !_storeCoordinator{ let _storeURL = self.applicationDocumentsDirectory.URLByAppendingPathComponent("CSDataStorage.sqlite") _storeCoordinator = NSPersistentStoreCoordinator(managedObjectModel: self.managedModel) func addStore() -&gt; NSError?{ var result: NSError? = nil if _storeCoordinator!.addPersistentStoreWithType(NSSQLiteStoreType, configuration: nil, URL: _storeURL, options: nil, error: &amp;result) == nil{ println("Create persistent store error occurred: \(result?.userInfo)") } return result } var error = addStore() if error != nil{ println("Store scheme error. Will remove store and try again. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> add scheme migration.") NSFileManager.defaultManager().removeItemAtURL(_storeURL, error: nil) error = addStore() if error{ println("Unresolved critical error with persistent store: \(error?.userInfo)") abort() } } } return _storeCoordinator! } //Managed Context var _managedContext: NSManagedObjectContext? = nil var managedContext: NSManagedObjectContext { if !_managedContext { let coordinator = self.storeCoordinator if coordinator != nil { _managedContext = NSManagedObjectContext() _managedContext!.persistentStoreCoordinator = coordinator } } return _managedContext! } //Init init() { super.init() NSNotificationCenter.defaultCenter().addObserver(self, selector: "appDidEnterBackground", name: UIApplicationDidEnterBackgroundNotification, object: nil) } @objc(appDidEnterBackground) func appDidEnterBackground(){ var (result:Bool, error:NSError?) = self.saveContext() if error != nil{ println("Application did not save data with reason: \(error?.userInfo)") } } // Returns the URL to the application's Documents directory. var applicationDocumentsDirectory: NSURL { let urls = NSFileManager.defaultManager().URLsForDirectory(.DocumentDirectory, inDomains: .UserDomainMask) return urls[urls.endIndex-1] as NSURL } //Save context func saveContext() -&gt; (Bool, NSError?){ println("Will save") var error: NSError? = nil var result: Bool = false let context = self.managedContext if context != nil{ if context.hasChanges &amp;&amp; !context.save(&amp;error){ println("Save context error occurred: \(error?.userInfo)") }else{ result = true } }else{ let errorCode = kCSErrorLocalStorageCode let userInfo = [NSLocalizedDescriptionKey : "Managed context is nil"] error = NSError.errorWithDomain(kCSErrorDomain, code: errorCode, userInfo: userInfo) } return (result, error) } //Singleton Instance class func sharedInstance() -&gt; CSDataManager{ struct wrapper{ static var shared_instance: CSDataManager? = nil static var token: dispatch_once_t = 0 } dispatch_once(&amp;wrapper.token, {wrapper.shared_instance = CSDataManager()}) return wrapper.shared_instance! } }</span></span></code> </pre><br><br>  The code that generates XCode automatically was taken as a basis - that is, it can be considered to some extent a reference.  Of the interesting things in terms of language learning, in this file I would single out for myself: <br><br><ul><li>  working with global constants </li><li>  working with class properties </li><li>  static class methods (good old class object methods) </li><li>  stored procedures (doped file storeCoordinator with a file, as it constantly changed the data model in the future and this ensured the automatic rubbing of the database file as necessary) </li><li>  working with Tuples using a modified context saving method </li><li>  work with NSNotificationCenter </li></ul><br><br><div class="spoiler">  <b class="spoiler_title">Jamb ‚Ññ2</b> <div class="spoiler_text">  Work with properties - I really do not like.  The example is based on what Xcode itself offers by default ‚Äî accordingly, I conclude that this is the best existing solution.  Specifically, I do not like it - the need to directly declare an internal variable for storage (it used to work under the hood).  At the same time, the variables themselves, despite the leading underscore in front, remain visible from the outside - and in fact we get that two properties are visible in the file inspector for each of our tasks.  Total totally I do not like: <br><ul><li>  The need to explicitly duplicate properties to solve such problems. </li><li>  The inability to create just internal variables </li><li>  The impossibility of creating internal properties - we would decide earlier that the definition of a property is inside the implementation file, and not a blank file </li></ul><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e08/17e/ced/e0817eced3b631c60d44ca94742c32f4.png" alt="image"></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Jamb ‚Ññ3</b> <div class="spoiler_text">  The pattern of the singleton is realized through a rigid crutch using the internal structure.  In theory, this should be solved in a simple way through the use of class variables (class var) that are stated in the language specification - but de facto the compiler is not yet supported.  Sadness, sadness - waiting for corrections.  Also, in the current version of the language, it is still impossible (compared to Objective-C) to denote the class initializer as a private method, as a result, it is still impossible to make a pure idiot-resistant singleton. </div></div><br><br><div class="spoiler">  <b class="spoiler_title">Jamb number 4 or feature, I do not know</b> <div class="spoiler_text">  It is also worth paying attention to how the call to the NSNotificationCenter works.  There is one simple point.  Apple writes that all system libraries (UIKit, Foundation, CoreData, etc.) are already successfully fully friendly with Swift.  However, in reality it turns out to be not quite so, or so, but not quite  Namely, NSNotificationCenter runs under the hood on pure Objective-C, most likely for compatibility with all your other code.  For this reason, its application has a number of nuances and limitations: <br><br><h6>  Moment one </h6><br>  In order for our code to work normally with Objective-C calls, we need to make it compatible ‚Äî here, in general, according to the instructions.  Add the magic attributes <code>@objc()</code> to the class name and the methods we need - for example, this is the part: <br><br><pre> <code class="objectivec hljs">@objc(CSDataManager) <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CSDataManager:<span class="hljs-built_in"><span class="hljs-built_in">NSObject</span></span> { ... @objc(appDidEnterBackground) func appDidEnterBackground(){ ...</code> </pre><br><br><h6>  Moment two </h6><br>  It would be logical to tie a call from the notification center to the saveContext method itself - but since it returns Tuple with us, we cannot do this, such constructions are not defined in Objective-C.  Because of this, we use a crutch with a simple <code>void</code> method call.  In principle, everything is zen here - no, it is not.  But in the head such things when designing your product, it is worth bearing in mind. <br></div></div><br><br><h5>  Create a data model </h5><br>  Here everything is trivial using standard Xcode tools to create our data model - as a result we get something like that. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/de9/352/284/de9352284682c01f6a41fc199221f89b.png" alt="image"><br><br><h4>  Actually the problem </h4><br>  And what is the actual problem.  It is simple - in Xcode 6-Beta, code generation is broken for the heirs classes from NSManagedObject.  More precisely, the code will be generated on Objective-C, and not on Swift, but this is somehow not comfy. <br>  So, briefly, what solutions are there again: <br><br><ul><li>  Option A. We use normal code generation, we get the usual Objective-C work files at the output and through the Bridging file we use them in our Swift code mainly.  How to use Objective-C custom classes in Swift can be read here - <a href="https://developer.apple.com/library/prerelease/ios/documentation/Swift/Conceptual/BuildingCocoaApps/MixandMatch.html">Swift and Objective-C in the Same Project</a> </li><li>  Option B. We try to do the opposite - we will write the Swift class, which will be able to behave like an Objective-C class and at the same time will work in currency with CoreData.  To do this, we take in the right hand a file, and in the left extremely brief guide from Apple - <a href="https://developer.apple.com/library/prerelease/ios/documentation/Swift/Conceptual/BuildingCocoaApps/WritingSwiftClassesWithObjective-CBehavior.html">Writing Swift Classes with Objective-C Behavior</a> </li></ul><br><br><h4>  Follow the instructions </h4><br>  We first consider the work with only one entity of the ‚ÄúDepartment‚Äù; we will return to relations a little later.  So, following the instructions from Apple, letter by letter, we come to this file to describe the CSDepartment class: <br><br><pre> <code class="objectivec hljs">import Foundation import CoreData import <span class="hljs-built_in"><span class="hljs-built_in">UIKit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CSDepartment : <span class="hljs-built_in"><span class="hljs-built_in">NSManagedObject</span></span>{ @<span class="hljs-built_in"><span class="hljs-built_in">NSManaged</span></span> var title: <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">NSManaged</span></span> var internalID: <span class="hljs-built_in"><span class="hljs-built_in">NSNumber</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">NSManaged</span></span> var phone: <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>? }</code> </pre><br><br>  And we‚Äôll check all the work with this code, which I left in my AppDelegate for simplicity (then, by the way, it will change to a more correct version for us). <br><br><pre> <code class="objectivec hljs">func application(application: <span class="hljs-built_in"><span class="hljs-built_in">UIApplication</span></span>, didFinishLaunchingWithOptions launchOptions: <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span>?) -&gt; Bool { <span class="hljs-comment"><span class="hljs-comment">//Get manager let manager = CSDataManager.sharedInstance() //Create new department let newDepartment : AnyObject! = NSEntityDescription.insertNewObjectForEntityForName("CSDepartment", inManagedObjectContext: manager.managedContext) //Save context manager.saveContext() //Get and print all departments let request = NSFetchRequest(entityName: "CSDepartment") let departments = manager.managedContext.executeFetchRequest(request, error: nil) println("Departments: \(departments)") return true }</span></span></code> </pre><br><br>  Run, watch logs and grieve.  Important points: <br><br><ul><li>  First of all, we get an error of saving data in CoreData due to the fact that a number of fields are set as mandatory (title and internalID), and we did not specify them.  Here, a typical solution is to set some default values ‚Äã‚Äãin the model file or use the awakeFromInsert method.  The first solution is working, but not sports, the second one is inoperative in this form - the method is simply not invoked, which made me disheartened. </li><li>  The second important point, in the logs, we see something like this: Departments: <br><pre> <code class="objectivec hljs">[&lt;<span class="hljs-built_in"><span class="hljs-built_in">NSManagedObject</span></span>: <span class="hljs-number"><span class="hljs-number">0xb264030</span></span>&gt; (entity: CSDepartment; <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-number"><span class="hljs-number">0xb264090</span></span> &lt;x-coredata:<span class="hljs-comment"><span class="hljs-comment">///CSDepartment/t3403D9E7-F910-4E2D-989E-95D9C984C1762&gt; ; data: {employees = (); internalID = nil;phone = nil;title = nil;})]</span></span></code> </pre><br>  An important conclusion follows from this log - our variable was instantiated as an instance of NSManagedObject, and not as CSDepartment.  As a result, we also cannot indicate the field values, since the rigid type conversion in the spirit of <br><pre> <code class="objectivec hljs">let newDepartment : CSDepartment = <span class="hljs-built_in"><span class="hljs-built_in">NSEntityDescription</span></span>.insertNewObjectForEntityForName(<span class="hljs-string"><span class="hljs-string">"CSDepartment"</span></span>, inManagedObjectContext: manager.managedContext) as CSDepartment</code> </pre><br>  It does not work, the application just crashes. </li></ul><br><br><h5>  We use the file </h5><br>  After wandering around the network, I found a series of gestures that cause the code to become working.  So, what to do: <br><br><h6>  Step 1. Compatible with Objective-C. </h6><br>  Somewhere under the hood, we still have clean Objective-C calls, so we need to make our new class compatible with Objective-C calls.  We do this in the usual way due to the directive <code>@objc()</code> <br><br><h6>  Step 2. We polish the model file. </h6><br>  This is not an obvious step - we need to select the file of our model again and hand-to-hand register in the model configuration what class to use to display the entity. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e31/f39/fa1/e31f39fa1422ce1b3cbb35af8fcb4ffb.png" alt="image"><br><br><h6>  Step 3. Cosmetic. </h6><br>  After the two previous steps, everything should work, but I still added the awakeFromInsert method, which now also works.  And also added a description method, so that a more beautiful and understandable data string is displayed in the log. <br><br>  As a result, the code of our class began to look like this: <br><br><pre> <code class="objectivec hljs">import Foundation import CoreData import <span class="hljs-built_in"><span class="hljs-built_in">UIKit</span></span> @objc(CSDepartment) <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CSDepartment : <span class="hljs-built_in"><span class="hljs-built_in">NSManagedObject</span></span>{ @<span class="hljs-built_in"><span class="hljs-built_in">NSManaged</span></span> var title: <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">NSManaged</span></span> var internalID: <span class="hljs-built_in"><span class="hljs-built_in">NSNumber</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">NSManaged</span></span> var phone: <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>? override func awakeFromInsert() { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.title = <span class="hljs-string"><span class="hljs-string">"New department"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.internalID = <span class="hljs-number"><span class="hljs-number">0</span></span> } func description() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Department: className=\(self.dynamicType.description()), title=\(self.title), id=[\(self.internalID)] and phone=\(self.phone)"</span></span> } }</code> </pre><br><br>  We run our tests again - everything works, you can rejoice. <br><br><h4>  We work with relationships </h4><br>  So, with trivial entities figured out.  By analogy, you can make a description of the entity <code>CSEmployee</code> .  There is only one thing left to do - to make our system work correctly with entities - to be able to add and delete links.  The relationship between the department and the staff is one-to-many.  Here, the new language and Xcode behaved in two ways. <br>  To implement the communication from the employee to the department, everything turned out to be trivial - we simply add one more to the list of its properties, which indicates the department itself.  In total, the employee's class here began to look like this (I also added random generation of the name and surname from global arrays): <br><br><pre> <code class="objectivec hljs">import Foundation import CoreData let st_fNames = [<span class="hljs-string"><span class="hljs-string">"John"</span></span>, <span class="hljs-string"><span class="hljs-string">"David"</span></span>, <span class="hljs-string"><span class="hljs-string">"Michael"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bob"</span></span>] let st_lNames = [<span class="hljs-string"><span class="hljs-string">"Lim"</span></span>, <span class="hljs-string"><span class="hljs-string">"Jobs"</span></span>, <span class="hljs-string"><span class="hljs-string">"Kyler"</span></span>] @objc(CSEmployee) <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CSEmployee:<span class="hljs-built_in"><span class="hljs-built_in">NSManagedObject</span></span>{ @<span class="hljs-built_in"><span class="hljs-built_in">NSManaged</span></span> var firstName: <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">NSManaged</span></span> var lastName: <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">NSManaged</span></span> var age: <span class="hljs-built_in"><span class="hljs-built_in">NSNumber</span></span>? @<span class="hljs-built_in"><span class="hljs-built_in">NSManaged</span></span> var department: CSDepartment override func awakeFromInsert() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.awakeFromInsert() <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.firstName = st_fNames[Int(arc4random_uniform(<span class="hljs-built_in"><span class="hljs-built_in">UInt32</span></span>(st_fNames.count)))] <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.lastName = st_lNames[Int(arc4random_uniform(<span class="hljs-built_in"><span class="hljs-built_in">UInt32</span></span>(st_lNames.count)))] } func description() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Employee: name= \(self.firstName) \(self.lastName), age=\(self.age) years"</span></span> } }</code> </pre><br><br>  But to implement the support mechanism on the side of the department, the file had to be taken in a stronger hand - because again, because of the broken code generation, magic methods for adding child entities were not created.  Total do the following thing: <br><br><ul><li>  Add a property to store employees with the NSSet class </li><li>  Adding custom handles to add and remove employees ‚Äî made on the basis of Xcode snippets for the Objective-C version </li></ul><br><br>  As a result, our class began to look like this: <br><br><pre> <code class="objectivec hljs">import Foundation import CoreData @objc(CSDepartment) <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CSDepartment : <span class="hljs-built_in"><span class="hljs-built_in">NSManagedObject</span></span>{ @<span class="hljs-built_in"><span class="hljs-built_in">NSManaged</span></span> var title: <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">NSManaged</span></span> var internalID: <span class="hljs-built_in"><span class="hljs-built_in">NSNumber</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">NSManaged</span></span> var phone: <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>? @<span class="hljs-built_in"><span class="hljs-built_in">NSManaged</span></span> var employees: <span class="hljs-built_in"><span class="hljs-built_in">NSSet</span></span> override func awakeFromInsert() { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.title = <span class="hljs-string"><span class="hljs-string">"New department"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.internalID = <span class="hljs-number"><span class="hljs-number">0</span></span> } func description() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>{ let employeesDescription = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.employees.allObjects.map({employee <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> employee.description()}) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Department: title=\(self.title), id=[\(self.internalID)], phone=\(self.phone) and employees = \(employeesDescription)"</span></span> } <span class="hljs-comment"><span class="hljs-comment">//Working with Employees func addEmployeesObject(employee: CSEmployee?){ let set:NSSet = NSSet(object: employee) self.addEmployees(set) } func removeEmployeesObject(employee: CSEmployee?){ let set:NSSet = NSSet(object: employee) self.removeEmployees(set) } func addEmployees(employees: NSSet?){ self.willChangeValueForKey("employees", withSetMutation: NSKeyValueSetMutationKind.UnionSetMutation, usingObjects: employees) self.primitiveValueForKey("employees").unionSet(employees) self.didChangeValueForKey("employees", withSetMutation: NSKeyValueSetMutationKind.UnionSetMutation, usingObjects: employees) } func removeEmployees(employees: NSSet?){ self.willChangeValueForKey("employess", withSetMutation: NSKeyValueSetMutationKind.MinusSetMutation, usingObjects: employees) self.primitiveValueForKey("employees").minusSet(employees) self.didChangeValueForKey("employees", withSetMutation: NSKeyValueSetMutationKind.MinusSetMutation, usingObjects: employees) } }</span></span></code> </pre><br><br><h4>  Final Job Verification Code and Remaining Problems </h4><br>  In the end, such adjustments were made: <br><ul><li>  Two methods have been added to the CSDataManager class to get a complete list of departments and employees. </li><li>  The example code has been changed - we looked at adding, deleting, and cascading deletion </li></ul><br><br>  So, the final code AppDelegate: <br><br><pre> <code class="objectivec hljs">import <span class="hljs-built_in"><span class="hljs-built_in">UIKit</span></span> import CoreData @<span class="hljs-built_in"><span class="hljs-built_in">UIApplicationMain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> AppDelegate: <span class="hljs-built_in"><span class="hljs-built_in">UIResponder</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">UIApplicationDelegate</span></span> { var window: <span class="hljs-built_in"><span class="hljs-built_in">UIWindow</span></span>? func application(application: <span class="hljs-built_in"><span class="hljs-built_in">UIApplication</span></span>, didFinishLaunchingWithOptions launchOptions: <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span>?) -&gt; Bool { <span class="hljs-comment"><span class="hljs-comment">//Get manager let manager = CSDataManager.sharedInstance() //Testing insert new objects let newDepartment : CSDepartment = NSEntityDescription.insertNewObjectForEntityForName("CSDepartment", inManagedObjectContext: manager.managedContext) as CSDepartment let newEmployee: CSEmployee = NSEntityDescription.insertNewObjectForEntityForName("CSEmployee", inManagedObjectContext: manager.managedContext) as CSEmployee let newEmployee2: CSEmployee = NSEntityDescription.insertNewObjectForEntityForName("CSEmployee", inManagedObjectContext: manager.managedContext) as CSEmployee newEmployee.department = newDepartment newDepartment.addEmployeesObject(newEmployee2) manager.saveContext() //Get and print all departments println("Have add oen department and two employees") println("Departments: \(manager.departments())") println("Employees: \(manager.employees())") //Testing remove child object newDepartment.removeEmployeesObject(newEmployee2) manager.saveContext() println("Have delete one employee") println("Departments: \(manager.departments())") //Testing cascade remove manager.managedContext.deleteObject(newDepartment) manager.saveContext() println("\nHave delete department") println("Departments: \(manager.departments())") println("Employees: \(manager.employees())") //Uncomment to remove all records // let departments = manager.departments() // for i in 0..departments.count{ // let dep = departments[i] as CSDepartment // manager.managedContext.deleteObject(dep) // } // let employees = manager.employees() // for i in 0..employees.count{ // let emp = employees[i] as CSEmployee // manager.managedContext.deleteObject(emp) // } // manager.saveContext() // println("\nHave delete all data") // println("Departments: \(manager.departments())") // println("Employees: \(manager.employees())") return true } }</span></span></code> </pre><br><br>  Found a significant bug - cascading removal of objects occurs with a bang, but when you remove employees from the department using the <code>removeEmployeesObject  removeEmployees</code> on the child objects, you do not reset the department pointers and, accordingly, the objects are still validly stolen by the system in the storage. <br>  <b>UPDATE:</b> This is not a bug - Objective-C code behaves the same way, apparently I‚Äôve confused something.  Apparently these problems should be solved by an architectural approach. <br><br><h4>  Conclusion </h4><br>  In general, you can work, but so far not without pain in the shower.  File always have to keep on hand.  I would be glad to comment, amend and free discussion in search of the true path of the samurai. </div><p>Source: <a href="https://habr.com/ru/post/225727/">https://habr.com/ru/post/225727/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../225707/index.html">Detained hackers who used stolen Apple IDs to block iDevice</a></li>
<li><a href="../225709/index.html">Mobile version of Habr: version 2.0</a></li>
<li><a href="../225715/index.html">Mobile banking development for RaiffeisenBank</a></li>
<li><a href="../225721/index.html">What nobody told you about z-index in the article ‚ÄúWhat nobody told you about z-index‚Äù</a></li>
<li><a href="../225723/index.html">How to use Tomita-parser in your projects. Practical course</a></li>
<li><a href="../225735/index.html">ZeptoLab and Codeforces join forces</a></li>
<li><a href="../225739/index.html">NASA Announces Mars Design Competition</a></li>
<li><a href="../225741/index.html">UK rewrites the rules of the road under the "robot"</a></li>
<li><a href="../225743/index.html">Qualifying round of the Russian Code Cup 2014: results and analysis of tasks</a></li>
<li><a href="../225745/index.html">Python, tone shift and Pianoputer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>