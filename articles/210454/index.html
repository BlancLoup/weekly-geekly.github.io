<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sweet.js: Syntax JavaScript Extensions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Let's try to look at Sweet.js , a compiler that implements hygienic macros for JavaScript. 

 It works quite simply - you define a set of patterns by ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sweet.js: Syntax JavaScript Extensions</h1><div class="post__text post__text-html js-mediator-article">  Let's try to look at <a href="http://sweetjs.org/">Sweet.js</a> , a compiler that implements hygienic macros for JavaScript. <br><br>  It works quite simply - you define a set of patterns by which the search is performed by the syntax tree.  When a macro matches, it receives a piece of wood that it needs and the body of the macro determines how this piece of wood should be transformed.  Further, the result is embedded back into the tree and the procedure continues from that place. <br><br>  Sweet.js operates with its own syntax tree format, almost at the token level, with minimal structure.  On the one hand, this makes it possible to define rather exotic syntaxes for your macros, on the other hand, it makes writing macros somewhat more complicated, as if they were defined above standard AST JavaScript. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  Let's start with the simplest example, but first you need to install Sweet.js: <br><br><pre><code class="javascript hljs">npm install --global sweet.js</code> </pre> <br><br>  After that, we should have the <code>sjs</code> utility available.  Let's write a macro that will swap the values ‚Äã‚Äãof two variables, put the following code in the <code>swap.sjs</code> file: <br><br><pre> <code class="javascript hljs">macro swap { rule { $x , $y } =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tmp = $x; $x = $y; $y = tmp } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = <span class="hljs-number"><span class="hljs-number">11</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y = <span class="hljs-number"><span class="hljs-number">12</span></span>; swap x, y; swap y, x;</code> </pre><br><br>  Now, in order to get ES5 compliant JavaScript code, we just need to feed it to the <code>sjs -r ./swap.sjs</code> compiler <code>sjs -r ./swap.sjs</code> <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = <span class="hljs-number"><span class="hljs-number">11</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y = <span class="hljs-number"><span class="hljs-number">12</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tmp = x; x = y; y = tmp; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tmp$<span class="hljs-number"><span class="hljs-number">2</span></span> = y; y = x; x = tmp$<span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre><br><br>  The moment that is worth paying attention to is that Sweet.js generated the variable names when the macro was expanded, thus eliminating the possibility of a name conflict.  This means that Sweet.js implements hygienic macros. <br><br>  Now let's write something useful.  How about a set of macros for writing tests in the style of BDD.  Let's start with the simplest. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> describe = macro { rule { <span class="hljs-attr"><span class="hljs-attr">$name</span></span>:lit { $body ... } } =&gt; { describe($name, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $body ... }); } } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> it = macro { rule { <span class="hljs-attr"><span class="hljs-attr">$name</span></span>:lit { $body ... } } =&gt; { it($name, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $body ... }); } } describe <span class="hljs-string"><span class="hljs-string">"My functionality"</span></span> { it <span class="hljs-string"><span class="hljs-string">"works!"</span></span> { } }</code> </pre><br><br>  In contrast to the <code>macro name</code> form, we used <code>let name = macro</code> - this is done in order to eliminate infinite recursion.  Since the <code>describe</code> and <code>it</code> macros return a set of tokens with names that match the names of the macros themselves, Sweet.js will try to use the corresponding macros again and again until the stack ends.  The <code>let</code> form helps to avoid this, since it does not create a binding for the name of the macro inside the syntax that is returned by the macro. <br><br>  Let's see what we have <br><pre> <code class="javascript hljs">describe(<span class="hljs-string"><span class="hljs-string">'My functionality'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ it(<span class="hljs-string"><span class="hljs-string">'works!'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ }); });</code> </pre><br><br>  This is more useful than the <code>swap</code> macro, which we wrote at the very beginning - it allows you to save on writing code and use syntactic constructions that are closer to the subject area. <br><br>  Let's see what else we can do with macros for writing tests.  How about a set of macros for writing assertions (assertions)?  Since macros have access to the very structure of the code, we can use this to write statements with informative messages about the non-fulfillment of statements.  At the same time, let's see how Sweet.js allows you to write infix macros. <br><br>  What will it all look like?  I suggest the following syntax: <br><br><pre> <code class="javascript hljs"><span class="hljs-number"><span class="hljs-number">2</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span> should == <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-string"><span class="hljs-string">"aabbcc"</span></span> should contain <span class="hljs-string"><span class="hljs-string">"bb"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>] should be truthy xy() should <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span></code> </pre><br><br>  At the same time, if an assertion is not fulfilled, I want to see an informative error message that will not only show the values ‚Äã‚Äãof the current variables in the <code>undefined has no method x</code> style <code>undefined has no method x</code> , but will display which code exactly led to this.  For example, <code>2 + 2 should == 5</code> should result in error message <code>2 + 2 should be equal to 5</code> . <br><br>  Let's start with the fact that we write a macro that will receive any JavaScript expression and generate a line of code, for this expression - ‚Äúlike parsing, just the opposite‚Äù.  We need this to generate informative error messages. <br><br><pre> <code class="javascript hljs">macro fmt { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> { _ ( $val:expr ) } =&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fmt</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v.map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x.token.inner ? x.token.value[<span class="hljs-number"><span class="hljs-number">0</span></span>] + fmt(x.token.inner) + x.token.value[<span class="hljs-number"><span class="hljs-number">1</span></span>] : x.token.value; }).join(<span class="hljs-string"><span class="hljs-string">''</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [makeValue(<span class="hljs-string"><span class="hljs-string">'`'</span></span> + fmt(#{$val}) + <span class="hljs-string"><span class="hljs-string">'`'</span></span>, #{here})]; } }</code> </pre><br><br>  Unlike the previous examples, this macro is a case macro.  Unlike rule macros that we used earlier, case macros allow you to use the full power of JavaScript to define a syntactic transformation. <br><br>  I will not describe in detail what this macro does.  But the scheme is this - we define the <code>fmt</code> function that bypasses the syntax tree and generates a line of code from it.  Then we construct another syntax tree, which consists of a single node-string and return it as the result of a macro. <br><br><pre> <code class="javascript hljs">fmt(<span class="hljs-number"><span class="hljs-number">1</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">// "1+1" fmt(xy(1, 2)) // "xy(1,2)"</span></span></code> </pre><br><br>  As you can see, everything works with a bang, except for the fact that the string is obtained without spaces.  Write the best version of the macro <code>fmt</code> remains as an exercise for the reader. <br><br>  We now turn to the direct definition of syntax for assertions.  We will use the <code>assert</code> module from the standard Node.js library for the statements themselves and simply define macros that will be compiled into function calls from this module. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> assert = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'assert'</span></span>); macro should { rule infix { <span class="hljs-attr"><span class="hljs-attr">$lhs</span></span>:expr | == $rhs:expr } =&gt; { assert.deepEqual( $lhs, $rhs, fmt($lhs) + <span class="hljs-string"><span class="hljs-string">" should be equal to "</span></span> + fmt($rhs)); } rule infix { <span class="hljs-attr"><span class="hljs-attr">$lhs</span></span>:expr | be truthy } =&gt; { assert.ok( $lhs, fmt($lhs) + <span class="hljs-string"><span class="hljs-string">" should be truthy"</span></span>); } rule infix { <span class="hljs-attr"><span class="hljs-attr">$lhs</span></span>:expr | contain $rhs } =&gt; { assert.ok( $lhs.indexOf($rhs) &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>, fmt($lhs) + <span class="hljs-string"><span class="hljs-string">" should contain "</span></span> + fmt($rhs)); } rule infix { <span class="hljs-attr"><span class="hljs-attr">$lhs</span></span>:expr | <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> } =&gt; { assert.throws( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $lhs }, <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>, fmt($lhs) + <span class="hljs-string"><span class="hljs-string">" should throw"</span></span>); } }</code> </pre><br><br>  We used the <code>rule infix</code> to define infix rules, the symbol <code>|</code>  in the template shows where the symbol of the macro name should be located, in this case <code>should</code> . <br><br>  Now a set of statements <br><br><pre> <code class="javascript hljs"><span class="hljs-number"><span class="hljs-number">2</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span> should == <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-string"><span class="hljs-string">"aabbcc"</span></span> should contain <span class="hljs-string"><span class="hljs-string">"bb"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>] should be truthy xy() should <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span></code> </pre><br><br>  will be revealed in the next ES5-valid code <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> assert = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'assert'</span></span>); assert.deepEqual(<span class="hljs-number"><span class="hljs-number">2</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">'`2+2`'</span></span> + <span class="hljs-string"><span class="hljs-string">' should be equal to '</span></span> + <span class="hljs-string"><span class="hljs-string">'`4`'</span></span>); assert.ok(<span class="hljs-string"><span class="hljs-string">'aabbcc'</span></span>.indexOf(<span class="hljs-string"><span class="hljs-string">'bb'</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-string"><span class="hljs-string">'`aabbcc`'</span></span> + <span class="hljs-string"><span class="hljs-string">' should contain '</span></span> + <span class="hljs-string"><span class="hljs-string">'`bb`'</span></span>); assert.ok([ <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> ], <span class="hljs-string"><span class="hljs-string">'`[1,2]`'</span></span> + <span class="hljs-string"><span class="hljs-string">' should be truthy'</span></span>); assert.throws(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ xy(); }, <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>, <span class="hljs-string"><span class="hljs-string">'`xy()`'</span></span> + <span class="hljs-string"><span class="hljs-string">' should throw'</span></span>);</code> </pre><br><br>  Mission accomplished!  Now you can start writing your own macros for your tasks or define your syntax for any libraries or frameworks. <br><br>  All the macros I defined in this article (and even a little bit more) are available on npm and on github: <br><br><ul><li>  <a href="https://github.com/Havvy/sweet-bdd">sweet-bdd</a> - describe, it, beforeEach, afterEach, ... macros </li><li>  <a href="https://github.com/andreypopp/sweet-assertions">sweet-assertions</a> - should macro </li></ul><br><br>  In order to use them, you must first install the necessary packages from npm: <br><br><pre> <code class="hljs coffeescript">% <span class="hljs-built_in"><span class="hljs-built_in">npm</span></span> install --<span class="hljs-built_in"><span class="hljs-built_in">global</span></span> mocha sweet.js % <span class="hljs-built_in"><span class="hljs-built_in">npm</span></span> install sweet-bdd sweet-assertions</code> </pre><br><br>  And then compile and test the code. <br><br><pre> <code class="javascript hljs">describe <span class="hljs-string"><span class="hljs-string">"additions"</span></span> { it <span class="hljs-string"><span class="hljs-string">"works"</span></span> { <span class="hljs-number"><span class="hljs-number">2</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span> should == <span class="hljs-number"><span class="hljs-number">4</span></span> } }</code> </pre><br><br>  using the following commands <br><br><pre> <code class="hljs matlab"><span class="hljs-comment"><span class="hljs-comment">% sjs -m sweet-bdd -m sweet-assertions ./specs.sjs &gt; specs.js % mocha specs.js</span></span></code> </pre><br><br>  <a href="https://npmjs.org/browse/keyword/sweet-macros">Other libraries</a> with macros are also available at npm.  I suggest, for example, to look at a <a href="https://github.com/natefaubion/sparkler">sparkler</a> that implements pattern matching in JavaScript: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myPatterns</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Match literals case 42 =&gt; 'The meaning of life' // Tag checking for JS types using Object::toString case a @ String =&gt; 'Hello ' + a // Array destructuring case [...front, back] =&gt; back.concat(front) // Object destructuring case { foo: 'bar', x, 'y' } =&gt; x // Custom extractors case Email{ user, domain: 'foo.com' } =&gt; user // Rest arguments case (a, b, ...rest) =&gt; rest // Rest patterns (mapping a pattern over many values) case [...{ x, y }] =&gt; _.zip(x, y) // Guards case x @ Number if x &gt; 10 =&gt; x }</span></span></code> </pre><br><br>  I think it was interesting.  About all comments, suggestions, please in the comments or who are shy, to me by <a href="">email</a> . <br><br>  UPDATE.  I forgot to say that Sweet.js has the ability to generate code maps (source maps), so there should be no difficulty with debugging (at least in the browser). </div><p>Source: <a href="https://habr.com/ru/post/210454/">https://habr.com/ru/post/210454/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../210444/index.html">Dungeons & Dragons turned 40 years old</a></li>
<li><a href="../210446/index.html">Windows Azure Media Services vs. Amazon Elastic Transcoder. Part 3: Comparison</a></li>
<li><a href="../210448/index.html">Modern technology for the benefit of</a></li>
<li><a href="../210450/index.html">Python on wheels</a></li>
<li><a href="../210452/index.html">Rule 3h when building a startup team Preply</a></li>
<li><a href="../210458/index.html">Transparent file encryption on the local computer using CyberSafe Files Encryption</a></li>
<li><a href="../210460/index.html">OpenVZ in Proxmox, margin notes</a></li>
<li><a href="../210462/index.html">SharePoint collection site, managed paths, and can subdomains?</a></li>
<li><a href="../210464/index.html">Samsung and Google enter into patent agreements</a></li>
<li><a href="../210466/index.html">Dev Story: Raildale - a game about the railway for iOS and Mac</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>