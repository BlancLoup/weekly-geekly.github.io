<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>High website availability: site file geo-replication with lsyncd</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="High availability of the website - a joint work of the hosting provider and the site developer. The primary goal of high availability is minimizing pl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>High website availability: site file geo-replication with lsyncd</h1><div class="post__text post__text-html js-mediator-article">  High availability of the website - a joint work of the hosting provider and the site developer.  The primary goal of high availability is minimizing planned and unplanned downtime. <br><br>  High availability is more than just placing your project in a secure cloud.  A truly highly accessible site should operate in several cloud regions and its users should not notice any changes even if one of the cloud regions becomes unavailable.  The website developer must ensure that the site is up and running even in an emergency.  High availability systems are duplicated: if the provider fails, the site will be available.  If a user fails to replicate, the site should also be available.  If you need to work on the server developer or reload it - users should not notice this. <br><br> <a href="http://infoboxcloud.ru/"><img src="https://habrastorage.org/getpro/habr/post_images/d96/e72/a6e/d96e72a6e7b3df3a1cf74ae17020e87a.jpg" width="500"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this series of articles we will look at how to organize the high availability of various subsystems of your site.  Many tasks have different solutions.  The author does not claim that the best solution is presented here, but it is quite efficient and tested in practice.  However, the field for experiments to increase accessibility is huge. <br><br>  Today we will look at syncing a static site between cloud regions: changes in files on one of the servers should appear on the other.  We will also consider the simplest way to redirect the users of your site to an alternative server using several A-DNS records, applicable for this case. <br><a name="habracut"></a><br><h4>  <b>Lsyncd</b> </h4><br>  <a href="https://code.google.com/p/lsyncd/">Lsyncd</a> (Live Syncing Daemon) is an application for timely interactive mirroring of these servers for use in high-availability clusters.  Especially good lsyncd is suitable for systems with low synchronization traffic.  The application collects information about data changes through the Linux <a href="https://ru.wikipedia.org/wiki/Inotify">inotify</a> kernel subsystem for a period specified in the configuration and starts the process of mirroring changes (via rsync by default, but there are other options).  By default, lsyncd runs as a daemon in the background and logs its actions using <a href="https://ru.wikipedia.org/wiki/Syslog">syslog</a> .  For testing purposes, you can run the application without demonization to see what is happening in the terminal for debugging. <br><br>  Lsyncd does not use a separate file system or block device and does not greatly affect the performance of the local file system. <br><br>  Using the rsync + ssh option allows you to transfer files directly to the target directory instead of transferring the location to a remote server. <br><br><h4>  <b>Installing and configuring geo-replication of web server files</b> </h4><br><h5>  <b>Access to different regions of InfoboxCloud</b> </h5><br>  Order 2 subscriptions to InfoboxCloud in Moscow and Amsterdam to create a geo-distributed solution. <br>  In order for subscriptions to be tied to a single user account, you need to act as follows: <br>  1. Go to <a href="http://infoboxcloud.ru/">http://infoboxcloud.ru</a> and <a href="http://help.sandbox.infoboxcloud.ru/content/ru/cloud_infrastructure/order_cloud/order_cloud.html">order cloud infrastructure</a> in any region (for example, in Amsterdam).  Then go to <a href="https://panel.infobox.ru/">the control panel</a> and order a cloud in another region (for example, in Moscow), as shown below. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dc8/0d5/380/dc80d5380137ed500636ddbc043dc693.jpg" width="400"><br><br>  After ordering, exit the control panel and login again.  Now you can select the region in which the work takes place in the upper right corner of the control panel: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/db3/5a9/d52/db35a9d527e49c74936fe15728fcd879.jpg" width="800"><br><br>  Create 2 servers: one in Moscow, the other in Amsterdam. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/838/50f/4ea/83850f4ea59853be4dba79988629721c.jpg" width="800"><br><br>  As the operating system, select CentOS 7. This article discusses it, but you can use another Linux operating system if necessary.  However, the settings may differ.  You can use any <a href="https://infoboxcloud.ru/community/blog/iaas/220.html">type of virtualization</a> to choose from.  The difference for a particular scenario is that if you <strong>don‚Äôt</strong> check the box ‚Äúallow OS kernel management‚Äù, you can use memory auto-scaling for servers, which will allow you to use resources more efficiently.  And if you <strong>install</strong> , you can configure the inotify kernel subsystem, which will be useful under high loads ( <a href="http://habrahabr.ru/post/132098/">configuration example</a> ), but it does not make sense for a regular small site.  When creating each of the servers, be sure to add one public IP address so that the servers can access from the external network: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/833/6df/7d6/8336df7d69537bbf91713e99cd8db889.jpg" width="500"><br><br>  After creating the servers, the access data will come to your email. <br><br><h5>  <b>DNS setup</b> </h5><br>  For the main domain, the site on which should be highly accessible, create <strong>two</strong> DNS DNS records pointing to a server in Moscow and a server in Amsterdam.  In our case, the site will <strong>failover.trukhin.com</strong> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8c2/375/486/8c237548697c16fc346461b55cd83a43.jpg" width="600"><br><br>  Create service subdomains whose A-record should point to your server.  For example, <strong>failovermsk.trukhin.com</strong> points to a server in <strong>Moscow</strong> , and <strong>failoverams.trukhin.com</strong> points to a server in <strong>Amsterdam</strong> .  Separate subdomains for each of the servers are needed in order, in case the server goes down, to deploy another replica from the backup server and redirect the subdomain to it. <br><br><h5>  <b>Server setup</b> </h5><br>  <strong>The steps below should be done on both servers.</strong> <br>  Connect via SSH to both servers.  Install Apache on each of the servers, run it and add it to autoload: <br><pre><code class="bash hljs">yum -y update &amp;&amp; yum install -y httpd &amp;&amp; systemctl start httpd.service &amp;&amp; systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> httpd.service</code> </pre> <br>  Create an <strong>index.html</strong> file in the / var / www / html directory of each server and make sure that the page opens correctly in the browser from each of the servers. <br><pre> <code class="bash hljs">&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;head&gt; &lt;meta charset=<span class="hljs-string"><span class="hljs-string">"utf-8"</span></span>&gt; &lt;title&gt; Hi &lt;/title&gt; &lt;/head&gt; &lt;body&gt; Hello, World! &lt;/body&gt; &lt;/html&gt;</code> </pre><br>  For lsyncd to work, you need to provide access to each of the servers for each other's keys. <br>  Generate an SSH key (for questions, you can just press Enter): <br><pre> <code class="bash hljs">ssh-keygen</code> </pre><br>  From a server in Moscow, add a key to a server in Amsterdam: <br><pre> <code class="bash hljs">ssh-copy-id root@failoverams.trukhin.com</code> </pre><br>  From the server in Amsterdam, add the key to the server in Moscow: <br><pre> <code class="bash hljs">ssh-copy-id root@failovermsk.trukhin.com</code> </pre><br>  Now connect from the server in Moscow (root@failovermsk.trukhin.com) to the server in Amsterdam (root@failoverams.trukhin.com) and vice versa.  Password should not be requested.  When connecting, answer yes. <br><br><h6>  <b>Install and configure lsyncd</b> </h6><br>  <strong>The steps below should be done on both servers.</strong> <br><br>  To install <strong>lsyncd</strong> on CentOS 7, add the EPEL repository with the command: <br><pre> <code class="bash hljs">rpm -ivh http://mirror.yandex.ru/epel/7/x86_64/e/epel-release-7-5.noarch.rpm</code> </pre><br>  Now install lsyncd: <br><pre> <code class="bash hljs">yum install lsyncd</code> </pre><br><br>  Create a directory for storing the lsyncd logs and temporary files: <br><pre> <code class="bash hljs">mkdir -p /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/lsyncd &amp;&amp; mkdir -p /var/www/temp</code> </pre><br>  Create a lsyncd configuration file at: <strong>/etc/lsyncd.conf</strong> <br><pre> <code class="bash hljs">settings { logfile = <span class="hljs-string"><span class="hljs-string">"/var/log/lsyncd/lsyncd.log"</span></span>, statusFile = <span class="hljs-string"><span class="hljs-string">"/var/log/lsyncd/lsyncd.status"</span></span>, nodaemon = <span class="hljs-literal"><span class="hljs-literal">false</span></span> } sync { default.rsyncssh, <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>=<span class="hljs-string"><span class="hljs-string">"/var/www/html"</span></span>, host=<span class="hljs-string"><span class="hljs-string">"failovermsk.trukhin.com"</span></span>, targetdir=<span class="hljs-string"><span class="hljs-string">"/var/www/html"</span></span>, rsync = { archive=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, compress=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, temp_dir=<span class="hljs-string"><span class="hljs-string">"/var/www/temp"</span></span>, update=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, links=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">times</span></span>=<span class="hljs-literal"><span class="hljs-literal">true</span></span>, protect_args=<span class="hljs-literal"><span class="hljs-literal">true</span></span> }, delay=3, ssh = { port = 22 } }</code> </pre><br>  Value host: <strong>failovermsk.trukhin.com</strong> replace with a subdomain directed only to a server in another region.  The <strong>source</strong> indicates the folder on the current server.  The <strong>targetdir</strong> specifies the folder on the remote server.  The <strong>delay</strong> parameter is the period over which the changes will be synchronized on the server.  This value is chosen experimentally, the default value is 10. Fully all the parameters of lsyncd can be found in the <a href="https://github.com/axkibe/lsyncd/wiki/Lsyncd-2.1.x-%25E2%2580%2596-Layer-4-Config-%25E2%2580%2596-Default-Behavior">official documentation</a> . <br><br>  To debug, set the parameter <strong>nodaemon = true</strong> and save the changes.  Create a file <strong>on one of the servers</strong> : <br><pre> <code class="bash hljs">touch /var/www/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre><br>  Run lsyncd manually to verify that everything is synchronizing correctly. <br><pre> <code class="bash hljs">lsyncd /etc/lsyncd.conf</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/ad2/c17/85e/ad2c1785e07f6da11ded8311bb6a134c.jpg" width="800"><br><br>  If everything went well - on a server in another region in the / var / www / html folder, you will see the test file created. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f76/46d/459/f7646d459c0011c9e1d00e9f4d75d120.jpg" width="800"><br><br>  Now return the value of <strong>nodaemon = false</strong> in /etc/lsyncd.conf.  Add lsyncd to autoload and start the service: <br><pre> <code class="bash hljs">systemctl start lsyncd.service systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> lsyncd.service</code> </pre><br>  Make sure the data is replicated after reboot. <br><br><h6>  <b>2-way replication</b> </h6><br>  For replication to work in the opposite direction - on the server in another region, make the same settings, but in the lsyncd configuration file, specify the address of the first server.  Check that the data is replicated in the opposite direction.  The lsyncd configuration already contains a temporary <strong>temp_dir</strong> directory, the use of which is necessary for two-way synchronization. <br><br>  <strong>It is not always necessary to replicate to 2 sides</strong> , since in mysql it is not recommended to use master-master replication and in the event of the first server failing when using such a database, you will need to configure replication from the second working server to the third.  This is done simply if we prepare in advance the backup server template for the cloud, which will be discussed in subsequent articles.  Today we work only with files and for a static site two-way replication is quite applicable. <br><br><h4>  <b>Check the availability of the site</b> </h4><br>  Let's go to our website: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fd1/aff/97d/fd1aff97dc3d4e7fdb7a8cb156a4b88c.jpg" width="400"><br><br>  Both servers are available. <br><br>  Next, turn off the server in Moscow. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d75/fd5/d60/d75fd5d60652feaaf4eb92a7a51f7a5a.jpg" width="800"><br><br>  Our site is available: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/aa0/a29/203/aa0a2920398c6d3eb80560f83cad7cbe.jpg" width="400"><br><br>  Turn on the server in Moscow and turn off in Amsterdam: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/131/504/18f/13150418fc439f0bec0907feb776b1b3.jpg" width="800"><br><br>  Our site is available: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/602/136/4dc/6021364dcb67df7c5c99c183ffe74065.jpg" width="400"><br><br><h5>  <b>Why does this work?</b> </h5><br>  Modern browsers, if there are several A-records, first try to access one ip ‚Äì address, and if it is not available, another.  Thus, if at least one server is available, the site will work. <br><br>  This approach in a more complex form has been used by large sites for a long time, and a lot of backup servers have been made for them.  For example, Google has 11: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f8a/a41/143/f8aa411433d48facef98488ffe70dc86.jpg" width="400"><br><br><h4>  <b>Conclusion</b> </h4><br>  In this article, we looked at how to configure geo-replication for a static site without a database.  In subsequent articles, we will look at how to replicate a database and provide high availability for more complex sites. <br><br>  If you find an error in the article, the author will gladly correct it.  Please write in the LAN or <a href="">in the mail</a> about it.  If you can not leave comments on Habr√© - write them in the <a href="https://infoboxcloud.ru/community/blog/iaas/248.html">InfoboxCloud Community</a> . <br><br>  Successful work! </div><p>Source: <a href="https://habr.com/ru/post/252751/">https://habr.com/ru/post/252751/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252741/index.html">RFC2544 standard test</a></li>
<li><a href="../252743/index.html">Your personal course on Big Data</a></li>
<li><a href="../252745/index.html">The most needed plugins for Gulp</a></li>
<li><a href="../252747/index.html">Best Practices for SSL / TLS Deployment, Part 2. Configuration</a></li>
<li><a href="../252749/index.html">Detect blocked resources using Google webmaster tools</a></li>
<li><a href="../252753/index.html">DaData.ru prompts email and determines the city by IP</a></li>
<li><a href="../252755/index.html">Tales of the antivirus forest</a></li>
<li><a href="../252759/index.html">Creating a Windows Runtime component in Visual C ++</a></li>
<li><a href="../252761/index.html">Optimizing the ToArray and ToList methods by providing the number of elements</a></li>
<li><a href="../252763/index.html">Virtual Link Trunking (VLT) Technology for Dell Network Factories</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>