<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Stripe CTF - SHA-1 algorithm vulnerability analysis</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When a post was published on Habr√© that Stripe is holding a Capture the Flag contest, I immediately registered as a participant. 

 Each of the nine l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Stripe CTF - SHA-1 algorithm vulnerability analysis</h1><div class="post__text post__text-html js-mediator-article"> When a <a href="http://habrahabr.ru/company/apps4all/blog/150097/">post</a> was published on Habr√© that Stripe is holding a <a href="https://stripe-ctf.com/">Capture the Flag</a> contest, I immediately registered as a participant. <br><br>  Each of the nine levels represented the task of hacking the system and obtaining a password to the next level.  Passwords could be stored both in databases and files, and in memory.  By the way, all the code was open, so the tasks were reduced to analyzing the code for vulnerabilities, it was not necessary to poke blindly. <br><br>  Levels from 0 to 6 were not difficult - standard SQL and JavaScript injections, uploading a PHP script to the server instead of a picture, etc. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But the 7th level makes me break my head ... <br><a name="habracut"></a><br>  Stripe programmers, inspired by the <a href="http://tacocopter.com/">TacoCopter</a> service, modeled a certain WaffleCopter - a service for the delivery of waffles to any specified point using a radio-controlled (or maybe fully automated) helicopter. <br><br>  The service provides an API for waffles.  The database contains information about users and types of waffles available for ordering.  There are several types available for ordering only premium accounts. <br><br>  CTF participants were provided with a regular account and the task was to order a specific type of premium waffles - Li√®ge Waffles.  As a bonus, a log of requests was published, so that you could see who ordered what and when. <br><br>  Each request must be signed using the SHA-1 algorithm according to the following principle: <br> <code> = sha1 (  +  )</code> <br> <code> += "|sig:" + </code> <br> <br>  Then the message is sent to the server using the POST method. <br><br>  In the logs I found the following query: <br> <code>user_id=1&amp;lat=26.629166676667&amp;long=-70.883611121111&amp;count=1 <br> &amp;waffle=dream|sig:439ca26828fb91eb8525274ecb9ef241f0487c88</code> <br>  (unfortunately, the server is already unavailable, so I substituted my values ‚Äã‚Äãin the request body) <br><br>  Here user_id is the user ID, lat and long are the coordinates of the place where the order is delivered, count is the number and waffle is the order type itself.  Of course, the type of waffles does not correspond to those that we must order, otherwise everything would be too easy. <br><br>  Since before our eyes there were logs of requests from premium users, the first thought that came to mind was ‚Äúcan I figure out the secret from two messages and two hashes?‚Äù <br>  Of course, this option immediately disappeared, since SHA-1 is not so simple an algorithm. <br><br>  After reading <a href="http://ru.wikipedia.org/wiki/SHA-1">Wikipedia</a> and a little googling about SHA-1, I found that it is not recommended to generate a signature like this: <code>sha1 (  +  )</code> , since this method is not sufficiently reliable.  At the same time, I received a hint from my American friend, who at that time had already successfully solved this quest: length-extension, or an attack by lengthening the message, which is also mentioned in Wikipedia.  Well ... I didn‚Äôt even think that SHA-1 is so vulnerable. <br><br>  The main loop SHA-1 iteratively processes 512-bit blocks into which the original message is broken.  By calculating and rearranging the block, five 32-bit words are formed at the output of each iteration, which are the input parameters of the next iteration.  After the last iteration, these parameters are combined into a 160-bit hash. <br><br><div class="spoiler">  <b class="spoiler_title">Watch the video, how the algorithm works.</b> <div class="spoiler_text"><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/aLvwpJcOy6s%3Ffeature%3Doembed&amp;xid=17259,15700019,15700043,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhjd_LpmCwWUxMSQu5D_ynkGm3uHXg" frameborder="0" allowfullscreen=""></iframe></div></div><br>  The essence of the attack by lengthening the message is as follows.  Another 512-bit block, consisting of an additional message, which we want to transmit to the server on behalf of another user, as well as service information, in particular, units, complementary zeros and message length, is initialized.  The 160-bit hash of the original message known to us is divided into five 32-bit words and an additional iteration is carried out, where the calculated words are input parameters.  Above our block, the necessary operations are performed and at the output we get new five words, which will be the new 160-bit hash. <br><br>  We supplement the original message with ours, replace the original hash with the computed, and voila: the server accepted our request. <br>  At the same time the server will receive something like <br> <code>user_id=1&amp;lat=26.629166676667&amp;long=-70.883611121111&amp;count=1 <br> &amp;waffle=dream%01%00%00%00%00%00P&amp;waffle=liege</code> <br> <br>  We added the wafer type we need to the original message.  In response to the request, we will receive a confirmation code, which, in the case of the order of Li√®ge Waffles, will be a password to the next level. <br><br>  As a measure to counter this type of attack, double hashing is recommended. </div><p>Source: <a href="https://habr.com/ru/post/151682/">https://habr.com/ru/post/151682/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151677/index.html">Differentiating Object, Array, Number, and String</a></li>
<li><a href="../151678/index.html">Two-level organization of source code. Inevitably or meaningless?</a></li>
<li><a href="../151679/index.html">SCSS: a couple of useful techniques</a></li>
<li><a href="../151680/index.html">But the robot turnstile, which recognizes you in person</a></li>
<li><a href="../151681/index.html">Example of using Perl REGEXP for fast text processing</a></li>
<li><a href="../151684/index.html">Bash heavy duty queue</a></li>
<li><a href="../151685/index.html">Released updated Group Policy Reference for Windows Server 2012 and Windows 8</a></li>
<li><a href="../151688/index.html">Hack Wi-Fi in ... 3 seconds</a></li>
<li><a href="../151689/index.html">Indie-Tracker Update</a></li>
<li><a href="../151690/index.html">ECMAScript Harmony and Node.js</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>