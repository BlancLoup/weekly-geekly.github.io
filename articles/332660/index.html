<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Script for express recovery Excel files after damage</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This note is intended for those who, when trying to open an Excel file, get an error message of the form: 


 In my case, with such an error, the xlsx...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Script for express recovery Excel files after damage</h1><div class="post__text post__text-html js-mediator-article">  This note is intended for those who, when trying to open an Excel file, get an error message of the form: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/35c/560/15a/35c56015ad3347ae89f3562713098733.png"></div><br>  In my case, with such an error, the xlsx-file (below 1.xlsx) was opened, restored with the help of R-Saver after a virus attack similar to ‚ÄúPetya‚Äù. <br><a name="habracut"></a><br>  After unpacking the contents of the 1.xlsx file into the "\ 1" folder, the following errors were displayed via the context menu: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/979/0f3/0cc/9790f30cca824e7ba10a2eddecd76505.png"></div><br>  It turned out that these service files are of zero size.  I did a similar procedure with a valid 2.xlsx file and copied from its "\ 2" folder non-zero [Content_Types] .xml and .rels files over the empty "\ 1" files.  Then added the contents of the folder "\ 1" to the .zip archive and renamed it to 3.xlsx.  As a result, the 3.xlsx file has already opened with correct data, albeit with a warning: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/web/225/d97/823/225d9782379f40208817381fb3910928.png"></div><br>  To automate the procedures performed above, a vbscript script was developed, distributed ‚ÄúAs Is‚Äù. <br><br><div class="spoiler">  <b class="spoiler_title">Script source code ST1_XLSX_FIXER_v1</b> <div class="spoiler_text"><pre><code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">explicit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> THIS_SCRIPT_NAME = <span class="hljs-string"><span class="hljs-string">"ST1_XLSX_FIXER_v1.vbs"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> SUBDIR_XLS_SRC = <span class="hljs-string"><span class="hljs-string">"ST1_XLSX_FIXER_DATA_v1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> SUBDIR_OUT = <span class="hljs-string"><span class="hljs-string">"ST1_XLSX_FIXED"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Const</span></span> RES_SUFFIX = <span class="hljs-string"><span class="hljs-string">"_fixed_ST1_v1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> fso: <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> fso = <span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>(<span class="hljs-string"><span class="hljs-string">"Scripting.FileSystemObject"</span></span>) <span class="hljs-comment"><span class="hljs-comment">'    if WScript.ScriptName = THIS_SCRIPT_NAME then if WScript.Arguments.Count &gt; 0 then Dim fname for each fname in WScript.Arguments if fso.GetExtensionName(fname) = "xls" then WScript.Echo "  Excel 2003   (.xls)  " else FixCorruptedExcel fname end if next else WScript.Echo "    xlsx-  " end if end if Set fso = Nothing Sub FixCorruptedExcel(fpath) Dim out_dir: out_dir = fso.GetParentFolderName(fpath) &amp; "\" &amp; SUBDIR_OUT if Trim(out_dir) &lt;&gt; "" then '   If not fso.FolderExists(out_dir) Then fso.CreateFolder(out_dir) end if End If 'c  xlsx-   .zip Dim extract_dir: extract_dir = out_dir &amp; "\" &amp; fso.GetBaseName(fpath) Dim fpath_zip: fpath_zip = extract_dir &amp; ".zip" fso.CopyFile fpath, fpath_zip '  Dim fpath_fixed: fpath_fixed = extract_dir &amp; RES_SUFFIX &amp; ".xlsx" if fso.FileExists(fpath_fixed) then fso.DeleteFile fpath_fixed ' zip UnzipFile fpath_zip, extract_dir ' zip- fso.DeleteFile fpath_zip '     Dim script_path: script_path = fso.GetParentFolderName(Wscript.ScriptFullName) fso.CopyFolder script_path &amp; "\" &amp; SUBDIR_XLS_SRC, extract_dir ' zip CreateEmptyZipFile fpath_zip ' extract_dir Dim shell: set shell = CreateObject("Shell.Application") Dim extract_dir_obj: set extract_dir_obj = fso.GetFolder(extract_dir) shell.NameSpace(fpath_zip).CopyHere shell.NameSpace(extract_dir).Items do until shell.namespace(fpath_zip).items.count = shell.namespace(extract_dir).items.count wscript.sleep 1000 loop 'zip -&gt; xlsx fso.MoveFile fpath_zip, fpath_fixed ' unzip- fso.DeleteFolder extract_dir, true WScript.Echo " : " &amp; vbCrLf &amp; fpath_fixed Set shell = Nothing end sub sub UnzipFile(fpath_zip, extract_dir) '    If not fso.FolderExists(extract_dir) Then fso.CreateFolder(extract_dir) End If ' xlsx -     "  ..." Dim shell: set shell = CreateObject("Shell.Application") Dim sub_files: set sub_files = shell.NameSpace(fpath_zip).items Const FOF_SILENT = &amp;H4&amp; Const FOF_RENAMEONCOLLISION = &amp;H8&amp; Const FOF_NOCONFIRMATION = &amp;H10&amp; Const FOF_ALLOWUNDO = &amp;H40&amp; Const FOF_FILESONLY = &amp;H80&amp; Const FOF_SIMPLEPROGRESS = &amp;H100&amp; Const FOF_NOCONFIRMMKDIR = &amp;H200&amp; Const FOF_NOERRORUI = &amp;H400&amp; Const FOF_NOCOPYSECURITYATTRIBS = &amp;H800&amp; Const FOF_NORECURSION = &amp;H1000&amp; Const FOF_NO_CONNECTED_ELEMENTS = &amp;H2000&amp; Dim args: args = FOF_SILENT + FOF_NOCONFIRMATION + FOF_NOERRORUI shell.NameSpace(extract_dir).CopyHere sub_files, args Set shell = Nothing end sub sub CreateEmptyZipFile(fname) if fso.FileExists(fname) then WScript.Echo " " &amp; fname &amp; "  ", vbCritical, WScript.ScriptFullName end if Const ForWriting = 2 Dim fp: set fp = fso.OpenTextFile(fname, ForWriting, True) fp.Write "PK" &amp; Chr(5) &amp; Chr(6) &amp; String(18, Chr(0)) fp.Close end sub</span></span></code> </pre> <br></div></div><br>  In addition to the script <a href="https://drive.google.com/file/d/0B2HGddzt5gSNM3lVZE1tbnE2UUE/view%3Fusp%3Dsharing">in the archive</a> attached folder ST1_XLSX_FIXER_DATA_v1, where are the reference files for substitution.  You can modify its contents in order to extend the scope of the script to other variants of broken files.  For example, add there the variants of zero files found by you. <br><br>  <b>For the script to work:</b> <br><br><ol><li>  Download and unzip the archive ST1_XSLX_FIXER_v1.zip to any folder </li><li>  Left-click to transfer one or more xlsx files to the ST1_XLSX_FIXER_v1.vbs script </li><li>  The processing of each file will begin: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/b02/bf5/c1f/b02bf5c1f07e44dd9957d589500d65c3.png"></div></li><li>  After successful processing of each file, a message of the form is displayed: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/6e3/dab/e8b/6e3dabe8b071447589cd7a198e3adf84.png"></div><br></li></ol><br>  <b>The principle of the script:</b> <br><br><ol><li>  Keeps the input file unchanged </li><li>  Creates a subfolder of ST1_XLSX_FIXED </li><li>  Creates a renamed zip copy of xlsx in ST1_XLSX_FIXED </li><li>  Extract zip to a folder and copy over it ST1_XLSX_FIXER_DATA_v1 </li><li>  Archives the resulting folder to zip and renames the resulting file to xlsx </li></ol><br>  <b>Conclusion</b> <br><br>  These experiments do not claim to common use, use the proposed solution at your own risk.  For my part, I plan to conduct a wider experiment and finalize the script based on the results.  The current explicit limitation is that the script does not analyze the size of the replaced files when copying from ST1_XLSX_FIXER_DATA_v1, therefore, it is not able to determine which service files were empty and require their replacement.  Most likely, this method is applicable if the service files are lost, and not the worksheets from "\ 1 \ xl \ worksheets". <br><br>  Also, the script is not suitable for files with the xls extension, created in versions of Excel 2003 and earlier, because it uses a different data storage format. </div><p>Source: <a href="https://habr.com/ru/post/332660/">https://habr.com/ru/post/332660/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332646/index.html">Security Week 27: ExPetr = BlackEnergy, more than 90% of sites are insecure, in RCE-vulnerability closed in Linux</a></li>
<li><a href="../332652/index.html">Using LibVirt API, InfluxDB and Grafana to collect and visualize VM execution statistics</a></li>
<li><a href="../332654/index.html">Creating chatbot-a using sockeye (MXNet) based on AWS EC2 and AWS DeepLearning AMI</a></li>
<li><a href="../332656/index.html">What did the PR leaders do on the day of the meeting between Putin and Trump on the G20?</a></li>
<li><a href="../332658/index.html">Personal experience: as an IT specialist, move to work in the USA, relying only on himself</a></li>
<li><a href="../332662/index.html">Interview in SD podCast with Pavel Odintsov, author of FastNetMon, a tool for detecting and repelling DDoS attacks</a></li>
<li><a href="../332664/index.html">Automata programming. Part 3. State and transition diagram. Continuation</a></li>
<li><a href="../332668/index.html">How to confuse analytics - 4. Probability and accuracy</a></li>
<li><a href="../332670/index.html">Smart IDReader SDK - add recognition to Android apps</a></li>
<li><a href="../332672/index.html">Google will soon cease to trust all certificates WoSign and StartCom</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>