<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multi-file storage of Java objects in xml format</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Multi-file storage of Java objects in xml format (part 2) 

 Introduction 
 In programming, we often face problems that we can solve in several ways: ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multi-file storage of Java objects in xml format</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/post/186526/">Multi-file storage of Java objects in xml format (part 2)</a> <br><br><h4>  Introduction </h4><br>  In programming, we often face problems that we can solve in several ways: to find and use ready-made solutions, or to solve a problem on our own.  Although many specifications and their implementations have been written, they do not always give us what is required in a particular case.  So I once again had to face a similar situation. <br>  The task was to store objects in a file in xml format.  Nothing would have seemed complicated if not for a few buts.  It is a lot of objects, they have a tree structure and on them operations of addition, change and removal in different flows are constantly performed.  As you understand, permanently writing and reading a large xml file is quite a laborious task.  Especially if several threads work with the same data.  So actually the idea was born to write a multi-file storage of objects in xml format. <br>  In this article I will not consider the implementation itself.  I will give only the main ideas and how to use this implementation.  If you want to go deep, you can download view source codes. <br><br>  Sources are available at the link: <a href="">xdstore-1.3</a> <br>  Source codes are slightly different from those in this article.  Exceptional situations were worked out more deeply in them, namely, for each operation, including reading, its own exception is thrown.  Also in the latest version implemented fragmentation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  The main idea of ‚Äã‚Äãthe development </h4><br>  The main idea is to store objects not in a single file, but in a certain set.  At the same time provide the ability to customize storage policies for each required class.  You can set one of the following policies for a class: <br><ul><li>  <i>ParentObjectFile</i> - class objects will be saved in the file of the owner object as children, this policy is applied by default; </li><li>  <i>SingleObjectFile</i> - a separate file is provided for each class object, and only the link to this object will be saved in the owner object file (in the future I will simply call it an object reference);  all files of each object will be stored in a separate folder inside the vault; </li><li>  <i>ClassObjectsFile</i> - all objects of this class will be stored in a separate file, and only object references will be saved in the owner object files. </li></ul><br>  The concept of an object reference is an object of a specified class that has a single field, an identifier.  In the xml file, instead of the complete data of this object, only the class name and the identifier are saved so that later on this link you can get all the data.  Loading such objects is similar to late initialization in hibernate. <br>  Stored objects should be implemented as JavaBeans with get (is) and set methods for stored fields. <br><br><a name="habracut"></a><br><h4>  One interesting challenge </h4><br>  In order to better understand the situation that we find ourselves when trying to implement such a repository, it is necessary to correctly set the task.  In terms of the database, it sounds like this: there are two rows in the database table, two transactions start at the same time, each of which modifies both rows, then the first transaction ends with a commit and the third begins, which also modifies these two rows. <br>  We are interested in behavior in a similar situation, i.e.  what happens to the data in each of the transactions.  In the current library implementation, the behavior will be as follows: <br>  1) Since the data was modified by the first transaction, the second transaction will be rejected to change the data as an exception.  This is explained by the fact that the first and second transactions began at the same time and most likely worked with identical copies, and in order not to lose the changes of the first transaction of the second one, it is necessary to refuse. <br>  2) But the data of the third transaction will be accepted, since it started after the commit of the first transaction and works with the updated data. <br>  Since this is a fairly simple implementation, when solving the task, no record locks were used to avoid deadlocks and the need to roll back transactions by timeout.  In this case, an exception is thrown, for which the transaction should be rolled back. <br><br><h4>  Start using </h4><br>  The very purpose of this development is to get a simple and flexible library that allows you to save objects in xml format.  Therefore, the resulting interface is quite simple, and the requirements for the stored objects are minimized.  The basic requirement for each saved object is the need to implement a simple interface IXmlDataStoreIdentifiable.  It looks like this: <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IXmlDataStoreIdentifiable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String id)</span></span></span></span>; }</code> </pre> <br>  As you can see, you only need to implement two methods of working with the object identifier.  This prerequisite is due to the fact that with some policies, only links to objects are saved, according to which you may later need to restore (load) all properties.  The link in the xml file looks like this: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">reference</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.flib.xdstore.entities.XdGalaxy"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cc74e3f2"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br>  When this link is loaded, an object of the specified class will be created and an identifier property will be attached to it.  The remaining fields will be initialized by default, i.e. they will not be loaded. <br>  We now consider a simple example of setting up a repository for storing objects of the following classes: XdUniverse and XdGalaxy.  First, we define their classes. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> org.flib.xdstore.entities; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Collection; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.flib.xdstore.IXmlDataStoreIdentifiable; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XdUniverse</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IXmlDataStoreIdentifiable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String id; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Collection&lt;XdGalaxy&gt; galaxies; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id = id; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Collection&lt;XdGalaxy&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getGalaxies</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> galaxies; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setGalaxies</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Collection&lt;XdGalaxy&gt; galaxies)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.galaxies = galaxies; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addGalaxy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(XdGalaxy galaxy)</span></span></span><span class="hljs-function"> </span></span>{ galaxies.add(galaxy); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> XdGalaxy </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeGalaxy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Iterator&lt;XdGalaxy&gt; it = galaxies.iterator(); XdGalaxy galaxy = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(it.hasNext()) { galaxy = it.next(); it.remove(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> galaxy; } }</code> </pre><br>  And a simple XdGalaxy class. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> org.flib.xdstore.entities; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.flib.xdstore.IXmlDataStoreIdentifiable; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XdGalaxy</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IXmlDataStoreIdentifiable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String id; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id = id; } }</code> </pre><br>  Now you can consider setting up storage for the specified entities. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XmlDataStore store = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XmlDataStore(<span class="hljs-string"><span class="hljs-string">"./teststore"</span></span>); store.setStorePolicy(XdUniverse.class, XmlDataStorePolicy.ClassObjectsFile); store.setStorePolicy(XdGalaxy.class, XmlDataStorePolicy.ClassObjectsFile);</code> </pre><br>  Now we have chosen the settings that all objects of each of the classes will be stored in their own file, i.e.  for each class one file.  You can use other settings and, for example, do not specify a policy for the XdGalaxy class, then its objects will be saved along with the objects of the XdUniverse class. <br>  As a result, for our settings after recording the objects, we get two files: XdUniverse.xml and XdGalaxy.xml. <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">objects</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">object</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isNull</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.flib.xdstore.entities.XdUniverse"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"002df141"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">collection</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Galaxies"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"java.util.ArrayList"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">reference</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.flib.xdstore.entities.XdGalaxy"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cc74e3f2"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">reference</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.flib.xdstore.entities.XdGalaxy"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ca519d20"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">collection</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">object</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Id"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isNull</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"java.lang.String"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"002df141"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">object</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">objects</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  As you can see from the example, this file contains links to objects from the second XdGalaxy.xml file below. <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">objects</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">object</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isNull</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.flib.xdstore.entities.XdGalaxy"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cc74e3f2"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">object</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Id"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isNull</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"java.lang.String"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cc74e3f2"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">object</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">object</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isNull</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.flib.xdstore.entities.XdGalaxy"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ca519d20"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">object</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Id"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isNull</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"java.lang.String"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ca519d20"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">object</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">objects</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  So we got two file storage for our objects.  If we do not need XdGalaxy class objects, then we can download only XdUniverse class objects and work with them.  If we need objects of class XdGalaxy, then we just need to download them from already loaded links. <br>  In case we set the policy of storing SingleObjectFile objects, a folder will be created in the root directory of the vault in which the object files will be saved. <br><br><h4>  Saving and loading objects </h4><br>  Consider the interface of the class XmlDataStore, concerning the operations of saving objects.  It is quite simple and allows us to save objects without specifying policies, since they are already set during initialization of the repository. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XmlDataStore</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> XmlDataStoreTransaction </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beginTransaction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">commitTransaction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> XmlDataStoreTransaction transaction)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rollbackTransaction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> XmlDataStoreTransaction transaction)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T extends IXmlDataStoreIdentifiable&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveRoot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T root)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> XmlDataStoreException </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> &lt;T extends IXmlDataStoreIdentifiable&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T object)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> XmlDataStoreException </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> &lt;T extends IXmlDataStoreIdentifiable&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveObjects</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Collection&lt;T&gt; objects)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> XmlDataStoreException }</span></span></code> </pre><br>  The repository was developed for multi-threaded use and several resource objects can be involved in the course of work, so it uses a transaction mechanism and provides the appropriate methods.  The acceptance and rollback of a transaction can also be invoked through the methods of the object of the transaction itself. <br>  Preserving root objects and child objects are slightly different, so the methods of working on root objects are divided into a separate group.  The difference is that with the SingleObjectFile policy, a separate file will be selected for each root object and, in addition, an additional file will be created for all of them in which the links will be stored.  This allows you to load all root objects at once. <br>  Now consider the save operation. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XmlDataStore store = initStore(<span class="hljs-string"><span class="hljs-string">"./teststore"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XdUniverse universe = generateUniverse(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XmlDataStoreTransaction tx = store.beginTransaction(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { store.saveRoot(universe); store.saveObjects(universe.getGalaxies()); tx.commit(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (XmlDataStoreException e) { tx.rollback(); }</code> </pre><br>  From the example, it is clear that saving objects is quite simple.  We only note that since the objects of the XdGalaxy class are saved in a separate file, we need to explicitly perform their save operation.  They can also be saved individually using another method described above.  The object itself writes to the file when the transaction is committed to making a transaction, and until it is called, all operations are performed with the cache. <br>  Now consider the part of the interface related to loading objects from the repository. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XmlDataStore</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T extends IXmlDataStoreIdentifiable&gt; <span class="hljs-function"><span class="hljs-function">Map&lt;String, T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadRoots</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Class&lt;T&gt; cl)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> XmlDataStoreException </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> &lt;T extends IXmlDataStoreIdentifiable&gt; T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadRoot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Class&lt;T&gt; cl, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String id)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> XmlDataStoreException </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> &lt;T extends IXmlDataStoreIdentifiable&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T reference)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> XmlDataStoreException </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> &lt;T extends IXmlDataStoreIdentifiable&gt; T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Class&lt;T&gt; cl, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String id)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> XmlDataStoreException </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> &lt;T extends IXmlDataStoreIdentifiable&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadObjects</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Collection&lt;T&gt; references)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> XmlDataStoreException }</span></span></code> </pre><br>  As you can see, the repository allows us to load all the roots of the specified class at once or to request one root of the specified class by the identifier.  You can also download objects of any class by reference or identifier.  In our case, loading all the saved data will look like this. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XmlDataStore store = initStore(<span class="hljs-string"><span class="hljs-string">"./teststore"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XmlDataStoreTransaction tx = store.beginTransaction(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Map&lt;String, XdUniverse&gt; roots = store.loadRoots(XdUniverse.class); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XdUniverse root : roots.values()) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Collection&lt;XdGalaxy&gt; galaxies = root.getGalaxies(); store.loadObjects(galaxies); } tx.commit(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(XmlDataStoreException e) { tx.rollback(); }</code> </pre><br>  From the example we see that all the roots are loaded first, and then for each root, all child objects are loaded by the object links. <br><br><h4>  Updating and deleting objects </h4><br>  Methods for updating (modifying) and deleting objects are presented below. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XmlDataStore</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T extends IXmlDataStoreIdentifiable&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateRoot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T root)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> XmlDataStoreException </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> &lt;T extends IXmlDataStoreIdentifiable&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteRoot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T root)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> XmlDataStoreException </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> &lt;T extends IXmlDataStoreIdentifiable&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteRoot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Class&lt;T&gt; cl, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String id)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> XmlDataStoreException </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> &lt;T extends IXmlDataStoreIdentifiable&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T object)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> XmlDataStoreException </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> &lt;T extends IXmlDataStoreIdentifiable&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T reference)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> XmlDataStoreException </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> &lt;T extends IXmlDataStoreIdentifiable&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteObjects</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Collection&lt;T&gt; references)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> XmlDataStoreException }</span></span></code> </pre><br>  It should be noted that all dependent objects that are stored in separate files from the owner must be explicitly updated or deleted.  For example, in our case, when removing an XdGalaxy class object from an XdUniverse object, you need to update the XdUniverse object and additionally explicitly delete XdGalaxy. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XmlDataStore store = initStore(<span class="hljs-string"><span class="hljs-string">"./teststore"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XmlDataStoreTransaction tx = store.beginTransaction(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Map&lt;String, XdUniverse&gt; roots = store.loadRoots(XdUniverse.class); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XdUniverse root : roots.values()) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Collection&lt;XdGalaxy&gt; galaxies = root.getGalaxies(); store.loadObjects(galaxies); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(roots.size() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XdUniverse universe = roots.values().iterator().next(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XdGalaxy galaxy = universe.removeGalaxy(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(galaxy != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { store.updateRoot(universe); store.deleteObject(galaxy); } } tx.commit(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(XmlDataStoreException e) { tx.rollback(); }</code> </pre><br>  If an object is added, the code looks like this. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XmlDataStore store = initStore(<span class="hljs-string"><span class="hljs-string">"./teststore"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XmlDataStoreTransaction tx = store.beginTransaction(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Map&lt;String, XdUniverse&gt; roots = store.loadRoots(XdUniverse.class); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XdUniverse root : roots.values()) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Collection&lt;XdGalaxy&gt; galaxies = root.getGalaxies(); store.loadObjects(galaxies); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(roots.size() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XdUniverse universe = roots.values().iterator().next(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XdGalaxy galaxy = initGalaxy(); <span class="hljs-comment"><span class="hljs-comment">// initialization XdGalaxy universe.addGalaxy(galaxy); store.updateRoot(universe); store.saveObject(galaxy); } tx.commit(); } catch(XmlDataStoreException e) { tx.rollback(); }</span></span></code> </pre><br>  If the saving policy is ParentObjectFile, then for the child objects there is no need to explicitly perform the delete and save operations, since after updating the owner object the necessary operation will be performed automatically. <br>  Complete cleaning of our storage will look like this: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XmlDataStore store = initStore(storedir); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XmlDataStoreTransaction tx = store.beginTransaction(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Map&lt;String, XdUniverse&gt; roots = store.loadRoots(XdUniverse.class); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> XdUniverse root : roots.values()) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Collection&lt;XdGalaxy&gt; galaxies = root.getGalaxies(); store.deleteObjects(galaxies); store.deleteRoot(root); } tx.commit(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(XmlDataStoreException e) { tx.rollback(); }</code> </pre><br>  From the example it is clear that we did not even need to load XdGalaxy class objects before deleting.  We just passed a collection of object references.  This is possible because the object reference stores the object identifier. <br><br><h4>  Little about implementation </h4><br>  To improve the performance of the storage is used non-detachable caching.  Those.  when working with any resource object (file), all objects stored in it are loaded and cached during the first transaction.  All other transactions work with already cached data.  Cache data is reset when the last transaction that runs on this resource object is completed.  All changes are cached and not flushed to disk until a transaction is committed. <br>  Since an indefinite number of resource objects may be affected during the execution of a transaction, the operation of making changes to a transaction is performed on all one by one.  If any error occurs during this process, the integrity of the data warehouse is broken and an exception of type XmlDataStoreRuntimeException is thrown.  In the current implementation, restoring the integrity of the repository is not implemented.  This is one of the major drawbacks of the current version. <br><br><h4>  Development plans </h4><br>  In the current implementation, with a large number of objects of a certain class and the storage policy ClassObjectsFile, the complexity of read and write operations grows in direct proportion to the growth in the number of objects.  In order to improve storage performance, we plan to implement fragmentation and the construction of an index file.  Fragmentation means breaking down a single file into fragments containing a limited number of objects, and the index in this case will contain links indicating the file of the fragment in which the object is stored. <br>  The plans also include implementation of restoring the integrity of the repository after a failure in making changes to the transaction. <br>  It is possible that triggers will appear in the new storage implementation, which will be called when the state of stored objects changes.  Those.  when adding, changing or deleting objects. <br><br>  <u>Author: Beschastny Evgeny</u> <br><br>  <a href="http://habrahabr.ru/post/186526/">Multi-file storage of Java objects in xml format (part 2)</a> </div><p>Source: <a href="https://habr.com/ru/post/185890/">https://habr.com/ru/post/185890/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../185876/index.html">Installing Tiny Tiny RSS on Zyxel Keenetic router</a></li>
<li><a href="../185878/index.html">Own Web project on D under Ubuntu OS</a></li>
<li><a href="../185882/index.html">More about the evolution of racing cars</a></li>
<li><a href="../185886/index.html">NAT traversal with IPv6 & CloudFlare</a></li>
<li><a href="../185888/index.html">Reliable (non-extreme) overclocking of the processor and memory for ASUS motherboards with an i7 processor</a></li>
<li><a href="../185894/index.html">mogenerator for Core Data you need to know about</a></li>
<li><a href="../185896/index.html">Automatic fluid interface and ArrayIterator in PHP models</a></li>
<li><a href="../185898/index.html">Sip via Wi-Fi + UniFi. Experience of use and modernization</a></li>
<li><a href="../185900/index.html">Obesity on the web. A little bit personal about browser development trends.</a></li>
<li><a href="../185902/index.html">Microsoft released another set of updates, July 2013</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>