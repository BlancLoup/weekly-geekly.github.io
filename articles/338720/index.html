<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Use PubNub: Emotional Talking Chat Do It Yourself</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Surprisingly, there is still very little information about PubNub in the Russian-speaking segment of the Internet ( including Habre as well) . Meanwhi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Use PubNub: Emotional Talking Chat Do It Yourself</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/835/21a/92e/83521a92e827dc2ec4d8b9ae661f8565.png" alt="image"><br><br>  Surprisingly, there is still very little information about <a href="https://www.pubnub.com/">PubNub</a> in the Russian-speaking segment of the Internet ( <a href="https://habrahabr.ru/search/%3Fq%3Dpubnub">including</a> <a href="https://www.pubnub.com/">Habre as well)</a> .  Meanwhile, a Californian startup founded in 2010 managed to grow into what the company itself calls the Global Data Stream Network (DSN) over the past seven years, and in fact an IaaS solution designed to meet the needs of messaging in real life. of time.  Our company - Distillery - is currently one of the four <a href="https://www.pubnub.com/partners/development-partners/">development partners of PubNub</a> , but this is not said to be a blessing for the sake of, but to share with the community the use of PubNub using the example of a demo project that was required to create in order to receive this status. <br><br>  Those who can not wait to look at the code (C # + JavaScript) can immediately go to the <a href="https://github.com/DistilleryTech/Potalk">repository on GitHub</a> .  Those who are interested in what PubNub can do, and how it works, please under the cat. <br><a name="habracut"></a><br>  In general, PubNub offers three categories of services: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  <b>Realtime Messaging.</b>  An API that implements the Publish / Subscribe mechanism, followed by a ready-made global infrastructure, which includes 15 locations distributed across the globe with a stated latency of no more than 250 ms.  All this is flavored with such tasty things as, for example, support for high-loaded channels, data compression and automatic banding of messages with unstable communication. </li><li>  <b>Presence.</b>  API for tracking the status of clients - from the banal status of online / offline to custom things like notifications about the set of messages. </li><li>  <b>Functions.</b>  Previously, this function was called BLOCKS, but only recently survived the rebranding (or rather, it is still experiencing it).  It represents scripts written in JavaScript and spinning on PubNub servers, with the help of which you can filter, aggregate, transform data or, as we will soon see, interact with third-party services. </li></ul><br>  For all this, PubNub offers more than 70 SDKs for a wide variety of programming languages ‚Äã‚Äãand platforms, including IoT solutions based on Arduino, RaspberryPi and even Samsung Smart TV (the full list can be found <a href="https://www.pubnub.com/docs">here</a> ). <br><br>  Perhaps enough theory, let's move on to practice.  The test task, anticipating the receipt of partner status, is as follows: ‚ÄúCreate a project based on PubNub using any two SDKs and the following functions: Presence, PAM and one BLOCK‚Äù.  PAM stands for PubNub Access Manager and is an add-on to a security framework that allows you to control channel access at the application level, the channel itself, or a specific user.  Since the assignment is formulated rather vaguely, it provides enough will of fantasy, the flight of which eventually led to the not very useful, but very interesting idea of ‚Äã‚Äãthe talking chat.  And to make it more fun, the chat is not only voiced by a speech synthesizer, but also allows you to transmit verbal emotions. <br><br>  Actually, the application itself is conceptually very simple - this is a two-page website.  Initially, the user enters the login page, where there is no real authentication, and after entering the nickname and mode selection ‚Äî full or ReadOnly ‚Äî goes to the chat page.  It has a ‚Äúwindow‚Äù with channel messages, including the system a la ‚ÄúVasya joined the channel‚Äù, a field for typing messages and a drop-down list with a choice of emotions.  When new messages are received from other users, these messages are read out by a speech synthesizer with the emotion that the author set out when sending.  To translate text to speech, use the standard <a href="https://www.pubnub.com/docs/blocks-catalog/text-to-speech-converter">BLOCK from IBM Watson</a> , which requires minimal configuration, mainly related to the voice used.  At the time of this writing, only three voices supported the emotional speech: en-US_AllisonVoice (female), en-US_LisaVoice (female) and en-US_MichaelVoice (male).  A couple of months ago, only Allison was able to do it, so, as they say, progress is evident. <br><br>  However, we turn to the code.  The server part, and this is the beauty, balances somewhere on the edge between simplicity and primitiveness: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HomeController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Login</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(); } [HttpPost] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LoginDTO loginDTO</span></span></span><span class="hljs-function">)</span></span> { String chatChannel = ConfigurationHelper.ChatChannel; String textToSpeechChannel = ConfigurationHelper.TextToSpeechChannel; String authKey = loginDTO.Username + DateTime.Now.Ticks.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> chatManager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ChatManager(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (loginDTO.ReadAccessOnly) { chatManager.GrantUserReadAccessToChannel(authKey, chatChannel); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { chatManager.GrantUserReadWriteAccessToChannel(authKey, chatChannel); } chatManager.GrantUserReadWriteAccessToChannel(authKey, textToSpeechChannel); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> authDTO = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AuthDTO() { PublishKey = ConfigurationHelper.PubNubPublishKey, SubscribeKey = ConfigurationHelper.PubNubSubscribeKey, AuthKey = authKey, Username = loginDTO.Username, ChatChannel = chatChannel, TextToSpeechChannel = textToSpeechChannel }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(authDTO); } }</code> </pre> <br>  The controller's Main method gets the DTO from the login form, extracts the channel information from the configuration data (one channel for chat, the second for communicating with IBM Watson), sets the access level by calling the appropriate methods of the object of the ChatManager class and gives all the collected information to the page.  Next is the front end.  For completeness, we also give the listing of the ChatManager class, which encapsulates interaction with PubNub SDK: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ChatManager</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> String PRESENCE_CHANNEL_SUFFIX = <span class="hljs-string"><span class="hljs-string">"-pnpres"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Pubnub pubnub; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ChatManager</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pnConfiguration = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PNConfiguration(); pnConfiguration.PublishKey = ConfigurationHelper.PubNubPublishKey; pnConfiguration.SubscribeKey = ConfigurationHelper.PubNubSubscribeKey; pnConfiguration.SecretKey = ConfigurationHelper.PubNubSecretKey; pnConfiguration.Secure = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; pubnub = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pubnub(pnConfiguration); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ForbidPublicAccessToChannel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String channel</span></span></span><span class="hljs-function">)</span></span> { pubnub.Grant() .Channels(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[] { channel }) .Read(<span class="hljs-literal"><span class="hljs-literal">false</span></span>) .Write(<span class="hljs-literal"><span class="hljs-literal">false</span></span>) .Async(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AccessGrantResult()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GrantUserReadAccessToChannel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String userAuthKey, String channel</span></span></span><span class="hljs-function">)</span></span> { pubnub.Grant() .Channels(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[] { channel, channel + PRESENCE_CHANNEL_SUFFIX }) .AuthKeys(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[] { userAuthKey }) .Read(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) .Write(<span class="hljs-literal"><span class="hljs-literal">false</span></span>) .Async(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AccessGrantResult()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GrantUserReadWriteAccessToChannel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String userAuthKey, String channel</span></span></span><span class="hljs-function">)</span></span> { pubnub.Grant() .Channels(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[] { channel, channel + PRESENCE_CHANNEL_SUFFIX }) .AuthKeys(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[] { userAuthKey }) .Read(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) .Write(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) .Async(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AccessGrantResult()); } }</code> </pre><br>  It makes sense to focus on the constant PRESENCE_CHANNEL_SUFFIX.  The fact is that the Presence mechanism for its messages uses a separate channel, which, by agreement, recycles the name of the current channel with the addition of the suffix ‚Äú-pnpres‚Äù.  Note that the PubNub Access Manager code, expressed as a call to the Grant function, requires that you explicitly specify the Presence Channel to set access rights. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pubnub; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> chatChannel; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> textToSpeechChannel; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> username; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">publishKey, subscribeKey, authKey, username, chatChannel, textToSpeechChannel</span></span></span><span class="hljs-function">) </span></span>{ pubnub = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PubNub({ <span class="hljs-attr"><span class="hljs-attr">publishKey</span></span>: publishKey, <span class="hljs-attr"><span class="hljs-attr">subscribeKey</span></span>: subscribeKey, <span class="hljs-attr"><span class="hljs-attr">authKey</span></span>: authKey, <span class="hljs-attr"><span class="hljs-attr">uuid</span></span>: username }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.username = username; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.chatChannel = chatChannel; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.textToSpeechChannel = textToSpeechChannel; addListener(); subscribe(); }</code> </pre><br>  The first thing we have to do in the JavaScript code is to initialize the corresponding SDK.  For convenience and simplicity, some entities are in the global variables.  After initialization, you need to add a listener for events of interest to us and subscribe to the chat channels, Presence and IBM Watson.  Let's start with a subscription: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">subscribe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ pubnub.subscribe({ <span class="hljs-attr"><span class="hljs-attr">channels</span></span>: [chatChannel, textToSpeechChannel], <span class="hljs-attr"><span class="hljs-attr">withPresence</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }); }</code> </pre><br>  If the code of the subscribe method speaks for itself, then with the addListener method everything is a bit more complicated: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addListener</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ pubnub.addListener({ <span class="hljs-attr"><span class="hljs-attr">status</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">statusEvent</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (statusEvent.category === <span class="hljs-string"><span class="hljs-string">"PNConnectedCategory"</span></span>) { getOnlineUsers(); } }, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.channel === chatChannel) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> jsonMessage = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(message.message); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> chat = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"chat"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (chat.value !== <span class="hljs-string"><span class="hljs-string">""</span></span>) { chat.value = chat.value + <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; chat.scrollTop = chat.scrollHeight; } chat.value = chat.value + jsonMessage.Username + <span class="hljs-string"><span class="hljs-string">": "</span></span> + jsonMessage.Message; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.channel === textToSpeechChannel) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.publisher !== username) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> audio = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Audio(message.message.speech); audio.play(); } } }, <span class="hljs-attr"><span class="hljs-attr">presence</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">presenceEvent</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (presenceEvent.channel === chatChannel) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (presenceEvent.action === <span class="hljs-string"><span class="hljs-string">'join'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!UserIsOnTheList(presenceEvent.uuid)) { AddUserToList(presenceEvent.uuid); } PutStatusToChat(presenceEvent.uuid, <span class="hljs-string"><span class="hljs-string">"joins the channel"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (presenceEvent.action === <span class="hljs-string"><span class="hljs-string">'timeout'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (UserIsOnTheList(presenceEvent.uuid)) { RemoveUserFromList(presenceEvent.uuid); } PutStatusToChat(presenceEvent.uuid, <span class="hljs-string"><span class="hljs-string">"was disconnected due to timeout"</span></span>); } } } }); }</code> </pre><br>  First, we subscribe to the ‚ÄúPNConnectedCategory‚Äù event to catch the moment when the current user joins the channel.  This is important because the receipt and display of a list of all participants need to be called only once, while the Presence event of the ‚Äújoin‚Äù is triggered every time a new client is joined.  Secondly, when capturing a new message event, we check the channel to which this event is addressed, and depending on the result of the check, we either create a textual representation by means of a banal concatenation, or initialize the Audio object using the link to the audio file from IBM Watson and start playing . <br><br>  Another interesting thing happens when sending a message: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> jsonMessage = { <span class="hljs-string"><span class="hljs-string">"Username"</span></span>: username, <span class="hljs-string"><span class="hljs-string">"Message"</span></span>: message }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> publishConfig = { <span class="hljs-attr"><span class="hljs-attr">channel</span></span>: chatChannel, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(jsonMessage) }; pubnub.publish(publishConfig); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> emotedText = <span class="hljs-string"><span class="hljs-string">'&lt;speak&gt;'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> selectedEmotion = iconSelect.getSelectedValue(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (selectedEmotion !== <span class="hljs-string"><span class="hljs-string">""</span></span>) { emotedText += <span class="hljs-string"><span class="hljs-string">'&lt;express-as type="'</span></span> + selectedEmotion + <span class="hljs-string"><span class="hljs-string">'"&gt;'</span></span>; } emotedText += message; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (selectedEmotion !== <span class="hljs-string"><span class="hljs-string">""</span></span>) { emotedText += <span class="hljs-string"><span class="hljs-string">'&lt;/express-as&gt;'</span></span>; } emotedText += <span class="hljs-string"><span class="hljs-string">'&lt;/speak&gt;'</span></span>; jsonMessage = { <span class="hljs-string"><span class="hljs-string">"text"</span></span>: emotedText }; publishConfig = { <span class="hljs-attr"><span class="hljs-attr">channel</span></span>: textToSpeechChannel, <span class="hljs-attr"><span class="hljs-attr">message</span></span>: jsonMessage }; pubnub.publish(publishConfig); }</code> </pre><br>  First we form the message itself, then we define the configuration that the SDK understands, and only after that we initiate the sending.  Further better.  To turn the text into synthesized speech, we send another message to the IBM Watson channel.  <a href="https://en.wikipedia.org/wiki/Speech_Synthesis_Markup_Language">Speech Synthesis Markup Language</a> (SSML) is used to define emotional coloring, and more specifically, the &lt;express-as&gt; tag.  As you probably already guess, when sending a message to a ReadOnly user, it will be blocked by the PAM mechanism and will never find its recipient. <br><br>  Among the products already on the market that use PubNub's capabilities are, say, the concept of <a href="http://www.insteon.com/">Insteon's</a> smart home or a mobile application for planning family events from <a href="https://www.curagoapp.com/">Curago</a> .  In conclusion, let me remind you once again that the full code of the example can be found on <a href="https://github.com/DistilleryTech/Potalk">GitHub</a> . </div><p>Source: <a href="https://habr.com/ru/post/338720/">https://habr.com/ru/post/338720/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338710/index.html">Energy efficient data center: familiarity with international experience</a></li>
<li><a href="../338712/index.html">Kali Linux: system protection and monitoring exercises</a></li>
<li><a href="../338714/index.html">How to get to ITMO University Technopark</a></li>
<li><a href="../338716/index.html">As we celebrated 256 day of the year and drew pixels through the API</a></li>
<li><a href="../338718/index.html">Understanding the new sync.Map in Go 1.9</a></li>
<li><a href="../338722/index.html">The second version of the Air Quality Monitor</a></li>
<li><a href="../338724/index.html">How to build a self-managed business: formulating the ‚Äúlaws of robotics‚Äù Hamster Marketplace</a></li>
<li><a href="../338730/index.html">IT events digest for October</a></li>
<li><a href="../338732/index.html">Performance: what's in my name? - Alexey Shipilev about optimization in large projects</a></li>
<li><a href="../338734/index.html">Dump memory and write maphack</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>