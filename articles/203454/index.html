<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>An example of the implementation of call history for IP-PBX 3CX Phone System</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We suggest you look at an example of the implementation of call history when using IP-PBX 3CX Phone System v.12, namely: the date and time of the call...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>An example of the implementation of call history for IP-PBX 3CX Phone System</h1><div class="post__text post__text-html js-mediator-article">  We suggest you look at an example of the implementation of call history when using IP-PBX 3CX Phone System v.12, namely: the date and time of the call;  duration;  incoming number;  outgoing number;  event of forwarding to another number;  event of forwarding from another number, link to audio recording file;  the ability to listen to the recording.  Integration is possible in any 1C configuration with minimal changes to the original configuration. <br><img src="https://habrastorage.org/getpro/habr/post_images/a11/5d1/169/a115d116983b18613f16752505928c3d.png" alt="image"><br><br><br>  In version 12 SIP PBX 3CX, a new client appeared - 3CX MyPhone.  The functionality of the client is impressive - the state of the phones, the phone book, view call history with the ability to listen to records and much more.  However, the possibilities of integration with other systems are rather limited.  The 3CX API interface, as in previous versions, works only on the same machine where the 3CX system is installed, and is rather complicated for programming.  In addition to the API, 3CX Phone System has another great CallHistory interface that keeps track of your calls after death.  We successfully used this interface for several years in conjunction with Manageengine ServiceDesk Plus within our company, thanks to which we were able to significantly increase the efficiency of our ‚Äúoutsourcing‚Äù work. <br><a name="habracut"></a><br>  Since  we have a sharp question about the internal implementation of the open source service desk system and our main business is 1C, then the products of the companies Rarus and Desnol-Soft were considered as new software.  The choice fell on Itilium from Desnol-Soft. <br>  But the introduction of Itilium without a bunch of telephony for us does not make sense.  Therefore, the first stage we set ourselves the task of storing the call history in 1C, namely: the date and time of the call;  duration;  incoming number;  outgoing number;  event of forwarding to another number;  event of forwarding from another number, link to audio recording file;  the ability to listen to the recording. <br>  So we have: 3CX Phone System v.12 installed and configured;  installed and published on the web server Itilium DB.  Let's turn to implementation. <br><br>  1. Making additional 3CX CallHistory settings for our purposes.  We will need the% 3CXData% \ Data \ CDRTemplates \ CDRTemplate-SocketListen.xml file (For Windows Server 2008, this is C: \ ProgramData \ 3CX \ Data \ CDRTemplates \ CDRTemplate-SocketListen.xml). <br>  In line <br>  CallTemplate Host = "127.0.0.1" Port = "33555" OutboundOnly = "false" <br>  change the Host parameter to the external IP address of the machine on which the 3CX system is running, for example 192.168.11.2.  Restart the 3CX CallHistory service and check the service operation by the command <br>  telnet [ip server address 3CX] 35555 <br>  After the completion of any call, information on this call should appear in the telnet window.  The data format depends on the contents of the CDRTemplate-SocketListen.xml file.  In principle, you can use the default format, but given the fact that we have to parse this data, we can simplify our future life.  For example, so <br><img title="CDRTemplate-SocketListen.xml" src="https://habrastorage.org/getpro/habr/post_images/841/fc4/19d/841fc419dd56b5dc093cb92adb805706.png" alt="CDRTemplate-SocketListen.xml" width="800" height="600"><br>  Such a message format will further greatly simplify the work. <br>  Do not forget after editing the CDRTemplate-SocketListen.xml restart the 3CXCallHistory service.  And another very important note - keep a copy of this file in a different place or rename it and set in 3CX the value of the CALLHISTTEMPLSOCKLISTEN parameter equal to the name of your file (Settings - Advanced settings - User parameters tab), since  when installing service packs for 3CX, files in the CDRTemplates directory are overwritten with default files.  So, on the 3CX side, for now, everything ... <br>  2. In the 1C system, create a data register TF_Zvonkov History: <br><img title="Register information TF_Zvorkov History" src="https://habrastorage.org/getpro/habr/post_images/ebc/b60/175/ebcb601750e7113f61c7b9522061424f.png" alt="  _" width="290" height="326"><br>  Then we create the CallHistory web service.  In it we create the SaveHistory (Record) method which will receive a line from item 1 at the input, parse it and create entries in the information register TF_History of Calls.  We avoid the names of services, methods and parameters of Russian names. <br><img title="CallHistory Web Service" src="https://habrastorage.org/getpro/habr/post_images/e0f/f63/f69/e0ff63f6937274bf275f62d91be54eeb.png" alt="Web- CallHistory" width="249" height="71"><br>  3. Draw the implementation of the SaveHistory method (hi-res: <a href="">habr.habrastorage.org/post_images/d4a/f4c/d4f/d4af4cd4f675daf692c5160fb396ef6b.png</a> ) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img title="SaveHistory method" src="http://infostart.ru/upload/iblock/4bb/4.png" alt=" SaveHistory" width="1321" height="692"><br><br>  As you can see, the correction of the message format makes it possible to simplify parsing.  Additional functions are needed, since the 1C and C # date and time formats are different: <br><img title="Additional functions" src="https://habrastorage.org/getpro/habr/post_images/e86/7be/b57/e867beb5754b7b7618b0fad44f019e1b.png" alt=" " width="613" height="388"><br>  The main function converts a string of the form [key] = [value]; [key] = [value] into the appropriate structure: <br><img title="Main function" src="https://habrastorage.org/getpro/habr/post_images/da7/bc5/1df/da7bc51dff30df75059124698a065ede.png" alt=" " width="480" height="628"><br>  Another note on the storage of audio recordings.  They can be stored in the database, but the size of the base grows by leaps and bounds.  Therefore, it is better to store files as links to a network resource.  Forming the correct links performs a very simple function (in the comments only the appearance of the record): <br><img title="Audio storage" src="https://habrastorage.org/getpro/habr/post_images/7ad/bd5/308/7adbd53082feecd5df3d6f7580c2646d.png" alt=" " width="773" height="163"><br>  With the web service for now.  Now let's tie it all together.  For bundles use C # Visual Studio 2012, although you can use any other tool that you own. <br>  Our C # program should connect to the port of the 3CXCallHistory service and transfer everything that was received to the 1C service.  The whole binding is aimed at automatically restarting if the connection is broken or the Web service is unavailable.  The program (in the near future we will publish it) can be launched from the command line, then it will issue diagnostics to the console.  You can install it as a service, and if you call the service 3CX_CDRClient1C, then it will be visible in the 3CX Phone System management console. <br>  Now the nuances. <br>  1. Authorization. <br>  The first option is no users in the database.  Web service is available.  But we are not looking for easy ways, especially since a combat base without users is nonsense. <br>  The second option is to launch a web server from an IUSR_IIS7 OS user, for example, plus setting up IUSR_IIS7 in 1C with OS authorization and ROLY rights to launch a web service.  At first glance, it works, but ... When you start a web client, we get not a joint, but a CANT !!!  The screenshot was not taken, but the laziness is to return the settings, so who cares - check who is lazy - believe me. <br><img title="Authorization" src="https://habrastorage.org/getpro/habr/post_images/7c1/e4f/79d/7c1e4f79d9fe1c382b4c95d37d2b1dc5.png" alt="" width="475" height="402"><br>  So, when you start the web client, the 1C authorization window does not appear, and the user IUSR_IIS7 writes in the red box in the screenshot.  In addition, in the Session Options. Current User is empty and this results in the error "Attempt to access an uninitialized session parameter".  So by no means authorization. <br>  The third option is <a href="https://habr.com/redirect.php%3Furl%3DaHR0cDovL3d3dy5mb3J1bS5taXN0YS5ydS90b3BpYy5waHA/aWQ9NjYxMTEw">http://www.forum.mista.ru/topic.php?id=661110</a> (for which a huge ‚ÄúThank you‚Äù!).  Using 3 options led to additional lines in the C # app.config project. <br><img title="Thanks to a famous resource." src="https://habrastorage.org/getpro/habr/post_images/d04/dfe/c6b/d04dfec6b6b66035c79d35c63046c226.png" alt="  " width="665" height="480"><br>  If anyone knows how to read - we will be happy to receive information. <br>  The result is this: <br><img title="Result 1" src="https://habrastorage.org/getpro/habr/post_images/660/8f6/da2/6608f6da2e2e3305b8015cf86266ad12.png" alt="CX + 1C  1" width="1127" height="516"><br><img src="https://habrastorage.org/getpro/habr/post_images/42b/857/31c/42b85731c38b9356cdff777571223037.png" alt="3CX + 1C result 2" width="584" height="282"><br>  The file name is a link.  When pressed, the player opens: <br><img src="https://habrastorage.org/getpro/habr/post_images/533/0de/bee/5330debee1a4a9479f0c583673609858.png" alt="3CX + 1C result 3" width="605" height="318"><br>  Integration is possible in any 1C configuration with minimal changes to the original configuration. <br><br>  Source: <a href="http://infostart.ru/public/237772/">infostart.ru/public/237772</a> </div><p>Source: <a href="https://habr.com/ru/post/203454/">https://habr.com/ru/post/203454/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../203444/index.html">Isomorphic JavaScript - the future of web applications</a></li>
<li><a href="../203446/index.html">UrtheCast starts!</a></li>
<li><a href="../203448/index.html">LinkMeUp. Release 9. Intelligent Network Control Systems and the NOC project</a></li>
<li><a href="../203450/index.html">Microsoft Xbox One Complete Parsing</a></li>
<li><a href="../203452/index.html">Softphone 3CXPhone for Mac OS released</a></li>
<li><a href="../203456/index.html">Am I a programmer?</a></li>
<li><a href="../203460/index.html">Plasma Crystal Experiment and Science on the ISS</a></li>
<li><a href="../203462/index.html">HTML5 Canvas Scheme of the suburban movement of the railway communication of Moscow and Moscow Region</a></li>
<li><a href="../203466/index.html">About private "clouds": what and how is usually done in Russia, educational program and the main problems</a></li>
<li><a href="../203470/index.html">Neurozagadka</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>