<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work with events in Laravel. Sending push notifications when publishing an article</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the comments to one of the first articles in my blog, the reader advised me to fasten push notifications through the Onesignal service. At that mom...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work with events in Laravel. Sending push notifications when publishing an article</h1><div class="post__text post__text-html js-mediator-article">  In the comments to one of the first articles in my blog, the reader advised me to fasten push notifications through the Onesignal service. At that moment I had no idea what kind of animal it was and what it was eating with.  Of course, I knew about the notifications themselves, but not about the service. <br>  It was easy to google it and it turned out that this is a service that allows you to send push notifications of absolutely different kinds, across all platforms and devices.  It has a convenient control panel / reporting, the possibility of deferred sending and so on. <br>  I will not dwell on setting up the service itself.  There are his Russian counterparts, links, if necessary, are easily located.  Yes, and it's no longer about the service itself, but about the correct application architecture on Laravel. <br><img src="http://laravel-news.ru/attach/d9/5e/56e4357ec3c65.jpg"><a name="habracut"></a><br><h2>  Integration </h2><br>  Work with the service is divided into 2 parts: subscription of users and sending notifications.  Therefore, the integration consists of two parts: <br>  1) Client part: we place javascript <br>  2) Server side: we are lazy people, so it‚Äôs not our method to go to the Onesignal admin area and post messages every time to send it manually.  We would trust this business to smart machines!  And, lo and behold!  For this, onesignal has a JSON API. <br><h2>  Client part </h2><br>  Also I will not describe in detail, as everything is described on the service website.  Let me just say that there are 2 ways.  Simple: stupidly place them Javascript, which generates a button for a subscription.  And more long: to impose a button with handles, on a click to call their URL. <br>  As you may have guessed, I chose a simple way) <br>  Below is the code for placement on the page, because  I did not find a method for simple localization of all this near-button interface, I redefined all JS messages, since their library allows it.  If someone needs Russian localization, you can take my already translated code. <br><pre><code class="hljs erlang-repl">&lt;script src=<span class="hljs-string"><span class="hljs-string">"https://cdn.onesignal.com/sdks/OneSignalSDK.js"</span></span> async&gt;&lt;/script&gt; &lt;script&gt; var OneSignal = OneSignal || []; OneSignal.push([<span class="hljs-string"><span class="hljs-string">"init"</span></span>, { appId: <span class="hljs-string"><span class="hljs-string">" id "</span></span>, subdomainName: <span class="hljs-string"><span class="hljs-string">'laravel-news'</span></span>, //   onesignal.com (   ) notifyButton: { enable: true, // Set to false to hide, size: <span class="hljs-string"><span class="hljs-string">'large'</span></span>, // One of <span class="hljs-string"><span class="hljs-string">'small'</span></span>, <span class="hljs-string"><span class="hljs-string">'medium'</span></span>, or <span class="hljs-string"><span class="hljs-string">'large'</span></span> theme: <span class="hljs-string"><span class="hljs-string">'default'</span></span>, // One of <span class="hljs-string"><span class="hljs-string">'default'</span></span> (red-white) or <span class="hljs-string"><span class="hljs-string">'inverse" (whi-te-red) position: '</span></span>bottom-right', // Either <span class="hljs-string"><span class="hljs-string">'bottom-left'</span></span> or <span class="hljs-string"><span class="hljs-string">'bottom-right'</span></span> offset: { offset: { bottom: <span class="hljs-string"><span class="hljs-string">'90px'</span></span>, left: <span class="hljs-string"><span class="hljs-string">'0px'</span></span>, // Only applied if bottom-left right: <span class="hljs-string"><span class="hljs-string">'80px'</span></span> // Only applied if bottom-right }, text: { <span class="hljs-string"><span class="hljs-string">"tip.state.unsubscribed"</span></span>: <span class="hljs-string"><span class="hljs-string">"       "</span></span>, <span class="hljs-string"><span class="hljs-string">"tip.state.subscribed"</span></span>: <span class="hljs-string"><span class="hljs-string">"   "</span></span>, <span class="hljs-string"><span class="hljs-string">"tip.state.blocked"</span></span>: <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-string"><span class="hljs-string">"message.prenotify"</span></span>: <span class="hljs-string"><span class="hljs-string">"       "</span></span>, <span class="hljs-string"><span class="hljs-string">"message.action.subscribed"</span></span>: <span class="hljs-string"><span class="hljs-string">"  !"</span></span>, <span class="hljs-string"><span class="hljs-string">"message.action.resubscribed"</span></span>: <span class="hljs-string"><span class="hljs-string">"   "</span></span>, <span class="hljs-string"><span class="hljs-string">"message.action.unsubscribed"</span></span>: <span class="hljs-string"><span class="hljs-string">",          "</span></span>, <span class="hljs-string"><span class="hljs-string">"dialog.main.title"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">"dialog.main.button.subscribe"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"dialog.main.button.unsubscribe"</span></span>: <span class="hljs-string"><span class="hljs-string">"   "</span></span>, <span class="hljs-string"><span class="hljs-string">"dialog.blocked.title"</span></span>: <span class="hljs-string"><span class="hljs-string">"      "</span></span>, <span class="hljs-string"><span class="hljs-string">"dialog.blocked.message"</span></span>: <span class="hljs-string"><span class="hljs-string">"  ,   :"</span></span> } }, prenotify: true, // Show an icon with <span class="hljs-number"><span class="hljs-number">1</span></span> unread message for first-time site visitors showCredit: false, // Hide the OneSignal logo welcomeNotification: { <span class="hljs-string"><span class="hljs-string">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">" Laravel"</span></span>, <span class="hljs-string"><span class="hljs-string">"message"</span></span>: <span class="hljs-string"><span class="hljs-string">"  !"</span></span> }, promptOptions: { showCredit: false, // Hide Powered by OneSignal actionMessage: <span class="hljs-string"><span class="hljs-string">"   :"</span></span>, exampleNotificationTitleDesktop: <span class="hljs-string"><span class="hljs-string">"   "</span></span>, exampleNotificationMessageDesktop: <span class="hljs-string"><span class="hljs-string">"     "</span></span>, exampleNotificationTitleMobile: <span class="hljs-string"><span class="hljs-string">"  "</span></span>, exampleNotificationMessageMobile: <span class="hljs-string"><span class="hljs-string">"     "</span></span>, exampleNotificationCaption: <span class="hljs-string"><span class="hljs-string">"(    )"</span></span>, acceptButtonText: <span class="hljs-string"><span class="hljs-string">""</span></span>.toUpperCase(), cancelButtonText: <span class="hljs-string"><span class="hljs-string">", "</span></span>.toUpperCase() } }]); &lt;/script&gt;</code> </pre> <br>  This completes the client side configuration. <br><h2>  Server part  Architecture. </h2><br>  Getting to the most interesting. <br>  <strong>Task: when placing a post (article) send push notifications.</strong> <br>  But, at the same time, we keep in mind that soon when publishing an article, we will need to perform 100% more than one action.  For example, send text to the ‚ÄúOriginal Texts‚Äù of a Yandex webmaster, tweet on Twitter and so on. <br>  Therefore, it is necessary to organize this whole process in some way, rather than shove everything into a model or, upasiboh, controller. <br><img src="http://laravel-news.ru/attach/1a/7b/56e41328548fe.jpg"><br>  Let's argue.  The publication of the article itself is what?  That's right - an <strong>event</strong> !  So let's use <a href="https://laravel.com/docs/5.2/events"><strong>events</strong></a> .  Their implementation in the chest is very good. <br><blockquote>  Of course, there was a spoiler in the title about the events, so everyone guessed right away) </blockquote><br>  According to the <a href="https://laravel.com/docs/5.2/events">documentation,</a> there are several ways to register events and create classes themselves.  Let's stop on the most convenient variant. <br><h2>  Write the code </h2><br>  We will do this: in app / Providers / EventServiceProvider.php we indicate our event and its listener.  The event is called PostPublishedEEvent, the listener is PostActionsListener. <br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $listen = [ <span class="hljs-string"><span class="hljs-string">'App\Events\PostPublishedEvent'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'App\Listeners\PostActionsListener'</span></span>, ], ];</code> </pre> <br>  Then go to the console and run the command <br><pre> <code class="hljs cs">php artisan <span class="hljs-keyword"><span class="hljs-keyword">event</span></span>:generate</code> </pre> <br>  The command will create classes for the app / Events / PostPublishedEvent.php event and its listener app / Listeners / PostActionsListener.php <br>  First we edit the event class, we will transfer a copy of our blog post to it. <br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $post; <span class="hljs-comment"><span class="hljs-comment">/** * PostPublishedEvent constructor. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Post $post */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Post $post)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;post = $post; }</code> </pre> <br>  Hereinafter, the code does not forget to connect classes. <br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> App\Models\Post;</code> </pre> <br>  Now go to the app / Listeners / PostActionsListener.php listener. <br>  I called him that way for a reason! <br>  In order not to produce listeners for each type of event (I think there will not be many of them), I decided to start one. <br>  We will decide what exactly to execute on the basis of which instance of the event came. <br>  Like that <br><pre> <code class="hljs php"><span class="hljs-comment"><span class="hljs-comment">/** * Handle the event. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Event $event * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Event $event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($event <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> PostPublishedEvent) { <span class="hljs-comment"><span class="hljs-comment">//   } }</span></span></code> </pre> <br>  Now it remains to somehow make our PostPublishedEvent event happen.  I suggest while doing this while saving the model. <br>  In our case, the article may have 2 statuses (status field) <em>Draft / Published</em> . <br>  Statuses I usually do class constants.  In this case, they look like this: <br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> STATUS_DRAFT = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> STATUS_PUBLISHED = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br>  When you change the status to "Published" and you need to send notifications. <br>  In order to make sure that this process will occur once, we will add an additional column, the flag that the notification on this post has been sent. <br>  Add an additional field notify_status, its values ‚Äã‚Äãcan be the same as for status. <br>  Run in console: <br><pre> <code class="hljs pgsql">php artisan make:migration add_noty_status_to_post_table <span class="hljs-comment"><span class="hljs-comment">--table=post</span></span></code> </pre> <br>  The created migration will be edited in the following way: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">function</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">up</span></span>() { <span class="hljs-attribute"><span class="hljs-attribute">Schema</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>(<span class="hljs-string"><span class="hljs-string">'post'</span></span>, function (Blueprint $table) { $table-&gt;<span class="hljs-built_in"><span class="hljs-built_in">tinyInteger</span></span>(<span class="hljs-string"><span class="hljs-string">'notify_status'</span></span>)<span class="hljs-built_in"><span class="hljs-built_in">-</span></span>&gt;<span class="hljs-built_in"><span class="hljs-built_in">default</span></span>(0); }); }</code> </pre> <br>  Perform in <code>php artisan migrate</code> console <code>php artisan migrate</code> <br><h2>  Event call </h2><br>  Now everything is ready to trigger the event itself. <br>  To catch the process of saving the model in Laravel there are specially trained <em>(again)</em> <a href="https://laravel.com/docs/5.2/eloquent">events</a> . <br>  Let's get a static boot method in the Post model And add a listener to it on the save event, explained in the comments: <br><pre> <code class="hljs ruby">public static function boot() { static::saving(function($instance) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    ‚Äì   ¬´¬ª,    ,     ¬´¬ª <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($instance-&gt;status == self::STATUS_PUBLISHED &amp;&amp; $instance-&gt;notify_status &lt; self::STATUS_PUBLISHED){ <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     ¬´¬ª $instance-&gt;notify_status = self::STATUS_PUBLISHED; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ¬´¬ª  PostPublishedEvent,     . \Event::fire(new PostPublishedEvent($instance)); }); parent::boot(); }</code> </pre> <br><h2>  Tests </h2><br>  It's time to write the first test! <br>  We need to test: firstly, that the necessary event occurs under the right conditions, and secondly, that the event does not occur when it is not necessary (status = draft for example) <br>  If you read the article <a href="http://laravel-news.ru/blog/tutorials/first-laravel-application-1">The First App on Laravel.</a>  <a href="http://laravel-news.ru/blog/tutorials/first-laravel-application-1">Walkthrough (Part 1)</a> <br>  You already know about model factories, and how they are useful for testing.  Create your own factory for the Post model <br>  file database / factories / PostFactory.php: <br><pre> <code class="hljs php">$factory-&gt;define(App\Models\Post::class, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Faker\Generator $faker)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'title'</span></span> =&gt; $faker-&gt;text(<span class="hljs-number"><span class="hljs-number">100</span></span>), <span class="hljs-string"><span class="hljs-string">'publish_date'</span></span> =&gt; date(<span class="hljs-string"><span class="hljs-string">'Ymd H:i'</span></span>), <span class="hljs-string"><span class="hljs-string">'short_text'</span></span> =&gt; $faker-&gt;text(<span class="hljs-number"><span class="hljs-number">300</span></span>), <span class="hljs-string"><span class="hljs-string">'full_text'</span></span> =&gt; $faker-&gt;realText(<span class="hljs-number"><span class="hljs-number">1000</span></span>), <span class="hljs-string"><span class="hljs-string">'slug'</span></span> =&gt; str_random(<span class="hljs-number"><span class="hljs-number">50</span></span>), <span class="hljs-string"><span class="hljs-string">'status'</span></span> =&gt; \App\Models\Post::STATUS_PUBLISHED, <span class="hljs-string"><span class="hljs-string">'category_id'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> ]; });</code> </pre> <br>  And the tests / PostCreateTest.php test itself with one method so far: <br><pre> <code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostCreateTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestCase</span></span></span><span class="hljs-class"> </span></span>{ public function testPublishEvent() { <span class="hljs-comment"><span class="hljs-comment">//,    \App\Events\PostPublishedEvent $this -&gt; expectsEvents(\App\Events\PostPublishedEvent::class); //       $post = factory(App\Models\Post::class)-&gt;create(); //      $this -&gt; seeInDatabase('post', ['title' =&gt; $post-&gt;title]); //  $post -&gt; delete(); } }</span></span></code> </pre> <br><blockquote>  Please note: when testing events, the events themselves do not occur.  Only the fact of their occurrence or non-occurrence is recorded. </blockquote><br>  Run phpunit.  Everything should be fine <code>OK (1 test, 1 assertion)</code> <br>  Now we add a reverse check that the event does not occur, for example, on drafts: <br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> function testNoPublishEvent() { $<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;doesntExpectEvents(\App\Events\PostPublishedEvent::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">); //     ‚Äì  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class">. $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">post</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">factory</span></span></span></span>(App\Models\Post::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">)-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span></span>( [ <span class="hljs-string"><span class="hljs-string">'status'</span></span> =&gt; App\Models\Post::STATUS_DRAFT ]); $<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;seeInDatabase(<span class="hljs-string"><span class="hljs-string">'post'</span></span>, [<span class="hljs-string"><span class="hljs-string">'title'</span></span> =&gt; $post-&gt;title]); $post-&gt;delete(); }</code> </pre> <br>  Run phpunit: <code>OK (2 tests, 2 assertions)</code> <br><h2>  Handling events, sending push notifications </h2><br>  Only trifles remained, just to handle the event and send push notifications through onesignal.com. <br>  Go to the service website and smoke the <a href="https://documentation.onesignal.com/docs/server-api-overview">REST API</a> manual. <br>  We are interested in the <a href="https://documentation.onesignal.com/v2.0/docs/notifications-create-notification">procedure for sending a message</a> . <br>  All parameters are described in detail, sample code is. <br><img src="http://laravel-news.ru/attach/6e/50/56e4185aafef1.jpg"><br>  Instead of using curl_ * functions, I‚Äôll <a href="https://github.com/anlutro/php-curl">install the anlutro / curl</a> package wrapper I‚Äôm familiar with. <br>  In the <code>composer require anlutro/curl</code> console, <code>composer require anlutro/curl</code> <br>  All the sending procedure will be issued as a separate handler app / Handlers / OneSignalHandler.php: Here is his code completely.  In the comments I will describe what's what <br><pre> <code class="hljs bash">&lt;?php namespace App\Handlers; use anlutro\cURL\cURL; use App\Models\Post; class OneSignalHandler { //   private <span class="hljs-variable"><span class="hljs-variable">$test</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; //    <span class="hljs-string"><span class="hljs-string">" "</span></span> public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> __construct(<span class="hljs-variable"><span class="hljs-variable">$test</span></span>=<span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;<span class="hljs-built_in"><span class="hljs-built_in">test</span></span> = <span class="hljs-variable"><span class="hljs-variable">$test</span></span>; } // sendNotify     . public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> sendNotify(Post <span class="hljs-variable"><span class="hljs-variable">$post</span></span>) { //   <span class="hljs-variable"><span class="hljs-variable">$config</span></span> = \Config::get(<span class="hljs-string"><span class="hljs-string">'onesignal'</span></span>); // app_id  ,   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!empty(<span class="hljs-variable"><span class="hljs-variable">$config</span></span>[<span class="hljs-string"><span class="hljs-string">'app_id'</span></span>])) { //C    <span class="hljs-variable"><span class="hljs-variable">$data</span></span> = array( <span class="hljs-string"><span class="hljs-string">'app_id'</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$config</span></span>[<span class="hljs-string"><span class="hljs-string">'app_id'</span></span>], <span class="hljs-string"><span class="hljs-string">'contents'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">"en"</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$post</span></span>-&gt;short_text ], <span class="hljs-string"><span class="hljs-string">'headings'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">"en"</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$post</span></span>-&gt;title ], //(   WebPush ) <span class="hljs-string"><span class="hljs-string">'isAnyWeb'</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">'chrome_web_icon'</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$config</span></span>[<span class="hljs-string"><span class="hljs-string">'icon_url'</span></span>], <span class="hljs-string"><span class="hljs-string">'firefox_icon'</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$config</span></span>[<span class="hljs-string"><span class="hljs-string">'icon_url'</span></span>], <span class="hljs-string"><span class="hljs-string">'url'</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$post</span></span>-&gt;link ); //  <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> == <span class="hljs-literal"><span class="hljs-literal">true</span></span>       , <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$data</span></span>[<span class="hljs-string"><span class="hljs-string">'include_player_ids'</span></span>] = [<span class="hljs-variable"><span class="hljs-variable">$config</span></span>[<span class="hljs-string"><span class="hljs-string">'own_player_id'</span></span>]]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { //  -  . <span class="hljs-variable"><span class="hljs-variable">$data</span></span>[<span class="hljs-string"><span class="hljs-string">'included_segments'</span></span>] = [<span class="hljs-string"><span class="hljs-string">"All"</span></span>]; } //  !  ! <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strtotime(<span class="hljs-variable"><span class="hljs-variable">$post</span></span>-&gt;publish_date) &gt; time()) { <span class="hljs-variable"><span class="hljs-variable">$data</span></span>[<span class="hljs-string"><span class="hljs-string">'send_after'</span></span>] = date(DATE_RFC2822, strtotime(<span class="hljs-variable"><span class="hljs-variable">$post</span></span>-&gt;publish_date)); <span class="hljs-variable"><span class="hljs-variable">$data</span></span>[<span class="hljs-string"><span class="hljs-string">'delayed_option'</span></span>] = <span class="hljs-string"><span class="hljs-string">'timezone'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$data</span></span>[<span class="hljs-string"><span class="hljs-string">'delivery_time_of_day'</span></span>] = <span class="hljs-string"><span class="hljs-string">'10:00AM'</span></span>; } <span class="hljs-variable"><span class="hljs-variable">$curl</span></span> = new cURL(); <span class="hljs-variable"><span class="hljs-variable">$req</span></span> = <span class="hljs-variable"><span class="hljs-variable">$curl</span></span>-&gt;newJsonRequest(<span class="hljs-string"><span class="hljs-string">'post'</span></span>,<span class="hljs-variable"><span class="hljs-variable">$config</span></span>[<span class="hljs-string"><span class="hljs-string">'url'</span></span>], <span class="hljs-variable"><span class="hljs-variable">$data</span></span>)-&gt;setHeader(<span class="hljs-string"><span class="hljs-string">'Authorization'</span></span>, <span class="hljs-string"><span class="hljs-string">'Basic '</span></span>.<span class="hljs-variable"><span class="hljs-variable">$config</span></span>[<span class="hljs-string"><span class="hljs-string">'api_key'</span></span>]); <span class="hljs-variable"><span class="hljs-variable">$result</span></span> = <span class="hljs-variable"><span class="hljs-variable">$req</span></span>-&gt;send(); //  ,    . <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$result</span></span>-&gt;statusCode &lt;&gt; 200) { \Log::error(<span class="hljs-string"><span class="hljs-string">'Unable to push to Onesignal'</span></span>, [<span class="hljs-string"><span class="hljs-string">'error'</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$result</span></span>-&gt;body]); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-variable"><span class="hljs-variable">$result</span></span> = json_decode(<span class="hljs-variable"><span class="hljs-variable">$result</span></span>-&gt;body); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$result</span></span>-&gt;id) { //   -  - . <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$result</span></span>-&gt;recipients; } } } }</code> </pre><br><h3>  Settings </h3><br>  To store the settings for onesignal I created a config <br>  config / onesignal.php <br><pre> <code class="hljs xml"><span class="php"><span class="hljs-meta"><span class="php"><span class="hljs-meta">&lt;?php</span></span></span><span class="php"> </span><span class="hljs-keyword"><span class="php"><span class="hljs-keyword">return</span></span></span><span class="php"> [ </span><span class="hljs-string"><span class="php"><span class="hljs-string">'app_id'</span></span></span><span class="php"> =&gt; env(</span><span class="hljs-string"><span class="php"><span class="hljs-string">'ONESIGNAL_APP_ID'</span></span></span><span class="php">,</span><span class="hljs-string"><span class="php"><span class="hljs-string">''</span></span></span><span class="php">), </span><span class="hljs-string"><span class="php"><span class="hljs-string">'api_key'</span></span></span><span class="php"> =&gt; env(</span><span class="hljs-string"><span class="php"><span class="hljs-string">'ONESIGNAL_API_KEY'</span></span></span><span class="php">,</span><span class="hljs-string"><span class="php"><span class="hljs-string">''</span></span></span><span class="php">), </span><span class="hljs-string"><span class="php"><span class="hljs-string">'url'</span></span></span><span class="php"> =&gt; env(</span><span class="hljs-string"><span class="php"><span class="hljs-string">'ONESIGNAL_URL'</span></span></span><span class="php">,</span><span class="hljs-string"><span class="php"><span class="hljs-string">'https://onesignal.com/api/v1/notifications'</span></span></span><span class="php">), </span><span class="hljs-string"><span class="php"><span class="hljs-string">'icon_url'</span></span></span><span class="php"> =&gt; env(</span><span class="hljs-string"><span class="php"><span class="hljs-string">'ONESIGNAL_ICON_URL'</span></span></span><span class="php">,</span><span class="hljs-string"><span class="php"><span class="hljs-string">''</span></span></span><span class="php">), </span><span class="hljs-string"><span class="php"><span class="hljs-string">'own_player_id'</span></span></span><span class="php"> =&gt; env(</span><span class="hljs-string"><span class="php"><span class="hljs-string">'ONESIGNAL_OWN_PLAYER_ID'</span></span></span><span class="php">,</span><span class="hljs-string"><span class="php"><span class="hljs-string">''</span></span></span><span class="php">) ];</span></span></code> </pre> <br>  The settings themselves in .env <br><pre> <code class="hljs ruby">ONESIGNAL_APP_ID = <span class="hljs-number"><span class="hljs-number">256</span></span>aa8d2‚Ä¶. ONESIGNAL_API_KEY = YWR‚Ä¶.. ONESIGNAL_ICON_URL = <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/laravel-news.ru/images</span></span><span class="hljs-regexp"><span class="hljs-regexp">/laravel_logo_80.jpg ONESIGNAL_URL = https:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/onesignal.com/api</span></span><span class="hljs-regexp"><span class="hljs-regexp">/v1/notifications</span></span> ONESIGNAL_OWN_PLAYER_ID = <span class="hljs-number"><span class="hljs-number">830</span></span>‚Ä¶</code> </pre> <br>  'Own_player_id' appears in the config <br>  This is my subscriber ID from admin.  I need it for tests to send a notification only to myself. <br><img src="http://laravel-news.ru/attach/22/c0/56e4132856c4a.jpg"><br><h2>  Testing </h2><br>  Sending is ready - it's time to test it.  This is very easy to do, since we have set the correct architecture and the process of sending an article is essentially isolated. <br>  Let's add this method to our test: <br><pre> <code class="hljs bash">public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testSendOnesignal</span></span></span></span>() { //      (   ) <span class="hljs-variable"><span class="hljs-variable">$post</span></span> = factory(App\Models\Post::class)-&gt;make(); //     <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-variable"><span class="hljs-variable">$handler</span></span> = new \App\Handlers\OneSignalHandler(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); //   <span class="hljs-variable"><span class="hljs-variable">$result</span></span> = <span class="hljs-variable"><span class="hljs-variable">$handler</span></span>-&gt;sendNotify(<span class="hljs-variable"><span class="hljs-variable">$post</span></span>); //  1,     . <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertEquals(1,<span class="hljs-variable"><span class="hljs-variable">$result</span></span>); }</code> </pre> <br>  In the <code>phpunit</code> console - the test passes successfully and a notification pops up (sometimes there are delays of up to several minutes) <br>  If the test fails, look at the log and correct what the service does not like <br><h2>  Final chord </h2><br>  It remains only to add a call to the listener. <br><pre> <code class="hljs php"><span class="hljs-comment"><span class="hljs-comment">/** * Handle the event. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Event $event * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Event $event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($event <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> PostPublishedEvent) { (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OneSignalHandler())-&gt;sendNotify($event-&gt;post); } }</code> </pre><br><h1>  note </h1><br>  That's all for now, but <strong>our code has several disadvantages:</strong> <br>  1) we are sending in real time when the model is saved, if heavier and slower operations are added, the saving will not reach and everything will fall. <br>  2) when recording the sending status, we do not take into account the response of the service, if the service refuses to send, we will consider the article processed and we will not try to send more notifications on it. <br>  Therefore, <strong>I do not recommend using this solution on the production server.</strong> <br>  We will correct these shortcomings in future lessons.  Wait for the continuation (spoiler in the first comment :) <br><h2>  UPD </h2><br>  Continuing the article <a href="https://laravel-news.ru/blog/tutorials/laravel-queued-events">Working with events in Laravel.</a>  <a href="https://laravel-news.ru/blog/tutorials/laravel-queued-events">Asynchronous queue processing.</a> <br></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/279385/">https://habr.com/ru/post/279385/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../279375/index.html">CodingFuture + Puppet. Part IV: Centralized Management (cftotalcontrol)</a></li>
<li><a href="../279377/index.html">Recall all: Java JET conference. September 28, 2015. Report</a></li>
<li><a href="../279379/index.html">Google's beacon platform. Part 2 - Nearby meassages API</a></li>
<li><a href="../279381/index.html">Google's beacon platform. Part 1 - Proximity beacon API</a></li>
<li><a href="../279383/index.html">Work with VK API when creating a game for VKontakte</a></li>
<li><a href="../279389/index.html">Azure-IaaS-Digest number 3 (March)</a></li>
<li><a href="../279393/index.html">Parallel noise and random number functions for OpenCL cores</a></li>
<li><a href="../279395/index.html">Windows 2008 R2 on HP DL380 G4p</a></li>
<li><a href="../279397/index.html">Anatomy of document editors: a common code for online and offline versions of ONLYOFFICE editors</a></li>
<li><a href="../279403/index.html">Update KB3035583 can automatically update Windows 7 to Windows 10</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>