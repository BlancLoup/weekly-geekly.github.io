<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MVVM implementation of a WPF application configuration built on the basis of the Catel framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Implementing software settings management is probably one of those things that they implement in their own way in almost every application. Most frame...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MVVM implementation of a WPF application configuration built on the basis of the Catel framework</h1><div class="post__text post__text-html js-mediator-article"><p>  Implementing software settings management is probably one of those things that they implement in their own way in almost every application.  Most frameworks and other add-ons usually provide their own means for saving / loading values ‚Äã‚Äãfrom some key-value of parameter storage. </p><br><p>  However, in most cases, the implementation of a specific settings window and related many things is left to the discretion of the user.  In this article I want to share the approach that I managed to come to.  In my case, I need to implement work with settings in the MVVM-friendly style and using the specifics of the Catel framework used in this case. </p><br><p>  <strong>Disclaimer</strong> : in this note there will be no technical subtleties more difficult than basic reflection.  This is just a description of the approach to solving a small problem that I got over the weekend.  I wanted to think about how to get rid of the standard boilerplate code and copy-paste related to saving / loading application settings.  The solution itself turned out to be rather trivial thanks to the convenient .NET / Catel tools available, but maybe someone will save a couple of hours of time or suggest useful thoughts. </p><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Catel Framework Brief</b> <div class="spoiler_text"><p>  Like other WPF frameworks (Prism, MVVM Light, Caliburn.Micro, etc.), Catel provides convenient tools for building applications in the MVVM style. <br>  The main components: </p><br><ul><li>  IoC (integrated with MVVM components) </li><li>  ModelBase: a base class that provides an automatic implementation of PropertyChanged (especially in conjunction with Catel.Fody), serialization, and BeginEdit / CancelEdit / EndEdit (classic "apply" / "cancel"). </li><li>  ViewModelBase, able to bind to the model, wrapping its properties. </li><li>  Working with views that can automatically create and bind to ViewModel.  <a href="https://docs.catelproject.com/vnext/introduction/mvvm/introduction-to-nested-user-controls-problem/">Nested controls are</a> supported. </li></ul></div></div><br><h2 id="trebovaniya">  Requirements </h2><br><p>  We will proceed from the fact that we want the following from configuration tools: </p><br><ul><li> Access to configuration in a simple structured way.  for example <br> <code>CultureInfo culture = settings.Application.PreferredCulture;</code> <br> <code>TimeSpan updateRate = settings.Perfomance.UpdateRate;</code>  . <br><ul><li>  All parameters are presented as normal properties.  The storage method is encapsulated inside.  For simple types, everything should happen automatically; for more complex types, it should be possible to configure serialization of the value into a string. </li></ul></li><li>  Simplicity and reliability.  I don‚Äôt want to use fragile tools like serializing the whole model of settings or some Entity Framework.  At the lower level, the configuration remains a simple repository of parameter-value pairs. </li><li>  The ability to discard changes made to the configuration, for example, if the user clicked "cancel" in the settings window. </li><li>  Ability to subscribe to configuration updates.  For example, we want to update the application language immediately after the configuration has been changed. </li><li>  Migration between application versions.  It should be possible to set actions when switching between application versions (rename parameters, etc.). </li><li>  Minimum boilerplate code, minimum typos.  Ideally, we just want to set the auto property and not think about how it will be saved, under which string key, etc ... We don‚Äôt want to manually copy each of the properties in the view-model of the settings window, everything should work automatically. </li></ul><br><h2 id="standartnye-sredstva">  Standard Tools </h2><br><p>  Catel provides the IConfigurationService service, which allows storing and loading values ‚Äã‚Äãof string keys from local storage (a file on disk in the standard implementation). </p><br><p>  If we want to use this service in its pure form, we will have to declare these keys ourselves, for example, by setting such constants: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Application</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> String PreferredCulture = <span class="hljs-string"><span class="hljs-string">"Application.PreferredCulture"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> String PreferredCultureDefaultValue = Thread.CurrentThread.CurrentUICulture.ToString(); }</code> </pre> <br><p>  Then we can get these parameters like this: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> preferredCulture = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CultureInfo(configurationService.GetRoamingValue( Application.PreferredCulture, Application.PreferredCultureDefaultValue));</code> </pre> <br><p>  It‚Äôs a lot and tedious to write, it is easy to make typos when there are many settings.  In addition, the service supports only simple types, for example <code>CultureInfo</code> cannot be saved without additional transformations. </p><br><p>  To simplify the work with this service, a wrapper consisting of several components was obtained. </p><br><p>  The full sample code is available in the <a href="https://github.com/ArXen42/CatelConfigurationExample">GitHub repository</a> .  It contains the simplest application with the ability to edit a couple of parameters in the settings and make sure that everything works.  I didn‚Äôt bother with localization, the ‚ÄúLanguage‚Äù parameter in the settings is used solely to demonstrate the operation of the configuration.  If interested, Catel has convenient <a href="https://docs.catelproject.com/vnext/catel-core/multilingual/">localization mechanisms</a> , including at the WPF level.  If you don‚Äôt like resource files, you can make your own implementation working with GNU gettext, for example. </p><br><p>  For ease of reading, in the code examples in the text of this publication, all xml-doc comments have been removed. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/_9/js/i_/_9jsi_xxzbfegcuhavmkyluowni.png"></div><br><h2 id="servis-konfiguracii">  Configuration service </h2><br><p>  A service that can be embedded through IoC and have access to work with settings from anywhere in the application. </p><br><p>  The main objective of the service is to provide a settings model, which in turn provides a simple and structured way to access them. </p><br><p>  In addition to the settings model, the service also provides the ability to undo or save changes made to the settings. </p><br><p>  Interface: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IApplicationConfigurationProviderService</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> TypedEventHandler&lt;IApplicationConfigurationProviderService&gt; ConfigurationSaved; ConfigurationModel Configuration { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadSettingsFromStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaveChanges</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre> <br><p>  Implementation: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ApplicationConfigurationProviderService</span></span> : <span class="hljs-title"><span class="hljs-title">IApplicationConfigurationProviderService</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IConfigurationService _configurationService; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ApplicationConfigurationProviderService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IConfigurationService configurationService</span></span></span><span class="hljs-function">)</span></span> { _configurationService = configurationService; Configuration = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfigurationModel(); LoadSettingsFromStorage(); ApplyMigrations(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> TypedEventHandler&lt;IApplicationConfigurationProviderService&gt; ConfigurationSaved; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ConfigurationModel Configuration { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadSettingsFromStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Configuration.LoadFromStorage(_configurationService); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaveChanges</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Configuration.SaveToStorage(_configurationService); ConfigurationSaved?.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ApplyMigrations</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentVersion = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ApplicationConfigurationProviderService).Assembly.GetName().Version; String currentVersionString = currentVersion.ToString(); String storedVersionString = _configurationService.GetRoamingValue(<span class="hljs-string"><span class="hljs-string">"SolutionVersion"</span></span>, currentVersionString); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (storedVersionString == currentVersionString) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-comment"><span class="hljs-comment">//Either migrations were already applied or we are on fresh install var storedVersion = new Version(storedVersionString); foreach (var migration in _migrations) { Int32 comparison = migration.Version.CompareTo(storedVersion); if (comparison &lt;= 0) continue; migration.Action.Invoke(); } _configurationService.SetRoamingValue("SolutionVersion", currentVersionString); } }</span></span></code> </pre> <br><p>  The implementation is trivial, the contents of the <code>ConfigurationModel</code> described in the following sections.  The only thing that probably attracts attention is the <code>ApplyMigrations</code> method. </p><br><p>  In the new version of the program, something may change, for example, the method of storing some complex parameter or its name.  If we do not want to lose our settings after each update that changes existing parameters, we need a migration mechanism.  The <code>ApplyMigrations</code> method <code>ApplyMigrations</code> very simple support for performing any actions during the transition between versions. </p><br><p>  If something has changed in the new version of the application, we simply add the necessary actions (for example, saving the parameter under a new name) in the new version to the list of migrations contained in the neighboring file: </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IReadOnlyCollection&lt;Migration&gt; _migrations = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Migration[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Migration(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Version(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>), () =&gt; { <span class="hljs-comment"><span class="hljs-comment">//... }) } .OrderBy(migration =&gt; migration.Version) .ToArray(); private class Migration { public readonly Version Version; public readonly Action Action; public Migration(Version version, Action action) { Version = version; Action = action; } }</span></span></code> </pre> <br><h2 id="model-nastroek">  Settings Model </h2><br><p>  Automation of routine operations is as follows.  The configuration is described as a regular model (data-object).  Catel provides a convenient base class <code>ModelBase</code> , which is the core of all its MVVM tools, for example, automatic bindings between all three MVVM components.  In particular, it allows you to easily access the model properties that we want to save. </p><br><p>  By declaring such a model, we can get its properties, map string keys to them, create them from property names, and then automatically load and save values ‚Äã‚Äãfrom the configuration.  In other words, bind properties and values ‚Äã‚Äãin a configuration. </p><br><h3 id="obyavlenie-parametrov-konfiguracii">  Declaring configuration options </h3><br><p>  This is the root model: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ConfigurationModel</span></span> : <span class="hljs-title"><span class="hljs-title">ConfigurationGroupBase</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigurationModel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Application = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApplicationConfiguration(); Performance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PerformanceConfiguration(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ApplicationConfiguration Application { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PerformanceConfiguration Performance { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br><p>  <code>ApplicationConfiguration</code> and <code>PerfomanceConfiguration</code> are subclasses that describe their settings groups: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ConfigurationModel</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PerformanceConfiguration</span></span> : <span class="hljs-title"><span class="hljs-title">ConfigurationGroupBase</span></span> { [DefaultValue(<span class="hljs-number"><span class="hljs-number">10</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Int32 MaxUpdatesPerSecond { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre> <br><p>  Under the hood, this property will be associated with the parameter <code>"Performance.MaxUpdatesPerSecond"</code> , the name of which is generated from the name of the type <code>PerformanceConfiguration</code> . </p><br><p>  It should be noted that the ability to declare these properties was so concise thanks to the use of <a href="">Catel.Fody</a> , a plug-in to the well-known .NET code generator <a href="https://github.com/Fody/Fody">Fody</a> .  If for some reason you do not want to use it, properties should be declared as usual, according to the <a href="http://docs.catelproject.com/vnext/catel-core/data-handling/modelbase/">documentation</a> (visually similar to DependencyProperty from WPF). </p><br><p>  If desired, the level of nesting can be increased. </p><br><h3 id="realizaciya-svyazyvaniya-svoystv-s-iconfigurationservice">  Implement Property Binding with IConfigurationService </h3><br><p>  Binding occurs in the base class <code>ConfigurationGroupBase</code> , which in turn is inherited from ModelBase.  Consider its contents in more detail. </p><br><p>  First of all, we make a list of properties that we want to save: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ConfigurationGroupBase</span></span> : <span class="hljs-title"><span class="hljs-title">ModelBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IReadOnlyCollection&lt;ConfigurationProperty&gt; _configurationProperties; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IReadOnlyCollection&lt;PropertyData&gt; _nestedConfigurationGroups; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigurationGroupBase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> properties = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetDependencyResolver() .Resolve&lt;PropertyDataManager&gt;() .GetCatelTypeInfo(GetType()) .GetCatelProperties() .Select(property =&gt; property.Value) .Where(property =&gt; property.IncludeInBackup &amp;&amp; !property.IsModelBaseProperty) .ToArray(); _configurationProperties = properties .Where(property =&gt; !property.Type.IsSubclassOf(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ConfigurationGroupBase))) .Select(property =&gt; { <span class="hljs-comment"><span class="hljs-comment">// ReSharper disable once PossibleNullReferenceException String configurationKeyBase = GetType() .FullName .Replace("+", ".") .Replace(typeof(ConfigurationModel).FullName + ".", string.Empty); configurationKeyBase = configurationKeyBase.Remove(configurationKeyBase.Length - "Configuration".Length); String configurationKey = $"{configurationKeyBase}.{property.Name}"; return new ConfigurationProperty(property, configurationKey); }) .ToArray(); _nestedConfigurationGroups = properties .Where(property =&gt; property.Type.IsSubclassOf(typeof(ConfigurationGroupBase))) .ToArray(); } ... private class ConfigurationProperty { public readonly PropertyData PropertyData; public readonly String ConfigurationKey; public ConfigurationProperty(PropertyData propertyData, String configurationKey) { PropertyData = propertyData; ConfigurationKey = configurationKey; } } }</span></span></code> </pre> <br><p>  Here we simply turn to the analogue of reflection for Catel models, get properties (by filtering utility or those that we explicitly marked with the <code>[ExcludeFromBackup]</code> attribute) and generate string keys for them.  Properties that themselves are of type <code>ConfigurationGroupBase</code> listed in a separate list. </p><br><p>  The <code>LoadFromStorage()</code> method writes values ‚Äã‚Äãfrom the configuration to standard properties that were previously obtained or standard if they were not previously saved.  For subgroups, their <code>LoadFromStorage()</code> called: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadFromStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IConfigurationService configurationService</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> property <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _configurationProperties) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { LoadPropertyFromStorage(configurationService, property.ConfigurationKey, property.PropertyData); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { Log.Error(ex, <span class="hljs-string"><span class="hljs-string">"Can't load from storage nested configuration group {Name}"</span></span>, property.PropertyData.Name); } } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> property <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _nestedConfigurationGroups) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configurationGroup = GetValue(property) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ConfigurationGroupBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (configurationGroup == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Log.Error(<span class="hljs-string"><span class="hljs-string">"Can't load from storage configuration property {Name}"</span></span>, property.Name); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } configurationGroup.LoadFromStorage(configurationService); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadPropertyFromStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IConfigurationService configurationService, String configurationKey, PropertyData propertyData</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> objectConverterService = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetDependencyResolver().Resolve&lt;IObjectConverterService&gt;(); Object <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = configurationService.GetRoamingValue(configurationKey, propertyData.GetDefaultValue()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> String stringValue) <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = objectConverterService.ConvertFromStringToObject(stringValue, propertyData.Type, CultureInfo.InvariantCulture); SetValue(propertyData, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); }</code> </pre> <br><p>  The <code>LoadPropertyFromStorage</code> method determines how the value is transferred from the configuration to the property.  It is virtual and can be redefined for non-trivial properties. </p><br><p>  A small feature of the internal operation of the <code>IConfigurationService</code> service: you can notice the use of <code>IObjectConverterService</code> .  It is needed because <code>IConfigurationService.GetValue</code> in this case is called with a generic parameter of type <code>Object</code> and in this case it will not convert the loaded strings to numbers, for example, therefore, we need to do this ourselves. </p><br><p>  Similarly with saving parameters: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaveToStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IConfigurationService configurationService</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> property <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _configurationProperties) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { SavePropertyToStorage(configurationService, property.ConfigurationKey, property.PropertyData); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { Log.Error(ex, <span class="hljs-string"><span class="hljs-string">"Can't save to storage configuration property {Name}"</span></span>, property.PropertyData.Name); } } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> property <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _nestedConfigurationGroups) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configurationGroup = GetValue(property) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ConfigurationGroupBase; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (configurationGroup == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Log.Error(<span class="hljs-string"><span class="hljs-string">"Can't save to storage nested configuration group {Name}"</span></span>, property.Name); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } configurationGroup.SaveToStorage(configurationService); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SavePropertyToStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IConfigurationService configurationService, String configurationKey, PropertyData propertyData</span></span></span><span class="hljs-function">)</span></span> { Object <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = GetValue(propertyData); configurationService.SetRoamingValue(configurationKey, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); }</code> </pre> <br><p>  It should be noted that inside the configuration model, you need to follow simple naming conventions to get uniform parameter string keys: </p><br><ul><li>  Types of settings groups (except the root) are subclasses of the "parent" group and their names end in Configuration. </li><li>  For each such type there is a property corresponding to it.  For example, the <code>ApplicationSettings</code> group and the <code>Application</code> property.  The name of the property does not affect anything, but this is the most logical and expected option. </li></ul><br><h3 id="nastroyka-sohraneniya-otdelnyh-svoystv">  Setting save individual properties </h3><br><p>  The auto- <code>IConfigurationService</code> Catel.Fody and <code>IConfigurationService</code> (direct saving of the value in <code>IConfigurationService</code> and the <code>[DefaultValue]</code> attribute) will work only for simple types and constant default values.  For complex properties, you have to paint a little more authentic: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ConfigurationModel</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ApplicationConfiguration</span></span> : <span class="hljs-title"><span class="hljs-title">ConfigurationGroupBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CultureInfo PreferredCulture { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [DefaultValue(<span class="hljs-string"><span class="hljs-string">"User"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Username { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadPropertyFromStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IConfigurationService configurationService, String configurationKey, PropertyData propertyData</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (propertyData.Name) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">case</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nameof</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PreferredCulture</span></span></span><span class="hljs-function">): String preferredCultureDefaultValue</span></span> = CultureInfo.CurrentUICulture.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (preferredCultureDefaultValue != <span class="hljs-string"><span class="hljs-string">"en-US"</span></span> || preferredCultureDefaultValue != <span class="hljs-string"><span class="hljs-string">"ru-RU"</span></span>) preferredCultureDefaultValue = <span class="hljs-string"><span class="hljs-string">"en-US"</span></span>; String <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = configurationService.GetRoamingValue(configurationKey, preferredCultureDefaultValue); SetValue(propertyData, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CultureInfo(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.LoadPropertyFromStorage(configurationService, configurationKey, propertyData); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SavePropertyToStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IConfigurationService configurationService, String configurationKey, PropertyData propertyData</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (propertyData.Name) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">case</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nameof</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PreferredCulture</span></span></span><span class="hljs-function">): Object </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">value</span></span></span></span> = GetValue(propertyData); configurationService.SetRoamingValue(configurationKey, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.ToString()); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.SavePropertyToStorage(configurationService, configurationKey, propertyData); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } }</code> </pre> <br><p>  Now we can, for example, in the settings window bind to any of the model properties: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextBox</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding Configuration.Application.Username}"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br><p>  It remains to remember to override the operations when closing the ViewModel settings window: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Task&lt;Boolean&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaveAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _applicationConfigurationProviderService.SaveChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.SaveAsync(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Task&lt;Boolean&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CancelAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _applicationConfigurationProviderService.LoadSettingsFromStorage(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.CancelAsync(); }</code> </pre> <br><p>  With an increase in the number of parameters and accordingly the complexity of the interface, you can easily create separate View and ViewModel for each section of the settings. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/460981/">https://habr.com/ru/post/460981/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../46097/index.html">Debian stuff - apt-build</a></li>
<li><a href="../460971/index.html">NVIDIA Jetson Nano: tests and first impressions - part 2, AI tests</a></li>
<li><a href="../460973/index.html">Contact welding for 18650 batteries</a></li>
<li><a href="../460979/index.html">Rejuvenation biotechnologies are real and inevitable</a></li>
<li><a href="../46098/index.html">How to buy books, software, iTunes Gift Card directly on the iPhone. For WebMoney.</a></li>
<li><a href="../460983/index.html">I'm not real</a></li>
<li><a href="../460985/index.html">14 Best Kanban Tools in 2019</a></li>
<li><a href="../460987/index.html">"God Mode for the Internet": tracking users through extensions Chrome and Firefox</a></li>
<li><a href="../460989/index.html">Which language - D, Go or Rust has better prospects to replace C and why?</a></li>
<li><a href="../46099/index.html">Real estate without intermediaries</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>