<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Greetings from the libc free world! (Part 1)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As an exercise, I want to write a program in C. Simple enough to disassemble it and explain the whole code to myself. 

 Sounds easy, right? 

 The re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Greetings from the libc free world! (Part 1)</h1><div class="post__text post__text-html js-mediator-article">  <i>As an exercise,</i> I want to write a program in C. Simple enough to disassemble it and explain the whole code to myself. <br><br>  Sounds easy, right? <br><br>  The reader assumes experience in compiling programs and working in Linux.  A small ability to read assembly code is also useful. <br><a name="habracut"></a><br>  So, here is our simplest hello world: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre>  jesstess @ kid-charlemagne: ~ / c $ cat hello.c
 #include &lt;stdio.h&gt;

 int main ()
 {
	 printf ("Hello World \ n");
	 return 0;
 } </pre><br>  Compile it and count the number of characters: <br><br><pre>  jesstess @ kid-charlemagne: ~ / c $ gcc -o hello hello.c
 jesstess @ kid-charlemagne: ~ / c $ wc -c hello
 10931 hello </pre><br>  Figas!  Where do these 11 kilobytes come from?  <code>objdump -t hello</code> shows 79 entries in the table of identifiers, for most of which the standard library is responsible. <br><br>  So we will not use it.  And we won't use <code>printf</code> either to get rid of the include: <br><br><pre>  jesstess @ kid-charlemagne: ~ / c $ cat hello.c
 int main ()
 {
	 char * str = "Hello World";
	 return 0;
 } </pre><br>  Recompile and recalculate the number of characters: <br><br><pre>  jesstess @ kid-charlemagne: ~ / c $ gcc -o hello hello.c
 jesstess @ kid-charlemagne: ~ / c $ wc -c hello
 10892 hello </pre><br>  Almost nothing has changed?  Ha! <br><br>  The problem is that gcc still uses startup files (?) During linking.  Proof of?  <a href="http://gcc.gnu.org/onlinedocs/gcc-4.4.3/gcc/Link-Options.html"><code>-nostdlib</code></a> with the <a href="http://gcc.gnu.org/onlinedocs/gcc-4.4.3/gcc/Link-Options.html"><code>-nostdlib</code></a> key, after which (according to the documentation) gcc ‚Äúwill not use the system libraries and startup files when linking.  Only files explicitly transferred to the linker will be used. ‚Äù <br><br><pre>  jesstess @ kid-charlemagne: ~ / c $ gcc -nostdlib -o hello hello.c
 / usr / bin / ld: warning: cannot find entry symbol _start;  defaulting to 00000000004000e8 </pre><br>  Just a warning, still try: <br><br><pre>  jesstess @ kid-charlemagne: ~ / c $ wc -c hello
 1329 hello </pre><br>  Looks good!  We reduced the size to a much more sane (as much as a whole order!) ... <br><br><pre>  jesstess @ kid-charlemagne: ~ / c $ ./hello
 Segmentation fault </pre><br>  ... and paid for it with a segfolt.  Pancake. <br><br>  For fun, let's make our program run before we start understanding the assembler. <br><br>  What makes the symbol <code>_start</code> , which seems to be needed to run the program?  Where is it usually defined when using libc? <br><br>  By default, from the point of view of the <a href="http://en.wikipedia.org/wiki/Linker_%2528computing%2529">linker</a> , <code>_start</code> , rather than <code>main</code> , is the real entry point into the program.  Usually <code>_start</code> defined in the <code>crt1.o</code> <a href="http://en.wikipedia.org/wiki/Executable_and_Linkable_Format">ELF being</a> <code>crt1.o</code> .  Verify this by linking the helloWord with <code>crt1.o</code> and noting that <code>_start</code> now detected (but other problems appeared instead because other startup records libc are not defined): <br><br><pre>  # compile the source without linking
 jesstess @ kid-charlemagne: ~ / c $ gcc -Os -c hello.c
 # now try to link
 jesstess @ kid-charlemagne: ~ / c $ ld /usr/lib/crt1.o -o hello hello.o
 /usr/lib/crt1.o: In function `_start ':
 /build/buildd/glibc-2.9/csu/../sysdeps/x86_64/elf/start.S:106: undefined reference to `__libc_csu_fini '
 /build/buildd/glibc-2.9/csu/../sysdeps/x86_64/elf/start.S:107: undefined reference to `__libc_csu_init '
 /build/buildd/glibc-2.9/csu/../sysdeps/x86_64/elf/start.S:113: undefined reference to `__libc_start_main ' </pre><br>  The check reported that on this computer <code>_start</code> lives in the libc source: <code><a href="http://sourceware.org/git/%3Fp%3Dglibc.git%3Ba%3Dblob%3Bf%3Dsysdeps/x86_64/elf/start.S%3Bh%3D3c2caf9d00a0396ef2b74adb648f76c6c74ff65f%3Bhb%3Dcvs/glibc-2_9-branch"></a> sysdeps/x86_64/elf/start.S</code>  <code><a href="http://sourceware.org/git/%3Fp%3Dglibc.git%3Ba%3Dblob%3Bf%3Dsysdeps/x86_64/elf/start.S%3Bh%3D3c2caf9d00a0396ef2b74adb648f76c6c74ff65f%3Bhb%3Dcvs/glibc-2_9-branch"></a> sysdeps/x86_64/elf/start.S</code> .  This delightfully commented file exports the <code>_start</code> character, initializes the stack, some registers, and calls <code>__libc_start_main</code> .  If you look at the bottom <code><a href="http://sourceware.org/git/%3Fp%3Dglibc.git%3Ba%3Dblob%3Bf%3Dcsu/libc-start.c%3Bh%3Da14ed71616a3f63f092837e9c30780f8344b4fbe%3Bhb%3Dcvs/glibc-2_9-branch"></a> csu/libc-start.c</code>  <code><a href="http://sourceware.org/git/%3Fp%3Dglibc.git%3Ba%3Dblob%3Bf%3Dcsu/libc-start.c%3Bh%3Da14ed71616a3f63f092837e9c30780f8344b4fbe%3Bhb%3Dcvs/glibc-2_9-branch"></a> csu/libc-start.c</code> , you can see the <code>_main</code> call of our program: <br><br><pre>  / * Nothing special, just call the function * /
 result = main (argc, argv, __environ MAIN_AUXVEC_PARAM);
</pre><br>  ... and went. <br><br>  So this is why <code>_start</code> needed.  For convenience, <code>_start</code> summarize what happens between <code>_start</code> and the <code>main</code> call: initialize a bunch of things for libc and call <code>main</code> .  And since we don‚Äôt need libc, we export our own <code>_start</code> symbol, which only knows what to call <code>main</code> , and link it with it: <br><br><pre>  jesstess @ kid-charlemagne: ~ / c $ cat stubstart.S
 .globl _start

 _start:
	 call main </pre><br>  Compile and execute the helloWorld with the _start assembler stub: <br><br><pre>  jesstess @ kid-charlemagne: ~ / c $ gcc -nostdlib stubstart.S -o hello hello.c
 jesstess @ kid-charlemagne: ~ / c $ ./hello
 Segmentation fault </pre><br>  Hooray, with the compilation of problems is no more.  But the Segfolt did not go anywhere.  Why?  Compile with debug information and take a look at gdb.  Set a breakpoint on <code>main</code> and step by step execute the program before the default: <br><br><pre>  jesstess @ kid-charlemagne: ~ / c $ gcc -g -nostdlib stubstart.S -o hello hello.c
 jesstess @ kid-charlemagne: ~ / c $ gdb hello
 GNU gdb 6.8-debian
 Copyright (C) 2008 Free Software Foundation, Inc.
 License GPLv3 +: GNU GPL version 3 or later
 This is free software:
 There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
 and "show warranty" for details.
 This GDB was configured as "x86_64-linux-gnu" ...
 (gdb) break main
 Breakpoint 1 at 0x4000f4: file hello.c, line 3.
 (gdb) run
 Starting program: / home / jesstess / c / hello

 Breakpoint 1, main () at hello.c: 5
 5 char * str = "Hello World";
 (gdb) step
 6 return 0;
 (gdb) step
 7}
 (gdb) step
 0x00000000004000ed in _start ()
 (gdb) step
 Single stepping until exit from function _start,
 which has no line number information.
 main () at helloint.c: 4
 four {
 (gdb) step

 Breakpoint 1, main () at helloint.c: 5
 5 char * str = "Hello World";
 (gdb) step
 6 return 0;
 (gdb) step
 7}
 (gdb) step

 Program received signal SIGSEGV, Segmentation fault.
 0x0000000000001 in ??  ()
 (gdb) </pre><br>  What?  <code>main</code> is executed twice?  ... The time has come to take on the assembler: <br><br><pre>  jesstess @ kid-charlemagne: ~ / c $ objdump -d hello
 hello: file format elf64-x86-64
 Disassembly of section .text:

 00000000004000e8 &lt;_start&gt;:
   4000e8: e8 03 00 00 00 callq 4000f0
   4000ed: 90 nop
   4000ee: 90 nop
   4000ef: 90 nop    

 00000000004000f0:
   4000f0: 55 push% rbp
   4000f1: 48 89 e5 mov% rsp,% rbp
   4000f4: 48 c7 45 f8 03 01 40 movq $ 0x400103, -0x8 (% rbp)
   4000fb: 00
   4000fc: b8 00 00 00 00 mov $ 0x0,% eax
   400101: c9 leaveq
   400102: c3 retq </pre><br>  Heh  We will leave a detailed analysis of the assembler for later, noting in brief the following: after returning from <code>callq</code> to <code>main</code> we execute a few <code>nop</code> and return directly to <code>main</code> .  Since the re-entry into <code>main</code> was made without setting the return instruction pointer on the stack (as part of the standard preparation for calling the function), the second <code>retq</code> call <code>retq</code> to <code>retq</code> dummy return instruction pointer from the stack and the program crashes.  Need a way to complete. <br><br>  Literally.  After returning from <code>callq</code> to <code>%eax</code> , push <code>1</code> , <a href="http://git.kernel.org/%3Fp%3Dlinux/kernel/git/torvalds/linux-2.6.git%3Ba%3Dblob%3Bf%3Darch/x86/include/asm/unistd_32.h%3Bh%3D3baf379fa8402a0df08a1ea6ab7f388e3fdac081%3Bhb%3D60b341b778cc2929df16c0a504c91621b3c6a4ad">the</a> <code>sys_exit</code> <a href="http://git.kernel.org/%3Fp%3Dlinux/kernel/git/torvalds/linux-2.6.git%3Ba%3Dblob%3Bf%3Darch/x86/include/asm/unistd_32.h%3Bh%3D3baf379fa8402a0df08a1ea6ab7f388e3fdac081%3Bhb%3D60b341b778cc2929df16c0a504c91621b3c6a4ad">system call</a> <code>sys_exit</code> , and so on are made.  need to report the correct completion put in <code>%ebx 0</code> , the only argument is <code>SYS_exit</code> .  Now we enter the kernel with the <code>int $0x80</code> interrupt. <br><br><pre>  jesstess @ kid-charlemagne: ~ / c $ cat stubstart.S
 .globl _start

 _start:
	 call main
	 movl $ 1,% eax
	 xorl% ebx,% ebx
	 int $ 0x80
 jesstess @ kid-charlemagne: ~ / c $ gcc -nostdlib stubstart.S -o hello hello.c
 jesstess @ kid-charlemagne: ~ / c $ ./hello
 jesstess @ kid-charlemagne: ~ / c $ </pre><br>  Hooray!  The program is compiled, run, when running through gdb even ends normally. <br><br>  Greetings from the libc free world! <br><br>  Stay with me, in the second part we will analyze the assembler code in detail, let's see what happens if we make the program more complex, and understand a little more about linking, calling conventions and the structure of the binary ELF file in the x86 architecture. </div><p>Source: <a href="https://habr.com/ru/post/88101/">https://habr.com/ru/post/88101/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../88090/index.html">Revolutionary wealth. Toffler</a></li>
<li><a href="../88091/index.html">Convenient online messenger for online store</a></li>
<li><a href="../88094/index.html">DevConf: 3 reports + MySQL masterclass: DRBD / HeartBeat / MySQL, MariaDB, MySQL performance monitoring</a></li>
<li><a href="../88096/index.html">Prospects and problems of the Android platform</a></li>
<li><a href="../88100/index.html">The sum of the measurements in rrdtool</a></li>
<li><a href="../88106/index.html">Simkl launches Promo Manager - a tool for promotion of startups and online stores</a></li>
<li><a href="../88109/index.html">Inside the clouds</a></li>
<li><a href="../88110/index.html">Windows Phone 7 emulator unlocked to access all features</a></li>
<li><a href="../88113/index.html">ProgressBar - Javascript Canvas2d</a></li>
<li><a href="../88114/index.html">RSS new torrents with rutracker.org</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>