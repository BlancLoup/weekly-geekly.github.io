<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>You do not know how to work with transactions.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The headline came catchy, but boiling. I must say that it will be about 1C. Dear 1C-nicks, you do not know how to work with transactions and do not un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>You do not know how to work with transactions.</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/ay/0z/8o/ay0z8ormmv-qepftdi67nlk6nb0.png"></p><br><p>  The headline came catchy, but boiling.  I must say that it will be about 1C.  Dear 1C-nicks, you do not know how to work with transactions and do not understand what exceptions are.  I came to this conclusion by looking at a large amount of code on 1C, born in the wilds of a domestic enterprise.  In typical configurations, this is pretty good, but the horrendous amount of custom code is written incompetently in terms of working with the database.  Have you ever seen the error "There have already been errors in this transaction"?  If so, then the title of the article applies to you.  Let's see under the cut, finally, what are transactions and how to handle them correctly, working with 1C. </p><a name="habracut"></a><br><h2 id="pochemu-nado-bit-trevogu">  Why do I need to sound the alarm </h2><br><p>  To begin with, let's see what the error is "In this transaction, errors have already occurred."  This is, in fact, a very simple thing: you are trying to work with a database inside an already rolled back (canceled) transaction.  For example, the CancelTransaction method was called somewhere, and you are trying to commit it. </p><br><p>  Why is that bad?  Because this error tells you nothing about where the problem actually happened.  When a user receives a screenshot with such text, and especially for server code that the person does not work with interactively, this ... I wanted to write a "critical error", but I thought it was a buzzword that nobody already pays attention to ....  This is ass.  This is a programming error.  This is not a random crash.  This cant, which must be redone immediately.  Because when your server‚Äôs background processes get up at night and the company starts to lose money fast, then ‚ÄúThere have already been errors in this transaction‚Äù is the last thing you want to see in the diagnostic logs. </p><br><p>  There is, of course, the possibility that the server‚Äôs technological log (it‚Äôs included in production, right?) Will somehow help diagnose the problem, but I can‚Äôt think of an option right now - how to find the real cause of this error in it.  And the real reason is one - programmer Vasya received an exception inside the transaction and decided that <del>  once - not a carabas </del>  "think, mistake, let's go further." </p><br><h2 id="chto-takoe-tranzakcii-v-1s">  What is a transaction in 1C </h2><br><p>  It is embarrassing to write about truism, but, probably, it is necessary a little.  Transactions in 1C are the same as transactions in a DBMS.  These are not some special "1C-s" transactions, they are transactions in a DBMS.  According to the general idea of ‚Äã‚Äãtransactions, they can either be executed entirely or not executed at all.  All changes to database tables made within a transaction can be undone at once, as if nothing had happened. </p><br><p>  Further, you need to understand that nested transactions are not supported in 1C.  In fact, they are not supported not "in 1C", but are not supported at all.  At least, those DBMS with which 1C can work.  Nested transactions, for example, are not in MS SQL and Postgres.  Each "nested" call to Start Transaction simply increases the transaction counter, and each call to "Commit Transaction" reduces this counter.  This behavior is described in many books and articles, but the conclusions from this behavior are apparently not well understood.  Strictly speaking, in SQL there is a so-called.  SAVEPOINT, but 1C does not use them, and the thing is quite specific. </p><br><p>  Hereinafter, especially for the Warriors of the True Faith, who believe that the code should be written only in English, an analogue of the code in English syntax 1C will be given under the spoilers. </p><br><pre><code class="1c"> ()

    ();

         
         = .();
        . = "    ";
        .();
    ;

    ();


</code></pre><br>
<div class="spoiler"><b class="spoiler_title">  </b><div class="spoiler_text"><p>  , .           ,       .</p></div></div><br>
<p>     , ?     .  , .  ?     ,            .   ‚Äî  .   ‚Äî  deadlock,       ,      ,     ,    .    : <em>deadlock  </em>. </p><br>
<p> ,   .    1-  .    ,  , 3 .   ,          ,    1 :)</p><br>
<h3 id="obektnye-blokirovki"> </h3><br>
<p>,  .  1   ,   ""  "".   ,  ,   :).   ,      .     <a href="https://infostart.ru/public/543218"></a>  <a href="https://its.1c.ru/db/metod8dev"></a>,     IT-  .</p><br>
<p>   ,         ,         (   ),      .        "    ".      ,    ,     .      ,       .   ,   , ,  ELK-   1      ‚Ä¶ (,  ,    ,       :))</p><br>
<p> ,     ,    . ,     ,            "<em>.()</em>".    (    )        ,  .</p><br>
<h3 id="a-teper-pro-tranzakcii">   </h3><br>
<p>   ,    .</p><br>
<p>       ,   (,     "()")      <strong>  </strong>.    ""       , ,  -    -,      .   ,   : <strong>,  ,      .</strong></p><br>
<p><img src="https://habrastorage.org/webt/0l/4l/jy/0l4ljyxexk9fodjreu41veepowg.png"></p><br>
<p>      .   <a href="http://silverbulleters.org/sonarqube">   1</a>   SonarQube      .      ,    1,       ,       ‚Ä¶</p><br>
<p>?         90%          .  ,  <strong>1              .</strong>   ,       1,   .</p><br>
<p>      :</p><br>
<pre><code class="1c"> ()

      = ();
     ();

</code></pre><br>
<p>,  .     - ,   .         ‚Äî   -        .    ‚Äî      ‚Ä¶        , ?   ""     ,       .  ,     .  ,          ,      ,  "   -‚Ä¶"</p><br>
<h3 id="razmazyvanie-tranzakciy-po-metodam">   </h3><br>
<p>  "-" : <strong>                </strong>.           .   , ,   ,    -  ,     .      .</p><br>
<p>:</p><br>
<pre><code class="1c"> ()

      = ();
     ();

     ();

     //   ,         .

</code></pre><br>
<p> ‚Äî  .    ,         (  ‚Äî  )    ,   .      -,   ,  .</p><br>
<p>  ,         3- .          ‚Äî        .</p><br>
<h2 id="pytaemsya-ispravit-kod">  </h2><br>
<p>       .  ,        , ,     .</p><br>
<h3 id="pervyy-podhod-tipichnogo-1s-nika">   1-</h3><br>
<p>  1 ,       .     ,     . ,  :</p><br>
<pre><code class="1c"> ()

    ();

         
         = .();

        . = "    ";
        
              .();
        
              .("    %1", );
              ;
        ;
    ;

    ();

</code></pre><br>
<p> ,  , ?  ,       .       .      ‚Äî   ,  ,       "  ",        .  ,       .</p><br>
<p>,  1-  ,  ,   .     ,      .   "()"  1    ,          .         1    (,    -),           ""     .        ,      "  ".</p><br>
<p>  ,       ,     ,     -   ""     .       ,  -    .  ,      ,     .</p><br>
<p><strong>,   ,     .</strong>      .                .</p><br>
<h3 id="metody-raboty-s-tranzakciyami-v-1s">     1</h3><br>
<p>   ,   1      .    :</p><br>
<ul>
<li>()</li>
<li>()</li>
<li>()</li>
<li>()</li>
</ul><br>
<p> 3     ,     .   ‚Äî  ,     .</p><br>
<p>   .     (  )  ,     .  ,       ,   .</p><br>
<p>    ?  :     : <strong>,  ,      .</strong></p><br>
<p>    ?  :</p><br>
<pre><code class="1c">();
();
();</code></pre><br>
<p>   ,    ‚Äî  .    - ,   ""    . ,    :</p><br>
<pre><code class="1c">();

    ();

    //     ?
;
();</code></pre><br>
<p>,    ,     ?    ? ,  ,               .   ?       ?        ,       .    ""  .    -       throw.</p><br>
<pre><code class="1c">();

    ();

    ;
;
();</code></pre><br>
<p>, ‚Ä¶      ,      ?   :        .</p><br>
<pre><code class="1c">();

    ();

    ();
    ;
;
();</code></pre><br>
<p>,  , . ,   ,     ().         ,      ?    ,       ,  ?   ,  <strong>     </strong>,          .   ,        ,    . -    .</p><br>
<h4 id="finalnyy-variant"> </h4><br>
<p>,    , "-"  .  :</p><br>
<p>**UPD:      ,      .     ,      -.</p><br>
<pre><code class="1c">();

    ();
    ();

     () 
        ();
    ;
    ;
;</code></pre><br>
<p>,     ""   .    ""        ""?  ,     : <strong>,  ,      .</strong>     ,    .           .      .  ,       .   .        .        ""   .           ,  ,    <strong>   , "" </strong>.</p><br>
<h2 id="chek-list-refaktoringa">- </h2><br>
<p>     ,    .</p><br>
<p><strong>:</strong></p><br>
<pre><code class="1c">();
();
();</code></pre><br>
<p>  ""   ,     .</p><br>
<p><strong>:</strong></p><br>
<pre><code class="1c">  () 
    ()
</code></pre><br>
<p>  .   ,  .     .    ,     .           .   .</p><br>
<p>  :</p><br>
<pre><code class="1c"> () 
    ()
</code></pre><br>
<p>:     ‚Äî  .   ? , -      ?   .</p><br>
<p><strong>:</strong></p><br>
<pre><code class="1c">()
 .() 

    //    
    //  

;
();</code></pre><br>
<ol>
<li>     deadlock</li>
<li>   </li>
<li>  "",   </li>
</ol><br>
<p><strong>:</strong></p><br>
<pre><code class="1c">()
 .() 

    
    .();
    
           ("  ");
    ;

;
();</code></pre><br>
<p>       .    .   ,    .       .</p><br>
<h2 id="v-zaklyuchenie"> </h2><br>
<p>,   , , ,   ,   1    .  , ,  ,    Highload,     ,          .     ORM,  GUI,  -,  Reporting,    .        ,  ,  ‚Äî   1,   ‚Äî      .     ,      ,  ,   ,  , -,    . 1      .   20         /     -.  ,     ,          . -  1    ,   ,   . -  "()"....</p><br>
<p>  ‚Äî  ,   .    1    -      .    ,   .          " 1" ‚Äî     .    .</p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/419715/">https://habr.com/ru/post/419715/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../419701/index.html">Why in the presence of power you need a good old coal boiler in the car</a></li>
<li><a href="../419703/index.html">Registration of medical devices: how many mice will suffer in the process</a></li>
<li><a href="../419705/index.html">We want to replace devops with a script (not really): developers, you need your opinion</a></li>
<li><a href="../419707/index.html">Gamification of applications - 5 moments that should not be forgotten</a></li>
<li><a href="../419711/index.html">The first IT Bike Quest in St. Petersburg. How it was</a></li>
<li><a href="../419717/index.html">Embedded architecture design</a></li>
<li><a href="../419719/index.html">[bookmark] 23 recommendations for the protection of Node.js applications</a></li>
<li><a href="../419721/index.html">Biomarkers of aging. Frailty panel. Part 1</a></li>
<li><a href="../419725/index.html">Darts, dice and coins: discrete sampling algorithms</a></li>
<li><a href="../419727/index.html">Harbor - Registry for Docker Containers with Out-of-Box Security</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>