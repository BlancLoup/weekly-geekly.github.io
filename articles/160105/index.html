<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple state machines in the service of the developer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Imagine an ordinary programmer for a moment. Suppose his name is Vasya and he needs to make an animated menu on the site / desktop application / mobil...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple state machines in the service of the developer</h1><div class="post__text post__text-html js-mediator-article">  Imagine an ordinary programmer for a moment.  Suppose his name is Vasya and he needs to make an animated menu on the site / desktop application / mobile app.  You know, who go from top to bottom, like the menu at the Windows window or the menu with the apple in OS X. That's it. <br><br>  He starts with a single drop-down window, tests the animation, sets ease out 100% and enjoys the result.  But soon he realizes that in order to manage the menu, it would be good to know if it is closed now or not.  We are experienced programmers here, we all understand that we need to add a flag.  No question, there is a flag. <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> opened = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre> <br>  It seems to work.  But, if you quickly click on the button, the menu starts blinking, opening and closing without having had time to reanimate into the final state.  Vasya adds a flag <i>animating</i> .  Now we have the code: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> opened = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> animating = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (animating) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (opened) close(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> open(); }</code> </pre><br>  After some time, Vasya is told that the menu can be completely turned off and inactive.  No problem!  We are experienced programmers here with you, we all understand that ... <b>we need to add ANOTHER FLAG!</b>  And, only after a couple of days of development, the menu code is already replete with two-line IF-s like this: <br><br><pre> <code class="hljs erlang-repl">if (enabled &amp;&amp; opened &amp;&amp; !animating &amp;&amp; !selected &amp;&amp; finishedTransition &amp;&amp; !endOfTheWorld &amp;&amp; ...) { ... }</code> </pre> <br>  Vasya starts asking questions: how can it be that animating == true and enabled == false;  why is it all buggy from time to time;  How can you even understand the state of the menu?  Aha  <b>States ...</b> About them further, and will be discussed. <br><br>  Meet this Vasya. <br><br><img src="https://habrastorage.org/storage2/e26/f2a/c1f/e26f2ac1ff10bc14ff62f731067f358c.jpg"><br><a name="habracut"></a><br><h4>  condition </h4><br>  Vasya is already beginning to understand that many combinations of flags do not make sense, and the rest can be easily described with a couple of words, for example: <b>Disabled</b> , <b>Idle</b> , <b>Animating</b> , <b>Opened</b> .  We are all experienced programmers here, we immediately recall about state machines.  But, Vasya will have to tell what it is and why.  In simple language, without any mathematical terms. <br><br>  We have an object, for example, the aforementioned menu.  The object is always in one state and reacting to various events can move between these states.  Usually, states, events and transitions are conveniently described with such schemes (circles denote initial and final states): <br><br><img src="https://habrastorage.org/storage2/3ee/204/72c/3ee20472cd37bffa84b6f07290453975.gif"><br><br>  From the scheme it is clear that from the state <b>Inactive</b> to <b>Active</b> can be reached only by the <b>Begin</b> event, and from the state <b>Paused</b> one can get into both <b>Active</b> and <b>Inactive</b> .  For some reason, this simple concept is called the ‚ÄúState Machine‚Äù or the ‚ÄúFinite State Machine‚Äù, which is very frightening for ordinary people. <br><br>  According to the PLO covenant, the states should be hidden inside the object and just not accessible from the outside.  For example, an object during operation may have 20 different states, but the external API answers the question <i>‚Äúhow are you?‚Äù</i> Answers <i>‚Äúnothing so‚Äù</i> to 19 of them and only <i>foul language</i> on 1 that <i>all polymers are missed</i> . <br><br>  Following the concept of state machines, it is very easy to structure the code in such a way that it will always be clear what and how an object does.  It will always be clear that something went wrong if the system suddenly tried to go into a state inaccessible from this state.  And events that suddenly dared to come at the wrong time, you can safely ignore and not be afraid that something will break. <br><br><img src="https://habrastorage.org/storage2/b42/29e/7f9/b4229e7f97a83be08c5fe445c86d581c.jpg"><br><br><h4>  The world's easiest state machine </h4><br>  Suppose now Vasya is doing a project in C # and he needs a simple state machine for one type of objects.  He writes something like this: <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> State { Disabled, Idle, Animating } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> State state; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">State </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { state = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (state) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> State.Disabled: ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> State.Idle: ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> State.Animating : ... <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre><br>  And this is how it handles events depending on the current state: <br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">event1Handler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (state) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> State.Idle: ... <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre><br>  But, we are experienced programmers here, we all understand that the setState method will eventually grow into a couple of dozen pages, which (as it is written in textbooks) is not good. <br><br><h4>  State Pattern </h4><br>  Googling a couple of hours, Vasya decides that the <a href="http://en.wikipedia.org/wiki/State_pattern">State Pattern is</a> perfect in this situation.  Moreover, senior programmers are always competing who will stuff more patterns into their app, so, Vasya decides, patterns are important. <br><br>  For example, for a State Pattern, you can make an <b>IState</b> interface: <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IState</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Event1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Event2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre><br>  And on a separate class for each state that this interface is implemented.  In theory, it looks beautiful and 100% according to the textbook. <br><br>  But, first, for every unfortunate petty state machine you need to fence a lot of classes, which in itself is not fast.  Secondly, problems with access to shared data will begin sooner or later.  Where to store them?  Basically class?  How do state classes get access to them?  And how can I get a quick hack around the rules 15 minutes before the deadline?  And similar interaction problems that will greatly slow down the development. <br><br><h4>  Implementation based on language features </h4><br>  Some programming languages ‚Äã‚Äãfacilitate the solution of certain problems.  In Ruby, for example, so generally there is a whole DSL (and not one) for creating state machines.  And in C #, the state machine can be simplified through Reflection.  <a href="http://unitygems.com/fsm2/">Something like this</a> : <br><br><ol><li>  inherit from the class <i>FiniteStateMachine</i> , </li><li>  create methods called <b>stateName_eventName ()</b> that are automatically called when navigating through states and processing events </li></ol><br>  I really have much less code to write. <br><br>  Having implemented the system described above, Vasya understands that she, too, has more disadvantages than advantages: <br><br><ul><li>  It is necessary to inherit from the class FiniteStateMachine, </li><li>  In reactions to custom events, you also need to write large switch constructions, </li><li>  It is not possible to transfer parameters when the state changes. </li></ul><br><h4>  Framework </h4><br>  In the meantime, Vasya already began to delve into the theory of state machines and decided that it would be nice to be able to formally describe them via the API or (oh God) via XML, which sounds cool in theory.  We are experienced programmers here, we all understand that you need to write your own framework.  Because <a href="https://www.google.ru/search%3Fq%3Dstate%2Bmachine%2Bframework">others are</a> not suitable, since they all have one <a href="http://lurkmore.to/%25D0%25A4%25D0%25B0%25D1%2582%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BD%25D0%25B5%25D0%25B4%25D0%25BE%25D1%2581%25D1%2582%25D0%25B0%25D1%2582%25D0%25BE%25D0%25BA">fatal flaw</a> . <br><br>  Vasya decided that using his framework it would be possible to quickly and easily create a state machine without having to write a lot of unnecessary code.  The framework will not impose any restrictions on the developer.  Everyone around will be cheerful and cheerful. <br><br>  I tried many frameworks in different languages, I wrote a few of these myself.  And always to describe the finite state machine by means of the framework, more code was required than in a <b>simple example</b> .  All of them impose certain restrictions, and many are trying to do so much at once that in order to figure out how to create an uncomplicated state machine, you have to search the documentation for a long time. <br><br>  Here, for example, the description of a state machine by a <a href="http://code.google.com/p/stateless/">stateless</a> framework: <br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> phoneCall = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StateMachine&lt;State, Trigger&gt;<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">State.OffHook</span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">phoneCall</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">State.OffHook</span></span></span><span class="hljs-function">) .</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Permit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Trigger.CallDialed, State.Ringing</span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">phoneCall</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">State.Ringing</span></span></span><span class="hljs-function">) .</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Permit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Trigger.HungUp, State.OffHook</span></span></span><span class="hljs-function">) .</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Permit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Trigger.CallConnected, State.Connected</span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">phoneCall</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">State.Connected</span></span></span><span class="hljs-function">) .</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OnEntry</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="hljs-function">) =&gt;</span></span> StartCallTimer()) .OnExit(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> StopCallTimer()) .Permit(Trigger.LeftMessage, State.OffHook) .Permit(Trigger.HungUp, State.OffHook) .Permit(Trigger.PlacedOnHold, State.OnHold);</code> </pre><br>  But, making your way through the creation of a state machine, you can use the useful functions that the framework provides.  Basically they are: validation of transitions, synchronization of dependent state machines and sub-state machines and all kinds of protection against a fool. <br><br><h5>  XML </h5><br>  XML is a separate evil.  Someone once thought of using it to write configs.  A herd of lemming java developers for a long time praying for him.  And now, no one knows why everyone uses XML, but <a href="http://www.factroom.ru/facts/4763">continues to beat everyone who tries to get rid of it</a> . <br><br>  Vasya also got an idea that you can configure everything in XML and DO NOT WRITE ANY CODE LINE!  As a result, XML files of approximately the following content lie separately in its framework: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fsm</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Vending Machine"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">states</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">state</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"start"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">transition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">input</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nickel"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">next</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"five"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">transition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">input</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dime"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">next</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ten"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">transition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">input</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"quarter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">next</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"start"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dispense"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">state</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">state</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"five"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">transition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">input</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nickel"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">next</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ten"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">transition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">input</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dime"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">next</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fifteen"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">transition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">input</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"quarter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">next</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"start"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dispense"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">state</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">state</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ten"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">transition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">input</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nickel"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">next</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fifteen"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">transition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">input</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dime"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">next</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"twenty"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">transition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">input</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"quarter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">next</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"start"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dispense"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">state</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">states</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fsm</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Great!  And no programming.  But, we are experienced programmers here, we all understand that programming has not gone anywhere.  Vasya replaced a piece of imperative code with a piece of declarative code, adding an XML interpreter to the framework, which still complicated a couple of times.  And then try it otdebazhit when the code in different languages ‚Äã‚Äãand scattered on the project. <br><br><h4>  Agreement </h4><br>  And here Vasya got tired of all this and he went back to <i>the simplest finite state machine in the world</i> .  He redid it a bit and came up with the rules for how to write code in it. <br><br>  <b>UPDATE:</b> <i>thanks for the comments.</i>  <i>This really lacked a little explanation.</i> <br><br>  We have several states.  The transition between them is a transaction from atomic operations, that is, they all always happen together, in the correct order, and some other code cannot interpose between them.  When the state changes from A to B, the following happens: the exit code from the state A is executed, the state changes from A to B, the entry code to state B is executed <br><br>  To go to state A, you need to call the stateA method, which will execute the necessary logic and call setState (A).  Calling setState (A) yourself is highly discouraged. <br><br>  It turned out the following: <br><br><pre> <code class="hljs haskell">/** *    enum   ,     enums. */ private enum <span class="hljs-type"><span class="hljs-type">State</span></span> { <span class="hljs-type"><span class="hljs-type">Disabled</span></span>, <span class="hljs-type"><span class="hljs-type">Idle</span></span>, <span class="hljs-type"><span class="hljs-type">Animating</span></span> } /** *    . ,         . */ private <span class="hljs-type"><span class="hljs-type">State</span></span> state; /** *         state&lt; &gt;(). *                . *    setState(newValue)     . */ void stateDisabled() { switch (state) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">State</span></span>.<span class="hljs-type"><span class="hljs-type">Idle</span></span>: break; } setState(<span class="hljs-type"><span class="hljs-type">State</span></span>.<span class="hljs-type"><span class="hljs-type">Disabled</span></span>); // <span class="hljs-type"><span class="hljs-type">State</span></span> <span class="hljs-type"><span class="hljs-type">Disabled</span></span> enter logic } /** *       . * stateIdle(<span class="hljs-number"><span class="hljs-number">0</span></span>); */ void stateIdle(int <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">setState</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">State</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Idle</span></span></span><span class="hljs-class">); // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">State</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Idle</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">enter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">logic</span></span></span><span class="hljs-class"> } void stateAnimating() { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">setState</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">State</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Animating</span></span></span><span class="hljs-class">); // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">State</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Animating</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">enter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">logic</span></span></span><span class="hljs-class"> } /** *  setState    * state = value; *   prevState = state;     . * ,         . */ void setState(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">State</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">switch</span></span></span><span class="hljs-class"> ( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class"> ) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">State</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Animating</span></span></span><span class="hljs-class">: // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Animating</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">exit</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">logic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">break</span></span></span><span class="hljs-class">; // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">states</span></span></span><span class="hljs-class"> } state = value; } /** *     ,     . */ void event1Handler() { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">switch</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">State</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Idle</span></span></span><span class="hljs-class">: // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">state</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Idle</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">logic</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">break</span></span></span><span class="hljs-class">; // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">states</span></span></span><span class="hljs-class"> } }</span></span></code> </pre><br>  <b>UPDATE:</b> A unique exit logic is written to setState (), and a specific exit logic from state A is possible in stateB () when switching to B. But it is very rarely used. <br><br>  A simple convention for writing state machines.  It is quite flexible and has the following advantages: <br><br><ul><li>  almost all logic when changing states is in <i>stateA ()</i> methods, which allows you to break a giant switch into <i>setState ()</i> and make the code more readable, </li><li>  state change occurs only through <i>stateA ()</i> methods, which makes debugging easier, </li><li>  You can easily pass parameters to a new state, for example, if a book has a Page state, then you can switch to a new page simply by changing the state by calling <i>statePage (42)</i> </li><li>  In event handlers, it is always clear what logic is executed in which states, </li><li>  all team members know where to write logic to enter and exit the state, </li><li>  there is no need for any framework and pre-configuration of the finite state machine, </li><li>  There is an opportunity to dirty everything at the last moment, if absolutely no other way. </li></ul><br>  Another non-obvious advantage is the independence of the agreement from the language.  Moving from one platform to another, you do not have to rewrite your favorite framework into another language or look for a worthy replacement for it. <br><br>  As in all agreements, some code may first be in one place, but then it will have a different meaning, or it will appear that it is duplicated somewhere.  Then we can move it to another place.  Nobody forbids us.  Still, the code is not carved out of stone, it is just a text that (oh, horror!) Can and should be changed with the development of the project. <br><br>  <b>UPDATE:</b> <i>and setState () may well be replaced by a single setter for clarity.</i> <br><br><h4>  Conclusion </h4><br>  This ends the fascinating adventure of Vasya in the world of state machines.  But there is still so much interesting.  A separate topic would only deserve parallel and dependent state machines. <br><br>  I hope that if you are not yet using state machines everywhere, this article will drag you to the side of good;  If you write your UTF to work with state machines, it will help you to take a fresh look at what you get. <br><br>  I hope that this article will help developers to think about where and when to use patterns and frameworks, and that the described agreement on the design of state machines will be useful to someone. </div><p>Source: <a href="https://habr.com/ru/post/160105/">https://habr.com/ru/post/160105/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160083/index.html">The correct translation or how was the localization of the series "Stage"</a></li>
<li><a href="../160085/index.html">Groovy Validation DSL</a></li>
<li><a href="../160087/index.html">How to distribute iOS applications bypassing the AppStore</a></li>
<li><a href="../160089/index.html">The first two implications of staff interaction</a></li>
<li><a href="../160093/index.html">PHP extensions: some interesting features</a></li>
<li><a href="../160107/index.html">How I became a copywriter: Confession</a></li>
<li><a href="../160111/index.html">The appearance of dust on the matrix D600 in slow motion by a Canadian photographer</a></li>
<li><a href="../160113/index.html">The Manifesto of the Master / The Fixer's Manifesto</a></li>
<li><a href="../160115/index.html">Progress in the development of neural networks for machine learning</a></li>
<li><a href="../160117/index.html">Web API using the Django REST framework</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>