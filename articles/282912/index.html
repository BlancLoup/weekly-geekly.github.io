<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We send data from Arduino to Azure IoT Hub</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, I became the proud owner of Genuino MKR1000 . Resource Hackster.io together with Microsoft held a competition for the best idea. I ma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We send data from Arduino to Azure IoT Hub</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/d26/91e/42d/d2691e42d3c3470e90bbfa4e37cd30a9.png"></div><br><br>  Not so long ago, I became the proud owner of <a href="https://www.arduino.cc/en/Main/ArduinoMKR1000">Genuino MKR1000</a> .  Resource Hackster.io together with Microsoft held a competition for the best idea.  I may not have had time to bring my idea to life and take part in the second part of the competition, but I can share with you information that will help you realize your ideas.  Under the cut how to send data from the Arduino to the cloud and how to calculate it if you have a WiFi shield or MKR1000. <br><a name="habracut"></a><br><h4>  Azure setup </h4><br>  We go to portal.azure.com, click "+", select "Internet of things" - "IoT Hub" and invent the name of our hub.  I decided to call the hub simply and modestly - alexey.  Price category I chose a free S1 (per device). <br><br><img src="https://habrastorage.org/files/947/7b1/49c/9477b149c013427e8cc8e5fb43fe3042.PNG">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Actually, the hub configuration is complete on this.  You will still need to get the primary key, but this can be done later. <br><br><h4>  Arduino Setup </h4><br>  Install the necessary WiFi101 library: <br><br><img src="https://habrastorage.org/files/aca/9eb/e92/aca9ebe9239a434f884079b8560573d5.PNG"><br><br>  We need a version higher than 0.8, so if you already have an old library installed, update it. <br><br><img src="https://habrastorage.org/files/884/517/d42/884517d42fc84e2c9df22139af8e8600.PNG"><br><br>  Azure IoT Hub uses SSL for connection security.  But since the Arduino does not have enough memory to store an SSL certificate in it, we need to write it to the WiFi chip.  To do this, update the firmware version of WiFi101.  Download the <a href="">link</a> file Wifi101_FirmwareUpdater_windows.zip <br><br>  In the Arduino IDE, open the sketch File - Examples - WiFi101 - FirmwareUpdater.  Connect the MRK1000 and load the sketch.  Now the Arduino board is ready to receive firmware with a certificate. <br>  Unpack the Wifi101_FirmwareUpdater_windows zip archive, which we recently downloaded and run winc1500-uploader-gui.exe.  Enter the node address of our hub. <br><br><img src="https://habrastorage.org/files/ccc/6cd/a94/ccc6cda947de4c98be131215a56ba566.PNG"><br><br>  Click and select the COM port, then click "Upload certificate" <br><br><img src="https://habrastorage.org/files/3de/889/a54/3de889a541644c958d40e46b4e9e0ad9.PNG"><br><br>  It remains to wait for the certificate to be downloaded. <br><br><img src="https://habrastorage.org/files/8c3/a1b/77e/8c3a1b77e72041318f09af910273de62.PNG"><br><br>  Microsoft Azure IoT Hub uses <a href="https://azure.microsoft.com/ru-ru/documentation/articles/storage-dotnet-shared-access-signature-part-1/">Shared Access Signatures</a> . <br>  These are access signatures that can be used to work with an IoT Hub message queue without a password.  We need to create a SAS token.  In order not to do this in Arduino code, you can use the Device Explorer utility. <br>  Download the <a href="https://github.com/Azure/azure-iot-sdks/releases">link</a> SetupDeviceExplorer.msi file <br>  Install and run.  Go to the portal Azure in IoT Hub and click on the key in the upper right corner: <br><br><img src="https://habrastorage.org/files/e35/f43/a18/e35f43a181ce42ce81fe320697a2e4c6.PNG"><br><br>  Select iothubowner from the list and copy ‚ÄúConnection string - primary key‚Äù <br><br><img src="https://habrastorage.org/files/167/5d8/e58/1675d8e5829f4138bd0ce8d2e47f06f5.PNG"><br><br>  This line is entered into the Configuration tab of the Device Explorer application and click the Update button. <br><br><img src="https://habrastorage.org/files/ff7/5a9/2c6/ff75a92c64124b0a812ff6ed5cec8606.PNG"><br><br>  Go to the Management tab.  Here we can add a new device.  The Create button, create an ID for our device (I named my device myDevice) and click Create. <br><br><img src="https://habrastorage.org/files/cb0/925/f59/cb0925f595704a0c8248db2a3c526b29.PNG"><br><br>  Our device will appear in the list.  Select the string with it and click SAS Token ... <br>  Enter the interval of days and click Generate.  From the resulting token, we need only the part starting with ‚ÄúSharedAccessSignature sr =‚Äù (copy carefully, since the text SharedAccessSignature occurs 2 times in the line) <br><br><img src="https://habrastorage.org/files/743/07a/25c/74307a25c447409baaaf1a2f710d1355.PNG"><br><br>  An English manual on how to use the Device Explorer is here: <br>  <a href="">How to use Device Explorer for IoT Hub devices</a> <a href=""><br></a> <br><br><h4>  Arduino code </h4><br>  Consider the Arduino code.  Our title is: <br><br> <code>#include &lt;SPI.h&gt; <br> #include &lt;WiFi101.h&gt; <br> <br> char hostname[] = "alexey.azure-devices.net"; //   Azure IoT Hub <br> char authSAS[] = "SharedAccessSignature sr=alexey.azure-devices.net%2fdevices%2fmyDevice&amp;sig=D7OxGEm98bqAQDYk33d0DzPB92EuGMkjkzKBCsBBksc%3d&amp;se=1493799405"; // SAS token,    Device Explorer <br> String deviceName = "myDevice"; // ID   <br> char ssid[] = "myhomenet"; //     wi-fi <br> char pass[] = "password123"; //     <br> String uri = "/devices/myDevice/messages/events?api-version=2016-02-03"; <br> int status = WL_IDLE_STATUS; //    <br> WiFiSSLClient client; <br></code> <br>  The uri string will be different for sending and receiving data. <br>  If we got the data, the string would be <br>  <b>/ devices / myDevice / messages / devicebound? api-version = 2016-02-03</b> <br>  In addition to sending and receiving, it is possible <a href="https://msdn.microsoft.com/ru-ru/library/azure/mt590785.aspx">to complete / reject or reset a</a> message. <br>  In the setup, we only make a standard connection to the Wi-Fi network. <br><br> <code>void setup() { <br> Serial.begin(9600); <br> Serial.println("Setup begin"); <br> // check for the presence of the shield: <br> if (WiFi.status() == WL_NO_SHIELD) { <br> Serial.println(" Arduino  WiFi "); <br> while (true); //      <br> } <br> //     Wifi: <br> while ( status != WL_CONNECTED) { <br> Serial.print("     "); <br> Serial.println(ssid); <br> status = WiFi.begin(ssid, pass); <br> delay(10000); //  10     <br> } <br> Serial.println("Connected to Wi-Fi"); <br> } <br></code> <br>  We need a method that will send a string of text with a POST HTTP request to our site.  I don‚Äôt bother and send a string of text, although usually in the examples they generate and send json. <br><br> <code>void httpPost(String content) <br> { <br> client.stop(); //  ,     <br> if (client.connectSSL(hostname, 443)) { <br> client.print("POST "); <br> client.print(uri); <br> client.println(" HTTP/1.1"); <br> client.print("Host: "); <br> client.println(hostname); <br> client.print("Authorization: "); <br> client.println(authSAS); <br> client.println("Connection: close"); <br> client.print("Content-Type: "); <br> client.println("text/plain"); <br> client.print("Content-Length: "); <br> client.println(content.length()); <br> client.println(); <br> client.println(content); <br> delay(200); <br> } else { <br> Serial.println("HTTP POST  "); <br> } <br> } <br></code> <br>  Now in order to send a string of text, just call the method <br><br> <code>httpPost("Some message from Arduino"); <br></code> <br>  But we also consider the answer to ensure that the data are safely received <br><br> <code>httpPost("Some message from Arduino"); <br> String response = ""; <br> char c; <br> while (client.available()) { <br> c = client.read(); <br> response.concat(c); <br> } <br> if (!response.equals("")) <br> { <br> if (response.startsWith("HTTP/1.1 204")) { <br> Serial.println("    Azure"); <br> } else { <br> Serial.println(""); <br> Serial.println(response); <br> } <br> } <br></code> <br>  All code you can download from <a href="https://github.com/programmersommer/Arduino_Azure_IoT_Hub">github</a> <br><br><h4>  Console application that reads data from the IoT Hub message queue </h4><br>  Create a console application. <br>  Open the NuGet Package Manager, look for the <b>WindowsAzure.ServiceBus</b> and install. <br>  Add a pair of namespace: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.ServiceBus.Messaging; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading;</code> </pre><br>  And announcements: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> connectionString = <span class="hljs-string"><span class="hljs-string">"HostName=alexey.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=xrzUfBj8gaq2i310MhRCcSEs08t3lk7zbCNI4Tltqp4="</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> iotHubD2cEndpoint = <span class="hljs-string"><span class="hljs-string">"messages/events"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> EventHubClient eventHubClient;</code> </pre><br>  Here you can notice that with the connectionString value I entered the value obtained from the Azure portal - this is the "Connection string - primary key".  Add the following method: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReceiveMessagesFromDeviceAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> partition, CancellationToken ct</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> eventHubReceiver = eventHubClient.GetDefaultConsumerGroup().CreateReceiver(partition, DateTime.UtcNow); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ct.IsCancellationRequested) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; EventData eventData = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> eventHubReceiver.ReceiveAsync(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eventData == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> data = Encoding.UTF8.GetString(eventData.GetBytes()); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Message received. Partition: {0} Data: '{1}'"</span></span>, partition, data); } }</code> </pre><br>  and finally add the code to Main: <br><br><pre> <code class="cs hljs">Console.WriteLine(<span class="hljs-string"><span class="hljs-string">" . Ctrl-C  .\n"</span></span>); eventHubClient = EventHubClient.CreateFromConnectionString(connectionString, iotHubD2cEndpoint); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> d2cPartitions = eventHubClient.GetRuntimeInformation().PartitionIds; CancellationTokenSource cts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CancellationTokenSource(); System.Console.CancelKeyPress += (s, e) =&gt; { e.Cancel = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; cts.Cancel(); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"..."</span></span>); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tasks = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Task&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> partition <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> d2cPartitions) { tasks.Add(ReceiveMessagesFromDeviceAsync(partition, cts.Token)); } Task.WaitAll(tasks.ToArray());</code> </pre><br>  If you run this console application, you can read messages sent by the included Arduino board. <br><br>  UPDATE: Since this sending via HTTP is far from ideal, it is better to use the Arduino SDK port called <a href="https://github.com/Azure/azure-iot-arduino">Azure IoT Hub library for Arduino</a> <br><br><h4>  Useful links: </h4><br>  <a href="https://azure.microsoft.com/ru-ru/documentation/articles/iot-hub-csharp-csharp-getstarted/">Get started with Azure IoT using .NET</a> <br>  <a href="http://mohanp.com/mkr1000-azure-iot-hub-how-to/">MKR1000 Azure IoT Hub Interface Using HTTP</a> <br>  <a href="https://create.arduino.cc/projecthub/doncoleman/mkr1000-temp-and-humidity-sensor-8f22ed">MKR1000 Temp and Humidity Sensor</a> </div><p>Source: <a href="https://habr.com/ru/post/282912/">https://habr.com/ru/post/282912/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282900/index.html">Notes with MBC Symposium: more about saddle points</a></li>
<li><a href="../282902/index.html">Delphi. What does TDictionary</a></li>
<li><a href="../282906/index.html">Administrators of groups in vk have always been in the public domain.</a></li>
<li><a href="../282908/index.html">Virtual IT Infrastructure: Pros and Cons</a></li>
<li><a href="../282910/index.html">NB-IoT: narrow band - broad prospects</a></li>
<li><a href="../282914/index.html">Writing the background process on Apache Cordova</a></li>
<li><a href="../282916/index.html">IMAPSync. Transfer mail between servers</a></li>
<li><a href="../282918/index.html">Performance Indicators: KVM vs. Xen</a></li>
<li><a href="../282922/index.html">Work with WAV files using PHP</a></li>
<li><a href="../282924/index.html">Test Gradle Plugins Correctly</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>