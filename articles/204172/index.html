<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple GStreamer audio player</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I needed to implement a small audio player. I, for various reasons, chose the Gstreamer library. And so I decided to share the knowledge gai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple GStreamer audio player</h1><div class="post__text post__text-html js-mediator-article">  Recently, I needed to implement a small audio player.  I, for various reasons, chose the Gstreamer library.  And so I decided to share the knowledge gained.  I hope the information below will be useful to someone. <br><a name="habracut"></a><br><h4>  So, let's begin </h4><br><h5>  First of all, let's get to the bottom of the basic concepts in Gstreamer </h5><br>  The element is the most important class of objects in Gstreamer.  They can unite in a chain and create a so-called channel (pipeline).  Each element has a strictly defined function: reading a file, entering or outputting data, etc. <br><br>  Nests (pads) - used to transfer data between elements.  In each element can be from one and above nests. <br><br>  Element container (Bin) - combines a chain of elements.  With this container, you can manage the elements as one unit. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The channel (pipeline) is similar to bins, except that the location of the elements it contains containers of elements. <br><br>  Read more about all this in the <a href="http://gstreamer.freedesktop.org/documentation/">documentation</a> . <br><br><h5>  We now turn to the implementation of our class. </h5><br>  This is how the class of our audio player looks like: <br><br><div class="spoiler">  <b class="spoiler_title">audioengine.h</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> AUDIOENGINE_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> AUDIOENGINE_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;gst/gst.h&gt; #include &lt;glib.h&gt; #include &lt;QObject&gt; class AudioEngine : public QObject { Q_OBJECT public: AudioEngine(QObject *parent = 0); ~AudioEngine(); int Init(); void MusicPlay(); void MusicPaused(); void MusicStop(); void AddFile(char *file); void SetVolume(gdouble val); gint64 GetMusicPosition(); gint64 GetMusicDuration(); void SetMusicPosition(gint64 pos); private: GstElement *pipeline; GstElement *source; GstElement *volume; gint64 pos; static void OnPadAdded(GstElement *element, GstPad *pad, gpointer data); private slots: }; #endif // AUDIOENGINE_H</span></span></span></span></code> </pre> <br></div></div><br><br>  In the Init () function, we initialize the Gstreamer library: <br><br><pre> <code class="cpp hljs">gst_init(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br>  This function accepts argv and argc command line arguments, in our case they can be omitted. <br><br>  Next, create a channel: <br><br><pre> <code class="cpp hljs">pipeline = gst_pipeline_new(<span class="hljs-string"><span class="hljs-string">"audio-player"</span></span>);</code> </pre><br>  and the elements we need: <br><br><pre> <code class="cpp hljs">source = gst_element_factory_make(<span class="hljs-string"><span class="hljs-string">"filesrc"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); demuxer = gst_element_factory_make(<span class="hljs-string"><span class="hljs-string">"decodebin"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); decoder = gst_element_factory_make(<span class="hljs-string"><span class="hljs-string">"audioconvert"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); volume = gst_element_factory_make(<span class="hljs-string"><span class="hljs-string">"volume"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); conv = gst_element_factory_make(<span class="hljs-string"><span class="hljs-string">"audioconvert"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); sink = gst_element_factory_make(<span class="hljs-string"><span class="hljs-string">"autoaudiosink"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>);</code> </pre><br>  Element source - designed to read audio files. <br>  demuxer - used to decode an audio file. <br>  decoder and conv - to convert an audio file to another format. <br>  volume - designed to control the sound volume. <br>  sinc - automatically detects the audio device and outputs data to it ... <br><br>  It should be noted that the demuxer creates sockets for each stream element and we will have to install an event handler to associate the demuxer with the decoder.  The OnPadAdded () function will help us with this. <br><br>  The event handler in our code looks like this: <br><br><pre> <code class="cpp hljs">g_signal_connect(demuxer, <span class="hljs-string"><span class="hljs-string">"pad-added"</span></span>, G_CALLBACK(OnPadAdded), decoder);</code> </pre><br>  Add all created items to the channel: <br><br><pre> <code class="cpp hljs">gst_bin_add_many (GST_BIN (pipeline), source, demuxer, decoder, volume, conv, sink, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>);</code> </pre><br>  and link the elements together. <br><br><pre> <code class="cpp hljs">gst_element_link (source, demuxer); gst_element_link_many (decoder, volume, conv, sink, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>);</code> </pre><br>  The function for adding a file to the player looks like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AudioEngine::AddFile(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *file) { g_object_set(G_OBJECT(source), <span class="hljs-string"><span class="hljs-string">"location"</span></span>, file, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); }</code> </pre><br>  The g_object_set () function passes arguments to the source element.  In this case, the location argument tells us that the audio file is on the local machine, file is the path to our file.  The last parameter NULL tells us that the element no longer needs any arguments. <br><br>  Functions to start, stop playback look like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AudioEngine::AddFile(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *file) { g_object_set(G_OBJECT(source), <span class="hljs-string"><span class="hljs-string">"location"</span></span>, file, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AudioEngine::MusicPlay() { gst_element_set_state(pipeline, GST_STATE_PLAYING); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AudioEngine::MusicPaused() { gst_element_set_state(pipeline, GST_STATE_PAUSED); }</code> </pre><br>  here everything seems to be clear. <br><br>  Function for volume control: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AudioEngine::SetVolume(gdouble val) { g_object_set(G_OBJECT(volume), <span class="hljs-string"><span class="hljs-string">"volume"</span></span>, val, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); }</code> </pre><br>  Functions for to get the duration of the track and its current position: <br><br><pre> <code class="cpp hljs">gint64 AudioEngine::GetMusicDuration() { gint64 len; gst_element_query_duration(pipeline, GST_FORMAT_TIME, &amp;len); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> len; } gint64 AudioEngine::GetMusicPosition() { gint64 pos; gst_element_query_position(pipeline, GST_FORMAT_TIME, &amp;pos); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pos; }</code> </pre><br>  it should be borne in mind that functions return time values ‚Äã‚Äãin nanoseconds. <br><br>  And finally, the function to change the position of the track: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AudioEngine::SetMusicPosition(gint64 pos) { gst_element_set_state(pipeline, GST_STATE_PAUSED); gst_element_seek_simple(pipeline, GST_FORMAT_TIME, GST_SEEK_FLAG_FLUSH, pos); gst_element_set_state(pipeline, GST_STATE_PLAYING); }</code> </pre><br>  in order to change the position, we will have to stop the playback, and after the change, we will again start it. <br>  gst_element_seek_simple () takes our channel as arguments, time format, position search flag, and position itself, which is measured in nanoseconds. <br><br>  The full code is listed below by reference in a place with a small GUI implemented in Qt. <br>  <a href="https://github.com/TriKrista/GstPlayer-example">Sources on GitHab</a> <br><br>  Thanks to all. </div><p>Source: <a href="https://habr.com/ru/post/204172/">https://habr.com/ru/post/204172/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../204162/index.html">TempusJS - working with the date in javascript</a></li>
<li><a href="../204164/index.html">How users interact with mobile devices</a></li>
<li><a href="../204166/index.html">Magento. Process of loading configuration files</a></li>
<li><a href="../204168/index.html">Is it possible to become a programmer after 30?</a></li>
<li><a href="../204170/index.html">Will Angular.js and Facebook Login be able to make friends?</a></li>
<li><a href="../204174/index.html">Gottfried Svartholm is a defendant in the case of rutor.org</a></li>
<li><a href="../204176/index.html">Writing a plugin for CKEditor 4</a></li>
<li><a href="../204178/index.html">News: Jolla introduced its first smartphone on Sailfish OS. Price ‚Ç¨ 399</a></li>
<li><a href="../204180/index.html">Intel: server component life shortened due to environmental pollution</a></li>
<li><a href="../204184/index.html">Smartphone Lexand Vega: a pleasant "budget" on the platform MediaTek MT6572</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>