<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tcl for Cisco IOS in simple examples</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Imagine that you need to deploy from scratch a dozen of similar Cisco access switches. Typical configurations include hostname and domain name, defaul...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tcl for Cisco IOS in simple examples</h1><div class="post__text post__text-html js-mediator-article">  Imagine that you need to deploy from scratch a dozen of similar Cisco access switches.  Typical configurations include hostname and domain name, default gateway, passwords, user list, IP addresses for SVI, VLAN numbers, uplink trunk settings, etc.  To enter it every time with hands is very long and unproductive.  Of course, you can create a typical config and upload it via (T) FTP, but, first, it will require at least the minimum configuration from the console, and secondly, the configuration parameters that are changed will still have to be changed.  To solve such (and many other) tasks, Cisco IOS contains a powerful automation tool ‚Äî the built-in Tcl interpreter (Cisco IOS scripting w / Tcl). <br><a name="habracut"></a><br><h2>  What is Tcl </h2><br>  Tcl (read ‚Äútickle‚Äù, sometimes ‚Äúflowed‚Äù) is an interpreted programming language developed in the late 80s for embedding into console applications.  The range of capabilities of modern Tcl is quite wide: here it supports OOP, developed regexp tools, dynamic arrays, etc. <br><br>  Support for this language first appeared on the Cisco IOS 12.2 (3) T platform (in some sources it is indicated at 12.3 (2), but I did not find confirmation of this) and currently has several options: <br><br><ul><li>  Tcl command line interpreter.  Built into various versions of the Cisco IOS platform, including IOS XE and XR, and is available for a wide range of devices.  Allows you to run Tcl commands, run pre-made scripts as files, etc.  Devices that use not the IOS as the operating system, for example, Cat OS or ASA (in the same firewall), do not contain an interpreter command line. </li><li>  T.N.  ‚ÄúEmbedded event manager‚Äù or EEM is an event tracking system that allows you to automatically respond to them in real time.  For example, monitor a remote host with an e-mail notification.  EEM scripts (applets) are written to Tcl, but EEM itself does not provide a separate Tcl command line.  Example of use, see <a href="https://habr.com/ru/post/91879/">here</a> .  EEM is available on the Nexus platform (NX OS) and ASA from version 9.2 (1) and above. </li><li>  Voice menu systems IVR (Interactive Voice Responce). </li></ul><br>  How to determine the presence of the command interpreter knowing the device model or version of IOS?  There is <a href="https://cfn.cloudapps.cisco.com/ITDIT/CFN/">Cisco Feature Navigator for this</a> : 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/go/kw/vg/gokwvg43agxltlunw5b6kv8pb5k.png" alt="image"><br><br>  The <b>Research Features</b> menu item allows you to select a specific IOS version for a given IOS Train Release or a specific hardware platform.  The <b>Research Software</b> menu item allows you to find all IOS versions with Tcl support for a given hardware.  Click, filter the Filter by field by name (Feature name) ‚ÄúCisco IOS scripting w / Tcl‚Äù (or simply ‚ÄúTcl‚Äù), add the name of the feature to the list, select Train release and get a list of all IOS versions containing this feature: <br><br><img src="https://habrastorage.org/webt/ko/py/aa/kopyaaihxbytr7a5qdcptq5jhtw.png"><br><br>  Unfortunately, the CFN database is incomplete and sometimes does not show all the information.  So, for the CAT2960S platform, the navigator showed the presence of Tcl in the IOS 15.2E1 release and did not show in the 15.2E9 release, although in fact the Tcl interpreter is both there and there. <br><br>  So what can I do in Cisco IOS using Tcl?  Quite a lot: view and change configuration, create interactive scripts, operate with MIB objects, TCP and UDP sockets, and even ... <a href="https://habr.com/ru/post/157371/">write a whole web shell!</a> <br><br>  In general, a Tcl program contains a sequence of commands, separated by a newline or semicolon.  Example not requiring explanation: <br><br><pre><code class="plaintext hljs">puts "Hello, world!"; puts "My first Tcl IOS script!"</code> </pre> <br>  Some operators: <br><br>  <code>#</code> comment to end of line <br>  <code>set a 1</code> assignment a = 1 <br>  <code>$a</code> get the value of a variable <br>  <code>{ }</code> block operator - defines the body of the cycle or conditions <br>  <code>[ ]</code> substitution statement - when executed, instead of square brackets, the calculated value of the expression they contain will be substituted <br>  <code>== &lt;= &lt;&gt;</code> comparison operators <br>  <code>puts "text"</code> displays the string "text" on stdout (i.e., on the console) <br>  <code>puts $a</code> same for variable a <br>  <code>gets stdin</code> reads values ‚Äã‚Äãfrom console <br>  <code>set a [gets stdin]</code> enter a value from the console and assign it to the variable a <br>  <code>for {set i 1} {$i &lt; 10} {inrc i} {....}</code> for loop <br>  <code>proc {argument, ....} {body}</code> procedure <br><br>  For a complete list, see <a href="http://progopedia.ru/language/tcl/">progopedia.ru/language/tcl</a> <br><br>  The Tcl interpreter is started by the tclsh command from the priveleged EXEC mode: <br><br><pre> <code class="plaintext hljs">sw#Tclsh sw(tcl)#</code> </pre> <br>  Run the first script: <br><br><img src="https://habrastorage.org/webt/na/mh/bo/namhbouiixicygisd6mgjejgwsc.png" alt="image"><br><br>  The output from the interpreter is the <code>tclquit</code> command or just exit.  Tcl is case sensitive, so <code>Puts "Hello, world"</code> will cause an error, but the IOS shell command register is unimportant.  All commands entered are first processed by the Tcl interpreter, if the command entered is executable from that.  Tcl, it is executed and the result is output to a TTY device.  If the command cannot be executed by the interpreter, it is passed to the IOS command parser.  Thus, a single script can combine Tcl statements and IOS commands.  The IOS environment does not contain a full-fledged text editor, therefore, pre-defined scripts need to be created by external means and only then copied to flash or to memory.  It also supports precompiling the script into bytecode and then launching it.  Running a file with a script for execution is performed by the command <br><br><pre> <code class="plaintext hljs">tclsh flash:filename</code> </pre> <br>  Multiple Tcl interpreter sessions from different TTY sessions are allowed. <br><br>  Tcl interpreter internal commands: <br>  <b>exec</b> - executes the command in quotes from the IOS CLI set priveleged EXEC. <br>  <code>sw(tcl)#exec "show int fa0"</code> will display: <br><br><img src="https://habrastorage.org/webt/xs/78/up/xs78upuw2tbpujftowk8ceh0xd0.png" alt="image"><br><br>  <b>ios-config</b> - executes a command from global configuration mode.  Behind it, all subsequent sub-configuration commands are specified in separate double quotes.  For example: <br> <code>sw(tcl)#ios_config "int fa0" "ip address 192.168.0.1 255.255.255.0" "no shut"</code> <br>  equivalent to a series of IOS commands: <br><br><pre> <code class="plaintext hljs">sw#conf te sw(config)#int fa0 sw(conf-int)#ip address 192.168.0.1 255.255.255.0 sw(conf-int)#no shut</code> </pre> <br>  The Tcl interpreter prevents exec processes from directly interacting with the console.  Therefore, data transfer to exec processes running from the Tcl shell is done using the <b>typeahead command</b> : <br> <code>typeahead "y\ny" <br> exec "reload" <br></code> <br>  First, two ‚Äúy‚Äù characters will be saved in the input buffer, separated by a line break (\ n), then the exload reload command will be run, which reads from the input buffer the cancel or confirm reload command and, if necessary, save the configuration. <br><br>  Tickle does not support typing, it must be remembered when operating with variables: <br><br><img src="https://habrastorage.org/webt/ok/-o/ew/ok-oewwhgz0fbdqdzcgisf9skmm.png" alt="image"><br><br>  The nested operator <code>[expr {..}]</code> calculate the value of the expression specified in curly brackets ($ a + $ b) and perform the substitution of this value instead of square brackets. <br><br>  Sample procedure in Tcl: <br> <code>proc ping_net {x} { <br> for {set n 1} {$n &lt; $x} {incr n} { <br> exec "ping 192.168.0.$n" <br> } <br> }</code> <br>  when entering a curly bracket, the interpreter will not close the command line until a pair of closing brackets is entered.  The procedure is stored in the interpreter's memory until the interpreter session is terminated with the tclquit command.  This makes it possible to run procedures and access variables of previously running scripts.  Remember that an error in the script can lead to looping and locking your session (V) TTY!  The console does not have emergency shutdown tools (such as Ctrl + Break), the only way is a new session and resetting a hung session with the <code>clear line</code> command. <br><br>  We now turn to solving a practical problem.  Before us is the 48-port Cat2950S "out of the box."  Script below <br><br><ul><li>  requests from the console the serial number of the switch sw_num </li><li>  sets hostname of the form switch_ &lt;sw_num&gt; </li><li>  requests and sets a password to the priveleged EXEC console </li><li>  adjusts the address on its control interface Fa0 (192.168.0.x) and interface Vlan1 (10.0.x.254) according to the entered switch number </li><li>  creates a port-based DHCP reservation and a pool of 48 addresses in which one IP address is reserved for each client, the low octet of which is equal to the serial number of the port through which this client is connected. </li></ul><br><pre> <code class="plaintext hljs">puts "Enter Switch number:" set sw_num [gets stdin] ios_config "hostname switch_$sw_num" puts "Enter password (secret):" set pass [gets stdin] ios_config "enable secret 0 $pass" ios_config "line 0 16" "password 0 $pass" "login" ios_config "int fa0" "ip address 192.168.0.$sw_num 255.255.255.0" "no shut" ios_config "int vlan1" "ip address 10.0.$sw_num.254 255.0.0.0" "no shut" ios_config "ip dhcp use subscriber-id client-id" ios_config "ip dhcp subscriber-id interface-name" #    48       subscriber-id for {set i 1} {$i &lt;= 48} {incr i} {ios_config "int Gi1/0/$i" "ip dhcp server use subscriber-id client-id"} ios_config "ip dhcp pool POOL1" "network 10.0.0.0 255.0.0.0" "reserved-only" "default-router 10.10.0.254" #    48  IP-,   .  for {set i 1} {$i &lt;= 48} {incr i} {ios_config "ip dhcp pool POOL1" "address 10.0.$sw_num.$i client-id Gi1/0/$i ascii"} #</code> </pre> <br>  Note 1. This script has a small logical error.  Try to find it. <br><br>  Note 2. Some text editors like to put an unprintable EoF character at the end of a file.  You can see it in the IOS console by displaying the contents of the file with the command cat or more.  Stumbling on EoF, the Tcl interpreter will generate an error and ignore the entire line.  Therefore, I left a comment at the end of the script. <br><br>  The question arises: how to write the script in the memory of the switch with unconfigured IP working only through the console port?  Do not type the script with your hands!  Is it possible to manually configure the Management Interface and use FTP every time?  No, it can be easier.  Cisco IOS can copy files directly through the serial port of the console via the Xmodem protocol and save them to the flash.  To do this, you will need a terminal emulator with Xmodem support, for example, ZOC or Tera Term (but the popular free Putty, alas, will not work!).  Copying is performed by the IOS <i>copy xmodem: flash: filename</i> command, after which you need to perform File Transfer in the terminal emulator menu: <br><br><img src="https://habrastorage.org/webt/as/mx/l1/asmxl1uza1gqpdstctvhyrnq-ac.png" alt="image"><br><br>  This can also be done while in ROMmon (for example, if you ‚Äúdemolish‚Äù the switch configuration without having a password on the priveleged EXEC).  But the reverse copying of files (from the flash memory of the switch on the PC) is not supported. <br><br>  Unfortunately, you cannot open a telnet session from a Tcl to a remote router.  Upon attempt <br>  <code>sw(tclsh)#exec "telnet host"</code> session just hangs during password input. <br><br>  This concludes the introduction of the Tcl language capabilities on the Cisco IOS platform, you can explore the issue in more detail in the Cisco IOS Scripting with TCL Configuration Guide available on the Cisco website. </div><p>Source: <a href="https://habr.com/ru/post/455401/">https://habr.com/ru/post/455401/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../45539/index.html">The Japanese have released a browser with three engines</a></li>
<li><a href="../455391/index.html">RISC-V: RocketChip in unnatural habitat</a></li>
<li><a href="../455393/index.html">On the application of parametric spectral estimation methods in radar - the method MUSIC. Addition to the article</a></li>
<li><a href="../455397/index.html">How we designed and implemented a new network on Huawei in the Moscow office, part 1</a></li>
<li><a href="../4554/index.html">Spammers call on the stock exchange and continue to use the GIF</a></li>
<li><a href="../455403/index.html">From five cents to the game of deities</a></li>
<li><a href="../455405/index.html">How a small program turned a small office into a federal company with a profit of 100+ million rubles / month</a></li>
<li><a href="../455407/index.html">Electric cars and peak fuel car sales</a></li>
<li><a href="../455409/index.html">backward compatibility</a></li>
<li><a href="../455411/index.html">Megaphone conducted a technical update ... network name</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>