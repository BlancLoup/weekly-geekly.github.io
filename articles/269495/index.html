<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Extreme economy fonts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Very long, small bitmap fonts were the scourge of KolibriOS. But relatively recently, another developer, Pathoswithin, joined the project. Quickly ori...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Extreme economy fonts</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/332/ac0/97c/332ac097cb7bfba245943a942c69f564.png" align="left">  Very long, small bitmap fonts were the scourge of KolibriOS.  But relatively recently, another developer, <b>Pathoswithin,</b> joined the project.  Quickly oriented in the project, he took up the solution to this problem.  The results of his work, you can see in the latest nightly builds.  Well, this article is a narration about working on fonts, written by <b>Pathoswithin</b> himself. <br><a name="habracut"></a><br><br>  Each character of the font is called a "glyph."  In fact, this is a regular image.  Are there many problems with drawing pictures?  At least two.  First of all, the font should scale, and if you can still reduce it, then nothing good will come out of the increase. <br><br><img src="https://habrastorage.org/files/540/89f/caa/54089fcaa0fe41ec970bce06d538146c.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Thus, glyphs must initially have a high resolution, and to achieve maximum quality, several sets of different sizes are needed.  And okay, if the font is 256 characters.  And if?  Such a font will take a lot of memory, even by modern standards. <br><br>  A bitmap image stores the colors of each point.  But why, if you can store a description of how to draw the glyph.  Fortunately, the fonts fit perfectly into the principles of vector graphics.  In this case, it is enough to indicate the coordinates of several points between which you need to draw straight lines;  Maximum - parameters for drawing a curve.  Since almost all points are drawn on the fly, such glyphs are not tied to a specific resolution, and take up much less memory. <br><br><img src="https://habrastorage.org/files/c13/17f/7cb/c1317f7cb79b4f7eabdcb7f58021c4df.PNG"><br><br>  The second problem: reduction, including smoothing, is to use halftone.  This gives an excellent result for photographs, but the glyph is a contrast image, most often a black symbol on a white background, and when gray shades appear, it looks blurry.  On the other hand, it is impossible to beautifully draw a small character using only two colors. <br><br>  To solve this problem, the features of LCD monitors are used.  Each pixel of the screen in the horizontal direction consists of three subpixels: red, green and blue.  The combination of different brightness of these colors forms all the others.  They are encoded in the same way, which makes it easy to manage sub-pixels separately.  Moreover, if the difference between their brightness is not too high, the colors of the neighboring pixels may merge.  This principle underlies the ‚ÄúClearType‚Äù smoothing technology: the glyphs are drawn in a threefold horizontal resolution, the pixels are equal to subpixels and their brightness is determined by taking into account 4 neighbors.  In fact, the color blur is made with a diameter of 5 subpixels, the classic ratio is 1/2/3/2/1. <br><br><img src="https://habrastorage.org/files/34b/d2a/3c0/34bd2a3c032e41ef8faa4a12ccbfcfbd.png"><br><br>  MenuetOS used a tiny bitmap font with a 6x9 glyph resolution.  Each pixel is described by one bit, a line byte, 9 bytes for each of 256 glyphs, total font size is 2 kb.  It only looks good with a screen resolution of no more than 800x600.  In KolibriOS, they repeatedly tried to use vector fonts, but both problems stood up. <br><br>  With the exception of the kernel, writing under KOS is possible not only in assembly language.  But in order to remain small, fast and not turn into Linux, the main distribution is a 1.4 MB floppy disk image.  For some, this is a psychological barrier, for others - a banal fence.  Vector fonts can save size compared to huge raster ones, but still take up much more than 2 kb.  It will be a shame to use a font larger than the kernel with drivers and graphics. <br><br>  Also, in any open OS there are problems with drivers for video cards.  Nvidia and ATI are still a mafia, they sell hardware, but they don‚Äôt explain how to communicate with them in the absence of Windows.  Fortunately, there is VESA BIOS Extensions, which at least allows you to set the normal screen resolution, but writing translucent pixels in video memory is not.  So you need to manually read a pixel from there, mix the colors in the right ratio, and write them back.  The frequency of communication with video memory is high, but there are big delays from the beginning of the transfer to the result.  Writing works quickly, but when reading you need to wait a lot until the requested pixel is delivered.  For example, creating a screenshot in this mode takes more than a second.  Since anti-aliasing is based on blending the background pixels with the color of the glyph, drawing vector fonts on the screen becomes an extremely slow process.  Without anti-aliasing, they either require additional data for hinting, or look worse than raster. <br><br><img src="https://habrastorage.org/files/336/268/de9/336268de91d44bb48ad780c64946a5c1.png"><br><br>  In the best traditions of low-level programming, I asked the question "How to get the maximum at minimum cost?", And decided to try to squeeze more out of what is.  With a simple magnification, the symbols consist of squares and right angles (although some connoisseurs of cubism like this style), but if you finish the points in the right places, then angles of 45 or even 30 degrees will appear.  I was inspired by the image smoothing algorithm, optionally presented in <a href="http://armorgames.com/play/17682/the-enchanted-cave-2">this</a> ‚Äúpixel‚Äù game.  However, existing implementations do not really cope with single-pixel thickness fonts. <br>  For example, the result of the work hqx: <br><br><img src="https://habrastorage.org/files/79f/9cc/4f6/79f9cc4f6ff449aa8e2d4fbd2eedecea.png"><br><br>  As a result, I created my own algorithm, designed specifically for small raster fonts, and called it Anti Eye Bleeding, for neither more nor less. <br><br><img src="https://habrastorage.org/files/a86/f79/901/a86f79901cd445c9a620d2b50522cfde.PNG"><br><br>  You can follow the evolution of the algorithm on our <a href="http://board.kolibrios.org/viewtopic.php%3Ff%3D36%26t%3D3084">forum</a> . <br><br>  Using general principles, it produces a multiple increase or smoothing (the choice is regular or subpixel with a precalculated ratio).  In the case of anti-aliasing, only a few individual pixels are subject to mixing, which allows to achieve acceptable performance.  It is written in assembler and integrated into the core KolibriOS, as a basic tool.  Also, I added a 8x16 font to the kernel for 1400 Unicode characters, 22 kb in size (without compression), which caused it to burn up to 188 kb (92 kb after compression). <br><br>  Immediately after turning on system-wide anti-aliasing, one feature emerged: when drawing text, you must erase the previous one, otherwise the intensity of mixed pixels increases with each redraw.  In some programs, the "obesity" of the text can be found so far. <br><br>  The main problem remains scaling with a fractional multiplier.  I tried to write a library in which ClearType is used to reduce to the right size after a multiple increase, but the result remains controversial.  However, you can help evaluate it: <br><br><img src="https://habrastorage.org/files/3d9/b35/c69/3d9b35c69e28469b80f3f9a514fc48a1.bmp"></div><p>Source: <a href="https://habr.com/ru/post/269495/">https://habr.com/ru/post/269495/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269481/index.html">I am writing a CMS for PHP. Part 2</a></li>
<li><a href="../269487/index.html">The digest of interesting materials for the mobile developer # 126 (October 19-25)</a></li>
<li><a href="../269489/index.html">How to make friends AWS Lambda and PostgreSQL</a></li>
<li><a href="../269491/index.html">Android 6.0: Doze Mode, App Standby, Runtime Permissions. Everything every developer needs to know</a></li>
<li><a href="../269493/index.html">Taming of the Shrew. We connect a single number to several mobile</a></li>
<li><a href="../269497/index.html">Recursive queries in PostgreSQL (WITH RECURSIVE)</a></li>
<li><a href="../269499/index.html">ASP.NET MVC integration with Sharepoint 2013. Part 2: Interact with SharePoint</a></li>
<li><a href="../269501/index.html">SparkleFormation - CloudFormation template generator with rainbows and unicorns.</a></li>
<li><a href="../269503/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ182 (October 19 - 25, 2015)</a></li>
<li><a href="../269505/index.html">Rapid Java Reporting Development: Downshifting from 1C: Enterprise</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>