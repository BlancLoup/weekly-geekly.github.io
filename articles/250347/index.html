<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Password cracking on Mac with Arduino and OpenCV</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How to break poppy password with Arduino and OpenCV. Based on the article Brutforsim EFI with Arduino . 



 Story 
 It all started as usual - my frie...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Password cracking on Mac with Arduino and OpenCV</h1><div class="post__text post__text-html js-mediator-article">  How to break poppy password with Arduino and OpenCV.  Based on the article <a href="http://habrahabr.ru/post/240291/">Brutforsim EFI with Arduino</a> . <br><br><img src="https://habrastorage.org/files/e0d/b43/aed/e0db43aed0934be19cbacd8ae4f98355.jpg"><br><a name="habracut"></a><br><h4>  Story </h4><br>  It all started as usual - my friend was blocked by Mac Air, taking away an account.  And if the iPhone can be restored, then the Mac is blocked from the ends.  Contacting technical support did not lead to anything, the service center offered to unlock for 1000 rubles and 1 day.  True, they discovered a marriage of the motherboard, which did not allow them to do it. <br><br>  After reading the article <a href="http://habrahabr.ru/post/240291/">Brutforsim EFI with Arduino</a> , we decided to repeat the experience.  True, there was no display, but there were two Arduins - Uno and Mega2560.  And the laptop, which is not very sorry for ~ 33 hours to leave to sort out the password.  We decided to do a brute force with preference and poetess - let the automatics watch the brute force while we drink tea. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Description of the problem </h4><br>  For a start - briefly about what we decided at all.  This section is for those who do not want to carefully read the article to which I referred. <br><br>  If your Apple account is hijacked, a hacker can block your Mac remotely by setting a four-digit numeric password of your choice.  After that, it is impossible to turn on the Mac without entering this password, and this password can be entered in two different places - before entering your account (there are 4 empty single-character input fields closed with asterisks) and when you try to enter UEFI (in this case, field for entering any number of characters, also closed with asterisks).  If you enter the wrong password many times in 4 fields, the input is blocked first for 5 minutes, then for 10, and so on until an hour.  For busting is not very suitable.  In the case of UEFI, you can repeat the entry about every 12 seconds (a little less, in fact).  If we calculate the maximum search time, we get 33, (3) hours of search, without taking into account the time for entering characters and ‚Äúentering‚Äù.  Not deadly, in principle.  It seems Apple has something to think about in terms of security. <br><br>  We are, however, such negligence in choosing the complexity of the password (or the delay between inputs) only at hand. <br>  I note that when you enter the correct password, the input is not blocked at all, that is, these ~ 12 seconds are not the time to check the password, but an artificial delay.  It seems that you can get somewhere for this delay and sort out much faster.  We did not do that, but the idea is interesting. <br><br><h5>  Disclaimer </h5><br>  Everything that happens in this article was legal (because it was produced with its own poppy), aimed at combating fraudsters, whose contact information has already gone where it should.  The use of materials of this article for illegal (as well as legitimate) actions under no circumstances is the responsibility of the author or the site.  Everything that you do, you do at your own peril and risk.  The author or the site is not responsible for any damage, direct or indirect, caused by the materials of the article.  In short, who did not hide, I'm not guilty. <br><br><h5>  How to sort through? </h5><br>  The author of the article ‚ÄúBrutforsim EFI with Arduino‚Äù suggested a wonderful way to select a password - Arduino pretends to be a USB keyboard and sequentially sorts through passwords.  I will not repeat all the details of the approach, the link to the article above.  I will describe what we decided to do differently and why <br><br><ol><li>  Use the computer constantly.  We did not have a display, so there was nothing to write a log of what was entered.  Therefore, the computer will remember what was entered </li><li>  Recognize the image on the monitor poppy.  It seemed to us relatively simple to check if the poppy was still cracked, and to enter passwords only if it was not cracked.  Anyway, the computer is used. </li><li>  Check that exactly four characters are entered.  This was the most unexpected change for us.  It was found that sometimes a bunch of computer - arduino - arduino - poppy did not enter all the characters.  Sometimes input was skipped, and it was not very scary (you can add 3-4 inputs after the password, they do not interfere).  But sometimes the password was omitted.  Why - a mystery.  We decided to look at the picture and make sure that all the characters are entered.  If not, repeat the entry. </li><li>  Enumerate passwords in random order.  Passwords in the article moved from 0000 to 9999, we did not like it.  Most likely, the attacker chose a password, far from both 0000 and 9999, so that the picker would suffer.  Therefore, we decided to make a randomized search.  What a cruel joke it played with us, read on. </li></ol><br><br><h4>  Let's get to the point! </h4><br>  We are going through this scheme: <br><ol><li>  The computer generates a list of passwords for busting </li><li>  The computer checks that the poppy is still locked. </li><li>  The computer sends the next password to the Arduine Uno, which, in fact, is used as a USB &lt;-&gt; SERIAL adapter and has a simple program that does nothing </li><li>  With Uno, the data reads Mega over Serial1.  That is why they used the order Uno -&gt; Mega, and not vice versa. </li><li>  Mega enters data into a Mac, considering itself a keyboard. </li><li>  The computer checks that 4 characters are entered on the screen.  If not, the password is marked as not entered. </li><li>  In the same way, the input is pressed. </li><li>  While the password field is not empty, do nothing </li><li>  As soon as the entry field is empty, go to the second step. </li></ol><br><br><h5>  Data transfer </h5><br>  Data was transferred via USB, became serial, then became keystrokes.  There was nothing particularly interesting here, except for shocked characters.  By debugging, we determined that the characters are lost in the last stage.  That is, the character from the keyboard goes away, but is not registered in the poppy.  Why, remains a mystery.  We did not understand, just checked that everything was entered. <br><br><h5>  Lock recognition </h5><br>  While the poppy is locked, a lock is drawn.  Here is this: <br><br><img src="https://habrastorage.org/files/592/76e/fb1/59276efb10644643936fc667267d9072.png"><br><br>  Let's look for it with OpenCV!  This is such a suitable use for a microscope (in fact, not). <br>  Surprisingly, OpenCV under .NET wound up with a half-kick and two NuGet packages (OpenCV.NET, OpenCV).  Next is some code. <br><br><pre><code class="cs hljs">lck = CV.LoadImage(<span class="hljs-string"><span class="hljs-string">"D:\\mac-unlock\\lock.png"</span></span>, LoadImageFlags.Unchanged); <span class="hljs-comment"><span class="hljs-comment">//Load lock image file Capture camera = Capture.CreateCameraCapture(-1); //Create camera object to capture image. Don't care about device index as the notebook has 1 camera device var img = camera.RetrieveFrame(); //get camera image IplImage res = new IplImage(new OpenCV.Net.Size(img.Width - tpl.Width + 1, img.Height - tpl.Height + 1), IplDepth.F32, 1); //Create image for matching results OpenCV.Net.CV.MatchTemplate(img, lck, res, TemplateMatchingMethod.CorrelationCoefficientNormed); //Find lock image in camera image double min, max; OpenCV.Net.Point minloc; OpenCV.Net.Point maxloc; CV.MinMaxLoc(res, out min, out max, out minloc, out maxloc); if (max &lt; 0.88) //No lock image on the screen! Wow! ...</span></span></code> </pre> <br>  This simple code looks for an image of a lock on the screen.  Finds great: <br><br><img src="http://ipic.su/img/img7/fs/0000C.1424025866.png"><br><br>  The green rectangle is a found lock.  This section has not caused any difficulties.  OpenCV was very surprised and pleased. <br><br><h5>  Password field </h5><br>  If we found a lock on the screen, you can search for the password field below it.  This is done relatively easily with the usual manipulation of image pixels.  Or done, if not for the camera.  There are two problems.  First, the camera resolution was 640 * 480, which is terrible for analysis.  Secondly, with inconsistent lighting, the camera behaved completely unpredictable.  That something was lit, something disappeared.  The second problem was solved by stable lighting conditions, the first one - by binding to sizes in pixels and filters. <br><br>  So, there is a castle, you can find its center and go down until we meet two peaks of brightness. <br><br><img src="http://ipic.su/img/img7/fs/lights-below.1424025931.png"><br><br>  In the figure - the brightness of the pixels under lock. <br>  Having found two maxima at a sufficient distance, you can take the center between them and go left (we assume that the password field is horizontal).  When they found a bright pixel, either the input field ended, or they stumbled upon an asterisk. <br><br><img src="http://ipic.su/img/img7/fs/input.1424025906.png"><br><br>  Entry field.  Green - frame lock.  White - line down, which are looking for two maxima.  Red - maximums found and the first bright pixel on the left in the center. <br><br>  Now, if the first bright pixel on the left is ‚Äúleft‚Äù enough, then the input field is empty.  If ‚Äúright‚Äù is enough, 4 characters are entered.  Calibration is needed, however. <br><br>  During calibration, the position of the bright pixel was searched with an empty input field, then 4 characters were entered, and the position of the bright pixel was searched.  These values ‚Äã‚Äãwere saved and further used as reference. <br><br>  This ends the part on working with the image, and indeed it is time to move on to the results. <br><br><h4>  results </h4><br><img src="http://ipic.su/img/img7/fs/found.1424025662.png"><br><br>  Lock not found!  After 33 hours of operation, the password was chosen.  Despite randomization, the correct password was number 35 from the end.  The password value was <b>2605</b> .  The probability of this event was 0.35%. <br><br><img src="http://vignette3.wikia.nocookie.net/halflife/images/a/a1/Cake.jpg/revision/latest?cb=20140907045022&amp;path-prefix=ru" alt="image"><br><br><h4>  Literature, equipment and code </h4><br>  The article used: <br>  Apple Mac Air <br>  Lenovo Thinkpad T510 <br>  Arduino Uno (compatible) <br>  Arduino Mega 2560 (compatible) <br><br>  Literature: <br><br>  <a href="http://habrahabr.ru/post/240291/">EFI brute force with Arduino</a> - from here everything is taken about working with Arduino as with a keyboard and the principle of locking poppy.  Thanks to the author! <br>  <a href="http://arduino.cc/">Of</a>  <a href="http://arduino.cc/">Arduino website</a> <br>  <a href="http://opencv.org/">Of</a>  <a href="http://opencv.org/">OpenCV website</a> <br><br>  <b><a href="https://onedrive.live.com/redir%3Fresid%3D9A6D39AA455E9403!1951%26authkey%3D!AC5rNgz73qHslq0%26ithint%3Dfile%252C7z">Code.</a></b>  Attention, the code is terrible.  It is written ad hoc and contains traces of experiments.  In addition, it is tied to the size of my camera, so it may require modification. <br><br>  You can do anything with the code, if it is not prohibited by law. </div><p>Source: <a href="https://habr.com/ru/post/250347/">https://habr.com/ru/post/250347/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../250337/index.html">We are forbidden to even talk about cryptocurrency?</a></li>
<li><a href="../250339/index.html">TLS hacking with cash prize</a></li>
<li><a href="../250341/index.html">External hardware driver for 1C on the example of the Maria-301MTM fiscal recorder</a></li>
<li><a href="../250343/index.html">PSR-7 in examples</a></li>
<li><a href="../250345/index.html">Pack the cluster in a box!</a></li>
<li><a href="../250349/index.html">The results of the Olympiad on programming among schoolchildren</a></li>
<li><a href="../250353/index.html">Webinars on new features RAD Studio XE7</a></li>
<li><a href="../250355/index.html">High-tech gifts for Valentine's Day</a></li>
<li><a href="../250357/index.html">How we did a single on Ubuntu Studio 14.04</a></li>
<li><a href="../250359/index.html">HGST drives in RAID arrays</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>