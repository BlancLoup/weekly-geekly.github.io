<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using Linux on the SAN network. Little trick</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to all. 
 I do not think that the situation described by me is typical for the majority, but nevertheless I think it will be useful to know. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using Linux on the SAN network. Little trick</h1><div class="post__text post__text-html js-mediator-article">  Good day to all. <br>  I do not think that the situation described by me is typical for the majority, but nevertheless I think it will be useful to know.  My story about how to protect "from a fool" in the case when you have a <a href="http://ru.wikipedia.org/wiki/SAN">SAN</a> network, there are several storage systems (Storage System) that do not support technology to restrict access to certain LUN (Logical Unit Number) and servers based on Linux (in our In this case, all actions will be performed using SLES OS 10SP1). <br><a name="habracut"></a><br><br><h4>  Prehistory </h4><br>  In 2008 I had to commission the computing infrastructure of a single customer.  A small SAN network was built with some storages (about 10 pieces of different classes).  Most of these storads were designed to build the file system of a computing cluster, so the problem was not obvious at first and didn‚Äôt even think about it. <br><br>  And the problem is that some infrastructure subsystems have been allocated a stack that does not know how to restrict access to certain LUNs from certain hosts (for each manufacturer it is called Port Masking, LUN MAPPING, etc.), more correctly it can do it, but you need to buy additional.  license, and this was not done.  And here the problem arose - all the servers that connect to this stack see all its sections.  It seems to be nothing terrible in this, but it is necessary to protect the customer from the possibility of formatting someone else's section, because  data of each subsystem is very important. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Total we have: <br><ul><li>  <a href="http://lsi.com/storage_home/products_home/external_raid/6998_storage_system/index.html">LSI</a> storage system (more precisely, one of its partners) </li><li>  Servers based on SLES10 SP1 with a two-headed FC adapter </li><li>  A great desire to insure themselves and the customer from mistakes. </li></ul><br><br><h4>  Step One, Introductory </h4><br>  Immediately make a reservation for those who do not have strong knowledge in the subject: <br>  Each device in the SAN network has a unique WWN (World Wide Name) address, it is a kind of analog of the MAC address of the network adapter, but, as in the case of Ethernet, the switch does not know what lies inside the packet coming to the switch, so make a restriction on the switch ) it is impossible, you can only limit the scope of Data Storage Systems for certain nodes, which was done. <br><br>  The circle of finding a solution was limited to the following options: <br><ol><li>  Driver availability to use only certain LUNs </li><li>  Use OS Tools to Block Unwanted LUNs </li></ol><br><br><h5>  First option </h5><br>  He disappeared after seeing the information on this module.  It contains only the option to scan the device and determines the maximum number of LUNs.  So this option disappears. <br><br><h5>  Second option </h5><br>  This option immediately directs us to ‚Äúcarry out land work‚Äù in the direction of the udev subsystem.  It is she who is responsible in linux for initializing devices, assigning them specialized names and other actions.  Simply put, we need to correctly describe the rule for udev, which will create only the devices we need. <br>  Looking ahead, I will say that this decision will limit only the creation of specials.  devices (like / dev / sdb, / dev / sdc, etc.), but physically the host will see all the LUNs available to it. <br><br><h4>  Step Two, Study </h4><br><br>  Let's start a detailed study of the topic. <br><br>  After a quick study of the documentation, as well as the rules that are in the system, you can isolate the following blocks that are interesting to us: <br><br><ol><li> The ‚ÄúSUBSYSTEM‚Äù block, which defines a subsystem.  There are three types of subsystems: ‚Äúblock‚Äù (block devices), ‚Äúchar‚Äù (character devices) and ‚Äúpipe‚Äù (FIFO devices). <br> <code>man mknod</code> <br>  We are interested in the ‚Äúblock‚Äù subsystem, since  Drives belong to this class. <br><br></li><li>  udev can view device attributes.  They usually store various data, such as: <br><ul><li>  type of manufacturer </li><li>  model name </li><li>  various hardware data. </li></ul><br><br>  To figure out the parameters we need, we will need: <br>  Utility lssci - displays all SCSI devices that are available in the system, as well as the name of the spec.  device that is assigned to this SCSI device <br>  Udevinfo utility - shows all the necessary data on the requested device. <br><br>  Let's start: <br><br>  First we need to display a list of all devices that are available on this server: <br><br> <code># lssci <br> SCSI ID TYPE VENDOR MODEL REV. device <br> [5:0:0:10] disk XXX YYYYY 0619 /dev/sdr <br> [5:0:0:20] disk XXX YYYYY 0619 /dev/sds <br> [5:0:0:21] disk XXX YYYYY 0619 /dev/sdu <br> ...... <br> [5:0:1:10] disk XXX YYYYY 0619 /dev/sdan <br> [5:0:1:20] disk XXX YYYYY 0619 /dev/sdao <br> [5:0:1:21] disk XXX YYYYY 0619 /dev/sdar <br></code> <br><br>  The output of this command will be large, so I will give only a part. <br>  So now we know: <br>  SCSI ID - identifier in the format H: B: T: L (Host: Bus: Target: Lun) Host is the ordinal number of the adapter that is responsible for this device, Bus (Channel) is the SCSI channel number on the adapter, Target is the number FC port on the stack, LUN - identifier of the partition allocated on the stack. <br>  VENDOR - the name of the manufacturer storadzh <br>  MODEL - model name <br>  Rev.  - FirmWare version in stock <br>  device - special  user accessible device <br><br>  In this operation, we were interested in the "device" and "SCSI ID" fields.  The remaining fields are ignored. <br><br></li><li>  The next step is to get the list of storage attributes that we need: <br><ul><li>  driver name </li><li>  manufacturer name </li><li>  model name </li></ul><br><br>  For this, we will need the udevinfo utility, as well as the sysfs file system (for kernel versions 2.6), since  all the information we need is stored in it. <br><br> <code># udevinfo -a -p /sys/block/sds <br> <br> looking at device '/block/sds': <br> KERNEL=="sds" <br> SUBSYSTEM=="block" <br> SYSFS{stat}==" 151707 2355 3422965 430068 436954 12273 18585533 1098588 0 651944 1528756" <br> SYSFS{size}=="2129838080" <br> SYSFS{removable}=="0" <br> SYSFS{range}=="16" <br> SYSFS{dev}=="65:32" <br> <br> looking at device '/devices/pci0000:00/0000:00:04.0/0000:08:00.0/host5/rport-5:0-0/target5:0:0/5:0:0:20': <br> ID=="5:0:0:20" <br> BUS=="scsi" <br> DRIVER=="sd" <br> SYSFS{ioerr_cnt}=="0x7" <br> SYSFS{iodone_cnt}=="0xec62d" <br> SYSFS{iorequest_cnt}=="0xec62d" <br> SYSFS{iocounterbits}=="32" <br> SYSFS{retries}=="5" <br> SYSFS{timeout}=="60" <br> SYSFS{state}=="running" <br> SYSFS{rev}=="0619" <br> SYSFS{model}=="YYYYY " <br> SYSFS{vendor}=="XXX " <br> SYSFS{scsi_level}=="6" <br> SYSFS{type}=="0" <br> SYSFS{queue_type}=="simple" <br> SYSFS{queue_depth}=="64" <br> SYSFS{device_blocked}=="0" <br> .... <br> looking at device '/devices/pci0000:00/0000:00:04.0/0000:08:00.0': <br> ID=="0000:08:00.0" <br> BUS=="pci" <br> DRIVER=="mptfc" <br> SYSFS{modalias}=="pci:v00001000d00000646sv00001000sd00001020bc0Csc04i00" <br> SYSFS{local_cpus}=="00000000,00000000,00000000,0000000f" <br> SYSFS{irq}=="169" <br> SYSFS{class}=="0x0c0400" <br> SYSFS{subsystem_device}=="0x1020" <br> SYSFS{subsystem_vendor}=="0x1000" <br> SYSFS{device}=="0x0646" <br> SYSFS{vendor}=="0x1000" <br> <br></code> <br><br>  Request information for each device is not necessary, because  The output of "lsscsi" contains duplicate entries.  These are the paths to a specific LUN through different devices (for example, 1 FC port on the host and 3 Port on the storage), and since this is the same storage, the parameters we need will be the same for everyone. </li></ol><br><br>  Short summary: <br><br><ol><li>  DRIVER == "sd" is the name of the driver that identifies this device.  Why ‚Äúsd‚Äù, and not the FC driver ‚Äúmptfc‚Äù, because exactly how the ‚Äúsd‚Äù driver detects the disk device received from the SCSI / FC adapters. </li><li>  SYSFS {vendor} == "XXX" is a storage manufacturer.  If you pay attention, his name is not just "XXX", but also a certain number of spaces.  It is for this reason that the output of lsscsi is not so informative, and in the case of using only ‚ÄúXXX‚Äù the rule simply does not work. </li><li>  SYSFS {model} == "YYYYY" is the model name.  Same reason as in paragraph above. </li><li>  ID == "5: 0: 0: 20" is an identifier in the format H: B: T: L.  He also needs to be remembered, because  we will need it further. </li><li>  BUS == "scsi" is a type of bus.  We will need to more accurately identify the device. </li></ol><br><br>  So now we have all the necessary information to write a rule. <br><br><h4>  Step three, the office writes! </h4><br><br>  Now we proceed directly to writing the rule.  We will need udev documentation. <br>  I give the final rule and description of options: <br><br> <code># If not a block device (ex. tape) ignore this rule <br> SUBSYSTEM!="block", GOTO="go_ignore_end" <br> # Phisical device section <br> BUS=="scsi", DRIVER=="sd", SYSFS{vendor}=="XXX ", SYSFS{model}=="YYYYY ", ID=="*:*:*:20", GOTO="go_ignore_end" <br> BUS=="scsi", DRIVER=="sd", SYSFS{vendor}=="XXX ", SYSFS{model}=="YYYYY ", ID=="*:*:*:21", GOTO="go_ignore_end" <br> BUS=="scsi", DRIVER=="sd", SYSFS{vendor}=="XXX ", SYSFS{model}=="YYYYY ", OPTIONS+="ignore_device,last_rule" <br> <br> LABEL="go_ignore_end" <br></code> <br><br>  And now the explanation of what's what: <br><br> <code>SUBSYSTEM!="block", GOTO="go_ignore_end"</code> <br>  This option tells udev that if the subsystem works with any non-block device, then this rule does not apply. <br><br> <code>BUS=="scsi", DRIVER=="sd", SYSFS{vendor}=="XXX ", SYSFS{model}=="YYYYY ", ID=="*:*:*:20", GOTO="go_ignore_end" <br> BUS=="scsi", DRIVER=="sd", SYSFS{vendor}=="XXX ", SYSFS{model}=="YYYYY ", ID=="*:*:*:21", GOTO="go_ignore_end" <br></code> <br><br>  This is the most important part, in fact, for the sake of this part, and this article was written.  The rule defines the behavior: if a device gets through the BUS == "scsi" and it uses the DRIVER == "sd" driver, we also have the manufacturer SYSFS {vendor} == "XXX" and the model name SYSFS {model} == " YYYYY "and LUN of this device corresponds to ID ==" *: *: *: 20 ", then this device should follow all other rules and create specials.  device in the / dev directory. <br><br>  Record ID == "*: *: *: 20" is an entry in the format H: B: T: L, which describes only the LUN identifier, the rest of the fields can be any.  This allows us to skip all storage devices that have a given LUN.  If it is necessary to expand the list of LUNs, then records are simply added and the identifier we need is recorded in the last field.  The main thing is that they should be placed before the following rule. <br><br> <code>BUS=="scsi", DRIVER=="sd", SYSFS{vendor}=="XXX ", SYSFS{model}=="YYYYY ", OPTIONS+="ignore_device,last_rule" <br></code> <br><br>  This rule applies the same conditions as the previous one, only OPTIONS + = ‚Äúignore_device, last_rule‚Äù tells udev to ignore all further actions with this device.  Those.  all devices except the specified ones will be ignored. <br><br> <code>LABEL="go_ignore_end"</code> <br>  This rule is a simple end-of-file label.  It should be the last in the list. <br><br><h4>  Step four, the last battle </h4><br>  Now we just have to save this rule and enable it. <br>  We save this rule in the /etc/udev/rules.d folder in the correct format.  I used the name "52-ignore-unused-devices.rules".  After that, something else needs to be done.  If the adapter driver is in the ramdisk, then it should be removed from there and loaded only after the udev subsystem starts; otherwise, this rule will not work, because  devices will be created before udev starts. <br><br>  To do this, you need to make changes to the / etc / sysconfig / kernel file: <br><br><ol><li>  Delete in the variable INITRD_MODULES = "...." the device driver FC. </li><li>  Add it to the MODULES_LOADED_ON_BOOT = "..." variable </li><li>  Regenerate ramdisk with the mkinitrd command. </li></ol><br><br>  Now you can restart the server and make sure that only those devices that we need are created.  The rest, although visible in the system, but not specified special.  files, and therefore the user can not do anything with them.  It will look like this: <br><br> <code># lssci <br> <br> SCSI ID TYPE VENDOR MODEL REV. device <br> [5:0:0:10] disk XXX YYYYY 0619 - <br> [5:0:0:20] disk XXX YYYYY 0619 /dev/sds <br> [5:0:0:21] disk XXX YYYYY 0619 /dev/sdu <br> ...... <br> [5:0:1:10] disk XXX YYYYY 0619 - <br> [5:0:1:20] disk XXX YYYYY 0619 /dev/sdao <br> [5:0:1:21] disk XXX YYYYY 0619 /dev/sdar <br></code> <br><br>  As a result, our task was solved elegantly and beautifully.  It will also speed up the download, especially if you use the built-in multipath mechanism. <br><br>  I hope this will be useful for at least one person. <br><br>  Materials that helped a lot <br><ul><li>  <a href="http://reactivated.net/writing_udev_rules.html">http://reactivated.net/writing_udev_rules.html</a> </li><li>  Existing udev rules </li></ul></div><p>Source: <a href="https://habr.com/ru/post/112453/">https://habr.com/ru/post/112453/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../112447/index.html">VLC Media Player 1.1.6 saw the light</a></li>
<li><a href="../112449/index.html">Locating a disconnected phone: a myth?</a></li>
<li><a href="../112450/index.html">Sending E-Mail via Android</a></li>
<li><a href="../112451/index.html">Cartographic capabilities of Samsung Bada, part 2</a></li>
<li><a href="../112452/index.html">Are you ready to ride the Harley?</a></li>
<li><a href="../112454/index.html">Start Cloud Printing</a></li>
<li><a href="../112456/index.html">A hundred best</a></li>
<li><a href="../112457/index.html">Translated into Russian a very visual circuit simulator</a></li>
<li><a href="../112458/index.html">A few tips on working with VBA in Excel</a></li>
<li><a href="../112459/index.html">How in the Ulyanovsk region "selected" the Minister of IT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>