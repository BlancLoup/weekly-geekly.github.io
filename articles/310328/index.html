<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Database Performance Testing with tSQLt and SQLQueryStress</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I hope it will not be a revelation if I say that testing plays an important role in the development of any software product. The better the testing, t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Database Performance Testing with tSQLt and SQLQueryStress</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/b79/ce9/0ae/b79ce90aeb8942408ded3021956c3b7b.png"><br><br>  I hope it will not be a revelation if I say that testing plays an important role in the development of any software product.  The better the testing, the better the final product should end up. <br><br>  It is often possible to encounter a situation where testing of the program code is very painstaking, and there is no time left for testing the database or it is done according to the residual principle.  I emphasize that this formulation is very restrained, in practice everything is even worse ... they remember the base only when problems start with it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As a result, working with the database can be a bottleneck in the performance of our application. <br><br>  To save myself from this kind of problems, I propose to consider various aspects of database testing.  These include load testing and performance testing of <i>SQL Server</i> as a whole with the help of unit tests. <br><a name="habracut"></a><br>  Take some abstract task.  For example, we are developing an engine for online stores.  Our clients may have different sales, different types of goods ... but in order not to overload we will make the structure base relatively simple. <br><br><div class="spoiler">  <b class="spoiler_title">Database schema</b> <div class="spoiler_text"><pre><code class="1c hljs">USE [master] GO IF DB_ID('db_sales') IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> BEGIN ALTER DATABASE [db_sales] SET SINGLE_USER WITH ROLLBACK IMMEDIATE DROP DATABASE [db_sales] END GO CREATE DATABASE [db_sales] GO USE [db_sales] GO CREATE TABLE dbo.Customers ( [CustomerID] INT IDENTITY PRIMARY KEY , [FullName] NVARCHAR(<span class="hljs-number"><span class="hljs-number">150</span></span>) , [Email] VARCHAR(<span class="hljs-number"><span class="hljs-number">50</span></span>) NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> , [Phone] VARCHAR(<span class="hljs-number"><span class="hljs-number">50</span></span>) ) GO CREATE TABLE dbo.Products ( [ProductID] INT IDENTITY PRIMARY KEY , [Name] NVARCHAR(<span class="hljs-number"><span class="hljs-number">150</span></span>) NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> , [Price] MONEY NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> CHECK (Price &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) , [Image] VARBINARY(MAX) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> , [Description] NVARCHAR(MAX) ) GO CREATE TABLE dbo.Orders ( [OrderID] INT IDENTITY PRIMARY KEY , [CustomerID] INT NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> , [OrderDate] DATETIME NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> DEFAULT GETDATE() , [CustomerNotes] NVARCHAR(MAX) , [IsProcessed] BIT NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> DEFAULT <span class="hljs-number"><span class="hljs-number">0</span></span> ) GO ALTER TABLE dbo.Orders WITH NOCHECK ADD CONSTRAINT FK_Orders_CustomerID FOREIGN KEY (CustomerID) REFERENCES dbo.Customers (CustomerID) GO ALTER TABLE dbo.Orders CHECK CONSTRAINT FK_Orders_CustomerID GO CREATE TABLE dbo.OrderDetails ( [OrderID] INT NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> , [ProductID] INT NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> , [Quantity] INT NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> CHECK (Quantity &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) , PRIMARY KEY (OrderID, ProductID) ) GO ALTER TABLE dbo.OrderDetails WITH NOCHECK ADD CONSTRAINT FK_OrderDetails_OrderID FOREIGN KEY (OrderID) REFERENCES dbo.Orders (OrderID) GO ALTER TABLE dbo.OrderDetails CHECK CONSTRAINT FK_OrderDetails_OrderID GO ALTER TABLE dbo.OrderDetails WITH NOCHECK ADD CONSTRAINT FK_OrderDetails_ProductID FOREIGN KEY (ProductID) REFERENCES dbo.Products (ProductID) GO ALTER TABLE dbo.OrderDetails CHECK CONSTRAINT FK_OrderDetails_ProductID GO</code> </pre> <br></div></div><br>  Also suppose that our thin client will work with the database through pre-written stored procedures.  They are all quite simple.  Insert a new user or get an existing <i>ID</i> : <br><br><pre> <code class="1c hljs">CREATE PROCEDURE dbo.GetCustomerID ( @FullName NVARCHAR(<span class="hljs-number"><span class="hljs-number">150</span></span>) , @Email VARCHAR(<span class="hljs-number"><span class="hljs-number">50</span></span>) , @Phone VARCHAR(<span class="hljs-number"><span class="hljs-number">50</span></span>) , @CustomerID INT OUT ) AS BEGIN SET NOCOUNT ON; SELECT @CustomerID = CustomerID FROM dbo.Customers WHERE Email = @Email IF @CustomerID IS <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> BEGIN INSERT INTO dbo.Customers (FullName, Email, Phone) VALUES (@FullName, @Email, @Phone) SET @CustomerID = SCOPE_IDENTITY() END END</code> </pre><br>  Place a new order: <br><br><pre> <code class="1c hljs">CREATE PROCEDURE dbo.CreateOrder ( @CustomerID INT , @CustomerNotes NVARCHAR(MAX) , @Products XML ) AS BEGIN SET NOCOUNT ON; DECLARE @OrderID INT INSERT INTO dbo.Orders (CustomerID, CustomerNotes) VALUES (@CustomerID, @CustomerNotes) SET @OrderID = SCOPE_IDENTITY() INSERT INTO dbo.OrderDetails (OrderID, ProductID, Quantity) SELECT @OrderID , tcvalue('@ProductID', 'INT') , tcvalue('@Quantity', 'INT') FROM @Products.nodes('items/item') t(c) END</code> </pre><br>  Suppose we are faced with the task of ensuring a minimum response when executing queries.  On an empty base of performance problems, even if desired, can hardly be expected.  Therefore, to check the performance of our procedures, we need at least some test data.  As an option, use the script to generate test data for the <i>Customers</i> table: <br><br><div class="spoiler">  <b class="spoiler_title">Script</b> <div class="spoiler_text"><pre> <code class="1c hljs">DECLARE @obj INT = OBJECT_ID('dbo.Customers') , @sql NVARCHAR(MAX) , @cnt INT = <span class="hljs-number"><span class="hljs-number">10</span></span> ;WITH E1(N) AS ( SELECT * FROM ( VALUES (<span class="hljs-number"><span class="hljs-number">1</span></span>),(<span class="hljs-number"><span class="hljs-number">1</span></span>),(<span class="hljs-number"><span class="hljs-number">1</span></span>),(<span class="hljs-number"><span class="hljs-number">1</span></span>),(<span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-number"><span class="hljs-number">1</span></span>),(<span class="hljs-number"><span class="hljs-number">1</span></span>),(<span class="hljs-number"><span class="hljs-number">1</span></span>),(<span class="hljs-number"><span class="hljs-number">1</span></span>),(<span class="hljs-number"><span class="hljs-number">1</span></span>) ) t(N) ), E2(N) AS (SELECT <span class="hljs-number"><span class="hljs-number">1</span></span> FROM E1 a, E1 b), E4(N) AS (SELECT <span class="hljs-number"><span class="hljs-number">1</span></span> FROM E2 a, E2 b), E8(N) AS (SELECT <span class="hljs-number"><span class="hljs-number">1</span></span> FROM E4 a, E4 b) SELECT @sql = ' DELETE FROM ' + QUOTENAME(OBJECT_SCHEMA_NAME(@obj)) + '.' + QUOTENAME(OBJECT_NAME(@obj)) + ' ;WITH E1(N) AS ( SELECT * FROM ( VALUES (1),(1),(1),(1),(1), (1),(1),(1),(1),(1) ) t(N) ), E2(N) AS (SELECT 1 FROM E1 a, E1 b), E4(N) AS (SELECT 1 FROM E2 a, E2 b), E8(N) AS (SELECT 1 FROM E4 a, E4 b) INSERT INTO ' + QUOTENAME(OBJECT_SCHEMA_NAME(@obj)) + '.' + QUOTENAME(OBJECT_NAME(@obj)) + '(' + STUFF(( SELECT ', ' + QUOTENAME(name) FROM sys.columns c WHERE c.[object_id] = @obj AND c.is_identity = <span class="hljs-number"><span class="hljs-number">0</span></span> AND c.is_computed = <span class="hljs-number"><span class="hljs-number">0</span></span> FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, '') + ') SELECT TOP(' + CAST(@cnt AS VARCHAR(<span class="hljs-number"><span class="hljs-number">10</span></span>)) + ') ' + STUFF(( SELECT ' , ' + QUOTENAME(name) + ' = ' + CASE WHEN TYPE_NAME(c.system_type_id) IN ( 'varchar', 'char', 'nvarchar', 'nchar', 'ntext', 'text' ) THEN ( STUFF(( SELECT TOP( CASE WHEN max_length = -<span class="hljs-number"><span class="hljs-number">1</span></span> THEN CAST(RAND() * <span class="hljs-number"><span class="hljs-number">10000</span></span> AS INT) ELSE max_length END / CASE WHEN TYPE_NAME(c.system_type_id) IN ('nvarchar', 'nchar', 'ntext') THEN <span class="hljs-number"><span class="hljs-number">2</span></span> ELSE <span class="hljs-number"><span class="hljs-number">1</span></span> END ) '+SUBSTRING(x, (ABS(CHECKSUM(NEWID())) % 80) + 1, 1)' FROM E8 FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, '') ) WHEN TYPE_NAME(c.system_type_id) = 'tinyint' THEN '50 + CRYPT_GEN_RANDOM(10) % 50' WHEN TYPE_NAME(c.system_type_id) IN ('int', 'bigint', 'smallint') THEN 'CRYPT_GEN_RANDOM(10) % <span class="hljs-number"><span class="hljs-number">2500</span></span>0' WHEN TYPE_NAME(c.system_type_id) = 'uniqueidentifier' THEN 'NEWID()' WHEN TYPE_NAME(c.system_type_id) IN ('decimal', 'float', 'money', 'smallmoney') THEN 'ABS(CAST(NEWID() AS BINARY(6)) % <span class="hljs-number"><span class="hljs-number">1000</span></span>) * RAND()' WHEN TYPE_NAME(c.system_type_id) IN ('datetime', 'smalldatetime', 'datetime2') THEN 'DATEADD(MINUTE, RAND(CHECKSUM(NEWID())) * (1 + DATEDIFF(MINUTE, ''<span class="hljs-number"><span class="hljs-number">20000101</span></span>'', GETDATE())), ''<span class="hljs-number"><span class="hljs-number">20000101</span></span>'')' WHEN TYPE_NAME(c.system_type_id) = 'bit' THEN 'ABS(CHECKSUM(NEWID())) % 2' WHEN TYPE_NAME(c.system_type_id) IN ('varbinary', 'image', 'binary') THEN 'CRYPT_GEN_RANDOM(5)' ELSE 'NULL' END FROM sys.columns c WHERE c.[object_id] = @obj AND c.is_identity = <span class="hljs-number"><span class="hljs-number">0</span></span> AND c.is_computed = <span class="hljs-number"><span class="hljs-number">0</span></span> FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, ' ') + ' FROM E8 CROSS APPLY ( SELECT x = ''<span class="hljs-number"><span class="hljs-number">0123456789</span></span>-ABCDEFGHIJKLMNOPQRSTUVWXYZ abcdefghijklmnopqrstuvwxyz'' ) t' EXEC sys.sp_executesql @sql</code> </pre><br></div></div><br>  The script was created in order to generate random test data for tables with arbitrary structure.  As a result, we won in universality, but lost in realism: <br><br><pre> <code class="sql hljs">CustomerID FullName Email Phone <span class="hljs-comment"><span class="hljs-comment">----------- ------------------------------------ ---------------- --------------- 1 uN9UiFZ9i0pALwQXIfC628Ecw35VX9L i6D0FNBuKo9I ZStNRH8t1As2S 2 Jdi6M0BqxhE-7NEvC1 a12 UTjK28OSpTHx 7DW2HEv0WtGN 3 0UjI9pIHoyeeCEGHHT6qa2 2hUpYxc vN mqLlO 7c R5 U3ha 4 RMH-8DKAmewi2WdrvvHLh w-FIa wrb uH 5 h76Zs-cAtdIpw0eewYoWcY2toIo g5pDTiTP1Tx qBzJw8Wqn 6 jGLexkEY28Qd-OmBoP8gn5OTc FESwE l CkgomDyhKXG 7 09X6HTDYzl6ydcdrYonCAn6qyumq9 EpCkxI01tMHcp eOh7IFh 8 LGdGeF5YuTcn2XkqXT-92 cxzqJ4Y cFZ8yfEkr 9 7 Ri5J30ZtyWBOiUaxf7MbEKqWSWEvym7 0C-A7 R74Yc KDRJXX hw 10 D DzeE1AxUHAX1Bv3eglY QsZdCzPN0 RU-0zVGmU</span></span></code> </pre><br>  Of course, no one bothers us to write a request to generate more approximate data for the same <i>Customers</i> table: <br><br><pre> <code class="1c hljs">DECLARE @cnt INT = <span class="hljs-number"><span class="hljs-number">10</span></span> DELETE FROM dbo.Customers ;WITH E1(N) AS ( SELECT * FROM ( VALUES (<span class="hljs-number"><span class="hljs-number">1</span></span>),(<span class="hljs-number"><span class="hljs-number">1</span></span>),(<span class="hljs-number"><span class="hljs-number">1</span></span>),(<span class="hljs-number"><span class="hljs-number">1</span></span>),(<span class="hljs-number"><span class="hljs-number">1</span></span>), (<span class="hljs-number"><span class="hljs-number">1</span></span>),(<span class="hljs-number"><span class="hljs-number">1</span></span>),(<span class="hljs-number"><span class="hljs-number">1</span></span>),(<span class="hljs-number"><span class="hljs-number">1</span></span>),(<span class="hljs-number"><span class="hljs-number">1</span></span>) ) t(N) ), E2(N) AS (SELECT <span class="hljs-number"><span class="hljs-number">1</span></span> FROM E1 a, E1 b), E4(N) AS (SELECT <span class="hljs-number"><span class="hljs-number">1</span></span> FROM E2 a, E2 b), E8(N) AS (SELECT <span class="hljs-number"><span class="hljs-number">1</span></span> FROM E4 a, E4 b) INSERT INTO dbo.Customers (FullName, Email, Phone) SELECT TOP(@cnt) [FullName] = txt , [Email] = LOWER(txt) + LEFT(ABS(CHECKSUM(NEWID())), <span class="hljs-number"><span class="hljs-number">3</span></span>) + '@gmail.com' , [Phone] = '+38 (' + LEFT(ABS(CHECKSUM(NEWID())), <span class="hljs-number"><span class="hljs-number">3</span></span>) + ') ' + STUFF(STUFF(LEFT(ABS(CHECKSUM(NEWID())), <span class="hljs-number"><span class="hljs-number">9</span></span>) , <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, '-') , <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, '-') FROM E8 CROSS APPLY ( SELECT TOP(CAST(RAND(N) * <span class="hljs-number"><span class="hljs-number">10</span></span> AS INT)) txt FROM ( VALUES (N'Boris_the_Blade'), (N'John'), (N'Steve'), (N'Mike'), (N'Phil'), (N'Sarah'), (N'Ann'), (N'Andrey'), (N'Liz'), (N'Stephanie') ) t(txt) ORDER BY NEWID() ) t</code> </pre><br>  This became a little more realistic: <br><br><pre> <code class="sql hljs">FullName Email Phone <span class="hljs-comment"><span class="hljs-comment">--------------- -------------------------- ------------------- Boris_the_Blade boris_the_blade1@gmail.com +38 (146) 296-33-10 John john130@mail.com +38 (882) 688-98-59 Phil phil155@gmail.com +38 (125) 451-73-71 Mike mike188@gmail.com +38 (111) 169-59-14 Sarah sarah144@gmail.com +38 (723) 124-50-60 Andrey andrey100@gmail.com +38 (193) 160-91-48 Stephanie stephanie188@gmail.com +38 (590) 128-86-02 John john723@gmail.com +38 (194) 101-06-65 Phil phil695@gmail.com +38 (164) 180-57-37 Mike mike200@gmail.com +38 (110) 131-89-45</span></span></code> </pre><br>  However, do not forget that we have foreign keys between the tables and it is already an order of magnitude more difficult to generate consistent data for all other entities.  In order not to invent solutions to this problem, I suggest using one of the date generators, which allows you to create meaningful test data for tables in the database. <br><br><img src="https://habrastorage.org/files/a46/707/6b3/a467076b30854982b881dccf2cfb5618.png"><br><br><pre> <code class="1c hljs">SELECT TOP <span class="hljs-number"><span class="hljs-number">10</span></span> * FROM dbo.Customers ORDER BY NEWID()</code> </pre><br><pre> <code class="sql hljs">CustomerID FullName Email Phone <span class="hljs-comment"><span class="hljs-comment">----------- -------------- ----------------------------------- ----------------- 18319 Noe Pridgen Doyle@example.com (682) 219-7793 8797 Ligia Gaddy CrandallR9@nowhere.com (623) 144-6165 14712 Marry Almond Cloutier39@nowhere.com (601) 807-2247 8280 NULL Lawrence_Z_Mortensen85@nowhere.com (710) 442-3219 8012 Noah Tyler RickieHoman867@example.com (944) 032-0834 15355 Fonda Heard AlfonsoGarcia@example.com (416) 311-5605 10715 Colby Boyd Iola_Daily@example.com (718) 164-1227 14937 Carmen Benson Dennison471@nowhere.com (870) 106-6468 13059 Tracy Cornett DaniloBills@example.com (771) 946-5249 7092 Jon Conaway Joey.Redman844@example.com (623) 140-7543</span></span></code> </pre><br>  Test data is ready.  Let's move on to testing the performance of our stored procedures. <br><br>  We have a <i>GetCustomerID</i> procedure that returns a customer <i>ID</i> , if not, then creates the corresponding entry in the <i>Customers</i> table.  Let's try to do it beforehand by enabling the display of the actual execution plan: <br><br><pre> <code class="1c hljs">DECLARE @CustomerID INT EXEC dbo.GetCustomerID @FullName = N'' , @Email = 'sergeys@mail.ru' , @Phone = '<span class="hljs-number"><span class="hljs-number">710544</span></span>5' , @CustomerID = @CustomerID OUT SELECT @CustomerID</code> </pre><br>  On the execution plan, you can see that a full scan of the cluster index is happening: <br><br><img src="https://habrastorage.org/files/b81/2cc/3ba/b812cc3ba7e64feb82ab4432a9bd6ef4.png"><br><br>  And to do this, <i>SQL Server</i> has to do 200 logical reads from a table, and all this takes about 20 milliseconds: <br><br><pre> <code class="sql hljs">Table 'Customers'. Scan count 1, logical reads 200, physical reads 0, ... SQL Server Execution Times: CPU time = 0 ms, elapsed time = 20 ms.</code> </pre><br>  But we are talking about the execution time of a single request.  What if this stored procedure is very active with us?  Continuous index scans will slow down server performance. <br><br>  Let's try performing the stress tests of our stored procedure using one interesting SQLQueryStress <a href=""><i>open source tutor</i></a> , which was developed by <i>Adam Machanic</i> (link to <a href="https://github.com/ErikEJ/SqlQueryStress"><i>GitHub</i></a> ). <br><br><img src="https://habrastorage.org/files/072/44b/3b2/07244b3b28d543febeecb22f136bad37.png"><br><br>  We see that a call 2,000 times of the <i>GetCustomerID</i> procedure in two threads took a little less than 4 seconds on the server.  Now let's try to see what will happen if we add an index to the field by which our search takes place: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> NONCLUSTERED <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> IX_Email <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dbo.Customers (Email)</code> </pre><br>  <i>Index Seek</i> appeared on the execution plan instead of <i>Index Scan</i> : <br><br><img src="https://habrastorage.org/files/f90/a3f/3d2/f90a3f3d217541239dad85f66d8641f8.png"><br><br>  Logical reads and overall execution times have been reduced: <br><br><pre> <code class="sql hljs">Table 'Customers'. Scan count 1, logical reads 2, ... SQL Server Execution Times: CPU time = 0 ms, elapsed time = 8 ms.</code> </pre><br>  If we repeat our stress test in <i>SQLQueryStress</i> , then we will be able to see that now our procedure with a multiple call will load the server less and run faster: <br><br><img src="https://habrastorage.org/files/dcf/e27/0fa/dcfe270fa47840ad90417e58f8756d05.png"><br><br>  Now, let's try using <i>SQLQueryStress to</i> emulate a mass order placement: <br><br><pre> <code class="1c hljs">DECLARE @CustomerID INT , @CustomerNotes NVARCHAR(MAX) , @Products XML SELECT TOP(<span class="hljs-number"><span class="hljs-number">1</span></span>) @CustomerID = CustomerID , @CustomerNotes = REPLICATE('a', RAND() * <span class="hljs-number"><span class="hljs-number">100</span></span>) FROM dbo.Customers ORDER BY NEWID() SELECT @Products = ( SELECT [@ProductID] = ProductID , [@Quantity] = CAST(RAND() * <span class="hljs-number"><span class="hljs-number">10</span></span> AS INT) FROM dbo.Products ORDER BY ProductID OFFSET CAST(RAND() * <span class="hljs-number"><span class="hljs-number">1000</span></span> AS INT) ROWS FETCH NEXT CAST(RAND() * <span class="hljs-number"><span class="hljs-number">10</span></span> AS INT) + <span class="hljs-number"><span class="hljs-number">1</span></span> ROWS ONLY FOR XML PATH('item'), ROOT('items') ) EXEC dbo.CreateOrder @CustomerID = @CustomerID , @CustomerNotes = @CustomerNotes , @Products = @Products</code> </pre><br><img src="https://habrastorage.org/files/df3/bf1/5b3/df3bf15b3dbd464d99b6f30e93460ce0.png"><br><br>  Performing the procedure 100 times in two threads simultaneously took 2.5 seconds.  Let's clear the statistics of expectations: <br><br><pre> <code class="1c hljs">DBCC SQLPERF(<span class="hljs-string"><span class="hljs-string">"sys.dm_os_wait_stats"</span></span>, CLEAR)</code> </pre><br>  <i>Restart SQLQueryStress</i> and see what the expectations were when executing our stored procedure: <br><br><pre> <code class="sql hljs">wait_type wait_time <span class="hljs-comment"><span class="hljs-comment">--------------------------------- ----------- WRITELOG 2.394000 PARALLEL_REDO_WORKER_WAIT_WORK 0.264000 PAGEIOLATCH_SH 0.157000 ASYNC_NETWORK_IO 0.125000 PAGEIOLATCH_UP 0.097000 PREEMPTIVE_OS_FLUSHFILEBUFFERS 0.049000 IO_COMPLETION 0.048000 PAGEIOLATCH_EX 0.043000 PREEMPTIVE_OS_WRITEFILEGATHER 0.037000 LCK_M_IX 0.033000</span></span></code> </pre><br>  We see that in the first place is <i>WRITELOG</i> , which in time roughly corresponds to the total time of our stress test.  What does this delay mean?  Since we have every command for insertion is atomic, then after it is executed, there is a physical fixation of changes in the log.  When we have a large number of short transactions, there is a queue, because operations with the log occur synchronously, unlike data files. <br><br>  In <i>SQL Server 2014</i> , the ability to set up a delayed write to the <a href="https://habrahabr.ru/post/303156/"><i>Delayed Durability</i></a> log has been added, which is enabled at the database level: <br><br><pre> <code class="1c hljs">ALTER DATABASE db_sales SET DELAYED_DURABILITY = ALLOWED</code> </pre><br>  And then we just need to slightly change the stored procedure: <br><br><pre> <code class="1c hljs">ALTER PROCEDURE dbo.CreateOrder ( @CustomerID INT , @CustomerNotes NVARCHAR(MAX) , @Products XML ) AS BEGIN SET NOCOUNT ON; BEGIN TRANSACTION t DECLARE @OrderID INT INSERT INTO dbo.Orders (CustomerID, CustomerNotes) VALUES (@CustomerID, @CustomerNotes) SET @OrderID = SCOPE_IDENTITY() INSERT INTO dbo.OrderDetails (OrderID, ProductID, Quantity) SELECT @OrderID , tcvalue('@ProductID', 'INT') , tcvalue('@Quantity', 'INT') FROM @Products.nodes('items/item') t(c) COMMIT TRANSACTION t WITH (DELAYED_DURABILITY = ON) END</code> </pre><br>  Clean up the statistics and rerun the stress test: <br><br><img src="https://habrastorage.org/files/cdd/964/6cb/cdd9646cb52c4eb28f6269605b1fe703.png"><br><br>  We see that the total execution time has been reduced by half, and the delays of the <i>WRITELOG</i> have become minimal: <br><br><pre> <code class="sql hljs">wait_type wait_time <span class="hljs-comment"><span class="hljs-comment">-------------------------- ---------- PREEMPTIVE_OS_WRITEFILE 0.027000 PAGEIOLATCH_EX 0.024000 PAGELATCH_EX 0.020000 WRITELOG 0.014000</span></span></code> </pre><br>  Now consider another situation when you need to periodically check the performance of a particular query.  Using <i>SQLQueryStress</i> for this will not be so convenient, because you will have to open the application, copy the query there and wait for the execution. <br><br>  Is it possible to automate it? .. <br><br>  In 2014, I first met <a href="http://tsqlt.org/"><i>tSQLt</i></a> , which turned out to be quite a wonderful free framework for unit testing.  Let's try to install <i>tSQLt</i> and create an autotest using it to check the performance of our stored procedure. <br><br>  Download the latest version of <a href="http://tsqlt.org/download/tsqlt/"><i>tSQLt</i></a> , configure an instance of <i>SQL Server</i> to work with the <i>CLR</i> : <br><br><pre> <code class="1c hljs">EXEC sys.sp_configure 'clr enabled', <span class="hljs-number"><span class="hljs-number">1</span></span> RECONFIGURE GO ALTER DATABASE [db_sales] SET TRUSTWORTHY ON GO</code> </pre><br>  After that, we will execute the <i>tSQLt.class.sql</i> script from the archive on our database.  The script will create its own <i>tSQLt</i> scheme, <i>CLR</i> assembly and many scripted objects.  Some of the procedures will contain the prefix <i>Private_</i> which are intended for internal use by the framework itself. <br><br>  If everything is set correctly, then in <i>Output</i> we will receive the following message: <br><br><pre> <code class="sql hljs">+<span class="hljs-comment"><span class="hljs-comment">-----------------------------------------+ | | | Thank you for using tSQLt. | | | | tSQLt Version: 1.0.5873.27393 | | | +-----------------------------------------+</span></span></code> </pre><br>  Now we will create a scheme in which we will create autotests: <br><br><pre> <code class="1c hljs">USE [db_sales] GO CREATE SCHEMA [Performance] GO EXEC sys.sp_addextendedproperty @name = N'tSQLt.Performance' , @value = <span class="hljs-number"><span class="hljs-number">1</span></span> , @level0type = N'SCHEMA' , @level0name = N'Performance' GO</code> </pre><br>  It should be noted that the <i>Extended Property</i> determines whether an object belongs to the <i>tSQLt</i> functionality. <br><br>  Create a test in the Performance schema by specifying the test prefix in the test name: <br><br><pre> <code class="1c hljs">CREATE PROCEDURE [Performance].[test ProcTimeExecution] AS BEGIN SET NOCOUNT ON; EXEC tSQLt.Fail 'TODO: Implement this test.' END</code> </pre><br>  We try to execute the created autotest.  For this we can either perform: <br><br><pre> <code class="1c hljs">EXEC tSQLt.RunAll</code> </pre><br>  Or explicitly specify the scheme: <br><br><pre> <code class="1c hljs">EXEC tSQLt.Run 'Performance'</code> </pre><br>  or a specific test: <br><br><pre> <code class="1c hljs">EXEC tSQLt.Run 'Performance.test ProcTimeExecution'</code> </pre><br>  If you want to run the last test run, you can call Run without parameters: <br><br><pre> <code class="1c hljs">EXEC tSQLt.Run</code> </pre><br>  After executing one of the commands above, we obtain the following information: <br><br><pre> <code class="sql hljs">[Performance].[test ProcTimeExecution] failed: (Failure) TODO: Implement this test. +<span class="hljs-comment"><span class="hljs-comment">----------------------+ |Test Execution Summary| +----------------------+ |No|Test Case Name |Dur(ms)|Result | +--+--------------------------------------+-------+-------+ |1 |[Performance].[test ProcTimeExecution]| 0|Failure|</span></span></code> </pre><br>  Let's try to change the content in the AutoTest to something more useful.  For example, take the <i>GetUnprocessedOrders</i> procedure, which returns a list of unprocessed orders: <br><br><pre> <code class="1c hljs">CREATE PROCEDURE dbo.GetUnprocessedOrders AS BEGIN SET NOCOUNT ON; SELECT o.OrderID , o.OrderDate , c.FullName , c.Email , c.Phone , OrderSum = ( SELECT SUM(p.Price + d.Quantity) FROM dbo.OrderDetails d JOIN dbo.Products p ON d.ProductID = p.ProductID WHERE d.OrderID = o.OrderID ) FROM dbo.Orders o JOIN dbo.Customers c ON o.CustomerID = c.CustomerID WHERE o.IsProcessed = <span class="hljs-number"><span class="hljs-number">0</span></span> END</code> </pre><br>  and create an autotest that will perform the procedure n-th number of times and fail with an error if the average execution time is greater than the specified threshold value. <br><br><pre> <code class="1c hljs">ALTER PROCEDURE [Performance].[test ProcTimeExecution] AS BEGIN SET NOCOUNT ON; DECLARE @time DATETIME , @duration BIGINT = <span class="hljs-number"><span class="hljs-number">0</span></span> , @cnt TINYINT = <span class="hljs-number"><span class="hljs-number">10</span></span> WHILE @cnt &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> BEGIN SET @time = GETDATE() EXEC dbo.GetUnprocessedOrders SET @duration += DATEDIFF(MILLISECOND, @time, GETDATE()) SET @cnt -= <span class="hljs-number"><span class="hljs-number">1</span></span> END IF @duration / <span class="hljs-number"><span class="hljs-number">10</span></span> &gt; <span class="hljs-number"><span class="hljs-number">100</span></span> BEGIN DECLARE @txt NVARCHAR(MAX) = 'High average execution time: ' + CAST(@duration / <span class="hljs-number"><span class="hljs-number">10</span></span> AS NVARCHAR(<span class="hljs-number"><span class="hljs-number">10</span></span>)) + ' ms' EXEC tSQLt.Fail @txt END END</code> </pre><br>  Carry out autotest: <br><br><pre> <code class="1c hljs">EXEC tSQLt.Run 'Performance'</code> </pre><br>  And we get the following message: <br><br><pre> <code class="sql hljs">[Performance].[test ProcTimeExecution] failed: (Error) High execution time: 161 ms +<span class="hljs-comment"><span class="hljs-comment">----------------------+ |Test Execution Summary| +----------------------+ |No|Test Case Name |Dur(ms)|Result| +--+--------------------------------------+-------+------+ |1 |[Performance].[test ProcTimeExecution]| 1620|Error |</span></span></code> </pre><br>  Let's try to optimize the query and make the test pass.  First, look at the execution plan: <br><br><img src="https://habrastorage.org/files/51b/f25/485/51bf25485bba4da89c9ede717d8cc87a.png"><br><br>  We see that the problem is often referring to the clustered index of the <i>Products</i> table.  A large number of logical readings also confirm this statement: <br><br><pre> <code class="sql hljs">Table 'Customers'. Scan count 1, logical reads 200, ... Table 'Orders'. Scan count 1, logical reads 3886, ... Table 'Products'. Scan count 0, logical reads 73607, ... Table 'OrderDetails'. Scan count 1, logical reads 235, ...</code> </pre><br>  How can the situation be corrected?  You can add a nonclustered index and include the <i>Price</i> field there, make a preliminary calculation of the values ‚Äã‚Äãin a separate table, or alternatively create an aggregated index view: <br><br><pre> <code class="1c hljs">CREATE VIEW dbo.vwOrderSum WITH SCHEMABINDING AS SELECT d.OrderID , OrderSum = SUM(p.Price + d.Quantity) , OrderCount = COUNT_BIG(*) FROM dbo.OrderDetails d JOIN dbo.Products p ON d.ProductID = p.ProductID GROUP BY d.OrderID GO CREATE UNIQUE CLUSTERED INDEX IX_OrderSum ON dbo.vwOrderSum (OrderID)</code> </pre><br>  And change the stored procedure: <br><br><pre> <code class="1c hljs">ALTER PROCEDURE dbo.GetUnprocessedOrders AS BEGIN SET NOCOUNT ON; SELECT o.OrderID , o.OrderDate , c.FullName , c.Email , c.Phone , s.OrderSum FROM dbo.Orders o JOIN dbo.Customers c ON o.CustomerID = c.CustomerID JOIN dbo.vwOrderSum s WITH(NOEXPAND) ON o.OrderID = s.OrderID WHERE o.IsProcessed = <span class="hljs-number"><span class="hljs-number">0</span></span> END</code> </pre><br>  <a href="http://sqlperformance.com/2015/12/sql-performance/noexpand-hints"><i>It is</i></a> advisable to specify the <a href="http://sqlperformance.com/2015/12/sql-performance/noexpand-hints"><i>NOEXPAND hint</i></a> to make the optimizer always use the index from our view.  In addition, to reduce the number of logical reads from <i>Orders,</i> you can create a filtered index: <br><br><pre> <code class="1c hljs">CREATE NONCLUSTERED INDEX IX_UnProcessedOrders ON dbo.Orders (OrderID, CustomerID, OrderDate) WHERE IsProcessed = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  Now when executing our stored procedure, a simpler plan will be used: <br><br><img src="https://habrastorage.org/files/c21/677/1af/c216771af0d645408972da22bc80d71d.png"><br><br>  Logical readings will be less: <br><br><pre> <code class="sql hljs">Table 'Customers'. Scan count 1, logical reads 200, ... Table 'Orders'. Scan count 1, logical reads 21, ... Table 'vwOrderSum'. Scan count 1, logical reads 44, ...</code> </pre><br>  The execution of the stored procedure is reduced and our test will be executed successfully: <br><br><pre> <code class="sql hljs">|No|Test Case Name |Dur(ms)|Result | +<span class="hljs-comment"><span class="hljs-comment">--+--------------------------------------+-------+-------+ |1 |[Performance].[test ProcTimeExecution]| 860|Success|</span></span></code> </pre><br>  We can say that we managed.  Optimized all bottlenecks and made a really cool product.  But let's face it.  Data tend to accumulate, and <i>SQL Server</i> generates an execution plan based on the expected number of rows.  Now we have conducted testing for growth, however, there is no guarantee that after a year of work the implementation plan will be just as effective, the scheme will not change, someone will not mistakenly delete the necessary index, and so on ... Therefore, it is extremely important to run such tests on a regular basis to quickly identify problems. <br><br>  Now let's see what else such useful can be done with the help of unit tests. <br><br>  For example, we can see in all execution plans whether there is a <i>MissingIndexGroup</i> section.  If it is, then SQL Server considers that there is not enough index for a specific query: <br><br><pre> <code class="1c hljs">CREATE PROCEDURE [Performance].[test MissingIndexes] AS BEGIN SET NOCOUNT ON DECLARE @msg NVARCHAR(MAX) , @rn INT SELECT t.text , p.query_plan , q.total_worker_time / <span class="hljs-number"><span class="hljs-number">100000</span></span>. FROM ( SELECT TOP <span class="hljs-number"><span class="hljs-number">100</span></span> * FROM sys.dm_exec_query_stats ORDER BY total_worker_time DESC ) q CROSS APPLY sys.dm_exec_sql_text(q.sql_handle) t CROSS APPLY sys.dm_exec_query_plan(q.plan_handle) p WHERE p.query_plan.exist('//*:MissingIndexGroup') = <span class="hljs-number"><span class="hljs-number">1</span></span> SET @rn = @@ROWCOUNT IF @rn &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> BEGIN SET @msg = 'Missing index in ' + CAST(@rn AS VARCHAR(<span class="hljs-number"><span class="hljs-number">10</span></span>)) + ' queries' EXEC tSQLt.Fail @msg END END</code> </pre><br>  You can also automate the search for unused indexes.  This is all done quite simply - just find out the statistics of the use of an index in <a href="https://msdn.microsoft.com/en-us/library/ms188755.aspx"><i>dm_db_index_usage_stats</i></a> : <br><br><pre> <code class="1c hljs">CREATE PROCEDURE [Performance].[test UnusedUndexes] AS BEGIN DECLARE @tables INT , @indexes INT , @msg NVARCHAR(MAX) SELECT @indexes = COUNT(*) , @tables = COUNT(DISTINCT o.[object_id]) FROM sys.objects o CROSS APPLY ( SELECT s.index_id , index_usage = s.user_scans + s.user_lookups + s.user_seeks , usage_percent = (s.user_scans + s.user_lookups + s.user_seeks) * <span class="hljs-number"><span class="hljs-number">100</span></span>. / NULLIF(SUM(s.user_scans + s.user_lookups + s.user_seeks) OVER (), <span class="hljs-number"><span class="hljs-number">0</span></span>) , index_count = COUNT(*) OVER () FROM sys.dm_db_index_usage_stats s WHERE s.database_id = DB_ID() AND s.[object_id] = o.[object_id] ) t WHERE o.is_ms_shipped = <span class="hljs-number"><span class="hljs-number">0</span></span> AND o.[schema_id] != SCHEMA_ID('tSQLt') AND o.[type] = 'U' AND ( (t.usage_percent &lt; <span class="hljs-number"><span class="hljs-number">5</span></span> AND t.index_usage &gt; <span class="hljs-number"><span class="hljs-number">100</span></span> AND t.index_count &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) OR t.index_usage = <span class="hljs-number"><span class="hljs-number">0</span></span> ) IF @tables &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> BEGIN SET @msg = 'Database contains ' + CAST(@indexes AS VARCHAR(<span class="hljs-number"><span class="hljs-number">10</span></span>)) + ' unused indexes in ' + CAST(@tables AS VARCHAR(<span class="hljs-number"><span class="hljs-number">10</span></span>)) + ' tables' EXEC tSQLt.Fail @msg END END</code> </pre><br>  When developing large and complex systems, it is often possible to come across situations when a table was added to the system, data was inserted there and the existence of it was forgotten. <br><br>  How to identify such tables?  For example, they are not referenced; selection from these tables has not taken place since the server was started, provided that the server has been running for more than a week.  The conditions are relative and can be modified for each specific task. <br><br><pre> <code class="1c hljs">CREATE PROCEDURE [Performance].[test UnusedTables] AS BEGIN SET NOCOUNT ON DECLARE @msg NVARCHAR(MAX) , @rn INT , @txt NVARCHAR(<span class="hljs-number"><span class="hljs-number">1000</span></span>) = N'Starting up database ''' + DB_NAME() + '''.' DECLARE @database_start TABLE ( log_date SMALLDATETIME, spid VARCHAR(<span class="hljs-number"><span class="hljs-number">50</span></span>), msg NVARCHAR(<span class="hljs-number"><span class="hljs-number">4000</span></span>) ) INSERT INTO @database_start EXEC sys.xp_readerrorlog <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, @txt SELECT o.[object_id] , [object_name] = SCHEMA_NAME(o.[schema_id]) + '.' + o.name FROM sys.objects o WHERE o.[type] = 'U' AND o.is_ms_shipped = <span class="hljs-number"><span class="hljs-number">0</span></span> AND o.[schema_id] != SCHEMA_ID('tSQLt') AND NOT EXISTS( SELECT * FROM sys.dm_db_index_usage_stats s WHERE s.database_id = DB_ID() AND s.[object_id] = o.[object_id] AND ( s.user_seeks &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> OR s.user_scans &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> OR s.user_lookups &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> OR s.user_updates &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ) ) AND NOT EXISTS( SELECT * FROM sys.sql_expression_dependencies s WHERE o.[object_id] IN (s.referencing_id, s.referenced_id) ) AND EXISTS( SELECT <span class="hljs-number"><span class="hljs-number">1</span></span> FROM @database_start t HAVING MAX(t.log_date) &lt; DATEADD(DAY, -<span class="hljs-number"><span class="hljs-number">7</span></span>, GETDATE()) ) SET @rn = @@ROWCOUNT IF @rn &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> BEGIN SET @msg = 'Database contains ' + CAST(@rn AS VARCHAR(<span class="hljs-number"><span class="hljs-number">10</span></span>)) + ' unused tables' EXEC tSQLt.Fail @msg END END</code> </pre><br>  And such tests, as I quoted above, you can create many more ... <br><br>  As a conclusion, I honestly do not know what else can be added to what was written earlier.  Probably only one.  Try <a href="http://tsqlt.org/"><i>tSQLt</i></a> and <a href="http://sqlblog.com/blogs/adam_machanic/archive/2016/01/04/sqlquerystress-the-source-code.aspx"><i>SQLQueryStress</i></a> .  These products are completely free and in practice they helped me out more than once with <i>SQL Server</i> load testing and performance optimization on the server. </div><p>Source: <a href="https://habr.com/ru/post/310328/">https://habr.com/ru/post/310328/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310314/index.html">Inheritance implementations: bury stewardess</a></li>
<li><a href="../310318/index.html">Getting Started with Intel Active Management (AMT)</a></li>
<li><a href="../310320/index.html">The language of arithmetic expressions with the let construction as dsl on Kotlin</a></li>
<li><a href="../310324/index.html">Rag I limp or have power?</a></li>
<li><a href="../310326/index.html">UWP beginner: Window title in applications (VB.NET + C #)</a></li>
<li><a href="../310330/index.html">Azure-IaaS-Digest number 10 (August-September)</a></li>
<li><a href="../310332/index.html">DetectNet: Deep Neural Network for Object Detection at DIGITS</a></li>
<li><a href="../310334/index.html">Introducing Apache Ignite: First Steps</a></li>
<li><a href="../310336/index.html">The main characteristics of a quality code</a></li>
<li><a href="../310338/index.html">About fundamental mistakes in the design of programming languages</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>