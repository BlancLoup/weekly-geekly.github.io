<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fast ip positioning in postgresql</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this topic, I want to talk about a task that is very common in web projects - determining the location by ip-address. To begin with, in order to de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fast ip positioning in postgresql</h1><div class="post__text post__text-html js-mediator-article">  In this topic, I want to talk about a task that is very common in web projects - determining the location by ip-address.  To begin with, in order to determine the location of a user, a certain geoip base is needed.  Here are two popular free options: <br>  <a href="http://ipgeobase.ru/">IpGeoBase</a> is a very good free base, but, unfortunately, only on Russian ip-addresses. <br>  <a href="http://www.maxmind.com/">MaxMind</a> is a huge database of ip-addresses of all countries.  Provide a free lite version of the database.  The accuracy of the database on Russian ip-addresses is not as good as that of IpGeoBase.  Also provide some kind of API for working with your database, which allows you to make samples very quickly. <br><br>  Suppose you downloaded these databases and uploaded them to your Postgresql database tables (the download itself is somewhat out of scope, if someone has a desire - I can tell you about the COPY command in the future and what they eat with).  In general, you will get a table with this structure: <br><br><table><tbody><tr><th>  startip </th><th>  endip </th><th>  location_id </th></tr><tr><td>  2130706433 </td><td>  2130706433 </td><td>  one </td></tr></tbody></table><br>  Here: <br>  <b>startip</b> is the beginning of the block of ip-addresses in the long format <br>  <b>endip</b> - the end of the block of ip-addresses in the long format <br>  <b>location_id</b> - <b>location</b> identifier (city, region, country, etc., maxmind even contains coordinates). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h2>  Decision number 1 </h2><br>  The first time I encountered this, I simply decided to do it on the machine as follows: <br>  1. Create an index on (startip, endip) <br>  2. Create a simple function to convert ip-address to BIGINT: <br> <code>CREATE OR REPLACE FUNCTION "public"."extract_long_from_ip" (ip text) <br> RETURNS bigint AS <br> $body$ <br> SELECT (((elements[1]::bigint * 256) + elements[2]::bigint) * 256 + elements[3]::bigint) * 256 + elements[4]::bigint <br> FROM ( <br> SELECT string_to_array($1, '.') as elements <br> ) t; <br> $body$ LANGUAGE 'sql' IMMUTABLE; <br></code> <br>  3. Voila: <br> <code>SELECT location_id <br> FROM geo.ip_blocks <br> WHERE extract_long_from_ip('93.158.134.8') BETWEEN startip AND endip; <br></code> <br>  And everything is so simple?  - you ask.  But never once.  This query will work correctly, but very slowly.  The thing is that postgresql does not know how to use an index in queries of the form "SOMETHING BETWEEN X AND Y".  If the location needs to be determined quickly (and I had just such a case) - seq scan of the entire table is simply no good. <br><br>  And now what?  Transfer location by ip to the application?  Not necessarily - the search can be significantly accelerated.  For this we use the wonderful module - <a href="http://pgfoundry.org/projects/ip4r/">ip4r</a> . <br><br><h2>  Installation </h2><br> <code>su -c 'yum install postgresql-ip4r'</code> <br>  or <br> <code>sudo apt-get install postgresql-8.3-ip4r</code> <br>  or simply download from the site. <br><br>  We look for the file ip4r.sql in the contrib directory and install it in the base we need: <br> <code>psql -U user -f "...../contrib/ip4r.sql" database</code> <br> <br><h2>  Table structure </h2><br>  The ip4r module provides two new types: ip4 and ip4r.  The first corresponds to the IPv4 address.  The second - a certain range of IPv4 addresses.  The type ip4r is especially interesting to us - the fact is that it is indexable. <br><br>  Let's change our table: <br> <code>ALTER TABLE geo.ip_blocks ADD COLUMN ip_range ip4r; <br> UPDATE geo.ip_blocks SET ip_range = ip4r(startip::ip4, endip::ip4); <br> ALTER TABLE geo.ipblocks DROP COLUMN startip; <br> ALTER TABLE geo.ipblocks DROP COLUMN endip; <br></code> <br>  Create an index: <br> <code>CREATE INDEX ip_blocks_idx ON geo.ip_blocks USING gist (ip_range); <br></code> <br><h2>  That's all </h2><br>  We use this simple request and get the acceleration hundreds of times: <br> <code>SELECT location_id FROM geo.ip_blocks WHERE ip_range &gt;&gt;= '93.158.134.8'::ip4; <br></code> <br><br>  <b>UPD:</b> <br>  All, of course, strongly depends on the hardware and the load of the base.  But, for example, I got the following results: <br> <code>NOTICE: 100 queries without ip4r 00:00:14.988 <br> NOTICE: 100 queries with ip4r 00:00:00.008 <br></code> <br><br>  <b>UPD2:</b> <br>  The comments suggested another solution for quick search by ip. <br>  Ip4r is not used, the startip index is created and we use a small trick in the request: <br> <code>CREATE INDEX ip_blocks_idx ON geo.ip_blocks USING btree(startip); <br> SELECT CASE WHEN extract_long_from_ip('93.158.134.8') &lt;= endip <br> THEN location_id <br> ELSE NULL END AS location_id <br> FROM geo.ip_blocks <br> WHERE startip &lt;= extract_long_from_ip('93.158.134.8') <br> ORDER BY startip DESC <br> LIMIT 1; <br></code> <br><br>  <b>UPD3:</b> <br>  From the comments - another place where you can take a geoip base.  Based on maxmind lite, but not bad reworked + comes in a SQL database format or CSV.  There's also a good description of how to work with this base. <br>  <a href="http://ipinfodb.com/ip_database.php">http://ipinfodb.com/ip_database.php</a> </div><p>Source: <a href="https://habr.com/ru/post/72674/">https://habr.com/ru/post/72674/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../72657/index.html">Karmic Release Party Minsk</a></li>
<li><a href="../72658/index.html">Google Wave: Pulp Fiction</a></li>
<li><a href="../72665/index.html">jQuery GridWizard - Visual Table Designer</a></li>
<li><a href="../72667/index.html">small hack for Zend_Db_Table_Row class</a></li>
<li><a href="../72673/index.html">Proposed anti-piracy legislation cracked</a></li>
<li><a href="../72676/index.html">Using Vim to edit plain text</a></li>
<li><a href="../72680/index.html">Internet security</a></li>
<li><a href="../72681/index.html">How did you imagine the future of AT & T in 1993</a></li>
<li><a href="../72682/index.html">Habrahabr, Live Writer and Code Highlighting</a></li>
<li><a href="../72683/index.html">Corsair has announced a heavy-duty flash drive with a capacity of 64 GB</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>