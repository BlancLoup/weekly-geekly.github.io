<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Algorithm: How to make a bug on the Linux kernel</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My experience in the development and debugging of Parallels Virtuozzo Containers allowed me to summarize and formulate a wish list for the user proble...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Algorithm: How to make a bug on the Linux kernel</h1><div class="post__text post__text-html js-mediator-article">  My experience in the development and debugging of Parallels Virtuozzo Containers allowed me to summarize and formulate a wish list for the user problem description, which can significantly reduce the time to diagnose and solve the problem in the Linux kernel.  Please note that with all the obviousness of some of the recommendations, many members of the open-source community still neglect them.  The algorithm is a tackle. <br><a name="habracut"></a><br><ol><li>  Description of the problem. <br>  The most important thing you have to do is to accurately describe the problem and the actions that lead to it.  Any, even the smallest detail, can be important.  To the same point can be attributed the question: "How often is the bug reproduced?". <br></li><li> Kernel version <br>  It is better if you attach the output of the command to the bug: <br> <code># uname -a</code> <br> </li><li>  Where did you get the core? <br>  The linux kernel is distributed both in binary form and in source codes.  In the bug it is important to specify the exact version of the kernel and by whom it was assembled.  If you assembled it yourself, you need to attach the config and you may also need a vmlinux or module.  When crashing, the developers often match the disassembled code and the C code to determine the exact place where the bug occurred. <br></li><li>  Kernel logs. <br>  Perhaps for individual users this is the most difficult topic.  The most reliable way to collect logs is the serial port and the second machine.  At home, not everyone has such an opportunity, and serial ports have become rare. <br>  The next step was netconsole.  With it, you only need to configure rsyslogd on one machine to collect logs via the network and register its address on all servers.  This method may not work, especially if the bug is connected to the network. <br>  Netconsole has simplified setting up log collection from servers, but the problem of users remained relevant, and kdump was invented.  At the moment it is the most powerful and at the same time the most unreliable mechanism.  In the case of system crash, a memory image is saved to disk.  Later, you can open it with the crash utility and find out the status of all processes, the kernel logs, the memory value at a given address, and so on. It is somewhat similar to the core file that applications postpone in the event of a crash. <br></li><li>  The version and name of the distribution and applications directly related to the problem. <br>  It only seems that the kernel lies under user applications, and their work depends on the behavior of the kernel.  But it often happens that the behavior of the kernel depends on user applications. <br></li><li>  Network problems. <br>  Some packages do not reach the recipients, or vice versa, something extra leaks through the filters.  In this case, it is useful to attach the tcpdump log on both sides. <br></li><li>  Sysrq <br>  This is such a magic key combination.  Hold Alt and press Prt-Scr and the letter in sequence.  If you press H, then a little help will appear in the kernel logs. <br>  The most common use case for sysrq is all possible freezes.  First you should press L, which will print information about what each processor is doing at the moment.  T - prints the status of each process.  Also, using these keys, you can kill all processes except init, flush the data from memory to disk, reboot the machine, send the car to panic, show the state of the timers and memory, etc. <br></li><li>  Boot options <br>  You can read about kernel parameters in Documentation / kernel-parameters.txt.  In case of a bug, I would recommend including the following: <br>  <i>sysrq_always_enabled</i> ‚Äî sysrq magic keys are enabled <br>  <i>debug</i> - improves kernel logging <br>  <i>earlyprintk</i> - print the kernel log at an early stage.  This option should be enabled if the machine on boot does not issue anything and hangs. <br>  I would also recommend removing the <i>quiet</i> option, which in some distributions is enabled by default.  With it, the kernel does not print part of the logs. <br></li></ol><br><h2>  Additional debugging tools. </h2><br><ol><li>  Kernel debug <br>  You probably noticed that in distributions most often there are two cores of the same version.  One of them has a debug prefix.  This kernel is a bit slower and contains a number of additional checks.  For example: it fills the freed memory with a special template, checks that the kernel does not fall asleep with forbidden interrupts, tracks the order in which locks are taken, and so on. <br>  If your bug is stable, it will be useful to try to reproduce it on the debug core and provide logs from it. <br></li><li>  Tracer <br>  This item is more likely for very advanced users who want to deal with the problem themselves. <br>  The interface to this mechanism is fully implemented in debugfs: <br> <code>mount debugfs -t debugfs /debug <br> cd /debug/tracing</code> <br>  There are two types of tracers.  The first is the events, the developers obviously in the code report them.  And the second ftrace is a tracer, which shows in which order the kernel functions were called.  All events from tracers can be filtered, turned on and off separately.  In case events are disabled, they practically do not affect the performance of the kernel. <br></li></ol><br><h2>  And in conclusion some useful tips. </h2><br><ol><li>  The application does not work correctly or freezes.  Try using the strace utility, it shows all system calls with arguments and return code. <br></li><li>  The process is in a state of D "uninterruptible sleep".  Most likely the process is in the core.  You can try to look in / proc / [PID] / stack and / proc / [PID] / status. <br></li><li>  If you have a panic.  View the log from the beginning.  Often at the end of the log are error messages that are a consequence of the previous ones.  Bug need to score on the first error. <br></li><li>  In order for the kernel to save memory dumps to disk, you need to load the kernel with the <i>crashkernel = 128M</i> option, install kexec-tools on the machine and start the kdump service.  Dumps will be saved in / var / crash <br></li><li>  Kernel logs can be obtained from the core dump using the makedumpfile utility: <br> <code>makedumpfile ‚Äîdump-dmesg vmcore log.txt</code> <br> </li></ol><br><h2>  Links </h2><br>  <a href="http://git.kernel.org/%3Fp%3Dlinux/kernel/git/torvalds/linux-2.6.git%3Ba%3Dblob%3Bf%3DDocumentation/kdump/kdump.txt%3Bhb%3DHEAD">Documentation / kdump / kdump.txt</a> <br>  <a href="http://git.kernel.org/%3Fp%3Dlinux/kernel/git/torvalds/linux-2.6.git%3Ba%3Dblob%3Bf%3DDocumentation/kernel-parameters.txt%3Bhb%3DHEAD">Documentation / kernel-parameters.txt</a> <br>  <a href="http://git.kernel.org/%3Fp%3Dlinux/kernel/git/torvalds/linux-2.6.git%3Ba%3Dblob%3Bf%3DDocumentation/networking/netconsole.txt%3Bhb%3DHEAD">Documentation / networking / netconsole.txt</a> <br>  <a href="http://git.kernel.org/%3Fp%3Dlinux/kernel/git/torvalds/linux-2.6.git%3Ba%3Dblob%3Bf%3DDocumentation/trace/ftrace.txt%3Bhb%3DHEAD">Documentation / trace / ftrace.txt</a> <br>  <a href="http://ru.wikipedia.org/wiki/Tcpdump">tcpdumpt at wikipedia</a> <br>  <a href="http://en.wikipedia.org/wiki/Strace">strace at wikipedia</a> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/125017/">https://habr.com/ru/post/125017/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125008/index.html">Windows Workflow Foundation - for what and in what cases to apply</a></li>
<li><a href="../125011/index.html">Jumio service suggests using a webcam as a POS terminal.</a></li>
<li><a href="../125013/index.html">Leakage of confidential data through the eyes of 96%</a></li>
<li><a href="../125015/index.html">Canon has released a hybrid mouse and calculator</a></li>
<li><a href="../125016/index.html">Standard anti-virus software for non-standard purposes.</a></li>
<li><a href="../125018/index.html">DDoS-attack on Habrahabr: post-mortem</a></li>
<li><a href="../125019/index.html">Media pirates of the XXI century</a></li>
<li><a href="../125022/index.html">Leaks and laws. Who is guilty?</a></li>
<li><a href="../125023/index.html">Evernote Competition Finalists</a></li>
<li><a href="../125025/index.html">Manage WebSphere Application Server Scheduler Tables from Java</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>