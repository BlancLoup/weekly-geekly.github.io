<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Gearman Queue Server: Practical Experience and the Gearman Monitor && Control web application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Gearman Queue Server is a great tool. But in the work of the queue server in something like a system unit: it does something, but in order to know...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Gearman Queue Server: Practical Experience and the Gearman Monitor && Control web application</h1><div class="post__text post__text-html js-mediator-article">  The Gearman Queue Server is a great tool.  But in the work of the queue server in something like a system unit: it does something, but in order to know what, and to control the process, you need a monitor with a keyboard, and an idea of ‚Äã‚Äãwhat is happening in the system unit. <br>  It often seems that Gearman is like an outlandish tool without a handle: it‚Äôs interesting and beautiful, but it‚Äôs not clear why you need it, but it‚Äôs painful to use. <br>  Need to get out of this situation, Gearman is really good. <br>  Let's consider: <br><ul><li>  Gearman "on the fingers" </li><li>  examples of real-world tasks using gearman </li><li>  web application and class for real-time monitoring and control of processes on the gearman queue server </li></ul><br><br>  Interesting?  I ask under the cat. <br><a name="habracut"></a><br><br><h5>  Is it possible to explain the principle of the Gearman "on the fingers"? </h5><br>  Can. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>What is a worker?</b> <br>  This is just a console script, in which programming language it does not matter.  The script is running constantly, it is a demon. <br>  When started, the worker daemon sends lines to the server ‚Äî the names of the functions it can perform, opens a socket to the server, and waits. <br><br>  <b>What data does a worker get?</b> <br>  Two lines come to the co-worker: the first is the name of the f-function to be executed, and the second is the argument.  We emphasize: it is impossible to transfer several arguments to the worker, an array, an object is just a string, all other data must be converted to a string ‚Äî serialization or json. <br>  Actually, what is surprising is that all data transmission over the protocol, for example, HTTP, is also the transfer of strings only. <br><br>  <b>Where do the lines come from - tasks for the worker?</b> <br>  When sending a task to the server, the Gearman client transmits just two strings ‚Äî the name of the function to be executed and the argument as a string.  In this case, the task in the queue is marked as being in progress. <br><br>  <b>So, what is next?</b> <br>  If the task is a background task, the worker performs the function and sends only the execution signal to the server.  If the task is not a background task, the gearman transmits a string ‚Äî the result of executing the function, and the execution signal. <br>  When a run-time signal is received, Gearman marks the task as completed and removes it from the queue. <br><br>  <b>And if in the process of performing the function, the worker will crash abnormally, or if there is an abnormal situation in the function, that is, the function will not be executed?</b> <br>  Gearman will not receive a successful completion signal in this case, and the task will remain in the queue. <br><br>  <b>What is a customer?</b> <br>  Separate concept ‚Äúclient‚Äù for Gearman is difficult to distinguish.  You can contact Gearman from PL, sending and receiving data - you can send and wait, you can in the background.  But still easier. <br><br>  <b>"Receives", "sends", "come" - how is the data exchange with the server?</b>  <b>Looking for low-level add-ons in PL?</b> <br>  Communication with Gearman takes place via sockets.  It is possible to not have any additions to the PL to work with Gearman, to manage working with sockets and Telnet.  For example, in PHP, you can work with Gearman by installing the <a href="https://pecl.php.net/package/gearman">PECL add-</a> on to the language, or you can use the <a href="https://pear.php.net/package/Net_Gearman/">Pear library</a> by simply connecting files of several classes. <br><br>  <b>If the client sends a task to the server, but there is no worker for this function - is it not free, or not at all?</b> <br>  The task "hangs" in anticipation of the worker.  If there are more tasks for the same function, a queue is formed - Gearman queue server is still. <br><br>  <b>Is it possible to distinguish two tasks on the queue server for the same function?</b> <br>  Not.  No argument, no way. <br><br>  <b>Is it possible to find out which task is sent in the queue?</b> <br>  Since tasks for the same function are indistinguishable, no. <br><br>  <b>Can I find out how many tasks are in the queue?</b> <br>  Yes.  You can also find out how many workers can handle this task, and where are these workers from (IP). <br><br>  <b>Imagine that one task has been entered, and several workers can do it.</b>  <b>Who gets the task?</b> <br>  Tasks are indistinguishable, but workers are also indistinguishable.  What kind of workman Gearman will give the task - so easy not to answer.  No queue of workers. <br><br>  <b>What kinds of tasks are there on the queue server?</b> <br>  Tasks can be divided 1) by priority, 2) background task or not <br>  1) There are three priorities - normal, low - less priority than normal, and high - higher than normal priority.  The priority is taken into account in the queue, the default is the normal priority. <br>  2) The background task does not give anything to the queue server, and the client does not receive any data.  A normal task should return a string, and Gearman will return this string to the client as the result of the task. <br><br>  <b>How many workers can you run at the same time?</b> <br>  Here you need to clarify - not how much to run, but how many workers can simultaneously connect to Gearman to handle tasks. <br>  Theoretically - as much as necessary.  In reality, the maximum number of workers can be limited by the maximum number of simultaneous threads to an external resource, the number of simultaneous connections to the database, and other conditions independent of Gearman.  The author of these lines managed to run about 1000 on one server, then MySQL began to swear. <br><br>  <b>Is it possible to work in PHP with Gearman on Windows?</b> <br>  The question is divided into two: 1) is it possible to start the Gearman queue server itself on Windows and 2) whether it is possible to work with the queue server already on the external host. <br>  1) there is the <a href="https://gist.github.com/mnapoli/5270256">option of installing Gearman on Windows using cygwin</a> <a href="https://gist.github.com/mnapoli/5270256"><br></a> <br>  2) For comfortable work, for use in the code of the usual constructions of the form <pre><code class="php hljs">$worker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GearmanWorker(); $worker-&gt;addServer()</code> </pre> <br>  and similar language additions are required.  This immediately imposes limitations: not only can you not do it under Windows, but you will not be able to do it on the hosting, if you do not have access rights to the server, which allow installing packages. <br>  Denwer and OpenServer do not contain add-ons to work with Gearman. <br>  So, there is no way out, Gearman - only for * nix systems? <br>  Of course not.  Problem Solving - Connecting to the <a href="https://pear.php.net/package/Net_Gearman/">Pear Net_Gearman</a> Library <a href="https://pear.php.net/package/Net_Gearman/">Project</a> <br>  There are other class names and a slightly different logic, but you can survive this and work with Gearman fully. <br><br><h4>  Real tasks using gearman </h4><br><br>  1) An advertising agency accompanies AdWords and Yandex.Direct advertising campaigns for medium and large online stores.  Information about goods changes constantly: prices change (the dollar exchange rate, etc.), new products appear, some goods run out of stock, some are removed from sale.  There are thousands and tens of thousands of products in each store. <br>  The task: to make the information in the AdWords and Yandex.Direct advertising be up-to-date: you need to change prices, add advertisements / groups / campaigns for new products, stop advertising for those who have finished in stock, delete ads for products that have been removed from sale. <br>  The task is simply solved with the use of Gearman: from the database we form tasks - changing prices, adding, stopping, deleting.  Next, tasks are thrown onto the queue server, and there they are quietly processed into several threads: the workers contact the AdWords API or the Yandex.Direct API and perform the required operations. <br>  It turned out like this: <br><img src="https://habrastorage.org/files/94a/2dd/f9e/94a2ddf9e81b4acc9196e5a53e0a697a.png"><br>  Gearman here solves two problems: parallel execution of processes ‚Äî once, and regulation of access to external resources. <br>  <i>Neither the AdWords API nor the Yandex.Direct API will allow you to perform operations in a hundred, for example, flows - there is a limit on the number of requests per second.</i>  <i>In my case, I got a maximum of 4 flows to the AdWords API and 8 flows to Yandex.Direct API.</i> <br>  <i>About runtime.</i>  <i>The initial load of 10k products takes up to several hours, several hundreds of thousands of ads, several hundred campaigns, etc. are created. Update - a few minutes, fully automatic.</i> <br><br>  2) Continuation of task 1. Almost all stores transmit data as an XML file.  But some send a .xls file.  No problem getting the data from the XLS file, there is PHPExcel.  But PHPExcel has a nuance: when processing large files, it slows down a lot, but the main thing is that it consumes memory up to exceeding the limits in php.ini 1024MB and more. <br>  The processing of an XLS file using PHPExcel can be parallelized (the idea was drawn from <a href="https://habrahabr.ru/post/148203/">this publication here</a> , thanks to <a href="https://habrahabr.ru/users/mparshin/" class="user_link">MParshin</a> ).  Workers read the file in rows, each worker is their own lines, so the process is parallelized. <br>  Here Gearman solves two problems: 1) parallel processing and 2) bypassing the limit on the memory limit of a single PHP script. <br>  Of course, in this case it is also impossible to start a thousand, for example, workers - the server's memory is also not infinite.  In my case, it turned out to process the XLS file in 20 threads. <br><br>  3) A large vendor - an equipment manufacturer - wants to know at what prices its equipment is actually traded.  Data can be obtained from the catalog, but again - only from the site.  Standard process: parser, workers in several threads receive data from the catalog site. <br>  The presence of the API in the developed system Gearman Monitor &amp;&amp; Control allows you to demonstrate to the client - the vendor - the acquisition of data in real time. <br>  Here Gearman solves two problems: parallel acquisition and processing of data, and display of the process in real time. <br>  Here is the client interface of the system. <br><img src="https://habrastorage.org/files/b36/c1f/ef6/b36c1fef6ca24d77bbfe1dda065bdef1.png"><br><br>  4) Hotel service providers provide data.  Task: display hotels on the map.  The task seems to be quite simple, since the data is provided along with the coordinates.  But, unfortunately, many of the coordinates provided are incorrect, and customers cannot show this - the address is in one place, and the hotel marker is in a completely different place.  It was decided to independently obtain data using Google geocoder using hotel addresses.  But if you simply call the geocoder in javascript, many markers are not displayed - the javascript tries to get the addresses of all hotels at the same time, the geocoder blocks most requests due to exceeding the limit by the number of calls per second. <br>  Solution: all geocoder requests from javascript are sent to your proxy, which forwards the task to the queue server. <br>  Here Gearman solves the problem of regulating and limiting access to an external resource - the Google Geocoder API. <br><img src="https://habrastorage.org/files/5b0/b1a/f7c/5b0b1af7c38f468280fef157795a73a8.png"><br><br>  5) The last example is the integrated use of the queue server.  The site provides specific information about several thousand objects.  Task: to get and translate this information.  Solution: run the workers for information, and workers for translation.  The first workers in several streams receive information, as soon as the worker receives the required text, he again sets the task for the queue server, the task for the translation workers.  Workers-translators translate it and put the finished material in the database. <br>  Gearman is used here as standard - receiving and processing information in several streams, the only nuance is that the workers themselves set tasks for other workers. <br><br>  Based on practical challenges, Gearman control system requirements have emerged. <br><br>  Imagine that we are working with a queue server.  How to run one worker?  We type in the console <code>php worker.php</code> <br>  Ok, you need to run 20 workers for parallel processing.  Open 20 consoles?  Not an option.  Or you need to run several different workers - the same problem.  So, the class method and implementation in the web interface are required: <br>  <i><b>- start of workers, with the choice of which one and indicating the number</b></i> <br>  Ok, we develop further, started the worker, it works.  And how to stop it?  Necessarily need <br>  <i><b>- stop workers</b></i> <br>  Situation: they launched several different workers in the development process, and - oh, stop, all back, the parameter is not the same!  Help us out: <br>  - stop all workers with one action <br>  But the worker is like a little child: he does something, and what is not clear, he needs supervision.  This will require: <br>  <i><b>- logging the work of the worker</b></i> <br>  Here a little more.  It's very nice to see what the worker is doing, to enjoy the creation.  But here's the situation: bang - and the worker walked out.  Or even better - does not start at all.  And what a mistake?  Is it wrong in the code, or an unhandled exception, or an error from an external service is not provided?  Therefore: <br>  <i><b>- logging of worker errors, including fatal ones</b></i> <br>  The log can be large, its viewing is tedious, and often impossible due to the volume.  required <br>  <i><b>- search in the log of arbitrary text</b></i> <br>  Deal with the workers, they are subject to us.  And the turn? <br>  Again, workers like small children dismantle a handful, but what about that pile?  Therefore: <br>  <i><b>- output of all functions that are registered on the queue server</b></i> <br>  <i><b>- output queue of tasks for each function</b></i> <br>  But now the clients threw 1000 taskouts onto the server of task queues, 1000 of them accumulated one at a time, and one worker clearly cannot cope with it, or there are no workers at all.  Or closer to life: the external service to which the workers addressed is not available, the queue needs to be reset.  How to be?  Is required <br>  <i><b>- reset / clear the queue for each function</b></i> <br>  But we played enough Gearman, you need to disconnect.  Or we did something wrong, sent it to the queue server, and we need to urgently stop everything.  Will help <br>  <i><b>- full reset: clear all queues, stop all workers.</b></i> <br><br>  We add that everything that happens <b>should be displayed in real time without any updates to the page</b> . <br><br>  All the above tasks will be solved by the Gearman_Monitor class and the Gearman Monitor &amp;&amp; Control web application that implements the methods of this class. <br>  <a href="https://github.com/konst21/gearman_monitor_control">Gearman Monitor &amp;&amp; Control project on Github</a> <br><div class="spoiler">  <b class="spoiler_title">Pure web application screenshot</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/085/1d0/bad/0851d0bad5aba94f2c2813e32e8dfdcd.png"></div></div><br><div class="spoiler">  <b class="spoiler_title">The same screenshot with detailed explanations.</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/4ce/6b3/75b/4ce6b375b640e1f43f021573a740e245.png"></div></div><br><br>  Here is a web application video <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/xISLzV9SqzY%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700253&amp;usg=ALkJrhjkIh9SPEsBUWwxbomjLaZtxj5_Yg" frameborder="0" allowfullscreen=""></iframe><br><br>  For use in development, the Gearman_Monitor and Gmonitor_Settings classes are required (the names of the php files match the names of the classes). <br>  The properties and methods of the classes are documented in detail in the files themselves.  We explain only this: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $func_name_synonyms = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'summ'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Sum'</span></span>, <span class="hljs-string"><span class="hljs-string">'muliply'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'    '</span></span>, <span class="hljs-string"><span class="hljs-string">'subtract'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Substract Function'</span></span>, <span class="hljs-string"><span class="hljs-string">'divide'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'ÂäüËÉΩ'</span></span>, );</code> </pre><br>  Here <br>  array key - function name registered by the worker on the queue server <br>  value - What you see in the table, in any form.  This is for the convenience of the operators - once, and another application.  Imagine that several projects are ‚Äúspinning‚Äù on one queue server.  Of course, I want to see not everything in the heap, but only my project.  To do this, we specify synonyms (if not specified, the function name is used), and set the value <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $synonyms_only_view = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>;</code> </pre><br>  In this case, only those for which there are synonyms will be displayed in the table of functions. <br><br>  One more thing.  The web application contains a logger and PHP error handler.  If you connect the gearman_includes.php file to the worker, you can write from the worker to the log that is displayed, and the worker's errors will also be recorded and displayed in the log. <br><br>  There are two workers in the / workers directory.  fake_worker.php is needed for the application to work, the second worker from the running project can be considered as an example. <br><br>  To use the web application you will need: <br>  - creation of the log table in the database (see the file log_create.sql) <br>  - specify the parameters of the database connection in the Gearman_Db.php file <br>  - set write permissions to all directories inside view / Smarty / smarty_dirs (first of all it concerns the view / Smarty / smarty_dirs / templates_ directory) <br>  - specify the Gearman server host in the Gearman_Monitor.php file <br><br>  All successful queues! <br><br>  PS The web application is torn from a working project, there may be some minor inconsistencies, I apologize in advance. <br>  Another moment.  Attempts were made repeatedly to rewrite the web application ‚Äî to refine the code, the interface, but tasks constantly arose with the use of Gearman, and the very first version was quickly finished on the knee.  As a result, it was published as repeatedly tested, reliable, stable and convenient. </div><p>Source: <a href="https://habr.com/ru/post/212761/">https://habr.com/ru/post/212761/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../212741/index.html">How to move away after burning at work</a></li>
<li><a href="../212743/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ96 (February 9 - 15, 2014)</a></li>
<li><a href="../212755/index.html">New, innovative design of the screw from Outlaw Fasteners breaks all the centuries-old foundations</a></li>
<li><a href="../212757/index.html">Kickstarter service hacking</a></li>
<li><a href="../212759/index.html">Compile Try / Catch / Finally for JVM</a></li>
<li><a href="../212765/index.html">Deploying Windows Azure WebJobs</a></li>
<li><a href="../212767/index.html">Cross-browser CSS3 properties set</a></li>
<li><a href="../212769/index.html">New Userland-RootKit Azazel</a></li>
<li><a href="../212771/index.html">The construction of the world's largest thermal solar power station has been completed.</a></li>
<li><a href="../212773/index.html">Namespace in PHP, clarification</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>