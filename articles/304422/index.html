<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implement http / 2 server push using nghttp2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone, today I will talk about how I set up server push on my website and achieved an increase in page rendering speed. First, what is server...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implement http / 2 server push using nghttp2</h1><div class="post__text post__text-html js-mediator-article">  Hello everyone, today I will talk about how I set up server push on my website and achieved an increase in page rendering speed.  First, what is <strong>server push in HTTP / 2</strong> ?  This technology allows the server to ‚Äúpush‚Äù additional data to the client, at the time of the request of the main document.  That is, in the usual situation, the browser requests the html-page, then it processes it and comes to the conclusion that it needs to load additional files for the correct display: styles, scripts, images.  After that, downloads them and displays the final result.  Server push allows you to send additional files at the time of receiving the main document, and they will already be in the cache when they are required by the browser.  Due to this, the site loading speed increases. <br><br>  This time the scheme will be as follows: <br><br><img src="https://habrastorage.org/files/d43/105/529/d43105529a0a443797a0a418ab9bead3.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  Now directly about the implementation itself.  Currently, nginx in HTTP / 2 mode does not support server push technology.  For these purposes, I will use nghttp2 - it is used in CloudFlare to implement push'ey for their clients.  nghttp2 is a set of tools that implement the HTTP / 2 protocol.  Namely: standalone server, client and reverse proxy server.  We are interested in the part that implements the proxy server, the program is called nghttpx. <br><br><h3>  Customization </h3><br>  Install nghttp2: <br><pre><code class="hljs swift">apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install nghttp2</code> </pre> <br>  Configure nghttpx.  The configuration file <strong>/etc/nghttpx/nghttpx.conf is rendered</strong> <br><pre> <code class="hljs delphi">frontend=<span class="hljs-number"><span class="hljs-number">93.170</span></span>.<span class="hljs-number"><span class="hljs-number">104.204</span></span>,<span class="hljs-number"><span class="hljs-number">443</span></span> #IP    - backend=<span class="hljs-number"><span class="hljs-number">127.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span>,<span class="hljs-number"><span class="hljs-number">6081</span></span> #IP   - <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>-key-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>=/etc/ssl/ssl.webshake.ru.key #  certificate-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>=/etc/ssl/ssl.webshake.ru.pem #      ,  nginx http2-proxy=no # server push   workers=<span class="hljs-number"><span class="hljs-number">1</span></span> # </code> </pre> <br>  We check that the site is working.  Now, in order to ‚Äúlaunch‚Äù the style file into the browser, it is enough for the client to transfer a type header to nghttpx from the backend: <br><pre> <code class="hljs pgsql">Link: /<span class="hljs-type"><span class="hljs-type">path</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>/file.css; rel=preload; <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>=stylesheet</code> </pre> <br>  For a JS file, the header would be: <br><pre> <code class="hljs pgsql">Link: /<span class="hljs-type"><span class="hljs-type">path</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>/file.js; rel=preload; <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>=script</code> </pre> <br>  I added 14 such headers by implementing this in PHP.  Added lines to index.php file: <br><pre> <code class="hljs pgsql">&lt;?php <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>("link: &lt;/wp-content/themes/shootingstar/style.css&gt;; rel=preload; as=stylesheet", <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>("link: &lt;/wp-content/themes/shootingstar/css/elegantfont.css?ver=4.5.3&gt;; rel=preload; as=stylesheet", <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>("link: &lt;/wp-content/plugins/google-captcha/css/gglcptch.css?ver=1.23&gt;; rel=preload; as=stylesheet", <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>("link: &lt;/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta&gt;; rel=preload; as=stylesheet", <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>("link: &lt;/wp-content/plugins/crayon-syntax-highlighter/themes/github/github.css?ver=_2.7.2_beta&gt;; rel=preload; as=stylesheet", <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>("link: &lt;/wp-includes/js/wp-emoji-release.min.js?ver=4.5.3&gt;; rel=preload; as=script", <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>("link: &lt;/wp-includes/js/wp-embed.min.js?ver=4.5.3&gt;; rel=preload; as=script", <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>("link: &lt;/wp-content/themes/shootingstar/js/responsive.js?ver=1.0&gt;; rel=preload; as=script", <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>("link: &lt;/wp-content/themes/shootingstar/js/selectnav.js?ver=0.1&gt;; rel=preload; as=script", <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>("link: &lt;/wp-content/themes/shootingstar/js/menubox.js?ver=1.0&gt;; rel=preload; as=script", <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>("link: &lt;/wp-content/themes/shootingstar/js/scroll-to-top.js?ver=1.0&gt;; rel=preload; as=script", <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>("link: &lt;/wp-content/themes/shootingstar/js/placeholders.js?ver=2.0.8&gt;; rel=preload; as=script", <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>("link: &lt;/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1&gt;; rel=preload; as=script", <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>("link: &lt;/wp-includes/js/jquery/jquery.js?ver=1.12.4&gt;; rel=preload; as=script", <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>);</code> </pre> <br>  and restarted Varnish to flush the entire cache. <br><br><h3>  Result </h3><br>  After that, the browser uploaded the home page of your site and saw the fuzzy files: <br><img src="https://habrastorage.org/files/bb5/4f0/950/bb54f0950532427e96ae8acd7f617683.png"><br>  And here is the download with disabled guns: <br><img src="https://habrastorage.org/files/65b/c08/2f8/65bc082f892a470b924feab3b630eb86.png"><br><br>  The file that was sent using server push has an appropriate header. <br><img src="https://habrastorage.org/files/036/3dd/e90/0363dde909a94deb98aea842af048afa.png"><br><br>  Here is a comparison of the rendering speed of the main page when pushing files with styles and JS and without push: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/nje_VEA05OI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  The measurements were carried out with the <a href="http://www.webpagetest.org/">WebPagetest /</a> tool, which I learned from my colleague.  Open-source project, a bunch of metrics, settings and test servers are available.  I advise everyone! <br><br>  Also in the process of work, I nakodil mini-service that allows you to quickly check the list of files to be pushed by typing the url of the site.  Maybe someone will come in handy - <a href="https://webshake.ru/post/480">webshake.ru/post/480</a> <br><br><h3>  Conclusion </h3><br>  Server push technology has reduced the download and rendering of my site from 1.7 to 1.4 seconds, which is already 17%!  It works and should be used. <br><br>  Finally, some more metrics with WebPagetest. <br><img src="https://habrastorage.org/files/465/f98/362/465f98362a654bfcb581a5c06b1bf130.png"><br><br><img src="https://habrastorage.org/files/7e4/3bb/e9a/7e43bbe9a8f7478abee4da2c4cff41c3.png"><br><br>  Source: <a href="https://webshake.ru/post/480">webshake.ru/post/480</a> </div><p>Source: <a href="https://habr.com/ru/post/304422/">https://habr.com/ru/post/304422/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../304408/index.html">10 useful sites with 2D resources for games</a></li>
<li><a href="../304410/index.html">6 golden rules for learning anything in record time</a></li>
<li><a href="../304412/index.html">Data Center Cooling: Experience Bluon Energy, Emerson, Star Refrigeration, Asetek and CoolIT Systems</a></li>
<li><a href="../304414/index.html">Javascript Neural Networks</a></li>
<li><a href="../304416/index.html">We write puzzles on FBD. Fifteen and Simpson</a></li>
<li><a href="../304424/index.html">IBM Watson and no magic: an IBM engineer created a dispensing hat from Harry Potter for his daughters</a></li>
<li><a href="../304426/index.html">Java & PostgreSQL - meeting with Alvaro Hernandez, St. Petersburg</a></li>
<li><a href="../304428/index.html">Very simple and fast HTML-> TEXT</a></li>
<li><a href="../304430/index.html">Rake A / B testing - meeting with Roman Poborch, St. Petersburg</a></li>
<li><a href="../304432/index.html">RAO. End of monopoly or just ‚Äúsome have stolen too much‚Äù?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>