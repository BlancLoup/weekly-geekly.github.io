<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Distributed Music Player on Raspberry Pi</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have long planned to write this post, but progress was slow. To accelerate the pace I pushed this question , where I had the imprudence to say that ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Distributed Music Player on Raspberry Pi</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage3/654/d1b/b09/654d1bb09b72d498ba0aa09999de628e.jpg" align="right"><br>  I have long planned to write this post, but progress was slow.  To accelerate the pace I pushed <a href="http://habrahabr.ru/qa/47380/">this question</a> , where I had the imprudence to say that I was writing such a post, as a result of which he aroused a keen interest, so I had no choice but to fulfill this promise, for which I express special thanks to the author of the question <a href="http://habrahabr.ru/users/m03g/" class="user_link">M03G</a> , with whose filing and I received this accelerating Pendel.  And since the post seems to be released on Friday, I allowed myself a rather loose (sorry, involuntary pun came out) writing style.  I hope everyone will be satisfied. <br><br>  <i>(Yes, the post largely overlaps with the post <a href="http://habrahabr.ru/post/181728/">Distributed audio player on the Odroid U2</a> , but a little easier to set up)</i> <br><a name="habracut"></a><br><br><h3>  Prologue </h3><br>  I began to dream of a similar system in 2003, as soon as I started living in an apartment with a number of rooms&gt; 1, and the question of music in the kitchen (and indeed in the whole apartment) rose to its full height.  The situation was aggravated by the fact that the apartment was built according to the architectural genius of Nikita Sergeevich Khrushchev, and the computer was placed in the ‚Äúfar‚Äù room, so that the kitchen could be heard a little more than nothing at all. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/275/e39/281/275e39281da9fba51d8b93f963649ce7.jpg"></div><br><br>  As time went on, the apartments changed, pondered and discarded various options, the dream remained, now going to the fullest background, now emerging from the depths of the subconscious, but did not move. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d52/8e0/be1/d528e0be191fc0f2ec1da0fa3ff4c3c4.jpg" alt="image"></div><br><br><h3>  Prehistory </h3><br>  By the time the wonderful Raspberry Pi single-board computers turned out to be in wide access, I changed 3 places of residence, the same amount of work, as well as the country of residence, therefore, because of the abundance of what is happening, the dream did not give voice to even a weak voice, having fallen asleep to dusty closet in the back of the memory.  Malinku I, however, still ordered.  I didn‚Äôt understand myself why, but I couldn‚Äôt resist: I decided everything for the price / potential ratio.  ‚ÄúThis is in the perspective of both NAS, and a web server for experiments, and a lot of everything else,‚Äù I thought (well, on the NAS, <a href="http://habrahabr.ru/post/165153/">as it turns out</a> , it doesn‚Äôt pull, but even if I knew it then, I wouldn‚Äôt care it did not stop). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage3/21a/c09/e7c/21ac09e7c3286de1882451b4fe842862.jpg"></div><br><br>  However, after the ‚ÄúMalinka‚Äù did get into my hands, I just had a blockage both at work and with personal projects, so the ‚Äúberry‚Äù lay on the shelf and lay for several months without taste of electricity. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7a5/420/6c3/7a54206c39e3a5fcf34e7692a87e72bc.jpg" alt="image"></div><br><br>  But one day everything changed. <br><br><h3>  Outset </h3><br>  There was nothing to do on a warm summer evening, something that had not happened to me for several years, and I decided not to miss this opportunity and to sort the trash in the cupboard a little.  There I came across a black box, sadly looking at me with slots of empty slots. <br><blockquote>  ‚ÄúBoth on, yes I have something here!‚Äù </blockquote>  - I thought and immediately got into the Internet for the image of the system for it.  It so happened that she lay down on the table in such a way that the audio output stared straight at my left eye, asking a dumb question <br><blockquote>  ‚ÄúWell, shall we do something or what?‚Äù </blockquote>  The plan matured quickly: we plug an external screw with music into the usb port, connect speakers to the audio output, put MPD on the raspberries and get an excellent music player that can be controlled from any computer in the house (there are plenty of clients for any OS).  So, Malinka finally found a use, it blinked merrily with multi-colored LEDs, and it was good. <br><br>  Good but not enough. <br><blockquote>  ‚ÄúHeh, there is such a wonderful thing like Icecast2 that gets along excellently with MPD and stream music to the net!‚Äù </blockquote>  - flashed through my head.  And then it will be possible to listen on any device with any player who can grab an audio stream from the network.  These thoughts burst out so loud (I would even say deafeningly) that the menacing rumble reached the forgotten dusty closet and woke up a hopelessly asleep dream, which immediately began to hollow into the wall with a tin mug: <br><blockquote>  ‚ÄúAnd who bothers you to take another couple of raspberries, write the simplest software that, on command from the network, turns on / off the same mplayer to play the specified URL (the same one to which Icecast2 broadcasts from the first raspberry), and release me from here at the end ends ?? ‚Äù </blockquote>  But here I (and her) waited for the first bummer (as it turned out later - for the better): the power of the raspberry was not enough to pinch the stream on the fly and stream it - the sound stuttered.  I climbed to look for whether it is possible to ‚Äúpersuade‚Äù Icecast2 not to pinch, but directly stream what is being fed to it.  And while smoking the MPD config, I came across the familiar word ‚Äúpulseaudio‚Äù. <br><blockquote>  ‚ÄúSo, stop, yes, this is the kind of crap that can potentially play on the network?  Or maybe I don‚Äôt need to make a fuss with Icecast2 and a samopisnyi on / off switch? ‚Äù </blockquote>  And so it happened ... And the cabinet remained unassembled. <br><br><h3>  Go! </h3><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/924/0cb/7ae/9240cb7ae41e53daa72d5bff8074a5e3.jpg" alt="image"></div><br><br>  So let's go.  Source material: two or more Raspberry Pi (one will be the server on which MPD is spinning, the rest are clients), the same number of speakers for playing sound, a bit of Linux knowledge, and an evening of free time.  Well, of course, a music collection with correctly spelled tags, since  MPD operates with them.  I had all this available, so I informed my wife beforehand that I was not there the next evening, I fell ill, disappeared from home, went to Vancouver, and emigrated nafig in general from this planet, and that I would come back tomorrow for dinner, and head plunged into Google.  Google did not disappoint. <br><br><h4>  Preparatory stage (same for server and clients) </h4><br>  I will not describe in detail the process of installing the system on the Raspberry Pi, the instructions on the Internet are complete.  I will only make a <a href="http://www.raspbian.org/">reservation</a> that I, as a Debian lover with 8 years of experience, used <a href="http://www.raspbian.org/">Raspbian</a> , so all instructions will be given for him.  In general, download the image, flash, stick the card, load.  The initial setting is also standard, I will list what I did: <br><br><ul><li>  set the password (of course) </li><li>  activated ssh server </li><li>  set the timezone </li><li>  removed loading X's </li><li>  set the amount of video memory to a minimum (16 megabytes), because there is no need to waste it in the absence of X's. </li></ul><br>  If you are not very confident in the console, then you can skip the last two points, and configure it directly from the ‚Äúcrimson‚Äù gui, but I did everything by logging in via ssh. <br><br>  <b>Mandatory item:</b> assign a static address to each ‚Äúraspberry‚Äù in the settings of your router (or in its own network settings, no difference) - later it will be very useful. <br><br>  Well, let's get started: <br><br>  <b>1.</b> First of all, we will update the system to a fresh state and install PulseAudio.  In general, we will now do a lot of things from the root, so go under your account in your favorite way ( <a href="http://habrahabr.ru/post/193084/">choose your own taste</a> ): <br><br><pre>  $ sudo -i
 # aptitude update &amp;&amp; aptitude upgrade &amp;&amp; aptitude install pulseaudio </pre><br><br>  <b>2.</b> Since  it is assumed that everything will work immediately after the download, ideally - without X and the user's login, we need PulseAudio to work in system-wide mode.  To do this, edit the file <b>/ etc / default / pulseaudio</b> as follows: <br><br><pre>  ...
 PULSEAUDIO_SYSTEM_START = 1
 ... </pre><br><br>  <b>3.</b> Next, in order for everything to work, you need to add user pi to the pulse-access group: <br><br><pre>  # usermod -a -G pulse-access pi </pre><br><br>  <b>4.</b> Now enable the reception of sound over the network.  To do this, add the line to the <b>/etc/pulse/system.pa</b> file <br><br><pre>  ...
 load-module module-native-protocol-tcp auth-ip-acl = 127.0.0.1; 192.168.1.0/24
 ... </pre><br>  Here we authorize both ‚Äúhimself‚Äù and all devices from the local network with addresses 192.168.1. * (If you have another address range, correct it accordingly).  In principle, the first part is needed only for the server (to play on itself), and the second - for clients (to receive from the network), but we will do both, so that if something happens, the raspberries are interchangeable with minimal gestures. <br><br>  <b>4.</b> Actually, we start the pulseaudio service <br><br><pre>  # service pulseaudio start </pre><br><br>  This is where the common part ends.  Let's go to the settings of clients and server. <br><br><h4>  Customer </h4><br>  Perhaps, it will seem strange to someone, but ‚Äúthe client is already ready‚Äù, and no additional configuration is required, so we will continue to <s>move strictly to a server of the order of 50 meters and work on the</s> server. <br><br><h4>  Server </h4><br>  First of all, you need to install MPD on the server, and at the same time a console client (for initial setup): <br><br><pre>  # aptitude install mpd mpc </pre><br><br>  Now edit the config <b>/etc/mpd.conf</b> .  He, like many other configs in Linux, is well commented, so I‚Äôll mark only the main necessary edits: <br><br>  Specify the path to the collection <br><pre>  music_directory "/ mnt / disk1 / music / mp3 / sorted" </pre><br><br>  Bind on any network interface: <br><pre>  bind_to_address "any" </pre><br><br>  To standard port: <br><pre>  port "6600" </pre><br><br>  Auto-update the collection when files change: <br><pre>  auto_update "yes" </pre><br><br>  And most importantly, we configure audio outputs.  Here we create one output for each of the client ‚ÄúMalines‚Äù, plus one for the server itself - it will also act as an equal client.  This is where the static IP addresses that we assigned to each of the raspberries will come in handy. <br><br><pre>  audio_output {
         type "pulse"
         name "Office"
         server "localhost" # server
 }

 audio_output {
         type "pulse"
         name "Living Room"
         server "192.168.1.4" # client # 1
 } </pre><br>  (and so on, by the number of existing customers) <br><br>  Well, restart MPD.  You can end the root session at this point. <br><br><pre>  # service mpd restart
 # exit </pre><br><br>  Scan the collection to create a database (it will take some time, depending on the size of the collection): <br><pre>  $ mpc -w update </pre><br><br>  Actually, this is all. <br><br><h4>  Rulim! </h4><br>  It remains nothing: how to manage this whole business.  There is nothing complicated here, at our disposal a <a href="http://mpd.wikia.com/wiki/Clients">wagon and a small cart of customers</a> for various operating systems.  When choosing, be sure to pay attention to whether the client is able to switch output channels (or, as they are also called, Output Devices) - in fact, this is exactly the feature that allows you to turn on / off a particular client.  Under Mac I stopped at <a href="http://mpd.wikia.com/wiki/Client:Theremin">Theremin</a> , under Linux - at <a href="http://gmpclient.org/">Gmpc</a> , I didn‚Äôt have to use Windows clients, so I can‚Äôt advise anything. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8da/11d/2ae/8da11d2ae795c98a8b9ed14a4aabec8f.jpg" alt="image"></div><br><br><h4>  Climax </h4><br>  With light and smooth finger movements, gently touching the touchpad, I started Theremin, added the first track I got to the playlist and pressed Play.  A second from the speakers in the hall came the gentle play of the good old composition ‚ÄúMaster of Puppets‚Äù of the vocal-instrumental ensemble ‚ÄúMetallica‚Äù.  The child sitting inside of me exulted - <blockquote>  "Hooray!!!  This is what I dreamed of for 10 years !!! ‚Äù </blockquote>  Additional degrees of spiritual warmth were generated from the awareness of the fact that no ‚Äúrocket science‚Äù was involved, and everything was assembled literally in the evening from ‚Äúimprovised materials‚Äù, and even without a single piece of blue electrical tape.  I listened - from the office upstairs also came the sound!  I climbed into the menu and took a daw off with the ‚ÄúLiving Room‚Äù - the sound from the speakers in the hall was gone, and remained only in the office. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage3/4bb/41a/94d/4bb41a94d18e1b5d5d38683ebaa030c4.png"></div><br><br>  Victory! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/928/cbf/eff/928cbfeff224ff1b34848c260aaa88b9.jpg" alt="image"></div><br><br><h4>  Epilogue </h4><br>  After a few minutes, the internal perfectionist demanded unification of the interface between the devices and the AXES, and so the crazy thought immediately flashed through my head ‚ÄúBut I want a web interface, so that it has all the necessary functions!‚Äù but short.  This kind of fichasty, but put through the opu.  This one is generally abandoned. ‚ÄùAnd so on.  Not to mention the fact that they all had one <a href="http://lurkmore.to/%25D0%25A4%25D0%25B0%25D1%2582%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BD%25D0%25B5%25D0%25B4%25D0%25BE%25D1%2581%25D1%2582%25D0%25B0%25D1%2582%25D0%25BE%25D0%25BA">fatal flaw</a> .  In general, the most intelligent readers have already understood everything: I decided to write my own, ‚Äúwith musical scores and pianists‚Äù.  Especially since I never really worked on web development, but I always wanted to try the jQuery scary beast, and generally appreciate how far web technologies have gone since I last wrote and threw my hamster on narod. ru, with javascripts and rotating menus.  Therefore, for three week evenings and one day off, this miracle was born: <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/storage3/87f/2ad/bb4/87f2adbb4b25c309cabcad587b87a8e6.png" alt="image"></a> </div><br>  <i>(screenshot taken from the screen of the BlackBerry PlayBook)</i> <br><br>  But about it - next time. <br><br>  <b>UPD:</b> web interface link: <a href="https://github.com/Mezomish/WebMPC">github.com/Mezomish/WebMPC</a> </div><p>Source: <a href="https://habr.com/ru/post/195458/">https://habr.com/ru/post/195458/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../195444/index.html">Samsung's new flagship preview: GALAXY NOTE III</a></li>
<li><a href="../195446/index.html">Change caller ID to 3CX Phone System 12</a></li>
<li><a href="../195448/index.html">Using short-term characteristics in speech processing</a></li>
<li><a href="../195452/index.html">Final RussianCodeCup 2013: Photo Report</a></li>
<li><a href="../195454/index.html">Let's save the largest media library in runet. All base rutracker on your computer</a></li>
<li><a href="../195460/index.html">What's new in our processes: Kanban board for transactions</a></li>
<li><a href="../195464/index.html">Go: Two years in production</a></li>
<li><a href="../195468/index.html">SLI - fast creation of multilingual on the site</a></li>
<li><a href="../195470/index.html">Finally! Oracle Java Hard-float on Raspberry Pi</a></li>
<li><a href="../195472/index.html">Young shoots, or Find me a computer circle</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>