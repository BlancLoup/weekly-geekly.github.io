<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Shared VHDX in Windows Server 2012 R2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In a previous post on Windows Server 2012 R2 , I mentioned a new feature in Hyper-V ‚Äî the use of shared VHDX files (Shared VHDX) to create guest clust...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Shared VHDX in Windows Server 2012 R2</h1><div class="post__text post__text-html js-mediator-article">  In a previous <a href="http://habrahabr.ru/company/microsoft/blog/186922/">post</a> on <a href="http://technet.microsoft.com/ru-RU/evalcenter/dn205286">Windows Server 2012 R2</a> , I mentioned a new feature in Hyper-V ‚Äî the use of shared VHDX files (Shared VHDX) to create guest clusters.  Today I would like to dwell on this topic and discuss the features of setting up and applying Shared VHDX. <a name="habracut"></a><br><br><br><h1>  Guest Clustering </h1><br>  First of all, briefly about why guest clustering is needed at all.  Most of the applications and services used in modern IT infrastructure can be run inside virtual machines (VMs).  Virtualization gives a number of obvious and not very advantages, the listing of which goes beyond the post.  The more critical an application for a company is spinning inside a VM, the more important the task of ensuring high availability of such a VM becomes. <br><br>  You can provide high availability of VMs by placing it on a physical (host) cluster, in this context - Hyper-V cluster.  Failure of the physical node of the cluster on which the VM was running results in automatic recovery of the VM on another node of the cluster.  This failover procedure can lead to a short-term, but loss of communication with the VM and the application inside it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Another method of increasing accessibility is to combine two or more VMs in a failover cluster, that is, creating a guest cluster in the sense that the cluster is created based on the guest OS.  In this case, we are already talking about high availability not of the VM as such, but of the application (or applications) within the guest cluster. <br><br>  Of course, for greater reliability, you can combine host and guest clustering. <br>  Guest clustering, as well as host clustering, assumes the presence of some common storage.  With regard to virtual machines, such storage before the release of Windows Server 2012 could be iSCSI-storage. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c43/a02/1f2/c43a021f2b53b7c1b18fdb9a7220b8d0.png" alt="image"><br><br>  In Windows Server 2012, thanks to Virtual Fiber Channel, it became possible to connect VMs via the host HBA adapter directly to FC storage. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/da1/2e1/88a/da12e188afa0a760ff449626da8fadbd.png" alt="image"><br><br>  However, in any case, in order to build a guest cluster, it was necessary to provide the VM with direct access to the storage.  In many scenarios, for example for hosting providers, this option is very inconvenient.  General VHDX files just allow you to solve this problem, because they abstract VMs from the features of the storage implementation.  To create a guest cluster, the necessary number of Shared VHDX is connected to the virtual machines, which represent the shared cluster storage.  And where physically, in what specific storage and LUN-e these files are located - this is the provider's business. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/599/28b/5cd/59928b5cd85ab62ba8192b711f041ab1.png" alt="image"><br><br><br><h1>  Supported configurations and configuration of Shared VHDX </h1><br>  From the point of view of the implementation of the described approach, we can distinguish two main configurations of using Shared VHDX.  In the first configuration, the common VHDX files are located on the CSV volume of the physical cluster.  The CSV volume, in turn, can be implemented on any block storage supported by the Windows Server Clustering service (Fiber Channel, iSCSI, Shared SAS). <br><br>  In the second configuration, the VHDX files are located in the shared folder of the <a href="http://habrahabr.ru/company/microsoft/blog/161683/">Scale-Out File Server</a> file cluster.  The latter, I note, also suggests the presence of a CSV-volume.  As you can see, both configurations ultimately lead to a combination of host and guest clustering.  Host clustering increases the availability of shared VHDX, then created on top of the guest cluster provides high availability of services and applications within the VM. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/39f/780/9c0/39f7809c0ae7d4bdb97e4540d0043b07.png" alt="image"><br><br>  To configure Shared VHDX, first of all, of course, you need to create one or more VHDX files and arrange them using one of the above configurations.  You can then connect the Shared VHDX in the Hyper-V console, using PowerShell cmdlets or using the service template in the System Center 2012 R2 Virtual Machine Manager. <br><br>  In the Hyper-V console, this is done by adding a new SCSI disk: select the <b>SCSI Controller</b> in the VM properties, then <b>Hard Drive</b> , click the <b>Add</b> button, specify the path to the VHDX file, then select <b>Advanced Features</b> and check the corresponding checkbox. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b97/b25/3c6/b97b253c63f93169bff29e9221821e32.jpg" alt="image"><br><br>  Repeat the procedure for all VMs that are planned to be clustered. <br><br>  You can do the same in PowerShell with the following cmdlets: <br><br><pre><code class="javascript hljs">New-VHD -Path C:\ClusterStorage\Volume1\Shared.VHDX -Fixed -SizeBytes <span class="hljs-number"><span class="hljs-number">30</span></span>GB</code> </pre> <br><pre> <code class="javascript hljs">Add-VMHardDiskDrive -VMName Node1 -Path C:\ClusterStorage\Volume1\Shared.VHDX -ShareVirtualDisk</code> </pre> <br><pre> <code class="javascript hljs">Add-VMHardDiskDrive -VMName Node2 -Path C:\ClusterStorage\Volume1\Shared.VHDX ‚ÄìShareVirtualDisk</code> </pre> <br><br>  In VMM 2012 R2, in the service template, in the <b>Hardware Configuration</b> section, you must also add a SCSI disk, specify the path to the VHDX file, and check the <b>Share the disk across the service tier</b> checkbox.  When deploying a VM based on such a template, VMM will attach the specified file as Shared VHDX. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/186/0b9/183/1860b918318bb46d83414a3e974c9907.png" alt="image"><br><br>  Whichever option you choose, inside a VM the connected VHDX will look like a regular SAS disk. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1e4/c18/31d/1e4c1831d3a78c67b0db52813b272c23.png" alt="image"><br><br><br><h1>  Shared VHDX Requirements </h1><br>  It is necessary to remember the following requirements for Shared VHDX: <br><ol><li>  The files must be VHDX, the VHD format for the shared configuration is not supported.  At the same time, the guest OS itself may well be installed on a VHD disk. </li><li>  On Hyper-V hosts, and if using the Scale-Out File Server and on the nodes of the file cluster, a version of Windows Server 2012 R2 must be installed. </li><li>  Guest OS can be Windows Server 2012 R2 or Windows Server 2012 with the latest version of integration components. </li><li>  Both the first generation VM (Generation 1) and the second (Generation 2) are supported. </li></ol><br><br><h1>  Diagnostics and Testing </h1><br>  To diagnose possible problems in Performance Monitor, a new <b>Hyper-V Shared VHDX</b> object has been <b>added</b> with a set of various counters that you can analyze on Hyper-V hosts. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6bc/684/da1/6bc684da11704974b7bb2cb47800acb0.png" alt="image"><br><br>  In addition, new logs have been added, which can be viewed, as usual, using the Event Viewer, <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6cd/9f0/97f/6cd9f097f2351ab8e98eccd4cde25abd.png" alt="image"><br><br>  or PowerShell: <br><br><pre> <code class="javascript hljs">Get-WinEvent -LogName Microsoft-Windows-Hyper-V-Shared-VHDX/Operational</code> </pre> <br><pre> <code class="javascript hljs">Get-WinEvent -LogName Microsoft-Windows-Hyper-V-Shared-VHDX/Reservation</code> </pre> <br><br>  Finally, for the purposes of testing, studying, developing, it is possible to use the ‚Äúspecial‚Äù configuration of Shared VHDX.  For this configuration, a single physical host with Windows Server 2012 R2 and the raised Hyper-V role is enough, on which you can place common VHDX files without creating clusters with CSV volumes, etc. To implement this option, you need: <br><ol><li>  Install Failover Clustering Service <br><pre> <code class="javascript hljs">Install-WindowsFeature Failover-Clustering</code> </pre> </li><li>  Manually connect the Shared Virtual Disk filter for the partition where the shared VHDX files will be located, for example, for the D drive: it will look like <br><pre> <code class="javascript hljs">FLTMC.EXE attach svhdxflt D:</code> </pre> </li></ol><br>  But remember that this is an unsupported configuration and should not be used in a real environment. <br><br>  Thus, the shared VHDX file mechanism helps to implement a more efficient guest clustering scheme and, ultimately, increase the availability of critical applications and services of your infrastructure.  This technology can be especially useful for private clouds and hosting scenarios. <br><br>  Hope the material was helpful. <br><br>  Thank! </div><p>Source: <a href="https://habr.com/ru/post/191666/">https://habr.com/ru/post/191666/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../191654/index.html">DoS exploit for WebKit engine</a></li>
<li><a href="../191656/index.html">JUG.ru: about the Petersburg Java User Group in a few minutes</a></li>
<li><a href="../191660/index.html">A way to extract data from 1C database</a></li>
<li><a href="../191662/index.html">Reverse engineering client Dropbox</a></li>
<li><a href="../191664/index.html">Our view: Meteor vs Derby</a></li>
<li><a href="../191670/index.html">Syrian hackers tweaked Twitter and The New York Times DNS records</a></li>
<li><a href="../191674/index.html">The evolution of the school program in computer science</a></li>
<li><a href="../191676/index.html">Overview of the network platform Lanner FW-7582</a></li>
<li><a href="../191678/index.html">Parallels Access: working with Windows and OS X applications on an iPad</a></li>
<li><a href="../191684/index.html">BitTorrent sync is now available for iOS.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>