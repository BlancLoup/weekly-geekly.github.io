<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Visualization for music player</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The information in the article will cover the topic of creating a visualization for a music player. It so happened that the program was written in as3...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Visualization for music player</h1><div class="post__text post__text-html js-mediator-article">  The information in the article will cover the topic of creating a visualization for a music player.  It so happened that the program was written in as3, because  This is the language I'm currently programming. <br>  It all started from what I saw on <a href="http://www.btinternet.com/~richard.asbury/corona/">Phthalo's Corona</a> on the <a href="http://aimp.ru/">AIMP</a> player.  I thought for a long time how it works and finally came up with something. <br><a name="habracut"></a><br>  The first prototype was written in C ++. <br><img src="https://habrastorage.org/getpro/habr/post_images/f87/a5d/bb5/f87a5dbb54d9fdafcce8dcf11a040f26.png" alt="image"><br><br>  As a result, I only got a prototype of the motion of particles as in this visualization.  I stopped at this and after half a year I again wanted to work with the sound.  After 2 days, this flash drive was ready. <br>  <a href="https://dl.dropbox.com/u/80206417/habr_articles/visualization/swf/index.html">LINK</a> <br>  Mouse click - change blur mode. <br><br>  In order for it to work correctly, you need to open some kind of music player (for example, VKontakte) in the browser, and close all unnecessary tabs with audio data, because when you receive spectral data via SoundMixer.computeSpectrum, the flash drive may crash because the fact that other applications do not allow them to take audio data.  If it does not fall, then nothing can be closed.  As noted, in my chrome, the sound from other tabs is not caught. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We now turn to a review of how this all works. <br><br><h5>  Physics </h5><br>  Particles are located in the area (650 in this case).  600 active particles and 50 particles that appear at a random point in the area and fall down, when such a particle touches the floor, it respawns again in the area.  By itself, all particles are affected by gravity. <br>  In addition to gravity, particles can be influenced by an attractor and a repulsor.  Now I will explain what these things are magic.  In fact, they are not magic at all, just the names they have are just as abstruse as any "professors" like to say. <br><br>  <a href="http://ru.wikipedia.org/wiki/%25D0%2590%25D1%2582%25D1%2582%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25BE%25D1%2580">Attractor</a> - this is such a thing that attracts everything that is possible.  In this case, the particles, and the farther away the particle is from the attractor, the weaker it is attracted. <br><br>  A repulsor is the same as an attractor, only it on the contrary pushes everything away from itself. <br><br>  So, on particles under certain conditions (based on the sound spectrum), an attractor and a repulsor act.  Because of this, they so jump in the area. <br><br><h5>  Drawing </h5><br>  A bitmapdata for particles is created, one for all (this is logical).  This is a small white circle, why white will explain below. <br><pre><code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> radius: Number = PARTICLE_SIZE * <span class="hljs-number"><span class="hljs-number">0.5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> particleShape: Shape = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Shape(); particleShape.graphics.beginFill(<span class="hljs-number"><span class="hljs-number">0xFFFFFF</span></span>); particleShape.graphics.drawCircle(PARTICLE_SIZE * <span class="hljs-number"><span class="hljs-number">0.5</span></span>, PARTICLE_SIZE * <span class="hljs-number"><span class="hljs-number">0.5</span></span>, radius); m_ParticleBmp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapData(PARTICLE_SIZE, PARTICLE_SIZE, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-number"><span class="hljs-number">0x0</span></span>); m_ParticleBmp.draw(particleShape);</code> </pre> <br>  Particles are drawn like this: <br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> velDir: Number = Math.atan2(part.vel.y, part.vel.x); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> speed: Number = Math.max(Math.abs(part.vel.y), Math.abs(part.vel.x)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (speed &gt; <span class="hljs-number"><span class="hljs-number">20</span></span>) speed = <span class="hljs-number"><span class="hljs-number">20</span></span>; matr.identity(); matr.scale(<span class="hljs-number"><span class="hljs-number">1.3</span></span> + speed / <span class="hljs-number"><span class="hljs-number">20.0</span></span> * <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>); matr.rotate(velDir); matr.translate(part.pos.x, part.pos.y); m_BackBuffer.draw(m_ParticleBmp, matr);</code> </pre><br>  The matrix transforms the particles so that they stretch as they move.  Nothing complicated. <br><br><h5>  Effects </h5><br><h6>  Palette </h6><br>  When you start the visualization, palettes are created from which color is sampled when drawing the final image (standard fit for the demo-decoders :) <br><br>  They are randomly selected in the process. <br><br>  To work with the palette, you need to prepare 3 arrays of 256 values.  These will be arrays for red, green and blue. <br><br>  In order to enable them, you must use the BitmapData class <a href="http://kharchuk.ru/as3/BitmapData.html">paletteMap</a> function.  It receives as parameters these arrays and the original image. <br><br>  It works like this: <br><ol><li>  takes the color of the pixel from the original image, integer; </li><li>  this color is broken into rgb (byte) components; </li><li>  for these components, the value is taken from the corresponding array, these will be the new rgb values; </li><li>  new rgb values ‚Äã‚Äãare going back to integer. </li></ol><br>  Now I will explain why the particles need to be painted in white, and the background in black. <br><br>  When applying a blur filter, all pixels will be blurred and as a result, if nothing is drawn, they will turn black.  When applying the palette, black is replaced with any color, so when blurring, the color will smoothly turn into the color we need (in the buffer into which the particles are drawn, the background will remain black). <br><br>  The palette is constructed in such a way that rgb arrays are in the superscripts (255 is white), the color of the particles is recorded, and the background is written in the lower indices (0 is black).  In all other indices [1..254], the gradient colors from the background color to the color of the particle are recorded.  Of course, no one bothers to add more than 2 colors to the palette and make a gradient between them. <br><br><h6>  Distortion map </h6><br>  In the original visualization, a very interesting twist of a trace of particles was made.  I peered into it for a long time to understand how it works. <br><br>  In the end, I came to the conclusion that this is a <a href="http://ru.wikipedia.org/wiki/%25D0%2593%25D0%25B8%25D0%25BF%25D0%25B5%25D1%2580%25D0%25B1%25D0%25BE%25D0%25BB%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B0%25D1%258F_%25D1%2581%25D0%25BF%25D0%25B8%25D1%2580%25D0%25B0%25D0%25BB%25D1%258C">hyperbolic spiral</a> . <br><br>  <i>The equation of a hyperbolic spiral (in polar coordinates):</i> <br>  r * phi = a, where a is the speed of divergence of the helix <br><br>  <i>Cartesian coordinates:</i> <br>  x = a * cos (phi) / phi, <br>  y = a * sin (phi) / phi, where a / phi = r <br><br>  There was a question how to do it now O_O.  First, you need to somehow set the formula for such a distortion, and second, how to do it on a flash. <br><br>  Of course, at first I tried to do everything in the old manner, walking through all the pixels of the image and moving the pixels in certain directions, besides, it would allow me to immediately put in and blur.  But in practice everything turned out to be much different.  The cycle in the image killed fps.  I had to look for another solution. <br><br>  I got the idea to make a twirl effect, immediately found the code through DisplacementMapFilter.  But it was not what was in the original. <br><br>  I had to return to the review of the hyperbolic spiral.  The whole difficulty was that the helix was clearly defined through the angle and radius in polar coordinates, and I needed to add another parameter ‚Äî thickness.  As a result, after the derivation of some formulas, I wrote an algorithm for generating the displacement map. <br><br>  The displacement map is based on the following algorithm: <br>  Running through all the pixels of the image, each pixel is checked for belonging to the spiral (taking into account the thickness).  If the pixel belongs to a spiral, then at this point it is necessary to calculate the offset. <br><br>  To find the direction of the displacement, you can take a tangent at a given point.  To simplify the calculations, I decided to find the tangent to the circle at this point.  With this approach, the calculation error will be noticeable only in the tail of the helix.  Since  as the radius (or angle) increases, the y coordinate tends to a, i.e.  to the line. <br><br>  f '(x, y) = ArcTan (y / x) - Pi / 2 <br><br>  Now we just find the vector by the resulting angle and multiply it by the offset coefficient.  As a result, such an offset map was obtained (green and blue channels are used) <br><img src="https://habrastorage.org/getpro/habr/post_images/a0b/24e/4ff/a0b24e4ffb90cf557e6793e6f1a2fc0b.png" alt="image"><br><br>  In the second mode, another displacement map is superimposed, which is generated by Perlin noise. <br><pre> <code class="actionscript hljs">m_NoiseBuffer.perlinNoise(SCREEN_WIDTH, SCREEN_HEIGHT - FLOOR_POS, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, BitmapDataChannel.RED | BitmapDataChannel.BLUE, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, [m_OctaveOffset, m_OctaveOffset]);</code> </pre><br>  Here is a nice image is obtained at the output: <br><img src="https://habrastorage.org/getpro/habr/post_images/ee0/124/3eb/ee01243ebb632d73b08524e0085b6833.png" alt="image"><br><br>  It would be possible to add more octaves during generation, but the noise is generated every update (for this, the octave offset is used, for the effect of motion). <br><br>  As a result, the drawing steps are: <br><ol><li>  A displacementMapFilter filter is applied to the backBuffer with offsets. </li><li>  A blur filter is applied to the backBuffer (x: 8, y: 8, quality: 1). </li><li>  ColorTransform is applied to the backBuffer, so we adjust the image fading speed. </li><li>  Draw the particles in the backBuffer. </li><li>  We apply paletteMap to screeBuffer, we use backBuffer as the source image. </li><li>  Well, the last draw an inverted piece of floor </li></ol><br>  <a href="">SOURCES</a> . <br><br>  That's all, thank you for your attention! </div><p>Source: <a href="https://habr.com/ru/post/155695/">https://habr.com/ru/post/155695/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../155681/index.html">Apoi on wheels</a></li>
<li><a href="../155683/index.html">Comprehensive Retina site preparation</a></li>
<li><a href="../155689/index.html">Configuring Git Deployment for Windows Azure Virtual Machines</a></li>
<li><a href="../155691/index.html">"Odd Warrior" collects 950,000 rubles</a></li>
<li><a href="../155693/index.html">Sony announced plans to upgrade their smartphones to Android 4.1</a></li>
<li><a href="../155697/index.html">Original ZX Spectrum +3, drive repair drive</a></li>
<li><a href="../155699/index.html">Friends, we announce a set of creative ideas!</a></li>
<li><a href="../155701/index.html">At 10:00, watch the online broadcast of Windows 8 Summit right here.</a></li>
<li><a href="../155705/index.html">Coworking "Workstation"</a></li>
<li><a href="../155707/index.html">Domestic author blogs for geeks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>