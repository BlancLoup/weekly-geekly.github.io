<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Generating a sequence of dates and generate_series in PostgreSQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bike warning 

 This article may be a spherical example of cycling. If you know the standard or more elegant solution to the problem, I will be glad t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Generating a sequence of dates and generate_series in PostgreSQL</h1><div class="post__text post__text-html js-mediator-article"><div class="spoiler">  <b class="spoiler_title">Bike warning</b> <div class="spoiler_text"><p>  <em>This article may be a spherical example of cycling.</em>  <em>If you know the standard or more elegant solution to the problem, I will be glad to see it in the comments.</em> </p></div></div><br><p>  Once on one of the projects we needed to make a report on financial operations for the period with grouping subtotals at the end of the month. </p><br><p>  The task is, in general, simple, to determine the required periods within a large interval, to bind each operation to a suitable period, to group and add up the amount. </p><br><p>  To generate periods within an interval, I habitually took the function generate_series, which I often use to generate numeric sequences.  I checked the documentation about the possibility of generating a sequence of dates, looked at an example, wrote a request and was puzzled. </p><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> gs::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> generate_series(<span class="hljs-string"><span class="hljs-string">'2018-01-31'</span></span>, <span class="hljs-string"><span class="hljs-string">'2018-05-31'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 month'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> gs;</code> </pre> <br><table><thead><tr><th>  gs </th></tr></thead><tbody><tr><td>  01.31.2018 </td></tr><tr><td>  02.28.2018 </td></tr><tr><td>  03.28.2018 </td></tr><tr><td>  04/28/2018 </td></tr><tr><td>  05/28/2018 </td></tr></tbody></table><a name="habracut"></a><br><p>  The result was as unexpected as logical.  The generate_series function honestly and iteratively generated a sequence of dates according to the principle of successively adding a shift to the previous value.  At the same time, at each step, the correctness and correction of the received date was checked.  February 31 does not happen, so the date was transformed into February 28, and a further addition of the month brought down the entire sequence by the 28th. </p><br><p>  <em>UPD.</em>  <em>Explanations after questions in the comments.</em>  <em>In general, the original task is wider - to group data on arbitrary days of the month.</em>  <em>For example, grouped by the 20th day of each month, by the 15th day, but with such dates there are no problems with the generation.</em>  <em>The mechanism that we are looking for should equally well build a sequence of 10 numbers of each month, 21 numbers and correctly work out the ends of the months.</em> </p><br><p>  I wonder how the addition operation will behave with several months at once?  What will happen if we add an interval not iteratively, but in bulk? </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'2018-01-31'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> +<span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 mons'</span></span> <span class="hljs-number"><span class="hljs-number">28.02</span></span><span class="hljs-number"><span class="hljs-number">.2018</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'2018-01-31'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> +<span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-string"><span class="hljs-string">'2 mons'</span></span> <span class="hljs-number"><span class="hljs-number">31.03</span></span><span class="hljs-number"><span class="hljs-number">.2018</span></span></code> </pre> <br><p>  In this case, the addition is made honestly. <br>  How to use this approach to generate the necessary dates? </p><br><p>  If the number of months is known, it is very simple: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'2018-01-31'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> +make_interval(<span class="hljs-number"><span class="hljs-number">0</span></span>, i) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> gs <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> generate_series(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> i</code> </pre> <br><table><thead><tr><th>  gs </th></tr></thead><tbody><tr><td>  01.31.2018 </td></tr><tr><td>  02.28.2018 </td></tr><tr><td>  03/31/2018 </td></tr><tr><td>  04/30/2018 </td></tr><tr><td>  05.31.2018 </td></tr></tbody></table><br><p>  What to do if only the start date and end date are known? <br>  This task can be solved quite simply by writing a stored function and a simple cycle in it, but we are interested in the implementation option when there is no possibility or desire to clutter the database structure with unnecessary objects. <br>  Let's try to reduce the task to the previous one. </p><br><p>  <em>The following code is to some extent a mock-up board and does not pretend to elegance; we write the first variants of requests in the company with an emphasis on the flexibility and interchangeability of blocks.</em> </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/*  -  ,         ,      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> dates <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'2018-01-31'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt1, <span class="hljs-string"><span class="hljs-string">'2018-05-31'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt2 ), <span class="hljs-comment"><span class="hljs-comment">/*      ""  */</span></span> g_age <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> age( (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt2 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates), (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt1 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates)) ), <span class="hljs-comment"><span class="hljs-comment">/*       (*12 + )   +1       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">months</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">extract</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">year</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> g_age))*<span class="hljs-number"><span class="hljs-number">12</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">extract</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">month</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> g_age))+<span class="hljs-number"><span class="hljs-number">1</span></span>)::<span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> ), <span class="hljs-comment"><span class="hljs-comment">/*  ,           -   ,       */</span></span> seq <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt1 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates) + make_interval(<span class="hljs-number"><span class="hljs-number">0</span></span>, gs)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> gs <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> generate_series ( <span class="hljs-number"><span class="hljs-number">0</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">months</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> gs <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt1 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates) + make_interval(<span class="hljs-number"><span class="hljs-number">0</span></span>, gs)) &lt;= (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt2 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates) ) <span class="hljs-comment"><span class="hljs-comment">/*         */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> seq</code> </pre> <br><table><thead><tr><th>  gs </th></tr></thead><tbody><tr><td>  01.31.2018 </td></tr><tr><td>  02.28.2018 </td></tr><tr><td>  03/31/2018 </td></tr><tr><td>  04/30/2018 </td></tr><tr><td>  05.31.2018 </td></tr></tbody></table><br><p>  The solution turned out to be quite cumbersome, but it is sufficiently simple for the worker and him to integrate into other requests through the with mechanism. <br>  We have implemented the report, but the idea that this request is not only cumbersome, it is also limited in its use only in steps for whole months did not give rest. </p><br><p>  <strong>Option 2.</strong> <br>  After a while, it dawned on me that the sequential generation of dates is essentially a recursive procedure.  Only not in its pure form, since in our case the calculation of the next date from the previous one leads to the initial problem.  But at each step we can increase the interval added to the beginning of our period: </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/*    -,     timestamp */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">recursive</span></span> dates <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'2018-01-31'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt1, <span class="hljs-string"><span class="hljs-string">'2018-05-31'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt2, <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 month'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> ), <span class="hljs-comment"><span class="hljs-comment">/*           ,          ,   .  ,        */</span></span> pr <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> i, (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt1 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> i+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> i, ( (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt1 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates) + ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates)*i)::<span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pr <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ( ((<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt1 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates) + (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates)*i)::<span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span>) &lt;=(<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt2 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dates) ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> dt <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> gs <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pr;</code> </pre> <br><table><thead><tr><th>  gs </th></tr></thead><tbody><tr><td>  01.31.2018 </td></tr><tr><td>  02.28.2018 </td></tr><tr><td>  03/31/2018 </td></tr><tr><td>  04/30/2018 </td></tr><tr><td>  05.31.2018 </td></tr></tbody></table><br><p>  This query works correctly with any input time intervals and intervals. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/421969/">https://habr.com/ru/post/421969/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../421959/index.html">What to do when ‚Äúthis‚Äù loses contextual reference</a></li>
<li><a href="../421961/index.html">Creating a demo for an old phone - AONDEMO</a></li>
<li><a href="../421963/index.html">Accounting and accountant: their role in the organization</a></li>
<li><a href="../421965/index.html">"In addition to work, I still work" - 10 questions to the programmer, the third issue</a></li>
<li><a href="../421967/index.html">Children's toy on logic elements</a></li>
<li><a href="../421971/index.html">Native Russian from Xorg to rdesktop is a trifle, but nice</a></li>
<li><a href="../421975/index.html">New features FLProg - ESP8266 as a controller, not a modem</a></li>
<li><a href="../421977/index.html">Underwater "GPS" on two transceivers</a></li>
<li><a href="../421979/index.html">Dracula Theme is a universal theme for almost everything.</a></li>
<li><a href="../421983/index.html">Machine learning will help reduce the tsetse fly population to reduce the incidence of sleeping sickness</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>