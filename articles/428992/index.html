<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Selective bypass blocking on routers with Padavan and Keenetic OS firmware</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are a huge number of instructions with different options for bypassing Internet resource locks. But the topic does not lose relevance. Even more...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Selective bypass blocking on routers with Padavan and Keenetic OS firmware</h1><div class="post__text post__text-html js-mediator-article">  There are a huge number of instructions with different options for bypassing Internet resource locks.  But the topic does not lose relevance.  Even more often, there are initiatives at the legislative level to block articles on methods of circumventing locks.  And there were rumors that Roskomnadzor would receive another wad of taxpayers' money for ‚Äúbetter‚Äù locks.  Experienced users will not learn anything new and useful from the article.  But others will get ready step-by-step instructions for simple and effective selective bypass of locks on popular routers with Padavan and Keenetic firmware. <br><br><img src="https://habrastorage.org/webt/is/kb/td/iskbtdxuaisqiyg3r4tsrjhj6aw.jpeg"><br><a name="habracut"></a><br><h1>  Content </h1><br><ul><li>  <a href="https://habr.com/ru/post/428992/">Introduction</a> </li><li>  <a href="https://habr.com/ru/post/428992/">How will you manage block bypass after setup?</a> </li><li>  <a href="https://habr.com/ru/post/428992/">Principle of operation</a> </li><li>  <a href="https://habr.com/ru/post/428992/">Configuring the router with firmware Padavan</a> </li><li>  <a href="https://habr.com/ru/post/428992/">Configuring a router with Keenetic OS</a> </li><li>  <a href="https://habr.com/ru/post/428992/">Basic methods for diagnosing errors after setup</a> </li><li>  <a href="https://habr.com/ru/post/428992/">Optional bypass filtering DNS requests by the provider</a> </li></ul><br><a name="con1"></a><h1>  Introduction </h1><br>  For about two years I used the <a href="https://habr.com/post/270657/">option of bypassing locks</a> from <a href="https://habr.com/users/Zolg/">Zolg</a> .  Many online instructions are based on it.  Including mine. <br><br>  Everything was good, but "the best is always the enemy of the good."  First, some new programs have become too ‚Äúsmart‚Äù and rezolvyat domains by their own methods, bypassing the router's DNS server.  This does not allow dnsmasq on the router to add an address to the ipset to unlock and leads to a natural result - the resource remains locked.  In Android 9, full support for DNS-over-TLS appeared, i.e.  this lock bypass method stops working (if the other device has not previously accessed dnsmasq).  Secondly, updating the entire list of domains from antizapret leads to unpredictable results every time.  The list may include domains that are not blocked in reality, and whose operation is important through the main channel.  You need to constantly be alert and edit the generated files with your hands.  Thirdly, I got tired of ‚Äúdragging along‚Äù a huge list of domains with tens of thousands of casinos and the like, which are simply not needed.  Over time, I realized that I needed only a small specific list of blocked resources. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, I have been using the slightly modified unlocking method for a year, which I am completely satisfied with: <br><br><ul><li>  Simplicity and ease of management (after setting). </li><li>  Full control over which resources to unlock. </li><li>  Minimum requirements for processor resources and router RAM. </li><li>  Wide coverage of nuances when bypassing locks. </li></ul><br>  It is important to note that my option is not intended for the case when you need to unlock hundreds and thousands of domains.  Because at the start of the router, a rezolving of each domain from the specified list occurs.  The more domains in the list, the longer will be the initialization of the set ipset to unlock. <br><br>  The basis of the lock bypass is the same - the Tor network.  Its use is due to two simple factors ‚Äî free of charge, and the likelihood that Tor will be blocked in Russia is close to zero, unlike any VPN service.  Tor is the foundation of drug traffic in Russia from the middle to the bottom.  Blocking Tor will lead to a search for new tools for the market and a decrease in the level of anonymity, which will lead to the successful revitalization of the work of local law enforcement agencies.  In the end, this, like a virus, will begin to negatively affect the upper link.  Given the latest amazing news about the links of top state officials with global drug traffic to Russia, blocking Tor in Russia is just a taboo, even though it is trivial.  Neither Roskomnadzor, no matter what billions were allocated to this department, no court in Russia has the permission ‚Äúfrom above‚Äù to block Tor.  And it does not even surprise and frighten anyone, even though Russia is simply buried in drugs (every schoolchild knows what ‚Äúdaknet‚Äù is, and after 30 minutes has the actual opportunity in any city with a population of 10 thousand people to get any drugs without hindrance. in any quantities - such an evil truth of life).  In the current mode, the probability of blocking the Tor network is lower than the probability of blocking the Hermitage museum site. <br><br>  These instructions are easy to adapt for routers with OpenWrt.  Also, minor changes can easily replace Tor with OpenVPN. <br><br><a name="con11"></a><h1>  How will you manage block bypass after setup? </h1><br>  Everything is very simple.  You have the file /opt/etc/unblock.txt - a simple list to unlock.  You can unblock a domain, IP address, address range or CIDR.  One line - one element.  Blank lines are allowed, and you can use the # character at the beginning of a line to ignore. <br><br><div class="spoiler">  <b class="spoiler_title">Here is an example of my personal file.</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">###- rutracker.org rutor.info rutor.is mega-tor.org kinozal.tv nnm-club.me nnm-club.ws tfile.me tfile-home.org tfile1.cc megapeer.org megapeer.ru tapochek.net tparser.org rustorka.com uniongang.tv fast-torrent.ru ###    hdrezka.ag hdrezka.me filmix.co filmix.cc seasonvar.ru ### lib.rus.ec flisland.net flibusta.site ### telegram.org tdesktop.com tdesktop.org tdesktop.info tdesktop.net telesco.pe telegram.dog telegram.me t.me web.telegram.org desktop.telegram.org updates.tdesktop.com venus.web.telegram.org flora.web.telegram.org vesta.web.telegram.org pluto.web.telegram.org aurora.web.telegram.org 149.154.172.0/22 91.108.4.0/22 91.108.8.0/22 91.108.12.0/22 91.108.16.0/22 91.108.56.0/22 149.154.160.0/22 149.154.164.0/22 149.154.168.0/22 ### edem.tv crimerussia.com 4pna.com 2019.vote ### Tor check.torproject.org ###   IP ( #   ) #195.82.146.214 ###   CIDR ( #   ) #103.21.244.0/22 ###    ( #   ) #100.100.100.200-100.100.100.210</span></span></code> </pre> <br></div></div><br>  After editing this file, you simply execute the command to apply the new configuration: <br><br><pre> <code class="bash hljs">unblock_update.sh</code> </pre> <br>  All resources from unblock.txt are unlocked without the need to restart the router. <br><br><a name="con12"></a><h1>  Principle of operation </h1><br><ul><li>  When the router is initialized, an empty IP address set ipset is created with the name unblock. </li><li>  A rule is added to the firewall to redirect all packets with unblock destinations to Tor. </li><li>  The Tor service starts in transparent proxy mode. </li><li>  A special unblock_ipset.sh script runs, which resolves all the domains from unblock.txt and adds their IP addresses to the unblock set.  IP addresses, ranges and CIDR from this file are also added to unblock. </li><li>  It starts dnsmasq with an additional unblock.dnsmasq configuration file, which specifies the addition of the IP addresses of the domains from unblock.txt to the unblock set during resolving. </li><li>  cron runs unblock_ipset.sh at regular intervals to partially compensate for possible cases with nuances. </li><li>  If necessary, all domains from unblock.txt (and only they) are resolved via dnscrypt-proxy, if the provider filters DNS. </li></ul><br><a name="con2"></a><h1>  Configuring the router with firmware Padavan </h1><br>  You must have a router with Padavan firmware installed and an Entware package manager already configured.  On Windows, you can use the <a href="https://www.putty.org/">PuTTY</a> client to connect to the router via SSH. <br><br>  Make sure you use Entware, and not outdated Entware-ng.  Look at the contents of the / opt / var / opkg-lists folder.  There will be an entware or entware-ng file.  In the second case, you need to upgrade your router's Padavan firmware to the latest version and reinstall the Entware package manager.  Only after that proceed step by step instructions. <br><br>  As reviews have shown, mostly problems arise for those who have Entware configured incorrectly initially (ie, scripts from init.d are not loaded) in the internal memory of the router.  If you have Xiaomi Mi Router 3 or 3G, and you are not sure that Entware in your internal memory is working correctly (automatic start), then just set everything up again.  Take PROMETHEUS.  Updates the script (1).  Update source code (2).  Collect and flash the most current firmware (4).  Reset the firmware settings (NVRAM and file storage) - More&gt; Administration&gt; Settings.  Configure Internet access on the router and enable SSH.  Perform in PROMETHEUS Firmware&gt; Format RWFS.  Choose Advanced&gt; Administration&gt; Settings&gt; Mount file system in R / W section&gt; UBIFS.  Reboot the router.  All actual Entware startup scripts from the internal memory will be registered automatically, and everything will work like a clock. <br><br>  For the tests, I used the popular Xiaomi Mi Router 3G (Entware is installed in the internal memory) with the latest firmware - 32a93db.  Everything will work even on the legendary baby WT3020 AD / F / H for $ 10. <br><br><img src="https://habrastorage.org/webt/th/kf/2k/thkf2kvtt2rhtnbxvmx0qri7dsk.jpeg"><br><br><h3>  1. Install the necessary software on the router </h3><br><pre> <code class="bash hljs">opkg update opkg install mc tor tor-geoip <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-dig cron</code> </pre> <br>  <b>mc</b> is the Midnight Commander file manager.  It is needed only because of the convenient editor mcedit.  If you are used to using another text editor, then you can not install mc. <br>  <b>tor</b> - Tor service. <br>  <b>tor-geoip</b> is a geo-IP base for Tor. <br>  <b>bind-dig</b> is a DNS client (similar to nslookup and host). <br>  <b>cron</b> - task scheduler. <br><cut></cut><br><h3>  2. Initialize ipset, create multiple unblock IP addresses (start_script.sh) </h3><br>  Connect the necessary modules and create an empty set of addresses named <b>unblock</b> when booting the router.  To do this, open the <b>/etc/storage/start_script.sh</b> file in the editor: <br><br><pre> <code class="bash hljs">mcedit /etc/storage/start_script.sh</code> </pre> <br>  Add at the end: <br><br><pre> <code class="bash hljs">modprobe ip_set modprobe ip_set_hash_ip modprobe ip_set_hash_net modprobe ip_set_bitmap_ip modprobe ip_set_list_set modprobe xt_set ipset create unblock <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>:net</code> </pre> <br>  To paste from the buffer, use Shift + Insert, save - F2, exit - F10. <br><br><img src="https://habrastorage.org/webt/tr/zp/cq/trzpcqqnadbonhsb0x3ebe7ltpo.png"><br><br>  If you wish, you can edit the start_script.sh file through the web interface of the router - ‚ÄúAdvanced‚Äù&gt; ‚ÄúPersonalization‚Äù&gt; ‚ÄúScripts‚Äù&gt; ‚ÄúRun before router initialization‚Äù.  After editing, click "Apply". <br><br><img src="https://habrastorage.org/webt/yr/aa/8q/yraa8qgcfwu-vesrp3wvvne2vui.png"><br><br><h3>  3. Configure Tor </h3><br>  Delete the contents of the Tor configuration file: <br><br><pre> <code class="bash hljs">cat /dev/null &gt; /opt/etc/tor/torrc</code> </pre> <br>  Open the Tor configuration file: <br><br><pre> <code class="bash hljs">mcedit /opt/etc/tor/torrc</code> </pre> <br>  Insert (Shift + Insert) content: <br><br><pre> <code class="bash hljs">User admin PidFile /opt/var/run/tor.pid ExcludeExitNodes {RU},{UA},{AM},{KG},{BY} StrictNodes 1 TransPort 192.168.0.1:9141 ExitRelay 0 ExitPolicy reject *:* ExitPolicy reject6 *:* GeoIPFile /opt/share/tor/geoip GeoIPv6File /opt/share/tor/geoip6 DataDirectory /opt/var/lib/tor</code> </pre> <br>  If necessary, replace <b>192.168.0.1</b> with the internal address of your router (LAN).  A brief description of the configuration: <br><br><ul><li>  Exclude weekend nodes: Russia, Ukraine, Armenia, Kyrgyzstan, Belarus. </li><li>  Hang the "transparent" proxy to the address 192.168.0.1, port 9141. </li><li>  Disallow being an exit point. </li></ul><br><h3>  4. List of domains (and not only) to bypass the blocking (unblock.txt) </h3><br>  unblock.txt - a simple list to unlock.  You can unblock a domain, IP address, range or CIDR.  One line - one element.  Blank lines (including spaces and tabs) are ignored.  You can use the # character at the beginning of a line to ignore. <br><br>  Create the <b>/opt/etc/unblock.txt</b> file: <br><br><pre> <code class="bash hljs">mcedit /opt/etc/unblock.txt</code> </pre> <br>  Each line can contain a domain name, IP address, range or CIDR.  You can use the # symbol to comment lines. <br><br><div class="spoiler">  <b class="spoiler_title">Here is an example of my personal file.</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">###- rutracker.org rutor.info rutor.is mega-tor.org kinozal.tv nnm-club.me nnm-club.ws tfile.me tfile-home.org tfile1.cc megapeer.org megapeer.ru tapochek.net tparser.org rustorka.com uniongang.tv fast-torrent.ru ###    hdrezka.ag hdrezka.me filmix.co filmix.cc seasonvar.ru ### lib.rus.ec flisland.net flibusta.site ### telegram.org tdesktop.com tdesktop.org tdesktop.info tdesktop.net telesco.pe telegram.dog telegram.me t.me web.telegram.org desktop.telegram.org updates.tdesktop.com venus.web.telegram.org flora.web.telegram.org vesta.web.telegram.org pluto.web.telegram.org aurora.web.telegram.org 149.154.172.0/22 91.108.4.0/22 91.108.8.0/22 91.108.12.0/22 91.108.16.0/22 91.108.56.0/22 149.154.160.0/22 149.154.164.0/22 149.154.168.0/22 ### edem.tv crimerussia.com 4pna.com 2019.vote ### Tor check.torproject.org ###   IP ( #   ) #195.82.146.214 ###   CIDR ( #   ) #103.21.244.0/22 ###    ( #   ) #100.100.100.200-100.100.100.210</span></span></code> </pre> <br></div></div><br><h3>  5. Script to populate the set of unblock IP addresses of a given list of domains (unblock_ipset.sh) </h3><br>  Create a script <b>/opt/bin/unblock_ipset.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_ipset.sh</code> </pre> <br>  Insert (Shift + Insert) content: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh until ADDRS=$(dig +short google.com @localhost) &amp;&amp; [ -n "$ADDRS" ] &gt; /dev/null 2&gt;&amp;1; do sleep 5; done while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue cidr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}') if [ ! -z "$cidr" ]; then ipset -exist add unblock $cidr continue fi range=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}-[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$range" ]; then ipset -exist add unblock $range continue fi addr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$addr" ]; then ipset -exist add unblock $addr continue fi dig +short $line @localhost | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | awk '{system("ipset -exist add unblock "$1)}' done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br>  Give execution rights: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_ipset.sh</code> </pre> <br>  The script is quite simple, this is the essence of its work ... We are waiting for the rezolving of the google.com domain to work (if this is not done, then the unblock set will not be filled when the router is loaded, because the router will still be in the process of initialization).  We read lines in the unblock.txt file.  Spaces and tabs at the beginning and at the end are automatically removed from the read lines.  Skipping blank lines.  We skip lines that begin with a # character.  We are looking for the CIDR line.  If CIDR is found, then add it to unblock.  We search for a range in the string.  If it is found, then add it to unblock.  We are looking for an IP address in the line.  If the IP is found, then add it to unblock.  Solve the string via dig.  All result IP addresses are added to unblock. <br><br><h3>  6. Script for generating the additional dnsmasq configuration file from the specified list of domains (unblock_dnsmasq.sh) </h3><br>  Create a script <b>/opt/bin/unblock_dnsmasq.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_dnsmasq.sh</code> </pre> <br>  Insert (Shift + Insert) content: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cat /dev/null &gt; /opt/etc/unblock.dnsmasq while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue echo $line | grep -Eq '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' &amp;&amp; continue echo "ipset=/$line/unblock" &gt;&gt; /opt/etc/unblock.dnsmasq done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br>  Give execution rights: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_dnsmasq.sh</code> </pre> <br>  The script is quite simple, here is the essence of his work ... We consistently read lines from /opt/etc/unblock.txt.  Spaces and tabs at the beginning and at the end are automatically removed from the read lines.  Skipping blank lines.  We skip lines that begin with #.  We skip lines that contain an IP address (IP, range, CIDR), i.e.  we are only interested in strings with domain names.  In the /opt/etc/unblock.dnsmasq file we add the lines ‚Äúipset = / domain_name / unblock‚Äù.  This means that after determining the IP addresses of a specific domain, they will be automatically added to the unblock set. <br><br>  Be sure to run the script to generate the unblock.dnsmasq file: <br><br><pre> <code class="bash hljs">unblock_dnsmasq.sh</code> </pre> <br>  Check that the unblock.dnsmasq file is created: <br><br><pre> <code class="bash hljs">cat /opt/etc/unblock.dnsmasq</code> </pre> <br><h3>  7. Script manual forced system update after editing the list of domains (unblock_update.sh) </h3><br>  Create a script <b>/opt/bin/unblock_update.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_update.sh</code> </pre> <br>  Insert (Shift + Insert) content: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ipset flush unblock /opt/bin/unblock_dnsmasq.sh restart_dhcpd sleep 3 /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre> <br>  Give execution rights: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_update.sh</code> </pre> <br><h3>  8. Script for automatic filling of unblock sets when booting the router (S99unblock) </h3><br>  Create a script <b>/opt/etc/init.d/S99unblock</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/etc/init.d/S99unblock</code> </pre> <br>  Insert (Shift + Insert) content: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$1" != "start" ] &amp;&amp; exit 0 /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre><br>  Give execution rights: <br><br><pre> <code class="bash hljs">chmod +x /opt/etc/init.d/S99unblock</code> </pre> <br><h3>  9. Redirecting packets from unblock to Tor (post_iptables_script.sh) </h3><br>  Open the <b>/etc/storage/post_iptables_script.sh</b> file in the editor: <br><br><pre> <code class="bash hljs">mcedit /etc/storage/post_iptables_script.sh</code> </pre> <br>  Add at the end: <br><br><pre> <code class="bash hljs">iptables -t nat -A PREROUTING -i br0 -p tcp -m <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --match-set unblock dst -j REDIRECT --to-port 9141</code> </pre> <br><img src="https://habrastorage.org/webt/af/u2/dl/afu2dld3v0nrhtjwfekvo6i-wsi.png"><br><br>  If you wish, you can edit the post_iptables_script.sh file via the web interface of the router - ‚ÄúAdvanced‚Äù&gt; ‚ÄúPersonalization‚Äù&gt; ‚ÄúScripts‚Äù&gt; ‚ÄúRun after restarting the firewall rules‚Äù.  After editing, click "Apply". <br><br><img src="https://habrastorage.org/webt/pv/be/ot/pvbeotspo0xhzrukgp3dgvu5aws.png"><br><br>  In the same file you can add (this is optional) redirect all requests to external port 53 to yourself.  This is necessary so that clients on the local network do not use third-party DNS services.  Requests will go through a regular DNS server. <br><br><pre> <code class="bash hljs">iptables -t nat -I PREROUTING -i br0 -p udp --dport 53 -j DNAT --to 192.168.0.1 iptables -t nat -I PREROUTING -i br0 -p tcp --dport 53 -j DNAT --to 192.168.0.1</code> </pre> <br>  If necessary, replace <b>192.168.0.1</b> with the internal address of your router (LAN). <br><br><h3>  10. Connecting an additional configuration file to dnsmasq </h3><br>  We need to connect the created unblock.dnsmasq file to dnsmasq.  To do this, open the <b>/etc/storage/dnsmasq/dnsmasq.conf</b> file in the editor: <br><br><pre> <code class="bash hljs">mcedit /etc/storage/dnsmasq/dnsmasq.conf</code> </pre> <br>  Add at the end: <br><br><pre> <code class="bash hljs">conf-file=/opt/etc/unblock.dnsmasq</code> </pre> <br>  If you wish (this is optional), you can add an additional server for resolving and reliability: <br><br><pre> <code class="bash hljs">server=8.8.8.8</code> </pre> <br>  If you wish, you can edit the dnsmasq.conf file through the web interface of the router ‚Äî Advanced&gt; LAN&gt; DHCP Server&gt; Custom configuration file dnsmasq.conf.  After editing, click "Apply". <br><br><img src="https://habrastorage.org/webt/x0/ar/4c/x0ar4cm6v9pgsluqabh74qck-s0.png"><br><br><h3>  11. Adding a task to cron to periodically update the contents of the set unblock </h3><br>  This is an additional insurance in case programs / devices use their own method of resolving, and the IP address of the domain has changed.  All you need to do is run the script unblock_ipset.sh with the desired frequency.  For example, we will run every day at 6 am. <br><br>  Replace the root name in the cron configuration file with admin: <br><br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">'s/root/admin/g'</span></span> /opt/etc/crontab</code> </pre> <br>  Open the <b>/ opt / etc / crontab</b> file in the editor: <br><br><pre> <code class="bash hljs">mcedit /opt/etc/crontab</code> </pre> <br>  Add at the end: <br><br><pre> <code class="bash hljs">00 06 * * * admin /opt/bin/unblock_ipset.sh</code> </pre> <br>  If you wish, you can comment out all the other template tasks.  Here is what your crontab will look like: <br><br><img src="https://habrastorage.org/webt/hf/lb/fc/hflbfcv04lpvzlrjmehoc3l51ts.png"><br><br><h3>  12. Reboot the router </h3><br>  Run the command: <br><br><pre> <code class="bash hljs">reboot</code> </pre> <br>  After the reboot, open the check.torproject.org site in the browser (it should be added to unblock.txt).  If you did everything right, then you will see the inscription ‚ÄúCongratulations.  This browser is configured to use Tor. ‚Äù: <br><br><img src="https://habrastorage.org/webt/wa/19/dz/wa19dzxbu8qtldwrvkeijfqna7q.png"><br><br><br><a name="con3"></a><h1>  Configuring a router with Keenetic OS </h1><br>  You must have a Keenetic / Zyxel router with an Entware package manager (OPKG) already configured.  For example, here is a list of some routers that support Entware: Keenetic II, Keenetic III, Extra, Extra II, Giga II, Giga III, Omni, Omni II, Viva, Ultra, Ultra II, Omni (KN-1410), Extra (KN -1710), Giga (KN-1010), Ultra (KN-1810), Viva (KN-1910), DSL (KN-2010), Duo (KN-2110).  Instructions for setting up Entware can be found <a href="https://help.keenetic.com/hc/ru/articles/360000264829-%25D0%25A3%25D1%2581%25D1%2582%25D0%25B0%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B0-%25D0%25B8-%25D0%25BD%25D0%25B0%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25B9%25D0%25BA%25D0%25B0-OPKG-%25D0%25BF%25D0%25B0%25D0%25BA%25D0%25B5%25D1%2582%25D0%25B0-rTorrent">here</a> (up to 10 points). <br><br>  If earlier (with firmware earlier than 2.07) you have already added support for Entware, then make sure that you <a href="https://forum.keenetic.net/topic/4223-entware-3x-%25D0%25B8-entware-ng-%25D0%25BE%25D0%25B1%25D1%258A%25D0%25B5%25D0%25B4%25D0%25B8%25D0%25BD%25D0%25B8%25D0%25BB%25D0%25B8%25D1%2581%25D1%258C-%25D0%25BD%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9-%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582-%25D0%25BD%25D0%25B0%25D0%25B7%25D1%258B%25D0%25B2%25D0%25B0%25D0%25B5%25D1%2582%25D1%2581%25D1%258F-%25D0%25BF%25D1%2580%25D0%25BE%25D1%2581%25D1%2582%25D0%25BE-entware/">are using non-outdated Entware-ng</a> . <br><br>  Be sure to enable the ‚ÄúNetfilter Subsystem Kernel Modules‚Äù - General Settings&gt; Change Component Set.  If it is not in the list of available, then try installing IPv6 Protocol component first.  If after that does not appear, then try without it, but there is a high probability that you will not have unlock range and CIDR working (since there will be no support for many hash: net). <br><br><img src="https://habrastorage.org/webt/vv/dh/hi/vvdhhirhcktuefrgbxh3fkx5i0i.png"><br><br>  For the tests, I used Keenetic Ultra (KN-1810) with the latest firmware - 2.14.C.0.0-4. <br><br>  <u>Important note.</u>  <u>You will have to disable the regular DNS server in the system, we will use dnsmasq instead.</u>  <u>You will lose the ability to assign DNS services (Yandex.DNS / SkyDNS / AdGuard DNS) individually for clients, but you can easily use them globally through the dnsmasq settings if necessary.</u> <br><br><h3>  1. Install the necessary software on the router </h3><br><pre> <code class="bash hljs">opkg update opkg install mc tor tor-geoip <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-dig cron dnsmasq-full ipset iptables</code> </pre> <br>  <b>mc</b> is the Midnight Commander file manager.  It is needed only because of the convenient editor mcedit.  If you are used to using another text editor, then you can not install mc. <br>  <b>tor</b> - Tor service. <br>  <b>tor-geoip</b> is a geo-IP base for Tor. <br>  <b>bind-dig</b> is a DNS client (similar to nslookup and host). <br>  <b>cron</b> - task scheduler. <br>  <b>dnsmasq-full</b> - DNS server. <br>  <b>ipset and iptables</b> are console utilities ipset and iptables (perhaps they are already in the system and are not needed, I added them for backup). <br><br><h3>  2. Initialize ipset, create multiple unblock IP addresses (100-ipset.sh) </h3><br>  Check that your router‚Äôs system has support for many hash: net (as it turned out, not all Keenetic routers have it): <br><br><pre> <code class="bash hljs">ipset create <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>:net</code> </pre> <br>  If the team has not issued any errors and messages, then there is support, and just follow the instructions further.  Otherwise (there is an error) in the following script you need to replace <b>hash: net</b> with <b>hash: ip</b> .  At the same time, you will lose the ability to unlock by range and CIDR. <br><br>  Create an empty set of addresses named <b>unblock</b> when booting the router.  To do this, create the file <b>/opt/etc/ndm/fs.d/100-ipset.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/etc/ndm/fs.d/100-ipset.sh</code> </pre> <br>  Insert (Shift + Insert) content: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$1" != "start" ] &amp;&amp; exit 0 ipset create unblock hash:net -exist exit 0</span></span></code> </pre> <br>  To paste from the buffer, use Shift + Insert, save - F2, exit - F10. <br><br>  Give execution rights: <br><br><pre> <code class="bash hljs">chmod +x /opt/etc/ndm/fs.d/100-ipset.sh</code> </pre> <br><h3>  3. Configure Tor </h3><br>  Delete the contents of the Tor configuration file: <br><br><pre> <code class="bash hljs">cat /dev/null &gt; /opt/etc/tor/torrc</code> </pre> <br>  Open the Tor configuration file: <br><br><pre> <code class="bash hljs">mcedit /opt/etc/tor/torrc</code> </pre> <br>  Insert (Shift + Insert) content: <br><br><pre> <code class="bash hljs">User root PidFile /opt/var/run/tor.pid ExcludeExitNodes {RU},{UA},{AM},{KG},{BY} StrictNodes 1 TransPort 192.168.0.1:9141 ExitRelay 0 ExitPolicy reject *:* ExitPolicy reject6 *:* GeoIPFile /opt/share/tor/geoip GeoIPv6File /opt/share/tor/geoip6 DataDirectory /opt/var/lib/tor</code> </pre> <br>  If necessary, replace <b>192.168.0.1</b> with the internal address of your router (LAN).  A brief description of the configuration: <br><br><ul><li>  Exclude weekend nodes: Russia, Ukraine, Armenia, Kyrgyzstan, Belarus. </li><li>  Hang the "transparent" proxy to the address 192.168.0.1, port 9141. </li><li>  Forbid to be an exit point. </li></ul><br><h3>  4. List of domains (and not only) to bypass the blocking (unblock.txt) </h3><br>  unblock.txt - a simple list to unlock.  You can unblock a domain, IP address, range or CIDR.  One line - one element.  Blank lines (including spaces and tabs) are ignored.  You can use the # character at the beginning of a line to ignore. <br><br>  Create the <b>/opt/etc/unblock.txt</b> file: <br><br><pre> <code class="bash hljs">mcedit /opt/etc/unblock.txt</code> </pre> <br>  Each line can contain a domain name, IP address, range or CIDR.  You can use the # symbol to comment lines. <br><br><div class="spoiler">  <b class="spoiler_title">Here is an example of my personal file.</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">###- rutracker.org rutor.info rutor.is mega-tor.org kinozal.tv nnm-club.me nnm-club.ws tfile.me tfile-home.org tfile1.cc megapeer.org megapeer.ru tapochek.net tparser.org rustorka.com uniongang.tv fast-torrent.ru ###    hdrezka.ag hdrezka.me filmix.co filmix.cc seasonvar.ru ### lib.rus.ec flisland.net flibusta.site ### telegram.org tdesktop.com tdesktop.org tdesktop.info tdesktop.net telesco.pe telegram.dog telegram.me t.me web.telegram.org desktop.telegram.org updates.tdesktop.com venus.web.telegram.org flora.web.telegram.org vesta.web.telegram.org pluto.web.telegram.org aurora.web.telegram.org 149.154.172.0/22 91.108.4.0/22 91.108.8.0/22 91.108.12.0/22 91.108.16.0/22 91.108.56.0/22 149.154.160.0/22 149.154.164.0/22 149.154.168.0/22 ### edem.tv crimerussia.com 4pna.com 2019.vote ### Tor check.torproject.org ###   IP ( #   ) #195.82.146.214 ###   CIDR ( #   ) #103.21.244.0/22 ###    ( #   ) #100.100.100.200-100.100.100.210</span></span></code> </pre> <br></div></div><br><h3>  5. Script to populate the set of unblock IP addresses of a given list of domains (unblock_ipset.sh) </h3><br>  Create a script <b>/opt/bin/unblock_ipset.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_ipset.sh</code> </pre> <br>  Insert (Shift + Insert) content: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh until ADDRS=$(dig +short google.com @localhost) &amp;&amp; [ -n "$ADDRS" ] &gt; /dev/null 2&gt;&amp;1; do sleep 5; done while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue cidr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}') if [ ! -z "$cidr" ]; then ipset -exist add unblock $cidr continue fi range=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}-[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$range" ]; then ipset -exist add unblock $range continue fi addr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$addr" ]; then ipset -exist add unblock $addr continue fi dig +short $line @localhost | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | awk '{system("ipset -exist add unblock "$1)}' done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br>  Give execution rights: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_ipset.sh</code> </pre> <br>  The script is quite simple, this is the essence of its work ... We are waiting for the rezolving of the google.com domain to work (if this is not done, the unblock will not be filled when the router is loaded, because the router will be still in the process of initialization).  We read lines in the unblock.txt file.  Spaces and tabs at the beginning and at the end are automatically removed from the read lines.  Skipping blank lines.  We skip lines that begin with a # character.  We are looking for the CIDR line.  If CIDR is found, then add it to unblock.  We are looking for a range in the string.  If it is found, then add it to unblock.  We are looking for an IP address in the line.  If the IP is found, then add it to unblock.  Solve the string via dig.  All result IP addresses are added to unblock. <br><br><h3>  6. Script for generating the additional dnsmasq configuration file from the specified list of domains (unblock_dnsmasq.sh) </h3><br>  Create a script <b>/opt/bin/unblock_dnsmasq.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_dnsmasq.sh</code> </pre> <br>  Insert (Shift + Insert) content: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cat /dev/null &gt; /opt/etc/unblock.dnsmasq while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue echo $line | grep -Eq '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' &amp;&amp; continue echo "ipset=/$line/unblock" &gt;&gt; /opt/etc/unblock.dnsmasq done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br>  Give execution rights: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_dnsmasq.sh</code> </pre> <br>  The script is quite simple.  We consistently read lines from /opt/etc/unblock.txt.  Spaces and tabs at the beginning and at the end are automatically removed from the read lines.  Skipping blank lines.  We skip lines that begin with #.  We skip lines that contain an IP address (IP or CIDR), i.e.  we are only interested in strings with domain names.  In the /opt/etc/unblock.dnsmasq file we add the lines ‚Äúipset = / domain_name / unblock‚Äù.  This means that after determining the IP addresses of a specific domain, they will be automatically added to the unblock set. <br><br>  Be sure to run the script to generate the unblock.dnsmasq file: <br><br><pre> <code class="bash hljs">unblock_dnsmasq.sh</code> </pre> <br>  Check that the unblock.dnsmasq file is created: <br><br><pre> <code class="bash hljs">cat /opt/etc/unblock.dnsmasq</code> </pre> <br><h3>  7. Script manual forced system update after editing the list of domains (unblock_update.sh) </h3><br>  Create a script <b>/opt/bin/unblock_update.sh</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_update.sh</code> </pre> <br>  Insert (Shift + Insert) content: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ipset flush unblock /opt/bin/unblock_dnsmasq.sh /opt/etc/init.d/S56dnsmasq restart /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre> <br>  Give execution rights: <br><br><pre> <code class="bash hljs">chmod +x /opt/bin/unblock_update.sh</code> </pre> <br><h3>  8. Script for automatic filling of unblock sets when booting the router (S99unblock) </h3><br>  Create a script <b>/opt/etc/init.d/S99unblock</b> : <br><br><pre> <code class="bash hljs">mcedit /opt/etc/init.d/S99unblock</code> </pre> <br>  Insert (Shift + Insert) content: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$1" != "start" ] &amp;&amp; exit 0 /opt/bin/unblock_ipset.sh &amp;</span></span></code> </pre><br>  Give execution rights: <br><br><pre> <code class="bash hljs">chmod +x /opt/etc/init.d/S99unblock</code> </pre> <br><h3>  9. Redirecting packets from unblock to Tor (100-redirect.sh) </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To do this, create the file </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/opt/etc/ndm/netfilter.d/100-redirect.sh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/ndm/netfilter.d/100-redirect.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Insert (Shift + Insert) content: </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh [ "$type" == "ip6tables" ] &amp;&amp; exit 0 if [ -z "$(iptables-save 2&gt;/dev/null | grep unblock)" ]; then ipset create unblock hash:net -exist iptables -w -t nat -A PREROUTING -i br0 -p tcp -m set --match-set unblock dst -j REDIRECT --to-port 9141 fi exit 0</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you used </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hash: ip</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> instead of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hash: net</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in step 2 </font><font style="vertical-align: inherit;">, replace hash: net with hash: ip. </font><font style="vertical-align: inherit;">In fact, we additionally duplicate the function of creating the unblock set of 2 steps. </font><font style="vertical-align: inherit;">This is needed for security, if the scripts from fs.d have not yet started to run, and the scripts of netfilter.d are already running. </font><font style="vertical-align: inherit;">It's okay if unblock has already been created earlier, the command will simply be ignored. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the same file you can add (this is optional) redirect all requests to external port 53 to yourself. </font><font style="vertical-align: inherit;">This is necessary so that clients on the local network do not use third-party DNS services. </font><font style="vertical-align: inherit;">Requests will go through a regular DNS server. </font><font style="vertical-align: inherit;">Before the last exit, add:</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -z <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(iptables-save 2&gt;/dev/null | grep "udp \-\-dport 53 \-j DNAT")</span></span></span><span class="hljs-string">"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> iptables -w -t nat -I PREROUTING -i br0 -p udp --dport 53 -j DNAT --to 192.168.0.1 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -z <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(iptables-save 2&gt;/dev/null | grep "tcp \-\-dport 53 \-j DNAT")</span></span></span><span class="hljs-string">"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> iptables -w -t nat -I PREROUTING -i br0 -p tcp --dport 53 -j DNAT --to 192.168.0.1 <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If necessary, replace </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.0.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with the internal address of your router (LAN). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Give execution rights:</font></font><br><br><pre> <code class="bash hljs">chmod +x /opt/etc/ndm/netfilter.d/100-redirect.sh</code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10. Configure dnsmasq and connect an additional configuration file to dnsmasq </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Delete the contents of the dnsmasq configuration file: </font></font><br><br><pre> <code class="bash hljs">cat /dev/null &gt; /opt/etc/dnsmasq.conf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Open the dnsmasq configuration file: </font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/dnsmasq.conf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Insert (Shift + Insert) content: </font></font><br><br><pre> <code class="bash hljs">user=nobody bogus-priv no-negcache clear-on-reload <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>-dynamic listen-address=192.168.0.1 listen-address=127.0.0.1 min-port=4096 cache-size=1536 expand-hosts <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-facility=/dev/null <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-async conf-file=/opt/etc/unblock.dnsmasq server=8.8.8.8</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If necessary, replace </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.0.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with the internal address of your router (LAN).</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 11. Adding a task to cron to periodically update the contents of the set unblock </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is an additional insurance in case programs / devices use their own method of resolving, and the IP address of the domain has changed. </font><font style="vertical-align: inherit;">All you need to do is run the script unblock_ipset.sh with the desired frequency. </font><font style="vertical-align: inherit;">For example, we will run every day at 6 am. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ opt / etc / crontab</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file in the editor </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/crontab</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Add at the end: </font></font><br><br><pre> <code class="bash hljs">00 06 * * * root /opt/bin/unblock_ipset.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you wish, you can comment out all the other template tasks. </font><font style="vertical-align: inherit;">Here is what your crontab will look like:</font></font><br><br><img src="https://habrastorage.org/webt/le/y5/sl/ley5slcvjfvs-9odj9air9qdd8s.png"><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 12. Disable regular DNS server and reboot the router </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connect to the </font></font><a href="https://help.keenetic.com/hc/ru/articles/213965889-%25D0%2598%25D0%25BD%25D1%2582%25D0%25B5%25D1%2580%25D1%2584%25D0%25B5%25D0%25B9%25D1%2581-%25D0%25BA%25D0%25BE%25D0%25BC%25D0%25B0%25D0%25BD%25D0%25B4%25D0%25BD%25D0%25BE%25D0%25B9-%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25BA%25D0%25B8-CLI-%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B5%25D1%2580%25D0%25BD%25D0%25B5%25D1%2582-%25D1%2586%25D0%25B5%25D0%25BD%25D1%2582%25D1%2580%25D0%25B0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keenetic router CLI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (port 23 for Telnet and 22 for SSH if the SSH Server component is added to the system). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run the command:</font></font><br><br><pre> <code class="bash hljs">opkg dns-override system configuration save system reboot</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The built-in DNS server will be turned off, and dnsmasq from Entware will be used instead. </font><font style="vertical-align: inherit;">The router checks when the opt folder is mounted (if there is a flash drive / disk with Entware). </font><font style="vertical-align: inherit;">If there is, then the regular DNS server is not used. </font><font style="vertical-align: inherit;">If not, it is used.</font></font> Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">removing the flash drive and rebooting the router, everything will work for you, as before (before setting up). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After the reboot, open the check.torproject.org site in the browser (it should be added to unblock.txt). </font><font style="vertical-align: inherit;">If you did everything right, then you will see the inscription ‚ÄúCongratulations. </font><font style="vertical-align: inherit;">This browser is configured to use Tor. ‚Äù:</font></font><br><br><img src="https://habrastorage.org/webt/wa/19/dz/wa19dzxbu8qtldwrvkeijfqna7q.png"><br><br><br><a name="con31"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Basic methods for diagnosing errors after setup </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the check with the site check.torproject.org (it should be added to unblock.txt) passes, but for other resources the stub from the provider continues to open (or does not open), most likely the provider interferes with the DNS traffic, replacing the answers - you need to do an additional filtering bypass DNS queries. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If, after setting up, something does not work as it should, use simple commands to identify the problem phase. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Display the contents of the unblock set:</font></font><br><br><pre> <code class="bash hljs">ipset list unblock</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the system reports that there is no such set, then the error in step 2 or you did not include the Netfilter module in the system (in the case of Keenetic). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the set is empty, then the unblock_ipset.sh script, which in turn must be started with the S99unblock startup script, did not work. Run this unblock_ipset.sh script manually. If the set is full, then the error is at step 8. If the script cannot be executed (most likely it is expecting google.com to be resolved), then the error is somewhere on the side of the DNS server, possibly at step 10 or 6. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Check for a redirect in iptables :</font></font><br><br><pre> <code class="bash hljs">iptables-save 2&gt;/dev/null | grep unblock</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If not, then the error in step 9. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If at all all the sites do not work, i.e. </font><font style="vertical-align: inherit;">DNS does not work, an error somewhere in step 6 or 10. Perhaps in step 9. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If all sites from unblock.txt do not work (waiting time is exceeded), but all others work, then the problem is somewhere on the Tor side, an error in step 3.</font></font><br><br><br><a name="con4"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Optional bypass filtering DNS requests by the provider </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If a provider intervenes in DNS traffic, replacing responses for blocked resources, it is very easy to get around. </font><font style="vertical-align: inherit;">For this we will use dnscrypt-proxy. </font><font style="vertical-align: inherit;">With desire and experience, you can easily replace dnscrypt with stubby (DNS over TLS). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dnscrypt will be used only for those domains listed in unblock.txt. </font><font style="vertical-align: inherit;">All other requests will go through regular DNS servers. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you are sure that your provider does not filter DNS queries, then this additional configuration is not necessary. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You should already have configured the lock bypass described above. </font><font style="vertical-align: inherit;">The following settings are identical for Padavan and Keenetic OS. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install additional software on the router:</font></font><br><br><pre> <code class="bash hljs">opkg update opkg install dnscrypt-proxy2</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Open the dnscrypt-proxy configuration file: </font></font><br><br><pre> <code class="bash hljs">mcedit /opt/etc/dnscrypt-proxy.toml</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Find the parameters listen_addresses, fallback_resolver, cache and change them: </font></font><br><br><pre> <code class="bash hljs">listen_addresses = [<span class="hljs-string"><span class="hljs-string">'127.0.0.1:9153'</span></span>] fallback_resolver = <span class="hljs-string"><span class="hljs-string">'77.88.8.8:1253'</span></span> cache = <span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">77.88.8.8:1253 is the address of the Yandex DNS server with a non-standard port. </font><font style="vertical-align: inherit;">It is a backup in case dnscrypt-proxy encounters any problems. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run dnscrypt-proxy:</font></font><br><br><pre> <code class="bash hljs">/opt/etc/init.d/S09dnscrypt-proxy2 start</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Make sure dnscrypt-proxy is working (you should see a list of IP addresses in response): </font></font><br><br><pre> <code class="bash hljs">dig +short google.com @localhost -p 9153</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/opt/bin/unblock_ipset.sh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> script in the editor </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_ipset.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Replace content with: </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh until ADDRS=$(dig +short google.com @localhost -p 9153) &amp;&amp; [ -n "$ADDRS" ] &gt; /dev/null 2&gt;&amp;1; do sleep 5; done while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue cidr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/[0-9]{1,2}') if [ ! -z "$cidr" ]; then ipset -exist add unblock $cidr continue fi range=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}-[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$range" ]; then ipset -exist add unblock $range continue fi addr=$(echo $line | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}') if [ ! -z "$addr" ]; then ipset -exist add unblock $addr continue fi dig +short $line @localhost -p 9153 | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | awk '{system("ipset -exist add unblock "$1)}' done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We made a small change - now dig for resolving uses not a regular DNS server, but dnscrypt-proxy with port 9153. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/opt/bin/unblock_dnsmasq.sh</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> script in the editor </font><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="bash hljs">mcedit /opt/bin/unblock_dnsmasq.sh</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Replace content with: </font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh cat /dev/null &gt; /opt/etc/unblock.dnsmasq while read line || [ -n "$line" ]; do [ -z "$line" ] &amp;&amp; continue [ "${line:0:1}" = "#" ] &amp;&amp; continue echo $line | grep -Eq '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' &amp;&amp; continue echo "ipset=/$line/unblock" &gt;&gt; /opt/etc/unblock.dnsmasq echo "server=/$line/127.0.0.1#9153" &gt;&gt; /opt/etc/unblock.dnsmasq done &lt; /opt/etc/unblock.txt</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We made a small change - now when generating the unblock.dnsmasq file, additional strings are added of the form "server = / domain_name / 127.0.0.1 # 9153". This means that rezolving of domains from the list will occur through dnscrypt-proxy. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run unblock_update.sh:</font></font><br><br><pre> <code class="bash hljs">unblock_update.sh</code> </pre> <br>  Is done.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All complex settings behind. </font><font style="vertical-align: inherit;">Now you will only edit the unblock.txt list if necessary, adding or removing domains or IP addresses to unlock from it, and using the unblock_update.sh command activate the changes made. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For example, they unblocked torrent trackers and calmly watch torrents directly on your favorite Android box: </font></font><br><br><img src="https://habrastorage.org/webt/_h/ma/pt/_hmaptkue09vo-1vvx3g0vgkgte.png"><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Additional information for those who want to block advertising domains on the router, in </font></font><a href="https://habr.com/post/428992/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comment. </font><font style="vertical-align: inherit;">For those who want to use dnscrypt as the main resolver for all domains, in </font></font><a href="https://habr.com/post/428992/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> comment.</font></font></i> </div><p>Source: <a href="https://habr.com/ru/post/428992/">https://habr.com/ru/post/428992/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../428982/index.html">How to write on D under ARM</a></li>
<li><a href="../428984/index.html">Julia and phase portraits of dynamic systems</a></li>
<li><a href="../428986/index.html">Conference ThinkJava # 8 in Kharkov</a></li>
<li><a href="../428988/index.html">Nature Tips - Cloudy Night Light</a></li>
<li><a href="../428990/index.html">Configuration examples for UIViewControllers using RouteComposer</a></li>
<li><a href="../428994/index.html">Networking on Android using Corutin and Retrofit</a></li>
<li><a href="../428996/index.html">Club of anonymous Santa Clauses 2018-2019 in Habrahabr</a></li>
<li><a href="../428998/index.html">How to use the new experimental Profiler feature in React</a></li>
<li><a href="../429000/index.html">Why did Bill Gates invent a $ 233 billion toilet</a></li>
<li><a href="../429004/index.html">Full disclosure: VirtualBox 0day Escape Vulnerability</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>