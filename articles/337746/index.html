<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Comparing taking from the cache of the same file using fs.readFileSync and fs.readFile (and reading multiple files)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After reading the article Episode 8: Interview with Ryan Dahl, Creator of Node.js and comments on the translation , I decided to test the effectivenes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Comparing taking from the cache of the same file using fs.readFileSync and fs.readFile (and reading multiple files)</h1><div class="post__text post__text-html js-mediator-article"><p>  After reading the article <a href="https://www.mappingthejourney.com/single-post/2017/08/31/Episode-8-Interview-with-Ryan-Dahl-Creator-of-Nodejs">Episode 8: Interview with Ryan Dahl, Creator of Node.js</a> and comments on the <a href="https://habrahabr.ru/post/337098/">translation</a> , I decided to test the effectiveness of blocking and non-blocking reading of the file in Node.js, under the cut of the table and graphics. </p><br><p>  UPD: Under the cut is a bad benchmark.  As correctly indicated in the comments, essentially taking the same file from the cache is compared using fs.readFileSync and fs.readFile. </p><br><p>  UPD2: The article has been edited, the benchmark has been corrected, the results have been added. </p><a name="habracut"></a><br><p>  The blocking operation (fs.readFileSync is one of these) assumes that the execution of the entire application will be suspended until non-JS-related direct operations are performed. </p><br><p>  Non-blocking operations allow you to perform non-JS operations asynchronously in parallel threads (for example, fs.readFile). </p><br><p>  More about blocking vs non-blocking <a href="https://nodejs.org/en/docs/guides/blocking-vs-non-blocking/">here</a> . </p><br><p>  Although Node.js runs in one thread, using child_process or cluster, you can distribute the execution of the code into several threads. </p><br><p>  <a href="https://github.com/shvabuk/read-file-benchmark">Tests</a> were conducted with parallel and sequential reading of the cached file (large and small), as well as reading of uncached files. </p><br><p>  All tests took place on the same computer, with one HDD, and immeno: </p><br><blockquote>  OS: Ubuntu 16.04 <br>  Node.js version: 8.4.0 <br>  Processor: AMD Phenom (tm) 9750 Quad-Core Processor <br>  Physical cores: 4 <br>  HDD: 2TB 7200rpm 64MB <br>  File system type: ext4 <br>  file.txt size: 3.3 kB <br>  bigFile.txt size: 6.5 MB </blockquote><p>  Results for cached file. </p><br><p>  When reading 3.3 kB file 10,000 times </p><br><table><thead><tr><th>  Symbol </th><th>  Name </th><th>  ops / sec </th><th>  Percents </th></tr></thead><tbody><tr><td>  A </td><td>  Loop readFileSync </td><td>  7.4 </td><td>  100% </td></tr><tr><td>  B </td><td>  Promise chain readFileSync </td><td>  4.47 </td><td>  60% </td></tr><tr><td>  C </td><td>  Promise chain readFile </td><td>  1.09 </td><td>  15% </td></tr><tr><td>  D </td><td>  Promise.all readFileSync </td><td>  4.58 </td><td>  62% </td></tr><tr><td>  E </td><td>  Promise.all readFile </td><td>  1.69 </td><td>  23% </td></tr><tr><td>  F </td><td>  Multithread loop readFileSync </td><td>  20.05 </td><td>  271% </td></tr><tr><td>  G </td><td>  Multithread promise.all readFile </td><td>  4.98 </td><td>  67% </td></tr></tbody></table><br><p>  When reading 3.3 kB file 100 times </p><br><table><thead><tr><th>  Symbol </th><th>  Name </th><th>  ops / sec </th><th>  Percents </th></tr></thead><tbody><tr><td>  A </td><td>  Loop readFileSync </td><td>  747 </td><td>  100% </td></tr><tr><td>  B </td><td>  Promise chain readFileSync </td><td>  641 </td><td>  86% </td></tr><tr><td>  C </td><td>  Promise chain readFile </td><td>  120 </td><td>  sixteen% </td></tr><tr><td>  D </td><td>  Promise.all readFileSync </td><td>  664 </td><td>  89% </td></tr><tr><td>  E </td><td>  Promise.all readFile </td><td>  238 </td><td>  32% </td></tr><tr><td>  F </td><td>  Multithread loop readFileSync </td><td>  1050 </td><td>  140% </td></tr><tr><td>  G </td><td>  Multithread promise.all readFile </td><td>  372 </td><td>  50% </td></tr></tbody></table><br><p>  When reading 6.5 MB file 100 times </p><br><table><thead><tr><th>  Symbol </th><th>  Name </th><th>  ops / sec </th><th>  Percents </th></tr></thead><tbody><tr><td>  A </td><td>  Loop readFileSync </td><td>  0.63 </td><td>  83% </td></tr><tr><td>  B </td><td>  Promise chain readFileSync </td><td>  0.66 </td><td>  87% </td></tr><tr><td>  C </td><td>  Promise chain readFile </td><td>  0.61 </td><td>  80% </td></tr><tr><td>  D </td><td>  Promise.all readFileSync </td><td>  0.66 </td><td>  87% </td></tr><tr><td>  E </td><td>  Promise.all readFile </td><td>  0.76 </td><td>  100% </td></tr><tr><td>  F </td><td>  Multithread loop readFileSync </td><td>  0.83 </td><td>  109% </td></tr><tr><td>  G </td><td>  Multithread promise.all readFile </td><td>  0.81 </td><td>  107% </td></tr></tbody></table><br><p>  CPU load when reading 3.3 kB file 10,000 times <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/2f7/df1/d1e/2f7df1d1e6b18e28e47a92afe942a033.png" alt="file.txt, reading 10,000 times"></a> </p><br><p>  CPU usage when reading 6.5 MB file 100 times <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/30d/352/b88/30d352b8891d4be6ae91e01e23d62719.png" alt="bigFile.txt, reading 100 times"></a> </p><br><p>  As you can see, fs.readFileSync is always executed in one thread on one core.  fs.readFile uses several threads in its work, but the kernels are not loaded at full capacity.  For a small file, fs.readFileSync is faster than fs.readFile, and only when reading a large file when a node is running in one stream, fs.readFile runs faster than fs.readFileSync. </p><br><p><del>  Therefore, reading small files is best done using fs.readFileSync, and large files using fs.readFile (how big the file should be depends on the computer and software). </del></p><br><p><del>  For some tasks, fs.readFileSync may be preferable for reading large files.  For example, with a long reading and processing of multiple files.  In this case, the load between the cores must be distributed using child_process.  Roughly speaking, run the node itself, and not operations in multiple threads. </del></p><br><p>  <strong>UPD2</strong> <br>  Below is the data obtained for reading a lot of un-cached files of the same size (3.3kB). </p><br><p>  When reading 1000 files </p><br><table><thead><tr><th>  Symbol </th><th>  Name </th><th>  ops / sec </th><th>  Percents </th></tr></thead><tbody><tr><td>  A </td><td>  Loop readFileSync </td><td>  8.47 </td><td>  74% </td></tr><tr><td>  B </td><td>  Promise chain readFileSync </td><td>  6.28 </td><td>  55% </td></tr><tr><td>  C </td><td>  Promise chain readFile </td><td>  5.49 </td><td>  48% </td></tr><tr><td>  D </td><td>  Promise.all readFileSync </td><td>  8.06 </td><td>  70% </td></tr><tr><td>  E </td><td>  Promise.all readFile </td><td>  11.05 </td><td>  100% </td></tr><tr><td>  F </td><td>  Multithread loop readFileSync </td><td>  3.71 </td><td>  32% </td></tr><tr><td>  G </td><td>  Multithread promise.all readFile </td><td>  5.11 </td><td>  44% </td></tr></tbody></table><br><p>  When reading 100 files </p><br><table><thead><tr><th>  Symbol </th><th>  Name </th><th>  ops / sec </th><th>  Percents </th></tr></thead><tbody><tr><td>  A </td><td>  Loop readFileSync </td><td>  79.19 </td><td>  85% </td></tr><tr><td>  B </td><td>  Promise chain readFileSync </td><td>  50.17 </td><td>  54% </td></tr><tr><td>  C </td><td>  Promise chain readFile </td><td>  48.46 </td><td>  52% </td></tr><tr><td>  D </td><td>  Promise.all readFileSync </td><td>  54.7 </td><td>  58% </td></tr><tr><td>  E </td><td>  Promise.all readFile </td><td>  92.87 </td><td>  100% </td></tr><tr><td>  F </td><td>  Multithread loop readFileSync </td><td>  80.46 </td><td>  86% </td></tr><tr><td>  G </td><td>  Multithread promise.all readFile </td><td>  92.19 </td><td>  99% </td></tr></tbody></table><br><p>  CPU usage when reading unzipped files is small, about 20%.  Results vary ¬± 30%. <br>  The results show that using non-blocking fs.readFile is more profitable. </p><br><p>  An example of a file reading situation. </p><br><p>  Suppose we have a web server on a node in a single T1 thread.  Two requests come at the server at the same time (P1 and P2) for reading and processing small files (one per request).  When using fs.readFileSync, the sequence of execution of the code in the T1 stream will look like this: </p><br><p>  P1 -&gt; P2 </p><br><p>  When using fs.readFile, the sequence of code execution in the T1 stream will look like this: </p><br><p>  P1-1 -&gt; P2-1 -&gt; P1-2 -&gt; P2-2 </p><br><p>  Where P1-1, P2-1 is a delegation of reading to another thread, P1-2, P2-2 is getting reading results and processing data. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/337746/">https://habr.com/ru/post/337746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337736/index.html">RPM repository - do it yourself</a></li>
<li><a href="../337738/index.html">Experience of learning programming for children from 8 years online</a></li>
<li><a href="../337740/index.html">DevFest North for the first time in Petersburg</a></li>
<li><a href="../337742/index.html">GDD Europe 2017 Report</a></li>
<li><a href="../337744/index.html">Cupertino Express - Moscow. New features iOS 11, discussion of Apple Special Event and competition from Avito</a></li>
<li><a href="../337748/index.html">7 reasons why SMBs do not need loyalty programs as presented on the market</a></li>
<li><a href="../337756/index.html">ABBYY Ideas Contest - how to win a new iPhone</a></li>
<li><a href="../337758/index.html">Rules and prohibitions of web design</a></li>
<li><a href="../337760/index.html">New Apache Struts web server vulnerability allows remote code execution</a></li>
<li><a href="../337764/index.html">Slowly, we are recording: 10 new applications of the QIWI Wallet API, which are proposed by Habr</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>