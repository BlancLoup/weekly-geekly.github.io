<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bidirectional transactional data replication</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=""MSSQL load distribution on 2 servers" 
 Good afternoon, habrazhiteli, so I decided to write about my history ‚ÄúDistribution of the load of MSSQL on 2 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bidirectional transactional data replication</h1><div class="post__text post__text-html js-mediator-article"><h4>  "MSSQL load distribution on 2 servers" </h4><br>  Good afternoon, habrazhiteli, so I decided to write about my history ‚ÄúDistribution of the load of MSSQL on 2 servers by the method of bidirectional transactional data replication‚Äù.  And not just 2 servers, but what would they work like mirrors.  Anyone interested, I invite you to read. <a name="habracut"></a><br>  <a href="https://habr.com/ru/post/170213/">Who wants to go straight to the point</a> <br>  And of course, data replication came to the rescue.  After reviewing the types of replication, let's consider the architecture that suits us best. <br>  In our case, we were chasing the load distribution between 2 servers.  Well, and walked through the logical chain of "load distribution - 2 server mirrors - minimum delays - transactional replication."  And since there <s>was little</s> experience at all, again I went to msdn.  And then I went into the article, started reading one, went through a couple of explanations of the terms, and was completely distracted.  In other ways, like me from the main topic ... <br>  First, I had the type of transactional replication as <a href="http://technet.microsoft.com/ru-ru/library/ms151196.aspx">"Peer-to-Peer Transactional Replication</a> ".  I do not know how many, but I often first look at the topology in the form of a diagram, and then I just get a grasp of it.  This time, again, I got caught by my own mistake. <br><img src="https://habrastorage.org/storage2/3ac/cfc/0a7/3accfc0a76829918e78ec7481fb46f2a.jpg" alt="image"><br>  I looked at this topology, well, I liked it, that on the left there is a ‚Äúread-write‚Äù to both servers, everything is beautiful, the load is distributed.  In case of a fall, for a while, one server will cope. <br>  Well, in joy, I began to customize, or rather get a grasp of the setting and try it on test bases.  At first, I visited <a href="http://msdn.microsoft.com/ru-ru/library/ms146914(v%3Dsql.100).aspx">this</a> page and I liked the phrase ‚Äú <i>When setting up the topology of active databases to add the first and second nodes (node ‚Äã‚ÄãA and node B), the following procedure is used.</i>  <i>The next procedure is then used to add node C and all subsequent nodes</i> . ‚Äù  In particular, these 2 phrases ‚Äúthe <i>next procedure</i> ‚Äù and ‚Äúthe <i>next procedure</i> ‚Äù and further in the text about the three-node peer-to-peer topology. <br>  And then, by luck, I decided to return to the page where I started and read about this topology and again I‚Äôve come across the key phrase ‚Äú <i>On the left, update operations are partitioned between two servers.</i>  <i>If the database contains a product catalog, you can, for example, create a custom application that directs updates of product names starting with letters from ‚ÄúA‚Äù to ‚ÄúM‚Äù to node A, and updates of products starting with letters from ‚ÄúH‚Äù to ‚ÄúI "- on node B. Then updates are replicated to another node</i> ."  So this is not what I wanted, and it means that when server ‚ÄúA‚Äù crashes, there will be only a part of the data. <br>  And again, in sadness and grief, a long surf through the expanses of links, although the decision was under the nose.  I stumble on the article " <a href="http://msdn.microsoft.com/ru-ru/library/ms151855(v%3Dsql.90).aspx">Bidirectional Transactional Replication</a> ."  And again, a smile on his face, and again his hands are torn into battle.  And when I read the <a href="http://msdn.microsoft.com/ru-ru/library/ms147929(v%3Dsql.105).aspx">setting of</a> this replication, a little smile subsides, and I understand that I do not understand anything in the setting of replication.  After several hours of reading, trial and error, the situation begins to clear up.  In the configuration of bidirectional replication, most of it is described in the configuration through the procedures, I will show my own configuration method according to which this topology works for me. <br><a name="Example1"></a><br>  Well, let's start.  <u>I advise you first do this on the test bases</u> .  Basically I will throw links, well, describe the " <i>pitfalls</i> " that may occur on the way <br><img src="https://habrastorage.org/storage2/667/6de/de4/6676dede47a85f39f446b43458956491.jpg" alt="image"><br><ul><li>  1. <a href="http://msdn.microsoft.com/ru-ru/library/ms151192(v%3Dsql.105).aspx">Configure distribution</a> .  Run on both servers (distributor (publisher) and subscriber).  In this part of the problems did not meet any special, distribution server and publisher, in my case, the same.  When installing a folder for snapshots, you must specify a local folder (specify a link to the shared folder that will be accessed by both servers).  Further, since the publisher and distributor are the same server, we leave it unchanged.  And the last is to enter the password between the distributor and the publisher (in our case, the password will not be used further). </li><li>  2. Next, add publications and articles (on both servers).  "Replication - Local Publications - Create Publication."  We select the database, the publication type ‚ÄúTransaction Publication‚Äù, and select the available objects, you can skip the agent configuration, fill the security of the agent. <br><div class="spoiler">  <b class="spoiler_title">Pebble</b> <div class="spoiler_text">  One of the conditions of the article is the Primary Key in the table. <br>  When creating a Primary key, I advise you to check that there is no clustered index on the key field, and if there is, then delete it.  When creating a key, this index will be created, and if you do not delete it, it will no longer be clustered and data processing will be increased due to the presence of 2 identical indexes. </div></div></li><li>  3. At the stage of creating subscriptions, I was confused at the beginning, but I will try to explain intelligibly. <br>  Let's start in succession: <br><ol><li>  On server A: <br><div class="spoiler">  <b class="spoiler_title">(1) Create a subscription procedure</b> <div class="spoiler_text"><pre><code class="sql hljs">EXEC sp_addsubscription @publication = '_ Base_repl_1', <span class="hljs-comment"><span class="hljs-comment">--        2. @article = N'all', @subscriber = 'B', --    @destination_db = N'Base_repl_2', --    B @sync_type = N'none', @status = N'active', @update_mode = N'read only', @loopback_detection = 'true'; --   .</span></span></code> </pre> </div></div><div class="spoiler">  <b class="spoiler_title">(2) Enable Agent</b> <div class="spoiler_text"><pre> <code class="sql hljs">EXEC sp_addpushsubscription_agent @publication = '_ Base_repl_1', <span class="hljs-comment"><span class="hljs-comment">--         2. @subscriber = 'B', --   A @subscriber_db = N'Base_repl_2', --     @job_login = 'domain\user', --  @job_password = 'pass'; -- </span></span></code> </pre></div></div></li><li>  On server B: <br><div class="spoiler">  <b class="spoiler_title">(1) Create a subscription procedure</b> <div class="spoiler_text"><pre> <code class="sql hljs">EXEC sp_addsubscription @publication = 'B_ Base_repl_2', <span class="hljs-comment"><span class="hljs-comment">--        2. @article = N'all', @subscriber = 'A', --    @destination_db = N'Base_repl_1', --    B @sync_type = N'none', @status = N'active', @update_mode = N'read only', @loopback_detection = 'true'; --   .</span></span></code> </pre> </div></div><div class="spoiler">  <b class="spoiler_title">(2) Enable Agent</b> <div class="spoiler_text"><pre> <code class="sql hljs">EXEC sp_addpushsubscription_agent @publication = 'B_ Base_repl_2', <span class="hljs-comment"><span class="hljs-comment">--         2. @subscriber = 'A', --   A @subscriber_db = N'Base_repl_1', --     @job_login = 'domain\user', --  @job_password = 'pass'; -- </span></span></code> </pre></div></div></li></ol><br></li><li>  4. To create stored procedures used for articles, you can use the <a href="http://msdn.microsoft.com/ru-ru/library/ms147880(v%3Dsql.100).aspx">article</a> .  I consider it not in demand, since for each table it is very expensive to create manually 3 procedures (ins, upd, del).  Therefore, I used the following procedure <a href="http://msdn.microsoft.com/ru-ru/library/ms187946.aspx">sp_scriptpublicationcustomprocs</a> <br>  On server A: <br><pre> <code class="sql hljs">sp_scriptpublicationcustomprocs @publication ='_ Base_repl_1' <span class="hljs-comment"><span class="hljs-comment">--     </span></span></code> </pre><br>  then copy the result of the procedure and execute it on the server ‚ÄúB‚Äù in the Base_repl_2 database <br>  On server B: <br><pre> <code class="sql hljs">sp_scriptpublicationcustomprocs @publication ='B_ Base_repl_2' <span class="hljs-comment"><span class="hljs-comment">--     </span></span></code> </pre><br>  then copy the result of the procedure and execute it on the server ‚ÄúA‚Äù in the Base_repl_1 database </li></ul><br>  Well, almost everything.  I will welcome any advice and criticism. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/170213/">https://habr.com/ru/post/170213/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../170197/index.html">Video recording of the meteorite is blocked for copyright infringement</a></li>
<li><a href="../170201/index.html">12 business lessons from Amazon founder and CEO Jeff Bezos. Part 1</a></li>
<li><a href="../170205/index.html">Fight TimeMachine's reluctance to recover data from a NAS device</a></li>
<li><a href="../170207/index.html">Database Modeling Assistant: Well Forgotten Old</a></li>
<li><a href="../170209/index.html">Nuclear battery</a></li>
<li><a href="../170215/index.html">Where did xUnit go</a></li>
<li><a href="../170217/index.html">Best Android Mobile Development Apps</a></li>
<li><a href="../170221/index.html">Safety control systems practices and examples</a></li>
<li><a href="../170227/index.html">Win32 / DoS.OutFlare.A aims to circumvent the anti-DDOS service CloudFlare</a></li>
<li><a href="../170229/index.html">Website development for mobile devices</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>