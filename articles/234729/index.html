<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Protecting the site from scanning and chaotic intensive requests</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chaotic intensive requests heavily load servers and transport channels, significantly slowing down the site. Using a scan, cybercriminals copy the con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Protecting the site from scanning and chaotic intensive requests</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/010/f79/19b/010f7919b95346da8ebf21add09847e1.png" alt="image"></div><br><br>  Chaotic intensive requests heavily load servers and transport channels, significantly slowing down the site.  Using a scan, cybercriminals copy the contents of the sites and identify weaknesses in their protection, causing significant damage.  In addition, requests to the site, made during the scanning process, also adversely affect performance.  Most often, the problem of slow work sites for large portals with high traffic.  But it can also affect small sites, since even with low traffic the site can be subject to high loads.  High load is created by various robots, constantly scanning sites.  At the same time, the work of the site may be slowed down, or it may not be available at all. <br><br>  <b>Scanning the site is</b> done by programs, third-party sites or manually.  This creates a large number of requests in a short period of time.  Site scans are most often used to search for vulnerabilities in it or to copy website content. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A sufficiently effective measure to protect the site from scanning will be the separation of access rights to the resources of the site.  The information about the site structure will help to hide the apache <b>mod_rewrite</b> module that modifies the links.  And making link scanning ineffective and, at the same time, setting the time delay between frequent requests from one user will help reduce the load.  To maintain effective protection against scanning and chaotic intensive requests, a regular audit of web resources is necessary. <br><br>  <b>Chaotic intensive requests</b> are random or malicious numerous requests in a short period of time on the site pages by users or robots.  For example, random intensive requests include frequent page refresh.  Malicious numerous requests include spam on the site‚Äôs pages from users or DoS attacks.  Chaotic intensive requests also include a brute force selection method.  You can choose a password either manually or with the help of special programs.  A manual password is selected only in cases where its possible options are known.  In other cases, special programs are used that automatically select a login and password pair, i.e.  programs for bruteforce. <br><br>  Effective methods to protect a site from <b>chaotic intense requests</b> include: setting a time delay between requests for a certain period of time, creating black and white lists, setting the search engines for a time delay between requests for website pages in a <b>robots.txt</b> file, and setting the period for updating pages in a <b>sitemap .xml</b> . <br><br>  I implemented one of the methods to protect the site from <b>scanning</b> and <b>chaotic intensive requests</b> , which consists in counting the number of requests in a certain period of time and setting the time delay when the threshold is exceeded.  In particular, this method makes an inefficient or even useless way to crack a password by iterating, because the time spent on the search will be too long.  <b>Ready php script under the hood.</b> <br><a name="habracut"></a><br><h4>  1. Data on implemented php-script </h4><br>  At present, in practice, various approaches are used to protect any computer information, including information available on the Internet resource.  These approaches can be defined by the following characteristics: <br>  - the presence of formalized requirements, both for the recruitment and for the parameters of all protection mechanisms, which are regulated by the majority of modern requirements for ensuring general computer security (in other words, by the requirements defining what exactly should be provided by developers); <br>  - the presence of real protection mechanisms that are implemented in the process of protecting any computer information.  These protection mechanisms are primarily related to protection tools built into the operating system, for the simple reason that most of the scripts used on the web server use the protection mechanisms built into the operating system or inherit the methods used in them.  It is on the basis of these mechanisms and the methods used in them that the overall level of protection of the entire web server is determined; <br>  - existing statistics of various threats to the security of computer information.  In particular, this is data about successful attacks already carried out on any information resources.  Maintaining this statistic is intended to help determine how effective the measures taken are, as well as to assess the level of requirements for creating protection on a web server. <br><br>  As already mentioned, the most effective method for countering site scans, as well as all kinds of chaotic intensive requests, is to set some time delay between requests originating from the same user.  When identifying a user, the main focus should be on his IP address, for the reason that cookies can be easily deleted.  Of course, the user's IP address can also be changed, for example, using a proxy server or using reconnection, if the user's IP address is dynamic, although this operation can take quite a long time, which in its the queue will negate all the efforts of the attacker. <br><br>  This site protection method should be implemented by writing a php script.  Using this kind of script will help protect the contents of the site from scanning conducted with the help of crawler programs and, at the same time, will help significantly slow down the scanning of the site "manually".  In addition, the use of such a script will provide excellent security for absolutely all pages of the site from various types of chaotic intensive requests, which in turn will make it possible to reduce the load on the web server equipment. <br><br>  The script that is developed must have the ability to customize.  In particular, it is necessary to foresee the possibility of changing part of the script parameters.  In other words, the script should be: <br>  - the ability to configure the time blocking the user's IP address; <br>  - it is possible to set the time interval during which the user's activity will be checked, in other words, the time during which the number of requests from one specific user will be recorded; <br>  - having the ability to set the number of requests that one user can send to the pages of the site during a specified time interval; <br>  - the possibility of creating a list of "always resolved IP-addresses."  The IP addresses listed in this list will never be blocked; <br>  - the possibility of creating a list of "always denied IP addresses", i.e.  the script will always block IP addresses that are listed. <br><br>  The advantages of creating and using such a php-script can be considered: <br>  - a significant reduction in the number of requests sent to the database server; <br>  - significant savings in incoming and outgoing traffic on the web server; <br>  - availability of convenient and flexible configuration of the most important parameters of the script; <br>  - the possibility of a significant reduction in the load on the web server by users; <br>  - copying all the information posted on the site will be very difficult or even impossible if there are a lot of pages on this resource. <br><br>  The logic of the work of the developed site security system, created in the form of a php-script, is shown in the figure: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f10/0f0/d9a/f100f0d9a3474bdf8a22f20fe4b023bb.jpg" alt="image"></div><br><br>  In the process of developing a script, an important point is the choice of how to store the information received.  In our case, these are the IP addresses of current users.  This information can be stored either in a database or on a hard disk.  In order to speed up the work of the developed script, as well as to make it more stable, we will use caching directories to store the IP addresses of current users. <br><br>  In one of these directories, the script will store the IP addresses of active, currently users, this directory will be called active.  And in another directory we will add files whose name will include the IP addresses of temporarily blocked users (the block directory). <br><br>  In addition to the IP-address, in the process of the script, you also need information about the user's activity.  To do this, we will also include the exact system time in the name of the file containing the IP address of the user, when he showed the ‚Äúfirst‚Äù, at a specified time interval, activity, i.e.  the first time in a certain (predetermined) period of time sent a request to the page of the site.  If the user exceeded the predetermined number of sent requests to the site pages in the specified time interval, the script will delete the file containing its IP address from the active users directory.  After that, it will write a new file (the name of which will contain the IP address of the newly blocked user) in the directory containing the blocked IP addresses.  Thus, in the caching directories (active and block), files with the following names will be temporarily stored: 127.0.0.1_1302615293, 195.80.91.151_1302615389, 95.30.17.60_1302615457, 77.39.54.104_ 1302615504 and the like. <br><br>  The file name, before the bottom slash, will contain the IP address of the active user, and after the bottom slash, the exact system time will be entered in the file name, in which he was active (ie, sent a request to the resource pages or was blocked). <br><br>  Separately, it should be noted that for caching directories, i.e.  the active and block folders, it is necessary to set the permissions of the owner of the file or 777. In other words, the attributes of these folders specified on the server should give the script the right to write, read, and execute.  Permissions 777 must be set for all user groups. <br><br>  In addition, a separate exception should be provided in case the site administrator does not do this.  Indeed, in such a situation, the work of the script will be impossible, which means that protecting the site from scanning and chaotic intensive requests will, at a minimum, be untenable.  In other words, in the process of the script operation, the presence or absence of the possibility of reading and writing to any of the caching directories must be checked. <br><br>  We will take information about current users (in particular, about their IP addresses) from the $ _SERVER [] superglobal array.  This array is created by the web server.  It contains the values ‚Äã‚Äãof various environment variables.  To work with users' IP addresses, we need to use the following environment variables contained in the $ _SERVER [] superglobal array: <br>  - $ _SERVER ['HTTP_X_FORWARDED_FOR']; <br>  - $ _SERVER ['HTTP_CLIENT_IP']; <br>  - $ _SERVER ['HTTP_X_CLUSTER_CLIENT_IP']; <br>  - $ _SERVER ['HTTP_PROXY_USER']; <br>  - $ _SERVER ['REMOTE_ADDR']. <br><br>  The $ _SERVER ['HTTP_X_FORWARDED_FOR'] environment variable allows us to determine the client‚Äôs IP address if it uses a proxy server.  The $ _SERVER ['HTTP_CLIENT_IP'] environment variable allows you to get the client's IP address, if it does not use a proxy server, to work on the Internet.  The $ _SERVER ['HTTP_X_CLUSTER_CLIENT_IP'] environment variable allows you to get the client's IP address if the site does not use the SSL cryptographic protocol that provides a secure connection between the server and the client.  The $ _SERVER ['HTTP_PROXY_USER'] environment variable allows you to determine the IP address of the client that the proxy server uses. <br><br>  The $ _SERVER ['REMOTE_ADDR'] environment variable allows you to get the remote user's IP address.  During testing on a local machine, this IP address will be 127.0.0.1.  At the same time, on the network, this variable will return either the IP address of the client or the IP address of the last user-used proxy server (with which this client got to the web server).  Thus, using simultaneously many different environment variables from the $ _SERVER [] array (all the variables used are listed above), we will be able to determine the real IP address of the user, even if he tries to ‚Äúmask‚Äù him with or proxy server. <br><br>  For the stable operation of the script on any of the pages of the site, regardless of its nesting level, we will use the ability to bring to absolute form the paths to the caching directories (active and block).  Using this approach will allow us to run the script from any page of the site and at the same time do not fear that the relative paths to the caching directories on any of the pages initially specified in the script will be incorrect. <br><br>  As already mentioned, the script being developed must have the ability to customize.  In particular, it is necessary to foresee the possibility of changing part of the script parameters (the blocking time of the user's IP address, the time interval for which the number of requests sent to resource pages, and the number of allowed requests in a given time interval) will be taken into account.  These parameters will initially be set in the script using constants. <br><br>  In particular, such parameters in the script will include the following parameters: <br>  - the time to block the user's IP address is specified in seconds (const blockSeconds); <br>  - the time interval in which requests from one user to the site pages will be taken into account.  This interval will also be specified in seconds (const intervalSeconds); <br>  - the number of requests to the pages of the website that can be sent by one user for a specified time interval (const intervalTimes). <br>  Separately, in the script, you should define such arrays containing string data: <br>  - an array of values ‚Äã‚Äãof those IP addresses that are included in the "list of always allowed IP addresses" (public static $ alwaysActive = array ('') array declaration); <br>  - an array of values ‚Äã‚Äãof those IP addresses that are included in the "list of always denied IP addresses" (public static $ alwaysBlock = array ('') array declaration). <br>  For the script to work properly, as well as to debug it, it is necessary to provide for the presence of several flags in the script.  Note that the use of such flags will also help in the process of protecting the content of the site from scanning and various chaotic intensive requests.  These flags include: <br>  - flag of the ability to connect always active users (const isAlwaysActive); <br>  - flag to connect always blocked users (const isAlwaysBlock). <br>  The developed script contains one class TBlockIp.  This class includes the following methods: <br>  - checkIp ().  This method implements the ability to check the user's IP address for its blocking or for activity.  At the same time, IP addresses listed in the ‚Äúalways allowed IP addresses‚Äù list are skipped, and IP addresses listed in the ‚Äúalways denied IP addresses‚Äù list are blocked on the contrary.  If the user's IP-address is not found in the array of possible IP-addresses - the script will create the identifier of the new active IP-address; <br>  - _getIp ().  This method allows you to get the current IP-address of the user, selected from all possible IP-addresses (filtering is done before identifying the desired client IP-address).  The method returns the received IP address. <br><br>  Ultimately, the developed script can be considered as an effective tool that will help counter the process of scanning a site, and will also be a preventive measure for all kinds of chaotic intensive requests.  In the developed script there is a setting of some time delay between requests originating from the same user.  When identifying a user, the main focus is on his IP address.  The reason for this is simple - the fact is that cookies can be easily deleted from the attacker's computer, which means that you cannot build resource protection using them. <br><br>  Of course, the user's IP address can also be changed, for example, using a proxy server.  In order to exclude such an opportunity for an attacker, the script uses environment variables, which in turn help to identify the real IP address of the user.  It is this IP-address, if the user exceeds the established limit of requests to the pages of the site within a certain period of time, will be blocked.  The developed script performs all the functions assigned to it, related to protecting the site from scanning, as well as from chaotic intensive requests. <br><br><h4>  2 Program listing </h4><br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** *     ip-. */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TBlockIp</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *    . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> blockSeconds = <span class="hljs-number"><span class="hljs-number">60</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *    . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> intervalSeconds = <span class="hljs-number"><span class="hljs-number">15</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *      . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> intervalTimes = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *     . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isAlwaysActive = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *     . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isAlwaysBlock = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *      . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pathActive = <span class="hljs-string"><span class="hljs-string">'active'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *      . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pathBlock = <span class="hljs-string"><span class="hljs-string">'block'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *     . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pathIsAbsolute = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *    . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $alwaysActive = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'172.16.1.1'</span></span>, ); <span class="hljs-comment"><span class="hljs-comment">/** *    . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $alwaysBlock = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'172.16.1.1'</span></span>, ); <span class="hljs-comment"><span class="hljs-comment">/** *   ip-    . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkIp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  ip- $ip_address = self::_getIp(); //     if (in_array($ip_address, self::$alwaysActive) &amp;&amp; self::isAlwaysActive) { return; } //     if (in_array($ip_address, self::$alwaysBlock) &amp;&amp; self::isAlwaysBlock) { echo '&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;'; echo '&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;'; echo '&lt;head&gt;'; echo '&lt;title&gt; &lt;/title&gt;'; echo '&lt;meta http-equiv="content-type" content="text/html; charset=utf-8" /&gt;'; echo '&lt;/head&gt;'; echo '&lt;body&gt;'; echo '&lt;p style="background:#ccc;border:solid 1px #aaa;margin:30px au-to;padding:20px;text-align:center;width:700px"&gt;'; echo '   .&lt;br /&gt;'; echo '&lt;/p&gt;'; echo '&lt;/body&gt;'; echo '&lt;/html&gt;'; exit; } //     $path_active = self::pathActive; $path_block = self::pathBlock; //        if (!self::pathIsAbsolute) { $path_active = str_replace('\\' , '/', dirname(__FILE__) . '/' . $path_active . '/'); $path_block = str_replace('\\' , '/', dirname(__FILE__) . '/' . $path_block . '/'); } //      if (!is_writable($path_active)) { die('         .'); } if (!is_writable($path_block)) { die('         .'); } //   ip- $is_active = false; if ($dir = opendir($path_active)) { while (false !== ($filename = readdir($dir))) { //  ip +    ip if (preg_match('#^(\d{1,3}.\d{1,3}.\d{1,3}.\d{1,3})_(\d+)$#', $filename, $matches)) { if ($matches[2] &gt;= time() - self::intervalSeconds) { if ($matches[1] == $ip_address) { $times = intval(trim(file_get_contents($path_active . $filename))); if ($times &gt;= self::intervalTimes - 1) { touch($path_block . $filename); unlink($path_active . $filename); } else { file_put_contents($path_active . $filename, $times + 1); } $is_active = true; } } else { unlink($path_active . $filename); } } } closedir($dir); } //   ip- $is_block = false; if ($dir = opendir($path_block)) { while (false !== ($filename = readdir($dir))) { //  ip +    ip if (preg_match('#^(\d{1,3}.\d{1,3}.\d{1,3}.\d{1,3})_(\d+)$#', $filename, $matches)) { if ($matches[2] &gt;= time() - self::blockSeconds) { if ($matches[1] == $ip_address) { $is_block = true; $time_block = $matches[2] - (time() - self::blockSeconds) + 1; } } else { unlink($path_block . $filename); } } } closedir($dir); } // ip-  if ($is_block) { header('HTTP/1.0 502 Bad Gateway'); echo '&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;'; echo '&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;'; echo '&lt;head&gt;'; echo '&lt;title&gt;502 Bad Gateway&lt;/title&gt;'; echo '&lt;meta http-equiv="content-type" content="text/html; charset=utf-8" /&gt;'; echo '&lt;/head&gt;'; echo '&lt;body&gt;'; echo '&lt;h1 style="text-align:center"&gt;502 Bad Gateway&lt;/h1&gt;'; echo '&lt;p style="background:#ccc;border:solid 1px #aaa;margin:30px au-to;padding:20px;text-align:center;width:700px"&gt;'; echo ' ,   , -    .&lt;br /&gt;'; echo '  .  ' . $time_block . ' ()    .'; echo '&lt;/p&gt;'; echo '&lt;/body&gt;'; echo '&lt;/html&gt;'; exit; } //    ip- if (!$is_active) { touch($path_active . $ip_address . '_' . time()); } } /** *    ip-   . */ private static function _getIp() { // ip-   $ip_address = '127.0.0.1'; //   ip- $addrs = array(); //    ip- if (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) { //   ip-   - foreach (array_reverse(explode(',', $_SERVER['HTTP_X_FORWARDED_FOR'])) as $value) { $value = trim($value); //  ip- if (preg_match('#^\d{1,3}.\d{1,3}.\d{1,3}.\d{1,3}$#', $value)) { $addrs[] = $value; } } } //  ip- if (isset($_SERVER['HTTP_CLIENT_IP'])) { $addrs[] = $_SERVER['HTTP_CLIENT_IP']; } //  ip- if (isset($_SERVER['HTTP_X_CLUSTER_CLIENT_IP'])) { $addrs[] = $_SERVER['HTTP_X_CLUSTER_CLIENT_IP']; } //  ip- if (isset($_SERVER['HTTP_PROXY_USER'])) { $addrs[] = $_SERVER['HTTP_PROXY_USER']; } //  ip- if (isset($_SERVER['REMOTE_ADDR'])) { $addrs[] = $_SERVER['REMOTE_ADDR']; } //   ip-,    foreach ($addrs as $value) { //  ip- if (preg_match('#^(\d{1,3}).(\d{1,3}).(\d{1,3}).(\d{1,3})$#', $value, $matches)) { $value = $matches[1] . '.' . $matches[2] . '.' . $matches[3] . '.' . $matches[4]; if ('...' != $value) { $ip_address = $value; break; } } } //   ip- return $ip_address; } } //   ip- TBlockIp::checkIp();</span></span></code> </pre> <br><br>  This script can be embedded directly into the index page, or separately in the php file, including its call at the very beginning of the index file. <br><br>  An example implementation in the site index file.  At the very top of the index file we write (you can after setting the encoding parameters so that the page encoding is correctly displayed): <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">'/block/index.php'</span></span>;</code> </pre><br><br>  In this case, you need to create the folder ‚Äúblock‚Äù in the root, there are also the folders ‚Äúactive‚Äù and ‚Äúblock‚Äù and the file ‚Äúindex.php‚Äù (here we copy the above code). <br><br><h4>  3 Testing php-script embedded in the site </h4><br>  Viewing and subsequent testing of written code is one of the most important stages in the development of php scripts.  This stage is often missed by developers programming for the Web.  The fact is that it is very easy to run a written script two or three times and note that it works fine.  At the same time, this is a common mistake.  After all, the created script must be thoroughly analyzed or tested. <br><br>  The main difference between the developed php scripts and application programs is that an extremely wide circle of people will work with Web applications.  In this situation, you should not rely on users to understand the use of various Web applications.  Users can not provide a huge guide or a quick reference.  That is why the developed Web-applications must be not only self-documenting, but also self-evident.  When implementing a developed php-script, it is necessary to take into account various ways of using it, as well as to test its behavior in various situations. <br><br>  It is often difficult for an experienced user or programmer to understand the problems that arise for inexperienced users.  One way to solve the problem is to find testers who will represent the actions of typical users.  In the past, the following approach was used: first, a beta version of the developed Web application was released to the market.  After most of the errors were supposedly corrected, this application was published for a small number of users, who, accordingly, would create a small amount of incoming traffic.  After conducting this kind of test, developers get a lot of different combinations of data and use cases of the developed system, which its developers didn‚Äôt even guess [13, p. 394]. <br><br>  The created php script should do exactly what, in fact, it was created for.  With regard to the php script developed and created in this work, you can say this: if the user can send for a certain period of time (15 seconds by default) more than the specified number of requests (3 requests by default) to the site pages and the script will not block its IP the address means an error has crept into the work of the written Web application.  In general, testing is an activity that is aimed at identifying such inconsistencies that exist between the expected behavior of a written php script and its actual behavior.  By identifying inconsistencies in the behavior of the script, as well as its incorrect behavior during development, the developer has the opportunity to significantly reduce the likelihood that the user will encounter this kind of behavior of the script.  Testing the program (in our case, written php-script) can be either manually or with the help of specialized online services. <br><br><h5>  3.1 Manual Testing </h5><br>  When testing a written php script manually, we need to check whether the script performs the tasks assigned to it.  In particular, does the number of requests to the pages of the site originating from the same user limit if their frequency exceeds the allowable limit in a certain period of time.  To test the performance of the script, we first need to embed it in the site code.  To do this, you can use the following language construct: <br>  include "block / index.php"; <br><br>  When enabled, the script should be located in the block folder.  It should be noted that if the content management system of the site uses the creation of a so-called Friendly URL for the pages, i.e.  web addresses that are convenient for human perception (in this case means creating some multi-level structures, for example, / news / sport / 2003/10 /), or loading pages with an address different from the root of the folder (for example, / news /sport.php), it will be necessary to correctly specify the address to the script.  In such a situation, the absolute path to the script may well be indicated. <br><br>  In itself, testing the written php-script will be to send requests to the pages of the site.  In the process of testing, we need to check: does the created script skip the specified maximum number of requests (3 requests by default) for a certain period of time (15 seconds by default).  First of all, we need to check how the script copes with its main function, i.e.  direct blocking of intensive requests to the site pages originating from the same user.  Checking the number of requests that can be sent to the pages of the site showed that during the allotted fifteen seconds to send more than three requests to the pages of the site.  In particular, if a user sends more than three requests, then he receives a temporary blocking message shown in the figure: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d49/9d6/84e/d499d684e731432b97fa9ed139c35f38.png" alt="image"></div><br><br>  Thus, testing has shown that the script works exactly as expected: it blocks the user for a certain time (by default - for one minute) if, during a certain time interval, the number of requests from one user exceeds the specified rate (by default - 3 requests ).  The next stage of testing will be the verification of the performance of individual functions written php-script.  In particular, you need to check how the script will work if the IP address of the testing user is added to the list of "always allowed IP addresses".  You also need to check how the script will behave if the IP address of the testing user is added to the list of ‚Äúalways denied IP addresses‚Äù. <br><br>  After adding the IP address of the testing user to the ‚Äúalways allowed IP addresses‚Äù list, the limit on the number of requests sent to the site‚Äôs pages was removed, and it was possible to follow links (or refresh the page) an unlimited number of times.  In other words, the function that the "always allowed IP addresses" list should perform correctly works.  After adding the IP address of the testing user to the list of ‚Äúalways denied IP addresses‚Äù, it was not possible to send at least one request to the website page.  Instead of the contents of the web resource, a blocking message appears in the browser, shown in the figure: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/010/f79/19b/010f7919b95346da8ebf21add09847e1.png" alt="image"></div><br><br>  In other words, the function that the "always denied IP addresses" list should perform works correctly.  This function completely blocks the user whose IP address is included in the list of "always denied IP addresses."  Thus, the access control functions that are implemented with the presence of a list of ‚Äúalways allowed IP addresses‚Äù, as well as the presence of a list of ‚Äúalways denied IP addresses‚Äù work correctly and the script behaves exactly as originally intended.  In other words, the script provides unrestricted access to the pages of the site for those users whose IP addresses are listed in the "always allowed IP addresses" list and completely denies access to those users whose IP addresses are found in the "always denied IP addresses" list.  Testing a written php script manually showed that all functions of the script, and therefore the script itself, work correctly, i.e.  exactly as originally conceived. <br><br><h5>  3.2 Testing with online services </h5><br>  Testing a written php-script with the help of online services will provide an opportunity to find out the exact amount of traffic needed to load the pages of the site, as well as help to establish the exact "throughput" of the written php-script for requests that will be sent by various automatic services or programs.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The last parameter is very important, because one of the tasks of the script is to protect the site from scanning with the help of crawler programs. This kind of testing will not only help to conclude about the required amount of traffic and CPU time, but also about whether the information presented on the site is available for software tools that request pages automatically. To begin, let us estimate the average loading time of the site pages, at different connection speeds. We also estimate the size of the pages uploaded by the user. To conduct this type of testing, we will use the online service located at </font></font><a href="http://analyze.websiteoptimization.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">analyze.websiteoptimization.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The sizes of the loaded pages, determined by the service, are shown in the picture:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ff0/165/029/ff01650295be4f71ab79d7a9fe4c7a53.png" alt="image"></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Given that the site we are testing consists of only one page, which is 1511 bytes in size, it will load in 0.51 seconds (at a connection speed of 56 K) or in 0.21 seconds (at a connection speed of a user of 1.44 Mbps) . The speed of loading pages at different user connection speeds is shown in the picture:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/346/294/e4d/346294e4df10417180ab8962876f677e.png" alt="image"></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As can be seen from the information shown in the figure, even at the lowest connection speed (14.4 K), the site page loads fairly quickly - in 1.4 seconds. At the same time, if the user‚Äôs connection speed is quite high (in particular, 1.44 Mbps), then the page will be loaded literally instantly (in 0.21 seconds). Note that the low download speed at this resource is adjusted by the packet loss rate (this factor is 0.7). Also taken into account is the delay time equal to 0.2 seconds on average per page load. It is these parameters that explain why a significant increase in connection speed does not lead to an equally significant reduction in page load time. Note that this service, in addition to evaluating the basic parameters of loading pages of the site, also provides general results of site analysis and, of course,recommendations aimed at improving all parameters of loading pages on the site. The results of the analysis and recommendations of the service are shown in the figure:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/4b5/f07/275/4b5f0727549c4e47bcd6caf1c40696e3.png" alt="image"></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As can be seen from the figure, all indicators of the tested site for all analyzed parameters are within the normal range. In particular, the service states that the number of pages on the site, the objects on them, as well as the sizes of these pages and objects are within acceptable limits. Based on the obtained data, optimization of the tested site is not required, because the site complies with the standards for all analyzed parameters. In other words, the amount of information downloaded from the site (or pages of the site) is rather small and allows saving resources of both the web server and the user.</font></font> Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the developed script does not load the site and, in fact, its presence is not noticeable. What underlines the testing. Checking the speed of loading pages of the site, as well as their availability for other scripts can be performed using such an online service as </font></font><a href="http://www.pr-cy.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.pr-cy.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The result of the test done using this online service is shown in the figure:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/dcd/ab4/183/dcdab418325e47f1aeeedfb1c2a946bd.png" alt="image"></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As can be seen, from the data obtained at an average download speed of 30.31 Kb / sec, the page loading time is 0.05 seconds. </font><font style="vertical-align: inherit;">At the same time, with an average speed of 37.89 Kb / sec, the page loading time is already 0.04 seconds. </font><font style="vertical-align: inherit;">At the same time, testing showed that the script developed in this work blocks more than three requests to site pages originating from a single IP address and thus reduces the overload and makes it very difficult to try or even make it impossible to find a password to the site.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 3.3 Test results php-script embedded in the site </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The tests showed that the developed php-script perfectly copes with the functions initially assigned to it to protect the site from scanning, as well as from chaotic intensive requests and brute-force attempts from one user. In particular, testing the site manually showed that the script blocks requests to pages of the site that originate from the same IP address, if the number of these requests during a specified time interval exceeds the pre-allocated limit. In addition, this testing showed that all the functions of the script work fine, in particular, the functions for working with lists of "always allowed IP addresses" and "always denied IP addresses". In other words, the developed script provides unlimited access to all pages of the site for those usersThe IP addresses of which are included in the list of "always allowed IP addresses" and completely prohibits access to those users whose IP addresses are found in the list of "always denied IP addresses".</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testing of the site, in which the developed php-script was implemented, showed that all indicators of the tested site for all analyzed parameters are within the normal range. In particular, the service states that the number of pages on the site, the objects on them, as well as the sizes of these pages and objects are within acceptable limits. Based on the obtained data, optimization of the tested site is not required, because the site complies with the standards for all analyzed parameters. In other words, the amount of information downloaded from the site (or pages of the site) is rather small and allows saving resources of both the web server and the user. Previously, the script was used on the sites to learn </font></font><a href="http://www.engwords.net/ru"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">English</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="http://www.engwords.net/ru"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">English words.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but later more serious protection measures were taken. However, at first, this script significantly reduced the load on inexpensive hosting and allowed to turn sites with an attendance of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5000+</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hosts per day.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In addition, testing the site showed that the download speed of the pages of the test site is quite high. Also, the script blocked the testing of the site when the number of requests sent from the IP address of this online service exceeded the limit in the developed script (the maximum number of requests from one IP address set in the script is three requests in 15 seconds).</font></font><br><br>  ,           ,    .  ,   ,    IP- ( ,  IP-      ¬´  IP-¬ª     ¬´  IP-¬ª),       ,  IP-        ,     ,        - (   IP- ). </div><p>Source: <a href="https://habr.com/ru/post/234729/">https://habr.com/ru/post/234729/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../234717/index.html">New Life Telebreeze Player</a></li>
<li><a href="../234719/index.html">Metasploit Secrets</a></li>
<li><a href="../234721/index.html">Database Development Solutions</a></li>
<li><a href="../234723/index.html">Data mining. Optimization of orders for goods in the pharmacy (pharmacy)</a></li>
<li><a href="../234727/index.html">We work with notifications in Windows Phone 8.1</a></li>
<li><a href="../234731/index.html">Algorithm for adopting someone else's project or what to do when managers have a honeymoon</a></li>
<li><a href="../234735/index.html">Changing the structure of sections on Habrahabr</a></li>
<li><a href="../234737/index.html">Flask Mega-Tutorial, Part 11: Email Support</a></li>
<li><a href="../234739/index.html">InFocus M512 - a budget device for Snapdragon 400 and with support for 4G networks</a></li>
<li><a href="../234741/index.html">Speed: terminal acceleration for stock trading with undocumented features</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>