<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we did the service on WebRTC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are already a lot of articles about WebRTC both on the Internet and on Habr√© ( here and here ), repeating them once again doesn‚Äôt make much sens...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we did the service on WebRTC</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/75f/6f6/1d7/75f6f61d7df96705846e41d9217c4ef4.png"><br><br>  There are already a lot of articles about WebRTC both on the Internet and on Habr√© ( <a href="http://habrahabr.ru/post/198632/">here</a> and <a href="http://habrahabr.ru/post/187270/">here</a> ), repeating them once again doesn‚Äôt make much sense, so here we <a href="http://live.pics.io/">‚Äôll</a> give you our personal experience and impressions from the development of <a href="http://live.pics.io/">live.pics.io.</a> <br><br><h4>  Idea </h4><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/uC6eIvrwjPw%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700253&amp;usg=ALkJrhi9HAEhZrj03zE5xXcORTODKHePXw" frameborder="0" allowfullscreen=""></iframe><br>  Live.pics.io allows you to create private sessions for sharing and discussing images by voice.  It can be any image: from photos to design layouts and presentations.  While developing pics.io, we have learned quite well how to work with different raw formats in the browser, so you can not bother with conversion and throw photos right after shooting (the owners of Canon and Nikon will be happy, the other cameras still need to be converted to DNG). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Very briefly about webRTC </h4><br>  In fact, using WebRTC is almost the same as using sockets.  But a little bit different (quite a bit).  We need to transmit image and sound.  We take RTCPeerConnection for connection between peers, MediaStream for audio broadcasting and RTCDataChannel for image transfer.  Also, in order for all this to work, you need a small server to connect peers and transfer control instructions.  But more on that later. <br><br><a name="habracut"></a><br><h4>  Exoskeleton vs Backbone </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/4f2/464/c8a/4f2464c8a346921875824fb7e53355e5.png"><br><br>  It so happens that our main project (pics.io) is being developed on <a href="http://backbonejs.org/">Backbone</a> .  We have long wanted to try the <a href="http://exosjs.com/">exoskeleton</a> , which, however, is the same ... But not quite.  In our case, Exoskeleton is not so necessary, but we just wanted to play around with the new thing and release it into production.  Mine we did not lose.  Another must pay tribute to the author <a href="https://twitter.com/paulmillr">@PaulMiller</a> , who is very actively supporting his brainchild.  In general, we don‚Äôt hate jQuery, from which Exoskeleton saves, but we found that you can write in pure JS for modern browsers.  I sincerely hope that Exoskeleton will repeat the path of <a href="http://lodash.com/">Lodash</a> and conquer the hearts of the backboners. <br><br><h4>  WebRTC via PeerJS </h4><br>  We decided that it would be better and faster to deploy the WebRTC part using a ready-made and tested solution.  After studying several open source projects that wrap WebRTC services, the choice fell on PeerJS: partly because of the large number of stars on GitHub, and partly because of the <a href="https://github.com/lvivski">@Lvivsky advice</a> that the dog ate on creating the <a href="https://github.com/lvivski/speaker">speaker</a> library on Dart / WebRTC. <br><br>  PeerJS is a wrapper over WebRTC that allows you to abstract from its insides.  In the end, we still had to dig into its source when we stumbled upon the restriction of the transferred files via RTCDataChannel to ~ 6Mb.  In general, the library left only pleasant impressions, and the project maintainers promptly helped us. <br>  The first impression from PeerJS was amazing: one line to a pollack server, a great client interface, support for Media call (audio / video) and DataConnections.  And best of all, PeerJS helps to continue limiting the amount of data transferred through DataConnections in Chrome 31, which has not yet learned how to transfer more than 1100 bytes.  But not everyone is a Carnival cat, RTCDataChannel crashes with an absolutely uninformative <code>Uncaught SyntaxError: An invalid or illegal string was specified</code> .  After a couple of liters of coffee and chatting with PeerJS distributors, it turned out that Chrome limits the data transfer rate to 60kb / s.  In addition, it turned out that the maximum size of the transmitted file was ~ 6.3M.  In principle, this is enough to transfer the jpeg extracted from the raw file. <br><br><br><h4>  NAT, NAT, NAT </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/8fb/b29/580/8fbb2958038cd350e982acd9a4bb2c5e.png"><br><br>  On the eve of the release, we could not help it.  The connection in the local network worked perfectly (both MediaStream and DataChannel), but when someone did not connect from the office, our enthusiasm was lost, inexplicable problems started, which were unstable.  That the sound, the data to the guests did not reach. <br>  We highlighted several points that could influence this: <br><ul><li>  DataChannel - which was the connector between all peers </li><li>  A banal bug that was hard to reproduce. </li><li>  NAT obstruction </li></ul><br>  We started with the fact that instead of a DataChannel, we added a Signaling server to the WebSocket, with which we connected existing peers, but this did not solve the problem. <br>  The search for the bug was also unsuccessful.  They were found a lot, but it did not help. <br><br>  ‚ÄúStill, NAT‚Äù - we decided and, as it turned out, we are right.  Strange, but the solution to this problem is not well described in the documentation.  Initially, most libraries use the default server: <br><br><pre> <code class="javascript hljs">[{<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun.l.google.com:19302'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'turn:homeo@turn.bistri.com:80'</span></span>, <span class="hljs-attr"><span class="hljs-attr">credential</span></span>: <span class="hljs-string"><span class="hljs-string">'homeo'</span></span>}]</code> </pre><br>  But, unfortunately, we did not have enough of this and had to surf in search of additional servers.  As a result, we got a huge config for ICEServers <br><br><pre> <code class="javascript hljs">[{<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun01.sipphone.com'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun.ekiga.net'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun.fwdnet.net'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun.ideasip.com'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun.iptel.org'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun.rixtelecom.se'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun.schlund.de'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun.l.google.com:19302'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun1.l.google.com:19302'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun2.l.google.com:19302'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun3.l.google.com:19302'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun4.l.google.com:19302'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stunserver.org'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun.softjoys.com'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun.voiparound.com'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun.voipbuster.com'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun.voipstunt.com'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun.voxgratia.org'</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">url</span></span>:<span class="hljs-string"><span class="hljs-string">'stun:stun.xten.com'</span></span>}, { <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">'turn:numb.viagenie.ca'</span></span>, <span class="hljs-attr"><span class="hljs-attr">credential</span></span>: <span class="hljs-string"><span class="hljs-string">'muazkh'</span></span>, <span class="hljs-attr"><span class="hljs-attr">username</span></span>: <span class="hljs-string"><span class="hljs-string">'webrtc@live.com'</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">'turn:192.158.29.39:3478?transport=udp'</span></span>, <span class="hljs-attr"><span class="hljs-attr">credential</span></span>: <span class="hljs-string"><span class="hljs-string">'JZEOEt2V3Qb0y27GRntt2u2PAYA='</span></span>, <span class="hljs-attr"><span class="hljs-attr">username</span></span>: <span class="hljs-string"><span class="hljs-string">'28224511:1379330808'</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">'turn:192.158.29.39:3478?transport=tcp'</span></span>, <span class="hljs-attr"><span class="hljs-attr">credential</span></span>: <span class="hljs-string"><span class="hljs-string">'JZEOEt2V3Qb0y27GRntt2u2PAYA='</span></span>, <span class="hljs-attr"><span class="hljs-attr">username</span></span>: <span class="hljs-string"><span class="hljs-string">'28224511:1379330808'</span></span> }]</code> </pre><br>  After that, we safely pierced the walls of the NAT and heard the voices of people from other subnets, cities and countries. <br><br><h4>  Problems of technology and implementation </h4><br><h6>  Crossbrowser compatibility. </h6><br>  At the moment, WebRTC implementations have a problem with work between different browsers, but Firefox and Chrome are actively moving in this direction.  After a couple of versions of the web already receive this support. <br><br><h6>  Punching NAT. </h6><br>  STUN and TURN - perhaps the main problem, which for some reason, little is written.  Constantly testing, we noticed that within the same network, everyone heard each other and perfectly received data, but the people who sat behind the routers had constant problems.  We spent a huge amount of nerves on this, since we didn‚Äôt work very closely with network protocols and didn‚Äôt fully understand why.  Now we know - from private networks, class A, B, C, people in the public class network go only through NAT.  This technology is not convenient because two hosts behind NATs cannot communicate with each other.  Therefore, they invented these technologies. <br><br><h6>  Non-Stop coding. </h6><br>  Very cool pastime, a lot of new emotions and skills and a sense of satisfaction from the fact that the output of the finished product.  But you risk being squeezed all the next day. <br><br><h4>  findings </h4><br><ul><li>  PeerJS data transfer rate is limited to 60kb / s </li><li>  maximum file transfer size ~ 6MB </li><li>  you need to emphasize the moment with NAT + STUN + TURN </li><li>  jQuery developer vacancy should become less popular </li><li>  do not forget to specify the scheme for your URI </li><li>  Sooner or later, WebRTC will take over the world </li><li>  WebRTC developers hate their voice </li><li>  we love everything new, raw and broken </li><li>  weekly continuous pedaling terribly exhausting </li></ul><br><br><h5>  Favorite links </h5><br>  <a href="http://www.html5rocks.com/en/tutorials/webrtc/basics/">www.html5rocks.com/en/tutorials/webrtc/basics</a> <br>  <a href="http://www.youtube.com/watch%3Fv%3Dp2HzZkd2A40">www.youtube.com/watch?v=p2HzZkd2A40</a> <br>  <a href="http://www.youtube.com/watch%3Fv%3DE8C8ouiXHHk">www.youtube.com/watch?v=E8C8ouiXHHk</a> <br>  <a href="https://www.webrtc-experiment.com/">www.webrtc-experiment.com</a> <br>  <a href="http://www.webrtc.org/">www.webrtc.org</a> <br>  <a href="https://speakerdeck.com/feross/webrtc-data-black-magic">speakerdeck.com/feross/webrtc-data-black-magic</a> </div><p>Source: <a href="https://habr.com/ru/post/203306/">https://habr.com/ru/post/203306/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../203292/index.html">List of free DNS services</a></li>
<li><a href="../203294/index.html">Co-founder of The Pirate Bay will be issued to Denmark</a></li>
<li><a href="../203296/index.html">Richard Branson promises Virgin Galactic will accept Bitcoin from space tourists</a></li>
<li><a href="../203298/index.html">Pole built a musical instrument designed by Leonardo da Vinci (+ video performance)</a></li>
<li><a href="../203300/index.html">Interview with Elon Musk. Part 2 - about mass, about Mars and about MBA</a></li>
<li><a href="../203308/index.html">GOST usability</a></li>
<li><a href="../203310/index.html">Meeting C ++ 2013</a></li>
<li><a href="../203314/index.html">Snowfall with FFmpeg filters</a></li>
<li><a href="../203316/index.html">Country hackathon in Finland</a></li>
<li><a href="../203318/index.html">Spring Security Overview</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>