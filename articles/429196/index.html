<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>iOS runtime mobile exploration with Objection, or Hack own application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Author: Andrey Batutin, Senior iOS Developer, DataArt. 

 More than once or twice, when I came to work (or just got out of bed), I found an angry lett...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>iOS runtime mobile exploration with Objection, or Hack own application</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/l1/_s/ly/l1_slyrmahxsxmkciorh7werir8.jpeg"><br><br>  <i>Author: Andrey Batutin, Senior iOS Developer, DataArt.</i> <br><br>  More than once or twice, when I came to work (or just got out of bed), I found an angry letter in the mail, the essence of which was that nothing works in the app installation app, and everything needs to be fixed immediately. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Sometimes the cause was my jambs.  Sometimes - my colleagues.  And sometimes even <a href="https://stackoverflow.com/questions/44796613/silent-pushes-not-delivered-to-the-app-on-ios-11">Apple Inc itself</a> . <br><br>  But the most deadly scenarios were associated with bugs that were reproduced only on appstorovskih / release builds.  Nothing baffles so much and makes you howl in front of the MacBook, like the inability to connect a debugger to its own application and see what happens there. <a name="habracut"></a><br><br>  <a href="https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/APNSOverview.html">APNS</a> and its troubleshooting on release / ad-hoc builds create similar difficulties. <br>  On those builds where there is a production APNS environment, you cannot connect a debugger. <br>  On those assemblies where there is a debager, there is no APNS production-push.  But they usually fall off. <br><br>  Apple, like the Old Testament god, with one hand gives a platform where the jailbreak will soon go down in <a href="https://www.cultofmac.com/490594/jailbreaking-pioneers-say-iphone-jailbreaking-dead/">history</a> (and piracy in the App Store remains at the level of statistical error), and the other makes the developer feel like a poor relative, little Oliver Twist, who dared to ask for more porridge. <br><br><img src="https://habrastorage.org/webt/ru/h5/6x/ruh56xq-zncwzkfg1utdqp3c0xw.gif"><br>  <i>Voice-over: "Uncle Apple, please give me another distribution certificate ..."</i> <br><br>  For an average programmer to do something with the release / appstorovskoy build iOS-application was almost unreal.  It was easier to quit before the release. <br><br>  In short: <br><br>  The release build is signed by the Distribution Certificate and uses the Distribution Provisioning Profile.  Entitlement does not allow attachment of debugger to the application process.  Plus, when downloading ipa from the App Store, the binary is also encrypted.  App Extensions are signed separately. <br><br>  That is, the application author seems to be able to take and re-sign the App Store assembly with a certificate using a debugging provisioning profile.  But it still needs to know how to do it.  But even after that, the question of how to connect the debager to the application process remains open. <br><br>  Therefore, it is necessary to focus solely on the fact that it is not adjusted at the design stage.  And catch all the bugs before the application goes to the App Store.  And logs, more logs for the god of logs! <br><br><img src="https://habrastorage.org/webt/ro/0t/pc/ro0tpcf-d0z-jbinkdtm2tcawg4.gif"><br><br>  But recently a new hope has loomed on the horizon. <br><br><img src="https://habrastorage.org/webt/o7/je/vz/o7jevzl9q-oyhytrykl3rilt0ie.gif"><br><br>  In the previous <a href="https://habr.com/company/dataart/blog/424485/">part,</a> we met Frida, a wonderful framework for dynamic code injection.  And SSL-pinning bypassed it in the wonderful <a href="https://gitlab.abatutin.net/abatutin/FoodSnifferSSLPinner">FoodSniffer</a> project. <br><br>  In this article we will introduce the framework created on the basis of Frida, which greatly facilitates the manipulation of the release assemblies of iOS applications. <br><br><h2>  <a href="https://github.com/sensepost/objection">Objection</a> </h2><br>  Objection allows <a href="https://www.owasp.org/index.php/Code_Injection">you</a> to <a href="https://www.owasp.org/index.php/Code_Injection">inject</a> <a href="https://www.frida.re/docs/gadget/">FridaGadget</a> into an iOS assembly and re-sign it with the necessary certificate and provisioning profile. <br><br><h3>  Training </h3><br>  First we need the release assembly FoodSniffer. <br><br>  Important note - when creating ipa, disable ‚ÄúInclude bitcode for iOS content‚Äù. <br><br><img src="https://habrastorage.org/webt/5w/du/b2/5wdub2c1inuc66_xkxgadrkqnti.png"><br><br>  Then we will need a provisioning profile for the assembly. <br><br>  To get it: <br><br><ol><li>  Install the application via Xcode on the device. </li><li>  Find FoodSniffer.app in the Finder. <br><br><img src="https://habrastorage.org/webt/q1/xd/tt/q1xdtt4k8aig7-7qls--eva7lhk.png"></li><li>  Go to the FoodSniffer bundle. <br><br><img src="https://habrastorage.org/webt/fg/ww/rc/fgwwrcpp98jrz8gorivzi8wjanc.png"></li><li>  Copy <b>embedded.mobileprovision</b> from there to the folder with your release ipa. <br><br><img src="https://habrastorage.org/webt/dc/fa/ix/dcfaixrevudcaj1fiwexmkbshn8.png"></li></ol><br>  You should have something like this: <br><br><img src="https://habrastorage.org/webt/lo/py/4k/lopy4kzw1olxcv-4lv18wmpmlp0.png"><br><br>  After this, install objection according to the <a href="https://github.com/sensepost/objection/wiki/Installation">instructions</a> .  I strongly recommend using the virtualenv option. <br><br>  In addition to objection, we need <a href="https://github.com/ios-control/ios-deploy">ios-deploy</a> to run the patched application on the device. <br><br><h3>  Reware the app! </h3><br>  In the terminal, find out the hash of the code sign identity we need: <br><br>  <b>security find-identity -p codesigning -v</b> <br><br><img src="https://habrastorage.org/webt/e4/6a/0y/e46a0yut-b-fje1qml7nk_b9a7o.png"><br><br>  We are interested in the 386XXX identity, since it is the one that corresponds to the debit serial certificate with which the application was signed when installed via Xcode, from which we got the provisioning profile. <br><br>  Register FridaGadget and re-sign our application: <br><br>  <b>objection patchipa --source FoodSniffer / FoodSniffer.ipa --codesign-signature 386XXX --provision-file embedded.mobileprovision</b> <br><br><img src="https://habrastorage.org/webt/vu/oe/f3/vuoef3bipuclzxznuvpffj0x6oc.png"><br><br>  As a result, we should get <b>FoodSniffer-frida-codesigned.ipa</b> . <br><br>  Now we need <b>ios-deploy</b> to install and connect to FridaGadget.  This is an important step - if you simply install ipa on your device via iTunes or Xcode, you will not be able to connect to FridaGadget. <br><br>  Before unpacking <b>FoodSniffer-frida-codesigned.ipa</b> : <br><br>  <b>unzip FoodSniffer-frida-codesigned.ipa</b> <br><br>  Run our patched application on the device: <br><br>  <b>ios-deploy --bundle Payload / FoodSniffer.app -W -d</b> <br><br>  If everything went well, then the application should start on the device, and in the terminal we will see: <br><br><img src="https://habrastorage.org/webt/jo/uh/mj/jouhmjurtt0g-czuzoiy9iorgqg.png"><br><br>  Now, in another tab of the terminal, we connect objection to FridaGadget: <br><br>  <b>objection explore</b> <br><br><img src="https://habrastorage.org/webt/7m/xf/8j/7mxf8jh_92cwac9c47nbkm619kg.png"><br><br>  Profit! <br><br><h3>  Objection provides </h3><br><h4>  SSL Pinning Bypass </h4><br>  Everything is simple: <br><br>  <b>ios sslpinning disable</b> <br><br><img src="https://habrastorage.org/webt/u4/yk/os/u4ykos2slu-abpk3be2zchia81q.png"><br><br>  Now you can easily use the Proxy Server to monitor the traffic of our application, as described in the <a href="https://habr.com/company/dataart/blog/419677/">first part</a> . <br><br><h4>  Dump UserDefaults </h4><br>  <b>ios nsuserdefaults get</b> <br><br>  At the end of the dump we should see <b>‚Äúmood_state‚Äù = ‚ÄúI'm hungry‚Äù</b> <br><br><img src="https://habrastorage.org/webt/xi/t9/qe/xit9qecm1w6bbllk6kiwxbhdy6o.png"><br><br><h4>  Dump app keychain </h4><br>  <b>ios keychain dump</b> <br><br><img src="https://habrastorage.org/webt/-i/ea/pn/-ieapnuhfqegrgvwhmfa-jgiz_o.png"><br><br>  And here is our super secret password. <br><br>  <i>Fetching data from SQLite database.</i> <br>  In the application I added the sqlite-database <b>chinook.db</b> <a href="http://www.sqlitetutorial.net/sqlite-sample-database/">from here</a> . <br><br>  Objection allows you to make requests directly to the database as follows. <br><br><ol><li>  Connection to the database: <br><br>  <b>sqlite connect chinook.db</b> <br><br><img src="https://habrastorage.org/webt/w5/q7/ev/w5q7evj5ekk3ac2i6-aislbaouq.png"></li><li>  Request to her: <br><br>  <b>sqlite execute query select * from albums</b> <br><br><img src="https://habrastorage.org/webt/vr/jb/ma/vrjbma1nqr5vgqrqxx_4bpje_hm.png"></li></ol><br><h2>  Conclusion </h2><br>  Objection and Frida finally allow you to work relatively normally and simply with Ad Hoc and Distribution assemblies of iOS applications.  They return to the programmer the power over their own application, hidden behind the layers of protection with which Apple so carefully wraps iOS apps.  Plus Objection and Frida work on non-jailbroken devices.  In addition, they are relatively easy to use. <br><br>  With them I have a hope of make iOS development great again.  Safely avoiding undermining the new Apple headquarters from the inside. <br><br><img src="https://habrastorage.org/webt/ob/uu/d5/obuud5qapsvakfmb_gkmgr35v2g.gif"><br><br><h2>  Hyper (useful) links </h2><br>  <a href="http://www.delaat.net/rp/2016-2017/p50/report.pdf">Research for Amsterdam students on iOS Code Sign</a> . <br><br>  <a href="https://labs.mwrinfosecurity.com/blog/repacking-and-resigning-ios-applications/">https://labs.mwrinfosecurity.com/blog/repacking-and-resigning-ios-applications/</a> <br><br>  <a href="https://www.nccgroup.trust/us/about-us/newsroom-and-events/blog/2016/october/ios-instrumentation-without-jailbreak/">https://www.nccgroup.trust/us/about-us/newsroom-and-events/blog/2016/october/ios-instrumentation-without-jailbreak/</a> . <br><br>  <a href="https://gitlab.abatutin.net/abatutin/FoodSnifferSSLPinner">FoodSniffer iOS app source code</a> . <br><br>  <a href="https://t.me/fridadotre">Frida telegram</a> . <br><br>  Special thanks to <b>@manishrhll</b> . <br><br>  <i>Note.</i>  All of the above should be applied only to their applications and not try to break Tinder or something else.  Still not work! </div><p>Source: <a href="https://habr.com/ru/post/429196/">https://habr.com/ru/post/429196/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../429186/index.html">Selection @pythonetc, October 2018</a></li>
<li><a href="../429188/index.html">PICASO 3D Designer XL Review</a></li>
<li><a href="../429190/index.html">We make our own implant for electronics</a></li>
<li><a href="../429192/index.html">These new tricks are still able to outsmart Deepfake videos.</a></li>
<li><a href="../429194/index.html">7 libraries for Android development at Kotlin</a></li>
<li><a href="../429198/index.html">The Kernel-Bridge Framework: Ring0 Bridge</a></li>
<li><a href="../429200/index.html">British scientists have launched a supercomputer with 1 million cores, which simulates the human brain</a></li>
<li><a href="../429202/index.html">Expensive courses: is it worth it?</a></li>
<li><a href="../429204/index.html">The most important misconceptions about game development</a></li>
<li><a href="../429208/index.html">Block system encryption of Windows Linux installed systems. Encrypted multiboot. Defense and attack on GRUB2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>