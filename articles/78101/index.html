<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The recipe is simple cooking OpenVPN. Step-by-step instruction</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings, habra people. I will not write the traditional "this is my first topic on Habr√©, do not judge strictly." On the contrary - valid criticism ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The recipe is simple cooking OpenVPN. Step-by-step instruction</h1><div class="post__text post__text-html js-mediator-article"><a href="http://www.openvpn.net/"><img src="https://habrastorage.org/getpro/geektimes/post_images/c31/58d/e29/c3158de296b49e3f40823608360a17d1.png" alt="image"></a> <br><br>  Greetings, habra people.  I will not write the traditional "this is my first topic on Habr√©, do not judge strictly."  On the contrary - valid criticism is welcome, because  I do not have much experience writing articles and I would appreciate any reaction. <br><br>  <u>Warning number of times.</u>  This post, most likely, will not be interesting to the guru from the world of networks.  It is primarily addressed to those whose interests lie in other areas of the IT world, but they are curious and interested in everything new.  Therefore, for those who are ‚Äúin the subject line‚Äù the text may seem like a set of well-known truths and platitudes.  Gentlemen, I strive not to surprise you, but to help those less advanced in this area.  <u>All of the following will apply exclusively to computers running different versions of Windows.</u> <br>  <u>Warning namber that.</u>  I also do not consider myself a guru and can make mistakes / admit inaccuracies in some statements and judgments.  However, the algorithm of actions for setting up a worker is verified personally. <br>  <u>Warning three.</u>  Many letters.  I am writing intentionally in detail, as a result - extensively. <br>  If the above does not scare you - let's start. <br><a name="habracut"></a><br>  To begin with, I‚Äôll remind you what a VPN is and how it can be useful.  VPN (eng. Virtual Private Network) is a generic name for technologies that allow you to provide one or several network connections (logical network) on top of another network (for example, the Internet).  Now in Russian.  If necessary, you can <u>safely</u> combine as many remote computers as you like, so that they consider themselves to be members of the same local network with all the benefits and amenities that follow from this, if only they have access to the Internet. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Example one: your home provider has a double rate, local (cheap and smart connection) and external, ‚Äúto the world‚Äù (more expensive and slower).  On one of the non-home computers to which you have access (for example, a working one), there is anlim Internet with good speed.  Let us leave the moral, ethical and legal aspects aside, now we are interested in a purely technical aspect - can we get access to the world through the mentioned anlim channel at local traffic rates?  The answer is, VPN can help us. <br><br>  Example two: being away from home, there is a need to get access to the files of your home computer.  Moreover, the access is reliably encrypted, because there are plenty of beginners on the network (perhaps in your local one) and many of them may not even have a rough idea of ‚Äã‚Äãspoofing, the TCP / IP stack and other tricky "models", but they know how to run programs like ‚ÄúCain &amp; Abel‚Äù that can not only intercept most of the passwords transmitted in the reachable segment of the network, but also helpfully brute-force those that are encrypted but not chosen very well.  Along with other methods, VPN will help us again - all traffic is securely encrypted using open and proven algorithms and mechanisms over the years. <br><br>  For the organization of VPN, it is desirable that at least one side of the channel being organized has an ‚Äúhonest‚Äù IP address.  You can also implement between two private networks with ‚Äúgray‚Äù IP addresses behind a NAT or proxy server, you only have to call on <a href="http://ru.wikipedia.org/wiki/Hamachi">Hamachi</a> , or you can do with port forwarding (using the ‚Äúconnect‚Äù for a proxy) if you have access to server / router settings.  Further, I consider just such a case. <br><br>  There are a lot of options for organizing a virtual private channel, I want to talk about one of them, free and public, as the name suggests - OpenVPN.  Another advantage of this software is that it is cross-platform.  Connected computers may have different operating systems, * nix including, but configuring such machines is beyond the scope of this article. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/1f2/502/580/1f2502580f35ac4d91989c626c14e337.gif" alt="image"><br><br>  Undoubtedly, everyone, if desired, and known perseverance, can independently figure out the installation and configuration of this client-server software, therefore the purpose of this article is to warn about the rake that I happened to save in order to save time for others to analyze their own.  So, (finally!) What and how to do? <br><br>  1. <a href="">Download software</a> <br><br>  2. We put.  First on the side of the future server.  Then we repeat on the client side (this is a bit simpler), although the sequence is not critical.  As a lazy creature, I agreed with the default installation paths (C: \ Program Files \ OpenVPN \), for which I paid with the first <b>rake</b> . <br>  Problem: when working, the software incorrectly works out the paths to configuration files that contain spaces. <br>  Solution: put in the root of the disk in a separate subfolder without spaces in the name or later ‚Äúscreen‚Äù in configs such paths with quotes.  I screened and the further description is based on the standard installation path. <br><br>  3. To establish an encrypted connection with a remote machine, certificates will be required for each side of the virtual channel, which will confirm that they are exactly who they claim to be.  They can be bought (hundreds of dollars a year, although there are also trial versions up to 90 days) at one of the many certification authorities (CA).  The advantage of such a solution is that no operating system or browser will hysteria that the certificate was issued by an unknown supplier and ‚Äúthe owner, think again, who do you believe?‚Äù.  The downside is obvious - costs.  The second option is to create such certificates yourself, having built your local CA for personal use.  There are a lot of ways to do this, it is important to only carefully consider the parameters of ready-made certificates (namely, compare the ‚Äúfingerprints‚Äù (thumbprint or hashes) generated and implemented) that you will slip to OpenVPN and make sure that this is created by you and not an evil hacker who wants to drag off your entire archive of <s>photos of a naked girlfriend of</s> business correspondence, who learned about your plans to use a VPN and in some way replaced the certificate with your own.  The situation is, of course, almost unbelievable and, frankly, we are paranoid, but security is security.  This is perhaps the most vulnerable point in the very idea of ‚Äã‚Äãusing certificates and keys - their replacement by a single transfer across the network from the CA to the sides of the VPN channel and the realization of the man in the middle attack. <br><br>  I will mention only two ways to create certificates.  The first is with the use of server Windows.  The procedure is not the fastest and most obvious, but quite feasible.  However, in this case it is more convenient to use the second one - the built-in tools of OpenVPN itself on any Windows. <br><br>  For those who want to quickly and not afraid to repeat the mistakes of others: everything written below about the creation of keys and certificates is summarized in English in the file C: \ Program Files \ OpenVPN \ easy-rsa \ README.txt. <br>  I will sign it in more detail and tell you why I had problems. <br><br><h4>  Certificate Authority, keys, certificates </h4><br>  a.  Go to C: \ Program Files \ OpenVPN \ easy-rsa <br><br>  b.  We open openssl.cnf.sample, we rule as necessary.  There is a standard rule - "not sure - do not touch."  By the way, this file can not be changed at all, the default setting is quite working.  But if your hands itch: for example, some variable values ‚Äã‚Äãwill be required by the user when creating a certificate, but they can be set in advance by default and they will be displayed as an answer in square brackets, they can be applied by simply pressing Enter.  Such variables are designated ‚Äúmatch‚Äù.  Required parameters are labeled "optional".  Required for input and unique parameters that each time you need to enter manually marked ‚Äúsupplied‚Äù (such variables are not recommended to be transferred to a different status). <br>  You can configure the expiration date of certificates (default is 10 years), restrictions on the length of user contact information, and so on.  Save as openssl.cnf. <br><br>  c.  Run init-config.bat <br>  Attention, <b>rakes are</b> possible!  It is recommended that this and all subsequent * .bat files be launched not by a double click, but in the Windows console.  For those who use it rarely recall that a little easier life for yourself can be copied paths to quickly navigate to the desired folder.  Explorer -&gt; select the path to the folder -&gt; copy -&gt; switch to the console (win + r -&gt; cmd) -&gt; right mouse button -&gt; paste (Ctrl + V does not roll!).  If you need to copy the path from the console to the buffer: right mouse button -&gt; Mark -&gt; select the desired piece of text -&gt; Enter. <br>  Go to the console in the folder C: \ Program Files \ OpenVPN \ easy-rsa and run init-config.bat. <br><br>  d.  Go back to the explorer in easy-rsa and edit the vars.bat file (I advise you to open it with WordPad, if you open the "edit" window from the context menu, you can get another <b>rake</b> - a message stating that the file was not found with the proposal to create a new one the same gap on the way).  All parameters are supplied with comments, it is easy to figure out what's what.  By and large, everything can also be left by default, but for patriotic reasons, you can also change the country, city, enter your e-mail.  This will not affect anything, but will simply be displayed as information in certificates.  Note the variable KEY_DIR = keys.  This is the name of the subfolder that will need to be created after saving vars.bat to easy-rsa, there will be the keys and certificates necessary for encryption.  The name can be changed, but do not forget to display it in the KEY_DIR variable. <br><br>  e.  Do not forget to create the keys folder or your name option. <br><br>  f.  Create new empty files ‚Äúindex.txt‚Äú and ‚Äúserial‚Äù in keys.  In easy-rsa, the index.txt.start and serial.start files are already located, you can simply copy them into keys and rename them there, removing the .start extension.  The serial will contain the number of certificates issued by CA (the first one is the certificate of the CA itself), index.txt contains information about the certificates issued. <br><br>  g.  We start vars.bat, we start clean-all.bat (and again we do not forget - in the console!) <br><br>  h.  Create a certificate authority key: run vars.bat, launch build-ca.bat and answer the questions.  You can answer all with Enter, using the default options offered, except for a unique answer to the ‚ÄúCommon Name‚Äù question (that is, your name or computer name).  A couple of times to confirm the intentions, agree to sign. <br>  Result: certificate authority certificate file ‚Äúca.crt‚Äù and CA file ‚Äúca.key‚Äù in the Keys folder.  All private keys must be securely stored, having them can be decrypted everything is strained and carefully encrypted. <br><br>  i.  We create the Diffie-Hellman key (what it is and why - you can <a href="http://ru.wikipedia.org/wiki/%25D0%2590%25D0%25BB%25D0%25B3%25D0%25BE%25D1%2580%25D0%25B8%25D1%2582%25D0%25BC_%25D0%2594%25D0%25B8%25D1%2584%25D1%2584%25D0%25B8_%25E2%2580%2594_%25D0%25A5%25D0%25B5%25D0%25BB%25D0%25BB%25D0%25BC%25D0%25B0%25D0%25BD%25D0%25B0">read it</a> in the wiki, if it's too lazy - just accept the fact that it is needed): run vars.bat, run build-dh.bat, wait a bit and admire the process.  If you run build-dh.bat not in the console, but with the mouse, then nothing happens, again, do not forget, I spent a few hours on this <b>rake</b> . <br><br>  j.  We create a private key and a certificate for the server: run vars.bat, launch build-key-server.bat &lt;server_name&gt;.  The server name as a parameter separated by a space on behalf of the batch file at startup is highly desirable, because by default we will receive key and certificate files without names, with some extensions, which in some circumstances may lead to overwriting other certificates and keys that were also created without a name (one more <b>rake</b> ). <br><br>  k.  Create a private key for the client: run vars.bat, run build-key.bat &lt;client_name&gt;.  Recommendation by name is similar - it is desirable to specify.  As a result, we get the key in the PEM-format.  (It is possible to create a key in the PKCS N12 format, for this, instead of build-key.bat &lt;client_name&gt;. You need to run build-key-pkcs12.bat &lt;client_name&gt;. I will not describe the difference between the formats, you can google if you wish). <br><br>  l.  Everything.  In less than half an hour, we created the necessary keys and certificates for the client and server and saved a few hundred dollars. <br><br><h4>  Customization </h4><br>  4. Now actually setting OpenVPN.  Again you have to edit the config files, this is the legacy of the linux-roots of the program.  Go to C: \ Program Files \ OpenVPN \ sample-config, copy client.ovpn and server.ovpn from there, put them in C: \ Program Files \ OpenVPN \ config. <br><br><h5>  a.  Client setup </h5><br>  In C: \ Program Files \ OpenVPN \ config, open (you can just double click) client.ovpn, read the comments for each variable, change the ones we need.  Commented out options begin with ‚Äú;‚Äù, acting (and recommended) - without a semicolon at the beginning.  It is possible to agree with most of the recommended parameters, at least it is necessary to change the following parameters: <br><br>  "Ca ca.crt".  Here you need to specify the full path to the certificate authority certificate.  If your installation path is the same as mine, it is in easy-rsa \ keys.  Attention, <b>rake</b> : in the server and client configs in the paths to the files you need to use not single, but double slashes.  This is a feature of the program.  I mentioned earlier one more <b>rake</b> : the paths contain a space, so they must be enclosed in quotes.  The variable ca will look like this: <br>  ca "C: \\ Program Files \\ OpenVPN \\ easy-rsa \\ keys \\ ca.crt" <br><br>  do the same with client variables cert and key: <br>  cert "C: \\ Program Files \\ OpenVPN \\ easy-rsa \\ keys \\ &lt;client_name&gt; .crt" <br>  key "C: \\ Program Files \\ OpenVPN \\ easy-rsa \\ keys \\ &lt;client_name&gt; .key" <br><br>  remote: here you need to specify the IP address of the server and, through the space, the port on which it will listen for incoming connections (the port is configured during server configuration). <br>  A small digression.  Since the initiator of the connection in client-server models is the client, the server must have an ‚Äúhonest‚Äù IP address, or at least it is located behind the server / router that is accessed with that one.  I set up VPN between the worker (behind the NAT) and the home (similarly) computers, the home has a ‚Äúgray‚Äù IP address, but it was easily decided by ‚Äúforwarding‚Äù the port (I chose 7000) of the router to this computer, since the router has a permanent and an ‚Äúhonest‚Äù network address. <br><br>  I left the rest of the variables by default, you can change what you need, they are well described. <br><br><h5>  b.  Server Tuning. </h5><br>  Variable port - specify the UDP port (or TCP port, if you changed the protocol in the proto variable, you only need the proto value to match on the client and server sides) that the server will listen to.  You can choose any value from 1025 to 65535, it is important that it does not conflict with other server software, if there is one (or other programs that may be tied to a specific port, for example, torrent rocking). <br><br>  Similarly client, variable keys and certificates: <br>  ca "C: \\ Program Files \\ OpenVPN \\ easy-rsa \\ keys \\ ca.crt" (the CA certificate is the same, the client and the server are the same) <br><br>  cert "C: \\ Program Files \\ OpenVPN \\ easy-rsa \\ keys \\ &lt;server_name&gt; .crt" <br><br>  key "C: \\ Program Files \\ OpenVPN \\ easy-rsa \\ keys \\ &lt;server_name&gt; .key" <br><br>  Plus the Diffie-Hellman key: <br>  dh "C: \\ Program Files \\ OpenVPN \\ easy-rsa \\ keys \\ dh1024.pem" <br><br>  Server variable  Defines a private (‚Äúgray‚Äù) network from which the IP addresses for the computers to be connected will be selected.  When organizing VPN by means of OpenVPN, new virtual network interfaces appear on the server and on the client, which the Windows, thanks to the drivers included, consider them to be fully-fledged real network cards.  Their settings are determined by this variable.  In most cases, you can leave the default. <br><br>  The remaining variables can also not be changed, I will mention only about the variable verb.  It defines the details of the logs that will be kept on the server side about all events and errors.  A value of 1 is the least detail; a value of 9 will impress you.  So for one unsuccessful connection attempt, I received a log file weighing about 600 kb.  It is reasonable to leave 3, or increase to 4-5 if you need careful error analysis. <br><br>  5. Now you need to arrange the necessary files on the server and client sides.  The easiest option is to install the program on each side and copy all the files configured by the algorithm above into the appropriate folders.  If you approach carefully and canonically - on the client side, leave only the client keys, certificates and certificate of the certification authority, deleting everything related to the CA and the server, on the server side, delete all the client ones.  Reasonable - pre boiling. <br><br><h4>  Run </h4><br>  6. Setup is complete, you can try to run it all.  (Do not forget to open the necessary ports and IP addresses in firewalls!) There are two options for this: <br><br>  a.  Go to the server in C: \ Program Files \ OpenVPN \ config, right mouse button on server.ovpn -&gt; Start OpenVPN on this config file.  Similarly, on the client side with the client.ovpn file.  In each case, we observe messages and, if successful, on the client we will see in the last line: <br>  "Initialization Sequence Completed" <br><br>  or <br>  b.  We start the graphical shell C: \ Program Files \ OpenVPN \ bin \ openvpn-gui-1.0.3.exe - Right mouse button on the tray icon - server - connect (for client - client - connect).  In case of success on the client we will see a pop-up window from the tray of the form: <br>  "Assigned IP: 10.8.0.6" and the icon will turn green. <br><br>  7. Another one, the last <b>rake</b> , with which I happened to face.  If the system service ‚ÄúDHCP client‚Äù is not running on the client (and I deliberately disconnected it immediately after installing Windows, because the machine‚Äôs IP address is permanent), it will not be able to get an IP address that the server will try to issue to it.  Moreover, the graphical shell will report that the address has been received, but we will not see this in the network connections in the system routing table. <br><br><h4>  Application </h4><br>  8. Is there a connection, what now?  And now - only depends on your imagination.  You can put home an ftp server that listens to the virtual channel's IP address (goodbye, the problem of open transfer of login and password via ftp protocol), you can use something like R-Admin or its free analogue TightVNC, you can go home from home Internet through a remote gateway (example one; however, for this you will need to tinker a little more (at least enable) with routing on a remote gateway and not forget that simply changing the default gateway to a remote one can lose the Internet along with the tunnel in general; useful uncomment us  Royko server variable push ¬´redirect-gateway def1 bypass-dhcp¬ª).  You can configure remote file synchronization.  In general, you can do everything in a local network.  And while it is safe.  As the tunnel rises at the OSI transport layer, any network application can be ‚Äúwrapped‚Äù into it. <br>        Wake-On-Lan ‚Äî        . <br><br><h6> PS    .        OpenVPN. </h6><br><h6> PPS   ,  . </h6><br><br>  <b>UPD.</b>   . <br>      .       ¬´  Open VPN¬ª:        .           :        ,   .           -  .     ,    ,    .             ‚Äî     . <br><br> <b>UPD-2.</b>    OpenVPN 2.1.1 (released on 2009.12.11),     .   <a href="http://www.openvpn.net/index.php/open-source/documentation/change-log/71-21-change-log.html">.</a> <br><habracut></habracut></div><p>Source: <a href="https://habr.com/ru/post/78101/">https://habr.com/ru/post/78101/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../78086/index.html">Debian-packages with a human face on the example of Zabbix 1.8</a></li>
<li><a href="../78088/index.html">Dropbox 0.7 - new version with support for LAN sync, as well as DropboxPortable for flash drives</a></li>
<li><a href="../78092/index.html">Big brother is watching you!</a></li>
<li><a href="../78094/index.html">How to build a binary deb package: detailed HowTo</a></li>
<li><a href="../78095/index.html">Review of Android communicator for $ 210, DualSIM, 5Mp, WiFi</a></li>
<li><a href="../78102/index.html">Esoteric programming language called "... your mother"</a></li>
<li><a href="../78103/index.html">How do I conduct myself on a freelance website</a></li>
<li><a href="../78104/index.html">Christmas Quiz by allsoft</a></li>
<li><a href="../78106/index.html">C # 3.0 syntax highlighting in blogs</a></li>
<li><a href="../78108/index.html">Proposal for GNOME to exit GNU projects</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>