<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A simple interpreter from scratch in Python (translation) # 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The thing that attracted me to study computer science was the compiler. I thought it was all magic, how can they even read my badly written code and c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A simple interpreter from scratch in Python (translation) # 1</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/92d/b64/dea/92db64deaa585651fb5060baa37dce0f.png"><br><br>  The thing that attracted me to study computer science was the compiler.  I thought it was all magic, how can they even read my badly written code and compile it.  When I completed the compiler course, I began to find this process very simple and straightforward. <br><br><div class="spoiler">  <b class="spoiler_title">Content</b> <div class="spoiler_text">  <b>Simple interpreter from scratch in Python # 1</b> <br>  <a href="http://habrahabr.ru/post/206454/">Simple interpreter from scratch in Python # 2</a> <br>  <a href="http://habrahabr.ru/post/208872/">Simple interpreter from scratch in Python # 3</a> <br>  <a href="http://habrahabr.ru/post/207662/">Simple interpreter from scratch in Python # 4</a> <br></div></div><br>  In this series of articles, I will try to capture some of this simplicity by writing a simple interpreter for the usual imperative language <b>IMP</b> (IMperative Language).  The interpreter will be written in Python, because it is a simple and widely known language.  Also, the python code is similar to pseudocode, and even if you do not know it [python], you will be able to understand the code.  Parsing will be performed using a simple set of combinators written from scratch (I will tell you more in the next section).  No additional libraries will be used except <i>sys</i> (for I / O), <i>re</i> (regular expressions in the lexer) and <i>unittest</i> (to test the performance of our crafts). <br><a name="habracut"></a><br><h5>  The essence of the IMP language </h5><br>  First of all, let's discuss why we will write an interpreter.  IMP is an unrealistically simple language with the following constructs: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>Assignments (all variables are global and only accept integer):</i> <br><br><pre><code class="python hljs">x := <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><br>  <i>Conditions:</i> <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x = <span class="hljs-number"><span class="hljs-number">1</span></span> then y := <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> y := <span class="hljs-number"><span class="hljs-number">3</span></span> end</code> </pre><br><br>  <i>While loop:</i> <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> x &lt; <span class="hljs-number"><span class="hljs-number">10</span></span> do x := x + <span class="hljs-number"><span class="hljs-number">1</span></span> end</code> </pre><br><br>  <i>Compound operators (separated <b>;</b> ):</i> <br><br><pre> <code class="python hljs">x := <span class="hljs-number"><span class="hljs-number">1</span></span>; y := <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre><br><br>  This is just a toy language.  But you can extend it to a utility level like Python or Lua.  I just wanted to keep it as simple as I can. <br><br>  <i>And here is an example of a program that calculates factorial:</i> <br><br><pre> <code class="python hljs">n := <span class="hljs-number"><span class="hljs-number">5</span></span>; p := <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> n &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> do p := p * n; n := n - <span class="hljs-number"><span class="hljs-number">1</span></span> end</code> </pre><br><br>  The IMP language cannot read input data (input), i.e.  At the beginning of the program you need to create all the necessary variables and assign values ‚Äã‚Äãto them.  Also, the language can not display anything: the interpreter will display the result at the end. <br><br><h5>  Interpreter structure </h5><br>  The interpreter core is nothing more than an intermediate representation (intermediate representation, IR).  It will represent our IMP programs in memory.  Since IMP is as simple as 3 rubles, IR will directly correspond to the syntax of the language;  we will create a class for each syntax unit.  Of course, in a more complex language, you would also like to use a semantic representation, which is much easier to analyze or execute. <br><br>  Only three stages of interpretation: <br><ul><li>  Parse source code symbols into tokens. </li><li>  Collect all tokens in an abstract syntax tree (abstract syntax tree, AST).  AST is our IR. </li><li>  Execute AST and display the result at the end. </li></ul><br><br>  The process of dividing characters into tokens is called lexing, and the lexer does this.  Tokens are short, digestible lines containing the most basic parts of a program, such as numbers, identifiers, keywords, and operators.  Lexer will skip the spaces and comments, as they are ignored by the interpreter. <br><br>  The process of assembling tokens in AST is called parsing.  The parser extracts the structure of our program into a form that we can execute. <br><img src="http://habrastorage.org/storage3/1ee/b66/213/1eeb66213f95fdbe1d27a530c6aaf465.png" align="right"><br><br>  This article will focus exclusively on the lexer.  First we will write the general lex library and then the lexer for IMP.  The following parts will focus on the parser and artist. <br><br><h5>  Lexer </h5><br>  In truth, lexical operations are very simple and are based on regular expressions.  If you are not familiar with them, you can read the <a href="http://docs.python.org/2/library/re.html">official documentation</a> . <br><br>  The input to the lexer will be a simple stream of characters.  For simplicity, we will read the input in memory.  But the output data will be a list of tokens.  Each token includes a value and a label (tag, to identify the type of token).  The parser will use this to build a tree (AST). <br><br>  So, let's make the most common lexer, which will take a list of regexps and parse the code into tags.  For each expression, it will check whether the input matches the current position.  If a match is found, the corresponding text is extracted into the token, along with the regular expression tag.  If the regular expression does not fit anywhere, the text is discarded.  This allows us to get rid of things like comments and spaces.  If nothing matched at all, then we report an error and the script becomes a hero.  This process is repeated until we analyze the whole code flow. <br><br>  <i>Here is the code from the lexer library:</i> <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lex</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(characters, token_exprs)</span></span></span><span class="hljs-function">:</span></span> pos = <span class="hljs-number"><span class="hljs-number">0</span></span> tokens = [] <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> pos &lt; len(characters): match = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> token_expr <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> token_exprs: pattern, tag = token_expr regex = re.compile(pattern) match = regex.match(characters, pos) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> match: text = match.group(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> tag: token = (text, tag) tokens.append(token) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> match: sys.stderr.write(<span class="hljs-string"><span class="hljs-string">'Illegal character: %s\n'</span></span> % characters[pos]) sys.exit(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: pos = match.end(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tokens</code> </pre><br><br>  Note that the order of transmission to regular expressions is significant.  The lex function will iterate through all the expressions and accept only the first match found.  This means that when using this function, first of all we should pass specific expressions (corresponding to operators and keywords), and then ordinary expressions (identifiers and numbers). <br><br><h5>  Lexer IMP </h5><br>  Given the code above, creating a lexer for our language becomes very simple.  First, let's define a series of tags for tokens.  A language needs only 3 tags.  <b>RESERVED</b> for reserved words or operators, <b>INT</b> for numbers, <b>ID</b> for identifiers. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> lexer RESERVED = <span class="hljs-string"><span class="hljs-string">'RESERVED'</span></span> INT = <span class="hljs-string"><span class="hljs-string">'INT'</span></span> ID = <span class="hljs-string"><span class="hljs-string">'ID'</span></span></code> </pre><br><br>  Now we define the expressions for the tokens that will be used in the lexer.  The first two expressions correspond to spaces and comments.  Since they have no tags, the lexer will skip them. <br><br><pre> <code class="python hljs">token_exprs = [ (<span class="hljs-string"><span class="hljs-string">r'[ \n\t]+'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (<span class="hljs-string"><span class="hljs-string">r'#[^\n]*'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>),</code> </pre><br><br>  After that all our operators and reserved words follow. <br><br><pre> <code class="python hljs"> (<span class="hljs-string"><span class="hljs-string">r'\:='</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'\('</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'\)'</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r';'</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'\+'</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'-'</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'\*'</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'/'</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'&lt;='</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'&lt;'</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'&gt;='</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'&gt;'</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'='</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'!='</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'and'</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'or'</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'not'</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'if'</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'then'</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'else'</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'while'</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'do'</span></span>, RESERVED), (<span class="hljs-string"><span class="hljs-string">r'end'</span></span>, RESERVED),</code> </pre><br><br>  Finally, we need expressions for numbers and identifiers.  Please note that the regular expressions for identifiers will correspond to all the reserved words above, so it is very important that these two lines come last. <br><br><pre> <code class="python hljs"> (<span class="hljs-string"><span class="hljs-string">r'[0-9]+'</span></span>, INT), (<span class="hljs-string"><span class="hljs-string">r'[A-Za-z][A-Za-z0-9_]*'</span></span>, ID), ]</code> </pre><br><br>  When our regexps are defined, we can create a wrapper over the <b>lex</b> function <b>:</b> <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">imp_lex</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(characters)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lexer.lex(characters, token_exprs)</code> </pre><br><br>  If you have read these words, you will most likely be interested in how our miracle works.  Here is the code for the test: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> imp_lexer <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: filename = sys.argv[<span class="hljs-number"><span class="hljs-number">1</span></span>] file = open(filename) characters = file.read() file.close() tokens = imp_lex(characters) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> token <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> tokens: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> token</code> </pre><br><br><pre> <code class="python hljs">$ python imp.py hello.imp</code> </pre> <br><br>  Download full source code: <a href="">imp-interpreter.tar.gz</a> <br>  The author of the original article is <a href="http://www.jayconrod.com/posts/37/a-simple-interpreter-from-scratch-in-python-part-1">Jay Conrod</a> . <br><br>  <b>UPD:</b> Thanks to the <a href="https://habrahabr.ru/users/zelark/" class="user_link">zeLark</a> user for fixing the bug related to the pattern definition order. </div><p>Source: <a href="https://habr.com/ru/post/206320/">https://habr.com/ru/post/206320/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../206304/index.html">Suddenly. SugarSync finishes free accounts</a></li>
<li><a href="../206306/index.html">An example of solving a multiple regression problem using Python</a></li>
<li><a href="../206308/index.html">Save our souls: how reality shows affect people</a></li>
<li><a href="../206310/index.html">McLaren replaces wiper blades with a force field of sound waves</a></li>
<li><a href="../206312/index.html">Top 10 books to understand the stock market device</a></li>
<li><a href="../206322/index.html">We build an OpenVPN bridge under Mac OSX</a></li>
<li><a href="../206324/index.html">ShareJS or how to make your Google Wave with OT and NodeJS</a></li>
<li><a href="../206326/index.html">How to add additional fields in the system properties</a></li>
<li><a href="../206328/index.html">Debugging Chrome Dev Tools from Chrome Dev Tools</a></li>
<li><a href="../206330/index.html">How to scale Meteor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>