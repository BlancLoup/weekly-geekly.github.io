<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Home accounting on the CUBA platform</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The purpose of this article is to tell about the capabilities of the CUBA platform by the example of creating a small useful application. 
 CUBA is de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Home accounting on the CUBA platform</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/2a6/a5b/247/2a6a5b247ff644e999e3a1ff09f67738.png"><br><br>  The purpose of this article is to tell about the capabilities of the <a href="https://www.cuba-platform.com/">CUBA</a> platform by the example of creating a small useful application. <br>  CUBA is designed for rapid development of business applications in Java, we have already written about her several <a href="http://habrahabr.ru/company/haulmont">articles</a> on Habr√©. <br><br>  Usually, on the platform, either real but too large and closed information systems are built, or applications in the ‚ÄúHello World‚Äù style or artificial examples of the ‚ÄúLibrary‚Äù type on our website.  Therefore, some time ago I decided to try to kill two birds with one stone - write a useful application for myself and share it as an example of using our platform, since the subject area is simple and clear to everyone. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h2>  What happened in the end </h2><br>  In short, the application solves two main tasks: <br><ol><li>  At any time shows the current balance for all types of funds: cash, cards, deposits, debts, etc. </li><li>  Generates a report by income and expense categories, allowing you to find out what was spent on or where the money came from in a certain period. </li></ol><br>  A little more detail: <br><ul><li>  Different types of cash are <i>invoices</i> . </li><li>  <i>Transactions</i> are possible on arrival to the account, expense from the account and transfer of funds between accounts. </li><li>  In a receipt or expense transaction, you can set a <i>category</i> to clarify where the money came from or what it was spent on. </li><li>  The balance of all accounts on the current date is displayed continuously and is recalculated after each transaction. </li><li>  The report on the categories of income and expenses shows a summary of two arbitrary periods simultaneously for a quick visual comparison.  Any category can be excluded from the comparison.  For each line of the report, you can ‚Äúfail‚Äù in the operation to see what it consists of. </li><li>  The system consists of three web applications deployed on one Tomcat: <br><ol><li>  Middleware </li><li>  Full featured UI on CUBA </li><li>  Responsive UI on Backbone.js + Bootstrap for easy input operations on mobile devices. </li></ol><br>  It looks somewhat redundant for solving such a simple task, but, firstly, the application was created more for training purposes than practical ones, and secondly, it doesn‚Äôt need much resources - my own copy runs easily on the Amazon EC2 micro instance. <br></li></ul><br><h2>  Few screenshots </h2><br><div class="spoiler">  <b class="spoiler_title">Primary UI: list of operations</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/cd5/973/12e/cd597312e29a460c8b1cb60643d8e33e.png"></div></div><br><div class="spoiler">  <b class="spoiler_title">Primary UI: income / expense category report</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/678/f2e/137/678f2e1370e14d8c9aff260ea772c89f.png"></div></div><br><div class="spoiler">  <b class="spoiler_title">Responsive UI: list of operations</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/b13/da6/a88/b13da6a889cf42ad8819477fb91975e9.png"></div></div><br><div class="spoiler">  <b class="spoiler_title">Responsive UI: current balance</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/385/40b/d0e/38540bd0ee8e47d9842ef10a96dcdfaa.png"></div></div><br><br><h2>  How to start </h2><br>  The source code of the project is here: <a href="https://github.com/knstvk/akkount">github.com/knstvk/akkount</a> (QC is my initials, nothing better came to mind). <br>  The platform itself is not free, but five simultaneous connections in a free license are more than enough for home use, so if someone wants to use it, please. <br><br>  It only requires JDK 7+ and the JAVA_HOME environment variable set.  To build, open the command line in the project root and run <br> <code>gradlew setupTomcat deploy</code> <br> <br>  Gradle will be loaded, which will download the <s>Internet</s> platform and other libraries, and then build the application in the build / tomcat subdirectory.  During the build process, you will be asked to accept the license agreement for the CUBA platform. <br>  After that, you need to start the HSQL server and create a database in the data subdirectory of the project: <br> <code>gradlew startDb</code> <br> <code>gradlew createDb</code> <br> <br>  To run Tomkat, you can use the Gradle command. <br> <code>gradlew start</code> <br>  or by <code>startup.*</code> scripts in the <code>build/tomcat/bin</code> subdirectory. <br>  The main web interface of the application is available on <code><a href="http://localhost/"></a> localhost:8080/app</code>  <code><a href="http://localhost/"></a> localhost:8080/app</code> , responsive UI - on <code><a href="http://localhost/"></a> localhost:8080/app-portal</code>  <code><a href="http://localhost/"></a> localhost:8080/app-portal</code> .  User is admin, password is admin. <br><br>  The database is initially empty; there is a generator for filling it with test data.  It is available through the <b>Administration -&gt; JMX Console -&gt; app-core.akkount -&gt; app-core.akkount: type = SampleDataGenerator menu</b> .  Here there is a method <code>generateSampleData()</code> , which takes an integer as input - the number of days ago from the current date for which you need to create operations.  For example, type 200, and click Start.  Wait for the operation to complete, then log out (the icon in the upper right corner) and log in again.  You will see about the same thing as in my screenshots. <br><br><h2>  How to look inside </h2><br>  To study and refine the application, I recommend <a href="https://www.cuba-platform.com/download">downloading</a> and installing CUBA Studio, IntelliJ IDEA and CUBA plugin for it. <br><br>  Further, I will not dwell on how and what is done in the Studio.  There and so everything is visually, there is contextual help, there are <a href="https://www.cuba-platform.com/ru/quickstart">video materials</a> and <a href="http://docs.cuba-platform.com/cuba/5.1/manual/ru/html-single/manual.html">documentation</a> on the platform.  Let me explain the only nuance with using HSQL database: When opening a project using HSQL DB, Studio launches its own server on port 9001 and stores databases in the <code>~/.haulmont/studio/hsqldb</code> .  This means that if you started the HSQL server separately from Studio with the Gradle commands, you need to stop it.  Database files, if necessary, can simply be transferred from <code>data/akk</code> to <code>~/.haulmont/studio/hsqldb/akk</code> . <br><br>  In general, the application can be run on a more serious database - PostgreSQL, Microsoft SQL Server or Oracle.  To do this, in Studio it is enough to select the desired type of database in the <b>Project properties</b> , then execute <b>Entities -&gt; Generate DB Scripts</b> , then in the main menu <b>Run -&gt; Create database</b> . <br><br>  The main objective of this article is to show those development techniques on the platform that are not visible in the Studio interface and which are difficult to find in the documentation if you do not know in advance what to look for.  Therefore, the project description will be fragmentary, with emphasis on non-obvious and non-standard things. <br><br><h2>  Data model </h2><br><img src="https://habrastorage.org/files/6eb/d48/3a5/6ebd483a5a4f4285892bcff68c1529b3.png"><img src="https://habrastorage.org/files/781/c6c/f44/781c6cf440df45b984bf4dc13aaefef9.PNG"><br><br>  Entity classes are located in the <code>global</code> module, which is accessible to both the middle layer and web clients. <br><br>  These are mostly regular JPA entities, appropriately annotated and registered in <code>persistence.xml</code> .  Most of them also have a CUBA-specific annotation <code>@NamePattern</code> , which specifies ‚Äúinstance name‚Äù - how to display a specific entity instance in the UI, something like <code>toString()</code> .  If such an annotation is not specified, just <code>toString()</code> used as the instance name, which returns the class name and object identifier.  Another specific annotation - <code>@Listeners</code> , defines classes of listeners for creating / changing objects.  The entity listeners below will be discussed in detail. <br><br>  In addition to the JPA entities, there is a non-persistent <code>CategoryAmount</code> entity in the project.  Instances of non-persistent entities are not stored in the database, but are used only for transferring data between application layers and displaying by standard UI components.  In this case, this entity is used to generate a report by category: the middle layer retrieves the data, creates and populates <code>CategoryAmount</code> instances, and in the web client these instances are put into data sources (datasources) and displayed in tables.  Standard <code>Table</code> components do not know anything about the origin of entities ‚Äî for them, they are simply objects known in the application's metadata.  And in order to include a non-persistent entity in metadata, you need to add the <code>@MetaClass</code> annotation to its class, attributes the <code>@MetaProperty</code> annotation to <code>@MetaProperty</code> , and register the class in the <code>metadata.xml</code> file.  Of course, persistent entities are also described in metadata - for this, the metadata loader at the start of the application also parses the <code>persistence.xml</code> file. <br><br>  Next to the entities are enumeration classes, for example <code>OperationType</code> .  Enumerations that are used in the data model in the attributes of entities are not quite ordinary: they implement the <code>EnumClass</code> interface and have the <code>id</code> field.  Thus, the value stored in the database is separated from the Java value.  This makes it possible to ensure compatibility with data in production DB with arbitrary refactoring of application code. <br><br>  In the files <code>messages.properties</code> and <code>messages_ru.properties</code> an entity package there are localized names of entities and their attributes.  These names are used in the UI, if the visual components do not override them at their level.  Message files are regular UTF-8 key-value sets.  The search for a message for a locale is similar to the <code>PropertyResourceBundle</code> rules ‚Äî first, the key is searched for in files with a suffix that matches the locale, if not found ‚Äî in files without a suffix. <br><br>  Consider the essence of the model. <br><ul><li>  <code>Currency</code> - currency.  It has a unique code and an arbitrary name.  The uniqueness of the currency code is maintained by a unique index, which the Studio includes in the database creation scripts if the <code>@Column</code> annotation contains the <code>unique = true</code> property.  The platform contains an exception handler thrown in case of uniqueness violation in the database.  This handler issues a standard message to the user.  The handler can be changed in your project. </li><li>  <code>Account</code> - an account.  It has a unique name and an arbitrary description.  It also contains a link to the currency and a separate field of the currency code.  This field is an example of denormalization to improve performance.  Since in the lists of accounts, as a rule, they are displayed together with the currency code, it makes sense to get rid of the join in database queries by adding the currency code to the account itself.  We will force the entity listener to update the currency code in the account when the account currency changes (even though in practice it happens very rarely) - more on this later.  The account also contains an <code>active</code> attribute ‚Äî a sign that it is available for use in new transactions, and an <code>includeInTotal</code> attribute ‚Äî a sign that the balance on this account should be included in the aggregate balance. </li><li>  <code>Category</code> - the category of income or expenses.  It has a unique name and an arbitrary description.  The <code>catType</code> attribute is a category type, defined by the <code>CategoryType</code> enum.  As already explained above, the class field and the database store the value determined by the enumeration identifier (in this case, the string ‚ÄúE‚Äù or ‚ÄúI‚Äù), and the getter and setter, and therefore the entire application code, work with the <code>CategoryType.INCOME</code> values and <code>CategoryType.EXPENSE</code> . </li><li>  <code>Operation</code> - operation.  Operation attributes: type (transfer <code>OperationType</code> ), date, expense and <code>acc1</code> accounts ( <code>acc1</code> , <code>acc2</code> ) and corresponding amounts ( <code>amount1</code> , <code>amount2</code> ), category and comments. </li><li>  <code>Balance</code> - the balance on the account on a certain date.  In general, for home accounting it would be quite possible to do without this entity and to always calculate the balance dynamically ‚Äúfrom the beginning of time‚Äù: just lay down the entire income and take away all the expense on the account.  But I decided for interest to complicate the implementation in case of a large number of operations - the balance on the account at the beginning of each month is stored in <code>Balance</code> instances, when recording each operation, balances for the beginning of the next month (and later, if any) are recalculated.  But to calculate the balance for the current date, you only need to take the balance at the beginning of the month and calculate the turnover of the operations of the current month.  This approach will not cause performance problems over time. </li><li>  <code>UserData</code> - key-value storage of some data associated with the user.  For example, the last used account, report parameters by category.  That is, it stores what is necessary to ‚Äúremember‚Äù when repeated actions of the user.  Possible keys are defined as constants in the <code>UserDataKeys</code> class. </li></ul><br><br><h2>  Entity listeners </h2><br><img src="https://habrastorage.org/files/16c/f3e/512/16cf3e51231044c4addb0d0b213b4d32.PNG"><br><br>  If you worked with JPA, you probably also used entity listeners.  This is a convenient mechanism for performing any actions at the moment of saving changes to entities in the database.  The most important thing is that all changes made by the listeners are made in the same transaction - similar to the database triggers.  Therefore, it is convenient to organize the logic of maintaining the consistency of the data model on the listeners. <br><br>  The entity listeners in CUBA differ somewhat in implementation from JPA.  The listener class must implement one or more special interfaces ( <code>BeforeInsertEntityListener</code> , <code>BeforeUpdateEntityListener</code> , etc.).  Listeners on the entity class are registered in the @Listeners annotation <code>@Listeners</code> listing the class names in the array of strings.  You cannot use literals class literals directly in an entity class, since an entity is a global object that is accessible to both the middle layer and clients, and the listener is only an object of the middle layer that is inaccessible to clients.  The listeners live only on the middle layer because they need access to the <code>EntityManager</code> and other database tools. <br><br>  In this application, entity listeners perform two functions: first, they update denormalized fields, and second, they recalculate balances on accounts at the beginning of months. <br>  The first task is trivial: AccountEntityListener in the <code>onBeforeInsert()</code> methods, <code>onBeforeUpdate()</code> updates the value of the currency code.  To do this, it is enough for him to refer to the associated instance of <code>Currency</code> . <br>  The second task is essentially one of the main business logic of the application.  Engaged in this <code>OperationEntityListener</code> in the methods <code>onBeforeInsert()</code> , <code>onBeforeUpdate()</code> , <code>onBeforeDelete()</code> .  In addition to recalculating the balance, this listener also remembers the last used accounts in <code>UserData</code> objects. <br><br>  It should be noted that in Before-listers there are no restrictions on using <code>EntityManager</code> , loading and modifying instances of any entities.  For example, in <code>addOperation()</code> using <code>Query</code> <code>Balance</code> instances are loaded and modified.  They will be stored in the database simultaneously with the operation in a single transaction. <br><br>  Sometimes in the listener you need to get the ‚Äúprevious‚Äù state of the object that is currently in the persistent context, that is, the state that is now in the database.  For example, in this case, in <code>onBeforeUpdate()</code> we must first subtract the previous value of the transaction amount from the balance, and then add the new value.  To do this, in the <code>getOldOperation()</code> method, a new transaction is started using <code>persistence.createTransaction()</code> , in its context another <code>EntityManager</code> obtained, and through it the previous operation state with the same identifier is loaded from the database.  Then the new transaction is completed without affecting the current one, in which our listener operates. <br><br><h2>  Middle layer components </h2><br><img src="https://habrastorage.org/files/724/1e5/b0a/7241e5b0a4ba47639bb7195cd7d580bd.PNG"><img src="https://habrastorage.org/files/f53/5cf/ea7/f535cfea73904f218dd2bfa4e82327bd.PNG"><br><br>  The main work on loading data to the client level and saving user-made changes to the database is performed by the standard DataService implemented in the platform.  Through it work data sources of visual components.  This is not enough in our application, so several specific services are created. <br><br>  First, it is the <code>UserDataService</code> , which allows you to work with the key-value <code>UserData</code> storage, providing a typed interface for reading and writing entity identifiers.  The service interface is in the <code>global</code> module, because it must be accessible to the client layer.  The service implementation is located in the core module in the <code>UserDataServiceBean</code> class.  It delegates calls to the <code>UserDataWorker</code> , in which the code that does the useful work is concentrated.  This is done because this functionality is also required in the <code>OperationEntityListener</code> , that is, ‚Äúfrom the inside‚Äù of the middle layer.  The service forms the ‚Äúmiddleware border‚Äù and is intended only for calling from client blocks.  It should not be called from the inside of the middle layer components, since this leads to the repeated triggering of the interceptor, which checks the authentication and processes the exception in a special way.  And just for the sake of restoring order, it is worth separating the services called outside by middleware from the rest of the bins called from within.  If only because when you call outside the transaction is always absent, and when you call from the middleware code, the transaction can already be opened. <br><br>  The next service is <code>BalanceService</code> .  It allows you to get the value of the account balance for an arbitrary date.  Since this functionality is required both for clients in the UI and on the middle layer (test data generator), it is also moved to a separate bin <code>BalanceWorker</code> . <br><br>  And the last service is <code>ReportService</code> .  It retrieves the data for the report by category, and returns it as a list of instances of the <code>CategoryAmount</code> non-persistent entity. <br><br>  On the middle layer, the <code>SampleDataGenerator</code> bin is also implemented, which is intended for generating test data.  For functionality of this kind, a complex UI is usually not required - it is enough to provide a call with the transfer of simple parameters, sometimes you need to display some state as a set of attributes.  In addition, only the administrator works with this, not the users of the system.  In this case, it is convenient to give the bean a JMX interface and call its methods from the JMX console built into the web client, or by connecting with any external JMX tool.  In our case, the bean has the <code>SampleDataGeneratorMBean</code> interface, and it is registered in the core module <code>spring.xml</code> . <br><br>  Notice that the <code>generateSampleData()</code> method of a bean is annotated as <code>@Authenticated</code> .  This means that when calling this method, a special system login will be executed and a user session will be present in the execution thread.  It is required in this case because the method creates and modifies entities through <code>EntityManager</code> , which, when saved, require the installation of their attributes <code>createdBy</code> , <code>updatedBy</code> - who <code>updatedBy</code> given instances.  On the other hand, the <code>removeAllData()</code> method, also called via the JMX interface, does not require authentication because it removes data using SQL queries through the <code>QueryRunner</code> and does not access the user session anywhere. <br><br>  In general, the obligatory check of the presence of the user session is performed only at the entrance to the middle layer from the client level - in the service interceptor.  Check or not to check the session and user rights at the level of middleware - the application developer decides, but in some cases the session is necessary because of the need to put the user name in the attributes of the audit entities.  In addition, user rights are always checked in <code>DataWorker</code> , a bin to which the <code>DataService</code> delegates the execution of CRUD operations with entities. <br><br><h2>  Main application window </h2><br>  The standard feature of the CUBA web client is a hidden panel on the left side of the application window, which usually displays so-called ‚Äúapplication folders‚Äù and ‚Äúsearch folders‚Äù.  These folders are used for quick access to information - clicking on the folder opens a specific screen with a list of entities and an overlay filter. <br><br>  It seemed to me logical to display information on the current balance in the left part of the main window.  Therefore, I have embedded the balance panel in the upper part of the folder panel. <br><img src="https://habrastorage.org/files/37d/88f/44e/37d88f44e77942d19bb00a42a4dc8458.PNG"><br><br>  This is done as follows: <br><ul><li>  The <code>FoldersPane</code> class is inherited from the platform <code>FoldersPane</code> , the <code>init()</code> and <code>refreshFolders()</code> methods are overridden, in which the <code>createBalancePanel()</code> method is <code>createBalancePanel()</code> .  It creates a new container, fills it with data from the <code>BalanceService</code> , and fits it at the top of the parent container. </li><li>  In <code>LeftPanel</code> use <code>LeftPanel</code> instead of the standard <code>FoldersPane</code> , the <code>AppWindow</code> class is inherited from the platform <code>AkkAppWindow</code> and the <code>createFoldersPane()</code> method is <code>createFoldersPane()</code> . </li><li>  So that in turn <code>AkkAppWindow</code> used instead of the standard <code>AppWindow</code> , the <code>createAppWindow()</code> method of the <code>App</code> class is overridden.  In addition, the method of access to the new panel <code>getLeftPanel()</code> is defined here - it is called from the screens to update the balance after a commit or delete operations. </li></ul><br><br><h2>  Operations Browser </h2><br>  The screen <code>operation-browse.xml</code> is located in the <code>operation-browse.xml</code> .  Everything is standard here, except for the use of formatter classes to represent dates and amounts in the table of operations. <br><br>  To display the date, a platform <code>DateFormatter</code> is used, which is sent to the format by a key from a package of localized messages.  Thus, the format string can be different for different languages ‚Äã‚Äã- for Russian, the date is divided by dots, and for English - with characters /. <br>  In order for the sums to be displayed without the fractional part, and 0 not to be displayed at all, the <code>DecimalFormatter</code> class was created in the project ‚Äî it is used in the sums columns. <br><br><h2>  Operation editor </h2><br>  Here it is more interesting: the operation can be one of three types (income, expense, transfer), and the editing screen should look different for them. <br><img src="https://habrastorage.org/files/776/32e/d27/77632ed2732b4c9bace064f37eae6c07.PNG"><br><img src="https://habrastorage.org/files/3ee/d51/e97/3eed51e97b2b49239b93e8cc4d841f84.PNG"><br><img src="https://habrastorage.org/files/fe1/afd/1b6/fe1afd1b6d3b45a2b984bb32ae855e02.PNG"><br><br>  At first glance, the first two screens appear to be the same, but in reality this is not the case: the visual components work with different attributes of the <code>Operation</code> entity ‚Äî consumption with <code>acc1</code> and <code>amount1</code> , income with <code>acc2</code> and <code>amount2</code> .  This variability could be implemented completely in the controller code, but I decided to make it more declarative - by separating the different parts of the screen into separate frames. <br><br>  Three frames - by the number of types of operations.  All of them are located in the same package as the operation editing screen itself.  Most often, frames are connected statically - using the <code>iframe</code> component in the XML screen descriptor.  It does not suit us, because we need to select the desired frame depending on the type of operation.  Therefore, in the XML descriptor of the <code>operation-edit.xml</code> , only the frame container is defined ‚Äî the <code>groupBox</code> component with the <code>frameContainer</code> identifier, and the frame itself is created and inserted into the screen in the <code>OperationEdit</code> controller: <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> GroupBoxLayout frameContainer; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> OperationFrame operationFrame; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Map&lt;String, Object&gt; params)</span></span></span><span class="hljs-function"> </span></span>{ ... String frameId = operation.getOpType().name().toLowerCase() + <span class="hljs-string"><span class="hljs-string">"-frame"</span></span>; operationFrame = openFrame(frameContainer, frameId, params);</code> </pre><br>  <code>OperationFrame</code> ‚Äî ,      .         ‚Äî    . <br><br>   <code>init()</code>  <code>OperationEdit</code>      ‚Äî  ,    : <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Map&lt;String, Object&gt; params)</span></span></span><span class="hljs-function"> </span></span>{ ... getDsContext().addListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DsContext.CommitListenerAdapter() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">afterCommit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CommitContext context, Set&lt;Entity&gt; result)</span></span></span><span class="hljs-function"> </span></span>{ LeftPanel leftPanel = App.getLeftPanel(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (leftPanel != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) leftPanel.refreshBalance(); } }); }</code> </pre><br>      ,   . <br><br>         ‚Äî  ,   ,     .    ,        ,     . <br><br>  <code>expense-frame.xml</code> .     <code>textField</code>   <code>amountField</code> .   <code>ExpenseFrame</code>   <code>AmountCalculator</code> ,      : <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TextField amountField; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AmountCalculator amountCalculator; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postInit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Operation item)</span></span></span><span class="hljs-function"> </span></span>{ amountCalculator.initAmount(amountField, item.getAmount1()); ‚Ä¶ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postValidate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ValidationErrors errors)</span></span></span><span class="hljs-function"> </span></span>{ BigDecimal value = amountCalculator.calculateAmount(amountField, errors); ‚Ä¶ }</code> </pre><br>   ,    Web Client,       .  <code>initAmount()</code>       ,     <code>BigDecimal</code> .   <code>datatype = decimal</code>   ,            ,         .  <code>calculateAmount()</code>       regexp,        Groovy   <code>Scripting</code> .   ,         . <br><br><h2>    </h2><br><img src="https://habrastorage.org/files/633/6db/2bc/6336db2bcc844ae88151c7954aadec0f.png"><br><br>      <code>categories-report.xml</code> .      ,        <code>CategoryAmountDatasource</code> .       <code>datasourceClass</code>  <code>collectionDatasource</code> .       JPQL-,        ,      ,    .      <code>CategoryAmountDatasource</code>   <code>loadData()</code>      <code>DataService</code>  JPQL-,    <code>ReportService</code> ,    : <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CategoryAmountDatasource</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CollectionDatasourceImpl</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CategoryAmount</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UUID</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ReportService service = AppBeans.get(ReportService.NAME); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Map&lt;String, Object&gt; params)</span></span></span><span class="hljs-function"> </span></span>{ ... Date fromDate = (Date) params.get(<span class="hljs-string"><span class="hljs-string">"from"</span></span>); Date toDate = (Date) params.get(<span class="hljs-string"><span class="hljs-string">"to"</span></span>); ... List&lt;CategoryAmount&gt; list = service.getTurnoverByCategories(fromDate, toDate, categoryType, currency.getCode(), ids); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (CategoryAmount categoryAmount : list) { data.put(categoryAmount.getId(), categoryAmount); } ... }</code> </pre><br>       <code>refresh()</code>   ‚Äî .  <code>refreshDs1()</code> , <code>refreshDs2()</code>  <code>CategoriesReport</code> .       <code>CategoryAmount</code> ,         data.   ,     ,   <code>CategoryAmount</code>    ,     . <br><br>     <b></b> ,      . <br><br>   <code>categories-report.xml</code>     ‚Äî     .       <code>excludeCategory</code>  .     XML-    .  How does this work?   ,           <code>init()</code>  : .  <code>initExcludedCategories()</code> .     ‚Äú‚Äù    ,     <code>UserDataService</code> . <br><br>   <code>ExcludeCategoryAction</code>     <code>excludeCategory()</code> ,   <code>ComponentsFactory</code>      -,   ,           <code>excludedBox</code> .     ,     ,       ,    .  ,   ,   . <br><br> ,          ,       ,        . <br><br><h2>  Thanks </h2><br>        <a href="https://zenmoney.ru/">zenmoney.ru</a> ,    .  open-source   ,    ,    <b>Help -&gt; About -&gt; Credits</b> . <br><br><h2>  To be continued </h2><br>              responsive UI,    Backbone.js + Bootstrap       REST API.  ,      UI     UI-,       . </div><p>Source: <a href="https://habr.com/ru/post/235617/">https://habr.com/ru/post/235617/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../235601/index.html">App Market for glasses Epson Moverio BT-200 (September, 2014)</a></li>
<li><a href="../235603/index.html">Eddie Osmani: The Paralysis of Choice</a></li>
<li><a href="../235607/index.html">As we were looking for an investor, "from scratch" created a company for developing mobile applications in St. Petersburg and ... mistakes that we made</a></li>
<li><a href="../235609/index.html">Amazon has released a fix for instances running under Windows Server 2012 R2, preventing the loss of network connections</a></li>
<li><a href="../235611/index.html">Github, Reddit and StackExchange offer standard Markdown syntax</a></li>
<li><a href="../235619/index.html">Epson SureColor SC-F2000: Epson's first textile printer</a></li>
<li><a href="../235623/index.html">Case Crocs: sales optimization of one hundred million. Part 2</a></li>
<li><a href="../235627/index.html">Sale of books from the series "Head First O'Reilly"</a></li>
<li><a href="../235629/index.html">Interview with the legend of sports programming Peter Mitrichev</a></li>
<li><a href="../235631/index.html">Tear down the TV tower</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>