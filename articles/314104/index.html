<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Docker: PostgreSQL configuration master-slave</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article, I talked about a project to automate the deployment of Docker containers , the development of which started earlier this year...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Docker: PostgreSQL configuration master-slave</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/463/c34/348/463c3434896740bea2b7f88752565ae6.jpg"><br><br>  In the previous <a href="https://habrahabr.ru/company/redmadrobot/blog/303118/">article,</a> I talked about a project to <a href="https://github.com/renskiy/fabricio">automate the deployment of Docker containers</a> , the development of which started earlier this year.  Several months have passed, Fabricio has been significantly improved and improved, and today I want to tell you about one of the latest innovations - about the automatic deployment of master-slave configurations for PostgreSQL. <br><br>  Running PostgreSQL in containers is not the most popular idea, and there is a rational explanation for this: there is no need to add <a href="http://stackoverflow.com/questions/21889053/what-is-the-runtime-performance-cost-of-a-docker-container">additional network delays</a> to an already rather loaded service.  But there are a number of cases when such a solution can still be applied.  For example, when <s>you fully trust the Docker</s> DB, it does not experience serious workloads, but the possibility of duplicating / replicating stored data to several servers is important.  Or just to test and debug the settings before applying them to the combat servers. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order not to bore the reader (and user) with a large amount of textual information, I decided that it would be nice to give ‚Äúlive‚Äù <a href="https://github.com/renskiy/fabricio/tree/master/examples">examples of using Fabricio</a> on actually working containers ‚Äî you will agree ‚Äî it's better to see it once. <br><a name="habracut"></a><br>  <a href="https://github.com/renskiy/fabricio/tree/master/examples/db/postgres/master_slave">The master-slave configuration example for PostgreSQL is</a> implemented on three virtual machines in which Docker is installed.  The creation and initial setup of these virtual machines are fully automated with Vagrant, so there should be no difficulty with running the example. <br><br><h2>  Implemented scripts </h2><br>  The most important scenario in the case of the master-slave configuration is undoubtedly the recovery of the database after the master (master) server fails.  As a rule, on combat systems this is configured using systems of permanent monitoring of existing servers and automatic switching / exclusion of failed hosts - failover.  For example, for these purposes you can use the <a href="http://www.pgpool.net/mediawiki/index.php/Main_Page">pgpool-II</a> tool, <a href="http://www.pgpool.net/mediawiki/index.php/Main_Page">which is</a> popular today.  However, setting up such systems is not a trivial task (and not all of them are completely reliant on automation), so you can often find configurations that do without automatic recovery after a crash.  If a failure in such systems still occurs, then it is eliminated, as a rule, in manual or semi-automatic mode by restoring the database from the backup copy and / or switching the application configs to the address of the new database master. <br><br>  Fabricio offers a semi-automatic way to recover from a master failure.  To do this, you need to execute just one command, after making sure that the failed server was replaced with a new one, or deleted from the configuration of the deployment configuration: <br><br><pre><code class="bash hljs">fab --parallel db</code> </pre> <br>  Not much different from the above option, the scenario of adding a new slave server to the configuration, for this it is enough to write the address of this server in the list of hosts of Fabricio and re-launch the deployment command.  The initial state of the database will be copied from the current master server. <br><br><div class="spoiler">  <b class="spoiler_title">Idempotency test</b> <div class="spoiler_text"> <code>[vagrant@192.168.1.85] Executing task 'update' <br> [vagrant@192.168.1.86] Executing task 'update' <br> [vagrant@192.168.1.87] Executing task 'update' <br> [vagrant@192.168.1.85] Found master: 192.168.1.85 <br> [vagrant@192.168.1.85] download: &lt;file obj&gt; &lt;- /data/postgresql.conf <br> [vagrant@192.168.1.85] /data/postgresql.conf not changed <br> [vagrant@192.168.1.85] download: &lt;file obj&gt; &lt;- /data/pg_hba.conf <br> [vagrant@192.168.1.86] Waiting for master info (10 seconds)... <br> [vagrant@192.168.1.85] /data/pg_hba.conf not changed <br> [vagrant@192.168.1.85] run: docker inspect --type container postgres <br> [vagrant@192.168.1.87] Waiting for master info (10 seconds)... <br> [vagrant@192.168.1.85] run: docker inspect --type image postgres:9.6 <br> [vagrant@192.168.1.85] run: docker start postgres <br> [vagrant@192.168.1.86] download: &lt;file obj&gt; &lt;- /data/recovery.conf <br> [vagrant@192.168.1.87] download: &lt;file obj&gt; &lt;- /data/recovery.conf <br> [vagrant@192.168.1.87] /data/recovery.conf not changed <br> [vagrant@192.168.1.86] /data/recovery.conf not changed <br> [vagrant@192.168.1.87] download: &lt;file obj&gt; &lt;- /data/postgresql.conf <br> [vagrant@192.168.1.86] download: &lt;file obj&gt; &lt;- /data/postgresql.conf <br> [vagrant@192.168.1.87] /data/postgresql.conf not changed <br> [vagrant@192.168.1.86] /data/postgresql.conf not changed <br> [vagrant@192.168.1.86] download: &lt;file obj&gt; &lt;- /data/pg_hba.conf <br> [vagrant@192.168.1.87] download: &lt;file obj&gt; &lt;- /data/pg_hba.conf <br> [vagrant@192.168.1.87] /data/pg_hba.conf not changed <br> [vagrant@192.168.1.86] /data/pg_hba.conf not changed <br> [vagrant@192.168.1.87] run: docker inspect --type container postgres <br> [vagrant@192.168.1.86] run: docker inspect --type container postgres <br> [vagrant@192.168.1.87] run: docker inspect --type image postgres:9.6 <br> [vagrant@192.168.1.86] run: docker inspect --type image postgres:9.6 <br> [vagrant@192.168.1.87] run: docker start postgres <br> [vagrant@192.168.1.86] run: docker start postgres <br> [vagrant@192.168.1.87] No changes detected, update skipped. <br> [vagrant@192.168.1.85] No changes detected, update skipped. <br> [vagrant@192.168.1.86] No changes detected, update skipped. <br> <br> Done. <br> Disconnecting from vagrant@127.0.0.1:2222... done. <br> Disconnecting from vagrant@127.0.0.1:2200... done. <br> Disconnecting from vagrant@127.0.0.1:2201... done. <br></code> <br></div></div><br>  For test needs, Fabricio also supports configuration deployment from scratch, selecting wizards randomly from the list of available hosts. <br><br><h2>  Features of the implementation </h2><br>  Automatic wizard detection requires running Fabricio in parallel execution mode, which is disabled by default.  This is what the option <b>--parallel</b> is used in the deployment team. <br><br>  If at least one of the slaves has its own non-empty data folder (determined by the presence of the PG_VERSION file), automatic selection (promotion) of the new master is not performed by default (the script ends with a corresponding error).  Although this procedure is quite safe, it is still recommended to familiarize yourself with the algorithm for selecting a new wizard before enabling this option.  And then the master is selected in such a case randomly among those hosts that have at least some data, while the data on the ‚Äúempty‚Äù hosts (that is, not having their own database) will be copied from the new master. <br><br>  Also, without a special instruction, a rollback to the previous state does not work, due to the fact that the master-slave configuration does not provide for such a scenario at all - after all, the master does not automatically fix it, and if any error occurred, then it is better to repair it manually, and not rely on automation.  If the rollback option is still enabled, then the rollback logic inherited from the parent class (PostgreSQL single configuration) will be used - returning the previous configs and / or the previous container (or containers) depending on what was updated during the last successful deployment. <br><br><h2>  Future plans </h2><br>  In the very near future, most likely by the end of the year, <a href="https://github.com/renskiy/fabricio/issues/38">support for Swarm mode</a> in Docker version 1.12 or higher will be implemented.  This will make it possible with Fabricio to deploy not only individual containers, but at once whole services with automatic scaling and fault tolerance. <br><br>  After implementing the solution for Swarm, it will be logical to start supporting Kubernetes and / or Mesos.  But there is no separate task for this yet, and everything will depend on the complexity of implementation. </div><p>Source: <a href="https://habr.com/ru/post/314104/">https://habr.com/ru/post/314104/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314086/index.html">Create interactive charts with R and Highcharts</a></li>
<li><a href="../314088/index.html">mgr-forms-react: Simple component for simple forms</a></li>
<li><a href="../314094/index.html">Paul Graham pushes the government: 95% of the world's excellent programmers are out of work, let them in</a></li>
<li><a href="../314096/index.html">Paul Graham thought about death and updated his todo list</a></li>
<li><a href="../314100/index.html">Software Cost Estimation: Dan Galloth and SEER-SEM</a></li>
<li><a href="../314106/index.html">How we started a failover cluster</a></li>
<li><a href="../314108/index.html">Remotely enable Mikrotik scripts from Telegram</a></li>
<li><a href="../314110/index.html">Repository Pattern via CSLA .NET</a></li>
<li><a href="../314112/index.html">US authorities allowed researchers to do pentest and reverse engineering without legal consequences</a></li>
<li><a href="../314114/index.html">Enum in PHP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>