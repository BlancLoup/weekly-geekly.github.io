<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Plugin system example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I came up with the task of developing a system of plug-ins (add-ins) to the program. A little digging AddIn which have been proposed since. NET 3.5, I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Plugin system example</h1><div class="post__text post__text-html js-mediator-article">  I came up with the task of developing a system of plug-ins (add-ins) to the program.  A little digging AddIn which have been proposed since. NET 3.5, I realized that they do not suit me.  Firstly, this is not a convenient location of directories, a lot of unnecessary.  Secondly, it is not possible to infiltrate into any part of the process and do it your way, i.e.  weak extensibility. <br>  And I decided to invent a bicycle ... <a name="habracut"></a><br><br>  The basis I put isolation from the main application and the possibility of a sandbox.  This is all not difficult to do by creating a new AppDomain and configuring it on InternetZone.  But during development I encountered a problem when loading an assembly with a plugin into a domain.  The problem was a link error.  For download, I use AppDomain.Load ().  As it turned out later, this method does not suit me.  In this, I had to make a small crutch, which I will tell you about. <br><br>  Start by creating a new project and a console application (I called it PluginHost) and add another project class library (let's call it PluginFramework).  Add a class to the library: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> Plugin: MarshalByRefObject { <font color="#0000ff">public</font> <font color="#0000ff">virtual</font> <font color="#0000ff">void</font> Initialize() { } }</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <ol><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">public</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> Plugin: MarshalByRefObject { <font color="#0000ff">public</font> <font color="#0000ff">virtual</font> <font color="#0000ff">void</font> Initialize() { } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">public</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> Plugin: MarshalByRefObject { <font color="#0000ff">public</font> <font color="#0000ff">virtual</font> <font color="#0000ff">void</font> Initialize() { } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">public</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> Plugin: MarshalByRefObject { <font color="#0000ff">public</font> <font color="#0000ff">virtual</font> <font color="#0000ff">void</font> Initialize() { } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">public</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> Plugin: MarshalByRefObject { <font color="#0000ff">public</font> <font color="#0000ff">virtual</font> <font color="#0000ff">void</font> Initialize() { } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">public</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> Plugin: MarshalByRefObject { <font color="#0000ff">public</font> <font color="#0000ff">virtual</font> <font color="#0000ff">void</font> Initialize() { } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">public</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> Plugin: MarshalByRefObject { <font color="#0000ff">public</font> <font color="#0000ff">virtual</font> <font color="#0000ff">void</font> Initialize() { } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> </ol> <code><font color="gray"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> Plugin: MarshalByRefObject { <font color="#0000ff">public</font> <font color="#0000ff">virtual</font> <font color="#0000ff">void</font> Initialize() { } }</font> * This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  And one more class, without which it was difficult to implement the logic I needed: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">public</font> <font color="#0000ff">class</font> AssemblyHelper: MarshalByRefObject </li><li>  { </li><li>  <font color="#0000ff">private</font> AppDomain _currentDomain; </li><li>  <font color="#0000ff">public</font> AssemblyHelper () </li><li>  { </li><li>  _currentDomain = AppDomain.CurrentDomain; </li><li>  _currentDomain.AssemblyResolve + = <font color="#0000ff">new</font> ResolveEventHandler (_currentDomain_AssemblyResolve); </li><li>  } </li><li></li><li>  <font color="#2B91AF">Assembly</font> _currentDomain_AssemblyResolve ( <font color="#0000ff">object</font> sender, ResolveEventArgs e) </li><li>  { </li><li>  <font color="#0000ff">string</font> [] nameSplit = e.Name.Split ( <font color="#A31515">','</font> ); </li><li>  <font color="#0000ff">string</font> path = Path.Combine (SearchFolder, nameSplit [0] + <font color="#A31515">".dll"</font> ); </li><li>  <font color="#2B91AF">Assembly</font> loadedAssembly; </li><li>  <font color="#0000ff">try</font> </li><li>  { </li><li>  loadedAssembly = <font color="#2B91AF">Assembly</font> .LoadFile (path); </li><li>  } </li><li>  <font color="#0000ff">catch</font> (Exception exc) </li><li>  { </li><li>  Exception exp = exc; </li><li>  <font color="#0000ff">throw</font> ; </li><li>  } </li><li>  <font color="#0000ff">if</font> (loadedAssembly! = <font color="#0000ff">null</font> ) </li><li>  { </li><li>  <font color="#0000ff">return</font> loadedAssembly; </li><li>  } </li><li>  <font color="#0000ff">else</font> </li><li>  { </li><li>  <font color="#0000ff">return</font> <font color="#0000ff">null</font> ; </li><li>  } </li><li>  } </li><li></li><li>  <font color="#0000ff">public</font> <font color="#0000ff">string</font> SearchFolder { <font color="#0000ff">get</font> ;  <font color="#0000ff">set</font> ;  } </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  Base frame is ready.  Not a big digression what I actually wanted to achieve: <br>  1. Once again isolation from the main application <br>  2. At any time loading and unloading the plugin.  If for example the plugin has fallen, we will simply unload it and reload it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What we have in Main: <br>  First, I load the PluginFramework assembly in reflection-only mode and get the Type of our base class for all plugins: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#2B91AF">Assembly</font> frameworkReflect = <font color="#2B91AF">Assembly</font> .ReflectionOnlyLoadFrom (Path.Combine (Environment.CurrentDirectory, <font color="#A31515">"PluginFramework.dll"</font> )); </li><li>  Type basePluginType = frameworkReflect.GetType ( <font color="#A31515">"MyPluginSample.Framework.Plugin"</font> ); </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  Then search all available folders. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">string</font> pathPlugins = Path.Combine (Environment.CurrentDirectory, <font color="#A31515">"Plugins"</font> ); </li><li>  DirectoryInfo directoryPlugins = <font color="#0000ff">new</font> DirectoryInfo (pathPlugins); </li><li>  <font color="#0000ff">foreach</font> ( <font color="#0000ff">var</font> dir <font color="#0000ff">in</font> directoryPlugins.GetDirectories ()) </li><li>  { </li><li>  FileInfo dllFile = dir.GetFiles (dir.Name + <font color="#A31515">".dll"</font> ) .First (); </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  And again I load the assembly in the mode only for reflection, but already with the plugin and am looking for a class that inherits from the base class Plugin.  So that we could load the assembly with the plugin here and compare it with the base type we had to load PluginFramework at the beginning too, just for reflection. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#2B91AF">Assembly</font> reflectionAsm = <font color="#2B91AF">Assembly</font> .ReflectionOnlyLoadFrom (dllFile.FullName); </li><li>  Type typePlugin = reflectionAsm.GetTypes (). First (t =&gt; t.IsSubclassOf (basePluginType)); </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  Now you can start creating a new domain, load everything you need into it and launch our plugin for execution <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  AppDomain pluginDomain = AppDomain.CreateDomain (dir.Name + <font color="#A31515">"plugin"</font> ); </li><li>  AssemblyHelper helper = (AssemblyHelper) pluginDomain.CreateInstanceAndUnwrap ( <font color="#A31515">"PluginFramework"</font> , <font color="#A31515">"MyPluginSample.Framework.AssemblyHelper"</font> ); </li><li>  helper.SearchFolder = dir.FullName; </li><li>  Plugin plugin = (Plugin) pluginDomain.CreateInstanceAndUnwrap (reflectionAsm.FullName, typePlugin.FullName); </li><li>  plugin.Initialize (); </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  That's all! <br>  And write a test plugin to check <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">public</font> <font color="#0000ff">class</font> MyPlugin1: Plugin </li><li>  { </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">void</font> Initialize () </li><li>  { </li><li>  <font color="#2B91AF">Console</font> .WriteLine ( <font color="#A31515">"Executing in Plugin 1. Domain Id: {0}"</font> , AppDomain.CurrentDomain.Id); </li><li>  } </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  The directory structure is as follows <br> <a title="Habraffe.ru" href=""><img src="https://habrastorage.org/storage/habraeffect/3b/75/3b75ca3a0116c916770a664f3ea0d8d5.png"></a> <br><br>  Link to source <a href="http://narod.ru/disk/23265022000/PluginSystem.zip.html">PluginSystem.zip</a> <br><br>  <b>PS</b> I load the assemblies for reflection, because if we simply load the assembly into a new domain, we will not be able to go through it from the child domain and find the class we need.  The CLR will attempt to load this build into the child domain. </div><p>Source: <a href="https://habr.com/ru/post/101547/">https://habr.com/ru/post/101547/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../101539/index.html">University editors will learn to use statistics</a></li>
<li><a href="../101540/index.html">Health and coding - how to combine?</a></li>
<li><a href="../101541/index.html">Who gets funding for Internet startups?</a></li>
<li><a href="../101544/index.html">Versioning and data history</a></li>
<li><a href="../101545/index.html">Granin. This strange life</a></li>
<li><a href="../101548/index.html">Toshiba Media Controller - now for Apple iPhone and iPod touch users</a></li>
<li><a href="../101549/index.html">IPhone Fourth is afraid of heat</a></li>
<li><a href="../101550/index.html">Interviews with Techdays winners</a></li>
<li><a href="../101552/index.html">Commercial software with a free past</a></li>
<li><a href="../101553/index.html">Comstar UTS: Arbitrage or speculation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>