<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pro Video Compression - Introduction</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Days go by, video quality requirements are constantly increasing. At the same time, the width of the channels and the capacity of the carriers could n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pro Video Compression - Introduction</h1><div class="post__text post__text-html js-mediator-article">  Days go by, video quality requirements are constantly increasing.  At the same time, the width of the channels and the capacity of the carriers could not keep up with this growth if the video compression algorithms had not been improved. <br>  Then we will talk about some basic concepts of video compression.  Some of them are somewhat outdated or described too simply, but at the same time they give a minimal idea of ‚Äã‚Äãhow everything works. <br><br><img src="https://habrastorage.org/storage/habraeffect/85/58/8558e8e1546c41ffa686da9f0a987366.png" alt="image"><br>  <i>Search for motion vectors to compensate for motion (-: More on this ...</i> <br><a name="habracut"></a><br><h4>  Characteristics of the video stream </h4><br>  Almost everyone knows that any video is a set of static pictures that will replace each other in time.  Further we will call this ordered set a video stream.  They are different, so here it is extremely useful to conduct a small classification: <br><ul><li>  <b>Pixel format</b>  Pixel does not give us any information except its color.  However, color perception is highly subjective and great efforts have been made to create color presentation and color rendering systems that would be acceptable to most people.  So, the color that we see in the real world is quite complex in the frequency spectrum of light, which is extremely difficult to transmit in digital form, and even harder to display.  However, it was noted that all three points in the spectrum can accurately approximate the displayed color to the present in the color perception metric of an ordinary person.  These three points are red, green and blue.  That is, with their linear combination we can cover most of the visible color spectrum.  Therefore, the easiest way to represent a pixel is <b>RGB24</b> , where exactly 8 bits of information are allocated to the Red, Green and Blue components.  And so we can convey 256 gradations of each color and a total of 16,777,216 different shades.  But in practice during storage such color representation is practically not used, not only because we spend as much as 3 bytes per pixel, but for other reasons, but more on that later (about <b>YV12</b> ). </li><li>  <b>Frame size</b> .  We have already taken and encoded all the pixels of the video stream and received a huge array of data, but it is inconvenient in operation.  At first, everything is very simple, the frame is characterized by: width, height, dimensions of the visible part and format (more on that later).  There will surely be a lot of familiar figures for the numbers: <b>640x480, 720x480, 720x576, 1280x720, 1920x1080</b> .  Why?  Yes, because they appear in different standards, for example, the resolution of 720x576 has most of the European DVDs.  No, of course, you can make a 417x503 video, but I don‚Äôt think there‚Äôs anything good in it. </li><li>  <b>Frame format</b> .  Even knowing the size of the frame, we can not imagine an array of pixels in a more convenient form, without having information about the way the frame is ‚Äúwrapped‚Äù.  In the simplest case, nothing tricky: take a row of pixels and write out in a row the bits of each encoded pixel and so line by line.  That is, we write out as many lines as we have a height of as many pixels as we have width and everything in a row, in order.  Such a sweep is called <b>progressive</b> .  But maybe you tried to watch TV shows on your computer without proper adjustments and saw the ‚Äúcomb effect‚Äù, this is when the same object is in different positions with respect to even and odd lines.  One can argue about the expediency of <b>interlaced</b> scanning for a very long time, but the fact is that it remains as a relic of the past from traditional television (for whom it is interesting to read about the device of a kinescope).  About the methods of elimination ( <b>deinterlacing</b> ) of this unpleasant effect I will not speak now.  From here come the magic symbols: <b>576i, 720p, 1080i, 1080p</b> , where the number of lines (frame height) and the type of scanning are indicated. </li><li>  <b>Frame rate</b> .  Some of the standard values ‚Äã‚Äãare <b>23.976, 24, 25, and 29.97</b> frames per second.  For example, 25 fps is used in European television, 29.97 in the US, and at a frequency of 24 fps is filmed.  But where did the ‚Äústrange‚Äù 23.976 and 29.97 come from?  I will reveal the secret: 23.976 = 24 / 1.001, and 29.97 = 30 / 1.001, that is, the divider 1.001 is incorporated into the standard of the American television broadcasting NTSC.  Accordingly, when a film is shown, there will be a very slight slowdown, which will not be noticeable to the viewer, but if this is a musical concert, the speed of the show is so critical that it is better to skip frames occasionally and again the viewer will not notice anything.  Although I was a little deceived, ‚Äú24‚Äù frames per second are never shown on American television, but ‚Äú30‚Äù interlaced frames are shown (and that 59.94 frames per second, which corresponds to the frequency of their electrical network), but they are obtained by the ‚Äúdescent method‚Äù ( <b>3: 2 pulldown</b> ).  The essence of the method is that we have 2 full frames and 5 half-frames, and we fill in the first 3 half-frames from the first frame, and the remaining 2 from the second frame. That is, the sequence of the half-frames is as follows: [1 top, 1 bottom], [1 top, 2 bottom], [2 top, 3 bottom], [3 top, 3 bottom], [4 top, 4 bottom], etc.  Where top - the top lines ( <b>fields, fields</b> ), and bottom bottom, that is, odd and even starting from the top, respectively.  Thus, the film picture is quite watchable on TV, but twitching is noticeable on dynamic scenes.  The frame rate may be variable, but many problems are connected with it, so I will not consider this case. </li><li>  <b>Global characteristics</b> .  All the above concerns local properties, that is, those that are reflected during playback.  But the <b>duration of the video stream</b> over time, the amount of data, the availability of additional information, dependencies, etc.  For example: a video stream may contain one stream corresponding to the left eye, and another stream will in some way store information about the difference between the flow of the right eye from the left eye.  So you can transmit stereo video or popularly known ‚Äú3D‚Äù. </li></ul><br><h4>  Why do I need to compress video? </h4><br>  If we transmit video uncompressed, then no matter what is serious, we will not have enough communication channels or space to store data.  Suppose we have an HD stream with characteristics: <br>  1920x1080p, 24 fps, RGB24 and calculate the ‚Äúcost‚Äù of such a stream. <br>  1920 * 1080 * 24 * 24 = 1139 Megabit / s, and if we want to record a 90 minute film, then we need 90 * 60 * 1139 = 750 GB!  Cool?  This is despite the fact that a video of amazing quality with the same 1920x1080p on BluRay will occupy 20 GB, that is, the difference is almost 40 times! <br>  Obviously, the video requires compression, especially given the fact that you can reduce the size of 40 or more times, while leaving the viewer in awe. <br><br><h4>  What can you save? </h4><br><ul><li> <b>Color coding</b> .  Surely many people know that once upon a time television was black and white, but today's television is entirely in color.  But a black and white TV can still show programs.  The fact is that in the television signal the brightness is coded separately from the color components and is presented in the <b>YUV</b> format (for more details, see Wikipedia).  Where Y component is brightness, and U and V are color components, and all this is calculated by the ‚Äúmagic‚Äù formula: <br> <code>Y = 0.299 * R + 0.587 * G + 0.114 * B <br> U = -0.14713 * R - 0.28886 * G + 0.436 * B <br> V = 0.615 * R - 0.51499 * G - 0.10001 * B</code> <br>  As can be seen, the transformation is linear and nondegenerate.  Consequently, we can easily get back the values ‚Äã‚Äãof R, G and B. Assume that under storage of Y, U and V we allocate 8 bits each, then there were 24 bits per pixel and that‚Äôs it.  No savings.  But the human eye is sensitive to brightness, but to color it is not very pretentious.  Yes, and almost all images of colors replace each other less often.  If we conditionally divide the image into Y, U, and V layers and leave the luminance layer unchanged, and reduce U and V layers by two times in height and two times in width and four times.  If earlier 24 bits were spent on each pixel, now we spend 8 * 4 + 8 + 8 = 48 bits per 4 pixels, that is, roughly speaking, 12 bits per pixel (that is why this encoding format is called <b>YV12</b> ).  Due to the <b>color thinning,</b> we squeezed the flow twice without any special losses.  For example, JPEG always performs a similar conversion, but compared to other possible artifacts, thinning the color does not bear any harm. </li><li>  <b>Image redundancy</b> .  I will not dwell here especially since there are no differences from image compression algorithms.  The same JPEG compresses the image due to its local redundancy by the methods of <b>discrete cosine transform (DCT) and quantization</b> , which again can be read on wikipedia.  I will only mention that the static image compression algorithm built into the codec should compress well even remotely resembling real images, you will soon find out why. </li><li>  <b>Interframe difference</b> .  Surely, anyone looking at any video will notice that the images do not change dramatically, and the neighboring frames are quite similar.  Of course, there are abrupt changes, but they usually occur when changing scenes.  And here a problem arises: how should a computer represent all the variety of possible image transformations?  The <b>motion compensation</b> algorithm comes to the rescue.  About him I wrote <a href="http://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25BC%25D0%25BF%25D0%25B5%25D0%25BD%25D1%2581%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F_%25D0%25B4%25D0%25B2%25D0%25B8%25D0%25B6%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F">an article</a> on wikipedia.  In order not to make copy-paste, I will confine myself to the main points.  The image is divided into blocks and in the neighborhood of each of them a similar block is searched for in another frame ( <b>motion estimation</b> ), this is how the field of motion vectors is obtained.  And already at compensation ( <b>motion compensation</b> ) the <b>motion</b> vectors are taken into account, and an image as a whole similar to the original frame is created. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage/habraeffect/af/49/af4914c9c43d50f06bd79415adbb35e2.png" alt="image"><br>  <i>Difference before motion compensation</i> <br><br><img src="https://habrastorage.org/storage/habraeffect/5a/c8/5ac8f0b86dd5434a1ec58b16e6946b20.png" alt="image"><br>  <i>Difference between original and compensated frames</i> <br><br>  Here it is clearly seen that the initial interframe difference is much larger than the difference between the original and compensated frames.  Given the amount of information when compressing images, we can save motion vectors almost for free.  They did this and then squeezed the image of the compensated interframe difference with a static image compression algorithm.  And since the second picture is a blatant mess, the image compression algorithm should work correctly with such things.  Due to the large redundancy of such images, they compress very strongly.  But if the codec compresses them too much, then the blockiness effect occurs.  The old algorithms do not take into account the changes in the objects in brightness and that is why the blockiness of the president is visible on TV during camera flashes. </li><li>  <b>The organization of sequences of frames</b> .  First of all, the codec should be sensitive to scene changes.  To determine this is quite simple, since the motion compensation will work in this case ugly.  The frame of the beginning of the new scene is logical to keep ‚Äúas it is‚Äù, since it does not look like anything previously encountered.  Such frames are called reference frames ( <b>I-frame</b> ).  And then there are frames to which motion compensation was applied, that is, they depend on the reference frame and from each other.  It can be <b>P-frame</b> or <b>B-frame</b> .  The former can only rely on the previous frames, and the latter can on the left and right neighbor.  The I-frame and all its dependencies form a <b>GOP</b> (group of pictures).  The advantages of using bi-frames are as follows: fast navigation (because previous bi-frames do not need to be decoded) and the fact that they have the smallest size among all movie frames, well, a little lower quality (but fast alternation with higher-quality frames makes it unobtrusive to the viewer). </li><li>  <b>Output redundancy</b> .  Even after performing all the compression procedures, the flow of coefficients has redundancy.  Further different lossless compression methods can be applied.  In the H.264 codec, for example, there are two variants of <b>CABAC</b> and <b>CAVLC</b> that implement arithmetic compression with a powerful probabilistic model and implement Huffman with a simpler model.  For unclear reasons, Apple prefers the latter option, although on good decoders the difference in performance is insignificant. </li></ul><br><h4>  Instead of conclusion </h4><br>  I tried to tell some basic concepts, not much loading with technical details.  Next, I will talk about the structure of codecs, containers, etc.  For those who are seriously interested in the compression and processing of video data there is a website compression.ru, supported by the native laboratory of computer graphics and multimedia VMK MSU. <br>  To be continued‚Ä¶ </div><p>Source: <a href="https://habr.com/ru/post/111244/">https://habr.com/ru/post/111244/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111238/index.html">[Programming] Working with the status bar in Android</a></li>
<li><a href="../111239/index.html">Working with sockets in Qt</a></li>
<li><a href="../111241/index.html">FTP protocol + WinSocks on the example of a simple FTP client (mirror) on ASM!</a></li>
<li><a href="../111242/index.html">Symfony Code'n'Coffee Minsk (Belarus) Jan 2011</a></li>
<li><a href="../111243/index.html">Evernote: 2010 in numbers</a></li>
<li><a href="../111246/index.html">Lab DC power supply from power supply</a></li>
<li><a href="../111249/index.html">Video hosting with their own hands</a></li>
<li><a href="../111252/index.html">Comet ‚Äì application for Mochiweb with a load of 1 000 000 users. Part 1/3</a></li>
<li><a href="../111253/index.html">New generation media</a></li>
<li><a href="../111254/index.html">PHP 5.2.17 and 5.3.5 release</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>