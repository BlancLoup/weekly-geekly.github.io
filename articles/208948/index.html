<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Improving export to Excel for SharePoint</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The standard ability to export to Excel in SharePoint works in a rather unusual way. When you click on the export button, SharePoint sends the request...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Improving export to Excel for SharePoint</h1><div class="post__text post__text-html js-mediator-article">  The standard ability to export to Excel in SharePoint works in a rather unusual way.  When you click on the export button, SharePoint sends the request file in a special format that opens Excel, and Excel itself already tightens the data. <br><br>  The advantage of this approach is that the data in Excel can be updated, since there is a connection.  But more disadvantages: <br><br><ul><li>  You need Excel installed on your computer to get the data. </li><li>  In the resulting document, the InternalName fields are used for the column names. </li><li>  The resulting document uses the ‚Äúraw‚Äù data format, which is not always suitable. </li></ul><br>  Using a small amount of code, you can replace the standard export function with your own, so that users will not notice anything. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  The substitution of export buttons </h4><br>  To replace an existing item in the Ribbon, add a new <code>CommandUIDefinition</code> with the <code>Location</code> parameter equal to the Id of the existing item.  All standard elements are in the file <code>C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\ <b>14</b> \TEMPLATE\GLOBAL\XML\CMDUI.XML</code> for SharePoint 2010 (or <b>15</b> for SharePoint 2013). <br><br>  In order to replace the export buttons in Excel, you need to find the buttons with Id equal to <code>Ribbon.List.Actions.ExportToSpreadsheet</code> and <code>Ribbon.Library.Actions.ExportToSpreadsheet</code> and completely copy to your project.  As a <code>Location</code> for new items, you must specify these Id. <br><br><div class="spoiler">  <b class="spoiler_title">A lot of copy-paste</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CommandUIDefinitions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CommandUIDefinition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Location</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Ribbon.Library.Actions.ExportToSpreadsheet"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Ribbon.Library.Actions.ExportToSpreadsheet-Replacement"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Sequence</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"40"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ExportToSpreadsheet-Replacement"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Image16by16</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/_layouts/$Resources:core,Language;/images/formatmap16x16.png"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Image16by16Top</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"-152"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Image16by16Left</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"-32"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Image32by32</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/_layouts/$Resources:core,Language;/images/formatmap32x32.png"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Image32by32Top</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"-352"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Image32by32Left</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">LabelText</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$Resources:core,cui_ButExportToSpreadsheet;"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ToolTipTitle</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$Resources:core,cui_ButExportToSpreadsheet;"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ToolTipDescription</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$Resources:core,cui_STT_ButExportListToSpreadsheet;"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TemplateAlias</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"o2"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CommandUIDefinition</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CommandUIDefinition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Location</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Ribbon.List.Actions.ExportToSpreadsheet"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Ribbon.List.Actions.ExportToSpreadsheet-Replacement"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Sequence</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"40"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ExportToSpreadsheet-Replacement"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Image16by16</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/_layouts/$Resources:core,Language;/images/formatmap16x16.png"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Image16by16Top</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"-152"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Image16by16Left</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"-32"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Image32by32</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/_layouts/$Resources:core,Language;/images/formatmap32x32.png"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Image32by32Top</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"-352"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Image32by32Left</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">LabelText</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$Resources:core,cui_ButExportToSpreadsheet;"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ToolTipTitle</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$Resources:core,cui_ButExportToSpreadsheet;"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ToolTipDescription</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$Resources:core,cui_STT_ButExportListToSpreadsheet;"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TemplateAlias</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"o1"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CommandUIDefinition</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CommandUIDefinitions</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  There is also a separate button for the calendar with <code>Id="Ribbon.Calendar.Calendar.Actions.ExportToSpreadsheet"</code> , you can do the same with it. <br><br><h4>  Creating control </h4><br>  The button should call some server code.  To make the behavior similar to the standard button, it is best to do <i>DelegateControl</i> , which will be placed on each page.  For this there is a container with <code>Id="AdditionalPageHead"</code> : <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Control</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"AdditionalPageHead"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Sequence</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1000"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ControlAssembly</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$SharePoint.Project.AssemblyFullName$"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ControlClass</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$SharePoint.Type.7fd7c6f0-4eda-48ce-ac8f-aa9f9d2666ac.FullName$"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br>  The custom button will call <i>PostBack</i> , processed by our control.  The button can be pressed on the list view page, then no additional parameters need to be passed.  Also, list views can be added to regular pages as web parts, then you need to transfer the list Id and views to the server. <br><br>  Alas, getting the Id of the view in which the button was pressed is not a trivial task.  Therefore, I will confine myself to the transfer of the Id list <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CommandUIHandlers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CommandUIHandler</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ExportToSpreadsheet-Replacement"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">CommandAction</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"javascript:(function(){var x=SP.ListOperation.Selection.getSelectedList(); if (x) {__doPostBack('ExportToSpreadsheet-Replacement', x);}})();"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CommandUIHandlers</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Next on the server, you need to check whether the button is pressed on the list view page or on the regular page: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnLoad</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Page.Request[<span class="hljs-string"><span class="hljs-string">"__EVENTTARGET"</span></span>] == <span class="hljs-string"><span class="hljs-string">"ExportToSpreadsheet-Replacement"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> spContext = SPContext.Current; SPList list; SPView view; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (spContext.ViewContext.View != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { list = spContext.List; view = spContext.ViewContext.View; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> listId = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Guid(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Page.Request[<span class="hljs-string"><span class="hljs-string">"__EVENTARGUMENT"</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> web = spContext.Web; list = web.Lists[listId]; view = list.DefaultView; } ExportData(list.Title + <span class="hljs-string"><span class="hljs-string">" - "</span></span> + view.Title, GetDataTable(list, view)); } }</code> </pre><br><br>  Getting the data table by view is very simple: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> System.Data.<span class="hljs-function"><span class="hljs-function">DataTable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDataTable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SPList list, SPView view</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SPQuery(view); SPListItemCollectionPosition position; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> flags = SPListGetDataTableOptions.UseBooleanDataType | SPListGetDataTableOptions.UseCalculatedDataType; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = list.GetDataTable(query, flags, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> position); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (position != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { list.AppendDataTable(query, flags, result, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> position); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br><br><h4>  Excel file generation </h4><br><br>  The last step is to create an Excel file and give it to the client.  One of the easiest ways to generate Excel is to use the ClosedXml library ( <a href="http://closedxml.codeplex.com/">http://closedxml.codeplex.com/</a> ). <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExportData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> title, System.Data.DataTable table</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XLWorkbook(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ws = wb.Worksheets.Add(title); ws.Cell(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>).InsertTable(table); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> response = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Page.Response; response.Clear(); response.ContentType = <span class="hljs-string"><span class="hljs-string">"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filename = title+<span class="hljs-string"><span class="hljs-string">".xlsx"</span></span>; response.AddHeader(<span class="hljs-string"><span class="hljs-string">"content-disposition"</span></span>, GetContentDisposition(filename)); <span class="hljs-comment"><span class="hljs-comment">// Flush the workbook to the Response.OutputStream using (var memoryStream = new MemoryStream()) { wb.SaveAs(memoryStream); memoryStream.WriteTo(response.OutputStream); } response.End(); }</span></span></code> </pre><br><br>  The first three lines of the method actually form the Excel document (thanks to ClosedXml), and the rest is the code to give the file to the client. <br><br>  The <code>content-disposition</code> response header is very differently perceived by different browsers, so giving a file with the correct Russian name requires some dances with a tambourine. <br><br>  I found the code to form the correct <code>content-disposition</code> header on StackOverflow <a href="http">stackoverflow.com/questions/93551/how-to-encode-the-filename-parameter-of-content-disposition-header-in-http</a> <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetContentDisposition</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> filename</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Page.Request; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> contentDisposition; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.Browser.Browser == <span class="hljs-string"><span class="hljs-string">"IE"</span></span> &amp;&amp; (request.Browser.Version == <span class="hljs-string"><span class="hljs-string">"7.0"</span></span> || request.Browser.Version == <span class="hljs-string"><span class="hljs-string">"8.0"</span></span>)) contentDisposition = <span class="hljs-string"><span class="hljs-string">"attachment; filename="</span></span> + Uri.EscapeDataString(filename); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.UserAgent != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; request.UserAgent.ToLowerInvariant().Contains(<span class="hljs-string"><span class="hljs-string">"android"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">// android built-in download manager (all browsers on android) contentDisposition = "attachment; filename=\"" + MakeAndroidSafeFileName(filename) + "\""; else contentDisposition = "attachment; filename=\"" + filename + "\"; filename*=UTF-8''" + Uri.EscapeDataString(filename); return contentDisposition; } private static readonly Dictionary&lt;char, char&gt; AndroidAllowedChars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ._-+,@¬£$‚Ç¨!¬Ω¬ß~'=()[]{}0123456789".ToDictionary(c =&gt; c); private string MakeAndroidSafeFileName(string fileName) { char[] newFileName = fileName.ToCharArray(); for (int i = 0; i &lt; newFileName.Length; i++) { if (!AndroidAllowedChars.ContainsKey(newFileName[i])) newFileName[i] = '_'; } return new string(newFileName); }</span></span></code> </pre><br><br><h4>  Conclusion </h4><br>  For everything to work on Production, you need to add the ClosedXml.dll and DocumentFormat.OpenXml.dll files to your package.  The Ribbon and Control buttons should be placed in one feature of the Site or Web level. <br><br>  The entire project can be viewed at the link - <a href="https://spsamples.codeplex.com/SourceControl/latest">spsamples.codeplex.com/SourceControl/latest#ExportToExcel</a> <br><br>  Ready WSP file here - <a href="https://spsamples.codeplex.com/releases/view/117220">spsamples.codeplex.com/releases/view/117220</a> <br><br>  Most of the code is universal, and does not depend on SharePoint.  You can use a similar approach in any ASP.NET project. </div><p>Source: <a href="https://habr.com/ru/post/208948/">https://habr.com/ru/post/208948/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../208928/index.html">How to prepare and get a PMP certificate in two weeks</a></li>
<li><a href="../208932/index.html">Free screencasts to explore Go</a></li>
<li><a href="../208938/index.html">Programming Circle for Pupils</a></li>
<li><a href="../208940/index.html">New Year reload or tale of a convenient way to serve customers</a></li>
<li><a href="../208942/index.html">The distribution of the Nokia Black update for Lumia smartphones has already begun</a></li>
<li><a href="../208952/index.html">JavaScript Decision Trees</a></li>
<li><a href="../208954/index.html">What is Microsoft video training technology how to work on the formation of personality</a></li>
<li><a href="../208960/index.html">WebGL Experiment + Google Analytics + Leap Motion</a></li>
<li><a href="../208962/index.html">The virus has disabled all video recording complexes in the Moscow region</a></li>
<li><a href="../208964/index.html">Pngquant - library and command line utility for png lossy compression</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>