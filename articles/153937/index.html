<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The system of notifications about events on the site (for example, audio player VKontakte)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings. 

 I think many who have a Vkontakte account and listen to music there, noticed that if you turn on a track on one tab and then turn on the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The system of notifications about events on the site (for example, audio player VKontakte)</h1><div class="post__text post__text-html js-mediator-article">  Greetings. <br><br>  I think many who have a Vkontakte account and listen to music there, noticed that if you turn on a track on one tab and then turn on the second one, the first track will pause.  Approximately the same thing happens with different notifications (new message, reply to comment / post, etc.) - it is displayed only in the active tab.  Who cares how it works and how to do this on your site, you are welcome for a habrakat. <br><a name="habracut"></a><br><h4>  Theory </h4><br>  And all this is implemented using <a href="http://www.w3schools.com/html/html5_webstorage.asp">HTML5 Local Storage</a> .  Take the same audio player.  When you start a track in Local Storage, the window ID and player status (for example, 'play') is saved.  If another track is launched in another window (of the same domain, of course), all tabs pause their players.  And so on. <br><br><h4>  Practice </h4><br>  We will store the event data in one key, for example, 'notifier_event'.  We will write there a string representation of some object of the following form: <br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> evt = { <span class="hljs-string"><span class="hljs-string">'notifier_id'</span></span>: <span class="hljs-string"><span class="hljs-string">'aAr63gd2'</span></span>, <span class="hljs-string"><span class="hljs-string">'event'</span></span>: <span class="hljs-string"><span class="hljs-string">'audiostate'</span></span>, <span class="hljs-string"><span class="hljs-string">'event_data'</span></span>: {<span class="hljs-string"><span class="hljs-string">'state'</span></span>: <span class="hljs-string"><span class="hljs-string">'play'</span></span>}, <span class="hljs-string"><span class="hljs-string">'event_ts'</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.round(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().getTime() / <span class="hljs-number"><span class="hljs-number">1000</span></span>) };</code> </pre> <br>  The notifier_id field is the ID of the tab from which the event was sent;  'event' is the name of the event, 'event_data' is the event data, respectively, 'event_ts' is the Unix Timestamp.  Event time must be specified so that the key value change event is always processed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When an event is received, simply launch the necessary handler and perform all actions that relate to the received event.  That's all :) <br><br><h4>  Listings </h4><br>  Event handling <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Binds storage key change event * @return void **/</span></span> Notifier.prototype.bindEvent = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.isAvailable()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; $(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>).bind(<span class="hljs-string"><span class="hljs-string">'storage'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> evt = e.originalEvent; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (evt.key == t.m_localStorageKey) <span class="hljs-comment"><span class="hljs-comment">//    -   ,   t.handleLsEvent(JSON.parse(evt.newValue)); }); }; /** * Handles changes for certain localStorage event * @param Object evt **/ Notifier.prototype.handleLsEvent = function(evt) { switch (evt.event) { case 'audiostate': this.handleAudioStateEvent(evt); //    play/pause  break; } }; /** * Handles audiostate event * @param Object evt * @return void **/ Notifier.prototype.handleAudioStateEvent = function(evt) { if (evt.notifier_id != this.getNotifierId()) { if (evt.event_data.state == 'play') { //  -    ,      player.pause(); } } };</span></span></code> </pre><br><br><h4>  Demo </h4><br>  An example can be found here - <a href="http://gpdev.org/ls-notifier/%3Fplayer%3D1">track 1</a> , <a href="http://gpdev.org/ls-notifier/%3Fplayer%3D2">track 2</a> . <br><br><h4>  Sources </h4><br>  Sources can be downloaded from the <a href="https://github.com/Shadez/ls-notifier">GitHub</a> repository. <br><br>  <i>Presented in the demo audio distributed under the license <a href="http://creativecommons.org/licenses/by-sa/2.0/">Attribution-ShareAlike License</a> .</i> </div><p>Source: <a href="https://habr.com/ru/post/153937/">https://habr.com/ru/post/153937/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../153921/index.html">Report from the conference BitByte</a></li>
<li><a href="../153923/index.html">Do you think short tags are bad?</a></li>
<li><a href="../153925/index.html">New in CSS3: multi-colouration, flexbox, grid markup</a></li>
<li><a href="../153929/index.html">Family portrait of Mars research vehicles</a></li>
<li><a href="../153933/index.html">Instruction novice game developer</a></li>
<li><a href="../153941/index.html">Review of Lenovo ThinkPad X220 Slice Battery 19+ (P / N: 0A36280)</a></li>
<li><a href="../153945/index.html">Google's neural network set to work</a></li>
<li><a href="../153949/index.html">The shortest recording of asynchronous calls in tornado v2, or patch AST</a></li>
<li><a href="../153951/index.html">Anti-piracy robot in paranoia mode</a></li>
<li><a href="../153953/index.html">Psychiatrist about banning Youtube, Wifi for children, blocking sites</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>