<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>geoDNS using Powerdns and nginx</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I love the task ‚Äúat the junction of technology,‚Äù this is one of those. 
 Task: 


- implement geoDNS * 
- with wildcard capability (* .some.tst. A 1.2...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>geoDNS using Powerdns and nginx</h1><div class="post__text post__text-html js-mediator-article">  I love the task ‚Äúat the junction of technology,‚Äù this is one of those. <br>  Task: <br><ul><li>  implement geoDNS * </li><li>  with wildcard capability (* .some.tst. A 1.2.3.4) </li><li>  with the ability to change the contents of zones on the go, add new zones in batches </li><li>  without the need to run bulky scripts on every query ‚Äúpast the cache‚Äù </li><li>  learn to test this reactor (from localhost, not proxy / VDS heaps) </li></ul><br><br>  *) By geoDNS, I mean the possibility for clients from different regions to give different, for example, server / A-record addresses (for the USA, the server IP is given in the USA, for the CIS - in Moscow, for the EU - in Europe ...) <br><br>  Article describes <br><ul><li>  geoDNS implementation method </li><li>  testing method </li><li>  sketching solution on ‚Äúpure nginx‚Äù </li></ul><br>  If it is interesting, and here nginx, I ask under kat. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The existing solutions ( <a href="http://www.caraytech.com/geodns/">patch for bind</a> , <a href="http://doc.powerdns.com/html/geo.html">geo_backend</a> and <a href="http://doc.powerdns.com/html/backends-detail.html">pipe_backend</a> for powerdns), for example, did not suit us. <br><br><h4>  GeoDNS implementation method </h4><br>  Powerdns (pdns) - <a href="http://powerdns.com/">authoritative dns server</a> , which has a bunch (as many as <a href="http://doc.powerdns.com/html/backends-detail.html">15 pieces</a> ) of backends (information sources) from standard BIND-like to various DBMS (MySQL, Oracle, PostgreSQL, sqlite), simple pipe and exotic of type Lua, LDAP. <br><br>  The backend is selected globally for the entire installation (5 domains per mysql are not allowed, 5 more per sqlite, etc.) like this: <br><pre><code class="dos hljs">launch=remote remote-connection-string=http:url=http://<span class="hljs-number"><span class="hljs-number">127</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">4343</span></span>/dnsapi</code> </pre> <br><br>  When using <a href="http://doc.powerdns.com/html/remotebackend.html">remote backend</a> , pdns sends an http request to the specified server and expects to receive an http response from the one containing data in json's favorite web developers format. <br><br>  As an example: <br><pre> <code class="hljs pgsql">&gt; <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /dnsapi/lookup/www.example.com/<span class="hljs-keyword"><span class="hljs-keyword">ANY</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> &lt; {"result":[{"qtype":"A", "qname":"www.example.com", "content":"192.168.1.2", "ttl": <span class="hljs-number"><span class="hljs-number">60</span></span>}]}</code> </pre><br><br>  It is obvious that it is impossible to set any dynamics for a web server (it will be too fat, and ddos ‚Äã‚Äãthrough DNS is quite common), therefore, we are trying to implement the DNS logic on pure nginx, which renders the usual statics. <br><br>  Surprisingly, the logic turned out to be very simple and nothing was needed except try_files and rewrite, the implementation of the geo component was complicated only by using the <a href="http_geo_module.html">ngx_http_geo_module</a> module <br>  It took a little clever generator of this very static (see below). <br><br>  We will store our zone (the answer is already ready for json, without taking into account the geo-binding) in the file structure of the form <br> <code>/$1/$2$1_$3.jsn</code> <br>  <code>$1</code> - zone <br>  <code>$2</code> - subdomain (_ in case of wildcard) <br>  <code>$3</code> - type of request (for example, A, CNAME, MX ... ANY) <br>  Example: /domain.com/sub.domain.com_A.jsn <br><br>  Important clarification: the logical domain name nextsub.sub.domain.com can be <br><ul><li>  independent domain /nexts.sub.domain.com/nextsub.sub.domain.com_A.jsn </li><li>  subdomain /sub.domain.com/nextsub.sub.domain.com_A.jsn </li><li>  wildcard /sub.domain.com/_sub.domain.com_A.jsn </li></ul><br><br>  Therefore, you need to go through three options (put in try_files). <br><br>  If such a subdomain was not found, we search above (this is not according to the RFC, and the practical use is doubtful): we simply repeat the search for sub.domain.com (we put it in rewrite) <br><br>  It's time to remember about the geo-component. <br>  Everything is simple, we add a letter code of the geofence: /domain.com/ <b>def</b> /sub.domain.com_A.jsn <br><br><h4>  Sketchy solution on pure nginx </h4><br>  Crutch for a wildcard: It is important to understand that in a wildcard request of the form ddddd.domain.com we have to give a subdomain in the answer (and not * .domain.com), <a href="http_sub_module.html">ngx_http_sub_module</a> comes to the rescue, which replaces% WC% in statics with the requested subdomain. <br><br><div class="spoiler">  <b class="spoiler_title">Nginx config</b> <div class="spoiler_text"><pre> <code class="nginx hljs"><span class="hljs-comment"><span class="hljs-comment">#   X-remotebackend powerdns  IP  #    ,     $src geo $http_x_remotebackend_remote $src{ default def; 127.1.0.0/16 i0; 127.1.1.0/24 i1; } #  ,    geo-  IP  log_format ns '$remote_addr - [$time_local] "$request" $status ' '"$http_user_agent" $http_x_remotebackend_real_remote ' ' $http_x_remotebackend_real_remote $http_x_remotebackend_remote $http_x_remotebackend_local $src'; server { listen 127.0.0.1:4343; access_log /var/www/dns/logs/nginx.access.log ns; error_log /var/www/dns/logs/nginx.error.log; #   ! #rewrite_log on; root /var/www/dns/store; #      - . error_page 403 /backend.jsn; location / { return 403; } location ~* ^/dnsapi/lookup/([^\.]+)\.([^/]*)/([az]+)$ { #   http add_header X-geo $src; sub_filter_types text/plain; sub_filter "%WC%" $1.$2. ; #          , #  /empty.jsn try_files /$2/$src/$1.$2_$3.jsn /$1.$2/$src/$1.$2_$3.jsn /$2/$src/_$2_$3.jsn /$2/def/$1.$2_$3.jsn /$1.$2/def/$1.$2_$3.jsn /$2/def/_$2_$3.jsn /empty.jsn @fallback; #        ($src) #   ,  . index fallback.jsn; limit_except GET {deny all;} # ./nextsub.sub.domain.com/SOA # sub.domain.com/&lt;geo&gt;/nextsub.sub.domain.com_SOA # nextsub.sub.domain.com/&lt;geo&gt;/nextsub.sub.domain.com_SOA # sub.domain.com/&lt;geo&gt;/_sub.domain.com_SOA # ./sub.domain.com/SOA # ... } #    . location @fallback{ rewrite ^/dnsapi/lookup/([^\.]+)\.([^/]*)/([az]+) /dnsapi/lookup/$2/$3; } } #server</span></span></code> </pre></div></div><br><br><h4>  Testing method </h4><br>  It's still easier here, pay attention, we distributed our test geofences inside 127.0.0.0/8, to the dig and wget commands you can easily feed the desired IP source. <br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">wget</span></span> -q -S -O - --bind-address=<span class="hljs-number"><span class="hljs-number">127.1.0.2</span></span> http://127.0.0.1:4343/dnsapi/lookup/dqqq/A dig -b <span class="hljs-number"><span class="hljs-number">127.0.12.1</span></span> ANY q.qq <span class="hljs-variable"><span class="hljs-variable">@localhost</span></span></code> </pre><br>  For our case, everything is perfectly tested as follows: <br><pre> <code class="hljs css"># <span class="hljs-selector-tag"><span class="hljs-selector-tag">dig</span></span> +<span class="hljs-selector-tag"><span class="hljs-selector-tag">short</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-b</span></span> 127<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">q</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.qq</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">localhost</span></span> <span class="hljs-number"><span class="hljs-number">1.1</span></span>.<span class="hljs-number"><span class="hljs-number">1.1</span></span> # dig +short -b <span class="hljs-number"><span class="hljs-number">127.1</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span> A q.qq @localhost <span class="hljs-number"><span class="hljs-number">127.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span> # dig +short -b <span class="hljs-number"><span class="hljs-number">127.1</span></span>.<span class="hljs-number"><span class="hljs-number">1.1</span></span> A q.qq @localhost <span class="hljs-number"><span class="hljs-number">127.1</span></span>.<span class="hljs-number"><span class="hljs-number">99.123</span></span></code> </pre><br><br><h4>  A little clever generator </h4><br>  There is a bit of code for which I am ashamed in some places.  Here he is <br><div class="spoiler">  <b class="spoiler_title">Static generator</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $empty=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); define(<span class="hljs-string"><span class="hljs-string">'TTL'</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>); opt(<span class="hljs-string"><span class="hljs-string">'empty'</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>,<span class="hljs-string"><span class="hljs-string">'empty'</span></span>); opt(<span class="hljs-string"><span class="hljs-string">'index'</span></span>,<span class="hljs-string"><span class="hljs-string">'true'</span></span>,<span class="hljs-string"><span class="hljs-string">'index'</span></span>); opt(<span class="hljs-string"><span class="hljs-string">'backend'</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>,<span class="hljs-string"><span class="hljs-string">'backend'</span></span>); $zones=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-comment"><span class="hljs-comment">//  $q=array(); $q[]=array('','NS','a.ns'); $q[]=array('','NS','b.ns'); $q[]=array('','A','1.1.1.1'); $q[]=array('www','CNAME',''); $q[]=array('*','A','3.2.1.4'); $q[]=array('','MX','mxs.ns',5); $q[]=array('','SOA','a.ns domain.lazutov.net. 5 3600 3600 604800 0'); //   geo $zones['q.qq']['def']=$q; $q=unsetrr($q,'','A'); //      $zones['q.qq']['i0']=$q; $zones['q.qq']['i0'][]=array('','A','127.0.0.1'); $zones['q.qq']['i1']=$q; $zones['q.qq']['i1'][]=array('','A','127.1.99.123'); foreach ($zones as $zone=&gt;$locdata){ foreach ($locdata as $loc=&gt;$rrs){ $sub=array(); $all=$rrs; //   "" foreach ($rrs as $r){ if ($r[0]==='*'){ $sub['*'][]=$r; } elseif ($r[0]==='') { $sub['@'][]=$r; } else { $sub[$r[0]][]=$r; } } //        . foreach ($sub as $sd=&gt;$rrs){ $rrs=formdata($zone,$rrs); foreach ($rrs as $type=&gt;$v) writedown($zone,$loc,$sd,$type,$v); } } } //      type  sub  zone   loc function writedown ($zone,$loc,$sub,$type,$data){ $fn="{$sub}.{$zone}"; if ($sub=='@') $fn=$zone; elseif ($sub=='*') $fn='_'.$zone; opt("{$zone}/{$loc}/{$fn}_{$type}",$data); } //     json (  ) function formdata($zone,$rrs){ $r=array(); foreach ($rrs as $rr){ $qname=(empty($rr[0])?$zone:"{$rr[0]}.{$zone}"); $pr=(empty($rr[3])?0:intval($rr[3])); $c=(empty($rr[2])?$zone:$rr[2]); $rd=array('qname'=&gt;$qname,'qtype'=&gt;$rr[1],'content'=&gt;$c,'ttl'=&gt;TTL,'priority'=&gt;$pr,'domain_id'=&gt;-1); if ($rr[0]==='*' AND $rd['qtype']!=='ANY') $rd['qname']='%WC%'; $r[$rr[1]][]=$rd; $r['ANY'][]=$rd; } return $r; } function unsetrr($data,$src,$type){ foreach ($data as $k=&gt;$v) if ($v[0]===$src and $v[1]===$type) unset($data[$k]); return $data; } //  OutPuT  data   file   add function opt($file,$data,$add=NULL){ $r=array('result'=&gt;$data); if (!empty($add)) $r['desc']=$add; $dir=dirname(__FILE__); $cd=dirname($dir.'/'.$file) ; //echo "{$cd}\n"; if (!is_dir($cd)) mkdir($cd ); file_put_contents($dir.'/'.$file.'.jsn',json_encode($r) ); }</span></span></code> </pre></div></div><br><br>  Advantages of this solution: <br><ul><li>  Hot Add / Change </li><li>  Return statics through nginx well studied and quite simple </li><li>  nginx_geo is well studied and documented </li><li>  Scaled horizontally, adding new pdns workers first, and then pdns + nginx servers </li><li>  The nginx config syntax completes your needs. </li></ul><br><br>  But I do not think it is ready for use in combat conditions and that is why: <br><ul><li>  remote_backend meanwhile unstable and pdns need to be <a href="http://doc.powerdns.com/html/remotebackend.html">recovered from the trunk</a> with its support </li><li>  I didn't even look at the RFC </li></ul><br><br>  Thanks for attention! <br><br>  I ask to send questions in comments, and typographical errors - in a pm. <br>  Those who wish to use your DNS service, please proceed to <a href="http://habrahabr.ru/hub/i_am_advertising/">your yard</a> , sorry. </div><p>Source: <a href="https://habr.com/ru/post/178727/">https://habr.com/ru/post/178727/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../178713/index.html">RE: How to deal with low-quality Android applications</a></li>
<li><a href="../178717/index.html">Interoperability: Fortran and C #</a></li>
<li><a href="../178721/index.html">Smart player nearly collapsed EVE Online economy</a></li>
<li><a href="../178723/index.html">Google recognized Palestine</a></li>
<li><a href="../178725/index.html">Scientists have embedded radio chips in paper</a></li>
<li><a href="../178733/index.html">Modify Chrome Logger - a post as an incentive to study Google Chrome extensions and write your own</a></li>
<li><a href="../178737/index.html">Creating a simple CRUD application using Yii2</a></li>
<li><a href="../178739/index.html">How to increase revenue from 0 to $ 1,000,000 for two years</a></li>
<li><a href="../178741/index.html">Cloud in your pocket</a></li>
<li><a href="../178743/index.html">Time to connect the source. Introduction to Source Maps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>