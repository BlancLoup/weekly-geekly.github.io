<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We build an OpenVPN bridge under Mac OSX</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once I had the need to have access to a local network from a remote place. To perform this task, an OSX server was installed on the iMac in which remo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We build an OpenVPN bridge under Mac OSX</h1><div class="post__text post__text-html js-mediator-article">  Once I had the need to have access to a local network from a remote place.  To perform this task, an OSX server was installed on the iMac in which remote access VPN was configured.  Everything worked quite well except mDNS (Bonjour).  As it turned out, this VPN implementation does not support multicast.  And it was vital because of the presence of some special applications that only work on the local network. <br><br>  After a brief search, there were several solutions to this problem.  One of them was free to install the <a href="http://www.chaoticsoftware.com/ProductPages/NetworkBeacon.html">‚ÄúNetwork Beacon‚Äù program</a> and set the paths to the Bonjour services in it.  Another solution was paid and suggested the installation of a special application <a href="http://www.yazsoft.com/products/sharetool/">‚ÄúShareTool‚Äù</a> which firstly can build its own SSH tunnels and secondly transmit information about the services on the server side through the tunnel. <br><br>  There are two minuses to this solution.  The first is that you need to buy a license for each car.  Well, the second is that this decision is still a crutch.  And I wanted to do everything as clean as possible. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The solution was the construction of a VPN bridge based on OpenVPN with a virtual adapter ‚Äútap‚Äù. <br>  But how to do that?  On the network, I found many different instructions for setting up such a configuration, but not a single option for building a bridge under OSX. <br><br>  And then I remembered how I set up a bridge for expanding the wireless network and decided to do everything in a similar way. <br><a name="habracut"></a><br><h5>  Step One - Configuring OpenVPN </h5><br>  All subsequent steps will require superuser rights.  Therefore, we open the terminal and immediately switch to the limitless possibilities mode. <br><br><pre><code class="bash hljs">sudo -s</code> </pre> <br><br>  First, install the TunTap driver <br>  You can download it at this link: <a href="">tuntap_20111101.tar.gz</a> <br>  Unpack, run the installer.  After the installation is complete, we load the modules into the kernel. <br><br><pre> <code class="bash hljs">kextload /Library/Extensions/tun.kext kextload /Library/Extensions/tap.kext</code> </pre><br><br>  Next, we install OpenVPN itself via MacPorts. <br><br><pre> <code class="bash hljs">port install openvpn2</code> </pre><br><br>  For those who do not know yet - Easy-RSA is no longer part of the OpenVPN package for this, download it separately by the link: <br>  <a href="">easy-rsa-release-2.x.zip</a> <br><br>  For more convenience, copy the contents of the folder "openvpn2" in "/ etc / openvpn". <br><br><pre> <code class="bash hljs">cp -r /opt/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/share/doc/openvpn2 /etc/openvpn</code> </pre><br><br>  We unpack in it Easy-RSA 2. <br><br><pre> <code class="bash hljs">mkdir /etc/openvpn/easy-rsa unzip ‚Äìj easy-rsa-release-2.x.zip easy-rsa-release-2.x/easy-rsa/2.0/\* -d /etc/openvpn/easy-rsa/2.0/</code> </pre><br><br>  We rule vars for ourselves and generate keys.  Editing ‚Äúvars‚Äù consists in correcting the information on the certificate holder and key, as well as changing (if necessary) the Diffie-Hellman parameters. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/openvpn/easy-rsa/2.0 nano vars <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> vars ./clean-all ./build-ca</code> </pre><br><br>  For the server. <br><pre> <code class="bash hljs">./build-key-server server</code> </pre><br><br>  And the client. <br><pre> <code class="bash hljs">./build-key client</code> </pre><br><br>  In conclusion, we generate the Diffie - Hellman parameters. <br><pre> <code class="bash hljs">./build-dh</code> </pre><br><br>  Edit the pattern from "/ etc / openvpn / sample-config-files /" or create a new ‚Äúserver.conf‚Äù. <br>  For example, my version <br><br><pre> <code class="diff hljs">#   port 1194 #  proto udp #   .  . dev tap #      ca /etc/openvpn/easy-rsa/2.0/keys/ca.crt cert /etc/openvpn/easy-rsa/2.0/keys/server.crt key /etc/openvpn/easy-rsa/2.0/keys/server.key #          vars. "dh1024.pem"  "dh2048.pem" dh /etc/openvpn/easy-rsa/2.0/keys/dh1024.pem #      ifconfig-pool-persist /etc/openvpn/ipp.txt #      . server-bridge 192.168.2.2 255.255.255.0 192.168.2.224 192.168.2.254 #       push "route 192.168.2.0 255.255.255.0" #          script-security 2 up /etc/openvpn/scripts/up.sh #         . #          . learn-address /etc/openvpn/scripts/routes.sh #       . client-to-client #           duplicate-cn #    10        60    . keepalive 10 60 #   comp-lzo #        persist-key #       OpenVPN persist-tun #   .        1   0 verb 3</code> </pre><br><br>  Now let's move on to the next step, creating a bridge using MacOS itself. <br><br><h5>  Step Two - ‚ÄúBridge Building‚Äù </h5><br>  Run the System Settings and select Network. <br><img src="https://habrastorage.org/getpro/habr/post_images/eb5/910/fd3/eb5910fd3c5994fbd5283b5f9ba323e9.png" alt="image"><br><br>  Click on the gear and select "Manage virtual interfaces". <br><img src="https://habrastorage.org/getpro/habr/post_images/4eb/7e1/210/4eb7e1210b0e18ad7137c2972653e46e.png"><br><br>  Next, click on the plus and select "New Bridge ...". <br><img src="https://habrastorage.org/getpro/habr/post_images/b1e/fd4/360/b1efd4360f93a141cace223510211639.png"><br>  Here we will never see our ‚Äútap‚Äù interface even when the OpenVPN server is running.  But as it turned out with all the "friendliness" MacOs gives you the opportunity to create a network bridge with one interface.  And this is exactly what we need.  We select the adapter with which we are connected to the network and call the bridge at our discretion.  Click "create" and "ready." <br><br>  Next, we configure the bridge connection in the same way as the network interface was configured and click Apply. <br><img src="https://habrastorage.org/getpro/habr/post_images/78e/b41/8bf/78eb418bfc4dbf20caf8188a9b560ffa.png"><br><br>  Everything, the network is configured and the window can be closed.  It is no longer needed. <br>  Now you can check in the terminal the presence of a bridge with one member.  Run the ifconfig command and make sure that the bridge0 has one member in its role, which is the interface that we chose when creating it. <br><img src="https://habrastorage.org/getpro/habr/post_images/ed8/6c3/563/ed86c35632e755353882bf175685fda1.png"><br><br>  The next step is the creation of a script that should perform two functions.  First, convince the kernel to skip packets and, second, add the ‚Äútap‚Äù interface to the bridge. <br><br><h5>  Step Three - Launch </h5><br>  Create the file "/etc/openvpn/scripts/up.sh". <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #    ARP    /usr/sbin/sysctl -w net.link.ether.inet.proxyall=1 #          /usr/sbin/sysctl -w net.inet.ip.forwarding=1 #   tap   /sbin/ifconfig bridge0 addm tap0</span></span></code> </pre><br><br>  Save and make it executable. <br><pre> <code class="bash hljs">chmod +x /etc/openvpn/scripts/up.sh</code> </pre><br>  The path to this script is specified in the server configuration and starts after the creation of the virtual interface. <br><br>  Checking the configuration <br><pre> <code class="bash hljs">/opt/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/openvpn2 ‚Äìconfig /etc/openvpn/server.conf</code> </pre><br>  Is the server running?  If so, then kill it "Control + C".  If you flew with errors, then look with what and fix it. <br><br>  Now go to the autorun server. <br><br>  Create a file "/Library/LaunchDaemons/org.openvpn.bridge.plist" with the following content. <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plist</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dict</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span>KeepAlive<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">true</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span>Label<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span>org.openvpn.bridge<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span>ProgramArguments<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">array</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span>/opt/local/sbin/openvpn2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span>--config<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span>/etc/openvpn/server.conf<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">array</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span>RunAtLoad<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">true</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dict</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plist</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Save and run the server. <br><pre> <code class="bash hljs">launchctl load /Library/LaunchDaemons/org.openvpn.bridge.plist</code> </pre><br><br>  Everything, with start of the server coped.  Go to the client. <br><br><h5>  Step Four - Customer </h5><br>  I will briefly describe only the option of running the client from under MacOS.  Since I‚Äôm connecting to this server from MacBook and I didn‚Äôt have to put Xcode and MacPorts on it, I decided to use an all-inclusive solution like <a href="https://code.google.com/p/tunnelblick/">Tunnelblick</a> . <br><br>  Create a configuration folder.  For example on the desktop.  Make it easier on the server.  Further it will be clear why. <br>  In the folder, create the file ‚Äúconfig.ovpn‚Äù and set the configuration. <br><br>  Example. <br><pre> <code class="diff hljs">client dev tap proto udp #       #       IP. remote my.server.tld 1194 resolv-retry infinite nobind persist-key persist-tun ca ca.crt cert client.crt key client.key comp-lzo verb 3</code> </pre><br><br>  We save and copy the keys and certificates created at the beginning to the same folder. <br><br><pre> <code class="bash hljs">cp /etc/openvpn/easy-rsa/2.0/keys/ca.crt /Users/username/Desktop/MyVpnConfig/ cp /etc/openvpn/easy-rsa/2.0/keys/client.crt /Users/username/Desktop/MyVpnConfig/ cp /etc/openvpn/easy-rsa/2.0/keys/client.key /Users/username/Desktop/MyVpnConfig/</code> </pre><br><br>  After copying the keys and certificates, you need to change their owner.  It must match the user under which we build the configuration.  For one we leave the superuser's paradise. <br><br><pre> <code class="bash hljs">chown -R username:staff /Users/username/Desktop/MyVpnConfig <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre><br><br>  Next, rename the folder with the configuration and keys (the folder name will be the name of the configuration in ‚ÄúTunnelblick‚Äù) and add the extension ‚Äú.tblk‚Äù <br><br><pre> <code class="bash hljs">mv /Users/username/Desktop/MyVpnConfig /Users/username/Desktop/MyVpnConfig.tblk</code> </pre><br><br>  After that we transfer the configuration to the client with the installed ‚ÄúTunnelblick‚Äù in any convenient way.  Then open the "Finder" find the location of the configuration and click on it twice.  It will automatically be added to the configurations. <br>  Run ‚ÄúTunnelblick‚Äù, select your configuration from the list and click the ‚ÄúConnect‚Äù button.  And if everything is done correctly, then after a few seconds we already have full access to the remote local network, including all multicast protocols. <br><br><div class="spoiler">  <b class="spoiler_title">Bibliography</b> <div class="spoiler_text">  <a href="http://provideotech.org/bonjour-and-vpn-or-how-i-learned-to-stop-googling-and-love-simplicity/">provideotech.org/bonjour-and-vpn-or-how-i-learned-to-stop-googling-and-love-simplicity</a> <br>  <a href="http://www.yazsoft.com/products/sharetool/">www.yazsoft.com/products/sharetool</a> <br>  <a href="http://tuntaposx.sourceforge.net/">tuntaposx.sourceforge.net</a> <br>  <a href="https://code.google.com/p/tunnelblick/">code.google.com/p/tunnelblick</a> <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/206322/">https://habr.com/ru/post/206322/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../206306/index.html">An example of solving a multiple regression problem using Python</a></li>
<li><a href="../206308/index.html">Save our souls: how reality shows affect people</a></li>
<li><a href="../206310/index.html">McLaren replaces wiper blades with a force field of sound waves</a></li>
<li><a href="../206312/index.html">Top 10 books to understand the stock market device</a></li>
<li><a href="../206320/index.html">A simple interpreter from scratch in Python (translation) # 1</a></li>
<li><a href="../206324/index.html">ShareJS or how to make your Google Wave with OT and NodeJS</a></li>
<li><a href="../206326/index.html">How to add additional fields in the system properties</a></li>
<li><a href="../206328/index.html">Debugging Chrome Dev Tools from Chrome Dev Tools</a></li>
<li><a href="../206330/index.html">How to scale Meteor</a></li>
<li><a href="../206336/index.html">File viewer, he's a viewer, he's a viewer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>