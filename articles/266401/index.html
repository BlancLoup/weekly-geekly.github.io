<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The queue of events in the card game + Angular basics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, newbies, today we will try to remake our toy , learning the basics of new ‚Äútechnologies‚Äù for us: 



- AngularJS 
- DataBoom 
 On the Angula...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The queue of events in the card game + Angular basics</h1><div class="post__text post__text-html js-mediator-article">  Good day, newbies, today we will try to remake <a href="http://habrahabr.ru/post/259907/">our toy</a> , learning the basics of new ‚Äútechnologies‚Äù for us: <br><br><ul><li>  AngularJS </li><li>  DataBoom </li></ul><br>  On the Angular we try to rewrite the main parts of our application to find out what it is and what it is eaten with.  Therefore, in the first part I will try to describe the course in more detail to you so that you do not break on the pitfalls that are contained in a considerable amount on your way of exploring angular. <br><br>  Well, in the second part, using DataBoom, we will create a wonderful line of events, as in the original game (I remind you what we are doing in the image of HeartStone).  Looking ahead, I‚Äôll say that next time we‚Äôll get rid of the php server altogether, and fully switch to Databoom, but this is a completely different article ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/files/ca4/2ed/147/ca42ed1477d148139c1c28db90995e73.jpg" alt="image"></div><br><a name="habracut"></a><br><h2>  AngularJS </h2><br>  You should start with the fact that to initialize an angular application, it will not be enough for you to simply connect the library and create a module in the js file.  To work with angular, you will need to work with your html files as a view, which, in my opinion, is better for separating the view and the controller. <br><br>  In Angulyar there is such an entity as directives - special html-attributes, and one such we will use to initialize our application.  The application may not cover the whole page, but only a separate block on it, it all depends on where you initialize it.  Initialization takes place with the help of the ng-app directive: <br><br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-app</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  This suggests that this element and everything lower down the tree is the representation of an angular.  We will manage all this with the help of controllers, which also need to be initialized in a similar way: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-controller</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"myController"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  The controllers, in turn, do not hang in the air, but are tied to the modules.  The application itself is also a module (the main, entry point to the application), and to set the primacy of one of the modules, its name must be specified in the ng-app directive: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-app</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"App"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Modules are created using the angular object's module method: <br><br><pre> <code class="javascript hljs">angular.module(<span class="hljs-string"><span class="hljs-string">' '</span></span>, [<span class="hljs-string"><span class="hljs-string">'_1'</span></span>])</code> </pre><br>  But the module itself is of little use without controllers.  To create a controller on our main module, which we define as an entry point for an application (for example), call the controller method on the module object: <br><br><pre> <code class="javascript hljs">myModule.controller(<span class="hljs-string"><span class="hljs-string">' '</span></span>, [<span class="hljs-string"><span class="hljs-string">'$scope'</span></span>,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$scope</span></span></span><span class="hljs-function">)</span></span>{ $scope.var = <span class="hljs-string"><span class="hljs-string">'some'</span></span>; $scope.foo = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{}; }]);</code> </pre><br>  The $ scope object defines all the variables and functions of the controller's scope, that is, what we can use in the view.  In this case, in our html files, we can work with var and foo. <br><br>  The output of variable values ‚Äã‚Äãis performed using double curly braces {{var}}, that is: <br><br><div class="spoiler">  <b class="spoiler_title">html</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> {{var}} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  will print "some". <br><br><h2>  Closer to the point </h2><br>  We will deal with the rest of the subtleties immediately with examples, since  There are some articles on the angular, although the documentation on angular.ru is not quite clear (to me personally). <br><br>  We will meet the first pitfall when we try to make the application modular (using the example of requirejs).  If you immediately register the ng-app directive in html, and then connect the angular library with the require method, we will find that nothing works.  This is because the DOM tree at the time of connection of the library has already been compiled. <br><br>  In this case, the angular object has a bootstrap method: <br><br><pre> <code class="javascript hljs"> <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>([<span class="hljs-string"><span class="hljs-string">'domReady!'</span></span>], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">document</span></span></span><span class="hljs-function">) </span></span>{ ng.bootstrap(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>, [<span class="hljs-string"><span class="hljs-string">'App'</span></span>]); });</code> </pre><br>  Thus, we bind the App module as an entry point to the application to the document. <br><br>  The first thing we will remake in our toy is the menu, and the only thing that is there is the list of players. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs">define([<span class="hljs-string"><span class="hljs-string">'angularControllersModule'</span></span>, <span class="hljs-string"><span class="hljs-string">'User'</span></span>, <span class="hljs-string"><span class="hljs-string">'Directive'</span></span>],<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">controllers, User, Directive</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">///////////  userList controllers.controller('userlistCtrl', ['$scope',function($scope){ $scope.userlist = []; //  ,   $scope.isMe = function(name){ //  if (name == User.login) { return 'me'; }; } $scope.letsFight = function(name){ // ,      return Directive.run('figthRequest',name); } }]); return controllers; })</span></span></code> </pre></div></div><br>  Here, the letsFight () method (invitation to battle) will be invoked by clicking on the appropriate button near each player.  In Angular, this is given by the ng-click directive: <br><br><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{isMe(user.name)}}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-repeat</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"user in userlist"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"name"</span></span></span><span class="hljs-tag">&gt;</span></span>{{user.name}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fightButton"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"letsFight(user.name)"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Pay attention to the different function calls: with curly braces and without.  The difference is that the expression in curly brackets is calculated immediately, without waiting for any action from the user, so in the second case we do not use curly brackets, it‚Äôs necessary that the function be called only by click. <br><br>  The ng-repeat directive works in the same way as foreach in php or for of in ES6 - all objects of the list are sorted.  The directive is specified in the &lt;li&gt; tag, which means that we will repeat it exactly as many times as we have elements in the userlist array. <br><br>  But initially our list of players is empty, and we get it via websockets from the server.  In the appendix, I tried to separate libraries, modules and some simple instruction sets (I called them Directives) in order to be able to rewrite them without serious consequences. <br><br>  Moreover, we have a separate handler for these directives (Directives.js), which simply calls the necessary directives by name, which we get from anywhere, for example by websockets or ajax.  In the simplest case, this is just apply (), but I created a table in the database that describes how the directives are called.  What I mean is: when we try to call a directive with the name myDir, if there is a match in the table, then the directive that is specified there is called, a kind of link.  But the point is that the bases are also convenient to set pre and post directives.  That is what will be called before and after the call of a specific directive. <br><br><img src="https://habrastorage.org/files/43a/aa1/527/43aaa1527c38463685373bfb7b0290eb.png" alt="image"><br><br>  And all these directives are stored in a separate folder, connecting when necessary: <br><br><div class="spoiler">  <b class="spoiler_title">modules / directive.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">define([<span class="hljs-string"><span class="hljs-string">'DB'</span></span>,<span class="hljs-string"><span class="hljs-string">'is'</span></span>],<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DB</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = <span class="hljs-string"><span class="hljs-string">'Actions/'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Directive = { <span class="hljs-attr"><span class="hljs-attr">run</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">directiveName, args</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> args = args || [<span class="hljs-string"><span class="hljs-string">''</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is.array(args)) { args = [args] }; DB.getDerictive(directiveName, exec); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exec</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">directiveName</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Directive.preAction ? if (typeof directiveName == undefined || typeof directiveName == 'string') { action = directiveName; }else{ action = directiveName.action; } Directive._apply(action,args); } }, _apply: function(actionName,args){ require([path + actionName],function(action){ action.run.apply(action,args); }); } } return Directive; })</span></span></code> </pre></div></div><br>  By websockets from the server, we get the directive name and arguments, call it using this module: <br><br><pre> <code class="javascript hljs"> socket.onmessage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> e.data === <span class="hljs-string"><span class="hljs-string">"string"</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(e.data); Directive.run(request.function,request.args); }; }</code> </pre><br>  In the same way, we receive instructions on how to add players to our empty list. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs">define([<span class="hljs-string"><span class="hljs-string">'angularrutch'</span></span>],<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">angularrutch</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> action = { <span class="hljs-attr"><span class="hljs-attr">run</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">list</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> list){ angularrutch.scopePush(<span class="hljs-string"><span class="hljs-string">'userListTpl'</span></span>, <span class="hljs-string"><span class="hljs-string">'userlist'</span></span>,{<span class="hljs-attr"><span class="hljs-attr">name</span></span>: key}); } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> action; })</code> </pre></div></div><br>  I am sure you have already paid attention to the dependency with the speaker called angular rrutch.  This module provides access to the anguly modules from the outside.  The fact is that changing the data of the Angulyar controller is not so easy.  You can not just call any method or rewrite the value of the parameter.  Even if you assign an angular module to some variable, the scope of $ scope will still not be accessible to you directly. <br><br>  For these purposes, you can use this construction: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> el = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelector( mySelector ); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = angular.element(el).scope(); scope.userlist.push(user);</code> </pre><br>  Everything is great, there is access to $ scope, but here it is not so simple.  You can change the $ scope data as much as you want, but nothing will change in the view.  Angulyar simply did not notice that you changed something, it does not track any change in the $ scope parameters, but does so only in its $ digest () cycle, which is called during certain user actions.  To call it manually, call the $ apply method on our scope: <br><br><div class="spoiler">  <b class="spoiler_title">Modified code</b> <div class="spoiler_text"><pre> <code class="javascript hljs">scope.$apply(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ scope.userlist.push(user); });</code> </pre></div></div><br>  Now everything is in order, the changes that we have made will be visible. <br><br>  I will not dwell on the controllers of the list of cards in the hands of the players and in the arena, everything is the same here, but we better proceed to the implementation of the event queue. <br><br><h2>  Queue on DataBoom </h2><br>  All of you (many) know that if you give several tasks in a row and quickly (attack, cast, finish), everything will not be done at the same time, creating a flicker of objects on the screen. <br><br>  In the database, the queue table looks like this: <br><br><pre> <code class="hljs objectivec">{<span class="hljs-string"><span class="hljs-string">"for"</span></span>:<span class="hljs-string"><span class="hljs-string">"user_1"</span></span>,<span class="hljs-string"><span class="hljs-string">"motion"</span></span>:<span class="hljs-string"><span class="hljs-string">"opGetCard"</span></span>,<span class="hljs-string"><span class="hljs-string">"motionId"</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>}, {<span class="hljs-string"><span class="hljs-string">"for"</span></span>:<span class="hljs-string"><span class="hljs-string">"user_2"</span></span>,<span class="hljs-string"><span class="hljs-string">"motion"</span></span>:<span class="hljs-string"><span class="hljs-string">"opGetCard"</span></span>,<span class="hljs-string"><span class="hljs-string">"motionId"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>},</code> </pre><br>  For which player is the action intended, the instruction name and the action id for the order. <br><br>  For queuing, I created two instructions: the stack.js module with a single push method (the stack is not really a queue, just like the word) and the push method of the DB module responsible for interacting with the DataBoom base: <br><br><div class="spoiler">  <b class="spoiler_title">stack.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">define([<span class="hljs-string"><span class="hljs-string">'DB'</span></span>, <span class="hljs-string"><span class="hljs-string">'User'</span></span>],<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DB, User</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span> = { <span class="hljs-attr"><span class="hljs-attr">push</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">forWho, motion, expandObj</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> expandObj = expandObj || <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> motionObj = { <span class="hljs-string"><span class="hljs-string">'for'</span></span>: forWho, <span class="hljs-string"><span class="hljs-string">'motion'</span></span>: motion }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (expandObj) { motionObj[expandObj.prop] = [{<span class="hljs-attr"><span class="hljs-attr">id</span></span>:expandObj.id}]; }; DB.push(<span class="hljs-string"><span class="hljs-string">'motionQueue'</span></span>,motionObj); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>; })</code> </pre><br></div></div><br>  Using this interface is simple: <br><br><pre> <code class="javascript hljs">stack.push(User.login,<span class="hljs-string"><span class="hljs-string">'myTimerStart'</span></span>);</code> </pre><br>  Calls the myTimerStart instruction for the User.login user. <br><br>  The instructions will be retrieved using the simple setInterval () function every 2 seconds: <br><br><pre> <code class="javascript hljs">setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ Directive.run(<span class="hljs-string"><span class="hljs-string">'getNextAction'</span></span>); }, <span class="hljs-number"><span class="hljs-number">2000</span></span>);</code> </pre><br>  To keep the order, we need a global variable window.motionId, containing the instruction number that has already been worked out (that is, the action has been completed, move on).  The getNextAction directive calls the database module method of the same name and describes a callback: <br><br><pre> <code class="javascript hljs">DB.getNextAction(User.login, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.actionStart); <span class="hljs-comment"><span class="hljs-comment">//      </span></span></code> </pre><br>  We can search for the necessary instruction in the table due to the possibility of query queries, that is, queries with a filter, sorting and limit: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = { <span class="hljs-attr"><span class="hljs-attr">baseHost</span></span>: <span class="hljs-string"><span class="hljs-string">'https://t014.databoom.space'</span></span>, <span class="hljs-attr"><span class="hljs-attr">baseName</span></span>: <span class="hljs-string"><span class="hljs-string">'b014'</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db = databoom(config.baseHost, config.baseName); <span class="hljs-comment"><span class="hljs-comment">//    var filter = "(motionId gt " + window.motionId + ") and (for eq '" + forWho + "')"; //   /*    : eq -  ne -   lt -  le -    gt -  ge -    */ db.load('motionQueue',{ filter: filter, orderby: "motionId", //  top: 1 //   -   })</span></span></code> </pre><br>  And everything would look simple if we didn‚Äôt have complicated instructions like ‚Äúthe player put a card with such parameters on the table‚Äù.  Here we need to know what the card, what its parameters.  Yes, we will create another field in the base ‚Äúargument‚Äù or ‚Äúmap‚Äù.  Make another request to the database for a selection of information about the map? <br><br>  DataBoom, thank the gods, has a solution to this effect - the expand option, which says that you need to expand the returned object with data from another table, in our case, a table with maps. <br><br><div class="spoiler">  <b class="spoiler_title">Map table</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/089/1fc/e8a/0891fce8a4fd4a3394542002ff8a59cc.png" alt="image"><br></div></div><br>  By itself, the binding in the database looks like this: <br><br><pre> <code class="hljs erlang">... ,<span class="hljs-string"><span class="hljs-string">"card"</span></span>:[{ <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"probe"</span></span>}], ...</code> </pre><br>  Record ID in another table.  And note that square brackets clearly hint that this is an array, that is, the binding can be multiple. <br><br>  When expanding the response of the base with the expand instruction, we get the same entry from the base, where instead of the {‚Äúid‚Äù: ‚Äúprobe‚Äù} object will be selected by id from the corresponding table: <br><br><pre> <code class="hljs objectivec">{ <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>:<span class="hljs-string"><span class="hljs-string">"..."</span></span>, collections:[{ <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-string"><span class="hljs-string">"motionQueue"</span></span>}], <span class="hljs-string"><span class="hljs-string">"for"</span></span>:<span class="hljs-string"><span class="hljs-string">"user_1"</span></span>, <span class="hljs-string"><span class="hljs-string">"motion"</span></span>:<span class="hljs-string"><span class="hljs-string">"opPutCard"</span></span>, <span class="hljs-string"><span class="hljs-string">"motionId"</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span> card:[ { <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>:<span class="hljs-string"><span class="hljs-string">"probe"</span></span>, title:<span class="hljs-string"><span class="hljs-string">"probe"</span></span>, mana:<span class="hljs-number"><span class="hljs-number">1</span></span>, attack:<span class="hljs-number"><span class="hljs-number">1</span></span>, health:<span class="hljs-number"><span class="hljs-number">1</span></span> } ], }</code> </pre><br><h2>  Conclusion </h2><br><ul><li>  All the basic wisdom angular unceremoniously fails to understand, unnecessarily complicated.  Difficult to interact from the outside, did not like. </li><li>  I liked DataBoom as a whole, although a lot of things are poorly documented in English (although the company, as far as I know, is Russian-speaking), we have to learn some techniques using a poke. </li></ul><br><h3>  Resources </h3><br><ul><li>  <a href="https://github.com/seokirill/PlayingCardsAngular">Github</a> </li><li>  <a href="http://141.8.196.222/">Demo</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/266401/">https://habr.com/ru/post/266401/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266387/index.html">VR and AR Digest: August</a></li>
<li><a href="../266389/index.html">We are looking for speakers at the second Moscow Atlassian Meetup</a></li>
<li><a href="../266393/index.html">HighLoad ++ is a highly loaded dish.</a></li>
<li><a href="../266397/index.html">RailsClub 2015: Interview with Andrei Kumanyaev</a></li>
<li><a href="../266399/index.html">Automatically building kernel modules with DKMS</a></li>
<li><a href="../266407/index.html">World undocumented React.js. Context</a></li>
<li><a href="../266409/index.html">Profiling of hybrid cluster applications MPI + OpenMP</a></li>
<li><a href="../266411/index.html">Using the Java native library on application servers</a></li>
<li><a href="../266413/index.html">Microsoft Useful Resources for IT Professionals</a></li>
<li><a href="../266415/index.html">Protection of corporate applications: how to become a developer of PT Application Firewall</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>