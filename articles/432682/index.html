<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Secrets of building and sending SSH to Docker 18.09</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Using Dockerfile, it has always been difficult to access private resources. There was simply no good solution. Using environment variables or simply d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Secrets of building and sending SSH to Docker 18.09</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/51a/244/e44/51a244e44066ef74933b2e3fbb5a005b.jpg" alt="image"><br><p>  Using Dockerfile, it has always been difficult to access private resources.  There was simply no good solution.  Using environment variables or simply deleting secret files after use is no good: they remain in the image metadata.  Users sometimes went to tricks: they created multi-stage assemblies, but they still had to take extreme care so that at the final stage there were no secret values, and the secret files were kept in the local assembly cache before the cut. </p><br><p>  The Docker build team 18.09 includes many updates.  The main feature is that there is a completely new version of the implementation of the server part, it is offered as part of the Moby BuildKit project.  The server application BuildKit has got new features, among which is the support of Dockerfile build secrets. </p><a name="habracut"></a><br><h3 id="ispolzovanie-sekretov">  Use of secrets </h3><br><p> First of all, you need to enable the server part of BuildKit.  BuildKit in version <code>18.09</code> is a selection function that can be enabled using the environment variable <code>DOCKER_BUILDKIT=1</code> before running <code>docker build</code> .  In the next version, it is planned to make BuildKit the default server part. </p><br><pre> <code class="plaintext hljs">export DOCKER_BUILDKIT=1</code> </pre> <br><p>  The implementation of build secrets is based on two new features of BuildKit.  One of them is the ability to use the user interface loaded from images in the registry;  the second is the possibility of using installation points in <code>RUN</code> commands for Dockerfile.  To use the implementation function with support for secrets (instead of the standard one), define the image of the linker using the syntax directive in the first line of the Dockerfile ‚Äî pointing to the image of the container you want to use.  So far, the secrets in the stable channel of external Dockerfile are not available: you need one of the versions in the experimental channel, for example, <code>docker/dockerfile:experimental</code> or <code>docker/dockerfile/1.0.0-experimental</code> . </p><br><pre> <code class="plaintext hljs"># syntax=docker/dockerfile:1.0.0-experimental</code> </pre> <br><p>  If, as the author of the Dockerfile, you know that the <code>RUN</code> command set in the Dockerfile requires a secret value, use the <code>--mount</code> label for it, indicating what secret the command needs and where it should be mounted.  The <code>--mount</code> label accepts a comma-delimited structure as in <code>--mount</code> for <code>docker run</code> . </p><br><pre> <code class="plaintext hljs"># syntax=docker/dockerfile:1.0.0-experimental FROM alpine RUN --mount=type=secret,id=mysite.key command-to-run</code> </pre> <br><p>  This label indicates that during operation the command has access to the secret file via the path <code>/run/secrets/mysite.key</code> .  The secret is available only to the team labeled mount, and not to other parts of the assembly.  The data in this file is downloaded from the secret store based on the specified identifier "mysite.key".  Currently, the Docker command-line interface supports the disclosure of secrets from local client files using the <code>--secret</code> tag. </p><br><pre> <code class="plaintext hljs">docker build --secret id=mysite.key,src=path/to/mysite.key .</code> </pre> <br><p>  As described above, the default secrets are set to <code>/run/secrets</code> , however, you can specify any path using the ‚Äútarget‚Äù key.  If ‚Äútarget‚Äù is specified, and ‚Äúid‚Äù is not, then ‚Äúid‚Äù defaults to the base name of the destination path. </p><br><p>  Not necessarily limited to one secret.  You can use any number of them, indicating different identifiers. </p><br><p>  If the author of Dockerfile indicates that the <code>RUN</code> instruction can use the secret, and the user invoking the assembly does not provide it, then the secret is ignored and no file is installed at the specified path.  If this situation is undesirable, use the ‚Äúrequired‚Äù key: this will show that the assembly will fail without a value. </p><br><pre> <code class="plaintext hljs"># syntax=docker/dockerfile:1.0.0-experimental FROM alpine RUN --mount=type=secret,id=mysite.key,required &lt;command-to-run&gt;</code> </pre> <br><h3 id="realizaciya">  Implementation </h3><br><p>  The secret file is automatically installed only in a separate tmpfs file system in order to prevent leaks to the final image or the next command and that it is not stored in the local build cache. </p><br><p>  Secret values ‚Äã‚Äãare also excluded from the build cache calculations so that the metadata cache cannot be used. </p><br><h3 id="ssh">  Ssh </h3><br><p>  Most often, they are probably trying to gain access to private storages - through the SSH protocol.  Yes, to unlock the SSH private key for the assembly, you can use secret elements, but there is a better solution.  The SSH protocol uses public key cryptography, and thanks to this design, it is not necessary for anyone to communicate their private key.  For example, if you use several computers with SSH, you do not need to transfer your key - it is enough to provide a connection through the <code>ssh-A</code> protocol. </p><br><p>  We added a similar feature to the <code>docker build</code> , where you can use the <code>--ssh</code> label to direct an existing SSH agent connection or key to the linker program.  Instead of passing key information, Docker will simply notify the linker of the availability of this feature.  If the linker needs access to the remote server via SSH, he will contact the client and ask for confirmation of the specific request necessary for the connection.  The key itself does not leave the client program, and after the program that requires access, the linker does not have any data left to re-establish the remote connection. </p><br><p>  Access to the file transfer via the SSH protocol is obtained only by commands in the Dockerfile that directly requested access to SSH by specifying the <code>type=ssh</code> block.  Other commands do not have data about an available SSH agent. </p><br><p>  Another aspect of SSH is also worth noting - the use of the TOFU security model.  When connecting to an SSH server for the first time, it will request information about an unknown host, since it does not have a public key available at the local level for this server and, accordingly, cannot verify whether the public key provided by the remote party is valid for this address. </p><br><p>  When building with Dockerfile, the correctness of this request is not checked, and accordingly, the server's public key must already exist in the container trying to use SSH.  There are several ways to get this public key.  For example, it will be provided by the base image, or you copy it from the build context.  If you want a simpler solution, run the <code>ssh‚Äìkeyscan</code> program as part of the build - it will load the current public key of the host. </p><br><p>  To request SSH access to the <code>RUN</code> command in the Dockerfile, you must specify a block with the ‚Äússh‚Äù type.  Then during the execution of the process, a socket will be installed with access to the SSH agent read-only.  This will also set up the <code>SSH_AUTH_SOCK</code> environment variable so that programs using the SSH protocol automatically use this socket. </p><br><pre> <code class="plaintext hljs"># syntax=docker/dockerfile:experimental FROM alpine # install ssh client and git RUN apk add --no-cache openssh-client git # download public key for github.com RUN mkdir -p -m 0600 ~/.ssh &amp;&amp; ssh-keyscan github.com &gt;&gt; ~/.ssh/known_hosts # clone our private repository RUN --mount=type=ssh git clone git@github.com:myorg/myproject.git myproject</code> </pre> <br><p>  On the client side of the Docker, you need to specify with the help of the <code>--ssh</code> label that sending via SSH is allowed for this assembly. </p><br><pre> <code class="plaintext hljs">docker build --ssh default .</code> </pre> <br><p>  A label accepts a pair of key values ‚Äã‚Äãdefining the location of the local SSH agent socket or private keys.  If you want to use the <code>default=$SSH_AUTH_SOCK</code> , the path to the socket can be left blank. </p><br><p>  In the Dockerfile block, you can also use the ‚Äúid‚Äù key to separate different servers that are included in one assembly.  For example, access to various repositories in the Dockerfile can be obtained with different deployment keys.  In this case, in the Dockerfile you will use: </p><br><pre> <code class="plaintext hljs">‚Ä¶ RUN --mount=type=ssh,id=projecta git clone projecta ‚Ä¶ RUN --mount=type=ssh,id=projectb git clone projectb ‚Ä¶</code> </pre> <br><p>  and reveal client data with docker build <code>--ssh projecta=./projecta.pem --ssh projectb=./projectb.pem</code> .  Notice that even if you specify the actual keys, only the agent connection is reported to the linker, and not the actual contents of these private keys. </p><br><p>  This completes the review of the new features of assembly secrets in Docker 18.09.  Hopefully, the new features will help to make more use of the Dockerfile capabilities in projects and ensure a higher level of security of the assembly line. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/432682/">https://habr.com/ru/post/432682/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../432672/index.html">What kind of developers are we looking for to develop the 1C: Enterprise platform?</a></li>
<li><a href="../432674/index.html">First experience with Yandex Dialogues. We are waiting for innovations</a></li>
<li><a href="../432676/index.html">Check Point Security Check List</a></li>
<li><a href="../432678/index.html">Winter frontend meetup at OZON</a></li>
<li><a href="../432680/index.html">Any Internet company is obliged to secretly change the program code at the request of the authorities</a></li>
<li><a href="../432686/index.html">WireGuard - the perfect VPN of the future?</a></li>
<li><a href="../432688/index.html">Digital events in Moscow from December 10 to 16</a></li>
<li><a href="../432692/index.html">Launched the biggest project for cleaning the world's oceans</a></li>
<li><a href="../432696/index.html">nomoregoogle.com - a fresh collection of alternatives to the technology giant's services</a></li>
<li><a href="../432698/index.html">Fantastic tmlidy and where they live</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>