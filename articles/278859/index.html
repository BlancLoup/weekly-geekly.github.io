<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asterisk and information about incoming calls in the browser via Notifications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Our company uses the 8800 phone number so that customers can place an order without access to the site. For the service of most incoming calls, the ca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asterisk and information about incoming calls in the browser via Notifications</h1><div class="post__text post__text-html js-mediator-article">  Our company uses the 8800 phone number so that customers can place an order without access to the site.  For the service of most incoming calls, the call-center is used, and if necessary, it is redirected to an internal employee. <br><br>  For the convenience of employees and the possibility of a personalized response, an incoming call recognition system was introduced for the internal customer base. <br><a name="habracut"></a><br>  Since cron tasks would be too rare (maximum 1 time per second), a daemon for php was taken as the basis, which scans the channels and sends information about the call to the temporary storage.  Memcached was used for temporary storage. <br><br>  The version of Asterisk used is 11.15.1. <br>  As an API, php and Asteriska bundles are the <a href="https://github.com/marcelog/PAMI">PAMI module</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">The main class of the wiretapping demon</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsteriskDaemon</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $asterisk; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $memcache; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;asterisk = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClientImpl([ ... ]); $memcache = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Memcached; $memcache-&gt;connect(<span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>, <span class="hljs-string"><span class="hljs-string">'11211'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;memcache = $memcache; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $asterisk = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;asterisk; $loop = Factory::create(); <span class="hljs-comment"><span class="hljs-comment">// add periodic timer $loop-&gt;addPeriodicTimer(1, function () use (&amp;$asterisk) { $pid = \pcntl_fork(); if ($pid &lt; 0) { //   exit; }elseif ($pid) { // ,    \pcntl_waitpid($pid, $status, WUNTRACED); if ($status &gt; 0) { //     ,  $asterisk-&gt;close(); usleep(1000); $asterisk-&gt;open(); } return; } else { //    try { $asterisk-&gt;process(); exit(0); } catch (\Exception $e) { exit(1); } } }); //   $loop-&gt;addPeriodicTimer(30, function () { while (($pid = \pcntl_waitpid(0, $status, WNOHANG)) &gt; 0) { echo "process exit. pid:" . $pid . ". exit code:" . $status . "\n"; } }); $loop-&gt;run(); } }</span></span></code> </pre> <br></div></div><br>  There are two possible recognition options: listening to channel events and manual analysis of information in CoreShowChannel, let's look at everything in order. <br><br><h4>  Listening to events </h4><br>  In the daemon constructor, add the initialization of the AsteriskEventListener event listener: <br><br><div class="spoiler">  <b class="spoiler_title">Event listener</b> <div class="spoiler_text"><pre> <code class="php hljs">... <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;asterisk-&gt;registerEventListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AsteriskEventListener($memcache), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(EventMessage $event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       return $event instanceof BridgeEvent; }); $this-&gt;asterisk-&gt;open(); ...</span></span></code> </pre><br></div></div><br>  And accordingly, the class itself listening and working with temporary storage: <br><br><div class="spoiler">  <b class="spoiler_title">Listening class</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsteriskEventListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IEventListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $memcache; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $bridges = []; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($memcache)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;memcache = $memcache; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addBridge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($phone1, $phone2)</span></span></span><span class="hljs-function"> </span></span>{ $bFind = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;bridges) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;bridges <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $bridge) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (in_array($phone1, $bridge) &amp;&amp; in_array($phone2, $bridge)) { $bFind = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$bFind) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;bridges[] = [ $phone1, $phone2 ]; $bFind = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $bFind; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteBridge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($phone1, $phone2 = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;bridges) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;bridges <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $bridge) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (in_array($phone1, $bridge) &amp;&amp; (!$phone2 || ($phone2 &amp;&amp; in_array($phone2, $bridge)))) { <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;bridges[$key]); } } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(EventMessage $event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  ,    /  if ($event instanceof BridgeEvent) { $this-&gt;bridges = $this-&gt;memcache-&gt;getKey('asterisk-bridges'); $state = $event-&gt;getBridgeState(); $caller1 = $event-&gt;getCallerID1(); $caller2 = $event-&gt;getCallerID2(); if ($state == 'Link') { //   $this-&gt;addBridge($caller1, $caller2); } else { //   $this-&gt;deleteBridge($caller1, $caller2); } $this-&gt;memcache-&gt;setKey('asterisk-bridges', $this-&gt;bridges); } } }</span></span></code> </pre><br></div></div><br>  In this embodiment, there may be problems when creating channels.  The fact is that when a call is redirected between employees or redirected from a call center to an employee, both channels will be created in conjunction with the person who redirected, and there will be no information about the resulting operator and client bundle. <br><br><h4>  Manual parsing of information CoreShowChannel </h4><br>  In order for this method to work, it is necessary to modify the daemon somewhat, we trigger the CoreShowChannel event forcibly, since Asterisk itself does not generate it: <br><br><div class="spoiler">  <b class="spoiler_title">Generating a CoreShowChannels Event</b> <div class="spoiler_text"><pre> <code class="php hljs">... <span class="hljs-comment"><span class="hljs-comment">//     try { $message = $asterisk-&gt;send(new CoreShowChannelsAction()); $events = $message-&gt;getEvents(); $this-&gt;parse($events); $asterisk-&gt;process(); exit(0); } catch (\Exception $e) { exit(1); } ...</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Parsing function</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($events)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($events <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $event) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($event <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> CoreShowChannelEvent) { $caller1 = $event-&gt;getKey(<span class="hljs-string"><span class="hljs-string">'CallerIDnum'</span></span>); $caller2 = $event-&gt;getKey(<span class="hljs-string"><span class="hljs-string">'ConnectedLineNum'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;bridges = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;memcache-&gt;getKey(<span class="hljs-string"><span class="hljs-string">'asterisk-bridges'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addBridge($caller1, $caller2); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;memcache-&gt;setKey(<span class="hljs-string"><span class="hljs-string">'asterisk-bridges'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;bridges); } } }</code> </pre><br></div></div><br>  In this method there is a problem of deleting a phone number when a client disconnects from the channel.  To solve, you can use the disconnect event: <br><br><div class="spoiler">  <b class="spoiler_title">Disconnect event</b> <div class="spoiler_text"><pre> <code class="php hljs">... <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;asterisk-&gt;registerEventListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AsteriskEventListener(), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(EventMessage $event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $event <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> HangupEvent; }); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;asterisk-&gt;open(); ...</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Handling a disconnect event</b> <div class="spoiler_text"><pre> <code class="php hljs">... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(EventMessage $event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($event <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> HangupEvent) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;bridges = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;memcache-&gt;getKey(<span class="hljs-string"><span class="hljs-string">'asterisk-bridges'</span></span>); $caller1 = $event-&gt;getKey(<span class="hljs-string"><span class="hljs-string">'CallerIDNum'</span></span>); $caller2 = $event-&gt;getKey(<span class="hljs-string"><span class="hljs-string">'ConnectedLineNum'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;deleteBridge($caller1); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;deleteBridge($caller2); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;memcache-&gt;setKey(<span class="hljs-string"><span class="hljs-string">'asterisk-bridges'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;bridges); } } ...</code> </pre><br></div></div><br>  As a result, it turned out that the second method is more efficient, since when working with asterisk events it often fell, and, as a result, some calls were lost.  Also, in the first method, calls were not recognized when redirecting from the call-center, since the employee and client numbers were in different channels (the first channel connects the call-center and the employee, the second channel connects the call-center and the client). <br><br><h4>  Information about the call through Notifications </h4><br>  For information about incoming calls, the <a href="https://github.com/Yaffle/EventSource">event-source-polyfill plugin</a> and long-pull requests to the server were used.  Let me remind you that we store incoming calls in memcached. <br><br>  Practice has shown that if an employee opens many tabs, then a large number of requests are generated.  To prevent this, the <a href="">wormhole</a> plugin was used, which transmits information about the channel between the tabs. <br><br>  The result is the following script: <br><br><div class="spoiler">  <b class="spoiler_title">The script to send a notification</b> <div class="spoiler_text"><pre> <code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">) </span></span>{ $.getCall = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (localStorage.callTitle !== <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> &amp;&amp; localStorage.callSuccess === <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> notification, title = localStorage.callTitle, options = { <span class="hljs-attr"><span class="hljs-attr">body</span></span>: localStorage.callText, <span class="hljs-attr"><span class="hljs-attr">icon</span></span>: localStorage.callImage }, eventNotification = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.open(localStorage.callUrl); }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(<span class="hljs-string"><span class="hljs-string">'Notification'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>)) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(<span class="hljs-string"><span class="hljs-string">'This browser does not support desktop notification'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Notification.permission === <span class="hljs-string"><span class="hljs-string">'granted'</span></span>) { notification = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Notification(title, options); notification.onclick = eventNotification; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Notification.permission !== <span class="hljs-string"><span class="hljs-string">'denied'</span></span>) { Notification.requestPermission(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">permission</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (permission === <span class="hljs-string"><span class="hljs-string">'granted'</span></span>) { notification = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Notification(title, options); notification.onclick = eventNotification; } }); } localStorage.callSuccess = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }; <span class="hljs-comment"><span class="hljs-comment">//        wormhole().on('master', function () { var es = new EventSource('/check-call'); es.addEventListener('message', function (res) { var data = JSON.parse(res.data); if (data['id']) { localStorage.callTitle = data['title']; localStorage.callText = data['text']; localStorage.callImage = data['img']; localStorage.callUrl = data['url']; } else { delete localStorage.callTitle; delete localStorage.callText; delete localStorage.callImage; delete localStorage.callUrl; delete localStorage.callSuccess; } }); }); })(jQuery); setInterval(function () { $.getCall(); }, 1000);</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Handler for long-pull requests</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkCall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ header(<span class="hljs-string"><span class="hljs-string">'Content-Type: text/event-stream'</span></span>); header(<span class="hljs-string"><span class="hljs-string">'Cache-Control: no-cache'</span></span>); header(<span class="hljs-string"><span class="hljs-string">'Access-Control-Allow-Origin: *'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//     $managerPhone = $_SESSION['phone']; $user = null; $clientPhone = $this-&gt;getPhone($managerPhone); if ($clientPhone) { $user = User::find()-&gt;where(['phone' =&gt; $clientPhone])-&gt;one(); } if ($user) { //         echo "retry: 30000\n"; } else { echo "retry: 3000\n"; } echo 'id: ' . $managerPhone . "\n"; $data = []; if ($user) { $data = [ 'id' =&gt; $user['id'], 'title' =&gt; '   ' . $user['name'], 'text' =&gt; '   ', 'img' =&gt; '/phone.png', 'url' =&gt; '/user/' . $user['id'] ]; } echo "data: " . json_encode($data) . "\n\n"; } //    public function getPhone($managerPhone) { $memcache = new Memcached; $memcache-&gt;addServer('127.0.0.1', '11211'); $extPhone = ''; if (!$managerPhone) { return $extPhone; } $bridges = $memcache-&gt;getKey('asterisk-bridges'); if (!isset($bridges) || !is_array($bridges)) { return $extPhone; } foreach ($bridges as $bridge) { if (($key = array_search($managerPhone, $bridge)) !== false) { $extPhone = $bridge[!$key]; break; } } return $extPhone; }</span></span></code> </pre><br></div></div><br><h4>  Results of implementation </h4><br><ul><li>  Quite an interesting experience with Asterisk and Notifications system for various browsers. </li><li>  Personalize incoming calls. </li><li>  Instant search for the number in the database and the ability to quickly go to the customer card. </li><li>  Employees received a useful service alerts for incoming calls. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/278859/">https://habr.com/ru/post/278859/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278847/index.html">How can you simplify your life using Telegram-bot</a></li>
<li><a href="../278849/index.html">How Cloud@mail.ru saved all * my files and what came of it</a></li>
<li><a href="../278853/index.html">Obstacle Chase</a></li>
<li><a href="../278855/index.html">Do not miss the details about the new SQL Server 2016 and Linux support, see the online event on March 10 at 18:00 (MCK)</a></li>
<li><a href="../278857/index.html">Microsoft fixed another Stuxnet-like vulnerability in Windows</a></li>
<li><a href="../278863/index.html">An example of game development based on Google Analytics data</a></li>
<li><a href="../278865/index.html">Certificate Authority Let's Encrypt has issued a million free certificates</a></li>
<li><a href="../278867/index.html">FizzBuzz problem solution</a></li>
<li><a href="../278869/index.html">We are looking for you to help you earn $ 5000 this summer</a></li>
<li><a href="../278871/index.html">Unit for node.js</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>