<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work with QDataStream</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It was necessary to work often with the QDataStream class. As a result, I gained some experience how to use it correctly. 


 Introduction 
 I repeate...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work with QDataStream</h1><div class="post__text post__text-html js-mediator-article">  It was necessary to work often with the QDataStream class.  As a result, I gained some experience how to use it correctly. <br><br><a name="habracut"></a><br><h4>  Introduction </h4><br>  I repeatedly noticed that at the beginning of work with a class there is an opinion that once a class has stream in its name, it is simply obliged to store data.  <i>Line</i> in <i>QDatastream :: QDatastream help (QByteArray * a, QIODevice :: OpenMode mode)</i> <i><br></i>  <i>Constructs a data stream that operates on a byte array, a.</i>  <i>This is what device is used to be.</i>  At first, few people have concerns.  But if you look under the hood, you can see that no data directly in the QDataStream is written.  In the constructor, the QBuffer class is initialized, which in this case is a wrapper for the passed QByteArray.  The idea of ‚Äã‚Äãwork is as follows: data is stored exclusively in QByteArray, and all operations on (de) serialization are performed by the QDataStream class.  When reading data from a stream, only the pointer to the current byte is changed, while the data itself is not lost.  When writing, data for <i>QIODevice :: WriteOnly is</i> overwritten by new values, for <i>QIODevice :: Append it is</i> added to the end.  From this follows the conclusion about the QByteArray lifetime monitoring. <br><habracut><br><h4>  Read-Write </h4><br>  The entry is represented by the standard operator &lt;&lt; defined for all basic types.  However, it is often more convenient to write data directly to the data structure.  The following example shows how to overload the operator &lt;&lt; for our purposes. <br><br><pre><code class="cpp hljs">sctruct anyStruct { <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> sVal; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> fVal; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> dVal; <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> Empty; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[<span class="hljs-number"><span class="hljs-number">8</span></span>]; } QDataStream <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> &lt;&lt;(QDataStream &amp;out, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> anyStruct &amp;any) { out &lt;&lt; any.sVal; out &lt;&lt; any.fVal; out &lt;&lt; any.dVal; out &lt;&lt; any.Empty; out.writeRawData(any.<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(any.<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> out; }</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Everything is quite simple here: the entry of a ‚Äúcomplex‚Äù structure is divided into the entry of simpler types.  Also note the <b>QDataStream writeRawData (const char * s, int len)</b> .  It would be possible to write the values ‚Äã‚Äãof the arrays in a loop, but why do it if there is a more elegant way. In the same way, we will overload the operator for reading: <br><br><pre> <code class="cpp hljs">QDataStream <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> &gt;&gt;(QDataStream &amp;out, anyStruct &amp;any) { out &gt;&gt; any.sVal; out.setFloatingPointPrecision(QDataStream::FloatingPointPrecision); out &gt;&gt; any.fVal; out.setFloatingPointPrecision(QDataStream::DoublePrecision); out &gt;&gt; any.dVal; out.skipRawData(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(any.Empty)); out.ReadRawData(any.<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(any.<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> out; }</code> </pre><br><br>  Everything is the same here, but you should pay attention to the <b>QDataStream :: setFloatingPointPrecision (FloatingPointPrecision precision)</b> function.  The point is that starting with Qt 4.6, you need to explicitly specify the precision of the floating-point type.  As you can guess, <i>SinglePrecision is</i> needed for types with single precision, and <i>DoublePrecision</i> for types with double.  There are two ways to solve this unpleasant situation: the first is to overload &lt;&lt; and &gt;&gt; something like this: <br><br><pre> <code class="cpp hljs">QDataStream <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> &gt;&gt;(QDataStream &amp;out, <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> &amp;val) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(out. FloatingPointPrecision() != QDataStream:: SinglePrecision) { out.setFloatingPointPrecision(QDataStream::FloatingPointPrecision); out &gt;&gt; val; out.setFloatingPointPrecision(QDataStream::DoublePrecision); } }</code> </pre><br><br>  Or, in your code, indicate before reading float and double how to read them.  The default is DoublePrecision. <br>  Now let's turn our attention to <b>QDataStream :: skipRawData (int len)</b> .  This function simply skips the specified number of bytes, which is extremely useful when aligning structures. <br><br>  Separately, it should be said about the recording order of the high bit.  The <b>QDataStream :: setByteOrder (ByteOrder bo)</b> method sets the order.  With <i>ByteOrder :: BigEndian, the</i> record goes high byte forward, and that is the order used by default.  With <i>ByteOrder :: LittleEndian, the</i> record goes in the low- <i>order</i> bit. <br><br><h4>  (De) Serialization of Qt classes </h4><br>  In addition to standard C ++ types, QDataStream also allows you to write some Qt classes such as QList and QVariant.  However, there are some problems with the Qt version.  However, the developers took care of the serialization of classes of different versions.  Responsible for this is the <b>QDataStream :: setVersion (int v)</b> method, where v is the Qt version indication.  Nevertheless, it is worth remembering that if you can push classes through different versions, only those class properties that are in the current version of the library will be available.  You can get the version the stream works with using <b>QDataStream :: version ()</b> .  Consider a small example of writing to a QHash container file. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;QtCore/QCoreApplication&gt; #include &lt;QDataStream&gt; #include &lt;QByteArray&gt; #include &lt;QFile&gt; #include &lt;QString&gt; #include &lt;QHash&gt; #include &lt;QDebug&gt; class simpleClass { public: quint32 a,b; quint32 func(quint32 arg1, quint32 arg2); quint32 getC(); friend QDataStream &amp;operator &lt;&lt;(QDataStream &amp;stream,const simpleClass &amp;sC); friend QDataStream &amp;operator &gt;&gt;(QDataStream &amp;stream, simpleClass &amp;sC); protected: quint32 c; }; inline quint32 simpleClass::func(quint32 arg1, quint32 arg2) { a = arg1; b = arg2; c = a+b; return c; } inline quint32 simpleClass::getC() { return c; } inline QDataStream &amp;operator &lt;&lt;(QDataStream &amp;stream,const simpleClass &amp;sC) // ; { stream &lt;&lt; sC.a; stream &lt;&lt; sC.b; stream &lt;&lt; sC.c; return stream; } inline QDataStream &amp;operator &gt;&gt;(QDataStream &amp;stream, simpleClass &amp;sC) // ; { stream &gt;&gt; sC.a; stream &gt;&gt; sC.b; stream &gt;&gt; sC.c; return stream; } int main(int argc, char *argv[]) { QCoreApplication a(argc, argv); QFile appFile(QString("filename.data")); appFile.open(QFile::Append); //    ; QDataStream inFile(&amp;appFile); //     QIODevice; QHash &lt;quint32,simpleClass&gt; hash; //       ; for(quint32 i = 0; i &lt; 64; i++) { if(!hash.contains(i)) //    ,    ; { simpleClass sC; //  ; sC.func(i,i+10); //   ; hash.insert(i,sC); //   ; } } inFile.setVersion(QDataStream::Qt_4_8); //    Qt,  ; inFile &lt;&lt; hash; //  ; appFile.flush(); //     ; appFile.close(); //      ; QFile readFile(QString("filename.data")); readFile.open(QFile::ReadOnly); QDataStream outFile(&amp;readFile); outFile.setVersion(QDataStream::Qt_4_8); QHash&lt;quint32,simpleClass&gt; readHash; //   ; outFile &gt;&gt; readHash; //     ; foreach(quint64 key, readHash.keys()) //   : readHash.keys()    ; { simpleClass sC = readHash.value(key); //     ; qDebug() &lt;&lt; "Sum was " &lt;&lt; sC.getC(); //   ; qDebug() &lt;&lt; "Sum is "&lt;&lt; sC.func(key,2*key); //   ; } readFile.close(); return a.exec(); }</span></span></span></span></code> </pre><br><br>  Before going to the example, I want to pay special attention to such a thing as flush ().  When working with some devices, the data can be buffered, which means that writing to them may not happen at the moment of calling the recording function.  The topic of buffering deserves a separate article, so let us dwell on the conclusion that it is necessary to forcibly empty the buffer for writing. <br><br>  In the example, we created the class simpleClass and overloaded the QDataStream operators for it.  Notice that we made the operators friendly to the class in order to be able to directly access the private sections.  It would be possible to make a fuss overloading operators for a class or writing functions for accessing private properties, but for me personally, a solution with a friend seems more elegant.  Then everything is pretty simple: open the file for reading, create a stream with a binding to the file, fill in QHash and write it down, not forgetting to specify the version of Qt.  The order for reading is almost the same. <br><br><h4>  Conclusion </h4><br>  Despite the high level of design class, it also has its pitfalls, which must be remembered.  It should always be remembered that a class is a functional wrapper over a data structure and it makes sense to use it when you need to directly perform read / write operations, and use other means to transfer data.  In addition, it is good practice to explicitly specify the parameters for working with a stream.  A couple of lines will save a lot of nerves in the future for those who will have to work with the code after you. </habracut></div><p>Source: <a href="https://habr.com/ru/post/150827/">https://habr.com/ru/post/150827/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150819/index.html">Back side backup</a></li>
<li><a href="../150820/index.html">ASN.1 in simple terms (part 2)</a></li>
<li><a href="../150821/index.html">5 LinguaLeo updates and secret plans for English learners</a></li>
<li><a href="../150825/index.html">Debugging Android Applications Without Java Source Code</a></li>
<li><a href="../150826/index.html">Policemen from Temirtau (Kazakhstan) sent a letter to the creators of "Photoshop"</a></li>
<li><a href="../150828/index.html">Webinar announcement: IT-infrastructure control. Change Audit with NetWrix Change Reporter Suite</a></li>
<li><a href="../150829/index.html">A little more about the development of plug-ins for IntelliJ</a></li>
<li><a href="../150834/index.html">ATIS by phone</a></li>
<li><a href="../150835/index.html">JetBrains News Digest August 7th to September 4th</a></li>
<li><a href="../150836/index.html">Valve takes on iron</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>