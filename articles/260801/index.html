<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a wrapper for FUSE in Java Native Runtime</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will tell you how to implement a file system in a user space in Java, without a line of kernel code. I will also show you how to lin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a wrapper for FUSE in Java Native Runtime</h1><div class="post__text post__text-html js-mediator-article">  In this article I will tell you how to implement a file system in a user space in Java, without a line of kernel code.  I will also show you how to link Java and native code without writing C code, while maintaining maximum performance. <br><br><img src="https://habrastorage.org/files/3b2/a74/094/3b2a740945d74108a2c70a82d7c97a28.png"><br><br>  Interesting?  Welcome under the cut! <br><a name="habracut"></a><br>  Before starting to implement the wrapper, you need to understand what FUSE is. <br>  FUSE (Filesystem in Userspace) is a file system in user space that allows users to create their own file systems without privileges and without having to rewrite kernel code.  This is achieved by running the file system code in user space, while the FUSE module only provides a bridge for the actual kernel interfaces.  FUSE was officially included in the main Linux code tree in version 2.6.14. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/43c/83d/6ba/43c83d6ba20e4a10adc239e565d6d77c.png"><br><br>  Those.  You can easily create your own file system with the implementation of several methods ( <a href="http://fuse.sourceforge.net/helloworld.html">an example of the simplest</a> file system).  Applications to this million, you can, for example, quickly write a file system, the backend for which is Dropbox or GitHub. <br>  Or, consider such a case, you have a business application where all user files are stored in the database, but the client suddenly needed direct access to the directory on the server where all the files are located.  Of course, duplicating files in the database and file system is not the best solution, and then the virtual file system comes to the rescue.  You simply write your FUSE wrapper, which, when accessing files, follows them to the database. <br><br><h2>  Java and native code </h2><br>  Great, but the FUSE implementation starts with ‚Äúinclude the header &lt;fuse.h&gt;‚Äù, and your business application is written in Java.  Obviously, you need to interact in some way with the native code. <br><br><h4>  Jni </h4><br>  The standard tool is JNI, but it introduces a lot of complexity into the project, especially considering that to implement FUSE we will have to make callbacks from native code into Java classes.  Yes, and ‚Äúwrite once‚Äù actually suffers, although in the case of FUSE this is less important to us. <br>  Actually, if you try to find projects that implement the wrapper for FUSE on JNI, you can find several projects that, however, have not been supported for a long time and provide an API curve. <br><br><h4>  Jna </h4><br>  Another option is <a href="https://github.com/twall/jna">the JNA library</a> .  JNA (Java Native Access) makes it quite easy to access native code without using JNI, limiting yourself to writing java-code.  Everything is quite simple, we declare an interface that corresponds to the native code, we get its implementation through ‚ÄúNative.loadLibrary‚Äù and we use everything.  Separate plus JNA is the most detailed documentation.  The project is alive and actively developing. <br><br>  Moreover, there is already a great project for FUSE that implements a wrapper on JNA. <br>  However, JNA has certain performance issues.  JNA is based on reflection, and the transition from native code with the conversion of all structures into java objects is very expensive.  This is not very noticeable if native calls are rare, but this is not the case with the file system.  The only way to speed up fuse-jna is to try to read files in large chunks, but this does not always work.  For example, when there is no access to client code, or all files are small, a large number of text files. <br>  Obviously, there should have been a library that would combine JNI performance and JNA convenience. <br><br><h4>  Jnr </h4><br>  This is where the JNR (Java Native Runtime) comes.  JNR, like JNA, is based on libffi, but instead of reflection, bytecode generation is used, thereby achieving a huge performance advantage. <br>  Any information about JNR is quite small, the most detailed is the <a href="http://medianetwork.oracle.com/video/player/2630340184001">performance of Charles Nutter at JVMLS 2013</a> ( <a href="http://www.oracle.com/technetwork/java/jvmls2013nutter-2013526.pdf">presentation</a> ).  However, JNR is already a fairly large ecosystem, which is actively used by JRuby.  Many of its parts, for example, unix-sockets, posix-api are also actively used by third-party projects. <br><br><img src="https://habrastorage.org/files/904/a13/49c/904a1349c43649679cff1308067fe6b3.png"><br><br>  It is JNR that is the basis for developing the <a href="http://openjdk.java.net/jeps/191">JEP 191</a> - Foreign Function Interface, which targets java 10. <br>  Unlike JNA, JNR does not have any documentation, all the answers to the questions have to be found in the source code, this was the main reason for writing a small guide. <br><br><h2>  Feature writing code for Java Native Runtime </h2><br><h3>  Binding functions </h3><br>  The easiest binding to libc looks like this: <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> jnr.ffi.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> jnr.ffi.types.pid_t; <span class="hljs-comment"><span class="hljs-comment">/** * Gets the process ID of the current process, and that of its parent. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Getpid</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LibC</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@pid</span></span><span class="hljs-function"><span class="hljs-function">_t </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getpid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@pid</span></span><span class="hljs-function"><span class="hljs-function">_t </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getppid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ LibC libc = LibraryLoader.create(LibC.class).load(<span class="hljs-string"><span class="hljs-string">"c"</span></span>); System.out.println(<span class="hljs-string"><span class="hljs-string">"pid="</span></span> + libc.getpid() + <span class="hljs-string"><span class="hljs-string">" parent pid="</span></span> + libc.getppid()); } }</code> </pre> <br>  Via LibraryLoader, we load by name the library that corresponds to the passed interface. <br><br>  In the case of FUSE, you need an interface with the fuse_main_real method, to which the FuseOperations structure is passed, which contains all callbacks. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LibFuse</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fuse_main_real</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, String argv[], FuseOperations op, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> op_size, Pointer user_data)</span></span></span></span>; }</code> </pre><br><br><h3>  Struct implementation </h3><br>  It is often necessary to work with structures located at a specific address, for example, the fuse_bufvec structure: <br><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fuse_bufvec</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> count; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> idx; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> off; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fuse_buf</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">buf</span></span></span><span class="hljs-class">[1];</span></span> };</code> </pre><br>  To implement it in JNR, you must inherit from jnr.ffi.Struct. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> jnr.ffi.*; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FuseBufvec</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Struct</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FuseBufvec</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(jnr.ffi.Runtime runtime)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(runtime); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> size_t count = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> size_t(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> size_t idx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> size_t(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> size_t off = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> size_t(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> FuseBuf buf = inner(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FuseBuf(getRuntime())); }</code> </pre><br>  Inside each structure is stored a pointer, according to which it is placed in memory.  Most of the API for working with structures can be seen by looking at the static methods of Struct. <br>  size_t is an inner Struct class and when it is created, for each field, the offset with which this field is located in memory is remembered, due to which each field knows by which offset it lies in memory.  There are already many such inner classes (for example, Signed64, Unsigned32, time_t, etc.), you can always implement your own. <br><br><h3>  Kolbeki </h3><br><pre> <code class="hljs rust"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fuse_operations</span></span></span></span> { int (*getattr) (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stat</span></span></span></span> *); }</code> </pre><br>  There is an annotation for working with callbacks in JNR. <pre>  @Delegate </pre><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GetAttrCallback</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Delegate</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getattr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String path, Pointer stbuf)</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FuseOperations</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Struct</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FuseOperations</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Runtime runtime)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(runtime); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Func&lt;GetAttrCallback&gt; getattr = func(GetAttrCallback.class); }</code> </pre><br>  After that, you can set the required callback implementation in the getattr field, for example. <br><br><pre> <code class="java hljs">fuseOperations.getattr.set((path, stbuf) -&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br><br><h3>  Enum </h3><br>  Of some non-obvious things, it is also worth noting a wrapper over enum, for this you need to inherit your enum from jnr.ffi.util.EnumMapper.IntegerEnum and implement the intValue method <br><pre> <code class="hljs swift"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">enum</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fuse_buf_flags</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-type"><span class="hljs-type">FUSE_BUF_IS_FD</span></span> = (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-type"><span class="hljs-type">FUSE_BUF_FD_SEEK</span></span> = (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-type"><span class="hljs-type">FUSE_BUF_FD_RETRY</span></span> = (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>), };</code> </pre><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> FuseBufFlags implements EnumMapper.IntegerEnum { FUSE_BUF_IS_FD(<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>), FUSE_BUF_FD_SEEK(<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">2</span></span>), FUSE_BUF_FD_RETRY(<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> value; FuseBufFlags(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> value) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.value = value; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">intValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value; } }</code> </pre><br><br><h3>  Work with memory </h3><br><ul><li>  For direct work with memory, there is a wrapper over the raw pointer jnr.ffi.Pointer </li><li>  Memory can be allocated using jnr.ffi.Memory </li><li>  The starting point of the JNR API can be considered jnr.ffi.Runtime </li></ul><br>  This knowledge is enough to easily implement a simple cross-platform wrapper over some native library. <br><br><h1>  jnr-fuse </h1><br>  What I actually did with FUSE in my <a href="https://github.com/SerCeMan/jnr-fuse">jnr-fuse</a> project.  Initially, the fuse-jna library was used, but it was she who was the bottleneck in the implementation of the file system.  When developing the API, I tried to keep compatibility with fuse-jna as well as with the native implementation (&lt;fuse.h&gt;) as much as possible. <br><br>  To implement your file system in user space, it is necessary to follow from ru.serce.jnrfuse.FuseStubFS and implement the necessary methods.  Fuse_operations contains a <a href="http://fuse.sourceforge.net/doxygen/structfuse__operations.html">lot of methods</a> , however, in order to get a working file system, you only need to implement a few basic ones. <br>  It's pretty simple, here are some <a href="https://github.com/SerCeMan/jnr-fuse/tree/master/src/main/java/ru/serce/jnrfuse/examples">examples of working FS</a> . <br><br>  Linux is currently supported (x86 and x64). <br><br>  The library is in jcenter, in the near future I will add a mirror in the maven central. <br><br><h5>  Gradle </h5><br><pre> <code class="hljs cs">repositories { jcenter() } dependencies { compile <span class="hljs-string"><span class="hljs-string">'com.github.serceman:jnr-fuse:0.1'</span></span> }</code> </pre><br><h5>  Maven </h5><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repositories</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span>central<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>bintray<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>http://jcenter.bintray.com<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repositories</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.github.serceman<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>jnr-fuse<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>0.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><h2>  Compare the performance of fuse-jna and jnr-fuse </h2><br>  In my case, FS was read-only and I was interested in specifically throughput.  The performance will depend heavily on the implementation of your file system, so if all of a sudden you are already using fuse-jna, you can easily connect jnr-fuse, write a test based on your load profile and see the difference.  (This test will come in handy anyway, we all love to chase performance, right?) <br><br>  To show the difference order, I transferred the MemoryFS implementation from fuse-jna to fuse-jnr with minimal changes and started the fio reading test.  For the test, I used the <a href="http://freecode.com/projects/fio">fio</a> framework, about which not so long ago there was a good <a href="http://habrahabr.ru/post/154235/">article on Habr√©</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Test configuration</b> <div class="spoiler_text">  [readtest] <br>  blocksize = 4k <br>  directory = / tmp / mnt / <br>  rw = randread <br>  direct = 1 <br>  buffered = 0 <br>  ioengine = libaio <br>  time_based = 60 <br>  size = 16M <br>  runtime = 60 <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Fuse-jna result</b> <div class="spoiler_text">  serce @ SerCe-FastLinux: ~ / git / jnr-fuse / bench $ fio read.ini <br>  readtest: (g = 0): rw = randread, bs = 4K-4K / 4K-4K / 4K-4K, ioengine = libaio, iodepth = 1 <br>  fio-2.1.3 <br>  Starting 1 process <br>  readtest: Laying out IO file (s) (1 file (s) / 16MB) <br>  Jobs: 1 (f = 1): [r] [100.0% done] [24492KB / 0KB / 0KB / s] [6123/0/0 iops] [eta 00m: 00s] <br>  readtest: (groupid = 0, jobs = 1): err = 0: pid = 10442: Sun Jun 21 14:49:13 2015 <br>  read: io = 1580.2MB, bw = 26967KB / s, iops = 6741, runt = 60000msec <br>  slat (usec): min = 46, max = 29997, avg = 146.55, stdev = 327.68 <br>  clat (usec): min = 0, max = 69, avg = 0.47, stdev = 0.66 <br>  lat (usec): min = 47, max = 30002, avg = 147.26, stdev = 327.88 <br>  clat percentiles (usec): <br>  |  1.00th = [0], 5.00th = [0], 10.00th = [0], 20.00th = [0], <br>  |  30.00th = [0], 40.00th = [0], 50.00th = [0], 60.00th = [1], <br>  |  70.00th = [1], 80.00th = [1], 90.00th = [1], 95.00th = [1], <br>  |  99.00th = [2], 99.50th = [2], 99.90th = [3], 99.95th = [12], <br>  |  99.99th = [14] <br>  bw (KB / s): min = 17680, max = 32606, per = 96.09%, avg = 25913.26, stdev = 3156.20 <br>  lat (usec): 2 = 97.95%, 4 = 1.96%, 10 = 0.02%, 20 = 0.06%, 50 = 0.01% <br>  lat (usec): 100 = 0.01% <br>  cpu: usr = 1.98%, sys = 5.94%, ctx = 405302, majf = 0, minf = 28 <br>  IO depths: 1 = 100.0%, 2 = 0.0%, 4 = 0.0%, 8 = 0.0%, 16 = 0.0%, 32 = 0.0%,&gt; = 64 = 0.0% <br>  submit: 0 = 0.0%, 4 = 100.0%, 8 = 0.0%, 16 = 0.0%, 32 = 0.0%, 64 = 0.0%,&gt; = 64 = 0.0% <br>  complete: 0 = 0.0%, 4 = 100.0%, 8 = 0.0%, 16 = 0.0%, 32 = 0.0%, 64 = 0.0%,&gt; = 64 = 0.0% <br>  issued: total = r = 404511 / w = 0 / d = 0, short = r = 0 / w = 0 / d = 0 <br><br>  Run status group 0 (all jobs): <br>  READ: io = 1580.2MB, aggrb = 26967KB / s, minb = 26967KB / s, maxb = 26967KB / s, mint = 60000msec, maxt = 60000msec <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Jnr-fuse result</b> <div class="spoiler_text">  serce @ SerCe-FastLinux: ~ / git / jnr-fuse / bench $ fio read.ini <br>  readtest: (g = 0): rw = randread, bs = 4K-4K / 4K-4K / 4K-4K, ioengine = libaio, iodepth = 1 <br>  fio-2.1.3 <br>  Starting 1 process <br>  readtest: Laying out IO file (s) (1 file (s) / 16MB) <br>  Jobs: 1 (f = 1): [r] [100.0% done] [208.5MB / 0KB / 0KB / s] [53.4K / 0/0 iops] [eta 00m: 00s] <br>  readtest: (groupid = 0, jobs = 1): err = 0: pid = 10153: Sun Jun 21 14:45:17 2015 <br>  read: io = 13826MB, bw = 235955KB / s, iops = 58988, runt = 60002msec <br>  slat (usec): min = 6, max = 23671, avg = 15.80, stdev = 19.97 <br>  clat (usec): min = 0, max = 1028, avg = 0.37, stdev = 0.78 <br>  lat (usec): min = 7, max = 23688, avg = 16.29, stdev = 20.03 <br>  clat percentiles (usec): <br>  |  1.00th = [0], 5.00th = [0], 10.00th = [0], 20.00th = [0], <br>  |  30.00th = [0], 40.00th = [0], 50.00th = [0], 60.00th = [0], <br>  |  70.00th = [1], 80.00th = [1], 90.00th = [1], 95.00th = [1], <br>  |  99.00th = [1], 99.50th = [1], 99.90th = [2], 99.95th = [2], <br>  |  99.99th = [10] <br>  lat (usec): 2 = 99.88%, 4 = 0.10%, 10 = 0.01%, 20 = 0.01%, 50 = 0.01% <br>  lat (usec): 100 = 0.01%, 250 = 0.01% <br>  lat (msec): 2 = 0.01% <br>  cpu: usr = 9.33%, sys = 34.01%, ctx = 3543137, majf = 0, minf = 28 <br>  IO depths: 1 = 100.0%, 2 = 0.0%, 4 = 0.0%, 8 = 0.0%, 16 = 0.0%, 32 = 0.0%,&gt; = 64 = 0.0% <br>  submit: 0 = 0.0%, 4 = 100.0%, 8 = 0.0%, 16 = 0.0%, 32 = 0.0%, 64 = 0.0%,&gt; = 64 = 0.0% <br>  complete: 0 = 0.0%, 4 = 100.0%, 8 = 0.0%, 16 = 0.0%, 32 = 0.0%, 64 = 0.0%,&gt; = 64 = 0.0% <br>  issued: total = r = 3539449 / w = 0 / d = 0, short = r = 0 / w = 0 / d = 0 <br><br>  Run status group 0 (all jobs): <br>  READ: io = 13826MB, aggrb = 235955KB / s, minb = 235955KB / s, maxb = 235955KB / s, mint = 60002msec, maxt = 60002msec <br></div></div><br><br><img src="https://habrastorage.org/files/570/301/385/570301385160406ea268c39c94a23ebf.png"><br>  The test only demonstrates the difference in the speed of reading the file in fuse-jna and fuse-jnr, however, based on it, you can get an idea of ‚Äã‚Äãthe difference in the speed of JNA and JNR.  Those who wish can always write more detailed tests for native calls with the help of <a href="http://openjdk.java.net/projects/code-tools/jmh/">JMH</a> , taking into account all the features, I myself would be interested to look at these tests. <br><br>  The difference in throughput and latency in JNR and JNA is expected, as in the presentation from Charles Nutter, is ~ 10 times. <br><br><h2>  Links </h2><br><ul><li>  <a href="http://fuse.sourceforge.net/">Fuse on sourceforge</a> </li><li>  <a href="https://github.com/jnr">JNR on github</a> </li><li>  <a href="http://www.oracle.com/technetwork/java/jvmls2013nutter-2013526.pdf">Presentation from Charles Nutter about JNR</a> </li><li>  <a href="http://openjdk.java.net/jeps/191">JEP 191</a> </li><li>  <a href="">hello-fuse on java</a> / <a href="http://fuse.sourceforge.net/helloworld.html">hello-fuse on C</a> </li></ul><br>  The jnr-fuse project is <a href="https://github.com/SerCeMan/jnr-fuse">hosted on github</a> .  I will once be asterisks, pull requests, suggestions for improving the project. <br>  And also I will be happy to answer all your questions about JNR and jnr-fuse. </div><p>Source: <a href="https://habr.com/ru/post/260801/">https://habr.com/ru/post/260801/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260787/index.html">The digest of interesting materials for the mobile developer # 108 (June 15-21)</a></li>
<li><a href="../260789/index.html">Node Webkit without webkit</a></li>
<li><a href="../260791/index.html">Howto Qemu-kvm Debian 8</a></li>
<li><a href="../260795/index.html">Hackathon in deep learning</a></li>
<li><a href="../260797/index.html">What is the best programming language to learn in 2015?</a></li>
<li><a href="../260803/index.html">Beginner site optimization guide. Part 1</a></li>
<li><a href="../260805/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 165 (June 15 - 21, 2015)</a></li>
<li><a href="../260809/index.html">Using monads in C ++. Part 1: List Monad</a></li>
<li><a href="../260811/index.html">"Her" or another fixator</a></li>
<li><a href="../260813/index.html">What's new in Babylon.js</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>