<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The second competition is CUBRID. Search for a solution</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many have probably heard that the open source project CUBRID decided to arrange a contest, and since the time for delivery of works has already ended,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The second competition is CUBRID. Search for a solution</h1><div class="post__text post__text-html js-mediator-article">  Many have probably heard that the open source project CUBRID decided to arrange a contest, and since the time for delivery of works has already ended, I will tell you about how I solved the contest task, which method I used and which features CUBRID faced. <br><br><h4>  Task (approximate) </h4><br>  Dana DB, which consists of tables containing well-defined types of columns: <pre><code class="sql hljs">VARCHAR, CHAR, STRING, INT, SMALLINT, BIGINT, NUMERIC, FLOAT, DOUBLE, DATE, TIME, DATETIME  TIMESTAMP.</code> </pre> <br>  It is required to find the most frequent non-numeric value in the database (the one that consists not only of numbers) and the number of its uses.  The answer must be recorded in the results table.  And that's it (in brief, read more on the contest page). <br><a name="habracut"></a><br><h4>  Task analysis </h4><br>  The solution can stand out from the rest only if it is faster and less demanding of RAM (+ there can be a lot of values).  Therefore, I entrusted all the statistics maintenance using the temporary table.  And the counters decided to update with the help of the prefix <code>on dublicate key update key update "count"="count"+1</code> for all insert requests.  I did not use hashing, since the tests showed that there is no use for it (most likely, CUBRID already uses hashing for string keys).  Multithreading will also not have an effect - at one point in time only one process can change the data in the table, while others have to wait (you can remove the lock, but the integrity of the data is broken). <br><br><h4>  Decision </h4><br>  The following decision comes to mind: <br><pre> <code class="php hljs">init(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(list_tables() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $table){ process_table($table); } save_result();</code> </pre> <br>  It remains to implement only 4 functions: <br><ol><li>  <code>init</code> is a function that creates a temporary table. <br>  Sample code: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">global</span></span> $tempTableName,$conn; $tempTableName=<span class="hljs-string"><span class="hljs-string">'"temp'</span></span>.rand(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">32767</span></span>).<span class="hljs-string"><span class="hljs-string">'"'</span></span>; $q=<span class="hljs-string"><span class="hljs-string">'CREATE TABLE '</span></span>.$tempTableName.<span class="hljs-string"><span class="hljs-string">'( "val" character varying(255) NOT NULL, "count" bigint DEFAULT 1 NOT NULL, CONSTRAINT pk_temp_hash_val PRIMARY KEY("val") )'</span></span>; cubrid_execute($conn,$q);</code> </pre> </li><li>  <code>list_tables</code> is a function that gets a list of tables in the current database. <br>  Since CUBRID is similar to MySql, the first thing you can do is look at <code>SHOW TABLES</code> , which, however, is not supported by version 8.3.1 (alas, there is little in the documentation about getting a list of tables in the database), so we all go to the <a href="http://www.cubrid.org/about_cubrid_web_query">Cubrid WebQuery</a> project <a href="http://www.cubrid.org/about_cubrid_web_query">page</a> and study the code.  For the most impatient I immediately quote the required sql query: <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> class_name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> table_name <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> db_class <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> class_type=<span class="hljs-string"><span class="hljs-string">'CLASS'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> is_system_class=<span class="hljs-string"><span class="hljs-string">'NO'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> class_name!=<span class="hljs-string"><span class="hljs-string">'results'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">asc</span></span>;</code> </pre> <br>  And use it in our code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      You can use the <code>cubrid_schema</code> function, but there you also need to filter the type of classes and make additional.  processing. </li><li>  <code>process_tables</code> is the most interesting function in the entire solution, which makes statistics accordingly. <br><br>  There are many possible implementation options: <br><ul><li> <code>select * + setFetchSize/cubrid_unbuffered_query</code> <br>  As my tests showed (to whom it is interesting - the java solution is also contained in the archive at the bottom of the post) - not the fastest solution. </li><li>  <code>select *</code> + condition with a call to a stored function in java type: <br> <code>where "int"&lt;0 and counter("int") or length(translate("str",'0123456789',''))&gt;0 and counter("str")</code> <br>  where <code>counter</code> saves the value in the database and returns false. <br>  However, such a request simply caused my system to freeze (most likely in CUBRID, the functions in java are not completely refined). </li><li> <code>insert from select ... on dublicate key update "count"="count"+1</code> <br>  It is this option that I position as the main one (although, in view of the errors in the php driver, when processing double values, I had to invent my crutches). </li></ul><br>  Now we need to somehow get a list of columns and their types, since it is obvious that for each type of columns their own processing can take place: <br><ul><li>  For <code>integer</code> type (or <code>decimal</code> without decimals), it suffices to check for a character. <br></li><li>  For all string values, you must delete all the digits and then check the length of the string. <br></li><li>  For all other values, no checks are needed. </li></ul><br>  The question also arises - in what format to convert the values ‚Äã‚Äãinto a string.  After much discussion on the forum, I came to the conclusion that the most ideal option is to use the same format as in the cubrid manager (when it shows the result of the select query). <br><br>  Since the same type of verification can be applied to different types of columns (+ there are still different names for the same data type), I brought all the conditions and ‚Äúaliases‚Äù into separate arrays: <br><pre> <code class="php hljs">$aliases=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"STRING"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"VARCHAR"</span></span>, <span class="hljs-string"><span class="hljs-string">'CHAR'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'VARCHAR'</span></span>, <span class="hljs-string"><span class="hljs-string">"INT"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'INTEGER'</span></span>, <span class="hljs-string"><span class="hljs-string">"SHORT"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'INTEGER'</span></span>, <span class="hljs-string"><span class="hljs-string">'SMALLINT'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'INTEGER'</span></span>, <span class="hljs-string"><span class="hljs-string">'BIGINT'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'INTEGER'</span></span>, <span class="hljs-string"><span class="hljs-string">'DECIMAL'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'NUMERIC'</span></span>, <span class="hljs-string"><span class="hljs-string">'DEC'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'NUMERIC'</span></span>, <span class="hljs-string"><span class="hljs-string">"REAL"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'FLOAT'</span></span>, <span class="hljs-string"><span class="hljs-string">"DOUBLE PRECISION"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'DOUBLE'</span></span>, ); <span class="hljs-comment"><span class="hljs-comment">// column process criteria and/or format $handlers=array( 'VARCHAR'=&gt;array( 'select'=&gt;'cast(%s as varchar(255))', 'criteria'=&gt;"length(translate(%s,'0123456789',''))&gt;0", ), 'INTEGER'=&gt;array( 'select'=&gt;'cast(%s as varchar(255))', 'criteria'=&gt;"%s&lt;0" ), 'FLOAT'=&gt;array( 'select'=&gt;"to_char(%s,'9.999999EEee')", ), 'DOUBLE'=&gt;array( 'select'=&gt;"to_char([double],'9.9999999999999999EEee')", ), 'DATE'=&gt;array( 'select'=&gt;"TO_CHAR(%s,'YYYY-MM-DD')", ), 'TIME'=&gt;array( 'select'=&gt;"TO_CHAR(%s,'HH24:MI:SS')", ), 'DATETIME'=&gt;array( 'select'=&gt;"to_char(%s,'YYYY-MM-DD HH24:MI:SS.FF')", ), 'TIMESTAMP'=&gt;array( 'select'=&gt;"to_char(%s,'YYYY-MM-DD HH24:MI:SS')", ), 'DEFAULT'=&gt;array( 'select'=&gt;'cast(%s as varchar(255))', ) );</span></span></code> </pre><br>  And finally, the final cycle: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(get_columns($q) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $column){ <span class="hljs-comment"><span class="hljs-comment">//echo "\tProcess column:".$column['column']."\n"; while(isset(self::$aliases[$column['type']])) $column['type']=self::$aliases[$column['type']]; // If column is decimal and has no precision then convert type to integer if($column['type']==='NUMERIC' &amp;&amp; $column['scale']===0) $column['type']='INTEGER'; $criteria=(isset(self::$handlers[$column['type']])) ? self::$handlers[$column['type']]: self::$handlers["DEFAULT"]; $toSelect=(isset($criteria['select'])) ? $criteria['select'] : '%s'; // Depending of the column type build appropiate criteria $q='insert into '.$tempTableName.' ("hash","val") '. 'SELECT 1,'.$toSelect.' '. 'FROM `'.$qtable.'` '. 'where %s is not null and '.$criteria.' '. 'ON DUPLICATE KEY UPDATE "count"="count"+1'; $q=str_replace('%s','`'.$this-&gt;escape($column['column']).'`',$q); cubrid_execute($q); }</span></span></code> </pre><br></li><li>  <code>save_result</code> - saves the result and deletes the temporary table <br>  In order not to overload the article I quote only an sql query to save the result. <br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'replace into results ("userid","most_duplicated_value","total_occurrences") select \''</span></span>.cubrid_real_escape_string($userid).<span class="hljs-string"><span class="hljs-string">'\',val,"count" from "'</span></span>.$tempTableName.<span class="hljs-string"><span class="hljs-string">'" order by "count" desc limit 1'</span></span></code> </pre><br>  It is used by <code>replace</code> since during testing the code is run many times, and in the case of the insert, an error will occur for the same set of verification data. </li></ol><br><h4>  findings </h4><br>  Although I sent a solution that was not completely finished to my mind (there was a problem with char and the name of the temporary table was not random, there was no check for null values ‚Äã‚Äãeither) and, at the very last moment, during that time I understood the cubrid performance and mastered java at the beginner level, practiced English and gained a lot of valuable experience.  As an experimental method, I found out that CUBRID has a very fast query interpreter, it works very quickly with tables, but it lacks support for temporary tables in RAM and good documentation (now it looks more like a brief reference).  Since CUBRID turned out to be a very productive DBMS, in the future (when some of the errors I found are corrected), I will use it in high-load projects. <br><br><h4>  Links </h4><br><ol><li>  <a href="http://www.cubrid.org/cubrid_it">Curid it</a> - competition page. </li><li>  <a href="http://www.cubrid.org/%3Fmid%3Dforum%26category%3D195511%26document_srl%3D195539">Cubrid it forum</a> - discussion page. </li><li>  <a href="http://www.cubrid.org/about_cubrid_web_query">Cubrid Webquery</a> - analog cubrid manager, contains useful sql queries. </li><li>  <a href="">Cubrid solution</a> - my solution, corrected (java + php + code to fill the test database). </li></ol><br><br>  PS: This is my first article on Habr√©, tried to take into account all the rules (but if something is wrong - write, correct, I will learn from mistakes).  I decided to transfer the topic to the sql blog (it will not work in the cubrid company blog), since there is a place for it. <br>  PS2: Habrayuser from cubrid advised a suitable blog.  Moved there. <br>  PS3: The decision of the winner of the competition is also published on Habr√© - <a href="http://habrahabr.ru/blogs/cubrid/125608/">we look</a> </div><p>Source: <a href="https://habr.com/ru/post/123727/">https://habr.com/ru/post/123727/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../123717/index.html">Common words about a web search device</a></li>
<li><a href="../123718/index.html">Flags of 254 countries by one sprite</a></li>
<li><a href="../123721/index.html">Continuing the war between customs and Russian Post</a></li>
<li><a href="../123723/index.html">Sony Ericsson Xperia Neo video review</a></li>
<li><a href="../123725/index.html">KLEE virtual machine for symbolic code execution</a></li>
<li><a href="../123728/index.html">F ** k GTD! (post good :)</a></li>
<li><a href="../123729/index.html">Every bugtracker project</a></li>
<li><a href="../123730/index.html">The latest mission of the shuttle - look online</a></li>
<li><a href="../123734/index.html">I just came to say hello!</a></li>
<li><a href="../123735/index.html">HP P6000 EVA - New Virtual Disk Arrays</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>