<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Parse the x.509 certificate</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi% username%! 

 It just so happened that despite a relatively good understanding of the public key infrastructure, the contents of * .crt files alwa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Parse the x.509 certificate</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage3/a79/4f5/a23/a794f5a230a121a5329617488b0164f9.jpg" align="left"><br>  Hi% username%! <br><br>  It just so happened that despite a relatively good understanding of the public key infrastructure, the contents of * .crt files always remained a complete mystery to me. <br>  No, don't get it wrong.  I know that the x.509 certificate contains information about the owner, the public key, the identification center information, and the electronic digital signature.  But when installing the next certificate I was always tormented by curiosity. <br>  What is the difference between a key identifier and a fingerprint?  Which certificate data is signed and which is not?  And what a data structure allows you to store all this information, reducing redundancy to a minimum. <br>  But finally curiosity overcame laziness, and in this post I will try to describe the structure of x.509 certificates and answer these and other questions. <br><a name="habracut"></a><br><h4>  Part 1. Self-signed certificate </h4><br>  To begin, consider the option of a self-signed root-level certificate. <br>  To simplify the task, we will generate a certificate that will contain only the necessary parameters: <br><ul><li>  Certificate Version </li><li>  Serial number </li><li>  Signature algorithm </li><li>  Publisher Information </li><li>  Certificate start date </li><li>  Certificate expiration date </li><li>  Owner Information </li><li>  Public key </li></ul><br>  You can do this using the Bouncy Castle library, as follows: <br><pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">button1_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> KeyGenerate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RsaKeyPairGenerator(); KeyGenerate.Init(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyGenerationParameters(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SecureRandom(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CryptoApiRandomGenerator()), <span class="hljs-number"><span class="hljs-number">1024</span></span>)); AsymmetricCipherKeyPair kp = KeyGenerate.GenerateKeyPair(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gen = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> X509V3CertificateGenerator(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> certName = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> X509Name(<span class="hljs-string"><span class="hljs-string">"CN=CA"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serialNo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigInteger(<span class="hljs-string"><span class="hljs-string">"1"</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>); gen.SetSerialNumber(serialNo); gen.SetSubjectDN(certName); gen.SetIssuerDN(certName); gen.SetNotAfter(DateTime.Now.AddYears(<span class="hljs-number"><span class="hljs-number">100</span></span>)); gen.SetNotBefore(DateTime.Now); gen.SetSignatureAlgorithm(<span class="hljs-string"><span class="hljs-string">"SHA1WITHRSA"</span></span>); gen.SetPublicKey(kp.Public); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> myCert = gen.Generate(kp.Private); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] result = DotNetUtilities.ToX509Certificate(myCert).Export(X509ContentType.Cert); FileStream fs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileStream(<span class="hljs-string"><span class="hljs-string">"D:\\test1.crt"</span></span>, FileMode.CreateNew); fs.Write(result, <span class="hljs-number"><span class="hljs-number">0</span></span>, result.Length); fs.Flush(); fs.Close(); }</code> </pre> <br><br>  As a result of this procedure, a standard x.509 certificate will be created, which, being opened with a hex editor, looks like this in a wonderful way: <br><pre> <code class="bash hljs">30 82 01 8F 30 81 F9 A0 03 02 01 02 02 01 01 30 0D 06 09 2A 86 48 86 F7 0D 01 01 05 05 00 30 0D 31 0B 30 09 06 03 55 04 03 0C 02 43 41 30 20 17 0D 31 33 30 39 31 35 31 35 33 35 30 32 5A 18 0F 32 31 31 33 30 39 32 32 31 35 33 35 30 32 5A 30 0D 31 0B 30 09 06 03 55 04 03 0C 02 43 41 30 81 9F 30 0D 06 09 2A 86 48 86 F7 0D 01 01 01 05 00 03 81 8D 00 30 81 89 02 81 81 00 8D 80 B5 8E 80 8E 94 D1 04 03 6A 45 1A 54 5E 7E EE 6D 0C CB 0B 82 03 F1 7D C9 6F ED 52 02 B2 08 C3 48 D1 24 70 C3 50 C2 1C 40 BC B5 9D F8 E8 A8 41 16 7B 0B 34 1F 27 8D 32 2D 38 BA 18 A5 31 A9 E3 15 20 3D E4 0A DC D8 CD 42 B0 E3 66 53 85 21 7C 90 13 E9 F9 C9 26 5A F3 FF 8C A8 92 25 CD 23 08 69 F4 A2 F8 7B BF CD 45 E8 19 33 F1 AA E0 2B 92 31 22 34 60 27 2E D7 56 04 8B 1B 59 64 77 5F 02 03 01 00 01 30 0D 06 09 2A 86 48 86 F7 0D 01 01 05 05 00 03 81 81 00 0A 1C ED 77 F4 79 D5 EC 73 51 32 25 09 61 F7 00 C4 64 74 29 86 5B 67 F2 3D A9 39 34 6B 3C A9 92 B8 BF 07 13 0B A0 9B DF 41 E2 8A F6 D3 17 53 E1 BA 7F C0 D0 BC 10 B7 9B 63 4F 06 D0 7B AC C6 FB CE 95 F7 8A 72 AA 10 EA B0 D1 6D 74 69 5E 20 68 5D 1A 66 28 C5 59 33 43 DB EE DA 00 80 99 5E DD 17 AC 43 36 1E D0 5B 06 0F 8C 6C 82 D3 BB 3E 2B A5 F1 94 FB 53 7B B0 54 22 6F F6 4C 18 1B 72 1C</code> </pre><br>  The same certificate, but already open using standard windows tools: <br><pre> <code class="bash hljs">  CA  CA   3   0x1  ... 15.09.2013 15:35:00 GMT  ... 22.09.2113 15:35:00 GMT   (SHA-1) F9 AD 58 B5 50 3D F6 36 5E B8 89 D4 DC C8 5F CC 25 4B 93 A2   (SHA-256) 42 02 24 20 4E 8F 3A 3E 31 38 88 E5 C5 E7 C3 03 14 3A A6 52 EA 78 B9 77 42 5B 99 EB 4B BA 23 82  (1024 )    rsaEncryption  00: 8D 80 B5 8E 80 8E 94 D1 04 03 6A 45 1A 54 5E 7E 10: EE 6D 0C CB 0B 82 03 F1 7D C9 6F ED 52 02 B2 08 20: C3 48 D1 24 70 C3 50 C2 1C 40 BC B5 9D F8 E8 A8 30: 41 16 7B 0B 34 1F 27 8D 32 2D 38 BA 18 A5 31 A9 40: E3 15 20 3D E4 0A DC D8 CD 42 B0 E3 66 53 85 21 50: 7C 90 13 E9 F9 C9 26 5A F3 FF 8C A8 92 25 CD 23 60: 08 69 F4 A2 F8 7B BF CD 45 E8 19 33 F1 AA E0 2B 70: 92 31 22 34 60 27 2E D7 56 04 8B 1B 59 64 77 5F  01 00 01    sha1WithRSAEncryption  00: 0A 1C ED 77 F4 79 D5 EC 73 51 32 25 09 61 F7 00 10: C4 64 74 29 86 5B 67 F2 3D A9 39 34 6B 3C A9 92 20: B8 BF 07 13 0B A0 9B DF 41 E2 8A F6 D3 17 53 E1 30: BA 7F C0 D0 BC 10 B7 9B 63 4F 06 D0 7B AC C6 FB 40: CE 95 F7 8A 72 AA 10 EA B0 D1 6D 74 69 5E 20 68 50: 5D 1A 66 28 C5 59 33 43 DB EE DA 00 80 99 5E DD 60: 17 AC 43 36 1E D0 5B 06 0F 8C 6C 82 D3 BB 3E 2B 70: A5 F1 94 FB 53 7B B0 54 22 6F F6 4C 18 1B 72 1C</code> </pre><br>  Having these two files, one with binary data, and the other with a description of the certificate, try to figure out what's what. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First of all, it should be noted that the * .crt file stores information about the certificate in coded form.  A special language called ASN.1 is used for encoding. <br><blockquote>  ASN.1 is a recording standard that describes data structures for representing, encoding, transmitting and decoding data.  <a href="http://ru.wikipedia.org/wiki/ASN.1">Wikipedia</a> </blockquote><br>  With the help of ASN.1 language, it is possible to describe complex structures consisting of data of different types.  A typical example of an ASN.1 file looks something like this: <br><div class="spoiler">  <b class="spoiler_title">Asn.1 file</b> <div class="spoiler_text"><pre> <code class="bash hljs">SEQUENCE(3 elem) SEQUENCE(7 elem) [0](1 elem) INTEGER 2 INTEGER 1 SEQUENCE(2 elem) OBJECT IDENTIFIER 1.2.840.113549.1.1.5 NULL SEQUENCE(1 elem) SET(1 elem) SEQUENCE(2 elem) OBJECT IDENTIFIER 2.5.4.3 UTF8String CA SEQUENCE(2 elem) UTCTime 13-09-15 15:35:02 UTC GeneralizedTime 2113-09-22 15:35:02 UTC SEQUENCE(1 elem) SET(1 elem) SEQUENCE(2 elem) OBJECT IDENTIFIER 2.5.4.3 UTF8String CA SEQUENCE(2 elem) SEQUENCE(2 elem) OBJECT IDENTIFIER 1.2.840.113549.1.1.1 NULL BIT STRING(1 elem) SEQUENCE(2 elem) INTEGER(1024 bit) INTEGER 65537 SEQUENCE(2 elem) OBJECT IDENTIFIER 1.2.840.113549.1.1.5 NULL BIT STRING(1024 bit)</code> </pre><br></div></div><br>  However, ASN.1 was developed in those bright times when ‚Äú640 KB should have been enough for everyone‚Äù and there was no way to waste space on such a bulky record.  Therefore, in order to save space, as well as more convenient processing of information stored in the ASN.1 form, a special coding method was developed - DER. <br><br>  DER encoding is described by the following rule.  The first is the byte that describes the data type, then the byte sequence that stores the data length, and then the data itself is recorded. <br><br>  For example, the following form is used to encode an integer INTEGER 65537: <font color="#0000CD">02</font> <font color="#008080">03</font> 01 00 01. <br>  Here the first byte is 02, it defines the type of INTEGER (you can find the complete type table here, for example), the second byte 03 shows the block length.  And the following bytes, 01 00 01, are the hexadecimal notation of our number 65537. <br><br>  In our case, for the description of the simplest self-signed certificate, 9 data types are sufficient.  We give the coding table for these types: <br><br><table width="200"><tbody><tr><th>  <b>Type Name</b> </th><th>  <b>Short description</b> </th><th>  <b>Type View in DER Encoding</b> </th></tr><tr><td>  SEQUENCE </td><td>  Used to describe a data structure consisting of various types. </td><td>  thirty </td></tr><tr><td>  INTEGER </td><td>  Integer. </td><td>  02 </td></tr><tr><td>  OBJECT IDENTIFIER </td><td>  A sequence of integers. </td><td>  06 </td></tr><tr><td>  UTCTime </td><td>  Temporary type, contains 2 digits to determine the year </td><td>  17 </td></tr><tr><td>  Generalizedtime </td><td>  Extended time type, contains 4 digits for the year. </td><td>  18 </td></tr><tr><td>  SET </td><td>  Describes the structure of data of different types. </td><td>  31 </td></tr><tr><td>  UTF8String </td><td>  Describes string data. </td><td>  0C </td></tr><tr><td>  Null </td><td>  Actually NULL </td><td>  05 </td></tr><tr><td>  BIT STRING </td><td>  A type for storing a bit sequence. </td><td>  03 </td></tr></tbody></table><br><br>  Knowing how each of these types is encoded, we can try parsing our * .crt file. <br><blockquote>  <font color="#0000CD">30</font> <font color="#008080">82 01 8F</font> <font color="#0000CD">30</font> <font color="#008080">81 F9</font> <font color="#0000CD">A0</font> <font color="#008080">03</font> <font color="#0000CD">02</font> <font color="#008080">01</font> 02 <font color="#0000CD">02</font> <font color="#008080">01</font> 01 <font color="#0000CD">30</font> <br>  <font color="#008080">0D</font> <font color="#0000CD">06</font> <font color="#008080">09</font> 2A 86 48 86 F7 0D 01 01 05 <font color="#0000CD">05</font> <font color="#008080">00</font> <font color="#0000CD">30</font> <font color="#008080">0D</font> <br>  <font color="#0000CD">31</font> <font color="#008080">0B</font> <font color="#0000CD">30</font> <font color="#008080">09</font> <font color="#0000CD">06</font> <font color="#008080">03</font> 55 04 03 <font color="#0000CD">0C</font> <font color="#008080">02</font> 43 41 <font color="#0000CD">30</font> <font color="#008080">20</font> <font color="#0000CD">17</font> <br>  <font color="#008080">0D</font> 31 33 30 39 31 35 31 35 33 35 30 32 5A <font color="#0000CD">18</font> <font color="#008080">0F</font> <br>  32 31 31 33 30 39 32 32 31 35 33 35 30 32 5A <font color="#0000CD">30</font> <br>  <font color="#008080">0D</font> <font color="#0000CD">31</font> <font color="#008080">0B</font> <font color="#0000CD">30</font> <font color="#008080">09</font> <font color="#0000CD">06</font> <font color="#008080">03</font> 55 04 03 <font color="#0000CD">0C</font> <font color="#008080">02</font> 43 41 <font color="#0000CD">30</font> <font color="#008080">81</font> <br>  9F <font color="#0000CD">30</font> <font color="#008080">0D</font> <font color="#0000CD">06</font> <font color="#008080">09</font> 2A 86 48 86 F7 0D 01 01 01 <font color="#0000CD">05</font> <font color="#008080">00</font> <br>  <font color="#0000CD">03</font> <font color="#008080">81 8D</font> 00 <font color="#0000CD">30</font> <font color="#008080">81 89</font> <font color="#0000CD">02</font> <font color="#008080">81 81</font> 00 8D 80 B5 8E 80 <br>  8E 94 D1 04 03 6A 45 1A 54 5E 7E EE 6D 0C CB 0B <br>  82 03 F1 7D C9 6F ED 52 02 B2 08 C3 48 D1 24 70 <br>  C3 50 C2 1C 40 BC B5 9D F8 E8 A8 41 16 7B 0B 34 <br>  1F 27 8D 32 2D 38 BA 18 A5 31 A9 E3 15 20 3D E4 <br>  0A DC D8 CD 42 B0 E3 66 53 85 21 7C 90 13 E9 F9 <br>  C9 26 5A F3 FF 8C A8 92 25 CD 23 08 69 F4 A2 F8 <br>  7B BF CD 45 E8 19 33 F1 AA E0 2B 92 31 22 34 60 <br>  27 2E D7 56 04 8B 1B 59 64 77 5F <font color="#0000CD">02</font> <font color="#008080">03</font> 01 00 01 <br>  <font color="#0000CD">30</font> <font color="#008080">0D</font> <font color="#0000CD">06</font> <font color="#008080">09</font> 2A 86 48 86 F7 0D 01 01 05 <font color="#0000CD">05</font> <font color="#008080">00</font> <font color="#0000CD">03</font> <br>  <font color="#008080">81 81</font> 00 0A 1C ED 77 F4 79 D5 EC 73 51 32 25 09 <br>  61 F7 00 C4 64 74 29 86 5B 67 F2 3D A9 39 34 6B <br>  3C A9 92 B8 BF 07 13 0B A0 9B DF 41 E2 8A F6 D3 <br>  17 53 E1 BA 7F C0 D0 BC 10 B7 9B 63 4F 06 D0 7B <br>  AC C6 FB CE 95 F7 8A 72 AA 10 EA B0 D1 6D 74 69 <br>  5E 20 68 5D 1A 66 28 C5 59 33 43 DB EE DA 00 80 <br>  99 5E DD 17 AC 43 36 1E D0 5B 06 0F 8C 6C 82 D3 <br>  BB 3E 2B A5 F1 94 FB 53 7B B0 54 22 6F F6 4C 18 <br>  1B 72 1C <br></blockquote><br>  Transforming the type identifier bytes and removing the bytes describing the length of the blocks we get the following structure: <br><pre> <code class="bash hljs">SEQUENCE(3 elem) SEQUENCE(7 elem) [0](1 elem) INTEGER 2 INTEGER 1 SEQUENCE(2 elem) OBJECT IDENTIFIER 1.2.840.113549.1.1.5 NULL SEQUENCE(1 elem) SET(1 elem) SEQUENCE(2 elem) OBJECT IDENTIFIER 2.5.4.3 UTF8String CA SEQUENCE(2 elem) UTCTime 13-09-15 15:35:02 UTC GeneralizedTime 2113-09-22 15:35:02 UTC SEQUENCE(1 elem) SET(1 elem) SEQUENCE(2 elem) OBJECT IDENTIFIER 2.5.4.3 UTF8String CA SEQUENCE(2 elem) SEQUENCE(2 elem) OBJECT IDENTIFIER 1.2.840.113549.1.1.1 NULL BIT STRING(1 elem) SEQUENCE(2 elem) INTEGER 00: 8D 80 B5 8E 80 8E 94 D1 04 03 6A 45 1A 54 5E 7E EE 6D 0C CB 0B 82 03 F1 7D C9 6F ED 52 02 B2 08 C3 48 D1 24 70 C3 50 C2 1C 40 BC B5 9D F8 E8 A8 41 16 7B 0B 34 1F 27 8D 32 2D 38 BA 18 A5 31 A9 E3 15 20 3D E4 0A DC D8 CD 42 B0 E3 66 53 85 21 7C 90 13 E9 F9 C9 26 5A F3 FF 8C A8 92 25 CD 23 08 69 F4 A2 F8 7B BF CD 45 E8 19 33 F1 AA E0 2B 92 31 22 34 60 27 2E D7 56 04 8B 1B 59 64 77 5F INTEGER 65537 SEQUENCE(2 elem) OBJECT IDENTIFIER 1.2.840.113549.1.1.5 NULL BIT STRING 00: 0A 1C ED 77 F4 79 D5 EC 73 51 32 25 09 61 F7 00 C4 64 74 29 86 5B 67 F2 3D A9 39 34 6B 3C A9 92 B8 BF 07 13 0B A0 9B DF 41 E2 8A F6 D3 17 53 E1 BA 7F C0 D0 BC 10 B7 9B 63 4F 06 D0 7B AC C6 FB CE 95 F7 8A 72 AA 10 EA B0 D1 6D 74 69 5E 20 68 5D 1A 66 28 C5 59 33 43 DB EE DA 00 80 99 5E DD 17 AC 43 36 1E D0 5B 06 0F 8C 6C 82 D3 BB 3E 2B A5 F1 94 FB 53 7B B0 54 22 6F F6 4C 18 1B 72 1C</code> </pre><br>  This is more similar to what we see when opening certificates in a browser or Windows.  Run through each element: <br><ul><li>  <b>INTEGER 2</b> is an integer describing the version of the certificate.  For certificates, version 1 is 0. </li><li>  <b>INTEGER 1</b> - the serial number of our certificate. </li><li>  <b>OBJECT IDENTIFIER 1.2.840.113549.1.1.5</b> - a sequence that describes the digital signature algorithm.  This sequence describes sha1WithRSAEncryption. </li><li>  <b>OBJECT IDENTIFIER 2.5.4.3</b> - indicates that the next field describes any information about the publisher.  Sequence 2.5.4.3, describes the property CN (common name) - a common name. </li><li>  <b>UTF8String CA</b> - publisher name. </li><li>  <b>UTCTime 13-09-15 15:35:02 UTC</b> - the date of commencement of the certificate. </li><li>  <b>GeneralizedTime 2113-09-22 15:35:02 UTC</b> is the expiration date of the certificate. </li><li>  <b>OBJECT IDENTIFIER 2.5.4.3</b> - describes the type of information about the owner. </li><li>  <b>UTF8String CA</b> - the name of the owner. </li><li>  <b>OBJECT IDENTIFIER 1.2.840.113549.1.1.1</b> - characterizes the key algorithm, in this case rsaEncryption. </li><li>  <b>INTEGER 00:</b> - certificate public key. </li><li>  <b>BIT STRING 00:</b> - certificate signature. </li></ul><br><br>  An important point that is particularly worth mentioning is the data for which the signature is calculated.  Intuitively, it may seem that all data going to the last BIT STRING field containing the signature is signed.  But actually it is not.  In the x.509 standard, a certain part of the certificate is signed, called a TBS certificate (to be signed).  The TSB-certificate includes a second-level SEQUENCE sequence with all the nested data. <br><pre> <code class="bash hljs"> SEQUENCE(7 elem) [0](1 elem) INTEGER 2 INTEGER 1 SEQUENCE(2 elem) OBJECT IDENTIFIER 1.2.840.113549.1.1.5 NULL SEQUENCE(1 elem) SET(1 elem) SEQUENCE(2 elem) OBJECT IDENTIFIER 2.5.4.3 UTF8String CA SEQUENCE(2 elem) UTCTime 13-09-15 15:35:02 UTC GeneralizedTime 2113-09-22 15:35:02 UTC SEQUENCE(1 elem) SET(1 elem) SEQUENCE(2 elem) OBJECT IDENTIFIER 2.5.4.3 UTF8String CA SEQUENCE(2 elem) SEQUENCE(2 elem) OBJECT IDENTIFIER 1.2.840.113549.1.1.1 NULL BIT STRING(1 elem) SEQUENCE(2 elem) INTEGER 00: 8D 80 B5 8E 80 8E 94 D1 04 03 6A 45 1A 54 5E 7E EE 6D 0C CB 0B 82 03 F1 7D C9 6F ED 52 02 B2 08 C3 48 D1 24 70 C3 50 C2 1C 40 BC B5 9D F8 E8 A8 41 16 7B 0B 34 1F 27 8D 32 2D 38 BA 18 A5 31 A9 E3 15 20 3D E4 0A DC D8 CD 42 B0 E3 66 53 85 21 7C 90 13 E9 F9 C9 26 5A F3 FF 8C A8 92 25 CD 23 08 69 F4 A2 F8 7B BF CD 45 E8 19 33 F1 AA E0 2B 92 31 22 34 60 27 2E D7 56 04 8B 1B 59 64 77 5F INTEGER 65537</code> </pre><br>  So  if you are faced with the task of verifying the digital signature of an x.509 certificate, then for this you first need to extract the TBS certificate. <br><br>  Another note relates to the thumbprint of the certificate.  As you can see the certificate itself does not contain any information about the fingerprint.  This is because the thumbprint is the normal SHA-1 hash value from the entire certificate file, with all its fields, including the publisher's signature.  Therefore, it is not necessary to store a fingerprint, you can simply calculate the hash every time you view the certificate. <br><br><h4>  Part 2. Level 2 Certificate </h4><br>  You and I examined the insides of a self-signed certificate, and it remains for us to understand how the structure of lower-level certificates differs from that of the root center. <br>  To do this, using the secret key of the CA certificate that we have, we will create the user certificate subordinate to it.  And this will again help us Bouncy Castle. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">button2_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> KeyGenerate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RsaKeyPairGenerator(); KeyGenerate.Init(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyGenerationParameters(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SecureRandom(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CryptoApiRandomGenerator()), <span class="hljs-number"><span class="hljs-number">1024</span></span>)); AsymmetricCipherKeyPair kp2 = kpgen.GenerateKeyPair(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gen2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> X509V3CertificateGenerator(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> certName = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> X509Name(<span class="hljs-string"><span class="hljs-string">"CN=CA"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serialNo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigInteger(<span class="hljs-string"><span class="hljs-string">"1"</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> certName2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> X509Name(<span class="hljs-string"><span class="hljs-string">"CN=User"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> certNameOwner2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> X509Name(<span class="hljs-string"><span class="hljs-string">"CN=User"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serialNo2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigInteger(<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); gen2.SetSerialNumber(serialNo2); gen2.SetSubjectDN(certName2); gen2.SetIssuerDN(certName); gen2.SetNotAfter(DateTime.Now.AddYears(<span class="hljs-number"><span class="hljs-number">100</span></span>)); gen2.SetNotBefore(DateTime.Now.Subtract(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TimeSpan(<span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>))); gen2.SetSignatureAlgorithm(<span class="hljs-string"><span class="hljs-string">"SHA1WITHRSA"</span></span>); gen2.SetPublicKey(kp2.Public); gen2.AddExtension( X509Extensions.AuthorityKeyIdentifier.Id, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AuthorityKeyIdentifier( SubjectPublicKeyInfoFactory.CreateSubjectPublicKeyInfo(kp.Public), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GeneralNames(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GeneralName(certName)), serialNo)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newCert2 = gen2.Generate(kp.Private); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] result = DotNetUtilities.ToX509Certificate(newCert2).Export(X509ContentType.Cert); FileStream fs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileStream(<span class="hljs-string"><span class="hljs-string">"D:\\FullTest.crt"</span></span>, FileMode.CreateNew); fs.Write(result, <span class="hljs-number"><span class="hljs-number">0</span></span>, result.Length); fs.Flush(); fs.Close(); }</code> </pre><br><br>  After parsing our certificate and converting it to a readable form, we get the following beauty: <br><pre> <code class="bash hljs">SEQUENCE(3 elem) SEQUENCE(8 elem) [0](1 elem) INTEGER2 INTEGER2 SEQUENCE(2 elem) OBJECT IDENTIFIER1.2.840.113549.1.1.5 NULL SEQUENCE(1 elem) SET(1 elem) SEQUENCE(2 elem) OBJECT IDENTIFIER2.5.4.3 UTF8StringCA SEQUENCE(2 elem) UTCTime13-09-15 15:35:02 UTC GeneralizedTime2113-09-22 15:35:02 UTC SEQUENCE(1 elem) SET(1 elem) SEQUENCE(2 elem) OBJECT IDENTIFIER2.5.4.3 UTF8StringUser SEQUENCE(2 elem) SEQUENCE(2 elem) OBJECT IDENTIFIER1.2.840.113549.1.1.1 NULL BIT STRING(1 elem) SEQUENCE(2 elem) INTEGER(1024 bit) INTEGER65537 [3](1 elem) SEQUENCE(1 elem) SEQUENCE(2 elem) OBJECT IDENTIFIER2.5.29.35 OCTET STRING(1 elem) SEQUENCE(3 elem) [0](20 byte) 6FBC9476035CB50061524C4ABE9064C9C4C32E6B [1](1 elem) [4](1 elem) SEQUENCE(1 elem) SET(1 elem) SEQUENCE(2 elem) OBJECT IDENTIFIER2.5.4.3 UTF8StringCA [2](1 byte) 01 SEQUENCE(2 elem) OBJECT IDENTIFIER1.2.840.113549.1.1.5 NULL BIT STRING(1024 bit)</code> </pre><br>  As you can see, the only difference from the self-signed certificate is the presence of an additional block: <br><pre> <code class="bash hljs">[3](1 elem) SEQUENCE(1 elem) SEQUENCE(2 elem) OBJECT IDENTIFIER 2.5.29.35 OCTET STRING(1 elem) SEQUENCE(3 elem) [0](20 byte) 6FBC9476035CB50061524C4ABE9064C9C4C32E6B [1](1 elem) [4](1 elem) SEQUENCE(1 elem) SET(1 elem) SEQUENCE(2 elem) OBJECT IDENTIFIER 2.5.4.3 UTF8String CA [2](1 byte) 01</code> </pre><br>  which contains information about the issuer of the certificate and its public key.  Here I would like to add one comment.  Without this block, the certificate will still remain working, since  The information stored here is considered to be nothing more than an addition, more precisely indicating which of the publisher's keys the current certificate has been signed.  Consider each element of the block separately. <br><br><ul><li>  <b>OBJECT IDENTIFIER 2.5.29.35</b> - a set of numbers describes what information is stored in the block.  The sequence 2.5.29.35 means that we have the information about the key of the signer. </li><li>  [ <b>0] (20 byte) 6FBC9476035CB50061524C4ABE9064C9C4C32E6B</b> is the key identifier of the publisher.  SHA-1 hash from DER encoded public key. </li><li>  <b>OBJECT IDENTIFIER 2.5.4.3</b> - specifies that the next field represents the name of the publisher. </li><li>  <b>[2] (1 byte) 01</b> is the serial number of the publisher's certificate. </li></ul><br>  Finally, we will open the received certificate using standard tools and make sure that all the necessary data is in place: <br><pre> <code class="bash hljs">  User  CA   3   0x2  ... 15.09.2013 15:35:00 GMT  ... 22.09.2113 15:35:00 GMT   (SHA-1) A4 E7 9B AD E7 E2 67 B1 8A D6 6F F9 61 0D 42 A9 DB C3 A9 67   (SHA-256) 39 A2 D8 47 CE F7 E7 C3 81 62 8A 4A 65 F3 4A E8 6F 12 B7 8A 1A ED F9 94 6E 57 19 F6 39 DA B7 8F  (1024 )    rsaEncryption  00: A7 BA 25 52 5F 0D 82 EE 2C B1 F0 E1 E2 0D 3F B2 10: 25 06 DB A2 5A B0 D3 00 D7 2C 1F 85 8C 71 73 95 20: 8A 06 6C 04 6D 4B AB 15 50 1E 53 92 9F BA 6E 04 30: 5D 71 6B C0 0A 8E 6C 51 51 2F 27 2E BB 8E C9 FF 40: 9C C2 E2 45 56 26 6B 61 C5 C1 67 0C 6F A9 8A 16 50: 76 8E 12 DB 38 A2 B3 09 6F B3 39 DD 9B EB 98 B7 60: 61 9F 9E 18 65 4F DB AB 74 72 79 AC 14 7C 24 D8 70: 47 16 5B 17 30 CB 6E FB 45 5E D1 04 37 FA 85 C3  01 00 01    sha1WithRSAEncryption  00: 2C 1C D9 7F B4 F2 D0 10 16 7A B7 29 D6 89 A4 A1 10: 2B 4A 78 1B 85 38 53 83 4E 71 3C 81 C0 A5 AD A8 20: AB 16 59 F4 D3 A7 7E 83 2F AE 21 75 9E 91 F6 FC 30: 93 A3 AE F5 27 CF 5F 0B C9 5F DC E1 75 26 D5 39 40: 74 32 39 B9 BD 95 79 A7 EE 02 0C 56 0A A9 A5 83 50: F8 86 0D 6F B5 7F C5 FE 23 0B 4B 5C 65 A8 BC 89 60: 36 37 B3 53 74 BB 25 66 10 F8 53 AA EF 05 9E ED 70: 74 04 E9 3D F4 DF 85 71 37 57 5D E7 D8 C6 8E EA  X509v3 Authority Key Identifier keyid:6F:BC:94:76:03:5C:B5:00:61:52:4C:4A:BE:90:64:C9:C4:C3:2E:6B DirName:/CN=CA serial:01</code> </pre><br><br><h4>  Conclusion </h4><br>  I would like to thank those diligent people who pushed through all these ASN.1 expressions and hexadecimal data sets.  I hope you had a little interesting.  And it became a little clearer what the X.509 certificate really is. <br><br>  Well, as always, few links for those who want more details. <br><ol><li>  <a href="http://tools.ietf.org/html/rfc5280">RFC5280</a> is an x.509 certificate and certificate revision list specification. </li><li>  <a href="http://pro-ldap.ru/tr/zytrax/tech/ssl.html">Survival Guide - SSL / TLS and X.509 Certificates</a> </li><li>  <a href="">ASN.1 in simple terms</a> , a <a href="http://habrahabr.ru/post/150757/">version of the article for Habr</a> </li><li>  <a href="http://lapo.it/asn1js/">on-line utility to decode DER files</a> </li><li>  <a href="http://www.itu.int/rec/T-REC-X.509-200508-S">Primary standard ITU-T X.509 (+ Russian translation)</a> .  Thanks <a href="http://habrahabr.ru/users/ystr/" class="user_link">ystr</a> for the link. </li></ol></div><p>Source: <a href="https://habr.com/ru/post/194664/">https://habr.com/ru/post/194664/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../194650/index.html">Shed Skin - an experimental translator from Python to C ++</a></li>
<li><a href="../194654/index.html">Apple iPhone 5s: autopsy, comparison with previous generations and maintainability assessment</a></li>
<li><a href="../194658/index.html">Reading Java configuration files: nProperty</a></li>
<li><a href="../194660/index.html">Articles from businessmen from Silicon Valley. Alexey Fedoseev: ‚ÄúA brave and new, but not very clear world (part 1)‚Äù</a></li>
<li><a href="../194662/index.html">Nintendo story led by Hiroshi Yamauchi</a></li>
<li><a href="../194666/index.html">The digest of news from the world of mobile development in the last week ‚Ññ25 (September 16‚Äì22, 2013)</a></li>
<li><a href="../194670/index.html">And how many drones give milk? Reverse engineering techniques in sound design</a></li>
<li><a href="../194674/index.html">Gravitational search. Gravitational search</a></li>
<li><a href="../194676/index.html">Your curious girl can unlock your Iphone 5s with your finger while you sleep</a></li>
<li><a href="../194678/index.html">NLPub Q & A</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>