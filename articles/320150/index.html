<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We break Android. How deep is the rabbit hole?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My first Android phone Galaxy Note N7000 was purchased immediately after the announcement in October 2011. Thanks to one German craftsman under the ni...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We break Android. How deep is the rabbit hole?</h1><div class="post__text post__text-html js-mediator-article"><p><img src="http://images.mobidrive.ru/news/2015/02/11/8OYhX.jpg" alt="image"></p><br><p>  My first Android phone Galaxy Note N7000 was purchased immediately after the announcement in October 2011.  Thanks to one German craftsman under the nickname bauner, I had the opportunity to use the latest version of CyanogenMod (now <a href="https://forum.xda-developers.com/galaxy-note/development/rom-nightowl-preview-t3455847">LineageOS</a> ).  Until a year and a half ago, the phone died from a Chinese car charger. </p><br><p>  I was looking for a replacement for a long time and stopped at <a href="https://ru.wikipedia.org/wiki/Kyocera">Kyocera</a> (yes, they also produce phones) KC-S701.  It differs in brutal appearance and lack of touch buttons.  I didn‚Äôt even think about root access to the phone, assuming that now every phone has the ability to get root in one way or another.  And there is a craftsman who can port CyanogenMod for him.  I was wrong. </p><br><p>  In just one and a half years, only one update was released - a <a href="https://github.com/torvalds/linux/commit/a134f083e79fb4c3d0a925691e732c56911b4326">fixed</a> kernel crash from a specially formed ping package.  And Android KitKat a year ago was not the first freshness.  Root did not receive access to this phone, and there was no information about it.  I note that the same hardware is used in the American version of the Kyocera Brigadier E6782 phone, in which the fastboot mode is activated by default and there is no restriction on the launch of unsigned cores (just launch, not firmware, and only when using the unpatched bootloader, <a href="https://www.codeaurora.org/projects/security-advisories/fastboot-boot-command-bypasses-signature-verification-cve-2014-4325">CVE-2014 -4325</a> ) and there is an opportunity to load into these modes by clamping the buttons of the phone.  Through the efforts of Verizon (and maybe Kyocera?), The Android version on Brigadier has been upgraded to Lollipop. </p><br><p>  So, I decided to deal with the process of getting root on Android on my own. </p><a name="habracut"></a><br><p>  Two months ago, I did not know anything about the Android device (and now I don‚Äôt even know more).  Most of the knowledge had to be obtained by studying source codes and experiments, since  Information about hacking Android on the Internet is very small.  The following description is valid for Android 4.4 KitKat, but it is possible that it will work on newer versions. </p><br><p>  I want to draw your attention to the fact that this review describes only my specific experience of hacking Android on a particular phone model, so be extremely careful with using it in your practice if you don‚Äôt want to suddenly get a dead phone.  Before starting research, I recommend that you forget that you use a hacked phone in everyday life and make a backup with a hard reset.  This will protect your data when you make a mistake. </p><br><p>  The article describes not only the actions that led to success, but also errors.  I hope that my attempts to get to the bottom of the truth and the numerous rakes will be interesting to you. </p><br><p>  All studies were conducted in a Linux environment. </p><br><h1 id="dirtycow-cve-2016-5195">  Dirtycow (CVE-2016-5195) </h1><br><p> With simple words, dirtycow (a <a href="https://github.com/timwr/CVE-2016-5195">working exploit</a> for Android) allows you to replace the memory of any process (useful if you know ASM well) or any readable file, even if it is on the readonly file system.  It is desirable that the file being replaced is less than or equal in size to the one being replaced.  The main attack in dirtycow for Android is the substitution of <code>/system/bin/run-as</code> , a kind of <code>sudo</code> for debugging applications.  Starting with the <strong>android-19</strong> API (API and Android version correspondence <a href="https://source.android.com/source/build-numbers.html">table</a> ) <code>/system/bin/run-as</code> has <strong>CAP_SETUID</strong> and <strong>CAP_SETGID</strong> capabilities flags (older versions use the usual suid bit - 6755). </p><br><pre> <code class="hljs swift">$ getcap bin/run-<span class="hljs-keyword"><span class="hljs-keyword">as</span></span> bin/run-<span class="hljs-keyword"><span class="hljs-keyword">as</span></span> = cap_setgid,cap_setuid+ep</code> </pre> <br><p>  If the file system is mounted in read-write mode, then everything that replaces dirtycow will end up on the file system.  Therefore, it is necessary to make a backup of the original file and restore it after getting access, or not to remount the file system in read-write mode.  As a rule, the <em>/ system</em> partition in Android is by default mounted in read-only mode. </p><br><p>  No wonder dirtycow is considered one of the most serious vulnerabilities discovered in Linux.  And if you have knowledge with dirtycow, you can bypass all levels of kernel protection, including SELinux. </p><br><h1 id="selinux">  SELinux </h1><br><p>  For starters, you can read about how SELinux contexts work.  A nice article on the Gentoo wiki: <a href="https://wiki.gentoo.org/wiki/SELinux/Tutorials/How_does_a_process_get_into_a_certain_context">https://wiki.gentoo.org/wiki/SELinux/Tutorials/How_does_a_process_get_into_a_certain_context</a> </p><br><p>  In short, then: </p><br><ul><li>  the context of the SELinux process can be changed if such an operation is described in the sepolicy rules.  In the version of Android 4.4 (KitKat) it is possible to elevate privileges by changing the context.  But starting from 5.x it can not be done. </li><li>  There are file contexts. </li><li>  In addition to the context of files and processes in Android, contexts for <strong>property_contexts</strong> parameters are implemented. </li></ul><br><h1 id="adbd-i-konsol">  adbd and console </h1><br><p>  The only available way to get a relatively privileged shell in production Android devices is developer mode.  Developer mode starts the adbd daemon, which can act as an analogue of ssh / telnet.  In Android KitKat, it is located in <a href="https://en.wikipedia.org/wiki/Initramfs">initramfs</a> along the path <code>/sbin/adbd</code> and is not readable for non-root users.  Initially, adbd runs as root and works in the SELinux context / init domain (used by the init process and usually has more privileges than other domains).  If the process context is explicitly specified in <code>/init.rc</code> , for example <strong>seclabel u: r: adbd: s0</strong> , then the process starts immediately in the specified context.  When initializing adbd, depending on the compilation parameters ( <a href="https://source.android.com/source/building.html">user, userdebug or eng,</a> and Android parameters ( <a href="http://rxwen.blogspot.com/2010/01/android-property-system.html%5D">properties</a> ), lowers privileges, namely, changes the current user from root to shell, sets the SELinux context to the <strong>shell,</strong> and cuts off all system capabilities except <strong>CAP_SETUID</strong> and <strong>CAP_SETGID</strong> for debugging applications via <code>run-as</code> . The so-called Capability Bounding Set does not allow children to upgrade their capabilities, only lower them. These privileges allow you to do a little more than nothing on your phone. You can view the current process's capabilities using the <code>cat /proc/self/status | grep CapBnd</code> . A p  sshifrovat them with the command <code>capsh</code> (not available on Android), for example: </p><br><pre> <code class="hljs pgsql">$ capsh <span class="hljs-comment"><span class="hljs-comment">--decode=0000001fffffffff</span></span></code> </pre> <br><p>  The current SELinux context can be viewed with the <code>id</code> command or <code>cat /proc/self/attr/current</code> .  The previous process context can be viewed with the <code>cat /proc/self/attr/prev</code> command. </p><br><p>  View context files: <code>ls -Z</code> <br>  View the context of running processes: <code>ps -Z</code> </p><br><h1 id="poluchaem-root-dostup">  Get root access </h1><br><h2 id="root-da-ne-tot">  root, not that </h2><br><p>  The first thing I did was using dirtycow for the intended purpose - I replaced <code>/system/bin/run-as</code> , which set the UID / GID to 0 (su does the same thing).  However, I could not mount the file system, even tmpfs.  I also could not load kernel modules.  View dmesg - no.  I could not even browse directories that had 700 permissions and belonged to other system users.  I could only read and write to block devices, and browsing files or directories was possible thanks to specifying the user‚Äôs UID / GID (I wrote my own <a href="">bike</a> - an analogue of su, which could set selinux context and user / group). </p><br><p>  The first thing I did was dump all the firmware, boot and recovery: </p><br><pre> <code class="hljs ruby">$ dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=<span class="hljs-regexp"><span class="hljs-regexp">/dev/block</span></span><span class="hljs-regexp"><span class="hljs-regexp">/mmcblk0 of=/storage</span></span><span class="hljs-regexp"><span class="hljs-regexp">/sdcard1/mmcblk</span></span><span class="hljs-number"><span class="hljs-number">0</span></span>.img $ dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=<span class="hljs-regexp"><span class="hljs-regexp">/dev/block</span></span><span class="hljs-regexp"><span class="hljs-regexp">/platform/msm</span></span>_sdcc.<span class="hljs-number"><span class="hljs-number">1</span></span>/by-name/boot of=<span class="hljs-regexp"><span class="hljs-regexp">/storage/sdcard</span></span>1/boot.img $ dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=<span class="hljs-regexp"><span class="hljs-regexp">/dev/block</span></span><span class="hljs-regexp"><span class="hljs-regexp">/platform/msm</span></span>_sdcc.<span class="hljs-number"><span class="hljs-number">1</span></span>/by-name/recovery of=<span class="hljs-regexp"><span class="hljs-regexp">/storage/sdcard</span></span>1/recovery.img</code> </pre> <br><p>  You can explore the dump with the utilities <code>kpartx</code> and <a href="https://github.com/osm0sis/mkbootimg"><code>unpackbootimg</code></a> .  The <code>kpartx -a mmbblk0.img</code> creates a virtual block device accessible by the path <code>/dev/mapper/loop0</code> .  You can work with it as with any other block device.  Dumps of the boot and recovery sections were unpacked with the <code>unpackbootimg</code> utility. </p><br><p>  Then I tried to write to recovery <code>/dev/zero</code> , check and immediately restore from dump. </p><br><p>  Since I could write to block devices, it means I could write custom recovery.  I found TWRP from Brigadier, flashed it in recovery and rebooted into it <code>adb reboot recovery</code> .  TWRP I did not see, but only the Android icon with an exclamation mark.  This is what a standard recovery looks like, which means TWRP has not flashed. </p><br><p>  I reboot into normal mode, launch an exploit, check the hash recovery section - hash corresponds to the original.  I try to write data again - hash has changed!  I remember about page cache, I clean ( <code>echo 3 &gt; /proc/sys/vm/drop_caches</code> ) - hash is old.  Those.  everything that I write to the block device flies without errors to / dev / null and sometimes lands in the Linux cache.  But is the firmware update somehow happening?  And user data is somehow written to internal memory.  We must dig further. </p><br><h2 id="probuem-otklyuchit-selinux">  Trying to disable SELinux </h2><br><p>  At that time, I thought that all errors about the absence of privileges were caused by SELinux (I completely forgot that the capabilities can be trimmed).  I did not see the logs of dmesg, logcat did not show anything relevant.  And I started thinking how to disable SELinux. </p><br><p>  The first clue I could find: </p><br><pre> <code class="hljs pgsql">$ grep -A2 reload_policy boot/ramfs/init.rc <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> property:selinux.reload_policy=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> ueventd <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> installd</code> </pre> <br><p>  <a href="">Sources</a> indicate that when this option is changed, init reloads SELinux policies from the <code>/sepolicy</code> file. </p><br><p>  Those.  I can use dirtycow to overwrite <code>/sepolicy</code> and use the <code>setprop selinux.reload_policy 1</code> command <code>setprop selinux.reload_policy 1</code> load the updated policy. </p><br><p>  First you need to find out what is <code>/sepolicy</code> .  You can explore it with the <code>sesearch</code> (the setools package in Debian). </p><br><pre> <code class="hljs ruby">$ sesearch --allow sepolicy $ sesearch --neverallow sepolicy $ sesearch --auditallow sepolicy $ sesearch --dontaudit sepolicy</code> </pre> <br><p>  In my case <code>/sepolicy</code> contained only <strong>allow</strong> , which means - when enforcing SELinux mode on Android, it is allowed to do only what is declared in the policy.  And the init process was only allowed to load the policy, but not disable it: </p><br><pre> <code class="hljs perl">$ sesearch --allow sepolicy | <span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> <span class="hljs-string"><span class="hljs-string">'load_policy'</span></span> allow init kernel : security load_policy ;</code> </pre> <br><p>  My task was to allow the init context to set selinux-&gt; enforce to permissive (setenforce 0). </p><br><p>  The first thing I did was collect the standard Android stock policy, replace the original <code>/sepolicy</code> , upload ( <code>setprop selinux.reload_policy 1</code> as root) set and received a message in the status line that the phone is in unprotected mode.  After that, the phone refused to launch applications, became very thoughtful, I also failed to set the permissive mode, and in the end the phone rebooted.  A negative result is also a result, the replacement <code>/sepolicy</code> worked. </p><br><p>  The very first thought: the stock policy does not fit this phone and it starts to blunt in the absence of rights. </p><br><p>  I put together a new policy in which I simply described all existing SELinux context and declared them permissive.  It also did not help. </p><br><p>  Then I decided to rebuild the policy and, if possible, add privileges to the shell context. </p><br><p>  I found <a href="https://ge0n0sis.github.io/posts/2015/12/exploring-androids-selinux-kernel-policy/">an article</a> that says how to "decompile" a policy.  A little tricky I was able to collect all the dependencies and run the <a href="https://github.com/kayrus/sedump/"><code>sedump</code></a> utility.  At the output, I received a text file that I was able to collect back (for KitKat <code>checkpolicy -M -c 26 -o sepolicy.new policy.conf</code> ) and even get a file with exactly the same size as the original <code>sepolicy</code> , but with different hex contents.  Downloading a new policy caused exactly the same results as before - the phone rebooted after a while. </p><br><p>  I decided to put together two policies: from <code>policy.conf</code> , which I received and from <code>policy.conf</code> , which added all the privileges for <code>allow init kernel : security</code> , including <strong>setenforce</strong> .  Compare files in hex and, by analogy, replace bytes in the original <code>sepolicy</code> . </p><br><p>  As it turned out, two reassembled policies differed only in a couple of bytes.  I began to look for similar matches in the original <em>sepolicy</em> , but did not find it.  Then I just wrote a brute force script, which in the given range of displacements replaces the two bytes with "0xFF, 0xFF", starts <code>sesearch --allow | grep " "</code>  <code>sesearch --allow | grep " "</code> .  So I found the necessary bias in the original policy, replaced the bytes, replaced the original policy and nothing.  Disabling selinux again failed. </p><br><p>  A little later, I found the <a href="https://bitbucket.org/joshua_brindle/sepolicy-inject/">sepolicy-inject utility</a> , which adds privileges to an already compiled <code>sepolicy</code> file.  If the rule already exists, adding maximum privileges does not increase the final size of the policy.  Unfortunately, running the utility adds just one rule at a time.  Wrote a script that adds maximum privileges for each rule.  The result was a file with a policy in which each rule contained maximum privileges.  File size is the same as the original.  And this again did not help. </p><br><p>  Then I learned that in Android there is a <code>load_policy</code> command that reloads the policy in any way.  Dances with a tambourine were superfluous. </p><br><pre> <code class="hljs pgsql">adb shell run-<span class="hljs-keyword"><span class="hljs-keyword">as</span></span> /data/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/tmp/run -u <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> -cu:r:init:s0 load_policy /data/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/tmp/sepolicy.<span class="hljs-built_in"><span class="hljs-built_in">new</span></span></code> </pre> <br><p>  It was possible to add any permissive domain, download a new policy and work in the context of this domain (by the way, chainfire supersu for new versions of Android <a href="https://su.chainfire.eu/">works just like that</a> ).  But even this did not make it possible to disable SELinux.  I decided to dig in the other direction. </p><br><h2 id="kopaem-recovery">  Digging recovery </h2><br><p><img src="https://habrastorage.org/files/4f0/d3c/ea5/4f0d3cea5c47403880f8a7202badca5e.png" alt="image"></p><br><p>  Checking the difference between the boot and recovery sections.  Everything is identical except initramfs.  In the recovery section initramfs, I study init.rc, which describes only one service that runs <code>/sbin/recovery</code> .  I study <code>strings sbin/recovery | less</code>  <code>strings sbin/recovery | less</code> , then the <a href="">source code of the original recovery</a> .  As you can see, by default, recovery simply displays the Android logo.  And if something needs to be done, then in the normal mode, the <code>/cache/recovery/command</code> file is written to the <code>/cache/recovery/command</code> partition, which may contain startup parameters for recovery.  If we write <code>--show_text</code> to this file, we should see the menu. </p><br><p>  I run dirtycow exploit, set the UID / GID, write the file and run <code>adb reboot recovery</code> .  The phone restarts and I get to the standard recovery menu.  Already something.  I try to flash a zip file with supersu via <code>adb sideload</code> .  The operation is aborted with an error.  I don‚Äôt really look at the error, but climb into the recovery code and look for the place responsible for checking the digital signature of the ZIP file. </p><br><p>  I find out that initramfs contains the <code>res/keys</code> public key in <a href="https://github.com/IanHarvey/minicrypt">minicrypt</a> format, which verifies the digital signature of the ZIP file.  It turned out to be the standard Android <a href="">test key</a> , and that I can sign any archive with this <a href="">key</a> .  You can check this as follows: </p><br><pre> <code class="hljs perl">java -jar dumpkey.jar android/bootable/recovery/testdata/testkey.x509.pem &gt; mykey diff -u mykey res/<span class="hljs-keyword"><span class="hljs-keyword">keys</span></span></code> </pre> <br><p>  I tried to install ZIP directly from sdcard, but an error occurred during recovery when mounting a sdcard.  Studied <code>etc/recovery.fstab</code> , it turned out that in recovery mode, sdcard is mounted as vfat: </p><br><pre> <code class="hljs perl">$ <span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> mmcblk1 recovery/ramfs/etc/recovery.fstab /dev/block/mmcblk1p1 /sdcard vfat nosuid,nodev,barrier=<span class="hljs-number"><span class="hljs-number">1</span></span>,data=ordered,nodelalloc <span class="hljs-keyword"><span class="hljs-keyword">wait</span></span></code> </pre> <br><p>  My 64Gb flash drive was formatted in exfat.  I found an old sdcard on 2Gb, formatted it as vfat, recorded a ZIP, inserted it into my phone.  Recovery this time was able to mount the card and I could view its contents on the phone.  However, when installing the ZIP again, an error occurred: <strong>E: failed to set up expected mounts for install;</strong>  <strong>aborting</strong> . </p><br><p>  The <code>strings recovery</code> team showed that this recovery is different from the stock one, at least there were strings related to Kyocera, and most likely to cleaning the <code>/data</code> partition.  Having rummaged in the original source code, I found out that the error I was interested in appears in the <code>setup_install_mounts</code> function in the <code>setup_install_mounts</code> file. </p><br><p>  Those.  before applying ZIP, recovery unmounts all partitions, but in my case something goes wrong. </p><br><h2 id="kopaem-ishodniki-yadra">  Digging kernel sources </h2><br><p>  The GPL license obliges smartphone manufacturers to upload kernel sources.  Thanks to Linus and Stallman for this.  Sometimes manufacturers put something left, sometimes the right source, but without a <code>defconfig</code> file, sometimes right and very rarely with instructions on how to compile them (for example LG). </p><br><p>  In my case, there were source codes with the correct <code>defconfig</code> but without instructions.  A little sweating, I was able to assemble the <a href="">core</a> and made sure that it was not a complete linden. </p><br><p>  After a long time I stopped at two files: </p><br><ul><li>  <a href="">https://github.com/kayrus/kc-s701-torque-kernel/blob/master/security/selinux/hooks.c</a> </li><li>  <a href="">https://github.com/kayrus/kc-s701-torque-kernel/blob/master/arch/arm/mach-msm/restart.c</a> </li></ul><br><h2 id="hooks">  hooks </h2><br><p>  Kyocera did not think for a long time, but simply wrote hooks on potentially dangerous operations on Android: <code>mount</code> , <code>umount</code> , <code>insmod</code> (only one module is allowed to load - <code>wlan</code> and only if it is loaded by the init process), and so on.  This is where the recovery problem was.  He could not unmount the file system <code>/system</code> !  These operations were allowed only to the init process.  Including I could not disable SELinux because this feature was disabled when the kernel was compiled.  It was possible to bypass these hooks only if the kernel was loaded with certain parameters ( <strong>kcdroidboot.mode = f-ksg</strong> or <strong>androidboot.mode = kcfactory</strong> , more about them later). </p><br><h2 id="restart">  restart </h2><br><p>  Also an interesting file to learn.  It describes the possible options for downloading the phone: </p><br><ul><li>  <strong>adb reboot bootloader</strong> - fastboot mode, not available on my phone ( <code>0x77665500</code> - hex tag 00556677 in the sbl1 section) </li><li>  <strong>adb reboot recovery</strong> - <strong>recovery</strong> mode ( <code>0x77665502</code> - hex label 02556677 in the sbl1 section) </li><li>  <strong>adb reboot rtc</strong> - the so-called ALARM_BOOT.  I did not understand why, there is no label in sbl1.  Perhaps it means <a href="https://developer.android.com/reference/android/app/AlarmManager.html">https://developer.android.com/reference/android/app/AlarmManager.html</a> </li><li>  <strong>adb reboot oem-X</strong> (in my case oem-1, <code>0x6f656d01</code> - hex tag 016d656f in the sbl1 section).  What happens during this mode is set by the manufacturer.  Judging by the source code, the phone reboots into this mode if the firmware authentication fails from the modem section. </li><li>  <strong>adb reboot edl</strong> - emergency download, translates the phone into standard qualcomm download mode.  The phone is defined as <strong>QHSUSB__BULK</strong> COM port, through which you can transfer the signed bootloader (if not mistaken, each bootloader is designed for one type of SoC and phone manufacturer) and perform low-level operations with the phone, including flash.  Commonly used with QPST.  For some phones, the downloaders are leaking into the network, for example, for Kyocera KYL22.  Where they come from is unknown to me. </li><li>  A certain <strong>download mode</strong> , which does not go through <strong>adb reboot</strong> .  Here it is interesting ... But more on that later. </li></ul><br><p>  A little about how to boot on phones with a Qualcomm processor: </p><br><p>  The built-in ROM boot loader Qualcomm (pbl - primary bootloader) loads the sbl1 partition (secondary bootloader).  sbl1 loads tz (trust zone), then aboot (android boot, little kernel, lk).  Aboot in turn loads boot, recovery or fota. </p><br><p>  Description of sections involved in the boot: </p><br><ul><li>  tz - Qualcomm Trust Zone.  Performs low-level operations, including working with QFuses (rpmb section). </li><li>  rpm - Resource and Power Manager firmware.  Firmware for specialized SoC, responsible for resources and power. </li><li>  sdi - trust zone storage partition.  Data that is used by the Trust Zone. </li></ul><br><p>  All these sections are signed by a chain of certificates. </p><br><h2 id="fota">  fota </h2><br><p>  In some cases, it is useful to ignore firmware updates. </p><br><p>  FOTA - firmware over the air.  Unlike boot and recovery, fota is an unofficial Android boot mode.  The task of fota is to update the firmware.  Kyocera uses a solution from <a href="https://en.wikipedia.org/wiki/Red_Bend_Software">Red Bend</a> for this, which in 35Mb can accommodate not only the kernel update but also the <code>/system</code> partition.  Therefore, writing to the <code>/system</code> section is prohibited, otherwise applying a patch to the wrong data may mimic the phone. </p><br><p>  There was an update on my phone.  I could venture on it because I already had the opportunity to write to <code>/cache</code> and interrupt the update at any time. </p><br><p>  After examining the sources responsible for updating the <a href="http://www.javadecompilers.com/apktool">Java application</a> , it became clear to me how it happens: </p><br><ul><li>  The Java application downloads the special file <code>/cache/delta/boot_delta.bin</code> , creates the file <code>/cache/delta/Alt-OTA_dlcomplete</code> , confirming successful download of the file, and other files with headers. </li><li>  When you confirm the update, the presence of these files is checked again. </li><li>  If the files are in place, then the <code>libjnialtota.so</code> is modified through the library <code>fotamng</code> . </li><li>  A reboot occurs. </li></ul><br><p>  The reboot does not happen instantly, so I have the opportunity to delete the file before rebooting and see what happens with the fotamng section. </p><br><p>  I am writing a command that continuously dumps a partition and renames <code>/cache/delta/boot_delta.bin</code> .  I launch it immediately after the agreement to restart the phone.  The phone reboots into FOTA mode, reports the absence of the update, and reboots into normal mode. </p><br><p>  Begin to study the data that sdampil.  In the <code>/cache</code> section, I get fota logs, which even have dmseg logs!  The reboot itself in the fota is initialized with the bytes "1" in the fotamng section: </p><br><pre> <code class="hljs ruby">$ dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=<span class="hljs-regexp"><span class="hljs-regexp">/data/local</span></span><span class="hljs-regexp"><span class="hljs-regexp">/tmp/one</span></span>_bit.bin of=<span class="hljs-regexp"><span class="hljs-regexp">/dev/block</span></span><span class="hljs-regexp"><span class="hljs-regexp">/platform/msm</span></span>_sdcc.<span class="hljs-number"><span class="hljs-number">1</span></span>/by-name/fotamng seek=<span class="hljs-number"><span class="hljs-number">16</span></span> bs=<span class="hljs-number"><span class="hljs-number">1</span></span> count=<span class="hljs-number"><span class="hljs-number">1</span></span> $ dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=<span class="hljs-regexp"><span class="hljs-regexp">/data/local</span></span><span class="hljs-regexp"><span class="hljs-regexp">/tmp/one</span></span>_bit.bin of=<span class="hljs-regexp"><span class="hljs-regexp">/dev/block</span></span><span class="hljs-regexp"><span class="hljs-regexp">/platform/msm</span></span>_sdcc.<span class="hljs-number"><span class="hljs-number">1</span></span>/by-name/fotamng seek=<span class="hljs-number"><span class="hljs-number">24</span></span> bs=<span class="hljs-number"><span class="hljs-number">1</span></span> count=<span class="hljs-number"><span class="hljs-number">1</span></span> $ dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=<span class="hljs-regexp"><span class="hljs-regexp">/data/local</span></span><span class="hljs-regexp"><span class="hljs-regexp">/tmp/one</span></span>_bit.bin of=<span class="hljs-regexp"><span class="hljs-regexp">/dev/block</span></span><span class="hljs-regexp"><span class="hljs-regexp">/platform/msm</span></span>_sdcc.<span class="hljs-number"><span class="hljs-number">1</span></span>/by-name/fotamng seek=<span class="hljs-number"><span class="hljs-number">131088</span></span> bs=<span class="hljs-number"><span class="hljs-number">1</span></span> count=<span class="hljs-number"><span class="hljs-number">1</span></span> $ dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=<span class="hljs-regexp"><span class="hljs-regexp">/data/local</span></span><span class="hljs-regexp"><span class="hljs-regexp">/tmp/one</span></span>_bit.bin of=<span class="hljs-regexp"><span class="hljs-regexp">/dev/block</span></span><span class="hljs-regexp"><span class="hljs-regexp">/platform/msm</span></span>_sdcc.<span class="hljs-number"><span class="hljs-number">1</span></span>/by-name/fotamng seek=<span class="hljs-number"><span class="hljs-number">131096</span></span> bs=<span class="hljs-number"><span class="hljs-number">1</span></span> count=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p>  After a reboot, they are reset.  In dmesg, I noticed the presence of the kernel parameter <strong>kcdroidboot.mode = f-ksg</strong> .  Here it is!  Those.  bootloader removes protection for fota.  And theoretically, if I write the boot partition to the fota and reboot the phone to this mode, then I will get a kernel with Kyocera protection disabled.  But I still cannot write to system partitions. </p><br><h2 id="izuchenie-ishodnikov-little-kernel-lk">  Studying the little kernel source (lk) </h2><br><p>  What is in the aboot section is the Android downloader, the vanilla source code of which is located at: <a href="https://source.codeaurora.org/quic/la/kernel/lk/">https://source.codeaurora.org/quic/la/kernel/lk/</a> </p><br><p>  There you can find information about how to load in some of the modes.  For example, I found information that if you write "boot-recovery" in the misc section, you can <a href="">reboot into recovery</a> without <strong>adb reboot recovery</strong> .  When loaded into recovery, this <a href="">label is reset</a> .  And if recovery cannot boot, the phone will end up in the boot loop and you will lose it.  So be careful, but rather avoid this reboot option. </p><br><p>  There you can also find the code that translates the emmc system area into <a href="">read-only</a> mode.  The answer to the question why it is impossible to overwrite recovery.  This protection can be disabled from the Linux kernel. <del>  if you write the corresponding kernel module </del>  .  <a href="https://github.com/hiikezoe/android_mmc_protect">Everything is already written by a</a> friend from the land of the rising sun, who, it seems, also breathes unevenly to Kyocera telephones.  The module did not work the first time, sometimes it hangs mmc in claim mode.  Perhaps not everything is so clear and requires detailed research. </p><br><p>  This is how the signature of the boot sections is verified: <a href="">https://source.codeaurora.org/quic/la/kernel/lk/tree/platform/msm_shared/image_verify.c?h=LA.BR.1.3.3_rb2.29</a> </p><br><h1 id="pervye-uspehi">  First successes </h1><br><h2 id="dmesg">  dmesg </h2><br><p>  Google helped me answer the question why I cannot read the kernel logs: <a href="https://www.kernel.org/doc/Documentation/sysctl/kernel.txt"><code>/proc/sys/kernel/dmesg_restrict</code></a> .  The value of this parameter is set to 1 while the phone is loading.  If the user does not have <strong>CAP_SYS_ADMIN</strong> capability, then the logs are not available to him. </p><br><h2 id="uevent_helper">  uevent_helper </h2><br><p>  In my case, surprisingly, it was possible to set <code>/sys/kernel/uevent_helper</code> .        executable  (shell script  ),          init   init      full capabilities. </p><br><p>   : </p><br><pre> <code class="hljs mel">#!/<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>/bin/sh echo <span class="hljs-number"><span class="hljs-number">0</span></span> &gt; /<span class="hljs-keyword"><span class="hljs-keyword">proc</span></span>/sys/kernel/dmesg_restrict</code> </pre> <br><p>          <code>/sys/kernel/uevent_helper</code> .      dmesg! </p><br><h2 id="patchennyy-adbd">  adbd </h2><br><p><img src="https://habrastorage.org/files/913/9bf/21e/9139bf21e1464df3a865b603fd59ea9e.png" alt="image"></p><br><p>  Since        Android,    adbd  ,      adbd <del>     </del>  .     70 Gb  Android,        .       capabilities, ,  <code>/sbin/adbd</code>    root .      ,  dmesg   <strong>dmesg_restrict</strong> ,     ,    root   .       <code>/system</code>      . </p><br><p> ,    ,  <a href="https://github.com/baselsayeh/custombackdoorlshserver">lsh</a>      <code>/sys/kernel/uevent_helper</code> .    lsh  ,   <code>PATH</code> environment,        . </p><br><h2 id="wifi">  WiFi </h2><br><p> WiFi       . WiFi  ‚Äî  . WiFi  ‚Äî  .     ,    WiFi    .        . ,   ,     ,   SELinux      Amazon Fire Phone: <a href="https://github.com/chaosmaster/ford_selinux_permissive">https://github.com/chaosmaster/ford_selinux_permissive</a> </p><br><p>   ,  -      Module.symvers.      ,    ,  <code>Module.symvers</code> ,       . </p><br><p>        ( <strong>disagrees about version of symbol module_layout</strong> ),    <code>Module.symvers</code>  <code>boot</code> .   ,   <a href="https://github.com/glandium/extract-symvers">https://github.com/glandium/extract-symvers</a> : </p><br><pre> <code class="hljs matlab">$ unpackbootimg -<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> boot.img -o boot $ extract-symvers.py -e le -B <span class="hljs-number"><span class="hljs-number">0xc0008000</span></span> boot/boot.img-zImage &gt; <span class="hljs-comment"><span class="hljs-comment">%PATH_TO_KERNEL%/Module.symvers</span></span></code> </pre> <br><p>           Kyocera. </p><br><p><img src="https://habrastorage.org/files/441/057/0f5/4410570f50904b67afab8278a6145e19.jpg" alt="image"></p><br><p>  <a href=""></a>    ?    wlan   .   : </p><br><ul><li>  symlink <code>wlan.c</code>    </li><li>  Makefile </li></ul><br><pre> <code class="hljs erlang">... MODULE_NAME = wlan ...</code> </pre> <br><p>     (,    wlan ,   lsmod),  SELinux  . </p><br><p>  dmesg       .   ,       : <code>/proc/sys/kernel/printk</code> ,   INFO ,    .     : <code>echo '8 8 8 8' &gt; /proc/sys/kernel/printk</code> .    ,       ,   SELinux  . </p><br><p> ,    ,       WiFi.   / WiFi    Android. </p><br><h2 id="pishem-svoy-modul">    </h2><br><h3 id="snimaem-zaschitu">   </h3><br><p> SELinux   ,      <a href="https://github.com/chaosmaster/ford_selinux_permissive">https://github.com/chaosmaster/ford_selinux_permissive</a>     ,   Kyocera hooks.      <strong>kc_bootmode</strong>  <strong>kc_kbfm</strong>  . </p><br><p>   Linux         : <code>cat /proc/kallsyms</code> .       0.     .    : <code>echo 0 &gt; /proc/sys/kernel/kptr_restrict</code> . </p><br><p>    ,            1.   ,      kallsyms   ( <strong>d</strong>  <strong>D</strong> ,      ),        .     <code>CONFIG_KALLSYMS_ALL</code>   . </p><br><pre> <code class="hljs ruby">$ adb shell <span class="hljs-string"><span class="hljs-string">"grep kc_bootmode_setup /proc/kallsyms"</span></span> c0d19d84 t kc_bootmode_setup</code> </pre> <br><p>    : </p><br><pre> <code class="hljs delphi">int <span class="hljs-comment"><span class="hljs-comment">(*_kc_bootmode_setup)(char *buf) = (int(*)</span></span>()) <span class="hljs-number"><span class="hljs-number">0</span></span>xc0d19d84;</code> </pre> <br><p>   : </p><br><pre> <code class="hljs lisp">_kc_bootmode_setup(<span class="hljs-string"><span class="hljs-string">"f-ksg"</span></span>)</code> </pre> <br><p>    : </p><br><pre> <code class="hljs lisp">_kc_bootmode_setup = (<span class="hljs-name"><span class="hljs-name">int</span></span> (<span class="hljs-name"><span class="hljs-name">*</span></span>)(<span class="hljs-name"><span class="hljs-name">char</span></span> *buf))kallsyms_lookup_name("kc_bootmode_setup");</code> </pre> <br><p>  <a href="https://github.com/kayrus/break_free"> </a>   !     <code>/system</code>         . </p><br><p>   emmc           <code>/system</code>    .  ,    cache     . </p><br><h3 id="vsyo-taki-otklyuchaem-selinux"> -  SELinux </h3><br><p>     -   SELinux.  defined  <code>selinux_enabled</code>   ,       hooks  <code>security_ops</code> . </p><br><p>     <code>reset_security_ops</code> : </p><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*_reset_security_ops)(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; ... ... ... _reset_security_ops = (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*)(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>))kallsyms_lookup_name(<span class="hljs-string"><span class="hljs-string">"reset_security_ops"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_reset_security_ops != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { _reset_security_ops(); }</code> </pre> <br><p>    SELinux   ,      ,   .       . </p><br><h3 id="perezagruzhaemsya-v-download-mode">   download mode </h3><br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> (*_enable_dload_mode)(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">str</span></span>) = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(*)()) <span class="hljs-number"><span class="hljs-number">0xc0d0cc18</span></span>; ... ... ... _enable_dload_mode(<span class="hljs-string"><span class="hljs-string">"dload_mode"</span></span>);</code> </pre> <br><p>       <code>download_mode</code> ,     .        ,    usb mass storage device.  Those.           !    recovery. </p><br><p>    ,      .      mass storage .   : </p><br><pre> <code class="hljs mel">BS=<span class="hljs-number"><span class="hljs-number">512</span></span> nextblock=<span class="hljs-number"><span class="hljs-number">0</span></span> IMG=my-recovery.img DEST=/dev/sdb12 # <span class="hljs-number"><span class="hljs-number">64</span></span> - total amount of <span class="hljs-number"><span class="hljs-number">512</span></span>*<span class="hljs-number"><span class="hljs-number">512</span></span>b blocks <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>Mb <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> (<span class="hljs-number"><span class="hljs-number">16</span></span>Mb*<span class="hljs-number"><span class="hljs-number">1024</span></span>*<span class="hljs-number"><span class="hljs-number">1024</span></span>/(<span class="hljs-number"><span class="hljs-number">512</span></span>*<span class="hljs-number"><span class="hljs-number">512</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> {<span class="hljs-number"><span class="hljs-number">1.</span></span><span class="hljs-number"><span class="hljs-number">.64</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> echo $i echo dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=${IMG} of=${DEST} bs=${BS} seek=${nextblock} skip=${nextblock} count=${BS} oflag=direct dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=${IMG} of=${DEST} bs=${BS} seek=${nextblock} skip=${nextblock} count=${BS} oflag=direct nextblock=$((nextblock+BS)) echo <span class="hljs-string"><span class="hljs-string">"nextblock = ${nextblock}"</span></span> sleep <span class="hljs-number"><span class="hljs-number">0.5</span></span> done sync echo <span class="hljs-number"><span class="hljs-number">3</span></span> &gt; /<span class="hljs-keyword"><span class="hljs-keyword">proc</span></span>/sys/vm/drop_caches</code> </pre> <br><p>  ,  <code>adb reboot recovery</code>  .      . <strong>   <code>misc</code> ,    recovery     </strong> . </p><br><p>        <code>/system</code>         <a href="http://www.supersu.com/download">supersu</a> .   :  root  .     WiFi ,   hooks.   ,  WiFi    .     ,    . </p><br><p>           .        ,    : </p><br><ul><li> <a href="https://github.com/beaups/SamsungCID">https://github.com/beaups/SamsungCID</a> . </li><li> <a href="https://github.com/djrbliss/loki">https://github.com/djrbliss/loki</a> </li></ul><br><h3 id="cifrovaya-podpis-aboot-i-boot-razdelov">   aboot  boot  </h3><br><p>        boot .    aboot ( <code>binwalk -e aboot</code> ),           . ,      .          boot ,           .  aboot  .       sha256 .       sha256,     ,   . </p><br><pre> <code class="hljs smalltalk">#!/bin/bash # print der certificate: # openssl x509 -inform der -in <span class="hljs-number"><span class="hljs-number">0xff</span></span>.crt -text -noout # mkdir boot # unpackbootimg -i <span class="hljs-number"><span class="hljs-number">09</span></span>-boot.img -o boot # cd boot # mkbootimg --kernel <span class="hljs-number"><span class="hljs-number">09</span></span>-boot.img-zImage --ramdisk <span class="hljs-number"><span class="hljs-number">09</span></span>-boot.img-ramdisk.gz --cmdline <span class="hljs-comment"><span class="hljs-comment">"`cat 09-boot.img-cmdline`"</span></span> --base `cat <span class="hljs-number"><span class="hljs-number">09</span></span>-boot.img-base` --pagesize `cat <span class="hljs-number"><span class="hljs-number">09</span></span>-boot.img-pagesize` --dt <span class="hljs-number"><span class="hljs-number">09</span></span>-boot.img-dtb --kernel_offset `cat <span class="hljs-number"><span class="hljs-number">09</span></span>-boot.img-kerneloff` --ramdisk_offset `cat <span class="hljs-number"><span class="hljs-number">09</span></span>-boot.img-ramdiskoff` --tags_offset `cat <span class="hljs-number"><span class="hljs-number">09</span></span>-boot.img-tagsoff` --output mynew.img # dd if=../<span class="hljs-number"><span class="hljs-number">09</span></span>-boot.img of=signature.bin bs=<span class="hljs-number"><span class="hljs-number">1</span></span> count=<span class="hljs-number"><span class="hljs-number">256</span></span> skip=<span class="hljs-string"><span class="hljs-string">$(</span></span>ls -la mynew.img | awk <span class="hljs-string"><span class="hljs-string">'{print $5}'</span></span>) # cd .. # binwalk -e <span class="hljs-number"><span class="hljs-number">05</span></span>-aboot.img # extract aboot signature # dd if=<span class="hljs-number"><span class="hljs-number">05</span></span>-aboot.img of=signature.bin bs=<span class="hljs-number"><span class="hljs-number">1</span></span> count=<span class="hljs-number"><span class="hljs-number">256</span></span> skip=<span class="hljs-string"><span class="hljs-string">$(</span></span>od -<span class="hljs-type"><span class="hljs-type">A</span></span> d -t x4 <span class="hljs-number"><span class="hljs-number">05</span></span>-aboot.img | awk --non-decimal-data <span class="hljs-string"><span class="hljs-string">'/^0000016/ { i=sprintf("%d\n","0x"$3); print (i+40)}'</span></span>) # extract base aboot image # <span class="hljs-number"><span class="hljs-number">40</span></span> - aboot header size, refer to: https://android.googlesource.com/kernel/lk/+/caf/master/target/msm8226/tools/mkheader.c#<span class="hljs-number"><span class="hljs-number">160</span></span> # dd if=<span class="hljs-number"><span class="hljs-number">05</span></span>-aboot.img of=aboot-base.img bs=<span class="hljs-number"><span class="hljs-number">1</span></span> count=<span class="hljs-string"><span class="hljs-string">$(</span></span>od -<span class="hljs-type"><span class="hljs-type">A</span></span> d -t x4 <span class="hljs-number"><span class="hljs-number">05</span></span>-aboot.img | awk --non-decimal-data <span class="hljs-string"><span class="hljs-string">'/^0000016/ { i=sprintf("%d\n","0x"$3); print (i)}'</span></span>) skip=<span class="hljs-number"><span class="hljs-number">40</span></span> # how sha256 was calculated? # openssl dgst -sha256 -sign private_key -out signature.bin aboot-base.img ? <span class="hljs-type"><span class="hljs-type">NAME</span></span>=<span class="hljs-string"><span class="hljs-string">$1</span></span> <span class="hljs-type"><span class="hljs-type">IMG</span></span>=<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">NAME</span></span>}/mynew.img <span class="hljs-type"><span class="hljs-type">SIG</span></span>=<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">NAME</span></span>}/signature.bin <span class="hljs-symbol"><span class="hljs-symbol">#IMG</span></span>=aboot-base.img <span class="hljs-symbol"><span class="hljs-symbol">#SIG</span></span>=signature.bin <span class="hljs-type"><span class="hljs-type">CALC_SHA256</span></span>=<span class="hljs-string"><span class="hljs-string">$(</span></span>sha256sum <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">IMG</span></span>} | awk <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span>) for i in `find . -name *.crt`; do <span class="hljs-type"><span class="hljs-type">ORIG_SHA256</span></span>=<span class="hljs-string"><span class="hljs-string">$(</span></span>openssl rsautl -inkey &lt;(openssl x509 -pubkey -noout -inform der -in <span class="hljs-string"><span class="hljs-string">${</span></span>i} <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;/dev/null) -pubin -in <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">SIG</span></span>} <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;/dev/null | hexdump -ve <span class="hljs-string"><span class="hljs-string">'/1 "%02x"'</span></span>) if [ <span class="hljs-comment"><span class="hljs-comment">"${ORIG_SHA256}"</span></span> != <span class="hljs-comment"><span class="hljs-comment">""</span></span> ]; then echo <span class="hljs-comment"><span class="hljs-comment">"sha256 was decrypted using ${i} key - ${ORIG_SHA256}"</span></span> fi if [ <span class="hljs-comment"><span class="hljs-comment">"${ORIG_SHA256}"</span></span> = <span class="hljs-comment"><span class="hljs-comment">"${CALC_SHA256}"</span></span> ]; then echo <span class="hljs-comment"><span class="hljs-comment">"sha256 ${ORIG_SHA256}"</span></span> echo <span class="hljs-comment"><span class="hljs-comment">"$i"</span></span> fi done</code> </pre> <br><p>       boot    fota, ,    fota   .    , ..   bootloop,   bootloop recovery.    fota    fotamng     ,     . </p><br><p>  , boot ,   fota  ,  bootloop ,  ,  .     boot ,   recovery  .     ,  recovery    ,    boot.      .    ramdisk  tags: </p><br><p> boot/recovery: </p><br><pre> <code class="hljs"> ramdisk: 0x01000000 tags: 0x00000100</code> </pre> <br><p> fota: </p><br><pre> <code class="hljs"> ramdisk: 0x02000000 tags: 0x01e00000</code> </pre> <br><p>  <a href="https://www.qualcomm.com/media/documents/files/secure-boot-and-image-authentication-technical-overview.pdf">Secure boot whitepaper</a>  Qualcomm   ,   sha256 hash  sha256 hash'   ELF .     Subject' .  <strong>OU=05 00002000 SW_SIZE</strong>   ,     sha256 hash   256 hash'   32  (0x2000/32=256).    aboot   ELF       sbl1 (secondary boot loader). </p><br><p>  <a href="https://developer.qualcomm.com/download/db410c/little-kernel-boot-loader-overview.pdf"></a>  little kernel  Qualcomm,          aboot.      . </p><br><h2 id="eksperimenty-s-zagruzchikami">    </h2><br><p>           Kyocera Brigadier   . </p><br><p>     aboot . Subject'   ,     .   :  aboot  KC-S701  Brigadier.  .  ,  emmc               Brigadier.   ,      Brigadier  KC-S701.           fastboot.      . </p><br><p>     ,  "  " ‚Äî   .          Qualcomm <code>QHSUSB__BULK</code> ,        ,    download mode,     USB mass storage.   .     ,   . </p><br><h1 id="to-chto-esche-trebuet-raboty-ili-vyyasnit-ne-udalos"> ,         </h1><br><ul><li>  / WiFi  ? <strong>UPD:  <a href=""></a></strong> </li><li>    sepolicy  ?   sepolicy? - ? </li><li>     oem-1? </li></ul><br><h2 id="zagruzka-fota">  Fota </h2><br><p>  boot      fota?     .    ,     <em></em> ,       . </p><br><h2 id="rasshifrovka-kyocera-properties">  Kyocera properties </h2><br><p> Kyocera   android system properties     properties,      .     ,           bootloader'.     <em>libkcjprop_jni.so</em>   <em>kcjprop_daemon</em> .       ,         . </p><br><p>     ,   : </p><br><pre> <code class="hljs go">$ ls -la /sysprop/kcjprop/rw/<span class="hljs-number"><span class="hljs-number">8d</span></span>9d788ddd5fecfdbc6c5f7c5cecfc -rw-rw---- root root <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">1970</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-22</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">8d</span></span>9d788ddd5fecfdbc6c5f7c5cecfc</code> </pre> <br><h2 id="kexec"> Kexec </h2><br><p> <a href="https://en.wikipedia.org/wiki/Kexec">Kexec</a>    Linux   .    production     Kexec,       .   user-end    ,   .    ,       ‚Äî       . </p><br><h2 id="uyazvimost-v-qsee">   QSEE </h2><br><p> QSEE ‚Äî    Qualcomm,   <del>  </del>    <a href="https://bits-please.blogspot.com/2016/05/qsee-privilege-escalation-vulnerability.html"> </a> .   ‚Äî        Trust Zone.     . </p><br><p>      .          emmc,  RPMB.       SCM .   RPMB (Replay Protected Memory Block)  ,    lock/unlock . </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p><img src="http://ngzt.ru/userfiles/picoriginal/img-20150218172850-120.jpg" alt="image"></p><br><p>  , aboot       Kyocera Propertiies      github: <a href="https://github.com/kayrus/break_free">https://github.com/kayrus/break_free</a> . </p><br><p>     ,       <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D1%2585%25D0%25B8%25D0%25BB%25D0%25BB%25D0%25B5%25D1%2581_%25D0%25B8_%25D1%2587%25D0%25B5%25D1%2580%25D0%25B5%25D0%25BF%25D0%25B0%25D1%2585%25D0%25B0">  </a> .        .     ,      . </p><br><p>  ,      Kyocera      .        .        .          ,    . </p><br><p> PS     (Nikolay Elenkov),   <a href="https://nelenkov.blogspot.com/2014/04/android-security-internals.html">Android security internals</a> .     bootloader'     Android. </p><br><p> PPS      , Justin Case, ,    ,      Qualcomm,       . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/320150/">https://habr.com/ru/post/320150/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320134/index.html">The digest of interesting materials for the mobile # 187 developer (January 16-22)</a></li>
<li><a href="../320136/index.html">Cases: development of specifications and guidelines (web ui kit)</a></li>
<li><a href="../320140/index.html">Classical labyrinth generation algorithms. Part 1: introduction</a></li>
<li><a href="../320142/index.html">What if in games to use a video card for physics, not for graphics</a></li>
<li><a href="../320148/index.html">Alcatel Lucent - setting dect-phone</a></li>
<li><a href="../320152/index.html">Multithreading (concurrency) in Swift 3. GCD and Dispatch Queues</a></li>
<li><a href="../320156/index.html">Logging VPN Connections on the Cisco ASA</a></li>
<li><a href="../320158/index.html">Areas of flexibility</a></li>
<li><a href="../320160/index.html">Vulnerable Highways and Energy Infrastructure: Recent Major Failures</a></li>
<li><a href="../320164/index.html">Caution: HSTS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>