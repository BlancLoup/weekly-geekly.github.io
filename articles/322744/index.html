<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configure replication between PostgreSQL and PipelineDB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article may be of interest to those who already have a superficial understanding of the types and problems of replication within a PostgreSQL clu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configure replication between PostgreSQL and PipelineDB</h1><div class="post__text post__text-html js-mediator-article">  This article may be of interest to those who already have a superficial understanding of the types and problems of replication within a PostgreSQL cluster, as well as those who decide to use the PipelineDB streaming database engine as a replica in such a cluster. <br><br>  PipelineDB is one of the implementations of the now-growing streaming DBMS.  You can easily read about the advantages of streaming database management systems in various <a href="https://www.pipelinedb.com/use-cases">cases</a> today on a variety of resources.  Very simply, the principle of their work is visualized on the website <a href="http://www.pipelinedb.com/">www.pipelinedb.com</a> in the ‚ÄúHow It Works‚Äù section. <br><br>  Specifically, PipelineDB is a PostgreSQL fork with additional functionality that allows you to store only aggregated data, calculating the delta from the incoming stream (hence the name of this type of DBMS) on the fly.  This data is stored in special PipelineDB objects, called continuous views.  In the simplest case, the stream itself is formed from ordinary tables stored in the same database.  Using this tool allows us to get rid of the need to create and maintain an ETL layer when preparing data for reporting systems, and can save you a lot of time and nerves.  But I believe that since you are reading this, then you already know something about it in a volume sufficient for the appearance of interest in the events described here. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We will consider a case in which PostgreSQL 9.4+ DBMS is already working on our product environment, and we need to get its realtime (well, or almost realtime) replica in order to unload the main database from the multiple and heavy SELECT queries received from, for example, reporting systems, DWH or our data marts.  And after studying the issue, you can decide that the streaming DBMS is very well suited for such a task. <a name="habracut"></a><br><br>  But bad luck - what kind of replication mechanism to use?  After additional <a href="https://www.postgresql.org/docs/9.0/static/different-replication-solutions.html">study of the issue,</a> we conclude that PostgreSQL's wonderful built-in asynchronous (physical) replication streaming mechanism, which <a href="http://peter.eisentraut.org/blog/2015/03/03/the-history-of-replication-in-postgresql/">appeared in PostgreSQL version 9.0</a> and is constantly evolving, does not fit due to its limitations, namely: <br><br>  a) the master and the replica should have the same major version of PostgreSQL, and if possible, spin on identical hardware. <br>  b) the replica works in ‚Äúhot standby‚Äù mode, in which it is read-only <br>  c) when using physical replication, we can only have a full "one-to-one" replica of the master <br><br>  In my case, the first restriction would prevent me from raising a replica of the master server running Postgre 9.6 to PipelineDB.  the Postgre version, from which the latest version of PipelineDB used by me, is only 9.5.  If your wizard is running Postgre 9.5, then you can try this trick, but there is a high probability that the master server simply does not recognize PipelineDB as a complete and equal PostgreSQL - the mechanism of physical replication is very capricious in this regard. <br><br>  The second limitation is more significant.  As we found out, PipelineDB writes its data to the database.  At least it is continuous views, for which we are confused with it.  But the second restriction allows our cue to be only complete - one to one - a copy of the wizard database without the ability to write to it.  That does not suit us at all. <br><br>  Thus, since physical replication does not suit us, we understand that we need to look towards logical replication.  Not without its drawbacks, but completely eliminating these two limitations, namely: <br><br>  a) logical replication allows us to work with different versions of the DBMS on the master and the slave <br>  b) logical replication allows you to make a replica of only the data we need, and not all master data, one-to-one, and does not block the write slave <br><br>  And here before us the whole ocean of possibilities opens. <br><br>  At the first acquaintance with the list of various tools for creating logical replication and a variety of methods of replication itself, the first desire that arises is the desire to change the type of activity.  But the first shock passes, and we begin to catch from this ocean worthy candidates for the post of the instrument of our dreams. <br><br><blockquote>  A one-year article that discusses issues and replications and utilities that support it well, including: <a href="http://postgresql.leopard.in.ua/html/">postgresql.leopard.in.ua/html/#</a> replication <br></blockquote><br>  One of the most popular tools used for this is slony (trigger-based) and pgpool / pgpool-II (middleware). <br><br>  I‚Äôll say right away that the attempt to solve this problem with the help of the very well-known and popular Slony version 2.2.5 utility did not succeed in two weeks - even in the case when for proof-of-concept and master and replica tasks were running the same PostgreSQL version .  The slony daemon stubbornly did not want to start and rebooted immediately upon startup due to the segmentation fault, the cause of which could not be found.  Yes, and a thankless task to look for the causes of segmentation faults in third-party software.  Moreover, the same picture was observed when compiling this utility from source codes and installing it from the native Alpine Linux repository. <br><br>  This experiment was conducted with such starting data: <br>  - docker containers <br>  - both master and slave: <a href="https://hub.docker.com/r/library/postgres/tags/9.6-alpine/">postgre 9.6 on Alpine Linux</a> <br><br>  It is possible that the initial conditions themselves became the cause of failure - the use of the docker or specifically this Linux distribution - but in my case these were the rules of the game.  I also admit that the problem could be hiding in the instability of the latest version of Slony itself, which I used.  In any case, this decision did not work, and Slony went to bed.  Perhaps in another system configuration or with another version of Slony, you will succeed. <br><br>  However, after reading the article further, you may not want to pop in this ancient utility.  And do not forget about it: <a href="http://howfuckedismydatabase.com/postgres/slony.php">howfuckedismydatabase.com/postgres/slony.php</a> <br><br>  I never got to the second pgpool utility, because on the way I found what eventually became my solution: the <a href="https://2ndquadrant.com/en/resources/pglogical/">pglogical</a> utility from 2ndQuadrant. <br><br>  Reading the utility documentation and realizing who the 2ndQuadrant was immediately got me to this decision.  Looking ahead, I would say that apparently this solution can even go into the upcoming 10 version of PostgreSQL as a standard solution for logical replication.  So it was decided to play with him, moving in the queue to the study pgpool. <br><br>  I decided to build the system right away on the components that I was supposed to send to production later, bypassing the proof-of-concept stage: <br>  <b>Master:</b> docker-container from the same image as in the first case <br>  <b>Replica:</b> PipelineDB docker-container from <a href="https://hub.docker.com/r/pipelinedb/pipelinedb/">another image</a> , which seems to be the official image of this project, although it is decorated in some strange way.  The image is compiled based on the Debian distribution, not Alpine. <br><br>  So, I started digging into pglogical.  Almost immediately, I was bitterly disappointed: in the APT repository, this utility exists only for PostgreSQL versions 9.4, 9.5 and 9.6, and there are no PipelineDBs in it there.  The utility flatly refused to be installed on the host with PipelineDB, reporting unmet dependency postgresql-9.5.  So  A wonderful experiment ended in essence and did not begin. <br><br>  But the awareness of the fact that PipelineDB is still the same PostgreSQL - the structure of the base directories, configuration files, built-in commands and service utilities clearly demonstrated this - and that this should lead me to something positive, did not leave me.  And I decided on a little trick. <br><br>  To the host with PipelineDB, the pglogical utility is installed as follows (everything was done in a docker container under the root): <br><br>  Add a repository and download utility packages: <br><br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb [arch=amd64] http://packages.2ndquadrant.com/pglogical/apt/ jessie-2ndquadrant main"</span></span> &gt; /etc/apt/sources.list.d/2ndquadrant.list wget --quiet -O - http://packages.2ndquadrant.com/pglogical/apt/AA7A6805.asc | apt-key add - apt-get update &amp;&amp; apt-get download libpq5 postgresql-9.5-pglogical</code> </pre> <br>  Install the necessary libraries and the package itself with ignoring dependencies (!), Solving our problem of the utility‚Äôs reluctance to install on anything other than Postgre: <br><br><pre> <code class="bash hljs">dpkg -i --ignore-depends=postgresql-9.5 libpq5_9.4.10-0+deb8u1_amd64.deb dpkg -i --ignore-depends=postgresql-9.5 postgresql-9.5-pglogical_1.2.2-1jessie_amd64.deb</code> </pre> <br>  We delete the dependency record from the / var / lib / dpkg / status file so that when apt-get continues to work, it does not swear at the non-found dependency and does not suggest that we remove pglogical: <br><pre> <code class="bash hljs">sed <span class="hljs-string"><span class="hljs-string">'s/, postgresql-9.5//g'</span></span> /var/lib/dpkg/status &gt; /var/lib/dpkg/status-new &amp;&amp; \ mv /var/lib/dpkg/status /var/lib/dpkg/status.bkp &amp;&amp; \ mv /var/lib/dpkg/status-new /var/lib/dpkg/status</code> </pre> <br>  Everything!  The utility is installed on the host, with PipelineDB.  But again, bad luck - the utility is installed in folders named postgresql, and PipelineDB has a similar folder structure, but named pipelinedb.  Well, let's not be discouraged about this and move the utility files to the appropriate folders already PipelineDB: <br><pre> <code class="bash hljs">mv /usr/lib/postgresql/9.5/lib/* /usr/lib/pipelinedb/lib/pipelinedb/ mv /usr/lib/postgresql/9.5/bin/* /usr/lib/pipelinedb/bin/ mv /usr/share/postgresql/9.5/extension/* /usr/lib/pipelinedb/share/pipelinedb/extension/</code> </pre> <br>  That's all.  We got a working server with PipelineDB with the pglogical utility installed, which we can start using. <br><br>  After a brief cluster setup, the master slave (configure the PipelineDB replica in the same way as regular PostgreSQL), described in millions of resources, including Postgre documentation, and after completing the simple <a href="https://2ndquadrant.com/en/resources/pglogical/pglogical-docs/">configuration</a> steps of <a href="https://2ndquadrant.com/en/resources/pglogical/pglogical-docs/">the utility itself,</a> we can verify that replication works. <br><br>  UPD: Sources of configurations and initialization scripts for the docker can be found here: <a href="https://github.com/akrymets/pg-replication">https://github.com/akrymets/pg-replication</a> <br><br>  I will be glad to hear comments on the essence and suggestions on the narration.  The best offers will be implemented as edits to the article. </div><p>Source: <a href="https://habr.com/ru/post/322744/">https://habr.com/ru/post/322744/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../322734/index.html">Check-list: what is VDI or how to distinguish a real product from ‚Äúimport-substituted‚Äù crafts</a></li>
<li><a href="../322736/index.html">Travel Financial Transaction</a></li>
<li><a href="../322738/index.html">The role of the payment service in online transactions</a></li>
<li><a href="../322740/index.html">10 sins in site / application navigation systems</a></li>
<li><a href="../322742/index.html">Selenium: New Hope</a></li>
<li><a href="../322748/index.html">The third conference of JavaScript-developers in Odessa "JS Lab" is looking for speakers</a></li>
<li><a href="../322750/index.html">A brief algorithm for selecting a team for a startup</a></li>
<li><a href="../322752/index.html">What does the Landing Page structure consist of and how to write a marketing headline</a></li>
<li><a href="../322754/index.html">Restore data storage and VMFS partitions. Lifting the EMC iomega from that light ...</a></li>
<li><a href="../322756/index.html">Perfectionism. How to stop looking for spiders in a room and start living</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>