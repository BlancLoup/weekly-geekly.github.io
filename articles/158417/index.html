<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Anatomy of an attack: How I hacked StackOverflow</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Almost two years ago, I came across a rather significant vulnerability on the StackExchange network of sites. I say stumbled because I did not try to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Anatomy of an attack: How I hacked StackOverflow</h1><div class="post__text post__text-html js-mediator-article">  Almost two years ago, I came across a rather significant vulnerability on the <a href="http://stackexchange.com/">StackExchange</a> network of sites.  I say stumbled because I did not try to hack the site.  Circumstances opened the door for me.  The vulnerability itself is quite interesting, and contains a lesson for everyone who creates and maintains websites or server infrastructure.  So, here is the story of how I hacked <a href="http://stackoverflow.com/">StackOverflow</a> ... <br><a name="habracut"></a><br><h4>  Initial data </h4><br>  At that time I worked in a small company where there was a firewall with completely draconian limitations.  It cut all request and response headers that did not conform to the HTTP / 1.1 specification (and even cut valid HTTP / 1.1 headers).  It played a trick on sites that rely on things like <code>X-Requested-With</code> .  Therefore, for my ‚Äúexternal adventures‚Äù, I set up a proxy. <br><br>  I had several servers at that time, so I just put Squid on one of them.  Since I understood something, I only allowed connections to the proxy with <code>127.0.0.1</code> .  I raised the ssh tunnel to the server and pointed the browser to localhost as a proxy.  The browser connected to the tunnel that connected to Squid on the server.  Everything was great.  Besides the fact that all my traffic was encrypted, I was able to use the sites normally. <br><br>  For those of you who want to tell me that I did a bad thing, I want to draw your attention to the fact that I had the opportunity to do this.  And not just an opportunity, I was openly told to use a proxy, since we had to work with some sites that did not work through our firewall.  So I didn‚Äôt do anything wrong. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Attack </h4><br>  At that time, I often visited StackOverflow.  Then he had just appeared, and there were a couple of bugs in him.  One day, the site started showing me a call stack.  I did not attach any importance to this, as I often met with this all over the Internet.  In fact, almost every time I received an error message on a site written in ASP.NET, I saw a call stack. <br><br>  And then I noticed a new menu item in the chat.  This new menu item was called ‚Äúadmin‚Äù.  Out of curiosity, I clicked on the link, believing that I would be denied access.  What happened next surprised me.  I got full access to everything.  I had a developer console where I could see who was doing what.  I had an interface for working with a database, where I could directly request anything from any database.  I got full admin rights. <br><br><h4>  What happened next </h4><br>  The next thing I did - immediately reported it to the moderator.  A few minutes later I was in a private chat with a moderator, as well as two developers.  The reason was found in approximately 10 minutes.  After another 10 minutes, the problem was solved superficially.  A complete correction took a couple of hours.  They worked great.  I still have the log of that chat, and I want to say that these developers deserve all praise.  They responded quickly and professionally.  And solved the problem as soon as possible. <br><br><h4>  Vulnerability </h4><br>  If you are smart, then, most likely, guess what happened.  Since I logged out through a proxy, the <code>X-Forwarded-For</code> header was added to my requests.  The value of this header was the IP from which the proxy server was requested.  But, since I connected to the proxy through an SSH tunnel, the IP was local.  So Squid added <code>X-Forwarded-For: 127.0.0.1</code> ... <br><br>  But the most interesting thing was what the ASP showed in the logs.  When they looked at the dumps of my requests, there was the <code>REMOTE_ADDR: 127.0.0.1</code> entry!  In their application, all header checks were implemented correctly.  But IIS was incorrectly configured and it overwritten <code>REMOTE_ADDR</code> value <code>X-Forwarded-For</code> , if it was present.  And thanks to such a configuration error, I was able to access the admin panel using my proxy server. <br><br><h4>  findings </h4><br>  Never rely on <code>X-Forwarded-For</code> , as we see - it is not safe.  Always use <code>REMOTE_ADDR</code> .  It is worth considering whether you need IP protection at all.  Or, at least, you should not completely rely on it, and use only as an additional measure. <br><br>  It is interesting to note that the developers did use proper header validation.  The bottom line is that you should never blindly trust your infrastructure.  This hole appeared due to the difference in configuration between the server and the application.  These little things happen every day.  The application assumes one, and the server - another.  The problem is that such trust can completely undermine security.  In this case, the developers trusted the <code>REMOTE_ADDR</code> value (quite justified), but the server was incorrectly configured.  Of course, there are situations where you have to trust the server or other components, but you have to remember that blind trust is not a good thing.  Think about it, and try to insure against such cases. <br><br>  The StackOverflow team solved this question wonderfully.  Quick, responsive and reasonable.  They asked me for help (which I gladly provided), and behaved professionally and respectfully.  They did a fantastic job.  We all need to learn a lesson.  Respond to reports of vulnerabilities seriously.  Solve the issue professionally and quickly. <br><br><h4>  As for PHP </h4><br>  The most interesting thing here is that applications written in PHP may have the same vulnerability.  We look at the <a href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/HttpFoundation/Request.php">Symfony2 Request class</a> .  Looks great.  Until you notice that it uses a static variable to determine whether to trust the proxy.  This means that if any part of your application wants to get headers from the proxy (for example, to write to the log), then your entire application will receive headings from the proxy after that.  To see if your code is affected by a similar vulnerability, look for the <code>$request-&gt;trustProxy()</code> call in it.  Also note that there is no reverse mechanism.  You can not "stop trusting" the proxy.  I think this is a big architectural miscalculation ... <br><br>  Zend Framework 2 does the same.  It has a <a href="https://github.com/zendframework/zf2/blob/master/library/Zend/Session/Validator/RemoteAddr.php">class</a> that behaves in a similar way (in terms of obtaining IP).  Interestingly, in Zend Framework 1, the <a href="https://github.com/komola/ZendFramework/blob/master/Controller/Request/Http.php">way to get an IP address</a> was adequate.  The calling code must explicitly indicate what it wants to receive, and by default it should be a safe option. <br><br><h4>  Conclusion </h4><br>  This problem was the result of a combination of two minor miscalculations.  Individually, they are very easy to lose sight of.  But if they converge in a certain way, you will get a very serious security threat.  And the biggest lesson is that you really can't trust anything outside of your application.  If you can get around this (for example, by not trusting headers and variables, like <code>REMOTE_ADDR</code> ), then you can make your application more secure.  But above all, think about the code you write and the systems you build.  And support them. </div><p>Source: <a href="https://habr.com/ru/post/158417/">https://habr.com/ru/post/158417/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../158403/index.html">Why eval is not always bad</a></li>
<li><a href="../158409/index.html">Voice of the people! Get on TechEd Russia 2012 as a speaker!</a></li>
<li><a href="../158411/index.html">How to write a script for a selling video trailer</a></li>
<li><a href="../158413/index.html">Stephen Sinofsky left Microsoft</a></li>
<li><a href="../158415/index.html">Roskomnadzor will evaluate the quality of communication providers</a></li>
<li><a href="../158419/index.html">What are the benefits of branding?</a></li>
<li><a href="../158421/index.html">Lost Island of Good Code</a></li>
<li><a href="../158423/index.html">There is a return path from the registry: Lurkmore removed from the registry of prohibited sites</a></li>
<li><a href="../158425/index.html">Plastic Aston Martin printed on a 3D printer filmed in Skyfall</a></li>
<li><a href="../158427/index.html">H3C: Performance Switch with Half Pink</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>