<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The problem of simultaneous use of kernel raid autodetect for / on / dev / md0 and superblock v1.2 for other / dev / md, or how can I drop (and raise) the server after updating it</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Thank you for reading the title. It was a test. 
 Today, after the next update to your favorite Gentoo server and preventive reboot, suddenly / dev / ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The problem of simultaneous use of kernel raid autodetect for / on / dev / md0 and superblock v1.2 for other / dev / md, or how can I drop (and raise) the server after updating it</h1><div class="post__text post__text-html js-mediator-article"><habracut text="   ..."><br><h4>  Thank you for reading the title.  It was a test. </h4><br>  Today, after the next update to your favorite Gentoo server and preventive reboot, suddenly / dev / md1 fell off with the words of a wise kernel: sdc1 doesn‚Äôt have a valid v0.90 superblock, not importing! <br><br>  Shock!  Panic!  Well, that is not in the core ... <br><br><h4>  And what's the matter? </h4><br>  To begin with, I‚Äôll talk about the server configuration to make it easier to understand the essence of the problem and how to solve it.  So, the kernel is 3.10.7 with RAID autodetect enabled and two RAID1 (mirror) disks. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On / dev / md0 is mounted root, on / dev / md1 database (Percona): <br><pre><code class="bash hljs">db13 ~ <span class="hljs-comment"><span class="hljs-comment"># cat /etc/fstab | grep md /dev/md0 / ext3 noatime 0 1 /dev/md1 /mnt/db reiser4 noatime 0 0</span></span></code> </pre> <br>  And a piece of /boot/grub/grub.conf: <br><pre> <code class="bash hljs">title Gentoo Linux 3.10.7 md0 root (hd0,0) kernel /boot/kernel-3.10.7 root=/dev/md0</code> </pre><br>  So, for successful assembly of md devices by the kernel at boot time, two conditions must be met: <br><ol><li>  Type 0xFD at partitions on which RAID is built </li><li>  The version of <a href="https://raid.wiki.kernel.org/index.php/RAID_superblock_formats">the superblock format 0.90</a> on the device / dev / md, which is created using mdadm </li></ol><br>  If with item 1.  everything was fine in my configuration, as it turned out, the superblock format was 1.2 I suspect that I created / dev / md1 after a new version of mdadm arrived, which by default uses this format.  As a result, the kernel swears in terrible words: <div class="spoiler">  <b class="spoiler_title">dmesg |</b>  <b class="spoiler_title">grep md</b> <div class="spoiler_text"><pre>  [0.000000] Command line: root = / dev / md0 raid = / dev / md0
 [0.000000] Kernel command line: root = / dev / md0 raid = / dev / md0
 [1.063603] md: raid1 personality registered for level 1
 [1.266420] md: Waiting for all devices available before autodetect
 [1.266494] md: If you don't use raid, use raid = noautodetect
 [1.266781] md: Autodetecting RAID arrays.
 [1.293670] md: invalid raid superblock magic on sdc1
</pre><pre>  [1.294210] md: sdc1 doesn‚Äôt have a valid v0.90 superblock, not importing!
 [1.312482] md: invalid raid superblock magic on sdd1
 [1.312556] md: sdd1 doesn‚Äôt have a valid v0.90 superblock, not importing! </pre><pre> [1.312579] md: Scanned 4 and added 2 devices.
 [1.312595] md: autorun ...
 [1.312610] md: considering sdb3 ...
 [1.312626] md: adding sdb3 ...
 [1.312641] md: adding sda3 ...
 [1.312657] md: created md0
 [1.312665] md: bind &lt;sda3&gt;
 [1.312754] md: bind &lt;sdb3&gt;
 [1.312770] md: running: &lt;sdb3&gt; &lt;sda3&gt;
 [1.313064] md / raid1: md0: active with 2 out of 2 mirrors
 [1.313166] md0: detected capacity change from 0 to 7984840704
 [1.313262] md: ... autorun DONE.
 [1.320413] md0: unknown partition table
 [1.338528] EXT3-fs (md0): mounted filesystem with ordered data mode
 [2.581420] systemd-udevd [861]: starting version 208
 [3.122748] md: bind &lt;sdc1&gt;
 [4.896331] EXT3-fs (md0): using internal journal
</pre><br></div></div><br><h4>  When Google doesn't help </h4><br>  The choice is quite small - either to disable autodetection of arrays in the kernel (recompiling and editing in grub.conf), or changing the format of the superblock (full data backup and killing the mirror and then restoring it).  Both options are not an option, because they are inherently destructive and can lead to data loss, and they can take a lot of time (as it turned out during the search for the <a href="https://raid.wiki.kernel.org/index.php/Autodetect">kernel autodetect is depricated feature</a> ) <br><br>  By the way, after the start of sevrer / dev / md1 is perfectly started using the command <pre>  mdadm --manage / dev / md1 --run </pre>  .  Of course, one could write this line somewhere in rc-scripts, but, you see, this is somehow not sporty. <br><br><h4>  Eureka! </h4><br>  The solution did not come immediately, although it was on the surface - all that needs to be done is to remove the 0xFD type (replace with 0x83) from the disks in / dev / md1 and then the kernel will no longer try to build this array without success, making it difficult for udevd to do its work.  Indeed, after using fdisk to change the type of partitions on both mirrors and reboot the server, everything miraculously got started: <br><div class="spoiler">  <b class="spoiler_title">dmesg |</b>  <b class="spoiler_title">grep md</b> <div class="spoiler_text"><pre> [0.000000] Command line: root = / dev / md0 raid = / dev / md0
 [0.000000] Kernel command line: root = / dev / md0 raid = / dev / md0
 [1.063924] md: raid1 personality registered for level 1
 [1.248078] md: waiting for all devices available before autodetect
 [1.248201] md: If you don't use raid, use raid = noautodetect
 [1.248504] md: Autodetecting RAID arrays.
 [1.265058] md: Scanned 2 and added 2 devices.
 [1.265243] md: autorun ...
 [1.265258] md: considering sda3 ...
 [1.265274] md: adding sda3 ...
 [1.265290] md: adding sdb3 ...
 [1.265305] md: created md0
 [1.265321] md: bind &lt;sdb3&gt;
 [1.265331] md: bind &lt;sda3&gt;
 [1.265428] md: running: &lt;sda3&gt; &lt;sdb3&gt;
 [1.265865] md / raid1: md0: active with 2 out of 2 mirrors
 [1.265891] md0: detected capacity change from 0 to 7984840704
 [1.266068] md: ... autorun DONE.
 [1.276627] md0: unknown partition table
 [1.294892] EXT3-fs (md0): mounted filesystem with ordered data mode
</pre><pre>  [2.713383] systemd-udevd [860]: starting version 208
 [3.128295] md: bind &lt;sdc1&gt;
 [3.159107] md: bind &lt;sdd1&gt;
 [3.170320] md / raid1: md1: active with 2 out of 2 mirrors
 [3.170333] md1: detected capacity change from 0 to 17170300928
 [3.178113] md1: unknown partition table
 [4.911712] EXT3-fs (md0): using internal journal
 [5.027077] reiser4: md1: found disk format 4.0.0.
</pre><br></div></div><br>  I would be glad if Google, having found this text, will show it to my colleagues in the workshop who are in a similar situation. </habracut></div><p>Source: <a href="https://habr.com/ru/post/203652/">https://habr.com/ru/post/203652/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../203634/index.html">The IceCube detector registered neutrinos from outside the solar system.</a></li>
<li><a href="../203638/index.html">Winamp will not die?</a></li>
<li><a href="../203646/index.html">Damage-oriented programming</a></li>
<li><a href="../203648/index.html">Deadly disease was a software bug 23andMe</a></li>
<li><a href="../203650/index.html">The most frequently used words on Habr√©</a></li>
<li><a href="../203658/index.html">WOW CSS</a></li>
<li><a href="../203660/index.html">Unchecky - Down with Potentially Unwanted Programs</a></li>
<li><a href="../203664/index.html">Articles from businessmen from Silicon Valley. Alexey Fedoseev: ‚ÄúMake the structure in chaos! And how to approach this ... "(Part 2)</a></li>
<li><a href="../203668/index.html">Stock Market Tools: Trading Terminal</a></li>
<li><a href="../203670/index.html">Risk-free national payment system, or I want an account with the Central Bank of the Russian Federation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>