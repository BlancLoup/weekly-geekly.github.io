<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>XNA Draw: write deferred lighting to three sources using a shader</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi habravchanam! 

 Long time I did not write on habr: study, the session is coming, you know. Today I will try to tell you how to implement Deferred ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>XNA Draw: write deferred lighting to three sources using a shader</h1><div class="post__text post__text-html js-mediator-article">  Hi habravchanam! <br><br><img src="https://habrastorage.org/storage1/57af6d56/8abbe765/8132ea57/a3b3541b.png" align="left">  Long time I did not write on habr: study, the session is coming, you know.  Today I will try to tell you how to implement <i><b>Deferred Lighting</b></i> (deferred lighting) using <b>normal mapping</b> for three light sources in XNA, while using the Reach-profile and <i><b>Shader model 2.0</b></i> . <br>  Let me remind you that earlier we already touched on the topic of shaders: <a href="http://habrahabr.ru/blogs/gdev/128349/">here</a> .  The rest is under the cut, video and demo there. <a name="habracut"></a><br><br>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <br><br><br><br>  In this part: <ul><li>  What is <b>Deferred Lighting</b> </li><li>  What is <b>Normal mapping</b> </li><li>  Implementation, shader connection </li><li>  Pixel Shader Implementation </li></ul><br><br><h4>  Theory </h4><br>  Why exactly three light sources at the same time?  Shaders have limitations: in <i><b>Shader model 2.0</b></i> , there can be no more than 64 arithmetic operations in one pass of the shader.  To use light sources more than three in one pass - <b><i>Shader model 3.0</i></b> is required, it supports 512 arithmetic operations, approximately ~ 30 sources per pass.  But for model 3.0 you need a <i>hidef</i> profile, and for it you need a <i>DirectX10-suitable</i> video card.  Therefore, we confine ourselves to three sources (and moreover, what prevents to draw sources in several passes? Therefore, three sources are the restriction of the entire shader, in the article we will consider only one pass). <br><br>  By the way, the comparison of shader models: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/31402caf/00b54fad/f952c4c8/3ffb84b4.png"></div><br><br>  More details can be found <a href="http://msdn.microsoft.com/en-us/library/bb219846(v%3DVS.85).aspx">here</a> . <br><br>  The limitations of pixel shaders of the second model seem to be sorted out. <br><br>  Now let's look at another strange word: " <u>deferred lighting</u> ". <br><br><h6>  Deferred lighting </h6><br>  The main difference between deferred lighting and shading from standard lighting methods is that these methods immediately write the result of the shader to the framebuffer color. <br><br>  If it is very easy to explain, then we count all the pixels from the light source and immediately write it to the framebuffer, in our case there will be four sums to the framebuffer (ambient + the result of three istons) <br><br>  Very briefly, what is deferred lighting, we figured out, it remains to understand what the normal mapping. <br><br><h6>  Normal mapping </h6><br>  Also known in the common people is a map of texture normals, for those who still think: the normal is perpendicular to the surface. <br><br>  Let's see what can be won with it?  I will give an example of lighting using the normal map and without.  And then I will explain how this works. <br><br>  This is how our scene looks without lighting: <br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/bf016c37/0cecc620/dcf41042/8fec7e60.png"></div><br><br>  So our scene looks like using lighting (without using Normal Mapping): <br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/a94b230f/543241be/68695eff/b794500c.png"></div><br><br>  So our scene looks like using lighting (using Normal Mapping): <br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/3dd983c9/a750c558/078c5283/4da5f673.png"></div><br><br>  As you can see, the result on the face, the scene with <b>Normal Mapping</b> is like a ‚Äúvolumetric‚Äù one and it looks more realistic, especially in dynamics (when moving lights). <br>  Let's take a look at the textures themselves. <br><br>  The texture itself ( <b>Color map</b> ): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/4fceccb1/d3c677fe/ab2c8b96/5a1af837.jpg"></div><br><br>  <b>Normal Map</b> Texture: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/4bb7e32a/31815025/04ab754f/19ff72bc.jpg"></div><br><br>  On the second texture, you won‚Äôt understand what‚Äôs what, remember the displacement-shader <a href="http://habrahabr.ru/blogs/gdev/128349/">article</a> ?  There we transmitted through R, G channels information about how to bend a pixel, and here, we transmit with the help of R, G, B information about the normals, i.e.  R = X, G = Y, B = Z. And already in the shader we use the X, Y, Z coordinates when calculating the lighting, simple, yes? <br><br>  And if the reader again did not understand anything, even after seeing the word normal for the first time and got an explanation for it, then using the normal map, the texture gets a 3D representation for lighting. <br><br>  And yes, about creating a normal map, it‚Äôs almost <u>impossible to</u> draw them, they are either removed from the high-poly model, or generated from the texture itself (for example, a <a href="http://developer.nvidia.com/nvidia-texture-tools-adobe-photoshop">plug-in</a> for photoshop). <br><br>  With a theory like a bit sorted out, let's try to implement it all the code. <br><br><h4>  Practice </h4><br>  Here I will give pieces of code with comments. <br>  Create a light source view, class <b>LightEmmiter</b> : <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LightEmmiter</span></span> { <span class="hljs-comment"><span class="hljs-comment">//      : X, Y, Z public Vector3 position; //   public Vector3 color; //   (  ‚Äî ) public float corrector; //   public float radius; //       internal void UpdateEffect(EffectParameter effectParameter) { effectParameter.StructureMembers["position"].SetValue(position); effectParameter.StructureMembers["color"].SetValue(color * corrector); effectParameter.StructureMembers["invRadius"].SetValue(1f / radius); } }</span></span></code> </pre> <br><br>  Now we are working with <b>Game1</b> (main class): <br>  Create variables: <br><pre> <code class="cs hljs">Texture2D texture; <span class="hljs-comment"><span class="hljs-comment">// Color  ( ) Texture2D textureNormal; // Normal  private Effect deferred; //  SpriteFont spriteFont; // ,   Debug- EffectParameter lightParameter; //     private float lightRadius; //     private float lightZ; //   Z-  private float lightC; //     LightEmmiter[] lights = new LightEmmiter[2]; //  </span></span></code> </pre><br><br>  Now we initialize all this in the <b>LoadContent</b> method: <br><pre> <code class="cs hljs">texture = Content.Load&lt;Texture2D&gt;(<span class="hljs-string"><span class="hljs-string">"test1"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   textureNormal = Content.Load&lt;Texture2D&gt;("test1_map"); //   deferred = Content.Load&lt;Effect&gt;("deferred"); //   spriteFont = Content.Load&lt;SpriteFont&gt;("default"); //   lightRadius = 320f; //    lightZ = 50f; //   Z- lightC = 1f; //    lights[0] = new LightEmmiter(); lights[0].position = new Vector3(20, 30, 0); lights[0].radius = lightRadius; lights[0].corrector = lightC; lights[0].color = new Vector3(1f, 0f, 0f); lights[1] = new LightEmmiter(); lights[1].position = new Vector3(20, 30, 0); lights[1].radius = lightRadius; lights[1].corrector = lightC; lights[1].color = new Vector3(1f, 1f, 1f);</span></span></code> </pre><br><br>  We update <b>Draw</b> : <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//     RenderTarget ‚Äî  GraphicsDevice.Clear(Color.LightSkyBlue); GraphicsDevice.SetRenderTarget(null); //     lights[0].position = new Vector3(Mouse.GetState().X, Mouse.GetState().Y, lightZ); lights[0].radius = lightRadius; lights[0].corrector = lightC; lights[1].position = new Vector3(800 - Mouse.GetState().X, 480 - Mouse.GetState().Y, lightZ); lights[1].radius = lightRadius; lights[1].corrector = lightC; //   deferred.CurrentTechnique = deferred.Techniques["Deferred"]; //    deferred.Parameters["screenWidth"].SetValue(GraphicsDevice.Viewport.Width); deferred.Parameters["screenHeight"].SetValue(GraphicsDevice.Viewport.Height); deferred.Parameters["ambientColor"].SetValue(new Vector3(1, 1, 1) * 0.1f); deferred.Parameters["numberOfLights"].SetValue(2); deferred.Parameters["normaltexture"].SetValue(textureNormal); //    lights-   lightParameter = deferred.Parameters["lights"]; //  lights-    for (int i = 0; i &lt; lights.Length; i++) { LightEmmiter l = lights[i]; l.UpdateEffect(lightParameter.Elements[i]); } //   (   ) foreach (EffectPass pass in deferred.CurrentTechnique.Passes) { spriteBatch.Begin(SpriteSortMode.Immediate, BlendState.Opaque, SamplerState.LinearClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise); pass.Apply(); spriteBatch.Draw(texture, new Rectangle(0, 0, 800, 480), Color.White); spriteBatch.End(); } //  Debug- spriteBatch.Begin(SpriteSortMode.Deferred, BlendState.NonPremultiplied, SamplerState.LinearClamp, DepthStencilState.None, RasterizerState.CullCounterClockwise, null); //800 480 spriteBatch.DrawString(spriteFont, "lightRadius: " + lightRadius + "\nlightCorrector: " + lightC + "\nligthZ: " + lightZ, new Vector2(10, 10), Color.LightYellow); spriteBatch.End();</span></span></code> </pre><br><br>  All that remains is the most important thing; we create the shader <b>deferred.fx</b> , listing: <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//   ,   struct Light { float3 position; float3 color; float invRadius; }; //   texture normaltexture; // -      3-  int numberOfLights; Light lights[3]; //   float3 ambientColor; // ,   float screenWidth; float screenHeight; //  Color- () sampler ColorMap : register(s0); //  Normal- sampler NormalMap : samplerState { Texture = normaltexture; MinFilter = Linear; MagFilter = Linear; AddressU = Clamp; AddressV = Clamp; }; //      float3 CalculateLight(Light light, float3 normal, float3 pixelPosition) { //  float3 direction = light.position - pixelPosition; float atten = length(direction); direction /= atten; //      float amount = max(dot(normal, direction), 0); atten *= light.invRadius; //  ,  modifer       ,         float modifer = max((1 - atten), 0); //     return light.color * modifer * amount; } float4 DeferredNormalPS(float2 texCoords : TEXCOORD0) : COLOR { float4 base = tex2D(ColorMap, texCoords); //    color-   texCoords float3 normal = normalize(tex2D(NormalMap, texCoords) * 2.0f - 1.0f); //   X,Y,Z  -   texCoords     : -1, 1. //    float3 pixelPosition = float3(screenWidth * texCoords.x, screenHeight * texCoords.y,0); //  - float3 finalColor = 0; for (int i=0;i&lt;numberOfLights;i++) { //          finalColor += CalculateLight(lights[i], normal, pixelPosition); } //   ,  *     ,  multiply          return float4((ambientColor + finalColor) * base.rgb, base.a); } technique Deferred { pass Pass0 { PixelShader = compile ps_2_0 DeferredNormalPS(); } }</span></span></code> </pre><br><br>  That's all, in this article - I will not tell you how to realize an infinite number of light sources through multiple passes of shaders, you can do it yourself;) <br><br>  Video demonstration of lighting: <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/7VX06GL9R4s%3Ffeature%3Doembed&amp;xid=17259,15700002,15700021,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhjYWsNm4E3GfphVL_eSR395Nzjqkg" frameborder="0" allowfullscreen=""></iframe><br><br>  Link to demo (exe): <a href="">here</a> . <br>  Link to source (project, VS2010): <a href="">here</a> . <br><br>  Also, I would like to express special thanks to the <a href="http://habrahabr.ru/users/lazychaser/" class="user_link">lazychaser</a> for helping with the analysis of the material and leading to a pure virgin path. <br><br>  <i>Good luck;)</i> </div><p>Source: <a href="https://habr.com/ru/post/134819/">https://habr.com/ru/post/134819/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134812/index.html">Reddwarf to create a Java server using the example of the online game Stone-Scissors-Paper: Server</a></li>
<li><a href="../134813/index.html">A bit about the "underwater satellite constellation"</a></li>
<li><a href="../134814/index.html">ZAGG Keyboard Case for Galaxy Tab 10.1</a></li>
<li><a href="../134817/index.html">TPoDT keygenme analysis # 2</a></li>
<li><a href="../134818/index.html">Kiri</a></li>
<li><a href="../134820/index.html">Introduction to mnemonics</a></li>
<li><a href="../134821/index.html">Three20 demystifying: TTModel</a></li>
<li><a href="../134822/index.html">SockJS server performance study</a></li>
<li><a href="../134823/index.html">Asynchronous function sequential call</a></li>
<li><a href="../134824/index.html">2GIS - iOS version appeared</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>