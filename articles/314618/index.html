<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Once executed block in an arbitrary place of code (C ++ 11 and higher)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to provide a small ready-made solution for those who may need to write a large (or not so) piece of code that the program must execute exactly ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Once executed block in an arbitrary place of code (C ++ 11 and higher)</h1><div class="post__text post__text-html js-mediator-article">  I want to provide a small ready-made solution for those who may need to write a large (or not so) piece of code that the program must execute exactly 1 time;  and you may need to place it anywhere (within the limits of reasonable and C ++ syntax rules).  If the need for this arises more often than a couple of times in the entire project, it would be good to have at least some more or less working solution for this case. <br><a name="habracut"></a><br><h4>  Immediately to the point </h4><br>  Without arguing for a long time, I immediately post my code that works with the C ++ 11 standard and higher. <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; #define DO_ONCE(...) { static bool _do_once_ = ([&amp;](){ __VA_ARGS__ }(), true); (void)_do_once_; } void Foo(int val) { using namespace std; //  _do_once_        DO_ONCE static unsigned int _do_once_ = 1; DO_ONCE ( cout &lt;&lt; "[First call of 'Foo' function]" &lt;&lt; endl; ) cout &lt;&lt; "Calls: " &lt;&lt; _do_once_++ &lt;&lt; ", value: " &lt;&lt; val &lt;&lt; endl; } int main(int argc, char** argv) { using namespace std; for (auto val : {1, 2, 3}) { Foo(val); DO_ONCE ( Foo(val); ) } system("pause &gt; nul"); return 0; } /*  : [First call of 'Foo' function] Calls: 1, value: 1 Calls: 2, value: 1 Calls: 3, value: 2 Calls: 4, value: 3 /*</span></span></span></span></code> </pre> <br>  Consider the most important piece of code that does all the work required: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DO_ONCE(...) { static bool _do_once_ = ([&amp;](){__VA_ARGS__}(), true); (void)_do_once_; }</span></span></code> </pre><br>  It looks not very clear and nice, so I'll sign a little more: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DO_ONCE(...) \ { \ static bool _do_once_ = ([&amp;] ( ) { __VA_ARGS__ } ( ), true); \ (void)_do_once_; \ }</span></span></code> </pre><br>  It works like this - in the code block, a local static variable of the bool type is created, which, using the comma operator, is initialized in two stages: <br><br>  <b>1.</b> Using the operator "parentheses" is called lambda: <br><br><pre> <code class="cpp hljs">[&amp;] ( ) { __VA_ARGS__ }</code> </pre><br>  which captures by reference all that is in scope and executes the expression that the user passed to the macro DO_ONCE through arguments packed in <i>__VA_ARGS__</i> .  The preset macro <i>__VA_ARGS__</i> will allow you to save all the code inside the block, even if it contains commas (which the preprocessor considers as separators of arguments at the parsing stage). <br><br>  <b>2.</b> The _do_once_ variable is assigned the value true (the assigned value and the type of the variable itself do not play a role, not counting the size occupied in the program).  The record "(void) _do_once_;"  need to avoid warning about an unused variable. <br><br>  At this, the variable initialization is completed and the code will never be executed again, which was what was required. <br><br>  <b>Cons of the approach:</b> <br><br>  - Requires standard C ++ 11, <br>  - Requires the creation of 1 variable for each DO_ONCE block. <br><br>  <b>Pros:</b> <br><br>  - Good readability, simple syntax. <br>  - There are no restrictions on the number of operators in the block and on their type (do not try to enter there break and continue, if the loop is outside the body of the block DO_ONCE or the case label, if DO_ONCE is inside the switch). <br>  - The ability to work with variables and functions that are available in the scope of a DO_ONCE call without the additional cost of passing them as arguments. <br>  - There is no risk to get the error of redefining the _do_once_ variable, since  in the body of the block, it simply replaces this name from the outer scope. <br><br>  References: <br>  ¬ª <a href="https://msdn.microsoft.com/ru-ru/library/dd293608.aspx">Lambda expressions</a> <br>  ¬ª <a href="https://msdn.microsoft.com/ru-ru/library/ms177415.aspx">Macro with variable argument lists</a> </div><p>Source: <a href="https://habr.com/ru/post/314618/">https://habr.com/ru/post/314618/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314606/index.html">Some facts about python asyncio</a></li>
<li><a href="../314608/index.html">How to increase the effectiveness of your email list</a></li>
<li><a href="../314610/index.html">Update Vivaldi 1.4 for Linux - the hunt for flash plugin</a></li>
<li><a href="../314612/index.html">Data Center and Digital Transformation</a></li>
<li><a href="../314616/index.html">A person. Anders Hejlsberg - creator of Turbo Pascal, Delphi and C #</a></li>
<li><a href="../314620/index.html">Product Design Digest October 2016</a></li>
<li><a href="../314622/index.html">Setting up email notifications in MS SQL Server</a></li>
<li><a href="../314624/index.html">EF Core: Setting the name of the generated models in Scaffolding</a></li>
<li><a href="../314628/index.html">Auto-collection of data on completed tasks in MS SQL Server</a></li>
<li><a href="../314630/index.html">Auto-collection of data about changes in database schemas in MS SQL Server</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>