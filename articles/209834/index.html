<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Transition to ADFS authorization and authentication mechanisms as part of a marketing strategy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article will be interesting to anyone who wants to learn the meaning of the scary term ‚ÄúActive Directory Federation Services‚Äù using real life exam...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Transition to ADFS authorization and authentication mechanisms as part of a marketing strategy</h1><div class="post__text post__text-html js-mediator-article">  The article will be interesting to anyone who wants to learn the meaning of the scary term ‚ÄúActive Directory Federation Services‚Äù using real life examples, as well as everyone who develops custom systems based on SharePoint and is in the process of deciding which authorization and authentication model to choose, or going to switch an existing solution to ADFS. <br><br>  And most importantly, it is useful to those who are important consumer qualities of an IT product, its value and convenience for the end user. <br><br>  Most recently, we have transferred loyalty programs from one of our customers to the ADFS portal.  This has become part of a large process of system infrastructure change.  It is always more interesting to talk about complex things in relation to the business goals that these complex technical things serve.  Therefore - a small description of the loyalty program itself. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This is a loyalty system for cashiers who sell the services of our customer.  Run on MS SharePoint.  Through the portal, cashiers save bonuses and receive gifts for them (souvenirs, tours, gift cards, etc.) The company can thus flexibly manage the sales of the necessary ‚Äúpositions‚Äù, analyze the work of cashiers and agencies, and much more useful. <br><br>  We developed a loyalty program right from the start.  The first release took place in February 2013.  The development of the system continues.  For example, we have just made a complete redesign of the portal.  But this was preceded by the migration to ADFS, as the most important stage of modernization.  About this - further speech. <br><br><a name="habracut"></a>  In brief, the ADFS operation scheme can be described as: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/208/ee6/d12/208ee6d126ba82aa71039d7389034f97.png"><br><br>  The client enters the portal, the portal web server redirects the client to the ADFS service for authorization.  Here the client passes authorization and receives from the authorization service ‚ÄúCLAIM‚Äù (marker), then with the help of this token is authorized on the portal. <br><br><h5>  ADFS Migration </h5><br>  The loyalty program is part of a complex solution based on SharePoint, which consists of different subsystems that live on different sites.  It was necessary to provide Single Sign On to all these products, to simplify and brand the entrance, to make it more familiar to users. <br><br>  In this case, it was necessary not to create a solution from scratch, but ‚Äúauthorization migration‚Äù from ‚Äúclassic ntlm‚Äù to ADFS.  And we went our own <a href="http://habrahabr.ru/company/eastbanctech/blog/168493/">classic way of spent multi-stage preparation for the transfer</a> : <br><br><ol><li>  We deployed a prototype solution on our test site and began to work out errors. </li><li>  After making sure that everything worked, we compiled the solution deployment documentation and sent it to the customer so that he could deploy the solution to himself. </li><li>  Tested with the customer on a test configuration. </li><li>  Successfully conducted combat migration. </li></ol><br><br><h5>  Analyzing your own solution </h5><br>  So, first analyze what we need to go: <br><br><ol><li>  We have a list of users of the site (several thousand) who need to be replaced with a claim record. </li><li>  We have lists and document libraries with custom permissions.  And it is necessary that after the migration of new users the rights remain the same. </li><li>  We have a bunch of custom code (web parts, pages, handlers, etc.) that check the level of user access through AD.  All this needs to be refactored and rewritten, given the fact that users may be branded. </li><li>  Since we are switching to ADFS not the entire portal, but only a single node, we will have to allocate the node into a separate web application.  But part of the data is used from the root node, so it is necessary to take out the data manipulation layer in the WCF service, with which we will receive this data in our new application. </li></ol><br>  We begin the process: <br><br><ol><li>  We started with 4 points - highlighting the receipt of data from the root node into a separate service and the subsequent separation of our node into a separate application. <br><br>  In the first part, there were no special problems - an ordinary code refactoring and setting up a WCF service.  A couple of weeks - and everything works. <br>  Separating a node into a separate application poses some difficulties.  Basically, they were connected with the fact that during import / export it was necessary to make sure that all the data was saved, users dragged, rights remained.  But since there was a lot of data on the node, the import / export procedure took about 3 hours, and if the result was unsuccessful, the whole thing had to be restarted and re-started again. <br><br>  The longest and most incomprehensible problem until some time was the problem with the import of users.  They seemed to be imported normally, but the rights to the lists and the libraries and fields with the User type did not want to be restored. <br><br>  After a long and painful search for the reasons, it turned out that the problem was that the portal had previously been migrated from SharePoint 2007 to SharePoint 2010, and in the list schema, the description of the User field was incomplete.  I had to start to run the utility (written by myself), then again do the export / import.  After that, the import was successful. </li><li>  Now you can switch the new application to ADFS.  We follow the standard procedure: <br><br>  a.  Install the trusted ADFS server and certificate via powershell script <br><br><pre><code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$map1</span></span> = New-SPClaimTypeMapping <span class="hljs-string"><span class="hljs-string">"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"</span></span> -IncomingClaimTypeDisplayName <span class="hljs-string"><span class="hljs-string">"EmailAddress"</span></span> -SameAsIncoming <span class="hljs-variable"><span class="hljs-variable">$map2</span></span> = New-SPClaimTypeMapping <span class="hljs-string"><span class="hljs-string">"http://schemas.microsoft.com/ws/2008/06/identity/claims/role"</span></span> -IncomingClaimTypeDisplayName <span class="hljs-string"><span class="hljs-string">"Role"</span></span> -SameAsIncoming <span class="hljs-variable"><span class="hljs-variable">$map3</span></span> = New-SPClaimTypeMapping <span class="hljs-string"><span class="hljs-string">"http://schemas.xmlsoap.org/ws/2005/05/identity/claims/upn"</span></span> -IncomingClaimTypeDisplayName <span class="hljs-string"><span class="hljs-string">"UserPrincipalName"</span></span> -SameAsIncoming <span class="hljs-variable"><span class="hljs-variable">$signingTokenCert</span></span> = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$signingTokenCertPath</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-variable"><span class="hljs-variable">$webServerCert</span></span> = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$webServerCertPath</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-variable"><span class="hljs-variable">$ap</span></span> = New-SPTrustedIdentityTokenIssuer -Name <span class="hljs-string"><span class="hljs-string">"ADFS Federated Server"</span></span> -Description <span class="hljs-string"><span class="hljs-string">"ADFS Federated Server"</span></span> -Realm <span class="hljs-variable"><span class="hljs-variable">$realm</span></span> -ImportTrustCertificate <span class="hljs-variable"><span class="hljs-variable">$signingTokenCert</span></span> -ClaimsMappings <span class="hljs-variable"><span class="hljs-variable">$map1</span></span>,<span class="hljs-variable"><span class="hljs-variable">$map2</span></span>,<span class="hljs-variable"><span class="hljs-variable">$map3</span></span> -SignInUrl <span class="hljs-variable"><span class="hljs-variable">$signinurl</span></span> -IdentifierClaim <span class="hljs-variable"><span class="hljs-variable">$map3</span></span>.InputClaimType New-SPTrustedRootAuthority <span class="hljs-string"><span class="hljs-string">"ADFS Token Signing"</span></span> -Certificate <span class="hljs-variable"><span class="hljs-variable">$signingTokenCert</span></span> New-SPTrustedRootAuthority <span class="hljs-string"><span class="hljs-string">"ADFS web server"</span></span> -Certificate <span class="hljs-variable"><span class="hljs-variable">$webServerCert</span></span></code> </pre> <br><br>  b.  Change application authentication settings <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a46/420/cf3/a46420cf3d0b052317bd916f288470fa.png"><br><br>  c.  We migrate users in order for all permissions to become through Claims (again through the powershell script) <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$webAppUrl</span></span> = <span class="hljs-string"><span class="hljs-string">"..."</span></span> <span class="hljs-variable"><span class="hljs-variable">$account</span></span> = <span class="hljs-string"><span class="hljs-string">"..."</span></span> <span class="hljs-variable"><span class="hljs-variable">$account</span></span> = (New-SPClaimsPrincipal -identity <span class="hljs-variable"><span class="hljs-variable">$account</span></span> -identitytype 1).ToEncodedString() <span class="hljs-variable"><span class="hljs-variable">$webApp</span></span> = get-SPWebApplication <span class="hljs-variable"><span class="hljs-variable">$webAppUrl</span></span> <span class="hljs-variable"><span class="hljs-variable">$policy</span></span> = <span class="hljs-variable"><span class="hljs-variable">$webApp</span></span>.ZonePolicies(<span class="hljs-string"><span class="hljs-string">"Default"</span></span>).Add(<span class="hljs-variable"><span class="hljs-variable">$account</span></span>,<span class="hljs-string"><span class="hljs-string">"PSPolicy"</span></span>) <span class="hljs-variable"><span class="hljs-variable">$fullControlRole</span></span>=<span class="hljs-variable"><span class="hljs-variable">$webApp</span></span>.PolicyRoles.GetSpecialRole(<span class="hljs-string"><span class="hljs-string">"FullControl"</span></span>) <span class="hljs-variable"><span class="hljs-variable">$policy</span></span>.PolicyRoleBindings.Add(<span class="hljs-variable"><span class="hljs-variable">$fullControlRole</span></span>) <span class="hljs-variable"><span class="hljs-variable">$webApp</span></span>.Update() <span class="hljs-variable"><span class="hljs-variable">$webApp</span></span>.MigrateUsers(<span class="hljs-variable"><span class="hljs-variable">$true</span></span>) <span class="hljs-variable"><span class="hljs-variable">$webApp</span></span>.ProvisionGlobally()</code> </pre><br><br>  d.  After that, we update all existing accounts and bring them to Claim records of the form i: 0e.t | ADFS Federated Server | user @ company <br>  After that, everything worked as a whole.  Then they trained for a long time locally and on test servers. </li></ol><br><br><h5>  Fighting Switching and Problems </h5><br>  Combat switching was done on Saturday, since the time for export / import only took about 5 hours.  In the end, with all the minor problems started at 9 am, finished at 12 at night :) <br><br>  In general, everything worked right away, since before that everyone had been trained and tested on a test environment.  But one bug got out, which on the test we have never repeated (and still does not repeat) - the problem of logout in Internet Explorer. <br><br>  <b>The bottom line is as follows:</b> <br><br>  To exit, use a redirect to an ADFS server page like <a href="https://adfs.ru/adfs/ls/%3Fwa%3Dwsignout1.0%26Source%3Dyoursiteurl">adfs.ru/adfs/ls/?wa=wsignout1.0&amp;Source=yoursiteurl</a> <br><br>  When a page is requested, the server handler deletes the session from ADFS, and in order to delete the authorization cookies and the session in SharePoint, on the same page lies an invisible iframe in which the exit page of the SharePoint portal is loaded. <br><br>  So, in order to log out to SharePoint correctly, you need to pass the FedAuth authorization cookies in the request when calling this exit page. <br><br>  As it turned out, this is not always the case in IE, and the effect was obtained when we click on the exit, but we cannot exit. <br><br>  As a result, I had to tweak the exit url a little, so that after working on the ADFS logout page, the SharePoint logout page was called directly and after that the ADFS authorization page was called back: <br><br>  <a href="https%253A%252F%252Fmyadfs.ru%252F">https://myadfs.ru/adfs/ls/?wa=wsignout1.0&amp;Source=https%3a%2f%2fmysharepoint%2f_trust%2f%3fwa%3dwsignoutcleanup1.0%26wreply%3dhttps%3a%2f%2fmyadfs.ru</a> <br>  (this is provided by MS out of the box). <br><br><h5>  Conclusion </h5><br>  Why was the loyalty program migration to ADFS important for the customer? <br><br><ol><li>  ADFS allows you to log in to the portal using a friendly login password instead of the awesome standard Windows Authentication form.  Also, if the user has forgotten the password, the system will kindly prompt him, you will not need to look for the admin and prove to him that you are not a camel. </li><li>  Such an entry can be branded with corporate colors and symbols and tailored to uniform corporate visual standards. </li><li>  ADFS makes it possible to configure single sign on authorization, and users will not be able to generate accounts, but log in using their accounts in social networks.  What can not but affect their mental equilibrium and positive attitude to work :) </li><li>  ADFS is great for use in such complex systems as our customer, because  provides single sign-on functionality to different web applications during one session. </li></ol></div><p>Source: <a href="https://habr.com/ru/post/209834/">https://habr.com/ru/post/209834/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../209824/index.html">Test boost :: lockfree on the speed and delay of message transmission</a></li>
<li><a href="../209826/index.html">The implementation of the shingle algorithm on Node.JS. Finding Fuzzy Duplicates for English Texts</a></li>
<li><a href="../209828/index.html">Hekslet: Erlang, logic, operating systems, Java 2</a></li>
<li><a href="../209830/index.html">Recognition of document images using the roulette algorithm</a></li>
<li><a href="../209832/index.html">Persuasion architecture, 7 user manipulation mechanisms</a></li>
<li><a href="../209838/index.html">How to test in Google</a></li>
<li><a href="../209842/index.html">The future of web systems design, an attempt to forecast</a></li>
<li><a href="../209844/index.html">Test: IMX6 and OMAP4 performance comparison</a></li>
<li><a href="../209848/index.html">NanoBeam</a></li>
<li><a href="../209850/index.html">Scala. Everyone out of the twilight!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>