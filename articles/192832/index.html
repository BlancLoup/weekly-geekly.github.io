<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>[NES] Writing level editor for Prince of Persia. Chapter Five Reflection</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chapter One , Chapter Two , Chapter Three , Chapter Four , Chapter Five , Epilogue 

 Disclaimer 
 Despite the fact that I wanted to make a simple edi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>[NES] Writing level editor for Prince of Persia. Chapter Five Reflection</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/post/187876/">Chapter One</a> , <a href="http://habrahabr.ru/post/191880/">Chapter Two</a> , <a href="http://habrahabr.ru/post/192028/">Chapter Three</a> , <a href="http://habrahabr.ru/post/192546/">Chapter Four</a> , <b>Chapter Five</b> , <a href="http://habrahabr.ru/post/193406/">Epilogue</a> <br><br><h5>  Disclaimer </h5><br>  Despite the fact that I wanted to make a simple editor that would only change the ‚Äúappearance‚Äù of the levels of the game, the twin of the character did not give me rest.  I really did not want to climb deep into the game engine, but this villain, emerging from the mirror, then drinking a bottle of "poison" in the middle of the game, and then completely dropping the prince into the abyss, did not give me rest.  For a week, I struggled with the psychological effect of the ‚Äúunfinished action‚Äù, but I could not overcome it. <br><br>  On the night from Friday to Saturday, I again opened the debugger, RAM Filter and started looking for ... <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Birth </h5><br>  It all started with the fact that I was sent a modification of the game, made in the editor, with the question: Why does it hang on entering one of the rooms? <br>  The room looked quite normal in the editor.  Checking the correctness of the work of the editor showed that everything is in order: what they asked for was saved.  I tried to move the objects that the author of the modification put in the room, and found that the hangup was gone, but a double appeared in the room, which, moreover, also had the audacity to attack: <br><img src="https://habrastorage.org/storage3/863/adb/458/863adb458b13e056288d7beca765b75d.png"><br>  That is, the presence of objects in the room somehow affects the presence / absence of a twin.  Everything is clear with the guards - their arrangement is spelled out directly in the level header, but there is not a single byte of information about the twin.  Data arrays for 4, 5 and 6 levels were no different from all the others in their essence.  The completely copied fifth level, say, the first one, did not ‚Äúcause‚Äù a twin from the core of the engine code, which means it is somehow sewn into the engine itself.  It was necessary to understand what changes if we enter a room with a double. <br><br>  I began to study the fifth level, since the counterpart there performed the most actions: if you press the button that opens the exit, he would appear, drink the precious contents of the bottle, and run away.  RAM Filter revealed anomalous activity when a double appeared in the memory in the $ 0400- $ 0410 address area: when entering the room, the flag in the $ 0401 cell was cocked, after pressing the button, the flag in the $ 0402 cell was additionally cocked, and then, after running away from the room, cell $ 0401 was reset and no longer changed.  So, we will study what is happening here. <br><br>  The presence of an additional character (guard, skeleton or twin) in a room in the NES version causes a slowdown in the engine, and this feature should be noted. <br>  We start the game, set it at $ 0401 units and really begin to observe the slowdown of the engine.  Moreover, the double begins to ‚Äúattack‚Äù us again. <br>  Once the cell $ 0401 is responsible for the presence / absence of this, then we go to the debugger, set a breakpoint: <br><img src="https://habrastorage.org/storage3/e59/0f8/9c7/e590f89c7cbefb89416bd592e0805cd1.png"><br>  In the Condition field we set the condition: the battery should not contain 0 when writing to the cell. Cell changes can also occur through the index registers, but often this is done through the battery.  Stop brings us here: <br><pre><code class="hljs mel">$A1D0:A9 <span class="hljs-number"><span class="hljs-number">00</span></span> LDA #$00 $A1D2:<span class="hljs-number"><span class="hljs-number">8</span></span>D <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> STA $0401 = #$00 $A1D5:A5 <span class="hljs-number"><span class="hljs-number">51</span></span> LDA $0051 = #$17 $A1D7:<span class="hljs-number"><span class="hljs-number">8</span></span>D DE <span class="hljs-number"><span class="hljs-number">04</span></span> STA $04DE = #$17 $A1DA:AD <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> LDA $0402 = #$00 $A1DD:D0 <span class="hljs-number"><span class="hljs-number">4</span></span>D BNE $A22C $A1DF:A9 <span class="hljs-number"><span class="hljs-number">3</span></span>D LDA #$3D $A1E1:<span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>F STA $002F = #$2D $A1E3:A9 A2 LDA #$A2 $A1E5:<span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> STA $0030 = #$A2 $A1E7:A5 <span class="hljs-number"><span class="hljs-number">70</span></span> LDA $0070 = #$04 $A1E9:C9 <span class="hljs-number"><span class="hljs-number">05</span></span> CMP #$05 $A1EB:D0 <span class="hljs-number"><span class="hljs-number">04</span></span> BNE $A1F1 $A1ED:A5 <span class="hljs-number"><span class="hljs-number">51</span></span> LDA $0051 = #$17 $A1EF:F0 <span class="hljs-number"><span class="hljs-number">2</span></span>D BEQ $A21E $A1F1:A9 <span class="hljs-number"><span class="hljs-number">4</span></span>D LDA #$4D $A1F3:<span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>F STA $002F = #$2D $A1F5:A9 A2 LDA #$A2 $A1F7:<span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> STA $0030 = #$A2 $A1F9:AD FD <span class="hljs-number"><span class="hljs-number">04</span></span> LDA $04FD = #$00 $A1FC:D0 <span class="hljs-number"><span class="hljs-number">0</span></span>C BNE $A20A $A1FE:A5 <span class="hljs-number"><span class="hljs-number">70</span></span> LDA $0070 = #$04 $A200:C9 <span class="hljs-number"><span class="hljs-number">03</span></span> CMP #$03 $A202:D0 <span class="hljs-number"><span class="hljs-number">06</span></span> BNE $A20A $A204:A5 <span class="hljs-number"><span class="hljs-number">51</span></span> LDA $0051 = #$17 $A206:C9 <span class="hljs-number"><span class="hljs-number">03</span></span> CMP #$03 $A208:F0 <span class="hljs-number"><span class="hljs-number">14</span></span> BEQ $A21E $A20A:A9 <span class="hljs-number"><span class="hljs-number">2</span></span>D LDA #$2D $A20C:<span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>F STA $002F = #$2D $A20E:A9 A2 LDA #$A2 $A210:<span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> STA $0030 = #$A2 $A212:A5 <span class="hljs-number"><span class="hljs-number">70</span></span> LDA $0070 = #$04 $A214:C9 <span class="hljs-number"><span class="hljs-number">04</span></span> CMP #$04 $A216:D0 <span class="hljs-number"><span class="hljs-number">14</span></span> BNE $A22C $A218:A5 <span class="hljs-number"><span class="hljs-number">51</span></span> LDA $0051 = #$17 $A21A:C9 <span class="hljs-number"><span class="hljs-number">17</span></span> CMP #$17 $A21C:D0 <span class="hljs-number"><span class="hljs-number">0</span></span>E BNE $A22C $A21E:A9 <span class="hljs-number"><span class="hljs-number">01</span></span> LDA #$01 $A220:<span class="hljs-number"><span class="hljs-number">8</span></span>D <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> STA $0401 = #$00 ;; &lt;&lt;&lt;  $A223:<span class="hljs-number"><span class="hljs-number">8</span></span>D E0 <span class="hljs-number"><span class="hljs-number">06</span></span> STA $06E0 = #$00 $A226:<span class="hljs-number"><span class="hljs-number">20</span></span> AD F2 JSR $F2AD $A229:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">85</span></span> DB JSR $DB85 $A22C:<span class="hljs-number"><span class="hljs-number">60</span></span> RTS</code> </pre> <br><br>  This sheet is quite difficult to understand, so I will translate it into pseudocode, calling the cells as follows: <br>  - $ 70 - LEVEL; <br>  - $ 51 - ROOM; <br>  - $ 401 - MIRROR_FLAG. <br>  We will deal with the rest later: <br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">char</span></span> sub_A1D0() { MIRROR_FLAG = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-meta"><span class="hljs-meta">$04</span></span>DE = ROOM; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-meta"><span class="hljs-meta">$0402</span></span> ) goto label_A22C; <span class="hljs-meta"><span class="hljs-meta">$2</span></span>F = #<span class="hljs-number"><span class="hljs-number">3</span></span>D; <span class="hljs-meta"><span class="hljs-meta">$30</span></span> = #A2; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">LEVEL</span></span> != #<span class="hljs-number"><span class="hljs-number">05</span></span> ) goto label_A1F1; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !ROOM ) goto label_A21E; label_A1F1: <span class="hljs-meta"><span class="hljs-meta">$2</span></span>F = #<span class="hljs-number"><span class="hljs-number">4</span></span>D; <span class="hljs-meta"><span class="hljs-meta">$30</span></span> = #A2; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-meta"><span class="hljs-meta">$04</span></span>FD ) goto label_A20A; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">LEVEL</span></span> != #<span class="hljs-number"><span class="hljs-number">03</span></span> ) goto label_A20A; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( ROOM == #<span class="hljs-number"><span class="hljs-number">03</span></span> ) goto label_A21E; label_A20A: <span class="hljs-meta"><span class="hljs-meta">$2</span></span>F = #<span class="hljs-number"><span class="hljs-number">2</span></span>D; <span class="hljs-meta"><span class="hljs-meta">$30</span></span> = #A2; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">LEVEL</span></span> != #<span class="hljs-number"><span class="hljs-number">04</span></span> ) goto label_A22C; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( ROOM != #<span class="hljs-number"><span class="hljs-number">17</span></span> ) goto label_A22C; label_A21E: MIRROR_FLAG = <span class="hljs-meta"><span class="hljs-meta">$06</span></span>E0 = #<span class="hljs-number"><span class="hljs-number">01</span></span>; sub_F2AD(); sub_DB85(); label_A22C: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre><br>  Now it's easier to learn.  As we see, those levels and rooms in them where the twin appears appear, the flag of its presence is set and two more procedures are called.  I will not give them, I will only describe what they do. <br>  - $ F2AD - searches for the doubled #FF marker, starting at address $ 060E, then returns the length of the byte sequence between $ 060E and the #FFFF marker (not including the last one) in the Y register; <br>  - $ DB85 ‚Äî shifts a sequence of bytes, starting from the #FFFF marker found by the previous procedure, forward by the length of the sequence whose address is stored in $ 2F cells: $ 30, and which also ends with the #FFFF marker. <br>  As we can see, hard-coded addresses are inserted somewhere in the ROM into $ 2F and $ 30 cells: $ A22D, $ A23D, $ A24D. <br><br>  Just making a unit in the $ 0401 cell is not enough, you still have to do some magical actions. <br><br><h6>  Two of the same casket from the face </h6><br>  Since the double appears only when the flag is cocked in the $ 0402 cell, we will look first at where the entry is made to it, and then where the value is read from it.  The flag is cocked, as expected, then when we press the button that opens the exit (there is nothing interesting there).  But reading from the cell is done here: <br><pre> <code class="hljs mel">$A319:A9 <span class="hljs-number"><span class="hljs-number">89</span></span> LDA #$89 $A31B:<span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> STA $0072 = #$89 $A31D:A9 A3 LDA #$A3 $A31F:<span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">73</span></span> STA $0073 = #$A3 $A321:AD <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> LDA $0402 = #$01 ;; &lt;&lt;  $A324:F0 <span class="hljs-number"><span class="hljs-number">53</span></span> BEQ $A379 $A326:AD <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> LDA $0401 = #$01 $A329:F0 <span class="hljs-number"><span class="hljs-number">4</span></span>E BEQ $A379 $A32B:EE <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> INC $0404 = #$00 $A32E:AC <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> LDY $0403 = #$00 $A331:B1 <span class="hljs-number"><span class="hljs-number">72</span></span> LDA ($72),Y @ $A389 = #$15 $A333:C9 FF CMP #$FF $A335:F0 <span class="hljs-number"><span class="hljs-number">43</span></span> BEQ $A37A $A337:CD <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> CMP $0404 = #$01 $A33A:D0 <span class="hljs-number"><span class="hljs-number">0</span></span>B BNE $A347 $A33C:A9 <span class="hljs-number"><span class="hljs-number">00</span></span> LDA #$00 $A33E:<span class="hljs-number"><span class="hljs-number">8</span></span>D <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> STA $0404 = #$01 $A341:EE <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> INC $0403 = #$00 $A344:EE <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> INC $0403 = #$00 $A347:C8 INY $A348:B1 <span class="hljs-number"><span class="hljs-number">72</span></span> LDA ($72),Y @ $A389 = #$15 ;; ...</code> </pre><br>  A remarkable procedure, isn't it?  The essence of its actions, if you study it entirely, is very similar to the procedure that plays for us in demo play.  In cells $ 72: $ 73 we have the address $ A389: <br> <code>15 01 06 0D 02 02 03 32 0C 4E 02 05 17 01 FF</code> <br>  The same #FF marker, the same structures consisting of two bytes, where the first one is time, and the second one ... no, the second one is no longer an imitation of a gamepad, but something else.  When the value counted in cell $ 0404 is compared with the first byte of the structure, the counter in cell $ 0403 is incremented by 2 and the process repeats.  If you look at what happens during this process with the second byte, then we come to a certain array of pointers: <br> <code>0x15602: 00 00 AE 96 DB 96 64 97 9D 97 ...</code> <br>  The index in this array will be our second byte.  Each pointer in this array points to a structure with which the engine works rather cunningly.  If this structure contains a value that is greater than a certain number, then it is decoded into an index, which is used in the array of pointers to certain procedures in the code.  If the number is less than a certain number, then it is used as an argument for the above procedures.  These procedures, performing certain actions, bring the following pointer into the structure responsible for the character.  Thus, after a certain starting pointer is set in the character structure, a self-regulating cycle begins to be executed, which sets the sprite in motion.  For example, if we write the ‚Äúaction‚Äù pointer into the structure, then each step of the run will be initiated by the previous one, specifying a new pointer in the same structure in the ActionPtr field during each iteration.  In addition, in these procedures, the sprite will be moved on the screen and its actions will be voiced. <br><br>  Total pointers in the array 93 pieces.  That is, the game supports 93 actions for the character.  But since pointers are sometimes repeated, there are fewer different actions.  I cited this structure (character) earlier, so I will not dwell on its analysis.  If we study the actions of the twin, we can see that its structure repeats the structure of the prince himself.  In other words, when a double appears in the room, then after the structure describing the prince, the same structure is inserted that describes the double.  The flag is cocked in the $ 0401 cell, and then the engine, depending on the level number, the room number and our actions, makes changes to this structure, thus setting the double into motion. <br><br><div class="spoiler">  <b class="spoiler_title">The full code (in pseudocode) of the 'double drive'</b> <div class="spoiler_text"><pre> <code class="hljs dos">char sub_A25D() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !MIRROR_FLAG ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A277; $<span class="hljs-number"><span class="hljs-number">06</span></span>E0 = MIRROR_FLAG; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( level == #<span class="hljs-number"><span class="hljs-number">03</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A28D; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( level != #<span class="hljs-number"><span class="hljs-number">04</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A272; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A319; label_A272: // here CMP #<span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A398; label_A277: return; label_A278: $<span class="hljs-number"><span class="hljs-number">0072</span></span> = #<span class="hljs-number"><span class="hljs-number">86</span></span>; $<span class="hljs-number"><span class="hljs-number">0073</span></span> = #A3; $<span class="hljs-number"><span class="hljs-number">04</span></span>FE = #<span class="hljs-number"><span class="hljs-number">00</span></span>; MIRROR.Y.LOW = #<span class="hljs-number"><span class="hljs-number">40</span></span>; return sub_A326(); label_A28D: $<span class="hljs-number"><span class="hljs-number">04</span></span>FB = $<span class="hljs-number"><span class="hljs-number">0402</span></span> = #<span class="hljs-number"><span class="hljs-number">00</span></span>; MIRROR.DIRECTION = #FF; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( room != #<span class="hljs-number"><span class="hljs-number">03</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A2CF; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( $<span class="hljs-number"><span class="hljs-number">04</span></span>FD ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A278; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( PRINCE.Y.LOW &gt;= #<span class="hljs-number"><span class="hljs-number">48</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A2CF; $<span class="hljs-number"><span class="hljs-number">04</span></span>FB = $<span class="hljs-number"><span class="hljs-number">04</span></span>FC; // <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> prince around mirror (by Y pos) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !$<span class="hljs-number"><span class="hljs-number">04</span></span>FB ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A2C3; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( PRINCE.X.HI ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A2C3; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( PRINCE.X.LOW &lt;= #AC ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A2D0; label_A2C3: A = #<span class="hljs-number"><span class="hljs-number">02</span></span>; Y = #<span class="hljs-number"><span class="hljs-number">0</span></span>E; sub_CAFD(); MIRROR.X.HI = #<span class="hljs-number"><span class="hljs-number">02</span></span>; label_A2CF: return; label_A2D0: X = #<span class="hljs-number"><span class="hljs-number">98</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !PRINCE.DIRECTION ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A2D9; X = #<span class="hljs-number"><span class="hljs-number">94</span></span>; label_A2D9: MIRROR.X.LOW = X; MIRROR.X.HI = #<span class="hljs-number"><span class="hljs-number">00</span></span>; MIRROR.Y.LOW = PRINCE.Y.LOW; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( PRINCE.ACTION_INDEX == #<span class="hljs-number"><span class="hljs-number">06</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A2C3; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( PRINCE.POSE_INDEX &lt;= #<span class="hljs-number"><span class="hljs-number">06</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A2F9; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( PRINCE.POSE_INDEX &lt;= #<span class="hljs-number"><span class="hljs-number">0</span></span>E ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A301; label_A2F9: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( PRINCE.POSE_INDEX &lt;= #<span class="hljs-number"><span class="hljs-number">20</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A302; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( PRINCE.POSE_INDEX &gt;= #<span class="hljs-number"><span class="hljs-number">28</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A302; label_A301: return; label_A302: X = #<span class="hljs-number"><span class="hljs-number">00</span></span>; Y = #<span class="hljs-number"><span class="hljs-number">05</span></span>; label_A306: MIRROR.ACTION_PTR = PRINCE.ACTION_PTR; X++; Y--; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( Y ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A306; MIRROR.DIRECTION = PRINCE.DIRECTION xor #FF; return; label_A319: $<span class="hljs-number"><span class="hljs-number">0072</span></span> = #<span class="hljs-number"><span class="hljs-number">89</span></span>; $<span class="hljs-number"><span class="hljs-number">0073</span></span> = #A3; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !$<span class="hljs-number"><span class="hljs-number">0402</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A379; label_A326: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !$<span class="hljs-number"><span class="hljs-number">0401</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A379; $<span class="hljs-number"><span class="hljs-number">404</span></span>++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( $<span class="hljs-number"><span class="hljs-number">72</span></span>[Y] == #FF ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A37A; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( $<span class="hljs-number"><span class="hljs-number">0404</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A347; $<span class="hljs-number"><span class="hljs-number">0404</span></span> = #<span class="hljs-number"><span class="hljs-number">00</span></span>; $<span class="hljs-number"><span class="hljs-number">0403</span></span> += <span class="hljs-number"><span class="hljs-number">2</span></span>; label_A347: Y++; A = $<span class="hljs-number"><span class="hljs-number">72</span></span>[Y]; Y = #<span class="hljs-number"><span class="hljs-number">0</span></span>E; sub_CAFD(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( MIRROR.POSE_INDEX != #<span class="hljs-number"><span class="hljs-number">6</span></span>D ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A379; $<span class="hljs-number"><span class="hljs-number">0054</span></span> = $<span class="hljs-number"><span class="hljs-number">06</span></span>F0 = #<span class="hljs-number"><span class="hljs-number">00</span></span>; $<span class="hljs-number"><span class="hljs-number">04</span></span>B1 = #<span class="hljs-number"><span class="hljs-number">03</span></span>; sub_DB23(); A = #<span class="hljs-number"><span class="hljs-number">27</span></span>; sub_F203(); #<span class="hljs-number"><span class="hljs-number">0610</span></span>[X] = #<span class="hljs-number"><span class="hljs-number">02</span></span>; A = #<span class="hljs-number"><span class="hljs-number">20</span></span>; sub_F203(); #<span class="hljs-number"><span class="hljs-number">0610</span></span>[X] = #<span class="hljs-number"><span class="hljs-number">02</span></span>; label_A379: return; label_A37A: $<span class="hljs-number"><span class="hljs-number">060</span></span>E = $<span class="hljs-number"><span class="hljs-number">061</span></span>C = $<span class="hljs-number"><span class="hljs-number">0401</span></span> = #<span class="hljs-number"><span class="hljs-number">00</span></span>; return; A386: .data[XX:YY],<span class="hljs-number"><span class="hljs-number">1</span></span>C:<span class="hljs-number"><span class="hljs-number">01</span></span> FF // XX:<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>, YY:action, FF:EOF A389: .data[XX:YY],<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>D <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>C:<span class="hljs-number"><span class="hljs-number">4</span></span>E <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> FF label_A398: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( level == #<span class="hljs-number"><span class="hljs-number">05</span></span> &amp;&amp; !$<span class="hljs-number"><span class="hljs-number">610</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A3A7; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( PRINCE.X.LOW &lt;= #<span class="hljs-number"><span class="hljs-number">10</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A3A7; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A3D1; label_A3A7: $<span class="hljs-number"><span class="hljs-number">0054</span></span> = #<span class="hljs-number"><span class="hljs-number">00</span></span>; $<span class="hljs-number"><span class="hljs-number">04</span></span>B1 = #<span class="hljs-number"><span class="hljs-number">0</span></span>C; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !sub_DB18() ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A3D1; $<span class="hljs-number"><span class="hljs-number">0072</span></span> = #D2; $<span class="hljs-number"><span class="hljs-number">0073</span></span> = #A3; sub_A326(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( MIRROR.POSE_INDEX != #<span class="hljs-number"><span class="hljs-number">7</span></span>C ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_A3D1; $<span class="hljs-number"><span class="hljs-number">06</span></span>FC = #<span class="hljs-number"><span class="hljs-number">00</span></span>; $<span class="hljs-number"><span class="hljs-number">06</span></span>FB = #<span class="hljs-number"><span class="hljs-number">0</span></span>B; label_A3D1: return; A3D2: .data[XX:YY]: <span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>A F0:<span class="hljs-number"><span class="hljs-number">02</span></span> F0:<span class="hljs-number"><span class="hljs-number">02</span></span> F0:<span class="hljs-number"><span class="hljs-number">02</span></span> FF } char sub_F203() { $<span class="hljs-number"><span class="hljs-number">0017</span></span> = A; switch_bank(#<span class="hljs-number"><span class="hljs-number">02</span></span>); sub_B298(); $<span class="hljs-number"><span class="hljs-number">04</span></span>BF = Y; switch_bank($<span class="hljs-number"><span class="hljs-number">06</span></span>D1); Y = $<span class="hljs-number"><span class="hljs-number">04</span></span>BF; return; } char sub_B298() { X=#<span class="hljs-number"><span class="hljs-number">00</span></span>; label_B29A: // aka sub_B29A Y=#<span class="hljs-number"><span class="hljs-number">00</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( #<span class="hljs-number"><span class="hljs-number">060</span></span>E[X] != #FF ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_B2A4; Y++; label_B2A4: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( #<span class="hljs-number"><span class="hljs-number">060</span></span>E[X] &amp; #<span class="hljs-number"><span class="hljs-number">7</span></span>F == $<span class="hljs-number"><span class="hljs-number">0017</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_B2BC; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( #<span class="hljs-number"><span class="hljs-number">060</span></span>F[X] != #FF ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_B2B2; Y++; label_B2B2: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( Y == #<span class="hljs-number"><span class="hljs-number">02</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_B2BF; sub_F215(); <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_B29A; label_B2BC: Y = #<span class="hljs-number"><span class="hljs-number">01</span></span>; return; label_B2BF: Y = #<span class="hljs-number"><span class="hljs-number">00</span></span>; return; } char sub_8730() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( A == #<span class="hljs-number"><span class="hljs-number">0616</span></span>[Y] ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_874B; // $<span class="hljs-number"><span class="hljs-number">0616</span></span>+Y - address of MIRROR.ACTION_INDEX $<span class="hljs-number"><span class="hljs-number">0616</span></span>[Y] = A; X = A &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>; #<span class="hljs-number"><span class="hljs-number">0613</span></span>[Y] = #<span class="hljs-number"><span class="hljs-number">95</span></span>F2[X]; // <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> MIRROR.ACTION_PTR to new value ($<span class="hljs-number"><span class="hljs-number">0613</span></span> + Y - address of ACTION_PTR <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> MIRROR struct) #<span class="hljs-number"><span class="hljs-number">0614</span></span>[Y] = #<span class="hljs-number"><span class="hljs-number">95</span></span>F3[X]; #<span class="hljs-number"><span class="hljs-number">0618</span></span>[Y] = #FF; // <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> EOF marker label_874B: return; }</code> </pre></div></div><br>  It is worth noting that the ‚Äúreflection‚Äù procedure in the mirror is quite interesting.  If the prince is located next to the mirror, then the double is placed in the next position from him, the pointer of the prince‚Äôs action is copied into the double structure, and the direction byte is inverted.  If the position of the prince is "run jump", then the twin "runs out" from the mirror and runs away. <br><br><h5>  Make patch </h5><br>  This code is quite difficult to link with the editor.  You can, of course, edit those short data arrays used by the above code, but you would have to do some work, and the effect would be insignificant.  Editing this code with the editor is too difficult.  I wanted something more.  And the solution was found. <br><br>  To manage the twin, it will be enough for us to copy its structure after the structure of the prince himself and set the flag $ 0401.  In the future, we will set the actions that it will perform by writing a pointer to its structure.  But how to do that?  Need to write code.  But where to insert it?  There are practically no free places in the game, and those small stubs of several bytes left between the code and data cannot be used.  So, it is necessary to seek additional space in other ways. <br><br><h5>  Wider circle </h5><br>  As we remember, Mapper # 02 contains two different types of mapping.  One of them - UNROM, - contains 8 banks of PRG-ROM, and the second - UOROM, - 16. If you insert another 8x16 kB in the ROM file, the mapper will change to UOROM without harm to the game.  However, it is necessary to insert it so that the last bank remains the last, and the first 7 should remain at the beginning. <br><br>  We climb to the hex editor, change the number of banks in the header (fifth byte, offset 0x04) from # 08 to # 10, then paste 8x16 kB zeros into the file, starting at offset 0x1C010.  The size of the ROM file changes and becomes equal to 262,160 bytes.  Run the ROM in the emulator ... It works! <br>  If we perform this procedure in hardware, we will need to change the mapper controller, and put the increased ROM memory - 32x8 KB, and we will also get a working game. <br><br>  ROM increased, there is a place, but how to use it?  In order to call the code or read the data from there, we need to turn on this bank and transfer control there.  This can be done safely only from the last bank, but there is no space in it.  Where to write the code? <br>  Let us set the requirements: <br><ul><li>  The code should be called from the main game loop, since we will manage the twin right during the main game; </li><li>  The code should be called and return control to the last bank; </li><li>  Called code should not break the original code. </li></ul><br><br>  Recall the main loop.  There, we call various procedures, before which the procedures for including the relevant bank are called.  It is quite difficult to insert two new procedures and add new calls to the main loop, but we can change one of the bank inclusion procedures. <br>  Take the end of the cycle: <br><pre> <code class="hljs perl">;; ... $CC3B:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> CB JSR $CB00 $CC3E:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>F JSR $9F12 $CC41:<span class="hljs-number"><span class="hljs-number">20</span></span> DD A3 JSR $A3DD $CC44:<span class="hljs-number"><span class="hljs-number">4</span></span>C <span class="hljs-number"><span class="hljs-number">1</span></span>A CC JMP $CC1A</code> </pre><br>  Procedures $ 9F12, $ A3DD cannot be touched, as they are in another bank, in the place of which ours should be.  It is also impossible to transfer them there, as they will pull the rest of the contents of the bank with them.  You can, however, change the address of $ CB00 to the address of the new procedure, which will include our # 07 bank, call our code, then call the original $ CB00 procedure and return control back to the loop.  Code like this: <br><pre> <code class="hljs mel">LDA #<span class="hljs-number"><span class="hljs-number">07</span></span> JSR $F2D3 ;;   #<span class="hljs-number"><span class="hljs-number">07</span></span> JSR $8000 ;;   ,      JMP $CB00 ;;    $CB00, ;;    RTS     </code> </pre><br>  12 bytes (3 bytes for each instruction).  Not much, but they need to be inserted somewhere, and there is no place anyway.  Few places can be won by modifying the existing code in the last bank.  It is enough to take some long procedure that does not use data from banks # 00 to # 06, which also does not call procedures using these banks, and which is called from procedures that do not use these banks.  After we find it, we will be able to transfer it to a new bank, place our code in its place, and put a call from the new bank before our code. <br><br>  Long or short, this procedure was found: <br><pre> <code class="hljs mel">$C111:AD C6 <span class="hljs-number"><span class="hljs-number">06</span></span> LDA $06C6 = #$00 $C114:C9 <span class="hljs-number"><span class="hljs-number">06</span></span> CMP #$06 $C116:B0 <span class="hljs-number"><span class="hljs-number">20</span></span> BCS $C138 $C118:AD D7 <span class="hljs-number"><span class="hljs-number">06</span></span> LDA $06D7 = #$04 $C11B:D0 <span class="hljs-number"><span class="hljs-number">1</span></span>B BNE $C138 $C11D:<span class="hljs-number"><span class="hljs-number">8</span></span>D <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span> STA $0730 = #$00 $C120:<span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">54</span></span> STA $0054 = #$01 $C122:<span class="hljs-number"><span class="hljs-number">8</span></span>D F0 <span class="hljs-number"><span class="hljs-number">06</span></span> STA $06F0 = #$00 $C125:AD <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span> LDA $0617 = #$0C $C128:C9 <span class="hljs-number"><span class="hljs-number">11</span></span> CMP #$11 $C12A:<span class="hljs-number"><span class="hljs-number">90</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>D BCC $C139 $C12C:C9 <span class="hljs-number"><span class="hljs-number">2</span></span>B CMP #$2B $C12E:B0 <span class="hljs-number"><span class="hljs-number">09</span></span> BCS $C139 $C130:C9 <span class="hljs-number"><span class="hljs-number">1</span></span>A CMP #$1A $C132:<span class="hljs-number"><span class="hljs-number">90</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> BCC $C138 $C134:C9 <span class="hljs-number"><span class="hljs-number">26</span></span> CMP #$26 $C136:<span class="hljs-number"><span class="hljs-number">90</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> BCC $C139 $C138:<span class="hljs-number"><span class="hljs-number">60</span></span> RTS</code> </pre><br><br>  What she does is an open question, but, incidentally, it doesn't matter.  The main thing is that it meets all the necessary requirements: it is not called from ‚Äúdynamic‚Äù banks, it does not call the code of them and does not apply to them.  And the transition to $ C139 we will redo a little. <br>  We modify our bank inclusion code a bit and place it at $ C111: <br><pre> <code class="hljs mel">$C111:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> C1 JSR $C117 ;;     $C114:<span class="hljs-number"><span class="hljs-number">4</span></span>C <span class="hljs-number"><span class="hljs-number">90</span></span> BF JMP $BF90 ;;     (     $BF90) ;;    RTS      ;; ========     ========== $C117:A9 <span class="hljs-number"><span class="hljs-number">07</span></span> LDA #$07 $C119:<span class="hljs-number"><span class="hljs-number">4</span></span>C D3 F2 JMP $F2D3 ;; ========      ========== ;;   ,    $C11C:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> C1 JSR $C117 ;;   $C11F:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> B0 JSR $B010 ;;   .    - $B010. $C122:<span class="hljs-number"><span class="hljs-number">4</span></span>C <span class="hljs-number"><span class="hljs-number">00</span></span> CB JMP $CB00 ;;   $CB00,       $C125:<span class="hljs-number"><span class="hljs-number">00</span></span> BRK ;; ... $C138:<span class="hljs-number"><span class="hljs-number">00</span></span> BRK</code> </pre><br>  Not only did we successfully cram the call to our code, we still have a lot of space left from $ C125 to $ C138, which we can use somehow else: after all, we still have 7 (!) Free banks, and they will also need to work from the last bank (if we use them in the future).  I placed the address of the new code at $ B010 (approximately the middle of the bank), since we will have to place a copy of the levels and rooms in our bank, plus some other data.  But more about that below. <br><br>  We also modify the procedure itself, since it contains jumps to the address $ C139, which is outside of it: <br><pre> <code class="hljs mel">$BF90:AD C6 <span class="hljs-number"><span class="hljs-number">06</span></span> LDA $06C6 = #$00 ;; ============ CUT ============ $BFAA:<span class="hljs-number"><span class="hljs-number">90</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>D BCC $BFB9 $BFAC:C9 <span class="hljs-number"><span class="hljs-number">2</span></span>B CMP #$2B $BFAE:B0 <span class="hljs-number"><span class="hljs-number">09</span></span> BCS $BFB9 $BFB0:C9 <span class="hljs-number"><span class="hljs-number">1</span></span>A CMP #$1A $BFB2:<span class="hljs-number"><span class="hljs-number">90</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> BCC $BFB8 $BFB4:C9 <span class="hljs-number"><span class="hljs-number">26</span></span> CMP #$26 $BFB6:<span class="hljs-number"><span class="hljs-number">90</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> BCC $BFB9 $BFB8:<span class="hljs-number"><span class="hljs-number">60</span></span> RTS $BFB9:<span class="hljs-number"><span class="hljs-number">4</span></span>C <span class="hljs-number"><span class="hljs-number">39</span></span> C1 JMP $C139</code> </pre><br>  Everything!  What once passed to the address $ C139 now goes to the address $ BFB9, according to which the JMP instruction makes you jump to $ C139, as if we hadn‚Äôt moved the code anywhere. <br>  The body of the main loop, we can now change to the following: <br><pre> <code class="hljs perl">;; ... $CC3B:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> CB JSR $C11 $CC3E:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>F JSR $9F12 $CC41:<span class="hljs-number"><span class="hljs-number">20</span></span> DD A3 JSR $A3DD $CC44:<span class="hljs-number"><span class="hljs-number">4</span></span>C <span class="hljs-number"><span class="hljs-number">1</span></span>A CC JMP $CC1A</code> </pre><br>  We can place some dummy like ‚ÄúRTS‚Äù at $ B010 and run the game in the emulator.  Everything was as it was - it remained. <br><br><h5>  We write our "drive" for "reflection" </h5><br>  It remains only to develop its own algorithm for the appearance of reflections in the room. <br>  I developed the following data structure: <br><img src="http://habrastorage.org/storage3/ddc/a36/46d/ddca3646dcf92bb6e80fbbe824c45309.png"><br><br>  When entering the room, we extract the pointer by the level number in the first pointer array (Levels ptrs), if it is not zero, then go to the second array (Rooms ptrs). <br>  If the pointer extracted by the room number is also not zero, then proceed to reading the structure of the reflection. <br>  The structure of the reflection is as follows: <br><ul><li>  Structure describing the initial state of the character (struct CHARACTER); </li><li>  Pairs ‚Äútime‚Äù: ‚Äúaction‚Äù, which describe what the character will do and in what time interval; </li><li>  Graduation marker # FF. </li></ul><br><br>  In order not to bore the reader with an excess of code, I will not give it here.  It will be at the end of the article. <br><br><h5>  We respond to events </h5><br>  The unconditional appearance of reflection is uninteresting.  It seems it is, but no sense.  I would like it to appear in accordance with any game events and know how to do something. <br><br>  Starting with the address $ 0500 in memory, we have data that determine certain changes in the rooms.  For example, if a character drinks a potion from a bottle, the bottle will not appear there anymore.  Or, if the plate falls, then this array will contain both the fact that now there is a hole in its place, as well as the fact that in the place where it fell - its fragments.  The same with open and closed grids.  Each such event is encoded with two bits.  In the room we have 30 blocks, for each line of 10 blocks there are 3 bytes (4 blocks fit in 1 byte, and in the third byte the remaining 4 bits remain unused), totaling 9 bytes per room.  Thus, the level goes 9 * 24 = 216 bytes. <br><br>  As soon as an action has taken place, the corresponding pair of bits in this array is set to a specific value.  Total possible combinations - 3 (00 - means that nothing happened), and a lot of events: the grate opened, the grate closed, drank from the bottle, the plate is missing (dropped), fragments of a fallen plate;  accordingly, events overlap.  For example, if we place a bottle and hang a falling plate above it, after its fall we will either miss the bottle or not see fragments of the fallen plate. <br><br>  Apply this knowledge to our patch.  In the structure that we came up with, we add an address that should be constantly read, and a value with which to compare.  As long as the specified value is not the desired value, we will not set in motion our twin. <br><br><h5>  We force to push the button </h5><br>  And finally, it remains to teach him to do something.  Double out of the box can not do anything.  Able only to appear on the screen and make any movements, calluses of the eye.  He does not know how to make contact with the walls, he does not know how to press buttons, and in general he is not able to do anything. <br><br>  While our prince is doing something in the game, his coordinates are constantly compared with the block in which he is located, and if this block is ‚Äúactive‚Äù, certain actions are taken: for example, if we hit the ‚ÄúButton‚Äù block, this button will be to push.  The double runs on its own and no one follows its movements.  So, we in our patch must do this for the main engine.  To do this, it is enough to transfer to the main engine (to the verification procedure) the coordinate of the twin instead of the coordinate of the prince, and then everything will happen by itself.  But the problem is that the engine compares the block with the data array of the room, which is stored in another bank.  Nevertheless, there is still enough space in our bank, and it will be included during the check, so we ... just copy the game data from the original bank to ours at the same place, and the engine will read this data as if nothing had happened ( Remember, earlier we placed the code in the middle of the bank?).  During editing, however, now it will be necessary to consider that changes should be made to the main copy and to the backup. <br><br>  The result is obvious: <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/jrA0xkY1OL0%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700253&amp;usg=ALkJrhjRkgryiQEhO3XA6FcIe9lXbFFE7g" frameborder="0" allowfullscreen=""></iframe><br><br><h5>  FIN </h5><br>  In the end, we managed to force the twin to be not just furniture, but to perform the simplest action ‚Äî to press a button and open a door for us.  Already with such a simple thing, it was possible to inject a puzzle element into the game: until you press a button, break a plate or drink from a bottle at one end of a level, a reflection appears in the other that does not press a button that opens, for example, an exit. <br><br>  Well, now you can add the game together, or new characters, or new blocks, but ... it would be a different game.  By this time I was completely satisfied with my curiosity, so I closed the debugger and went to sleep.  It was a warm July Monday. <br><br><h5>  PS </h5><br>  But this is not the end.  After the end, an epilogue will follow: I have finished with the editor, but there is still one unclear question that I would like to make out.  So ahead ‚ÄúEpilogue.  Dungeon. <br><br>  I attach a <a href="http://yadi.sk/d/WzX11T_h8qbk3">link</a> where you can download the archive with the editor, a small documentation on the game and the source code of the patch. </div><p>Source: <a href="https://habr.com/ru/post/192832/">https://habr.com/ru/post/192832/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../192818/index.html">Simplify the life of the administrator, associate the user name and computer name in automatic mode in the AD directory</a></li>
<li><a href="../192820/index.html">Unity3D + Kinect, or animation on the knee</a></li>
<li><a href="../192822/index.html">SecurityLab.ru launches online vulnerability notification service</a></li>
<li><a href="../192824/index.html">Something about edX Blades</a></li>
<li><a href="../192828/index.html">Continuous integration of .NET projects: NAnt and / or MSBuild?</a></li>
<li><a href="../192834/index.html">Scilab - from factorial search to tic-tac-toe</a></li>
<li><a href="../192836/index.html">IFA 2013: PocketBook CoverReader</a></li>
<li><a href="../192838/index.html">LLVM news for Windows</a></li>
<li><a href="../192840/index.html">Founder of startups worth more than $ 2,000,000,000, Founder of the Founder Institute Adeo Ressi: ‚ÄúFabulous talented guys in the CIS!‚Äù</a></li>
<li><a href="../192842/index.html">Zeno's quantum paradox</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>