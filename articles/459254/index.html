<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Still the best ZIP bomb</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article shows how to create a non - recursive zip-bomb , which provides a high degree of compression by overlapping files inside a zip-container. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Still the best ZIP bomb</h1><div class="post__text post__text-html js-mediator-article">  The article shows how to create a <i>non</i> <a href="https://en.wikipedia.org/wiki/Zip_bomb">-</a> <i>recursive</i> <a href="https://en.wikipedia.org/wiki/Zip_bomb">zip-bomb</a> , which provides a high degree of compression by overlapping files inside a zip-container.  ‚ÄúNon-recursive‚Äù means that it does not depend on the recursive decompressing by decompressor of files embedded in zip-archives: there is only one round.  The output size increases quadratically from the input, reaching a compression ratio of over 28 million (10 MB ‚Üí 281 TB) within the zip format.  An even larger expansion is possible with 64-bit extensions.  The design uses only the most common compression algorithm DEFLATE and is compatible with most zip parsers. <br><br><a name="2"></a><ul><li>  <a href="">zbsm.zip</a> 42 kB ‚Üí 5.5 GB <br></li><li>  <a href="">zblg.zip</a> 10 MB ‚Üí 281 TB <br></li><li>  <a href="">zbxl.zip</a> 46 MB ‚Üí 4.5 PB (Zip64, less compatible with parsers) </li></ul><br>  Source: <br><pre>  git clone https://www.bamsoftware.com/git/zipbomb.git </pre>  <a href="">zipbomb-20190702.zip</a> <br><br>  Data and sources of illustrations: <br><pre>  git clone https://www.bamsoftware.com/git/zipbomb-paper.git </pre><a name="habracut"></a><br><div class="scrollable-table"><table><thead><tr><td colspan="2"></td><th colspan="2">  non-recursive </th><th colspan="2">  recursive </th></tr><tr><td></td><th>  archive size </th><th>  uncompressed size </th><th>  ratio </th><th>  uncompressed size </th><th>  ratio </th></tr></thead><tbody><tr><th>  <a href="https://research.swtch.com/zip">Quine Cox</a> </th><td>  440 </td><td>  440 </td><td>  1.0 </td><td>  ‚àû </td><td>  ‚àû </td></tr><tr><th>  <a href="http://www.steike.com/code/useless/zip-file-quine/">Quine Ellingsen</a> </th><td>  28,809 </td><td>  42 569 </td><td>  1.5 </td><td>  ‚àû </td><td>  ‚àû </td></tr><tr><th>  <a href="https://www.unforgettable.dk/">42.zip</a> </th><td>  42 374 * </td><td>  558 432 </td><td>  13.2 </td><td>  4 507 981 343 026 016 </td><td>  106 billion </td></tr><tr><th>  this technique </th><td>  42 374 </td><td>  5 461 307 620 </td><td>  129 thousand </td><td>  5 461 307 620 </td><td>  129 thousand </td></tr><tr><th>  this technique </th><td>  9,893,525 </td><td>  281 395 456 244 934 </td><td>  28 million </td><td>  281 395 456 244 934 </td><td>  28 million </td></tr><tr><th>  this technique (zip64) </th><td>  45 876 ‚Äã‚Äã952 </td><td>  4 507 981 427 706 459 </td><td>  98 million </td><td>  4 507 981 427 706 459 </td><td>  98 million </td></tr></tbody></table></div><br>  <sub>* There are two versions of 42.zip: the <a href="http://www.unforgettable.dk/">old</a> 42,374 bytes, and <a href="http://www.unforgettable.dk/">the newer one</a> at 42,838 bytes.</sub>  <sub>The difference is that a new password is required before unpacking.</sub>  <sub>We compare only with the old version.</sub>  <sub>Here is a copy of the file, if you need one: <a href="">42.zip</a> .</sub> <sub>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </sub>  <sub>** I would like to know and indicate the author of 42.zip, but could not find it - let me know if you have any information.</sub> <br><br>  Zip bombs must overcome the fact that the DEFLATE compression algorithm most often supported by parsers <a href="https://www.zlib.net/zlib_tech.html">cannot exceed</a> a compression ratio of 1032 to 1. For this reason, zip bombs usually rely on recursive decompression, putting zip files into zip files to get an additional factor 1032 with each layer.  But the trick works only in implementations that unpack recursively, but most do not.  The most famous <a href="https://www.unforgettable.dk/">42.zip</a> bomb expands to a formidable 4.5 PB, if all six layers are recursively unpacked, but on the top layer, it has a trifling 0.6 MB.  Zip quains, like those of <a href="https://research.swtch.com/zip">Cox</a> and <a href="http://www.steike.com/code/useless/zip-file-quine/">Ellingsen</a> , give out a copy of themselves and, thus, expand infinitely with recursive unpacking.  But they are also completely safe when unpacking once. <br><br>  This article shows you how to create a non-recursive zip-bomb whose compression ratio exceeds the DEFLATE limit of 1032. It works by overlapping files inside a zip-container to refer to the ‚Äúcore‚Äù of highly compressed data in several files without making multiple copies.  The output size of the zip-bomb grows quadratically from the input size;  that is, the compression ratio improves as the size of the bomb increases.  The design depends on the features of zip and DEFLATE: it is not transferred directly to other file formats or compression algorithms.  The bomb is compatible with most zip parsers, except for ‚Äústreaming‚Äù, which analyze files in one pass, without checking the central directory of the zip file.  We try to balance two conflicting goals: <br><br><ul><li>  Increase the compression ratio.  We define the compression ratio as the sum of the sizes of all files in the archive divided by the size of the zip file itself.  It does not take into account file names or other file system metadata, but only the content. <br></li><li>  Save compatibility.  Zip is a complex format, and parsers are different, especially in border situations and with additional features.  Do not use techniques that work only with certain parsers.  We will note some ways to improve the efficiency of a zip-bomb with a certain loss of compatibility. </li></ul><br><h1>  Zip file structure </h1><br>  A zip file consists of a <i>central directory of</i> file links. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/896/5d8/074/8965d80745e0b95831b8e3f7c68c5386.svg"><br><br>  The central directory is at the end of the zip file.  This is a list of <i>headings for the central catalog</i> .  Each central directory header contains single-file metadata, such as the file name and CRC-32 checksum, as well as a reverse pointer to the local file header.  The central directory header has a length of 46 bytes plus the length of the file name. <br><br>  A file consists of a local file header followed by compressed file data.  The length of the local file header is 30 bytes plus the length of the file name.  It contains a redundant copy of the metadata from the header of the central catalog, as well as the sizes of the compressed and uncompressed data files behind it.  Zip is a container format, not a compression algorithm.  The data of each file is compressed using the algorithm specified in the metadata, usually <a href="https://tools.ietf.org/html/rfc1951">DEFLATE</a> . <br><br>  This description of the zip format omits many details that are not needed to understand the zip-bomb.  For full details, see <a href="https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT">section 4.3 APPNOTE.TXT</a> or the <a href="https://users.cs.jmu.edu/buchhofp/forensics/formats/pkzip.html">‚ÄúStructure of the PKZip File‚Äù by</a> Florian Buchholz, or see the <a href="https://www.bamsoftware.com/hacks/zipbomb/">source code</a> . <br><br>  Considerable redundancy and a lot of ambiguities in the zip format open up possibilities for the mischief of various kinds.  Zip-bomb - this is only the tip of the iceberg.  Links for further reading: <br><br><ul><li>  <a href="https://gynvael.coldwind.pl/%3Fid%3D682">‚ÄúTen Thousand Security Traps: ZIP Format‚Äù</a> , a lecture by Ginvael Coldwind <br></li><li>  <a href="https://www.bamsoftware.com/sec/mozilla/">The ambiguous zip parsing allows you to hide Firefox add-on files from the linter and people</a> : my vulnerability is on addons.mozilla.org </li></ul><br><h1>  First discovery: overlapping files </h1><br>  By compressing a long string of duplicate bytes, we can create <i>a</i> highly compressed data <i>core</i> .  By itself, the kernel compression ratio cannot exceed the DEFLATE limit of 1032, so we need a way to reuse the kernel in many files, without creating a separate copy of it in each file.  We can do this by overlapping files: make sure that many of the headers of the central directory point to a single file whose data is the core. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f80/675/a85/f80675a8530b8adfc1d5847eaaf813ca.svg"><br><br>  Consider an example of how this design affects the degree of compression.  Suppose a 1000 byte kernel is unpacked into 1 MB.  Then the first megabyte of output is ‚Äúworth‚Äù 1078 bytes of input data: <br><br><ul><li>  31 bytes for the local file header (including the 1-byte file name) <br></li><li>  47 bytes for the central directory header (including the 1-byte file name) <br></li><li>  1000 bytes per core </li></ul><br>  But every 1 MB of output after the first one is only 47 bytes - we don‚Äôt need another local file header or another copy of the kernel, just an additional header of the central directory.  Thus, while the first link from the core has a compression ratio of 1,000,000 / 1078 ‚âà 928, each additional link moves the factor closer to 1,000,000 / 47 ‚âà 21,277, and the large core raises the ceiling. <br><br>  The problem with this idea is the lack of compatibility.  Since many central directory headers point to a single local file header, the metadata (in particular, the file name) cannot be the same for each file.  Some parsers <a href="https://www.bamsoftware.com/hacks/zipbomb/">swear at this</a> .  For example, <a href="http://infozip.sourceforge.net/UnZip.html">Info-ZIP UnZip</a> (standard <code>unzip</code> program in Unix) extracts files, but with warnings: <br><br><pre>  $ unzip overlap.zip
   inflating: A
 B: mismatching "local" filename (A),
          continuing with "central" filename version
   inflating: B
 ... </pre><br>  Python <a href="https://docs.python.org/3/library/zipfile.html">zipfile</a> also <a href="https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py">throws an exception</a> : <br><br><pre>  $ python3 -m zipfile -e overlap.zip.
 Traceback (most recent call last):
 ...
 __main __. BadZipFile: File name in directory 'B' and header b'A 'differ. </pre><br>  Next, we look at how to change the design for consistency of file names, while retaining most of the advantages of overlapping files. <br><br><h1>  Second discovery: quoting local file headers </h1><br>  We need to separate the headers of the local files for each file, while reusing one core.  Simply merging all the headers does not work, because the zip parser will find that local file header where it waits for the beginning of the DEFLATE stream.  But the idea will work, with a few changes.  We will use the DEFLATE function of uncompressed blocks to ‚Äúquote‚Äù local file headers so that they appear to be part of the same DEFLATE stream that ends in the kernel.  Each local file header (except the first one) will be interpreted in two ways: as a code (part of the zip file structure) and as data (part of the file's contents). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1c1/668/e92/1c1668e92501880340aaf1651df25095.svg"><br><br>  The DEFLATE stream is a sequence of <a href="https://tools.ietf.org/html/rfc1951">blocks</a> , where each block can be compressed or uncompressed.  We usually think only of compressed blocks, for example, the core is one large compressed block.  But there are uncompressed ones that start with a <a href="https://tools.ietf.org/html/rfc1951">5-byte header</a> with a length field, which means simply: ‚Äúoutput the next <i>n</i> bytes verbatim‚Äù.  Unpacking an uncompressed block only means deleting a 5-byte header.  Compressed and uncompressed blocks can be freely mixed in the DEFLATE stream.  The output is a concatenation of the results of unpacking all the blocks in order.  The term ‚Äúuncompressed‚Äù has meaning only at the DEFLATE level;  File data is still considered ‚Äúcompressed‚Äù at the zip level, regardless of which blocks are used. <br><br>  The easiest way to present this construction as an internal overlap, from the last file to the first.  We start by inserting the kernel, which will form the end of the data file for each file.  Add the header of the local LFH <sub><i>N</i></sub> file and the header of the central CDH <sub><i>N</i></sub> directory that points to it.  Set the ‚Äúcompressed size‚Äù metadata field in LFH <sub><i>N</i></sub> and CDH <sub><i>N</i></sub> to the compressed kernel size.  Now add a 5-byte header of an uncompressed block (green on the diagram), the length field of which is equal to the size of the LFH <sub><i>N.</i></sub>  Add the second header of the local LFH file <sub><i>N</i> ‚àí1</sub> and the header of the central directory CDH <sub><i>N</i> ‚àí1</sub> , which points to it.  Set the ‚Äúcompressed size‚Äù metadata field as the new header of the compressed kernel size <i>plus the</i> size of the uncompressed block header (5 bytes) <i>plus the</i> size of the LFH <sub><i>N.</i></sub> <br><br>  At the moment, the zip file contains two files with the names Y and Z. Let's go through what the parser sees when parsing.  Suppose that the compressed size of the kernel is 1000 bytes, and the size of the LFH <sub><i>N</i></sub> is 31 bytes.  We start with CDH <sub><i>N</i> ‚àí1</sub> and follow the pointer to LFH <sub><i>N</i> ‚àí1</sub> .  The name of the first file is Y, and the compressed size of its data file is 1036 bytes.  Interpreting the next 1036 bytes as a DEFLATE stream, we first encounter a 5-byte header of an uncompressed block that says to copy the next 31 bytes.  We write the next 31 bytes, which are LFH <sub><i>N</i></sub> , which we unpack and add to the Y file. Moving further in the DEFLATE stream, we find the compressed block (core), which we unpack to the Y file. Now we have reached the end of the compressed data and finished with the Y file. <br><br>  Moving on to the next file, we follow the pointer from CDH <sub><i>N</i></sub> to LFH <sub><i>N</i></sub> and find a file named Z, the compressed size of which is 1000 bytes.  Interpreting these 1000 bytes as a DEFLATE stream, we immediately encounter a compressed block (core again) and unpack it into file Z. Now we have reached the end of the final file and finished.  The output file Z contains the unpacked kernel;  the output file Y is the same, but additionally with a prefix of 31 bytes LFH <sub><i>N.</i></sub> <br><br>  We complete the construction by repeating the citation procedure until the zip archive includes the necessary number of files.  Each new file adds a central directory header, a local file header and an uncompressed block for quoting the next local file header itself.  Compressed file data is usually a chain of uncompressed DEFLATE blocks (quoted local file headers), followed by a compressed kernel.  Each byte in the core contributes about 1032 <i>N</i> to the output size, because each byte is part of all <i>N</i> files.  Output files are also of different sizes: the earlier ones are larger than the later ones, because they cite local file headers more.  The content of the output files does not make much sense, but no one said that it should make sense. <br><br>  This citation design with interleaving has better compatibility than the full overlap design from the previous section, but compatibility is achieved due to the degree of compression.  There, each file added only cost the central directory header, here it stands for the central directory header, the local file header, and another 5 bytes for the citation header. <br><br><h1>  Optimization </h1><br>  Having obtained the basic design of the zip-bomb, we will try to make it as efficient as possible.  We want to answer two questions: <br><br><ul><li>  What is the maximum compression ratio for a given zip file size? <br></li><li>  What is the maximum compression ratio, given the limitations of the zip format? </li></ul><br><h3>  Kernel compression </h3><br>  It is beneficial for us to compress the kernel as much as possible, because each unpacked byte is multiplied by <i>N.</i>  For this purpose, we use a custom DEFLATE compressor called bulk_deflate, specialized in compressing a string of duplicate bytes. <br><br>  All decent DEFLATE archivers are approaching a compression ratio of 1032 on an endless stream of duplicate bytes, but we are concerned about a specific size.  In our archive size, bulk_deflate holds more data than general-purpose archivers: about 26 KB more than zlib and Info-ZIP, and about 15 KB more than <a href="https://github.com/google/zopfli">Zopfli</a> , which sacrifices speed for the sake of compression quality. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8b4/cac/e5b/8b4cace5b49ef6945fd1d1ddc8fd7310.svg"><br><br>  The price of the high compression ratio bulk_deflate is the lack of versatility.  It can compress only strings of duplicate bytes and only a certain length, namely 517 + 258 <i>k</i> for an integer <i>k</i> ‚â• 0. In addition to good compression, bulk_deflate works quickly, performing work at almost the same time regardless of the size of the input data, not counting the job of actually writing a compressed string. <br><br><a name="1"></a><h3>  File names </h3><br>  For our purposes, file names are almost dead weight.  Although they contribute to the output size, being part of the quoted local file headers, but the byte in the file name contributes much less than the byte in the kernel.  We want the file names to be as short as possible, while being different, not forgetting compatibility. <br><br>  Each byte spent on a file name means two bytes not spent on the kernel (two, because each file name appears twice: in the header of the central directory and in the header of the local file).  The file name byte results in an average of only ( <i>N</i> + 1) / 4 bytes of output, while the byte in the kernel is counted as 1032 <i>N.</i>  Examples: <a href="https://bugs.python.org/issue10614">1</a> , <a href="https://bugs.python.org/issue10972">2</a> , <a href="https://github.com/thejoshwolfe/yauzl/issues/84">3</a> . <br><br>  The first compatibility consideration is encoding.  The zip format specification states that file names should be interpreted as <a href="https://en.wikipedia.org/wiki/Code_page_437">CP 437</a> or <a href="https://en.wikipedia.org/wiki/UTF-8">UTF-8</a> if a certain flag bit is set ( <a href="https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT">APPNOTE.TXT, Appendix D</a> ).  This is the main point of incompatibility between zip parsers, which can interpret file names in some fixed or locale-specific encoding.  Therefore, for compatibility, it is better to limit to characters with the same encoding in both CP 437 and UTF-8.  Namely, these are 95 printable US-ASCII characters. <br><br>  We are also bound by file system naming restrictions.  Some file systems are case-insensitive, so 'a' and 'A' are not considered different names.  Common file systems, such as FAT32, <a href="https://en.wikipedia.org/wiki/Comparison_of_file_systems">prohibit certain characters</a> , such as '*' and '?'. <br><br>  As a safe, but not necessarily optimal compromise, our zip-bomb will use 36-character alphabet file names, which do not include special characters and symbols from different registers: <br><br><pre>  0 1 2 3 4 5 6 7 8 9 ABCDEFGHIJKLMNOPQRSTU VWXYZ </pre><br>  File names are generated in an obvious way, all positions in turn, with the addition of a position at the end of the cycle: <br><br><pre>  "0", "1", "2", ..., "Z",
 "00", "01", "02", ..., "0Z",
 ...,
 "Z0", "Z1", "Z2", ..., "ZZ",
 "000", "001", "002", ... </pre><br>  There are 36 single-character file names, 36¬≤ two-character names, and so on.  Four bytes is enough for 1,727,604 different file names. <br><br>  Given that the file names in the archive will usually have different lengths, how should they be better arranged: from the shortest to the longest, or vice versa?  If you think a little, it is better to put the longest names last.  This ordering adds more than 900 MB of output to <a href="https://www.bamsoftware.com/hacks/zipbomb/">zblg.zip</a> , compared with the ordering from the longest to the shortest.  However, this is a minor optimization, because 900 MB is only 0.0003% of the total issue size. <br><br><h3>  Core size </h3><br>  The overlap citation design allows you to place a compressed data core, and then cheaply copy it many times.  For a specific size of the zip file <i>X</i> , how much space is optimally allocated for storing the kernel, and how much to create copies? <br><br>  To find the optimal balance, you need to optimize only one variable <i>N</i> , the number of files in the zip archive.  Each <i>N</i> value requires a certain amount of overhead for headings in the central catalog, local file headers, citation block headers and file names.  The rest of the space will be occupied by the core.  Since <i>N</i> must be an integer, and you can put only a certain number of files before the kernel size drops to zero, it is enough to check each possible value of <i>N</i> and choose what gives the greatest output. <br><br>  The application of the optimization procedure to <i>X</i> = 42,374 for 42.zip finds a maximum at <i>N</i> = 250. These 250 files require 21,195 bytes of service data, leaving 21,179 bytes for the kernel.  A kernel of this size is unpacked into 21,841,249 bytes (a ratio of 1031.3 to 1).  250 copies of the unpacked kernel plus slightly quoted local file headers give a total unpacked output of 5,461,307,620 bytes and a compression ratio of 129,000. <br><br><ul><li>  <a href="">zbsm.zip</a> 42 kB ‚Üí 5.5 GB </li></ul><pre>  zipbomb --mode = quoted_overlap --num-files = 250 --compressed-size = 21179&gt; zbsm.zip </pre><br>  The optimization resulted in an almost uniform distribution of space between the core and the file headers.  This is no coincidence.  Consider a simplified model of the construction of quotation with overlap.  In the simplified model, we ignore the file names, as well as a slight increase in the size of the output file due to quoting local file headers.  An analysis of the simplified model will show that the optimal distribution between the core and file headers is approximately even, and the output size with optimal distribution grows quadratically depending on the size of the input. <br><br>  Defining some constants and variables: <br><br><div class="scrollable-table"><table><tbody><tr><td>  X </td><td></td><td>  zip file size (considered fixed) </td></tr><tr><td>  N </td><td></td><td>  number of files in the zip archive (variable for optimization) </td></tr><tr><td>  CDH </td><td>  = 46 </td><td>  size of the central directory header (without file name) </td></tr><tr><td>  Lfh </td><td>  = 30 </td><td>  local file header size (without file name) </td></tr><tr><td>  Q </td><td>  = 5 </td><td>  uncompressed header size of a DEFLATE block </td></tr><tr><td>  C </td><td>  ‚âà 1032 </td><td>  kernel compression ratio </td></tr></tbody></table></div><br>  Let <i>H (N)</i> be the amount of overhead for headers for <i>N</i> files.  See <a href="https://www.bamsoftware.com/hacks/zipbomb/">diagram</a> to understand the essence of the formula. <br><br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mi>H</mi><mo stretchy=&quot;false&quot;>(</mo><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mi>N</mi><mo>&amp;#x22C5;</mo><mo stretchy=&quot;false&quot;>(</mo><mi>C</mi><mi>D</mi><mi>H</mi><mo>+</mo><mi>L</mi><mi>F</mi><mi>H</mi><mo stretchy=&quot;false&quot;>)</mo><mo>+</mo><mo stretchy=&quot;false&quot;>(</mo><mi>N</mi><mo>&amp;#x2212;</mo><mn>1</mn><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x22C5;</mo><mi>Q</mi></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="42.802ex" height="2.66ex" viewBox="0 -832 18428.8 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-48" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-28" x="888" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4E" x="1278" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-29" x="2166" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-3D" x="2833" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4E" x="3890" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-22C5" x="5000" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-28" x="5501" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-43" x="5891" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-44" x="6651" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-48" x="7480" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-2B" x="8590" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4C" x="9591" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-46" x="10272" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-48" x="11022" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-29" x="11910" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-2B" x="12522" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-28" x="13523" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4E" x="13912" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-2212" x="15023" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-31" x="16024" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-29" x="16524" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-22C5" x="17136" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-51" x="17637" y="0"></use></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mi>H</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo><mo>=</mo><mi>N</mi><mo>‚ãÖ</mo><mo stretchy="false">(</mo><mi>C</mi><mi>D</mi><mi>H</mi><mo>+</mo><mi>L</mi><mi>F</mi><mi>H</mi><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mi>N</mi><mo>‚àí</mo><mn>1</mn><mo stretchy="false">)</mo><mo>‚ãÖ</mo><mi>Q</mi></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> H (N) = N ‚ãÖ (CDH + LFH) + (N - 1) ‚ãÖ Q </script></p><br>  For the core, there is an <i>X - H (N)</i> space.  The total unpacked size <i>S <sub>X</sub> (N)</i> is equal to the size of <i>N</i> copies of the kernel, unpacked with the <i>C</i> ratio (in this simplified model we ignore a slight additional extension from the mentioned local file headers). <br><br><p><math> </math> $$ display $$ S_X (N) = (X - H (N)) CN \\ = (X - (N ‚ãÖ (CDH + LFH) + (N - 1) Q)) CN \\ = - (CDH + LFH + Q) CN ^ 2 + (X + Q) CN $$ display $$ </p><br>  S <sub>X</sub> (N) is a polynomial in part N, therefore the maximum should be where the derivative of S ‚Ä≤ <sub>X</sub> (N) is zero.  Taking the derivative and finding zero gives us N <sub>OPT</sub> , the optimal number of files. <br><br><p><math> </math> $$ display $$ S‚Ä≤X (N_ {OPT}) = ‚àí2 (CDH + LFH + Q) C N_ {OPT} + (X + Q) C \\ 0 = ‚àí2 (CDH + LFH + Q) C N_ {OPT} + (X + Q) C \\ N_ {OPT} = (X + Q) / (CDH + LFH + Q) / 2 $$ display $$ </p><br>  <i>H (N <sub>OPT</sub> )</i> gives the optimal amount of space to accommodate file headers.  It is independent of CDH, LFH and C and is close to <i>X / 2</i> . <br><br><p><math> </math> $$ display $$ H (N_ {OPT}) = N_ {OPT} (CDH + LFH) + (N_ {OPT} - 1) ‚ãÖ Q \\ = (X - Q) / 2 $$ display $$ </p><br>  S <sub>X</sub> (N <sub>OPT</sub> ) - total unpacked size with optimal distribution.  From this we see that the size of the output grows quadratically with increasing input data. <br><br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>S</mi><mi>X</mi></msub><mo stretchy=&quot;false&quot;>(</mo><msub><mi>N</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>O</mi><mi>P</mi><mi>T</mi></mrow></msub><mo stretchy=&quot;false&quot;>)</mo><mo>=</mo><mo stretchy=&quot;false&quot;>(</mo><mi>X</mi><mo>+</mo><mi>Q</mi><msup><mo stretchy=&quot;false&quot;>)</mo><mn>2</mn></msup><mi>C</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mo stretchy=&quot;false&quot;>(</mo><mi>C</mi><mi>D</mi><mi>H</mi><mo>+</mo><mi>L</mi><mi>F</mi><mi>H</mi><mo>+</mo><mi>Q</mi><mo stretchy=&quot;false&quot;>)</mo><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mn>4</mn></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="48.954ex" height="3.021ex" viewBox="0 -987.6 21077.5 1300.8" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-53" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-58" x="867" y="-213"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-28" x="1316" y="0"></use><g transform="translate(1705,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4E" x="0" y="0"></use><g transform="translate(803,-155)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4F" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-50" x="763" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-54" x="1514" y="0"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-29" x="4178" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-3D" x="4846" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-28" x="5902" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-58" x="6291" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-2B" x="7366" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-51" x="8367" y="0"></use><g transform="translate(9158,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-29" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-32" x="550" y="583"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-43" x="10002" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-2F" x="10762" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-28" x="11263" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-43" x="11652" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-44" x="12413" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-48" x="13241" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-2B" x="14352" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4C" x="15353" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-46" x="16034" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-48" x="16784" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-2B" x="17894" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-51" x="18895" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-29" x="19687" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-2F" x="20076" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-34" x="20577" y="0"></use></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>S</mi><mi>X</mi></msub><mo stretchy="false">(</mo><msub><mi>N</mi><mrow class="MJX-TeXAtom-ORD"><mi>O</mi><mi>P</mi><mi>T</mi></mrow></msub><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mi>X</mi><mo>+</mo><mi>Q</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mi>C</mi><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mo stretchy="false">(</mo><mi>C</mi><mi>D</mi><mi>H</mi><mo>+</mo><mi>L</mi><mi>F</mi><mi>H</mi><mo>+</mo><mi>Q</mi><mo stretchy="false">)</mo><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mn>4</mn></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-5"> S_X (N_ {OPT}) = (X + Q) ^ 2C / (CDH + LFH + Q) / 4 </script></p><br>  Increasing the size of the zip file, we will eventually encounter the limits of the zip format: there can be no more than 2 <sup>16</sup> ‚àí1 files in the archive no larger than 2 <sup>32</sup> ‚àí1 bytes each.  Worse, <a href="https://www.bamsoftware.com/hacks/zipbomb/">some implementations</a> take maximum values ‚Äã‚Äãas an indicator of the presence of <a href="https://www.bamsoftware.com/hacks/zipbomb/">64-bit extensions</a> , so our limits are in fact 2 <sup>16</sup> ‚àí2 and 2 <sup>32</sup> ‚àí2.  It happens that the first we are faced with a limit on the size of an uncompressed file.  With a zip file size of 8,319,377 bytes, a naive optimization will give us a number of files of 47,837 and a maximum file of 2,332,111 bytes. <br><br>  (Actually, everything is a bit more complicated, because the exact limits depend on the implementation. Python's zipfile <a href="https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py">ignores the</a> number of files, archive / zip in Go <a href="https://github.com/golang/go/commit/38e512824336971bcb3d067ad46d01728501b959">allows you to</a> increase the number of files until they have the lower 16 bits. But for general compatibility, we must adhere to established limits). <br><br>  If we cannot infinitely increase <i>N</i> or the size of the core, we would like to find the maximum degree of compression within the zip format.  You need to make the kernel as large as possible with the maximum number of files.  Despite the fact that we can no longer maintain a roughly even separation between the kernel and the file headers, each added file <i>still</i> increases the compression ratio ‚Äî just not as fast as if we could continue to grow the kernel.  In fact, as we add files, we will need to <i>reduce the</i> size of the kernel in order to make room for a file of maximum size, which grows a little with each file added. <br><br>  The plan leads to a zip archive with 2 <sup>16</sup> ‚àí2 files and a kernel, which is unpacked into 2 <sup>32</sup> ‚àí2 178 825 bytes.  Files will be larger towards the beginning of the zip archive ‚Äî the first and largest file is unpacked into 2 <sup>32</sup> ‚àí56 bytes.  This is as close as we can get using coarse output parameters of bulk_deflate - encoding the final 54 bytes will cost more than their size (the zip file generally has a compression ratio of 28 million, and the final 54 bytes will receive a maximum of 54 10 <sup>32</sup> ( 2 <sup>16</sup> - 2) ‚âà 36? 5 million bytes, so it only helps if 54 bytes can be encoded into one byte - and I could not encode less than two. Therefore, if you cannot encode 54 bytes into 1 byte, it only reduces the degree of compression).  The size of this output zip-bomb: 281 395 456 244 934 bytes, 99.97% of the theoretical maximum (2 <sup>32</sup> - 1) √ó (2 <sup>16</sup> - 1).  Any significant improvement in the compression ratio can only be achieved by reducing the size of the input signal, and not increasing the output signal. <br><br><ul><li>  <a href="">zblg.zip</a> 10 MB ‚Üí 281 TB </li></ul><pre>  zipbomb --mode = quoted_overlap --num-files = 65534 --max-uncompressed-size = 4292788525&gt; zblg.zip </pre><br><h1>  Efficient CRC-32 Calculation </h1><br>  Among the metadata in the header of the central directory and the header of the local file is a checksum of uncompressed file data - <a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check">CRC-32</a> .  This creates a problem because the amount of CRC-32 computing for each file is proportional to its size, which is by default very large (after all, it's a zip-bomb).  We would prefer to do work that is at least proportional to the size of the archive.  Two factors work in our favor: all files have a common core, and an uncompressed kernel is a string of duplicate bytes.  Imagine CRC-32 as a matrix product - this will allow not only to quickly calculate the kernel checksum, but also to reuse calculations between files.  The method described in this section is a small extension of the <a href="">crc32_combine</a> function in zlib, which Mark Adler explains <a href="https://stackoverflow.com/questions/23122312/crc-calculation-of-a-mostly-static-data-stream/23126768">here</a> . <br><br>  CRC-32 can be modeled as a state machine, updating a 32-bit status register for each input bit.  The basic update operations for bits 0 and 1 are: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">uint32 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">crc32_update_0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint32 state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Shift out the least significant bit. bit b = state &amp; 1; state = state &gt;&gt; 1; // If the shifted-out bit was 1, XOR with the CRC-32 constant. if (b == 1) state = state ^ 0xedb88320; return state; } uint32 crc32_update_1(uint32 state) { // Do as for a 0 bit, then XOR with the CRC-32 constant. return crc32_update_0(state) ^ 0xedb88320; }</span></span></code> </pre> <br>  If you represent the state register as a 32-element binary vector and use XOR for addition and multiplication, then <code>crc32_update_0</code> is a <a href="https://en.wikipedia.org/wiki/Linear_map">linear map</a> ;  that is, it can be represented as multiplication by <a href="https://en.wikipedia.org/wiki/Transformation_matrix">a</a> 32 √ó 32 binary <a href="https://en.wikipedia.org/wiki/Transformation_matrix">transition matrix</a> .  To understand why, note that multiplying a matrix by a vector is simply the sum of the columns of the matrix after multiplying each column by the corresponding element of the vector.  The shift operation <code>state &gt;&gt; 1</code> simply takes each bit <i>i</i> of the state vector and multiplies it by a vector that is zero everywhere except for bit <i>i</i> - 1 (the numbering of the bits is from right to left).  Relatively speaking, the final XOR <code>state ^ 0xedb88320</code> occurs only when the bit <code>b</code> is equal to one.  This can be represented as the first multiplication of b by 0xedb88320, and then XORing into a given state. <br><br>  In addition, <code>crc32_update_1</code> is just a <code>crc32_update_0</code> plus (XOR) constant.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This makes </font></font><code>crc32_update_1</code> <a href="https://en.wikipedia.org/wiki/Affine_transformation"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an affine transformation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : multiplication of a matrix followed by a mapping (i.e., vector addition). We can imagine matrix multiplication and mapping in one step, if we increase the size of the transformation matrix to 33 √ó 33 and add an additional element to the state vector, which is always equal to 1 (this representation is called </font></font><a href="https://en.wikipedia.org/wiki/Homogeneous_coordinates"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">homogeneous coordinates</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br><br><img src="https://habrastorage.org/webt/sg/ay/or/sgayorbdqetnkmc1y-qm42uywic.png"><br> <i><font color="gray"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The transformation matrices are 33 √ó 33 M </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and M </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which compute the change in state of the CRC-32 performed by bits 0 and 1, respectively. Column vectors are stored with the most significant bit at the bottom of: reading the first column from the bottom up, you see a constant polynomial CRC-32 edb8832016 = </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">111</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">111</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 000 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 00000 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 00 </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 00000 </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . These two matrices differ only in the final column, which represents the translation vector in homogeneous coordinates. In M </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0, the</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> translation is zero, and in M </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the edb88320 </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the polynomial constant CRC-32. Units are immediately above the diagonal status of the operation</font></font><code>state &gt;&gt; 1</code></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Both operations</font></font><code>crc32_update_0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and</font></font><code>crc32_update_1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can be represented by the transition matrix of 33 √ó 33. Matrices M</font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and M</font><sub><font style="vertical-align: inherit;"> 1</font></sub><font style="vertical-align: inherit;"> shown</font></font><sub><font style="vertical-align: inherit;"></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The advantage of the matrix representation is that matrices can be multiplied. </font><font style="vertical-align: inherit;">Suppose we want to see a state change made by processing an ASCII character 'a', whose binary representation is 01100001 </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We can represent the cumulative state change of the CRC-32 of these eight bits in one transformation matrix:</font></font><br><br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-6-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msub><mi>M</mi><mi>a</mi></msub><mo>=</mo><msub><mi>M</mi><mn>0</mn></msub><msub><mi>M</mi><mn>1</mn></msub><msub><mi>M</mi><mn>1</mn></msub><msub><mi>M</mi><mn>0</mn></msub><msub><mi>M</mi><mn>0</mn></msub><msub><mi>M</mi><mn>0</mn></msub><msub><mi>M</mi><mn>0</mn></msub><msub><mi>M</mi><mn>1</mn></msub></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="32.921ex" height="2.419ex" viewBox="0 -780.1 14174.2 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-3D" x="1722" y="0"></use><g transform="translate(2778,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-30" x="1372" y="-213"></use></g><g transform="translate(4203,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-31" x="1372" y="-213"></use></g><g transform="translate(5627,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-31" x="1372" y="-213"></use></g><g transform="translate(7052,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-30" x="1372" y="-213"></use></g><g transform="translate(8476,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-30" x="1372" y="-213"></use></g><g transform="translate(9901,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-30" x="1372" y="-213"></use></g><g transform="translate(11325,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-30" x="1372" y="-213"></use></g><g transform="translate(12749,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-31" x="1372" y="-213"></use></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msub><mi>M</mi><mi>a</mi></msub><mo>=</mo><msub><mi>M</mi><mn>0</mn></msub><msub><mi>M</mi><mn>1</mn></msub><msub><mi>M</mi><mn>1</mn></msub><msub><mi>M</mi><mn>0</mn></msub><msub><mi>M</mi><mn>0</mn></msub><msub><mi>M</mi><mn>0</mn></msub><msub><mi>M</mi><mn>0</mn></msub><msub><mi>M</mi><mn>1</mn></msub></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-6">M_a = M_0 M_1 M_1 M_0 M_0 M_0 M_0 M_1</script></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And we can imagine changing the state of the row of repeating 'a' by multiplying many copies of M </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - raising the matrix to a power. </font><font style="vertical-align: inherit;">We can quickly do this using </font></font><a href="https://en.wikipedia.org/wiki/Exponentiation_by_squaring"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the fast exponentiation algorithm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which allows us to calculate M </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n in</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> just a log </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 </font></font></sub> <sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> steps. </font><font style="vertical-align: inherit;">For example, here is a matrix for changing the state of a string of 9 characters 'a':</font></font><br><br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display"><span class="MathJax_SVG" id="MathJax-Element-7-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mo stretchy=&quot;false&quot;>(</mo><msub><mi>M</mi><mi>a</mi></msub><msup><mo stretchy=&quot;false&quot;>)</mo><mn>9</mn></msup><mo>=</mo><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><mspace linebreak=&quot;newline&quot; /><mo>=</mo><mo stretchy=&quot;false&quot;>(</mo><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msup><mo stretchy=&quot;false&quot;>)</mo><mn>2</mn></msup><msub><mi>M</mi><mi>a</mi></msub><mspace linebreak=&quot;newline&quot; /><mo>=</mo><mo stretchy=&quot;false&quot;>(</mo><mo stretchy=&quot;false&quot;>(</mo><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msup><mo stretchy=&quot;false&quot;>)</mo><mn>2</mn></msup><msup><mo stretchy=&quot;false&quot;>)</mo><mn>2</mn></msup><msub><mi>M</mi><mi>a</mi></msub><mspace linebreak=&quot;newline&quot; /><mo>=</mo><mo stretchy=&quot;false&quot;>(</mo><mo stretchy=&quot;false&quot;>(</mo><mo stretchy=&quot;false&quot;>(</mo><msub><mi>M</mi><mi>a</mi></msub><msup><mo stretchy=&quot;false&quot;>)</mo><mn>2</mn></msup><msup><mo stretchy=&quot;false&quot;>)</mo><mn>2</mn></msup><msup><mo stretchy=&quot;false&quot;>)</mo><mn>2</mn></msup><msub><mi>M</mi><mi>a</mi></msub></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="93.735ex" height="13.985ex" viewBox="0 -987.6 40358 6021.4" role="img" focusable="false" style="vertical-align: -11.691ex; max-width: 778px;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g transform="translate(11670,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-28" x="0" y="0"></use><g transform="translate(389,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g><g transform="translate(1834,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-29" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-39" x="550" y="583"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-3D" x="2955" y="0"></use><g transform="translate(4011,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g><g transform="translate(5456,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g><g transform="translate(6901,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g><g transform="translate(8346,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g><g transform="translate(9791,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g><g transform="translate(11236,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g><g transform="translate(12681,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g><g transform="translate(14126,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g><g transform="translate(15571,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g></g><g transform="translate(15422,-1567)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-3D" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-28" x="1056" y="0"></use><g transform="translate(1445,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g><g transform="translate(2890,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g><g transform="translate(4335,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g><g transform="translate(5780,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g><g transform="translate(7225,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-29" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-32" x="550" y="583"></use></g><g transform="translate(8068,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g></g><g transform="translate(16250,-3133)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-3D" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-28" x="1056" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-28" x="1445" y="0"></use><g transform="translate(1835,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g><g transform="translate(3280,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g><g transform="translate(4725,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-29" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-32" x="550" y="583"></use></g><g transform="translate(5568,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-29" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-32" x="550" y="583"></use></g><g transform="translate(6411,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g></g><g transform="translate(16356,-4699)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-3D" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-28" x="1056" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-28" x="1445" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-28" x="1835" y="0"></use><g transform="translate(2224,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g><g transform="translate(3669,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-29" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-32" x="550" y="583"></use></g><g transform="translate(4513,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-29" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-32" x="550" y="583"></use></g><g transform="translate(5356,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-29" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-32" x="550" y="583"></use></g><g transform="translate(6199,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-61" x="1372" y="-213"></use></g></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mo stretchy="false">(</mo><msub><mi>M</mi><mi>a</mi></msub><msup><mo stretchy="false">)</mo><mn>9</mn></msup><mo>=</mo><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><mspace linebreak="newline"></mspace><mo>=</mo><mo stretchy="false">(</mo><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><msub><mi>M</mi><mi>a</mi></msub><mspace linebreak="newline"></mspace><mo>=</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><msub><mi>M</mi><mi>a</mi></msub><msub><mi>M</mi><mi>a</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup><msub><mi>M</mi><mi>a</mi></msub><mspace linebreak="newline"></mspace><mo>=</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><msub><mi>M</mi><mi>a</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup><msub><mi>M</mi><mi>a</mi></msub></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-7">(M_a)^9 = M_a M_a M_a M_a M_a M_a M_a M_a M_a\\ = (M_a M_a M_a M_a)^2 M_a\\ = ((M_a M_a)^2)^2 M_a\\ = (((M_a)^2)^2)^2 M_a</script></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The fast matrix multiplication algorithm is useful for calculating the M </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kernel</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the matrix for an uncompressed kernel, since the kernel is a string of duplicate bytes. To get the CRC-32 checksum from the matrix, multiply the matrix by the zero vector (the zero vector is in homogeneous coordinates, that is, 32 zeros and then one; here we omit the minor complication of pre- and post-processing the checksum to check for consistency). To calculate the checksum for each file, we work in the opposite direction. We start with the initialization </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M: = M </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kernel</font></font></sub></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The kernel checksum is also the checksum of the final file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , so multiply </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a zero vector and stores the received checksum in the CDH </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and LFH </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The data of file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N ‚àí 1 is the</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> same as the file data of file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but with the prefix LFH </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> added </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Therefore, we calculate</font></font><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , state change matrix for LFH</font><sub><font style="vertical-align: inherit;">N</font></sub><font style="vertical-align: inherit;">and update</font></font><span class="MathJax_SVG" id="MathJax-Element-8-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>M</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>F</mi><msub><mi>H</mi><mi>N</mi></msub></mrow></mrow></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.398ex" height="2.539ex" viewBox="0 -780.1 3185.3 1093.4" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><g transform="translate(970,-150)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4C" x="0" y="0"></use><g transform="translate(481,0)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-46" x="0" y="0"></use><g transform="translate(529,0)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-48" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4E" x="1175" y="-213"></use></g></g></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>M</mi><mrow class="MJX-TeXAtom-ORD"><mi>L</mi><mrow class="MJX-TeXAtom-ORD"><mi>F</mi><msub><mi>H</mi><mi>N</mi></msub></mrow></mrow></msub></math></span></span><script type="math/tex" id="MathJax-Element-8">M_{L{FH_N}}</script><font style="vertical-align: inherit;"></font><sub><font style="vertical-align: inherit;"></font></sub><font style="vertical-align: inherit;"></font><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-9-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>M</mi><mo>:=</mo><mi>M</mi><msub><mi>M</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>L</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>F</mi><msub><mi>H</mi><mi>N</mi></msub></mrow></mrow></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="16.028ex" height="2.539ex" viewBox="0 -780.1 6900.8 1093.4" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><g transform="translate(1329,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-3A"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMAIN-3D" x="278" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="2664" y="0"></use><g transform="translate(3715,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4D" x="0" y="0"></use><g transform="translate(970,-150)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4C" x="0" y="0"></use><g transform="translate(481,0)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-46" x="0" y="0"></use><g transform="translate(529,0)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-48" x="0" y="0"></use><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/459254/&amp;xid=25657,15700021,15700186,15700190,15700256,15700259,15700262&amp;usg=ALkJrhgBgz4E7WIwnikFRy6WQpLYsV9_oA#MJMATHI-4E" x="1175" y="-213"></use></g></g></g></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>M</mi><mo>:=</mo><mi>M</mi><msub><mi>M</mi><mrow class="MJX-TeXAtom-ORD"><mi>L</mi><mrow class="MJX-TeXAtom-ORD"><mi>F</mi><msub><mi>H</mi><mi>N</mi></msub></mrow></mrow></msub></math></span></span><script type="math/tex" id="MathJax-Element-9">M := M M_{L{FH_N}}</script>  .<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> represents a cumulative change of state from LFH </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> processing </font><font style="vertical-align: inherit;">by core. </font><font style="vertical-align: inherit;">We calculate the checksum for the file </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N ‚àí 1 by</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> multiplying </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by the zero vector </font><font style="vertical-align: inherit;">again </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We continue the procedure, accumulating state change matrices in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , until all files are processed.</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Extension: Zip64 </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Previously, we ran into an extension problem due to the limitations of the zip format - it was impossible to issue more than 281 TB, no matter how cleverly the zip file was packed. </font><font style="vertical-align: inherit;">You can exceed these limits using </font></font><a href="https://en.wikipedia.org/wiki/Zip_(file_format)"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zip64</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, a zip file extension that increases the size of some header fields to 64 bits. Zip64 support is by no means universal, but it is one of the most commonly implemented extensions. As for the compression ratio, the effect of Zip64 is to increase the size of the central directory header from 46 to 58 bytes, and the size of the local directory header from 30 to 50 bytes. Looking at the formula for the optimal expansion coefficient in the simplified model, we see that the zip-bomb in the Zip64 format still grows quadratically, but slower because of the larger denominator - this is seen in the diagram below. Due to the loss of compatibility and slower growth, almost any restrictions on file size are removed.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suppose we need a zip-bomb that expands to 4.5 PB, like 42.zip. </font><font style="vertical-align: inherit;">How big should the archive be? </font><font style="vertical-align: inherit;">Using a binary search, we find that the minimum size of such a file is 46 MB.</font></font><br><br><ul><li> <a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zbxl.zip</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 46 MB ‚Üí 4,5 PB (Zip64, less compatible)</font></font></li></ul><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zipbomb --mode = quoted_overlap --num-files = 190023 --compressed-size = 22982788 --zip64&gt; zbxl.zip </font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.5 petabyte - approximately as much data was recorded by the Telescope of the event horizon for the </font></font><a href="https://motherboard.vice.com/en_us/article/597m7q/reddits-data-hoarders-are-freaking-out-over-all-that-black-hole-data"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">first image of a black hole</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : racks and racks with hard drives in the data center. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With Zip64, it‚Äôs almost uninteresting to consider the maximum compression ratio, because we can simply continue to increase the size of the zip file and the compression ratio with it, until even a compressed zip file becomes prohibitively large. An interesting threshold, however, is 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">64</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bytes (18 EB or 16 EiB) - so much data will not fit in most file systems. Binary search finds the smallest zip bomb that produces at least as much output: it contains 12 million files and a compressed 1.5 GB kernel. The total size of the zip file is 2.9 GB, and it is unpacked in 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">64</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+11,727,895,877 bytes with a compression ratio of over 6.2 billion to one. </font><font style="vertical-align: inherit;">I did not upload this file for download, but you can generate it yourself using the </font></font><a href="https://www.bamsoftware.com/hacks/zipbomb/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It has files of such size that even a </font></font><a href="https://bugs.debian.org/cgi-bin/bugreport.cgi%3Fbug%3D929502"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bug</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in Info-ZIP UnZip 6.0 was revealed.</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zipbomb --mode = quoted_overlap --num-files = 12056313 --compressed-size = 1482284040 --zip64&gt; zbxxl.zip </font></font></pre><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Extension: bzip2 </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DEFLATE is the most common compression algorithm for the zip format, but this is only one of many options. Probably the second most common algorithm is </font></font><a href="https://en.wikipedia.org/wiki/Bzip2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bzip2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Although it is not as compatible as DEFLATE. Theoretically, in bzip2, the maximum compression ratio is about 1.4 million to one, which allows for a closer packing of the core. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bzip2 first of all encodes a ‚Äúrun step‚Äù (run-length encoding), reducing the length of a string of duplicate bytes by 51 times. Then the data is divided into blocks of 900 KB and each block is compressed separately. Theoretically, one block can shrink to 32 bytes. 900,000 √ó 51/32 = 1 434 375. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ignoring the loss of compatibility, does bzip2 allow a more efficient bomb to be made?</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yes - but only for small files. The problem is that in bzip2 there is nothing like the uncompressed DEFLATE blocks that we used to cite local file headers. Thus, it is impossible to overlap files and reuse the kernel - for each file you need to write your own copy, so the overall compression ratio will be no better than the coefficient for any single file. On the graph below, we see that without overlapping bzip2 exceeds DEFLATE only for files of about a megabyte. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is only hope for an alternative means of citing headlines in bzip2, which is discussed in the next section. Also, if you know that a particular zip parser supports bzip2 </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">admits a file name mismatch, you can use a full overlap construction that does not need quoting. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/350/bb1/aa1/350bb1aa131f71762b2ad03d4203ac66.svg"><br> <i><font color="gray"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comparison of compression ratio for different zip-bombs. Pay attention to the logarithmic axis. Each design is shown with and without Zip64. In structures without overlap, the linear growth rate is evident from the constant ratio of the axes. The vertical displacement of the bzip2 graphic means that the compression ratio of bzip2 is about a thousand times greater than that of DEFLATE. The DEFLATE citation constructs have a quadratic growth rate, as evidenced by a slope to the 2: 1 axes. The Zip64 option is slightly less efficient, but allows you to issue more than 281 TB. Graphs for bzip2 with quotations through an additional field are transferred from quadratic to linear when either the maximum file size is reached (2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">32</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚àí2 bytes), or the maximum allowed number of files</font></font></font></i> <br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Expansion: quoting through an additional field </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So far, we have used the DEFLATE function to quote local file headers, and we just saw that this trick does not work in bzip2. </font><font style="vertical-align: inherit;">However, there is an alternative way of quoting, somewhat more limited, which uses only functions of the zip format and is independent of the compression algorithm. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the end of the local file header structure there is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an additional</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable-length </font><i><font style="vertical-align: inherit;">field</font></i><font style="vertical-align: inherit;"> for storing information that does not fit into regular header fields ( </font></font><a href="https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">APPNOTE.TXT, section 4.3.7</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Additional information may include, for example, a time stamp or a uid / gid from Unix. </font><font style="vertical-align: inherit;">Zip64 information is also stored in an additional field. </font><font style="vertical-align: inherit;">The additional field is represented as a length-value structure; </font><font style="vertical-align: inherit;">if you increase the length without adding a value, then the additional field will include what is behind it in the zip file, namely the next header of the local file. </font><font style="vertical-align: inherit;">Using this method, each local file header can ‚Äúquote‚Äù the following headers, wrapping them in its own additional field. </font><font style="vertical-align: inherit;">Compared to DEFLATE there are three advantages:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Quoting through an extra field requires only 4 bytes, not 5, leaving more room for the kernel. </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It does not increase the size of the files, which means a larger kernel size, given the limitations of the zip format. </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It provides bzip2 citations. </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despite these advantages, quoting through additional fields is less flexible. This is not a chain, as in DEFLATE: each header of a local file must contain not only the next header itself, but </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">all</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> subsequent headers. Additional fields increase as you get closer to the beginning of the zip file. Since the maximum field length is 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚àí1 bytes, you can only quote up to 1808 local file headers (or 1170 in Zip64), assuming that the names are </font></font><a href="https://habr.com/ru/post/459254/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assigned as expected</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(in the case of DEFLATE, you can use the additional field to cite the first (shortest) headers of local files, and then switch to the citing DEFLATE for the rest). Another problem: in order to conform to the internal data structure of the additional field, you must select the 16-bit tag for the type ( </font></font><a href="https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">APPNOTE.TXT, section 4.5.2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) preceding the citation data. We want to select a type tag that will cause parsers to ignore data in quotes, rather than trying to interpret them as meaningful metadata. Zip parsers should ignore tags of an unknown type, so we can choose tags randomly, but there is a risk that in the future some tag will break the compatibility of the structure.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The previous diagram illustrates the possibility of using additional fields in bzip2, c and without Zip64. On both graphs there is a break point when growth goes from quadratic to linear. Without Zip64, this happens where the maximum uncompressed file size is reached (2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">32</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚àí2 bytes); then you can increase only the number of files, but not their size. The graph completely ends when the number of files reaches 1809, then we have a place in the additional field for citing additional headers. With Zip64, a fracture occurs on 1171 files, after which only the size of the files can be increased, but not their number. The additional field helps in the case of DEFLATE, but the difference is so small that it is not visually noticeable. It increases the compression ratio of zbsm.zip by 1.2%; zblg.zip by 0.019%; and zbxl.zip by 0.0025%.</font></font><br><br><h1>  Discussion </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In their work on this topic, </font></font><a href="http://sar.informatik.hu-berlin.de/research/publications/index.htm"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pletz and colleagues</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> use an overlap of files to create an almost self-replicating zip archive. The file overlap itself was </font></font><a href="https://gynvael.coldwind.pl/%3Fid%3D682"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suggested earlier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (slide 47) by Ginvael Coldwind. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have developed a zip-bomb design with overlapping citations with regard to compatibility - a number of differences in implementations, some of which are shown in the table below. The resulting construction is compatible with zip-parsers that work in the usual way, that is, first checking the central directory and using it as an index of files. Among them, a unique zip-parser from </font></font><a href="https://www.usenix.org/conference/osdi14/technical-sessions/presentation/bangert"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nail</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">which is automatically generated from formal grammar. However, the construction is incompatible with ‚Äústreaming‚Äù parsers that analyze the zip file from beginning to end in one run without first reading the central catalog. By their nature, streaming parsers do not allow file overlap in any way. Most likely, they will extract only the first file. In addition, they may even give an error, as in the case of </font></font><a href="https://github.com/madler/sunzip"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sunzip</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which analyzes the central directory at the end and checks it for consistency with the headers of the local files that it has already seen.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you want the extracted files to start with a specific prefix, different from the bytes of the local file header, you can insert a DEFLATE block in front of the uncompressed block that quotes the next header. Not every file in a zip archive should be involved in creating a bomb: you can include regular files in the archive, if necessary, to fit some special format (in the source code there is a parameter </font></font><code>--template</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for this use case). Many formats use zip as a container, for example, Java JAR documents, Android APK and LibreOffice. </font></font><br><br> <a href="https://en.wikipedia.org/wiki/PDF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PDF</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Much like a zip. It has a cross-reference table at the end of the file that points to previous objects, and it supports compressing objects through the FlateDecode filter. I haven't tried it, but you can use the idea of ‚Äã‚Äãoverlap citation to make a PDF bomb. Perhaps there is not even much work to do: binaryhax0r </font></font><a href="https://binaryhax0r.blogspot.com/2010/06/flatedecode-decoder.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">writes in a blog</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that you can simply specify several FlateDecode layers on one object, after which creating a PDF bomb becomes trivial. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Determining the specific class of the zip-bomb described in the article is easy: just find overlapping files. Mark Adler wrote a </font></font><a href="https://github.com/madler/unzip/commits/6519bf0f8a896851d9708da11e1b63c818238c8f"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">patch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for Info-ZIP Unzip, which does exactly that. </font><font style="vertical-align: inherit;">However, in general, blocking overlapping files does not protect against all classes of zip bombs. </font><font style="vertical-align: inherit;">It is difficult to predict in advance whether the file is a zip-bomb or not, if you do not have accurate knowledge of the internal components of the parsers that will be used to analyze it. </font></font><a href="https://stackoverflow.com/a/1459154"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peering into the headers and summation of the ‚Äúuncompressed size‚Äù fields of all files does not work</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , because the value in the headers may not coincide with the actual uncompressed size (in the compatibility table, see the line ‚Äúallows too small file size‚Äù). </font><font style="vertical-align: inherit;">Reliable protection against zip-bombs includes limits on time, memory and disk space in a zip-parser during its operation. </font><font style="vertical-align: inherit;">Take parsing of zip-files, as well as any complex operations with unreliable data, with caution.</font></font><br><br><div class="scrollable-table"><table><thead><tr><td></td><th> <a href="http://infozip.sourceforge.net/UnZip.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Info-ZIP </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UnZip 6.0</font></font></a> </th><th> <a href="https://docs.python.org/3/library/zipfile.html">Python 3.7 <br> zipfile</a> </th><th> <a href="https://golang.org/pkg/archive/zip/">Go 1.12 <br> archive/zip</a> </th><th> <a href="https://github.com/thejoshwolfe/yauzl">yauzl 2.10.0 <br> (Node.js)</a> </th><th> <a href="https://github.com/jbangert/nail/tree/4bd9cc29c4092abe7a77f8294aff2337bba02ec5/examples/zip">Nail <br> examples/zip</a> </th><th> <a href="https://android.googlesource.com/platform/system/core/%2B/refs/tags/android-9.0.0_r1/libziparchive">Android 9.0.0 r1 <br> libziparchive</a> </th><th> <a href="https://github.com/madler/sunzip">sunzip 0.4</a> <br> (streaming) </th></tr></thead><tbody><tr><th> DEFLATE </th><td>  ‚úì </td><td> <a href="https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py">‚úì</a> </td><td> <a href="">‚úì</a> </td><td> <a href="">‚úì</a> </td><td> <a href="">‚úì</a> </td><td> <a href="">‚úì</a> </td><td> <a href="">‚úì</a> </td></tr><tr><th> Zip64 </th><td> <a href="http://infozip.sourceforge.net/UnZip.html">‚úì</a> </td><td> <a href="https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py">‚úì</a> </td><td> <a href="">‚úì</a> </td><td> <a href="">‚úì</a> </td><td>  <a href="">-</a> </td><td>  <a href="">-</a> </td><td> <a href="">‚úì</a> </td></tr><tr><th> bzip2 </th><td> <a href="http://infozip.sourceforge.net/UnZip.html">‚úì</a> </td><td> <a href="https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py">‚úì</a> </td><td>  <a href="">-</a> </td><td>  <a href="">-</a> </td><td>  <a href="">-</a> </td><td>  <a href="">-</a> </td><td> <a href="">‚úì</a> </td></tr><tr><th>     </th><td>  </td><td>  <a href="https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py">-</a> </td><td> <a href="">‚úì</a> </td><td> <a href="">‚úì</a> </td><td> <a href="">‚úì</a> </td><td>  <a href="">-</a> </td><td> <a href="">‚úì</a> </td></tr><tr><th>   CRC-32 </th><td> <abbr title="    CRC"></abbr> </td><td>  <a href="https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py">-</a> </td><td> <a href=""> </a> </td><td> <a href="">‚úì</a> </td><td>  <a href="">-</a> </td><td> <a href="">‚úì</a> </td><td>  <a href="">-</a> </td></tr><tr><th>      </th><td>  ‚úì </td><td>  <a href="https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py">-</a> </td><td>  <a href="">-</a> </td><td>  <a href="">-</a> </td><td>  <a href="">-</a> </td><td>  <a href="">-</a> </td><td>  <a href="">-</a> </td></tr><tr><th>  2 <sup>32</sup> ‚àí1  </th><td>  ‚úì </td><td> <a href="https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py">‚úì</a> </td><td> <a href="">‚úì</a> </td><td>  <a href="https://github.com/thejoshwolfe/yauzl/issues/109">-</a> </td><td> <a href="">‚úì</a> </td><td> <a href="">‚úì</a> </td><td> <a href="">‚úì</a> </td></tr><tr><th>  2 <sup>16</sup> ‚àí1  </th><td>  ‚úì </td><td> <a href="https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py">‚úì</a> </td><td> <a href="">‚úì</a> </td><td>  <a href="https://github.com/thejoshwolfe/yauzl/issues/108">-</a> </td><td> <a href="">‚úì</a> </td><td> <a href="">‚úì</a> </td><td> <a href="">‚úì</a> </td></tr></tbody><tbody><tr><th>  <a href="https://habr.com/ru/post/459254/">overlap.zip</a> </th><td>  </td><td>  - </td><td>  ‚úì </td><td>  ‚úì </td><td>  ‚úì </td><td>  - </td><td>  - </td></tr><tr><th>  <a href="https://habr.com/ru/post/459254/">zbsm.zip  zblg.zip</a> </th><td>  ‚úì </td><td>  ‚úì </td><td>  ‚úì </td><td>  ‚úì </td><td>  ‚úì </td><td>  ‚úì </td><td>  - </td></tr><tr><th>  <a href="https://habr.com/ru/post/459254/">zbxl.zip</a> </th><td>  ‚úì </td><td>  ‚úì </td><td>  ‚úì </td><td>  ‚úì </td><td>  - </td><td>  - </td><td>  - </td></tr></tbody></table></div><br> <i><font color="gray">    zip-,    ,     zip-.      DEFLATE  Zip64,          ,    CRC     32-  16- .</font></i> <br><br><h1>  Acknowledgments </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thanks to </font></font><a href="https://madler.net/madler/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mark Adler</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://swtch.com/~rsc/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Russ Cox</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="http://brandonenright.net/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Brandon Enright</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://idea.popcount.org/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Marek Maykovsky</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://wolfesoftware.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Josh Wolfe,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and reviewers of the </font></font><a href="https://www.usenix.org/conference/woot19/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USENIX WOOT 2019</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for comments on the draft of this article. </font><font style="vertical-align: inherit;">Kaolan McNamara evaluated the impact of zip-bombs on the safety of LibreOffice. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A version of this article has been prepared for the </font></font><a href="https://www.usenix.org/conference/woot19/presentation/fifield"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USENIX WOOT 2019</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seminar </font><font style="vertical-align: inherit;">. </font></font><a href="https://habr.com/ru/post/459254/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is available. </font></font><a href="https://www.usenix.org/conference/woot19/call-for-artifacts"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Artifacts</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for presentation at the seminar are in the file </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zipbomb-woot19.zip</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Did you find a system that falls into one of the bombs? </font><font style="vertical-align: inherit;">Did the bombs help you find a bug or make money in a bug search program? </font><font style="vertical-align: inherit;">Let me know, I will try to mention it here.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LibreOffice 6.1.5.2 </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After renaming zblg.zip to zblg.odt or zblg.docx, the LibreOffice program creates and deletes a series of temporary files of about 4 GB each, trying to determine the file format. </font><font style="vertical-align: inherit;">Ultimately, he finishes doing this and deletes the temporary files as they arrive, so the zip-bomb only causes a temporary DoS, without filling the disk. </font><font style="vertical-align: inherit;">Kaolan McNamara responded to my error message.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mozilla addons-server 2019.06.06 </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I tried zip-bombs against the local addons-server installation, which is part of the addons.mozilla.org software. </font><font style="vertical-align: inherit;">The system processes the bomb gracefully, imposing a time limit of 110 seconds on extracting files. </font><font style="vertical-align: inherit;">The zip-bomb expands as fast as the disk allows up to this time limit, but then the process is killed and the unpacked files are eventually automatically cleared.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> UnZip 6.0 </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mark Adler wrote a patch for UnZip to discover this class of zip bombs. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">July 5, 2019: I noticed that vulnerability </font></font><a href="https://cve.mitre.org/cgi-bin/cvename.cgi%3Fname%3DCVE-2019-13232"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CVE-2019-13232 was assigned to UnZip</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Personally, I would argue that the ability / inability of UnZip (or any zip parser) to handle this kind of zip-bomb necessarily represents a vulnerability or even a bug. This is a natural implementation that does not violate the specification, what can I say. The type of bomb in this article is just one type, and there are many other ways that you can puzzle the zip parser. As mentioned above, if you want to protect against resource depletion attacks, you should not attempt to list, detect, and block every single known attack; rather, it is necessary to establish external restrictions on time and other resources so that the parser does not get into such a situation, no matter what attack it encounters. There is nothing wrong with trying to detect and reject certain constructions as a first pass optimization,but you can not stop there. If you ultimately do not isolate and restrict unreliable data operations, your system is probably still vulnerable. Consider the analogy with HTML cross-site scripting: the right defense is not to try to filter out specific bytes that can be interpreted as code, but to avoid everything correctly.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Antivirus engines </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Twitter user @TVqQAAMAAAAEAAA </font></font><a href="https://twitter.com/TVqQAAMAAAAEAAA/status/1146351962486476801"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reports</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : "McAfee Antivirus on my test machine just exploded." </font><font style="vertical-align: inherit;">I did not check it myself and I do not have such details as the version number. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tavis Ormandi </font></font><a href="https://twitter.com/taviso/status/1146477576132542466"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">points</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> out that in </font></font><a href="https://www.virustotal.com/gui/file/f1dc920869794df3e258f42f9b99157104cd3f8c14394c1b9d043d6fcda14c0a/detection"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirusTotal for zblg.zip</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> there is a series of timeouts ( </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">screenshot dated June 6, 2019</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): AhnLab-V3, ClamAV, DrWeb, Endgame, F-Secure, GData, K7AntiVirus, K7GW, MaxSecure, McAfee, McAfee-GVtiVirus, K7GW, MaxSecure, McAfee, McAfee-GVtiVirus, K7GW, MaxSecure, McAfee, McAfee-GVtiVirus, K7GW, MaxSecure, McAfee, McAfee-GVtiVirus, K7GW, MaxSecure, McAfee, McAfee-Mi-Vee-Virus -Edition, Panda, Qihoo-360, Sophos ML, VBA32. </font></font><a href="https://www.virustotal.com/gui/file/fb4ff972d21189beec11e05109c4354d0cd6d3b629263d6c950cf8cc3f78bd99/detection"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Results for zbsm.zip</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">screenshot dated June 6, 2019</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) similar, but with a different set of engines that fell out in a timeout: Baido, Bkav, ClamAV, CMC, DrWeb, Endgame, ESET-NOD32, F-Secure, GData, Kingsoft, McAfee-GW-Edition, NANO-Antivirus, Acronis. </font><font style="vertical-align: inherit;">Interestingly, </font><font style="vertical-align: inherit;">there are no timeouts </font><font style="vertical-align: inherit;">in the </font></font><a href="https://www.virustotal.com/gui/file/eafd8f574ea7fd0f345eaa19eae8d0d78d5323c8154592c850a2d78a86817744/detection"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">results of zbxl.zip</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">screenshot dated June 6, 2019</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Perhaps some antiviruses do not support Zip64? </font><font style="vertical-align: inherit;">Several engines detect files as a kind of ‚Äúcompression bomb‚Äù. </font><font style="vertical-align: inherit;">It is interesting to see whether they will still do this with small changes, such as changing file names or adding an ASCII prefix to each file.</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Closing statement </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It's time to put an end to Facebook. </font><font style="vertical-align: inherit;">This is not a neutral job for you: every day when you come to work, you do something wrong. </font><font style="vertical-align: inherit;">If you have a Facebook account, delete it. </font><font style="vertical-align: inherit;">If you work on Facebook, be content. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And do not forget that the National Security Agency must be destroyed.</font></font></div><p>Source: <a href="https://habr.com/ru/post/459254/">https://habr.com/ru/post/459254/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459246/index.html">Why is website conversion going down? Examples of 60 errors in design and usability</a></li>
<li><a href="../459248/index.html">Digital events in Moscow from 09 to 14 July</a></li>
<li><a href="../45925/index.html">Glasses display: Teleglass by Scalar</a></li>
<li><a href="../459250/index.html">PostgreSQL WAL: 2. Prerecord Log</a></li>
<li><a href="../459252/index.html">Security Week 28: Hacking a Smart Home</a></li>
<li><a href="../459256/index.html">How we optimized our Theme Hospital for different platforms</a></li>
<li><a href="../459258/index.html">14,000 versts not a hook</a></li>
<li><a href="../45926/index.html">habra</a></li>
<li><a href="../459262/index.html">Retire at 22</a></li>
<li><a href="../459264/index.html">Get out of the Tarantool networks. Sync node when filtering traffic</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>