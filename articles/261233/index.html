<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We continue to deal with the "historical reasons" in cmd.exe</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article, we talked about a possible solution to the situation with the need to specify the "/ D" key for the CD command, which is incl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We continue to deal with the "historical reasons" in cmd.exe</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/29d/0e1/dcc/29d0e1dcc27bcc3eef172b694e86e8bd.png" alt="image"><br><br>  In the previous <a href="http://habrahabr.ru/post/260991/">article,</a> we talked about a possible solution to the situation with the need to specify the "/ D" key for the CD command, which is included in the delivery of the standard command line interpreter for the Windows operating system <a href="https://en.wikipedia.org/wiki/Cmd.exe">cmd.exe</a> .  It is time to talk about another behavior, which stretches from time immemorial for no particular reason. <br><br>  This time we will talk about autocompletion of paths, which in most environments and software products (and cmd.exe is not an exception in this case) by pressing the Tab / Shift-Tab keys.  I think no one will argue with the fact that the feature is quite useful and often saves up to a few seconds of time that would be spent on manually entering the full path to the interested user of a file or directory.  It's great that it is also present in cmd.exe, however ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's experiment.  Run cmd.exe (Win-R -&gt; cmd), start typing ‚ÄúCD C: /‚Äù, press Tab, and ... Instead of the expected directories like ‚ÄúProgram Files‚Äù and ‚ÄúWindows‚Äù, we get the first alphabetical object from% HOMEPATH%, ‚ÄúStuck together‚Äù together with ‚ÄúC: /‚Äù (in my case it gave the result in the form of ‚ÄúC: /. Vim‚Äù).  Why?  I think those who, by their nature of work, often had to deal with cmd.exe, already understood what was the matter - instead of forward slash, for correct autocompletion, you should use backslash (by the way, there are other <a href="https://angryprogrammerblog.wordpress.com/2013/07/25/%25D0%25B8%25D1%2581%25D0%25BF%25D0%25BE%25D0%25BB%25D1%258C%25D0%25B7%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5-%25D0%25B4%25D0%25BB%25D1%258F-%25D0%25BF%25D1%2583%25D1%2582%25D0%25B5%25D0%25B9-%25D0%25B2-windows/">exceptions</a> in this regard).  This is especially unusual for those who spend most of their time in other systems (for example, * nix-like), where the forward slash is used as the separator path and not the reverse.  Why Microsoft decided to use this particular symbol instead of the forward slash, which has already become familiar to many users at the time, is explained, for example, <a href="http://blogs.msdn.com/b/larryosterman/archive/2005/06/24/432386.aspx">here</a> .  Well, it remains for us to either come to terms with this, or pick up a debugger <s>file</s> and start exploring cmd.exe.  If we had chosen the first path, then there would have been no article, so you should have already guessed what was going on. <br><br>  How was the process, and what came of it, read under the cut (carefully, a <b>lot of screenshots</b> ). <br><a name="habracut"></a><br>  First of all, we need to see why this cmd.exe decided to search for objects not in the user-specified directory, but in% HOMEPATH. <br><br>  Iteration over objects in a directory using WinAPI is usually done using the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa364418(v%3Dvs.85).aspx">FindFirstFile</a> and <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa364428(v%3Dvs.85).aspx">FindNextFile functions</a> , as well as their variations in the form of <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa364419(v%3Dvs.85).aspx">FindFirstFileEx</a> , <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa364422(v%3Dvs.85).aspx">FindFirstFileTransacted</a> , etc.  Run <a href="http://www.ollydbg.de/">OllyDbg</a> , load cmd.exe into it (of course, copied in advance to any directory other than "% WINDIR% \ system32"), open a window with a list of intermodule calls (right-click on the window CPU -&gt; Search for -&gt; All intermodular calls ), we write ‚ÄúFindFirstFile‚Äù and set breakpoints on all calls using the F2 key: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/37a/e76/0cb/37ae760cb53e07247bff7531fe116e5f.png" alt="image"><br><br>  Enter the ‚ÄúCD C: /‚Äù command we are examining, press Tab and see the following picture in front of us: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/414/3aa/7b6/4143aa7b6fb49b5e0dc11606313e7291.png" alt="image"><br><br>  Pay attention to the first argument passed to the <b>FindFirstFileEx</b> function - it is he who, according to the documentation, sets the criterion by which the search will be performed: <br><br><blockquote>  lpFileName [in] <br>  The asterisk (*) or the question mark (?) </blockquote><br>  In my case, he pointed to the address <b>0x0030F660</b> , where the Unicode string "C: \ Program Files \ *" was stored.  Why precisely she?  Yes, because it was there that I was at the time of entering the CD command. <br><br>  Let's do the same thing using backslash instead of forward slash.  Press F9, enter the command ‚ÄúCD C: \‚Äù followed by pressing Tab and see: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4f0/019/521/4f001952131e62be4cd66f77ec445c91.png" alt="image"><br><br>  Yes, now this argument points to the string "C: \ *", as expected.  Therefore, in the case of using a forward slash as the path separator, cmd.exe runs over the objects suitable for auto-completion in the current directory. <br><br>  We run through the calls of all the procedures from the call stack, which is opened by pressing Alt-K, and we see near one of them something similar to the parsing of the command that came from the user: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/690/4a0/cd3/6904a0cd37ff27e7da1e351edb837472.png" alt="image"><br><br>  We set the breakpoint at the beginning of this procedure (in my case it is <b>0x4ACE1877</b> ), press F9, enter our command with a backslash and Tab'om again and start step by step debugging.  Shortly after the amplified pressing of the F7 key, we realize that we were in a cycle that runs over all the characters in the command entered by the user: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/63e/06b/726/63e06b726c66e5293b726d425a23b6fa.png" alt="image"><br><br>  <b>EBP + 8</b> points to a Unicode line with a command, <b>EBP + 10</b> contains the length of the command, and <b>EDI</b> is a loop counter. <br><br>  Almost immediately after this cycle, there is a call to the function <a href="http://en.cppreference.com/w/cpp/string/byte/memcpy">std :: memcpy</a> , as a result of which, if you use backslash, the ‚ÄúC: \‚Äù will get to dest <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7db/f7d/07b/7dbf7d07b4a82585c4d94c24ee60f60b.png" alt="image"><br><br>  , and in the case of forward slash, the empty string: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3b2/962/d80/3b2962d8012aaab898681a70ccf8f78a.png" alt="image"><br><br>  Well, let's try to figure out what is happening in this cycle by translating the algorithm of its work into some high-level programming language.  IDA Pro can decompile the code for you, but, unfortunately, it asks for a lot of money for it, so we will try to translate it yourself into C ++: <br><br><pre><code class="hljs lua">#include &lt;cstddef&gt; #include &lt;cstring&gt; #include &lt;cwchar&gt; #include &lt;iostream&gt; #include &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; int main() { std::wstring command; std::getline(std::wcin, command); auto command_size = command.size(); int ebx = <span class="hljs-number"><span class="hljs-number">-1</span></span>; int esi = <span class="hljs-number"><span class="hljs-number">0</span></span>; int edx = <span class="hljs-number"><span class="hljs-number">0</span></span>; const int ebp_24 = <span class="hljs-number"><span class="hljs-number">0</span></span>; // Always <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> our case cause it changes <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the <span class="hljs-string"><span class="hljs-string">'"'</span></span> branch // Not actually used <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> our case int ebp_1c = <span class="hljs-number"><span class="hljs-number">0</span></span>; int ebp_28 = <span class="hljs-number"><span class="hljs-number">0</span></span>; int ebp_2c = <span class="hljs-number"><span class="hljs-number">0</span></span>; /** * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE18C7 | &gt; / <span class="hljs-number"><span class="hljs-number">897</span></span>D D0 / MOV DWORD PTR SS : [EBP - <span class="hljs-number"><span class="hljs-number">30</span></span>], EDI * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE18CA | . | <span class="hljs-number"><span class="hljs-number">8</span></span>B45 <span class="hljs-number"><span class="hljs-number">10</span></span> | MOV EAX, DWORD PTR SS : [EBP + <span class="hljs-number"><span class="hljs-number">10</span></span>] * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE18CD | . | <span class="hljs-number"><span class="hljs-number">3</span></span>BF8 | CMP EDI, EAX * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE18CF | . | <span class="hljs-number"><span class="hljs-number">0</span></span>F8D <span class="hljs-number"><span class="hljs-number">90000000</span></span> | JGE cmd<span class="hljs-number"><span class="hljs-number">.4</span></span>ACE1965 */ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (std::wstring::size_type i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; command_size; ++i) { /** * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE18D5 | . <span class="hljs-number"><span class="hljs-number">8</span></span>B45 <span class="hljs-number"><span class="hljs-number">08</span></span> | MOV EAX, DWORD PTR SS : [EBP + <span class="hljs-number"><span class="hljs-number">8</span></span>] * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE18D8 | . <span class="hljs-number"><span class="hljs-number">0</span></span>FB70478 | MOVZX EAX, WORD PTR DS : [EAX + EDI * <span class="hljs-number"><span class="hljs-number">2</span></span>] */ const wchar_t cur_symbol = command[i]; // <span class="hljs-number"><span class="hljs-number">4</span></span>ACE18DC | . <span class="hljs-number"><span class="hljs-number">66</span></span>:<span class="hljs-number"><span class="hljs-number">83</span></span>F8 <span class="hljs-number"><span class="hljs-number">2</span></span>F | CMP AX, <span class="hljs-number"><span class="hljs-number">2</span></span>F <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cur_symbol == L<span class="hljs-string"><span class="hljs-string">'/'</span></span>) { /** * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE18E2 | . <span class="hljs-number"><span class="hljs-number">8</span></span>D77 <span class="hljs-number"><span class="hljs-number">01</span></span> | LEA ESI, DWORD PTR DS : [EDI + <span class="hljs-number"><span class="hljs-number">1</span></span>] * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE18E5 | . <span class="hljs-number"><span class="hljs-number">8975</span></span> D8 | MOV DWORD PTR SS : [EBP - <span class="hljs-number"><span class="hljs-number">28</span></span>], ESI */ esi = i + <span class="hljs-number"><span class="hljs-number">1</span></span>; ebp_28 = esi; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cur_symbol == L<span class="hljs-string"><span class="hljs-string">'"'</span></span>) { // ... } // <span class="hljs-number"><span class="hljs-number">4</span></span>ACE18F0 | . <span class="hljs-number"><span class="hljs-number">3955</span></span> DC | CMP DWORD PTR SS : [EBP - <span class="hljs-number"><span class="hljs-number">24</span></span>], EDX <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ebp_24 == edx) { /** * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE190C | . <span class="hljs-number"><span class="hljs-number">50</span></span> | PUSH EAX; / w * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE190D | . <span class="hljs-number"><span class="hljs-number">68</span></span> E008D04A | PUSH cmd<span class="hljs-number"><span class="hljs-number">.4</span></span>AD008E0; | wstr = <span class="hljs-string"><span class="hljs-string">" &amp;()[]{}^=;!%'+,`~"</span></span> * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1912 | .FF15 F010CC4A | CALL DWORD PTR DS : [&lt;&amp;msvcrt.wcschr&gt;]; \wcschr * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1918 | . <span class="hljs-number"><span class="hljs-number">59</span></span> | POP ECX * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1919 | . <span class="hljs-number"><span class="hljs-number">59</span></span> | POP ECX * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE191A | . <span class="hljs-number"><span class="hljs-number">85</span></span>C0 | TEST EAX, EAX */ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (std::wcschr(L<span class="hljs-string"><span class="hljs-string">" &amp;()[]{}^=;!%'+,`~"</span></span>, cur_symbol) != NULL) { /** * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE191E |. <span class="hljs-number"><span class="hljs-number">8</span></span>D77 <span class="hljs-number"><span class="hljs-number">01</span></span> |LEA ESI,DWORD PTR DS:[EDI+<span class="hljs-number"><span class="hljs-number">1</span></span>] * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1921 |. <span class="hljs-number"><span class="hljs-number">8975</span></span> D8 |MOV DWORD PTR SS:[EBP<span class="hljs-number"><span class="hljs-number">-28</span></span>],ESI * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1924 |. <span class="hljs-number"><span class="hljs-number">8365</span></span> E4 <span class="hljs-number"><span class="hljs-number">00</span></span> |AND DWORD PTR SS:[EBP<span class="hljs-number"><span class="hljs-number">-1</span></span>C],<span class="hljs-number"><span class="hljs-number">0</span></span> * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1928 |. <span class="hljs-number"><span class="hljs-number">33</span></span>D2 |XOR EDX,EDX */ esi = i + <span class="hljs-number"><span class="hljs-number">1</span></span>; ebp_28 = esi; ebp_1c = <span class="hljs-number"><span class="hljs-number">0</span></span>; edx = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { // <span class="hljs-number"><span class="hljs-number">4</span></span>ACE192C | &gt; \<span class="hljs-number"><span class="hljs-number">33</span></span>D2 | XOR EDX, EDX edx = <span class="hljs-number"><span class="hljs-number">0</span></span>; /** * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1935 | . <span class="hljs-number"><span class="hljs-number">66</span></span>:<span class="hljs-number"><span class="hljs-number">83</span></span>F8 <span class="hljs-number"><span class="hljs-number">3</span></span>A | CMP AX, <span class="hljs-number"><span class="hljs-number">3</span></span>A * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1939 | . <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>B | JE SHORT cmd<span class="hljs-number"><span class="hljs-number">.4</span></span>ACE1956 * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE193B | . <span class="hljs-number"><span class="hljs-number">66</span></span> : <span class="hljs-number"><span class="hljs-number">83</span></span>F8 <span class="hljs-number"><span class="hljs-number">5</span></span>C | CMP AX, <span class="hljs-number"><span class="hljs-number">5</span></span>C * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE193F | . <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> | JE SHORT cmd<span class="hljs-number"><span class="hljs-number">.4</span></span>ACE1956 */ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cur_symbol == L<span class="hljs-string"><span class="hljs-string">':'</span></span> || cur_symbol == L<span class="hljs-string"><span class="hljs-string">'\\'</span></span>) { /** * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1956 | &gt; \<span class="hljs-number"><span class="hljs-number">8</span></span>D5F <span class="hljs-number"><span class="hljs-number">01</span></span> | LEA EBX, DWORD PTR DS : [EDI + <span class="hljs-number"><span class="hljs-number">1</span></span>] * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1959 | . <span class="hljs-number"><span class="hljs-number">895</span></span>D D4 | MOV DWORD PTR SS : [EBP - <span class="hljs-number"><span class="hljs-number">2</span></span>C], EBX * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE195C | &gt; <span class="hljs-number"><span class="hljs-number">8955</span></span> E4 | MOV DWORD PTR SS : [EBP - <span class="hljs-number"><span class="hljs-number">1</span></span>C], EDX */ ebx = i + <span class="hljs-number"><span class="hljs-number">1</span></span>; ebp_2c = ebx; ebp_1c = edx; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cur_symbol == L<span class="hljs-string"><span class="hljs-string">'*'</span></span> || cur_symbol == L<span class="hljs-string"><span class="hljs-string">'?'</span></span>) { // ... } } } } /** * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1965 |&gt; \<span class="hljs-number"><span class="hljs-number">83</span></span>FB FF CMP EBX,<span class="hljs-number"><span class="hljs-number">-1</span></span> * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1968 |. <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> JE SHORT cmd<span class="hljs-number"><span class="hljs-number">.4</span></span>ACE196E * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE196A |. <span class="hljs-number"><span class="hljs-number">3</span></span>BDE CMP EBX,ESI * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE196C |. <span class="hljs-number"><span class="hljs-number">7</span></span>D <span class="hljs-number"><span class="hljs-number">05</span></span> JGE SHORT cmd<span class="hljs-number"><span class="hljs-number">.4</span></span>ACE1973 */ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ebx == <span class="hljs-number"><span class="hljs-number">-1</span></span> || ebx &lt; esi) { /** * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE196E | &gt; \<span class="hljs-number"><span class="hljs-number">8</span></span>BDE MOV EBX, ESI * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1970 | . <span class="hljs-number"><span class="hljs-number">895</span></span>D D4 MOV DWORD PTR SS : [EBP - <span class="hljs-number"><span class="hljs-number">2</span></span>C], EBX */ ebx = esi; ebp_2c = ebx; } /** * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1973 | &gt; \<span class="hljs-number"><span class="hljs-number">2</span></span>BC6 SUB EAX, ESI * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1975 | . <span class="hljs-number"><span class="hljs-number">03</span></span>C0 ADD EAX, EAX * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1977 | . <span class="hljs-number"><span class="hljs-number">8</span></span>BF8 MOV EDI, EAX * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1979 | . <span class="hljs-number"><span class="hljs-number">57</span></span> PUSH EDI; / n * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE197A | . <span class="hljs-number"><span class="hljs-number">8</span></span>B45 <span class="hljs-number"><span class="hljs-number">08</span></span> MOV EAX, DWORD PTR SS : [EBP + <span class="hljs-number"><span class="hljs-number">8</span></span>]; | * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE197D | . <span class="hljs-number"><span class="hljs-number">8</span></span>D0470 LEA EAX, DWORD PTR DS : [EAX + ESI * <span class="hljs-number"><span class="hljs-number">2</span></span>]; | * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1980 | . <span class="hljs-number"><span class="hljs-number">50</span></span> PUSH EAX; | src * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1981 | .FF75 E0 PUSH DWORD PTR SS : [EBP - <span class="hljs-number"><span class="hljs-number">20</span></span>]; | dest * <span class="hljs-number"><span class="hljs-number">4</span></span>ACE1984 | .E8 <span class="hljs-number"><span class="hljs-number">52</span></span>FAFDFF CALL &lt;JMP.&amp;msvcrt.memcpy&gt;; \memcpy */ const std::size_t count = (command_size - esi) * <span class="hljs-number"><span class="hljs-number">2</span></span>; wchar_t dest[<span class="hljs-number"><span class="hljs-number">1024</span></span>] = { <span class="hljs-number"><span class="hljs-number">0</span></span> }; std::memcpy(dest, command.substr(esi).c_str(), count); std::wcout &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Result: "</span></span> &lt;&lt; dest &lt;&lt; std::endl; }</code> </pre> <br>  Places marked with the comment "// ..." are not affected in the cases we are considering. <br><br>  Characters like '*' and '\' were identified by the ASCII code table: <br><br><img src="https://hsto.org/files/dc5/fe2/380/dc5fe238022b4d78aa4d32d540b7b9d9.gif" alt="image"><br><br>  Experimenting with the input data, you can see the following: <br><br><blockquote>  CD C: \ <br>  Result: C: \ <br><br>  CD C: / <br>  Result: <br><br>  CD C: \ Windows \ <br>  Result: C: \ Windows \ <br><br>  CD C: / Windows \ <br>  Result: Windows \ </blockquote><br>  It is easy to see that forward slash causes problems regardless of the exact location of the path entered by the user, at least at the end, at least in the middle. <br><br>  The solution could be to replace all forward slashs with backslash immediately after cmd.exe realized that auto completion is necessary.  To do this, I propose to approach from the other side - to carry out step-by-step debugging immediately after the user enters data from the standard input stream. <br><br>  However, reading data from stdin can be done in many different ways.  How to understand exactly what is used in cmd.exe?  Quite simply - press F9, then F12 (Pause), look at the call stack and see among the calls the WinAPI function called <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684958(v%3Dvs.85).aspx">ReadConsole</a> : <br><br><img src="https://hsto.org/files/eb5/57c/da8/eb557cda8c274638855f7848fe3bfe5a.PNG" alt="image"><br><br>  By default, <b>ReadConsole</b> returns control to the code that called it after pressing the Enter key, but apparently this is not our case, since  it should complete its work, for example, after pressing Tab. <br><br>  We put the software breakpoint on its call and achieve its operation: <br><br><img src="https://hsto.org/files/b51/b7f/533/b51b7f533ba54a9999e1f49ba8110696.PNG" alt="image"><br><br>  Note the last parameter, here called <b>pReserved</b> .  In fact, it is called <b>pInputControl</b> and is responsible for the following: <br><br><blockquote>  pInputControl [in, optional] <br>  A pointer to a readout.  This parameter can be NULL </blockquote><br>  In our case, it is not NULL at all, so let's see what the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa363485(v%3Dvs.85).aspx">CONSOLE_READCONSOLE_CONTROL</a> structure looks like: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CONSOLE_READCONSOLE_CONTROL</span></span></span><span class="hljs-class"> {</span></span> ULONG nLength; ULONG nInitialChars; ULONG dwCtrlWakeupMask; ULONG dwControlKeyState; } CONSOLE_READCONSOLE_CONTROL, *PCONSOLE_READCONSOLE_CONTROL;</code> </pre><br>  Looking at the "raw" bytes is not very convenient, so let's use a special plugin for OllyDbg called <a href="https://tuts4you.com/download.php%3Fview.1275">StollyStructs</a> , which is designed to visualize structures.  Download, unzip .dll and .ini to the directory where the OllyDbg executable file is located (of course, if it is specified as a path for plugins, which is done by default) and restart the debugger.  After restarting cmd.exe, the addresses may change, but most likely, the ‚Äúending‚Äù of the addresses will remain the same.  For example, if previously the <b>ReadConsole</b> call <b>that</b> we are interested in was located at <b>0x4ACD3589</b> , then now it will probably be located at the address <b>0xXXXXX589</b> : <br><br><img src="https://hsto.org/files/116/189/abb/116189abb5f944059e6f9b2bdfdc2ea1.PNG" alt="image"><br><br>  We put a breakpoint, stop at it, click on Plugins -&gt; StollyStruct -&gt; Select structure, enter the address passed as an argument to <b>pInputControl</b> in the Address field, and ... We do not find the structure <b>CONSOLE_READCONSOLE_CONTROL</b> in the drop-down list.  Well, the author did not promise that all structures from WinAPI will be set in advance.  Option two - either add a description of this structure to the plug-in configuration file, or use another structure that will be similar to the one we are interested in.  The first thing that came to my mind is the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd162897(v%3Dvs.85).aspx">RECT</a> structure, which also contains 4 fields with the only difference that it uses LONGs instead of ULONGs, which, in principle, will hardly bother us in this case: <br><br><pre> <code class="hljs swift">typedef <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_RECT</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-type"><span class="hljs-type">LONG</span></span> <span class="hljs-keyword"><span class="hljs-keyword">left</span></span>; <span class="hljs-type"><span class="hljs-type">LONG</span></span> top; <span class="hljs-type"><span class="hljs-type">LONG</span></span> <span class="hljs-keyword"><span class="hljs-keyword">right</span></span>; <span class="hljs-type"><span class="hljs-type">LONG</span></span> bottom; } <span class="hljs-type"><span class="hljs-type">RECT</span></span>, *<span class="hljs-type"><span class="hljs-type">PRECT</span></span>;</code> </pre><br>  The result is the following: <br><br><img src="https://hsto.org/files/1d6/99b/109/1d699b1096864da6836958cc3e2aef6c.PNG" alt="image"><br><br>  Specifying the characters to stop input is done using the <b>dwCtrlWakeupMask</b> field: <br><br><blockquote>  dwCtrlWakeupMask <br>  A user-defined control character is used. </blockquote><br>  As you can see, in our case it contains the value 0x200, which is obtained as a result of performing the bit shift operation 1 &lt;&lt; 0x9, where 0x9 is the ASCII code of the Tab. <br><br>  Well, we made sure that the return from the <b>ReadConsole</b> function <b>is</b> performed after the user has entered either Enter'a or Tab'a.  Now let's go back to step by step debugging. <br><br>  Having run a little, we will find ourselves in another cycle, which is iterated over all the characters in the command entered by the user: <br><br><img src="https://hsto.org/files/aa0/1bf/4af/aa01bf4af5c144eab450f0c31db9a92e.PNG" alt="image"><br><br>  Here, <b>EDI</b> points to a unicode string with a command, and <b>EAX</b> is a loop counter. <br><br>  As you can see, each character is compared first with 0x0D, then with the value at <b>0x4A1640A0</b> , and then with the content at <b>0x4A1640A4</b> .  If you look at the table of ASCII codes, then we will see that 0x0D is nothing more than a carriage return.  At the addresses indicated above, the same value 0x9 is stored, which, as mentioned earlier, is the Tab's ASCII code: <br><br><img src="https://hsto.org/files/059/0dd/0a5/0590dd0a5f8744e7a6898b61f50a58b4.PNG" alt="image"><br><br>  And not far from the address to which the transition will be carried out in the case of equality of the current character with the Tab, there is the parsing code of the transmitted command, which we have already seen earlier.  Well, in my opinion, this is the very place where it is best to place the transition on our code cave. <br><br>  What are we going to do in it?  I propose to proceed as follows - run from the end of the line to its beginning, checking each character up to the first space character encountered for equality with forward slash and replacing it with backslash.  It will look something like this: <br><br><pre> <code class="hljs 1c">PUSHFD PUSHAD ; <span class="hljs-keyword"><span class="hljs-keyword"></span></span> <span class="hljs-built_in"><span class="hljs-built_in"></span></span> ,   <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  TEST EAX,EAX JZ l1 ;    (    ;  ,   <span class="hljs-built_in"><span class="hljs-built_in"></span></span> Tab') l4: DEC EAX ;   ECX   MOVZX ECX,WORD PTR DS:[EDI+EAX*2] CMP CX,2F ;   forward slash JE l2 CMP CX,20 ;    JE l1 JMP l3 l2: ;  forward slash  backslash MOV WORD PTR DS:[EDI+EAX*2],5C l3: ;     ,     TEST EAX,EAX ;        JNZ l4 l1: POPAD POPFD ;    ,   ;     JMP 4ACD42CD</code> </pre><br>  Find a place for our code cave (you can do this with Ctrl-B -&gt; many zeros in the ‚ÄúHEX + 0C‚Äù field) and write the following code there (addresses, of course, may differ): <br><br><pre> <code class="hljs css">4<span class="hljs-selector-tag"><span class="hljs-selector-tag">A163CC5</span></span> 9<span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PUSHFD</span></span> 4<span class="hljs-selector-tag"><span class="hljs-selector-tag">A163CC6</span></span> 60 <span class="hljs-selector-tag"><span class="hljs-selector-tag">PUSHAD</span></span> 4<span class="hljs-selector-tag"><span class="hljs-selector-tag">A163CC7</span></span> 85<span class="hljs-selector-tag"><span class="hljs-selector-tag">C0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TEST</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">EAX</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">EAX</span></span> 4<span class="hljs-selector-tag"><span class="hljs-selector-tag">A163CC9</span></span> 74 1<span class="hljs-selector-tag"><span class="hljs-selector-tag">D</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">JE</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SHORT</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmd</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4A163CE8</span></span> 4<span class="hljs-selector-tag"><span class="hljs-selector-tag">A163CCB</span></span> 48 <span class="hljs-selector-tag"><span class="hljs-selector-tag">DEC</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">EAX</span></span> 4<span class="hljs-selector-tag"><span class="hljs-selector-tag">A163CCC</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">FB70C47</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MOVZX</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ECX</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">WORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DS</span></span>:<span class="hljs-selector-attr"><span class="hljs-selector-attr">[EDI+EAX*2]</span></span> 4<span class="hljs-selector-tag"><span class="hljs-selector-tag">A163CD0</span></span> 66<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:83F9</span></span> 2<span class="hljs-selector-tag"><span class="hljs-selector-tag">F</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">CMP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">CX</span></span>,2<span class="hljs-selector-tag"><span class="hljs-selector-tag">F</span></span> 4<span class="hljs-selector-tag"><span class="hljs-selector-tag">A163CD4</span></span> 74 08 <span class="hljs-selector-tag"><span class="hljs-selector-tag">JE</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SHORT</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmd</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4A163CDE</span></span> 4<span class="hljs-selector-tag"><span class="hljs-selector-tag">A163CD6</span></span> 66<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:83F9</span></span> 20 <span class="hljs-selector-tag"><span class="hljs-selector-tag">CMP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">CX</span></span>,20 4<span class="hljs-selector-tag"><span class="hljs-selector-tag">A163CDA</span></span> 74 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">JE</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SHORT</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmd</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4A163CE8</span></span> 4<span class="hljs-selector-tag"><span class="hljs-selector-tag">A163CDC</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">EB</span></span> 06 <span class="hljs-selector-tag"><span class="hljs-selector-tag">JMP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SHORT</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmd</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4A163CE4</span></span> 4<span class="hljs-selector-tag"><span class="hljs-selector-tag">A163CDE</span></span> 66<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:C70447</span></span> 5<span class="hljs-selector-tag"><span class="hljs-selector-tag">C0</span></span>&gt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">MOV</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">WORD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PTR</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DS</span></span>:<span class="hljs-selector-attr"><span class="hljs-selector-attr">[EDI+EAX*2]</span></span>,5<span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span> 4<span class="hljs-selector-tag"><span class="hljs-selector-tag">A163CE4</span></span> 85<span class="hljs-selector-tag"><span class="hljs-selector-tag">C0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TEST</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">EAX</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">EAX</span></span> 4<span class="hljs-selector-tag"><span class="hljs-selector-tag">A163CE6</span></span> ^ 75 <span class="hljs-selector-tag"><span class="hljs-selector-tag">E3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">JNZ</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SHORT</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmd</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4A163CCB</span></span> 4<span class="hljs-selector-tag"><span class="hljs-selector-tag">A163CE8</span></span> 61 <span class="hljs-selector-tag"><span class="hljs-selector-tag">POPAD</span></span> 4<span class="hljs-selector-tag"><span class="hljs-selector-tag">A163CE9</span></span> 9<span class="hljs-selector-tag"><span class="hljs-selector-tag">D</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">POPFD</span></span> 4<span class="hljs-selector-tag"><span class="hljs-selector-tag">A163CEA</span></span> ^ <span class="hljs-selector-tag"><span class="hljs-selector-tag">E9</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DE05FFFF</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">JMP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmd</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4A1542CD</span></span></code> </pre><br>  where <b>0x4A1542CD</b> is the address to which we had to go as a result of a conditional branch located at <b>0x4A154299</b> and performing a check for equality of the current symbol in the command to Tab.  That transition, respectively, is replaced by a jump to our code cave: <br><br><img src="https://hsto.org/files/43b/5c8/713/43b5c8713d2142fd9880a96927535ca0.PNG" alt="image"><br><br>  I think you have already noticed that he wiped out the following instructions.  It's okay, because, in fact, it was a similar test for the equality of the current character on the same Tab, and it was impossible to get to it in other ways.  To make sure of this, you can select our changes, return everything, as it was with Alt-Backspace, select a line with this instruction and press Ctrl-R, where there will be one and only line with the same address: <br><br><img src="https://hsto.org/files/4a9/b47/aa2/4a9b47aa22154e7b972585bf885b7026.PNG" alt="image"><br><br>  We check the workability, and ... By pressing Tab, forward slash and are really replaced with backslash, as a result of which auto-completion is performed according to the user-specified directory, regardless of which slashes he originally used. <br><br><h3>  Afterword </h3><br>  Someone may say that this is all the little things.  Some may not like the fact that we are solving this task, and not the developers from Microsoft.  <s>Someone may not like anything at all</s> .  But the fact remains that we have solved our problem, and now cmd.exe works as we wanted at the very beginning of the article.  And to do similar or not, is up to you. <br><br>  In fairness it should be noted that in <a href="https://en.wikipedia.org/wiki/Windows_PowerShell">PowerShell</a> this ‚Äúproblem‚Äù, as well as the situation with the ‚Äú/ D‚Äù key for the CD command, is still corrected. <br><br>  Thank you for your attention, and again I hope that the article was useful to someone. </div><p>Source: <a href="https://habr.com/ru/post/261233/">https://habr.com/ru/post/261233/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261219/index.html">QoS configuration on VMWare and Cisco USC</a></li>
<li><a href="../261221/index.html">Testing in another language: what to do if you don‚Äôt know it</a></li>
<li><a href="../261223/index.html">Software oriented storage</a></li>
<li><a href="../261225/index.html">Top new features for Web, UX and mobile application designers in Photoshop 2015</a></li>
<li><a href="../261229/index.html">Microsoft Research for Young Scientists - Results, Slides, and Azure Cloud for Research Program</a></li>
<li><a href="../261235/index.html">Implement Blacklist in Asterisk using MySQL database</a></li>
<li><a href="../261237/index.html">Pluses of microservice architecture</a></li>
<li><a href="../261239/index.html">We monitor the status of Push-notifications and news of the project + UPD RSS</a></li>
<li><a href="../261241/index.html">Read more about 3D navigation in nanoCAD Plus 7</a></li>
<li><a href="../261243/index.html">World OpenStack Summit and other news</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>