<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WiFi radio from the old radio</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article focuses on the practical aspects of making inexpensive WiFi radio based on an OpenWrt router running a Stellaris microcontroller. 


 Pur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WiFi radio from the old radio</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/ff8/21d/02c/ff821d02ce1eef9d01399b81b6ae609d.jpg" alt="image"><br>  This article focuses on the practical aspects of making inexpensive <a href="http://en.wikipedia.org/wiki/Internet_radio_device">WiFi radio</a> based on an <a href="https://openwrt.org/">OpenWrt</a> router running a <a href="http://www.ti.com/tool/EK-LM4F120XL">Stellaris</a> microcontroller. <br><a name="habracut"></a><br><br><h5>  Purpose and justification of the choice of components </h5><br>  <b>The main goal</b> was to make a device for providing background music to the kitchen, with the most simple and intuitive interface usable home. <br>  <b>Secondary goals</b> : <br><ul><li>  fix broken radio </li><li>  Attach a faulty router and a Stellaris debug board ordered in a shopogolism fit </li><li>  evaluate the convenience of working with a Stellaris microcontroller </li></ul><br>  The choice of the remaining components of the scheme is not complete. <br><br><h5>  Housing </h5><br>  Usually this section is put at the end.  But in my opinion.  The topic is quite important, especially if the device is to be operated in aggressive environments (I mean the kitchen).  <a href="http://mightyohm.com/blog/2008/10/building-a-wifi-radio-part-1-introduction/">Jeff</a> made a plywood case.  A good solution for those who want a normal sound and can bend plywood.  In my performance, such a corpus would look too collectively, so I chose my old puzatenky tape recorder with a CD to play.  The wide base of the CD player allows you to place the most overall structural element of the router board, the speakers provide the basis of the audio path, and the handle for carrying the necessary mobility.  In addition, there is a chance to use the controls of the radio. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Interface </h5><br>  One of the factors hindering the use of new technologies is the need to change the user interface.  Therefore, it was decided to stop at the simplest option: a large screen for displaying the station number, 2 buttons next / previous station, 2 buttons for volume control and a start / stop button for playing.  For practical use of the device, it turned out to be important to remember the last set sound level and the selected station. <br><br><h5>  Design </h5><br>  A 4-year-old manual from the <a href="http://mightyohm.com/blog/2008/10/building-a-wifi-radio-part-1-introduction/">MightyOhm</a> website was chosen as the basis.  It is described in sufficient detail and I see no reason to reproduce it here entirely.  I will focus only on the differences. <br>  When constructing a radio according to this scheme, there is a dilemma of separation of control between Linux and the microcontroller.  I stopped at the option when most of the control logic is located on the MK due to dislike and the lack of a lot of Linux administration experience as well as the desire to play around with the MK.  In addition, I am confused by the problem of having to repeat the setup procedure when flashing the router. <br>  Therefore, from the side of openvrt I added only <br><ul><li>  <a href="https://wifiradio.googlecode.com/svn/trunk/openwrt/setup_mpc_update.txt">script</a> start playing with the update playlist from the Internet </li><li>  player status display <a href="https://wifiradio.googlecode.com/svn/trunk/openwrt/mpc_show.sh.txt">script</a> </li><li>  <a href="https://wifiradio.googlecode.com/svn/trunk/openwrt/setup_autostart.txt">label of the</a> end of loading the router </li></ul><br><br><h5>  Software </h5><br>  Stellaris is not your Arduin, only UART ports that work freely on the 115200 have 6 of them, which allows you to use two of them as a USB-UART adapter for PCs during debugging.  <b>The first</b> task performed by the MK software is the forwarding of information between the UART1 connected to the router and the UART0, which can be connected to the PC.  <b>The second</b> is the analysis of the passing information and the sending of events to the <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25BD%25D0%25B5%25D1%2587%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D0%25B2%25D1%2582%25D0%25BE%25D0%25BC%25D0%25B0%25D1%2582">state machine</a> including information on the change of the buttons state.  <b>The third</b> is the implementation of a finite state machine with the analysis of incoming messages and changing information on display devices <br><br>  After the start, the MC waits for the signal to finish loading the router, updates the playlist from the Internet (I use <a href="https://www.dropbox.com/">DropBox</a> to store the playlist), restores the sound level and the station, and sends a command to start playing. <br><br>  The proposed <a href="https://code.google.com/p/wifiradio/">scheme</a> and <a href="https://code.google.com/p/wifiradio/source/browse/">code are</a> working, but they were created in pieces within six months, as a result, turned out to be quite muddled and valuable only as a working demo. <br><br><h5>  Manufacturing </h5><br><img src="https://habrastorage.org/storage2/4c8/b33/c65/4c8b33c65bd3d80bdb241fe305c3e9c4.png"><br>  <i>The donor, an unknown miracle of the Chinese industry of the beginning of the century.</i> <br>  From the old radio tape recorder removed all the equipment except the speakers and the board with buttons.  You can try to save the audio amplifier and power if you have time and inspiration. <br><img src="https://habrastorage.org/storage2/eb3/41d/5cb/eb341d5cb76163738d931fe68dfc9501.png"><br>  <i>Gut.</i> <br>  After a corresponding revision of the hull, it is stuffed with new equipment: <br><img src="https://habrastorage.org/storage2/2b1/9dd/194/2b19dd194cc134dbdeadba66ef3a5596.png"><br>  <i>Stuffing</i> <br><img src="https://habrastorage.org/storage2/7dc/c93/0c0/7dcc930c04d80879887b2326147ce04c.png"><br>  <b>Router fee (1)</b> <br>  I got the famous <a href="http://www.asus.com/Networking/WL500gP_V2/">Asus WL-500gP V2</a> , got for the beer due to problems on the WAN port, which did not affect the work as a WiFi host.  Theoretically, the router should be suitable for anyone with the ability to install OpenWrt and a USB port. <br>  <b>USB sound card (5)</b> <br>  I ordered one like the one shown in the picture and it works, moreover, <a href="http://www.asus.com/Sound_Cards_and_DigitaltoAnalog_Converters/Xonar_U3/">Asus Xonar U3</a> was successfully tested, but it didn‚Äôt give the expected improvement in sound quality.  I suspect in connection with low bitrate and quality of the audio path.  Another tested Chinese USB sound card, in a transparent case without buttons, refused to work, despite the fact that everything was fine on the PC, the reason is unknown. <br>  <b>Audio amplifier (4)</b> <br>  I ordered it on EBay on the principle of "sho cheaper."  I cannot recommend it because of strong high-frequency noise, although the resistors connected in series with the speakers helped to reduce them to an acceptable level while maintaining a sufficient volume level. <br>  <b>Display Devices</b> <br>  When building a radio according to this scheme, it is enough to use a pair of LEDs to indicate the status or navigate through the LEDs of the router, but so that the MK resources do not idle, I ordered this <b>OLED screen (3)</b> .  The screen is wonderful - compact and contrasting, but too small, especially if it is supposed to be operated by people with poor eyesight.  Therefore, a <b>seven-segment indicator with a controller (6)</b> showing the most important information in my opinion - the number of the selected station was added to the design. <br>  <b>Motherboard</b> <br>  <b>MK (2)</b> , <b>memory (7)</b> and connectors to peripheral devices I connected on a breadboard.  The reason for the choice of external memory was a message about the bug with flash memory in early versions of stellaris, which significantly reduces the number of rewrite cycles.  Without a memory chip, you can do or use the internal MK flash, but this will require software refinement. <br>  <b>Nutrition (8)</b> <br>  The router requires 5v 2a, the amplifier 12v &lt;1a, I ordered two separate power supplies.  I suspect that there is a more accurate solution and will meet with pleasure in the comments. <br>  <b>Control devices (buttons)</b> <br>  The design of my car stereo made it possible to use my motherboard with buttons after appropriate modification.  Hope you get lucky also. <br><img src="https://habrastorage.org/storage2/48e/942/ce0/48e942ce0a823efe7e6630a6549228a9.png"><br>  <i>Is done</i> <br><br><h5>  Accounting </h5><br><table><tbody><tr><td>  one </td><td>  ASUS WL-500g Premium V2 </td><td>  $ 10 (dead WAN port) </td></tr><tr><td>  2 </td><td>  EK-LM4F120XL Stellaris LM4F120 LaunchPad Evaluation Board </td><td>  $ 7.99 (now) </td></tr><tr><td>  3 </td><td>  New 3.3V 0.96 "128X64 OLED LCD LED Display Module Shield white Color SSD1306 </td><td>  $ 8.74 </td></tr><tr><td>  four </td><td>  10W Mini HIFI 12V Digital power amplifier Stereo High power amplifier Board </td><td>  $ 4.99 </td></tr><tr><td>  five </td><td>  USB2.0 To 3.5mm Audio Microphone Speaker Port Adapter 7.1 Channel 3D Sound Track </td><td>  $ 2.08 </td></tr><tr><td rowspan="2">  6 </td><td>  0.56 "LED 7 Segment 4 Digit Common cathode MAX7219 arduino Blue White Green </td><td>  $ 3.68 </td></tr><tr><td>  MAX7219 </td><td>  $ 0.45 </td></tr><tr><td>  7 </td><td>  AT25040A </td><td>  ~ $ 1 </td></tr><tr><td rowspan="2">  eight </td><td>  Switch Power Supply Driver Strip Strip Light AC 110 / 220V 5V 2A 10W </td><td>  $ 8.16 </td></tr><tr><td>  12V 1A 12W DC Switch Power Supply Driver </td><td>  $ 4.99 </td></tr></tbody></table><br><br><h5>  Stellaris </h5><br>  Stellaris pleased with the wide possibilities and good documentation, but left the impression that the product is damp.  As with the iron, which is probably due to the fact that I used the board from the pre-order, and from the software.  At the same time, the community is not too large compared to the same arduin, which means that taking a step away from the examples proposed by TI, you find yourself in a minefield of riddles and bugs armed only with documentation and sources. <br>  So for example, it turns out that using UART above 2 requires making changes to the library code.  PB7 and PD1 pins were shorted on my board, although this is probably a consequence of my not very correct experiments.  It was not possible to get custom buttons and other not critical but annoying little things to work. <br><br><h5>  What remains unrealized: </h5><br><ul><li>  Tighten the control through the IR remote control, the benefit of the pins and computing power of the MC is enough. </li><li>  To start through the relay on the MK the power management of the router that will allow to realize the "sleep" mode and, if necessary, to reset the router. </li><li>  Adjust NTP and display exact time. </li><li>  Implement a timer to automatically turn off the radio after 4-5 hours of play </li><li>  Add a hard drive with a collection of music and the ability to use it in the absence of the Internet. </li><li>  Add the ability to use multiple playlists and a button to switch between them. </li><li>  Replace the volume and station buttons with rotary switches from old mice. </li></ul><br><br><h5>  findings </h5><br>  All set primary and secondary goals achieved.  The successful experience of operating the device for several months proves the correctness of the chosen solutions. <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/ijiHIHN7zNk%3Ffeature%3Doembed&amp;xid=17259,15700023,15700043,15700186,15700190,15700253&amp;usg=ALkJrhjENvRKl2_sA3CaFN2daO0INUwcoA" frameborder="0" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/190422/">https://habr.com/ru/post/190422/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../190402/index.html">Square Enix forbade the artist to sell printed 3D-figures of characters of Final Fantasy VII</a></li>
<li><a href="../190404/index.html">Leap Motion Review</a></li>
<li><a href="../190406/index.html">Perl6 - Exception Handling</a></li>
<li><a href="../190412/index.html">Continuous integration for the smallest</a></li>
<li><a href="../190414/index.html">Small survey about operating systems</a></li>
<li><a href="../190424/index.html">ICANN rejects google no dotted idea</a></li>
<li><a href="../190428/index.html">Modification of stock firmware for Android. Part 4</a></li>
<li><a href="../190434/index.html">Quick view comments on Habr√©</a></li>
<li><a href="../190436/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ70 (August 11 - 17, 2013)</a></li>
<li><a href="../190438/index.html">MakerBot 3D scanner goes on sale next week</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>