<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring TeamCity in Azure - a constantly available system for team work in the cloud</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article continues the cycle begun by our friends from Kaspersky Lab and describes the actual experience of using Microsoft testing tools (and not...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring TeamCity in Azure - a constantly available system for team work in the cloud</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  <em>This article continues the cycle begun by our friends from Kaspersky Lab and describes the actual experience of using Microsoft testing tools (and not only) with recommendations and conclusions.</em>  <em>The author is a testing engineer, Igor Shcheglovitov (@ ins4n3 on Habr√©).</em>  <em>Our testing articles are tagged with <a href="http://habrahabr.ru/search/%3Fq%3D%255Bmstesting%255D%26target_type%3Dposts">#mstesting</a> .</em> </blockquote><br>  In this article, I would like to share my first experience of setting up the Continuous Integration process using the popular TeamCity system, on a virtual machine in Azure.  This is good because we will always have our system available with convenient access and control over resources. <br><br><img src="https://habrastorage.org/files/bd8/b76/9ef/bd8b769ef62942d6894fca620b024308.png"><br><a name="habracut"></a><br>  The following actions will be described: <br><ul><li>  TeamCity server configuration </li><li>  creating a cloud agent image. </li><li>  setting up local git. </li><li>  Create a web site in Azure. </li><li>  build setup </li><li>  add and launch cloud agents </li><li>  work check </li></ul><br><br>  Let's start in order. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  TeamCity server configuration </h4><br><br>  We will deploy TeamCity server on a new virtual machine: <br><br>  Let's create a new VM in Azure. <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/2tr1z1hhks6vgk9w6e66kbo"><br><br>  Open port 80 on it (it will be used by the TeamCity server). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/948/51e/8b6/94851e8b6d178c4e2b946ec33620dec7.png"><br><br>  Let's add a console to our VM via Azure (it will be used to store TeamCity server data). <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/wbdfmo56k3_nyyx53pg063o8"><br><br>  Connect to the newly created VM via RDP and <a href="http://www.jetbrains.com/teamcity/download/index.html">download the TeamCity distribution</a> <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/1j16l9ypc88rny8bppnbhxbui"><br><br>  Open Disk Management and initialize the new disk. <br><br>  Install TeamCity, selecting only server components in the process. <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/jddir8nz3jts7bgq22dm-fsw"><br><br>  Next, as the TeamCity Data Directory, we specify the new disk. <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/xr4jpfd1lyrap2__79sbv_qj"><br><br>  Install the TeamCity server port (we will use the 80th port) <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/125dmub_5l6uc796s6gruu_6f"><br><br>  And we will select the user from under which the TeamCity service will work (I specified System) <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/1q0xfptklc6aajj5d464h-xfj"><br><br>  After installation, open <a href="http://localhost/mnt">http: // localhost / mnt</a> and start the process of automatic server configuration. <br>  After clicking the Proceed button, select the TeamCity database type (in this example, use the Internal database). <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/gdvq746vke4kcku-09ojdznt"><br><br>  Next, the initialization of the database will begin, after which the TeamCity server administrator should be created. <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/vq42xkv9bldsficc633vp6vd"><br><br>  Open FW port 80. <br><br><h4>  Creating a cloud agent image </h4><br><br>  Not so long ago, JetBrains announced a <a href="http://blog.jetbrains.com/teamcity/2014/11/introducing-teamcity-azure-plugin-run-builds-in-the-cloud/">plugin</a> that automatically allows you to create and run TeamCity cloud agents in Azure.  During agent startup, using this plugin, a new virtual machine is created.  You can stop the cloud agent at any time, which will lead to the release of resources and, consequently, to savings :) We will use cloud agents.  Cloud agents are created based on a previously prepared image of the virtual machine. <br><br>  So: <br>  We create the new virtual machine in Azure.  We will create a build for the ASP.NET site that will be created in Visual Studio 2013, and we will use MsTest to run the tests.  Although you can use other tools.  It does not matter.  We will need to install Visual Studio on the agent (I have installed Community 2013. If you have a free subscription, then you will not find an image with a pre-installed studio in the virtual machines gallery and then you will need to install it manually). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f76/472/b34/f76472b3425547c0bc14fef54d9b114b.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/21d/e87/a7b/21de87a7b5845c6f8cf41fe34bdd6d84.png"><br><br>  You should also open port 9090. This is the default port that the agent listens on. <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/2mnui104p8-5evtfoho67yuj"><br><br>  Connect via RDP to the created VM.  <a href="http://git-scm.com/download/win">Download and install Git for Windows</a> .  During installation, check <b>Use Git from the Windows Command Prompt</b> <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/q65cq46ge0fb5x8tgqj_q8nh"><br><br>  Specify the server port TeamCity <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/125dmub_5l6uc796s6gruu_6f"><br><br>  Set agent parameters: <br>  <b>serverUrl</b> - TeamCity server address <br>  <b>workDir</b> <b>and</b> <br>  <b>tempDir</b> can be left by default, but I usually use a special disk (Temporary Storage) on the VM for these variables. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a67/84f/12b/a6784f12b37f858c6b021915b44b31d9.png"><br><br>  Open port 9090 for incoming connections either via FW or with the command: <br>  <i>netsh advfirewall firewall add rule name = "</i> <i>TeamCityAgent</i> <i>In" dir = in action = allow protocol = TCP localport = 9090</i> <br><br>  I noticed that after creating a cloud agent (from the moment of launching the VM) it just hangs during the initialization stage and does not connect to the TeamCity server.  Perhaps this is a bug in the technical implementation of the JetBrains plugin itself, or maybe even where the problem is.  But, if you connect to the agent via RDP and restart the agent service manually, the agent will work.  I decided to automate this process.  Here is an example of how this can be done very simply: <br>  Open the Local Group Policy Editor (gpedit.msc) <br>  Add a new Startup powershell script <br><br>  <i>get-service "TeamCity Build Agent" |</i>  <i>restart-service -PassThru</i> <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/32j5uy6tw1-wsyctt_-ns0dg"><br><br>  Next, you need to stop the VM through the portal and create an image of the virtual machine based on it: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c0a/228/99a/c0a22899a3add9d064a90e2c896ff6f2.png"><br><br>  After that, remove the VM. <br><br><h4>  Configure local git </h4><br><br>  Let's create a new repository in GitHub. <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/iei5hod77uvlqjrgi3fp2a1o"><br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/clo_xzldpjjh5rl_rldpt353"><br><br>  And copy the link to it: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/90a/5eb/592/90a5eb592fff319f440ee3d988259e15.png"><br><br>  Install GIT on a local machine (from where security checks will be made).  Create a new folder that will act as a local copy of the code repository.  After that, we link the local folder with GitHub - using the command line, go to the created folder and execute the git clone {gitRepositoryUrl} command. <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/8bysscr-t37ouzou0d-xwm6r"><br><br>  If you work from a corporate network, then the clone team may fall off due to problems with the proxy.  I was able to configure and bypass this communication problem only by installing a local NTLM proxy server, which forwarded requests to the corporate proxy.  The distribution of the proxy server can be found <a href="http://cntlm.sourceforge.net/">here</a> . <br>  After successful configuration, you should configure the proxy for Git, for this you need to run the following commands: <br><br>  git config --global http.proxy <a href="http://localhost/">localhost</a> : {cntlm-proxy-port} <br>  git config --global https.proxy <a href="https://localhost/">localhost</a> : {cntlm-proxy-port} <br><br>  After cloning the repository in the project folder (GIT), create a new solution in Visual Studio (ASP.NET Web Form Project + UnitTestProject) <br>  Perform Commit and Push changes right in the studio. <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/1scw3-kwjs3c0nv66zzcqo0p8"><br><br>  After that, your new checkin will appear in GitHub. <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/n9yrwbsbqi0zb19gb09hmgz6"><br><br>  Note: you can commit changes using the git command in the command line <br>  git add.  (add files to Git repository) <br>  git commit ‚Äìam ‚ÄúTest commit.‚Äù (commit commit) <br>  git push {git-url} (Push changes from local storage to GitHub) <br><br><h4>  Creating a web site in Azure </h4><br><br>  Via Azure console create new empty web site <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/ylo22g_p0i1lic5j151r_xzy"><br><br>  After creating the site, click the ‚ÄúConfigure version control deployment‚Äù link and link the GitHub repository with the new site. <br>  Open the site settings.  On the settings tab, we are interested in: <br>  <i>Url</i> <i>address</i> <i>git</i> <br>  <i>Url</i> <i>address to start deployment</i> <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/1740110p215iojmo79_liztre"><br><br>  If, in the first URL, replace deploy with cifromgittestsite.git and transfer the resulting link to the git push command, you get the command to launch the web site deployment. <br><br>  git.exe push -f address <br><br>  Next, you need to disable automatic deployment from GitHub.  If this is not done, each checkin will result in an automatic deployment of the site.  And our goal to implement CI is to execute deployment only if the code is successfully assembled and the unit of tests run. <br><br><h4>  Build setup </h4><br><br>  Open the UI TeamCity (http: // TeamCityServerDns) and create a new project (Create Project). <br><br><img src="http://litehtmlconv.azurewebsites.net/api/pics/13i2-ljnxvwg61nbngq3bqojw"><br><br>  Set the project name.  Add a new build configuration (Create Build Configuration) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/315/9b7/e18/3159b7e18a4c3c3c3470a5b74b4e2f06.png"><br><br>  Specify the configuration name <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8b7/afe/74c/8b7afe74c3a7f803c81ae1ea0385fe82.png"><br><br>  Configure VCS (version control system).  Here you need to fill in the VCS type (Git), the name, Fetch URL (Read only the URL of your repository just notice the https or http protocol on git from the repository access link), specify the branch (I only have the master), and specify the path to git. exe on agent <br><br><img src="https://habrastorage.org/getpro/habr/post_images/73c/116/100/73c116100ccad37ed69e82cd466b800b.png"><br><br>  After configuration, you can click TestConnection and check that the connection to the GitHub repository is successful. <br>  After successfully setting up VCS in CheckOut Options, you must specify VCS checkout mode - Automatically on agent. <br>  Choose Build Steps and add (add build step) our build steps. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b19/225/2f4/b192252f474558c5cc59f40b2139fa6d.png"><br><br>  The first step is the assembly of our solyushin.  Here you need to fill in everything as in the screenshot: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ffa/691/900/ffa691900145943900b3067b1b5a2403.png"><br><br>  The second step is to run the tests: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/04d/27c/0a4/04d27c0a4458130c0091a0da0b31e4b4.png"><br><br>  The third step is deployment (the deployment team was formed during the site setup process) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e7c/049/f40/e7c049f409a486e900bab81b1d7e8e9c.png"><br><br>  You should have something like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2cd/950/9a1/2cd9509a125326fe50c01a635d9c9682.png"><br><br>  Create a new trigger.  Here we mark the checkbox Trigger a build on each check-in. <br><br><h4>  Adding and running cloud agents </h4><br><br>  Connect via RDP to the TeamCity server virtual machine.  <a href="https://github.com/JetBrains/teamcity-azure-plugin">Download plugin for managing cloud agents</a> . <br>  Put the plugin in the folder F: \ plugins (disk F - TeamCityDataDirectory) and restart the TeamCity Server service. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3aa/019/985/3aa019985610f2b18c8226f5e11ffe32.png"><br><br>  Open TeamCity UI (menu Administrations =&gt; Plugins Lists). <br>  A new plugin <b>called Azure</b> <b>integrations</b> should appear in the list of plugins. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1f4/32c/e95/1f432ce95b4d1fec03cdd0cf011d8ff0.png"><br><br>  Next, create a new empty Cloud Service through Azure console, which will act as a repository for storing the instances of the TeamCity agents. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/59b/da5/181/59bda5181a272dcd2b310dc9ef0ba0a1.png"><br><br>  Let's go to Administration =&gt; Global Settings and write the correct full DNS TeamCity server: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ad1/a24/e54/ad1a24e54d997ed5f19a179a453ebcce.png"><br><br>  Let's move on to creating a new cloud agent profile. Administration =&gt; Agent Cloud =&gt; Create new profile <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d62/854/a6e/d62854a6e52f82664837a390d0d03711.png"><br><br>  Here you should set the profile name, cloud type - Azure, certificate of management and SubscriptionId from your Azure subscription (this data can be downloaded at <a href="https://manage.windowsazure.com/publishsettings">https://manage.windowsazure.com/publishsettings</a> ) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d1a/43b/0a1/d1a43b0a1ea665fb71ce996aa5c13110.png"><br><br>  After filling in the basic profile settings, click Add images and specify the cloud agent virtual machine image name, empty cloud service name, maximum number of agents, agent size, and prefix of the name of the created agents <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dc4/4e7/476/dc44e74762da9100d4917924099f01f3.png"><br><br>  <i>Note.</i>  <i>The number of agent instances depends on the number of</i> <i>ports</i> <i>opened in the</i> <i>firewall</i> <i>on the cloud image of the virtual agent.</i> <br>  <i>Example</i> <i>:</i> <i>if the agent has a default port, i.e.</i>  <i>9090,</i> <i>if</i> <i>you open only port 9090</i> <i>in the</i> <i>firewall</i> <i>, you can create only one agent, but if you have a range from 9090-9099 in your image,</i> <i>you can create 10 agents.</i> <br><br>  After saving the settings, TeamCity will automatically launch a new cloud agent. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dcf/7f1/f9a/dcf7f1f9abae19691912f529fc9075fb.png"><br><br>  Agent management menu Agents =&gt; Cloud Agent, you can manage agents. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7c0/aa1/3e8/7c0aa13e8d2a7839780e897edc69e0ca.png"><br><br>  The agent will automatically create a virtual machine during the startup process: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f80/6e2/7b5/f806e27b5770974dcf407ddd14c8abaa.png"><br><br><h4>  Operation check </h4><br><br>  Everything is created and configured.  Now we can proceed to check our build. <br>  To do this, in the Projects menu, you can click Run. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c13/445/95f/c1344595f8d0881a1209067c4608194e.png"><br><br>  If you look at the build logs, you will see that the code is being downloaded from GitHub, it is being built, then unit tests are run, and if everything is successful, then the deployment starts. <br>  We have created a build trigger, so  if we check in new github changes, <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5bc/296/f4d/5bc296f4d1dd642961e9b03b81daff97.png"><br><br>  then our build will start automatically and in a few minutes - the build will automatically assemble, run tests and automatically secure the site in Azure <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cbd/fdd/24d/cbdfdd24db7c9b9fe06e3fd43125f24b.png"></div><p>Source: <a href="https://habr.com/ru/post/252023/">https://habr.com/ru/post/252023/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252013/index.html">Atomic reactor in every site</a></li>
<li><a href="../252015/index.html">Overview of glands for practicing robotics with children - 2</a></li>
<li><a href="../252017/index.html">DevCon 2015 Conference: Internet of Things in the World of Living Code</a></li>
<li><a href="../252019/index.html">5 demons in the soul of a support worker</a></li>
<li><a href="../252021/index.html">We write a multiplayer chat on C # in 15 minutes</a></li>
<li><a href="../252025/index.html">How to simplify the life of iOS developer</a></li>
<li><a href="../252027/index.html">Google decided to wait with Android data encryption by default</a></li>
<li><a href="../252029/index.html">Using npm to globally install GUI-based applications based on nw.js</a></li>
<li><a href="../252031/index.html">Game Storm Business games</a></li>
<li><a href="../252033/index.html">20 new free courses virtual academy Microsoft Virtual Academy, March 2015</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>