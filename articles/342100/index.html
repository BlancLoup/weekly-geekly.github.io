<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Universal smart multi-signature contract in Ethereum</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few days ago, we at BitClave read about the recent incident with the multi- subscription wallets of Parity Technologies , we decided to look at the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Universal smart multi-signature contract in Ethereum</h1><div class="post__text post__text-html js-mediator-article">  A few days ago, we at <a href="https://bitclave.com/">BitClave</a> read about the recent <a href="https://medium.com/%40ParityTech/security-alert-1fe9d015f1ba">incident with the multi-</a> <a href="https://bitclave.com/">subscription</a> <a href="https://medium.com/%40ParityTech/security-alert-1fe9d015f1ba">wallets</a> of <i>Parity Technologies</i> , we decided to look at the code of their smart contract.  <a href="https://blog.zeppelinos.org/parity-wallet-hack-reloaded/">A</a> recent blog post from <i>Zeppelin Solutions</i> describes the incident in detail from the technical side, so we would like in our article to focus more on the principles of designing smart contracts. <br><br><img src="https://habrastorage.org/webt/jb/me/yx/jbmeyx7aep8zmlgatsmyiy_oqs8.jpeg" alt="Ethereum wallet"><br><a name="habracut"></a><br>  There are several widely known principles of OOP included in the abbreviation <b><a href="https://en.wikipedia.org/wiki/SOLID_%2528object-oriented_design%2529">SOLID</a></b> : <br><br><ul><li> <a href="https://en.wikipedia.org/wiki/Single_responsibility_principle"><code><b>S</b></code> ingle responsibility principle</a> </li><li>  <a href="https://en.wikipedia.org/wiki/Open/closed_principle"><code><b>O</b></code> pen / closed principle</a> </li><li>  <a href="https://en.wikipedia.org/wiki/Liskov_substitution_principle"><code><b>L</b></code> iskov substitution principle</a> ( <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B8%25D0%25BD%25D1%2586%25D0%25B8%25D0%25BF_%25D0%25BF%25D0%25BE%25D0%25B4%25D1%2581%25D1%2582%25D0%25B0%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B8_%25D0%2591%25D0%25B0%25D1%2580%25D0%25B1%25D0%25B0%25D1%2580%25D1%258B_%25D0%259B%25D0%25B8%25D1%2581%25D0%25BA%25D0%25BE%25D0%25B2">Barbara Liskov</a> <a href="https://en.wikipedia.org/wiki/Liskov_substitution_principle">substitution principle</a> ) </li><li>  <a href="https://en.wikipedia.org/wiki/Interface_segregation_principle"><code><b>I</b></code> nterface segregation principle</a> </li><li>  <a href="https://en.wikipedia.org/wiki/Dependency_inversion_principle"><code><b>D</b></code> ependency inversion principle</a> </li></ul><br>  There are many supporters and opponents of using these principles, but we looked at many libraries in <i>Solidity</i> and came to the conclusion that the approach of <i>Zeppelin Solutions</i> is the most convenient and secure.  Their library, <a href="https://openzeppelin.org/">OpenZeppelin.org,</a> provides many small smart contracts that can be compiled to achieve a more complex <a href="https://en.wikipedia.org/wiki/Mixin">mixin</a> <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B8%25D0%25BC%25D0%25B5%25D1%2581%25D1%258C_(%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)">pattern</a> through the use of multiple inheritance in the Solidity language.  You need to decompose the responsibilities of your final smart contract into multiple smart contracts <b>with the only responsibilities</b> ‚Äî each smart contract should serve a single purpose.  Moreover, you will most likely find some of the contracts you need in libraries like the one offered by <i>Zeppelin Solutions</i> .  In addition, you can also test each of the contracts separately. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Guided by these principles, we have developed smart contracts for the sale of tokens: <a href="http://github.com/bitclave/crowdsale">github.com/bitclave/crowdsale</a> .  You can see <b><code>BonusCrowdsale</code></b> and <b><code>TokensCappedCrowdsale</code></b> smart contracts in the repository, which were designed to handle such aspects of our sales as the processing of participants' bonuses depending on the time and amount of investment, as well as to control the total number of tokens sold.  We received a rather laudable review of the smart contract security auditor for our code: <br><br><blockquote>  <i>‚ÄúExcellent work on reusing existing OpenZeppelin library contracts!</i>  <i>Additional contracts look very thoughtfully designed and look like a good extension of this framework "(" Great work reusing the existing OpenZeppelin libraries! The additional contracts are very thoughtfully designed, and Zeppelin Solutions.</i>  <i>The full conclusion can be found on the <a href="https://blog.zeppelin.solutions/bitclave-token-audit-570b0c664eb0">link</a> .</i> </blockquote><br>  In order to successfully apply these principles in practice, it is necessary to clearly understand how multiple inheritance works.  In fact, the Solidity compiler converts multiple inheritance into single inheritance.  In this way, after compilation, each smart contract will have only 1 parent, which can be accessed through the <b><code>super</code></b> keyword.  Perhaps the following example will additionally help to understand how the <a href="http://solidity.readthedocs.io/en/develop/contracts.html">linearization of C3 multiple inheritance</a> works: <br><br><pre> <code class="javascript hljs">contract A { } contract B { } contract C is A, B { } <span class="hljs-comment"><span class="hljs-comment">// C(A,B) = ABC contract D is C, A { } // D(C(A,B),A) = D(ABC,A) = ABCAD !!! Error !!! contract E is A, C { } // E(A,C(A,B)) = E(A,ABC) = ABCE</span></span></code> </pre><br>  The problem is that smart contract <b><code>A</code></b> cannot redefine <b><code>C</code></b> , because <b><code>C</code></b> redefines <b><code>B</code></b> , which in turn redefines <b><code>A</code></b> : <br><br><pre> <code class="hljs pgsql">TypeError: Linearization <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> inheritance graph impossible contract D <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> C, A { } ^ ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ^ Compiliation failed. See above.</code> </pre><br>  It is also necessary to take into account that any direct inheritance of contracts can be prevented in the process of inheriting child classes.  Notice how the following example compiles the contract <b><code>W</code></b> , and its parent contract <b><code>Z</code></b> becomes the successor of the contract <b><code>Y</code></b> (which is the successor of <b><code>X</code></b> ), instead of directly inheriting from <b><code>X</code></b> : <br><br><pre> <code class="javascript hljs">contract X {} contract Y is X {} <span class="hljs-comment"><span class="hljs-comment">// Y(X) = XY contract Z is X {} // Z(X) = XZ contract W is Y, Z {} // W(Y(X),Z(X)) = W(XY, XZ) = XYZW</span></span></code> </pre><br>  Returning to the <i>Parity Technologies</i> multi-signature wallet smart contract, we noticed that it was not decomposed at all.  The only architectural solution noted by us: the removal of the common code of all wallets in a single library in order to reduce the cost of loading the contract.  By the way, it was this feature that allowed a random developer to disrupt the work of all wallets by breaking down a single library with common code.  We reflected on the topic of multiple ownership of the resource and prepared our solution to this problem in the manner of the <i>OpenZeppelin</i> libraries.  We are pleased to present you the <a href="https://github.com/bitclave/Multiownable">Multiownable.sol</a> contract, which will allow you to easily add multi-signature functionality to any of your contracts.  Its use is as simple as using the usual <b><code>Ownable</code></b> contract ‚Äî you just need to follow it and add <b><code>onlyAnyOwner</code></b> and <b><code>onlyManyOwners</code></b> to the necessary functions: <br><br><pre> <code class="javascript hljs">contract SimplestMultiWallet is Multiownable { bool avoidReentrancy = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">payable</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transferTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">address to, uint256 amount</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onlyManyOwners</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(!avoidReentrancy); avoidReentrancy = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; to.transfer(amount); avoidReentrancy = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }</code> </pre><br>  The <b><code>transferTo</code></b> method of the smart contract will be called only after all the wallet owners call it with the same arguments.  You will not believe it, but this is the complete code of the simplest multi-signature wallet for the Ether currency.  Additionally, you can implement support for any tokens compatible with the ERC20 specification, this is the following method: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transferTokens</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">address token, address to, uint256 amount</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onlyManyOwners</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(!avoidReentrancy); avoidReentrancy = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; ERC20(token).transfer(to, amount); avoidReentrancy = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre><br>  We will be glad to any feedback of the community: <a href="https://github.com/bitclave/Multiownable">github.com/bitclave/Multiownable</a> <br><br>  <b>PS</b> Updated the example with the latest library changes - added protection against nested calls, in case the recipient is a contract that has a <b><code>transfer</code></b> method. </div><p>Source: <a href="https://habr.com/ru/post/342100/">https://habr.com/ru/post/342100/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342088/index.html">How to increase the level of service and increase the profits of companies using communication solutions</a></li>
<li><a href="../342090/index.html">Java nested classes</a></li>
<li><a href="../342094/index.html">Export data in any format: what IDE can do on IntelliJ platform</a></li>
<li><a href="../342096/index.html">How to discover a million dollars in your AWS account</a></li>
<li><a href="../342098/index.html">Testing through the eyes of the developer: tools, myths, situations</a></li>
<li><a href="../342102/index.html">Technical features of the ICO. Start</a></li>
<li><a href="../342104/index.html">In five days I was interviewed at five Silicon Valley companies and received five job offers</a></li>
<li><a href="../342106/index.html">Just about D3.js</a></li>
<li><a href="../342108/index.html">Guide to creating your own cohort recurrence report</a></li>
<li><a href="../342110/index.html">4 words</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>