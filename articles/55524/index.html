<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Protect USB flash drive from writing new files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I continue to develop the topic of protecting flash drives from viruses (I previously published materials AUTOSTOP - a script to protect flash drives ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Protect USB flash drive from writing new files</h1><div class="post__text post__text-html js-mediator-article">  I continue to develop the topic of protecting flash drives from viruses (I previously published materials <a href="http://habrahabr.ru/blogs/infosecurity/53642/">AUTOSTOP - a script to protect flash drives from autorun viruses</a> and <a href="http://habrahabr.ru/blogs/infosecurity/54187/">Panda USB and AutoRun Vaccine - a remedy for autorun viruses on a flash drive</a> - there it was mainly about protecting flash drives from writing to it malicious file autorun.inf).  The topic is interesting because the cleaning of viruses on a computer is a struggle against the investigation, and the protection of a flash drive from viruses is a measure aimed at eliminating the cause. <br><br>  Protecting a flash drive from writing new files is done by determining the free space on it, followed by its complete filling using the utility <b>fsutil</b> .  This method is great, for example, to protect bootable USB flash drives (with an autorun.inf file) that cannot be protected by creating the AUTORUN.INF directory of the same name. <br><br><img src="http://mechanicus.users.photofile.ru/photo/mechanicus/95320970/105793290.gif" alt="image"><br>  The following is a description of the method, its analysis, and a method of full automation. <br><a name="habracut"></a><br>  The method was not invented by me, it was suggested by the user <a href="http://kpnemo.ru/users/823/">cook</a> , and later found in several specialized sources.  I also developed a convenient automated method for its use, and also (based on an analysis of both its strengths and vulnerabilities), a more accurate name was given, namely ‚Äúprotection from writing new files‚Äù (as opposed to a less accurate name in other sources, ‚Äúprotection from the record "which does not fully reflect the essence of the method). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Way </h4><br>  In the original, to create such a file, use the command: <br><br> <code><font color="green">fsutil file createnew &lt;filename&gt; &lt;length&gt;</font></code> <br> <br>  Fsutil is a command line utility.  To use fsutil, you must be logged in with an administrator account or a member of the administrators group. <br><br>  This method, as it turned out as a result of testing, has 2 minuses: <br><ol><li>  FAT32 has a file size limit (2 ^ 32 bytes, i.e. 4 gigabytes).  Accordingly, a little filled with information 8GB flash drive size (such flash drives today are not so rare) and more so no longer protect </li><li>  Creating large files takes several minutes to complete.  And if you need to remove the security file, add something to the USB flash drive, and then again set the protection?  Time is lost again to create a large file. </li></ol><br><br>  In my automated version, the following code is used (it should be formatted as a bat-file, copied to a USB flash drive and run from there), free from the listed disadvantages: <br><br> <code><font color="green">@echo off <br> setlocal enabledelayedexpansion <br> set /a sizofile=1024 * 1024 * 1024 <br> for /l %%K in (1,1,256) do ( <br> for /f "tokens=3" %%J in ('dir %~d0 /-C') do (set freespace=%%J) <br> if !freespace! EQU 0 goto ready <br> if !freespace! GTR !sizofile! ( <br> call :getime <br> fsutil file createnew "%~d0\[ 1024 Mb ] !randtime!" !sizofile! <br> ) else ( <br> for /l %%K in (1,1,5) do ( <br> for /f "tokens=3" %%J in ('dir %~d0 /-C') do (set freespace=%%J) <br> set /a sizofilemb=!sizofile! / 1024 /1024 / 2 <br> set /a sizofile=!sizofile! / 2 <br> if !freespace! GEQ 67108864 ( <br> if !freespace! GEQ !sizofile! ( <br> call :getime <br> fsutil file createnew "%~d0\[ !sizofilemb! Mb ] !randtime!" !sizofile! <br> ) <br> ) else ( <br> if !freespace! EQU 0 goto ready <br> call :getime <br> fsutil file createnew "%~d0\[ 1-63 Mb ] !randtime!" !freespace! <br> goto :EOF <br> ) <br> ) <br> ) <br> ) <br> <br> :getime <br> set randtime=!time:~-10! <br> set randtime=!randtime::=! <br> set randtime=!randtime:,=! <br> exit /b <br></font></code> <br><br>  The logic of the code is as follows: <br><ul><li>  determines the amount of free space on the flash drive </li><li>  if the free space is greater than 1Gb, create 1Gb files as long as this condition is met </li><li>  When free space is less than 1 gigabyte - we are trying to create files of 512Mb, 256Mb, 128Mb, 64Mb in size and the last file from 1 to 63Mb in size </li></ul><br><br>  As a result, approximately the following file structure is created on the flash drive that fills all free space (the 7-digit unique code at the end of the name of each file is necessary to avoid the error of creating files with the same name): <br><br>  <b>[1-63 Mb] 7344296</b> <b><br></b>  <b>[64 Mb] 7343581</b> <b><br></b>  <b>[256 Mb] 6050959</b> <b><br></b>  <b>[512 Mb] 6043075</b> <b><br></b>  <b>[1024 Mb] 2341570</b> <b><br></b>  <b>[1024 Mb] 2353157</b> <b><br></b> <br><br>  After installing such protection on a USB flash drive, you cannot delete anything from it (including the bat file mentioned above), otherwise the protection will no longer work.  To remove the protection from writing new files (for example, if you need to write something on a USB flash drive), you must delete one or more files created in this way with the minimum required size and record your data.  Restoring protection after this will take minimal time. <br><br><h4>  Analysis </h4><br>  Strictly speaking, such a method cannot be considered a complete analog of the hardware read-only switch found on some types of flash drives.  Even if the flash drive is protected from writing new files by the described method, the virus has the ability <i>to create the</i> autorun.inf file on the flash drive ‚Äî but it will not be able to <i>write</i> anything to this file. <br><br>  It should also be noted that the virus has the ability to hit potentially vulnerable files already contained on the flash drive, due to the remaining free space (due to clustering) allocated for file storage.  But trends in the development of functional viruses suggest that today viruses are less likely to infect individual files, and increasingly exploit the vulnerabilities of the Windows operating system. <br><br>  Thus, such a method can be considered a write protection only in the context of the impossibility of creating non-empty new files on a flash drive.  However, as practice shows, this is a serious measure of protection against autorun viruses.  As mentioned above, this method is excellent for protecting boot flash drives (having an autorun.inf file) that cannot be protected by creating the AUTORUN.INF directory of the same name, as well as for flash drives with a personal set of necessary software that is connected to foreign computers. <br><br>  I would like to say a few more words about the <i>notorious reliability of the</i> protection provided by the hardware switch "Read-only".  There was such a case. <br><br><blockquote>  In the camera of the wife (Canon A610) there is no possibility of displaying the battery charge indicator.  I found <a href="http://chdk.clan.su/">an alternative firmware</a> that has this feature.  I recorded it on a memory card.  The instructions for the firmware say that in order for it to be loaded automatically (rather than starting up with your hands after turning on the camera), you need to switch the switch on the memory card to the ‚ÄúBlocked‚Äù position.  I re-read this point several times - wasn‚Äôt I mistaken.  No - that's right.  I put the switch in the ‚ÄúLock‚Äù position, charge the card to the camera, anticipating that now he curses the impossibility of recording, and ... And nothing happens - all the captured frames are perfectly saved to the memory card, and bad frames can be deleted without any problems.  Draw your own conclusions. </blockquote><br><br><h4>  Concrete implementation </h4><br>  The code for creating the bat file yourself is given above.  But the most convenient is to use the new version 2.4 of my <a href="http://mechanicuss.livejournal.com/195192.html">AUTOSTOP</a> script <a href="http://mechanicuss.livejournal.com/195192.html">.</a> <br><br><img src="http://mechanicus.users.photofile.ru/photo/mechanicus/95320970/105801136.gif" alt="image"><br>  After the creation of each file, it is able to generate a short sound signal through the system speaker, eliminating the need to look every few seconds to see if another file has been created (after all, as you know, the teapot you look at will never boil), but When the protection is installed, a long beep sounds. <br><br>  PS - I remind you that nobody has canceled the protection of a flash drive using the NTFS rights method, but there are times when its use is undesirable for some reason. <br><br>  PPS - thanks to <a href="http://forum.ru-board.com/profile.cgi%3Faction%3Dshow%26member%3DElroir">Elroir</a> for the help in writing the code. </div><p>Source: <a href="https://habr.com/ru/post/55524/">https://habr.com/ru/post/55524/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../55511/index.html">which web service would you pay for?</a></li>
<li><a href="../55512/index.html">CAD Autodesk 2010 in pictures</a></li>
<li><a href="../55514/index.html">Doctor Web discovered an ATM trojan</a></li>
<li><a href="../55516/index.html">Photo posters, or how to sell an artistic photo.</a></li>
<li><a href="../55517/index.html">Searching for methods in squeak smoltok</a></li>
<li><a href="../55525/index.html">Does every day have 24 hours?</a></li>
<li><a href="../55527/index.html">New sound format introduced</a></li>
<li><a href="../55529/index.html">New DaVinci app for Surface</a></li>
<li><a href="../55531/index.html">Making the house noticeable for Google Map satellite</a></li>
<li><a href="../55532/index.html">HotKeys Trainer - we rush over the clave with benefit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>