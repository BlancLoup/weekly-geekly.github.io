<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Database Mail: Mailing Lists Directly From Microsoft SQL Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many people know that starting from version 2005 in SQL Server there is a built-in ability to send emails, which database administrators often use to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Database Mail: Mailing Lists Directly From Microsoft SQL Server</h1><div class="post__text post__text-html js-mediator-article">  Many people know that starting from version 2005 in SQL Server there is a built-in ability to send emails, which database administrators often use to send urgent alerts, for example, when scheduled tasks fail.  However, few know that sending letters to SQL Server is possible directly from SQL queries, functions, and stored procedures.  And if you have already configured mail in SQL Server once, it will take you just a minute to send a letter, and you can organize a whole mailing in 15-20 minutes.  This system is called Database Mail (DBMail), and today I would like to share the experience of its use. <br><a name="habracut"></a><br><h4>  Customization </h4><br>  Before working with DBMail, you must first turn on the system and register in it a mail account (SMTP) from which emails will be sent.  Unfortunately, the IMAP system is not able to work, but in most cases it is not necessary. <br><br>  Configuring DBMail through the SQL Server administrator interface is very well and is described in detail in the article <a href="http://habrahabr.ru/post/132902/">‚ÄúConfiguring Database Mail in MS SQL Server 2005 and later‚Äù</a> , so I will not repeat it.  I think this option will be more convenient for those who set up the system for the first time. <br><br>  I, in turn, will show now an alternative option: how to set up programmatically through a SQL script.  This option is not so visual, but it is faster and more convenient for those who need to configure DBMail on many servers or transfer settings from server to server, in this case it will be enough to simply run this script on a new server.  It is only important not to forget that to use the following scripts you need to log in to the server as a member of the sysadmin group, otherwise the security system will indicate a lack of rights. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's get right to the point.  Here is a script that prepares the server to use DBMail: <br><pre><code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   Service broker -      -- ,  DBMail IF (SELECT is_broker_enabled FROM sys.databases WHERE [name] = 'msdb') = 0 ALTER DATABASE msdb SET ENABLE_BROKER WITH ROLLBACK AFTER 10 SECONDS GO --    DBMail sp_configure 'Database Mail XPs', 1 GO RECONFIGURE GO</span></span></code> </pre> <br>  Next, you need to check whether the DBMail service is running: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> msdb.dbo.sysmail_help_status_sp</code> </pre><br>  And if it is not running (its status is not ‚ÄúSTARTED‚Äù), then start it with a query <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> msdb.dbo.sysmail_start_sp</code> </pre><br>  Now you need to create an SMTP account to send emails, create a mailing list administrator profile and connect an SMTP account to this profile.  Suppose that the administrator of the MySite.ru site needs to organize a mailing list for registered users of his site, and for this he uses his mailbox admin@mysite.ru on the smtp.mysite.ru server. <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--  SMTP-    EXECUTE msdb.dbo.sysmail_add_account_sp --   @account_name = 'admin@mysite.ru', --    @description = N'  admin@mysite.ru', --   @email_address = 'admin@mysite.ru', -- ,      ":" @display_name = N' MySite.ru', -- ,        --    ,   "no-reply" @replyto_address = 'no-reply@please.no-reply', --   IP- SMTP- @mailserver_name = 'smtp.mysite.ru', --  SMTP-,  25 @port = 25, --  .       --        @username = 'admin', --     @password = 'MyPassword', --  SSL  ,  SMTP-   SSL @enable_ssl = 1; --      EXECUTE msdb.dbo.sysmail_add_profile_sp @profile_name = 'MySite Admin Mailer'; --  SMTP-    EXECUTE msdb.dbo.sysmail_add_profileaccount_sp @profile_name = 'MySite Admin Mailer', @account_name = 'admin@mysite.ru', --   SMTP-   @sequence_number = 1; --        DatabaseMailUserRole  MSDB EXECUTE msdb.dbo.sysmail_add_principalprofile_sp @profile_name = 'MySite Admin Mailer', @principal_id = 0, @is_default = 1;</span></span></code> </pre><br>  For reliability, it is recommended to create a pair of SMTP accounts for two different mail services and connect them to the profile.  This will allow you to send an important letter even if there is no connection with one of the SMTP servers.  In this case, for the priority SMTP account, the parameter @sequence_number of the procedure sysmail_add_profileaccount_sp must be equal to 1 (see above), for the spare account the parameter must be equal to 2. <br><br>  It is recommended to mass mailing from the private domain mailbox.  When trying to send from domains to public domains (mailboxes on yandex.ru, mail.ru, gmail.com, etc.), SMTP servers may consider you a spammer and block the mailing list or even the entire mailbox. <br><br><h4>  Firewall </h4><br>  Direct sending letters to SQL Server will be engaged in a separate program.  In different versions of SQL Server, it is called ‚ÄúDatabaseMail90.exe‚Äù or ‚ÄúDatabaseMail.exe‚Äù and, by default, is located in the ‚ÄúC: \ Program Files \ Microsoft SQL Server \ ... \ MSSQL \ Binn \‚Äù folder.  It is important not to forget to allow outgoing traffic for it in the firewall (firewall). <br><br><h4>  Test letter </h4><br>  It's time to try, is everything in order.  Any user from the sysadmin group, the owner of the database (db_owner) MSDB, or a user with the DatabaseMailUserRole role can send a test letter.  To add the DatabaseMailUserRole role to a user, use the standard sp_addrolemember procedure: <br><pre> <code class="sql hljs">sp_addrolemember @rolename = 'DatabaseMailUserRole', @membername = '&lt;_&gt;';</code> </pre><br>  Now let's send a test email: <br><pre> <code class="sql hljs">EXEC msdb.dbo.sp_send_dbmail <span class="hljs-comment"><span class="hljs-comment">--       @profile_name = 'MySite Admin Mailer', --   @recipients = 'friend@mysite.ru', --   @body = N'  SQL Server Database Mail', --  @subject = N' ', --        SQL- @query = 'SELECT TOP 10 name FROM sys.objects';</span></span></code> </pre><br>  Additional parameters of the sp_send_dbmail procedure can be found in its <a href="http://msdn.microsoft.com/en-us/library/ms190307(v%3Dsql.105).aspx">description in MSDN</a> . <br><br>  If something is wrong, you first need to look at the status of the letter: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> msdb.dbo.sysmail_allitems</code> </pre><br>  And then look at the log: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> msdb.dbo.sysmail_event_log</code> </pre><br>  The most typical problems are discussed in the MSDN article <a href="http://msdn.microsoft.com/en-us/library/ms188663(v%3Dsql.105).aspx">‚ÄúTroubleshooting Database Mail‚Äù</a> , as well as in the article <a href="http://dbatasks.blogspot.co.uk/2012/11/troubleshooting-database-mail-part-ii.html">‚ÄúSQL Server tasks for DBAs: Troubleshooting Database Mail‚Äù</a> . <br><br>  Successfully sent letters can be viewed with the following SQL query: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> sent_account_id, sent_date <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> msdb.dbo.sysmail_sentitems</code> </pre><br><h4>  Mailing List </h4><br>  Now suppose that the administrator of the MySite.ru site needs to select from the table of users of his site those who have not visited the site for more than a year and send them invitations.  We specifically take a real life situation to demonstrate more DBMail and SQL capabilities, including cursors and loops.  To complicate the task, add a few more conditions: <br><ul><li>  Letters should not be sent to those who indicated during registration that they do not wish to receive letters.  For even greater complexity, we will define those who refused using a separate SQL query in a loop. </li><li>  Letters must be in HTML format. </li><li>  Letters should be sent at intervals of 3 seconds so as not to overload our SMTP server. </li><li>  The mailing list should not begin immediately after the launch of the SQL script, but, say, at 3 am. </li></ul><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--     mysite USE mysite GO --  :  , , --     ,   DECLARE @user_id int, @user_name nvarchar(255), @last_login_date smalldatetime, @email_address varchar(255); --  @body       HTML DECLARE @body nvarchar(MAX); --  @no_mail   ,    DECLARE @no_mail int; --    ,      --        FAST_FORWARD DECLARE users CURSOR LOCAL FAST_FORWARD FOR SELECT id, name, last_login_date, email_address FROM users WHERE user_role IN (3,4,5) AND account_state = 2 AND email_address IS NOT NULL AND DATEDIFF(day, last_login_date, GETDATE()) &gt; 365 ORDER BY id --      ,   3   WAITFOR TIME '03:00:00' --   users OPEN users --       FETCH NEXT FROM users INTO @user_id, @user_name, @last_login_date, @email_address --      WHILE @@FETCH_STATUS = 0 BEGIN -- ,       SET @no_mail = (SELECT id FROM users WHERE id = @user_id AND allow_mail = 0) --  ,      IF @no_mail IS NOT NULL BEGIN PRINT N' ' + @user_name + N'   .' FETCH NEXT FROM users INTO @user_id, @user_name, @last_login_date, @email_address CONTINUE END PRINT N'   ' + @email_address + N' ...' --    SET @body = N' &lt;html&gt; &lt;head&gt; &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"/&gt; &lt;title&gt;&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;p&gt;&lt;img style="float:right;" src="http://mysite.ru/images/logo.png"/&gt;&lt;/p&gt; &lt;p&gt;, ' + @user_name + N'!&lt;/p&gt; &lt;p&gt;     MySite.ru.       ,  ,            .&lt;/p&gt; &lt;p&gt; !&lt;/p&gt; &lt;p&gt; ,   MySite.ru&lt;/p&gt; &lt;/body&gt; &lt;/html&gt;'; --   EXEC msdb.dbo.sp_send_dbmail @recipients = @email_address, @subject = N'     MySite.ru', @body = @body, --      'HTML',  'TEXT' @body_format = 'HTML', --        --@file_attachments ='C:\attachment.jpg', --        --@copy_recipients ='me@gmail.com', -- "Blind copy"  "carbon copy" -    , --         --@blind_copy_recipients ='me2@gmail.com', --        @profile_name = 'MySite Admin Mailer'; --    3   ,    SMTP- WAITFOR DELAY '00:00:03'; --         FETCH NEXT FROM users INTO @user_id, @user_name, @last_login_date, @email_address END --     CLOSE users GO</span></span></code> </pre><br>  All is ready.  You can go relax. </div><p>Source: <a href="https://habr.com/ru/post/179819/">https://habr.com/ru/post/179819/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../179809/index.html">Warm wooden sound</a></li>
<li><a href="../179811/index.html">Game Theory: Games with Nature</a></li>
<li><a href="../179813/index.html">Jasmine IM and Jimm Multi removed from Google Play by Mail.ru Group request</a></li>
<li><a href="../179815/index.html">IntelliJ IDEA based on new Android Studio</a></li>
<li><a href="../179817/index.html">Remove dust from 1000 photos using Gimp and Script-Fu</a></li>
<li><a href="../179821/index.html">CentOS 6.4 + ReiserFS</a></li>
<li><a href="../179823/index.html">Ceph FS distributed file system in 15 minutes</a></li>
<li><a href="../179825/index.html">Installing Citrix XenServer on Software RAID</a></li>
<li><a href="../179827/index.html">Exploring SAP R / 3 in Unusual and Difficult Conditions</a></li>
<li><a href="../179829/index.html">Calculating the Nth sign of Pi without calculating the previous ones</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>