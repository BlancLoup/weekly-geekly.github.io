<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cisco: Dual Routing Policy Based WAN Connection</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dual WAN connection on Cisco with Policy-based routing 
 Original: pierky.wordpress.com/2009/03/28/dual-wan-connection-on-cisco-with-policy-based-rout...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cisco: Dual Routing Policy Based WAN Connection</h1><div class="post__text post__text-html js-mediator-article"><h4>  Dual WAN connection on Cisco with Policy-based routing </h4><br>  <i>Original: <a href="http://pierky.wordpress.com/2009/03/28/dual-wan-connection-on-cisco-with-policy-based-routing-pbr/">pierky.wordpress.com/2009/03/28/dual-wan-connection-on-cisco-with-policy-based-routing-pbr</a></i> <br>  Article changed by me, because  the sequence of actions described in the original article did not give a positive result. <br><br>  I believe that this article may be useful to people who still do not know what policy-based routing is.  You can begin to study this topic by reading the official documentation on Cisco.com, but personally it is much more convenient for me to begin learning a new technology with a specific example of its implementation.  This allows you to immediately understand what you are dealing with and how it can be used in the future. <br><br>  <b>We have:</b> <br><ol><li>  Cisco router with two WAN connections to the provider. </li><li>  ‚ÄúBronze‚Äù link - narrow channel, subnet with mask / 30. </li><li>  The golden link is a wide channel, there is a point-to-point subnet with a mask / 30 and a subnet with a mask / 24 for its own needs. </li></ol><br><a name="habracut"></a><br>  <i>Note that we cannot send the subnet 1.1.1.0/24 traffic through the "bronze" link.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Goals:</b> <br><ol><li>  LAN users must have access to the Internet. </li><li>  Traffic that is important for us must be transmitted through a golden link. </li><li>  Our server platform should be accessible from the outside through "white" IP addresses. </li></ol><br>  For simplicity, in our example Telnet will be important traffic.  In real life, this could be RTP, database traffic, and so on. <br><br>  In this topology there are 5 traffic directions of interest to us: <br><ul><li>  LAN -&gt; Critical Services [Golden Link] </li><li>  LAN -&gt; WAN ["Bronze" link] </li><li>  LAN -&gt; Server farm </li><li>  ServerFarm -&gt; WAN [Golden Link] </li><li>  ServerFarm -&gt; LAN </li></ul><br><br>  Traffic from the LAN in the direction of the WAN or Critical Services must be translated via NAT, but remember that traffic is first routed, and only then transmitted by NAT.  So first of all, let's turn our attention to setting up packet routing.  To configure NAT'a back later. <br><br>  Normal routing simply forwards packets based on the destination address, it does not care about Layer 4 information (OSI model transport layer) or the source IP address.  How in this case to organize the routing based on other parameters, for example, on the TCP port number of the destination port?  For the implementation of such functionality, policy <a href="http://www.cisco.com/en/US/products/ps6637/products_ios_protocol_option_home.html">-based Routing was created</a> .  PBR can make decisions based on a number of parameters: source address, destination port, QoS tag. <br><br>  <b>Let's start the configuration.</b> <br><br>  First, we give the initial configuration of our router: <br> <code>interface Serial2/0 <br> description Bronze <br> ip address 2.2.2.2 255.255.255.252 <br> ! <br> interface Serial2/1 <br> description Gold <br> ip address 3.3.3.2 255.255.255.252 <br> ! <br> interface FastEthernet0/0 <br> description LAN <br> ip address 192.168.0.1 255.255.255.0 <br> ! <br> interface FastEthernet1/0 <br> description ServerFarm <br> ip address 1.1.1.1 255.255.255.0</code> <br> <br>  Simply assign IP addresses to the interfaces and ‚Äúraise‚Äù them (no shutdown).  Synchronization on the Serial interfaces is issued by ISP. <br><br>  Set the default route for our router (GW) through the "bronze" link: <br> <code>ip route 0.0.0.0 0.0.0.0 Serial2/0</code> <br> <br>  Now we are going to deploy Policy Based Routing (PBR). <br><br>  Let's create an extended named access control list (ACL) in which we define which traffic will be prioritized: <br> <code>ip access-list extended GoldServices <br> deny ip any 1.1.1.0 0.0.0.255 // IP    1.1.1.0/24 <br> permit tcp any any eq telnet // TCP     23(Telnet) <br> deny ip any any //  IP </code> <br>  This access list is used to allocate telnet traffic not directed to the server site. <br><br>  We define a route map (route-map) which will intercept the traffic of interest (telnet to the external network) and direct it to the required interface (the ‚Äúgolden‚Äù link): <br> <code>route-map PBR_LAN permit 10 <br> match ip address GoldServices //     <br> set interface Serial2/1 Serial2/0 //    </code> <br> <br>  Apply the created map to the interface connected to the LAN segment: <br> <code>interface FastEthernet0/0 <br> description LAN <br> ip policy route-map PBR_LAN //""    </code> <br>  If the package does not fall under any routing map, then it is simply routed based on standard rules (in our case it will be sent to the ‚Äúbronze‚Äù link). <br><br>  It should be noted that we specified two interfaces in the set interface Serial2 / 1 Serial2 / 0 command - in this case, if the channel through Serial2 / 1 fails, the router will start using the Serial2 / 0 interface to forward important traffic.  This gives us some redundancy and resiliency with respect to important traffic. <br>  It is possible to provide redundancy for traffic that is not a priority (traffic going through the "bronze" link): <br> <code>ip route 0.0.0.0 0.0.0.0 Serial2/1 10 //     10,      ""  </code> <br> <br>  We repeat the same steps for traffic between the server platform and the external network. <br> <code>ip access-list extended ServerFarm-To-WAN <br> deny ip 1.1.1.0 0.0.0.255 192.168.0.0 0.0.0.255 // IP    1.1.1.0/24   192.168.0.0/24 <br> permit ip any any //  IP  <br> ! <br> route-map PBR_ServerFarm permit 10 <br> match ip address ServerFarm-To-WAN //     <br> set interface Serial2/1 //     <br> ! <br> interface FastEthernet1/0 <br> description ServerFarm <br> ip policy route-map PBR_ServerFarm //""    </code> <br>  These commands will allow us to send traffic from servers to external sites exclusively through the "golden" link.  The traffic going from the servers to our local users will not get into external channels.  Unfortunately, we will not be able to add a second interface for fault tolerance, since  Our provider will not accept traffic from the 1.1.1.0/24 subnet on its ‚Äúarmored‚Äù link. <br><br>  This completes the routing setup.  Let's get down to setting up NAT. <br><br>  We have 1 internal interface (inside) and two external (outside): <br> <code>interface FastEthernet0/0 <br> description LAN <br> ip nat inside <br> ! <br> interface Serial2/0 <br> description Bronze <br> ip nat outside <br> ! <br> interface Serial2/1 <br> description Gold <br> ip nat outside</code> <br> <br>  Create a pool of addresses for broadcast packets going to the "golden" link: <br> <code>ip nat pool LAN-to-Gold 1.1.1.20 1.1.1.20 netmask 255.255.255.0 //     1.1.1.20/24</code> <br> <br>  Create an access control list in order to allocate traffic from the LAN to the external network. <br> <code>ip access-list extended Trivial <br> permit ip 192.168.0.0 0.0.0.255 any //    192.168.0.0/24 <br> deny ip any any //  IP </code> <br> <br>  We define two route maps that will be used in address translation: <br> <code>route-map NAT_Gold permit 10 <br> match ip address GoldServices //     <br> match interface Serial2/1 //     <br> ! <br> route-map NAT_Bronze permit 15 <br> match ip address Trivial //     <br> match interface Serial2/0 //    </code> <br> <br>  And the last: <br> <code>ip nat inside source route-map NAT_Gold pool LAN-to-Gold overload //   ""      NAT_Gold <br> ip nat inside source route-map NAT_Bronze interface Serial2/0 overload //   ""     Serial2/0</code> </div><p>Source: <a href="https://habr.com/ru/post/60608/">https://habr.com/ru/post/60608/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../60601/index.html">I have 12 invites to Habr</a></li>
<li><a href="../60602/index.html">Apple builds a $ 1 billion data center</a></li>
<li><a href="../60603/index.html">Translator's message</a></li>
<li><a href="../60604/index.html">Windows console - nobody needs it?</a></li>
<li><a href="../60606/index.html">XLGet - a new word in the sale of content</a></li>
<li><a href="../60613/index.html">Quick acquaintances at the 10th Startup Point mini-conference in Moscow (May 31, 2:00 pm)</a></li>
<li><a href="../60615/index.html">Nokia 6070 Modding</a></li>
<li><a href="../60616/index.html">Content filtering in schools - testing the system</a></li>
<li><a href="../60617/index.html">Now - startup era, I - a startup</a></li>
<li><a href="../60619/index.html">Cry of a drowning man</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>