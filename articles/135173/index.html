<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Your move, comrade .NET, or Reversi again under nanoCAD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago we had a big event - release of the nanoCAD 3.5 release. The key innovation of this version was the open API, which will be discussed in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Your move, comrade .NET, or Reversi again under nanoCAD</h1><div class="post__text post__text-html js-mediator-article">  Some time ago we had a big event - release of the nanoCAD 3.5 release.  The key innovation of this version was the open API, which will be discussed in this article. <br><br>  As you know, the best way to learn something is to do it.  Once I wrote Reversi under nanoCAD on a script.  Now I decided to write Reversi on .NET. <br><img src="https://habrastorage.org/getpro/habr/post_images/e39/9fd/5b0/e399fd5b070ee1e32ac238b9e82aaccb.jpg" alt="nanoCAD_MgdReversi"><br>  The result is a cross-CAD-platform application that can work not only under nanoCAD.  How it was done - look under the cut. <br><a name="habracut"></a><br>  It was possible to program under nanoCAD before.  <a href="http://habrahabr.ru/users/dows/" class="user_link">Dows</a> wrote <a href="http://habrahabr.ru/company/nanosoft/blog/86970/">Sierpinski's curves</a> on dows scripts, I wrote <a href="http://habrahabr.ru/company/nanosoft/blog/90742/">Reversi</a> , there were other examples from our forum.  This is all, of course, good, but not enough.  Therefore, my next move is .NET. <br><br><h4>  Entry level. </h4><br>  The first thing to do was create an assembly containing the code executed in nanoCAD: <br><ul><li>  create a project: Visual C #, Class Library, </li><li>  add the .NET nanoCAD library to References: hostdbmgd.dll, hostmgd.dll, </li><li>  register in nanoCAD command. </li></ul><br>  The method that will be registered as a command must have a public modifier and be marked with the special attribute CommandMethod. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For example, HelloWorld looks like this: <br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">CommandMethod(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"HelloWorld"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HelloWorld</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Editor ed = Platform.ApplicationServices.Application.DocumentManager.MdiActiveDocument.Editor; <span class="hljs-comment"><span class="hljs-comment">//      ed.WriteMessage("     nanoCAD!"); }</span></span></code> </pre> <br>  AND EVERYTHING! <br>  I do not write about this in more detail, since this can be read in the nanoCAD SDK.  Where to get?  <a href="http://developer.nanocad.ru/">In the nanoCAD Developer Club</a> , registration is open. <br><br><h4>  Structure. </h4><br>  I divided the game into several classes: game class, game board class, information panel class, game chip class: <br><ul><li>  the class of the game must contain algorithms for checking the possibility of making a move on certain coordinates, searching for the progress of the computer, counting players' chips, decisions on the continuation of the game; </li><li>  board class - draw a board, store its contents; </li><li>  class information panel - show the results of the passage of the party; </li><li>  class chips - draw a chip, be able to change its color, store all the information relating to a specific game cell. </li></ul>  Each class should be as independent as possible. <br>  Next, I needed to learn how to create objects, change them, and communicate with the user. <br><br><h4>  Creating objects.  Mat.  part. </h4><br>  Before drawing reversi, it was necessary to understand what to do, what to undertake. <br>  In order to create objects, you need to know a little about the structure of the document.  Each document has a database.  The database stores the objects contained in the drawing and their relationships with each other.  Everything is stored in the database: lines with arcs, model space, text styles and much more.  Adding a new object to the drawing, you need to add it to the database.  And where there is a database, there are transactions. <br><br>  Transactions are needed to protect our document: if the result of the code execution failed, the objects added by this code would not fall into the document - the transaction will be canceled.  If everything completes successfully, the transaction will be confirmed and the objects will be added. <br><br><pre> <code class="cs hljs">Database db = Application.DocumentManager.MdiActiveDocument.Database; TransactionManager tm = db.TransactionManager; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Transaction tr = tm.StartTransaction()) { ... tr.Commit(); }</code> </pre><br>  Just create an object a little.  It will not go anywhere and hang "in the air."  The object needs to be placed somewhere.  This is usually a model space.  There was something similar in the scripts - he said to the model space ‚Äúmake a line‚Äù - it will appear there.  In .NET, a little differently - you need to add the created object to the model space and to the transaction. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Transaction tr = tm.StartTransaction()) { BlockTable bt = tr.GetObject(db.BlockTableId, OpenMode.ForRead, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> BlockTable; BlockTableRecord ms = tr.GetObject(bt[BlockTableRecord.ModelSpace], OpenMode.ForWrite, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> BlockTableRecord; Line line = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Line(); ObjectId lid = ms.AppendEntity(line); <span class="hljs-comment"><span class="hljs-comment">//     tr.AddNewlyCreatedDBObject(line, true); //    tr.Commit(); //   }</span></span></code> </pre><br>  Each object added to the database is uniquely identified by its personal code - ObjectId.  Using ObjectId, you can open objects for reading or writing. <br><br><h4>  Creating objects 2. Full speed ahead. </h4><br>  Fine.  Armed with knowledge of the internal kitchen of the document, you can finally begin to develop a game board class.  No board - no party.  So the first thing I started doing was drawing cells in the document space. <br><br>  I made the cells from the hatching.  Having opened the description of the Hatch object in NCadSDK.chm (the documentation is included in the SDK, which is available to the members <a href="http://developer.nanocad.ru/">of the Developer Club</a> ), I learned the knowledge I needed.  The third paragraph immediately informed me that the hatching consists of loops, and the list of methods of the hatching object was suggested by the magic word AppendLoop ().  That's what I need, I thought. <br><br>  So, I built every cell from a square polyline that I painted over the hatching.  All hatching together formed a square of 8 by 8 cells. <br><br>  Next - on the thumb, everything is like last time: I create borders and tiles from 3Dmesh objects.  Border is a polygon 2 by 2 vertices.  I calculate the coordinates of the vertices, create them, add them to the network, add the network to the model. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Transaction tr = tm.StartTransaction()) { <span class="hljs-comment"><span class="hljs-comment">//   PolygonMesh mesh = new PolygonMesh(); mesh.NSize = 2; mesh.MSize = 2; ms.AppendEntity(mesh); tr.AddNewlyCreatedDBObject(mesh, true); //     AddVertexToMesh(mesh, new Point3d(col*gridstep, 0,-linehight), tr); AddVertexToMesh(mesh, new Point3d(col*gridstep, 0, linehight), tr); AddVertexToMesh(mesh, new Point3d(col*gridstep,8*gridstep,-linehight), tr); AddVertexToMesh(mesh, new Point3d(col*gridstep,8*gridstep,linehight), tr); tr.Commit(); } //    private void AddVertexToMesh(PolygonMesh PolyMesh, Point3d Pt3d, Transaction Trans) { PolygonMeshVertex PMeshVer = new PolygonMeshVertex(Pt3d); PolyMesh.AppendVertex(PMeshVer); Trans.AddNewlyCreatedDBObject(PMeshVer, true); }</span></span></code> </pre><br>  Fine.  There are cells, there are dividers.  Drawing a chip is now also not difficult.  I took the formulas for calculating the coordinates of the ball vertices from the script version of the game.  True, I corrected them so that the object looked more like a gaming reversi chip. <br><br>  Here's what I got as a result: <br><img src="https://habrastorage.org/getpro/habr/post_images/bee/5d7/1de/bee5d71de9c769a28ba13a174a70d4e1.jpg" alt="Game board"><br><br><h4>  "I am fifty third, I go out on the square." </h4><br>  Now you need to learn how to respond to user actions. <br><br>  Here again it is necessary to mention about the mat.  part.  In addition to the database, there are several other objects that relate not to the document itself, but to the application as a whole.  This is, for example, an Application object, a collection of all documents opened in a DocumentCollection.  And this is the user interaction object - Editor.  There are others, but I don‚Äôt touch them now. <br><br>  The Editor object has a number of methods for interacting with the user: query objects, query strings, numbers, regions.  The object is requested by the GetEntity method (PromptEntityOptions).  The PromptEntityOptions object is optional.  The invitation string, keywords (if needed) are set through this object, and restrictions are imposed on the choice of objects.  A similar object is accepted by all input methods. <br><br>  The principle of the course remains the same - the user selects the cell where he wants to go.  A cell is a hatching object.  Therefore - I specify that we accept only hatch objects as input, an empty choice is to forbid, there must be an object.  And write the invitation string. <br><br><pre> <code class="cs hljs">Editor ed = Application.DocumentManager.MdiActiveDocument.Editor; ObjectId selectObj = ObjectId.Null; PromptEntityOptions opts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PromptEntityOptions(<span class="hljs-string"><span class="hljs-string">" . "</span></span>); opts.SetRejectMessage(<span class="hljs-string"><span class="hljs-string">"\n    ."</span></span>); opts.AddAllowedClass(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Hatch), <span class="hljs-literal"><span class="hljs-literal">false</span></span>); PromptEntityResult pr = ed.GetEntity(opts);</code> </pre> <br>  The cell determines exactly where the user wants to place his chip.  Further, the algorithm checks whether this can be done, if yes - the player moves and the necessary pieces are turned over. <br><br><h4>  Repainting existing chips. </h4><br>  As I already wrote - all objects live inside the database.  This means that in order to read or change the properties of an object, this object must be opened.  Opening objects is done using the GetObject () transaction method.  When the change is complete, the transaction is confirmed. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Transaction myT = db.TransactionManager.StartTransaction()) { <span class="hljs-comment"><span class="hljs-comment">// pieceId ‚Äì  id     //   pieceId   - OpenMode.ForWrite PolygonMesh piece = myT.GetObject(this.pieceId, OpenMode.ForWrite) as PolygonMesh; //         piece.Color = (player == ePlayer.Human) ? Constants.HumanColor: Constants.PcColor; //   myT.Commit(); }</span></span></code> </pre> <br><h4>  Yummy. </h4><br>  I made two data structures for storing the game board in memory: an array and a dictionary. <br>  The array stores the image of the board 8 to 8, and the matching dictionary cell element - ObjectId-hatching.  Both data structures store references to game board objects.  With this approach, you can not take care of synchronization.  Only the Piece element will change.  And you can always get it on the link.  It does not matter from the array or from the dictionary. <br><pre> <code class="cs hljs">Dictionary&lt;ObjectId, Piece&gt; GameDesc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;ObjectId, Piece&gt;(); Piece[,] GameDesc_xy = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Piece[<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>];</code> </pre> <br>  Unlike scripts, on .NET I managed to make many things more beautiful and easier.  The capabilities of the framework carried pleasant delicacies.  For example, using LINQ, data structures were processed almost by themselves.  Counting the number of user chips - in one line.  Choosing a cell for the computer run - one request.  Beauty. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCounterCount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ePlayer player</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    player return gamedesk.GameDesc.Where(x =&gt; x.Value.Player == player).Count(); }</span></span></code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/875/7ea/352/8757ea35226f58acf6751604c35c61c5.jpg" alt="Game process"><br><br><h4>  Compiling and running the game </h4><br>  The sources of the game can be found <a href="">here</a> .  You need to open the project in Visual Studio or SharpDeveloper and compile.  Project paths are configured with the expectation that nanoCAD is installed in the standard directory. <br>  If you do not need the source code, but you just want to look at the reversi, you can download the <a href="">module</a> we have assembled. <br><br>  To start the game, you need to load the MgdReversi.dll assembly into nanoCAD with the NETLOAD command.  Now you can run the game team PLAY. <br><br><h4>  What did not have time to do. </h4><br>  It would be interesting to stop in the middle of the game, save the game to a file in nanoCAD, open the file in AutoCAD and finish it, because the file format in both systems is the same. <br><br>  But, for this you need to remake the architecture of the application, now information about the state of the game is stored in the team‚Äôs memory, and you need to save it in drawing objects (field, chips) that are saved to a file.  Let's leave it for the future. <br><br>  Until then, you can play Reversi without stopping, from the beginning to the end of the game, under AutoCAD, under nanoCAD, and there, and there the game works the same.  It is enough to rebuild Reversi for AutoCAD using its SDK, ObjectARX, it‚Äôs not difficult. </div><p>Source: <a href="https://habr.com/ru/post/135173/">https://habr.com/ru/post/135173/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../135167/index.html">Where do domains get * .rf after death</a></li>
<li><a href="../135169/index.html">Mozilla and Google signed a three-year cooperation agreement.</a></li>
<li><a href="../135170/index.html">Creation and processing of print form templates</a></li>
<li><a href="../135171/index.html">Well, a very inexpensive telepresence robot based on a laptop and motorcycle carts</a></li>
<li><a href="../135172/index.html">Forismatic 3.0 - quotes on iPad and iPhone</a></li>
<li><a href="../135176/index.html">Hibernate cache</a></li>
<li><a href="../135178/index.html">Radeon HD 7970 Graphics Card Announced</a></li>
<li><a href="../135179/index.html">About personal programming experience in transport, McDonald's and other crowded and noisy places.</a></li>
<li><a href="../135180/index.html">About the sad test</a></li>
<li><a href="../135182/index.html">Canobuvosti, 123rd edition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>