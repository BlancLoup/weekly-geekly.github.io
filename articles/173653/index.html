<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Watching the collection. Tailable cursors</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you are young and energetic, you are interested in mongoDb, you want to discuss the translation of the word tailable into Russian, and you are inte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Watching the collection. Tailable cursors</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/4d1/cf8/29e/4d1cf829e3d6579456d6df90eb52f28c.jpeg" align="left"><br><br>  If you <s>are young and energetic,</s> you <s>are</s> interested in mongoDb, you want to discuss the translation of the word tailable into Russian, and you are interested in where the pickrelayed is taken - welcome under the cat. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Some time ago, doing admin panel for one small project, I thought that it would be nice to display a log of some significant events in it.  Memory helpfully recalled one of the possibilities MongoDb, about which I heard, but never used in practice - the tail (tailable) cursors. <br><br><h5>  What kind of beast? </h5><br>  By default, Mongo automatically closes the connection after the client has obtained all the data available to the cursor.  For capped collections, additional behavior is possible, the so-called tail cursors. <br><br>  The tail cursors remain open and continue to receive new data that meets the search criteria.  Their action reminds well-familiar tail -f.  Mongo uses tail cursors to track opplog. <br><h5>  What you need, I thought </h5><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ DBCollection collection=MongoConnector.getInstance().getCollection(<span class="hljs-string"><span class="hljs-string">"events"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  addOption DBCursor cur= collection.find().addOption(Bytes.QUERYOPTION_TAILABLE).addOption(Bytes.QUERYOPTION_AWAITDATA); while (cur.hasNext()) { //   ,    ,     JS wsConnection.broadcast((String) cur.next().get("message")); } } }).start();</span></span></code> </pre> <br>  By the way, as practice has shown - the delay between the insertion of a new document and its receipt by the client on the tail cursor is so insignificant that it can be ignored in principle. <br><br><h5>  A spoon of tar </h5><br>  Official documentation suggests that the use of tail cursors on collections, with a large number of write operations can be very expensive.  If the request is based on the fields for which there is an index, in the case of a large number of records, it is better to use the usual cursor, periodically requesting new documents <br><br><h5>  How it works? </h5><br>  Remember the above I wrote the work tail cursors looks like a tail-f work?  In fact, the similarities here are even more than it seems at first glance. <br>  When you set the tail cursor and read data from it, having reached the last document, Mongo leaves the cursor on it and tracks the collection descriptor; if a new element appears that satisfies, the cursor moves to it. <br>  For ordinary (unlimited) collections, this behavior is impossible, since in them the order of storing documents on disk does not always correspond to the order of inserting data. <br><br><h5>  4 facts about tail cursors that shook the world </h5><br><br>  1) Tail cursors do not use indexes and return documents in the order in which they are stored on disk.  For limited collections, the order of placement always coincides with the order of insertion of documents. <br><br>  2) Since indexes are not used, at the beginning of the query you will have to read all the records in the collection, which can be very expensive with large amounts of data.  After we have already received the available data, screening out the newly added documents that do not satisfy the request is not expensive. <br><br>  3) The tail cursor may not be valid (there will be no tracking of the collection) if <br>  No document has satisfied the original search query. <br>  The last document was deleted when the cursor pointed at it. <br><br>  4) Dead cursor has id 0 </div><p>Source: <a href="https://habr.com/ru/post/173653/">https://habr.com/ru/post/173653/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../173643/index.html">Pre-order for Samsung Galaxy S IV available</a></li>
<li><a href="../173645/index.html">Personal computer in the living room</a></li>
<li><a href="../173647/index.html">Another vulnerability in the lock of some Samsung smartphones</a></li>
<li><a href="../173649/index.html">WorldHostingDays - the largest hosters conference (report)</a></li>
<li><a href="../173651/index.html">Zip codes - to freedom! (Reversing in pictures)</a></li>
<li><a href="../173655/index.html">Amazon Expanded Instance Types with EBS-Optimized Disks</a></li>
<li><a href="../173657/index.html">Voyager 1 almost left the solar system</a></li>
<li><a href="../173661/index.html">Windows Azure Storage - Architecture</a></li>
<li><a href="../173663/index.html">The war is over, everyone has won</a></li>
<li><a href="../173665/index.html">Google Keep is available. Again</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>