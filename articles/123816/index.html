<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fixed point math in Marmalade SDK</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago on Habr√© was the post "Plunge into 3D with the help of Marmalade SDK" , which left me a lot of questions. First of all, this concerned...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fixed point math in Marmalade SDK</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago on Habr√© was the post <a href="http://habrahabr.ru/blogs/gdev/122891/">"Plunge into 3D with the help of Marmalade SDK"</a> , which left me a lot of questions.  First of all, this concerned magic hexadecimal numbers that were passed to functions, i.e.  fixed point calculations.  This topic is described badly enough on the Internet, so I had to experiment.  If interested - welcome under cat. <a name="habracut"></a><br><br><h5>  First part.  Integer style coordinates </h5><br>  Having many years of experience in commercial game development, I quickly threw a torch (to the origin of coordinates) onto the stage in Maya and exported it with a marmalade plugin.  This was followed by a more fascinating question - which integer magic numbers should be set for the view matrix and the perspective matrix.  The answer depends primarily on how the model is loaded and how the float coordinates of the maya are converted into integer values.  Of course, I first thought about the macro IW_FIXED_FROM_FLOAT, which by the way translates 1.f to 0x1000 (this knowledge is useful for understanding what a normalized vector is, that is, a vector with a length of 0x1000).  I will not torture you and tell about your attempts, I will tell the result.  When importing, no such macros are applied, but the float is brought to a whole, i.e.  just cut everything after the comma.  Therefore, we return to Maya and make the torus more ... more, no more, I want awesome accuracy.  Well, I did tens of thousands.  And it was not there!  All broke off (more precisely, cut) a promising matrix.  It turns out that IwGxSetFarZNearZ, although it takes int32 as arguments, but allows the maximum zFar to be only 0xffff, imposing restrictions on the size of objects.  So, how to choose a balance between sufficient accuracy and limiting zFar?  In my opinion, the optimal size of objects will be in the range from 100 to 1000 (it is possible from 1000 to 10,000 for closed spaces).  This is in good agreement with the dimension of maya, where the unit is centimeter.  We make, for example, a person 180 cm and this will be sufficient accuracy for most scenes.  Of course, it‚Äôs impossible to model a detailed face with an accuracy of 1 cm, but fortunately (or unfortunately) on mobile platforms at the moment you don‚Äôt have to see a person‚Äôs face in the scene and at the same time a ship three hundred meters from us. <br><br><h5>  The second part of Marlezonsky ballet.  Integer style corners </h5><br>  Everything is easier with corners.  As well as for coordinates, there is an appropriate macro IW_ANGLE_FROM_DEGREES for translating corners into integers.  The question immediately arises where problems may appear when using integers for rotation matrices.  As a simple test showed, the animation from maya is exported without problems, all turns in float are converted into corresponding matrices with integer values.  The only place where you need to remember to transform manually - when transferring the matrix to the shader.  By the way, there is no support for shaders in marmalade, you need to write everything yourself. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  The third part.  Criticism (optional reading) </h5><br>  And in conclusion, I want to slightly criticize the post I mentioned at the very beginning of the article.  In general, I am grateful to the author for the inspiration to research and write this article. <br>  But it‚Äôs still impossible to post a small piece of the program causing tons of questions, and even with the postscript ‚ÄúThe code is very simple even for an inexperienced programmer.‚Äù  Although maybe I'm not quite an inexperienced programmer.  The first lines raised questions <br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">CIwSVec3 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0xFF</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0xFF</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0xFF</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; IwGxSetLightDirn(<span class="hljs-number"><span class="hljs-number">1</span></span>, &amp;dd);</code> </pre> <br>  Why all the components of the vector 0xFF, and not just (1,1,1)?  Is this something conscious or the cost of copy-paste?  Can the vector be normalized?  By the way, the last letter n in the function name seems to hint ... we read the description and indeed - the vector needs to be transferred normalized.  Obviously, the vector (0xFF, 0xFF, 0xFF) is not normalized, I have already mentioned above that the unit in the fixed marmalade system is 0x1000.  The length of the vector from the example is clearly less.  Add normalization - and voila, the lighting starts to work correctly.  By the way, I knowingly exported from Mayi a torus, and not a box - the efforts to create are the same, and on the torus you immediately see problems of lighting, accuracy of coordinates, etc.  This is how the lighting changed after correcting this annoying error. <br><img src="https://habrastorage.org/storage1/1437e7bb/345cfa33/00941ba5/12f15619.png"><br><br>  A little further in the text is a mega comment, after which I almost slipped under the table <br><blockquote>  Also, special attention should be paid to the IwGxSetPerspMul (...) function.  This is a kind of setting the degree of the fish-eye effect.  If you leave this option by default, your scenes around the edges of the screen will create the impression of viewing the bottom of a bottle through a <s>toilet hole</s> . <br></blockquote><br>  The author‚Äôs mathematical approach is amazing.  The method of scientific poking in all its glory. <br>  Help describes the only parameter of this function as "The distance from the camera to the viewing plane."  And what is not FOV - horizontal viewing angle, as all white people ask?  Almighty Google suggested what marmalade means by ‚Äúviewing plane‚Äù, which means we have a relatively simple formula for moving FOV to this distance: <br><pre> <code class="cpp hljs"> int32 perspMul = IwGxGetDeviceWidth() / (<span class="hljs-number"><span class="hljs-number">2</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">tan</span></span>(fov/<span class="hljs-number"><span class="hljs-number">2</span></span>)); IwGxSetPerspMul(perspMul);</code> </pre><br>  Having a little thought over my brains, I had an assumption as to why not FOV - mobile devices, unlike PCs, can have both portrait and landscape views.  Moreover, the gyroscope can switch it in real time.  This approach saves us from having to manually handle the change in view and change the perspective matrix each time. <br><br>  Go ahead ... <br><pre> <code class="cpp hljs"> CIwMat view = CIwMat::g_Identity; view.tz = <span class="hljs-number"><span class="hljs-number">-80</span></span>; view.ty = <span class="hljs-number"><span class="hljs-number">80</span></span>; view.tx = <span class="hljs-number"><span class="hljs-number">-60</span></span>; view.LookAt(view.GetTrans(), CIwVec3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>), -CIwVec3::g_AxisY);</code> </pre><br>  There is no sensible explanation from the author, although a certain redundancy of the code immediately catches the eye.  Why not just write <br><pre> <code class="cpp hljs">view.LookAt(CIwVec3(<span class="hljs-number"><span class="hljs-number">-60</span></span>,<span class="hljs-number"><span class="hljs-number">80</span></span>,<span class="hljs-number"><span class="hljs-number">-80</span></span>), CIwVec3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>), -CIwVec3::g_AxisY);</code> </pre><br>  I wrote.  But that doesn't work.  Help said that the function of the LookAt function does not change position, but creates only a rotation matrix.  Those.  The ‚Äútranslate‚Äù component must be installed separately.  Here you want to throw a big stone in the garden of marmalade developers - if you call the LookAt function, then you can do its job in the same way as D3DXMatrixLookAt and gluLookAt - we're used to the devil.  I am sure that it was not me alone who did not understand for a long time why it was not working.  Indeed, what to read help, when for many years you know this feature :) <br>  PS A little messy out, so if you have questions - ask.  I am not an expert on marmalade, but I will still try to answer. <br><br>  <b>Update:</b> forgot to write that for multiplication, division, trigonometric functions and other things you need to apply the corresponding macros IW_FIXED_MUL (IW_FIXED_MUL_SAFE) IW_FIXED_DIV (IW_FIXED_DIV_SAFE), IW_GEOM_COS, IW_GEOM_SIN etc.  Safe versions of macros are used for int64 calculations to avoid overflow during calculations.  Although, the result of multiplication, of course, can still overflow the buffer.  Thanks to habraouzer <a href="http://habrahabr.ru/users/zigmar/" class="user_link">zigmar</a> for reminding. </div><p>Source: <a href="https://habr.com/ru/post/123816/">https://habr.com/ru/post/123816/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../123805/index.html">Search engine job dataflow</a></li>
<li><a href="../123808/index.html">Attackers have access to data from users of the Washington Post</a></li>
<li><a href="../123810/index.html">Flash drive cryptex for lovers of design and cryptography</a></li>
<li><a href="../123812/index.html">Writing Your ASP.NET Session Store Provider Using Redis</a></li>
<li><a href="../123813/index.html">Textile printer do it yourself - continued</a></li>
<li><a href="../123818/index.html">Do you need a G + (+1) button on Habrahabr?</a></li>
<li><a href="../123819/index.html">Portable Areas as a modularity option in MVC</a></li>
<li><a href="../123821/index.html">Python unknown</a></li>
<li><a href="../123823/index.html">Collusion for Firefox extension: visualize tracking cookies</a></li>
<li><a href="../123826/index.html">Google + Photo + Android =?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>