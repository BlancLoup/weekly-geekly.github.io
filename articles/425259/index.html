<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Backing up your site with git and a makefile</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Translating a site into a set of static web pages allows you to reduce server load or even use free storage, as well as improve the reliability, speed...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Backing up your site with git and a makefile</h1><div class="post__text post__text-html js-mediator-article"><p>  Translating a site into a set of static web pages allows you to reduce server load or even use free storage, as well as improve the reliability, speed and security of the site.  In this article I will tell you how to do this using the familiar tools of <a href="https://git-scm.com/doc">git</a> and <a href="https://www.gnu.org/software/make/manual/make.html">Makefile</a> .  The advantage of this approach is also the ability to control versions of the content of web pages. </p><br><p>  The article describes how to make static versions of web pages for issuance by the server and how to put them in a repository for version control and backup.  In this case, static and media files can be stored separately and archived by other means (static is usually placed in the repository for the program code of the site).  The method also works for pages with Unicode names (for example, for Cyrillic domains).  At the end is a working Makefile. </p><br><p>  The author uses the django / uwsgi / nginx stack, a virtual dedicated server running GNU / Linux, but the content of the article is almost independent of specific technologies. </p><a name="habracut"></a><br><h3 id="zagruzhaem-stranicy">  Loading pages </h3><br><p>  We will save the site pages using the standard <a href="https://www.gnu.org/software/wget/">wget</a> program.  We will save each site in a separate directory (which may not be associated with the domain name of the site). </p><br><p>  Inside each directory the pages will be saved recursively using <a href="https://www.gnu.org/software/wget/manual/wget.html">the wget</a> <em>-r</em> <a href="https://www.gnu.org/software/wget/manual/wget.html">key</a> (it is assumed that all pages can be followed by links from the main one).  By default, recursive copying goes up to level 5, but this can be changed with the <em>-l option</em> . </p><br><p>  If we store media and static files separately from text pages, then the corresponding directories are ignored with the <em>-X option</em> . </p><br><p>  The complete command looks like this: </p><br><pre><code class="bash hljs">mkdir primer <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> primer wget -r -nH -X ,static --restrict-file-names=nocontrol .</code> </pre> <br><p>  <em>-nH</em> means <em>--no-host-directories</em> .  By default, <em>wget -r example.com</em> will put everything in the <em>example.com/</em> directory, and this option cancels the creation of a directory with the host name. </p><br><p>  The <em>--restrict-file-names</em> option specifies that characters in the URL be escaped when creating local files.  The value <em>nocontrol</em> means disabling screening and is very important for saving pages with Cyrillic links.  Without it, the pages are saved to files with slightly changed names, and it is not quite clear how to give them to the server.  Unfortunately for Windows users, <em>--restrict-file-names = nocontrol</em> will not work for them, this is a known <a href="http://savannah.gnu.org/bugs/%3F37564">problem</a> . </p><br><h3 id="dobavlyaem-v-git">  Add to git </h3><br><p>  A new repository is created using the <em>git init</em> command.  By default, it is created inside the current directory in the .git folder, but we want the server to have access only to files that correspond to the names of the open pages of the site.  Therefore, the full team that creates a clean (bare) repository in the ../.git-primer folder looks like this: </p><br><pre> <code class="bash hljs">git init --bare ../.git-primer</code> </pre> <br><p>  To further use this non-standard repository, you need to pass the <em>git-dir</em> and <em>work-tree</em> options to <em>git</em> : </p><br><pre> <code class="bash hljs">git --git-dir=../.git-primer --work-tree=. add .</code> </pre> <br><h3 id="pishem-makefile">  Writing Makefile </h3><br><p>  Let's start with the announcement of our projects: </p><br><pre> <code class="hljs mel">SITES := example primer all : $(SITES) .PHONY : $(SITES)</code> </pre> <br><p>  The variable <em>SITES</em> contains the names of our projects.  The default target is the first target <em>all</em> , that is, to perform all actions, it will suffice to type one <em>make command</em> .  All targets in <em>SITES</em> are fictitious ( <em>PHONY</em> ): the recipe for each of them will be executed regardless of the existence of the directory and the time it changes. <br>  The basic introduction to make can be read, for example, <a href="https://habr.com/post/211751/">here</a> , and the basic guide is <em>info make</em> ( <a href="https://www.gnu.org/software/make/manual/make.html">original</a> , <a href="http://linux.yaroslavl.ru/docs/prog/gnu_make_3-79_russian_manual.html">translation</a> ). </p><br><p>  The rule for each of the projects is as follows: </p><br><pre> <code class="hljs lua">$(SITES) : <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">[[ -d .git-$@ ]]</span></span>; \ <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> \ $(get-data); \ $(mgit) add . &amp;&amp; \ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">[[ -n "`$(mgit) status --porcelain`" ]]</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> \ $(mgit) commit -m <span class="hljs-string"><span class="hljs-string">"Update $@."</span></span>; \ fi \ <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> \ $(init-git); \ fi</code> </pre> <br><p>  This rule is essentially one shell command. <br>  $ @ Is an <a href="https://www.gnu.org/software/make/manual/html_node/Automatic-Variables.html">automatic variable</a> containing the name of the current target (for example, primer). <br>  First we check if the .git-primer directory exists.  If yes, then go to the project directory, download the pages, add them to git. <br>  If the content of the pages has not changed, git <a href="https://en.wikipedia.org/wiki/Content-addressable_storage">will not add</a> anything, but in this case the <em>commit</em> will cause an error and stop the execution of the Makefile.  Therefore, we first call <em>git status</em> with the option <em>- <a href="https://git-scm.com/docs/git-status">porcelain</a></em> , which is intended for use in scripts.  If the length of the <em>git status</em> output line <em>--porcelain is</em> not null, then we can commit ( <a href="https://stackoverflow.com/questions/5139290/how-to-check-if-theres-nothing-to-be-committed-in-the-current-branch">from here</a> ). </p><br><p>  get-data, mgit and init-git are <a href="https://www.gnu.org/software/make/manual/html_node/Canned-Recipes.html">canned</a> recipes in the Makefile.  For example, <em>mgit</em> is a call to <em>git</em> with an indication of the directory with the repository files and the working directory: </p><br><pre> <code class="hljs dos">define mgit = git --git-<span class="hljs-built_in"><span class="hljs-built_in">dir</span></span>=../.git-$@ --work-<span class="hljs-built_in"><span class="hljs-built_in">tree</span></span>=. endef</code> </pre> <br><p>  Canned recipes are created when one sequence of commands can be used in several recipes.  They can consist of several lines, each of which is automatically tabulated in recipes (more precisely, with the <a href="https://www.gnu.org/software/make/manual/html_node/Special-Variables.html">.RECIPEPREFIX</a> symbol).  In our example, the indent is made only for the convenience of reading the Makefile. <br>  During the execution of recipes, each line of the prepared sequences is interpreted as a separate line of the recipe, that is, in particular, they can use automatic variables for a given <em>purpose</em> . </p><br><p>  The full makefile looks like this: </p><br><pre> <code class="hljs mel">SITES := primer example SERVERHOST := example # .  punicode SERVERHOSTNAME := xn--e1afmkfd.xn--p1ai SERVERPATH := ~/archive all : $(SITES) .PHONY : $(SITES) # target-specific variables primer : DOMAIN := . primer : EXCLUDEDIRS := ,static example : DOMAIN := example.com ifeq ($(SERVERHOSTNAME),$(shell hostname)) # Server define mgit = git --git-dir=../.git-$@ --work-tree=. endef define init-git = mkdir -p $@ &amp;&amp; \ $(get-data) &amp;&amp; \ git init --bare ../.git-$@ &amp;&amp; \ $(mgit) add . &amp;&amp; \ $(mgit) commit -m <span class="hljs-string"><span class="hljs-string">"Initial commit of $@."</span></span> endef define get-data = cd $@ &amp;&amp; \ wget -r -nH -X $(EXCLUDEDIRS) --restrict-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>-names=nocontrol $(DOMAIN) endef <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> # Workstation define init-git = git clone $(SERVERHOST):$(SERVERPATH)/.git-$@ $@ endef endif $(SITES) : ifeq ($(SERVERHOSTNAME),$(shell hostname)) # Server <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [[ -d .git-$@ ]]; \ then \ $(get-data); \ $(mgit) add . &amp;&amp; \ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [[ -n <span class="hljs-string"><span class="hljs-string">"`$(mgit) status --porcelain`"</span></span> ]]; then \ $(mgit) commit -m <span class="hljs-string"><span class="hljs-string">"Update $@."</span></span>; \ fi \ <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> \ $(init-git); \ fi <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> # Workstation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [[ -d $@/.git ]]; \ then \ cd $@ &amp;&amp; git pull; \ <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> \ $(init-git); \ fi endif</code> </pre> <br><p>  In the fourth paragraph there are target-dependent variables: for each goal you can set its own value for this variable.  These values ‚Äã‚Äãare also transmitted to the <em>prerequisites of</em> each of the goals and to the used prepared recipes, that is, we can be sure that the recipe for each site will be executed with the correct name of the site and its directory. <br>  For each project, we can transfer our non-archived directories via the <em>EXCLUDEDIRS</em> variable or leave it empty.  Similarly, you can change the name of the server for archiving from the working computer ( <em>SERVERHOST</em> ) and the path on the server to the directory with the archive of sites ( <em>SERVERPATH</em> ).  For simplicity, in this example, all sites are on the same server and are archived in one directory. <br>  Since each line of the recipe (including the prepared one) is executed in a separate <em>shell</em> , so that the transition to the directory remains in effect for the following commands, we use the "and" <em>&amp;&amp;</em> operator and escape the end of the line \. </p><br><p>  Next comes the <a href="https://www.gnu.org/software/make/manual/html_node/Conditionals.html">conditional</a> Makefile <a href="https://www.gnu.org/software/make/manual/html_node/Conditionals.html">construction</a> : using the <a href="https://www.gnu.org/software/make/manual/html_node/Shell-Function.html">shell</a> <em>hostname</em> command, we check if make is running on the server or on the local computer.  Lines that do not satisfy the current branch of the conditional directive are completely ignored by the Makefile. </p><br><div class="spoiler">  <b class="spoiler_title">Difference between local and server repositories</b> <div class="spoiler_text"><p>  The local computer serves primarily to store data, so we only copy data from the server ( <em>git pull</em> ) to it, and for the convenience of local work with git (viewing logs or versions of files) we use the default repository structure (the usual repository in the .git folder ). <br>  In both cases, a single <em>make</em> command is sufficient.  For automatic copying, you can use the <em>cron</em> scheduler.  In order not to enter the password for access to the server each time, ssh-keys are generated. </p><br><p>  For the convenience of working on the server, you can create an <em>alias</em> git with the specified configuration from the current site directory: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> mgit=<span class="hljs-string"><span class="hljs-string">"git --work-tree=. --git-dir=../.git-</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${PWD##*/}</span></span></span><span class="hljs-string">"</span></span></code> </pre> <br><p>  The variable $ {PWD ## * /} contains the <a href="https://stackoverflow.com/questions/1371261/get-current-directory-name-without-full-path-in-a-bash-script">name of the current directory without a path to it</a> and is included in the <a href="http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html">POSIX</a> standard, that is, it can be used in all shells supporting POSIX. </p></div></div><br><p>  The conditional directive can also be used in recipes, the only restriction is that its beginning and end cannot be in different files. </p><br><div class="spoiler">  <b class="spoiler_title">Server</b> <div class="spoiler_text"><p>  After running make, the archive directory looks like this: </p><br><pre> <code class="bash hljs">$ ls -a . .. .git-example .git-primer Makefile example primer $ ls -a primer . .. index.html - - $ <span class="hljs-comment"><span class="hljs-comment"># ,     .    ./-  ./-</span></span></code> </pre> <br><p>  The nginx configuration file for example. RF may look like this: </p><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> xn--e1afmkfd.xn--p1ai; <span class="hljs-attribute"><span class="hljs-attribute">charset</span></span> utf-<span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> = / { <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /home/user/archive/primer; <span class="hljs-attribute"><span class="hljs-attribute">try_files</span></span> /index.html =<span class="hljs-number"><span class="hljs-number">404</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /home/user/archive/primer; <span class="hljs-attribute"><span class="hljs-attribute">default_type</span></span> <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">try_files</span></span> <span class="hljs-variable"><span class="hljs-variable">$uri</span></span> =<span class="hljs-number"><span class="hljs-number">404</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> = /index.html { <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">404</span></span>; } }</code> </pre> <br><p>  The first <em><a href="http_core_module.html">location</a></em> corresponds to the main page of the site, example.  It is saved to <em>wget</em> as an index.html file.  If it is not found, error 404 is issued. </p><br><p>  For all other URIs, files are checked in the primer directory with the name URI.  If they are not found, 404 is issued. </p><br><p>  In the end, in order to avoid duplication of content, we explicitly prohibit access by reference example.rf / index.html (404).  A little more detail about this configuration is written <a href="https://stackoverflow.com/a/33440489/952234">here</a> . </p></div></div><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  Backing up sites can be done using standard tools <em>wget</em> , <em>git</em> , <em>make</em> .  You can copy all pages of the site or exclude media and a number of other files as accurately as <em>wget</em> allows.  Similarly, using <em>.gitignore</em> , you can control which static pages will be added to the repository for backup and which ones will not.  <em>Makefile</em> allows you to flexibly manage different configurations for different projects.  The complete example of the Makefile for the client and for the server above, with only about 60 lines. </p><br><p>  It is assumed that the change and addition of site content occurs through standard mechanisms, that is, for this CMS or CMF is launched.  If this happens rarely, then after work they can be turned off, freeing up system resources and delivering the saved static pages.  An example of a more complete automation may deserve a separate article. </p><br><p>  The proposed method is suitable primarily for small projects that are rarely updated, so the issues of performance and security are almost not considered here.  Since we told <em>wget</em> not to escape characters from URIs, if arbitrary users can add files to the site, escaping or prohibiting them from adding should happen immediately. </p><br><p>  Saving versions of the contents of the site can also be carried out through the database when changing its pages.  But this requires support for versions with CMF models, as well as greater control over the database dump (completely copy it after any page editing).  In the proposed method, in the case of a small change in the contents, only this change will be added to the repository, and no full copy of the database will be required.  In addition, the generated static pages can be directly used by the server or viewed in a browser (changes in the design or other program code of the site will also be copied). </p><br><p>  Alternative backup programs are listed <a href="https://habr.com/company/nixys/blog/424717/">here</a> .  To store and synchronize media files you should pay attention to <a href="https://git-annex.branchable.com/">git-annex</a> .  Separating the .git repository from the working tree is also successfully used to manage user configuration files ( <a href="https://developer.atlassian.com/blog/2016/02/best-way-to-store-dotfiles-git-bare-repo/">dotfiles</a> ).  Today there are servers that directly <a href="https://blog.digitalocean.com/deploying-a-fully-automated-git-based-static-website-in-under-5-minutes/">support the</a> work with git-repositories. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/425259/">https://habr.com/ru/post/425259/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../425247/index.html">Crowdsourcing Testing</a></li>
<li><a href="../425249/index.html">How is familiarity with the LLP at ITMO University: the course "Low-level programming"</a></li>
<li><a href="../425251/index.html">LoJax: the first known UEFI rootkit used in a malicious campaign</a></li>
<li><a href="../425253/index.html">Making a machine learning project in Python. Part 1</a></li>
<li><a href="../425255/index.html">Broo lossless compression algorithm and delta encoding, compared with Xdelta3. Home project development</a></li>
<li><a href="../425261/index.html">EV certificates are dead</a></li>
<li><a href="../425263/index.html">IFEST festival will be held in Nizhny Novgorod</a></li>
<li><a href="../425265/index.html">Development rules in Yandex. Health</a></li>
<li><a href="../425267/index.html">Workplace .NET developer or the difficulty of choosing the ideal configuration ver.2.0</a></li>
<li><a href="../425269/index.html">Hackathon GAZ - how to touch the auto giant</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>