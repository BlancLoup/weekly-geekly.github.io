<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Introduction to the development of CatBoost. Yandex report</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My name is Stas Kirillov, I am a leading developer in the group of ML-platforms in Yandex. We develop machine learning tools, support and develop infr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Introduction to the development of CatBoost. Yandex report</h1><div class="post__text post__text-html js-mediator-article">  My name is Stas Kirillov, I am a leading developer in the group of ML-platforms in Yandex.  We develop machine learning tools, support and develop infrastructure for them.  Below is my recent report on how the CatBoost library is organized.  In the report, I talked about entry points and features of the code for those who want to understand it or become our contributor. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/ySla2kczbeM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  - CatBoost we live on GitHub under the Apache 2.0 license, that is, open and free for all.  The project is actively developing, now our repository has more than four thousand stars.  CatBoost, written in C ++, is a library for gradient boosting on decision trees.  It supports several types of trees, including the so-called "symmetric" trees, which are used in the library by default. <br><br><a name="habracut"></a>  What is the profit of our oblivious trees?  They learn quickly, apply quickly and help learning to be more resilient to parameter changes in terms of changes in the final quality of the model, which greatly reduces the need for parameter selection.  Our library is about making it convenient to use in production, learn quickly and get good quality right away. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/wv/0s/8f/wv0s8fv32vjvrpihdkyek1uv-yu.jpeg"><br><br>  Gradient boosting is an algorithm in which we build simple predictors that improve our objective function.  That is, instead of immediately building a complex model, we build many small models in turn. <br><br><img src="https://habrastorage.org/webt/nn/jd/e0/nnjde08vq2zueuftpfs6nv1pemw.jpeg"><br><br>  How does the learning process in CatBoost?  I'll tell you how it works in terms of code.  First, we parse the training parameters that the user passes, validate them, and continue to see if we need to load data.  Because the data can already be loaded - for example, in Python or R. Next, we load the data and build a grid of borders to quantize the numerical features.  It is necessary to make learning fast. <br><br>  Categorical features we process a little differently.  Categorical features we have at the very beginning we hash, and then we renumber the hashes from zero to the number of unique values ‚Äã‚Äãof the categorical feature in order to quickly count combinations of categorical features. <br><br>  Then we run the training loop directly - the main loop of our machine learning, where we iteratively build trees.  After this cycle, the model is exported. <br><br><img src="https://habrastorage.org/webt/ed/m6/lm/edm6lmnfi6ub-9ocgvxci6x7usm.jpeg"><br><br>  The training cycle itself consists of four points.  First, we are trying to build one tree.  Then we look at the increase or decrease in quality it gives.  Then we check if our retraining detector has worked.  Then we, if it's time, save the snapshot. <br><br><img src="https://habrastorage.org/webt/wn/es/f2/wnesf2muxq15auqojtipuwjzrjk.jpeg"><br><br>  Learning a single tree is a cycle through the levels of the tree.  At the very beginning, we randomly select a data permutation if we use ordered boosting or we have categorical features.  Then we count the counters on this permutation.  Then we try to greedily pick good splits in this tree.  By splits, we simply understand certain binary conditions: such and such a numeric feature is greater than such a value, or such a counter for a categorical feature is greater than such a certain value. <br><br>  How does the cycle of greedy selection of tree levels?  At the very beginning, the bootstrap is done - we re-weigh or sample objects, after which only the selected objects will be used to build the tree.  Bootstrap can also be recalculated before selecting each split, if the sampling option is enabled at each level. <br><br>  Then we aggregate the derivatives in histograms, so we do for each split candidate.  With the help of histograms we try to estimate the change in the objective function that will occur if we choose this split candidate. <br><br>  We select the candidate with the best soon and add it to the tree.  Then we calculate the statistics using this selected tree on the remaining permutations, update the value in the leaves on these permutations, count the values ‚Äã‚Äãin the leaves for the model and proceed to the next iteration of the cycle. <br><br><img src="https://habrastorage.org/webt/7s/bd/dt/7sbddtjen2ktfvjvgccack2hrrm.jpeg"><br><br>  It is very difficult to select any one place where the training takes place, so on this slide - it can be used as a certain entry point - the main files that we use for training are listed.  This is greedy_tensor_search, in which we live the very procedure of greedy selection of splits.  This is train.cpp, where we have the main CPU-training factory.  This is aprox_calcer, where the functions of updating the values ‚Äã‚Äãin the leaves are.  And also score_calcer is a candidate's evaluation function. <br><br>  No less important parts are catboost.pyx and core.py.  This is the Python wrapper code, most likely, many of you will inject some things into the Python wrapper.  Our Python wrapper is written in Cython, Cython is translated to C ++, so this code should be fast. <br><br>  Our R-wrapper is in the R-package folder.  It may be necessary for someone to add or correct some options, for options we have a separate library - catboost / libs / options. <br><br>  We came from Arcadia to GitHub, so we have a lot of interesting artifacts you will encounter. <br><br><img src="https://habrastorage.org/webt/wc/aw/as/wcawas_io1tv2tsyir8wv9y9ewu.jpeg"><br><br><img src="https://habrastorage.org/webt/yc/w6/or/ycw6or5ltsotncff_edmb_aq_4e.jpeg"><br><br>  Let's start with the repository structure.  We have the util folder, where the basic primitives lie: vectors, maps, file systems, work with strings, streams. <br><br>  We have a library, where the public libraries used by Yandex are located - many, not just CatBoost. <br><br>  The CatBoost and contrib folder is the code for third-party libraries that we link to. <br><br>  Let's now talk about the primitives of C ++ that you will encounter.  The first is smart pointers.  In Yandex, since the time of std :: unique_ptr, we use THolder, and instead of std :: make_unique, we use MakeHolder. <br><br><img src="https://habrastorage.org/webt/vo/uy/dw/vouydw0bfucjevtxvyttk36rkim.jpeg"><br><br>  We have our own SharedPtr.  And it exists in two ways, SimpleSharedPtr and AtomicSharedPtr, which differ in the type of counter.  In one case, it is atomic, which means that the object can be owned as if by several threads.  So it will be safe from the point of view of transmission between threads. <br><br>  A separate class IntrusivePtr allows you to own objects inherited from the class TRefCounted, that is, classes that have an embedded reference counter inside.  This is in order to allocate such objects at a time, without allocating an additional control unit with a counter. <br><br>  We also have our own system for input and output.  IInputStream and IOutputStream are interfaces for input and output.  They have useful methods such as ReadTo, ReadLine, ReadAll, in general, everything that can be expected from InputStreams.  And we have implementations of these streams for working with the console: Cin, Cout, Cerr and separate Endl, which is similar to std :: endl, that is, it flashes. <br><br><img src="https://habrastorage.org/webt/n4/cs/wa/n4cswarvhmfpciuulxej55cbea8.jpeg"><br><br>  We also have our own implementation of interfaces for files: TInputFile, TOutputFile.  This is a buffered read.  They implement buffered read and buffered write to a file, so you can use them. <br><br>  The util / system / fs.h has methods NFs :: Exists and NFs :: Copy, if suddenly you need to copy something or check that a file really exists. <br><br><img src="https://habrastorage.org/webt/a0/vq/4z/a0vq4zt1s-biymm5n2y4bix80a0.jpeg"><br><br>  We have our own containers.  They moved to std :: vector for quite a long time, that is, they are simply inherited from std :: vector, std :: set and std :: map, but we also have our own THashMap and THashSet, which in some cases are compatible with unordered_map and unordered_set.  But for some tasks, they were faster, so they are still used here. <br><br><img src="https://habrastorage.org/webt/h-/he/go/h-hegomeoamviz05exj_rt03bzg.jpeg"><br><br>  Array references are an analogue of std :: span from C ++.  True, he appeared here not in the twentieth year, but much earlier.  We actively use it to pass references to arrays, as if allocated on large buffers, so as not to allocate temporary buffers each time.  Suppose that for calculating derivatives or some approximations, we can allocate memory on some preallocated large buffer and transfer the counting function only to TArrayRef.  It is very convenient, and we use it a lot. <br><br><img src="https://habrastorage.org/webt/18/f0/km/18f0kmuuuuigc-j7zdck_yzn_qi.jpeg"><br><br>  Arcadia uses its own set of classes for working with strings.  First of all, TStingBuf is an analogue of str :: string_view from C ++ 17. <br><br>  TString is not a std :: sting at all, it is a CopyOnWrite string, so you need to work with it quite carefully.  In addition, TUtf16String is the same TString, only its base type is not char, but 16-bit wchar. <br><br>  And we have tools to convert from strings to strings.  This is ToString, which is analogous to std :: to_string and FromString paired with TryFromString, which allow you to turn a string into the type you need. <br><br><img src="https://habrastorage.org/webt/2f/fo/jv/2ffojvcw39thuqmjwps2cl2kreu.jpeg"><br><br>  We have our own exception structure, the base exception in arcade libraries is yexception, which is inherited from std :: exception.  We have a ythrow macro that adds information about the place from which the exception threw itself at yexception, this is just a convenient wrapper. <br><br>  There is an analogue of std :: current_exception - CurrentExceptionMessage, this function displays the current exception as a string. <br><br>  There are macros for asserts and verifies - these are Y_ASSERT and Y_VERIFY. <br><br><img src="https://habrastorage.org/webt/ac/ao/di/acaodinndi3xj9hr7kiju_vreew.jpeg"><br><br>  And we have our own embedded serialization, it is binary and is not intended to transfer data between different revisions.  Rather, this serialization is needed in order to transfer data between two binaries of the same revision, for example, with distributed training. <br><br>  It so happened that we use two versions of serialization in CatBoost.  The first option works through the interface methods Save and Load, which serialize to the stream.  Another option is used in our distributed learning, it uses a rather old internal library BinSaver, convenient for serializing polymorphic objects that need to be registered in a special factory.  This is necessary for distributed learning, about which we are unlikely to have time to talk about here due to lack of time. <br><br><img src="https://habrastorage.org/webt/lb/oa/q9/lboaq9rvcuexqpoea75mbnbve8g.jpeg"><br><br>  We also have our own analogue boost_optional or std :: optional - TMaybe.  Analog std :: variant - TVariant.  Need to use them. <br><br><img src="https://habrastorage.org/webt/fd/eg/xo/fdegxof00jzhggi1slypv6s_uvi.jpeg"><br><br>  There is also a certain agreement that inside the CatBoost code, instead of yexception, we throw a TCatBoostException.  This is the same yexception, only in it the stack trace is always added when throwing. <br><br>  And we also use the CB_ENSURE macro to conveniently check things and throw exceptions if they are not executed.  For example, we often use this for parsing options or parsing parameters passed by the user. <br><br><img src="https://habrastorage.org/webt/qn/ut/jk/qnutjk-36n7wnibgpx_1xvhzsw4.jpeg"><br><h5>  <sup><sub>Links from the slide: <a href="">first</a> , <a href="">second</a></sub></sup> </h5><br>  Be sure to before starting work we recommend to familiarize yourself with the code style, it consists of two parts.  The first one is a common Arc Style code style, which lies right in the root of the repository in the CPP_STYLE_GUIDE.md file.  Also in the root of the repository is a separate guide for our team: catboost_command_style_guide_extension.md. <br><br>  We try to draw the Python code using PEP8.  It does not always work, because for Cython code the linter doesn't work for us, and sometimes there is something going around with PEP8. <br><br><img src="https://habrastorage.org/webt/dp/cl/kg/dpclkg4wxn_ilcriilpquvfpihk.jpeg"><br><br>  What are the features of our assembly?  The Arcade assembly was initially aimed at collecting the most tightly sealed applications, that is, to have a minimum of external dependencies due to static linking.  This allows you to use the same binary on different versions of Linux without recompilation, which is quite convenient.  Assembly targets are described in ya.make files.  An example of ya.make can be seen on the next slide. <br><br><img src="https://habrastorage.org/webt/ua/zz/eh/uazzehw8w6k-2lo2f49jyk_tv9e.jpeg"><br><br>  If suddenly you want to add some kind of library, program or something else, you can, firstly, just look in the neighboring ya.make-files, and secondly, use this example.  Here we have the most important elements of ya.make.  At the very beginning of the file we say that we want to declare the library, then we list the compilation units that we want to place in this library.  There can be both cpp-files, and, for example, pyx-files, for which Cython will automatically start, and then the compiler.  Library dependencies are listed through the PEERDIR macro.  Here you just write the path to the folder with the library or with another artifact inside, relative to the root of the repository. <br><br>  There is a useful thing, GENERATE_ENUM_SERIALIZATION, necessary to generate ToString, FromString methods for enum classes and enums, described in some header file that you pass to this macro. <br><br><img src="https://habrastorage.org/webt/gj/w3/rq/gjw3rq4uayzgspxh4sj95pcgime.jpeg"><br><br>  Now about the most important - how to compile and run any test.  At the root of the repository lies the ya script, which loads the necessary toolkits and tools, and it has the ya make command - the make subcommand - which allows you to build the -r release with the -r release key, and the -d key with the -d key.  Artifacts in it are transmitted further and separated by a space. <br><br>  To build Python, I immediately pointed out flags here that may be useful.  This is a build with system Python, in this case with Python 3. If all of a sudden CUDA Toolkit is installed on your laptop or development machine, we recommend that you specify the ‚Äìd have_cuda no flag for a faster build.  CUDA has been around for quite some time, especially on 4-core systems. <br><br><img src="https://habrastorage.org/webt/eg/sn/4k/egsn4kcvq8bepyogckxf0p1vylw.jpeg"><br><br>  It should already work ya ide.  This is a tool that will generate clion or qt solution for you.  And for those who came with Windows, we have a Microsoft Visual Studio solution, which lies in the msvs folder. <br><br>  Listener: <br>  - Do you have all the tests through the Python wrapper? <br><br>  Stas: <br>  - No, we separately have tests that are in the pytest folder.  These are tests of our CLI interface, that is, our application.  True, they work through pytest, that is, these are Python functions, in which we make a subprocess check call and check that the program does not crash and works correctly with some parameters. <br><br>  Listener: <br>  - What about unit tests in C ++? <br><br>  Stas: <br>  - We also have unit tests in C ++.  They usually lie in the lib folder in ut subfolders.  And they are written so - unit test or unit test for.  There are examples.  There are special macros to declare a class with unit tests, and separate registers for the function of unit tests. <br><br>  Listener: <br>  - To verify that nothing is broken, it is better to run those and those? <br><br>  Stas: <br>  - Yes.  The only thing, our tests in open source are green only on Linux.  Therefore, if you compile, for example, on a Mac, if there are five tests going to fall there is no harm.  Due to the different implementation of the exhibitors on different platforms, or even some minor differences, the results can diverge greatly. <br><br><img src="https://habrastorage.org/webt/kr/bs/n0/krbsn0v7mas3stqnhzg19l_uwrq.jpeg"><br><br>  For example, take the puzzle.  I want to show some example.  We have a file with puzzles - open_problems.md.  Solve the problem number 4 of open_problems.md.  It is formulated as follows: if the user sets the learning rate to zero, then we should fall from a TCatBoostException.  You need to add validation options. <br><br><img src="https://habrastorage.org/webt/ut/uu/hq/utuuhqx7huwgb0cuqoolyy253vm.jpeg"><br><br>  To begin, we have to create a branch, clone our fork, clone origin, trigger origin, push origin into our fork and then create a branch and start working in it. <br><br>  How do options parsing occur at all?  As I said, we have an important catboost / libs / options folder where parsing of all options is stored. <br><br><img src="https://habrastorage.org/webt/e-/n4/bi/e-n4bi3t-z6l5fedfrlaexyeiza.jpeg"><br><br>  We have all the options stored in the TOption wrapper, which allows us to understand whether the option was redefined by the user.  If it wasn‚Äôt, it stores some default value.  In general, CatBoost parsit all options in the form of a large JSON dictionary, which during parsing turns into nested dictionaries and nested structures. <br><br><img src="https://habrastorage.org/webt/bm/zo/ch/bmzochyhm--wr1cwi9jg5snn3aq.jpeg"><br><br>  We somehow learned ‚Äî for example, by searching for a grep or by reading a code ‚Äî that we have a learning rate in TBoostingOptions.  Let's try to write a code that simply adds CB_ENSURE, that our learning rate is more than std :: numeric_limits :: epsilon, that the user has entered something more or less reasonable. <br><br><img src="https://habrastorage.org/webt/1m/u1/ay/1mu1ay3e5usvwwp51l1ctaxjtqy.jpeg"><br><br>  We just used the CB_ENSURE macro here, wrote some code and now we want to add tests. <br><br><img src="https://habrastorage.org/webt/ut/sb/gq/utsbgqg6miybtxhekflu0w6frie.jpeg"><br><br>  In this case, we add a test on the Command Line Interface.  In the pytest folder, we have a test.py script, where there are already quite a few test samples and you can just pick up something similar to your task, copy it and change the parameters so that it starts to fall or not to fall - depending on the parameters you passed.  In this case, we just take and create a simple pool of two lines.  (We call datasets in Yandex as pools. We have such a feature.) And then we check that our binary really drops, if we pass learning rate 0.0. <br><br><img src="https://habrastorage.org/webt/xb/uk/jn/xbukjnn55irccxybobjki-b8iyw.jpeg"><br><br>  We also add to the python-package test, which is located in atBoost / python-package / ut / medium.  We still have large, large tests that are associated with tests for the assembly of python wheel-packages. <br><br><img src="https://habrastorage.org/webt/ki/jh/1p/kijh1pd1b8rdeyr2scg82dbjtis.jpeg"><br><br>  Next we have the keys for ya make - -t and -A.  -t runs tests, -A forces all tests to run, regardless of whether they have large or medium tags. <br><br>  Here I also used a filter by the name of the test for beauty.  It is specified using the -F option and the test name specified below, which can be wild char-asterisks.  In this case, I used test.py::test_zero_learning_rate*, because, looking at our python tests, you will see: almost all functions accept the task type fixture inside.  This is so that by code our python-package tests look the same for both CPU- and GPU-learning and can be used for tests of GPU and CPU trainer. <br><br><img src="https://habrastorage.org/webt/hz/qj/yf/hzqjyf9cp0mlftldhq74zot4nya.jpeg"><br><br><img src="https://habrastorage.org/webt/d_/qx/g2/d_qxg2fyla89bki38tdx5o3gc68.jpeg"><br><br>  Further we will commit our changes and push them into our forked repository.  We publish pool rekvest.  He has already joined, all is well. </div><p>Source: <a href="https://habr.com/ru/post/458790/">https://habr.com/ru/post/458790/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../458778/index.html">Satellite Reporting Engine 6.5: What It Is And Why</a></li>
<li><a href="../458782/index.html">Adaptation programs for the ZX Spectrum to TR-DOS with modern tools. Part 3</a></li>
<li><a href="../458784/index.html">Broadcasting projects and libraries from Altium Designer to PADS Professional</a></li>
<li><a href="../458786/index.html">The "keepers" of video games, step by step, preserve the gaming culture</a></li>
<li><a href="../458788/index.html">Custom templates in GTM: figure it out</a></li>
<li><a href="../458792/index.html">"Burnt" employees: is there a way out?</a></li>
<li><a href="../458794/index.html">Mitap Business Analysts at Redmadrobot July 18</a></li>
<li><a href="../458796/index.html">How to prepare a website for large loads: 5 practical tips and useful tools</a></li>
<li><a href="../458798/index.html">NutritionBot or how I want to take away the bread from fitness trainers</a></li>
<li><a href="../4588/index.html">Zune in action</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>