<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Exceptions in the UEFI application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Any programmer who is familiar with UEFI is aware that the built-in exception handling mechanism is not there. These are try / except blocks, which ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Exceptions in the UEFI application</h1><div class="post__text post__text-html js-mediator-article">  Any programmer who is familiar with UEFI is aware that the built-in exception handling mechanism is not there.  These are try / except blocks, which are extensions of Microsoft C / C ++ compilers.  It can be very useful to have such a mechanism and fully use the advantages that it provides.  Therefore, in this article we will focus on solving this problem.  Also attached to the article is the full implementation of the mechanism with its demonstration based on the UEFI application.  Only 64-bit processors from Intel are affected, and only they are implied in the discussion.  The implementation of the mechanism is located in the exceptions folder of the git repository at: <a href="">https://github.com/anatolymik/machineries.git</a> . <br><a name="habracut"></a><br>  First, let's talk a little about how exceptions are generally handled.  First of all, the exception is a special situation.  As a rule, an exception occurs because the processor cannot execute a specific instruction.  When such an event occurs, the processor calls an exception handler whose entry point is in the IDT table.  There are many exceptions to the processor, therefore, the corresponding handler is called according to its type. <br><br><div style="text-align:center;"><img hspace="5" src="https://habrastorage.org/files/04e/7d9/5ed/04e7d95ed9014dd687c03f2faae9c5df.png"></div><br>  As can be seen from the figure above, exception handlers are only 256. Moreover, the first 32 are reserved for exceptions.  The rest are used to handle interrupts, which we will not discuss here.  As already mentioned, the corresponding handler is called according to the type of exception.  For example, when dividing a number by 0, an exception handler of 0 is called, or if the processor encounters an unfamiliar instruction in the stream, an exception handler 6 will be called. For more information, see the ‚ÄúIntel 64 and IA-32 Architects Software Developer's Manual‚Äù.  We have just touched on the processor hardware, without which hardware error handling is impossible, but that's not all. <br><br>  Speaking of try / except blocks, it should be mentioned that when the compiler encounters them, it generates meta information that describes the location of each block in the executable file.  This information is located in a separate place, more precisely, in the .pdata section of the PE image. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img hspace="5" src="https://habrastorage.org/files/8eb/3b6/f2c/8eb3b6f2c9bf456c8d0a86f2782b48a3.png"></div><br>  As can be seen from the figure, the code, data and various information about the executable file (for example, as in our case, the descriptors of try / except blocks) are arranged in a single image.  All these data are divided into so-called sections, in accordance with the type of data itself.  Returning to the discussion of the .pdata section, it should be mentioned that for each try / except block, besides its location, the address of its handler is also stored.  Typically, this is code enclosed in the except and finally blocks.  More information about the PE file format can be found in the Microsoft Portable Executable and Common Object File Format Specification.  We have just touched upon the software necessary for the functioning of the mechanism in question, now let's look at all this once again in a comprehensive manner. <br><br>  Despite the fact that try / except blocks are processed by the compiler in the process of generating code, and in general they are the mechanism of the language itself, their operation requires support from the operating system.  Moreover, it should be noted that part of the processing is performed by the operating system, and part is performed by the executable file itself.  There is also some part that is executed by the executable file itself, but is not generated by the compiler, and instead is required to be implemented.  For example, the reserved name __c_specific_handler is the name of the function that is responsible for handling the exception.  In the absence of its implementation, the linker will not be able to generate the executable file.  In the Windows development tools, the implementations of these functions are included in the libraries that are linked with the application. <br><br><div style="text-align:center;"><img hspace="5" src="https://habrastorage.org/files/222/e3d/d3b/222e3dd3b7224f9f9029044461509937.png"></div><br>  As shown in the figure above, when an exception occurs, the processor calls the appropriate handler from the IDT table.  Exception handlers are set by the operating system during its initialization, i.e.  at the time the exception occurs, the operating system itself receives control.  Handlers of all exceptions are very similar, they retain all the necessary information for processing and information unique to a specific type of exception.  Then all these handlers call the search and call handler function.  The function scans the .pdata section in order to find a handler corresponding to a specific section of the code in which the exception occurred.  And if the handler is found, the operating system passes control to it, otherwise the application fails.  We have just reviewed the process of the occurrence and handling of exceptions, so we can proceed to discuss what needs to be done in the UEFI application in order for exceptions to function fully.  Also, it should be noted that the description given is very simplified. <br><br>  Since there is nothing in UEFI that has anything to do with exceptions, it is obvious that all of the above should be implemented.  Further in the process of listing, in order to facilitate the study of source codes from the implementation attached to the article, we will also refer to its functions, files and folders.  First of all, you need to implement exception handlers.  They are located in the exccpu.asm file from the exc folder.  You also need to set their addresses in the IDT, this is performed by the CpuInitializeExceptionHandlers function, located in the exccpu.cpp file from the exc folder.  Almost all of these handlers call the CpuDispatchException function from the exccpu.cpp file, which in fact is the starting point for finding and calling the exception handler.  The DispatchException and UnwindStack functions, which are located in the excdsptch.cpp file from the exc folder, are responsible for finding and calling exception handlers.  To scan the .pdata section, you need the implementation of the PE image processing functions.  These functions are used by the previously mentioned functions for searching and calling exception handlers.  The implementation of the PE image scanning functions is grouped into a separate folder - pe.  Finally, implementations of the reserved functions __C_specific_handler and _local_unwind are needed.  Both functions are implemented in the excchandler.cpp file from the exc folder.  The entry point to the application is the EfiMain function, which is located in the efi.cpp file from the project root.  It should be noted that setting handler addresses in IDT is simplified for demonstration purposes.  If we talk about the full implementation, you will need an isolated IDT. <br><br>  Perhaps that's all.  One has only to add that the description of this mechanism has been repeatedly covered on the Internet in a variety of details.  And this article is unique, rather the attached implementation and demo.  Although, initially when the need arose for the implementation of this mechanism for projects operating outside the Windows environment, the previously mentioned descriptions were not enough.  Including it was necessary to reverse Windows, and the description of UNWIND_INFO version 2 could not be found at all.  Therefore, initially the article was conceived in a different format, in a very detailed one, after which there would be no questions left.  In practice, its writing has degenerated into writing documentation, and not an article, which can be boring to read, because  From the very beginning it is unclear what problem is being solved.  Therefore, it was written just such a simple and easy option, without any details.  A detailed version is planned to publish in parts. </div><p>Source: <a href="https://habr.com/ru/post/320948/">https://habr.com/ru/post/320948/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320936/index.html">Infrastructure simple electronic signature. Part 4: Practical aspects of implementation</a></li>
<li><a href="../320938/index.html">Site protection against hacker attacks - Nemesida Web Application Firewall</a></li>
<li><a href="../320940/index.html">Introduction to error handling in Swift 3</a></li>
<li><a href="../320942/index.html">GitHub introduced tags for repositories</a></li>
<li><a href="../320946/index.html">What I would like to know about promotions and shares, before becoming part of a startup-unicorn</a></li>
<li><a href="../320952/index.html">Founder's advice. Dmitry Barychev, ‚ÄúTrack parcel.rf‚Äù</a></li>
<li><a href="../320954/index.html">Hyper-Converged Platforms: From Exotic to Mainstream</a></li>
<li><a href="../320956/index.html">Google publishes Chrome source code for iOS</a></li>
<li><a href="../320958/index.html">Game theory and poker. Counting the number of possible strategies</a></li>
<li><a href="../320960/index.html">CEF, ES6, Angular 2, TypeScript using .Net Core classes. Creating a cross-platform GUI for .Net using CEF</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>