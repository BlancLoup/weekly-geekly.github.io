<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The second version of the glove to determine the position of the hand</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The last article was unsuccessful and not informative. Initially, I planned to attach the boards and the code for the microcontroller so that anyone c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The second version of the glove to determine the position of the hand</h1><div class="post__text post__text-html js-mediator-article">  The last article was unsuccessful and not informative.  Initially, I planned to attach the boards and the code for the microcontroller so that anyone could assemble it.  But there were so many crutches that it became embarrassing to attach it.  Now I will describe the second glove, which I collected two weeks ago, which contains more advanced sensors and provides more accurate data.  Although it looks much worse: <br><br><img src="https://habrastorage.org/files/971/a4d/de3/971a4dde304c4f31bd7b095806822671.jpg"><br><a name="habracut"></a><br><br><h4>  Differences from the previous version </h4><br>  1) The first is the sensors.  Of course, the angles of inclination can be determined using accelerometers, but in addition to the accelerometer noise, any human movement will also interfere with us, since  When the arm moves, various accelerations act on it, and not just the acceleration of the free fall of the Earth.  Then we decided to take a gyroscope.  But the MEMS gyro is not the gyroscope that was shown to us in physics lessons.  This gyroscope gives the rate of change of the angle.  So in order to get the total angle of deviation from the initial position, we need to integrate these readings.  So not only is the signal obtained discrete, there is also the so-called ‚Äúzero drift‚Äù.  At rest, the gyroscope produces not a zero, but a very small non-zero number.  So the integration will accumulate an error.  This is called low frequency gyroscope noise.  What to do?  This is where the alpha-beta filter comes in.  It looks like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/db8/3b6/5ca/db83b65ca967fb6969ee909ba1abd4d7.jpg" alt="image"><br><br>  The image is brazenly copied from the <a href="https://geektimes.ru/users/bibigone/" class="user_link">bibigone</a> article.  <a href="http://geektimes.ru/post/118192/">The article itself is</a> just awesome.  Anyone who wants to deal with sensors I advise you to read more.  And here I will provide a copy of the description of the filter from the article itself: <br><br><blockquote>  There is a much simpler filter, which is called just ‚Äúalpha-beta‚Äù, which is that, let's say, well, let's continue to integrate, just with a small correction, let's add the angle we get from the accelerometer.  Well, there is a small number of delta, the only parameter of this filter that must be selected.  Why is it such an alpha-beta, sometimes it is also called some kind of "composite filter".  Because this coefficient is large enough, it kills low frequencies, and this coefficient is small, it kills high-frequency noise.  It turns out that you are killing the low frequency of the noise from the integration, and here you are killing the high frequency, the same noise that comes from the sensor itself. </blockquote><br><br>  Everything is nice, of course, but in the same article in the sequel it is said that we don‚Äôt have anywhere to drift around the vector of the acceleration of free fall of the Earth.  So you need somewhere to take another vector that will not coincide with the acceleration vector.  For this, then you need a magnetometer, or as it is also called - a compass. <br>  From all this it follows that we need three sensors: a three-axis accelerometer, a three-axis gyroscope and a three-axis magnetometer.  Three chips on each finger do not want to put - take up a lot of space.  The need to determine the orientation of various devices in space arises so often that they produce combined sensors.  For example, an accelerometer and a gyroscope in one case, or, as in the case of the MPU-9250, all three sensors in one case.  Due to the fact that they have three three-axis sensors, they are called nine-axis sensors.  These gauges we stocked up. <br><br>  2) Microcontroller <br>  Although in the last article there was not a word about it, but still this difference.  In the old glove was chosen by me for the price and the body STM32F050F4.  But the new glove lacked its capabilities.  Neither power nor legs.  So it was decided to buy something in the LQFP64 package.  This something turned out to be STM32F103.  Since the legs were now abundant, it was possible to abandon the use of the shift register. <br><br>  3) Location of sensors.  Or rather their number.  Now the sensors were installed not only on the fingers, but also on the brush, and on the wrist, and on the forearm.  This made it possible to determine the position of the whole arm in space, and not just the fingers. <br><br>  The differences end there, for there is nothing more to be different.  Is that the glove is now on the right hand.  The left glove of this pair was used in the previous version: <br><br><img src="https://habrastorage.org/files/041/6a0/b2d/0416a0b2d2264516b499484ab94d4dbc.jpg"><br><br><h4>  Microcontroller board </h4><br><img src="https://habrastorage.org/files/231/951/091/23195109199a449493e43e21cf343d85.JPG"><br><br>  The board is separated: two SPI, two USART, 15GPIO and SWD.  At the bottom left are three adjacent sites - a place for the LP2950 stabilizer.  Everything else is on the datasheet: capacitors for power (tantalum size D, everything else 0603, although you can also solder 0805 to the same platforms), capacitor on the leg Reset and capacitors for quartz.  The first leg of the microcontroller is the left comb, the top pin.  After sealing all components and wires from the sensors, everything looks terrible: <br><br><img src="https://habrastorage.org/files/d44/8ff/a40/d448ffa40801453c9a27267a62549fb5.jpg"><br><br>  I have nothing to say in justification, except the word "time." <br><br><h4>  Sensor board </h4><br><br><img src="https://habrastorage.org/files/d38/4b3/2d1/d384b32d194a4c81ac65233bba2daa59.bmp"><br><br>  Here, as well as last time, there was a jumper.  It is marked with a red line.  Unlike the last glove, there is a small piping in the face of a 10 pF capacitor on the bottom left and two 0.1 microfarad on the remaining places.  Connection diagram is in datasheet: <br><br><img src="https://habrastorage.org/files/2c4/fea/1bb/2c4fea1bb9434234ad95c7c2a5da5fb2.PNG"><br><br>  I think there is no need for any explanations.  We solder the QFN24 case, solder the jumper and disperse and seal the cable.  By the way, the QFN24 case, although it has a smaller foot pitch than the LGA16, but these legs come out of the sides of the microcircuit and you can easily check the quality of the soldering, and in case of that, solder the failed legs: <br><br><img src="https://habrastorage.org/files/ced/a7b/982/ceda7b9827ad46af9187a42ff1e62e1d.jpg"><br><br><h4>  Sensor initialization </h4><br><br>  Actually we got to the programming of this whole mess.  Here I will immediately tell you about my shoals in the previous stages: I personally used the STM32F103RB microcontroller.  MK with prefixes R8 and RB have not only reduced memory, but also reduced peripherals.  In particular, there is no USART4, which is in their more ‚Äúvoluminous‚Äù brethren.  And due to my carelessness, I tried to turn it on for a very long time.  After all, he divorced me.  The fact that USART1 was divorced "just in case" saves us.  It remap the legs of the PB6 and PB7 microcontroller.  Actually we will do this when we initialize it.  But back to the sensor. <br><br>  The code given here is also suitable for MPU-6050.  This is the same sensor, but without a magnetometer. <br><br>  First you need to initialize SPI.  For this we use the following function: <br><div class="spoiler">  <b class="spoiler_title">SPI Initialization</b> <div class="spoiler_text"><pre><code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> HeInitSpi(<span class="hljs-type"><span class="hljs-type">void</span></span>) { RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA|RCC_APB2Periph_AFIO, <span class="hljs-keyword"><span class="hljs-keyword">ENABLE</span></span>); //       GPIO RCC_APB2PeriphClockCmd(RCC_APB2Periph_SPI1, <span class="hljs-keyword"><span class="hljs-keyword">ENABLE</span></span>); //  SPI GPIO_InitTypeDef SpiPort; SPI_InitTypeDef SPI_InitStructure; SpiPort.GPIO_Mode = GPIO_Mode_AF_PP; //  Push-Pull SpiPort.GPIO_Speed = GPIO_Speed_10MHz; //   <span class="hljs-number"><span class="hljs-number">10</span></span>MHz SpiPort.GPIO_Pin = GPIO_Pin_5 | GPIO_Pin_7 | GPIO_Pin_4; //  - <span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> GPIO_Init(GPIOA, &amp;SpiPort); //  . SpiPort.GPIO_Mode = GPIO_Mode_IPU; //     SpiPort.GPIO_Pin = GPIO_Pin_6; //  - <span class="hljs-number"><span class="hljs-number">6</span></span> GPIO_Init(GPIOA, &amp;SpiPort); //   SPI_InitStructure.SPI_Direction = SPI_Direction_2Lines_FullDuplex; //   SPI_InitStructure.SPI_DataSize = SPI_DataSize_8b; //  <span class="hljs-number"><span class="hljs-number">8</span></span>  SPI_InitStructure.SPI_CPOL = SPI_CPOL_Low; //  -  SPI_InitStructure.SPI_CPHA = SPI_CPHA_1Edge; //    SPI_InitStructure.SPI_NSS = SPI_NSS_Soft; //  NSS SPI_InitStructure.SPI_BaudRatePrescaler = SPI_BaudRatePrescaler_16; //   SPI SPI_InitStructure.SPI_FirstBit = SPI_FirstBit_MSB; SPI_InitStructure.SPI_Mode = SPI_Mode_Master; // -  SPI_Init(SPI1, &amp;SPI_InitStructure); // SPI SPI_Cmd(SPI1, <span class="hljs-keyword"><span class="hljs-keyword">ENABLE</span></span>); // SPI SPI_NSSInternalSoftwareConfig(SPI1, SPI_NSSInternalSoft_Set); }</code> </pre> <br></div></div><br>  Now you need to initialize the legs of the microcontroller, which are connected to the CS pins of the sensors.  Let's get defines for all sensors and write some functions that will simplify our life (for now, do not pay attention that I have only 6 sensors): <br><div class="spoiler">  <b class="spoiler_title">Code for sensors</b> <div class="spoiler_text"><pre> <code class="hljs kotlin">#define SENSOR_0_PORT GPIOA #define SENSOR_1_PORT GPIOA #define SENSOR_2_PORT GPIOA #define SENSOR_3_PORT GPIOC #define SENSOR_4_PORT GPIOC #define SENSOR_5_PORT GPIOC #define SENSOR_0_PIN GPIO_Pin_11 #define SENSOR_1_PIN GPIO_Pin_9 #define SENSOR_2_PIN GPIO_Pin_8 #define SENSOR_3_PIN GPIO_Pin_9 #define SENSOR_4_PIN GPIO_Pin_8 #define SENSOR_5_PIN GPIO_Pin_7 void HeInitSensorsPort(void) { RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA|RCC_APB2Periph_GPIOC|RCC_APB2Periph_AFIO, ENABLE); GPIO_InitTypeDef SensorsGpioPin; SensorsGpioPin.GPIO_Mode = GPIO_Mode_Out_PP; SensorsGpioPin.GPIO_Speed = GPIO_Speed_10MHz; SensorsGpioPin.GPIO_Pin = SENSOR_0_PIN|SENSOR_1_PIN|SENSOR_2_PIN; GPIO_Init(SENSOR_0_PORT, &amp;SensorsGpioPin); SensorsGpioPin.GPIO_Pin = SENSOR_3_PIN|SENSOR_4_PIN|SENSOR_5_PIN; GPIO_Init(SENSOR_5_PORT, &amp;SensorsGpioPin); } void HeReselectSensors(void) { GPIO_SetBits(SENSOR_0_PORT, SENSOR_0_PIN); GPIO_SetBits(SENSOR_1_PORT, SENSOR_1_PIN); GPIO_SetBits(SENSOR_2_PORT, SENSOR_2_PIN); GPIO_SetBits(SENSOR_3_PORT, SENSOR_3_PIN); GPIO_SetBits(SENSOR_4_PORT, SENSOR_4_PIN); GPIO_SetBits(SENSOR_5_PORT, SENSOR_5_PIN); } void HeSelectSensor (uint16_t <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) { switch (<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) { case <span class="hljs-number"><span class="hljs-number">0</span></span>: HeReselectSensors(); GPIO_ResetBits(SENSOR_0_PORT, SENSOR_0_PIN); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">1</span></span>: HeReselectSensors(); GPIO_ResetBits(SENSOR_1_PORT, SENSOR_1_PIN); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">2</span></span>: HeReselectSensors(); GPIO_ResetBits(SENSOR_2_PORT, SENSOR_2_PIN); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">3</span></span>: HeReselectSensors(); GPIO_ResetBits(SENSOR_3_PORT, SENSOR_3_PIN); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">4</span></span>: HeReselectSensors(); GPIO_ResetBits(SENSOR_4_PORT, SENSOR_4_PIN); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">5</span></span>: HeReselectSensors(); GPIO_ResetBits(SENSOR_5_PORT, SENSOR_5_PIN); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre><br></div></div><br>  Looks a little clumsy.  It works like this: to select sensor number n, I call the function HeSelectSensor (n).  After that, on the leg, behind which the sensor is fixed in the defaults, a logical 0 will be set, which means the beginning of work with the sensor. <br>  Also we will write functions for communication with sensors: <br><div class="spoiler">  <b class="spoiler_title">Functions for communicating with sensors</b> <div class="spoiler_text"><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">uint8_t</span></span> <span class="hljs-type"><span class="hljs-type">HeSendToSpi</span></span>(uint16_t nsensor, uint8_t addres, uint8_t <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HeSelectSensor(nsensor)</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_SendData</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addres</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">while</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_GetFlagStatus</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI1</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_FLAG_BSY</span></span></span><span class="hljs-class">) == </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SET</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_ReceiveData(SPI1)</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_ReceiveData(SPI1)</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_SendData</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">while</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_GetFlagStatus</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI1</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_FLAG_BSY</span></span></span><span class="hljs-class">) == </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SET</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HeReselectSensors</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_ReceiveData(SPI1)</span></span></span><span class="hljs-class">; } void writeByte(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">address</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subAddress</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) { /*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">char</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data_write</span></span></span><span class="hljs-class">[2]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data_write</span></span></span><span class="hljs-class">[0] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subAddress</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data_write</span></span></span><span class="hljs-class">[1] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i2c</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">write</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">address</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data_write</span></span></span><span class="hljs-class">, 2, 0);*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">address</span></span></span><span class="hljs-class">==</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MPU9250_ADDRESS</span></span></span><span class="hljs-class">){ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HeSelectSensor(sensor)</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_SendData</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subAddress</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">while</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_GetFlagStatus</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI1</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_FLAG_BSY</span></span></span><span class="hljs-class">) == </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SET</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_ReceiveData(SPI1)</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_ReceiveData(SPI1)</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_SendData</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">while</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_GetFlagStatus</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI1</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_FLAG_BSY</span></span></span><span class="hljs-class">) == </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SET</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_ReceiveData(SPI1)</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HeReselectSensors</span></span></span><span class="hljs-class">(); } else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">address</span></span></span><span class="hljs-class">==</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AK8963_ADDRESS</span></span></span><span class="hljs-class">){ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HeSelectSensor(sensor)</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">writeByte</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MPU9250_ADDRESS</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2C_SLV4_ADDR</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2C_SLV4_ADDR</span></span></span><span class="hljs-class">&amp;0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b01111111</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">writeByte</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MPU9250_ADDRESS</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2C_SLV4_REG</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subAddress</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">writeByte</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MPU9250_ADDRESS</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2C_SLV4_DO</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">writeByte</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MPU9250_ADDRESS</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2C_SLV4_CTRL</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2C_SLV4_CTRL</span></span></span><span class="hljs-class">|0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b10000000</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">=0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">&lt;0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">xFF</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HeReselectSensors</span></span></span><span class="hljs-class">(); } } uint8_t readByte(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">address</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subAddress</span></span></span><span class="hljs-class">) { /*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">char</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">[1]; // `</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">` </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">will</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">store</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">register</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">char</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data_write</span></span></span><span class="hljs-class">[1]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data_write</span></span></span><span class="hljs-class">[0] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subAddress</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i2c</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">write</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">address</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data_write</span></span></span><span class="hljs-class">, 1, 1); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">no</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stop</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i2c</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">read</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">address</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, 1, 0); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">[0];*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">address</span></span></span><span class="hljs-class">==</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MPU9250_ADDRESS</span></span></span><span class="hljs-class">){ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HeSelectSensor(sensor)</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_SendData</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subAddress</span></span></span><span class="hljs-class">|0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b10000000</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">while</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_GetFlagStatus</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI1</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_FLAG_BSY</span></span></span><span class="hljs-class">) == </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SET</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_ReceiveData(SPI1)</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_ReceiveData(SPI1)</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_SendData</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI1</span></span></span><span class="hljs-class">, 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">xAA</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">while</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_GetFlagStatus</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI1</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_FLAG_BSY</span></span></span><span class="hljs-class">) == </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SET</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">=</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_ReceiveData(SPI1)</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HeReselectSensors</span></span></span><span class="hljs-class">(); } else if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">address</span></span></span><span class="hljs-class">==</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AK8963_ADDRESS</span></span></span><span class="hljs-class">){ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HeSelectSensor(sensor)</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">writeByte</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MPU9250_ADDRESS</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2C_SLV4_ADDR</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AK8963_ADDRESS</span></span></span><span class="hljs-class">|0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b10000000</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">writeByte</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MPU9250_ADDRESS</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2C_SLV4_REG</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subAddress</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">writeByte</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MPU9250_ADDRESS</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2C_SLV4_CTRL</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2C_SLV4_CTRL</span></span></span><span class="hljs-class">|0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b10000000</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">=0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">&lt;0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">xFF</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">readByte</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MPU9250_ADDRESS</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2C_SLV4_DI</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HeReselectSensors</span></span></span><span class="hljs-class">(); } return (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">); } void readBytes(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint16_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">address</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subAddress</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">count</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dest</span></span></span><span class="hljs-class">) { /*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">char</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">[14]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">char</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data_write</span></span></span><span class="hljs-class">[1]; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data_write</span></span></span><span class="hljs-class">[0] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subAddress</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i2c</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">write</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">address</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data_write</span></span></span><span class="hljs-class">, 1, 1); // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">no</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stop</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i2c</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">read</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">address</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">count</span></span></span><span class="hljs-class">, 0);*/ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ii</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uint8_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">address</span></span></span><span class="hljs-class">==</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MPU9250_ADDRESS</span></span></span><span class="hljs-class">){ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ii</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ii</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">count</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ii</span></span></span><span class="hljs-class">++) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HeSelectSensor(sensor)</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_SendData</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI1</span></span></span><span class="hljs-class">, ((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subAddress</span></span></span><span class="hljs-class">|0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b10000000</span></span></span><span class="hljs-class">)+</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ii</span></span></span><span class="hljs-class">)); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">while</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_GetFlagStatus</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI1</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_FLAG_BSY</span></span></span><span class="hljs-class">) == </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SET</span></span></span><span class="hljs-class">); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_ReceiveData(SPI1)</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_ReceiveData(SPI1)</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_SendData</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI1</span></span></span><span class="hljs-class">, 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">xAA</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">while</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_GetFlagStatus</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI1</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_FLAG_BSY</span></span></span><span class="hljs-class">) == </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SET</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">=</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SPI_I2S_ReceiveData(SPI1)</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dest</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ii</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HeReselectSensors</span></span></span><span class="hljs-class">(); } } else for(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ii</span></span></span><span class="hljs-class"> = 0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ii</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">count</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ii</span></span></span><span class="hljs-class">++) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">address</span></span></span><span class="hljs-class">==</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AK8963_ADDRESS</span></span></span><span class="hljs-class">){ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HeSelectSensor(sensor)</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">writeByte</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MPU9250_ADDRESS</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2C_SLV4_ADDR</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2C_SLV4_ADDR</span></span></span><span class="hljs-class">|0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b10000000</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">writeByte</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MPU9250_ADDRESS</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2C_SLV4_REG</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subAddress</span></span></span><span class="hljs-class">+</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ii</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">writeByte</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MPU9250_ADDRESS</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2C_SLV4_CTRL</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2C_SLV4_CTRL</span></span></span><span class="hljs-class">|0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b10000000</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">for</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">=0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">&lt;0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">xFF</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">++); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">readByte</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MPU9250_ADDRESS</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I2C_SLV4_DI</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dest</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ii</span></span></span><span class="hljs-class">] = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">d</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HeReselectSensors</span></span></span><span class="hljs-class">(); } } }</span></span></code> </pre><br></div></div><br>  Now you can try to check the performance of the sensors.  To do this, poll the register WHO_AM_I and see the answer.  If everything is good, then the value of this register will coincide with the default value from the datasheet: <br><br><img src="https://habrastorage.org/files/758/ffb/9b0/758ffb9b0efd47c78200630cd72a476e.jpg"><br><br>  After this ping, I found out that two sensors do not work for me.  It was 4 hours before the plane, all the equipment was already packed in a suitcase, so I decided to score on two sensors, because they were located on the fingers, and not on the wrist or hand.  Fuh.  Now it seems all preparations are over and you can proceed to initialize the sensor.  First, I wrote my initialization, and then, while working on the glove, I found a <a href="">library</a> in which everything was well written and with comments.  But all the code was for the F401-Nucleo board and the SPI interface.  I had to rewrite a lot.  And the result of the initialization rewrite looks like this: <br><div class="spoiler">  <b class="spoiler_title">Sensor initialization</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">void</span></span> initMPU9250(uint16_t sensor) { // Initialize MPU9250 device // wake up device writeByte(sensor, MPU9250_ADDRESS, PWR_MGMT_1, <span class="hljs-number"><span class="hljs-number">0x00</span></span>); // Clear sleep mode <span class="hljs-type"><span class="hljs-type">bit</span></span> (<span class="hljs-number"><span class="hljs-number">6</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> sensors <span class="hljs-type"><span class="hljs-type">int</span></span> i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">0x3FF</span></span>; i++); // Delay <span class="hljs-number"><span class="hljs-number">100</span></span> ms <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> PLL <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> established <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> x-axis gyro; should <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> PLL ready interrupt readByte(sensor, MPU9250_ADDRESS, WHO_AM_I_MPU9250); // <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">stable</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span> source writeByte(sensor, MPU9250_ADDRESS, PWR_MGMT_1, <span class="hljs-number"><span class="hljs-number">0x01</span></span>); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> clock source <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> be PLL <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> x-axis gyroscope reference, bits <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> = <span class="hljs-number"><span class="hljs-number">001</span></span> // Configure Gyro <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> Accelerometer // <span class="hljs-keyword"><span class="hljs-keyword">Disable</span></span> FSYNC <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> accelerometer <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> gyro bandwidth <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span> Hz, respectively; // DLPF_CFG = bits <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> = <span class="hljs-number"><span class="hljs-number">010</span></span>; this sets the sample rate at <span class="hljs-number"><span class="hljs-number">1</span></span> kHz <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">both</span></span> // Maximum delay <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">4.9</span></span> ms which <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> just <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> a <span class="hljs-number"><span class="hljs-number">200</span></span> Hz maximum rate writeByte(sensor, MPU9250_ADDRESS, CONFIG, <span class="hljs-number"><span class="hljs-number">0x03</span></span>); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> sample rate = gyroscope output rate/(<span class="hljs-number"><span class="hljs-number">1</span></span> + SMPLRT_DIV) writeByte(sensor, MPU9250_ADDRESS, SMPLRT_DIV, <span class="hljs-number"><span class="hljs-number">0x04</span></span>); // Use a <span class="hljs-number"><span class="hljs-number">200</span></span> Hz rate; the same rate <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> CONFIG above // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> gyroscope <span class="hljs-keyword"><span class="hljs-keyword">full</span></span> scale range // Range selects FS_SEL <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> AFS_SEL are <span class="hljs-number"><span class="hljs-number">0</span></span> - <span class="hljs-number"><span class="hljs-number">3</span></span>, so <span class="hljs-number"><span class="hljs-number">2</span></span>-<span class="hljs-type"><span class="hljs-type">bit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> are left-shifted <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> positions <span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span> uint8_t c = readByte(sensor, MPU9250_ADDRESS, GYRO_CONFIG); writeByte(sensor, MPU9250_ADDRESS, GYRO_CONFIG, c &amp; ~<span class="hljs-number"><span class="hljs-number">0xE0</span></span>); // Clear self-test bits [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span>] writeByte(sensor, MPU9250_ADDRESS, GYRO_CONFIG, c &amp; ~<span class="hljs-number"><span class="hljs-number">0x18</span></span>); // Clear AFS bits [<span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>] writeByte(sensor, MPU9250_ADDRESS, GYRO_CONFIG, c | Gscale &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">full</span></span> scale range <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the gyro // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> accelerometer <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> c = readByte(sensor, MPU9250_ADDRESS, ACCEL_CONFIG); writeByte(sensor, MPU9250_ADDRESS, ACCEL_CONFIG, c &amp; ~<span class="hljs-number"><span class="hljs-number">0xE0</span></span>); // Clear self-test bits [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span>] writeByte(sensor, MPU9250_ADDRESS, ACCEL_CONFIG, c &amp; ~<span class="hljs-number"><span class="hljs-number">0x18</span></span>); // Clear AFS bits [<span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>] writeByte(sensor, MPU9250_ADDRESS, ACCEL_CONFIG, c | Ascale &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">full</span></span> scale range <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the accelerometer // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> accelerometer sample rate <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> // It <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> possible <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> a <span class="hljs-number"><span class="hljs-number">4</span></span> kHz sample rate <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the accelerometer <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> choosing <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> // accel_fchoice_b <span class="hljs-type"><span class="hljs-type">bit</span></span> [<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> this <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> the bandwidth <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">1.13</span></span> kHz c = readByte(sensor, MPU9250_ADDRESS, ACCEL_CONFIG2); writeByte(sensor, MPU9250_ADDRESS, ACCEL_CONFIG2, c &amp; ~<span class="hljs-number"><span class="hljs-number">0x0F</span></span>); // Clear accel_fchoice_b (<span class="hljs-type"><span class="hljs-type">bit</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> A_DLPFG (bits [<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]) writeByte(sensor, MPU9250_ADDRESS, ACCEL_CONFIG2, c | <span class="hljs-number"><span class="hljs-number">0x03</span></span>); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> accelerometer rate <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> kHz <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> bandwidth <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">41</span></span> Hz // The accelerometer, gyro, <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> thermometer are <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> kHz sample rates, // but <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> these rates are further reduced <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> a factor <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> Hz because <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the SMPLRT_DIV setting // Configure Interrupts <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> Bypass <span class="hljs-keyword"><span class="hljs-keyword">Enable</span></span> // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> interrupt pin active high, push-pull, <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> clear <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> INT_STATUS, <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> I2C_BYPASS_EN so additional chips // can <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> the I2C bus <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> can be controlled <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> the Arduino <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> master writeByte(sensor, MPU9250_ADDRESS, INT_PIN_CFG, <span class="hljs-number"><span class="hljs-number">0x22</span></span>); writeByte(sensor, MPU9250_ADDRESS, INT_ENABLE, <span class="hljs-number"><span class="hljs-number">0x01</span></span>); // <span class="hljs-keyword"><span class="hljs-keyword">Enable</span></span> data ready (<span class="hljs-type"><span class="hljs-type">bit</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>) interrupt writeByte(sensor, MPU9250_ADDRESS, I2C_SLV4_ADDR, AK8963_ADDRESS); // Address <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> mag <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> I2C bus writeByte(sensor, MPU9250_ADDRESS, I2C_MST_CTRL, I2C_MST_CTRL|<span class="hljs-number"><span class="hljs-number">0x0D</span></span>); // Speed <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> I2C <span class="hljs-number"><span class="hljs-number">400</span></span>kHz }</code> </pre><br></div></div><br>  Let's thank the author of the library for the initialization that has earned from the first time.  In general, the library is wonderful, but for I2C and for fans of the mbed library. <br><br>  Now that the sensors are initialized, we can proceed to receive the data. <br><br><h4>  Receiving and processing data </h4><br><br>  First you need to teach the controller to communicate with the computer.  And then there will be nowhere to transmit our data.  To do this, initialize USART1.  In this case, do not forget about REMAP legs. <br><div class="spoiler">  <b class="spoiler_title">USART Initialization</b> <div class="spoiler_text"><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">void</span></span> <span class="hljs-type"><span class="hljs-type">HeInitUsartGpio</span></span>(void) { <span class="hljs-type"><span class="hljs-type">GPIO_InitTypeDef</span></span> <span class="hljs-type"><span class="hljs-type">UsartGPIO</span></span>; <span class="hljs-type"><span class="hljs-type">RCC_APB2PeriphClockCmd</span></span>(<span class="hljs-type"><span class="hljs-type">RCC_APB2Periph_GPIOB</span></span>|<span class="hljs-type"><span class="hljs-type">RCC_APB2Periph_AFIO</span></span>, <span class="hljs-type"><span class="hljs-type">ENABLE</span></span>); <span class="hljs-type"><span class="hljs-type">UsartGPIO</span></span>.<span class="hljs-type"><span class="hljs-type">GPIO_Mode</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_Mode_AF_PP</span></span>; <span class="hljs-type"><span class="hljs-type">UsartGPIO</span></span>.<span class="hljs-type"><span class="hljs-type">GPIO_Speed</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_Speed_10MHz</span></span>; <span class="hljs-type"><span class="hljs-type">UsartGPIO</span></span>.<span class="hljs-type"><span class="hljs-type">GPIO_Pin</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_Pin_6</span></span>; <span class="hljs-type"><span class="hljs-type">GPIO_Init</span></span>(<span class="hljs-type"><span class="hljs-type">GPIOB</span></span>, &amp;<span class="hljs-type"><span class="hljs-type">UsartGPIO</span></span>); <span class="hljs-type"><span class="hljs-type">UsartGPIO</span></span>.<span class="hljs-type"><span class="hljs-type">GPIO_Mode</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_Mode_IN_FLOATING</span></span>; <span class="hljs-type"><span class="hljs-type">UsartGPIO</span></span>.<span class="hljs-type"><span class="hljs-type">GPIO_Pin</span></span> = <span class="hljs-type"><span class="hljs-type">GPIO_Pin_7</span></span>; <span class="hljs-type"><span class="hljs-type">GPIO_Init</span></span>(<span class="hljs-type"><span class="hljs-type">GPIOB</span></span>, &amp;<span class="hljs-type"><span class="hljs-type">UsartGPIO</span></span>); <span class="hljs-type"><span class="hljs-type">GPIO_PinRemapConfig</span></span>(<span class="hljs-type"><span class="hljs-type">GPIO_Remap_USART1</span></span>, <span class="hljs-type"><span class="hljs-type">ENABLE</span></span>); } void <span class="hljs-type"><span class="hljs-type">HeInitUsart</span></span>(void) { <span class="hljs-type"><span class="hljs-type">HeInitUsartGpio</span></span>(); <span class="hljs-type"><span class="hljs-type">USART_InitTypeDef</span></span> <span class="hljs-type"><span class="hljs-type">USART1_InitStructure</span></span>; <span class="hljs-type"><span class="hljs-type">RCC_APB2PeriphClockCmd</span></span>(<span class="hljs-type"><span class="hljs-type">RCC_APB2Periph_USART1</span></span>, <span class="hljs-type"><span class="hljs-type">ENABLE</span></span>); <span class="hljs-type"><span class="hljs-type">USART1_InitStructure</span></span>.<span class="hljs-type"><span class="hljs-type">USART_BaudRate</span></span> = <span class="hljs-number"><span class="hljs-number">115200</span></span>; <span class="hljs-type"><span class="hljs-type">USART1_InitStructure</span></span>.<span class="hljs-type"><span class="hljs-type">USART_HardwareFlowControl</span></span> = <span class="hljs-type"><span class="hljs-type">USART_HardwareFlowControl_None</span></span>; <span class="hljs-type"><span class="hljs-type">USART1_InitStructure</span></span>.<span class="hljs-type"><span class="hljs-type">USART_Mode</span></span> = <span class="hljs-type"><span class="hljs-type">USART_Mode_Rx</span></span>|<span class="hljs-type"><span class="hljs-type">USART_Mode_Tx</span></span>; <span class="hljs-type"><span class="hljs-type">USART1_InitStructure</span></span>.<span class="hljs-type"><span class="hljs-type">USART_Parity</span></span> = <span class="hljs-type"><span class="hljs-type">USART_Parity_No</span></span>; <span class="hljs-type"><span class="hljs-type">USART1_InitStructure</span></span>.<span class="hljs-type"><span class="hljs-type">USART_StopBits</span></span> = <span class="hljs-type"><span class="hljs-type">USART_StopBits_1</span></span>; <span class="hljs-type"><span class="hljs-type">USART1_InitStructure</span></span>.<span class="hljs-type"><span class="hljs-type">USART_WordLength</span></span> = <span class="hljs-type"><span class="hljs-type">USART_WordLength_8b</span></span>; <span class="hljs-type"><span class="hljs-type">USART_Init</span></span>(<span class="hljs-type"><span class="hljs-type">USART1</span></span>, &amp;<span class="hljs-type"><span class="hljs-type">USART1_InitStructure</span></span>); <span class="hljs-type"><span class="hljs-type">USART_Cmd</span></span>(<span class="hljs-type"><span class="hljs-type">USART1</span></span>, <span class="hljs-type"><span class="hljs-type">ENABLE</span></span>); } void <span class="hljs-type"><span class="hljs-type">HeSendToUsart</span></span> (uint8_t <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">USART_SendData</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">USART1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">while</span></span></span><span class="hljs-class">(!(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">USART_GetFlagStatus</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">USART1</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">USART_FLAG_TC</span></span></span><span class="hljs-class">))); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">USART_ClearFlag</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">USART1</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">USART_FLAG_TC</span></span></span><span class="hljs-class">); }</span></span></code> </pre><br></div></div><br>  To send data we will use the HeSendToUsart function. <br><br>  Now we can write the main function and interrupts: <br><div class="spoiler">  <b class="spoiler_title">main and Ko</b> <div class="spoiler_text"><pre> <code class="hljs matlab">int main(void) { HeInitUsart(); HeInitSensorsPort(); HeInitSpi(); initMPU9250(<span class="hljs-number"><span class="hljs-number">0</span></span>); RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM4,ENABLE); TIM4-&gt;PSC = <span class="hljs-number"><span class="hljs-number">7200</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span>; TIM4-&gt;ARR = <span class="hljs-number"><span class="hljs-number">100</span></span> ; TIM4-&gt;DIER |= TIM_DIER_UIE; TIM4-&gt;CR1 |= TIM_CR1_CEN; NVIC_InitTypeDef TIMQ; TIMQ.NVIC_IRQChannel = TIM4_IRQn; TIMQ.NVIC_IRQChannelCmd = ENABLE; NVIC_Init(&amp;TIMQ); int <span class="hljs-built_in"><span class="hljs-built_in">j</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>){ int p; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (p=<span class="hljs-number"><span class="hljs-number">0</span></span>; p&lt;<span class="hljs-number"><span class="hljs-number">18</span></span>; p++) { HeSendToUsart(SensBuf[p]); HeDelay(<span class="hljs-number"><span class="hljs-number">0xFF</span></span>); } HeDelay(<span class="hljs-number"><span class="hljs-number">0x2FFFF</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } void TIM4_IRQHandler(void) { TIM4-&gt;SR &amp;= ~TIM_SR_UIF; int ax, ay, az, gx, gy, gz; int <span class="hljs-built_in"><span class="hljs-built_in">j</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">j</span></span>&lt;<span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">j</span></span>++){ readAccelData(<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>, accelCount); readGyroData(<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>, gyroCount); ax = accelCount[<span class="hljs-number"><span class="hljs-number">0</span></span>]; ay = accelCount[<span class="hljs-number"><span class="hljs-number">1</span></span>]; az = accelCount[<span class="hljs-number"><span class="hljs-number">2</span></span>]; gx = gyroCount[<span class="hljs-number"><span class="hljs-number">0</span></span>]; gy = gyroCount[<span class="hljs-number"><span class="hljs-number">1</span></span>]; gz = gyroCount[<span class="hljs-number"><span class="hljs-number">2</span></span>]; hy[<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>] =((<span class="hljs-number"><span class="hljs-number">1</span></span> - (r/<span class="hljs-number"><span class="hljs-number">100</span></span>)) * (hy[<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>] + (gy*<span class="hljs-number"><span class="hljs-number">0.00762939</span></span>) * <span class="hljs-number"><span class="hljs-number">0.01</span></span>)) + ((r/<span class="hljs-number"><span class="hljs-number">100</span></span>) * (<span class="hljs-number"><span class="hljs-number">90</span></span>+(<span class="hljs-number"><span class="hljs-number">180</span></span>/<span class="hljs-number"><span class="hljs-number">3.1415</span></span>)*<span class="hljs-built_in"><span class="hljs-built_in">atan2</span></span>(-az,-ax))); hx[<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>] =((<span class="hljs-number"><span class="hljs-number">1</span></span> - (r/<span class="hljs-number"><span class="hljs-number">100</span></span>)) * (hx[<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>] + (gx*<span class="hljs-number"><span class="hljs-number">0.00762939</span></span>) * <span class="hljs-number"><span class="hljs-number">0.01</span></span>)) + ((r/<span class="hljs-number"><span class="hljs-number">100</span></span>) * (<span class="hljs-number"><span class="hljs-number">180</span></span>/<span class="hljs-number"><span class="hljs-number">3.1415</span></span>)*<span class="hljs-built_in"><span class="hljs-built_in">atan2</span></span>(ay,az)); hz[<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>] =((<span class="hljs-number"><span class="hljs-number">1</span></span> - (r/<span class="hljs-number"><span class="hljs-number">100</span></span>)) * (hz[<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>] + (gz*<span class="hljs-number"><span class="hljs-number">0.00762939</span></span>) * <span class="hljs-number"><span class="hljs-number">0.01</span></span>)) + ((r/<span class="hljs-number"><span class="hljs-number">100</span></span>) * (<span class="hljs-number"><span class="hljs-number">90</span></span>+(<span class="hljs-number"><span class="hljs-number">180</span></span>/<span class="hljs-number"><span class="hljs-number">3.1415</span></span>)*<span class="hljs-built_in"><span class="hljs-built_in">atan2</span></span>(-ay, ax))); SensBuf[<span class="hljs-number"><span class="hljs-number">0</span></span>+<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>*<span class="hljs-number"><span class="hljs-number">3</span></span>] = ((uint8_t)(int)(hx[<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>]*<span class="hljs-number"><span class="hljs-number">255</span></span>/<span class="hljs-number"><span class="hljs-number">360</span></span>)); SensBuf[<span class="hljs-number"><span class="hljs-number">1</span></span>+<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>*<span class="hljs-number"><span class="hljs-number">3</span></span>] = ((uint8_t)(int)(hy[<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>]*<span class="hljs-number"><span class="hljs-number">255</span></span>/<span class="hljs-number"><span class="hljs-number">360</span></span>)); SensBuf[<span class="hljs-number"><span class="hljs-number">2</span></span>+<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>*<span class="hljs-number"><span class="hljs-number">3</span></span>] = ((uint8_t)(int)(hz[<span class="hljs-number"><span class="hljs-number">5</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>]*<span class="hljs-number"><span class="hljs-number">255</span></span>/<span class="hljs-number"><span class="hljs-number">360</span></span>)); } }</code> </pre><br></div></div><br>  This is where the tail comes in.  First of all, we initialize everything.  This is as usual.  And then for some reason we turn on the timer.  What for?  And with it, we will add the gyroscope readings at regular intervals.  The timer is set to 100 interrupts per second.  So the sampling rate of the sensors will be 100 sps.  Then there is an endless loop in which a delay is made, after which an array of sensor data is sent.  The array looks like xyz of the first sensor, xyz of the second sensor, etc.  Only 18 values ‚Äã‚Äã(3 axes on 6 sensors). <br>  In the interrupt, we first read the accelerometer and gyro readings, and then substitute the alpha-beta filter.  There are two magic numbers.  0.00762939 is the resolution of the gyroscope.  Those.  With this coefficient, we translate the number taken from the gyroscope into an angle.  The second magic number is 0.01.  This is the actual time between measurements in seconds.  This is what the timer is used for - so that we always know for sure the elapsed time between measurements.  The incomprehensible variable r is the alpha-beta filter coefficient multiplied by 100. It is declared at the very beginning of the program and is equal to 10. <br>  Phew  Well, almost everything!  You can receive data.  True, these data are not entirely simple.  Since we send an eight-bit number to USART, we had to dodge with an angle: the number of 360/256 shares is sent.  That is, the angle of inclination of 90 degrees corresponds to the value 63. <br><br><h4>  That's all! </h4><br><br>  Cheers cheers.  And on this I killed a week and one night.  Here are the sources for the CooCox environment: <br>  <a href="https://www.dropbox.com/sh/g0vs5xwuqvp8cz3/AAAAYJBuWx4T6e--4wbtG6XLa%3Fdl%3D0">Project</a> <br>  If someone has worked with these sensors and he has a working code for working with a magnetometer via SPI, then I will be very grateful for his help.  I hope this article was more interesting and more useful than the previous one. <br><br>  PS I forgot to write about my biggest mess!  My magnetometer did not work (Therefore, I ask you to share the working code. </div><p>Source: <a href="https://habr.com/ru/post/250629/">https://habr.com/ru/post/250629/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../250617/index.html">Survey: how do you solve the problem of synchronizing parallel PHP queries?</a></li>
<li><a href="../250621/index.html">300 amazing free services</a></li>
<li><a href="../250623/index.html">Flourishing neocartography</a></li>
<li><a href="../250625/index.html">How does the brain work?</a></li>
<li><a href="../250627/index.html">Technical report on the activities of a criminal group engaged in targeted attacks - Anunak</a></li>
<li><a href="../250631/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 147 (February 9 - 15, 2015)</a></li>
<li><a href="../250633/index.html">Machine learning - 1. Correlation and regression. Example: site visitors conversion</a></li>
<li><a href="../250637/index.html">Details about the internal kitchen AngularJS</a></li>
<li><a href="../250641/index.html">Solution: Adobe AIR does not find a connected iOS device from under Windows 7</a></li>
<li><a href="../250643/index.html">Without cuts. The second month of cashback service Kubyshka in Russia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>