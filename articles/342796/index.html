<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Machine learning do-it-yourself (part 2). Service for the classification of calls to those. support</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In October, the Okdesk cloud service team took part in the Penza hackathon, in the framework of which we developed a "boxed" Telegram bot for Okdesk. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Machine learning do-it-yourself (part 2). Service for the classification of calls to those. support</h1><div class="post__text post__text-html js-mediator-article"><p>  In October, the <a href="https://www.okdesk.ru/">Okdesk</a> cloud service <a href="https://www.okdesk.ru/">team</a> took part in the Penza hackathon, in the framework of which we developed a "boxed" Telegram bot for Okdesk.  The bot will allow the clients of the service companies to send requests for the service, to correspond with the requests and to give marks to the fulfillment of the requests from the favorite messenger. </p><br><p><img src="https://habrastorage.org/webt/gp/yi/8p/gpyi8pcmwxux2hbvowxj7en57xg.png" alt="image"></p><br><p>  We planned to write about this article on Habra, but stopped on time.  Truly, who is interested in reading today that the next Telegram-bot was developed at the next hackathon?  Therefore, we wrote a continuation of the <a href="https://habrahabr.ru/company/okdesk/blog/337278/">article</a> on machine learning for the classification of applications in those.  support  In this article, we talk about how, after learning the algorithm, to make a working service, at the input of which the text of the client application is transmitted, and at the output - the category to which the application belongs. </p><a name="habracut"></a><br><h2 id="kratkoe-soderzhanie-predyduschey-chasti">  Summary of the previous part </h2><br><p>  We strongly recommend that you read the <a href="https://habrahabr.ru/company/okdesk/blog/337278/">first part</a> before reading this text (or at least add the first part of the article to the bookmarks).  The following is a brief summary. </p><br><p>  So, service companies provide services to their customers.  Clients send requests to customer support: for example, "the Internet does not work" or "does not pass the wiring in 1C."  In a service company, different people deal with different directions: problems with the Internet are the responsibility of the group of system administrators, and problems with 1C "fall" on the 1C support group.  Distribution of requests by groups can be assigned to the dispatcher, but these are additional expenses (salary) and loss of decision time (by the time the requests are resolved, the dispatcher‚Äôs response to the distribution of requests is added).  It is logical to shift the task of distributing applications to the "smart algorithm", which can determine by the application text which direction it belongs to. </p><br><p>  To solve this problem, a training sample was taken from 1200 application texts with stamped categories (14 categories).  A dictionary was compiled from the training sample (a set of words relevant to the classification), all applications were "projected" onto the dictionary (ie, each application text was assigned a vector in the dictionary space), after which the best projection was found on the vectors this training sample classification algorithm.  To classify applications by the algorithm, a vector in the space of the dictionary was input, and the output predicted the category of the application. </p><br><p>  The best algorithm showed on the training sample 74.5% classification accuracy (which is quite good for 14 categories), but grateful readers wrote to the PM that the applied algorithm showed 92% accuracy on their data (which is already a completely ‚Äúproduction‚Äù option). </p><br><p>  All this work was carried out on a laptop, for practical use it is necessary to somehow turn the result obtained on the laptop into a web service. </p><br><h2 id="vygruzka-slovarya-i-obuchennogo-algoritma">  Unloading a dictionary and a trained algorithm </h2><br><p>  Recall that the classification of new applications is carried out in 2 stages: </p><br><ol><li>  For the new application, the coordinates of the application are determined in the dictionary space; </li><li>  The resulting vector is passed to the trained algorithm, which returns the category of the application. </li></ol><br><p>  Thus, to transfer the classification mechanism from a laptop to a web service, we need to ‚Äúunload‚Äù the resulting dictionary and the trained algorithm. </p><br><p>  Further in the text we will use variables from the first part of the article. </p><br><h3 id="vygruzka-slovarya">  Unloading dictionary </h3><br><p>  Unloading a dictionary is simple.  In the first part, we wrote down all the vocabulary words (order is important!) In the list variable <strong><em>words</em></strong> .  Now you need to write the words from the words variable to a text file.  Each word will be written with a new line. </p><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   codecs,       utf8 import codecs #       words.txt,      with codecs.open('words.txt', 'w', encoding = 'utf8') as wordfile: wordfile.writelines(i + '\n' for i in words)</span></span></code> </pre> <br><h3 id="vygruzka-dampa-obuchennogo-algoritma">  Unloading a Dump Trained Algorithm </h3><br><p>  Algorithm training is an operation that requires a lot of machine time.  It is not advisable to carry it out every time the algorithm is started.  Therefore, if there is an opportunity to save an algorithm that is somehow trained to run on other machines, this opportunity should be used. </p><br><p>  Python offers 2 options for saving the algorithm. </p><br><p>  <strong>Built-in pickle module:</strong> </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pickle saved = pickle.dumps(classifier) classifier2 = pickle.loads(saved)</code> </pre> <br><p>  It allows you to save the dump to a variable, and the variable can be saved to a file. </p><br><p>  <strong>Joblib library:</strong> </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sklearn.externals <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> joblib joblib.dump(classifier, <span class="hljs-string"><span class="hljs-string">'filename.pkl'</span></span>) classifier2 = joblib.load(<span class="hljs-string"><span class="hljs-string">'classifier.pkl'</span></span>)</code> </pre> <br><p>  It does not allow to write a dump of a model into a variable, but immediately writes a dump into a .pkl file. </p><br><p>  For our task, it is necessary to save the dump of the algorithm to a file: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sklearn.externals <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> joblib joblib.dump(optimazer_tree.best_estimator_, <span class="hljs-string"><span class="hljs-string">'model_tree.pkl'</span></span>)</code> </pre> <br><p>  Now we have the second file: a dump of the trained algorithm in the model_tree.pkl file </p><br><h2 id="skript-klassifikacii-novyh-zayavok">  The classification script of new applications </h2><br><p>  The script that will classify new applications should be able to do the following: </p><br><ol><li>  Download a dictionary from the words.txt file; </li><li>  Download a trained algorithm from the classifier.pkl file; </li><li>  Project the text transmitted for classification into the dictionary space; </li><li>  Return the prediction of the category passed to classify the text. </li></ol><br><p>  Let's get started  To get started, import the necessary libraries.  We got acquainted with most of the libraries required for the script work either in the first part of the article, or (with <strong><em>codecs</em></strong> ) in this article just above.  Additionally, the <strong><em>sys</em></strong> library appears - we need it to work with the command line parameters (from which we will transfer text to the script) </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sklearn <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> codecs Import sys</code> </pre> <br><p>  Now we will load the dictionary and the trained algorithm: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#    words.txt with codecs.open('words.txt','r', encoding = 'utf8') as wordsfile: wds = wordsfile.readlines() #        words = [] for i in wds: words.append(i[:-1]) #     model_tree.pkl estimator = sklearn.externals.joblib.load('model_kNN.pkl')</span></span></code> </pre> <br><p>  Before you project a new text onto the space of a dictionary, it is necessary to split the text into words (first reducing the text to lower case).  We declare the corresponding functions: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#       def lower(str): return str.lower() # ,           def splitstring(str): words = [] #     [],        for i in re.split('[;,.,\n,\s,:,-,+,-,(,),=,-,/,¬´,¬ª,-,@,-,-,\d,!,?,"]',str): words.append(i) return words</span></span></code> </pre> <br><p>  And at the end we will declare a function that accepts a new text as input, and at the output it gives a prediction of its category: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># ,     ,      def class_func(new_issue): #   ,       new_issue_words = splitstring(lower(new_issue)) #    len(words) new_issue_vec = np.zeros((1,len(words))) # [j]-   ,    j-      new_issue for j in new_issue_words: if j in words: new_issue_vec[0][words.index(j)]+=1 #  return estimator.predict(new_issue_vec)</span></span></code> </pre> <br><p>  Recall that we plan to transmit the text of the new application from the command line.  In order to get the command line arguments in the script, we will use the <strong><em>sys</em></strong> library.  <strong><em>Sys.argv</em></strong> returns a list of command line arguments, while the zero element is the name of the script (but this is not important for us, since the name of the script is not in the dictionary; it will disappear when projected).  Thus, to transfer the text of the new application to the script, we need to "paste" the transferred command line parameters in the script (since each word from the text of the new application will be passed as one argument): </p><br><pre> <code class="python hljs">new_issue = <span class="hljs-string"><span class="hljs-string">u''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sys.argv: <span class="hljs-comment"><span class="hljs-comment">#    new_issue += ' ' + i.decode('cp1251') class_func(new_issue)</span></span></code> </pre> <br><p>  <strong>Important!</strong>  Depending on the encoding used in the console, the <em>new_issue + = '' + i.decode ('cp1251')</em> parameter in the <em>decode</em> may be different. </p><br><p>  So, to the file with the dictionary and the file with the dump of the trained algorithm, we added the third file: a script that does all the work of predicting the category of the new application. </p><br><p>  Next, all three files must be folded on the server into one folder and set up the necessary environment (python with libraries).  The script can be run from the command line in any way you like (for example, write a simple service in your favorite language that will receive the text of the new application on the network, send it to the script, receive an answer and send it back). </p><br><p>  The end!  Good luck in solving your ML-problems.  Well, we will continue to develop <a href="https://www.okdesk.ru/">Okdesk</a> - the most convenient (according to our company :)) helpdesk system for servicing clients in service companies, while at the same time exploring the possibilities of using ‚Äúsmart algorithms‚Äù for solving problems related to servicing. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/342796/">https://habr.com/ru/post/342796/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342786/index.html">Hedgehogs on wheels: how do we maintain the quality of communication in Moscow</a></li>
<li><a href="../342788/index.html">6 lines of deep learning</a></li>
<li><a href="../342790/index.html">Spring WebSocket. How it works?</a></li>
<li><a href="../342792/index.html">United company Yandex.Taxi and Uber plans to hold an IPO in 2019</a></li>
<li><a href="../342794/index.html">Example of implementation of a general performance indicator of MS SQL Server</a></li>
<li><a href="../342798/index.html">JBreak 2018 Java Conference Announcement: Connecting the Dots</a></li>
<li><a href="../342800/index.html">YouTrack 2017.4 Release: Time Evaluation Report, Markdown Support, and more</a></li>
<li><a href="../342802/index.html">How to cook blockchain</a></li>
<li><a href="../342804/index.html">Postgres Pro Quiz Task at Highload ++ 2017</a></li>
<li><a href="../342806/index.html">JARVIS for (not) iron man: how Perf will become an assistant for each Delivery manager</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>