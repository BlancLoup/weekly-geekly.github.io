<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Snapshots for virtual machines in the cloud</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Summary : A post talks about snapshots in the cloud, how to use them, and how they are organized. 

 One of the most notable new features in the cloud...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Snapshots for virtual machines in the cloud</h1><div class="post__text post__text-html js-mediator-article">  <u>Summary</u> : A post talks about snapshots in the cloud, how to use them, and how they are organized. <br><br>  One of the most notable new features in the cloud that appeared this year is snapshots.  Everything that we do is divided into three categories - what is useful to us (billing, service utilities, etc.), what is useful to customers, but not visually noticeable (for example, storage systems, changing versions of the hypervisor, previously launched servers), and that is useful to clients and visually noticeable - and here snapshots just from this third category). <br><br>  I want to warn you that the article will be very complicated.  I will first talk about simple things - how to work with it and what is the use of it, and then I will tell you how it works inside.  And if, I hope, we did it with convenience and clarity at the ‚Äúuser‚Äù level, then with a description of the device ... So say, take heart or skip it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  How to use snapshots? </h1>  The most common use of snapshots is to create backup copies in case of an error in setting up the machine.  I want to warn you right away that this is important: snapshots are stored in the same place as the disks.  This means that if a meteorite hits us or another natural disaster of federal significance arrives, then snapshots will be lost simultaneously with the disks, that is, for full backup copies, you should use another storage location geographically away from us.  We absolutely do not plan to lose customer drives or allow natural disasters to the server, but I still have to warn. <br><img src="https://habrastorage.org/getpro/habr/post_images/ca6/e96/aef/ca6e96aefd2c068d91a227bfe8e91a9b.png" alt="Creating a snapshot in the selectle cloud" align="right"><br>  Snapshot can be performed at any time, on or off the machine.  At the moment of performing snapshots, the disk activity of the machine is slightly suspended (we are talking about something about a second), after which it continues ‚Äúas if nothing had happened‚Äù. <a name="habracut"></a>  There are two methods to make snapshot: in the properties of the disk on the page with virtual machines (there is also a button to ‚Äúroll back to the previous snapshot‚Äù) and in the list of snapshots on the page with disks.  There is also a list of all snapshots disk.  Note that for a virtual machine, we usually do not give the opportunity to create snapshots during installation.  Especially <s>sneaky</s> attentive customers may find that the ‚Äúcreate snapshot‚Äù button on the drives page is still active (and working).  There will be nothing interesting (except for a semi-established Linux) in such a snapshot, but we decided not to take away from people the opportunity <s>to shoot themselves up</s> to do what they want with their machines. <br><br>  So, the created snapshot contains a copy of the disk at the time of creation.  In size, it is often much smaller than a disk.  If someone is interested in how the size of the snapshot is calculated - see the second part.  Snapshots form a chain (if snapshots are made in a row) or a tree (how it turns out - see the section on rolling back snapshots).  If you remove snapshot, then it begins to "dissolve" - ‚Äã‚Äãto unite with its neighbors (with the total amount of snapshots reduced).  The process is quite fast (a few minutes - and there is no snapshot). <br><br>  I personally consider the most ‚Äútasty‚Äù snapshot function to be the ability to connect snapshot as a disk.  It is connected in read only mode (read only), and allows you to look at the "previous" state of the disk.  No one bothers to make 10 snapshots of a disk and connect all 10 to the same machine - in this case the disks will be the chronology of the ‚Äúmain‚Äù disk. <br><br>  Moreover, snapshot can be connected to any number of machines at the same time.  (I immediately answer the question whether it is possible to boot from snapshot - formally, yes, in fact, the file system is very nervous about read only on root - we are working on this issue). <br><br>  The second most important function is the <b>rollback to the snapshot</b> , that is, the recovery of the disk state.  In this case, the changes are lost, so it is better to make a new one before rolling back to the old snapshot.  In this case, the disk can be ‚Äúswitched‚Äù between snapshots (roll back / forth).  There are some minor inconveniences to the rollback snapshot process ‚Äî disk operations become unavailable and machine consumption is incorrectly displayed in the past.  The total consumption of the account is calculated correctly, but since a new VBD (block device) is formed, the data for the VM is displayed for the new VBD.  (We know about this not very obvious feature of our billing and plan to change it to a more convenient one in the foreseeable time). <br><br>  For ease of use in the last few days before the announcement, we added a ‚Äúfinal touch‚Äù - if the disk rolls back from snapshot, then the reverted_at field appears (that is, ‚Äúrestored from snapshot‚Äù).  Trifle, but useful.  This field will pursue the disk until its death (and after, hehe, we don‚Äôt delete data about the objects). <br><br>  An important point: every time a snapshot is taken or rolled back, there is a ‚ÄúCOW‚Äù syndrome (copy-on-write) - the first record will be slower than the subsequent ones.  So on very busy servers with a large number of entries to create snapshots should be treated carefully. <br><br>  If you make a few snapshots of a disk, then roll back the disk to the snapshot in the ‚Äúmiddle‚Äù, then make a few snapshots, then roll it back to another snapshot, then roll it back again, then the <em>snapshots tree</em> will be formed.  We store relationships in our database - which snapshot it is.  Unfortunately, visualization is still in work (programmers strongly protest, having received the task ‚Äúto draw a tree on JS‚Äù, ‚Äã‚Äãand let them be ashamed when reading this post). <br><br>  Limits  Unfortunately, all this luxury is not limitless.  Our limitations: the length of the snapshot chain is no more than 20 disks, the maximum number of snapshots in a tree (taking into account branching) is no more than 60 pcs.  According to our estimates, this is more than enough for normal operation. <br><br>  On the ‚Äúdisks‚Äù page, each disk has a ‚Äúsnapshots‚Äù tab, where a list of all disk snapshots is given.  Snapshots can be called and give them a multi-line description (but all lazy, yes, I also love it when these fields are filled, but it's usually very lazy to fill them in).  In any case, snapshot can be uniquely identified by an absolutely useless number ( <em>English</em> universally useless ID, uuid) and (partially) by date of creation. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c83/d48/2fc/c83d482fc2fb8ab957490eed16413be2.png"><br><br>  A little bit about the "total" field.  Due to some features of the system, information about snapshots is unevenly updated - the list of snapshots is updated immediately after creating snapshots, but the ‚Äútotal‚Äù field may be late for some time - up to two minutes.  Unlike other resources, which we compute in real time, disks and snapshots are counted at (approximately) two-minute intervals.  The ‚Äútotal‚Äù field is calculated at the moment of calculating the consumption volume, so the ‚Äútotal‚Äù immediately after creating the snapshot will be incorrect (but will definitely return to the next write-off tick). <br><br><h1>  How does it work? </h1><br>  (please remove minors and people with increased susceptibility from the screens, now there will be hardcore). <br><br>  Our snapshots (as well as disks) are based on the VHD format, which was invented by microsoft, made public, and used by citrix.  It supports very effective snapshots (they are much more effective than LVM snapshots, which increase the number of entries in proportion to the number of snapshots).  When a snapshot chain is built up, there is implicitly implied a ‚Äúzero‚Äù snapshot, relative to which the changes of all the others are fixed (without this ‚Äúzero‚Äù snapshot, it becomes not clear what kind of ‚Äúchanges‚Äù are stored in the first snapshot).  Zero snapshot, of course, is not paid (because physically disk space does not take). <br><br>  When writing to the ‚Äúleaky‚Äù block, this block is copied from the ‚Äúold‚Äù snapshot to the current disk (the part that was recorded is replaced, the rest is taken in the previous copy).  After recording in the current disc it becomes one less hole and reading of this place in the future comes from the ‚Äúcurrent‚Äù disc.  Disk operations for disks with snapshots cost the same as conventional disk operations (personally, I'm not sure how much snapshots operations are harder for our storage systems, so we decided not to touch this area). <br><br>  What happens when creating snapshots?  (Technical part). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dc4/9c5/7e1/dc49c57e18e146da9ea92d495fd88682.png" alt="snapshot structure in the selectle cloud"><br><br>  The current disk is declared the so-called 'base copy', that is, read only a copy of the state of the machine.  Since the disk could have predecessors in the snapshot chain, base copy refers to other base copy (note, base copy always refers only to base copy).  In addition, another ‚Äúsnapshot‚Äù is done - it is a read / write copy of the current state (that is, the differences between snapshot and base copy).  In general, snapshots can be written, but we prohibit this, since in this case thin provisioning will turn out, and we cannot allow it for reasons of guaranteed reserved space (see section below).  But even the "unwritten" snapshot contains 8MB of meta-data.  Thus, each snapshot consists of two halves: metadata (8Mb) and the contents of base copy.  The disk refers to one type of links to the base copy of the previous snapshot, and the second type of links to the snapshot.  When a disk rollback occurs, the snapshot is cloned (not copied - hence the nuances with COW), referring to the same base copy that the snapshot that was cloned referred to. <br><br>  If someone makes a snapshot two or three times in a row (without changing the data), you will get one base copy and three snapshots with meta-data. <br><br>  When the snapshot is removed (from the middle), the following happens: the snapshot itself (metadata) is deleted immediately, but the base copy begins to disband - the data is transferred either to the ‚Äúprevious‚Äù state, or to the ‚Äúfuture‚Äù, or is discarded altogether (if there is an alternative both in the past and in the future).  This process is the "melting" of snapshots, which does not occur instantaneously.  It must be said that the data is not actually copied, but merely ‚Äúremarked‚Äù within LVM (LE is transferred between different LVs) or deleted (if there is another version of the block in the previous copy). <br><br><h2>  A bit about thin provision </h2><br>  One of the questions we are asked for on the storage system is related to thin provision.  What is thin provision?  This is when a certain amount of space is declared to the consumer, and the actual space occupied is smaller - and increases as the actual recording goes.  This fits perfectly on our model with snapshots, COW from the ‚Äúempty space‚Äù, and XCP implements excellent.  In fact, thin provision is an ‚Äúentry to snapshot‚Äù, that is, an entry to ‚Äúempty space‚Äù, which from this begins to take place in reality. <br><br>  However, thin provisioning is dangerous.  The reverse side of thin provision is overselling (aka oversubscription).  Roughly speaking, we have 100TB of space.  We allowed to create 200 disks of 1 TB on such storage.  The actual size of the disks at the beginning is 30-50 gigabytes, so there is plenty of free space.  But, suddenly, customers start writing to discs.  Disks are already allocated to them.  It takes a little time, and ... yes, the average disk fill creeps up to 500GB.  And then ... Then someone wants to write down another gigabyte, but gets an error.  Because the place is over. <br><br>  We have no control over the customers' disks, and if we have provided them with the resources, these resources are theirs, and it‚Äôs not our business to say ‚Äúnow it is possible, but now not.‚Äù  If there can be a compromise with respect to other resources (3% of the processor was not given to someone, someone migrated to another host to ensure a performance margin), then there is just a slight ‚Äúshort delivery‚Äù that is not noticeable, then with respect to disk space this will not work .  They did not allow at least one sector to be written down ‚Äî an error was fixed throughout the block device. <br><br>  So due to common sense, we decided not to do so. <br><br>  Due to the fact that snapshots are made in R / O, and after creation they only decrease, we can refuse to create a new snapshot (anything can happen - the place may suddenly end), but we definitely will not refuse the work of already created disks and snapshots. </div><p>Source: <a href="https://habr.com/ru/post/138347/">https://habr.com/ru/post/138347/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../138341/index.html">SEO for mobile applications (App Store and Android Market)</a></li>
<li><a href="../138342/index.html">Russia in your pocket: mobile navigation from Rambler-Kart</a></li>
<li><a href="../138343/index.html">Intangible incentives for IT professionals</a></li>
<li><a href="../138344/index.html">How to distinguish HTML from HTML5</a></li>
<li><a href="../138346/index.html">OS X Mountain Lion is available for developers.</a></li>
<li><a href="../138348/index.html">Video review of Android applications and games - kedDroid</a></li>
<li><a href="../138350/index.html">Unit testing from beginner to beginner</a></li>
<li><a href="../138353/index.html">Knowledge Management Survey Results</a></li>
<li><a href="../138354/index.html">About Code Formatting and User Scripts in Xcode 4</a></li>
<li><a href="../138357/index.html">Incorrect use of the Bridge / Bridge design pattern</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>