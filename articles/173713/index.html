<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Balancing incoming connections on iptables</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suppose you have a service that accepts incoming connections and the problem of load balancing and / or fault tolerance arises. 

 In general, the sch...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Balancing incoming connections on iptables</h1><div class="post__text post__text-html js-mediator-article"> Suppose you have a service that accepts incoming connections and the problem of load balancing and / or fault tolerance arises. <br><br>  In general, the scheme looks like this: <br> <code> ----&gt;  ---&gt;  () <br></code> <br><br>  There are a lot of ready balancers for specific needs.  For example, nginx is an excellent balancer for web applications, <a href="http://haproxy.1wt.eu/">haproxy</a> for tcp connections. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><ul><li>  You are not looking for easy ways. </li><li>  You are bored and want something new </li><li>  Only iptables, only hardcore </li></ul><br>  In fact, it all depends on the specific situation, so let me just write a recipe and along the way you decide for yourself where it might be useful. <br><br><h4>  Recipe </h4><br>  For balancing we will use the statistic, condition and labeling modules. <br>  Not all of these modules are by default.  In older versions of linux, look for nth instead of statistic, and you may have to condition the hands from <a href="http://xtables-addons.sourceforge.net/">the project site</a> <br><br>  Now suppose your service is an smtp server. <br>  External ip-address let it be 10.0.0.1 <br>  Internal ip-addresses of services will be 192.168.0.1 and 192.168.0.2 <br><br>  Create the following rule set in the mangle table. <br><br><blockquote>  * mangle <br>  : MAILMARK - [0: 0] <br><br>  -A MAILMARK -j CONNMARK --restore-mark <br>  -A MAILMARK -m mark --mark 0x0 -m statistic --mode nth --every 2 -m condition!  --condition mail1up -j MARK --set-mark 1 <br>  -A MAILMARK -m mark --mark 0x0 -m condition!  --condition mail2up -j MARK --set-mark 2 <br>  -A MAILMARK -m mark --mark 0x0 -m condition!  --condition mail1up -j MARK --set-mark 1 <br>  -A MAILMARK -j CONNMARK --save-mark <br><br>  -A PREROUTING -d 10.0.0.1 -p tcp --dport 25 -j MAILMARK <br><br>  COMMIT <br></blockquote><br><br>  and in the nat table, the following: <br><blockquote>  -A PREROUTING -d 10.0.0.1 -p tcp --dport 25 -i bond0.204 -m mark --mark 1 -j DNAT --to-destination 192.168.0.1 <br>  -A PREROUTING -d 10.0.0.1 -p tcp --dport 25 -i bond0.204 -m mark --mark 2 -j DNAT --to-destination 192.168.0.2 <br></blockquote><br><br>  That's all, now it remains to explain how it all works. <br><br>  First, any incoming packet to the external address 10.0.0.1 for port 25 goes through the mangle table and the labeling rule <br><blockquote>  -A PREROUTING -d 10.0.0.1 -p tcp --dport 25 -j MAILMARK </blockquote><br><br>  For marking, a separate MAILMARK chain has been created, which works as follows. <br>  If the connection has already been marked, then mark the package with the same value as the connection. <br><blockquote>  -A MAILMARK -j CONNMARK --restore-mark </blockquote><br>  Thus, the packets of one connection will later be transferred to one backend of the service. <br>  If the package is not marked, then mark it with the following rule. <br><blockquote>  -A MAILMARK -m mark --mark 0x0 -m statistic --mode nth --every 2 -m condition!  --condition mail1up -j MARK --set-mark 1 </blockquote><br><blockquote>  -m mark --mark 0x0 </blockquote>  the condition that the packet is not yet marked <br><blockquote>  -m statistic --mode nth --every 2 </blockquote>  We mark every second package.  Those.  we balance the load very simply 50/50, but this is not the only possibility (see random and statistic) <br><blockquote>  -m condition!  --condition mail1up </blockquote>  condition that the backend is live <br><blockquote>  -j MARK - set-mark 1 </blockquote>  label the package with a value of 1 <br><br>  If the package remains unmarked, then label it with a 2 label, provided that the backend is live <br><blockquote>  -A MAILMARK -m mark --mark 0x0 -m condition!  --condition mail2up -j MARK --set-mark 2 </blockquote><br>  If the packet is still not marked, then the second backend is apparently dead, and the first label was not set, since  either we are unlucky with the 50/50, or the first backend also died.  In case the first backend is still alive, we mark the package with a label 1 <br><blockquote>  -A MAILMARK -m mark --mark 0x0 -m condition!  --condition mail1up -j MARK --set-mark 1 </blockquote><br>  The last rule to remember for the current connection is a tag. <br><blockquote>  -A MAILMARK -j CONNMARK --save-mark </blockquote><br><br>  After the packet is marked, it will be translated to the selected backend by the rules that were added to the nat table. <br><br>  It remains to illuminate another point related to how iptables will understand that the backend is live. <br>  No way, you should do this yourself and put 0/1 in the / proc / net / nf_condition / mail1up and / proc / net / nf_condition / mail2up files, depending on whether the backend is alive or dead. <br>  By default, when starting iptables, these files will be 0. <br>  The rules that are given are calculated on the fact that 0 means that the backend is live. <br>  For example, to check the smtp server I use the following bash script <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash get () { response=$(echo "QUIT" | nc -w 5 $1 25 | head -1 | awk '{print $1}') if [ "$response" == "220" ] then echo "0" else echo "1" fi } echo $(get 192.168.0.1) &gt; /proc/net/nf_condition/mail1up echo $(get 192.168.0.2) &gt; /proc/net/nf_condition/mail2up</span></span></code> </pre> <br><br><h4>  Conclusion </h4><br>  On the one hand, there are probably no compelling reasons to do this, but on the other hand, you can think of them. <br><ol><li>  iptables runs at the kernel level and is likely to be faster than any other balancer </li><li>  iptables is more secure.  For example, it‚Äôs not a fact that when a failover happens between the balancers, the same haproxy will start successfully, since  for start he needs much more conditions.  For example, the IP address 10.0.0.1 should be intercepted and only after that it will be possible to run haproxy on port 25.  For example, someone during this time corrupted his configuration file and it will not start at all. </li></ol></div><p>Source: <a href="https://habr.com/ru/post/173713/">https://habr.com/ru/post/173713/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../173703/index.html">Ultra-hard sapphire glass for smartphones</a></li>
<li><a href="../173705/index.html">Writing your bootloader</a></li>
<li><a href="../173707/index.html">Internet project managers</a></li>
<li><a href="../173709/index.html">Working with the LCD indicator on the debug board STM32L-Discovery</a></li>
<li><a href="../173711/index.html">6 practical tips for beginners in building a simple BI solution</a></li>
<li><a href="../173715/index.html">Unity Technologies is now on Habr√©. Post about the present and the future</a></li>
<li><a href="../173717/index.html">Launched the first two domains of the dot.UkR level</a></li>
<li><a href="../173719/index.html">Announcement of the second wave of speakers and 25 reports of the DevCon 2013 conference</a></li>
<li><a href="../173721/index.html">Register of stationary objects of observation (complexes of WFM)</a></li>
<li><a href="../173723/index.html">Search for public transport is now in all versions of 2GIS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>