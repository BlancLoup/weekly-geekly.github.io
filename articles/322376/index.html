<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Elixir and Angular 2 without Hello, world !, or Implementing work with the tree directory, part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The functional programming language Elixir is gaining popularity, and one of the latest frameworks for creating single-page applications - Angular 2 -...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Elixir and Angular 2 without Hello, world !, or Implementing work with the tree directory, part 1</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/782/653/d3f/782653d3f1564597a132f7c0284f6b68.png" alt="CPDV"></p><br><p>  The functional programming language <a href="http://elixir-lang.org/">Elixir</a> is gaining popularity, and one of the latest frameworks for creating single-page applications - <a href="https://angular.io/">Angular 2</a> - has recently been released.  Let's take a look at them in a couple of articles by creating a full-fledged back-end on Elixir and <a href="http://www.phoenixframework.org/">Phoenix Framework</a> from scratch, supplying data to the frontend client application based on Angular 2. </p><br><p> <code>Hello, world</code> is not our option, so what was done if necessary can be applied in real projects: all the presented code is laid out under the <a href="https://ru.wikipedia.org/wiki/%25D0%259B%25D0%25B8%25D1%2586%25D0%25B5%25D0%25BD%25D0%25B7%25D0%25B8%25D1%258F_MIT">MIT license</a> . </p><br><p>  The volume of the article <del>  big </del>  huge!  I hope for an equally huge amount of comments - any.  Not once noticed that you get from the comments no less than from the main article, and sometimes more. </p><br><p>  The first article will contain several introductory words and work on the back-end.  Go! </p><a name="habracut"></a><br><h2 id="vvedenie">  Introduction </h2><br><p>  A few months ago, I was offered as a subcontractor to implement in a very short time a prototype of a web application;  of the requirements were present only the functional, the extreme end date and the need to use only open source tools.  ‚ÄúExcellent,‚Äù I thought, ‚Äúthis is a great reason to put into practice the Elixir / Phoenix Framework and Angular 2 bundle,‚Äù since the latter was released shortly before.  The project as a result was implemented on time, the customer was satisfied, the experience was replenished with the implementation of new tasks. </p><br><p>  One of these tasks was the need to display reference books of the <a href="https://ru.wikipedia.org/wiki/%25D0%2593%25D0%25BE%25D1%2581%25D1%2583%25D0%25B4%25D0%25B0%25D1%2580%25D1%2581%25D1%2582%25D0%25B2%25D0%25B5%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D1%2580%25D1%2583%25D0%25B1%25D1%2580%25D0%25B8%25D0%25BA%25D0%25B0%25D1%2582%25D0%25BE%25D1%2580_%25D0%25BD%25D0%25B0%25D1%2583%25D1%2587%25D0%25BD%25D0%25BE-%25D1%2582%25D0%25B5%25D1%2585%25D0%25BD%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25B9_%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2586%25D0%25B8%25D0%25B8">GRNTI</a> and <a href="https://en.wikipedia.org/wiki/Fields_of_Science_and_Technology">OECD FOS</a> with the possibility of choosing several values.  Since there were no ready-made solutions for outputting a tree directory of normal readiness, I had to reinvent my own bicycle.  In addition, it provided a topic for this series of ‚Äútutorial‚Äù articles for acquaintance with both the <a href="https://ru.wikipedia.org/wiki/Elixir_(%25D1%258F%25D0%25B7%25D1%258B%25D0%25BA_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)">Elixir</a> / <a href="http://www.phoenixframework.org/">Phoenix Framework</a> and <a href="https://angular.io/">Angular 2</a> simultaneously. </p><br><p>  So, at the end of this cycle, we will have a working back-end on Elixir and Phoenix Framework, using the API to provide the contents of the GRNTI and OECD FOS directories to an independent front-end on Angular 2, where you can call the output form of the multiple-choice data sections \ subsections, save (get outside of the selection window) and restore selected when opened.  Appearance will provide us with Twitter Bootstrap.  We shall design the reference book on the front-end as a separate module that can be used in the future with any projects. </p><br><h3 id="nekotorye-poyasneniya-po-realizacii">  Some explanations on the implementation </h3><br><p>  The GRNTI Reference Book is a three-level (maximum) structure, each entry of which has a code in the <a href="https://ru.wikipedia.org/wiki/%25D0%25A3%25D0%25BD%25D0%25B8%25D0%25B2%25D0%25B5%25D1%2580%25D1%2581%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25B4%25D0%25B5%25D1%2581%25D1%258F%25D1%2582%25D0%25B8%25D1%2587%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BA%25D0%25BB%25D0%25B0%25D1%2581%25D1%2581%25D0%25B8%25D1%2584%25D0%25B8%25D0%25BA%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F">decimal classification</a> , consisting of three groups of numbers from 00 to 99, separated by a period, as well as a name.  The reference book currently includes about 8,000 records of sections and subsections, the volume in a flat text form - more than 400 kb.  The contents of the directory can be found on <a href="http://grnti.ru/">grnti.ru</a> (I have no relation to this resource). </p><br><p>  OECD FOS also has a three-level structure with a hierarchical code separated by a dot, however, unlike the previous version, in this case the last group of code is a combination of two Latin letters.  There are significantly fewer entries in the directory - just under 300, and the total is about 8kb.  Unfortunately, online I could not find at least some of the current versions of this reference book, so we will use the fact that it was found through other channels. </p><br><p>  Due to the volume of the GRNTI reference book, when working with it, we will request with the back-end only those sections that we need at the moment, but the OECD FOS can be rendered as a whole and process the structure already on the client. </p><br><p>  I want to clarify right away: the problem is somewhat degenerate, it was only part of a wider functional.  Naturally, if the task is <em>only</em> to display reference books (for example, for informational purposes), then neither the back-end nor the <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D0%25B4%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%2580%25D0%25B0%25D0%25BD%25D0%25B8%25D1%2587%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BF%25D1%2580%25D0%25B8%25D0%25BB%25D0%25BE%25D0%25B6%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5">SPA</a> are needed. </p><br><p>  Also, I do not pretend to be a guru at all, and if you offer a more effective implementation of any part, I will be grateful for the science: I love to study. </p><br><p>  Please note: the code, the output of utilities and some advanced explanations are hidden under the spoiler in order to somehow improve the readability and use. </p><br><h2 id="vybor-steka-tehnologiy">  Choice of technology stack </h2><br><p>  Nowadays, vertical power expansion costs more and more, and performance is achieved not by increasing the frequency, but horizontally, by adding new cores.  Because of this, languages ‚Äã‚Äãspecializing in competitive computing (parallel execution) are of increasing interest.  At the same time, sharing of common data becomes a serious headache, which can be significantly reduced by <a href="https://ru.wikipedia.org/wiki/%25D0%25A4%25D1%2583%25D0%25BD%25D0%25BA%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">functional</a> programming languages. </p><br><p>  <strong>Elixir</strong> is a fairly young, byte-codeable functional language written in Erlang and executed in its <strong>Beam</strong> virtual machine.  The language inherits all the advantages of <strong>Erlang</strong> : </p><br><ul><li>  functionality, </li><li>  Immunity, </li><li>  "everything is a process", </li><li>  processes are isolated from each other </li><li>  very low cost of creating and destroying processes </li><li>  each process has a unique identifier (PID) and it can optionally be assigned a unique name, </li><li>  there is no resource sharing between processes </li><li>  You can send a message from any process to any process, if you know its name \ identifier, </li><li>  messaging is the only interprocess communication method </li><li>  pattern matching (pattern matching), </li><li>  the ideology of "do what is required, or just die," </li><li>  ease of creating distributed systems; </li></ul><br><p>  and at the same time it has a simpler syntax, somewhat similar to Ruby, polymorphism through the protocol mechanism, very rich <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B5%25D1%2582%25D0%25B0%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">meta-programming</a> capabilities, opportunities for easy creation of documentation with Markdown markup <em>and real examples testing (!!!)</em> directly in the code of modules .  It is important that all Erlang functions and libraries written for it can be called directly from Elixir code without any loss of performance. </p><br><p>  The language simply provokes the use of multiprocessing and messaging, the benefit of writing a full-fledged process module with messaging needs to be spent literally a couple of minutes (I hope we will return to this in future publications if the response to this cycle is positive). </p><br><p>  Much means the active participation of the author of the language - <em>Jos√© Valim</em> - in the life of the community.  He is happy to answer questions in detail and, if necessary, brings the missing functionality to the language / library (for example, in Ecto, which will be discussed further - there is a personal positive experience). </p><br><p>  <strong>The Phoenix Framework</strong> is the most popular web framework for Elixir, which implements <a href="https://ru.wikipedia.org/wiki/Model-View-Controller">the MVC pattern</a> and greatly simplifies the development of web applications.  In addition, Phoenix has Channels - the possibility of realtime communications with the application via websockets, and this is a real killer feature.  There is a JavaScript component for use with browsers, as well as implementations for some other languages, for example, for Java under Android. </p><br><p>  <strong>Angular 2</strong> is a framework for developing the client side of single page web applications, mainly supported by Google.  Version two has been completely rewritten based on the experience gained during the development and operation of AngularJS.  The release was released in September 2016. </p><br><h2 id="back-end-na-elixir-i-phoenix-framework">  Back-end on Elixir and Phoenix Framework </h2><br><div class="spoiler">  <b class="spoiler_title">A couple of words about Elixir</b> <div class="spoiler_text"><p>  If you have not encountered Elixir before, I highly recommend starting with learning a language.  I plan to give detailed explanations of the approaches and features used, but it is impossible to cover everything fully within a small series of articles (except for the fact that I myself constantly find something new).  There is a <a href="http://elixir-lang.org/getting-started/introduction.html">basic introduction</a> to the project site for studying, as well as many other resources on the Internet.  A very useful <a href="https://elixirforum.com/">forum</a> where the creator of the language responds with great pleasure.  By the way, an excellent example answer to the <a href="https://elixirforum.com/t/from-ruby-rails-phoenix-learn-elixir-first-or-dive-into-phoenix-tutorials/3528">question</a> "is it worth it to study Elixir first or immediately rush to the embrasure" can be seen in <a href="https://www.reddit.com/r/elixir/comments/5qsquu/performance_of_idiomatic_elixir_code/">this thread</a> on Reddit.  As a summary, I can say that the author of the topic was disappointed by the insignificant difference in the performance of the test case written in Ruby and "on Elixir" (as he believed).  The code on Ruby was executed in 4.221 seconds, on Elixir - 5.923 seconds.  After the code was rewritten using language features (and not just porting one-to-one with Ruby), he began working three (!!!) times faster. </p><br><p>  Having said the right things, I will say a seditious one: I rarely do this myself, and usually I rush into battle immediately. </p></div></div><br><h3 id="ustanovka-instrumentariya-i-nachalo-proekta">  Installing the toolkit and starting the project </h3><br><p>  To manage the versions of Erlang, Elixir and node (which will be needed later to work with the front-end), I use the <a href="https://github.com/asdf-vm/asdf">asdf</a> package manager.  There is a great <a href="https://gist.github.com/rubencaro/6a28138a40e629b06470">gist</a> in which the installation of dependencies for Fedora and Ubuntu, asdf, Erlang and Elixir is described in great detail, so I will not repeat.  He is in English, but there is enough copy-paste.  The latest versions at the time of this writing: Erlang - 19.2, Elixir - 1.4.1. </p><br><p>  You will also need PostgreSQL with one of the latest versions (I am using 9.6 at the moment), which you can install using the standard package managers of your distribution \ OS. </p><br><p>  After installing Erlang and Elixir, you need to <a href="http://www.phoenixframework.org/docs/installation">install the</a> Phoenix Framework. </p><br><p>  In Elixir for creating, compiling, testing projects, as well as managing their dependencies, there is a special automation utility - <strong><a href="https://hexdocs.pm/mix/Mix.html">Mix</a></strong> (you should also pay attention to <a href="http://elixir-lang.org/getting-started/mix-otp/introduction-to-mix.html">this</a> part of the documentation).  The <code>mix</code> utility is just like <code>make</code> , just more convenient. </p><br><p>  To begin with, we will install (regular) package manager with <a href="https://hex.pm/">Hex</a> command </p><br><pre> <code class="hljs pgsql">$ mix <span class="hljs-keyword"><span class="hljs-keyword">local</span></span>.hex</code> </pre> <br><p>  and then the Phoenix Framework archive: </p><br><pre> <code class="hljs ruby">$ mix archive.install <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/github.com/phoenixframework</span></span><span class="hljs-regexp"><span class="hljs-regexp">/archives/raw</span></span><span class="hljs-regexp"><span class="hljs-regexp">/master/phoenix</span></span>_new.ez</code> </pre> <br><p>  The documentation mentions the need for node.js, but since in this case Phoenix will only provide the API, we will need the node later when we move on to Angular 2. </p><br><p>  At the time of this writing, the Phoenix Framework version 1.2.1 was relevant. </p><br><p>  It should say a few words about <strong>Hex</strong> .  There is a single <a href="https://hex.pm/">https://hex.pm</a> repository in which libraries for Elixir / Erlang are published.  By default, all dependencies of projects on Elixir are searched there. </p><br><p>  Having installed the necessary software, go to the directory we need and create a new Phoenix project by running: </p><br><div class="spoiler">  <b class="spoiler_title">mix phoenix.new atv_api --no-brunch --no-html</b> <div class="spoiler_text"><pre> <code class="hljs vbscript">$ mix phoenix.<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> atv_api --no-brunch --no-html * creating atv_api/config/config.exs * creating atv_api/config/dev.exs * creating atv_api/config/prod.exs ... * creating atv_api/priv/static/images/phoenix.png * creating atv_api/priv/static/favicon.ico Fetch <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> install dependencies? [Yn] y * running mix deps.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> We are all <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>! Run your Phoenix application: $ cd atv_api $ mix phoenix.<span class="hljs-built_in"><span class="hljs-built_in">server</span></span> You can also run your app inside IEx (Interactive Elixir) as: $ iex -S mix phoenix.<span class="hljs-built_in"><span class="hljs-built_in">server</span></span> Before moving <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>, configure your database <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> config/dev.exs <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> run: $ mix ecto.create $</code> </pre> </div></div><br><p>  We are creating a new project without html templates and without the support of <a href="http://brunch.io/">brunch</a> , since the client part will be in a separate project. </p><br><p>  I advise you to immediately change the database connection settings in the config files <code>config/prod.exs</code> , <code>config/dev.exs</code> and <code>config/test.exs</code> for the production, development and testing modes, respectively. </p><br><p>  In addition, if you are using Elixir version 1.4 and above and the current version of Phoenix is ‚Äã‚Äãstill 1.2.1, I recommend changing the <code>mix.exs</code> file <code>mix.exs</code> .  Elixir 1.4 brought several <a href="http://elixir-lang.org/blog/2017/01/05/elixir-v1-4-0-released/">new features</a> , in particular, simplified the addition of dependencies that have their own process trees that require starting at the start of the project.  If earlier such dependencies (and most of them) were needed to be added both to the list of dependencies ( <code>deps</code> ) and to the list of applications for launching ( <code>applications</code> ), now now it is enough just the first one: <code>mix</code> will figure out whether the dependency is an application and launch it.  You must specify only applications that are not listed in dependencies.  Let's bring the method that returns the description of the application to the following form: </p><br><pre> <code class="hljs dos"> # mix.exs ... # Configuration <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the OTP application. # # <span class="hljs-built_in"><span class="hljs-built_in">Type</span></span> `mix <span class="hljs-built_in"><span class="hljs-built_in">help</span></span> compile.app` <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">more</span></span> information. def application <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> [mod: {AtvApi, []}, extra_applications: [:logger]] end ...</code> </pre> <br><p>  If you compare it with what it was before, you will see that the list that had the key <code>:applications</code> disappeared and a new - <code>:extra_applications</code> , in which only <code>:logger</code> remained, and everything that is listed in the dependencies is excluded. </p><br><p>  Having done this, start database creation using <code>mix ecto.create</code> .  The default environment is <code>dev</code> , respectively, a database will be created for this environment, the standard name for which will be <code>atv_api_dev</code> . </p><br><p>  At any time you can remove the database by running the <code>mix ecto.drop</code> task.  At the same time, <code>mix ecto.reset</code> will delete the database, create a new one, start the migrations and execute the contents of <code>seeds.exs</code> to fill the data for the first time (more on the latter later). </p><br><p>  By adding a variable initialized with the desired value ‚Äî <code>MIX_ENV=prod</code> , <code>MIX_ENV=dev</code> (by default) or <code>MIX_ENV=test</code> ‚Äî before <code>mix</code> , you can perform the required tasks in the appropriate environment. </p><br><h3 id="spravochnik-oecd-fos">  OECD FOS Handbook </h3><br><p>  Since the OECD FOS directory is simpler, let's start with it. </p><br><p>  To work with data in Phoenix, the <a href="https://github.com/elixir-ecto/ecto">Ecto</a> library is <a href="https://github.com/elixir-ecto/ecto">used</a> .  Ecto is a <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B5%25D0%25B4%25D0%25BC%25D0%25B5%25D1%2582%25D0%25BD%25D0%25BE-%25D0%25BE%25D1%2580%25D0%25B8%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D1%258F%25D0%25B7%25D1%258B%25D0%25BA">DSL</a> for working with database tables through views (models) and for writing database queries.  Ecto, unlike Rails ActiveRecords, is very simple (takes on a minimum), but at the same time a powerful tool. </p><br><h4 id="generatory-koda">  Code generators </h4><br><p>  In the Phoenix Framework, there are code generators of various types that can create a complete set of migration, model, controller that implements <a href="https://ru.wikipedia.org/wiki/CRUD">CRUD</a> , view modules (view), generating json, as well as basic tests.  In the case of both directories, we do not need a full-fledged CRUD, but for OECD FOS, you can start with the generated code and remove the excess. </p><br><p>  In the table of the OECD FOS directory, we will have two fields: <code>id</code> and <code>title</code> , both with type <code>text</code> .  (Why <code>text</code> ? Because if <a href="http://stackoverflow.com/questions/4848964/postgresql-difference-between-text-and-varchar-character-varying">there is no difference</a> , then why be sprayed?) </p><br><p>  Let's use the generator and conduct: </p><br><div class="spoiler">  <b class="spoiler_title">mix phoenix.gen.json fos fos title: text</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">$ mix phoenix.gen.json Fos fos title:<span class="hljs-type"><span class="hljs-type">text</span></span> * creating web/controllers/fos_controller.ex * creating web/views/fos_view.ex * creating test/controllers/fos_controller_test.exs * creating web/views/changeset_view.ex * creating web/models/fos.ex * creating test/models/fos_test.exs * creating priv/repo/migrations/<span class="hljs-number"><span class="hljs-number">20170215194144</span></span>_create_fos.exs <span class="hljs-keyword"><span class="hljs-keyword">Add</span></span> the resource <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> your api scope <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> web/router.ex: resources "/fos", FosController, <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: [:<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>, :edit] Remember <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> your repository <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> running migrations: $ mix ecto.migrate</code> </pre> </div></div><br><p>  Here <code>phoenix.gen.json</code> is the task of the mix (mix task) utility, <code>Fos</code> is the model name in the singular, <code>fos</code> is the name for the table, according to the convention there should be a model name with a small letter in the plural, and then comes the description of the fields.  In this case, we want to see in the model a field with the name <code>title</code> and type <code>text</code> (this is the PostgreSQL data type).  About the <code>id</code> field we will talk a bit later.  The mix task list can be obtained by running the <code>mix help</code> command, and for more information about phoenix tasks, see the <a href="http://www.phoenixframework.org/docs/mix-tasks">documentation</a> . </p><br><p>  After the completion of the command, we will be asked to add the line <code>resources "/fos", FosController, except: [:new, :edit]</code> <code>web/router.ex</code> <code>resources "/fos", FosController, except: [:new, :edit]</code> to the <code>web/router.ex</code> .  Let's do it for now (we'll change it later): </p><br><div class="spoiler">  <b class="spoiler_title">web / router.ex</b> <div class="spoiler_text"><pre> <code class="hljs ruby">defmodule AtvApi.Router <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> use AtvApi.Web, <span class="hljs-symbol"><span class="hljs-symbol">:router</span></span> pipeline <span class="hljs-symbol"><span class="hljs-symbol">:api</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> plug <span class="hljs-symbol"><span class="hljs-symbol">:accepts</span></span>, [<span class="hljs-string"><span class="hljs-string">"json"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> scope <span class="hljs-string"><span class="hljs-string">"/api"</span></span>, AtvApi <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> pipe_through <span class="hljs-symbol"><span class="hljs-symbol">:api</span></span> resources <span class="hljs-string"><span class="hljs-string">"/fos"</span></span>, FosController, <span class="hljs-symbol"><span class="hljs-symbol">except:</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:new</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:edit</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>  You will also be prompted to start the migration process, but do not hurry.  By default, Ecto generates a model and migration (a script to create a table in the database) with an auto-increment <code>id</code> field of <code>integer</code> type as the primary key, but we do not need this type of field, since we will use the section code as the key.  Let's change this behavior for our model. </p><br><p>  Let's start with the migration file.  The model generator creates migrations to the <code>priv/repo/migrations</code> directories.  Open the file that ends with <code>_create_fos.exs</code> and bring it to the following view: </p><br><div class="spoiler">  <b class="spoiler_title">priv / repo / migrations / 20170215194144_create_fos.exs</b> <div class="spoiler_text"><pre> <code class="hljs sql">defmodule AtvApi.Repo.Migrations.CreateFos <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Ecto.Migration <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> <span class="hljs-keyword"><span class="hljs-keyword">change</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(:fos, primary_key: <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, :<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, primary_key: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> :title, :<span class="hljs-built_in"><span class="hljs-built_in">text</span></span> timestamps() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>  The code in Elixir is organized in the form of <a href="http://elixir-lang.org/getting-started/modules-and-functions.html">modules and functions</a> .  Each module is defined by the macro <code>defmodule</code> , the description of the functions by the macro <code>def</code> or <code>defp</code> .  Don't pay attention to <code>use</code> yet, we'll come back to this later.  This migration module is called <code>AtvApi.Repo.Migrations.CreateFos</code> , and it is formed for convenience based on the convention.  The language does not force to give such names, and the language does not oblige you to have the whole chain with the "parent" modules such as <code>AtvApi.Repo.Migrations</code> and <code>AtvApi.Repo</code> . </p><br><p>  We added the <code>primary_key: false</code> option to <a href="https://hexdocs.pm/ecto/Ecto.Migration.html">the</a> <code>create/2</code> <a href="https://hexdocs.pm/ecto/Ecto.Migration.html">table creation</a> macro.  By this we cancel the creation of the standard <code>id</code> field and below we manually add a field with the same name, but with the <code>text</code> type, which will become the primary key. </p><br><p>  Let's correct the description of the model, located in the <code>web/models</code> directory: </p><br><div class="spoiler">  <b class="spoiler_title">web / models / fos.ex</b> <div class="spoiler_text"><pre> <code class="hljs ruby">defmodule AtvApi.Fos <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> use AtvApi.Web, <span class="hljs-symbol"><span class="hljs-symbol">:model</span></span> @primary_key {<span class="hljs-symbol"><span class="hljs-symbol">:id</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:string</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">autogenerate:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>} schema <span class="hljs-string"><span class="hljs-string">"fos"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:title</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:string</span></span> timestamps() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @doc <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">" Builds a changeset based on the `struct` and `params`. "</span></span><span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct, params \\ </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">%{}</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> struct <span class="hljs-params"><span class="hljs-params">|&gt; cast(params, [:id, :title]) |</span></span>&gt; validate_required([<span class="hljs-symbol"><span class="hljs-symbol">:id</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:title</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>  Notice that we have added the <code>@primary_key</code> constant with the description of the primary key.  We also added <a href="http://elixir-lang.org/getting-started/basic-types.html">an atom</a> with the name of the field <code>:id</code> to the list of allowed changes (see the <a href="https://hexdocs.pm/ecto/Ecto.Changeset.html">description of the</a> function <code>cast/3</code> , the last parameter <code>allowed</code> ) - otherwise we will not be able to add a field with the code specified by us to the changeset;  The same atom is added to the list <a href="https://hexdocs.pm/ecto/Ecto.Changeset.html">of validator function</a> <code>validate_required/2</code> , which, as the name implies, checks for the presence of the corresponding field in the changeset and, if it is not present, marks the set as erroneous. </p><br><p>  It is worth noting the call to the <code>timestamps/1</code> <a href="https://hexdocs.pm/ecto/Ecto.Schema.html">macro</a> , which adds the <code>inserted_at</code> and <code>updated_at</code> fields of the <code>timestamp</code> type to the model schema.  The first field is initialized with the current time at the moment of creation, the second - with each change of the record by the <code>Ecto</code> functions. </p><br><div class="spoiler">  <b class="spoiler_title">What is the model under the hood</b> <div class="spoiler_text"><p>  Here you also need to say a few words about what the model is. </p><br><p>  In Elixir, there is the concept of "structure" ( <code>struct</code> ).  A structure is an extension of <a href="http://elixir-lang.org/getting-started/keywords-and-maps.html">an associative array</a> (i.e., storage of key-value pairs, standardly denoted as <code>%{ key =&gt; value, ...}</code> , and if the key is an atom, then <code>%{ key: value, ...}</code> );  the structure has an additional key <code>__struct__</code> , the value of which contains its name, and is limited to only those fields that are specified in the code <em>at the time of compilation</em> .  If you try to add a value to a structure with a key that is not described in it at the time of compilation, an error will be generated.  The structure is determined using the <code>defstruct</code> construct and gets the name of the module in which it is described: </p><br><pre> <code class="hljs vbscript">iex&gt; defmodule User <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ...&gt; defstruct title: <span class="hljs-string"><span class="hljs-string">"John"</span></span>, age: <span class="hljs-number"><span class="hljs-number">27</span></span> ...&gt; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  The list of keywords used with <code>defstruct</code> defines the fields that this structure can and will contain, along with their default values.  In the example above, the structure will be named <code>%User{}</code> . </p><br><p>  As mentioned, the structure is an extension of the associative array, so all the functions of <a href="https://hexdocs.pm/elixir/Map.html">the</a> <code>Map</code> <a href="https://hexdocs.pm/elixir/Map.html">module</a> will work with them.  However, <a href="http://elixir-lang.org/getting-started/protocols.html">the</a> <code>Enumerable</code> <a href="http://elixir-lang.org/getting-started/protocols.html">protocol</a> for structures is not implemented, so the <code>Enum</code> <a href="https://hexdocs.pm/elixir/Enum.html">module</a> will not work with them. </p><br><p>  It remains to add that a model is a structure obtained using meta-programming (more on this later) from the description contained in the <code>do ... end</code> block of the macro macro.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Our model described in the module </font></font><code>AtvApi.Fos</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will be of type </font></font><code>%Fos{}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and contain key fields </font></font><code>:id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(by default) and </font></font><code>:title</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(explicitly defined).</font></font></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For more detailed information on structures, welcome to the </font></font><a href="http://elixir-lang.org/getting-started/structs.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p></div></div><br><p>     ,     : </p><br><div class="spoiler"> <b class="spoiler_title">mix test test/models/fos_test.exs</b> <div class="spoiler_text"><pre> <code class="hljs sql">$ mix test test/models/fos_test.exs Compiling 7 files (.ex) Generated atv_api app 1) test changeset <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> valid <span class="hljs-keyword"><span class="hljs-keyword">attributes</span></span> (AtvApi.FosTest) <span class="hljs-keyword"><span class="hljs-keyword">test</span></span>/models/fos_test.exs:<span class="hljs-number"><span class="hljs-number">9</span></span> Expected truthy, got <span class="hljs-literal"><span class="hljs-literal">false</span></span> code: changeset.valid?() stacktrace: <span class="hljs-keyword"><span class="hljs-keyword">test</span></span>/models/fos_test.exs:<span class="hljs-number"><span class="hljs-number">11</span></span>: (<span class="hljs-keyword"><span class="hljs-keyword">test</span></span>) . Finished <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0.05</span></span> seconds <span class="hljs-number"><span class="hljs-number">2</span></span> tests, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">failure</span></span> Randomized <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">seed</span></span> <span class="hljs-number"><span class="hljs-number">166025</span></span></code> </pre> </div></div><br><p>         <code>test/models/fos_test.exs</code> ,  ,  <a href="http://elixir-lang.org/getting-started/module-attributes.html"></a>   <code>@valid_attrs</code>   ,     <code>id</code> .   , -  <code>id</code>  ,     .      ‚Äî          .     : </p><br><pre> <code class="hljs objectivec"> @valid_attrs %{title: <span class="hljs-string"><span class="hljs-string">"Humanities, multidisciplinary"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-string"><span class="hljs-string">"0605BQ"</span></span>}</code> </pre> <br><p>    : </p><br><div class="spoiler"> <b class="spoiler_title">mix test test/models/fos_test.exs</b> <div class="spoiler_text"><pre> <code class="hljs bash">$ mix <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/models/fos_test.exs .. Finished <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.04 seconds 2 tests, 0 failures Randomized with seed 892257</code> </pre> </div></div><br><p>    ,    ,  ,    : </p><br><pre> <code class="hljs pgsql">$ mix ecto.migrate <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">26.080</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>] == Running AtvApi.Repo.Migrations.CreateFos.change/<span class="hljs-number"><span class="hljs-number">0</span></span> forward <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">26.080</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> fos <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">26.097</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>] == Migrated <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span>s</code> </pre> <br><p> ,           <code>mix ecto.rollback</code> . </p><br><h4 id="zapolnenie-tablicy-dannymi-spravochnika">     </h4><br><p>       .             ,            . </p><br><p>         <code>priv/repo/seeds.exs</code> .   <a href="https://raw.githubusercontent.com/vheathen/atv_tutorial_api/master/priv/repo/oecd_fos.txt"></a> <code>oecd_fos.txt</code>  <a href="https://raw.githubusercontent.com/vheathen/atv_tutorial_api/master/priv/repo/grnti.txt"></a> <code>grnti.txt</code> (   )          <code>priv/repo</code> .          .        : </p><br><div class="spoiler"> <b class="spoiler_title">priv/repo/seeds.exs</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">require Logger <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> AtvApi.Repo <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Ecto.Query ### OECD FOS <span class="hljs-keyword"><span class="hljs-keyword">dictionary</span></span> ### <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> AtvApi.Fos unless Repo.one!(<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> f <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Fos, <span class="hljs-keyword"><span class="hljs-keyword">select</span></span>: count(f.id)) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> multi = File.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>!("priv/repo/oecd_fos.txt") |&gt; String.split("\n") |&gt; Enum.reject(fn(<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>) -&gt; byte_size(<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) |&gt; Enum.sort |&gt; Enum.dedup |&gt; Enum.reduce(Ecto.Multi.<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>, fn(<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>, multi) -&gt; [id, title] = <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> |&gt; String.trim |&gt; String.split(";") changeset = Fos.changeset(%Fos{}, %{id: id, title: title}) Ecto.Multi.<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(multi, id, changeset) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) Repo.<span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span>(multi) Logger.<span class="hljs-keyword"><span class="hljs-keyword">info</span></span> "OECD FOS load complete" <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> ### OECD FOS <span class="hljs-keyword"><span class="hljs-keyword">dictionary</span></span> ###</code> </pre> </div></div><br><p>     .     ( <a href="http://elixir-lang.org/getting-started/alias-require-and-import.html">require</a> )   Logger   . </p><br><div class="spoiler"> <b class="spoiler_title">     require</b> <div class="spoiler_text"><p>  Elixir    - (..  ,   ).  ‚Äî   ,     (..   )   .  ,    ,  ,          .  <code>require</code>    . </p></div></div><br><p>  <code>alias</code>    ,     <code>Repo</code>  <code>AtvApi.Repo</code> .   ‚Äî <code>import</code> ‚Äî          (   ‚Äî Ecto.Query,           ).   (,   ,     )    ,  <code>only: [function_title: arity]</code> , , : <code>import Ecto.Query, only: [from: 2]</code> (arity ‚Äî     ).      ‚Äî     -   ,      .   ‚Äî    () ,    ,     ,          ,    .        <a href="http://elixir-lang.org/getting-started/alias-require-and-import.html"></a>  . </p><br><p>           <code>seeds.exs</code> ,       .     <a href="https://hexdocs.pm/ecto/Ecto.Repo.html"></a> Repo.one!/2      ,     SQL  <code>SELECT COUNT(f.id) FROM fos AS f</code> ,      ,   . </p><br><div class="spoiler"> <b class="spoiler_title">""  "" "</b> <div class="spoiler_text"><p>  <a href="https://hexdocs.pm/elixir/master/naming-conventions.html"></a> ,         []  ,      ( <a href="http://elixir-lang.org/getting-started/basic-types.html">tuple</a> )  <code>{:ok, result}</code>  <code>{:error, description}</code> ,  ,   ,     ,      . <br>  For example: </p><br><pre> <code class="hljs cmake">iex&gt; <span class="hljs-keyword"><span class="hljs-keyword">File</span></span>.read(<span class="hljs-string"><span class="hljs-string">"file.txt"</span></span>) {:ok, <span class="hljs-string"><span class="hljs-string">"file contents"</span></span>} iex&gt; <span class="hljs-keyword"><span class="hljs-keyword">File</span></span>.read(<span class="hljs-string"><span class="hljs-string">"no_such_file.txt"</span></span>) {:error, :enoent} iex&gt; <span class="hljs-keyword"><span class="hljs-keyword">File</span></span>.read!(<span class="hljs-string"><span class="hljs-string">"file.txt"</span></span>) <span class="hljs-string"><span class="hljs-string">"file contents"</span></span> iex&gt; <span class="hljs-keyword"><span class="hljs-keyword">File</span></span>.read!(<span class="hljs-string"><span class="hljs-string">"no_such_file.txt"</span></span>) ** (<span class="hljs-keyword"><span class="hljs-keyword">File</span></span>.Error) could <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> read <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> no_such_file.txt: no such <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> directory</code> </pre> </div></div><br><p>    ,    ( <a href="http://elixir-lang.org/getting-started/enumerables-and-streams.html">pipe operator</a> ).             <em>   </em> . ,  (2)  (3) ,    (4)  (5),      : </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="hljs swift">iex(<span class="hljs-number"><span class="hljs-number">1</span></span>)&gt; some_map = %{one: <span class="hljs-number"><span class="hljs-number">1</span></span>} %{one: <span class="hljs-number"><span class="hljs-number">1</span></span>} iex(<span class="hljs-number"><span class="hljs-number">2</span></span>)&gt; <span class="hljs-type"><span class="hljs-type">Enum</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>(some_map) <span class="hljs-number"><span class="hljs-number">1</span></span> iex(<span class="hljs-number"><span class="hljs-number">3</span></span>)&gt; some_map |&gt; <span class="hljs-type"><span class="hljs-type">Enum</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>() <span class="hljs-number"><span class="hljs-number">1</span></span> iex(<span class="hljs-number"><span class="hljs-number">4</span></span>)&gt; <span class="hljs-type"><span class="hljs-type">Enum</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>(<span class="hljs-type"><span class="hljs-type">Map</span></span>.put(some_map, :two, <span class="hljs-number"><span class="hljs-number">2</span></span>)) <span class="hljs-number"><span class="hljs-number">2</span></span> iex(<span class="hljs-number"><span class="hljs-number">5</span></span>)&gt; some_map |&gt; <span class="hljs-type"><span class="hljs-type">Map</span></span>.put(:two, <span class="hljs-number"><span class="hljs-number">2</span></span>) |&gt; <span class="hljs-type"><span class="hljs-type">Enum</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>() <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> </div></div><br><p>  , : </p><br><ul><li>    ( <code>File.read!/1</code> ),   , </li><li>      ( <a href="http://elixir-lang.org/getting-started/basic-types.html">List</a> )  -   <a href="https://hexdocs.pm/elixir/master/String.html"></a> <code>String.split/3</code> ,       <code>\n</code> , </li><li>    ,    ,   <a href="https://hexdocs.pm/elixir/master/Enum.html"></a> <code>Enum.reject/2</code> ,     ,          <code>false</code> , </li><li>     <a href="https://hexdocs.pm/elixir/Enum.html"></a> <code>Enum.sort/1</code> , </li><li>       <a href="https://hexdocs.pm/elixir/Enum.html"></a> <code>Enum.dedup/1</code> , </li><li> , ,    <a href="https://hexdocs.pm/elixir/master/Enum.html"></a> <code>Enum.reduce/3</code> ,    . </li></ul><br><p> <code>Enum.reduce(enumerable, acc, fun)</code> ,      <a href="https://hexdocs.pm/elixir/master/Enum.html">Enum</a> ,    ,  <a href="http://elixir-lang.org/getting-started/enumerables-and-streams.html"> Enumerable</a> (),    ,      ,   .             ,             .      <code>Enum.reduce/3</code>    . </p><br><p>         <a href="https://hexdocs.pm/ecto/Ecto.Multi.html"></a> <code>Ecto.Multi</code>      . </p><br><p>                       <a href="https://hexdocs.pm/elixir/master/String.html"></a> <code>String.trim/1</code> ,  white-space     ;        <code>String.split/3</code> ,      .  <code>oecd_fos.txt</code>       ,    . <code>String.split/3</code>     ,    .         (pattern matching)    <code>id</code> ,  ‚Äî  <code>title</code> . </p><br><div class="spoiler"> <b class="spoiler_title">      </b> <div class="spoiler_text"><p>    ( <a href="http://elixir-lang.org/getting-started/pattern-matching.html">pattern matching</a> ) ‚Äî      Elixir.        ,    ,  <code>=</code> ( ) ‚Äî   ,    (match operator).            ,         : </p><br><pre> <code class="hljs">iex&gt; x = 1 1 iex&gt; x 1</code> </pre> <br><p>     ,   : </p><br><pre> <code class="hljs pgsql">iex&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> = x <span class="hljs-number"><span class="hljs-number">1</span></span> iex&gt; <span class="hljs-number"><span class="hljs-number">2</span></span> = x ** (MatchError) <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> match <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> right hand side <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p>     <code>x</code>  1,         . <br>        ,   . </p><br><p>             : </p><br><pre> <code class="hljs ruby">iex&gt; {a, b, c} = {<span class="hljs-symbol"><span class="hljs-symbol">:hello</span></span>, <span class="hljs-string"><span class="hljs-string">"world"</span></span>, <span class="hljs-number"><span class="hljs-number">42</span></span>} {<span class="hljs-symbol"><span class="hljs-symbol">:hello</span></span>, <span class="hljs-string"><span class="hljs-string">"world"</span></span>, <span class="hljs-number"><span class="hljs-number">42</span></span>} iex&gt; a <span class="hljs-symbol"><span class="hljs-symbol">:hello</span></span> iex&gt; b <span class="hljs-string"><span class="hljs-string">"world"</span></span></code> </pre> <br><p>    : </p><br><pre> <code class="hljs ruby">iex&gt; {a, b, {d, e} = c} = {<span class="hljs-symbol"><span class="hljs-symbol">:hello</span></span>, <span class="hljs-string"><span class="hljs-string">"world"</span></span>, {<span class="hljs-symbol"><span class="hljs-symbol">:grey</span></span>, <span class="hljs-string"><span class="hljs-string">"hole"</span></span>}} {<span class="hljs-symbol"><span class="hljs-symbol">:hello</span></span>, <span class="hljs-string"><span class="hljs-string">"world"</span></span>, {<span class="hljs-symbol"><span class="hljs-symbol">:grey</span></span>, <span class="hljs-string"><span class="hljs-string">"hole"</span></span>}} iex&gt; a <span class="hljs-symbol"><span class="hljs-symbol">:hello</span></span> iex&gt; b <span class="hljs-string"><span class="hljs-string">"world"</span></span> iex&gt; c {<span class="hljs-symbol"><span class="hljs-symbol">:grey</span></span>, <span class="hljs-string"><span class="hljs-string">"hole"</span></span>} iex&gt; d <span class="hljs-symbol"><span class="hljs-symbol">:grey</span></span> iex&gt; e <span class="hljs-string"><span class="hljs-string">"hole"</span></span></code> </pre> <br><p>        ,   .  ,      : </p><br><pre> <code class="hljs pgsql">iex&gt; {a, b, c} = {:hello, "world"} ** (MatchError) <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> match <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> right hand side <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: {:hello, "world"}</code> </pre> <br><p>       ,           : </p><br><pre> <code class="hljs pgsql">iex&gt; {a, b, c} = [:hello, "world", <span class="hljs-number"><span class="hljs-number">42</span></span>] ** (MatchError) <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> match <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> right hand side <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: [:hello, "world", <span class="hljs-number"><span class="hljs-number">42</span></span>]</code> </pre> <br><p>      ,       .            ,       <code>:ok</code> : </p><br><pre> <code class="hljs ruby">iex&gt; {<span class="hljs-symbol"><span class="hljs-symbol">:ok</span></span>, result} = {<span class="hljs-symbol"><span class="hljs-symbol">:ok</span></span>, <span class="hljs-number"><span class="hljs-number">13</span></span>} {<span class="hljs-symbol"><span class="hljs-symbol">:ok</span></span>, <span class="hljs-number"><span class="hljs-number">13</span></span>} iex&gt; result <span class="hljs-number"><span class="hljs-number">13</span></span> iex&gt; {<span class="hljs-symbol"><span class="hljs-symbol">:ok</span></span>, result} = {<span class="hljs-symbol"><span class="hljs-symbol">:error</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:oops</span></span>} ** (MatchError) no match of right hand side <span class="hljs-symbol"><span class="hljs-symbol">value:</span></span> {<span class="hljs-symbol"><span class="hljs-symbol">:error</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:oops</span></span>}</code> </pre> <br><p>        ,     . </p><br><p>        - (pin operator). ,     , ,       , Elixir   ,      .    ,             ?        pin operator: </p><br><pre> <code class="hljs pgsql">iex&gt; x = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> iex&gt; ^x = <span class="hljs-number"><span class="hljs-number">2</span></span> ** (MatchError) <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> match <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> right hand side <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> iex&gt; {y, ^x} = {<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>} {<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>} iex&gt; y <span class="hljs-number"><span class="hljs-number">2</span></span> iex&gt; {y, ^x} = {<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>} ** (MatchError) <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> match <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> right hand side <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: {<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>}</code> </pre> <br><p>      x  1,     : </p><br><pre> <code class="hljs pgsql">iex&gt; {y, <span class="hljs-number"><span class="hljs-number">1</span></span>} = {<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>} ** (MatchError) <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> match <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> right hand side <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: {<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>}</code> </pre> </div></div><br><p>      ( <code>changeset</code> )    <code>AtvApi.Fos.changeset/2</code> ,           OECD FOS (,   ,   ,     <code>:id</code> ).            <code>Ecto.Changeset</code> . </p><br><div class="spoiler"> <b class="spoiler_title">   ,   ' ' `changeset`    </b> <div class="spoiler_text"><p>     <a href="https://hexdocs.pm/ecto/Ecto.Changeset.html"></a> ,  <code>Ecto.Changeset</code>   , ,    ()   ()  (constraints)     (    ,   ‚Äî  ).       <code>Ecto.Changeset</code>   " ", .. <code>changeset</code> .   <code>changeset</code>   <a href="https://hexdocs.pm/ecto/Ecto.Changeset.html"></a> <code>cast/3</code>  <a href="https://hexdocs.pm/ecto/Ecto.Changeset.html"></a> <code>change/2</code> .        , ,  ,   ,  API,     ..,   ‚Äî      .     ,  ,   (   )      . </p><br><p>      <code>AtvApi.Fos.changeset/2</code> ,        <code>Ecto.Changeset</code> ,    ‚Äî <code>cast/3</code> ‚Äî     ( <code>struct</code> ),   ( <code>params</code> )    ,        ,    ,    ( <code>[:id, :title]</code> ).   ,       ,    (  ,   ).       , ,       <code>:id</code> : </p><br><pre> <code class="hljs objectivec">|&gt; validate_length(:<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, min: <span class="hljs-number"><span class="hljs-number">6</span></span>)</code> </pre> <br><p>  ,      ,            <code>valid?</code>  <code>false</code> .           . <br>  For example: </p><br><pre> <code class="hljs pgsql">iex&gt; <span class="hljs-keyword"><span class="hljs-keyword">valid</span></span> = AtvApi.Fos.changeset(%AtvApi.Fos{}, %{id: "123", title: "Some title"}) #Ecto.Changeset&lt;action: nil, changes: %{id: "123", title: "Some title"}, errors: [], data: #AtvApi.Fos&lt;&gt;, <span class="hljs-keyword"><span class="hljs-keyword">valid</span></span>?: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>&gt; iex&gt; invalid = <span class="hljs-keyword"><span class="hljs-keyword">valid</span></span> |&gt; Ecto.Changeset.validate_length(:id, min: <span class="hljs-number"><span class="hljs-number">6</span></span>) #Ecto.Changeset&lt;action: nil, changes: %{id: "123", title: "Some title"}, errors: [id: {"should be at least %{count} character(s)", [count: <span class="hljs-number"><span class="hljs-number">6</span></span>, validation: :length, min: <span class="hljs-number"><span class="hljs-number">6</span></span>]}], data: #AtvApi.Fos&lt;&gt;, <span class="hljs-keyword"><span class="hljs-keyword">valid</span></span>?: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>&gt; iex&gt; AtvApi.Repo.<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>!(invalid) # "" ,    ** (Ecto.InvalidChangesetError) could <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">perform</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> because changeset <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> invalid. Applied changes %{id: "123", title: "Some title"} Params %{"id" =&gt; "123", "title" =&gt; "Some title"} Errors %{id: [{"should be at least %{count} character(s)", [count: <span class="hljs-number"><span class="hljs-number">6</span></span>, validation: :length, min: <span class="hljs-number"><span class="hljs-number">6</span></span>]}]} Changeset #Ecto.Changeset&lt;action: :<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>, changes: %{id: "123", title: "Some title"}, errors: [id: {"should be at least %{count} character(s)", [count: <span class="hljs-number"><span class="hljs-number">6</span></span>, validation: :length, min: <span class="hljs-number"><span class="hljs-number">6</span></span>]}], data: #AtvApi.Fos&lt;&gt;, <span class="hljs-keyword"><span class="hljs-keyword">valid</span></span>?: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>&gt; (ecto) lib/ecto/repo/<span class="hljs-keyword"><span class="hljs-keyword">schema</span></span>.ex:<span class="hljs-number"><span class="hljs-number">134</span></span>: Ecto.Repo.<span class="hljs-keyword"><span class="hljs-keyword">Schema</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>!/<span class="hljs-number"><span class="hljs-number">4</span></span> iex&gt; AtvApi.Repo.<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(invalid) # "" ,   {:error, description} {:error, #Ecto.Changeset&lt;action: :<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>, changes: %{id: "123", title: "Some title"}, errors: [id: {"should be at least %{count} character(s)", [count: <span class="hljs-number"><span class="hljs-number">6</span></span>, validation: :length, min: <span class="hljs-number"><span class="hljs-number">6</span></span>]}], data: #AtvApi.Fos&lt;&gt;, <span class="hljs-keyword"><span class="hljs-keyword">valid</span></span>?: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>&gt;}</code> </pre> </div></div><br><p> ,   ,             ,    . </p><br><p>           insert* <a href="https://hexdocs.pm/ecto/Ecto.Repo.html"></a> <code>Ecto.Repo</code> . ,    ( <code>use</code> )   <code>AtvApi.Repo</code>     ,          <code>AtvApi.Repo.insert ...</code> ,        .  ,      <code>Enum.reduce/3</code>     (       <a href="https://hexdocs.pm/elixir/Enum.html"></a> ‚Äî <code>Enum.each/2</code> ),  ,  -     ?         () .   ,     .    <a href="https://hexdocs.pm/ecto/Ecto.Repo.html"></a> <code>Ecto.Repo.transaction/2</code> ,        ,        ,  <a href="https://hexdocs.pm/ecto/Ecto.Multi.html"></a> <code>Ecto.Multi</code> ,  .          ,   <code>Ecto.Multi</code> ,        ,   <code>Enum.reduce/3</code> .       Elixir     ()  ,      <code>Ecto.Multi</code> ,   [ ]           ,         <code>Enum.reduce/3</code>     <code>multi</code> . </p><br><p>     <code>Repo.transaction/2</code> ,     (, , ,  ,  arity ‚Äî   ‚Äî     ,   ?  ,      , ..    ).          OECD FOS. </p><br><p>     : </p><br><div class="spoiler"> <b class="spoiler_title">mix run priv/repo/seeds.exs</b> <div class="spoiler_text"><pre> <code class="hljs sql">$ mix run priv/repo/seeds.exs [debug] QUERY OK source="fos" db=0.7ms <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(f0.<span class="hljs-string"><span class="hljs-string">"id"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"fos"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> f0 [] [debug] <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> OK db=<span class="hljs-number"><span class="hljs-number">0.1</span></span>ms <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> [] [debug] <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> OK db=<span class="hljs-number"><span class="hljs-number">1.4</span></span>ms <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">"fos"</span></span> (<span class="hljs-string"><span class="hljs-string">"id"</span></span>,<span class="hljs-string"><span class="hljs-string">"title"</span></span>,<span class="hljs-string"><span class="hljs-string">"inserted_at"</span></span>,<span class="hljs-string"><span class="hljs-string">"updated_at"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>,$<span class="hljs-number"><span class="hljs-number">2</span></span>,$<span class="hljs-number"><span class="hljs-number">3</span></span>,$<span class="hljs-number"><span class="hljs-number">4</span></span>) [<span class="hljs-string"><span class="hljs-string">"010000"</span></span>, <span class="hljs-string"><span class="hljs-string">"Natural Sciences"</span></span>, {{<span class="hljs-number"><span class="hljs-number">2017</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">21</span></span>}, {<span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">799789</span></span>}}, {{<span class="hljs-number"><span class="hljs-number">2017</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">21</span></span>}, {<span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">804086</span></span>}}] [debug] <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> OK db=<span class="hljs-number"><span class="hljs-number">0.3</span></span>ms ... <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">"fos"</span></span> (<span class="hljs-string"><span class="hljs-string">"id"</span></span>,<span class="hljs-string"><span class="hljs-string">"title"</span></span>,<span class="hljs-string"><span class="hljs-string">"inserted_at"</span></span>,<span class="hljs-string"><span class="hljs-string">"updated_at"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>,$<span class="hljs-number"><span class="hljs-number">2</span></span>,$<span class="hljs-number"><span class="hljs-number">3</span></span>,$<span class="hljs-number"><span class="hljs-number">4</span></span>) [<span class="hljs-string"><span class="hljs-string">"0605BQ"</span></span>, <span class="hljs-string"><span class="hljs-string">"Humanities, multidisciplinary"</span></span>, {{<span class="hljs-number"><span class="hljs-number">2017</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">21</span></span>}, {<span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">973021</span></span>}}, {{<span class="hljs-number"><span class="hljs-number">2017</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">21</span></span>}, {<span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">973025</span></span>}}] [debug] <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> OK db=<span class="hljs-number"><span class="hljs-number">5.8</span></span>ms <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> [] [info] OECD FOS <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> <span class="hljs-keyword"><span class="hljs-keyword">complete</span></span></code> </pre> </div></div><br><h4 id="kontroller-foscontroller">  FosController </h4><br><p>       back-end.     ?  ‚Äî   (    ,   )! </p><br><p>        CRUD-,  (View),   ,  ,      .  OECD FOS   ,         ‚Äî <code>index</code> ,    .         (  ,    ),     .  ,          (     ,      ). </p><br><p>         <a href="https://github.com/thoughtbot/ex_machina">ExMachina</a> .  ,    <a href="https://github.com/lpil/mix-test.watch">mix test.watch</a> ‚Äî      ,         . </p><br><p>       <code>mix.exs</code> : </p><br><div class="spoiler"> <b class="spoiler_title"> mix.exs</b> <div class="spoiler_text"><pre> <code class="hljs vbscript"># mix.exs # ... # Specifies your project dependencies. # # Type `mix help deps` <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> examples <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> options. defp deps <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> [{:phoenix, <span class="hljs-string"><span class="hljs-string">"~&gt; 1.2.1"</span></span>}, {:phoenix_pubsub, <span class="hljs-string"><span class="hljs-string">"~&gt; 1.0"</span></span>}, {:phoenix_ecto, <span class="hljs-string"><span class="hljs-string">"~&gt; 3.0"</span></span>}, {:postgrex, <span class="hljs-string"><span class="hljs-string">"&gt;= 0.0.0"</span></span>}, {:gettext, <span class="hljs-string"><span class="hljs-string">"~&gt; 0.11"</span></span>}, {:cowboy, <span class="hljs-string"><span class="hljs-string">"~&gt; 1.0"</span></span>}, #  -   {:ex_machina, <span class="hljs-string"><span class="hljs-string">"~&gt; 1.0"</span></span>, only: :test}, {:mix_test_watch, <span class="hljs-string"><span class="hljs-string">"~&gt; 0.3"</span></span>, only: :dev, runtime: <span class="hljs-literal"><span class="hljs-literal">false</span></span>}] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> # ...</code> </pre> </div></div><br><p>  : </p><br><div class="spoiler"> <b class="spoiler_title">mix deps.get</b> <div class="spoiler_text"><pre> <code class="hljs perl">$ mix deps.get Running dependency resolution... Dependency resolution completed: ex_machina <span class="hljs-number"><span class="hljs-number">1.0</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span> fs <span class="hljs-number"><span class="hljs-number">2.12</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> mix_test_watch <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">3.3</span></span> * Getting ex_machina (Hex <span class="hljs-keyword"><span class="hljs-keyword">package</span></span>) Checking <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> (https:<span class="hljs-regexp"><span class="hljs-regexp">//repo</span></span>.hex.pm/tarballs/ex_machina-<span class="hljs-number"><span class="hljs-number">1.0</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>.tar) Using locally cached <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> * Getting mix_test_watch (Hex <span class="hljs-keyword"><span class="hljs-keyword">package</span></span>) Checking <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> (https:<span class="hljs-regexp"><span class="hljs-regexp">//repo</span></span>.hex.pm/tarballs/mix_test_watch-<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">3.3</span></span>.tar) Fetched <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> * Getting fs (Hex <span class="hljs-keyword"><span class="hljs-keyword">package</span></span>) Checking <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> (https:<span class="hljs-regexp"><span class="hljs-regexp">//repo</span></span>.hex.pm/tarballs/fs-<span class="hljs-number"><span class="hljs-number">2.12</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.tar) Fetched <span class="hljs-keyword"><span class="hljs-keyword">package</span></span></code> </pre> </div></div><br><p>  ! </p><br><p>      .         ,   <a href=""></a>     <code>test/support</code> .        ,      <code>:id</code>  <code>:title</code> ,   <code>AtvApi.FactoryFosList.fos_list/0</code> ,    .      : </p><br><div class="spoiler"> <b class="spoiler_title">test/support/factory_fos_list.ex</b> <div class="spoiler_text"><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">defmodule</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">AtvApi</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.FactoryFosList</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">do</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">fos_list</span></span> [ %{<span class="hljs-selector-tag"><span class="hljs-selector-tag">id</span></span>: "010000", <span class="hljs-selector-tag"><span class="hljs-selector-tag">title</span></span>: "<span class="hljs-selector-tag"><span class="hljs-selector-tag">Natural</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Sciences</span></span>"}, %{<span class="hljs-attribute"><span class="hljs-attribute">id</span></span>: <span class="hljs-string"><span class="hljs-string">"020000"</span></span>, title: <span class="hljs-string"><span class="hljs-string">"Engineering and Technology"</span></span>}, %{<span class="hljs-attribute"><span class="hljs-attribute">id</span></span>: <span class="hljs-string"><span class="hljs-string">"030000"</span></span>, title: <span class="hljs-string"><span class="hljs-string">"Medical and Health Sciences"</span></span>}, # ... %{<span class="hljs-attribute"><span class="hljs-attribute">id</span></span>: <span class="hljs-string"><span class="hljs-string">"0604YG"</span></span>, title: <span class="hljs-string"><span class="hljs-string">"Theater"</span></span>}, %{<span class="hljs-attribute"><span class="hljs-attribute">id</span></span>: <span class="hljs-string"><span class="hljs-string">"0605BQ"</span></span>, title: <span class="hljs-string"><span class="hljs-string">"Humanities, multidisciplinary"</span></span>}, ] <span class="hljs-selector-tag"><span class="hljs-selector-tag">def</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">fos_list</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">do</span></span>: @<span class="hljs-keyword"><span class="hljs-keyword">fos_list</span></span> end</code> </pre> </div></div><br><p>    <code>AtvApi.Factory</code> ,       .             : </p><br><div class="spoiler"> <b class="spoiler_title">test/support/factory.ex</b> <div class="spoiler_text"><pre> <code class="hljs sql">defmodule AtvApi.Factory <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> ExMachina.Ecto, repo: AtvApi.Repo <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> AtvApi.FactoryFosList, <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>: [fos_list: <span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> fos_factory <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> %AtvApi.Fos{ <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, title: <span class="hljs-string"><span class="hljs-string">"Some science-technology name"</span></span>, } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> build_all(factory_name, <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>? \\ <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> get_list(factory_name) |&gt; Enum.map(fn(rec) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>? <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(factory_name, rec) <span class="hljs-literal"><span class="hljs-literal">false</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">build</span></span>(factory_name, rec) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> insert_all(factory_name) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> build_all(factory_name, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp get_list(:fos) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> fos_list() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp get_list(_) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> [] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>         <code>use</code> ,       <code>use ExMachina.Ecto, repo: IasipApi.Repo</code>   : </p><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">require</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ExMachina</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Ecto</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ExMachina</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Ecto</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.__using__</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">repo</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">AtvApi</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Repo</span></span>)</code> </pre> <br><p>  <code>require</code>    ,   <code>__using__/1</code> ,      ,    <code>use</code> , <a href="http://elixir-lang.org/getting-started/alias-require-and-import.html"></a>     ( )  ,    . </p><br><div class="spoiler"> <b class="spoiler_title">    ExMachina.Ecto</b> <div class="spoiler_text"><p> , - ‚Äî   ,      .     <a href="http://elixir-lang.org/getting-started/meta/quote-and-unquote.html">"Quote and unquote"</a> , <a href="http://elixir-lang.org/getting-started/meta/macros.html">""</a>  <a href="http://elixir-lang.org/getting-started/meta/domain-specific-languages.html">"Domain Specific Languages"</a>    Elixir. </p><br><p>      ,      ,  ,      , ... </p><br><p> ‚Ä¶    ‚Äî      ,   ,    <code>use ExMachina.Ecto, ...</code> .   <code>ExMachina.Ecto</code>  <a href="">  GitHub</a> . ,        ,     . </p><br><p>      ,  , ..    <code>ExMachina.Ecto</code> ( <code>require ExMachina.Ecto</code> )   <a href=""></a> <code>ExMachina.Ecto.__using__/1</code> ,         - (   ‚Äî <code>repo: AtvApi.Repo</code> ;  ,  Elixir           <code>[]</code> ).       <code>:repo</code>      <strong></strong> ,   <a href=""></a> <code>quote do ... end</code> ,    (..   <code>AtvApi.FactoryFos</code> ),     <code>quote</code>  <code>unquote</code> (.    ).  ,     <a href=""></a> <code>params_for/2</code> , <a href=""></a> <code>string_params_for/2</code>  .     <code>use ExMachina</code>  <code>use ExMachine.EctoStrategy, ...</code> ,     ‚Äî ..        (       ). </p><br><p>  ,   <code>build/2</code>  <code>build_list/3</code> ,           .  <code>ExMachina.Ecto</code>     <code>insert/2</code>  <code>insert_list/3</code> ,     ,           . ,           <a href=""></a> <code>ExMachina.Strategy</code> ,     <code>ExMachina.EctoStrategy</code> <a href=""> </a> <code>use ExMachine.Strategy, function_title: :insert</code> . ,  <code>insert/2</code>  <code>insert_list/3</code>      ‚Äî           <code>__using__/1</code>  <code>ExMachina.Strategy</code>   <code>:function_name</code> . </p><br><p>  ,          ,  . </p></div></div><br><p>    <code>AtvApi.FactoryFosList.fos_list/0</code> ,        ,    <code>fos_factory/0</code> . </p><br><p>   <code>ExMachine.Ecto</code> ,     : <code>build/2</code> / <code>build_list/3</code>  <code>insert/2</code> / <code>insert_list/3</code> .       (      ,           )    ,         .      .  <code>build/2</code>   <code>build(factory_name, attrs)</code> , <code>build_list/3</code>  <code>build_list(number_of_factories, factory_name, attrs)</code> .    , <code>build/2</code> ,       <code>&lt;factory_name&gt;_factory/0</code> .  Those.       <code>build(:fos, %{})</code> ,          <code>fos_factory/0</code> ,       . </p><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><p>     <code>AtvApi.Factory.build/2</code>    Elixir: </p><br><pre> <code class="hljs pgsql">$ MIX_ENV=test iex -S mix Erlang/OTP <span class="hljs-number"><span class="hljs-number">19</span></span> [erts<span class="hljs-number"><span class="hljs-number">-8.2</span></span>] [source] [<span class="hljs-number"><span class="hljs-number">64</span></span>-<span class="hljs-type"><span class="hljs-type">bit</span></span>] [smp:<span class="hljs-number"><span class="hljs-number">4</span></span>:<span class="hljs-number"><span class="hljs-number">4</span></span>] [async-threads:<span class="hljs-number"><span class="hljs-number">10</span></span>] [hipe] [kernel-poll:<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>] Interactive Elixir (<span class="hljs-number"><span class="hljs-number">1.4</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>) - press Ctrl+C <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> h() ENTER <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> help) iex&gt; AtvApi.Factory.build(:fos, %{id: "0103SY", title: "Optics"}) %AtvApi.Fos{__meta__: #Ecto.<span class="hljs-keyword"><span class="hljs-keyword">Schema</span></span>.Metadata&lt;:built, "fos"&gt;, id: "0103SY", inserted_at: nil, title: "Optics", updated_at: nil}</code> </pre> <br><p>         <code>build_all/2</code> ,    . </p><br><p>  :   <code>mix.exs</code>  Phoenix Framework  <code>mix</code> ,     <code>test/support</code>     .              <code>MIX_ENV=test</code> . </p></div></div><br><p>      ,        ( <code>build_all/2</code> ),         ( <code>insert_all/1</code> ). ,     <code>build_all/2</code> ,  <code>insert_all/1</code> ‚Äî       . </p><br><p>        <code>get_list/1</code> : </p><br><div class="spoiler"> <b class="spoiler_title">get_list/1</b> <div class="spoiler_text"><pre> <code class="hljs ruby"> defp get_list(<span class="hljs-symbol"><span class="hljs-symbol">:fos</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> fos_list() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp get_list(<span class="hljs-number"><span class="hljs-number">_</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> [] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>   ,        <code>defp</code>  <code>def</code> ,    .  ,             ( ,      -)   . </p><br><p> ,    .            <code>get_list/1</code>  <code>:fos</code>     ,   , <code>AtvApi.FactoryFosList.fos_list/0</code> ;  ,          .        ,    .        . </p><br><p>   <code>build_all/2</code> .        <code>get_list/1</code> ,  .     <a href="https://hexdocs.pm/elixir/Enum.html"></a> <code>Enum.map/2</code> ,                    ,   .        <code>insert?</code>     <code>ExMachina.build/2</code> ,  <code>ExMachina.Ecto.insert/2</code> (,        -     ).     <code>AtvApi.FactoryFos.build_all/2</code>           <code>%Fos{}</code> . </p><br><p>     ,       <code>mix test</code> .  ,  <code>mix-test.watch</code>           .  <code>mix test.watch</code>       : </p><br><div class="spoiler"> <b class="spoiler_title"> mix test.watch</b> <div class="spoiler_text"><pre> <code class="hljs sql">$ mix test.watch Running tests... ..... Finished in 0.05 seconds 5 tests, 0 failures Randomized <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">seed</span></span> <span class="hljs-number"><span class="hljs-number">806690</span></span></code> </pre> </div></div><br><p>            .   ,    Ctrl+C. </p><br><p>  Phoenix Framework      <code>test/controllers</code> .  ,     ‚Äî <code>exs</code> ,   <code>Elixir Script</code> .      ,   . </p><br><div class="spoiler"> <b class="spoiler_title">()    Elixir</b> <div class="spoiler_text"><p>    Elixir  <a href="https://hexdocs.pm/ex_unit/ExUnit.html"></a> <code>ExUnit</code> .      ,        ‚Äî ,        . </p><br><p>       . </p><br><p>      <code>ExUnit</code>  : </p><br><pre> <code class="hljs pgsql"># File: assertion_test.exs # <span class="hljs-number"><span class="hljs-number">1</span></span>)  ExUnit. ExUnit.<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> # <span class="hljs-number"><span class="hljs-number">2</span></span>)     ( , test <span class="hljs-keyword"><span class="hljs-keyword">case</span></span>) #   (use) "ExUnit.Case". defmodule AssertionTest <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> # <span class="hljs-number"><span class="hljs-number">3</span></span>)  :   "async: true",  #        . #   ,        #  . use ExUnit.<span class="hljs-keyword"><span class="hljs-keyword">Case</span></span>, async: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> # <span class="hljs-number"><span class="hljs-number">4</span></span>)     "test"  "def" test "the truth" <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>     : </p><br><pre> <code class="hljs sql">$ elixir assertion_test.exs warning: this <span class="hljs-keyword"><span class="hljs-keyword">check</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> will <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> yield the same <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> assertion_test.exs:<span class="hljs-number"><span class="hljs-number">17</span></span> . Finished <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0.03</span></span> seconds (<span class="hljs-number"><span class="hljs-number">0.03</span></span>s <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">load</span></span>, <span class="hljs-number"><span class="hljs-number">0.00</span></span>s <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> tests) <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> failures Randomized <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">seed</span></span> <span class="hljs-number"><span class="hljs-number">598489</span></span></code> </pre> <br><p>     <code>Mix</code>       <code>test/test_helper.exs</code> .       . </p><br><p>      <a href="https://hexdocs.pm/ex_unit/ExUnit.Case.html"></a> <code>ExUnit.Case</code> .     <code>async</code>  . </p><br><p>       .           <code>setup_all</code>  <code>setup</code> (  ): </p><br><pre> <code class="hljs sql">defmodule ExampleTest <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> ExUnit.Case setup <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {:ok, [hello: :world]} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"context contains key-value pairs"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">context</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> assert <span class="hljs-keyword"><span class="hljs-keyword">context</span></span>[:hello] == :world <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>      ,  ,         : </p><br><pre> <code class="hljs ruby"> test <span class="hljs-string"><span class="hljs-string">"context is a map and pattern matching"</span></span>, <span class="hljs-string"><span class="hljs-string">%{hello: hello}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> assert hello == <span class="hljs-symbol"><span class="hljs-symbol">:world</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>         <code>setup</code>   ,           ‚Äî    ,   . </p><br><p>  ,  <code>ExUnit.Case</code>       (callbacks) <a href="https://hexdocs.pm/ex_unit/ExUnit.Callbacks.html"></a> <code>ExUnit.Callbacks</code> .     <code>setup_all</code>  <code>setup</code> ,    <code>on_exit/2</code> . </p><br><p>            .      ,       (. ). </p><br><p>  <code>setup_all</code>          .   <code>setup</code>     .         , <code>setup_all</code>  <code>setup</code>   . </p><br><p> <code>on_exit/2</code>   ,    ,   <code>setup</code> . </p><br><p>    <code>setup_all</code>    <code>{:ok, keywords}</code> ,   -  <code>keywords</code>           <code>setup_all</code> , <code>setup</code>   . </p><br><p>       <code>setup</code>          <code>setup</code>  . </p><br><p>    <code>:ok</code>    . </p><br><p>    <code>setup_all</code> -   ,       ,       <code>setup</code>    . </p><br><p>   : </p><br><pre> <code class="hljs pgsql">defmodule AssertionTest <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> use ExUnit.<span class="hljs-keyword"><span class="hljs-keyword">Case</span></span>, async: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> # "setup_all"          setup_all <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> IO.puts " AssertionTest" # <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> metadata :ok <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> # "setup"     setup <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> IO.puts "   'setup'" on_exit fn -&gt; IO.puts "     " <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> #        [hello: "world"] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> #  ,    #    setup context <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> IO.puts " : #{context[:test]}" :ok <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> #        setup :invoke_local_or_imported_function test "always pass" <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> test "another one", context <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> context[:hello] == "world" <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp invoke_local_or_imported_function(context) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> [from_named_setup: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>            <a href="https://hexdocs.pm/ex_unit/ExUnit.Assertions.html"></a> <code>ExUnit.Assertions</code> . ,       <code>ExUnit.Case</code> ,       . </p><br><p>         <code>assert/1</code>       <code>refute/1</code>   . </p><br><p>   ,          ,     ,    . </p><br><p>     Phoenix Framework  ,        -    , ..  ,    ,    . </p><br><p>  ,  ,  . </p></div></div><br><p>     <code>fos_controller_test.exs</code>      : </p><br><div class="spoiler"> <b class="spoiler_title">test/controllers/fos_controller_test.exs</b> <div class="spoiler_text"><pre> <code class="hljs sql">defmodule AtvApi.FosControllerTest <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> AtvApi.ConnCase <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> AtvApi.Factory <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> AtvApi.FactoryFosList, <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>: [fos_list: <span class="hljs-number"><span class="hljs-number">0</span></span>] setup %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> insert_all(:fos) fos = fos_list() |&gt; Enum.sort |&gt; Poison.encode! |&gt; Poison.decode! {:ok, <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: put_req_header(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-string"><span class="hljs-string">"accept"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>), fos: fos} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"lists all entries on index"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, fos: fos} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, fos_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>) assert json_response(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>)[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == fos <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>     (use)  <code>AtvApi.ConnCase</code> ,        Phoenix Framework.         <a href="https://hexdocs.pm/phoenix/Phoenix.ConnTest.html"></a> <code>Phoenix.ConnTest</code> ,   ,   ,       ;  ,   <code>setup</code> ,           <code>conn</code>  <a href="https://hexdocs.pm/plug/Plug.Conn.html"></a> <code>Plug.Conn</code> ,          . </p><br><p>         <code>AtvApi.Factory</code>  <code>AtvApi.FactoryFosList</code> . </p><br><p>    <code>setup</code> ,          <code>conn</code>     <a href="https://hexdocs.pm/plug/Plug.Conn.html"></a> <code>Plug.Conn.put_req_header/3</code>       .          <code>AtvApi.Factory.insert_all/1</code> .          <code>AtvApi.FactoryFosList.fos_list/0</code> ,   <a href="https://hexdocs.pm/elixir/Enum.html"></a> <code>Enum.sort/1</code> ,             <a href="https://github.com/devinus/poison"></a>    JSON   <code>Poison</code> (   JSON,   ‚Äî ).         <code>conn</code> ,       . </p><br><p>         ,       <code>FosController</code>    <code>fos</code> ,     <code>setup</code> .         <code>conn</code>   <code>fos</code> ,        . </p><br><p>     .   ,    HTTP GET-   .      <a href="https://hexdocs.pm/phoenix/Phoenix.ConnTest.html"></a> <code>Phoenix.ConnTest.get/3</code> ,       <code>conn</code> ,   ‚Äî  URL,   .   ‚Äî <code>"/api/fos"</code> ‚Äî   ,      <a href="https://hexdocs.pm/phoenix/Phoenix.Router.html"></a> <code>Phoenix.Router</code> ,        <code>web/router.ex</code> .    -    <code>fos_path/2</code> . </p><br><p>    <code>Phoenix.ConnTest.get/3</code>      <code>conn</code> ,  . </p><br><p>          JSON- : </p><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"data"</span></span>: [ {<span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"010000"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Natural Sciences"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"020000"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Engineering and Technology"</span></span>}, ... ] }</code> </pre> <br><p> <a href="https://hexdocs.pm/phoenix/Phoenix.ConnTest.html"></a> <code>Phoenix.ConnTest.json_response/2</code> ,     ‚Äî 200 (.. HTTP_OK),      JSON-         .  ,    ,      <code>"data"</code>     ‚Äî ..       ‚Äî    <code>fos</code> . </p><br><p>      <code>web/router.ex</code>  <code>resources "/fos", FosController, except: [:new, :edit]</code> .       CRUD-,     .   ,    : </p><br><div class="spoiler"> <b class="spoiler_title">mix phoenix.routes</b> <div class="spoiler_text"><pre> <code class="hljs ruby">$ mix phoenix.routes fos_path GET /api/fos AtvApi.FosController <span class="hljs-symbol"><span class="hljs-symbol">:index</span></span> fos_path GET /api/fos/<span class="hljs-symbol"><span class="hljs-symbol">:id</span></span> AtvApi.FosController <span class="hljs-symbol"><span class="hljs-symbol">:show</span></span> fos_path POST /api/fos AtvApi.FosController <span class="hljs-symbol"><span class="hljs-symbol">:create</span></span> fos_path PATCH /api/fos/<span class="hljs-symbol"><span class="hljs-symbol">:id</span></span> AtvApi.FosController <span class="hljs-symbol"><span class="hljs-symbol">:update</span></span> PUT /api/fos/<span class="hljs-symbol"><span class="hljs-symbol">:id</span></span> AtvApi.FosController <span class="hljs-symbol"><span class="hljs-symbol">:update</span></span> fos_path DELETE /api/fos/<span class="hljs-symbol"><span class="hljs-symbol">:id</span></span> AtvApi.FosController <span class="hljs-symbol"><span class="hljs-symbol">:delete</span></span></code> </pre> </div></div><br><p>         ‚Äî   ‚Äî  .       ‚Äî     .   <code>resources "/fos", FosController, except: [:new, :edit]</code>  <code>get "/fos", FosController, :index</code>   <code>mix phoenix.routes</code> : </p><br><div class="spoiler"> <b class="spoiler_title">mix phoenix.routes</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">$ mix phoenix.routes Compiling <span class="hljs-number"><span class="hljs-number">6</span></span> files (.ex) fos_path <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /api/fos AtvApi.FosController :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span></code> </pre> </div></div><br><p>  ,      ‚Äî   HTTP GET-   <code>http://:/api/fos/</code>    <code>:index</code>  <code>AtvApi.FosController</code> . </p><br><p>    .  ,        ,    .  Which one : </p><br><div class="spoiler"> <b class="spoiler_title">mix test test/controllers/fos_controller_test.exs</b> <div class="spoiler_text"><pre> <code class="hljs php">$ mix test test/controllers/fos_controller_test.exs Compiling <span class="hljs-number"><span class="hljs-number">6</span></span> files (.ex) <span class="hljs-number"><span class="hljs-number">1</span></span>) test lists all entries on index (AtvApi.FosControllerTest) test/controllers/fos_controller_test.exs:<span class="hljs-number"><span class="hljs-number">19</span></span> Assertion with == failed code: json_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>)[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == fos left: [%{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"010000"</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Natural Sciences"</span></span>}, %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"020000"</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Engineering and Technology"</span></span>}, %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"030000"</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Medical and Health Sciences"</span></span>}, ... %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"0101PO"</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Mathematics, interdisciplinary applications"</span></span>}, %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"0101PQ"</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Mathematics"</span></span>}, %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"0101UR"</span></span>, ...}, %{...}, ...] right: [%{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"010000"</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Natural Sciences"</span></span>}, %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"010100"</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Mathematics"</span></span>}, %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"0101PN"</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Mathematics, applied"</span></span>}, ... %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"010600"</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Biological sciences"</span></span>}, %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"0106BD"</span></span>, <span class="hljs-string"><span class="hljs-string">"title"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Biodiversity conservation"</span></span>}, %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"0106CO"</span></span>, ...}, %{...}, ...] stacktrace: test/controllers/fos_controller_test.exs:<span class="hljs-number"><span class="hljs-number">21</span></span>: (test) Finished in <span class="hljs-number"><span class="hljs-number">0.1</span></span> seconds <span class="hljs-number"><span class="hljs-number">1</span></span> test, <span class="hljs-number"><span class="hljs-number">1</span></span> failure Randomized with seed <span class="hljs-number"><span class="hljs-number">415134</span></span></code> </pre> </div></div><br><p>   ,  ,    .  ,     <code>:index</code>  <code>AtvApi.FosController</code>      ,      ,    (  <code>Enum.sort/1</code> ,           <code>setup</code> ).   ,       <code>AtvApi.FosController.index/2</code> .       : </p><br><div class="spoiler"> <b class="spoiler_title">web/controllers/fos_controller.ex</b> <div class="spoiler_text"><pre> <code class="hljs sql">defmodule AtvApi.FosController <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> AtvApi.Web, :controller <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> AtvApi.Fos <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Ecto.Query <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, _params) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> fos = Repo.all(<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> f <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Fos, order_by: f.id) render(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-string"><span class="hljs-string">"index.json"</span></span>, fos: fos) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>   (use)  <code>AtvApi.Web</code> ,   <code>__using__/1</code>     <code>controller</code> .    ‚Äî <code>web/web.ex</code> ,       . </p><br><p>    ,      <code>index/2</code> . <a href="https://hexdocs.pm/ecto/Ecto.Repo.html"> </a> <code>Ecto.Repo.all/2</code>      ,  <a href="https://hexdocs.pm/ecto/Ecto.Queryable.html"></a> <code>Ecto.Queryable</code> ,               ,  .  ,      ,       : <code>Repo.all(Fos)</code> .   ,      ,       - : </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> f0."id", f0."title", f0."inserted_at", f0."updated_at" <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> "fos" <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> f0</code> </pre> <br><p>  those.       ,   <a href="https://blogs.msdn.microsoft.com/conor_cunningham_msft/2008/08/27/no-seatbelt-expecting-order-without-order-by/">  </a> .     ,  DSL  <code>Ecto.Query</code> ,         <code>Repo.all(from f in Fos, order_by: f.id)</code> ,    : </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> f0."id", f0."title", f0."inserted_at", f0."updated_at" <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> "fos" <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> f0 <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> f0."id"</code> </pre> <br><p>  ,     <code>fos</code>      <code>fos</code> ,    <code>id</code> . </p><br><p>      <a href="https://hexdocs.pm/phoenix/Phoenix.Controller.html"></a> <code>Phoenix.Controller.render/3</code> ,    (View)     <code>conn</code> ( ),   ( )        ( ).  ,   ,         ,     ,  ;    ,     Phoenix Framework      (  ) <code>AtvApi.FosView</code> ,         <code>render/2</code> ,      "index.json",   ‚Äî  ,     <code>fos</code> .  ,  <code>view</code> ‚Äî    ,   .   <code>web/views/fos_view.ex</code> ‚Äî      . </p><br><p>     : </p><br><div class="spoiler"> <b class="spoiler_title">mix test test/controllers/fos_controller_test.exs</b> <div class="spoiler_text"><pre> <code class="hljs bash">$ mix <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/controllers/fos_controller_test.exs Compiling 1 file (.ex) . Finished <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.2 seconds 1 <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>, 0 failures Randomized with seed 347227</code> </pre> </div></div><br><p>  ,      . </p><br><p>          (,      ,      ,   <code>mix ecto.create</code> , <code>mix ecto.migrate</code>  <code>mix run priv/repo/seeds.exs</code> ): </p><br><pre> <code class="hljs pgsql">$ mix phoenix.<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>] Running AtvApi.Endpoint <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> Cowboy <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> http://localhost:<span class="hljs-number"><span class="hljs-number">4000</span></span></code> </pre> <br><p>          <code>http://localhost:4000/api/fos/</code> : </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><p><img src="https://habrastorage.org/files/115/3de/8c9/1153de8c9896491eb2442bd5e57258e2.png" alt="Fos dictionary browser screenshot"></p></div></div><br><p>  ,    JSON-   .     ! </p><br><h3 id="spravochnik-grnti">   </h3><br><p> ,        ‚Äî   .    ,     ,  front-end'   .        <code>has_children</code>  . </p><br><h4 id="generaciya-modeli">   </h4><br><p>         ,   ,     : </p><br><pre> <code class="hljs pgsql">$ mix phoenix.gen.model Grnti2 grnti2 title:<span class="hljs-type"><span class="hljs-type">text</span></span> has_children:<span class="hljs-type"><span class="hljs-type">boolean</span></span></code> </pre> <br><p>       .     ,       . </p><br><p>         (integer)    .        . ,   <code>id</code>  <code>Ecto</code>   ,     integer. </p><br><p>       : </p><br><div class="spoiler"> <b class="spoiler_title">priv/repo/migrations/20170211194248_create_grnti.exs</b> <div class="spoiler_text"><pre> <code class="hljs sql">defmodule AtvApi.Repo.Migrations.CreateGrnti <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Ecto.Migration <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> <span class="hljs-keyword"><span class="hljs-keyword">change</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(:grnti, primary_key: <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, :<span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, primary_key: <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> :title, :<span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> :has_children, :<span class="hljs-built_in"><span class="hljs-built_in">boolean</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> timestamps() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>  ,   <code>:has_children</code>   -. </p><br><p>    : </p><br><div class="spoiler"> <b class="spoiler_title">web/models/grnti.ex</b> <div class="spoiler_text"><pre> <code class="hljs sql">defmodule AtvApi.Grnti <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> AtvApi.Web, :<span class="hljs-keyword"><span class="hljs-keyword">model</span></span> <span class="hljs-keyword"><span class="hljs-keyword">schema</span></span> <span class="hljs-string"><span class="hljs-string">"grnti"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">field</span></span> :title, :<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">field</span></span> :has_children, :<span class="hljs-built_in"><span class="hljs-built_in">boolean</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> timestamps() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @doc <span class="hljs-string"><span class="hljs-string">""" Builds a changeset based on the `struct` and `params`. """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> changeset(<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span>, params \\ %{}) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> |&gt; <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(params, [:<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, :title, :has_children]) |&gt; validate_required([:<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, :title, :has_children]) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>           ,      .   ,         <code>id</code> ,    .   ,  <code>changeset/2</code>   . </p><br><p>   ,     : </p><br><div class="spoiler"> <b class="spoiler_title">mix test test/models/grnti_test.exs</b> <div class="spoiler_text"><pre> <code class="hljs sql">$ mix test test/models/grnti_test.exs . 1) test changeset <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> valid <span class="hljs-keyword"><span class="hljs-keyword">attributes</span></span> (AtvApi.GrntiTest) <span class="hljs-keyword"><span class="hljs-keyword">test</span></span>/models/grnti_test.exs:<span class="hljs-number"><span class="hljs-number">9</span></span> Expected truthy, got <span class="hljs-literal"><span class="hljs-literal">false</span></span> code: changeset.valid?() stacktrace: <span class="hljs-keyword"><span class="hljs-keyword">test</span></span>/models/grnti_test.exs:<span class="hljs-number"><span class="hljs-number">11</span></span>: (<span class="hljs-keyword"><span class="hljs-keyword">test</span></span>) Finished <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0.05</span></span> seconds <span class="hljs-number"><span class="hljs-number">2</span></span> tests, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">failure</span></span> Randomized <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">seed</span></span> <span class="hljs-number"><span class="hljs-number">788882</span></span></code> </pre> </div></div><br><p> ,       ,      ,   <code>id</code>  ,     : </p><br><pre> <code class="hljs objectivec">@valid_attrs %{title: <span class="hljs-string"><span class="hljs-string">"some content"</span></span>, has_children: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-number"><span class="hljs-number">100001</span></span>}</code> </pre> <br><p>   : </p><br><div class="spoiler"> <b class="spoiler_title">mix test test/models/grnti_test.exs</b> <div class="spoiler_text"><pre> <code class="hljs bash">$ mix <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/models/grnti_test.exs .. Finished <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.04 seconds 2 tests, 0 failures Randomized with seed 692361</code> </pre> </div></div><br><p>   ‚Äî  : </p><br><div class="spoiler"> <b class="spoiler_title">mix ecto.migrate</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">$ mix ecto.migrate <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">26.080</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>] == Running AtvApi.Repo.Migrations.CreateGrnti.change/<span class="hljs-number"><span class="hljs-number">0</span></span> forward <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">26.080</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> grnti <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span>:<span class="hljs-number"><span class="hljs-number">26.097</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>] == Migrated <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span>s</code> </pre> </div></div><br><h4 id="zapolnenie-tablicy-dannymi-spravochnika-1">     </h4><br><p>             .     <code>priv/repo/seeds.exs</code>  : </p><br><div class="spoiler"> <b class="spoiler_title">priv/repo/seeds.exs</b> <div class="spoiler_text"><pre> <code class="hljs rust">### Grnti dictionary ### alias AtvApi.Grnti unless Repo.one!(from g <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Grnti, select: count(g.id)) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> multi = File.read!(<span class="hljs-string"><span class="hljs-string">"priv/repo/grnti.txt"</span></span>) |&gt; <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.split(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>) |&gt; Enum.reject(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span></span>(row) -&gt; byte_size(row) &lt; <span class="hljs-number"><span class="hljs-number">2</span></span> end) |&gt; Enum.reduce(%{}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span></span>(row, acc) -&gt; {id, parent_id, title} = case &lt;&lt;<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.trim(row)::binary&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> &lt;&lt;a::binary-size(<span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-string"><span class="hljs-string">"."</span></span>, b::binary-size(<span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-string"><span class="hljs-string">"."</span></span>, c::binary-size(<span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-string"><span class="hljs-string">" "</span></span>, title::binary&gt;&gt; -&gt; { <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.to_integer(<span class="hljs-string"><span class="hljs-string">"#{a}#{b}#{c}"</span></span>), <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.to_integer(<span class="hljs-string"><span class="hljs-string">"#{a}#{b}00"</span></span>), title } &lt;&lt;a::binary-size(<span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-string"><span class="hljs-string">"."</span></span>, b::binary-size(<span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-string"><span class="hljs-string">" "</span></span>, title::binary&gt;&gt; -&gt; { <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.to_integer(<span class="hljs-string"><span class="hljs-string">"#{a}#{b}00"</span></span>), <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.to_integer(<span class="hljs-string"><span class="hljs-string">"#{a}0000"</span></span>), title } &lt;&lt;a::binary-size(<span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-string"><span class="hljs-string">" "</span></span>, title::binary&gt;&gt; -&gt; { <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.to_integer(<span class="hljs-string"><span class="hljs-string">"#{a}0000"</span></span>), -<span class="hljs-number"><span class="hljs-number">1</span></span>, title } end parent = case Map.get(acc, parent_id) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> nil -&gt; {<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>} {p_title, _} -&gt; {p_title, <span class="hljs-literal"><span class="hljs-literal">true</span></span>} end current = case Map.get(acc, id) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> nil -&gt; {title, <span class="hljs-literal"><span class="hljs-literal">false</span></span>} {_, has_children} -&gt; {title, has_children} end acc |&gt; Map.put(id, current) |&gt; Map.put(parent_id, parent) end) |&gt; Enum.reduce(Ecto.Multi.new, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span></span>({id, {title, has_children}}, multi) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> id &gt; -<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> changeset = Grnti.changeset(%Grnti{}, %{id: id, title: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.trim(title), has_children: has_children}) Ecto.Multi.insert(multi, <span class="hljs-string"><span class="hljs-string">"#{id}"</span></span>, changeset) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> multi end end) Repo.transaction(multi) Logger.info <span class="hljs-string"><span class="hljs-string">"GRNTI load complete"</span></span> end ### Grnti dictionary ###</code> </pre> </div></div><br><p>  : </p><br><ul><li>    ( <code>File.read!/1</code> ),   , </li><li>      ( <a href="http://elixir-lang.org/getting-started/basic-types.html">List</a> )  -   <a href="https://hexdocs.pm/elixir/master/String.html"></a> <code>String.split/3</code> ,       <code>\n</code> , </li><li>    ,     ,   <a href="https://hexdocs.pm/elixir/master/Enum.html"></a> <code>Enum.reject/2</code> , </li><li>    <a href="https://hexdocs.pm/elixir/master/Enum.html"></a> <code>Enum.reduce/3</code>   , </li><li>         <code>Enum.reduce/3</code> . </li></ul><br><p>      <code>Enum.reduce/3</code> .         <code>%{}</code> .       <code>row</code>     <code>acc</code> .       ? </p><br><p> ,       , : </p><br><ol><li> " 00    " </li><li> " 00.21  -     " </li><li> " 02.01.39     " </li></ol><br><p>      <code>id</code>       <code>title</code> .  ,   ,     .          ,   <code>id</code>       "",  ‚Äî        (        ),    ‚Äî   ,   ‚Ä¶       ,      .        . </p><br><div class="spoiler"> <b class="spoiler_title">  binary   </b> <div class="spoiler_text"><p>  Elixir      <code>&lt;&lt;&gt;&gt;</code> .     <a href="http://elixir-lang.org/getting-started/binaries-strings-and-char-lists.html">  </a>   <a href="https://hexdocs.pm/elixir/Kernel.SpecialForms.html"></a> . </p><br><p>        .  ,   : Erlang   ,    ‚Äî ,     ,  Elixir     . </p><br><p>       ‚Äî  ,   ‚Äî     ,         : </p><br><pre> <code class="hljs ruby">defmodule ImageTyper @png_signature &lt;&lt;<span class="hljs-number"><span class="hljs-number">137</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:size</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>), <span class="hljs-number"><span class="hljs-number">80</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:size</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>), <span class="hljs-number"><span class="hljs-number">78</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:size</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>), <span class="hljs-number"><span class="hljs-number">71</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:size</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>), <span class="hljs-number"><span class="hljs-number">13</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:size</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:size</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>), <span class="hljs-number"><span class="hljs-number">26</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:size</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:size</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>)<span class="hljs-meta"><span class="hljs-meta">&gt;&gt; </span></span>@jpg_signature &lt;&lt;<span class="hljs-number"><span class="hljs-number">255</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:size</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>), <span class="hljs-number"><span class="hljs-number">216</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:size</span></span>(<span class="hljs-number"><span class="hljs-number">8</span></span>)&gt;&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">type</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&lt;&lt;@png_signature, rest::binary&gt;&gt;)</span></span></span></span>, <span class="hljs-symbol"><span class="hljs-symbol">do:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:png</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">type</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&lt;&lt;@jpg_signature, rest::binary&gt;&gt;)</span></span></span></span>, <span class="hljs-symbol"><span class="hljs-symbol">do:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:jpg</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">type</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>, do <span class="hljs-symbol"><span class="hljs-symbol">:unknown</span></span> end</code> </pre> <br><p>   <code>ImageTyper.type/1</code> ,          ,      : <code>:png</code> | <code>:jpg</code> | <code>:unknown</code> . </p></div></div><br><p>  ,      -,      <code>id</code> ,   ‚Äî     <code>title</code>     <code>has_children</code> : <code>%{id =&gt; {title, has_children}}</code> . </p><br><p>  ,   . </p><br><p>   <code>{id, parent_id, title}</code>      <code>case</code> ,           ,           <code>String.trim/1</code> .    -      . </p><br><p>             <code>a</code> , <code>b</code>  <code>c</code> ,         ,   <code>title</code> ,       .          <code>case</code>    :   ,     <code>"#{a}#{b}#{c}"</code> ( <code>#{}</code> ‚Äî          ( )),   ,    ,        ,   .              <code>c</code> ,  ‚Äî <code>b</code> .      ‚Äî    ‚Äî        -1.        <code>id</code> , <code>parent_id</code>  <code>title</code> . </p><br><p>   .      <a href="https://hexdocs.pm/elixir/Map.html"></a> <code>Map.get/3</code>          .        -  <code>nil</code> . ,     (       ,  ,    ),      ,   ‚Äî  <code>has_children</code>  <code>true</code> ,     <code>parent</code> . </p><br><p>       <code>id</code>  :    ‚Äî ,   ‚Äî      ,     <code>has_children</code>    . </p><br><p>       <a href="https://hexdocs.pm/elixir/Map.html"></a> <code>Map.put/3</code>  \          . </p><br><p>          . </p><br><p>            <code>Enum.reduce/3</code> ,       <code>Ecto.Multi</code> ,  ,      OECD FOS.          <code>multi</code> ,    <code>Repo.transaction/2</code>     . </p><br><p>  : </p><br><div class="spoiler"> <b class="spoiler_title">mix run priv/repo/seeds.exs</b> <div class="spoiler_text"><pre> <code class="hljs sql">$ mix run priv/repo/seeds.exs [debug] QUERY OK source="fos" db=0.9ms queue=0.1ms <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(f0.<span class="hljs-string"><span class="hljs-string">"id"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"fos"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> f0 [] [debug] <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> OK <span class="hljs-keyword"><span class="hljs-keyword">source</span></span>=<span class="hljs-string"><span class="hljs-string">"grnti"</span></span> db=<span class="hljs-number"><span class="hljs-number">3.6</span></span>ms <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(g0.<span class="hljs-string"><span class="hljs-string">"id"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"grnti"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> g0 [] [debug] <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> OK db=<span class="hljs-number"><span class="hljs-number">0.1</span></span>ms <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> [] [debug] <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> OK db=<span class="hljs-number"><span class="hljs-number">2.1</span></span>ms <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">"grnti"</span></span> (<span class="hljs-string"><span class="hljs-string">"has_children"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>,<span class="hljs-string"><span class="hljs-string">"title"</span></span>,<span class="hljs-string"><span class="hljs-string">"inserted_at"</span></span>,<span class="hljs-string"><span class="hljs-string">"updated_at"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>,$<span class="hljs-number"><span class="hljs-number">2</span></span>,$<span class="hljs-number"><span class="hljs-number">3</span></span>,$<span class="hljs-number"><span class="hljs-number">4</span></span>,$<span class="hljs-number"><span class="hljs-number">5</span></span>) [<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-number"><span class="hljs-number">443135</span></span>, <span class="hljs-string"><span class="hljs-string">"   "</span></span>, {{<span class="hljs-number"><span class="hljs-number">2017</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>}, {<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">51</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">581608</span></span>}}, {{<span class="hljs-number"><span class="hljs-number">2017</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>}, {<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">51</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">585864</span></span>}}] [debug] <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> OK db=<span class="hljs-number"><span class="hljs-number">0.3</span></span>ms <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">"grnti"</span></span> (<span class="hljs-string"><span class="hljs-string">"has_children"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>,<span class="hljs-string"><span class="hljs-string">"title"</span></span>,<span class="hljs-string"><span class="hljs-string">"inserted_at"</span></span>,<span class="hljs-string"><span class="hljs-string">"updated_at"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>,$<span class="hljs-number"><span class="hljs-number">2</span></span>,$<span class="hljs-number"><span class="hljs-number">3</span></span>,$<span class="hljs-number"><span class="hljs-number">4</span></span>,$<span class="hljs-number"><span class="hljs-number">5</span></span>) [<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-number"><span class="hljs-number">722335</span></span>, <span class="hljs-string"><span class="hljs-string">"  "</span></span>, {{<span class="hljs-number"><span class="hljs-number">2017</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>}, {<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">51</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">593526</span></span>}}, {{<span class="hljs-number"><span class="hljs-number">2017</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>}, {<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">51</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">593531</span></span>}}] [debug] <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> OK db=<span class="hljs-number"><span class="hljs-number">0.1</span></span>ms <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">"grnti"</span></span> (<span class="hljs-string"><span class="hljs-string">"has_children"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>,<span class="hljs-string"><span class="hljs-string">"title"</span></span>,<span class="hljs-string"><span class="hljs-string">"inserted_at"</span></span>,<span class="hljs-string"><span class="hljs-string">"updated_at"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>,$<span class="hljs-number"><span class="hljs-number">2</span></span>,$<span class="hljs-number"><span class="hljs-number">3</span></span>,$<span class="hljs-number"><span class="hljs-number">4</span></span>,$<span class="hljs-number"><span class="hljs-number">5</span></span>) [<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-number"><span class="hljs-number">761300</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>, {{<span class="hljs-number"><span class="hljs-number">2017</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>}, {<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">51</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">593995</span></span>}}, {{<span class="hljs-number"><span class="hljs-number">2017</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>}, {<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">51</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">594000</span></span>}}] ... [debug] <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> OK db=<span class="hljs-number"><span class="hljs-number">0.4</span></span>ms <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">"grnti"</span></span> (<span class="hljs-string"><span class="hljs-string">"has_children"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>,<span class="hljs-string"><span class="hljs-string">"title"</span></span>,<span class="hljs-string"><span class="hljs-string">"inserted_at"</span></span>,<span class="hljs-string"><span class="hljs-string">"updated_at"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>,$<span class="hljs-number"><span class="hljs-number">2</span></span>,$<span class="hljs-number"><span class="hljs-number">3</span></span>,$<span class="hljs-number"><span class="hljs-number">4</span></span>,$<span class="hljs-number"><span class="hljs-number">5</span></span>) [<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-number"><span class="hljs-number">107161</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, {{<span class="hljs-number"><span class="hljs-number">2017</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>}, {<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">51</span></span>, <span class="hljs-number"><span class="hljs-number">56</span></span>, <span class="hljs-number"><span class="hljs-number">376371</span></span>}}, {{<span class="hljs-number"><span class="hljs-number">2017</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>}, {<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">51</span></span>, <span class="hljs-number"><span class="hljs-number">56</span></span>, <span class="hljs-number"><span class="hljs-number">376375</span></span>}}] [debug] <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> OK db=<span class="hljs-number"><span class="hljs-number">0.3</span></span>ms <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-string"><span class="hljs-string">"grnti"</span></span> (<span class="hljs-string"><span class="hljs-string">"has_children"</span></span>,<span class="hljs-string"><span class="hljs-string">"id"</span></span>,<span class="hljs-string"><span class="hljs-string">"title"</span></span>,<span class="hljs-string"><span class="hljs-string">"inserted_at"</span></span>,<span class="hljs-string"><span class="hljs-string">"updated_at"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>,$<span class="hljs-number"><span class="hljs-number">2</span></span>,$<span class="hljs-number"><span class="hljs-number">3</span></span>,$<span class="hljs-number"><span class="hljs-number">4</span></span>,$<span class="hljs-number"><span class="hljs-number">5</span></span>) [<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-number"><span class="hljs-number">292931</span></span>, <span class="hljs-string"><span class="hljs-string">"     "</span></span>, {{<span class="hljs-number"><span class="hljs-number">2017</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>}, {<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">51</span></span>, <span class="hljs-number"><span class="hljs-number">56</span></span>, <span class="hljs-number"><span class="hljs-number">376969</span></span>}}, {{<span class="hljs-number"><span class="hljs-number">2017</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>}, {<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">51</span></span>, <span class="hljs-number"><span class="hljs-number">56</span></span>, <span class="hljs-number"><span class="hljs-number">376972</span></span>}}] [debug] <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> OK db=<span class="hljs-number"><span class="hljs-number">5.0</span></span>ms <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> [] [info] GRNTI <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> <span class="hljs-keyword"><span class="hljs-keyword">complete</span></span></code> </pre> </div></div><br><p> ,           <code>fos</code> ( ,      )  <code>grnti</code> .       . </p><br><h4 id="kontroller-grnticontroller">  GrntiController </h4><br><p>    . </p><br><p>              ,   <a href=""></a>     <code>test/support</code> .     ,         ,      <code>:id</code> , <code>:title</code>  <code>:has_children</code> ,   <code>AtvApi.FactoryGrntiList.grnti_list/0</code> ,    .     : </p><br><div class="spoiler"> <b class="spoiler_title">test/support/factory_grnti_list.ex</b> <div class="spoiler_text"><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">defmodule</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">AtvApi</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.FactoryGrntiList</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">do</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">grnti_list</span></span> [ %{<span class="hljs-selector-tag"><span class="hljs-selector-tag">id</span></span>: 000000, <span class="hljs-selector-tag"><span class="hljs-selector-tag">has_children</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">true</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">title</span></span>: "   "}, %{<span class="hljs-attribute"><span class="hljs-attribute">id</span></span>: <span class="hljs-number"><span class="hljs-number">000800</span></span>, has_children: false, title: <span class="hljs-string"><span class="hljs-string">"   "</span></span>}, %{<span class="hljs-attribute"><span class="hljs-attribute">id</span></span>: <span class="hljs-number"><span class="hljs-number">000900</span></span>, has_children: false, title: <span class="hljs-string"><span class="hljs-string">"  "</span></span>}, %{<span class="hljs-attribute"><span class="hljs-attribute">id</span></span>: <span class="hljs-number"><span class="hljs-number">001100</span></span>, has_children: false, title: <span class="hljs-string"><span class="hljs-string">"   "</span></span>}, # ... %{<span class="hljs-attribute"><span class="hljs-attribute">id</span></span>: <span class="hljs-number"><span class="hljs-number">032323</span></span>, has_children: false, title: <span class="hljs-string"><span class="hljs-string">"    (   XII .)"</span></span>}, %{<span class="hljs-attribute"><span class="hljs-attribute">id</span></span>: <span class="hljs-number"><span class="hljs-number">032325</span></span>, has_children: false, title: <span class="hljs-string"><span class="hljs-string">"     (  XII .   XVI .)"</span></span>}, ] <span class="hljs-selector-tag"><span class="hljs-selector-tag">def</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">grnti_list</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">do</span></span>: @<span class="hljs-keyword"><span class="hljs-keyword">grnti_list</span></span> end</code> </pre> </div></div><br><p>     <code>AtvApi.Factory</code> : </p><br><div class="spoiler"> <b class="spoiler_title">test/support/factory.ex</b> <div class="spoiler_text"><pre> <code class="hljs sql">defmodule AtvApi.Factory <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> ExMachina.Ecto, repo: AtvApi.Repo <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> AtvApi.FactoryFosList, <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>: [fos_list: <span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> AtvApi.FactoryGrntiList, <span class="hljs-keyword"><span class="hljs-keyword">only</span></span>: [grnti_list: <span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> fos_factory <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> %AtvApi.Fos{ <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, title: <span class="hljs-string"><span class="hljs-string">"Some science-technology name"</span></span>, } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> grnti_factory <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> %AtvApi.Grnti{ <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, title: <span class="hljs-string"><span class="hljs-string">"Some grnti chapter name"</span></span>, has_children: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> build_all(factory_name, <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>? \\ <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> get_list(factory_name) |&gt; Enum.map(fn(rec) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>? <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(factory_name, rec) <span class="hljs-literal"><span class="hljs-literal">false</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">build</span></span>(factory_name, rec) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> insert_all(factory_name) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> build_all(factory_name, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp get_list(:fos) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> fos_list() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp get_list(:grnti) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> grnti_list() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp get_list(_) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> [] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>  ,        ,    <code>grnti_factory/0</code>    <code>build/2</code> , <code>build_list/3</code> , <code>insert/2</code>  <code>insert_list/3</code> ,         <code>get_list/1</code> .      <code>build_all/1</code>  <code>insert_all/1</code>    <code>grnti</code> ,     ! , :  - (..   ,  <code>:fos</code>  <code>:grnti</code> )    .            ,   <code>get_list(_)</code>       ,        .    ,    ,    . </p><br><div class="spoiler"> <b class="spoiler_title">   get_list/1</b> <div class="spoiler_text"><p>   ,            ,    .    , , : </p><br><pre> <code class="hljs ruby"> defp get_list(factory) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> factory <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:fos</span></span> -&gt; fos_list() <span class="hljs-symbol"><span class="hljs-symbol">:grnti</span></span> -&gt; grnti_list() <span class="hljs-number"><span class="hljs-number">_</span></span> -&gt; [] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>   ,                      -  ,  . ,    <a href="https://github.com/vheathen/ex_anti_gate"> </a>   ,     API: </p><br><pre> <code class="hljs pgsql"> # ################################################### # # proceed API request results # # ################################################### # # <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> task defp proceed_response(task_uuid, response, state) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> # could be rewriten <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span>, but this <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> better code readability task = Map.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(state, task_uuid) proceed_response(task, task_uuid, response, state) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> such <span class="hljs-type"><span class="hljs-type">uuid</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span> defp proceed_response(task, _task_uuid, _response, state) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> is_nil(task) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> state <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> # Got a normal HTTP response defp proceed_response(task, task_uuid, {:ok, %HTTPoison.Response{body: body, status_code: <span class="hljs-number"><span class="hljs-number">200</span></span>}} = _response, state) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> json_decode_result = Poison.decode(body) proceed_response(task, task_uuid, json_decode_result, state) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> # API task ID defp proceed_response(task, task_uuid, {:ok, %{"errorId" =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, "taskId" =&gt; api_task_id} = _json_body}, state) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Process.send_after(self(), {:api_get_task_result, task_uuid}, task.result_request_interval) put_in(state, [task_uuid, :api_task_id], api_task_id) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> a timer <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> try again <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> the task <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> still processing defp proceed_response(task, task_uuid, {:ok, %{"errorId" =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, "status" =&gt; "processing"} = _json_body}, state) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Process.send_after(self(), {:api_get_task_result, task_uuid}, task.result_retry_interval) state <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> # Deal <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> result <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> the task <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> done <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Image # <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> push: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> defp proceed_response( %{<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: "ImageToTextTask"} = task, task_uuid, {:ok, %{"errorId" =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, "status" =&gt; "ready", "solution" =&gt; %{"text" =&gt; <span class="hljs-type"><span class="hljs-type">text</span></span>}} = _json_body}, state) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> state |&gt; put_in([task_uuid, :result], %{<span class="hljs-type"><span class="hljs-type">text</span></span>: <span class="hljs-type"><span class="hljs-type">text</span></span>}) |&gt; put_in([task_uuid, :status], :ready) |&gt; push_data(task, task_uuid, {:ready, task_uuid, %{<span class="hljs-type"><span class="hljs-type">text</span></span>: <span class="hljs-type"><span class="hljs-type">text</span></span>}}) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">Any</span></span> other - probably an error defp proceed_response(_task, task_uuid, error, state) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> parse_error(task_uuid, error, state) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>                  <code>if\else</code>     . <br>             .  ,        <code>{"errorId" =&gt; 0, "taskId" =&gt; 12345}</code> ,     API  ,  <code>{"errorId" =&gt; 0, "status" =&gt; "processing"}</code> ,       ,     ,  <code>{"errorId" =&gt; 0, "status" =&gt; "ready", "solution" =&gt; {"text" =&gt; "some_text"}}</code> .  ,         ,       ,     , ,  JSON <code>{"errorId" =&gt; 0, "status" =&gt; "ready", "solution" =&gt; %{"image" =&gt; image_string}}</code> (,     ,   JSON,    ).      ,       API    ‚Äî  -    <code>proceed_response/3</code> . </p><br><p>   ‚Äî  . ,       : </p><br><pre> <code class="hljs sql">$ iex Erlang/OTP 19 [erts-8.2] [source] [64-bit] [smp:4:4] [async-threads:10] [hipe] [kernel-poll:false] Interactive Elixir (1.4.1) - press Ctrl+C to exit (type h() ENTER for <span class="hljs-keyword"><span class="hljs-keyword">help</span></span>) iex&gt; defmodule ListSum <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ...&gt; <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> list_sum(<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>: list_sum(<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) ...&gt; <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> list_sum([<span class="hljs-keyword"><span class="hljs-keyword">head</span></span> | tail], <span class="hljs-keyword"><span class="hljs-keyword">acc</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>: list_sum(tail, <span class="hljs-keyword"><span class="hljs-keyword">acc</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">head</span></span>) ...&gt; <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> list_sum([], <span class="hljs-keyword"><span class="hljs-keyword">acc</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">acc</span></span> ...&gt; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> {:<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>, ListSum, &lt;&lt;<span class="hljs-number"><span class="hljs-number">70</span></span>, <span class="hljs-number"><span class="hljs-number">79</span></span>, <span class="hljs-number"><span class="hljs-number">82</span></span>, <span class="hljs-number"><span class="hljs-number">49</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">180</span></span>, <span class="hljs-number"><span class="hljs-number">66</span></span>, <span class="hljs-number"><span class="hljs-number">69</span></span>, <span class="hljs-number"><span class="hljs-number">65</span></span>, <span class="hljs-number"><span class="hljs-number">77</span></span>, <span class="hljs-number"><span class="hljs-number">69</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">223</span></span>, <span class="hljs-number"><span class="hljs-number">131</span></span>, <span class="hljs-number"><span class="hljs-number">104</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">101</span></span>, <span class="hljs-number"><span class="hljs-number">108</span></span>, <span class="hljs-number"><span class="hljs-number">105</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">105</span></span>, <span class="hljs-number"><span class="hljs-number">114</span></span>, <span class="hljs-number"><span class="hljs-number">95</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">111</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>, <span class="hljs-number"><span class="hljs-number">115</span></span>, <span class="hljs-number"><span class="hljs-number">95</span></span>, <span class="hljs-number"><span class="hljs-number">118</span></span>, <span class="hljs-number"><span class="hljs-number">49</span></span>, <span class="hljs-number"><span class="hljs-number">108</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">104</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, ...&gt;&gt;, {:list_sum, <span class="hljs-number"><span class="hljs-number">2</span></span>}} iex&gt; ListSum.list_sum([<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>]) <span class="hljs-number"><span class="hljs-number">36</span></span></code> </pre> </div></div><br><p>    .           , ..   , ,    ,   ,  ,     ‚Äî  ,   .         <code>mix test.watch</code> ,        . </p><br><p>  <code>AtvApi.GrntiController</code>        <code>"/api/grnti/&lt;id&gt;"</code>       <code>&lt;id&gt;</code> ,   ,   ,  <code>&lt;id&gt;</code>  -1. </p><br><p>         <code>get "/grnti/:id", GrntiController, :show</code> : </p><br><div class="spoiler"> <b class="spoiler_title">web/router.ex</b> <div class="spoiler_text"><pre> <code class="hljs sql">defmodule AtvApi.Router <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> AtvApi.Web, :router pipeline :api <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> plug :accepts, [<span class="hljs-string"><span class="hljs-string">"json"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">scope</span></span> <span class="hljs-string"><span class="hljs-string">"/api"</span></span>, AtvApi <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> pipe_through :api <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-string"><span class="hljs-string">"/fos"</span></span>, FosController, :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-string"><span class="hljs-string">"/grnti/:id"</span></span>, GrntiController, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>   : </p><br><div class="spoiler"> <b class="spoiler_title">mix phoenix.routes</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">$ mix phoenix.routes Compiling <span class="hljs-number"><span class="hljs-number">6</span></span> files (.ex) fos_path <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /api/fos AtvApi.FosController :<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> grnti_path <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /api/grnti/:id AtvApi.GrntiController :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span></code> </pre> </div></div><br><p>  Fine!     . </p><br><p>          -,          : </p><br><div class="spoiler"> <b class="spoiler_title">test/support/factory.ex</b> <div class="spoiler_text"><pre> <code class="hljs vbscript"> # ... def get_descendants(:grnti, <span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> grnti_list() |&gt; Enum.<span class="hljs-built_in"><span class="hljs-built_in">filter</span></span>(fn(%{id: id}) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">rem</span></span>(id, <span class="hljs-number"><span class="hljs-number">10000</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> # ...</code> </pre> </div></div><br><p> ,   ‚Äî    ?  ,   ?     !  <code>iex</code>   : </p><br><div class="spoiler"> <b class="spoiler_title">MIX_ENV=test iex -S mix</b> <div class="spoiler_text"><pre> <code class="hljs bash">$ MIX_ENV=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span> iex -S mix Erlang/OTP 19 [erts-8.2] [<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>] [64-bit] [smp:4:4] [async-threads:10] [hipe] [kernel-poll:<span class="hljs-literal"><span class="hljs-literal">false</span></span>] Interactive Elixir (1.4.1) - press Ctrl+C to <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> h() ENTER <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>) iex&gt; AtvApi.Factory.get_descendants(:grnti, -1) [%{has_children: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, id: 0, title: <span class="hljs-string"><span class="hljs-string">"   "</span></span>}, %{has_children: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, id: 20000, title: <span class="hljs-string"><span class="hljs-string">""</span></span>}, %{has_children: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, id: 30000, title: <span class="hljs-string"><span class="hljs-string">".  "</span></span>}]</code> </pre> </div></div><br><p>  . </p><br><p>   <code>test/controllers/grnti_controller_test.exs</code>      : </p><br><div class="spoiler"> <b class="spoiler_title">test/controllers/grnti_controller_test.exs</b> <div class="spoiler_text"><pre> <code class="hljs sql">defmodule AtvApi.GrntiControllerTest <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> AtvApi.ConnCase <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> AtvApi.Factory setup %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> insert_all(:grnti) {:ok, <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: put_req_header(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-string"><span class="hljs-string">"accept"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>)} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"the root level descendants"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">-1</span></span> grnti_subtree = get_descendants(:grnti, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, grnti_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) assert json_response(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>)[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == grnti_subtree |&gt; Poison.encode! |&gt; Poison.decode! <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>           <code>mix test.watch</code> ,  ,       <code>** (UndefinedFunctionError) function AtvApi.GrntiController.init/1 is undefined (module AtvApi.GrntiController is not available)</code> .  ,       .   : </p><br><div class="spoiler"> <b class="spoiler_title">web/controllers/grnti_controller.ex</b> <div class="spoiler_text"><pre> <code class="hljs sql">defmodule AtvApi.GrntiController <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> AtvApi.Web, :controller <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> AtvApi.Grnti <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> <span class="hljs-keyword"><span class="hljs-keyword">show</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> |&gt; put_resp_content_type(<span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>) |&gt; send_resp(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"request_ok"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>      <code>show/2</code> ,      <code>conn</code>   ,   <code>"id"</code> .      content-type     200   . ,    ,     ,     .    . </p><br><p>  Elixir, Ecto  Phoenix Framework    "thin model, fat controller" ‚Äî           ,        . </p><br><p>           .    Grnti,     : </p><br><div class="spoiler"> <b class="spoiler_title">web/models/grnti.ex</b> <div class="spoiler_text"><pre> <code class="hljs vbscript">defmodule AtvApi.Grnti <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> # ... def descendants(parent_id) when parent_id == <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> from g <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> AtvApi.Grnti, where: fragment(<span class="hljs-string"><span class="hljs-string">"mod(?, ?)"</span></span>, g.id, <span class="hljs-number"><span class="hljs-number">10000</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>, order_by: g.id <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>       <code>when</code> .  Erlang Elixir    <code>guards</code> :  ,       ,     (  ,  guards      <code>case</code> ,    ).       <code>guards</code> ,  <a href="http://elixir-lang.org/getting-started/case-cond-and-if.html">  </a> .         <code>id</code>   -1.        ,        ,    ,  . </p><br><p>    ‚Äî   DSL <a href="https://hexdocs.pm/ecto/Ecto.Query.html"></a> <code>Ecto.Query</code> .   ‚Äî   <a href="https://hexdocs.pm/ecto/Ecto.Query.html"></a> <code>where</code> <a href="https://hexdocs.pm/ecto/Ecto.Query.API.html"></a> <code>fragment/1</code>   <code>Ecto.Query.API</code> .       ,       <code>Ecto.Query</code> .       ,    ‚Äî    SQL-,       ( <code>?</code> )  ,      ,    .         <code>id</code>   10000 ‚Äî        . </p><br><p>        <code>show/2</code>  : </p><br><div class="spoiler"> <b class="spoiler_title">web/controllers/grnti_controller.ex</b> <div class="spoiler_text"><pre> <code class="hljs vbscript">defmodule AtvApi.GrntiController <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> # ... def show(conn, %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; parent_id}) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> grnti = parent_id |&gt; Grnti.descendants |&gt; Repo.all render(conn, <span class="hljs-string"><span class="hljs-string">"index.json"</span></span>, grnti: grnti) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>     <code>** (FunctionClauseError) no function clause matching in AtvApi.Grnti.descendants/1</code> .     ,   ,  ,    <code>AtvApi.Grnti.descendants/1</code>   "-1"   -1.    ‚Äî  <code>"id"</code>   URL GET-,    .         <code>AtvApi.Grnti.descendants/1</code> <em></em> : </p><br><div class="spoiler"> <b class="spoiler_title">web/models/grnti.ex</b> <div class="spoiler_text"><pre> <code class="hljs vbscript">defmodule AtvApi.Grnti <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> # ... def descendants(parent_id) when is_binary(parent_id) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> parent_id |&gt; <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.to_integer |&gt; descendants <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> def descendants(parent_id) when parent_id == <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> from g <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> AtvApi.Grnti, where: fragment(<span class="hljs-string"><span class="hljs-string">"mod(?, ?)"</span></span>, g.id, <span class="hljs-number"><span class="hljs-number">10000</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>, order_by: g.id <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>    ‚Äî  ( <a href="https://hexdocs.pm/elixir/Kernel.html"></a> <code>is_binary/1</code>  ,    ‚Äî ),          <code>descendants/1</code>  ,   . </p><br><p>  ,     : <code>** (UndefinedFunctionError) function AtvApi.GrntiView.render/2 is undefined (module AtvApi.GrntiView is not available)</code> . ,  ,    ,       (view).  : </p><br><div class="spoiler"> <b class="spoiler_title">web/views/grnti_view.ex</b> <div class="spoiler_text"><p> defmodule AtvApi.GrntiView do <br> use AtvApi.Web, :view </p><br><p> def render("index.json", %{grnti: grnti}) do <br> %{data: render_many(grnti, AtvApi.GrntiView, "grnti.json")} <br>  end </p><br><p> def render("grnti.json", %{grnti: grnti}) do <br> %{id: grnti.id, <br> title: grnti.title, <br> has_children: grnti.has_children} <br>  end <br>  end </p></div></div><br><p> ,  ‚Äî     ,          .  ,       <code>Phoenix.Controller.render/3</code> , ,   ,    <code>Phoenix.View.render/2</code> ,    ,   (  )   ()  .                .  ,      ,   <code>def render("index.json", %{grnti: grnti})</code> .         <code>:data</code> ,    ,   <code>render_many/3</code> .       ,  ,      ,   ‚Äî    (. ).             <code>Phoenix.View.render/2</code>      ,        ,        ,   <code>render("index.json", %{grnti: grnti})</code> ,     ‚Äî   . </p><br><p> ,        ,  ,    ‚Äî ! </p><br><p> ,    ! </p><br><p>        . ,  ,  -   .    <code>AtvApi.Factory</code>    <code>get_descendants/2</code> : </p><br><div class="spoiler"> <b class="spoiler_title">test/support/factory.ex</b> <div class="spoiler_text"><pre> <code class="hljs vbscript">defmodule AtvApi.Factory <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> # ... def get_descendants(:grnti, <span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> grnti_list() |&gt; Enum.<span class="hljs-built_in"><span class="hljs-built_in">filter</span></span>(fn(%{id: id}) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">rem</span></span>(id, <span class="hljs-number"><span class="hljs-number">10000</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> def get_descendants(:grnti, parent_id) when <span class="hljs-keyword"><span class="hljs-keyword">rem</span></span>(parent_id, <span class="hljs-number"><span class="hljs-number">10000</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> grnti_list() |&gt; Enum.<span class="hljs-built_in"><span class="hljs-built_in">filter</span></span>(fn(%{id: id}) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">rem</span></span>(id, <span class="hljs-number"><span class="hljs-number">100</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> id &gt; parent_id <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> id &lt; parent_id + <span class="hljs-number"><span class="hljs-number">10000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp get_list(:fos) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> # .. <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>     guard,              10000,   (..   xx0000).       ,  <code>id</code>    xxxx00       <code>id</code>     <code>id</code>    . </p><br><p>    ,  ,   . </p><br><p>   .   ,  ,  ,       ,          ,     .   ,  <a href="https://ru.wikipedia.org/wiki/Don%25E2%2580%2599t_repeat_yourself">DRY</a> ,  ,   ‚Äî .  ,        <a href="https://hexdocs.pm/ex_unit/ExUnit.Case.html">  </a>    <code>setup</code>         : </p><br><div class="spoiler"> <b class="spoiler_title">test/controllers/grnti_controller_test.exs</b> <div class="spoiler_text"><pre> <code class="hljs sql">defmodule AtvApi.GrntiControllerTest <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> AtvApi.ConnCase <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> AtvApi.Factory setup %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> insert_all(:grnti) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = put_req_header(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-string"><span class="hljs-string">"accept"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>) descendants = :grnti |&gt; get_descendants(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) |&gt; Poison.encode! |&gt; Poison.decode! <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, grnti_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) {:ok, <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, descendants: descendants} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"shows chosen root level subtree"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, descendants: descendants} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> assert json_response(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>)[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == descendants <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>         <code>setup</code> , ,   ,    .         .        <code>@tag id: -1</code> ,     <code>id: -1</code> ,          <code>setup</code> .   -  . </p><br><p> ,      .        : </p><br><div class="spoiler"> <b class="spoiler_title">test/controllers/grnti_controller_test.exs</b> <div class="spoiler_text"><pre> <code class="hljs lua"> # ... @tag id: <span class="hljs-number"><span class="hljs-number">000000</span></span> test <span class="hljs-string"><span class="hljs-string">"shows chosen second level subtree - id: 000000"</span></span>, %{conn: conn, descendants: descendants} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span> json_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>)[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == descendants <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag id: <span class="hljs-number"><span class="hljs-number">020000</span></span> test <span class="hljs-string"><span class="hljs-string">"shows chosen second level subtree - id: 020000"</span></span>, %{conn: conn, descendants: descendants} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span> json_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>)[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == descendants <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag id: <span class="hljs-number"><span class="hljs-number">030000</span></span> test <span class="hljs-string"><span class="hljs-string">"shows chosen second level subtree - id: 030000"</span></span>, %{conn: conn, descendants: descendants} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span> json_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>)[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == descendants <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> #...</code> </pre> </div></div><br><p>       ,       <code>** (FunctionClauseError) no function clause matching in AtvApi.Grnti.descendants/1</code> .    ‚Äî               ,  -1. </p><br><p> ,       ,           <code>AtvApi.Grnti/descendants/1</code> : </p><br><div class="spoiler"> <b class="spoiler_title">web/models/grnti.ex</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"> # ... def descendants(parent_id) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> parent_id == -<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> from g <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> AtvApi.Grnti, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>: fragment(<span class="hljs-string"><span class="hljs-string">"mod(?, ?)"</span></span>, g.id, <span class="hljs-number"><span class="hljs-number">10000</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>, order_by: g.id end def descendants(parent_id) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> rem(parent_id, <span class="hljs-number"><span class="hljs-number">10000</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> from g <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> AtvApi.Grnti, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>: g.id &gt; ^parent_id, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>: g.id &lt; ^(parent_id + <span class="hljs-number"><span class="hljs-number">10000</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>: fragment(<span class="hljs-string"><span class="hljs-string">"mod(?, ?)"</span></span>, g.id, <span class="hljs-number"><span class="hljs-number">100</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>, order_by: g.id end # ...</code> </pre> </div></div><br><p> ,    <code>Ecto</code> ,      SQL-: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> g0."id", g0."title", g0."has_children", g0."inserted_at", g0."updated_at" <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> "grnti" <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> g0 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (g0."id" &gt; <span class="hljs-meta"><span class="hljs-meta">$1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (g0."id" &lt; <span class="hljs-meta"><span class="hljs-meta">$2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (mod(g0."id", <span class="hljs-number"><span class="hljs-number">100</span></span>) = <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> g0."id"</code> </pre> <br><p>  <code>$1</code> ‚Äî   ,     ,  <code>$2</code> ‚Äî      . </p><br><p>    ,  ,    . </p><br><p>        . <br> : </p><br><div class="spoiler"> <b class="spoiler_title">test/support/factory.ex</b> <div class="spoiler_text"><pre> <code class="hljs vbscript">defmodule AtvApi.Factory <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> # ... def get_descendants(:grnti, parent_id) when <span class="hljs-keyword"><span class="hljs-keyword">rem</span></span>(parent_id, <span class="hljs-number"><span class="hljs-number">10000</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> grnti_list() |&gt; Enum.<span class="hljs-built_in"><span class="hljs-built_in">filter</span></span>(fn(%{id: id}) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">rem</span></span>(id, <span class="hljs-number"><span class="hljs-number">100</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> id &gt; parent_id <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> id &lt; parent_id + <span class="hljs-number"><span class="hljs-number">10000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> def get_descendants(:grnti, parent_id) when <span class="hljs-keyword"><span class="hljs-keyword">rem</span></span>(parent_id, <span class="hljs-number"><span class="hljs-number">100</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> grnti_list() |&gt; Enum.<span class="hljs-built_in"><span class="hljs-built_in">filter</span></span>(fn(%{id: id}) -&gt; id &gt; parent_id <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> id &lt; parent_id + <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp get_list(:fos) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> # .. <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>  Tests: </p><br><div class="spoiler"> <b class="spoiler_title">test/controllers/grnti_controller_test.exs</b> <div class="spoiler_text"><pre> <code class="hljs lua"> # ... @tag id: <span class="hljs-number"><span class="hljs-number">000900</span></span> test <span class="hljs-string"><span class="hljs-string">"shows chosen second level subtree - id: 000900"</span></span>, %{conn: conn, descendants: descendants} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span> json_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>)[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == descendants <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag id: <span class="hljs-number"><span class="hljs-number">021500</span></span> test <span class="hljs-string"><span class="hljs-string">"shows chosen second level subtree - id: 021500"</span></span>, %{conn: conn, descendants: descendants} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span> json_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>)[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == descendants <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag id: <span class="hljs-number"><span class="hljs-number">032300</span></span> test <span class="hljs-string"><span class="hljs-string">"shows chosen second level subtree - id: 032300"</span></span>, %{conn: conn, descendants: descendants} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span> json_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>)[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == descendants <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> #...</code> </pre> </div></div><br><p>  3    . </p><br><p> : </p><br><div class="spoiler"> <b class="spoiler_title">web/models/grnti.ex</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"> # ... def descendants(parent_id) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> rem(parent_id, <span class="hljs-number"><span class="hljs-number">10000</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> from g <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> AtvApi.Grnti, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>: g.id &gt; ^parent_id, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>: g.id &lt; ^(parent_id + <span class="hljs-number"><span class="hljs-number">10000</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>: fragment(<span class="hljs-string"><span class="hljs-string">"mod(?, ?)"</span></span>, g.id, <span class="hljs-number"><span class="hljs-number">100</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>, order_by: g.id end def descendants(parent_id) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> rem(parent_id, <span class="hljs-number"><span class="hljs-number">100</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> from g <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> AtvApi.Grnti, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>: g.id &gt; ^parent_id, <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>: g.id &lt; ^(parent_id + <span class="hljs-number"><span class="hljs-number">100</span></span>), order_by: g.id end # ...</code> </pre> </div></div><br><p>    ! </p><br><p> ,      . ,  ,    ,    <code>id</code>      ,              ,         . </p><br><p> ,      .        ,         <code>id</code> ‚Äî     <code>setup</code> ,      <code>AtvApi.Factory.descendants/2</code> ,      .        , ? </p><br><p>     <code>ExUnit.Case</code>  <a href="https://hexdocs.pm/ex_unit/ExUnit.Case.html"></a> <code>describe/2</code> .         <code>setup</code>  .   <code>setup</code> ,    <code>describe do ... end</code>     ,     .    <code>describe</code>      <code>setup</code> : </p><br><div class="spoiler"> <b class="spoiler_title">test/controllers/grnti_controller_test.exs</b> <div class="spoiler_text"><pre> <code class="hljs sql">defmodule AtvApi.GrntiControllerTest <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> AtvApi.ConnCase <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> AtvApi.Factory setup %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> insert_all(:grnti) <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> |&gt; put_req_header(<span class="hljs-string"><span class="hljs-string">"accept"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>) |&gt; <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(grnti_path(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">show</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)) {:ok, <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">describe</span></span> <span class="hljs-string"><span class="hljs-string">"Controller must return descendants of"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> setup %{<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> descendants = :grnti |&gt; get_descendants(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) |&gt; Poison.encode! |&gt; Poison.decode! {:ok, descendants: descendants} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"the root level"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, descendants: descendants} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> assert json_response(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>)[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == descendants <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-number"><span class="hljs-number">000000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"the chapter with id: 000000"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, descendants: descendants} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> assert json_response(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>)[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == descendants <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-number"><span class="hljs-number">020000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"the chapter with id: 020000"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, descendants: descendants} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> assert json_response(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>)[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == descendants <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-number"><span class="hljs-number">030000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"the chapter with id: 030000"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, descendants: descendants} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> assert json_response(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>)[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == descendants <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-number"><span class="hljs-number">000900</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"the chapter with id: 000900"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, descendants: descendants} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> assert json_response(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>)[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == descendants <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-number"><span class="hljs-number">021500</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"the chapter with id: 021500"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, descendants: descendants} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> assert json_response(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>)[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == descendants <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-number"><span class="hljs-number">032300</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-string"><span class="hljs-string">"the chapter with id: 032300"</span></span>, %{<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, descendants: descendants} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> assert json_response(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>)[<span class="hljs-string"><span class="hljs-string">"data"</span></span>] == descendants <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>       . </p><br><p>        <code>id</code> .    : </p><br><ul><li> , </li><li>   -1   999999, </li><li>    , ..       100,   . </li></ul><br><p>     <code>describe/2</code>   : </p><br><div class="spoiler"> <b class="spoiler_title">test/controllers/grnti_controller_test.exs</b> <div class="spoiler_text"><pre> <code class="hljs lua">defmodule AtvApi.GrntiControllerTest <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> use AtvApi.ConnCase # ... describe <span class="hljs-string"><span class="hljs-string">"Request must be declined with status code 422 and appropriate JSON error message in case of"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> @tag id: <span class="hljs-string"><span class="hljs-string">"somestring"</span></span> test <span class="hljs-string"><span class="hljs-string">"id as a non-digit symbol string"</span></span>, %{conn: conn} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span> json_response(conn, <span class="hljs-number"><span class="hljs-number">422</span></span>)[<span class="hljs-string"><span class="hljs-string">"error"</span></span>] == %{message: <span class="hljs-string"><span class="hljs-string">"Unprocessable Entity"</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag id: <span class="hljs-number"><span class="hljs-number">-2</span></span> test <span class="hljs-string"><span class="hljs-string">"id is less than -1 and equal -2"</span></span>, %{conn: conn} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span> json_response(conn, <span class="hljs-number"><span class="hljs-number">422</span></span>)[<span class="hljs-string"><span class="hljs-string">"error"</span></span>] == %{message: <span class="hljs-string"><span class="hljs-string">"Unprocessable Entity"</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag id: <span class="hljs-number"><span class="hljs-number">-100</span></span> test <span class="hljs-string"><span class="hljs-string">"id is less than -1 and equal -100"</span></span>, %{conn: conn} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span> json_response(conn, <span class="hljs-number"><span class="hljs-number">422</span></span>)[<span class="hljs-string"><span class="hljs-string">"error"</span></span>] == %{message: <span class="hljs-string"><span class="hljs-string">"Unprocessable Entity"</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag id: <span class="hljs-number"><span class="hljs-number">1000000</span></span> test <span class="hljs-string"><span class="hljs-string">"id is greater than 999999 and equal 1000000"</span></span>, %{conn: conn} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span> json_response(conn, <span class="hljs-number"><span class="hljs-number">422</span></span>)[<span class="hljs-string"><span class="hljs-string">"error"</span></span>] == %{message: <span class="hljs-string"><span class="hljs-string">"Unprocessable Entity"</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag id: <span class="hljs-number"><span class="hljs-number">90000000</span></span> test <span class="hljs-string"><span class="hljs-string">"id is greater than 999999 and equal 90000000"</span></span>, %{conn: conn} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span> json_response(conn, <span class="hljs-number"><span class="hljs-number">422</span></span>)[<span class="hljs-string"><span class="hljs-string">"error"</span></span>] == %{message: <span class="hljs-string"><span class="hljs-string">"Unprocessable Entity"</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag id: <span class="hljs-number"><span class="hljs-number">030955</span></span> test <span class="hljs-string"><span class="hljs-string">"id is a third level section code and equal 030955"</span></span>, %{conn: conn} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span> json_response(conn, <span class="hljs-number"><span class="hljs-number">422</span></span>)[<span class="hljs-string"><span class="hljs-string">"error"</span></span>] == %{message: <span class="hljs-string"><span class="hljs-string">"Unprocessable Entity"</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @tag id: <span class="hljs-number"><span class="hljs-number">020129</span></span> test <span class="hljs-string"><span class="hljs-string">"id is a third level section code and equal 020129"</span></span>, %{conn: conn} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">assert</span></span> json_response(conn, <span class="hljs-number"><span class="hljs-number">422</span></span>)[<span class="hljs-string"><span class="hljs-string">"error"</span></span>] == %{message: <span class="hljs-string"><span class="hljs-string">"Unprocessable Entity"</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>  .          <code>id</code>    .    <code>String.to_integer/1</code>     ,     .  <a href="https://hexdocs.pm/elixir/Integer.html"></a>  <code>Integer.parse/2</code> .   ‚Äî   ,         ‚Äî   10, .. ,       .        <code>{integer, reminder_of_binary}</code>  <code>:error</code>   . </p><br><p>     : </p><br><div class="spoiler"> <b class="spoiler_title">web/controllers/grnti_controller.ex</b> <div class="spoiler_text"><pre> <code class="hljs sql">defmodule AtvApi.GrntiController <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> AtvApi.Web, :controller <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> AtvApi.Grnti <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> <span class="hljs-keyword"><span class="hljs-keyword">show</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, %{<span class="hljs-string"><span class="hljs-string">"id"</span></span> =&gt; parent_id}) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Integer.parse(parent_id) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">error</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, :<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>) {<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, _} -&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> <span class="hljs-keyword"><span class="hljs-keyword">show</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, parent_id) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> is_integer(parent_id) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> parent_id &gt; <span class="hljs-number"><span class="hljs-number">-2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> parent_id &lt; <span class="hljs-number"><span class="hljs-number">1000000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">rem</span></span>(parent_id, <span class="hljs-number"><span class="hljs-number">100</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> parent_id == <span class="hljs-number"><span class="hljs-number">-1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> grnti = parent_id |&gt; Grnti.descendants() |&gt; Repo.all() render(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, <span class="hljs-string"><span class="hljs-string">"index.json"</span></span>, grnti: grnti) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> <span class="hljs-keyword"><span class="hljs-keyword">show</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">conn</span></span>, _parent_id) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">conn</span></span> |&gt; put_resp_content_type(<span class="hljs-string"><span class="hljs-string">"application/json"</span></span>) |&gt; send_resp(<span class="hljs-number"><span class="hljs-number">422</span></span>, ~S({<span class="hljs-string"><span class="hljs-string">"error"</span></span>:{<span class="hljs-string"><span class="hljs-string">"message"</span></span>:<span class="hljs-string"><span class="hljs-string">"Unprocessable Entity"</span></span>}})) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> </div></div><br><p>     ,   ,   </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><p>    <code>show/2</code>   ,        , ..      URL.         ,       <code>show/2</code>  .           .  ,     ,   <code>guard</code>   ,          .       ,       ,    <code>Content-Type: application/json</code>       ,    <a href="http://elixir-lang.org/getting-started/sigils.html"></a> (sigil) . </p></div></div><br><p>        back-end. ,      ( ,    GrntiController -    DRY       ).  ,           ,     -            ,   . </p><br><p>        <code>mix phoenix.server</code>      : </p><br><div class="spoiler"> <b class="spoiler_title">       </b> <div class="spoiler_text"><p><img src="https://habrastorage.org/files/f7c/76b/b89/f7c76bb890f24908b09cd49e336bd348.png" alt="GRNTI dictionary browser screenshot"></p></div></div><br><p>    ,         front-end ,    ,   . ,    ,           . </p><br><p>  back-end,    , <a href="https://github.com/vheathen/atv_tutorial_api">  GitHub</a> . </p><br><p> ,       .  Have a nice day! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/322376/">https://habr.com/ru/post/322376/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../322366/index.html">Analytical data outside Wrike analytics</a></li>
<li><a href="../322368/index.html">CSS for Swift: using styles for any subclass of UIView</a></li>
<li><a href="../322370/index.html">Genetic Algorithms and Turing Machine</a></li>
<li><a href="../322372/index.html">We write simple DSL on Kotlin in 2 steps</a></li>
<li><a href="../322374/index.html">Three-letter service quality</a></li>
<li><a href="../322378/index.html">Warm up before the weekend: Raspberry Pi, Arduino and free evening</a></li>
<li><a href="../322380/index.html">NSRegularExpression and NSDataDetector - Quick Start</a></li>
<li><a href="../322384/index.html">Video of reports from Go 1.8 release party Moscow</a></li>
<li><a href="../322386/index.html">Ping and some of its parameters</a></li>
<li><a href="../322388/index.html">On the structure and scaling of complex applications for Node.JS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>