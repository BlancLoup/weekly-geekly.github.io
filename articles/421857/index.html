<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ToFoIn v 1. Backup Gateways and Switch Between External Channels on FreeBSD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="annotation 
 The last article addressed the issue of organizing redundancy for local area network gateways. As a solution, a script was proposed, whic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ToFoIn v 1. Backup Gateways and Switch Between External Channels on FreeBSD</h1><div class="post__text post__text-html js-mediator-article"><h3>  annotation </h3><br>  The last article addressed the issue of organizing redundancy for local area network gateways.  As a solution, a script was proposed, which at that time solved the problem, but had several disadvantages.  After some time, it turned out to eliminate these shortcomings, partially rewrite the code and get something acceptable at the output.  Now we can say that the scripts are sufficiently tested to be called stable.  To simplify the understanding of the entire system, the main points on setting up secondary services (in terms of the topic of the article) will be partially duplicated below.  The reason is simple - during this time, the ipfw rules were also reworked, the dns went live in AD on Samba4 with bind-frontend and safely updating records from isc-dhcpd using kerberos, as well as secondary dns-servers in the form of bind on gateways, was CARP is tuned ... In general, it became much more interesting, but in more detail about how and how it works - below.  All that can be given links to the source, will be designed in this way, so as not to produce the essence.  What has been taken from any other places, but which is no longer available, will be presented here with appropriate comments. <br><a name="habracut"></a><br><h3>  Introduction </h3><br>  So, to increase the noise immunity of the communication channel with the outside world by the consumer, there are two ways: reservation of the gateway and reservation of the connection point.  In other words, in the first case, a second gateway is put in place, in case the first one fails, in the second case, a backup Internet channel is organized in case of any problems with the main one, and the more they intersect, the better it is.  If the first task for FreeBSD is solved by <abbr title="Common Address Redundancy Protocol">CARP</abbr> , then the second, after the organization of the second external channel, can again be solved in several ways.  At a minimum, traffic balancing or channel switching can be arranged.  Due to the large difference in bandwidth of external channels, the first option did not <abbr title="Toogle Failover of Internet">fit</abbr> me, so the main culprit of the publication was written: <abbr title="Toogle Failover of Internet">ToFoIn</abbr> is a set of bash scripts that is aimed at solving problems of diagnostics and switching to a working external channel.  After completion, it can be used for n gateways and m channels.  The situation is poorly represented, where n and m are more than 2, but the following scripts should work up to large values ‚Äã‚Äãof n and m, since  logical limit is not set.  In general, I suspect that using these scripts you can solve a fairly wide range of tasks depending on the connection status, limited, perhaps, only by your imagination. <br><br><img src="https://habrastorage.org/webt/2e/yw/s8/2eyws8o9hbu3cxfpo0yja6dm_ea.png" width="500" align="left"><br>  Approximately this network topology assumes in its simplest form the use of a set of ToFoIn scripts.  Of course, the scripts must also work in the case of a single router, but in this case, the Daemon module will have to be greatly modified to remove the dependence of the sequence of actions on the state of CARP, which will simply be absent in the system.  Further reservation of these and other nodes depends only on the degree of importance of the respective services. <br><br><h3>  Targets and goals </h3><br>  The goal of the project, as before, is to create a universal and easily scalable software package focused on identifying problems with external and internal connections and automatically switching to workable connections.  In general, the logic is as follows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  There are n ‚Äúrouters‚Äù with m external channels on each.  In this case, all n "routers" are in a strict hierarchy and are connected to each other with the help of CARP on all the necessary interfaces. </li><li>  On all machines, an agent works independently of each other, whose task, based on the current CARP status of his car: <br><ul><li>  If backup - identify and configure the machine on the router, which is the master at the moment; </li><li>  If master - check the status of connections at the current time and, if necessary, switch between external channels. </li></ul></li></ul><br><h3>  Decision </h3><br>  CARP operates in the internal network, which provides backup gateways and allows you to not change the settings of other network devices of the internal network when switching channels. <br><br>  Dhcpd operates in the primary - secondary mode and, in general, it doesn‚Äôt matter what other roles its car plays - the connection between dhcpd occurs in the internal network, which routers always look at. <br><br>  Master bind is removed in AD, which is hidden in the local network, while secondary bind servers operate on gateway routers on an equal basis. <br><br>  The ipfw rules differ depending on which channel is considered primary at a given moment and are restarted by the Daemon module when the role changes. <br><br>  Finally, about the scripts themselves.  Now the files are located in the appropriate directories, work from their user and have a startup script in rc.d.  Tasks requiring root access are handled by sudo.  There is an installation script that takes into account the possible presence of an installed version, as well as a fairly detailed configuration file.  The modules are the same with minor changes, some almost did not change in functionality: <br><br>  <b>Daemon</b> - as the name implies, is the main process that starts the testing and switching modules by timer and also tracks CARP. <br>  <b>Tester</b> - tests the availability of communication through external channels still with the help of the ping command.  (if it is running, it considers that the car has CARP in Master state) <br>  <b>Judge</b> - based on the test results, determines which external channel is working and whether switching is necessary, performs switching (if it is running, it considers that the machine has CARP in the Master state). <br>  <b>Scout</b> is a new module.  Runs when CARP is in Backup status.  It is needed to determine which of the remaining routers is currently the primary one. <br>  <b>Logger</b> - is responsible for logging events.  It is necessary so that information about events is not duplicated and the magazine is easier to read. <br>  <b>Watchdog</b> - runs on a schedule from the crontab.  It determines the "freezing" of all modules and (if possible) tries to solve the problems that have arisen.  Those.  nail everyone, to put it simply. <br><br>  In addition to the scripts themselves, it is worth considering some more important files: <br><br>  <b>Tofoin.conf</b> - a single configuration file. <br>  <b>Tofoin.log</b> is a single event log file. <br>  <b>Result_</b> &lt;internal channel number&gt; is a work file, test results are added here, created in / tmp next to .pid and other work files. <br><br>  I am happy to answer questions regarding the work of the modules, explaining the decisions in the comments. <br><br><h3>  Technical part </h3><br><h4>  Equipment </h4><br>  Compared to the previous time, the gateways moved to P4, received 1536 Mb of RAM and three 40 Gb HDDs each (mirror + spare).  Network cards are still PCI, BP are normal, naturally in the presence of a UPS. <br>  The increase in capacity is associated with the released iron and unnecessarily tedious update from the source, but mostly - the first.  OS FreeBSD 11.1, FS zfs. <br><br><h4>  System Component Settings </h4><br><div class="spoiler">  <b class="spoiler_title">Read more</b> <div class="spoiler_text">  The kernel is built with such additional parameters (something can be set in the loader, but better so): <br><br><pre><code class="bash hljs">options IPFIREWALL <span class="hljs-comment"><span class="hljs-comment"># ipfw firewall options IPFIREWALL_VERBOSE options IPFIREWALL_VERBOSE_LIMIT=50 options IPFIREWALL_NAT options LIBALIAS options DUMMYNET options HZ=1000 options ROUTETABLES=4 options KSTACK_PAGES=4 options KVA_PAGES=512 device carp</span></span></code> </pre> <br>  Settings / boot / loader.conf: <br><pre> <code class="bash hljs">geom_mirror_load=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> zfs_load=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> kern.geom.label.gptid.enable=<span class="hljs-string"><span class="hljs-string">"0"</span></span> vm.kmem_size=<span class="hljs-string"><span class="hljs-string">"1024M"</span></span> vm.kmem_size_max=<span class="hljs-string"><span class="hljs-string">"1024M"</span></span> vfs.zfs.arc_max=<span class="hljs-string"><span class="hljs-string">"512M"</span></span> vfs.zfs.vdev.cache.size=<span class="hljs-string"><span class="hljs-string">"30M"</span></span> vfs.zfs.prefetch_disable=1 kern.vty=vt</code> </pre> <br>  The /etc/rc.conf settings on the first machine (the CARP setting is of primary interest): <br><pre> <code class="bash hljs">ifconfig_eth0=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth0=<span class="hljs-string"><span class="hljs-string">"vlan111 vlan222"</span></span> create_args_vlan111=<span class="hljs-string"><span class="hljs-string">"vlan 111"</span></span> create_args_vlan222=<span class="hljs-string"><span class="hljs-string">"vlan 222"</span></span> ifconfig_eth1=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth1=<span class="hljs-string"><span class="hljs-string">"vlan333 vlan444 vlan555"</span></span> create_args_vlan333=<span class="hljs-string"><span class="hljs-string">"vlan 333"</span></span> create_args_vlan444=<span class="hljs-string"><span class="hljs-string">"vlan 444"</span></span> create_args_vlan555=<span class="hljs-string"><span class="hljs-string">"vlan 555"</span></span> ifconfig_eth2=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth2=<span class="hljs-string"><span class="hljs-string">"vlan666 vlan777 vlan888"</span></span> create_args_vlan666=<span class="hljs-string"><span class="hljs-string">"vlan 666"</span></span> create_args_vlan777=<span class="hljs-string"><span class="hljs-string">"vlan 777"</span></span> create_args_vlan888=<span class="hljs-string"><span class="hljs-string">"vlan 888"</span></span> ifconfig_vlan666=<span class="hljs-string"><span class="hljs-string">"inet 192.168.0.1/24"</span></span> ifconfig_vlan666_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.0.5/32"</span></span> ifconfig_vlan777=<span class="hljs-string"><span class="hljs-string">"inet 192.168.1.1/24"</span></span> ifconfig_vlan777_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.1.5/32"</span></span> ifconfig_vlan888=<span class="hljs-string"><span class="hljs-string">"inet 192.168.2.1/24"</span></span> ifconfig_vlan888_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.2.5/32"</span></span> ifconfig_vlan111=<span class="hljs-string"><span class="hljs-string">"inet 192.168.3.1/30"</span></span> ifconfig_vlan111_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 1.1.1.2/24"</span></span> ifconfig_vlan222=<span class="hljs-string"><span class="hljs-string">"inet 192.168.4.1/30"</span></span> ifconfig_vlan333=<span class="hljs-string"><span class="hljs-string">"inet 192.168.5.1/30"</span></span> ifconfig_vlan333_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 2.2.2.2/30"</span></span> ifconfig_vlan444=<span class="hljs-string"><span class="hljs-string">"inet 192.168.6.1/30"</span></span> ifconfig_vlan444_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 3.3.3.2/30"</span></span> ifconfig_vlan555=<span class="hljs-string"><span class="hljs-string">"inet 192.168.7.1/30"</span></span> defaultrouter=<span class="hljs-string"><span class="hljs-string">"1.1.1.1"</span></span> setfib1_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib1_defaultrouter=<span class="hljs-string"><span class="hljs-string">"3.3.3.1"</span></span> setfib2_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib2_defaultrouter=<span class="hljs-string"><span class="hljs-string">"2.2.2.1"</span></span> zfs_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> named_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> dhcpd_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_logging=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_script=<span class="hljs-string"><span class="hljs-string">"/etc/firewall.sh"</span></span> gateway_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> tofoin_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span></code> </pre> <br>  <i>Legend:</i> <i><br></i>  <i>eth0, eth1, eth2 - physical adapters</i> <i><br></i>  <i>vlan666, vlan777, vlan888 - virtual LAN adapters,</i> <i><br></i>  <i>vlan222 and vlan555 - adapters for backup communication between external network cards (perhaps no longer needed, were actively used before)</i> <i><br></i>  <i>vlan111 - main external channel</i> <i><br></i>  <i>vlan444 - backup external channel</i> <i><br></i>  <i>vlan333 - telephony</i> <br>  Settings / etc / rc.conf on the second machine (the main interest is the CARP setting, some of the repeating lines are removed): <br><pre> <code class="bash hljs">ifconfig_vlan666=<span class="hljs-string"><span class="hljs-string">"inet 192.168.0.2/24"</span></span> ifconfig_vlan666_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.0.5/32"</span></span> ifconfig_vlan777=<span class="hljs-string"><span class="hljs-string">"inet 192.168.1.2/24"</span></span> ifconfig_vlan777_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.1.5/32"</span></span> ifconfig_vlan888=<span class="hljs-string"><span class="hljs-string">"inet 192.168.2.2/24"</span></span> ifconfig_vlan888_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.2.5/32"</span></span> ifconfig_vlan111=<span class="hljs-string"><span class="hljs-string">"inet 192.168.3.2/30"</span></span> ifconfig_vlan111_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 1.1.1.2/24"</span></span> ifconfig_vlan222=<span class="hljs-string"><span class="hljs-string">"inet 192.168.4.2/30"</span></span> ifconfig_vlan333=<span class="hljs-string"><span class="hljs-string">"inet 192.168.5.2/30"</span></span> ifconfig_vlan333_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 2.2.2.2/30"</span></span> ifconfig_vlan444=<span class="hljs-string"><span class="hljs-string">"inet 192.168.6.2/30"</span></span> ifconfig_vlan444_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 3.3.3.2/30"</span></span> ifconfig_vlan555=<span class="hljs-string"><span class="hljs-string">"inet 192.168.7.2/30"</span></span> defaultrouter=<span class="hljs-string"><span class="hljs-string">"1.1.1.1"</span></span> setfib1_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib1_defaultrouter=<span class="hljs-string"><span class="hljs-string">"3.3.3.1"</span></span> setfib2_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib2_defaultrouter=<span class="hljs-string"><span class="hljs-string">"2.2.2.1"</span></span></code> </pre> <br>  Some rules that will come in handy when configuring ipfw (nat): <br>  to allow CARP traffic: <br><pre> <code class="bash hljs">/sbin/ipfw -q add allow carp from any to any</code> </pre> <br>  "Nuclear" nat: <br><pre> <code class="bash hljs">/sbin/ipfw -q nat 1 config <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> ip vlan111 reset same_ports deny_in unreg_only /sbin/ipfw -q add nat 1 ip from any to any <span class="hljs-keyword"><span class="hljs-keyword">in</span></span></code> </pre> <br>  using specific routing tables with specific adapters: <br><pre> <code class="bash hljs">/sbin/ipfw -q add setfib 0 all from any to any via vlan666</code> </pre> <br>  In general, one could quietly write a separate article about the settings of ipfw applied by me, but this is some other time. <br></div></div><br><h4>  Third Party Software </h4><br><div class="spoiler">  <b class="spoiler_title">Read more</b> <div class="spoiler_text">  Since there is a need to simultaneously work with two or more external channels, it is convenient for this to have several routing tables, one for each channel.  And it would be nice if these tables were created at the start themselves.  This will help rc.d setfib script.  The logic used in ToFoIn assumes that the file name (setfib1, setfib2, etc.) is the same as the table number into which the individual script adds the default route.  The table has the default number "0". <br>  DNS servers with Bind in the main role work in the secondary mode, the main role is samba4 + bind, hidden in the local network.  The setup of secondary bind is beautifully disclosed in Cricket Lee and Paul Albitts's book DNS and BIND.  I don‚Äôt remember any special requirements that take into account the use of samba4 for secondary servers, and I don‚Äôt have any mention of them in the settings file.  Unless, for different Internet channels, you may need to create 2 different files, which will then be copied to the ToFoIn script into the place from which the bind itself will read it.  This is due to the fact that when you specify both providers' addresses in the same file, given that bind only works with one routing table, there is a problem with resolving addresses from upstream servers that are inaccessible at some point. <br>  Failover isc-dhcpd.  Dhcpd is not critical for the work of ToFoIn, moreover, its absence will not affect the operation of the scripts at all, however, it seems to me that it is enough to place the dhcp server on gateways and then the issue of failover still arises.  And here, in comparison with the last time, it became more interesting ... In addition to the settings necessary for the failover, which I described <a href="https://habr.com/post/241654/">last time</a> (the beginning of the ‚Äúpre-setting‚Äù section within the drop-down menu). <br>  You also need a script to securely update dns entries in AD using samba4.  The samba4 server itself should simply be installed.  Setup and launch is not required, we are only interested in management tools that come with it.  Other information can be found in the section ‚ÄúDHCP with dynamic DNS updates‚Äù <a href="https://wiki.archlinux.org/index.php/Samba_4_Active_Directory_Domain_Controller">at</a> . <br>  It looks scary, but it works. <br>  This completes the configuration of third-party software. <br></div></div><br><h4>  Little about ToFoIn </h4><br>  All the text of the project along with the installation script is available on <a href="https://gitlab.com/LordNicky/ToFoIn">gitlab</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Finally, an example of the parameters of the ToFoIn settings file is considered:</b> <div class="spoiler_text">  Number of routers used in the system: <br><pre> <code class="bash hljs">RNUMBER=2</code> </pre> <br>  When using additional subnets, you need to set a default route when the router becomes main.  Here you can specify the number of the corresponding setfib file that will be restarted.  In this example, setfib2: <br><pre> <code class="bash hljs">ADDITLAN=2</code> </pre> <br>  Internal adapter name: <br><pre> <code class="bash hljs">INT_IF=vlan666</code> </pre> <br>  All other interfaces on which routers are connected through CARP.  Required to control and maintain the same state of all interfaces: <br><pre> <code class="bash hljs">ALL_IF=<span class="hljs-string"><span class="hljs-string">"vlan111 vlan333 vlan444 vlan666 vlan777 vlan888"</span></span></code> </pre> <br>  The vhid that was used when setting up CARP: <br><pre> <code class="bash hljs">CARP_VHID=1</code> </pre> <br>  IP addresses in the internal network of other routers in order of importance, if necessary, are then simply used ASERV_IP_2, ASERV_IP_3, etc. <br><pre> <code class="bash hljs">ASERV_IP_1=192.168.0.2</code> </pre> <br>  Number of external connection channels: <br><pre> <code class="bash hljs">CNUMBER=2</code> </pre> <br>  Settings for the main external connection channel: <br>  Adapter Name: <br><pre> <code class="bash hljs">EXT_0_IF=vlan111</code> </pre> <br>  Routing table number: <br><pre> <code class="bash hljs">RTABLE_0=0</code> </pre> <br>  Default Gateway: <br><pre> <code class="bash hljs">DEFAULT_GATEWAY=2.2.2.1</code> </pre> <br>  Settings for backup external connection channel: <br>  Adapter Name: <br><pre> <code class="bash hljs">EXT_1_IF=vlan444</code> </pre> <br>  Routing table number: <br><pre> <code class="bash hljs">RTABLE_1=1</code> </pre> <br>  The default gateway is not required, since for all routing tables except the main one, the setfib script &lt;table number&gt; is used by the rc.d, which is supposed to be the same as the table number by logic. <br>  Tester module parameters: <br>  The number of addresses that will be checked: <br><pre> <code class="bash hljs">TNUMBER=2</code> </pre> <br>  Addresses of machines for which ping requests are sent.  It is best to use the domain name in the first case, and only after this ip address: <br><pre> <code class="bash hljs">PTARGET_0=ya.ru PTARGET_1=8.8.8.8</code> </pre> <br>  The number of ping packets sent by one target: <br><pre> <code class="bash hljs">PNUMBER=2</code> </pre> <br>  Judge module settings <br>  The number of successful tests of the main channel before returning to it.  The return time to the main channel after the resumption of its work is approximately calculated by the formula: (WNUMBER + 1) * JUDGEPERIOD seconds. <br><pre> <code class="bash hljs">WNUMBER=3</code> </pre> <br>  Logger module settings <br>  These 2 parameters indicate the frequency with which the Logger will record repeated events.  After recording the event, the next time the LOGFREQ1 number of repetitions is reported, then the LOGFREQ2 number of repetitions.  Only events in succession are counted. <br><pre> <code class="bash hljs">LOGFREQ1=5 LOGFREQ2=20</code> </pre> <br>  Module start timers in seconds <br>  Tester module launch period.  It makes sense to calculate based on the time of unsuccessful attempts to test all targets. <br><pre> <code class="bash hljs">TESTERPERIOD=240</code> </pre> <br>  The launch period of the Judge module.  Do not install less than TESTERPERIOD. <br><pre> <code class="bash hljs">JUDGEPERIOD=300</code> </pre> <br>  Scout module launch period. <br><pre> <code class="bash hljs">SCOUTPERIOD=360</code> </pre> <br>  The waiting period before checking the timers for the Tester and Judge modules.  It is logical to set less than or equal to the value of TESTERPERIOD. <br><pre> <code class="bash hljs">SENSITIVITY=60</code> </pre> <br>  The time after which a working module is considered to be hung.  Used by the Watchdog module. <br><pre> <code class="bash hljs">TESTERLIMIT=40 JUDGELIMIT=30 LOGGERLIMIT=20 SCOUTLIMIT=120 WATCHDOGLIMIT=150</code> </pre> <br>  Paths to files and directories <br>  The path to the ipfw script. <br><pre> <code class="bash hljs">FIRESCRIPT=/etc/firewall.sh</code> </pre> <br>  Ipfw settings  If the ipfw settings are not in a separate file, FIRESCRIPT = FIRESETDEF. <br><pre> <code class="bash hljs">FIRESETDEF=/etc/firewall/config</code> </pre> <br>  Path to ipfw settings for the main external channel: <br><pre> <code class="bash hljs">FIRESET_0=/etc/firewall/config_0</code> </pre> <br>  The path to the ipfw settings for the backup external channel, if necessary, you can continue further FIRESET_2, etc .: <br><pre> <code class="bash hljs">FIRESET_1=/etc/firewall/config_1</code> </pre> <br>  Bind settings paths <br><pre> <code class="bash hljs">BINDSETDEF=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf</code> </pre> <br>  Bind settings for the main external channel: <br><pre> <code class="bash hljs">BINDSET_0=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf.0</code> </pre> <br>  Bind settings for the backup external channel, if necessary, you can continue further BINDSET_2, etc .: <br><pre> <code class="bash hljs">BINDSET_1=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf.1</code> </pre> <br>  Paths to all executable ToFoIn files: <br><pre> <code class="bash hljs">DAEMON=/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/daemon.sh TESTER=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/tester.sh JUDGE=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/judge.sh LOGGER=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/logger.sh SCOUT=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/scout.sh WATCHDOG=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/watchdog.sh</code> </pre> <br>  The event log.  This file is now NOT created during installation: <br><pre> <code class="bash hljs">LOGFILE=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/tofoin.log</code> </pre> <br>  Temporary files and directories are created when the respective modules are started, some are deleted when stopped: <br><pre> <code class="bash hljs">DIR_TMP=/tmp/tofoin DIR_PID=/var/run/tofoin JUDGEMETER=/tmp/tofoin/judgemeter PREVSTATE=/tmp/tofoin/prevstate SCOUTGATE=/tmp/tofoin/scoutgate LOGTMP=/tmp/tofoin/logger.tmp LOGMETER=/tmp/tofoin/logmeter DAEMON_PID=/var/run/tofoin/daemon.pid TESTER_PID=/var/run/tofoin SCOUT_PID=/var/run/tofoin/scout.pid JUDGE_PID=/var/run/tofoin/judge.pid LOGGER_PID=/var/run/tofoin/logger.pid WATCHDOG_PID=/var/run/tofoin_watchdog.pid</code> </pre> <br></div></div><br><h3>  Total </h3><br>  It turned out to be quite a workable and reliable set of scripts that copes well with the task of switching to the working channel in the case of 2 routers with 2 external communication channels. <br><br><h3>  Plans </h3><br>  My plans for this project are, perhaps, rewriting from bash to pure sh in order to get rid of the extra software on the server.  On the other hand, now everything works amazingly and I don‚Äôt really want to interfere in this process, besides the transition to sh is fraught with more terrible language constructions necessary to achieve the same result. <br>  For the rest, probably, it would be worthwhile to think about the best implementation of test modules. <br><br><h3>  References: </h3><br>  ‚Üê <a href="https://habr.com/post/241654/">Previous article</a> <br>  ‚Üí <a href="https://gitlab.com/LordNicky/ToFoIn">ToFoIn project page on gitlab</a> <br><div class="spoiler">  <b class="spoiler_title">Rest</b> <div class="spoiler_text">  DNS BIND 9: <br>  <a href="http://www.texnotron.com/bookshelf/1022-albitc-li-dns-and-bind-na-russkom-5-e-izdanie-2008-god.html">Lee K., Albitts P. - DNS and BIND (5th edition)</a> <br>  <a href="http://www.bog.pp.ru/work/bind.html">DNS server BIND</a> <br>  DHCP: <br>  <a href="http://bos.avenue.com.ua/freebsd/failover-dhcp.html">Failover DHCP</a> <br>  <a href="https://wiki.archlinux.org/index.php/Samba_4_Active_Directory_Domain_Controller">DHCP with dynamic DNS updates</a> <br>  <a href="">samba-dnsupdate</a> <br>  SETFIB: <br>  <a href="http://wiki.stocksy.co.uk/wiki/Multiple_default_routes_in_FreeBSD_without_BGP_or_similar">Multiple default routes in FreeBSD without BGP or similar</a> <br>  <a href="http://forum.lissyara.su/viewtopic.php%3Ff%3D8%26t%3D22518">setfib and switching between routing tables</a> <br>  <a href="http://i-rrv.ru/freebsd-%25D0%25B4%25D0%25B2%25D0%25B0-%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25B9%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B0-setfib/">FreeBSD two providers.</a>  <a href="http://i-rrv.ru/freebsd-%25D0%25B4%25D0%25B2%25D0%25B0-%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25B9%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B0-setfib/">setfib</a> <br>  IPFW + NAT: <br>  <a href="http://forum.lissyara.su/viewtopic.php%3Ff%3D4%26t%3D18967%26hilit%3Done_pass%26start%3D725">Detailed guide to ipfw nat</a> <br>  <a href="http://forum.lissyara.su/viewtopic.php%3Ff%3D4%26t%3D40131">FreeBSD 9 + ipfw + ipfw nat</a> <br>  <a href="http://www.lissyara.su/articles/freebsd/tuning/ipfw_nat/">Detailed guide to ipfw nat</a> <br>  <a href="http://ipfw.ism.kiev.ua/dummynet.html">DUMMYNET</a> <br>  <a href="http://alexnettm.org.ua/freebsd-nastroyka-kernel-nat/">Kernel NAT</a> <br>  BASH: <br>  <a href="http://habrahabr.ru/post/52871/">Basics of BASH.</a>  <a href="http://habrahabr.ru/post/52871/">Part 2.</a> <br>  <a href="">Advanced Bash-Scripting Guide</a> <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/421857/">https://habr.com/ru/post/421857/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../421845/index.html">What do data analysts actually do? Findings from 35 interviews</a></li>
<li><a href="../421847/index.html">Jump into the cloud. We build a budget solution for the Internet of things on NodeMCU + Azure IoT Hub</a></li>
<li><a href="../421849/index.html">Events for HR in IT in September 2018: Digest of My Circle</a></li>
<li><a href="../421851/index.html">The problem of the owl and the globe: connecting two assemblies with identical namespaces and class names</a></li>
<li><a href="../421855/index.html">Projectors for the home: the best ‚Äúby version‚Äù, ultra-short focus, champions in brightness and speed</a></li>
<li><a href="../421859/index.html">Notes IoT provider. Devices and outbid</a></li>
<li><a href="../421863/index.html">New way to create nanotubes: now in color</a></li>
<li><a href="../421867/index.html">How to make code readable</a></li>
<li><a href="../421869/index.html">Creating an Android application for the detection of persons in real time using the Firebase ML Kit</a></li>
<li><a href="../421871/index.html">How to miserably fail migration from Java to Kotlin in Android application</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>