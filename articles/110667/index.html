<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Accounting for processor time in the cloud</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After launch, I received a lot of questions about exactly how resources in the cloud are counted. Some intuitively understand what ‚Äúprocessor time‚Äù is...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Accounting for processor time in the cloud</h1><div class="post__text post__text-html js-mediator-article">  After launch, I received a lot of questions about exactly how resources in the cloud are counted.  Some intuitively understand what ‚Äúprocessor time‚Äù is, but there are those who want a detailed explanation.  Since in the general announcement detailed explanations would take a lot of space, I brought it to a separate topic.  At the same time, this format will allow us to describe in more detail how Zen and the virtual machines interact.  The level of this text is popular science, that is, I will not go into the wilds of ring buffers, disguise events, ‚Äúcredit planner‚Äù, etc., instead, I will try to tell you in a human language about how the hypervisor manages the guest machines. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/43b/7e6/362/43b7e63627e70589e5479eb796bde574.png" align="right"><br>  What is "CPU time"?  At first, we wanted to call it more familiar ‚Äúmachine time,‚Äù since such a term was used during mainframe times, when the idea of ‚Äã‚Äãsharing computer time was only born, but stopped in time.  The machine time of those years meant all the resources that were used by the machine, and in our case we are talking about the processor, since each limited resource is taken into account separately. <br><br>  So, what is ‚Äúprocessor time‚Äù and how can it turn out that one virtual machine counts it 4 hours a day, and another winds up 30 ‚Äúhours‚Äù in ten hours? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Selectel Cloud is running the Xen, more precisely, the Xen Cloud Platform, in which Xen acts as the hypervisor. <br><br>  Xen has the concept of a ‚Äúdomain scheduler‚Äù.  Leaving aside the difference between a domain and a virtual machine (a domain is a running virtual machine, when the virtual machine reboots, a new domain is obtained, when the virtual machine is turned off, there is no domain, and the machine itself is), we can assume that this virtual machine scheduler.  Those who are familiar with the work of modern operating systems probably already guessed that the domain scheduler is suspiciously similar to the process scheduler in these most advanced operating systems. <br><br>  How does the virtual machine look like? <br><a name="habracut"></a><br>  An event occurs: a network packet arrives, a timer fires, a reboot signal, etc.  Xen gives the processor a command to start running the virtual machine (more precisely, the domain, but within this explanation we will consider these concepts equivalent).  The kernel of the virtual machine handles the event that caused it to be woken up.  If necessary, it invokes user processes.  Processes do their work and tell the kernel "everything is finished."  The kernel deals with its questions and also says to the hypervisor (Xen) - ‚Äúthat's it, I'm done.‚Äù  After that, Xen <em>stops the</em> execution of the machine.  She simply does nothing in the literal sense of the word.  The car remains in this state until a new event occurs. <br><br>  In modern machines, these events occur at a tremendous speed - for example, if you download a file at a speed of 5 Mb / s, then this (with a packet size of 1500 bytes) is more than 3000 packets per second.  Each packet is a separate interruption (more precisely, in Xen, everything is smarter, there are several calls merged into one, so sometimes the virtual machine is a little faster than even on bare hardware).  And every such event is an awakening of the machine.  But the speed of modern processors is such that after each such call, the core of the virtual machine and the processes (for example, Apache or nginx) have time to work out and fall asleep.  The 5Mb / s statics return is a very low load, about 1-2% of one processor core, so, despite the fact that events occur at an interval of 300 microseconds, the virtual machine runs for 3-6 microseconds and the remaining 294- 296 microseconds have time to tell the hypervisor "I am everything" and fall asleep.  And after a microsecond, wake up again, work out and fall asleep again.  So it turns out that the virtual machine just sleeps most of the time. <br><br>  These are precisely the moments of time when the virtual machine is running and is ‚ÄúCPU time.‚Äù <br><br>  A thoughtful reader may ask - what if the virtual machine doesn‚Äôt say "I am everything"?  If we had Windows 3.11, where there was <em>cooperative multitasking</em> , then this would lead to the fact that the rest would not have received their due time.  But in Xen, <em>preemptive multitasking</em> is used ‚Äî and a virtual machine that works too greedily will simply be suspended.  Forcibly.  And then continued again. <br><br>  Typically, this situation occurs in a shortage of processor time, and the Xen authors have spent thousands of hours developing fair planners who, in conditions of processor overload, solve the problem of allocating time so that everyone continues to work more or less evenly. <br><br>  However, in real conditions of modern hosting, the speed of the processor is so high that the processor is the least demanded and most idle resource and in 99% of cases there is no competition for resources at all. <br><br>  CPU time is the time during which the virtual machine is running.  If she worked 2s per hour, then it is.  40 minutes means forty minutes.  CPU time has nothing to do with "real" time on the clock.  Since Xen is commanding virtual machines, Xen knows how long each machine has worked for up to a nanosecond.  We round this value to microseconds (to avoid problems with int64), and only whole seconds are fixed in the billing (the fractional part is accumulated until it runs for a second).  Money for processor time is written off as soon as it runs at least 1 kopeck (currently 36 seconds).  For comparison, a virtual machine load eats up about 3-6 seconds of computer time, and this is the most ‚Äúexpensive‚Äù operation in the domain life cycle. <br><br>  Another important detail is multiprocessing.  Multiple processor cores are actually independent processors.  And they can work in parallel.  Suppose we give 5 MB / s to several users.  At some point in time, we have to send a new packet before we sent the old one (for example, it took an interval of 0.5 microseconds).  If we had one processor, this request would be in the queue and was processed after the first one.  But if there are several processors, the request will be processed by the first free core, regardless of those already occupied. <br><br>  If the load is high, it turns out that several processors are working simultaneously.  In this case, each of them works, and the processor time is summed up.  Two simultaneously loaded cores - 2s computer time per second.  Eight means eight.  Although in reality it usually turns out that several cores are occupied, but not completely, that is, at some point 2 cores are working, at some 3, and at some point none of them.  So it is quite possible to see 10 minutes of processor time per hour on an 8-nuclear machine serving tens of thousands of customers. <br><br>  If the machine load is less than 100% (that is, it consumes less than an hour of processor time per hour), then, formally, it would be possible to limit one core. <br><br>  But, remember what I said above about simultaneous customer service?  Several cores provide greater ‚Äúresponsiveness‚Äù to requests, although perhaps one core would have done well, albeit at the cost of increasing the response time to a request. <br><br>  By the way, this is the answer and one more question: does the number of cores affect the CPU time spent?  The answer is no, if these cores are idle, then processor time is not used.  A large number of cores only reduces the delay in servicing simultaneous requests from multiple clients. <br><img src="https://habrastorage.org/getpro/habr/post_images/f5c/418/3ce/f5c4183ce1e1e4ef34702e9d3af0bdb3.png" align="right"><br>  Well, after a little about how to understand the concept of "gives time", "allocates time."  The processor is a piece of silicon silicon and stupid.  All the processor can do is execute the code (well, respond to interrupts).  And the processor doesn't really understand the ‚Äúvirtual machine domain‚Äù this, or a running copy of angry birds.  Thus, the concept of ‚Äúdomain‚Äù, ‚Äúhypervisor‚Äù is in a sense of convention.  When we say ‚Äúthe virtual machine was working 10 ms‚Äù, we actually mean the phrase ‚Äúthe processor executed the virtual machine code 10 ms‚Äù.  When we say "the hypervisor supplanted the virtual machine," we actually mean "by interrupting the timer, the processor updated the time counter, saved the process context and transferred control to another place other than where the timer interrupted it."  Such a translation of an object (code) into a subject that has the ability to act greatly simplifies the explanation - each program has an behavior algorithm, and it is easier to say that ‚Äúthe program behaves this way‚Äù instead of saying ‚Äúprocessor, executing the program, does this and that. ‚Äù <br><br>  Now a little about how much he eats.  At the beginning of the article there is a schedule of a very busy server that holds an asterisk with calls from the whole company, a web server, collecting statistics from routers, etc.  Below is a website with approximately 5,000 unique visitors per day.  This is to the question of whether modern server applications are heavily used by the processor (cyan on the charts is an idle processor). </div><p>Source: <a href="https://habr.com/ru/post/110667/">https://habr.com/ru/post/110667/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../110656/index.html">HTC and Samsung are not among the ten most popular mobiles, according to the Norwegian company</a></li>
<li><a href="../110657/index.html">Gigapixel panoramas of Yekaterinburg</a></li>
<li><a href="../110663/index.html">Video from HighLoad ++: Peter Zaitsev - Diagnosing and fixing MySQL performance problems</a></li>
<li><a href="../110665/index.html">Pritchi.ru -</a></li>
<li><a href="../110666/index.html">Pixel Qi has found a display manufacturer.</a></li>
<li><a href="../110668/index.html">Online - learning programming in Ruby without habraeffekt</a></li>
<li><a href="../110673/index.html">Matte ASUS EeePC 1015PEM</a></li>
<li><a href="../110675/index.html">CouchApp: JavaScript applications in CouchDB</a></li>
<li><a href="../110676/index.html">Why does ReactOS need Symantec?</a></li>
<li><a href="../110677/index.html">Clip2net vs Jing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>