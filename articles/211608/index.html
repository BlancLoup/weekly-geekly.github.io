<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work with usb video camera in Linux. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="By popularity, the video camera, today, is on a par with a microphone and headphones. It is used in various directions, such as object recognition, au...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work with usb video camera in Linux. Part 1</h1><div class="post__text post__text-html js-mediator-article">  By popularity, the video camera, today, is on a par with a microphone and headphones.  It is used in various directions, such as object recognition, augmented reality, video conferencing, and many others.  But what is hidden under the hood of these complex programs?  How do we get the picture from the camcorder?  This series of articles will allow you to look at the ease of working with a video camera at a low level, processing the resulting image. <br><a name="habracut"></a><br>  First, some information about working with devices on a Linux system.  Devices in nix systems are a file.  With some device files, we can work as with ordinary files.  For example: <br><br><pre><code class="bash hljs">~$ cat /dev/sda</code> </pre>  <sup><i>this command will display the entire sda ‚Äã‚Äãdisk.</i></sup> <br><br>  There are devices with which you can not work directly, they include a video camera. When we try to do this, we will get the following system response: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="bash hljs">~$ cat: /dev/video0:  </code> </pre>  <sup><i>* Where / dev / video0 is the best camcorder file device.</i></sup> <br><br>  To work with it, we need the ioctl system function. You can read more about it <a href="https://habr.com/ru/post/211608/">[1]</a> .  Let's try to apply it.  Here is the code that allows you to read information from the device (alternative to the cat command for video devices): <br><br><div class="spoiler">  <b class="spoiler_title">Code here</b> <div class="spoiler_text"><pre> <code class="hljs go">#include &lt;fcntl.h&gt; #include &lt;errno.h&gt; #include &lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.h&gt; #include &lt;stdlib.h&gt; #include &lt;stdio.h&gt; #include &lt;linux/videodev2.h&gt; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> main (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> argc,char* argv[]) { <span class="hljs-comment"><span class="hljs-comment">/*Read Params*/</span></span> char *device_name; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(argc &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) {  device_name = argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {  device_name = <span class="hljs-string"><span class="hljs-string">"/dev/video0"</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*Open Device*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> file_device = open(device_name, O_RDWR, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file_device == <span class="hljs-number"><span class="hljs-number">-1</span></span>) {  printf (<span class="hljs-string"><span class="hljs-string">"%s error %d, %s\n"</span></span>,device_name, errno, strerror(errno));  exit(EXIT_FAILURE); } <span class="hljs-comment"><span class="hljs-comment">/*Read Params From Device*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> v4l2_capability device_params; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ioctl(file_device, VIDIOC_QUERYCAP, &amp;device_params) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) {  printf (<span class="hljs-string"><span class="hljs-string">"\"VIDIOC_QUERYCAP\" error %d, %s\n"</span></span>, errno, strerror(errno));  exit(EXIT_FAILURE); } printf(<span class="hljs-string"><span class="hljs-string">"driver : %s\n"</span></span>,device_params.driver); printf(<span class="hljs-string"><span class="hljs-string">"card : %s\n"</span></span>,device_params.card); printf(<span class="hljs-string"><span class="hljs-string">"bus_info : %s\n"</span></span>,device_params.bus_info); printf(<span class="hljs-string"><span class="hljs-string">"version : %d.%d.%d\n"</span></span>,     ((device_params.version &gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>),     ((device_params.version &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>),     (device_params.version &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>)); printf(<span class="hljs-string"><span class="hljs-string">"capabilities: 0x%08x\n"</span></span>, device_params.capabilities); printf(<span class="hljs-string"><span class="hljs-string">"device capabilities: 0x%08x\n"</span></span>, device_params.device_caps); <span class="hljs-comment"><span class="hljs-comment">/* Close Device */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-number"><span class="hljs-number">-1</span></span> == <span class="hljs-built_in"><span class="hljs-built_in">close</span></span> (file_device)) {  printf (<span class="hljs-string"><span class="hljs-string">"\"close\" error %d, %s\n"</span></span>, errno, strerror(errno));  exit(EXIT_FAILURE); } file_device = <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br><br></div></div><br><br>  The first lines of code read the parameters from which the application is running.  If there are no parameters, then device_name takes the standard value "/ dev / video0". <br><br>  In the ‚ÄúOpen Device‚Äù block, the device is opened by the system function open (you need to connect header fcntl.h).  The required parameter O_RDWR is responsible for opening the reader / writer.  If an error occurs during the connection, the open function returns -1. <br><br>  The ‚ÄúRead Params From Device‚Äù block is the heart of our little program.  To use it you need to connect bilioteka <pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">linux</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">videodev2.h</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre>  <sup>you may have to install it, each distribution has its own package for this library</sup> <br>  The <i>ioctl</i> system function has three parameters: <br>  file_device - our device handle <br>  VIDIOC_QUERYCAP is the kernel function that we use for our device. <br>  device_params - the memory area where the result of the function ‚ÄúVIDIOC_QUERYCAP‚Äù will be reset. <br><br>  device_params is a structure consisting of the following fields: <br><br><pre> <code class="hljs ruby">struct v4l2_capability {  __u8  driver[<span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    -     __u8  card[<span class="hljs-number"><span class="hljs-number">32</span></span>]; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    __u8  bus_info[<span class="hljs-number"><span class="hljs-number">32</span></span>]; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      (   usb-)  __u32 version; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     __u32 capabilities; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> (/)    __u32 device_caps; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      __u32 reserved[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   };</code> </pre><br>  if an error occurs ioctl returns -1 <br><br>  The ‚ÄúClose Device‚Äù block closes the device descriptor. <br><br>  Let's see the program in action. <br><br>  compile <br><pre> <code class="bash hljs">gcc catvd.c -o catdv</code> </pre> <br><br>  run <br><pre> <code class="bash hljs">./catvd /dev/video0 /dev/video0 error 2, No such file or directory</code> </pre> <br>  the device was not detected by the kernel or the <s>cleaning lady was</s> not connected <s>again, unplugged the wires again</s> . <br>  Connect and re-launch.  We get the following information: <br><pre> <code class="bash hljs">./catvd /dev/video0 driver : uvcvideo card : UVC Camera (046d:0804) bus_info : usb-0000:00:12.2-3 version : 3.11.10 capabilities: 0x84000001 device capabilities: 0x04000001</code> </pre><br><br>  The capabilities and device capabilities can be decrypted using the constants from the videodev2.h file: <br><a name="capabilities"></a><br><pre> <code class="hljs ruby">V4L2_CAP_DEVICE_CAPS <span class="hljs-number"><span class="hljs-number">0x80000000</span></span> /<span class="hljs-regexp"><span class="hljs-regexp">/      . V4L2_CAP_STREAMING 0x04000000 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    i/o</span></span> ioctls. V4L2_CAP_VIDEO_CAPTURE <span class="hljs-number"><span class="hljs-number">0x00000001</span></span> /<span class="hljs-regexp"><span class="hljs-regexp">/    .</span></span></code> </pre><br><br>  This introductory article ends.  The following reviews will cover topics such as memory-mapping, image video deformats, camera setup, image output to texture, work with several cameras. <br><br>  Resources used in the article: <br><br><ol><li><a name="1"></a>  <a href="http://rus-linux.net/MyLDP/BOOKS/lkmpg-1/node18.htm">ioctl article</a> </li><li><a name="2"></a>  <a href="http://pages.cpsc.ucalgary.ca/~sayles/VFL_HowTo/">about working with video for linux (slightly outdated information)</a> </li></ol><br>  <a href="https://github.com/rsv91/v4linux_lessons/tree/master/lesson1">Source of the program used in the article</a> . </div><p>Source: <a href="https://habr.com/ru/post/211608/">https://habr.com/ru/post/211608/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211584/index.html">Dr.Web for licensed content</a></li>
<li><a href="../211588/index.html">Live webcast ALM Summit</a></li>
<li><a href="../211590/index.html">Repeatable, another way to render lists</a></li>
<li><a href="../211594/index.html">Toothpick-detective reveals the secret of the radio protocol</a></li>
<li><a href="../211606/index.html">Downloading Phonebooks to Polycom IP Phones</a></li>
<li><a href="../211610/index.html">Neural networks, "bad" tips</a></li>
<li><a href="../211612/index.html">‚ÄúFont-weight: bolder‚Äù for fonts with a variety of styles</a></li>
<li><a href="../211614/index.html">Games under threat</a></li>
<li><a href="../211618/index.html">Algorithm and tactics of finding words in the game Balda</a></li>
<li><a href="../211622/index.html">Video review tablet Acer Iconia A3-A11</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>