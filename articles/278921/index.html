<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SQL engine for generating reports. Solution Draft</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 In the first article ( Engine for building reports on SQL. Idea ) I shared the idea. Now I will share the solution (draft). This draft ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SQL engine for generating reports. Solution Draft</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  In the first article ( <a href="https://habrahabr.ru/post/278595/">Engine for building reports on SQL. Idea</a> ) I shared the idea.  Now I will share the solution (draft).  This draft is my first experience of ‚Äúserious‚Äù work with <b>T-SQL</b> , so you should not take it as a sample of ‚Äúgood‚Äù code. <br>  The most important thing in this draft is the mechanism for substituting formulas into a dynamic query.  The second most important is the mechanism for storing the results of calculations. <br><a name="habracut"></a><br>  When I got to work, I expected great difficulties, but in fact everything turned out to be very simple.  A lot of scribbling and just a couple of moments when I had to stop and think.  The first moment is the generation of the line number in the query output, the second is the generation of the value for the key field. <br>  Eyes to be afraid - hands do! <br>  I will begin at once from the most basic and interesting, for those to whom this is not enough - a thorough analysis of logic will be below.  Let's get started <br><br><h4>  Formula Calculation </h4><br><br><h5>  Difference between Columns and Partitions </h5><br>  There is a significant difference between the calculation of the formula for filling the column and the calculation of the formula for filling the fields of the section (header or basement).  This difference is that the column is calculated for each row separately, and the section is calculated once for all rows at once. <br>  Formulas for caps are always aggregate functions and the result of calculating the formula must be ‚Äúpasted‚Äù into the ‚Äúfootprint‚Äù of the template. <br>  The calculated value for the column must be "zabindit" (linked) with the row for which this column was calculated. <br>  Therefore, different templates have been developed for the calculation of the column and header. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Section Template </h5><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @sql_text = N<span class="hljs-string"><span class="hljs-string">' SELECT @result = '</span></span> + @formula + N<span class="hljs-string"><span class="hljs-string">' FROM table '</span></span></code> </pre> <br>  Everything is linear: <br><ul><li>  calculated the formula; </li><li>  the result is framed in the template; </li><li>  that turned out saved in the appropriate table ( <b>report_region_instances</b> ); </li><li>  end - cap formed; </li></ul><br><br><h5>  Column Template </h5><br>  With columns more complicated.  If the result of calculating the header is one value, then the result of calculating the column is the set of values, that is, it is a table consisting of one column and a certain number of rows. <br>  In order to display all the rows of columns during the output of the report, it was necessary to synchronize with each other, when saving the result (to the table <b>report_cell_instances</b> ), each row should be numbered. <br>  To do this, it is necessary to sort the lines in some uniform way - sort.  Add the phrase " <b>ORDER BY</b> " to the query for column calculation, add " <b>ROW_NUMBER () OVER (ORDER BY)</b> " to " <b>SELECT</b> ". <br>  Request Template: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @sql_text = N<span class="hljs-string"><span class="hljs-string">' SELECT ROW_NUMBER() OVER( ORDER BY key_column) ,'</span></span> + @formula + N<span class="hljs-string"><span class="hljs-string">' FROM table ORDER BY key_column'</span></span></code> </pre><br>  Not difficult.  The next interesting point is the preservation of calculations - the results of our work. <br><br><h4>  Save the result. </h4><br>  With the preservation of the section (headings or basement), there are no difficulties - the banal " <b>INSERT</b> " which is necessary where necessary (to the table <b>report_region_instances</b> ). <br>  With the preservation of the computed column is also not that difficult, it is necessary to add our dynamic query with the operator " <b>INSERT</b> ". <br>  The problem is only in the generation of the value of the unique key field.  There is an excellent solution to this problem using an auto-increment column ( <b>IDENTITY</b> property), but I like to have maximum control over what my program does, so I used another tool - " <b>SEQUENCE</b> " - and generate each number manually. <br>  Request Template: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @sql_text = N<span class="hljs-string"><span class="hljs-string">' INSERT INTO report_cell_instances ( id , row_order , value ) SELECT (NEXT VALUE FOR [dbo].[report_cell_instances_sequence] OVER( '</span></span> + @C_ORDER_BY + N<span class="hljs-string"><span class="hljs-string">' ) ) AS Record_Id , ROW_NUMBER() OVER( '</span></span> + @C_ORDER_BY + N<span class="hljs-string"><span class="hljs-string">' ) AS Row_Order , '</span></span> + @formula + N<span class="hljs-string"><span class="hljs-string">' AS Formula_Result FROM table'</span></span> + @C_ORDER_BY</code> </pre><br><br><h4>  Thorough analysis of implementation </h4><br>  The implementation is in the form of a <b>T-SQL</b> script, in a working implementation it must be a stored procedure, the composition of the input parameters is questionable ‚Äî it depends on the needs of the customer.  In my script it is: <br><ol><li>  customer - randomly selected from the consumer_reference table </li><li>  station number - randomly selected from the meteo_stations_reference table, </li><li>  date period - two random dates are selected from the meteo_measurements table for the selected station </li></ol><br>  Other things that should be at least constants made in the style of "hard code" aka "magic number", consider this a cost of "draft". <br>  I wrote the code in <b>dbForge Studio</b> , this IDE has the best source formatter (this is the only plus of this IDE), but I don‚Äôt have it configured, so the formatting was done manually, and only where I remembered about it. <br>  Out of habit for <b>C #</b> and <b>PL / SQ</b> L, each sentence ends with a ";". <br>  Read the rest in the comments to the code (quite obvious things have no comment, I'm sorry I'm not quite boring): <br><div class="spoiler">  <b class="spoiler_title">script with detailed comments</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  ,        ,           */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @C_ORDER_BY <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = <span class="hljs-string"><span class="hljs-string">' ORDER BY mm.meteo_station_id , mm.read_timestamp '</span></span> ; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @C_COLUMN_FORMULA_INSERT <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">' INSERT INTO report_cell_instances (id ,instance_id ,consumer_id ,column_id ,row_order ,value) '</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*      ,            report_cell_instances */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @C_COLUMN_FORMULA_SELECT <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">' SELECT (NEXT VALUE FOR [dbo].[report_cell_instances_sequence] OVER( '</span></span> + @C_ORDER_BY + N<span class="hljs-string"><span class="hljs-string">' ) ) AS RecordId , @Instance_Id AS InstanceId , @Consumer_Id AS ConsumerId , @Column_Id AS ColumnId , ROW_NUMBER() OVER( '</span></span> + @C_ORDER_BY + N<span class="hljs-string"><span class="hljs-string">' ) AS Row_Order , '</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @C_COLUMN_FORMULA_FROM <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = N<span class="hljs-string"><span class="hljs-string">' FROM meteo_measurements mm WHERE mm.meteo_station_id = @Station_Id AND mm.read_timestamp BETWEEN @FromDate AND @ThruDate '</span></span> + @C_ORDER_BY ; <span class="hljs-comment"><span class="hljs-comment">/*       @Station_Id -    @FromDate -       @ThruDate -       @Column_Id -       @Instance_Id -     @Consumer_Id -    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ColumnFormulaParams <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ColumnFormulaParams = N<span class="hljs-string"><span class="hljs-string">' @Station_Id bigint , '</span></span> + N<span class="hljs-string"><span class="hljs-string">' @FromDate datetimeoffset(7) , '</span></span> + N<span class="hljs-string"><span class="hljs-string">' @ThruDate datetimeoffset(7) , '</span></span> + N<span class="hljs-string"><span class="hljs-string">' @Column_Id INT , '</span></span> + N<span class="hljs-string"><span class="hljs-string">' @Instance_Id INT , '</span></span> + N<span class="hljs-string"><span class="hljs-string">' @Consumer_Id INT '</span></span> ; <span class="hljs-comment"><span class="hljs-comment">/*        ,     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @Station <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1</span></span> @Station = sr.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> meteo_stations_reference sr <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> NEWID(); <span class="hljs-comment"><span class="hljs-comment">/*     ,     "PRINT"     */</span></span> PRINT N' @Staton = ' + CAST ( @Station AS NVARCHAR ) ; <span class="hljs-comment"><span class="hljs-comment">/*      , @From -   @Thru -   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">From</span></span> DATETIMEOFFSET(<span class="hljs-number"><span class="hljs-number">7</span></span>) ; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @Thru DATETIMEOFFSET(<span class="hljs-number"><span class="hljs-number">7</span></span>) ; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">From</span></span> = mm.read_timestamp <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> meteo_measurements mm <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> NEWID(); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1</span></span> @Thru = mm.read_timestamp <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> meteo_measurements mm <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> NEWID(); <span class="hljs-comment"><span class="hljs-comment">/*  ""    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @SwapVariable DATETIMEOFFSET(<span class="hljs-number"><span class="hljs-number">7</span></span>) ; IF ( @From &gt; @Thru ) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @SwapVariable = @Thru; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @Thru = @<span class="hljs-keyword"><span class="hljs-keyword">From</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">From</span></span> = @SwapVariable ; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; PRINT N' @From = ' + CAST ( @From AS NVARCHAR )+ N' @Thru = ' + CAST ( @Thru AS NVARCHAR ); <span class="hljs-comment"><span class="hljs-comment">/*    ,     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">Instance</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">Instance</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">NEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [dbo].[report_instances_sequence] ; <span class="hljs-comment"><span class="hljs-comment">/*    ,    1 - "" */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> report_instances ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> , description , state_id ) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (@<span class="hljs-keyword"><span class="hljs-keyword">Instance</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">Instance</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span> ),<span class="hljs-string"><span class="hljs-string">' DEBUG '</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> ) ; <span class="hljs-comment"><span class="hljs-comment">/* ,      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ConsumerId <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1</span></span> @ConsumerId = cr.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> consumer_reference cr <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> NEWID(); PRINT N' @ConsumerId = ' + CAST ( @ConsumerId AS NVARCHAR ) ; <span class="hljs-comment"><span class="hljs-comment">/*         T-SQL       (      ).        ,          .          T-SQL       . T-SQL     (      ),      ,   .         ,         .                 .         -   .        .   -    ,     1000,         .        ,        . */</span></span> <span class="hljs-comment"><span class="hljs-comment">-- CREATE TABLE #consumers_report_columns( -- column_id int ) -- -- INSERT INTO #consumers_report_columns ( column_id ) -- SELECT -- rc.column_id -- FROM -- consumers_report_columns rc -- WHERE -- rc.consumer_id = @ConsumerId -- ; /*      */ DECLARE @consumers_report_columns TABLE ( column_id INT ) INSERT INTO @consumers_report_columns (column_id) SELECT rc.column_id FROM consumers_report_columns rc WHERE rc.consumer_id = @ConsumerId ; /* -=* CYCLE BEGIN *=- */ -- DECLARE consumers_report_columns_cursor CURSOR FOR -- SELECT -- rc.column_id -- FROM -- #consumers_report_columns rc -- ; /*         */ DECLARE consumers_report_columns_cursor CURSOR FOR SELECT rc.column_id FROM @consumers_report_columns rc ; /*      */ DECLARE @ColumnId INT ; OPEN consumers_report_columns_cursor ; FETCH NEXT FROM consumers_report_columns_cursor INTO @ColumnId WHILE @@FETCH_STATUS = 0 BEGIN PRINT N' @ColumnId = ' + CAST ( @ColumnId AS NVARCHAR ) ; /*              ,           ,      . */ /*  ""       */ DECLARE @FormulaId INT; SELECT @FormulaId = cl.formula_id FROM columns cl WHERE cl.id = @ColumnId ; PRINT N' @FormulaId = ' + CAST ( @FormulaId AS NVARCHAR ) ; /*       */ DECLARE @formula NVARCHAR(MAX); SELECT @formula = fm.formula FROM formulas fm WHERE fm.id = @FormulaId ; PRINT N' @formula = ' + @formula ; /*       ,          */ DECLARE @column_formula_phrase NVARCHAR(MAX); SET @column_formula_phrase = @C_COLUMN_FORMULA_SELECT + @formula + @C_COLUMN_FORMULA_FROM ; PRINT N' @column_formula_phrase = ' + @column_formula_phrase ; /*  ,       */ DECLARE @column_formula_sql NVARCHAR(MAX); SET @column_formula_sql = @column_formula_phrase ; /*         ,  ,     ,      */ EXEC sp_executesql @column_formula_sql , @ColumnFormulaParams , @Station_Id = @Station , @FromDate = @From , @ThruDate = @Thru , @Column_Id = @ColumnId , @Instance_Id = @Instance , @Consumer_Id = @ConsumerId /*            report_cell_instances */ SET @column_formula_phrase = @C_COLUMN_FORMULA_INSERT + @C_COLUMN_FORMULA_SELECT + @formula + @C_COLUMN_FORMULA_FROM ; PRINT N' @column_formula_phrase = ' + @column_formula_phrase ; /*        */ SET @column_formula_sql = @column_formula_phrase ; EXEC sp_executesql @column_formula_sql , @ColumnFormulaParams , @Station_Id = @Station , @FromDate = @From , @ThruDate = @Thru , @Column_Id = @ColumnId , @Instance_Id = @Instance , @Consumer_Id = @ConsumerId FETCH NEXT FROM consumers_report_columns_cursor INTO @ColumnId END CLOSE consumers_report_columns_cursor; /*    "DEALLOCATE"   */ DEALLOCATE consumers_report_columns_cursor; /* -=* CYCLE END *=- */ /*    */ -- DROP TABLE #consumers_report_columns DELETE @consumers_report_columns ; /*    */ /*      */ DECLARE @consumers_report_regions TABLE ( region_id INT ) INSERT INTO @consumers_report_regions (region_id) SELECT rr.region_id FROM consumers_report_regions rr WHERE rr.consumer_id = @ConsumerId ; /*         */ DECLARE consumers_report_regions_cursor CURSOR FOR SELECT rr.region_id FROM @consumers_report_regions rr ; /*       */ DECLARE @C_REGION_FORMULA_SELECT NVARCHAR(MAX) = N' SELECT @Result = ' ; /*        */ DECLARE @C_REGION_FORMULA_FROM NVARCHAR(MAX) = N' FROM meteo_measurements mm WHERE mm.meteo_station_id = @Station_Id AND mm.read_timestamp BETWEEN @FromDate AND @ThruDate '; /*       @Station_Id -       @FromDate -      @ThruDate -      @Result -    */ DECLARE @C_REGION_FORMULA_PARAMS NVARCHAR(MAX) = N' @Station_Id bigint , ' + N' @FromDate datetimeoffset(7) , ' + N' @ThruDate datetimeoffset(7) , ' + N' @Result NVARCHAR(MAX) OUT ' ; /*     */ DECLARE @RegionId INT ; OPEN consumers_report_regions_cursor ; FETCH NEXT FROM consumers_report_regions_cursor INTO @RegionId WHILE @@FETCH_STATUS = 0 BEGIN PRINT N' @RegionId = ' + CAST ( @RegionId AS NVARCHAR ) ; /*    */ DECLARE @Pattern NVARCHAR(MAX) ; SELECT @Pattern = rg.pattern FROM regions rg WHERE rg.id = @RegionId ; PRINT N' @Pattern = ' + @Pattern ; /*  .         */ DECLARE @region_formulas_and_placeholders TABLE ( formula NVARCHAR(MAX) , placeholder NVARCHAR(MAX) ) /*       */ INSERT INTO @region_formulas_and_placeholders ( formula , placeholder ) SELECT fr.formula , rf.placeholder -- , rg.pattern FROM regions rg JOIN region_formulas rf ON rg.id = rf.region_id JOIN formulas fr ON rf.formula_id = fr.id WHERE rg.id = @RegionId ; /*          */ DECLARE region_formulas_and_placeholders_cursor CURSOR FOR SELECT fp.formula , fp.placeholder FROM @region_formulas_and_placeholders fp ; /*      */ DECLARE @region_formula NVARCHAR(MAX); /*       .        */ DECLARE @placeholder NVARCHAR(MAX); OPEN region_formulas_and_placeholders_cursor ; FETCH NEXT FROM region_formulas_and_placeholders_cursor INTO @region_formula , @placeholder WHILE @@FETCH_STATUS = 0 BEGIN PRINT N' @region_formula = ' + @region_formula + N' @placeholder = ' + @placeholder; /*         */ DECLARE @region_formula_phrase NVARCHAR(MAX) ; SET @region_formula_phrase = @C_REGION_FORMULA_SELECT + @region_formula + @C_REGION_FORMULA_FROM ; PRINT N' @region_formula_phrase = ' + @region_formula_phrase ; DECLARE @region_formula_sql NVARCHAR(MAX) ; SET @region_formula_sql = @region_formula_phrase ; /*                 */ DECLARE @Substitute NVARCHAR(MAX) ; /*      ,    @Substitute */ EXEC sp_executesql @region_formula_sql , @C_REGION_FORMULA_PARAMS , @Station_Id = @Station , @FromDate = @From , @ThruDate = @Thru , @Result = @Substitute OUT ; PRINT N' @Substitute = ' + @Substitute ; /*       */ SET @Pattern = REPLACE ( @Pattern , @placeholder , @Substitute ) ; FETCH NEXT FROM region_formulas_and_placeholders_cursor INTO @region_formula , @placeholder END CLOSE region_formulas_and_placeholders_cursor; DEALLOCATE region_formulas_and_placeholders_cursor; /*       */ DELETE @region_formulas_and_placeholders ; PRINT N' FINISH @Pattern ' + @Pattern ; /*      report_region_instances */ INSERT INTO report_region_instances ( instace_id ,consumer_id ,region_id ,value ) VALUES( @Instance , @ConsumerId , @RegionId , @Pattern ) ; FETCH NEXT FROM consumers_report_regions_cursor INTO @RegionId END CLOSE consumers_report_regions_cursor; DEALLOCATE consumers_report_regions_cursor; /*    -    */ DELETE @consumers_report_regions ; /*     .      -   :) */ END;</span></span></code> </pre><br></div></div><br><br><h4>  Testing the solution </h4><br>  Testing was superficial, the behavior of the script in case of errors in the data was not checked. <br><br><h5>  Test data set </h5><br>  To generate a test suite, I used the <b>dbForge Studio</b> generator. <br>  In the <b>meteo_measurements</b> table, the type for the <b>read_timestamp</b> column had to be changed from " <b>timestamp</b> " to " <b>datetimeoffset</b> (7)", because the value with the type " <b>timestamp</b> " can only be created by the server, disabled manually, and the dataset generation is done manually in mode - a script with specifically prescribed operators "INSERT". <br>  In addition, the value for the ‚Äúmeteo_station_id‚Äù column had to be substituted by hands, in the sense of finishing the generated script: <br><ol><li>  replace ‚Äúmeasurements (read_timestamp,‚Äù with ‚Äúmeasurements (meteo_station_id, read_timestamp,‚Äù </li><li>  replace <b>"</b> wind_speed) VALUES (' <b>"</b> with <b>"</b> wind_speed) VALUES ((SELECT TOP 1 id FROM meteo_stations_reference ORDER BY NEWID ()),' <b>"</b> </li></ol><br>  The test suite had to be limited to 15,000 entries, while generating a script for more than 16,000, the line breaks were lost. <br><h5>  Tables with settings </h5><br>  In addition, for testing, records were added to other tables.  A pair of unique indexes was changed, and I don‚Äôt remember which indexes it is, so I‚Äôll just repeat all the main tables. <br>  DDL table creation scripts and DML data insertion scripts are on <b>GitHub</b> . <br><div class="spoiler">  <b class="spoiler_title">DDL tables and DML with data insertion</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> Linegro.dbo.meteo_stations_reference ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,description <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_meteo_stations_reference PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> UK_meteo_stations_reference_name <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] TEXTIMAGE_ON [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> DATEFORMAT ymd <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ARITHABORT, ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER, ANSI_NULLS, NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NUMERIC_ROUNDABORT, IMPLICIT_TRANSACTIONS, XACT_ABORT <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.meteo_stations_reference(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>, N<span class="hljs-string"><span class="hljs-string">' ""'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.meteo_stations_reference(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>, N<span class="hljs-string"><span class="hljs-string">'   '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.meteo_stations_reference(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>, N<span class="hljs-string"><span class="hljs-string">' '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.meteo_stations_reference(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>, N<span class="hljs-string"><span class="hljs-string">'  '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.meteo_stations_reference(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>, N<span class="hljs-string"><span class="hljs-string">'   - '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> Linegro.dbo.meteo_measurements ( meteo_station_id <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,read_timestamp DATETIMEOFFSET <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,temperature <span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,pressure <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,wind_direction <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,wind_speed <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_meteo_measurements PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (meteo_station_id, read_timestamp) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_meteo_measurements_meteo_stations_reference_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (meteo_station_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.meteo_stations_reference (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> Linegro.dbo.consumer_reference ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,description <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_consumer_reference PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> UK_consumer_reference_name <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] TEXTIMAGE_ON [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> DATEFORMAT ymd <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ARITHABORT, ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER, ANSI_NULLS, NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NUMERIC_ROUNDABORT, IMPLICIT_TRANSACTIONS, XACT_ABORT <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumer_reference(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, N<span class="hljs-string"><span class="hljs-string">' '</span></span>, N<span class="hljs-string"><span class="hljs-string">'    '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumer_reference(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, N<span class="hljs-string"><span class="hljs-string">' '</span></span>, N<span class="hljs-string"><span class="hljs-string">'   '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumer_reference(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, N<span class="hljs-string"><span class="hljs-string">' 23'</span></span>, N<span class="hljs-string"><span class="hljs-string">'   23'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumer_reference(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>, N<span class="hljs-string"><span class="hljs-string">'426  2016'</span></span>, N<span class="hljs-string"><span class="hljs-string">'  426 ( 2016 )     '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> Linegro.dbo.formulas ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,code <span class="hljs-keyword"><span class="hljs-keyword">NCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,formula <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_formulas PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> UK_formulas_code <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (code) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] TEXTIMAGE_ON [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> DATEFORMAT ymd <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ARITHABORT, ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER, ANSI_NULLS, NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NUMERIC_ROUNDABORT, IMPLICIT_TRANSACTIONS, XACT_ABORT <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.formulas(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, code, formula) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, N<span class="hljs-string"><span class="hljs-string">'temperature'</span></span>, N<span class="hljs-string"><span class="hljs-string">'COALESCE(temperature ,0) AS temperature'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.formulas(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, code, formula) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, N<span class="hljs-string"><span class="hljs-string">'pressure'</span></span>, N<span class="hljs-string"><span class="hljs-string">'COALESCE(pressure,0) AS pressure'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.formulas(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, code, formula) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, N<span class="hljs-string"><span class="hljs-string">'wind_direction'</span></span>, N<span class="hljs-string"><span class="hljs-string">'COALESCE(wind_direction,0) AS wind_direction'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.formulas(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, code, formula) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>, N<span class="hljs-string"><span class="hljs-string">'wind_speed'</span></span>, N<span class="hljs-string"><span class="hljs-string">'wind_speed AS wind_speed'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.formulas(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, code, formula) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span>, N<span class="hljs-string"><span class="hljs-string">'temperature_max'</span></span>, N<span class="hljs-string"><span class="hljs-string">'MAX(COALESCE(temperature,0)) '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.formulas(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, code, formula) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">6</span></span>, N<span class="hljs-string"><span class="hljs-string">'temperature_min'</span></span>, N<span class="hljs-string"><span class="hljs-string">'MIN(COALESCE(temperature,0)) '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.formulas(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, code, formula) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">7</span></span>, N<span class="hljs-string"><span class="hljs-string">'temperature_avg'</span></span>, N<span class="hljs-string"><span class="hljs-string">'AVG(COALESCE(temperature,0)) '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.formulas(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, code, formula) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">8</span></span>, N<span class="hljs-string"><span class="hljs-string">'speed_m_s'</span></span>, N<span class="hljs-string"><span class="hljs-string">'CAST ( COALESCE(wind_speed ,0) AS NVARCHAR ) + N'' ( $M_S$ )'' AS speed_m_s'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> Linegro.dbo.columns ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,formula_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,description <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_columns PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_columns_formulas_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (formula_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.formulas (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] TEXTIMAGE_ON [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> DATEFORMAT ymd <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ARITHABORT, ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER, ANSI_NULLS, NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NUMERIC_ROUNDABORT, IMPLICIT_TRANSACTIONS, XACT_ABORT <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.columns(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, formula_id, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>, N<span class="hljs-string"><span class="hljs-string">'  (   ) '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.columns(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, formula_id, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>, N<span class="hljs-string"><span class="hljs-string">'  (    )'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.columns(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, formula_id, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>, N<span class="hljs-string"><span class="hljs-string">' '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.columns(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, formula_id, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>, N<span class="hljs-string"><span class="hljs-string">'  ( / )'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.columns(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, formula_id, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>, N<span class="hljs-string"><span class="hljs-string">' '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> Linegro.dbo.regions ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,pattern <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,description <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_regions PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> UK_regions_name <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] TEXTIMAGE_ON [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> DATEFORMAT ymd <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ARITHABORT, ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER, ANSI_NULLS, NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NUMERIC_ROUNDABORT, IMPLICIT_TRANSACTIONS, XACT_ABORT <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.regions(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, pattern, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, N<span class="hljs-string"><span class="hljs-string">'max temp = $MAX_TEMP$ , min temp = $MIN_TEMP$ , average temp = $AVG_TEMP$'</span></span>, N<span class="hljs-string"><span class="hljs-string">'temp_statistics'</span></span>, N<span class="hljs-string"><span class="hljs-string">'  '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.regions(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, pattern, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, N<span class="hljs-string"><span class="hljs-string">'  426 ( 2016 )     '</span></span>, N<span class="hljs-string"><span class="hljs-string">'426_2016_title'</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.regions(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, pattern, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, N<span class="hljs-string"><span class="hljs-string">' '</span></span>, N<span class="hljs-string"><span class="hljs-string">'empty'</span></span>, N<span class="hljs-string"><span class="hljs-string">' '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.regions(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, pattern, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>, N<span class="hljs-string"><span class="hljs-string">'   '</span></span>, N<span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.regions(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, pattern, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span>, N<span class="hljs-string"><span class="hljs-string">' '</span></span>, N<span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> Linegro.dbo.consumers_report_columns ( column_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,consumer_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,column_order <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_consumers_report_columns PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (consumer_id, column_id) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> UK_consumers_report_columns_column_order <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (consumer_id, column_order) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_consumers_report_columns_columns_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (column_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.columns (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_consumers_report_columns_consumer_reference_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (consumer_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.consumer_reference (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> DATEFORMAT ymd <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ARITHABORT, ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER, ANSI_NULLS, NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NUMERIC_ROUNDABORT, IMPLICIT_TRANSACTIONS, XACT_ABORT <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumers_report_columns(column_id, consumer_id, column_order) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumers_report_columns(column_id, consumer_id, column_order) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumers_report_columns(column_id, consumer_id, column_order) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumers_report_columns(column_id, consumer_id, column_order) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumers_report_columns(column_id, consumer_id, column_order) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">14</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumers_report_columns(column_id, consumer_id, column_order) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumers_report_columns(column_id, consumer_id, column_order) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumers_report_columns(column_id, consumer_id, column_order) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumers_report_columns(column_id, consumer_id, column_order) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> Linegro.dbo.consumers_report_regions ( consumer_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,region_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,region_order <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,type_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_consumers_report_base PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (consumer_id, region_id) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> UK_consumers_report_regions_region_order <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (consumer_id, region_order) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_consumers_report_regions_consumer_reference_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (consumer_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.consumer_reference (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_consumers_report_regions_regions_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (region_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.regions (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_consumers_report_regions_report_region_types_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (type_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.report_region_types (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> DATEFORMAT ymd <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ARITHABORT, ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER, ANSI_NULLS, NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NUMERIC_ROUNDABORT, IMPLICIT_TRANSACTIONS, XACT_ABORT <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumers_report_regions(consumer_id, region_id, region_order, type_id) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumers_report_regions(consumer_id, region_id, region_order, type_id) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumers_report_regions(consumer_id, region_id, region_order, type_id) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumers_report_regions(consumer_id, region_id, region_order, type_id) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumers_report_regions(consumer_id, region_id, region_order, type_id) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">-100</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumers_report_regions(consumer_id, region_id, region_order, type_id) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.consumers_report_regions(consumer_id, region_id, region_order, type_id) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> Linegro.dbo.region_formulas ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,formula_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,region_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,placeholder <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_region_formulas PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> UK_region_formulas <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (region_id, formula_id) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_region_formulas_formulas_formula_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (formula_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.formulas (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_region_formulas_regions_id <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (region_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> dbo.regions (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> DATEFORMAT ymd <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ARITHABORT, ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER, ANSI_NULLS, NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NUMERIC_ROUNDABORT, IMPLICIT_TRANSACTIONS, XACT_ABORT <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.region_formulas(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, formula_id, region_id, placeholder) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, N<span class="hljs-string"><span class="hljs-string">'$MAX_TEMP$'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.region_formulas(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, formula_id, region_id, placeholder) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, N<span class="hljs-string"><span class="hljs-string">'$MIN_TEMP$'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.region_formulas(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, formula_id, region_id, placeholder) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, N<span class="hljs-string"><span class="hljs-string">'$AVG_TEMP$'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> Linegro.dbo.report_instace_states_reference ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,code <span class="hljs-keyword"><span class="hljs-keyword">NCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,description <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_report_instace_states_reference PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> UK_report_instace_states_reference_code <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (code) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] TEXTIMAGE_ON [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> DATEFORMAT ymd <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ARITHABORT, ANSI_PADDING, ANSI_WARNINGS, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER, ANSI_NULLS, NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NUMERIC_ROUNDABORT, IMPLICIT_TRANSACTIONS, XACT_ABORT <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.report_instace_states_reference(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, code, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.report_instace_states_reference(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, code, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.report_instace_states_reference(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, code, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> Linegro.dbo.report_instace_states_reference(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, code, description) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br></div></div><br>    ¬´¬ª  <b>NVARCHAR</b> (MAX),         ‚Äî       . <br><br><h4>   </h4><br>      <b>formula_parameters</b> ,       . <br><br><h4>  Conclusion </h4><br>      ,             :) <br>     ,     . <br>  Thanks for attention. <br><br><h4>  Links </h4><br><ol><li> <a href="https://habrahabr.ru/post/278595/">     SQL.</a>  <a href="https://habrahabr.ru/post/278595/">Idea</a> </li><li> <a href="https://github.com/SbWereWolf/SqlReportConstructor"> ‚Äî GitHub</a> </li><li> <a href="https://habrahabr.ru/post/220185/">    MS SQL     17  </a> </li><li> <a href="https://www.devart.com/ru/dbforge/sql/studio/download.html">dbForge Studio for SQL Server</a> </li><li> <a href="http://stackoverflow.com/questions/19412/how-to-request-a-random-row-in-sql">How to request a random row in SQL?</a> </li><li> <a href="http://www.sommarskog.se/dynamic_sql.html">The Curse and Blessings of Dynamic SQL</a> </li><li> <a href="http://www.sqlteam.com/article/temporary-tables">Temporary Tables</a>          ,            <a href="http://dba.stackexchange.com/questions/16385/whats-the-difference-between-a-temp-table-and-table-variable-in-sql-server/16386">What's the difference between a temp table and table variable in SQL Server?</a> </li><li> <a href="https://blogs.technet.microsoft.com/dataplatforminsider/2014/01/07/sql-server-2014-in-memory-oltp-memory-optimized-table-types-and-table-variables/">SQL Server 2014 In Memory OLTP: Memory-Optimized Table Types and Table Variables</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/278921/">https://habr.com/ru/post/278921/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278905/index.html">Cloud Digest # 1: Infrastructure, Data Storage and IoT</a></li>
<li><a href="../278907/index.html">Announcement of ThinkJava # 3. Microservices</a></li>
<li><a href="../278909/index.html">Announcement of a free online course DevOps: What, Why, and How</a></li>
<li><a href="../278913/index.html">Product Design Digest February 2016</a></li>
<li><a href="../278915/index.html">Hubsound</a></li>
<li><a href="../278925/index.html">Minor update of SBM version 11.01</a></li>
<li><a href="../278929/index.html">Software-defined data center: why is it necessary in the practice of the sysadmin</a></li>
<li><a href="../278931/index.html">What a programmer should be able to get a job in finance</a></li>
<li><a href="../278933/index.html">Bulletin MS16-023: When a critical Windows security update affects more than just security</a></li>
<li><a href="../278935/index.html">What is new is waiting for us in Laravel 5.2.23</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>