<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Add dependencies to CDI. Part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you follow this blog, remember that lately I have been writing (and talking ) about CDI ( Contexts and Dependency Injection ). CDI has many aspects...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Add dependencies to CDI. Part 3</h1><div class="post__text post__text-html js-mediator-article"><p>  If you follow this blog, remember that lately I have been writing (and <a href="https://antoniogoncalves.org/2011/05/23/to-inject-or-not-to-inject-cdi-is-the-question/">talking</a> ) about CDI ( <a href="http://jcp.org/en/jsr/summary%3Fid%3D299">Contexts and Dependency Injection</a> ).  CDI has many aspects, but so far I have focused on how <a href="https://antoniogoncalves.org/2011/01/12/bootstrapping-cdi-in-several-environments/">to get started with CDI</a> in your environment and how to <a href="https://antoniogoncalves.org/2011/02/07/adding-cdi-to-an-existing-java-ee-6-application/">integrate CDI into an existing Java EE 6 application</a> , and then focused on introducing dependencies into CDI.  This is the third post about the implementation in CDI: in the <a href="https://habrahabr.ru/company/at_consulting/blog/301636/">first one</a> I talked about the default implementation and specifiers, in the <a href="https://habrahabr.ru/company/at_consulting/blog/301768/">second</a> about all possible implementation points (field, constructor, setter).  In this post, I‚Äôll talk about <strong>producers</strong> or " <em>how you can implement anything and any <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B8%25D0%25BF%25D0%25BE%25D0%25B1%25D0%25B5%25D0%25B7%25D0%25BE%25D0%25BF%25D0%25B0%25D1%2581%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C">type of safe</a> way</em> ." </p><br><p><img src="https://habrastorage.org/files/cbb/352/f3f/cbb352f3f8f147c49314e29041a80278.jpg" alt="COFFEE_BEANS"></p><a name="habracut"></a><cut><br><h1>  Implement only bins? </h1><br><p> Before that, I showed you how to implement beans with the usual <code>@Inject</code> annotation.  If you look at the example with the generation of the book number that I <a href="https://habrahabr.ru/company/at_consulting/blog/301636/">used earlier</a> , you will see a servlet and a rest service in which the implementation of the <code>NumberGenerator</code> interface is being implemented.  Thanks to the specifiers, the servlet can get an <code>IsbnGenerator</code> marked at the insertion point with the <code>@ThirteenDigit</code> , and the rest of the service will get the <code>IssnGenerator</code> marked with <code>@EightDigits</code> (see my <a href="https://habrahabr.ru/company/at_consulting/blog/301636/">first</a> post).  The presented class diagram demonstrates some combination of bin injection: </p><br><p><img src="https://habrastorage.org/files/090/598/72d/09059872d64349e6a3bce3c13455ef10.gif" alt="CDI_3_1"></p><br><p>  But as you can see, all this is the <strong>injection of beans into other bins</strong> .  In CDI, can we embed only beans?  Not.  <strong>You can embed anything and anywhere</strong> . </p><br><h1>  Producers </h1><br><p>  Yes, you can embed anything and anywhere.  All you need to do is <em>create something</em> that you want to implement later.  For this, there are <strong>producers</strong> in CDI (an excellent implementation of the <a href="http://en.wikipedia.org/wiki/Factory_method_pattern">Factory</a> pattern).  With their help, you can create: </p><br><ul><li>  Class: unlimited set of bin types, its superclasses, and all interfaces it implements </li><li>  Interface: unlimited set of bean types, expanded interfaces, and also <code>java.lang.Object</code> </li><li>  Primitives and java array </li></ul><br><p>  So you can embed <code>java.util.Date</code> , <code>java.lang.String</code> or even an <code>int</code> .  Start by creating and implementing some data types and primitives. </p><br><h1>  Creating data types and primitive types </h1><br><p>  One example of how <em>to implement anything and anywhere</em> is the introduction of data types and primitives.  Well, let's try to embed <code>String</code> and <code>int</code> .  For this, I need to add additional classes to our model.  Prior to this, the <code>IsbnGenerator</code> created a random number in the format <strong>13-124-454644-4</strong> .  This number consists of a string serving as a prefix ( <strong>13-124</strong> ), and an integer value - a postfix ( <strong>4</strong> ).  The following class diagram shows the two new <code>PrefixGenerator</code> and <code>PostfixGenerator</code> that will be used to generate the number: </p><br><p><img src="https://habrastorage.org/files/356/828/4df/3568284df84049b38aaabba58d931b0b.gif" alt="CDI_3_2"></p><br><p>  If we look, for example, at the <code>PrefixGenerator</code> code, we will see a class that itself is not marked by any specifier, unlike its methods.  The <code>getIsbnPrefix</code> method returns a string that is specified by the <code>@ThirteenDigits</code> annotation.  This string is created using CDI (thanks to <code>@Produces</code> ), which means that you can embed it using <code>@Inject</code> and its specifier ( <code>@ThirteenDigits</code> ). </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PrefixGenerator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span> <span class="hljs-meta"><span class="hljs-meta">@ThirteenDigits</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getIsbnPrefix</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"13-84356"</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span> <span class="hljs-meta"><span class="hljs-meta">@EightDigits</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getIssnPrefix</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"8"</span></span>; } }</code> </pre> <br><p>  Now look closely at the <code>PostfixGenerator</code> class.  This code is similar to the previous one, except that it creates an <code>int</code> , which can then be embedded. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostfixGenerator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span> <span class="hljs-meta"><span class="hljs-meta">@ThirteenDigits</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getIsbnPostfix</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span> <span class="hljs-meta"><span class="hljs-meta">@EightDigits</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getIssnPostfix</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>; } }</code> </pre> <br><p>  And now we will change the logic of generating ISBN numbers.  The <code>IsbnGenerator</code> bin is <code>IsbnGenerator</code> <code>String</code> and <code>int</code> using <code>@Inject</code> and <code>@ThirteenDigits</code> .  Now you understand what <strong>strict typing</strong> in CDI means.  Using this syntax ( <code>@Inject @ThirteenDigits</code> ), CDI knows what to insert into the <code>String</code> place, and what to the int place and which implementation of the <code>NumberGenerator</code> implementation to <code>NumberGenerator</code> . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@ThirteenDigits</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IsbnGenerator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NumberGenerator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-meta"><span class="hljs-meta">@ThirteenDigits</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String prefix; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-meta"><span class="hljs-meta">@ThirteenDigits</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> postfix; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateNumber</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prefix + <span class="hljs-string"><span class="hljs-string">"-"</span></span> + Math.abs(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random().nextInt()) + <span class="hljs-string"><span class="hljs-string">"-"</span></span> + postfix; } }</code> </pre> <br><h1>  Embedding Java EE resources through producer fields </h1><br><p>  So, if CDI can embed anything and anywhere, if it can even embed strings and integers, then what about Java EE resources?  This is another story, and the producers will help us in this.  As I said earlier, everything is <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B8%25D0%25BF%25D0%25BE%25D0%25B1%25D0%25B5%25D0%25B7%25D0%25BE%25D0%25BF%25D0%25B0%25D1%2581%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C">type-safe</a> in CDI, so <strong>there is no way</strong> in CDI <strong>to embed a resource by its JNDI name</strong> , for example, <code>@Inject(name="jms/OrderQueue")</code> .  The standard example is an entity manager.  If you do not use CDI, then in Java EE 6 you can implement it as follows: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Stateless</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ItemEJB</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@PersistenceContext</span></span>(unitName = <span class="hljs-string"><span class="hljs-string">"cdiPU"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> EntityManager em; ... }</code> </pre> <br><p>  So why is it impossible to make an ordinary <code>@Inject</code> for an entity manager?  If you remember my <a href="https://habrahabr.ru/company/at_consulting/blog/301636/">first</a> post about the ambiguity of implementation, then there is the same problem.  You may have several units of persistence (named with a regular string), and if you just write <code>@Inject</code> , then CDI will not be able to figure out which one of them needs to be implemented.  Instead, you should create the entity manager first and <a href="https://docs.jboss.org/cdi/spec/1.2/cdi-spec.html">name</a> it somehow (if you don‚Äôt want to use <code>@Default</code> ): </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DatabaseProducer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span> <span class="hljs-meta"><span class="hljs-meta">@PersistenceContext</span></span>(unitName = <span class="hljs-string"><span class="hljs-string">"cdiPU"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@BookStoreDatabase</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> EntityManager em; }</code> </pre> <br><p>  The <code>DatabaseProducer</code> class uses <code>@PersistenceContext</code> to implement the entity manager with the cdiPU persistence unit.  It will be marked with a specifier ( <code>@BookStoreDatabase</code> ) and initialized, after which you can embed it in an EJB as follows: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Stateless</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ItemEJB</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-meta"><span class="hljs-meta">@BookStoreDatabase</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> EntityManager em; ... }</code> </pre> <br><p>  Another good example is the creation of JMS factories and recipients.  The <code>@Resource</code> allows you to get a JNDI link to a JMS factory or destination, the <code>@Order</code> names it, and <code>@Produces</code> allows you to implement it in the future: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JMSResourceProducer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span> <span class="hljs-meta"><span class="hljs-meta">@Order</span></span> <span class="hljs-meta"><span class="hljs-meta">@Resource</span></span>(name = <span class="hljs-string"><span class="hljs-string">"jms/OrderConnectionFactory"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> QueueConnectionFactory orderConnectionFactory; <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span> <span class="hljs-meta"><span class="hljs-meta">@Order</span></span> <span class="hljs-meta"><span class="hljs-meta">@Resource</span></span>(name = <span class="hljs-string"><span class="hljs-string">"jms/OrderQueue"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Queue orderQueue; }</code> </pre> <br><p>  Now your EJB can use type-safe <code>@Inject</code> : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Stateless</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ItemEJB</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-meta"><span class="hljs-meta">@Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> QueueConnectionFactory orderConnectionFactory; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-meta"><span class="hljs-meta">@Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Queue orderQueue; ... }</code> </pre> <br><h1>  Creating Java EE Resources Using Producer Methods </h1><br><p>  The examples considered are quite simple: we create a field and then we can implement it.  This is called a producing field.  But sometimes you need a more complex business logic to create a bean, and we will call this the producer method.  Let's look at another example.  When you need to send a JMS message, you always embed a JMS factory and destination (a queue or topic), create a connection, then a session, and so on, until you send a message.  Since this code is often repeated and may contain errors, why not put it somewhere in a separate class and create a session with it and other components necessary to send a message?  This class might look like this: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JMSResourceProducer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Resource</span></span>(name = <span class="hljs-string"><span class="hljs-string">"jms/OrderConnectionFactory"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> QueueConnectionFactory orderConnectionFactory; <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span> <span class="hljs-meta"><span class="hljs-meta">@Order</span></span> <span class="hljs-meta"><span class="hljs-meta">@Resource</span></span>(name = <span class="hljs-string"><span class="hljs-string">"jms/OrderQueue"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Queue orderQueue; <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span> <span class="hljs-meta"><span class="hljs-meta">@Order</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> QueueConnection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createOrderConnection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> JMSException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> orderConnectionFactory.createQueueConnection(); } <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span> <span class="hljs-meta"><span class="hljs-meta">@Order</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> QueueSession </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createOrderSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Order QueueConnection conn)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> JMSException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> conn.createQueueSession(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, Session.AUTO_ACKNOWLEDGE); } }</code> </pre> <br><p>  First, the class uses <code>@Resource</code> to get references to <code>QueueConnectionFactory</code> and <code>Queue</code> .  For the same reasons that I described above, you may have several JMS factories and recipients, and you must distinguish them by their JNDI name.  And since CDI does not allow you to specify a name at the deployment point, you must use <code>@Resource</code> instead of <code>@Inject</code> .  The <code>createOrderConnection</code> method uses a <code>QueueConnectionFactory</code> to create a <code>QueueConnection</code> and then <code>QueueConnection</code> it (simultaneously calling it <code>@Order</code> ).  If you look closely at the createOrderSession method, you will see that its parameter is the one created earlier for implementing the <code>QueueConnection</code> and is used to create a <code>QueueSession</code> .  As a result, it is enough just to embed a JMS session into an external component without creating it: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Stateless</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ItemEJB</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-meta"><span class="hljs-meta">@Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> QueueSession session; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-meta"><span class="hljs-meta">@Order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Queue orderQueue; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendOrder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Book book)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ QueueSender sender = session.createSender(orderQueue); TextMessage message = session.createTextMessage(); message.setText(marshall(book)); sender.send(message); } ... }</code> </pre> <br><h1>  Creating and ... recycling </h1><br><p>  You can say: ‚ÄúOk, I have an external class for rough work and creating a connection and session ... <strong>but who will close them?</strong> ‚Äù Indeed, someone must release these resources by closing them.  And at this moment CDI shows a little more magic: <code>@Disposes</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JMSResourceProducer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Resource</span></span>(name = <span class="hljs-string"><span class="hljs-string">"jms/OrderConnectionFactory"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> QueueConnectionFactory orderConnectionFactory; <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span> <span class="hljs-meta"><span class="hljs-meta">@Order</span></span> <span class="hljs-meta"><span class="hljs-meta">@Resource</span></span>(name = <span class="hljs-string"><span class="hljs-string">"jms/OrderQueue"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Queue orderQueue; <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span> <span class="hljs-meta"><span class="hljs-meta">@Order</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> QueueConnection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createOrderConnection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> JMSException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> orderConnectionFactory.createQueueConnection(); } <span class="hljs-meta"><span class="hljs-meta">@Produces</span></span> <span class="hljs-meta"><span class="hljs-meta">@Order</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> QueueSession </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createOrderSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Order QueueConnection conn)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> JMSException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> conn.createQueueSession(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, Session.AUTO_ACKNOWLEDGE); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">closeOrderSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Disposes @Order QueueConnection conn)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> JMSException </span></span>{ conn.close(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">closeOrderSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Disposes @Order QueueSession session)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> JMSException </span></span>{ session.close(); } }</code> </pre> <br><p>  In order to ask CDI to close a resource, you simply need to define a method similar to the one that created this resource ( <code>createOrderSession(@Order QueueConnection conn)</code> creates a session, and <code>closeOrderSession(@Order QueueConnection conn)</code> to close it) and add the <code>@Disposes</code> annotation.  CDI will dispose of resources in the correct order for you (first session, then connection).  I did not mention this, but CDI creates and utilizes resources depending on their scope (resquest, session, application, conversation ...).  But more about that another time.  (Information is in <a href="http://www.apress.com/9781430246268">Beginning Java EE 7</a> [ <a href="http://www.litres.ru/entoni-gonsalves/izuchaem-java-ee-7-2/">translation</a> ] - approx. Lane.) </p><br><h1>  Conclusion </h1><br><p>  As you understood from my previous posts ( <a href="https://habrahabr.ru/company/at_consulting/blog/301636/">part 1</a> , <a href="https://habrahabr.ru/company/at_consulting/blog/301768/">part 2</a> ), CDI is about dependency injection.  Until now, I have shown how to implement beans, but now you know how to embed anything (strings, primitives, entity managers, JMS factories ...) anywhere (POJO, servlets, EJB ...).  You just need to create what you want to implement (using either producing fields or producing methods). </p><br><h1>  Source </h1><br><p>  <a href="https://github.com/agoncal/agoncal-sample-cdi">Download the code</a> and tell us what you think about it. </p></cut></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/302010/">https://habr.com/ru/post/302010/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../30200/index.html">Electric Lightning: 10 minutes of charging, 200 miles</a></li>
<li><a href="../302000/index.html">Setting up Laravel relationships - counting comments (free translation)</a></li>
<li><a href="../302002/index.html">Push notifications to Android using Firebase Cloud Messaging for beginners</a></li>
<li><a href="../302006/index.html">New release candidate for CAD system Qucs-0.0.19S-RC6</a></li>
<li><a href="../302008/index.html">Curse of culture</a></li>
<li><a href="../302012/index.html">.NET Core: there will be no release, but you hold on, health to you, good mood</a></li>
<li><a href="../302014/index.html">IT news May</a></li>
<li><a href="../302016/index.html">Tony Robbins seminar review ‚ÄúFree your inner strength‚Äù. Day 1: Turning fear into force</a></li>
<li><a href="../302018/index.html">Google I / O through the eyes of a non-programmer</a></li>
<li><a href="../30202/index.html">pChart - build graphs and diagrams in PHP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>