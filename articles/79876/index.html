<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>nginx + apache. Caching</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi% username% 
 Here I want to talk about how I set up caching on one server, more precisely VDS. Server characteristics: 2000MHz, 2GB RAM, 80Gb HDD, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>nginx + apache. Caching</h1><div class="post__text post__text-html js-mediator-article">  Hi% username% <br>  Here I want to talk about how I set up caching on one server, more precisely VDS.  Server characteristics: 2000MHz, 2GB RAM, 80Gb HDD, virtualization technology - OpenVZ. <br>  It was decided to use Nginx version <b>0.7.64</b> .  On the server there were about 200 sites.  And a few highly loaded projects.  These very projects gave tangible brakes and server load.  We will consider DLE in this example. <a name="habracut"></a><br>  So, the main points of caching: <br><ul><li>  Cache site ‚Äúguests‚Äù </li><li>  Log in visitors directly to Apache </li></ul><br><br><h4>  0. We invent ‚Äútechnology‚Äù </h4><br>  If there are lines in urlah: <i>index.php? Action = logout</i> and <i>admin.php,</i> then we will send these requests directly to the Apache.  Then, we need to teach nginx to separate logged users from guests.  We will share them with the help of cookies.  In my case, Cookies <b>dle_user_id</b> and <b>dle_password</b> mean that the user is logged in and we do not want to give him a page 5 minutes old.  And plus, we need to send a POST request for authorization outside the cache, I think it is clear why and why (:. <br><br><h4>  1. Let's go.  We write a config </h4><br>  Actually, I will not describe the full config, I will describe only those moments that are necessary for caching.  I do not pretend to the correctness and optimality of my decision, but what is shown here works, and works well in combat conditions.  Do not kick much, I recently got into the wilds of nginx, but it feels like the documentation and the example is not enough! <br>  The main directives of the config are clickable and lead to the documentation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  1.1 Config itself </h4><br><br> <code><a href="http_proxy_module.html"></a> <a href="http_proxy_module.html"></a> <a href="http_core_module.html"></a> <a href="http_core_module.html"></a> <a href=""></a> <a href="http_core_module.html"></a> <a href="http_proxy_module.html"></a> <a href="http://127.0.0.1/"></a> <a href="http_proxy_module.html"></a> <a href="http://example.com/"></a> <a href="http_proxy_module.html"></a> <a href="http://127.0.0.1/"></a> <a href="http://example.com/"></a> <a href="http_rewrite_module.html"></a> <a href="http_core_module.html"></a> <a href="http_proxy_module.html"></a> <a href="http_proxy_module.html"></a> <a href="http_proxy_module.html"></a> <a href="http_proxy_module.html"></a> <a href="http_proxy_module.html"></a> <a href="http_proxy_module.html"></a> <a href="http://127.0.0.1/"></a> <a href="http://example.com/"></a> <a href="http_headers_module.html"></a> <a href="http://127.0.0.1/"></a> http { <br> proxy_cache_path /var/cache/nginx/cache levels=1:2 keys_zone=one:16m inactive=7d max_size=1024m; <br> proxy_temp_path /var/cache/nginx/temp; #     http ,    . <br> <br> server { <br> listen 127.0.0.1:80; <br> server_name example.com www.example.com; <br> proxy_temp_path /var/cache/nginx/example.com; <br> <br> location @nocached { <br> proxy_pass 127.0.0.1:8080; <br> proxy_redirect example.com:8080/ /; <br> proxy_set_header Host $host; <br> proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; <br> proxy_set_header X-Real-IP $remote_addr; <br> } <br> <br> location / { <br> proxy_pass 127.0.0.1:8080; <br> proxy_redirect example.com:8080/ /; <br> proxy_set_header Host $host; <br> proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; <br> proxy_set_header X-Real-IP $remote_addr; <br> #      <br> if ($cookie_dle_user_id) { return 412; } <br> if ($cookie_dle_password) { return 412; } <br> if ($request_method = POST ) { <br> return 412; <br> } <br> error_page 412 = @nocached; <br> proxy_cache one; <br> proxy_cache_key "$request_method|$is_args|$host|$request_uri"; <br> proxy_hide_header "Set-Cookie"; <br> proxy_ignore_headers "Cache-Control" "Expires"; <br> proxy_cache_valid 200 302 304 5m; <br> proxy_cache_valid 301 1h; <br> proxy_cache_valid 503 4s; <br> proxy_cache_valid any 1m; <br> proxy_cache_use_stale http_502 http_503 http_504; <br> } <br> <br> location ~ (admin.php|index.php?action=logout) { <br> proxy_pass 127.0.0.1:8080; <br> proxy_redirect example.com:8080/ /; <br> proxy_set_header Host $host; <br> proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; <br> proxy_set_header X-Real-IP $remote_addr; <br> } <br> <br> location ~* ^.+\.(jpg|jpeg|gif|png|svg|htm|js|css|mp3|ogg|mpe?g|avi|zip|gz|bz2?|rar)$ { <br> root /var/www/example/data/www/example.com; <br> expires 1y; <br> access_log /var/www/httpd-logs/example.com.access.log; <br> error_page 404 = @fallback; <br> } <br> location @fallback { <br> proxy_pass 127.0.0.1:8080; <br> proxy_set_header Host $host; <br> proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; <br> proxy_set_header X-Real-IP $remote_addr; <br> } <br> } <br> } <br></code> <br><br>  $ cookie_name, this variable is equal to the cookie name; <br><br>  Actually, we will continue to disassemble what we namulevali here.  Suggestions for improvements and revisions are welcome! <br><br><h4>  2. Debriefing </h4><br><br>  So, we had to differentiate users into 2 types, and depending on the type, give or not give him a cache. <br>  In the <b>@nocached location,</b> we will let those who own two cookies - <i>dle_user_id</i> , <i>dle_password</i> , therefore these users will walk with us directly, without caching.  I already wrote that for authorization POST requests are used, as well as for registration;), therefore we do not need to cache them.  In this case, we simply add a check to $ request_method. <br>  <b>error_page 412 = @nocached</b> actually sends the owners of cookies, or who tries to log in, directly to the Apache. <br>  I would like to mention the directive <b>proxy_cache_key</b> .  In it, for the key, I indicate only the ‚Äúuniqueness‚Äù of the page, that is, if anyone has turned to any of our pages ‚ÄúGuest‚Äù, then nginx, by proxying the first answer, immediately puts it into the cache.  After that, any other user who did it within the allotted page lifetime (proxy_cache_valid 200 ... 5m) gets the very page that Apache generated for the previous user, this will continue until the end of its life, in our case 200 is allocated for the answer - 5 minutes.  After that, everything will continue on the same scenario. <br>  Next, I would like to point out 2 lines: <i>proxy_hide_header, proxy_ignore_headers</i> which are <b>required</b> when caching.  You don't want Vasya Pupkin to get Petya Vasechkin's cookies, and thereby do them on his behalf ... ???  The second line, <b>proxy_ignore_headers</b> Allows us to save Apache responses that are marked as <i>not caching</i> or anything else like that.  After all, even for such things we have to twitch the awkward Apache, when you can cache it once, and give it away with a quick nginx. <br>  I will not <i>give</i> special attention to the <i>proxy_cache_valid</i> parameter, everything is well described in the documentation. <br>  <b>proxy_cache_use_stale is a</b> very valid directive, it allows us to give the client a cached ‚Äúnormal‚Äù page at the time when the Apache hanged, or died or something ... 502, and 504 errors, respectively. <br>  In the following <b>location ~ (admin.php | index.php? Action = logout)</b> we say that we want to send requests that contain strings directly to Apache. <br>  The next two <b>locations</b> tell nginx what statics (pictures of vidyushechka style sheets, etc.) to give to yourself.  And if nginx did not find such a file on disk, then maybe it is just located in .htaccess and Apache will give it to us. <br><br>  Well, I hope that everything.  I really hope that my Habra topic has helped you, or will help in the future to avoid some unpleasant moments. <br>  Thanks for attention. <br><br>  <b>PS</b> The parser ate my http: //, and nginx needs it, how can I recover it?  Otherwise, when you copy my config file, nginx may scream, and if not, then it is no longer known what will happen. <br>  <a href="http://bkmz.org/80">Crosspost</a> </div><p>Source: <a href="https://habr.com/ru/post/79876/">https://habr.com/ru/post/79876/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../79861/index.html">Firefox for Maemo operating system (Nokia N900 and N810) reached Release Candidate status</a></li>
<li><a href="../79864/index.html">Another neblon Habr</a></li>
<li><a href="../79869/index.html">Experimentally proved the existence of memories that persist in the brain for life</a></li>
<li><a href="../79870/index.html">Microsoft conducts Best Buy staff training</a></li>
<li><a href="../79874/index.html">EB-5 visa wants to expand on the founders of startups</a></li>
<li><a href="../79878/index.html">Doctrine, extending the capabilities of your favorite ORM framework! Part 1.a (I18n, quick access to translatable attributes)</a></li>
<li><a href="../79879/index.html">Get RSS / Atom feeds from any page</a></li>
<li><a href="../79880/index.html">Breaking "for an article"</a></li>
<li><a href="../79882/index.html">Notes on NLP (Part 5)</a></li>
<li><a href="../79883/index.html">C # coprocessor programming? Yes!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>