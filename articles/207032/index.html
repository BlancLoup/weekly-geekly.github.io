<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing the lightweight Jabber Prosody server (v0.9 and v0.10beta)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is about how to set up a jabber Prosody server for home, perhaps corporate, use. I had the task to raise a personal jabber server on my d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing the lightweight Jabber Prosody server (v0.9 and v0.10beta)</h1><div class="post__text post__text-html js-mediator-article">  This article is about how to set up a jabber Prosody server for home, perhaps corporate, use.  I had the task to raise a personal jabber server on my domain, while preserving history (perhaps synchronization with the client <a href="http://xmpp.org/extensions/xep-0136.html">XEP-0136</a> ), with supporting communication with other jabber servers, and conferences.  In general, everything is standard and nothing special, but when raising the server I ran into two problems that I plan to tell today. <br><br>  <a href="https://prosody.im/">Prosody</a> is a lightweight jabber server written in lua, supporting many XEPP (XMPP Extension Protocol) standards, all supported standards can be viewed on this <a href="https://prosody.im/doc/xeplist">page</a> .  To the question "why lua" creator prosody <a href="http://matthewwild.co.uk/">Matthew Wild</a> says that this is a very simple language that has a fast interpreter, which is the reason for such an unusual choice. <br><br>  In this article I will install prosody on Debian 7. <br><a name="habracut"></a><br>  First we need to add the required repository to source.list: <br><pre><code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> deb http://packages.prosody.im/debian $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list</code> </pre> <br>  After you need to apply the key: <br><pre> <code class="bash hljs">$ wget https://prosody.im/files/prosody-debian-packages.key -O- | sudo apt-key add -</code> </pre><br>  You need to update the repository: <br><pre> <code class="bash hljs">$ sudo apt-get update</code> </pre><br>  Next will be 2 versions for installing Prosody v0.9 and v0.10 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Install Prosody 0.9 </h3><br>  Installing version 0.9, currently stable: <br><pre> <code class="bash hljs">$ sudo apt-get install prosody</code> </pre><br>  We set up prosody on the files, for this you need to tweak the settings that are in the file "/etc/prosody/prosody.cfg.lua", I will immediately give the whole config, with comments: <br><pre> <code class="lua hljs">admins = { <span class="hljs-string"><span class="hljs-string">"user@example.com"</span></span> } <span class="hljs-comment"><span class="hljs-comment">--   modules_enabled = { -- Generally required "roster"; -- Allow users to have a roster. Recommended ;) "saslauth"; -- Authentication for clients and servers. Recommended if you want to log in. "tls"; -- Add support for secure TLS on c2s/s2s connections "dialback"; -- s2s dialback support "disco"; -- Service discovery "posix"; -- POSIX functionality, sends server to background, enables syslog, etc. -- Not essential, but recommended "private"; -- Private XML storage (for room bookmarks, etc.) "vcard"; -- Allow users to set vCards -- These are commented by default as they have a performance impact --"privacy"; -- Support privacy lists --"compression"; -- Stream compression (requires the lua-zlib package installed) -- Nice to have "version"; -- Replies to server version requests "uptime"; -- Report how long server has been running "time"; -- Let others know the time here on this server "ping"; -- Replies to XMPP pings with pongs "pep"; -- Enables users to publish their mood, activity, playing music and more "register"; -- Allow users to register on this server using a client and change passwords -- Admin interfaces "admin_adhoc"; -- Allows administration via an XMPP client that supports ad-hoc commands "admin_telnet"; -- Opens telnet console interface on localhost port 5582 } modules_disabled = { } allow_registration = false --       ssl = { --  ssl ,    key = "/etc/prosody/certs/localhost.key"; certificate = "/etc/prosody/certs/localhost.crt"; } c2s_require_encryption = true --  -  s2s_secure_auth = false pidfile = "/var/run/prosody/prosody.pid" authentication = "internal_hashed" --   (    ) storage = "internal" --     log = { info = "/var/log/prosody/prosody.log"; error = "/var/log/prosody/prosody.err"; "*syslog"; } VirtualHost "example.com" --     jabber  ssl = { --       key = "/etc/prosody/certs/example.com.key"; certificate = "/etc/prosody/certs/example.com.crt"; }</span></span></code> </pre><br>  example.com needs to be replaced with your domain everywhere, after which you need to generate the keys: <br><pre> <code class="bash hljs">$ sudo prosodyctl cert generate example.com $ sudo cp /usr/lib/prosody/example.com* /etc/prosody/certs/</code> </pre><br>  Register a new user and restart prosody: <br><pre> <code class="bash hljs">$ sudo prosodyctl register user example.com password $ sudo prosodyctl restart</code> </pre><br>  Now you can log in to the server, but you can only communicate inside your prosody server, if you want to configure s2s (server-server communication) you need to write a couple of entries in srv dns: <br><blockquote>  _xmpp-client._tcp.example.com.  18000 IN SRV 0 5 5222 xmpp.example.com. <br>  _xmpp-server._tcp.example.com.  18000 IN SRV 0 5 5269 xmpp.example.com. <br>  jabber._tcp.example.com.  18000 IN SRV 0 5 5269 xmpp.example.com. </blockquote><br>  As soon as the data is applied, the s2s connection should work and you can connect to conferences on jabber.ru or add to the contact list and communicate with people who use any jabber servers supporting s2s. <br><br>  Everything works well, but it remains to configure the message history, it is not supported by prosody by default, for this you need to install a module from <a href="https://code.google.com/p/prosody-modules/">prosody-modules</a> called ‚Äúmod_message_logging‚Äù. <br>  There are two options for how to install modules in prosody: <br>  1) You need to copy the lua file with the contents of the module code to the / usr / lib / modules directory and add it to the config in the modules_enabled section: <br><pre> <code class="lua hljs">modules_enabled = { ... <span class="hljs-string"><span class="hljs-string">"message_logging"</span></span>; ... }</code> </pre><br>  2) Clone the prosody-modules in any directory, give it read permissions for the prosody user and add to the config this: <br><pre> <code class="lua hljs">plugin_paths = { <span class="hljs-string"><span class="hljs-string">"/usr/lib/prosody/modules"</span></span>, <span class="hljs-string"><span class="hljs-string">"/path/to/prosody-modules"</span></span> } ... modules_enabled = { ... <span class="hljs-string"><span class="hljs-string">"message_logging"</span></span>; ... }</code> </pre><br>  Restart the server: <br><pre> <code class="bash hljs">$ prosodyctl restart</code> </pre><br>  And we admire the history of messages in / var / lib / prosody / message_logging /.  As you can see, the entire history of messages for 1 day is written to one file on the server for each authorized user, that is, /var/lib/prosody/message_logs/example.com/2013-12-20/user.msglog contains logs for this user. for the whole day with all his contacts. <br>  This implementation seemed to me very uncomfortable, in the prosody conference they said that there was no normal implementation of the message history and I changed mod_message_logging a little and it turned out that <a href="">mod_message_loggind_diff_files</a> also slightly fixed the problems of the past module and the following directory / file structure appeared - along the path / var / lib / prosody / message_logs /example.com/2013-12-20/user directories with all files with message history, all file names are the jid of the contact or conference, for example "prosody% 40conference.prosody.im.msglog". <br><br>  You can also connect as standard mod_message_logging. <br><br>  At this point, you can finish setting up the prosody server, but some will want to connect the module with support for HEP-0136 (synchronization of logs to the client), this module is called mod_mam, but the developers say that this module works very slowly with files, and even someone will want to switch on the database, but prosody 0.9 has a problem with that. <br>  The current implementation of the module for storing data in sql when running prosody in the absence of a connection to the database throws out a critical error and prosody does not start.  This problem is badly built in debian and centos, since their boot systems do not allow waiting for the database to be fully initialized to run the desired application, but in the sql2 module, which is available at 0.10, this problem is fixed, so we can install prosody 0.10 + mod_mam. <br><br><h3>  Install Prosody 0.10 </h3><br>  Installing version 0.10, currently beta: <br><pre> <code class="bash hljs">$ sudo apt-get install prosody-0.10</code> </pre><br>  Then we repeat everything as with version 0.9 with minor changes. <br>  1) Change the data storage location from internal to sql2 <br><pre> <code class="lua hljs">storage = <span class="hljs-string"><span class="hljs-string">"sql2"</span></span></code> </pre><br>  2) Add a setting to link to the base.  Before the necessary line, delete the "-" and change the data on your own to access the desired database <br><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--sql = { driver = "SQLite3", database = "prosody.sqlite" } -- Default. 'database' is the filename. --sql = { driver = "MySQL", database = "prosody", username = "prosody", password = "secret", host = "localhost" } --sql = { driver = "PostgreSQL", database = "prosody", username = "prosody", password = "", host = "localhost" }</span></span></code> </pre><br>  3) Install the lua driver to communicate with the desired database, for example, for sqlite <br><pre> <code class="lua hljs">$ sudo apt-get install lua-dbi-sqlite3</code> </pre><br>  The module for logging to the database is in <a href="https://code.google.com/p/prosody-modules/">prosody-modules</a> called ‚Äúmod_mam‚Äù, although unlike the module that writes message history to a file, this module stores only private messages.  If you need a posting history from conferences, you will need to install mod_message_logging or mod_message_loggind_diff_files.  There is also a module that stores the messages of the mod_mam_muc conferences, but it only stores messages from your local conferences raised on your server (if such a module can be useful). <br>  There are two options for how to install modules in prosody: <br>  1) You need to copy the lua file with the contents of the module code to the / usr / lib / modules directory and add it to the config in the modules_enabled section: <br><pre> <code class="lua hljs">modules_enabled = { ... <span class="hljs-string"><span class="hljs-string">"mam"</span></span>; ... }</code> </pre><br>  2) Clone the prosody-modules in any directory, give it read permissions for the prosody user and add to the config this: <br><pre> <code class="lua hljs">plugin_paths = { <span class="hljs-string"><span class="hljs-string">"/usr/lib/prosody/modules"</span></span>, <span class="hljs-string"><span class="hljs-string">"/path/to/prosody-modules"</span></span> } ... modules_enabled = { ... <span class="hljs-string"><span class="hljs-string">"mam"</span></span>; ... }</code> </pre><br>  Restart the server: <br><pre> <code class="bash hljs">$ prosodyctl restart</code> </pre><br>  After prosody reboot, you will be configured with message and conference history in files and personal message history in the database with synchronization to the client. <br><br>  I hope I helped someone, if there is an opportunity, I will answer your questions in the comments or in the LAN. </div><p>Source: <a href="https://habr.com/ru/post/207032/">https://habr.com/ru/post/207032/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../207018/index.html">Windows Azure Media Services vs. Amazon Elastic Transcoder. Part 1: Windows Azure Media Services</a></li>
<li><a href="../207020/index.html">The percentage of programming languages ‚Äã‚Äãthat are currently taught in high school</a></li>
<li><a href="../207024/index.html">Things you may not have known about Unity3D</a></li>
<li><a href="../207026/index.html">6 errors reduce the conversion of your store</a></li>
<li><a href="../207030/index.html">Dive into Litecoin, or how to start mining scrypt currency</a></li>
<li><a href="../207034/index.html">Effective mental arithmetic or brain warm-up</a></li>
<li><a href="../207036/index.html">Little bit about fragment</a></li>
<li><a href="../207038/index.html">Are there any more Telegram bookmarks?</a></li>
<li><a href="../207042/index.html">0day Wednesday - research on the latest malware</a></li>
<li><a href="../207044/index.html">Master in Finland - the experience of the year</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>