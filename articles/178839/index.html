<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Assembling a Cmake packer or training on cats</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="- You will not say how many degrees below zero? 
 - What? 
 - Well, I ‚Ä¶. I train. 
 - Train better .. (looks at Morgunov) ... on cats. 
 The article d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Assembling a Cmake packer or training on cats</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  - You will not say how many degrees below zero? <br>  - What? <br>  - Well, I ‚Ä¶.  I train. <br>  - Train better .. (looks at Morgunov) ... on cats. </blockquote><br>  The article describes the experience of using <a href="http://www.cmake.org/">CMAKE</a> and LZ4 with some bias on the embedded system. <a name="habracut"></a>  Those familiar with Makefiles or even CMAKE can safely skip the first few paragraphs. <br><br><h5>  Cats </h5><br>  As cats, it is better to take a small opensource project on the network consisting of a small number of files and several targets (executable files and libraries).  Such a project is difficult to find, because many popular projects are already overgrown with a bunch of files.  However, the <a href="https://code.google.com/p/lz4/">LZ4</a> packer turned out to be a good candidate.  LZ4 is still young, and most importantly, it is quite simple and aimed at SUPER FAST data compression, which may therefore be small, since a large piece of code will not work quickly (it will not be optimized in the cache). <br>  LZ4 can quickly compress information, which, for the embedded world, most likely means no great demands on performance and memory.  I managed to adapt it to compression for LPC2478 while the amount of RAM it occupied was 12k (4k input buffer + 4k output + 4k dictionary).  I think this volume can be reduced to 256 +256 + 256, naturally due to the loss of the compression ratio.  Nevertheless, even this is a good option so that you do not dodge your cunning compression algorithms of the polling history of any systems if you have ‚Äúalmost‚Äù repeated records of 30 ~ 100 bytes in size.  Those who are interested in the compression algorithm, I note, LZ4 is the optimized version of the LZ77 algorithm. <br>  Separate praise deserves the unpacking function.  It is very simple and fits in dozens of lines of code, it allows you to achieve a 1GB / s decompression speed on modern PCs. <br><br><h5>  What is the assembly system in embedded systems for? </h5><br>  As a rule, any project in embedded systems starts with <s>‚Äúhellow word‚Äù</s> , that is, with UartInit () + uart_put_char ().  However, it very quickly grows into several files, and of course professionals have a lot of ready source code, designed in the form of static libraries.  To create an executable image in any serious project with a few tens and hundreds of kilobytes of code, you must skip tens and hundreds of files through the compiler.  This is what the assembly system does.  The assembly scheme can be simplified to depict as follows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Source code ‚Üí build system ‚Üí compiler ‚Üí executable (s) file (s)</b> <br><br>  Of course, your new-fangled proprietary IDE will do its best to do all the assembly work for you, just click ‚ÄúBuild all‚Äù.  As your ‚Äúcode base‚Äù grows, you will think about collecting existing code as often as possible and in various ways. <br>  The reasons for the presence of several variants of code assembly can be the presence of the following factors: <br><ol><li>  several projects </li><li>  several boards </li><li>  even several types of controllers </li><li>  testing parts of code on a PC </li><li>  several development branches because of a large team </li></ol><br>  The first reaction to such requirements is always: ‚Äúlet's insert ifdefs‚Äù, however, very soon you realize that you cannot do with ifdefs alone, but the code does not look very nice. <br><br><h5>  Makefiles </h5><br>  The Make utility enters the arena, and brutal men take the compiler and the keys to it and begin to write assembly rules.  Make is quickly mastered, however, if you already have three projects and a lot of folders, each of which has a library, you have to be more diligent in writing Makefiles.  The build scheme with Make looks like this: <br><br>  <b>Source Code ‚Üí GNU MAKE ‚Üí Compiler ‚Üí Executable (s) File (s)</b> <br><br><h4>  MAKE </h4><br>  CMAKE is an advanced make.  Based on the build rules described in CmakeLists.txt, CMAKE generates build management files for MAKE and other utilities and development environments (the list of supported utilities can be obtained by running ‚Äúcmake ‚Äìhelp‚Äù).  Now the scheme is as follows: <br><br>  <b>Source Code ‚Üí CMAKE ‚Üí GNU MAKE or NMAKE or ....</b>  <b>‚Üí compiler ‚Üí executable file (s)</b> <br><br>  Among the advantages of CMAKE I will note: <br><ol><li>  The language of the rules of the Lisp assembly is similar and more developed than that of MAKE.  A good chance to try something different from the traditional C paradigm. </li><li>  The utility is cross-platform, your build will not be dependent on IDE and working OS. </li><li>  Not only build rules are generated, but also projects for Code-blocks, Eclipse and Visual Studio. </li><li>  There are ample opportunities to generate the source code itself, as well as many modules, which allows replacing Automake and Qmake. </li><li>  There are automatic assembly systems (CDASH), packaging (CPACK) and testing (CTEST). </li><li>  MAKE is popular.  Many development teams translate their projects under it (for example, KDE). </li></ol><br>  The main advantage in the field of embedded solutions is that, ultimately, your code becomes more portable, you are still one step closer to building a part of your application under a PC for more comfortable debugging.  You can arrange BUILD tests automatically, I don‚Äôt know if it allows Code Red or CoCox, but with CMAKE you are not dependent on the IDE. <br><br><h5>  minimal project </h5><br>  Below is a simple (but not the simplest) file CmakeLists.txt. <br><pre><code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">cmake_minimum_required</span></span> (VERSION <span class="hljs-number"><span class="hljs-number">2.8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">PROJECT</span></span>(LZ4 C) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(SRC_DIR <span class="hljs-variable"><span class="hljs-variable">${CMAKE_CURRENT_SOURCE_DIR}</span></span>/) <span class="hljs-keyword"><span class="hljs-keyword">ADD_DEFINITIONS</span></span>(<span class="hljs-string"><span class="hljs-string">"-Wall"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ADD_DEFINITIONS</span></span>(<span class="hljs-string"><span class="hljs-string">"-W"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ADD_DEFINITIONS</span></span>(<span class="hljs-string"><span class="hljs-string">"-Wundef"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ADD_DEFINITIONS</span></span>(<span class="hljs-string"><span class="hljs-string">"-Wcast-align"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ADD_DEFINITIONS</span></span>(<span class="hljs-string"><span class="hljs-string">"-Wno-implicit-function-declaration"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ADD_DEFINITIONS</span></span>(<span class="hljs-string"><span class="hljs-string">"-O3 -march=native -std=c99"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INCLUDE_DIRECTORIES</span></span> (<span class="hljs-variable"><span class="hljs-variable">${SRC_DIR}</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(LZ4_SRCS_LIB lz4_decoder.h lz4_encoder.h <span class="hljs-variable"><span class="hljs-variable">${SRC_DIR}</span></span>lz4.c <span class="hljs-variable"><span class="hljs-variable">${SRC_DIR}</span></span>lz4hc.c <span class="hljs-variable"><span class="hljs-variable">${SRC_DIR}</span></span>lz4.h <span class="hljs-variable"><span class="hljs-variable">${SRC_DIR}</span></span>lz4_format_description.txt) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(LZ4_SRCS <span class="hljs-variable"><span class="hljs-variable">${LZ4_SRCS_LIB}</span></span> <span class="hljs-variable"><span class="hljs-variable">${SRC_DIR}</span></span>xxhash.c <span class="hljs-variable"><span class="hljs-variable">${SRC_DIR}</span></span>bench.c <span class="hljs-variable"><span class="hljs-variable">${SRC_DIR}</span></span>lz4c.c ) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(FUZZER_SRCS <span class="hljs-comment"><span class="hljs-comment">#  -  ${LZ4_SRCS_LIB} ${SRC_DIR}fuzzer.c # ${SRC_DIR}ooops_commented_source_file.c ) #   lz4c add_executable(lz4c ${LZ4_SRCS}) #   fuzzer add_executable(fuzzer ${FUZZER_SRCS})</span></span></code> </pre> <br>  <b>make_minimum_required</b> sets the minimum version of Cmake.  The <b>PROJECT</b> command sets the project name as well as the programming language (s). <br>  Commands can be written in both lowercase and uppercase letters.  The most frequent <b>set</b> command is an analogue of assigning and creating variables, like in <b>Let</b> BASIC it starts to bother a little, but then you get used to it.  In CMAKE, other variables are also ‚Äúpredetermined‚Äù, one of them is <b>$ {CMAKE_CURRENT_SOURCE_DIR}</b> .  As in make, <b>SRC_DIR</b> is the name of the variable, and <b>$ {SRC_DIR}</b> is the value.  Variables in CMAKE are treated as lists, but can sometimes be interpreted as strings or numbers.  File lists can be easily broken into several lines. <br>  <b>ADD_DEFINITIONS</b> should actually be used to set the preprocessor macros, but here it is simply used to set the keys to the compiler. <br>  <b>add_executable</b> sets the build target ‚Äî the executable file. <br><br><h5>  Configuration </h5><br>  Already such a small CmakeLists.txt allows you to collect the packer LZ4 (today revision 94).  Open the command console and run cmake with an indication of the generator (see image of the screen). <br><br> <a href="http://tinypic.com/%3Fref%3D110k4dv"><img src="https://habrastorage.org/getpro/habr/post_images/1ac/e39/61f/1ace3961f8b4b1835558fa258f8aebc0.gif" alt="Image and video hosting by TinyPic"></a> <br><br>  make produces some basic messages, which in this case we ignore - nothing non-standard has happened - a Makefile is generated and a project for CodeBlocks. <br>  The presence of a preliminary setup phase in the form of running Cmake before make allows you to change the compilation process based on the launch arguments of CMAKE and the software version (OS, compiler) on which the build takes place.  You can also copy files, download files, apply patches, generate source files, and more.  Cmake has the ability to pass additional user-defined arguments.  make can also run various utilities during the configuration process.  I will try to write about this in the next section. <br><br>  With a big stretch, we can say that in terms of the build, CMAKE is able to perform Portage + automake functionality in Gentoo Linux, but compared to portage, Cmake is much more compact than the python distribution, it is more portable to many platforms (primarily Windows). <br><br><h5>  Running the build </h5><br>  The build starts through a) CodeBlocks b) make (I advise you to try also 'make VERBOSE = 1' and 'make help').  Additional buns over make are color output to the console, as well as percentages of completion. <br><br><h4>  Meow! </h4><br>  Now let's have fun with our lz4 packer. <br><pre>  C: \ Desktop \ lz4&gt; lz4c.exe -H
 *** LZ4 Compression CLI, by Yann Collet (May 1 2013) ***
 Usage:
       lz4c.exe [arg] input output
 Arguments:
  -c0 / -c: Fast compression (default)
  -c1 / -hc: High compression
  -d: decompression
  -y: overwrite without prompting
  -H: Help (this text + advanced options)

 Advanced options:
  -t: test compressed file
  -B #: Block size [4-7] (default: 7)
  -x: enable block checksum (default: disabled)
  -nx: disable stream checksum (default: enabled)
  -b #: benchmark files, using # [0-1] compression level
  -i #: iteration loops [1-9] (default: 3), benchmark mode only
 input: can be 'stdin' (pipe) or a filename
 output: can be 'stdout' (pipe) or a filename or 'null'
           example: lz4c -hc stdin compressedfile.lz4
</pre><br><br><h6>  The packaging itself. </h6><br><pre> C: \ Desktop \ lz4&gt; lz4c.exe lz4c.exe lz4c.lz4
 *** LZ4 Compression CLI, by Yann Collet (May 1 2013) ***
 Compressed 98828 bytes into 56586 bytes ==&gt; 57.26%
 Done in 0.03 s ==&gt; 3.04 MB / s
</pre><br><br><h6>  Launch benchmark. </h6><br><pre> C: \ Desktop \ lz4&gt; lz4c.exe -b lz4c.exe lz4c.lz4
 *** LZ4 Compression CLI, by Yann Collet (May 1 2013) ***
 lz4c.exe: 98828 -&gt; 56567 (57.24%), 163.3 MB / s, 467.5 MB / s
 lz4c.lz4: 56586 -&gt; 56278 (99.46%), 273.1 MB / s, 1442.1 MB / s
   TOTAL: 155414 -&gt; 112845 (72.61%), 191.3 MB / s, 620.0 MB / s
</pre><br>  My computer is not very fast, and I do not pretend to complete testing, but these figures are very impressive. <br><br><h4>  Total </h4><br>  So, I hope this article will help you in mastering the Cmake utility.  In the next part I will try to write about further research on the issue of assembly LZ4.  For those who are curious, the final version of the file I wrote was accepted by the author of the program, however, in the current version of LZ4 there are two CmakeLists files, <a href="https://code.google.com/p/lz4/source/browse/trunk/cmake/pack/CMakeLists.txt">one written by me</a> and used for assembly, and the other used to build libraries, although it is possible to combine these two files I have not reached the hands.  Guru Smake-dare! </div><p>Source: <a href="https://habr.com/ru/post/178839/">https://habr.com/ru/post/178839/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../178823/index.html">MVC model metadata output to dynamic markup</a></li>
<li><a href="../178825/index.html">A little more about SDH and PDH</a></li>
<li><a href="../178827/index.html">Tools that we use for team development.</a></li>
<li><a href="../178831/index.html">Quickly squaring numbers from 1 to 100</a></li>
<li><a href="../178833/index.html">How I chose a lightweight PHP framework</a></li>
<li><a href="../178849/index.html">The story of a developer, or shooting at the stars, you will hit the moon</a></li>
<li><a href="../178851/index.html">Remake Race Into Space: how to improve the gameplay and interface?</a></li>
<li><a href="../178855/index.html">EB 122.4. Preparing for the delivery of the third group of electrical safety</a></li>
<li><a href="../178859/index.html">PHP NameSpace - how to cook it?</a></li>
<li><a href="../178861/index.html">Rules for effective meetings</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>