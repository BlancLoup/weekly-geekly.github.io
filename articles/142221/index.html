<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Duplication of an object when trying to get data from a table with the DateTime key</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The other day, I encountered a strange error in Doctrine2 (version 2.2.2). 

 The essence of the problem 
 When trying to get data (in the form of an ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Duplication of an object when trying to get data from a table with the DateTime key</h1><div class="post__text post__text-html js-mediator-article">  The other day, I encountered a strange error in Doctrine2 (version 2.2.2). <br><br><h3>  The essence of the problem </h3><br>  When trying to get data (in the form of an array of objects (Entity)) from a table with a key of type DateTime, Doctrine returned an array consisting of a single object (the first row) and references to it. <br><a name="habracut"></a><br><br><h3>  Error description </h3><br>  There is a table, let's call it PublisherDailyStatistic, which has two keys (more precisely, the key is one, but composite): <br>  1) PublisherID integer <br>  2) StatisticDT DateTime <br>  Accordingly, statistics on publishers are recorded in this table once a day. <br>  Suppose there is already data: <br><table><tbody><tr><td>  PublisherID </td><td>  StatisticDT </td><td>  Somecontent </td></tr><tr><td>  one </td><td>  2012-04-15 00:00:00 </td><td>  test 15 </td></tr><tr><td>  one </td><td>  2012-04-16 00:00:00 </td><td>  test 16 </td></tr><tr><td>  one </td><td>  2012-04-17 00:00:00 </td><td>  test 17 </td></tr></tbody></table>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Further, in the repository (~ PublisherDailyStatisticRepository.php) there is a function that pulls the statistics on the publisher from the database for a certain period of time. <br>  It looks like this: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> function getByPublisherAndDate($publisher_id, \ <font color="#2B91AF">DateTime</font> $startDt, \ <font color="#2B91AF">DateTime</font> $endDt) <br> { <br> $qb = $ <font color="#0000ff">this</font> -&gt;_em-&gt;createQueryBuilder() <br> -&gt; <font color="#0000ff">select</font> ( <font color="#A31515">'p'</font> ) <br> -&gt; <font color="#0000ff">from</font> ( <font color="#A31515">'\Model\Entity\PublisherDailyStatistic, '</font> p <font color="#A31515">') <br> -&gt;where('</font> p.publisherid=:publisherid <font color="#A31515">') <br> -&gt;andWhere('</font> p.statisticdt&gt;=:startdt <font color="#A31515">') <br> -&gt;andWhere('</font> p.statisticdt&lt;=:enddt') <br> -&gt;setParameters(array( <font color="#A31515">"publisherid"</font> =&gt;( <font color="#0000ff">int</font> )$publisher_id, <br> <font color="#A31515">"startdt"</font> =&gt;$startDt, <br> <font color="#A31515">"enddt"</font> =&gt;$endDt)); <br> <br> <font color="#0000ff">return</font> $qb-&gt;getQuery()-&gt;getResult(); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <br> </blockquote><br><br>  It seems everything is simple and clear.  But here's what we get when we call getByPublisherAndDate (1, 2012-04-15, 2012-04-17): <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">array (size=3) <br> 0 =&gt; <br> <font color="#0000ff">object</font> (Model\Entity\PublisherDailyStatistic)[398] <br> <font color="#0000ff">private</font> <font color="#A31515">'publisherid'</font> =&gt; <font color="#0000ff">int</font> 1 <br> <font color="#0000ff">private</font> <font color="#A31515">'statisticdt'</font> =&gt; <br> <font color="#0000ff">object</font> ( <font color="#2B91AF">DateTime</font> )[381] <br> <font color="#0000ff">public</font> <font color="#A31515">'date'</font> =&gt; <font color="#0000ff">string</font> <font color="#A31515">'2012-04-15 00:00:00'</font> (length=19) <br> <font color="#0000ff">public</font> <font color="#A31515">'timezone_type'</font> =&gt; <font color="#0000ff">int</font> 3 <br> <font color="#0000ff">public</font> <font color="#A31515">'timezone'</font> =&gt; <font color="#0000ff">string</font> <font color="#A31515">'Europe/Moscow'</font> (length=13) <br> <font color="#0000ff">private</font> <font color="#A31515">'somecontent'</font> =&gt; <font color="#0000ff">string</font> <font color="#A31515">'test 15'</font> (length=7) <br> 1=&gt; <br> <font color="#0000ff">object</font> (Model\Entity\PublisherDailyStatistic)[398] <br> <font color="#0000ff">private</font> <font color="#A31515">'publisherid'</font> =&gt; <font color="#0000ff">int</font> 1 <br> <font color="#0000ff">private</font> <font color="#A31515">'statisticdt'</font> =&gt; <br> <font color="#0000ff">object</font> ( <font color="#2B91AF">DateTime</font> )[381] <br> <font color="#0000ff">public</font> <font color="#A31515">'date'</font> =&gt; <font color="#0000ff">string</font> <font color="#A31515">'2012-04-15 00:00:00'</font> (length=19) <br> <font color="#0000ff">public</font> <font color="#A31515">'timezone_type'</font> =&gt; <font color="#0000ff">int</font> 3 <br> <font color="#0000ff">public</font> <font color="#A31515">'timezone'</font> =&gt; <font color="#0000ff">string</font> <font color="#A31515">'Europe/Moscow'</font> (length=13) <br> <font color="#0000ff">private</font> <font color="#A31515">'somecontent'</font> =&gt; <font color="#0000ff">string</font> <font color="#A31515">'test 15'</font> (length=7) <br> 2 =&gt; <br> <font color="#0000ff">object</font> (Model\Entity\PublisherDailyStatistic)[398] <br> <font color="#0000ff">private</font> <font color="#A31515">'publisherid'</font> =&gt; <font color="#0000ff">int</font> 1 <br> <font color="#0000ff">private</font> <font color="#A31515">'statisticdt'</font> =&gt; <br> <font color="#0000ff">object</font> ( <font color="#2B91AF">DateTime</font> )[381] <br> <font color="#0000ff">public</font> <font color="#A31515">'date'</font> =&gt; <font color="#0000ff">string</font> <font color="#A31515">'2012-04-15 00:00:00'</font> (length=19) <br> <font color="#0000ff">public</font> <font color="#A31515">'timezone_type'</font> =&gt; <font color="#0000ff">int</font> 3 <br> <font color="#0000ff">public</font> <font color="#A31515">'timezone'</font> =&gt; <font color="#0000ff">string</font> <font color="#A31515">'Europe/Moscow'</font> (length=13) <br> <font color="#0000ff">private</font> <font color="#A31515">'somecontent'</font> =&gt; <font color="#0000ff">string</font> <font color="#A31515">'test 15'</font> (length=7)</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Suddenly, right? <br>  Moreover, if we change ‚Äúreturn $ qb-&gt; getQuery () -&gt; getResult ();‚Äù to ‚Äúreturn $ qb-&gt; getQuery () -&gt; getArrayResult ();‚Äù, we get: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">array (size=3) <br> 0 =&gt; <br> array (size=3) <br> <font color="#A31515">'publisherid'</font> =&gt; <font color="#0000ff">int</font> 1 <br> <font color="#A31515">'statisticdt'</font> =&gt; <br> <font color="#0000ff">object</font> ( <font color="#2B91AF">DateTime</font> )[384] <br> <font color="#0000ff">public</font> <font color="#A31515">'date'</font> =&gt; <font color="#0000ff">string</font> <font color="#A31515">'2012-04-15 00:00:00'</font> (length=19) <br> <font color="#0000ff">public</font> <font color="#A31515">'timezone_type'</font> =&gt; <font color="#0000ff">int</font> 3 <br> <font color="#0000ff">public</font> <font color="#A31515">'timezone'</font> =&gt; <font color="#0000ff">string</font> <font color="#A31515">'Europe/Moscow'</font> (length=13) <br> <font color="#A31515">'somecontent'</font> =&gt; <font color="#0000ff">string</font> <font color="#A31515">'test 15'</font> (length=7) <br> 1 =&gt; <br> array (size=3) <br> <font color="#A31515">'publisherid'</font> =&gt; <font color="#0000ff">int</font> 1 <br> <font color="#A31515">'statisticdt'</font> =&gt; <br> <font color="#0000ff">object</font> ( <font color="#2B91AF">DateTime</font> )[384] <br> <font color="#0000ff">public</font> <font color="#A31515">'date'</font> =&gt; <font color="#0000ff">string</font> <font color="#A31515">'2012-04-16 00:00:00'</font> (length=19) <br> <font color="#0000ff">public</font> <font color="#A31515">'timezone_type'</font> =&gt; <font color="#0000ff">int</font> 3 <br> <font color="#0000ff">public</font> <font color="#A31515">'timezone'</font> =&gt; <font color="#0000ff">string</font> <font color="#A31515">'Europe/Moscow'</font> (length=13) <br> <font color="#A31515">'somecontent'</font> =&gt; <font color="#0000ff">string</font> <font color="#A31515">'test 16'</font> (length=7) <br> 2 =&gt; <br> array (size=3) <br> <font color="#A31515">'publisherid'</font> =&gt; <font color="#0000ff">int</font> 1 <br> <font color="#A31515">'statisticdt'</font> =&gt; <br> <font color="#0000ff">object</font> ( <font color="#2B91AF">DateTime</font> )[384] <br> <font color="#0000ff">public</font> <font color="#A31515">'date'</font> =&gt; <font color="#0000ff">string</font> <font color="#A31515">'2012-04-17 00:00:00'</font> (length=19) <br> <font color="#0000ff">public</font> <font color="#A31515">'timezone_type'</font> =&gt; <font color="#0000ff">int</font> 3 <br> <font color="#0000ff">public</font> <font color="#A31515">'timezone'</font> =&gt; <font color="#0000ff">string</font> <font color="#A31515">'Europe/Moscow'</font> (length=13) <br> <font color="#A31515">'somecontent'</font> =&gt; <font color="#0000ff">string</font> <font color="#A31515">'test 17'</font> (length=7)</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  That is, correct data. <br><br><h3>  Solution to the problem </h3><br>  I began to understand what the problem was, and at first I sinned on the ‚ÄúPublisherDailyStatistic‚Äù object descriptions I created, but after my question on <a href="http://stackoverflow.com/questions/10121066/doctrine2-getresult-duplicate-objects">http://stackoverflow.com</a> was left unanswered, I began to look for an error in Doctrine code. <br>  And I found it in the ‚ÄúcreateEntity‚Äù function of the ‚ÄúUnitOfWork‚Äù class.  There is the following code: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">if</font> ($ <font color="#0000ff">class</font> -&gt;isIdentifierComposite) { <br> $id = array(); <br> <br> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">class</font> -&gt;identifier <font color="#0000ff">as</font> $fieldName) { <br> $id[$fieldName] = isset($ <font color="#0000ff">class</font> -&gt;associationMappings[$fieldName]) <br> ? $data[$ <font color="#0000ff">class</font> -&gt;associationMappings[$fieldName][ <font color="#A31515">'joinColumns'</font> ][0][ <font color="#A31515">'name'</font> ]] <br> : $data[$fieldName]; <br> } <br> <br> $idHash = implode( <font color="#A31515">' '</font> , $id); <br> } <font color="#0000ff">else</font> { <br> $idHash = isset($ <font color="#0000ff">class</font> -&gt;associationMappings[$ <font color="#0000ff">class</font> -&gt;identifier[0]]) <br> ? $data[$ <font color="#0000ff">class</font> -&gt;associationMappings[$ <font color="#0000ff">class</font> -&gt;identifier[0]][ <font color="#A31515">'joinColumns'</font> ][0][ <font color="#A31515">'name'</font> ]] <br> : $data[$ <font color="#0000ff">class</font> -&gt;identifier[0]]; <br> <br> $id = array($ <font color="#0000ff">class</font> -&gt;identifier[0] =&gt; $idHash); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  In our case, the error appears in the first part of the if operator (since, we have a composite key, but there is an error in the second part).  As we can see, the code goes through all the keys of the table, and the data of these keys are added to the $ id array, and then the string $ idHash is formed from this data, through the usual ‚Äúimplode‚Äù.  Later, by the value of $ idHash, it is determined whether such data was encountered when creating an object earlier (because two objects with the same key are the same object). Here, then everything breaks down, since in our case, as a result of the implode function, we get the same $ idHash for all strings, in our case ‚Äú1‚Äù. <br>  This is because implode ignores the DateTime object (like any other objects that do not have the __toString () magic function). <br>  I wrote to developers about this bug in their <a href="http://www.doctrine-project.org/jira/browse/DDC-1780%3Fpage%3Dcom.atlassian.jira.plugin.system.issuetabpanels%253Acomment-tabpanel">bugtracker</a> . <br>  In the meantime, you can easily correct this error in your project by adding a verification line to the loop: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">if</font> ($id[$fieldName] instanceof \ <font color="#2B91AF">DateTime</font> ) <br> { <br> $id[$fieldName] = $id[$fieldName]-&gt;getTimestamp(); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  This is my first article on Habr√©, please do not judge strictly, I will take into account all comments. <br>  And sorry for having written so much text about such a small mistake. </div><p>Source: <a href="https://habr.com/ru/post/142221/">https://habr.com/ru/post/142221/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../142213/index.html">Open Source Photo Realism on GPU: Cycles Render</a></li>
<li><a href="../142215/index.html">Personal account for the wholesale company. Is it really that hard?</a></li>
<li><a href="../142217/index.html">Google-sponsored research struggles with fake reviews</a></li>
<li><a href="../142218/index.html">Cluster? Easy!</a></li>
<li><a href="../142219/index.html">The relevance of SMBRelay attacks in modern Windows networks</a></li>
<li><a href="../142222/index.html">Yandex.Money takes to the streets!</a></li>
<li><a href="../142225/index.html">The launch of Google Drive will take place in a week. All for 5 GB for free</a></li>
<li><a href="../142226/index.html">ASUS U24E Ultraportable Notebook Review</a></li>
<li><a href="../142227/index.html">Installing Joomla CMS via Windows Web Platform Installer</a></li>
<li><a href="../142228/index.html">Issue with Evernote E-mail Addresses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>