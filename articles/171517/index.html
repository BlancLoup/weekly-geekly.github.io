<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write our extension for the browser Mozilla Firefox</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, after upgrading Firefox to version 19 , the beloved Yandex-Bar extension completely fell off. I will not forget to remind you that Yandex.Bar was ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write our extension for the browser Mozilla Firefox</h1><div class="post__text post__text-html js-mediator-article">  So, after upgrading <a href="http://habrahabr.ru/post/169989/">Firefox to</a> version <a href="http://habrahabr.ru/post/169989/">19</a> , the beloved Yandex-Bar extension completely fell off.  I will not forget to remind you that Yandex.Bar was replaced by <a href="http://habrahabr.ru/company/yandex/blog/146618/">Yandex.Ilements</a> that liked a little more than anybody, and therefore received their well-deserved <a href="https://addons.mozilla.org/ru/firefox/addon/yandexbar/">2 points out of 5</a> . <br><br>  Why did not like?  Replaced the address bar, it became inconvenient to view the mail, replaced the bookmarks and removed the address bar corrector (under the pretext of installing Punto Switcher, which can be good for the average employee, but not for the programmer. Therefore, it was removed almost immediately as installed. Yes and if it could be customized, then all the same the desire was gone). <br><br>  A little later, it was decided to create its own similar extension, which will include such buns as viewing mail and address line corrector.  Well, if not you, so who else? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  First of all, it was decided not to create your own bike and resurrect Yandeks.Bar, which did not want to work in the 19 version of the browser.  On the Internet, it was suggested that the extension is a regular zip archive.  Opened, looked, were horrified and closed.  It was not possible to resurrect, even with all the desire. <br><br>  Then go to the developer center: <a href="https://builder.addons.mozilla.org/">builder.addons.mozilla.org</a> .  I chose to work in a web editor, although sometimes it sometimes did not work very smoothly.  Having looked at other extensions, having borrowed the code and having a little understood the whole meaning of sowing the device, it all started first with the smashing machine and ended with a file. <br><br>  The builder includes 3 sections: this is the section with scripts (Lib), the section with downloadable content (images, styles and scripts) and the section with ready-made libraries (Libraries) <br><br>  By the way, here is the documentation: <a href="https://addons.mozilla.org/en-US/developers/docs/sdk/latest/">addons.mozilla.org/en-US/developers/docs/sdk/latest</a> , well written. <br>  The start of the extension starts with loading the <b>main.js</b> file. <br>  Called function: <b>exports.main</b> . <br><br>  An example of the main.js file: <br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tabs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"tabs"</span></span>); exports.main = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">) </span></span>{ tabs.on(<span class="hljs-string"><span class="hljs-string">"ready"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tab</span></span></span><span class="hljs-function">)</span></span>{ tab.attach({ <span class="hljs-attr"><span class="hljs-attr">contentScript</span></span>: <span class="hljs-string"><span class="hljs-string">"document.addEventListener('click', function(e) { \ var target = e.target; \ if(target.tagName == 'A') { \ var mail_to = target.href.match(/^mailto:(.*)/i); \ if(mail_to != null) { \ e.preventDefault(); \ var form = document.createElement('form'); \ form.setAttribute('action','http://mail.yandex.ru/neo2/#compose/mailto=' + mail_to[1]); \ form.setAttribute('target','_blank'); \ document.getElementsByTagName('body')[0].appendChild(form); \ form.submit(); \ form.parentNode.removeChild(form); \ } \ } \ }, false);"</span></span> }); }); }</code> </pre> <br>  What kind of magic happens in this code? <br><br>  First of all, the <b><a href="https://addons.mozilla.org/en-US/developers/docs/sdk/latest/modules/sdk/tabs.html">tabs</a></b> module is connected. <br>  In this case, it serves to add your JavaScript code to the browser page. <br>  Those.  what we have: during the onready document event, any JavaScript code is added to the document body.  In this example, a handler is added for links whose address begins with <u>mailto</u> . <br><br>  Okay, let's do something more complicated.  Add your button to the top bar! <br>  Again, we will not build bicycles, but with a clear conscience, take the ready-made library <a href="https://builder.addons.mozilla.org/package/166563/"><b>Toolbar Button Complete</b></a> . <br><br>  It also has an example of adding a button to the browser bar.  I think you should not dump it here, because  there is a bit of code. <br>  So, there is a button, the icon has been installed, everything seems to be fine, but not very.  How did we have in Yandex.Bar?  Oh yeah, opposite the icon also the counter of unread messages was. <br>  Here I found out several ways to add a counter: <br><ul><li>  versatile but lighter (with styles) </li><li>  not very versatile, but not as simple as the first (using canvas) </li></ul><br>  The second method, however, was found by typing on the Internet.  But I took the first one. <br>  We know that the top bar is the same set of elements with its classes, identifiers, properties and ways of working with them. <br><br>  Type tyke method: <pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> val <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'yandex-menu'</span></span>)) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(val); }</code> </pre><br>  it was found that the methods are exactly the same as those we usually use when working with elements of the site.  But I note that according to the standard, the browser does not know what neither <b>document</b> nor <b>window is</b> in extensions (and there are still differences). <br><br>  Solution example: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wuntils = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'sdk/window/utils'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">window</span></span> = wuntils.getMostRecentBrowserWindow(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">document</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.document;</code> </pre><br>  I note that the development of the builder does not stand still, and if earlier the way to get the active window <a href="https://addons.mozilla.org/en-US/developers/docs/sdk/latest/modules/sdk/deprecated/window-utils.html">was</a> : <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> winUtils = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"window-utils"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">window</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> winUtils.windowIterator()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"chrome://browser/content/browser.xul"</span></span> != <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"An open window! "</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location); }</code> </pre>  now everything is much easier (I cited the example above). <br><br>  Well, having a little talked about the features, I will return to adding the counter for the button. <br>  Smart people suggested that, according to the standard, the style of the <b>label</b> field of a button is <b>display: none;</b>  , so somehow it was necessary to inject your <b>css</b> code into the bar.  The solution, as it turned out, is not difficult (I advise you to wrap it in a file that will be included as needed): <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Cc, Ci } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'chrome'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-attr"><span class="hljs-attr">when</span></span>: unload } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'sdk/system/unload'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ios = Cc[<span class="hljs-string"><span class="hljs-string">'@mozilla.org/network/io-service;1'</span></span>].getService(Ci.nsIIOService); <span class="hljs-comment"><span class="hljs-comment">/* Helper that registers style sheets and remembers to unregister on unload */</span></span> exports.addXULStylesheet = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addXULStylesheet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> uri = newURI(url); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sss = Cc[<span class="hljs-string"><span class="hljs-string">"@mozilla.org/content/style-sheet-service;1"</span></span>].getService(Ci.nsIStyleSheetService); sss.loadAndRegisterSheet(uri, sss.USER_SHEET); unload(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sss.sheetRegistered(uri, sss.USER_SHEET)) { sss.unregisterSheet(uri, sss.USER_SHEET); } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sss; }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newURI</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">uriStr, base</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> baseURI = base ? ios.newURI(base, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>) : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ios.newURI(uriStr, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, baseURI); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.result === chrome.Cr.NS_ERROR_MALFORMED_URI) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">"malformed URI: "</span></span> + uriStr); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.result === chrome.Cr.NS_ERROR_FAILURE || e.result === chrome.Cr.NS_ERROR_ILLEGAL_VALUE) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">"invalid URI: "</span></span> + uriStr); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre><br><br>  And <b>we</b> add something like to the <b>exprorts.main</b> function (although you can add it anywhere): <br><pre> <code class="javascript hljs">stylesheet.addXULStylesheet(data.url(<span class="hljs-string"><span class="hljs-string">"stylesheet.css"</span></span>));</code> </pre><br>  Do not forget to create in the content file <b>stylesheet.css</b> . <br><br>  My file contains something like the following: <br><pre> <code class="css hljs"><span class="hljs-selector-id"><span class="hljs-selector-id">#yandex-mail</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">min-width</span></span>: <span class="hljs-number"><span class="hljs-number">16px</span></span>; } <span class="hljs-selector-id"><span class="hljs-selector-id">#yandex-mail</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.toolbarbutton-text</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">float</span></span>: right <span class="hljs-meta"><span class="hljs-meta">!important</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">display</span></span>: inline-block <span class="hljs-meta"><span class="hljs-meta">!important</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">font-size</span></span>: <span class="hljs-number"><span class="hljs-number">13px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding-left</span></span>:<span class="hljs-number"><span class="hljs-number">20px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">background</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">url</span></span>(data:image/png;base64,iVB.............OCYII=) no-repeat left center; } <span class="hljs-selector-id"><span class="hljs-selector-id">#yandex-mail</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.toolbarbutton-icon</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">display</span></span>: none; }</code> </pre><br>  Why do we hide the icon and add a background?  This is because if this is not done, the blocks are always displayed as <b>display: block</b> , no matter what values ‚Äã‚ÄãI put up (by the way, can anyone know about this topic?) Therefore, you have to be so cunning. <br><br>  Also faced with the issue of downloading content from other sites and parsing xml. <br>  With the first quickly figured out, do not go far: <a href="https://addons.mozilla.org/en-US/developers/docs/sdk/latest/modules/sdk/request.html">Request</a> <br>  But with the second had to tinker. <br><br>  As we know, you can get a <b>dom xml</b> document using several functions: <br><ul><li>  <b>XMLHttpRequest</b> - dropped, because  gave a cross-domain query error (maybe I did something wrong?) </li><li>  <b>DOMParser</b> - but here, too, had to tinker </li></ul><br>  What actually fuss: as with getting a <b>window</b> , so here: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> {Cc, Ci} = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"chrome"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parser = Cc[<span class="hljs-string"><span class="hljs-string">"@mozilla.org/xmlextras/domparser;1"</span></span>].createInstance(Ci.nsIDOMParser); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dom = parser.parseFromString(xmlPrepare (text), <span class="hljs-string"><span class="hljs-string">"application/xml"</span></span>);</code> </pre><br><br>  This is how creating extensions for Firefox is no different from creating plugins for jQuery :) <br><br>  By the way, the final creation to this day: <a href="https://addons.mozilla.org/ru/firefox/addon/customyandexbar/">CustomYandexBar</a> , while it is being tested.  <a href="https://builder.addons.mozilla.org/package/174709/latest/">Sources</a> , they have a lot of useful things. <br><br>  If someone doesn‚Äôt like it, I‚Äôm using ‚Äútheir‚Äù pictures, brand or the like.  - write. </div><p>Source: <a href="https://habr.com/ru/post/171517/">https://habr.com/ru/post/171517/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../171503/index.html">How we use Trello and Google Docs to continuously improve UserVoice</a></li>
<li><a href="../171505/index.html">Browser is cheaper than traffic lights</a></li>
<li><a href="../171511/index.html">Are you already reading the lesswrong.com rationality blog?</a></li>
<li><a href="../171513/index.html">The history of the development of design methodologies (software engineering)</a></li>
<li><a href="../171515/index.html">Mail.Ru Group Technology Forum: v5.0</a></li>
<li><a href="../171519/index.html">We load a lot of CSS for IE in development mode</a></li>
<li><a href="../171521/index.html">Maptrix geolocation application: developer explanation</a></li>
<li><a href="../171523/index.html">The combination of geolocation service and social network</a></li>
<li><a href="../171525/index.html">Ethernet weather station</a></li>
<li><a href="../171529/index.html">Hack searching the shortest path in starcraft</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>