<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing Zabbix 2.4 on RedHat Openshift</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I needed my own ‚Äúcloud‚Äù monitoring server with a budget of 0 rubles. As a solution, zabbix was chosen on the openshift platform. This option...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing Zabbix 2.4 on RedHat Openshift</h1><div class="post__text post__text-html js-mediator-article">  Recently, I needed my own ‚Äúcloud‚Äù monitoring server with a budget of 0 rubles.  As a solution, zabbix was chosen on the openshift platform.  This option is suitable for backup basic monitoring or monitoring a small portal with the help of web-scenarios and custom scripts via UserParameter. <br><br>  I decided to share this experiment with the community, including with the aim of receiving constructive criticism. <br><a name="habracut"></a><br>  First of all, of course, you need to register for <a href="https://openshift.redhat.com/">openshift</a> .  For zabbix to work, you need an application with a set of mysql and crontab cartridges.  It looks something like this: <br><br><img src="https://habrastorage.org/files/e0f/865/7ec/e0f8657ec8234b65a609105eea0bc072.PNG">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      You can also take a line to connect to the openshift server by clicking on ‚ÄúWant to log in your application?‚Äù.  You need to place your public ssh <a href="https://openshift.redhat.com/app/console/settings">key in the</a> openshift <a href="https://openshift.redhat.com/app/console/settings">public key</a> storage. <br><br>  Download the latest version of zabbix from the <a href="http://www.zabbix.com/ru/download.php">official site</a> .  On the openshift server, we create a directory for assembling zabbix executable files, upload the sources, unpack and compile: <br><br><pre><code class="bash hljs">]\&gt;mkdir -p /tmp/BUILD ; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /tmp/BUILD ; wget http://downloads.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/2.4.6/zabbix-2.4.6.tar.gz ; tar xf zabbix-2.4.6.tar.gz ; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> zabbix-2.4.6 ; &gt; mkdir /var/lib/openshift/<span class="hljs-variable"><span class="hljs-variable">$OPENSHIFT_APP_UUID</span></span>/app-root/data/zabbix ]\&gt;./configure --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-server --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-java --with-mysql --with-libcurl --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-agent --with-ssh2 --prefix=/var/lib/openshift/<span class="hljs-variable"><span class="hljs-variable">$OPENSHIFT_APP_UUID</span></span>/app-root/data/zabbix ]\&gt; make ]\&gt; make install</code> </pre> <br>  We configure the server and the agent for work in the openshift environment.  Here it will be necessary in the configuration file to replace $ OPENSHIFT_APP_UUID and $ OPENSHIFT_PHP_IP with the corresponding application: <br><pre> <code class="bash hljs">]\&gt; <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> | grep OPENSHIFT_PHP_IP <span class="hljs-built_in"><span class="hljs-built_in">declare</span></span> -x OPENSHIFT_PHP_IP=<span class="hljs-string"><span class="hljs-string">"127.13.151.129"</span></span> ]\&gt; <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> | grep OPENSHIFT_APP_UUID <span class="hljs-built_in"><span class="hljs-built_in">declare</span></span> -x OPENSHIFT_APP_UUID=<span class="hljs-string"><span class="hljs-string">"55e9bc400c1e66a589000029"</span></span> ]\&gt;vi /var/lib/openshift/<span class="hljs-variable"><span class="hljs-variable">$OPENSHIFT_APP_UUID</span></span>/app-root/data/zabbix/etc/zabbix_server.conf ListenIP=<span class="hljs-variable"><span class="hljs-variable">$OPENSHIFT_PHP_IP</span></span> ListenPort=30051 LogFile=/tmp/zabbix_server.log LogFileSize=5 DebugLevel=3 PidFile=/tmp/zabbix_server.pid DBHost=localhost DBName=zabbix <span class="hljs-comment"><span class="hljs-comment">#DBSchema=zabbix DBUser=zabbix DBPassword=&lt;&gt; DBSocket=/var/lib/openshift/$OPENSHIFT_APP_UUID/mysql/socket/mysql.sock ]\&gt;vi /var/lib/openshift/$OPENSHIFT_APP_UUID/app-root/data/zabbix/etc/zabbix_agentd.conf PidFile=/tmp/zabbix_agentd.pid LogFile=/tmp/zabbix_agentd.log LogFileSize=5 DebugLevel=3 Server=127.13.151.129 ServerActive=127.13.151.129:30051 ListenPort=30050 ListenIP=127.13.151.129 StartAgents=3 Hostname=Zabbix server</span></span></code> </pre><br>  Run to check: <br><br><pre> <code class="bash hljs">/var/lib/openshift/<span class="hljs-variable"><span class="hljs-variable">$OPENSHIFT_APP_UUID</span></span>/app-root/data/zabbix/sbin/zabbix_server -c /var/lib/openshift/<span class="hljs-variable"><span class="hljs-variable">$OPENSHIFT_APP_UUID</span></span>/app-root/data/zabbix/etc/zabbix_server.conf /var/lib/openshift/<span class="hljs-variable"><span class="hljs-variable">$OPENSHIFT_APP_UUID</span></span>/app-root/data/zabbix/sbin/zabbix_agentd -c /var/lib/openshift/<span class="hljs-variable"><span class="hljs-variable">$OPENSHIFT_APP_UUID</span></span>/app-root/data/zabbix/etc/zabbix_agentd.conf</code> </pre><br>  Look in the logs: <br><br><pre> <code class="bash hljs">[zabbix-chinacoolhacker.rhcloud.com zabbix]\&gt; tail -3 /tmp/zabbix_server.log 82320:20150904:153339.334 server <span class="hljs-comment"><span class="hljs-comment">#24 started [escalator #1] 82321:20150904:153339.334 server #25 started [proxy poller #1] 82323:20150904:153339.335 server #26 started [self-monitoring #1] [zabbix-chinacoolhacker.rhcloud.com zabbix]\&gt; tail -2 /tmp/zabbix_agentd.log 111422:20150904:154248.644 agent #4 started [listener #3] 111423:20150904:154248.644 agent #5 started [active checks #1]</span></span></code> </pre><br>  The executable code works, you can go to the front end. <br><br>  Then I decided to use the openshift built-in functionality - deploy via git.  I cloned myself on the local site ‚Äúblank‚Äù site: <br><br><pre> <code class="bash hljs">% git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> ssh://55e9bc400c1e66a589000029@zabbix-chinacoolhacker.rhcloud.com/~/git/zabbix.git/</code> </pre><br>  There are 2 options for setting the front end of zabbix-by editing the config and through a convenient gui.  Both options are working, but at restart we risk losing changes made in addition to the gita - so I‚Äôm doing through the config, it‚Äôs not difficult.  Copied the contents of the front-end from the archive zabbix.  I delete setup.php so that the attackers could not make changes to my installation and edit the config to suit my needs: <br><br><pre> <code class="bash hljs">c@pentahon:~/ZABBIX/zabbix % rm -f setup.php c@pentahon:~/ZABBIX/zabbix % <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> conf c@pentahon:~/ZABBIX/zabbix/conf % mv zabbix.conf.php.example zabbix.conf.php c@pentahon:~/ZABBIX/zabbix/conf % vi zabbix.conf.php // Zabbix GUI configuration file. global <span class="hljs-variable"><span class="hljs-variable">$DB</span></span>; <span class="hljs-variable"><span class="hljs-variable">$DB</span></span>[<span class="hljs-string"><span class="hljs-string">"TYPE"</span></span>] = <span class="hljs-string"><span class="hljs-string">'MYSQL'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$DB</span></span>[<span class="hljs-string"><span class="hljs-string">"SERVER"</span></span>] = <span class="hljs-string"><span class="hljs-string">'localhost'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$DB</span></span>[<span class="hljs-string"><span class="hljs-string">"PORT"</span></span>] = <span class="hljs-string"><span class="hljs-string">'0'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$DB</span></span>[<span class="hljs-string"><span class="hljs-string">"DATABASE"</span></span>] = <span class="hljs-string"><span class="hljs-string">'zabbix'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$DB</span></span>[<span class="hljs-string"><span class="hljs-string">"USER"</span></span>] = <span class="hljs-string"><span class="hljs-string">'zabbix'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$DB</span></span>[<span class="hljs-string"><span class="hljs-string">"PASSWORD"</span></span>] = <span class="hljs-string"><span class="hljs-string">'oDWp7akWrxWiMAIRCoYJ'</span></span>; // Schema name. Used <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> IBM DB2 and PostgreSQL. <span class="hljs-variable"><span class="hljs-variable">$DB</span></span>[<span class="hljs-string"><span class="hljs-string">"SCHEMA"</span></span>] = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-variable"><span class="hljs-variable">$ZBX_SERVER</span></span> = <span class="hljs-string"><span class="hljs-string">'127.13.151.129'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$ZBX_SERVER_PORT</span></span> = <span class="hljs-string"><span class="hljs-string">'30051'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$ZBX_SERVER_NAME</span></span> = <span class="hljs-string"><span class="hljs-string">'Overseer'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$IMAGE_FORMAT_DEFAULT</span></span> = IMAGE_FORMAT_PNG; ?&gt;</code> </pre><br>  Create .htaccess in the root of the site: <br><br><pre> <code class="bash hljs">c@pentahon:~/ZABBIX/zabbix/conf % <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> .. c@pentahon:~/ZABBIX/zabbix % vi .htaccess php_value upload_max_filesize 20M php_value date.timezone Europe/Moscow php_value post_max_size 20M php_value max_execution_time 300 php_value max_input_time 300 php_value max_input_time 300 php_value mysql.default_socket <span class="hljs-string"><span class="hljs-string">"/var/lib/stickshift/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$OPENSHIFT_APP_UUID</span></span></span><span class="hljs-string">/mysql-5.1/socket/mysql.sock"</span></span></code> </pre><br>  All in git! <br><br><pre> <code class="bash hljs">git add * git add .htaccess git commit -m <span class="hljs-string"><span class="hljs-string">"zabb"</span></span> git push</code> </pre><br>  After a successful push, you can enter the web interface (login \ password is admin \ zabbix, do not forget to change it!) And set up monitoring: <br><br><img src="https://habrastorage.org/files/7b9/1c3/90c/7b91c390c44642e5bc6dd0b08a61f0b4.PNG"><br><br>  In order for the agent to work and metrics to start gathering, you need to change the ip and port settings: <br><br><img src="https://habrastorage.org/files/d62/eef/4c1/d62eef4c121d4d26bc2469de40fe1a95.PNG"><br><br>  Now you need to add several tasks to cron - to restart the server and agent applications if they fail.  Crontab is located at /var/lib/openshift/55e9bc400c1e66a589000029/app-root/runtime/repo/.openshift/cron.  Create files: <br><br><pre> <code class="bash hljs">mkdir /tmp/status ]\&gt; vi minutely/zabbixwatchog.sh <span class="hljs-comment"><span class="hljs-comment">#!/bin/bash ### config pidof_prog="/sbin/pidof" ### zabbix_agentd_prog=/var/lib/openshift/$OPENSHIFT_APP_UUID/app-root/data/zabbix/sbin/zabbix_agentd zabbix_agentd_conf=/var/lib/openshift/$OPENSHIFT_APP_UUID/app-root/data/zabbix/etc/zabbix_agentd.conf zabbix_server_prog=/var/lib/openshift/$OPENSHIFT_APP_UUID/app-root/data/zabbix/sbin/zabbix_server zabbix_server_conf=/var/lib/openshift/$OPENSHIFT_APP_UUID/app-root/data/zabbix/etc/zabbix_server.conf ### agentstatlog=/tmp/status/agentstat.log serverstatlog=/tmp/status/serverstat.log ### ### server lifekeeper ### serverststat=`$pidof_prog $zabbix_server_prog` if [ "$serverststat" ] then echo "`date` : server pids: $serverststat" &gt;&gt; $serverstatlog; else echo "restarting server at `date`" &gt;&gt; $serverstatlog; $zabbix_server_prog -c $zabbix_server_conf; sleep 3 echo "`date` SERVER started with pids: `$pidof_prog $zabbix_server_prog` " &gt;&gt; $serverstatlog; fi ### agent lifekeeper ### agentstat=`$pidof_prog $zabbix_agentd_prog` if [ "$agentstat" ] then echo "`date` : agent pids: $agentstat" &gt;&gt; $agentstatlog; else echo "restarting agent at `date`" &gt;&gt; $agentstatlog; $zabbix_agentd_prog -c $zabbix_agentd_conf; sleep 3 echo "`date` agent started with pids: `$pidof_prog $zabbix_agentd_prog` " &gt;&gt; $agentstatlog; fi # ]\&gt; vi daily/zabbix.sh #!/bin/bash cp /tmp/status/agentstat.log /tmp/status/agentstat.log.`date +%Y-%m-%d` &amp;&amp; echo '' &gt; /tmp/status/agentstat.log cp /tmp/status/serverstat.log /tmp/status/serverstat.log.`date +%Y-%m-%d` &amp;&amp; echo '' &gt; /tmp/status/serverstat.log find /tmp/status/ -mtime +7 -exec rm {} \;</span></span></code> </pre><br>  Now, if there are no zabbix processes in the system, they will automatically start at the crown. <br><br>  PS <br>  This installation is well suited for web-scenarios and custom checks based on UserParamater, launched from an agent directly installed on the OpenShift server. <br>  As <a href="https://habr.com/ru/users/disen/" class="user_link">Disen</a> correctly noted, for security reasons, it is <b>not recommended to</b> put the zabbix-agent ports of your servers on the Internet! </div><p>Source: <a href="https://habr.com/ru/post/266327/">https://habr.com/ru/post/266327/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266317/index.html">Redirecting data from a COM port to the web. Revision</a></li>
<li><a href="../266319/index.html">Visualization of the job market with R</a></li>
<li><a href="../266321/index.html">The storage of research results by the method of radiology</a></li>
<li><a href="../266323/index.html">Security on trust</a></li>
<li><a href="../266325/index.html">Hidden bug (feature?) Switch ZyXEL ES-2108-G</a></li>
<li><a href="../266329/index.html">RailsClub 2015: Interview with Cyrus Shatrov</a></li>
<li><a href="../266331/index.html">Launch of RAD Studio 10 Seattle in Moscow and Almaty</a></li>
<li><a href="../266335/index.html">Examples of classic code that has become open source</a></li>
<li><a href="../266337/index.html">Bleed TinyMCE 4</a></li>
<li><a href="../266339/index.html">How I tried to make friends with Google API with CodeIgniter A3M and what came of it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>