<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Facing refucktoring</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The story of one refactoring, or the tale of how not to develop in PHP ... 

 It all started as always, from somewhere the customer appears all in tea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Facing refucktoring</h1><div class="post__text post__text-html js-mediator-article"> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/56c/efd/b88/56cefdb8829485cdb5d9aa0178958cf2.jpg" title="Mission impossible" width="451" height="323"></a> <br><br>  The story of one refactoring, or the tale of how not to develop in PHP ... <br><a name="habracut"></a><br>  It all started as always, from somewhere the customer appears all in tears and trance, yelling not in his own voice: ‚ÄúSave, help, my project slows down, users run from me.  You have a week ... " <br><br>  We deployed a project on our server - n-yes ... Then there was an analysis of this ‚ÄúQ‚Äù creation (those who <a href="http://twitter.com/AntonShevchuk">follow me</a> know what kind of Ukrainian company we are talking about), laughter through tears, and hysterics during the week.  Well, for starters, XDEBUG was taken and looked at what was there and how (clickable): <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/134/02c/3db/13402c3db3b31d1263242790b39c53bc.png" title="Splash screen" width="720" height="375"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote>  Such a cool thing draws <a href="http://code.google.com/p/webgrind/">Webgrind</a> , conveniently and clearly </blockquote><br><br>  Those.  We have a page that displays a greeting + language selection + selection of a category for viewing (hard by the way) generated in 4.6 seconds on a server with a Core2 Quad CPU Q6600@2.40GHz/16Gb (hysteria and rays of hate to the Q office). <br><br>  Much more terrible picture awaited us on the main page: <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/899/d31/e09/899d31e09038c2b822817ca874b3c907.png" title="Main Page" width="720" height="155"></a> <br><br>  Before applying Zend Framework, we were separated by a few more weeks of optimizing the g ... code ... <br><br><h3>  FastTemplate such ‚ÄúFast‚Äù </h3><br><br>  If you take a <em>closer</em> look, then on the previous screen you can see that a certain function <em>parse_body is</em> very expensive for us: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/505/146/224/50514622470c3529cb75d26780ef2c77.png" title="Main Page and FastTemplate" width="720" height="458"></a> <br><br>  Inside waiting for us: <br><br><ul><li>  call strtoupper - 56560 times </li><li>  call str_replace - 56560 times </li></ul><br><br>  We look at the code: <br><blockquote>  <font color="#666666">// $ content - template</font> <br>  <font color="#666666">// $ rec - variables</font> <br>  <font color="#000088">$ content</font> <font color="#339933">=</font> <font color="#990000">preg_replace</font> <font color="#009900">(</font> <font color="#0000ff">"/ <font color="#000099">\\</font> $ ([AZ] [A-Z0-9 _] +) /"</font> <font color="#339933">,</font> <font color="#0000ff">"@ <font color="#000099">\\</font> 1 @"</font> <font color="#339933">,</font> <font color="#000088">$ content</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#990000">is_array</font> <font color="#009900">(</font> <font color="#000088">$ rec</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">foreach</font> <font color="#009900">(</font> <font color="#000088">$ rec</font> <font color="#b1b100">as</font> <font color="#000088">$ key</font> <font color="#339933">=&gt;</font> <font color="#000088">$ value</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000088">$ name</font> <font color="#339933">=</font> <font color="#990000">strtoupper</font> <font color="#009900">(</font> <font color="#000088">$ key</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000088">$ content</font> <font color="#339933">=</font> <font color="#990000">str_replace</font> <font color="#009900">(</font> <font color="#0000ff">"@ <font color="#006699">$ name</font> @"</font> <font color="#339933">,</font> <font color="#0000ff">" <font color="#006699">$ value</font> "</font> <font color="#339933">,</font> <font color="#0000ff">" <font color="#006699">$ content</font> "</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br>  <font color="#b1b100">return</font> <font color="#000088">$ content</font> <font color="#339933">;</font> </blockquote><br><br>  Those.  at the very beginning we are looking for something like $ HTTP_PATH in templates, we replace it with @ HTTP_PATH @, then we try to replace all known variables with enumeration.  There is one problem - we have a lot of templates, they use quite a bit of a couple of hundred variables.  A simple replacement for str_replace with preg_replace_callback gave an increase of a couple of seconds (about 10%). <br><br><h3>  Code examples </h3><br>  Nervous better to skip this paragraph. <br><br>  Classics of bad PHP code, found among Indians and our students: <br><blockquote>  <font color="#000000">function</font> n <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000000">global</font> <font color="#000088">$ db</font> <font color="#339933">,</font> <font color="#000088">$ CONSTANTS</font> <font color="#339933">,</font> <font color="#000088">$ user</font> <font color="#339933">,</font> <font color="#339933">...;</font>  <font color="#666666">// many in one word</font> <br><br>  <font color="#b1b100">echo</font> <font color="#000088">$ CONSTANTS</font> <font color="#009900">[</font> HOMEPAGE_BANNER1_ID <font color="#009900">]</font> <font color="#339933">;</font>  <font color="#666666">// think this is a constant?</font> <br>  <font color="#b1b100">echo</font> <font color="#000088">$ CONSTANTS</font> <font color="#009900">[</font> HOMEPAGE_BANNER2_ID <font color="#009900">]</font> <font color="#339933">;</font>  <font color="#666666">// do you know what's inside?</font> <br>  <font color="#b1b100">echo</font> <font color="#000088">$ CONSTANTS</font> <font color="#009900">[</font> HOMEPAGE_BANNER3_ID <font color="#009900">]</font> <font color="#339933">;</font>  <font color="#666666">// 1, 2, 3, which do not change at all where O_o is declared</font> <br>  <font color="#009900">}</font> </blockquote><br><br>  Using the file system instead of the version control system: <br><pre> tpl
 | - index.tpl
 | - index2.tpl
 | - index3.tpl
 | - index __. tpl
 `- index.44.tpl
</pre><br><br>  With the database, the same number - table categories_old, items_1, etc. <br><br><blockquote>  If a boy likes work <br>  pokes a finger in the book, <br>  write about this here: <br>  he's a good boy. </blockquote><br><br>  This, as you understand, is not about our ‚Äúboys,‚Äù our 9,000 notices have on the main one.  And only weakak use manuals: <br><blockquote>  <font color="#666666">// we do not read manuals</font> <br>  <font color="#b1b100">while</font> <font color="#009900">(</font> <font color="#000088">$ row</font> <font color="#339933">=</font> <font color="#990000">mysql_fetch_array</font> <font color="#009900">(</font> <font color="#000088">$ res</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#000088">$ row</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">foreach</font> <font color="#009900">(</font> <font color="#000088">$ row</font> <font color="#b1b100">AS</font> <font color="#000088">$ key</font> <font color="#339933">=&gt;</font> <font color="#000088">$ field</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#990000">ereg</font> <font color="#009900">(</font> <font color="#0000ff">"^ [0-9] +"</font> <font color="#339933">,</font> <font color="#000088">$ key</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#990000">unset</font> <font color="#009900">(</font> <font color="#000088">$ row</font> <font color="#009900">[</font> <font color="#000088">$ key</font> <font color="#009900">]</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br>  <font color="#000088">$ rows</font> <font color="#009900">[</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#000088">$ row</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#666666">// if you finish a little</font> <br>  <font color="#666666">// trifle, of course, but an increase of ~ 0.1 sec.</font>  <font color="#666666">23162 calls occur</font> <br>  <font color="#b1b100">while</font> <font color="#009900">(</font> <font color="#000088">$ row</font> <font color="#339933">=</font> <font color="#990000">mysql_fetch_array</font> <font color="#009900">(</font> <font color="#000088">$ res</font> <font color="#339933">,</font> MYSQL_ASSOC <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000088">$ rows</font> <font color="#009900">[</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#000088">$ row</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> </blockquote><br><br>  Further, just a brilliant decision, I didn‚Äôt master the secret meaning of this creation: <br><blockquote>  <font color="#000088">$ sqls</font> <font color="#009900">[</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#000088">$ sql</font> <font color="#339933">;</font> <br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#990000">is_array</font> <font color="#009900">(</font> <font color="#000088">$ sqls</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">foreach</font> <font color="#009900">(</font> <font color="#000088">$ sqls</font> <font color="#b1b100">AS</font> <font color="#000088">$ ssql</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#000088">$ ssql</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000088">$ res</font> <font color="#339933">=</font> <font color="#990000">mysql_db_query</font> <font color="#009900">(</font> <font color="#000088">$ db</font> <font color="#009900">[</font> <font color="#0000ff">'name'</font> <font color="#009900">]</font> <font color="#339933">,</font> <font color="#000088">$ ssql</font> <font color="#339933">,</font> <font color="#000088">$ db</font> <font color="#009900">[</font> <font color="#0000ff">'id'</font> <font color="#009900">]</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#339933">!</font> <font color="#000088">$ res</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">return</font> <font color="#cc66cc">0</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> <font color="#b1b100">else</font> <font color="#009900">{</font> <br>  <font color="#b1b100">return</font> <font color="#cc66cc">0</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> </blockquote><br><br>  Counting search results, what could be simpler: <br><blockquote>  <font color="#666666">// before the query, you can count the number of results</font> <br>  <font color="#666666">// using the db_count function (called in 96 different places)</font> <br>  <font color="#000000">function</font> db_count <font color="#009900">(</font> <font color="#000088">$ sql</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000000">global</font> <font color="#000088">$ db</font> <font color="#339933">;</font> <br>  <font color="#000088">$ res</font> <font color="#339933">=</font> <font color="#990000">mysql_db_query</font> <font color="#009900">(</font> <font color="#000088">$ db</font> <font color="#009900">[</font> <font color="#0000ff">'name'</font> <font color="#009900">]</font> <font color="#339933">,</font> <font color="#000088">$ sql</font> <font color="#339933">,</font> <font color="#000088">$ db</font> <font color="#009900">[</font> <font color="#0000ff">'id'</font> <font color="#009900">]</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#000088">$ result</font> <font color="#339933">=</font> <font color="#990000">mysql_num_rows</font> <font color="#009900">(</font> <font color="#000088">$ res</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#b1b100">return</font> <font color="#000088">$ result</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> </blockquote><br><br>  Page navigation, and this too can: <br><blockquote>  <font color="#666666">// send a query to the database</font> <br>  <font color="#000088">$ res</font> <font color="#339933">=</font> <font color="#990000">mysql_db_query</font> <font color="#009900">(</font> <font color="#000088">$ db</font> <font color="#009900">[</font> <font color="#0000ff">'name'</font> <font color="#009900">]</font> <font color="#339933">,</font> <font color="#000088">$ sql</font> <font color="#339933">,</font> <font color="#000088">$ db</font> <font color="#009900">[</font> <font color="#0000ff">'id'</font> <font color="#009900">]</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// calculate the total (although db_count has already been called before)</font> <br>  <font color="#000088">$ row_count</font> <font color="#339933">=</font> <font color="#990000">mysql_num_rows</font> <font color="#009900">(</font> <font color="#000088">$ res</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#666666">// calculate how many pages we get</font> <br>  <font color="#000088">$ page_count</font> <font color="#339933">=</font> <font color="#990000">floor</font> <font color="#009900">(</font> <font color="#000088">$ row_count</font> <font color="#339933">/</font> <font color="#000088">$ pager</font> <font color="#009900">[</font> <font color="#0000ff">'per_page'</font> <font color="#009900">]</font> <font color="#339933">+</font> <font color="#cc66cc">1</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#666666">// this is offset</font> <br>  <font color="#000088">$ bi</font> <font color="#339933">=</font> <font color="#009900">(</font> <font color="#000088">$ pos</font> <font color="#339933">-</font> <font color="#cc66cc">1</font> <font color="#009900">)</font> <font color="#339933">*</font> <font color="#000088">$ pager</font> <font color="#009900">[</font> <font color="#0000ff">'per_page'</font> <font color="#009900">]</font> <font color="#339933">;</font> <br><br>  <font color="#666666">// now select only the necessary entries</font> <br>  <font color="#b1b100">for</font> <font color="#009900">(</font> <font color="#000088">$ i</font> <font color="#339933">=</font> <font color="#000088">$ bi</font> <font color="#339933">;</font> <font color="#000088">$ i</font> <font color="#339933">&lt;</font> <font color="#000088">$ bi</font> <font color="#339933">+</font> <font color="#000088">$ pager</font> <font color="#009900">[</font> <font color="#0000ff">"per_page"</font> <font color="#009900">]</font> <font color="#339933">;</font> <font color="#000088">$ i</font> <font color="#339933">++</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#000088">$ i</font> <font color="#339933">&gt; =</font> <font color="#000088">$ row_count</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">break</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#339933">!</font> <font color="#990000">mysql_data_seek</font> <font color="#009900">(</font> <font color="#000088">$ res</font> <font color="#339933">,</font> <font color="#000088">$ i</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">break</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#339933">!</font> <font color="#009900">(</font> <font color="#000088">$ row</font> <font color="#339933">=</font> <font color="#990000">mysql_fetch_assoc</font> <font color="#009900">(</font> <font color="#000088">$ res</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">break</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#666666">// store the result</font> <br>  <font color="#000088">$ new_rows</font> <font color="#009900">[</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#000088">$ row</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> </blockquote><br><br>  String repetition - we are not looking for easy ways (str_repeat): <br><blockquote>  <font color="#666666">// in file categories.sql.php</font> <br>  <font color="#666666">// function that builds select for HTML</font> <br>  <font color="#000088">$ offset_string</font> <font color="#339933">=</font> <font color="#0000ff">''</font> <font color="#339933">;</font> <br>  <font color="#b1b100">for</font> <font color="#009900">(</font> <font color="#000088">$ i</font> <font color="#339933">=</font> <font color="#cc66cc">1</font> <font color="#339933">;</font> <font color="#000088">$ i</font> <font color="#339933">&lt;</font> <font color="#000088">$ rec</font> <font color="#009900">[</font> <font color="#0000ff">'level'</font> <font color="#009900">]</font> <font color="#339933">;</font> <font color="#000088">$ i</font> <font color="#339933">++</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000088">$ offset_string</font> <font color="#339933">. =</font> <font color="#0000ff">'&amp; nbsp; &amp; nbsp; &amp; nbsp; &amp; nbsp;'</font>  <font color="#339933">;</font> <br>  <font color="#009900">}</font> </blockquote><br><br>  If we need to cut the string into 100 characters, and at the same time not shred the words, then here is the solution: <br><blockquote>  <font color="#000088">$ data</font> <font color="#009900">[</font> <font color="#0000ff">'row'</font> <font color="#009900">]</font> <font color="#009900">[</font> <font color="#0000ff">'description'</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#990000">substr</font> <font color="#009900">(</font> <font color="#000088">$ description</font> <font color="#339933">,</font> <font color="#cc66cc">0</font> <font color="#339933">,</font> <font color="#cc66cc">100</font> <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#000088">$ i</font> <font color="#339933">=</font> <font color="#cc66cc">100</font> <font color="#339933">;</font> <br>  <font color="#b1b100">while</font> <font color="#009900">(</font> <font color="#339933">!</font> <font color="#009900">(</font> <font color="#000088">$ description</font> <font color="#009900">[</font> <font color="#000088">$ i</font> <font color="#009900">]</font> <font color="#339933">==</font> <font color="#0000ff">""</font> <font color="#339933">||</font> <font color="#000088">$ description</font> <font color="#009900">[</font> <font color="#000088">$ i</font> <font color="#009900">]</font> <font color="#339933">==</font> <font color="#0000ff">"_"</font> <font color="#009900">)</font> <font color="#339933">&amp;&amp;</font> <font color="#000088">$ i</font> <font color="#339933">&lt;</font> <font color="#990000">strlen</font> <font color="#009900">(</font> <font color="#000088">$ description</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">:</font> <br>  <font color="#000088">$ data</font> <font color="#009900">[</font> <font color="#0000ff">'row'</font> <font color="#009900">]</font> <font color="#009900">[</font> <font color="#0000ff">'description'</font> <font color="#009900">]</font> <font color="#339933">. =</font> <font color="#000088">$ description</font> <font color="#009900">[</font> <font color="#000088">$ i</font> <font color="#009900">]</font> <font color="#339933">;</font> <br>  <font color="#000088">$ i</font> <font color="#339933">++;</font> <br>  <font color="#b1b100">endwhile</font> <font color="#339933">;</font> <br><br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#000088">$ i</font> <font color="#339933">&lt;</font> <font color="#990000">strlen</font> <font color="#009900">(</font> <font color="#000088">$ description</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000088">$ data</font> <font color="#009900">[</font> <font color="#0000ff">'row'</font> <font color="#009900">]</font> <font color="#009900">[</font> <font color="#0000ff">'description'</font> <font color="#009900">]</font> <font color="#339933">. =</font> <font color="#0000ff">"..."</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> </blockquote><br><br>  We have so many global variables, of course there is $ db, and it is passed to all functions that work with the database: <br><blockquote>  <font color="#000000">function</font> db_query <font color="#009900">(</font> <font color="#000088">$ db</font> <font color="#339933">,</font> <font color="#000088">$ sql</font> <font color="#009900">)</font> <font color="#009900">{</font> <font color="#009900">}</font> <br>  <font color="#000000">function</font> db_sql_query <font color="#009900">(</font> <font color="#000088">$ db</font> <font color="#339933">,</font> <font color="#000088">$ sql</font> <font color="#009900">)</font> <font color="#009900">{</font> <font color="#009900">}</font> <br>  <font color="#000000">function</font> db_count <font color="#009900">(</font> <font color="#000088">$ db</font> <font color="#339933">,</font> <font color="#000088">$ sql</font> <font color="#009900">)</font> <font color="#009900">{</font> <font color="#009900">}</font> <br>  <font color="#666666">// etc.</font> <br>  <font color="#666666">// but why not, because we have one database</font> <br>  <font color="#000000">function</font> db_query <font color="#009900">(</font> <font color="#000088">$ sql</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000000">global</font> <font color="#000088">$ db</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> </blockquote><br><br>  Let the sea be rolling, but we will always save workarounds: <br><blockquote>  <font color="#000088">$ sql</font> <font color="#339933">=</font> <font color="#0000ff">"SELECT id, name, pasw from users where name = ' <font color="#006699">$ _POST [username]</font> '"</font> <font color="#339933">;</font> </blockquote><br><br>  About aggregation in SQL, we do not know: <br><blockquote>  <font color="#666666">// $ rows - records from the database</font> <br>  <font color="#b1b100">foreach</font> <font color="#009900">(</font> <font color="#000088">$ rows</font> <font color="#b1b100">as</font> <font color="#000088">$ value</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#000088">$ total</font> <font color="#339933">+ =</font> <font color="#000088">$ value</font> <font color="#009900">[</font> <font color="#0000ff">"price"</font> <font color="#009900">]</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> </blockquote><br><br>  Need a SEO URL?  No problem: <br><blockquote>  <font color="#b1b100">switch</font> <font color="#009900">(</font> <font color="#000088">$ params</font> <font color="#009900">[</font> <font color="#cc66cc">1</font> <font color="#009900">]</font> <font color="#009900">)</font> <font color="#339933">:</font> <br>  <font color="#b1b100">case</font> <font color="#0000ff">"usageagreement"</font> <font color="#339933">:</font> <br>  <font color="#000088">$ page_id</font> <font color="#339933">=</font> <font color="#cc66cc">13</font> <font color="#339933">;</font> <br>  <font color="#b1b100">break</font> <font color="#339933">;</font> <br>  <font color="#b1b100">case</font> <font color="#0000ff">"privacypolicy"</font> <font color="#339933">:</font> <br>  <font color="#000088">$ page_id</font> <font color="#339933">=</font> <font color="#cc66cc">14</font> <font color="#339933">;</font> <br>  <font color="#b1b100">break</font> <font color="#339933">;</font> <br>  <font color="#b1b100">case</font> <font color="#0000ff">"termsandconditions"</font> <font color="#339933">:</font> <br>  <font color="#000088">$ page_id</font> <font color="#339933">=</font> <font color="#cc66cc">15</font> <font color="#339933">;</font> <br>  <font color="#b1b100">break</font> <font color="#339933">;</font> <br>  <font color="#b1b100">case</font> <font color="#0000ff">"affiliates"</font> <font color="#339933">:</font> <br>  <font color="#000088">$ page_id</font> <font color="#339933">=</font> <font color="#cc66cc">22</font> <font color="#339933">;</font> <br>  <font color="#b1b100">break</font> <font color="#339933">;</font> <br>  <font color="#b1b100">case</font> <font color="#0000ff">"aboutus"</font> <font color="#339933">:</font> <br>  <font color="#000088">$ page_id</font> <font color="#339933">=</font> <font color="#cc66cc">19</font> <font color="#339933">;</font> <br>  <font color="#b1b100">break</font> <font color="#339933">;</font> <br>  <font color="#b1b100">endswitch</font> <font color="#339933">;</font> </blockquote><br><br>  Ok with PHP, but HTML could be learned: <br><blockquote>  <font color="#808080">&lt;! - id is such id -&gt;</font> <br>  <font color="#009900">&lt; <font color="#000000">div</font> <font color="#000066">id</font> <font color="#66cc66">=</font> <font color="#ff0000">"banner"</font> &gt;</font> ... <font color="#009900">&lt; <font color="#66cc66">/</font> <font color="#000000">div</font> &gt;</font> <br>  <font color="#009900">&lt; <font color="#000000">div</font> <font color="#000066">id</font> <font color="#66cc66">=</font> <font color="#ff0000">"banner"</font> &gt;</font> ... <font color="#009900">&lt; <font color="#66cc66">/</font> <font color="#000000">div</font> &gt;</font> <br>  <font color="#009900">&lt; <font color="#000000">div</font> <font color="#000066">id</font> <font color="#66cc66">=</font> <font color="#ff0000">"banner"</font> &gt;</font> ... <font color="#009900">&lt; <font color="#66cc66">/</font> <font color="#000000">div</font> &gt;</font> <br>  <font color="#009900">&lt; <font color="#000000">div</font> <font color="#000066">id</font> <font color="#66cc66">=</font> <font color="#ff0000">"banner"</font> &gt;</font> ... <font color="#009900">&lt; <font color="#66cc66">/</font> <font color="#000000">div</font> &gt;</font> <br><br>  <font color="#808080">&lt;! - class is almost style -&gt;</font> <br>  <font color="#009900">&lt; <font color="#000000">li</font> <font color="#000066">class</font> <font color="#66cc66">=</font> <font color="#ff0000">"padding-left: 15px;"</font></font>  <font color="#009900">&gt;</font> ... <font color="#009900">&lt; <font color="#66cc66">/</font> <font color="#000000">li</font> &gt;</font> <br><br>  <font color="#808080">&lt;! - table layout -&gt;</font> <br>  <font color="#808080">&lt;! - although it is not necessary to paint 10 nested tables -&gt;</font> <br><br>  <font color="#808080">&lt;! - margin, what is a margin?</font>  <font color="#808080">-&gt;</font> <br>  <font color="#ddbb00">&amp; nbsp; &amp; nbsp; &amp; nbsp; &amp; nbsp; &amp; nbsp; &amp; nbsp;</font> </blockquote><br><br><h3>  Application Zend_Cache </h3><br>  Kesh will save the world, we thought and screwed it for all SQL queries (good, someone guessed to write a single function <em>db_sql_query</em> ) and all calls to <em>parse_body</em> .  For starters, we tried to cache files, it helped on the test server, but not live.  The reason is that we have so many small templates (~ 200 for the main one) that operations with the file system negated the caching gain. <br><br>  The second attempt was more successful, we decided to use memcache - a speed increase of ~ 180%.  What a cool indicator, but true only in 100% hit in the cache, so before us loomed the prospect of a complete refactoring of the system. <br><br><h3>  Some client optimization </h3><br>  Well, what can I tell you, simply adding the following rules to .htaccess greatly facilitated navigation for users who have visited the site at least once: <br><br> <code>FileETag MTime Size <br> <br> AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/x-javascript <br> <br> &lt;ifModule mod_expires.c&gt; <br> ExpiresActive On <br> ExpiresDefault "access plus 1 seconds" <br> ExpiresByType text/html "access plus 1 seconds" <br> ExpiresByType image/x-icon "access plus 2592000 seconds" <br> ExpiresByType image/gif "access plus 2592000 seconds" <br> ExpiresByType image/jpeg "access plus 2592000 seconds" <br> ExpiresByType image/png "access plus 2592000 seconds" <br> ExpiresByType text/css "access plus 604800 seconds" <br> ExpiresByType text/javascript "access plus 216000 seconds" <br> ExpiresByType application/x-javascript "access plus 216000 seconds" <br></code> <br><br>  And then everything is in order: <br><ul><li>  Optimization of images for the web (there is such a point in Photoshop) - 40% on all JPEG files </li><li>  Sprites - hard work, dozens of calls to the server can be reduced to units </li><li>  We press JavaScript and CSS - ~ 50% </li><li>  And the last point is nginx for all this stuff. </li></ul><br><br><h3>  Zend Framework </h3><br>  And now I‚Äôll talk about how the project is slowly moving to the Zend Framework.  It all starts with a simple check in index.php (oh yeah, there‚Äôs one entry point in our system): <br><br><blockquote>  <font color="#666666">// list of modules that have already been refactored</font> <br>  <font color="#000088">$ modules</font> <font color="#339933">=</font> <font color="#990000">array</font> <font color="#009900">(</font> <br>  <font color="#0000ff">'/ search /'</font> <font color="#339933">,</font> <br>  <font color="#0000ff">'/ about /'</font> <br>  <font color="#009900">)</font> <font color="#339933">;</font> <br><br>  <font color="#000088">$ path</font> <font color="#339933">=</font> <font color="#000088">$ _SERVER</font> <font color="#009900">[</font> <font color="#0000ff">'REQUEST_URI'</font> <font color="#009900">]</font> <font color="#339933">;</font> <br><br>  <font color="#666666">// we are satisfied with such a simple check</font> <br>  <font color="#666666">// but a request of the form / search /? ... will no longer be processed</font> <br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#990000">in_array</font> <font color="#009900">(</font> <font color="#000088">$ path</font> <font color="#339933">,</font> <font color="#000088">$ modules</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#666666">// connect ZF (inside the standard code from generated public / index.php)</font> <br>  <font color="#b1b100">require</font> <font color="#0000ff">'loader.php'</font> <font color="#339933">;</font> <br>  <font color="#990000">exit</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br><br>  <font color="#666666">// and this one will be</font> <br>  <font color="#b1b100">foreach</font> <font color="#009900">(</font> <font color="#000088">$ modules</font> <font color="#b1b100">as</font> <font color="#000088">$ module</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#990000">strpos</font> <font color="#009900">(</font> <font color="#000088">$ path</font> <font color="#339933">,</font> <font color="#000088">$ module</font> <font color="#009900">)</font> <font color="#339933">===</font> <font color="#cc66cc">0</font> <font color="#009900">)</font> <font color="#009900">{</font> <br>  <font color="#b1b100">require</font> <font color="#0000ff">'loader.php'</font> <font color="#339933">;</font> <br>  <font color="#990000">exit</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#009900">}</font> <br>  <font color="#009900">}</font> </blockquote><br><br>  If we have more than one entry point, then in each file that were affected we make a simple insert: <br><blockquote>  <font color="#000088">$ _SERVER</font> <font color="#009900">[</font> <font color="#0000ff">'REQUEST_URI'</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#990000">str_replace</font> <font color="#009900">(</font> <font color="#000088">$ _SERVER</font> <font color="#009900">[</font> <font color="#0000ff">'PHP_SELF'</font> <font color="#009900">]</font> <font color="#339933">,</font> <font color="#0000ff">'/ admin /'</font> <font color="#339933">,</font> <font color="#000088">$ _SERVER</font> <font color="#009900">[</font> <font color="#0000ff">'REQUEST_URI'</font> <font color="#009900">]</font> <font color="#009900">)</font> <font color="#339933">;</font> <br>  <font color="#b1b100">require</font> <font color="#0000ff">'loader.php'</font> <font color="#339933">;</font> <br>  <font color="#990000">exit</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> </blockquote><br><br>  In order to forget the "global" horror, the vital variables were thrown into Zend_Registry (and later thrown into the application.ini configuration file, where they belong). <br><br>  Also Zend_Translate was fed a table with translations (see adapter array) <br><br><h3>  Result </h3><br>  It is difficult to judge the result, the project is in development, but here are a few comparative measurements: <br><br><table cellspacing="1"><tbody><tr><th></th><th>  Generation time </th><th>  Generation time (re) </th><th>  Generation time (ZF) </th><th>  Page size </th><th>  Page Size (ZF) </th></tr><tr><th>  Home page </th><td align="right">  4 663ms </td><td align="right">  2 759ms </td><td align="right">  - </td><td align="right">  699.5Kb </td><td align="right">  288.0Kb </td></tr><tr><th>  Static pages </th><td align="right">  3 115ms </td><td align="right">  2 008ms </td><td align="right">  295ms </td><td align="right">  263.3Kb </td><td align="right">  166.2Kb </td></tr><tr><th>  Page item </th><td align="right">  3,082ms </td><td align="right">  1,745ms </td><td align="right">  180ms </td><td align="right">  589.1Kb </td><td align="right">  260.8Kb </td></tr></tbody></table><br><br>  Another vivid screenshot of the average / maximum time of page generation by dates: <a href="http://screencast.com/t/NDY1NGE5">http://screencast.com/t/NDY1NGE5</a> <br><br>  <b>UPDATE</b> : Sorry for the tone of the article, but somehow boiling something.  If it seems to someone that the purpose of the article is to show who is white and fluffy, and who else is not, the main idea is to share experience, show examples of ‚Äúbad‚Äù code, and it does not matter who wrote it, the main thing is for everyone to learn lesson, and this code is becoming less ... </div><p>Source: <a href="https://habr.com/ru/post/102220/">https://habr.com/ru/post/102220/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../102207/index.html">Behavior of the habra editor at unstable connection</a></li>
<li><a href="../102209/index.html">What time of day do you show maximum performance?</a></li>
<li><a href="../102210/index.html">Trillian for Android is available for public.</a></li>
<li><a href="../102215/index.html">GAMER LIVE 2010: How It Was</a></li>
<li><a href="../102218/index.html">Ask a question to the Wikipedia management</a></li>
<li><a href="../102223/index.html">Google Labs is experiencing a time machine</a></li>
<li><a href="../102225/index.html">Pico projector SP-H03</a></li>
<li><a href="../102230/index.html">Booting the operating system from the Grub command line</a></li>
<li><a href="../102232/index.html">XBee API Mode LabView Framework</a></li>
<li><a href="../102235/index.html">Augmented Reality S√ºddeutsche Zeitung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>