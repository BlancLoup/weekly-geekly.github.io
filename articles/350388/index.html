<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Examining DB and DBMS with T-SQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 Greetings to you again, dear reader Habra! 

 When you realize your ideas, experience, as well as all the information that does not give yo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Examining DB and DBMS with T-SQL</h1><div class="post__text post__text-html js-mediator-article"><h3>  Foreword </h3><br>  Greetings to you again, dear reader Habra! <br><br>  When you realize your ideas, experience, as well as all the information that does not give you peace of mind in a publication, sooner or later a logical point will come to the entire previously written flow of information.  This article will be different from all previously published by me with its laxity and more free style of text presentation, and also it will complete the presentation of all my accumulated experience on MS SQL Server. <br><br>  This article is a supplement to the article <a href="https://habrahabr.ru/post/241079/">Explore databases using T-SQL</a> , and also briefly talks about the SRV administration database created and utility projects that are designed to help DBA MS SQL Server work. <br><a name="habracut"></a><br><h3>  Some useful insights for database and database research in general </h3><br>  To determine the size of the embedded tables, you can create the following view [inf]. [VInnerTableSize]: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Implementing view [inf]. [VInnerTableSize]</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [_] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> [inf].[vInnerTableSize] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-comment"><span class="hljs-comment">--   select object_name(p.[object_id]) as [Name] , SUM(a.[total_pages]) as TotalPages , SUM(p.[rows]) as CountRows , cast(SUM(a.[total_pages]) * 8192/1024. as decimal(18, 2)) as TotalSizeKB from sys.partitions as p inner join sys.allocation_units as a on p.[partition_id]=a.[container_id] left outer join sys.internal_tables as it on p.[object_id]=it.[object_id] where OBJECTPROPERTY(p.[object_id], N'IsUserTable')=0 group by object_name(p.[object_id]) --order by p.[rows] desc; GO</span></span></code> </pre> </div></div><br>  With this view, you can control the growth of system tables in order to avoid their excessive growth. <br><br>  With the help of the system views <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/system-catalog-views/sys-sql-logins-transact-sql">[sys]. [Sql_logins]</a> and <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/system-compatibility-views/sys-syslogins-transact-sql">[sys]. [Syslogins]</a> you can get logins for cheek and screw inputs. <br><br>  Also of interest are the following system views for the tasks of the Agent instance of MS SQL Server: <br><br>  1) <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/system-tables/dbo-sysjobactivity-transact-sql">[msdb]. [Dbo]. [Sysjobactivity]</a> - active tasks <br>  2) <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/system-tables/dbo-sysjobhistory-transact-sql">[msdb]. [Dbo]. [Sysjobhistory]</a> - task execution history <br>  3) <a href="https://technet.microsoft.com/ru-ru/library/ms189817(v%3Dsql.110).aspx">[msdb]. [Dbo]. [Sysjobs_view]</a> and <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/system-tables/dbo-sysjobservers-transact-sql">[msdb]. [Dbo]. [Sysjobservers]</a> - tasks <br>  4) <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/system-tables/dbo-sysjobschedules-transact-sql">[msdb]. [Dbo]. [Sysjobschedules]</a> - task schedules <br>  5) <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/system-tables/dbo-sysjobsteps-transact-sql">[msdb]. [Dbo]. [Sysjobsteps]</a> - job steps <br>  6) <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/system-tables/dbo-sysjobstepslogs-transact-sql">[msdb]. [Dbo]. [Sysjobstepslogs]</a> - logging of task steps <br><br>  Also, in order to know for which schedules more than one task is assigned, it is enough to create the following representation [inf]. [VScheduleMultiJobs]: <br><br><div class="spoiler">  <b class="spoiler_title">The implementation of the [inf]. [VScheduleMultiJobs] view</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [  ] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> [inf].[vScheduleMultiJobs] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> sh <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> schedule_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [inf].[vJobSchedules] <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> schedule_id <span class="hljs-keyword"><span class="hljs-keyword">having</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*)&gt;<span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> msdb.dbo.sysschedules <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> s <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> top(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sh <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> sh.schedule_id=s.schedule_id) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre></div></div><br>  This view will avoid a rash change in the schedule for one task, so as not to cause changes for another. <br><br>  To obtain information about the description of database objects, you can use the extended properties (system representation <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/system-catalog-views/extended-properties-catalog-views-sys-extended-properties">[sys]. [Extended_properties]</a> ).  For convenience, you can create the following views: <br>  1) [inf]. [VObjectDescription]: <br><br><div class="spoiler">  <b class="spoiler_title">Implementing view [inf]. [VObjectDescription]</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [_] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> [inf].[vObjectDescription] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> SCHEMA_NAME(obj.[schema_id]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> SchemaName ,<span class="hljs-keyword"><span class="hljs-keyword">QUOTENAME</span></span>(object_schema_name(obj.[object_id]))+<span class="hljs-string"><span class="hljs-string">'.'</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">quotename</span></span>(obj.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ObjectName ,obj.[<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>] ,obj.[type_desc] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [TypeDesc] ,ep.[<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ObjectDescription <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.objects <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> obj <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.extended_properties <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ep <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> obj.[object_id]=ep.[major_id] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ep.[minor_id]=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ep.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>]=<span class="hljs-string"><span class="hljs-string">'MS_Description'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> obj.[is_ms_shipped]=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> obj.[parent_object_id]=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre></div></div><br>  2) Descriptions for objects that have parents ‚Äî using the [inf]. [VObjectInParentDescription] view: <br><br><div class="spoiler">  <b class="spoiler_title">Implementing view [inf]. [VObjectInParentDescription]</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [_] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> [inf].[vObjectInParentDescription] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> SCHEMA_NAME(obj.[schema_id]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> SchemaName ,<span class="hljs-keyword"><span class="hljs-keyword">QUOTENAME</span></span>(object_schema_name(obj.[parent_object_id]))+<span class="hljs-string"><span class="hljs-string">'.'</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">quotename</span></span>(object_name(obj.[parent_object_id])) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ParentObjectName ,<span class="hljs-keyword"><span class="hljs-keyword">QUOTENAME</span></span>(object_schema_name(obj.[object_id]))+<span class="hljs-string"><span class="hljs-string">'.'</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">quotename</span></span>(obj.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ObjectName ,obj.[<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>] ,obj.[type_desc] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [TypeDesc] ,ep.[<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ObjectDescription <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.all_objects <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> obj <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.extended_properties <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ep <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> obj.[parent_object_id]=ep.[major_id] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ep.[minor_id]=obj.[object_id] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ep.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>]=<span class="hljs-string"><span class="hljs-string">'MS_Description'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> obj.[is_ms_shipped]=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> obj.[parent_object_id]&lt;&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre></div></div><br>  3) Parameter descriptions - using the [inf]. [VParameterDescription] view: <br><br><div class="spoiler">  <b class="spoiler_title">Implementing view [inf]. [VParameterDescription]</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [_] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> [inf].[vParameterDescription] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> SCHEMA_NAME(obj.[schema_id]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> SchemaName ,<span class="hljs-keyword"><span class="hljs-keyword">QUOTENAME</span></span>(object_schema_name(obj.[object_id]))+<span class="hljs-string"><span class="hljs-string">'.'</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">quotename</span></span>(object_name(obj.[object_id])) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ParentObjectName ,p.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ParameterName ,obj.[<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>] ,obj.[type_desc] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [TypeDesc] ,ep.[<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ParameterDescription <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.parameters <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.objects <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> obj <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> p.[object_id]=obj.[object_id] <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.extended_properties <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ep <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> obj.[object_id]=ep.[major_id] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ep.[minor_id]=p.[parameter_id] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ep.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>]=<span class="hljs-string"><span class="hljs-string">'MS_Description'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> obj.[is_ms_shipped]=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre></div></div><br>  4) Table column descriptions using the [inf]. [VColumnTableDescription] view: <br><br><div class="spoiler">  <b class="spoiler_title">Implementing view [inf]. [VColumnTableDescription]</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [_] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> [inf].[vColumnTableDescription] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> SCHEMA_NAME(t.schema_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> SchemaName ,<span class="hljs-keyword"><span class="hljs-keyword">QUOTENAME</span></span>(object_schema_name(t.[object_id]))+<span class="hljs-string"><span class="hljs-string">'.'</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">quotename</span></span>(t.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TableName ,c.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ColumnName ,ep.[<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ColumnDescription <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.tables <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.columns <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.[object_id]=t.[object_id] <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.extended_properties <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ep <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> t.[object_id]=ep.[major_id] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ep.[minor_id]=c.[column_id] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ep.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>]=<span class="hljs-string"><span class="hljs-string">'MS_Description'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> t.[is_ms_shipped]=<span class="hljs-number"><span class="hljs-number">0</span></span>; GO</code> </pre></div></div><br>  5) View column descriptions using the [inf]. [VColumnViewDescription] view: <br><br><div class="spoiler">  <b class="spoiler_title">Implementing view [inf]. [VColumnViewDescription]</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [_] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> [inf].[vColumnViewDescription] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> SCHEMA_NAME(t.schema_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> SchemaName ,<span class="hljs-keyword"><span class="hljs-keyword">QUOTENAME</span></span>(object_schema_name(t.[object_id]))+<span class="hljs-string"><span class="hljs-string">'.'</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">quotename</span></span>(t.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TableName ,c.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ColumnName ,ep.[<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ColumnDescription <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.views <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.columns <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> c.[object_id]=t.[object_id] <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.extended_properties <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ep <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> t.[object_id]=ep.[major_id] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ep.[minor_id]=c.[column_id] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ep.[<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>]=<span class="hljs-string"><span class="hljs-string">'MS_Description'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> t.[is_ms_shipped]=<span class="hljs-number"><span class="hljs-number">0</span></span>; GO</code> </pre></div></div><br>  6) DB schema descriptions using the [inf]. [VSchemaDescription] view: <br><br><div class="spoiler">  <b class="spoiler_title">Implementing the view [inf]. [VSchemaDescription]</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [_] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> [inf].[vSchemaDescription] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> SCHEMA_NAME(t.schema_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> SchemaName <span class="hljs-comment"><span class="hljs-comment">--,QUOTENAME(object_schema_name(t.[object_id]))+'.'+quotename(t.[name]) as TableName ,ep.[value] as SchemaDescription from sys.schemas as t left outer join sys.extended_properties as ep on t.[schema_id]=ep.[major_id] and ep.[minor_id]=0 and ep.[name]='MS_Description' GO</span></span></code> </pre></div></div><br>  To add or edit extended properties for documenting database objects, it is better to use third-party utilities (for example, I use <a href="https://www.devart.com/ru/dbforge/sql/studio/features.html">dbForge</a> ). <br>  However, it can also be done with the following queries: <br><br><div class="spoiler">  <b class="spoiler_title">Examples of creating descriptions for database objects</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--     @ObjectID - dbo.GetPlansObject --       EXECUTE sp_addextendedproperty @name = N'MS_Description', @value = N' ', @level0type = N'SCHEMA', @level0name = N'dbo', @level1type = N'FUNCTION', @level1name = N'GetPlansObject', @level2type = N'PARAMETER', @level2name = N'@ObjectID'; --    - dbo.GetPlansObject --     ,  EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'    ', @level0type=N'SCHEMA', @level0name=N'dbo', @level1type=N'FUNCTION', @level1name=N'GetPlansObject'; --     inf.vColumnTableDescription --     EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'  ', @level0type=N'SCHEMA', @level0name=N'inf', @level1type=N'VIEW', @level1name=N'vColumnTableDescription'; --     TEST_GUID  dbo.TABLE --      EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'  ()', @level0type=N'SCHEMA', @level0name=N'dbo', @level1type=N'TABLE', @level1name=N'TEST', @level2type=N'COLUMN', @level2name=N'TEST_GUID'; --     rep EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'  rep    ' , @level0type=N'SCHEMA', @level0name=N'rep'; --     EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'      MS SQL Server 2016-2017 (     MS SQL Server 2012-2014).      MS SQL Server 2012           .    .   inf.InfoAgentJobs.';</span></span></code> </pre></div></div><br>  In order to change or delete the description, it suffices to use the stored procedures <a href="https://msdn.microsoft.com/ru-ru/library/ms186885(v%3Dsql.120).aspx">sp_updateextendedproperty</a> and <a href="https://msdn.microsoft.com/ru-ru/library/ms178595(v%3Dsql.120).aspx">sp_dropextendedproperty,</a> respectively. <br><br>  The following system views will also be useful in the study of the entire DBMS: <br><br>  1) <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/system-dynamic-management-views/sys-dm-os-performance-counters-transact-sql">[sys]. [Dm_os_performance_counters]</a> - values ‚Äã‚Äãof performance counters <br><br>  2) <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/system-dynamic-management-views/sys-dm-os-schedulers-transact-sql">[sys]. [Dm_os_schedulers]</a> - Task Schedulers <br><br>  3) <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/system-catalog-views/sys-configurations-transact-sql">[sys]. [Configurations]</a> - <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/system-catalog-views/sys-configurations-transact-sql">configuration</a> information <br><br>  4) to match the session identifiers with the Windows thread identifiers, you can create the following representation [inf]. [VSessionThreadOS]: <br><br><div class="spoiler">  <b class="spoiler_title">The implementation of the [inf]. [VSessionThreadOS] view</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [  ] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> [inf].[vSessionThreadOS] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   ,       Windows.         Windows.     ,        . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> STasks.session_id, SThreads.os_thread_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.dm_os_tasks <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> STasks <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.dm_os_threads <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SThreads <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> STasks.worker_address = SThreads.worker_address <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> STasks.session_id <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; GO</code> </pre></div></div><br>  5) to learn about problems with the number of tempdb database files, you can create the following representation [inf]. [VServerProblemInCountFilesTempDB]: <br><br><div class="spoiler">  <b class="spoiler_title">Implementing view [inf]. [VServerProblemInCountFilesTempDB]</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [  ] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> [inf].[vServerProblemInCountFilesTempDB] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-comment"><span class="hljs-comment">/* http://sqlcom.ru/dba-tools/tempdb-in-sql-server-2016/          tempdb.     latch    PFS, GAM, SGAM    tempdb.           ¬´Is Not PFS, GAM, or SGAM page¬ª,          tempdb */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> session_id, wait_type, wait_duration_ms, blocking_session_id, resource_description, ResourceType = <span class="hljs-keyword"><span class="hljs-keyword">Case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Cast</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Right</span></span>(resource_description, <span class="hljs-keyword"><span class="hljs-keyword">Len</span></span>(resource_description) - <span class="hljs-keyword"><span class="hljs-keyword">Charindex</span></span>(<span class="hljs-string"><span class="hljs-string">':'</span></span>, resource_description, <span class="hljs-number"><span class="hljs-number">3</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span>) - <span class="hljs-number"><span class="hljs-number">1</span></span> % <span class="hljs-number"><span class="hljs-number">8088</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> <span class="hljs-string"><span class="hljs-string">'Is PFS Page'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Cast</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Right</span></span>(resource_description, <span class="hljs-keyword"><span class="hljs-keyword">Len</span></span>(resource_description) - <span class="hljs-keyword"><span class="hljs-keyword">Charindex</span></span>(<span class="hljs-string"><span class="hljs-string">':'</span></span>, resource_description, <span class="hljs-number"><span class="hljs-number">3</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span>) - <span class="hljs-number"><span class="hljs-number">2</span></span> % <span class="hljs-number"><span class="hljs-number">511232</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> <span class="hljs-string"><span class="hljs-string">'Is GAM Page'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">When</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Cast</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Right</span></span>(resource_description, <span class="hljs-keyword"><span class="hljs-keyword">Len</span></span>(resource_description) - <span class="hljs-keyword"><span class="hljs-keyword">Charindex</span></span>(<span class="hljs-string"><span class="hljs-string">':'</span></span>, resource_description, <span class="hljs-number"><span class="hljs-number">3</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span>) - <span class="hljs-number"><span class="hljs-number">3</span></span> % <span class="hljs-number"><span class="hljs-number">511232</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Then</span></span> <span class="hljs-string"><span class="hljs-string">'Is SGAM Page'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Else</span></span> <span class="hljs-string"><span class="hljs-string">'Is Not PFS, GAM, or SGAM page'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">End</span></span> <span class="hljs-keyword"><span class="hljs-keyword">From</span></span> sys.dm_os_waiting_tasks <span class="hljs-keyword"><span class="hljs-keyword">Where</span></span> wait_type <span class="hljs-keyword"><span class="hljs-keyword">Like</span></span> <span class="hljs-string"><span class="hljs-string">'PAGE%LATCH_%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">And</span></span> resource_description <span class="hljs-keyword"><span class="hljs-keyword">Like</span></span> <span class="hljs-string"><span class="hljs-string">'2:%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre></div></div><br>  6) to learn about problems with the data writing time in the tempdb database, you can create the following representation [srv]. [VStatisticsIOInTempDB]: <br><br><div class="spoiler">  <b class="spoiler_title">Implementing view [srv]. [VStatisticsIOInTempDB]</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [  ] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> [srv].[vStatisticsIOInTempDB] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     (avg_write_stall_ms)  5 ,      .  5  10  ‚Äî  .  10  ‚Äî  ,    ,    -     https://minyurov.com/2016/07/24/mssql-tempdb-opt/ */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> files.physical_name, files.name, stats.num_of_writes, (<span class="hljs-number"><span class="hljs-number">1.0</span></span> * stats.io_stall_write_ms / stats.num_of_writes) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> avg_write_stall_ms, stats.num_of_reads, (<span class="hljs-number"><span class="hljs-number">1.0</span></span> * stats.io_stall_read_ms / stats.num_of_reads) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> avg_read_stall_ms <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.dm_io_virtual_file_stats(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> stats <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> master.sys.master_files <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> files <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> stats.database_id = files.database_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> stats.file_id = files.file_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> files.type_desc = <span class="hljs-string"><span class="hljs-string">'ROWS'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre></div></div><br>  7) for the convenience of displaying information about the latest backup copies of all databases, you can create the following representation [inf]. [VServerLastBackupDB]: <br><br><div class="spoiler">  <b class="spoiler_title">Implementing view [inf]. [VServerLastBackupDB]</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [  ] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> [inf].[vServerLastBackupDB] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> backup_cte <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> bs.[database_name], backup_type = <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> bs.[<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-string"><span class="hljs-string">'D'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'database'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-string"><span class="hljs-string">'L'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'log'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-string"><span class="hljs-string">'I'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'differential'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">'other'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, bs.[first_lsn], bs.[last_lsn], bs.[backup_start_date], bs.[backup_finish_date], <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(bs.[backup_size] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">18</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>))/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> BackupSizeMb, <span class="hljs-keyword"><span class="hljs-keyword">rownum</span></span> = row_number() <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> bs.[database_name], <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> bs.[backup_finish_date] <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> ), LogicalDeviceName = bmf.[logical_device_name], PhysicalDeviceName = bmf.[physical_device_name], bs.[server_name], bs.[user_name] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> msdb.dbo.backupset bs <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> msdb.dbo.backupmediafamily bmf <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [bs].[media_set_id] = [bmf].[media_set_id] ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> [server_name] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [ServerName], [database_name] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [DBName], [user_name] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [USerName], [backup_type] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [BackupType], [backup_start_date] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [BackupStartDate], [backup_finish_date] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [BackupFinishDate], [BackupSizeMb], <span class="hljs-comment"><span class="hljs-comment">--   [LogicalDeviceName], [PhysicalDeviceName], [first_lsn] as [FirstLSN], [last_lsn] as [LastLSN] from backup_cte where rownum = 1; GO</span></span></code> </pre></div></div><br>  8) a similar representation [inf]. [VServerBackupDB] can be created to obtain information about all backup copies: <br><div class="spoiler">  <b class="spoiler_title">Implementing view [inf]. [VServerBackupDB]</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [  ] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> [inf].[vServerBackupDB] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> backup_cte <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> bs.[database_name], backup_type = <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> bs.[<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-string"><span class="hljs-string">'D'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'database'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-string"><span class="hljs-string">'L'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'log'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-string"><span class="hljs-string">'I'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'differential'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">'other'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, bs.[first_lsn], bs.[last_lsn], bs.[backup_start_date], bs.[backup_finish_date], <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(bs.[backup_size] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">18</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>))/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> BackupSizeMb, LogicalDeviceName = bmf.[logical_device_name], PhysicalDeviceName = bmf.[physical_device_name], bs.[server_name], bs.[user_name] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> msdb.dbo.backupset bs <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> msdb.dbo.backupmediafamily bmf <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [bs].[media_set_id] = [bmf].[media_set_id] ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> [server_name] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [ServerName], [database_name] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [DBName], [user_name] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [USerName], [backup_type] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [BackupType], [backup_start_date] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [BackupStartDate], [backup_finish_date] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [BackupFinishDate], [BackupSizeMb], <span class="hljs-comment"><span class="hljs-comment">--   [LogicalDeviceName], [PhysicalDeviceName], [first_lsn] as [FirstLSN], [last_lsn] as [LastLSN] from backup_cte; GO</span></span></code> </pre></div></div><br>  9) you can also improve the performance on expectations statistics (from the article <a href="https://habrahabr.ru/post/216309/">SQL Server expectations statistics or please tell me where it hurts</a> ) to remove the output duplicate lines in the form of [inf]. [VWaits]: <br><br><div class="spoiler">  <b class="spoiler_title">Implementing the view [inf]. [VWaits]</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [  ] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> [inf].[vWaits] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> [Waits] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [wait_type], <span class="hljs-comment"><span class="hljs-comment">--   [wait_time_ms] / 1000.0 AS [WaitS],--      .    signal_wait_time_ms ([wait_time_ms] - [signal_wait_time_ms]) / 1000.0 AS [ResourceS],--        signal_wait_time_ms [signal_wait_time_ms] / 1000.0 AS [SignalS],--           [waiting_tasks_count] AS [WaitCount],--   .         100.0 * [wait_time_ms] / SUM ([wait_time_ms]) OVER() AS [Percentage], ROW_NUMBER() OVER(ORDER BY [wait_time_ms] DESC) AS [RowNum] FROM sys.dm_os_wait_stats WHERE [wait_type] NOT IN ( N'BROKER_EVENTHANDLER', N'BROKER_RECEIVE_WAITFOR', N'BROKER_TASK_STOP', N'BROKER_TO_FLUSH', N'BROKER_TRANSMITTER', N'CHECKPOINT_QUEUE', N'CHKPT', N'CLR_AUTO_EVENT', N'CLR_MANUAL_EVENT', N'CLR_SEMAPHORE', N'DBMIRROR_DBM_EVENT', N'DBMIRROR_EVENTS_QUEUE', N'DBMIRROR_WORKER_QUEUE', N'DBMIRRORING_CMD', N'DIRTY_PAGE_POLL', N'DISPATCHER_QUEUE_SEMAPHORE', N'EXECSYNC', N'FSAGENT', N'FT_IFTS_SCHEDULER_IDLE_WAIT', N'FT_IFTSHC_MUTEX', N'HADR_CLUSAPI_CALL', N'HADR_FILESTREAM_IOMGR_IOCOMPLETION', N'HADR_LOGCAPTURE_WAIT', N'HADR_NOTIFICATION_DEQUEUE', N'HADR_TIMER_TASK', N'HADR_WORK_QUEUE', N'KSOURCE_WAKEUP', N'LAZYWRITER_SLEEP', N'LOGMGR_QUEUE', N'ONDEMAND_TASK_QUEUE', N'PWAIT_ALL_COMPONENTS_INITIALIZED', N'QDS_PERSIST_TASK_MAIN_LOOP_SLEEP', N'QDS_CLEANUP_STALE_QUERIES_TASK_MAIN_LOOP_SLEEP', N'REQUEST_FOR_DEADLOCK_SEARCH', N'RESOURCE_QUEUE', N'SERVER_IDLE_CHECK', N'SLEEP_BPOOL_FLUSH', N'SLEEP_DBSTARTUP', N'SLEEP_DCOMSTARTUP', N'SLEEP_MASTERDBREADY', N'SLEEP_MASTERMDREADY', N'SLEEP_MASTERUPGRADED', N'SLEEP_MSDBSTARTUP', N'SLEEP_SYSTEMTASK', N'SLEEP_TASK', N'SLEEP_TEMPDBSTARTUP', N'SNI_HTTP_ACCEPT', N'SP_SERVER_DIAGNOSTICS_SLEEP', N'SQLTRACE_BUFFER_FLUSH', N'SQLTRACE_INCREMENTAL_FLUSH_SLEEP', N'SQLTRACE_WAIT_ENTRIES', N'WAIT_FOR_RESULTS', N'WAITFOR', N'WAITFOR_TASKSHUTDOWN', N'WAIT_XTP_HOST_WAIT', N'WAIT_XTP_OFFLINE_CKPT_NEW_LOG', N'WAIT_XTP_CKPT_CLOSE', N'XE_DISPATCHER_JOIN', N'XE_DISPATCHER_WAIT', N'XE_TIMER_EVENT') ) , ress as ( SELECT [W1].[wait_type] AS [WaitType], CAST ([W1].[WaitS] AS DECIMAL (16, 2)) AS [Wait_S],--      .    signal_wait_time_ms CAST ([W1].[ResourceS] AS DECIMAL (16, 2)) AS [Resource_S],--        signal_wait_time_ms CAST ([W1].[SignalS] AS DECIMAL (16, 2)) AS [Signal_S],--           [W1].[WaitCount] AS [WaitCount],--   .         CAST ([W1].[Percentage] AS DECIMAL (5, 2)) AS [Percentage], CAST (([W1].[WaitS] / [W1].[WaitCount]) AS DECIMAL (16, 4)) AS [AvgWait_S], CAST (([W1].[ResourceS] / [W1].[WaitCount]) AS DECIMAL (16, 4)) AS [AvgRes_S], CAST (([W1].[SignalS] / [W1].[WaitCount]) AS DECIMAL (16, 4)) AS [AvgSig_S] FROM [Waits] AS [W1] INNER JOIN [Waits] AS [W2] ON [W2].[RowNum] &lt;= [W1].[RowNum] GROUP BY [W1].[RowNum], [W1].[wait_type], [W1].[WaitS], [W1].[ResourceS], [W1].[SignalS], [W1].[WaitCount], [W1].[Percentage] HAVING SUM ([W2].[Percentage]) - [W1].[Percentage] &lt; 95 -- percentage threshold ) SELECT [WaitType] ,MAX([Wait_S]) as [Wait_S] ,MAX([Resource_S]) as [Resource_S] ,MAX([Signal_S]) as [Signal_S] ,MAX([WaitCount]) as [WaitCount] ,MAX([Percentage]) as [Percentage] ,MAX([AvgWait_S]) as [AvgWait_S] ,MAX([AvgRes_S]) as [AvgRes_S] ,MAX([AvgSig_S]) as [AvgSig_S] FROM ress group by [WaitType]; GO</span></span></code> </pre></div></div><br><h3>  SRV DB for database administration and DBMS in general </h3><br>  Until the moment of writing my articles, I created the SRV DB, which was modified and supplemented with the experience and knowledge gained. <br>  Other utility projects were also developed to help the database administrator on C # .NET. <br><br>  Access to projects <a href="https://github.com/jobgemws/Projects-MS-SQL-Server-DBA">here</a> . <br>  At the root is the ‚ÄúDescription‚Äù file, where each project is briefly described. <br>  These solutions are open and distributed freely. <br><br>  Also thanks to you, dear Habr readers, who left feedback in the form of comments and messages, we managed to improve the project on the SRV database.  Thank you very much for that! <br><br>  But it is important to note that existing approaches and solutions described in external sources should be carefully analyzed, since  These methods may not be suitable for your task.  It is necessary to pay special attention to the difference in the parameters and conditions of your task from the task, which is solved in the example: load, amount of information processed, frequency, specificity of a business problem, etc.  For example, a procedure that works for 40 minutes is suitable for a call once a day, but if the process needs to be started with a higher frequency, then this solution may not be suitable. <br><br>  Having found your unique approach to a specific task, do not forget to share it!  Thus, you will add to the ‚Äúglobal knowledge base‚Äù, which facilitates the search for solutions and ideas for new tasks. <br><br><h3>  Results </h3><br>  Some more useful system views of MS SQL Server were considered, including for self-documentation in the form of extended properties. <br><br><h3>  Reflections and ideas </h3><br>  As you have already noticed, MS SQL Server already sufficiently supports NoSQL in the form of graph tables (with <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/graphs/sql-graph-overview">MS SQL Server 2017</a> ) and document-oriented data (XML, and with MS SQL Server 2016 and <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/json/json-data-sql-server">JSON</a> ). <br><br>  However, as Edgar Frank Codd (by source [1]) noted in the 70s of the 20th century, not a simple relationship can be considered in the relational model.  That is, you can both embed one table into another, and inherit from one table to another (I remind you that a table is a relation in a relational model).  Table inheritance is implemented in some DBMS, for example, in the same <a href="https://postgrespro.ru/docs/postgrespro/9.5/ddl-inherit.html">PostgreSQL</a> .  But I have not seen the implementation of investments.  If we implement both attachments and inheritance, as well as lay the mechanism for processing these complex relationships, we get a DBMS that summarizes the JSON and XML formats and fully covers the so-called NoSQL technology (analogue of operator overload in programming languages, but in DBMS indices, aggregation, statistics , service and t d for such a relationship).  Moreover, it will probably cover all other data models to a sufficient degree, although it will be handled by the declarative language of SQL queries with some specific extensions and definitions for complex relationships. <br><br>  Seeing how quickly MS SQL Server is developing, it is worth hoping that someday it will come to the realization of complex relationships and cover all their varieties.  And then the wishes and foresight of the creator of relational algebra will be brought to life, and in the relational model, specialists will discover completely different aspects of creating various information databases and data warehouses. <br><br><h3>  Sources: </h3><br>  "" High load applications.  Programming, scaling, support ‚Äù, SPb .: Peter, 2018 Kleppman M. [1] <br>  " <a href="https://habrahabr.ru/post/216309/">SQL Server wait statistics or please tell me where it hurts</a> <br>  ¬ª <a href="https://habrahabr.ru/post/241079/">Investigate databases with T-SQL</a> <br>  ¬ª <a href="https://docs.microsoft.com/ru-ru/sql/">SQL documentation</a> <br>  ¬ª <a href="http://sqlcom.ru/dba-tools/tempdb-in-sql-server-2016/">Tempdb Improvements in SQL Server 2016</a> <br>  ¬ª <a href="https://minyurov.com/2016/07/24/mssql-tempdb-opt/">Temporary DB Optimization (tempdb)</a> <br>  ¬ª <a href="">T-SQL formatting standard</a> <br>  ¬ª <a href="https://github.com/jobgemws/Projects-MS-SQL-Server-DBA">Utilities for MS SQL Server DBA</a> <br>  ¬ª <a href="https://www.devart.com/ru/dbforge/sql/studio/features.html">DbForge</a> <br>  <a href="https://postgrespro.ru/docs/postgrespro/9.5/ddl-inherit.html">PostgreSQL (inheritance)</a> <br>  ¬ª <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/graphs/sql-graph-overview">MS SQL Server 2017 (columns)</a> <br>  ¬ª <a href="https://docs.microsoft.com/ru-ru/sql/relational-databases/json/json-data-sql-server">JSON in MS SQL Server 2016-2017</a> </div><p>Source: <a href="https://habr.com/ru/post/350388/">https://habr.com/ru/post/350388/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350378/index.html">ITSM chatbots: what it is and why they are needed</a></li>
<li><a href="../350380/index.html">FastTrack Training. "Network Basics". "Basics of a wireless LAN". Part one. Eddie Martin December 2012</a></li>
<li><a href="../350382/index.html">Testing Services API and RSpec</a></li>
<li><a href="../350384/index.html">Selection: 12 services to protect against DDoS-attacks</a></li>
<li><a href="../350386/index.html">Java 8 and Strategy pattern</a></li>
<li><a href="../350390/index.html">Proper bookmarking: how to work more efficiently and memorize more</a></li>
<li><a href="../350392/index.html">Cuckoo 2.0. We collect the best open source platform for analyzing malicious files</a></li>
<li><a href="../350394/index.html">Network Device Detection</a></li>
<li><a href="../350396/index.html">Implement fast 2D shadows in Unity using 1D shadow mapping</a></li>
<li><a href="../350398/index.html">Native dependency inversion in TypeScript and React</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>