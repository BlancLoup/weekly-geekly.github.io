<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Distributed Captive Portal in public places and Apple issues</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After reading about the subway , I wanted to comment, but decided to write separately. 

 We participated in the creation of public networks with dist...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Distributed Captive Portal in public places and Apple issues</h1><div class="post__text post__text-html js-mediator-article">  After reading <a href="http://habrahabr.ru/post/251599/">about the subway</a> , I wanted to comment, but decided to write separately. <br><br>  We participated in the creation of public networks with distributed captive portal and attacked almost all the rakes, so I want to share experiences. <br><a name="habracut"></a><br>  To begin with, there‚Äôs a little theory of how this works and how distributed portals differ from centralized ones.  Ideologically, what we used to call the Captive Portal actually consists of three components: <br><br>  <b>web frontend</b> - designed to interact with the user, collecting information by filling out forms and showing him advertising.  If we are going to ask the user to enter personal information and passwords, then https should be used, respectively, the server needs a normal certificate.  If we are going to ask to put a tick under the user agreement, then http is enough. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>captive portal itself</b> is a certain agent, called to receive information gathered through the web frontend, analyze it, it is possible to do specifying requests on its own behalf (for example, in RADIUS) and report its decision either directly to the user or to him through the web. frontend.  In the case of a positive decision, captvie portal opens for the user the necessary holes in the firewall.  After a specified period of time, the holes close and we have the user back to the web frontend.  Prematurely the portal is closed due to inactivity of the user.  Often the only reason for limiting the session time is the desire to show the user advertising again (if we don‚Äôt want to act like a subway, disfiguring the design of other sites) <br><br>  <b>firewall</b> - knows the access of individual users to the network.  In case of lack of access for ideological reasons, it redirects the user to the web frontend.  In case of lack of access for technical reasons (the gateway does not ping), you can instruct the firewall to redirect the user to a special page ‚Äúthere is no service, but we are repairing it with all our might‚Äù. <br><br>  In the case of a centralized captive portal, all three components are obviously located on the same machine (device), which greatly simplifies the task.  Firewall in this case often executes more NAT, and the captive portal can be implemented as a bunch of scripts that twist the local iptables.  There is a formidable desire to push into the network of cheap access points, which will throw us all users on ethernet or in the best case - in a separate vlan.  What are the problems here: <br><ul><li>  Safety problems.  We restrict access to the external channel, but everything is bad on the local network.  Since the network is open, any user can respond to arp on behalf of our default gateway, receive user traffic and engage in phishing.  It is not forbidden to put your DHCP server and in a certain delta-neighborhood to push users with statements like ‚Äúyour browser is hopelessly outdated‚Äù.  If your captive portal and the user are separated by a router, then you do not have the ability to control the mac and ip correspondence with all the consequences on the captive portal.  Communication between wireless clients becomes possible.  You can prohibit communicating to wireless clients at a cheap point, but clients of other points are already visible on ethernet. </li><li>  Traffic problems.  We have a lot of excess traffic on the local network.  Before opening the captive portal, customers are advised not to allow access points further. </li><li>  Scalability issues.  With a large number of clients, any of the three components of the portal can be problematic. </li></ul><br><br>  As you already guess, a distributed captive portal is designed to solve all these problems.  Speaking of "distributed", we assume that the components can be placed on different devices.  This will allow us to create a reliable system that will provide the necessary level of security and service, while having great potential for scaling.  The problem that we have to solve is to provide interaction between the components of the captive portal.  Where should the solution components be located? <br><br>  The firewall should be as close as possible to the client, i.e.  uniquely at the access point.  Since there are several access points and each of them has its own firewall, their work must be synchronized within a certain space or terrain, within which roaming of clients is assumed.  Otherwise, customers will experience communication problems when roaming.  In modern networks, the task of synchronizing the work of something inside a certain area (RF-domain) is performed using appointed arbitrators (RF-domain managers) and was solved in ancient times without regard to the task of implementing a distributed captive portal.  For this system, synchronization of a firewall is just one more process that must be performed in a domain consistently, along with (for example) traffic switching, synchronization of configurations of points, or collection of statistics. <br><br>  The location of the web frontend strongly depends on the complexity of the tasks that it has to solve.  If you need to show pages that do not imply server side processing or any difficulties like sending SMS, then it is quite possible to get by with a server on the access point.  He, again, is located as close as possible to the client and provides the most effective interaction with him.  The synchronization of the content of web servers at different access points will be handled (surprise) by the RF-domain manager. <br><br>  The location of the captive portal depends on the position of the web frontend and the availability of points.  Since the task of the captive portal is to twist the firewall, it must have its own representative (agent) at each point.  However, the web frontend can communicate with any of the copies of these agents, because their status (you guessed it) is also synchronized within the domain. <br><br>  Thus, we achieve a situation in which for a client that successfully passed authorization, the captive portal opens immediately in the entire domain and after that at any time on all access points of the firewall domain for this client is configured the same. <br><br><h5>  Subtleties </h5><br>  The method of interaction with the captive portal.  We need a mechanism by which we can tell the portal the results of user interaction.  In our case, HTTP GET was chosen as such a mechanism.  If you need to open the portal, we send HTTP GET to any of its offices.  The composition of the parameters transmitted in GET depends on the mode in which the portal operates.  Here are a few options: <br><ul><li>  The portal opens always.  It is possible to record this in the log. </li><li>  A portal is opened when there is a variable in GET that reflects agreement with the conditions (agreement). </li><li>  The username and password are transferred to GET, the portal itself climbs into RADIUS with these attributes and opens, having received ACCEPT from there. </li><li>  One (universal) attribute is transferred to GET, the portal indicates it both as a username and as a password when accessing RADIUS and is opened by receiving ACCEPT.  It is clear that such a user must be in RADIUS </li></ul><br>  Anything outside of this logic requires implementation in a web frontend.  For example, you can ask the user phone, send him a text message, check the code.  According to the results, charge the user to the radius (for example) with username = phone_number and password = his_IP and then send GET to the portal with these values. <br><br>  How does a portal, getting a GET, understand what kind of user is it?  When a user is redirected to the web frontend, the portal attaches a rather long variable to the call, which we must return to it in the integrity of the parameters of the request to open the portal. <br><br>  Ideally, the point performs bridging (level 2 forwarding) between the SSID and some vlan in the wires.  That is, the firewall runs at the second (MAC) level.  Since the firewall sees the DHCP offer arriving from the depths of your network to the client, it knows its IP for sure, responds instead of the client to ARP and rigidly filters all ARP and DHCP on the wireless segment. <br><br>  The absence of an IP address in a user vlan eliminates the possibility of the user communicating directly with the point.  However, sometimes we need this opportunity - at the location of the web and the portal right on the point.  In this case, the dummy address 1.1.1.1 is used. <br><br><h5>  What does Apple have to do with it? </h5><br>  And why are we everywhere, like in the subway, convincing iPhones that there is no portal. <br><br>  By the way iPhones behave in wireless networks, I had the strong conviction that the creators of this megaproduct assumed only one scenario, namely, <b>one access point</b> .  That is, either at home or in a cafe for hipsters.  In the second case, there is a non-illusory chance to meet with a captive portal. <br><br>  What does the iPhone do when it encounters several points with a single SSID and a captive portal?  He tries <b>all</b> available.  On each, it connects, asks for an address, checks a random url from its long list (it used to be one), realizes that it is captive, gives an address (dhcp release) and turns off.  Since in our case one SSID shines from each point in both 2.4 and 5GHz, everything is multiplied by two.  Having come to the logical conclusion ‚Äúyes, there is an ambush everywhere!‚Äù, The iPhone re-connects to one of the points and draws its own mini-browser.  In the terminology of our customers and clients, this process is called ‚ÄúMy last iPhone connects to your network for a very long time‚Äù and ‚Äúat my place everything flies at a point for 1000 rubles.‚Äù In the case of a coordinated network (not separate points), with each connection, the point sends a message to the manager the domain "we have a new passenger", and in the case of MESH - in parallel there and there.  The whole process takes up to 20 seconds. <br><br>  What does the iPhone do when it encounters the same SSID immediately in 2.4 and 5GHz?  You thought that you would be able to balance clients between channels, points and ranges, making maximum use of the possibilities of clients and network transmission?  Only not with Apple products!  On the network side, hearing requests from the client in both bands, we have the right to assume that we can force the client to connect where we need, skipping requests to those points where we don‚Äôt want it to connect.  Typically, customers take the hint and connect, for example, in 5Ghz.  IPhone will break in 2.4 to the last.  For resistant there is a separate counter (20 consecutive requests by default).  Takes time too. <br><br>  The two described processes occur not only when connected to the network, but also when roaming, if you go far enough.  Oh, yes, there are new points here.  Well, let's check ... <br><br>  What does the iPhone do if he launches a mini browser and we (suddenly) need to send an SMS message to the client?  It shows SMS in a small window on top with an exposure time of about 3 seconds.  Blonde is not able to remember 6 (six!) Numbers during this time.  The window is leaving, the user pokes a finger at the sms, the mini browser closes, dhcp release, disconnect, welcome to 3G.  The user with a grief in half remembers the code, climbs in settings, connects to the network, enter the phone number, get a new SMS.  And further, and further ... In the terminology of customers and users, this is called ‚Äúyour main portal is not working on my last iPhone‚Äù and ‚Äúthey have already repaired it even in the metro‚Äù. <br>  The situation can be corrected by sending the user's MAC (we are able) to the web frontend, memorizing there that we have already sent him a text message and asking for the code at the second call.  For this browser does not support cookies. <br><br>  What is the reason for such inadequate behavior?  It's simple: the creators of the device set out to not leave you without communication. <br><br>  Suppose you came to visit.  There is a closed network, but the good hosts told you the password and voil√† - here it is the Internet.  Your network remembered your smartphone and connected to it automatically during your next visit.  But the owners forgot to pay the provider and this time they did not let the router go further.  That is, you did not do anything, did not even pick up the phone, but, without knowing it, you were left without communication with the outside world.  This is very bad.  To avoid this, modern mobile devices perform a kind of multi-step process when connected, the purpose of which is not to leave you without communication: <br><ol><li>  We can not get IP - disconnect </li><li>  We do not see ARP with default gateway - we disconnect </li><li>  No DNS is responding from the list - disconnect </li><li>  We are requesting a url from one of our domains - we hope to see <pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">HTML</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">HEAD</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TITLE</span></span></span><span class="hljs-tag">&gt;</span></span>Success<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TITLE</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">HEAD</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BODY</span></span></span><span class="hljs-tag">&gt;</span></span>Success<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BODY</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">HTML</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </li></ol><br>  In case of success of the last step, we assume that the Internet is there and we get off 3G.  And so we do with each connection to wifi.  Even at home. <br>  If instead of ‚ÄúSuccess‚Äù we see something wrong, here it is a captive portal.  It's time to start the minibrowser.  The user could not agree at once with the portal in the window - we are disconnected.  The problem with the iPhone is that he hopes for the best to the last.  If you ask to connect to the network, and it can be seen at more than one point - all options will be tried.  Time will pass.  Most of the devices, seeing the portal, suggest that he is everywhere, probably. <br><br>  The only way to stop the throwing is to bypass portal detection.  It is possible to implement in two ways - by filtering "User-Agent: CaptiveNetworkSupport" or by passing traffic across a certain list of domains.  In the subway, for example, iMessage works with the portal closed. <br><br>  As a result, bypassing the portal, the network can be seen either in no way or not all.  In any case, this is very bad, because it actually leaves the user without communication in a way imperceptible to him. <br><br>  On our hardware, detection is turned off with one command: <br><br><pre> <code class="dos hljs">ap7131-ABCDEF(config-captive-portal-XXXXX)#bypass ? captive-portal-detection Captive portal detection requests(eg, Apple Captive Network Assistant ap7131-ABCDEF(config-captive-portal-XXXXX)#bypass captive-portal-detection</code> </pre></div><p>Source: <a href="https://habr.com/ru/post/252263/">https://habr.com/ru/post/252263/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252247/index.html">Time constraints and static time analysis FPGA on the example of Microsemi SmartTime</a></li>
<li><a href="../252249/index.html">When this == null: the untamed story from the world of the CLR</a></li>
<li><a href="../252255/index.html">Apple's environmental care, IMGA international award, Google Play success - and other news of the week for a mobile developer</a></li>
<li><a href="../252259/index.html">Who earned the most money in the mobile market in 2014</a></li>
<li><a href="../252261/index.html">FPGA - my first steps</a></li>
<li><a href="../252265/index.html">Search for texts that do not match the topic and find similar articles</a></li>
<li><a href="../252267/index.html">Game in 14 days [For those who have been building a team for years, but never made a prototype]</a></li>
<li><a href="../252269/index.html">TeleGeography World Wide Web Map. 2015 version</a></li>
<li><a href="../252271/index.html">Mobile application for the governor and sales agent</a></li>
<li><a href="../252273/index.html">Mobile Development Conference 2015: Announcement of Reports</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>