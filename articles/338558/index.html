<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reactive applications with Model-View-Intent. Part 2: View and Intent</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part, we discussed what a model is, its relationship to the state and how a properly designed model helps to solve some problems in the d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reactive applications with Model-View-Intent. Part 2: View and Intent</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="https://habrahabr.ru/company/tinkoff/blog/325376/">first</a> part, we discussed what a model is, its relationship to the state and how a properly designed model helps to solve some problems in the development for Android.  In this article, we will continue our path to creating reactive applications using the <b>M</b> odel- <b>V</b> iew- <b>I</b> ntent pattern. <br><br>  Before we begin, we will briefly discuss the main idea of ‚Äã‚ÄãMVI. <br><br><h3>  <b>Model-View-Intent (MVI)</b> </h3><br>  This pattern was described by Andr√© Staltz for the JavaScript framework <a href="https://cycle.js.org/">cycle.js</a> .  From a theoretical and mathematical point of view, MVI can be described as follows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/web/514/563/4c7/5145634c79df42cdacf2b52f682b7eb5.png" alt="image"></div><br><a name="habracut"></a><br><ul><li>  <b>intent ()</b> : A function that accepts input from a user (for example, user interface events such as click events) and translates into what will be passed as a parameter to the model () function.  This can be a simple string for setting the model value or a more complex data structure, such as an object. </li><li>  <b>model ()</b> : A function that uses the output from the <b>intent ()</b> function as input to work with the model.  The result of this function is a new model (with an altered state).  Thus it is necessary that the <b>data were immutable</b> .  In the first part, I gave an example with an application counter: we do not change an existing instance of the model, but create a new model according to the changes described in the intent.  The <b>model ()</b> function is only part of the code responsible for creating a new model object.  In essence, the model () function calls the business logic of the application (be it Interactor, UseCase, Repository) and as a result returns a new model object. </li><li>  <b>view ()</b> : A function that receives as input model from <b>model ()</b> and simply displays it.  Normally the view () function looks like <b>view.render (model)</b> . </li></ul><br>  Let's return to our task.  We want to create a reactive application.  But is MVI reactive?  What does reactivity really mean in this context? <br><br>  By reactivity, we mean an application with a UI that responds to a state change.  Since the state reflects the model, it is necessary for our business logic to react to events (intents), and at the output to create a model that could be displayed in View by calling the render (model) method. <br><br><h3>  <b>Connect the dots with RxJava</b> </h3><br>  We need the data stream to be unidirectional.  This is where RxJava comes into play.  When creating reactive applications with a unidirectional data flow, it is not necessary to use this particular library.  However, RxJava is well suited for event programming.  And since the UI is based on events, it makes sense to use it. <br><br>  In this article I will describe the creation of a simple application for a fictional online store.  In the application you can search for products and add them to the cart. <br><br>  The finished application will look like this: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/rmR9mV1Dsqk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Source code can be found on <a href="https://github.com/sockeqwe/mosby/tree/master/sample-mvi">github</a> . <br><br>  Let's start with the implementation of the search screen.  First of all, I define a model that will be displayed using View, as described in the first part of this series of articles.  I will write all classes of models with the <b>ViewState</b> suffix, since the model reflects the state. <br><br><div class="spoiler">  <b class="spoiler_title">SearchViewState</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchViewState</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchNotStartedYet</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchViewState</span></span></span><span class="hljs-class"> </span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Loading</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchViewState</span></span></span><span class="hljs-class"> </span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EmptyResult</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchViewState</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String searchQueryText; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EmptyResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String searchQueryText)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.searchQueryText = searchQueryText; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSearchQueryText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> searchQueryText; } } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchResult</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchViewState</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String searchQueryText; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;Product&gt; result; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SearchResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String searchQueryText, List&lt;Product&gt; result)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.searchQueryText = searchQueryText; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.result = result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSearchQueryText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> searchQueryText; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Product&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Error</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchViewState</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String searchQueryText; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Throwable error; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Error</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String searchQueryText, Throwable error)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.searchQueryText = searchQueryText; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.error = error; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSearchQueryText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> searchQueryText; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Throwable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> error; } }</code> </pre> <br></div></div><br>  Java is a strongly typed language, so I chose a type-safe approach to creating a model, dividing each substate within a class.  The business logic will return an object of type <b>SearchViewState</b> , which may be an instance of SearchViewState.Error, etc.  This is my personal preference, you can design the model in your own way. <br><br>  Focus on business logic.  Create a <b>SearchInteractor</b> that will be responsible for the search.  The result of the execution will be a SearchViewState object. <br><br><div class="spoiler">  <b class="spoiler_title">SearchInteractor</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchInteractor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SearchEngine searchEngine; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Observable&lt;SearchViewState&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">search</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String searchString)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (searchString.isEmpty()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Observable.just(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SearchViewState.SearchNotStartedYet()); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> searchEngine.searchFor(searchString) .map(products -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (products.isEmpty()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SearchViewState.EmptyResult(searchString); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SearchViewState.SearchResult(searchString, products); } }) .startWith(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SearchViewState.Loading()) .onErrorReturn(error -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SearchViewState.Error(searchString, error)); } }</code> </pre><br></div></div><br>  Let's look at the signature of the <b>SearchInteractor.search ()</b> method: there is an input parameter <b>searchString</b> and an output parameter <b>Observable &lt;SearchViewState&gt;</b> .  This suggests that on the observed stream, we expect an arbitrary number of SearchViewState instances.  The <b>startWith ()</b> method is needed to search SearchViewState.Loading before starting a search query.  Then View will be able to show the progressBar during the execution of the search. <br><br>  The <b>onErrorReturn ()</b> method catches any exceptions that may occur during the execution of a search, and throws <b>SearchViewState.Error</b> .  We cannot just use the onError () callback when subscribing to Observable.  This is a common misconception in RxJava: the onError () callback should be used when all of the observed flow encounters fatal errors and the entire flow ends. <br><br>  In our case, the error of not connecting to the Internet does not fall under the definition of fatal errors - this is just one of the states of our model.  In addition, we will be able to switch to another state - <b>SearchViewState.Loading</b> - after the internet connection is available again. <br><br>  Thus, we create an observable flow from business logic to View, which will emit a new model every time the state changes.  We do not need the observed stream to terminate with an error connecting to the Internet, so such errors are treated as a state.  Usually, in MVI, the observed stream never terminates (the onComplete or onError () methods are not called). <br><br>  To summarize: <b>SearchInteractor</b> provides an observable stream of <b>Observable &lt;SearchViewState&gt;</b> and issues a new SearchViewState each time a state changes. <br><br>  Consider what the View layer looks like, which should display the model.  Earlier, I suggested that View had a function <b>render (model)</b> .  In addition, the View should allow other layers to respond to UI events.  In MVI, these events are called <b>intents</b> .  In our case there is only one intent: the user searches for a product by entering a search query in the search field.  In MVP there is a good practice to create an interface for the View layer, we will also do this for MVI. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchView</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Observable&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">searchIntent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SearchViewState viewState)</span></span></span></span>; }</code> </pre><br>  In our case, View provides only one intent, but depending on the task there may be several of them. <br><br>  In the first part, we discussed why using a single render () method is a good solution.  Before creating a specific implementation of the View layer, let's take a look at how the final version will look like: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/07pkkbFQhtk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><div class="spoiler">  <b class="spoiler_title">SearchFragment</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchFragment</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fragment</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchView</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@BindView</span></span>(R.id.searchView) android.widget.SearchView searchView; <span class="hljs-meta"><span class="hljs-meta">@BindView</span></span>(R.id.container) ViewGroup container; <span class="hljs-meta"><span class="hljs-meta">@BindView</span></span>(R.id.loadingView) View loadingView; <span class="hljs-meta"><span class="hljs-meta">@BindView</span></span>(R.id.errorView) TextView errorView; <span class="hljs-meta"><span class="hljs-meta">@BindView</span></span>(R.id.recyclerView) RecyclerView recyclerView; <span class="hljs-meta"><span class="hljs-meta">@BindView</span></span>(R.id.emptyView) View emptyView; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SearchAdapter adapter; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Observable&lt;String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">searchIntent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RxSearchView.queryTextChanges(searchView) .filter(queryString -&gt; queryString.length() &gt; <span class="hljs-number"><span class="hljs-number">3</span></span> || queryString.length() == <span class="hljs-number"><span class="hljs-number">0</span></span>) .debounce(<span class="hljs-number"><span class="hljs-number">500</span></span>, TimeUnit.MILLISECONDS); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SearchViewState viewState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (viewState <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> SearchViewState.SearchNotStartedYet) { renderSearchNotStarted(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (viewState <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> SearchViewState.Loading) { renderLoading(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (viewState <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> SearchViewState.SearchResult) { renderResult(((SearchViewState.SearchResult) viewState).getResult()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (viewState <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> SearchViewState.EmptyResult) { renderEmptyResult(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (viewState <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> SearchViewState.Error) { renderError(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(<span class="hljs-string"><span class="hljs-string">"Don't know how to render viewState "</span></span> + viewState); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;Product&gt; result)</span></span></span><span class="hljs-function"> </span></span>{ TransitionManager.beginDelayedTransition(container); recyclerView.setVisibility(View.VISIBLE); loadingView.setVisibility(View.GONE); emptyView.setVisibility(View.GONE); errorView.setVisibility(View.GONE); adapter.setProducts(result); adapter.notifyDataSetChanged(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderSearchNotStarted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ recyclerView.setVisibility(View.GONE); loadingView.setVisibility(View.GONE); errorView.setVisibility(View.GONE); emptyView.setVisibility(View.GONE); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderLoading</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ recyclerView.setVisibility(View.GONE); loadingView.setVisibility(View.VISIBLE); errorView.setVisibility(View.GONE); emptyView.setVisibility(View.GONE); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ recyclerView.setVisibility(View.GONE); loadingView.setVisibility(View.GONE); errorView.setVisibility(View.VISIBLE); emptyView.setVisibility(View.GONE); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderEmptyResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ recyclerView.setVisibility(View.GONE); loadingView.setVisibility(View.GONE); errorView.setVisibility(View.GONE); emptyView.setVisibility(View.VISIBLE); } }</code> </pre><br></div></div><br>  The <b>render (SearchViewState)</b> method should look succinct.  In <b>searchIntent ()</b> I use the <a href="https://github.com/JakeWharton/RxBinding">RxBindings</a> library.  RxSearchView.queryText () creates an Observable that issues a string every time a user enters something into the EditText widget.  I use filter () to start a search query after entering three or more characters.  We do not need the search request to be sent to the server every time a user enters a new character, so I added a debounce () operator. <br><br>  We know that the input data stream for this screen is the searchIntent () method, and the output data stream is the render () method. <br><br>  The following video demonstrates how the interaction between these two streams occurs. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/oo0SBtqKhMw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  The question remains, how to link the intent and business logic?  If you carefully watch the video, you will see the <b>flatMap ()</b> operator in the middle.  This indicates the presence of an additional component, which I did not mention - <b>Presenter</b> , which is responsible for connecting the layers. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchPresenter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MviBasePresenter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchView</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchViewState</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SearchInteractor searchInteractor; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bindIntents</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Observable&lt;SearchViewState&gt; search = intent(SearchView::searchIntent) .switchMap(searchInteractor::search) <span class="hljs-comment"><span class="hljs-comment">//     flatMap(),      switchMap() .observeOn(AndroidSchedulers.mainThread()); subscribeViewState(search, SearchView::render); } }</span></span></code> </pre><br>  What is <b>MviBasePresenter</b> , methods <b>intent ()</b> and <b>subscribeViewState ()</b> .  This class is part of the <a href="https://github.com/sockeqwe/mosby">Mosby</a> library.  It should say a few words about Mosby and how MviBasePresenter works.  Let's start with the life cycle: MviBasePresenter doesn't have it.  The <b>bindIntent ()</b> method binds the intent from the View to business logic.  As a rule, flatMap () or switchMap () is used to send an intent to business logic.  This method is called once when View joins the Presenter, but is not called after the View joins the Presenter again, for example, after changing the orientation of the screen. <br><br>  It may be asked whether MviBasePresenter can really survive the screen orientation change, and if so, how does Mosby ensure that the observed stream does not ‚Äúleak‚Äù?  For this purpose <b>integer ()</b> and <b>subscribeViewState ()</b> methods are intended. <br><br>  <b>intent ()</b> creates a <b>PublishSubject</b> inside the Presenter and uses it as a ‚Äúgateway‚Äù for business logic.  PublishSubject subscribes to the View.  The invoice call (O1) actually returns a PublishSubject that is subscribed to O1. <br><br>  After changing the screen orientation, Mosby disconnects the View from the Presenter, but only temporarily unsubscribes the internal PublishSubject from the View and reassigns the PublishSubject to the View intent when the View rejoins the Presenter. <br><br>  <b>subscribeViewState ()</b> does the same in the opposite direction.  It creates inside the Presenter <b>BehaviorSubject</b> as a ‚Äúgateway‚Äù from business logic to View.  Since this is a BehaviorSubject, we can get an updated model from business logic even when View is disconnected from Presenter.  The BehaviorSubject always stores the last value it received, and repeats it when View joins the Presenter again. <br><br>  Simple rule: use the intent () method to wrap any intent.  Use subscribeViewState () instead of Observable.subscribe (...). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/3c7/cd1/c6c/3c7cd1c6cb304108a12f456052bde440.png"></div><br><br>  What about other life cycle events, such as <b>onPause ()</b> or <b>onResume ()</b> ?  I still think <a href="http://hannesdorfmann.com/android/presenters-dont-need-lifecycle">that the presenter does not need life cycle events</a> .  However, if you really think you need them, you can create them as an intent.  In your View, <b>pauseIntent ()</b> will appear, the launch of which initiates the Android life cycle, not the user's action. <br><br><h3>  <b>Conclusion</b> </h3><br>  In this part we talked about the basics of MVI and implemented a simple screen.  This example is probably too simple to understand all the advantages of MVI.  There is nothing wrong with MVP or MVVM, and I‚Äôm not saying that MVI is better than other architectural templates.  Nevertheless, I believe that MVI helps us write more elegant code for complex problems, as we will see in the next section, which will talk about <b>state reducer</b> . </div><p>Source: <a href="https://habr.com/ru/post/338558/">https://habr.com/ru/post/338558/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338544/index.html">Creating a sound effects synthesizer from retro games</a></li>
<li><a href="../338548/index.html">How to distinguish birds from flowers. Or flowers from birds</a></li>
<li><a href="../338550/index.html">MVP recommendation system for GitHub weekly</a></li>
<li><a href="../338554/index.html">Visualization of election results in Moscow on a map in Jupyter Notebook</a></li>
<li><a href="../338556/index.html">Go: 10 years and grow further</a></li>
<li><a href="../338560/index.html">Who, how and why is going to regulate Big Data in Russia?</a></li>
<li><a href="../338562/index.html">20 years to Yandex. Lecture by Ilya Segalovich - the person who invented this word</a></li>
<li><a href="../338564/index.html">Your own Python cover server for Internet radio</a></li>
<li><a href="../338568/index.html">Creating the Google Maps API Maps Component with VueJs2</a></li>
<li><a href="../338572/index.html">Eggs Datacenter: how Emercoin allowed to implement the idea of ‚Äã‚Äãa distributed data center on the blockchain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>