<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JUndo - undo library for Java</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 


 At the end of last year, I needed an undo / redo tool for a Java project that, in addition to the standard tasks for this concept, wo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JUndo - undo library for Java</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/s5/rp/et/s5rpethe0sriebl74tlmu--7qbk.gif"></p><br><h3 id="vvedenie">  Introduction </h3><br><p>  At the end of last year, I needed an undo / redo tool for a Java project that, in addition to the standard tasks for this concept, would be able to keep the history of commands and correctly handle the binding to a changing address context (this is with a view to my upcoming project for Android and its regular re-creation of views).  I looked, I did not find it, I took it. </p><br><p>  The result was <a href="https://github.com/ValeriusGC/jundo">the JUndo library</a> . </p><a name="habracut"></a><br><h3 id="vozmozhnosti">  Opportunities </h3><br><ul><li>  Saving command history for use somewhere else, in another place </li><li>  Maintain subject-matter versions for migration during restoration </li><li>  Local contexts - the mechanism for using commands in another address space </li><li>  Creating macros to automate the execution of command chains </li><li>  Creating a clean state - "save points" (for example, on the disk), to quickly return to this state </li><li>  Additional events for manual setup of save and restore if necessary </li></ul><br><blockquote>  The term "subject" in the context of the library is an element of the application, all without exception of which changes are made through commands.  Failure to comply with this condition will unambiguously lead to unpredictable behavior of the undo / redo methods and, quite possibly, to the crash of the application.&gt; </blockquote><p>  To be honest, it wasn‚Äôt too easy to do, mainly due to the maintenance of the concept of transferring commands to another address context. </p><br><p>  The saving itself is based on the standard Java serialization mechanism, so all automatically saved library classes implement Serialize.  Those that do not implement, you need to adjust the pens when saving / restoring.  But, although it sounds cumbersome, in fact, is not so difficult. </p><br><hr><br><p>  <strong>Important points</strong> </p><br><ul><li>  When designing a stack, you should consider what will be the subject of the stack, which is local contexts. </li><li>  When designing commands, what information will be part of the class (its fields), and what information will be dynamically connected at the time of execution. </li></ul><br><blockquote>  The general rule is this: widgets, views, resources, and everything that is a dependent part of the local address space should be connected to local stack contexts and used dynamically.  If you save them along with a stack of commands, then when you re-create in a new address space, trouble will surely happen. </blockquote><br><hr><br><div class="spoiler">  <b class="spoiler_title">How it works - a simple example</b> <div class="spoiler_text"><h3 id="kak-eto-rabotaet---prostoy-primer">  How it works - a simple example </h3><br><p> The subject is the fictional class <code>NonTrivialClass</code> , with a list of two types of objects - RECT &amp; CIRCLE. </p><br><h4 id="0-dizayn">  0. Design </h4><br><ul><li>  There is no binding to local context objects, we do not reflect them on the stack. </li><li>  An instance of <code>NonTrivialClass</code> does not depend on the address context, so it can be a stack subject </li><li>  For the same reason, we can keep references to the <code>NonTrivialClass</code> instance in commands </li></ul><br><h4 id="1-sozdaem-ekzemplyar-stek-i-nablyudatelya-za-sobytiyami">  1. Create an instance, stack, and event watcher </h4><br><pre> <code class="java hljs">NonTrivialClass ntc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NonTrivialClass(); UndoStack stack = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UndoStack(ntc, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  NonTrivialClass    stack.setWatcher(new SimpleUndoWatcher()); //  .    `UndoPacket...store()`</span></span></code> </pre> <br><h4 id="2-rabotaem-nad-subektom">  2. Work on the subject </h4><br><p>  All changes over the subject - only through the team.  More behaviors are required - add commands. </p><br><pre> <code class="java hljs">stack.push(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NonTrivialClass.AddCommand(stack, CIRCLE, ntc, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)); stack.push(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NonTrivialClass.AddCommand(stack, RECT, ntc, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)); stack.undo(); stack.redo(); stack.push(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NonTrivialClass.MovedCommand(stack, item, oldPos, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)); stack.undo(); stack.redo(); stack.push(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NonTrivialClass.DeleteCommand(stack, ntc, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)); stack.undo(); stack.undo(); stack.redo();</code> </pre> <br><h4 id="3-sohranyaem-istoriyu">  3. Save history </h4><br><pre> <code class="java hljs">String store = UndoPacket <span class="hljs-comment"><span class="hljs-comment">//       . //      . .make(stack, "some.NonTrivialClass", 1) //    gzip .zipped(true) // NonTrivialClass  Serializable,    . //.onStore(...) .store();</span></span></code> </pre> <br><p>  <em><code>SimpleUndoWatcher</code> automatically.</em> </p><br><h4 id="4-vosstanavlivaem-gde-to-v-drugom-adresnom-kontekste-polzuemsya-dalee">  4. Restoring somewhere in a different address context, use further </h4><br><pre> <code class="java hljs">UndoStack stackBack = UndoPacket <span class="hljs-comment"><span class="hljs-comment">//  ,     .peek(store, null) .restore(null) .stack(null); //   . stack.setWatcher(new SimpleUndoWatcher()); //   ,  . stack.undo(); stack.redo(); stack.push(new NonTrivialClass.MovedCommand(stack, item, oldPos, null)); stack.undo(); stack.redo();</span></span></code> </pre> </div></div><br><p>  Nothing complicated, but nothing particularly interesting.  The juice is how address contexts are handled during the transfer of history, how migration support is implemented, and other goodies. </p><br><div class="spoiler">  <b class="spoiler_title">How it works - a complicated example.</b> <div class="spoiler_text"><h3 id="kak-eto-rabotaet---slozhnyy-primer">  How it works - a complicated example. </h3><br><p>  This is part of <a href="https://github.com/ValeriusGC/jundo_javafx_sample">the JavaFx</a> code <a href="https://github.com/ValeriusGC/jundo_javafx_sample">example</a> . </p><br><p>  The example further illustrates the subject's migration to another version and the use of local contexts, including string resources. </p><br><h4 id="0-dizayn-1">  0. Design ... </h4><br><h5 id="komand">  ... teams </h5><br><p>  We manage the properties of an instance of the <code>javafx.scene.shape.Circle</code> class. </p><br><ul><li>  the class does not implement <code>Serializable</code> and is not even serialized to JSON without a tambourine, so we will not use it in the command fields.  Instead, we will save the properties that we specifically control: <code>ColorUndo</code> will store <code>color</code> , <code>RadiusUndo</code> - <code>radius</code> and so on. </li><li>  commands have the Caption property, which may depend on the context, because it is possible that recovery will occur in an application with a different location, and with a different version of string resources.  Therefore, we will store resource identifiers, and query the rows themselves dynamically through local stack contexts. </li><li>  <code>javafx.scene.control.Slider</code> controls that change the <code>x</code> , <code>y</code> and <code>radius</code> properties have the feature of generating events when the change is even a pixel.  We have absolutely no need for 100 teams when transferring a subject by 100 pixels, only a command for the final position is needed.  Therefore, we use the property of gluing commands using <code>UndoCommand#id</code> </li></ul><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// resId -     Caption. public ColorUndo(@NotNull UndoStack owner, UndoCommand parent, int resId, Color oldV, Color newV) { super(owner, parent, resId, // Color   Serializable,       . FxGson.createWithExtras().toJson(oldV), FxGson.createWithExtras().toJson(newV)); } @Override protected void doRedo() { //     . //  , ,    . ColorPicker cp = (ColorPicker) owner.getLocalContexts().get(IDS_COLOR_PICKER); Color cl = FxGson.createWithExtras().fromJson(newV, Color.class); cp.setValue(cl); } @Override protected void doUndo() { //     . //  , ,    . ColorPicker cp = (ColorPicker) owner.getLocalContexts().get(IDS_COLOR_PICKER); Color cl = FxGson.createWithExtras().fromJson(oldV, Color.class); cp.setValue(cl); } @Override public int id() { return 1001; //   XUndo (return 1002)  YUndo (return 1003) } /** *   ,            * ,    ,   {@link ColorUndo}    ,   . * &lt;p&gt;        ,     redo   undo   . */ @Override public boolean mergeWith(@NotNull UndoCommand cmd) { if(cmd instanceof RadiusUndo) { RadiusUndo ruCmd = (RadiusUndo)cmd; newV = ruCmd.newV; return true; } return false; } @Override public String getCaption() { //     . //  , ,    . Resources res = (Resources) owner.getLocalContexts().get(IDS_RES); return res.getString(resId); }</span></span></code> </pre> <br><h5 id="steka">  ... stack </h5><br><p>  The properties of the subject are controlled through the scene widgets, and these are local contexts, since in a different address space all saved links will be invalid. </p><br><h4 id="1-sozdaem-stek-i-nablyudatelya-za-sobytiyami">  1. Create a stack and an observer of events </h4><br><pre> <code class="java hljs">stack = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UndoStack(tab.shape, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    stack.getLocalContexts().put(BaseTab.UndoBulk.IDS_RES, new Resources_V1()); stack.getLocalContexts().put(BaseTab.UndoBulk.IDS_COLOR_PICKER, tab.colorPicker); stack.getLocalContexts().put(BaseTab.UndoBulk.IDS_RADIUS_SLIDER, tab.radius); stack.getLocalContexts().put(BaseTab.UndoBulk.IDS_X_SLIDER, tab.centerX); stack.getLocalContexts().put(BaseTab.UndoBulk.IDS_Y_SLIDER, tab.centerY); //    UndoStack stack.setWatcher(this);</span></span></code> </pre> <br><h4 id="2-rabotaem-nad-subektom-1">  2. Work on the subject </h4><br><p>  Work is performed automatically by linking to widget events and stack events. </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//       tab.shape.fillProperty().addListener( (observable, oldValue, newValue) -&gt; stack.push(new BaseTab.UndoBulk.ColorUndo( stack, null, 0, (Color)oldValue, (Color)newValue) )); //  undo/redo   tab.undoBtn.setOnAction(event -&gt; stack.undo()); tab.redoBtn.setOnAction(event -&gt; stack.redo()); tab.saveBtn.setOnAction(event -&gt; stack.setClean()); /** *      {@link UndoWatcher} * @param idx */ @Override public void indexChanged(int idx) { tab.undoBtn.setDisable(!stack.canUndo()); tab.redoBtn.setDisable(!stack.canRedo()); tab.saveBtn.setDisable(stack.isClean()); tab.undoBtn.setText("undo: " + stack.undoCaption()); tab.redoBtn.setText("redo: " + stack.redoCaption()); }</span></span></code> </pre> <br><h4 id="3-sohranyaem-istoriyu-1">  3. Save history </h4><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** *        . *         . *      ? *    ,              . *                ,        . */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { String store = UndoPacket .make(stack, IDS_STACK, <span class="hljs-number"><span class="hljs-number">1</span></span>) .onStore(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UndoPacket.OnStore() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Serializable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object subj)</span></span></span><span class="hljs-function"> </span></span>{ Map&lt;String, Object&gt; props = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); Gson fxGson = FxGson.createWithExtras(); props.put(<span class="hljs-string"><span class="hljs-string">"color"</span></span>, FxGson.createWithExtras().toJson(tab.shape.getFill())); props.put(<span class="hljs-string"><span class="hljs-string">"radius"</span></span>, FxGson.createWithExtras().toJson(tab.shape.getRadius())); props.put(<span class="hljs-string"><span class="hljs-string">"x"</span></span>, FxGson.createWithExtras().toJson(tab.shape.getCenterX())); props.put(<span class="hljs-string"><span class="hljs-string">"y"</span></span>, FxGson.createWithExtras().toJson(tab.shape.getCenterY())); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fxGson.toJson(props); } }) .zipped(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) .store(); <span class="hljs-comment"><span class="hljs-comment">//         . Files.write(Paths.get("./undo.txt"), store.getBytes()); } catch (Exception e) { System.err.println(e.getLocalizedMessage()); } }</span></span></code> </pre> <br><h4 id="4-vosstanavlivaem-gde-to-v-drugom-adresnom-kontekste-polzuemsya-dalee-1">  4. Restoring somewhere in a different address context, use further </h4><br><p>  In our situation, we restore the history for a new instance of the subject, on another tab and moreover - the new subject has a new type of <code>Circle_V2</code> . <br>  Here is how it is handled. </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//   String store = new String(Files.readAllBytes(Paths.get("./undo.txt"))); stack = UndoPacket //  ,   ,        . .peek(store, subjInfo -&gt; IDS_STACK.equals(subjInfo.id)) // -,       (     ) // -,      .restore((processedSubj, subjInfo) -&gt; { // 1. Type type = new TypeToken&lt;HashMap&lt;String, Object&gt;&gt;(){}.getType(); HashMap&lt;String, Object&gt; map = new Gson().fromJson((String) processedSubj, type); if(subjInfo.version == 1) { // 2. Gson fxGson = FxGson.createWithExtras(); Color c = fxGson.fromJson(map.get("color").toString(), Color.class); tab.colorPicker.setValue(c); Double r = fxGson.fromJson(map.get("radius").toString(), Double.class); tab.radius.setValue(r); Double x = fxGson.fromJson(map.get("x").toString(), Double.class); tab.centerX.setValue(x); Double y = fxGson.fromJson(map.get("y").toString(), Double.class); tab.centerY.setValue(y); } return map; }).stack((stack, subjInfo) -&gt; { //       stack.getLocalContexts().put(BaseTab.UndoBulk.IDS_RES, new Resources_V2()); stack.getLocalContexts().put(BaseTab.UndoBulk.IDS_COLOR_PICKER, tab.colorPicker); stack.getLocalContexts().put(BaseTab.UndoBulk.IDS_RADIUS_SLIDER, tab.radius); stack.getLocalContexts().put(BaseTab.UndoBulk.IDS_X_SLIDER, tab.centerX); stack.getLocalContexts().put(BaseTab.UndoBulk.IDS_Y_SLIDER, tab.centerY); }); if(null == stack) stack = new UndoStack(tab.shape, null); //   . stack.setWatcher(this);</span></span></code> </pre> <br><p>  The remaining actions for connecting the stack events and for the stack are similar to those in the <strong>"2.Work over the subject"</strong> step described earlier. </p><br><p>  As can be seen, with proper design of a specific project, working with the library is quite logical and simple. </p></div></div><br><h2 id="o-dizayne-biblioteki">  About library design </h2><br><p>  <strong>JUndo</strong> is a <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25BC%25D0%25B0%25D0%25BD%25D0%25B4%25D0%25B0_(%25D1%2588%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)">pattern</a> implementation. A <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25BC%25D0%25B0%25D0%25BD%25D0%25B4%25D0%25B0_(%25D1%2588%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)"><strong>command</strong></a> for creating Undo / Redo chains in an application. </p><br><p>  The <strong>command</strong> pattern is based on the assumption that all changes of the subjects are made through the creation of the objects of the corresponding commands.  Command objects save the state of the subject, make the necessary changes, and are consistently stored on the command stack.  Accordingly, each team knows how to return the subject to a previous state.  As long as the ‚Äúchange through commands‚Äù model is not violated, there is always the option to roll back at any time, simply by sequentially executing Undo, command by command on the stack, and returning back, executing Redo in the forward direction. </p><br><h3 id="klassy">  Classes </h3><br><p>  The library consists of the following main classes and interfaces: </p><br><ul><li>  class <code>UndoCommand</code> : base class for commands stored on the stack.  Apply the redo / undo command to an atomic change in a subject. </li><li>  class <code>UndoStack</code> : command stack.  Contains a list of consecutively added command objects executed on a specific subject and can "roll back" the state of the subject to any point forward and backward. </li><li>  class <code>UndoGroup</code> : stack group.  Grouping stacks is convenient when the application has more than one subject (for example, open documents), and it is necessary for each to store an individual undo / redo state.  UndoGroup has an active stack property that allows you to seamlessly switch between subjects and perform undo / redo on each of them. </li><li>  class <code>UndoPacket</code> : class management of the preservation and restoration of the stack.  Additional information that can be saved while saving allows you to learn how to correctly interpret the subjects on the recovery side, in particular, the version of the subject (which is useful when migrating data) </li><li>  interface <code>UndoWatcher</code> : set of events for subscribers needing information about command stack events.  All methods are defaulted, so the subscriber is not required to implement what he does not need </li></ul><br><p>  Additional classes and interfaces: </p><br><ul><li>  class <code>RefCmd&lt;V&gt;</code> : A convenient template command that allows you to implement simple data changes without creating additional classes </li><li>  interface <code>Getter&lt;V&gt;</code> : Helper interface for the getter property of the <code>RefCmd&lt;V&gt;</code> command </li><li>  interface <code>Setter&lt;V&gt;</code> : Helper interface for the setter property of the <code>RefCmd&lt;V&gt;</code> command </li></ul><br><h3 id="koncepcii">  Concepts </h3><br><ul><li>  <strong>One subject - one stack</strong> : it is not only illogical but also dangerous from the point of view of the stability of the application when performing undo / redo;  the most different collisions are possible.  Therefore, it is not possible to place 2 stacks with the same subject in a group.  Although this does not help if the developer decides to use such a potentially dangerous situation for ungrouped stacks. </li><li>  <strong>Clean state</strong> : can be used to signal that a subject crosses the moment when saving to disk occurred.  Useful for displaying the application‚Äôs dependent visual controls (availability of the Save button, etc.) or quickly returning to the state when the subject was saved. </li><li>  <strong>Merge commands</strong> : used to merge sequences of the same type into a single command.  In a text document, you can use to combine the printing of single characters into a command that prints a whole word.  In the graphic, you can combine the multiple movement of the subject from the starting point to the end point in one movement </li><li>  <strong>Macros</strong> : a sequence of commands executed undo / redo at a time.  This simplifies the creation of tasks for applications when a set of interrelated commands must be executed simultaneously.  For example, deleting / restoring a set of selected objects of a graphic scene can be arranged as a "Delete selected objects" macro. </li><li>  <strong>Smart save</strong> : allows <br><ul><li>  save the identifier and version of the subject for proper interpretation when restoring </li><li>  process non-serializable subjects through manual control in custom events </li><li>  save useful information in key-value format </li></ul></li><li>  <strong>Local contexts</strong> : an indispensable mechanism in the case of the dependence of commands on objects of reference type that have local addressing;  such objects cannot be saved, since it is not known in what address context the subject and his UndoStack will be used after unpacking.  Local contexts allow you to bind similar objects by identifiers on the recovery side </li></ul><br><br><h2 id="pravila">  rules </h2><br><h3 id="odin-subekt---odin-stek-komand">  One subject - one team stack </h3><br><p>  This rule is described above and is quite obvious from the elementary logic of the uniqueness of the chain of changes for the subject. </p><br><h3 id="lyuboe-izmenenie-svoystva-subekta---tolko-cherez-komandy">  Any change in subject property ‚Äî only through commands </h3><br><p>  If commands do not control the total change of property from beginning to end, they do not control it at all. <br>  Here we must understand that you can choose to control only certain properties, for example - color or size, the main thing is to follow this rule. <br>  It will certainly look strange at work - but at least consistent. </p><br><h3 id="vse-chto-ne-serializable---cherez-sobytiya-onstoreonrestore">  All that is not Serializable - via OnStore / OnRestore events </h3><br><p>  Under the hood of the library - work with the ObjectOutputStream methods, and not only when saving / restoring.  When the stack works with macros, serialization is also used. <br>  Therefore, when designing commands, you should not save non-serializable types in the fields, since there is no way to process them - you should use dynamic references to them in the doUndo / doRedo methods and so on through calls to local stack contexts (UndoCommand # owner). <br>  Non-serializable subjects should be manually converted to strings or another Serializable type in the onStore () / restore () methods. </p><br><h3 id="vse-chto-privyazano-k-adresam-v-pamyati---cherez-lokalnye-konteksty">  All that is bound to addresses in memory is through local contexts. </h3><br><p>  When restoring a stack in a different address space, most likely all saved links will become invalid.  Therefore, you should get rid of their preservation as much as possible, replacing them with work with local contexts. </p><br><div class="spoiler">  <b class="spoiler_title">Small HowTo for additional options</b> <div class="spoiler_text"><h2 id="howto">  Howto </h2><br><h3 id="sozdat-makros">  Create macro </h3><br><p>  A macro is a given sequence of commands for automating a chain of actions.  A characteristic feature of the macro is the possibility of its use at any time, as an independent atomic macro with a write to the stack.  For example, the macro </p><br><pre> <code class="java hljs">stack.beginMacro(<span class="hljs-string"><span class="hljs-string">"new line"</span></span>); AddLineCmd(stack, <span class="hljs-string"><span class="hljs-string">"add line"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) AddSymbolCmd(stack, <span class="hljs-string"><span class="hljs-string">"add char"</span></span>, <span class="hljs-string"><span class="hljs-string">":"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) AddSymbolCmd(stack, <span class="hljs-string"><span class="hljs-string">"add char"</span></span>, <span class="hljs-string"><span class="hljs-string">"~"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) AddSymbolCmd(stack, <span class="hljs-string"><span class="hljs-string">"add char"</span></span>, <span class="hljs-string"><span class="hljs-string">"$"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) AddSymbolCmd(stack, <span class="hljs-string"><span class="hljs-string">"add char"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) stack.endMacro();</code> </pre> <br><p>  called at any time should add a new line and characters in it </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//  :~$ String 1 :~$ String 2 :~$ String 3| //  stack.push(some_macro); //  :~$ String 1 :~$ String 2 :~$ String 3 :~$ |</span></span></code> </pre> <br><p>  <code>UndoStackTest</code> contains a <code>testRealMacros()</code> test that describes how it works: </p><br><pre> <code class="java hljs"> ... <span class="hljs-comment"><span class="hljs-comment">//      stack.beginMacro("macro 1"); stack.push(new TextSampleCommands.AddString(stack, "new string", "Hello", null)); stack.push(new TextSampleCommands.AddString(stack, "new string", ", ", null)); stack.push(new TextSampleCommands.AddString(stack, "new string", "world!", null)); //         ,  "Hello, world!" stack.endMacro(); ... //  -    UndoCommand macro = stack.clone(stack.getMacros().get(0)); stack.push(macro); //   "Hello, world!" stack.undo(); //   "Hello, world!" stack.redo(); //    "Hello, world!" ... }</span></span></code> </pre> <br><p>  Naturally, macros are also saved and restored along with the stack. </p><br><h3 id="sozdat-cepochku-komand-bez-ispolzovaniya-makrosov">  Create a chain of commands without using macros </h3><br><p>  Create a basic command of the UndoCommand type, and for all subsequent ones, specify it as a parent.  Add only the first command to the stack.  Thus, all subsequent commands will not be in the stack, but in the list of subcommands of the first command, and will automatically be executed when <code>UndoStack.undo/redo</code> called: </p><br><pre> <code class="java hljs">UndoCommand parent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UndoCommand(<span class="hljs-string"><span class="hljs-string">"Add robot"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AddShapeCommand(doc, ShapeRectangle, parent); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AddShapeCommand(doc, ShapeRectangle, parent); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AddShapeCommand(doc, ShapeRectangle, parent); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AddShapeCommand(doc, ShapeRectangle, parent); doc.undoStack().push(parent);</code> </pre> </div></div><br><hr><br><ul><li>  The library itself is <a href="https://github.com/ValeriusGC/jundo">here</a> </li><li>  An example of use in an application with JavaFx <a href="https://github.com/ValeriusGC/jundo_javafx_sample">here</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/347128/">https://habr.com/ru/post/347128/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347114/index.html">Let there be rock: PHDays 8 will host a music festival</a></li>
<li><a href="../347118/index.html">VMware Dispatch: a new framework for working with serverless applications</a></li>
<li><a href="../347120/index.html">Own pix2code with blackjack, but without neurons</a></li>
<li><a href="../347124/index.html">How dtraceasm works in JMH</a></li>
<li><a href="../347126/index.html">Reactive forms (reactive forms) Angular 5 (2+). Part 2</a></li>
<li><a href="../347130/index.html">7 types of office loafers - part one</a></li>
<li><a href="../347132/index.html">We comprehend C deeper using assembler. Part 3</a></li>
<li><a href="../347134/index.html">16 Tons. How I saved a dying WordPress site with very superficial knowledge of this CMS</a></li>
<li><a href="../347138/index.html">Making games in Python 3 and Pygame: Part 1</a></li>
<li><a href="../347140/index.html">How to cook AR on android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>