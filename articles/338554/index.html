<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Visualization of election results in Moscow on a map in Jupyter Notebook</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 


 Today we will talk about the visualization of geodata. Having statistics, obviously having a spatial reference, you always want to make a b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Visualization of election results in Moscow on a map in Jupyter Notebook</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/13c/684/348/13c68434804b4b56a984f4e30caa729c.png"><br>  Hello! </p><br><p>  Today we will talk about the visualization of geodata.  Having statistics, obviously having a spatial reference, you always want to make a beautiful map.  Preferably, with navigation and infoboxes In notebooks.  And, of course, so that later you can show your progress in visualization to the entire Internet! </p><br><p>  As an example, we take the recently passed municipal elections in Moscow.  The data itself can be taken from the Moscow City Election Committee site, you can simply pick up data from <a href="https://gudkov.ru/">https://gudkov.ru/</a> .  There is even some visualization there, but we will go deeper.  So, what should we get in the end? </p><a name="habracut"></a><br><p>  Having spent some time writing the Parser of the Election Commission website, I received the data I needed.  So let's start with imports. </p><br><div class="spoiler">  <b class="spoiler_title">imports</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pandas <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pd <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pickle</code> </pre> </div></div><br><p>  I work in a jupyter notebook on a Linux machine.  If you want to use my code on a Windows machine, then pay attention to writing paths, as well as important digressions in the text. </p><br><p>  I usually use a separate folder for the project, so for simplicity I set the current directory: </p><br><pre> <code class="python hljs">os.chdir(<span class="hljs-string"><span class="hljs-string">'/data01/jupyter/notebooks/habr/ods_votes/'</span></span>)</code> </pre> <br><p>  Then we are asked to collect data from the Election Commission website itself.  To parse the data, I wrote a separate parser.  The whole process takes 10-15 minutes.  You can pick it up from the <a href="https://github.com/fall-out-bug/izbirkom_parser">repository</a> . </p><br><p>  I decided to create a large dictionary with data frames inside.  To turn html pages into data frames, I used read_html, I empirically selected the necessary data frames, and after that I did a little processing, throwing out the excess and adding the missing.  I previously processed the data by batch.  Initially, they were not particularly readable.  In addition, there is a different spelling of the same parties (funny, but in some cases it is not a different spelling, but really different parties). </p><br><h1 id="razbor-dannyh-izbirkoma">  Parsing election committee data </h1><br><p>  Directly build directory.  What's going on here: </p><br><ul><li>  structure of administrative and municipal districts; </li><li>  all references to Territorial Election Commissions (TECs) are collected; </li><li>  a list of candidates is compiled for each TEC; </li><li>  within each TEC, District Election Commissions (DECs) are convened; </li><li>  for each DEC, statistics on DEC and statistics on candidates are collected; </li><li>  from the received dataset we collect statistics on municipal districts. </li></ul><br><p>  In the repository of this article are already ready data.  We will use them. </p><br><div class="spoiler">  <b class="spoiler_title">Parsing data</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> glob <span class="hljs-comment"><span class="hljs-comment">#      with open('tmp/party_aliases.pkl', 'rb') as f: party_aliases = pickle.load(f) votes = {} #       votes['atd'] = pd.read_csv('tmp/atd.csv', index_col=0, sep=';') votes['data'] = {} #         for v in votes['atd']['municipal'].values: votes['data'][v] = {} #     candidates = glob.glob('tmp/data_{}_candidates.csv'.format(v))[0] votes['data'][v]['candidates'] = pd.read_csv(candidates, index_col=0, sep=';') votes['data'][v]['votes'] = {} #        #    okrug_stats_list = glob.glob('tmp/data_{}*_okrug_stats.csv'.format(v)) for okrug_stats in okrug_stats_list: okrug = int(okrug_stats.split('_')[2]) try: votes['data'][v]['votes'][okrug] except: votes['data'][v]['votes'][okrug] = {} votes['data'][v]['votes'][okrug]['okrug_stats'] = pd.read_csv(okrug_stats, index_col=0, sep=';') #    candidates_stats_list = glob.glob('tmp/data_{}*_candidates_stats.csv'.format(v)) for candidates_stats in candidates_stats_list: okrug = int(candidates_stats.split('_')[2]) votes['data'][v]['votes'][okrug]['candidates_stats'] = pd.read_csv(candidates_stats, index_col=0, sep=';') #        data = [] #     for okrug in list(votes['data'].keys()): #  candidates = votes['data'][okrug]['candidates'].replace(to_replace={'party':party_aliases}) group_parties = candidates[['party','elected']].groupby('party').count() #      stats = np.zeros(shape=(12)) for oik in votes['data'][okrug]['votes'].keys(): stat = votes['data'][okrug]['votes'][oik]['okrug_stats'].iloc[:,1] stats += stat #     #   sum_parties = group_parties.sum().values[0] #    data_parties = candidates[['party','elected']].groupby('party').count().reset_index() #    data_parties['percent'] = data_parties['elected']/sum_parties*100 #      tops = data_parties.sort_values('elected', ascending=False) c = pd.DataFrame({'okrug':okrug}, index=[0]) c['top1'], c['top1_elected'], c['top1_percent'] = tops.iloc[0,:3] c['top2'], c['top2_elected'], c['top2_percent'] = tops.iloc[1,:3] c['top3'], c['top3_elected'], c['top3_percent'] = tops.iloc[2,:3] c['voters_oa'], c['state_rec'], c['state_given'], c['state_anticip'], c['state_out'], c['state_fired'], c['state_box'], c['state_move'], c['state_error'], c['state_right'], c['state_lost'] , c['state_unacc'] = stats c['voters_percent'] = (c['state_rec'] - c['state_fired'])/c['voters_oa']*100 c['total'] = sum_parties c['full'] = (c['top1_elected']== sum_parties) #      data.append(c) #    winners = pd.concat(data,axis=0)</span></span></code> </pre> </div></div><br><p>  We received a data frame with turnout statistics, ballots (from the number of issued to the number of damaged), the distribution of seats between the parties. <br>  You can start visualization! </p><br><h1 id="bazovaya-rabota-s-geodannymi-v-geopandas">  Basic work with geodata in geopandas </h1><br><p>  To work with geodata we will use the library geopandas.  What is geopandas?  This extension of pandas functionality is geographic abstractions (inherited from Shapely), which allow us to perform analytical geographic operations with geodata: samples, overlay, aggregation (as, for example, in PostGIS for Postgresql). </p><br><p>  Let me remind you that there are three basic types of geometry - a point, a line (or rather, a polyline, since it consists of connected segments) and a polygon.  All of them have a variant of multi- (Multi), where the geometry is the union of individual geographic formations into one.  For example, a metro exit may be a point, but several exits, combined into a ‚Äústation‚Äù entity, are already a multipoint. </p><br><div class="spoiler">  <b class="spoiler_title">Important retreat</b> <div class="spoiler_text"><p>  It should be noted that geopandas are reluctant to install via pip in a standard Python installation in the Windows environment.  The problem, as usual, is in dependencies.  Geopandas relies on the abstraction of the library fiona, which does not have official assemblies for Windows.  Ideal to use the Linux environment, for example, in a docker-container.  In addition, in Windows, you can use the conda manager, it pulls all dependencies from its repositories. </p></div></div><br><p>  With the geometry of municipalities, everything is quite simple.  They can be easily picked up from OpenStreetMap ( <a href="https://habrahabr.ru/post/270513/">read more here</a> ) or, for example, from NextGIS <a href="http://nextgis.ru/services/dataosm/">downloads</a> .  I use already made shapes. </p><br><p>  So, let's begin!  Perform the necessary imports, activate the matplotlib graphics ... </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> geopandas <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> gpd %matplotlib inline mo_gdf = gpd.read_file(<span class="hljs-string"><span class="hljs-string">'atd/mo.shp'</span></span>) mo_gdf.head()</code> </pre> <br><p><img src="https://habrastorage.org/web/6dd/b79/0d9/6ddb790d91a244fbaf2d7a9a472bd423.PNG"></p><br><p>  As you can see, this is a familiar DataFrame.  The geometry field is a representation of geographic objects (in this case polygons) in the form of WKT, well known text (for more information see <a href="https://en.wikipedia.org/wiki/Well-known_text">https://en.wikipedia.org/wiki/Well-known_text</a> ).  You can quite simply build a map of our objects. </p><br><pre> <code class="python hljs">mo_gdf.plot()</code> </pre> <br><p><img src="https://habrastorage.org/web/9c5/a50/654/9c5a50654de84a1fb45058ac9a9123d8.png"></p><br><p>  Guessing Moscow!  True, not quite familiar looks.  The reason is in the projection of the map.  On Habr√© there is already an <a href="https://habrahabr.ru/post/235283/">excellent educational program</a> for them. </p><br><p>  So, let's present our data in a more familiar projection of the Web Mercator (the initial projection can be easily obtained using the crs parameter).  Color the polygons by the name of the administrative district.  Line width set at 0.5.  The cmap coloring method uses the standard matplotlib values ‚Äã‚Äã(if you, like me, do not remember them by heart, then <a href="http://matplotlib.org/users/colormaps.html">here is the cheat sheet</a> ).  To see the map legend, set the legend parameter.  Well, figsize is responsible for the size of our map. </p><br><pre> <code class="python hljs">mo_gdf_wm = mo_gdf.to_crs({<span class="hljs-string"><span class="hljs-string">'init'</span></span> :<span class="hljs-string"><span class="hljs-string">'epsg:3857'</span></span>}) <span class="hljs-comment"><span class="hljs-comment">#   mo_gdf_wm.plot(column = 'ABBREV_AO', linewidth=0.5, cmap='plasma', legend=True, figsize=[15,15])</span></span></code> </pre> <br><p><img src="https://habrastorage.org/web/854/54a/f67/85454af67eea409c8cc005f6ddab5ae6.png"></p><br><p>  You can build a map and the type of municipality: </p><br><pre> <code class="python hljs">mo_gdf_wm.plot(column = <span class="hljs-string"><span class="hljs-string">'TYPE_MO'</span></span>, linewidth=<span class="hljs-number"><span class="hljs-number">0.5</span></span>, cmap=<span class="hljs-string"><span class="hljs-string">'plasma'</span></span>, legend=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, figsize=[<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>])</code> </pre> <br><p><img src="https://habrastorage.org/web/8f7/d39/8b2/8f7d398b2b264052aa13630ae74aa104.png"></p><br><p>  So, we will construct a map of statistics on municipal districts.  We have already created a winners data frame. <br>  We need to connect our data frame with a geodataframe to create a map.  We‚Äôll mix the names of the municipal districts in order to make the connection without surprises. </p><br><pre> <code class="python hljs">winners[<span class="hljs-string"><span class="hljs-string">'municipal_low'</span></span>] = winners[<span class="hljs-string"><span class="hljs-string">'okrug'</span></span>].str.lower() winners[<span class="hljs-string"><span class="hljs-string">'municipal_low'</span></span>] = winners[<span class="hljs-string"><span class="hljs-string">'municipal_low'</span></span>].str.replace(<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) mo_gdf_wm[<span class="hljs-string"><span class="hljs-string">'name_low'</span></span>] = mo_gdf_wm[<span class="hljs-string"><span class="hljs-string">'NAME'</span></span>].str.lower() mo_gdf_wm[<span class="hljs-string"><span class="hljs-string">'name_low'</span></span>] = mo_gdf_wm[<span class="hljs-string"><span class="hljs-string">'name_low'</span></span>].str.replace(<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) full_gdf = winners.merge(mo_gdf_wm[[<span class="hljs-string"><span class="hljs-string">'geometry'</span></span>, <span class="hljs-string"><span class="hljs-string">'name_low'</span></span>]], left_on=<span class="hljs-string"><span class="hljs-string">'municipal_low'</span></span>, right_on=<span class="hljs-string"><span class="hljs-string">'name_low'</span></span>, how=<span class="hljs-string"><span class="hljs-string">'left'</span></span>) full_gdf = gpd.GeoDataFrame(full_gdf)</code> </pre> <br><p>  Let's build a simple categorical map, where the winning parties are shown.  In the Shchukino area this year there really were no elections. </p><br><pre> <code class="python hljs">full_gdf.plot(column = <span class="hljs-string"><span class="hljs-string">'top1'</span></span>, linewidth=<span class="hljs-number"><span class="hljs-number">0</span></span>, cmap=<span class="hljs-string"><span class="hljs-string">'GnBu'</span></span>, legend=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, figsize=[<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>])</code> </pre> <br><p><img src="https://habrastorage.org/web/436/00f/9ac/43600f9acefe40759d8e26bb0e48f6e0.png"></p><br><p>  Turnout: </p><br><pre> <code class="python hljs">full_gdf.plot(column = <span class="hljs-string"><span class="hljs-string">'voters_percent'</span></span>, linewidth=<span class="hljs-number"><span class="hljs-number">0</span></span>, cmap=<span class="hljs-string"><span class="hljs-string">'BuPu'</span></span>, legend=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, figsize=[<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>])</code> </pre> <br><p><img src="https://habrastorage.org/web/a03/e04/c6e/a03e04c6e9714b7296f5c67afbc4262b.png"></p><br><p>  Residents: </p><br><pre> <code class="python hljs">full_gdf.plot(column = <span class="hljs-string"><span class="hljs-string">'voters_oa'</span></span>, linewidth=<span class="hljs-number"><span class="hljs-number">0</span></span>, cmap=<span class="hljs-string"><span class="hljs-string">'YlOrRd'</span></span>, legend=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, figsize=[<span class="hljs-number"><span class="hljs-number">15</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>])</code> </pre> <br><p><img src="https://habrastorage.org/web/827/faf/6b2/827faf6b2ab8416dbcf5d05aa2057b0d.png"></p><br><p>  Fine!  We got a nice visualization.  But I want a base map and navigation!  The cartoframes library will come to our rescue. </p><br><h1 id="vizualizaciya-geodannyh-s-pomoschyu-cartoframes">  Visualization of geodata using cartoframes </h1><br><p>  One of the most convenient tools for visualizing geodata is Carto.  To work with this service, there is the cartoframes library, which allows you to work with the service functions directly from Jupyter notebooks. </p><br><div class="spoiler">  <b class="spoiler_title">Important retreat</b> <div class="spoiler_text"><p>  The cartoframes library requires careful attention under Windows due to the design features (for example, when filling datasets, the library tries to use the linux folder style, which leads to sad consequences).  With Cyrillic data, you can easily shoot yourself a leg (cp1251 encoding can be turned into cracks).  It is better to use it either in a docker container, or on a full-fledged Linux.  Put the library only through pip.  In windows, it can be successfully installed by first putting geopandas through a conda (or placing all dependencies with your hands). </p></div></div><br><p>  Cartoframes works with the projection of WGS84.  In it and we will reproject ours.  After connecting two data frames, projection information may be lost.  Define it and re-project it. </p><br><pre> <code class="python hljs">full_gdf.crs = ({<span class="hljs-string"><span class="hljs-string">'init'</span></span> :<span class="hljs-string"><span class="hljs-string">'epsg:3857'</span></span>}) full_gdf = full_gdf.to_crs({<span class="hljs-string"><span class="hljs-string">'init'</span></span> :<span class="hljs-string"><span class="hljs-string">'epsg:4326'</span></span>})</code> </pre> <br><p>  Making the necessary imports ... </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cartoframes <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> warnings warnings.filterwarnings(<span class="hljs-string"><span class="hljs-string">"ignore"</span></span>)</code> </pre> <br><p>  Add data from the Carto account: </p><br><pre> <code class="python hljs">USERNAME = <span class="hljs-string"><span class="hljs-string">'  Carto'</span></span> APIKEY = <span class="hljs-string"><span class="hljs-string">'  API'</span></span></code> </pre> <br><p>  And finally, connect to Carto and fill our dataset: </p><br><pre> <code class="python hljs">cc = cartoframes.CartoContext(api_key=APIKEY, base_url=<span class="hljs-string"><span class="hljs-string">'https://{}.carto.com/'</span></span>.format(USERNAME)) cc.write(full_gdf, encode_geom=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, table_name=<span class="hljs-string"><span class="hljs-string">'mo_votes'</span></span>, overwrite=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)</code> </pre> <br><p>  Dataset can be unloaded from Carto back.  But the full geodataframe is only in the project.  However, using gdal and shapely, you can convert the binary representation of PostGIS geometry back to WKT. </p><br><p>  A feature of the plug-in is type conversion.  Alas, in the current version, the data frame is poured into a table with an assignment of type str for each column.  This must be remembered when working with maps. </p><br><p>  Finally, the map!  We color the data, put it on the base map and turn on the navigation.  You can check the coloring schemes <a href="https://github.com/CartoDB/CartoColor/wiki/CARTOColor-Scheme-Names">here</a> . </p><br><p>  For normal work with partitioning of classes we will write request with coercion of types.  PostgreSQL syntax </p><br><pre> <code class="hljs sql">query_layer = '<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> cartodb_id, the_geom, the_geom_webmercator, voters_oa::<span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, voters_percent::<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>, state_out::<span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mo_votes<span class="hljs-string"><span class="hljs-string">'</span></span></code> </pre> <br><p>  So, turnout: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cartoframes <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Layer, BaseMap, styling, QueryLayer l = QueryLayer(query_layer, color={<span class="hljs-string"><span class="hljs-string">'column'</span></span>: <span class="hljs-string"><span class="hljs-string">'voters_percent'</span></span>, <span class="hljs-string"><span class="hljs-string">'scheme'</span></span>: styling.darkMint(bins=<span class="hljs-number"><span class="hljs-number">7</span></span>)}) map = cc.map(layers=[BaseMap(source=<span class="hljs-string"><span class="hljs-string">'light'</span></span>, labels=<span class="hljs-string"><span class="hljs-string">'front'</span></span>), l], size=(<span class="hljs-number"><span class="hljs-number">990</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>), interactive=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>)</code> </pre> <br><p><img src="https://habrastorage.org/web/a5f/4cd/4e1/a5f4cd4e1dc2427c93e56a95047a974b.png"></p><br><p>  Number of inhabitants </p><br><pre> <code class="hljs mel">l = QueryLayer(query_layer, <span class="hljs-keyword"><span class="hljs-keyword">color</span></span>={<span class="hljs-string"><span class="hljs-string">'column'</span></span>: <span class="hljs-string"><span class="hljs-string">'voters_oa'</span></span>, <span class="hljs-string"><span class="hljs-string">'scheme'</span></span>: styling.burg(bins=<span class="hljs-number"><span class="hljs-number">7</span></span>)}) map = cc.map(layers=[BaseMap(<span class="hljs-keyword"><span class="hljs-keyword">source</span></span>=<span class="hljs-string"><span class="hljs-string">'light'</span></span>, labels=<span class="hljs-string"><span class="hljs-string">'front'</span></span>), l], <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>=(<span class="hljs-number"><span class="hljs-number">990</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>), interactive=False)</code> </pre> <br><p><img src="https://habrastorage.org/web/704/ccd/958/704ccd95854a4a74bd1178ddf7333371.png"></p><br><p>  And, for example, home-based voting </p><br><pre> <code class="hljs mel">l = QueryLayer(query_layer, <span class="hljs-keyword"><span class="hljs-keyword">color</span></span>={<span class="hljs-string"><span class="hljs-string">'column'</span></span>: <span class="hljs-string"><span class="hljs-string">'state_out'</span></span>, <span class="hljs-string"><span class="hljs-string">'scheme'</span></span>: styling.sunsetDark(bins=<span class="hljs-number"><span class="hljs-number">5</span></span>)}) map = cc.map(layers=[BaseMap(<span class="hljs-keyword"><span class="hljs-keyword">source</span></span>=<span class="hljs-string"><span class="hljs-string">'light'</span></span>, labels=<span class="hljs-string"><span class="hljs-string">'front'</span></span>), l], <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>=(<span class="hljs-number"><span class="hljs-number">990</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>), interactive=False)</code> </pre> <br><p><img src="https://habrastorage.org/web/13c/684/348/13c68434804b4b56a984f4e30caa729c.png"></p><br><p>  It should be noted that at the moment cartoframes does not allow embedding the info window directly into the notebook window, showing the legend, as well as publishing the maps on Carto.  But these options are in the implementation process. </p><br><p>  And now let's try a more complicated, but very flexible way to embed maps in Jupyter Notebook ... </p><br><h1 id="vizualizaciya-geodannyh-s-pomoschyu-folium">  Visualization of geodata using folium </h1><br><p>  So, we would like to receive not only the navigation, but also the info window on the map.  And also get the opportunity to publish a visualization on your server or on github.  We will help folium. </p><br><div class="spoiler">  <b class="spoiler_title">Important retreat</b> <div class="spoiler_text"><p>  The folium library is a pretty specific thing.  It is a python wrapper around the Leaflet JS library, which is responsible for cartographic visualization.  The following manipulations don't look very pythonic, but don't be scared, I'll explain everything. </p></div></div><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> folium</code> </pre> <br><p>  Simple visualization like Carto is pretty simple.  What's happening? </p><br><ul><li>  we create an instance map, m, centered on the selected coordinates; </li><li>  add instance cartogram (choropleth) <br>  In the cartogram instance, we specify many attributes: </li><li>  geo_data - geodata, we convert the data of our data frame into geojson; </li><li>  name - set the name of the layer; </li><li>  data - the data itself, we also select them from the data frame; </li><li>  key_on is the key for the connection (note that in geojson all attributes are put in a separate element, properties); </li><li>  columns - key and attribute for coloring; </li><li>  fill_color, fill_opacity, line_weight, line_opacity - fill color scale, fill transparency, width and transparency of lines; </li><li>  legend_name - the title of the legend; </li><li>  highlight - the addition of interactive (lights when hovering and approximation when clicking) on ‚Äã‚Äãobjects. </li></ul><br><p>  The color scale is based on <a href="http://colorbrewer2.org/">the Color Brewer library</a> .  I highly recommend using it when working with cards. </p><br><pre> <code class="hljs lua">m = folium.Map(location=[<span class="hljs-number"><span class="hljs-number">55.764414</span></span>, <span class="hljs-number"><span class="hljs-number">37.647859</span></span>]) m.choropleth( geo_data=full_gdf<span class="hljs-string"><span class="hljs-string">[['okrug', 'geometry']]</span></span>.to_json(), name=<span class="hljs-string"><span class="hljs-string">'choropleth'</span></span>, data=full_gdf<span class="hljs-string"><span class="hljs-string">[['okrug', 'voters_oa']]</span></span>, key_on=<span class="hljs-string"><span class="hljs-string">'feature.properties.okrug'</span></span>, columns=[<span class="hljs-string"><span class="hljs-string">'okrug'</span></span>, <span class="hljs-string"><span class="hljs-string">'voters_oa'</span></span>], fill_color=<span class="hljs-string"><span class="hljs-string">'YlGnBu'</span></span>, line_weight=<span class="hljs-number"><span class="hljs-number">1</span></span>, fill_opacity=<span class="hljs-number"><span class="hljs-number">0.7</span></span>, line_opacity=<span class="hljs-number"><span class="hljs-number">0.2</span></span>, legend_name=<span class="hljs-string"><span class="hljs-string">'type'</span></span>, highlight = True ) m</code> </pre> <br><p><img src="https://habrastorage.org/web/06f/966/1de/06f9661de8a14dbab74e76442b86a19a.PNG"></p><br><p>  So, we have an interactive cartogram.  But I would also like the info window ... </p><br><p>  Here we have to hack the library a bit.  We have winning parties in every TEC.  For each of them, we define the base color.  But not in every district the victory of the party means 100% of the vote.  For each base color, we define 3 gradations: absolute power (100%), a controlling stake (&gt; 50%) and cooperation (&lt;50%).  Let's write the color detection function: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">party_color</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(feature)</span></span></span><span class="hljs-function">:</span></span> party = feature[<span class="hljs-string"><span class="hljs-string">'properties'</span></span>][<span class="hljs-string"><span class="hljs-string">'top1'</span></span>] percent = feature[<span class="hljs-string"><span class="hljs-string">'properties'</span></span>][<span class="hljs-string"><span class="hljs-string">'top1_percent'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> party == <span class="hljs-string"><span class="hljs-string">' '</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> percent == <span class="hljs-number"><span class="hljs-number">100</span></span>: color = <span class="hljs-string"><span class="hljs-string">'#969696'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> &lt; percent &lt; <span class="hljs-number"><span class="hljs-number">100</span></span>: color = <span class="hljs-string"><span class="hljs-string">'#bdbdbd'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: color = <span class="hljs-string"><span class="hljs-string">'#d9d9d9'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> party == <span class="hljs-string"><span class="hljs-string">''</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> percent == <span class="hljs-number"><span class="hljs-number">100</span></span>: color = <span class="hljs-string"><span class="hljs-string">'#78c679'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> &lt; percent &lt; <span class="hljs-number"><span class="hljs-number">100</span></span>: color = <span class="hljs-string"><span class="hljs-string">'#addd8e'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: color = <span class="hljs-string"><span class="hljs-string">'#d9f0a3'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> party == <span class="hljs-string"><span class="hljs-string">''</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> percent == <span class="hljs-number"><span class="hljs-number">100</span></span>: color = <span class="hljs-string"><span class="hljs-string">'#ef3b2c'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> &lt; percent &lt; <span class="hljs-number"><span class="hljs-number">100</span></span>: color = <span class="hljs-string"><span class="hljs-string">'#fb6a4a'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: color = <span class="hljs-string"><span class="hljs-string">'#fc9272'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> party == <span class="hljs-string"><span class="hljs-string">' '</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> percent == <span class="hljs-number"><span class="hljs-number">100</span></span>: color = <span class="hljs-string"><span class="hljs-string">'#2171b5'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> &lt; percent &lt; <span class="hljs-number"><span class="hljs-number">100</span></span>: color = <span class="hljs-string"><span class="hljs-string">'#4292c6'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: color = <span class="hljs-string"><span class="hljs-string">'#6baed6'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> party == <span class="hljs-string"><span class="hljs-string">''</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> percent == <span class="hljs-number"><span class="hljs-number">100</span></span>: color = <span class="hljs-string"><span class="hljs-string">'#ec7014'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> &lt; percent &lt; <span class="hljs-number"><span class="hljs-number">100</span></span>: color = <span class="hljs-string"><span class="hljs-string">'#fe9929'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: color = <span class="hljs-string"><span class="hljs-string">'#fec44f'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-string"><span class="hljs-string">"fillColor"</span></span>:color, <span class="hljs-string"><span class="hljs-string">"fillOpacity"</span></span>:<span class="hljs-number"><span class="hljs-number">0.8</span></span>,<span class="hljs-string"><span class="hljs-string">"opacity"</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>}</code> </pre> <br><p>  Now let's write the html generation function for the info window: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">popup_html</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(feature)</span></span></span><span class="hljs-function">:</span></span> html = <span class="hljs-string"><span class="hljs-string">'&lt;h5&gt;     {}&lt;/h5&gt;'</span></span>.format(feature[<span class="hljs-string"><span class="hljs-string">'properties'</span></span>][<span class="hljs-string"><span class="hljs-string">'okrug'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">'top1'</span></span>, <span class="hljs-string"><span class="hljs-string">'top2'</span></span>, <span class="hljs-string"><span class="hljs-string">'top3'</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> feature[<span class="hljs-string"><span class="hljs-string">'properties'</span></span>][p + <span class="hljs-string"><span class="hljs-string">'_elected'</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>: html += <span class="hljs-string"><span class="hljs-string">'&lt;br&gt;&lt;b&gt;{}&lt;/b&gt;: {} '</span></span>.format(feature[<span class="hljs-string"><span class="hljs-string">'properties'</span></span>][p], feature[<span class="hljs-string"><span class="hljs-string">'properties'</span></span>][p + <span class="hljs-string"><span class="hljs-string">'_elected'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> html</code> </pre> <br><p>  Finally, we convert each data frame object into a geojson and add it to the map, attaching style, hover behavior and the info window to each map. </p><br><pre> <code class="python hljs">m = folium.Map(location=[<span class="hljs-number"><span class="hljs-number">55.764414</span></span>, <span class="hljs-number"><span class="hljs-number">37.647859</span></span>], zoom_start=<span class="hljs-number"><span class="hljs-number">9</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> mo <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> json.loads(full_gdf.to_json())[<span class="hljs-string"><span class="hljs-string">'features'</span></span>]: gj = folium.GeoJson(data=mo, style_function = party_color, control=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, highlight_function=<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x:{<span class="hljs-string"><span class="hljs-string">"fillOpacity"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"opacity"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>}, smooth_factor=<span class="hljs-number"><span class="hljs-number">0</span></span>) folium.Popup(popup_html(mo)).add_to(gj) gj.add_to(m) m</code> </pre> <br><p><img src="https://habrastorage.org/web/fee/301/31a/fee30131af044b95880b4db0c6b7b532.PNG"></p><br><p><img src="https://habrastorage.org/web/4c8/539/f2e/4c8539f2e2454bbeaa6faef3ed57654d.PNG"></p><br><p>  Finally, we save our map.  It can be published, for example, on <a href="https://fall-out-bug.github.io/izbirkom_viz/">Github</a> : </p><br><pre> <code class="python hljs">m.save(<span class="hljs-string"><span class="hljs-string">'tmp/map.html'</span></span>)</code> </pre> <br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  With the help of simple geodata visualization tools, you can find endless space for insights.  And after some work on the data and visualization, you can successfully publish your insights on Carto or on github.  <a href="https://github.com/fall-out-bug/izbirkom_viz">The repository of this article</a> . </p><br><p>  Congratulations, now you are a political scientist! <br><img src="https://habrastorage.org/web/482/742/729/482742729fbc49f0bab6145ea8caf553.png"><br>  You have learned to analyze the election results.  Share insights in comments! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/338554/">https://habr.com/ru/post/338554/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338540/index.html">CGLayout - new automatic layout system in iOS</a></li>
<li><a href="../338542/index.html">How does Microsoft try to send mobile mail to itself?</a></li>
<li><a href="../338544/index.html">Creating a sound effects synthesizer from retro games</a></li>
<li><a href="../338548/index.html">How to distinguish birds from flowers. Or flowers from birds</a></li>
<li><a href="../338550/index.html">MVP recommendation system for GitHub weekly</a></li>
<li><a href="../338556/index.html">Go: 10 years and grow further</a></li>
<li><a href="../338558/index.html">Reactive applications with Model-View-Intent. Part 2: View and Intent</a></li>
<li><a href="../338560/index.html">Who, how and why is going to regulate Big Data in Russia?</a></li>
<li><a href="../338562/index.html">20 years to Yandex. Lecture by Ilya Segalovich - the person who invented this word</a></li>
<li><a href="../338564/index.html">Your own Python cover server for Internet radio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>