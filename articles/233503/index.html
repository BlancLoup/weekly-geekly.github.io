<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Identification of Linux kernel loadable modules [part 1]: source code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this post, I‚Äôll tell you about my search for signs of how you can determine that a loadable Linux kernel module (LKM) is being assembled from some ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Identification of Linux kernel loadable modules [part 1]: source code</h1><div class="post__text post__text-html js-mediator-article">  <i>In this post, I‚Äôll tell you about my search for signs of how you can determine that a <a href="https://ru.wikipedia.org/wiki/%25D0%2597%25D0%25B0%25D0%25B3%25D1%2580%25D1%2583%25D0%25B6%25D0%25B0%25D0%25B5%25D0%25BC%25D1%258B%25D0%25B9_%25D0%25BC%25D0%25BE%25D0%25B4%25D1%2583%25D0%25BB%25D1%258C_%25D1%258F%25D0%25B4%25D1%2580%25D0%25B0">loadable Linux kernel module (LKM)</a> is being assembled from some source files, and not a regular executable file.</i> <br>  Suppose that there is no information about the purpose of source codes, or they are trying to deliberately hide it. <br>  <b>Upd</b> : The amount of code&gt; 4 GB and it is necessary to quickly select only those sources that implement the kernel modules. <br><br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/e00/ff2/311/e00ff2311b77a63355e91132dd72a4a7.jpg" height="200" width="320"></a> <br><br><br><h3>  # 01 __KERNEL__ </h3><br>  When assembling the source texts, the preprocessor symbol <i>__KERNEL__ is defined</i> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  As Alessandro Rubini and Jonathan Corbet write in the book <a href="http://rus-linux.net/MyLDP/BOOKS/ldd2/0/LinuxDeviceDrivers.html">‚ÄúDevice Drivers for Linux‚Äù:</a> <br><br><blockquote>  ‚ÄúSince the module is not linked to any of the standard libraries, the source code of the module should not include regular header files.  In kernel modules, only those functions that are exported by the kernel can be used.  All header files that are related to the kernel are located in the include / linux and include / asm directories, inside the directory tree with the kernel sources (usually, this is the / usr / src / linux directory). <br>  Early versions of Linux (based on libc version 5 and earlier) installed symbolic links from / usr / include / linux and / usr / include / asm to the actual directories from the kernel sources, so the libc header file tree could refer to the kernel header files .  This made it possible to include the kernel header files in user applications when the need arose. <br>  But even now, when the kernel header files are separated from the header files used by application programs, it is still sometimes necessary to include them in programs running in user space in order to use definitions that are not found in regular header files.  However, most of the definitions from the kernel header files belong exclusively to the kernel and are ‚Äúinvisible‚Äù for normal applications, since access to these definitions is enclosed in #ifdef __KERNEL__ blocks.  By the way, this is one of the reasons why it is necessary to define the __KERNEL__ symbol when building a module. ‚Äù </blockquote><br>  For example, the line "CFLAGS = -D__KERNEL__" may be present in the makefile. <br>  Or "-D__KERNEL__" can be found in the build logs. <br><br><h3>  # 02 MODULE </h3><br>  If the module is not statically linked to the kernel, then the string "-DMODULE" will always be included in the CFLAGS variable.  This preprocessor symbol must be defined before the <i>linux / module.h</i> file is <i>included</i> . <br><br><h3>  # 03 All names are declared as <i>static</i> and have a unique prefix </h3><br>  Thus, the developer avoids the ‚Äúpollution‚Äù of the kernel's namespace - otherwise, when debugging, he would have to catch the names of his module among all the kernel names.  Using the prefix frees you from the obligation to invent unique names that will not match the names already present in the kernel namespace. <br><br><br><h3>  # 04 printk () </h3><br>  In the source, the printk () function is used instead of the printf () function.  <a href="http://rus-linux.net/MyLDP/BOOKS/ldd2/0/LinuxDeviceDrivers.html">"Device Drivers in Linux" says:</a> <blockquote>  ‚ÄúThe printk function is defined in the kernel and in its behavior resembles the printf function from the standard C library. Why then does the kernel have its own function?  Everything is simple - the core is an independent code that is compiled without auxiliary libraries of the C language. " </blockquote><br><br><h3>  # 05 <i>init_module</i> and <i>cleanup_module</i> </h3><br><blockquote>  <a href="http://rus-linux.net/MyLDP/BOOKS/ldd2/0/LinuxDeviceDrivers.html">"Device Drivers in Linux" says:</a> <br><br>  ‚ÄúThe application is performed as an integral task, from beginning to end.  The module simply registers itself in the kernel, preparing it for servicing possible requests, and its main function completes its work immediately after the call.  In other words, the task of the init_module function (entry point) is to prepare the functions of the module for subsequent calls.  She seems to say to the nucleus: ‚ÄúHey!  I'm here!  Here is what I can do! ‚Äú.  The second entry point to the module, cleanup_module, is called immediately before the module is unloaded.  She tells the core: ‚ÄúI'm leaving!  Don't ask me about anything else! ‚Äú.  ‚Äû </blockquote><br>  <b>Upd:</b> A more reliable sign is the presence in the text of the function <b>cleanup_module</b> , since  Functions with this name are found approximately 20 times less frequently than with the name ‚Äú <b>init_module</b> ‚Äù.  Apparently, the name " <b>init_module</b> " is popular not only among writers of kernel modules. <br><br><h3>  # 06 Using <i>current-&gt;</i> </h3><br><blockquote>  <a href="http://rus-linux.net/MyLDP/BOOKS/ldd2/0/LinuxDeviceDrivers.html">"Device Drivers in Linux" says:</a> <br><br>  "&lt;...&gt; The kernel code can determine the current process accessing the module through the global <b>current</b> element ‚Äî a pointer to the <i>struct task_struct</i> , which is declared in the 2.4 kernel in the <i>&lt;asm / current.h&gt;</i> file. The <i>current</i> pointer refers to the current user process. In the process of making system calls, such as <i>read</i> or <i>write</i> , the process making the call is considered current. The kernel can use information about the current process using the <i>current</i> pointer if the need arises. &lt;...&gt; <br>  In fact, <i>current is</i> no longer a global kernel variable, as it was before.  The developers have optimized access to the structure that describes the current process, moving it onto the stack.  You will find the implementation of current in the <i>&lt;asm / current.h&gt;</i> file.  But before you go exploring this file, you must remember that Linux is an SMP-compatible system (from the English. SMP - Symmetric Multi-Processing) and therefore a simple global variable is simply not applicable here.  Implementation details are in other kernel subsystems and yet, the device driver can plug in the header file <i>&lt;linux / sched.h&gt;</i> and access the <i>current</i> pointer. <br>  From the point of view of the module, <i>current</i> is a regular external link, such as <i>printk</i> .  A module can access <i>current</i> whenever it deems necessary.  For example, the following code displays the identifier (ID) of the process and the name of the command that launched the process: <br>  printk ("The process is \"% s \ "(pid% i) \ n", current-&gt; comm, current-&gt; pid); <br><br><br>  The command name is stored in the field <i>current-&gt; comm</i> and is the name of the program file. </blockquote><br><br>  And how do you know the differences between the kernel module and the executable file at the source level? <br><br><br><br><br><h5>  Related links: </h5><br>  <a href="http://habrahabr.ru/post/106702/">"We write the driver under Linux"</a> from <a href="http://habrahabr.ru/users/iznakurnozh/">iznakurnozh</a> <br>  <a href="http://habrahabr.ru/post/213775/">‚ÄúWriting a driver for an LCD display under embedded linux‚Äù</a> by <a href="http://habrahabr.ru/users/alexzoidberg/">alexzoidberg</a> <br>  <a href="http://habrahabr.ru/post/123145/">"Overview of the SPI bus and development of the driver of the slave SPI device for embedded Linux (Part one, overview)"</a> from <a href="http://habrahabr.ru/users/Lampus/">Lampus</a> <br>  <a href="http://habrahabr.ru/post/123266/">"Overview of the SPI bus and development of the driver of the slave SPI device for embedded Linux (Part two, practical)"</a> from <a href="http://habrahabr.ru/users/Lampus/">Lampus</a> <br>  <a href="http://habrahabr.ru/post/117654/">We work with kernel modules in Linux</a> from <a href="http://habrahabr.ru/users/Vorb/">Vorb</a> <br>  <a href="http://habrahabr.ru/post/138328/">Learning to write a kernel module (Netfilter) or Transparent Proxy for HTTPS</a> from <a href="http://habrahabr.ru/users/sindo/">sindo</a> <br>  <a href="http://habrahabr.ru/company/spbau/blog/218833/">‚ÄúWriting a file system in the Linux kernel‚Äù</a> by <a href="http://habrahabr.ru/users/kmu1990/">kmu1990</a> <br>  <a href="http://habrahabr.ru/post/205274/">‚ÄúSimple masking of the Linux kernel module using DKOM‚Äù</a> from <a href="http://habrahabr.ru/users/milabs/">milabs</a> </div><p>Source: <a href="https://habr.com/ru/post/233503/">https://habr.com/ru/post/233503/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../233489/index.html">Checking GIMP source code with PVS-Studio</a></li>
<li><a href="../233491/index.html">Your screenshot service for a restful sleep</a></li>
<li><a href="../233493/index.html">How to charge a smartphone from a cat, a child and in the forest</a></li>
<li><a href="../233497/index.html">Disable full time synchronization between the virtual machine and the VMware ESXi hypervisor</a></li>
<li><a href="../233501/index.html">Understanding your own code</a></li>
<li><a href="../233505/index.html">Improving Web Application UI</a></li>
<li><a href="../233507/index.html">Ultraviolet look or tanning problems</a></li>
<li><a href="../233509/index.html">Dr. Tariff 2.0: new features for Beeline, MegaFon and MTS subscribers</a></li>
<li><a href="../233511/index.html">Kepler: smart detector for gas and CO leaks</a></li>
<li><a href="../233513/index.html">IXION - a new concept of "transparent" aircraft</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>