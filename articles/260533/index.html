<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Search for quadrangle documents on mobile devices</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some of the document recognition modules developed by our company, as the first stage of their work, should determine the location of the object on th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Search for quadrangle documents on mobile devices</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/ee7/31b/fb6/ee731bfb6de14cd4a3a2afdab37cd35f.jpg" width="50%"></div><br><br>  Some of the document recognition modules developed by our company, as the first stage of their work, should determine the location of the object on the incoming image or in the video stream.  Today‚Äôs article is devoted to one of our approaches to solving this problem. <br><br><h5>  Formulation of the problem </h5><br>  To begin with, we will determine what information we can use for our own purposes. <br>  In applications, the intended types of documents are sufficiently rigid.  We assume that no one is seriously trying to recognize a passport as an application for bank cards or vice versa, which means that we know, at least, the proportions of the desired object.  Also note that the absolute majority of mobile devices have cameras with a fixed focal length. <br><a name="habracut"></a><br>  Since the found has yet to be recognized, it makes sense to look at far from any image of the document.  In order not to get a photo at the entrance with a small piece of the document in the corner of the diagonals, we use some restrictions and accompany them with visualization, which would help the user to get a suitable frame layout at the shooting stage. <br>  Specifically, I would like to meet the following conditions: <br>  1 - recognizable document must be entirely in the frame. <br>  2 - the document should occupy a large enough part of the frame. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To achieve the fulfillment of these conditions can be different.  If you directly demand that the document occupy no less than X% of the frame area, you can hear the well-grounded grinding of user's teeth, since it‚Äôs very difficult to see if the document occupies, say, 80% of the frame area, or only 75%. <br>  But there are much more visual options.  So, you can set the permissible rectangular zones for each of the vertices of the document border and suggest the user to direct the camera in such a way that each side of the document completely lies on one side of the document. <br><br>  For the user, this might look like this: <br><img src="https://habrastorage.org/files/6a9/14d/f29/6a914df294524cd89f7456fc5efc0eba.png"><br><br>  In addition to visualization for the user, this method imposes an additional useful limitation on the position of the document: based on the size of the zones, you can calculate the maximum possible angles of inclination of the sides to the axes, and, as a result, the range of possible deviations of the quadrilateral angles from 90 degrees.  Well, or, conversely, it is possible to set such zone sizes so that the deviations of these parameters do not exceed certain threshold values. <br><br>  From this point on, one can observe maneuvering between Scylla and Charybdis of any image processing algorithm ‚Äî speed and accuracy / quality of work. <br><br><h5>  Highlighting borders </h5><br>  First of all, we will reduce the input image to a smaller size in order to reduce the time costs.  We use a cast to 320px on the larger side as some optimum selected for specific user cases. <br>  To search for a document, we will only need image regions corresponding to 4 side zones.  In each of them we will look for borders that could be the edges of the document. <br>  Further manipulations will be considered on the example of the upper region - for the rest, the actions are similar up to a rotation of 90 degrees (*). <br><br><ol><li>  Calculate the image gradient by suppressing high-frequency noise using a Gaussian filter.  Due to restrictions on the location of the document, we are only interested in orthotropic boundaries, i.e.  directed mainly along one of the coordinate axes (in the case of the upper region, along the axis OX).  To search for such boundaries, the derivative along the OY axis is sufficient.  The problem is that the color image is a vector image, and its derivative is also a vector, but in the one-dimensional case, to estimate the severity of the border, we can take some norm of this vector, unlike the full gradient, which is much more complicated to calculate, for example, by Di Zenzo [ one]. <br>  To avoid unnecessary arithmetic operations, we use <img src="https://habrastorage.org/getpro/habr/post_images/de2/986/6c9/de29866c9b37c0f962d9a4804ed34d90.gif" title="L_ \ infty">  norm, i.e.  take the derivative module in each channel <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/180/1ac/18e/1801ac18e4064ace8f1241e98237da13.png"></div><br>  and then choose the largest of these values <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c32/057/ddf/c32057ddfbcd4cad846bc9df7536a619.png"></div><br>  resulting in a halftone image derivative. <br></li><li>  We filter the resulting image: first we use the classical non-maximum suppression (see Canny [2]) and get the initial map of boundaries, then suppress the outliers generated by the textures.  To do this, multiply the value of each pixel G (x, y) of the borders by the following coefficient k: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1ae/a24/125/1aea241256d44966b22fc9685225b014.png"></div><br>  where ht is the height of the region, and for <sub>0</sub> , y <sub>1</sub> are the y-coordinates of the closest to the current boundary pixels above and below, or the fake values ‚Äã‚Äãif there are none. <br></li><li>  We collect the boundary pixels into connected components ‚Äî they have more possible clipping parameters than individual pixels.  In our implementation, components whose size or average brightness is less than the threshold values ‚Äã‚Äãare discarded. <br></li></ol><br>  * The search for boundaries (and then direct) in each region occurs independently of the others, which means it is perfectly parallelized. <br><br><h5>  Search direct </h5><br>  The next step is to extract the lines using the fast Hough transform [3] (*).  The Hough transformation translates the boundary map into a battery matrix, each cell (i, j) of which corresponds to a parametrically defined straight line, and local maxima in such a battery correspond to the most significant straight lines on the boundary map. <br>  In many cases, the best direct one is not enough - the restrictions will not protect us from a table / keyboard / keyboard / anything else that is longer and more contrast than our document.  However, a cunning plan to simply take some of the largest values ‚Äã‚Äãin a battery is doomed to failure: each straight line actually forms some maximum neighborhood in the battery (see figure below), and the first few maxima most likely will correspond to approximately the same straight line. <br>  Since our goal is not to find out with great precision the location of one straight line, but to dial several quite different ones, this does not suit us. <br>  Therefore, the following iterative procedure takes place in the combat version of the algorithm: <br><ol><li>  Transformation of Hafa over the boundary map </li><li>  Adding the best direct to the answer </li><li>  If the number of lines is less than the required - rubbing the found straight line on the map of boundaries and return to point 1 </li></ol><br>  Each of the received direct we will supply with weight - value from the corresponding cell of the accumulator Hough. <br><br>  * By fast Hough transform, we mean an exact fast implementation, not an approximation of a transform. <br><table><tbody><tr><td><img src="https://habrastorage.org/files/3a0/436/287/3a0436287656436b865fea1a418135c7.png"><br>  a) border map </td><td><img src="https://habrastorage.org/files/dd1/161/965/dd11619655dc49f5b2e3430697368c04.png"><br>  b) BPH battery </td></tr><tr><td colspan="2">  An example of the operation of BPH.  (Did you understand which of the straight lines corresponds to each of the peaks on the battery?) </td></tr></tbody></table><br><br><h5>  Combinatorial scheme </h5><br>  After the previous step, we have 4 sets of lines - one for each side of the document.  From these direct combinatorial enumeration we compose all possible quadrilaterals, among which we will search for the most plausible.  As an initial estimate C of each of the quadrangles, we take the sum of the weights of the lines from which it is assembled.  All subsequent steps are devoted to the adjustment of this assessment, taking into account the emergent characteristics of the quadrilateral. <br><br>  If the lines in the neighboring areas do not break at the point of their intersection, but continue beyond it, then it is highly likely that this is not the angle of the desired object, but something else.  Of course, there may be a case where the border of the document is located along a certain direct background, and, moreover, even at a real angle several pixels can crawl away during image processing, but in general this is a bad sign.  Such ‚Äúgetting out‚Äù of lines for a corner will be fined: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/164/235/db4/164235db497d44a080779f4e515b2edb.png"></div><br>  where p <sub>i</sub> is the penalty for the i-th angle, which is the sum of the intensities of the first n pixels on the boundary map behind the intersection point along the straight lines forming the angle. <br><img src="https://habrastorage.org/files/0de/39a/6e9/0de39a6e9c2e4ffaae338d835622c67c.png">  -&gt; <img src="https://habrastorage.org/files/2f6/911/e6d/2f6911e6d9684875818ed7a7b29f5348.png"><br>  An example for the upper left corner.  Yellow denotes the penalty area for horizontal lines. <br><br>  Further, using the focal distance known to us, for each of the quadrangles we reconstruct the parallelogram [4] (the only one up to homothety) whose projective image is this quadrilateral.  Let us compare the aspect ratio of the obtained parallelogram with the known aspect ratio of the desired document, and its angles - with the right angles, which the document, like, should have.  For the deviation of these parameters from the expected also introduce penalties: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/9b3/b3d/9c1/9b3b3d9c10da4765b6fe730510cf973f.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/bf5/164/19d/bf516419d5e84f9bb89a3948d8a7054f.png"></div><br><br>  Then if <img src="https://habrastorage.org/files/fdb/b7d/0a3/fdbb7d0a3f734934881b9e2a73c0ff7b.png">  : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/15c/fa1/6f2/15cfa16f229d464f97e82a1b99c5a133.png"></div><br><br>  where A, B, Œ±, Œ≤ - optimized coefficients, <br>  T <sub>a</sub> , T <sub>r</sub> - threshold values. <br><br>  That's all.  The quad with the greatest weight is taken for the location of the document on the image. <br><br><h5>  results </h5><br>  The test sample for quality assessment consists of 6000 photographs of documents on a different background and 6000 regular quadrangles, respectively.  The initial resolution of images varies from 640x480 to 800x600.  The test device is an iPhone 4S (photos were taken from it and shrunk to the specified permissions from the outside of the described algorithm). <br><br>  To assess the accuracy of finding the document, the following error function was used: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/b4f/04a/d45/b4f04ad45edc47b1a5c71d58238f71f3.png"></div><br>  where ‚àÜd <sub>max</sub> - the maximum of the distances between the corresponding angles of the true and found quadrangles, <br>  min (s) is the length of the minimal side of a true quadrilateral. <br><br>  It has been empirically found out that for sufficiently good character recognition on a detected document with side zones occupying 30% of the corresponding size, the value of err should be less than 0.06. <br><br>  The overall quality of the algorithm was calculated as <br><div style="text-align:center;"><img src="https://habrastorage.org/files/32b/9c6/7fd/32b9c67fdd1c4fcbb5c5acc254fe9e7f.png"></div><br><br>  According to this estimate, on a test sample of 6000 images, the quadrangles of documents are at a quality of 98.5%. <br><br>  The average running time of the algorithm on iPhone 4S is 0.043s (23.2FPS), of which: <br>  scaling - 0.014s, <br>  search for edges - 0.023s, <br>  direct search - 0.005s, <br>  bust with clipping - 0.001s. <br><br><h5>  Literature </h5><br>  [1] S. Di Zenzo.  A note on the gradient of a multi-image. <br>  [2] J. Canny.  A computational approach to edge detection. <br>  [3] DP Nikolaev et al.  Hough transform: underestimated tool in computer vision field. <br>  [4] Z. Zhang.  Whiteboard scanning and image enhancement. </div><p>Source: <a href="https://habr.com/ru/post/260533/">https://habr.com/ru/post/260533/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260515/index.html">How to evaluate the benefits of moving to the cloud</a></li>
<li><a href="../260519/index.html">Beat chart is the gamer's best friend.</a></li>
<li><a href="../260523/index.html">How our IaaS provider API works</a></li>
<li><a href="../260527/index.html">Kolab Groupware (Part 2 - Installation)</a></li>
<li><a href="../260531/index.html">Passing Parameters in Reporting Services Reports</a></li>
<li><a href="../260535/index.html">Vulnerability in Samsung phones allows eavesdropping</a></li>
<li><a href="../260539/index.html">Web application development on Golang</a></li>
<li><a href="../260541/index.html">Zabbix Moscow Meetup in Badoo</a></li>
<li><a href="../260543/index.html">How to pass "test free data recovery software" (part 1)</a></li>
<li><a href="../260545/index.html">The guys who make the talking robot for a smart home, distribute fees</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>