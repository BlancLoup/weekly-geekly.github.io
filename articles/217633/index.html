<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic update programs in C #. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few days ago I wrote an article about the implementation of automatic software updates in C #. 

 Taking into account the constructive criticism of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic update programs in C #. Part 2</h1><div class="post__text post__text-html js-mediator-article">  A few days ago I wrote an article about the implementation of <a href="http://habrahabr.ru/post/217325/">automatic software updates</a> in C #. <br><br>  Taking into account the constructive criticism of commentators, it was decided to improve that code, adding a few new features, including improving the ‚Äúold‚Äù ones: <br><ul><li>  Automatic checking, downloading and installing updates; </li><li>  Providing the user with a choice of the moment of update <i>(new)</i> ; </li><li>  Improved file version checking mechanism; </li><li>  Check update file integrity <i>(new)</i> </li></ul><br>  In order not to reprint the text of the <a href="http://habrahabr.ru/post/217325/">previous article</a> , in this I focus only on the revised parts of the code. <br><a name="habracut"></a><br><br><h4>  Key Notes </h4><br>  Commentators of the previous article identified the following code flaws (indicating only those that relied on): <br><ul><li>  It is only better to first download the new file so that the situation does not turn out, when in the middle of the download, for some reason, the application terminates and the user stays with .bak files and an incomplete .exe, i.e.  without a working application.  ( <a href="http://habrahabr.ru/users/darkbyte/" class="user_link">DarkByte</a> ); </li><li>  Just did not see the checksum checksum.  ( <a href="http://habrahabr.ru/users/naum/" class="user_link">naum</a> ); </li><li>  To show the user a modal (most likely) information window with a single ‚ÄúOk‚Äù button, leaving no choice is not a good practice.  It is necessary to do everything quietly and imperceptibly, or unobtrusively suggest upgrading with the ability to do it sometime later when it is more convenient for the user.  ( <a href="http://habrahabr.ru/users/iroln/" class="user_link">iroln</a> ); </li><li>  Your version comparison is wrong.  Problems will be, for example, when upgrading from 9.12.2 to 10.0.0.  ( <a href="http://habrahabr.ru/users/eyeless_watcher/" class="user_link">eyeless_watcher</a> ) </li><li>  And what prevents directly comparing Version types?  ( <a href="http://habrahabr.ru/users/teleavtomatika/" class="user_link">teleavtomatika</a> ). </li></ul><br>  There were, of course, other comments similar to these, but I didn‚Äôt give them all, and I propose to begin the consideration of the problems. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Amendment </h4><br>  Since there may be some error when downloading the file, as a result of which the file will be damaged, the following corrections were made to the code: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkUpdates</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (File.Exists(<span class="hljs-string"><span class="hljs-string">"launcher.update"</span></span>) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Version(FileVersionInfo.GetVersionInfo(<span class="hljs-string"><span class="hljs-string">"launcher.update"</span></span>).FileVersion) &gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Version(Application.ProductVersion)) { Process.Start(<span class="hljs-string"><span class="hljs-string">"updater.exe"</span></span>, <span class="hljs-string"><span class="hljs-string">"launcher.update \""</span></span> + Process.GetCurrentProcess().ProcessName + <span class="hljs-string"><span class="hljs-string">"\""</span></span>); Process.GetCurrentProcess().CloseMainWindow(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (File.Exists(<span class="hljs-string"><span class="hljs-string">"launcher.update"</span></span>)) { File.Delete(<span class="hljs-string"><span class="hljs-string">"launcher.update"</span></span>); } Download(); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (File.Exists(<span class="hljs-string"><span class="hljs-string">"launcher.update"</span></span>)) { File.Delete(<span class="hljs-string"><span class="hljs-string">"launcher.update"</span></span>); } Download(); } }</code> </pre> <br>  First, we check if the <b>launcher.update</b> update file exists, and also check the version of the file, since we do not care about its extension.  If the file is damaged, the <b>try catch</b> exception exception handler will be executed by executing the code to remove the damaged file and then running the check and download function (if found) for updates on the site. <br>  If the file turns out to be whole and its version is higher than the current one, then the additional utility <b>updater.exe is</b> launched to carry out operations to replace the main program file.  I will not elaborate in more detail, since it was <a href="http://habrahabr.ru/post/217325/">already early</a> . <br><br>  Thus, we will verify the integrity of the update file. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Download</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { XmlDocument doc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XmlDocument(); doc.Load(<span class="hljs-string"><span class="hljs-string">@"http://mysite/version.xml"</span></span>); remoteVersion = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Version(doc.GetElementsByTagName(<span class="hljs-string"><span class="hljs-string">"version"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].InnerText); localVersion = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Version(Application.ProductVersion); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (localVersion &lt; remoteVersion) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (File.Exists(<span class="hljs-string"><span class="hljs-string">"launcher.update"</span></span>)) { File.Delete(<span class="hljs-string"><span class="hljs-string">"launcher.update"</span></span>); } WebClient client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebClient(); client.DownloadProgressChanged += <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DownloadProgressChangedEventHandler(ProgressChanged); client.DownloadFileCompleted += <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AsyncCompletedEventHandler(Completed); client.DownloadFileAsync(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(<span class="hljs-string"><span class="hljs-string">@"http://mysite/launcher.exe"</span></span>), <span class="hljs-string"><span class="hljs-string">"launcher.update"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { } }</code> </pre><br>  Further, the function of the file version verification process has changed, the key point of which is the implementation of file version comparison using the built-in <b>System.Version</b> tools, as a result of which the problem of correct version checking, say, ‚Äú9.12.2‚Äù and ‚Äú10.0.0‚Äù has been resolved. <br>  In the case when a newer version is detected, the actions take place in the following scenario: the program automatically downloads the update file in the background, then gives the user a message about the availability of this update and offers 2 options for further developments: <br><ol><li>  <b>By agreeing to update</b> , the program is instantly restarted, taking all necessary actions; </li><li>  <b>Refusing to update the</b> program stores the file next to the executable file, where it was downloaded.  In this embodiment, the update process will occur the next time the program is started without displaying any notifications. </li></ol><br><br><h4>  Conclusion </h4><br>  The rewritten code turned out to be more perfect compared to the previous version, and also excludes the possibility of applying the update on the ‚Äúbit‚Äù file, as well as the lack of implementation of the checksum function of the downloaded file with the version on the server. <br><br>  And I would like to say special thanks to the following people for their constructive criticism: <a href="http://habrahabr.ru/users/darkbyte/" class="user_link">DarkByte</a> , <a href="http://habrahabr.ru/users/naum/" class="user_link">naum</a> , <a href="http://habrahabr.ru/users/iroln/" class="user_link">iroln</a> , <a href="http://habrahabr.ru/users/eyeless_watcher/" class="user_link">eyeless_watcher</a> , <a href="http://habrahabr.ru/users/teleavtomatika/" class="user_link">teleavtomatika</a> , <a href="http://habrahabr.ru/users/wire/" class="user_link">wire</a> . <br><br>  <i>Sincerely, Andrei Helldar!</i> <br><br>  PS: good people from among the minus - please kindly write in the comments why you decided so.  It is interesting to know where I am wrong. <br><br>  <b>UPD.</b>  <b>We kindly ask, who else has thoughts about ‚Äúhand curves‚Äù, ‚Äúcurve code‚Äù, etc., write at least in the comments what is wrong.</b>  <b>Based on your constructive criticism, I will improve my work, thereby learning how to write better code.</b> <b><br></b>  <b>Thanks in advance!</b> </div><p>Source: <a href="https://habr.com/ru/post/217633/">https://habr.com/ru/post/217633/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../217617/index.html">Testing ‚Äúfast MongoDB‚Äù - TokuMX in conditions close to reality</a></li>
<li><a href="../217625/index.html">First look at the prototype Yotaphone 2</a></li>
<li><a href="../217627/index.html">Asynchronous C # program update</a></li>
<li><a href="../217629/index.html">VPS as an anonymous proxy and not only ...</a></li>
<li><a href="../217631/index.html">Python-digest # 20. News, interesting projects, articles and interviews [March 23, 2014 - March 30, 2014]</a></li>
<li><a href="../217637/index.html">Certification of goods in the Russian Federation or 9 circles of hell</a></li>
<li><a href="../217639/index.html">Working with SQL Server in Hybrid Cloud Scripts. Part 2</a></li>
<li><a href="../217641/index.html">New hub "Chrome Extensions" (from October 2014 - "Extensions for browsers")</a></li>
<li><a href="../217643/index.html">Huawei Tecal RH2288H V2 - First Impressions</a></li>
<li><a href="../217645/index.html">How Minkowski in Flappy Bird played</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>