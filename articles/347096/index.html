<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analyze it. Mista.ru</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What, How, Why 


 The Mista.ru forum is one of the oldest and most active forums devoted to 1C. The first message is dated 2000, and at the moment th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analyze it. Mista.ru</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/od/xd/kw/odxdkwpc_7anzdc0vazcz6golwq.png"></p><br><h3 id="what-how-why">  What, How, Why </h3><br><p>  The Mista.ru forum is one of the oldest and most active forums devoted to 1C.  The first message is dated 2000, and at the moment the counter has passed over 800,000, and the number of messages is over 16,000,000. The forum was so popular that it was even tried to be ‚Äúmirrored‚Äù because it contained a good base of 1C questions and answers, due to What forum admins added "protection from downloading".  This article will describe how you can download this (and probably any other) forum in a relatively short time using the Google Cloud Platform. </p><a name="habracut"></a><br><h3 id="intro">  Intro </h3><br><p>  After my previous mini-project to get an interesting (in my opinion) <a href="https://habrahabr.ru/post/343838/">data set</a> , I needed another interesting task, at the solution of which I could train my skills as a data engineer.  As a goal, I chose the Mista.ru <a href="http://www.forum.mista.ru/">adinesnegov</a> forum and did it for several reasons at once.  First of all, this is a rather old forum and for many years it has accumulated millions of messages on various topics.  Secondly, he is one of the most popular among 1C programmers (at least 6-7 years ago) and the activity on it is quite high.  Thirdly, 99.99% of forum users are supporters of the current president, and the concentration of ‚Äústupid patriots‚Äù just rolls over, and this in turn gives hope for a very interesting analytics, such as the frequency of using the famous word "###", "Putin" or "Putin ###".  And fourthly, thanks to the ‚Äúprotection‚Äù, the task of downloading the forum became a bit more interesting. </p><br><h3 id="grabbing-script">  Grabbing script </h3><br><p>  The first attempts to approach the task with the tools already available, which I had left from the previous project, failed.  After 20 requests for GET requests, the forum stopped responding.  In the web backend is not strong, but I suspect that frequent requests from one SP were tracked and everything that was not similar to requests from a regular user was banned.  A bunch of downloaded downloads and site grabbers ran across the same rake and went to the trash.  I needed a fresh idea. </p><br><p>  And she was found.  In the partially completed Ruby-on-Rails course, I heard that there are automated testing tools that allow you to encode user behavior and use these emulation scripts for test cases.  Remembering the word Selenium and using Google, I quickly found some small examples, with a single nuance - they were in python, and in my arsenal there was only 1C and R. However, given that python is considered one of the easiest to learn, after a couple of hours I could already login to the forum: </p><br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> selenium <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> selenium <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> webdriver <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> selenium.webdriver.common.keys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Keys <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> selenium.webdriver.support.ui <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> WebDriverWait driver = webdriver.Chrome(<span class="hljs-string"><span class="hljs-string">"/usr/local/bin/chromedriver"</span></span>) base_url = <span class="hljs-string"><span class="hljs-string">'http://www.forum.mista.ru/'</span></span> driver.get(base_url) username = <span class="hljs-string"><span class="hljs-string">" "</span></span> password = <span class="hljs-string"><span class="hljs-string">"11"</span></span> uname = driver.find_element_by_name(<span class="hljs-string"><span class="hljs-string">"user_name"</span></span>) uname.send_keys(username.decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>)) passw = driver.find_element_by_name(<span class="hljs-string"><span class="hljs-string">"user_password"</span></span>) passw.send_keys(password) submit_button = driver.find_element_by_class_name(<span class="hljs-string"><span class="hljs-string">"sendbutton"</span></span>).click()</code> </pre> <br><br><p>  And still (rather long I have to say) the time appeared such a class MistaDownloader, which allowed immediately after initialization to log in on the forum and download forum threads by its number: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- # export PYTHONIOENCODING=UTF-8 import base64 import selenium from selenium import webdriver from selenium.webdriver.common.keys import Keys from selenium.webdriver.support.ui import WebDriverWait from bs4 import BeautifulSoup from urllib import quote import sys import codecs import binascii import os import datetime import subprocess import syslog reload(sys) sys.setdefaultencoding("utf-8") syslog.syslog("MistaDownloader class loaded.") print ("MistaDownloader class loaded.") class MistaDownloader: def print_to_log(self, message): syslog.syslog(message) print (message) def __init__(self): self.print_to_log("MistaDownloader initializing...") self.driver = webdriver.Chrome("/usr/local/bin/chromedriver") self.base_url = 'http://www.forum.mista.ru/' self.folder = '//home/gomista/files' if not os.path.exists(self.folder): os.makedirs(self.folder) self.print_to_log("MistaDownloader initialized.") def authenticate(self): self.driver.get(self.base_url) username = " " password = "11" uname = self.driver.find_element_by_name("user_name") uname.send_keys(username.decode('utf-8')) passw = self.driver.find_element_by_name("user_password") passw.send_keys(password) submit_button = self.driver.find_element_by_class_name("sendbutton") .click() self.print_to_log("Authentication done.") def download_by_id(self, topic_id): self.print_to_log("ID: " + topic_id) def write_source_to_file(topic_id, page_number, page_url, page_source, folder): filename = folder + '/' + '{0:0&gt;7}'.format(topic_id) + '_' + '{0:0&gt;2}'.format(page_number) + '_' + binascii.hexlify(page_url) + '.txt' file = open(filename,'w') page_source_to_save = page_source.replace('\t', ' ') .replace('\n', ' ') .replace('\r', ' ') res = '%s\t%s\t%s\t%s' % (topic_id, page_number, page_url, page_source_to_save) file.write(res) file.close() page_number = 1 current_url = '%s%s%s%s%s' % (self.base_url, 'topic.php?id=', topic_id, '&amp;page=', page_number) self.print_to_log('getting page: ' + current_url) self.driver.set_page_load_timeout(240) try: self.driver.get(current_url) self.print_to_log('done') html = self.driver.page_source write_source_to_file(topic_id, page_number, current_url, html, self.folder) soup = BeautifulSoup(html, "lxml") pages_tag = soup.find('span', { 'class' : 'pages' }) additional_pages = set() if pages_tag: pages_tag = pages_tag.findAll('a', attrs = {'data-page' : True}) if pages_tag: for page_tag in pages_tag: additional_pages.add(page_tag['data-page']) additional_pages = list(sorted(additional_pages)) for additional_page in additional_pages: current_url = '%s%s%s%s%s' % (self.base_url, 'topic.php?id=', topic_id, '&amp;page=', additional_page) self.print_to_log('getting page: '+current_url) self.driver.set_page_load_timeout(240) self.driver.get(current_url) self.print_to_log('done') html = self.driver.page_source write_source_to_file(topic_id, additional_page, current_url, html, self.folder) except Exception as e: write_source_to_file(topic_id, page_number, current_url, 'ERRORERRORERROR', self.folder)</span></span></code> </pre> <br><p>  The download of the pages itself could be done with the following lines: </p><br><pre> <code class="python hljs">do = MistaDownloader() do.authenticate() topic_id = <span class="hljs-number"><span class="hljs-number">1</span></span> do.download_by_id(topic_id) ... topic_id = <span class="hljs-number"><span class="hljs-number">99</span></span> do.download_by_id(topic_id)</code> </pre> <br><p>  Then I wanted this script to run not only on the desktop, but also on a server without a graphical interface.  For this, with the help of Google, I released the next version of the script, which with the help of an emulator could be run anywhere: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> xvfbwrapper <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Xvfb <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mista_downloader <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MistaDownloader vdisplay = Xvfb() vdisplay.start() do = MistaDownloader() ... vdisplay.stop()</code> </pre><br><p>  And it seemed that it was enough to start the cycle from 1 to 1,000,000 (all new branches are now being created with an index of slightly more than 811 thousand).  However ... Preliminary measurements suggested that it would take about 2-3 weeks to smoke while the entire forum was in the form of files on the hard disk.  Yes, you could go along a proven path and run in several streams on your own laptop, but recently viewed Google Cloud Platform for Data Engineers courses suggested a new idea. </p><br><h3 id="parallel-do">  Parallel do </h3><br><p>  Google Cloud Platform, allows you to create a virtual server in less than a minute and delete it immediately after it copes with the task.  Those.  In accordance with the idea, I did not need to search for one powerful server and make it work for a week, it was easier for me to rent 20 simple servers for example for 10 hours.  And since I was watching courses on Hadoop, HDFS, MapReduce and so on, I decided to make my own cluster with blackjack and nodes. </p><br><p>  The essence of the cluster - the central server (master) contains a list of links (namely, forum forum IDs) that need to be downloaded.  Work servers (Nodes) connect to the Wizard, receive a batch of IDs, download them, add the received files to the GCS (Google Cloud Storage) storage, notify the Wizard that the task is completed and receive a new batch of IDs. </p><br><blockquote>  The Google Cloud Platform has a pretty handy thing - Google Cloud Shell.  This is a small free virtual machine that is always available through the browser and with its help you can manage the entire cloud.  For almost every action through the web interface there is a similar command that can be executed using the Google Cloud Shell.  All scripts further in the article will be run through it. </blockquote><p>  Using the following script, I created a virtual machine named <code>cserver</code> : </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/bash gcloud compute --project "new-mista-project" instances create cserver \ --zone "europe-west1-b" \ --machine-type "n1-standard-2" \ --subnet "default" \ --metadata-from-file startup-script=startupscript_server.sh \ --metadata "ssh-keys=gomista:ssh-rsa key-key-key gomista" \ --maintenance-policy "MIGRATE" \ --service-account "1007343160266-compute@developer.gserviceaccount.com" \ --scopes "https://www.googleapis.com/auth/cloud-platform" \ --min-cpu-platform "Automatic" \ --image "image-mista-node" \ --image-project "new-mista-project" \ --boot-disk-size "10" \ --boot-disk-type "pd-standard" \ --boot-disk-device-name cserver gcloud compute instances add-tags cserver --tags 'mysql-server' --zone \ "europe-west1-b"</span></span></code> </pre> <br><blockquote>  This is a server of type <code>n1-standard-2</code> , which in fact means 2CPUs 7.5Gb.  As a hard disk - 10Gb Standard Disk.  By the way, the pleasure is <code>48.95 per month estimated. Effective hourly rate $0.067 (730 hours per month)</code>  <code>48.95 per month estimated. Effective hourly rate $0.067 (730 hours per month)</code> , i.e.  an hour of using such a server will cost you 4 rubles, and a day less than $ 100. </blockquote><p>  The server was created on the basis of a Ubuntu 16.04 LTS image that I had prepared in advance, with installed libraries and applications.  In fact, the server could be created from bare Ubuntu, and the command to install all the necessary programs in the parameter - <code>--metadata-from-file</code> , for example, type <code>sudo apt-get install xvfb x11-xkb-utils -y</code> .  The transferred command or script would start immediately after the creation of the VM and install everything necessary.  But since I knew that I would still create / delete this car many times, I decided to spend the extra 10 minutes and prepare the image (by GCP).  Also at the time of the creation of the server, my start <code>startupscript_server.sh</code> run <code>startupscript_server.sh</code> , which copied my repo and added a script to crontab, which distributed tasks to the Nodes. </p><br><p>  I used this script to create the Nodes: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/bash gcloud compute --project "new-mista-project" instances create $1 \ --zone $2 \ --machine-type "n1-standard-1" \ --subnet "default" \ --metadata-from-file startup-script=startupscript.sh \ --metadata "ssh-keys=gomista:ssh-rsa key-keykey gomista" \ --no-restart-on-failure \ --maintenance-policy "TERMINATE" \ --preemptible \ --service-account "1007343160266-compute@developer.gserviceaccount.com" \ --scopes "https://www.googleapis.com/auth/cloud-platform" \ --min-cpu-platform "Automatic" \ --image "image-mista-node" \ --image-project "new-mista-project" \ --boot-disk-size "10" \ --boot-disk-type "pd-standard" \ --boot-disk-device-name $1 gcloud compute instances add-tags $1 --tags 'mysql-client' --zone $2</span></span></code> </pre> <br><blockquote>  As Noda, there was an <code>n1-standard-1</code> server (1CPUs 3.75Gb).  The main difference between Noda and the Master is the <code>--preemptible</code> .  Creating a server with this flag means that this server can be forcibly disabled by Google at any time and that the maximum server time is 24 hours.  If you rent such a server and agree to such conditions, then Google will drop the price for it from 24.67 per month to 7.70 per month (hourly $ 0.011), which is slightly more than 15 rubles per day.  And since I just needed a couple of dozens of "for batch jobs and fault-tolerant workloads" machines, preemptible machines became a good option.  By the way, adding tags to servers, I thus added Firewall Rules to them (which I had previously attached to these tags). </blockquote><p>  Create 20 virtual machines with one team and get them ready for work in 1 minute?  You are welcome: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/bash ./create_node_west.sh node01 europe-west1-b &amp; ./create_node_west.sh node02 europe-west1-b &amp; ./create_node_west.sh node03 europe-west1-b &amp; ./create_node_west.sh node04 europe-west1-b &amp; ./create_node_west.sh node05 europe-west1-b &amp; ./create_node_west.sh node06 europe-west1-b &amp; ./create_node_west.sh node07 europe-west2-b &amp; ./create_node_west.sh node08 europe-west2-b &amp; ./create_node_west.sh node09 europe-west2-b &amp; ./create_node_west.sh node10 europe-west2-b &amp; ./create_node_west.sh node11 europe-west2-b &amp; ./create_node_west.sh node12 europe-west2-b &amp; ./create_node_west.sh node13 europe-west2-b &amp; ./create_node_west.sh node14 europe-west3-b &amp; ./create_node_west.sh node15 europe-west3-b &amp; ./create_node_west.sh node16 europe-west3-b &amp; ./create_node_west.sh node17 europe-west3-b &amp; ./create_node_west.sh node18 europe-west3-b &amp; ./create_node_west.sh node19 europe-west3-b &amp; ./create_node_west.sh node20 europe-west3-b &amp;</span></span></code> </pre> <br><h3 id="blackjack-and-nodes">  Blackjack and nodes </h3><br><p>  And now how it all worked. </p><br><p>  After the start of the Wizard, I ran a script that installed MySQL and created the necessary tables (by the way, the first muscle experience is also the first): </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/bash sudo apt-get install mysql-server -y sudo sed -i -e "s/bind-address/#bind-address/g" \ /etc/mysql/mysql.conf.d/mysqld.cnf sudo service mysql restart echo "Please enter root user MySQL password!" read rootpasswd mysql -uroot -p${rootpasswd} \ -e "CREATE DATABASE mistadb DEFAULT CHARACTER SET utf8;" mysql -uroot -p${rootpasswd} \ -e "CREATE USER 'gomista'@'%' IDENTIFIED BY 'gomista';" mysql -uroot -p${rootpasswd} \ -e "GRANT ALL PRIVILEGES ON *.* TO 'gomista'@'%' WITH GRANT OPTION;" mysql -uroot -p${rootpasswd} -e "FLUSH PRIVILEGES;" mysql -ugomista -pgomista -e "CREATE TABLE server_statuses ( node_name VARCHAR(50) PRIMARY KEY, node_ip VARCHAR(15) NOT NULL, node_status TINYINT(50), updated_at TIMESTAMP );" mistadb mysql -ugomista -pgomista -e "CREATE TABLE server_commands ( id INT(6) UNSIGNED AUTO_INCREMENT PRIMARY KEY, node_name VARCHAR(50) NOT NULL, node_ip VARCHAR(15) NOT NULL, job_id VARCHAR(70), n_links INT(50), received TINYINT(50), updated_at TIMESTAMP, CONSTRAINT node_name_unique UNIQUE (node_name, job_id) );" mistadb mysql -ugomista -pgomista -e "CREATE TABLE links ( job_id VARCHAR(70), link VARCHAR(200), status TINYINT(50), updated_at TIMESTAMP, INDEX(job_id), INDEX(link), CONSTRAINT node_name_unique UNIQUE (job_id, link) );" mistadb python -c "exec(\"import sys\\nfor i in range(1,1000000): \ print ('\t'+'{0:0&gt;6}'.format(str(i))+'\t0')\")" &gt; numbers mysql -ugomista -pgomista -e "LOAD DATA LOCAL INFILE 'numbers' \ INTO TABLE links;" mistadb rm numbers</span></span></code> </pre> <br><blockquote>  Numbers from 1 to 999999 were stored in the <code>links</code> table, information on whether the number was processed or not (status 0 - not processed, 1 - in operation, 2 - processed), the identifier of the job that performs or performs the processing of one or another number.  In the <code>server_commands</code> table, the jobs that the Master distributed to the Nodes (received 0 ‚Äî issued, received 1 ‚Äî received, received 2 ‚Äî completed).  In the <code>server_statuses</code> table, the <code>server_statuses</code> statuses (node_status 0 is free, node_status 1 is busy). </blockquote><p>  Every 5 seconds the following script was launched on the Master: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python import mysql.connector import socket import uuid import datetime import sys if len(sys.argv) == 2: number_of_links = int(sys.argv[1]) else: number_of_links = 500 cnx = mysql.connector.connect(user='gomista', password='gomista', host='cserver', database='mistadb') cursor = cnx.cursor() select_servers =("SELECT server_statuses.node_name, server_statuses.node_status," "server_commands.received " "FROM server_statuses " "LEFT JOIN server_commands " "ON server_statuses.node_name = server_commands.node_name and " "server_commands.received &lt;&gt; 2 " "WHERE server_statuses.node_status = %(node_status)s and " "server_commands.received IS NULL LIMIT 1") server_status = {'node_status': 0} cursor.execute(select_servers, server_status) row = cursor.fetchone() if row: node_name = row[0] print (node_name) cursor = cnx.cursor() new_job_id = node_name + "_" + datetime.datetime.now().strftime("%Y%m%d_%H%M%S") + "_" + str(uuid.uuid4()) received = 0 add_job_command = ("INSERT INTO server_commands " "(node_name, node_ip, job_id, n_links, received) " "VALUES (%(node_name)s, %(node_ip)s, %(job_id)s, %(n_links)s, %(received)s) " "ON DUPLICATE KEY UPDATE node_ip = %(node_ip)s, " "n_links = %(n_links)s, received = %(received)s, updated_at=now();" "UPDATE links " "SET job_id = %(job_id)s " "WHERE job_id = '' AND status = 0 LIMIT %(n_links)s;") server_job = {'node_name': str(node_name), 'node_ip': str(node_name), 'job_id': new_job_id, 'n_links': number_of_links, 'received': received} for result in cursor.execute(add_job_command, server_job, multi=True): pass cnx.commit() cursor.close() cnx.close() else: print ("no available worker found")</span></span></code> </pre> <br><blockquote>  This script checked the <code>server_statuses</code> table for the presence of available servers, and if it was found, created a job for it in the <code>server_commands</code> table and bound a certain number of numbers from the <code>links</code> table to the job. </blockquote><p>  The nodes, in turn, added the following script to their crontab at the time of start, which was executed every minute: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python from xvfbwrapper import Xvfb from cserver_connector import CserverConnector from mista_downloader import MistaDownloader import sys import subprocess import syslog import datetime MAX_PROCESS_TIME = 40 # min def print_to_log(message): syslog.syslog(message) print (message) def get_process_time_in_min(connector): mod_time = datetime.datetime.fromtimestamp(connector.modified_time) current_time = datetime.datetime.now() delta = current_time - mod_time delta_min = delta.seconds / 60 return delta_min print_to_log("Creating connector...") connector = CserverConnector() print_to_log("Connector created. Working: "+str(connector.working)) if connector.working: process_time_in_min = get_process_time_in_min(connector) if process_time_in_min &gt; MAX_PROCESS_TIME: print_to_log("Canceling job...") connector.cancel_job() connector.remove_file_flag() print_to_log("Updating 0 status on cserver...") connector.update_status_on_cserver(0) print_to_log("Exiting...") exit(0) else: connector.update_status_on_cserver(1) print_to_log("Exiting...") exit(0) else: print_to_log("Updating 0 status on cserver...") connector.update_status_on_cserver(0) print_to_log("Getting new job...") connector.get_new_job() if not connector.job_id: print_to_log("No assigned jobs found...") print_to_log("Exiting...") exit(0) print_to_log("Job found: "+connector.job_id) connector.create_file_flag() print_to_log("Updating 1 status on cserver...") connector.update_status_on_cserver(1) print_to_log("Getting list of links...") connector.get_links_list() print_to_log("Starting Xvfb...") vdisplay = Xvfb() vdisplay.start() print_to_log("Creating MistaDownloader...") try: do = MistaDownloader() except Exception as e: print_to_log(str(e)) raise print_to_log("Do authenticate...") do.authenticate() folder = do.folder print_to_log("Downloading links in loop...") for link in connector.links_list: do.download_by_id(link[0].lstrip('0')) vdisplay.stop() print_to_log("Moving files to GS...") move_command = "gsutil -m mv " + folder + "/* gs://mistabucket-west/files" subprocess.call([move_command], shell=True) print_to_log("Updating links on finish...") connector.update_links_on_finish() connector.remove_file_flag() print_to_log("Updating 0 status on cserver...") connector.update_status_on_cserver(0) print_to_log("Exiting...")</span></span></code> </pre> <br><blockquote>  This script was connected to the <code>server_commands</code> and looked at the <code>server_commands</code> table.  If he found the task, then by the number he received the list of numbers, started the download and informed the Master that he had taken the job to work and that he was now busy.  After the download was completed, Nod updated the <code>server_statuses</code> tables (he said that he was free now), <code>server_commands</code> (said he had completed the task), and <code>links</code> noted which numbers he downloaded.  The master, in his turn, as soon as he saw that Nod was free, he threw a new job for him into the tasks with still unprocessed numbers, so that in less than a minute Nod would pick up this task and set to work ... </blockquote><p>  All communication between Noda and the Master brought to a separate class <code>CServerConnector</code> : </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python import mysql.connector import socket import os import syslog class CserverConnector: def print_to_log(self, message): syslog.syslog(message) print (message) def __init__(self): self.hostname = socket.gethostname() self.file_flag = '/home/gomista/WORKING' self.mysql_connector = mysql.connector.connect(user='gomista', password='gomista', host='cserver', database='mistadb', buffered=True) self.working = os.path.isfile(self.file_flag) if self.working: self.modified_time = os.path.getmtime(self.file_flag) with open(self.file_flag, 'r') as f: self.job_id = f.readline().strip() else: self.modified_time = None self.job_id = None self.n_links = 0 self.links_list = list() def create_file_flag(self): file_flag_to_write = open(self.file_flag, "w") file_flag_to_write.write(self.job_id) file_flag_to_write.close() def update_file_flag(self): self.create_file_flag() def remove_file_flag(self): if os.path.isfile(self.file_flag): os.remove(self.file_flag) def update_status_on_cserver(self, status): cursor = self.mysql_connector.cursor() add_server_status_query = ("INSERT INTO server_statuses " "(node_name, node_ip, node_status) " "VALUES (%(node_name)s, %(node_ip)s, %(node_status)s)" "ON DUPLICATE KEY UPDATE node_ip = %(node_ip)s, " "node_status = %(node_status)s, updated_at=now()") server_status = {'node_name': self.hostname, 'node_ip': self.hostname, 'node_status': status} cursor.execute(add_server_status_query, server_status) self.mysql_connector.commit() cursor.close() def get_new_job(self): cursor = self.mysql_connector.cursor() get_command_query = ("SELECT node_name, job_id, n_links " "FROM server_commands " "WHERE node_name = %(node_name)s AND job_id &lt;&gt; '' AND " "received = %(node_name)s LIMIT 1") server_status = {'node_name': self.hostname, 'node_ip': self.hostname, 'received': 0} cursor.execute(get_command_query, server_status) row = cursor.fetchone() if row: node_name = str(row[0]) self.job_id = str(row[1]) self.n_links = str(row[2]) else: self.job_id = None self.n_links = 0 cursor.close() def get_links_list(self): self.print_to_log("Getting coursor and prepare the query...") cursor = self.mysql_connector.cursor() update_job_command_query = ("UPDATE server_commands " "SET received = 1 " "WHERE job_id = %(job_id)s;") server_job = {'job_id': self.job_id} self.print_to_log("Executing query 1.") cursor.execute(update_job_command_query, server_job) self.print_to_log("Commiting query 1.") self.mysql_connector.commit() update_links_query = ("UPDATE links " "SET status = 1 " "WHERE job_id = %(job_id)s;") server_job = {'job_id': self.job_id} self.print_to_log("Executing query 2. with job_id: "+self.job_id) try: cursor.execute(update_links_query, server_job) except Exception as e: self.print_to_log(str(e)) self.print_to_log(cursor.statement) raise self.print_to_log("Commiting query 2.") self.mysql_connector.commit() cursor.close() cursor = self.mysql_connector.cursor() get_links_query = ("SELECT link FROM links WHERE job_id = %(job_id)s") self.print_to_log("Executing query 3.") cursor.execute(get_links_query, {'job_id': self.job_id}) for (link) in cursor: self.links_list.append(link) cursor.close() self.print_to_log("Finished.") def update_links_on_finish(self): cursor = self.mysql_connector.cursor() update_job_command_query = ("UPDATE server_commands " "SET received = 2 " "WHERE job_id = %(job_id)s;") server_job = {'job_id': self.job_id} cursor.execute(update_job_command_query, server_job) self.mysql_connector.commit() update_links_query = ("UPDATE links " "SET status = 2 " "WHERE job_id = %(job_id)s;") server_job = {'job_id': self.job_id} cursor.execute(update_links_query, server_job) self.mysql_connector.commit() cursor.close() def cancel_job(self): cursor = self.mysql_connector.cursor() update_job_command_query = ("DELETE FROM server_commands " "WHERE job_id = %(job_id)s;") server_job = {'job_id': self.job_id} cursor.execute(update_job_command_query, server_job) self.mysql_connector.commit() update_links_query = ("UPDATE links " "SET status = 0, job_id = '' " "WHERE job_id = %(job_id)s;") server_job = {'job_id': self.job_id} cursor.execute(update_links_query, server_job) self.mysql_connector.commit() cursor.close()</span></span></code> </pre> <br><p>  Here are the tables in the process of work: </p><br><pre> <code class="hljs smalltalk">gomista@cserver:~/mista<span class="hljs-string"><span class="hljs-string">$ </span></span>./get_mysql_status.sh <span class="hljs-type"><span class="hljs-type">NODES</span></span>: +-----------+---------+-------------+---------------------+ | node_name | node_ip | node_status | updated_at | +-----------+---------+-------------+---------------------+ | node01 | node01 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> | | node02 | node02 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> | | node03 | node03 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> | | node04 | node04 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> | | node05 | node05 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> | | node06 | node06 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> | | node07 | node07 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> | | node08 | node08 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> | | node09 | node09 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> | | node10 | node10 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> | | node11 | node11 | <span class="hljs-number"><span class="hljs-number">0</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span> | | node12 | node12 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> | | node13 | node13 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> | | node14 | node14 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> | | node15 | node15 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> | | node16 | node16 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> | | node17 | node17 | <span class="hljs-number"><span class="hljs-number">0</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span> | | node18 | node18 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> | | node19 | node19 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> | | node20 | node20 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span> | | node21 | node21 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> | | node22 | node22 | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> | +-----------+---------+-------------+---------------------+ <span class="hljs-type"><span class="hljs-type">JOBS</span></span> <span class="hljs-type"><span class="hljs-type">DONE</span></span>: +-----------+-----------+ | node_name | jobs_done | +-----------+-----------+ | node08 | <span class="hljs-number"><span class="hljs-number">5</span></span> | | node10 | <span class="hljs-number"><span class="hljs-number">5</span></span> | | node11 | <span class="hljs-number"><span class="hljs-number">6</span></span> | | node07 | <span class="hljs-number"><span class="hljs-number">6</span></span> | | node09 | <span class="hljs-number"><span class="hljs-number">7</span></span> | | node22 | <span class="hljs-number"><span class="hljs-number">8</span></span> | | node13 | <span class="hljs-number"><span class="hljs-number">9</span></span> | | node06 | <span class="hljs-number"><span class="hljs-number">9</span></span> | | node20 | <span class="hljs-number"><span class="hljs-number">10</span></span> | | node17 | <span class="hljs-number"><span class="hljs-number">10</span></span> | | node14 | <span class="hljs-number"><span class="hljs-number">10</span></span> | | node21 | <span class="hljs-number"><span class="hljs-number">10</span></span> | | node12 | <span class="hljs-number"><span class="hljs-number">10</span></span> | | node18 | <span class="hljs-number"><span class="hljs-number">11</span></span> | | node15 | <span class="hljs-number"><span class="hljs-number">11</span></span> | | node02 | <span class="hljs-number"><span class="hljs-number">12</span></span> | | node19 | <span class="hljs-number"><span class="hljs-number">12</span></span> | | node04 | <span class="hljs-number"><span class="hljs-number">12</span></span> | | node01 | <span class="hljs-number"><span class="hljs-number">12</span></span> | | node05 | <span class="hljs-number"><span class="hljs-number">13</span></span> | | node03 | <span class="hljs-number"><span class="hljs-number">13</span></span> | | node16 | <span class="hljs-number"><span class="hljs-number">15</span></span> | +-----------+-----------+ <span class="hljs-type"><span class="hljs-type">COMMANDS</span></span> <span class="hljs-type"><span class="hljs-type">TO</span></span> <span class="hljs-type"><span class="hljs-type">BE</span></span> <span class="hljs-type"><span class="hljs-type">DONE</span></span>: +-----+-----------+---------+-------+---------+----------+---------------------+ | id | node_name | node_ip | job_id| n_links | received | updated_at | +-----+-----------+---------+-------+---------+----------+---------------------+ | <span class="hljs-number"><span class="hljs-number">266</span></span> | node17 | node17 | ad062 | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span> | | <span class="hljs-number"><span class="hljs-number">267</span></span> | node11 | node11 | ab531 | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span> | +-----+-----------+---------+-------+---------+----------+---------------------+ <span class="hljs-type"><span class="hljs-type">COMMANDS</span></span> <span class="hljs-type"><span class="hljs-type">IN</span></span> <span class="hljs-type"><span class="hljs-type">PROGRESS</span></span>: +-----+-----------+---------+-------+---------+----------+---------------------+ | id | node_name | node_ip | job_id| n_links | received | updated_at | +-----+-----------+---------+-------+---------+----------+---------------------+ | <span class="hljs-number"><span class="hljs-number">244</span></span> | node14 | node14 | <span class="hljs-number"><span class="hljs-number">5e1</span></span>b6 | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span> | | <span class="hljs-number"><span class="hljs-number">245</span></span> | node06 | node06 | d0235 | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> | | <span class="hljs-number"><span class="hljs-number">246</span></span> | node13 | node13 | c82fd | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span> | | <span class="hljs-number"><span class="hljs-number">249</span></span> | node09 | node09 | <span class="hljs-number"><span class="hljs-number">1</span></span>d553 | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span> | | <span class="hljs-number"><span class="hljs-number">250</span></span> | node12 | node12 | <span class="hljs-number"><span class="hljs-number">9176</span></span>f | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> | | <span class="hljs-number"><span class="hljs-number">251</span></span> | node22 | node22 | <span class="hljs-number"><span class="hljs-number">1</span></span>c8ae | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> | | <span class="hljs-number"><span class="hljs-number">252</span></span> | node15 | node15 | <span class="hljs-number"><span class="hljs-number">3</span></span>ca50 | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span> | | <span class="hljs-number"><span class="hljs-number">253</span></span> | node18 | node18 | <span class="hljs-number"><span class="hljs-number">8836</span></span>c | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> | | <span class="hljs-number"><span class="hljs-number">254</span></span> | node21 | node21 | <span class="hljs-number"><span class="hljs-number">091</span></span>f7 | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> | | <span class="hljs-number"><span class="hljs-number">255</span></span> | node16 | node16 | <span class="hljs-number"><span class="hljs-number">6475</span></span>d | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span> | | <span class="hljs-number"><span class="hljs-number">256</span></span> | node19 | node19 | <span class="hljs-number"><span class="hljs-number">489</span></span>b3 | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span> | | <span class="hljs-number"><span class="hljs-number">257</span></span> | node04 | node04 | <span class="hljs-number"><span class="hljs-number">9</span></span>fd5a | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> | | <span class="hljs-number"><span class="hljs-number">258</span></span> | node05 | node05 | <span class="hljs-number"><span class="hljs-number">49</span></span>b9f | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> | | <span class="hljs-number"><span class="hljs-number">259</span></span> | node01 | node01 | <span class="hljs-number"><span class="hljs-number">579</span></span>a7 | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> | | <span class="hljs-number"><span class="hljs-number">260</span></span> | node20 | node20 | d3fe8 | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span> | | <span class="hljs-number"><span class="hljs-number">261</span></span> | node08 | node08 | ff1c7 | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span> | | <span class="hljs-number"><span class="hljs-number">262</span></span> | node03 | node03 | b1165 | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> | | <span class="hljs-number"><span class="hljs-number">263</span></span> | node02 | node02 | <span class="hljs-number"><span class="hljs-number">7</span></span>d138 | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> | | <span class="hljs-number"><span class="hljs-number">264</span></span> | node10 | node10 | <span class="hljs-number"><span class="hljs-number">4</span></span>ad65 | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span> | | <span class="hljs-number"><span class="hljs-number">265</span></span> | node07 | node07 | e6501 | <span class="hljs-number"><span class="hljs-number">500</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-01</span></span><span class="hljs-number"><span class="hljs-number">-05</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span> | +-----+-----------+---------+-------+---------+----------+---------------------+ <span class="hljs-type"><span class="hljs-type">LINKS</span></span> <span class="hljs-type"><span class="hljs-type">TO</span></span> <span class="hljs-type"><span class="hljs-type">BE</span></span> <span class="hljs-type"><span class="hljs-type">PROCESSED</span></span>: +-------------+ | count(link) | +-------------+ | <span class="hljs-number"><span class="hljs-number">881999</span></span> | +-------------+ <span class="hljs-type"><span class="hljs-type">LINKS</span></span> <span class="hljs-type"><span class="hljs-type">IN</span></span> <span class="hljs-type"><span class="hljs-type">PROCESS</span></span>: +-------------+ | count(link) | +-------------+ | <span class="hljs-number"><span class="hljs-number">10000</span></span> | +-------------+ <span class="hljs-type"><span class="hljs-type">LINKS</span></span> <span class="hljs-type"><span class="hljs-type">DONE</span></span> +-------------+ | count(link) | +-------------+ | <span class="hljs-number"><span class="hljs-number">108000</span></span> | +-------------+ gomista@cserver:~/mista$</code> </pre> <br><p>  The whole process took about 20 hours.  Who cares, in money it is: $ 0.067 <em>20 hours + $ 0.011</em> 20 hours * 20 cars or 5.74 in the currency of the enemy or about 350 in our native rubles.  The spent 20 hours and 350 rubles bore fruit in the form of an over million files weighing 30GB. </p><br><p>  The list of users has been downloaded by this script.  In fact, this is simply a search of user pages from 1 to 200,000. In fact, there are fewer users, however, for some reason, users with an ID above 100,000 were found, so it was decided to download with a margin: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- # export PYTHONIOENCODING=UTF-8 import base64 import selenium from selenium import webdriver from selenium.webdriver.common.keys import Keys from selenium.webdriver.support.ui import WebDriverWait from bs4 import BeautifulSoup from urllib import quote from xvfbwrapper import Xvfb import sys import codecs import binascii import os import datetime print(sys.getdefaultencoding()) reload(sys) sys.setdefaultencoding("utf-8") print(sys.getdefaultencoding()) if len(sys.argv) == 3: N_START = int(sys.argv[1]) N_END = int(sys.argv[2]) else: N_START = 1 N_END = 2 URL_TO_SAVE = 'users' if not os.path.exists(URL_TO_SAVE): os.makedirs(URL_TO_SAVE) vdisplay = Xvfb() vdisplay.start() def _convert(param): if isinstance(param, str): return param.decode('utf-8') else: return param def get_driver(): url = "http://www.forum.mista.ru/index.php" driver = webdriver.Chrome() return driver def authenticate(url, driver): driver.get(url) username = " " password = "11" uname = driver.find_element_by_name("user_name") uname.send_keys(_convert(username)) passw = driver.find_element_by_name("user_password") passw.send_keys(password) submit_button = driver.find_element_by_class_name("sendbutton").click() url_edit = "http://www.forum.mista.ru/users.php?action=edit" driver.get(url_edit) a = driver.find_element_by_xpath("//a[@href='#tab3']") a.click() topics = driver.find_element_by_name("topics_per_page") topics.clear() topics.send_keys(99) section = driver.find_element_by_name("column_forum") if not section.is_selected(): section.click() section = driver.find_element_by_name("column_replies") if not section.is_selected(): section.click() section = driver.find_element_by_name("column_section") if not section.is_selected(): section.click() section = driver.find_element_by_name("show_topic_section") if not section.is_selected(): section.click() section = driver.find_element_by_name("column_author") if not section.is_selected(): section.click() section = driver.find_element_by_name("column_updated") if not section.is_selected(): section.click() submit_button = driver.find_element_by_name("Submit").click() base_url = 'http://www.forum.mista.ru/' print("getting driver") driver = get_driver() print("logging") authenticate(base_url, driver) def save_user_page(page, driver, n=0): links_list = list() print('getting page: '+page) driver.get(page) print('done') html = driver.page_source.replace('\t', ' ').replace('\n', ' ') .replace('\r', ' ') filename = URL_TO_SAVE + '/' + '{0:0&gt;10}'.format(n) + '_' + binascii.hexlify(page) + '.txt' file = open(filename,'w') file.write(html + '\n') file.close() limit = 100 for i in range(N_START, N_END): current_url = 'http://www.forum.mista.ru/users.php?id=' + str(i) n = i save_user_page(current_url, driver, n) vdisplay.stop()</span></span></code> </pre> <br><p>  (  )         . </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- # export PYTHONIOENCODING=UTF-8 import base64 import selenium from selenium import webdriver from selenium.webdriver.common.keys import Keys from selenium.webdriver.support.ui import WebDriverWait from bs4 import BeautifulSoup from urllib import quote from xvfbwrapper import Xvfb import sys import codecs import binascii import os import datetime print(sys.getdefaultencoding()) reload(sys) sys.setdefaultencoding("utf-8") print(sys.getdefaultencoding()) URL_TO_SAVE = 'links_backward' if not os.path.exists(URL_TO_SAVE): os.makedirs(URL_TO_SAVE) vdisplay = Xvfb() vdisplay.start() def _convert(param): if isinstance(param, str): return param.decode('utf-8') else: return param def get_driver(): url = "http://www.forum.mista.ru/index.php" driver = webdriver.Chrome() return driver def authenticate(url, driver): driver.get(url) username = " " password = "11" uname = driver.find_element_by_name("user_name") uname.send_keys(_convert(username)) passw = driver.find_element_by_name("user_password") passw.send_keys(password) submit_button = driver.find_element_by_class_name("sendbutton").click() url_edit = "http://www.forum.mista.ru/users.php?action=edit" driver.get(url_edit) a = driver.find_element_by_xpath("//a[@href='#tab3']") a.click() topics = driver.find_element_by_name("topics_per_page") topics.clear() topics.send_keys(99) section = driver.find_element_by_name("column_forum") if not section.is_selected(): section.click() section = driver.find_element_by_name("column_replies") if not section.is_selected(): section.click() section = driver.find_element_by_name("column_section") if not section.is_selected(): section.click() section = driver.find_element_by_name("show_topic_section") if not section.is_selected(): section.click() section = driver.find_element_by_name("column_author") if not section.is_selected(): section.click() section = driver.find_element_by_name("column_updated") if not section.is_selected(): section.click() submit_button = driver.find_element_by_name("Submit").click() base_url = 'http://www.forum.mista.ru/' print("getting driver") driver = get_driver() print("logging") authenticate(base_url, driver) def save_links_list_on_page(page, driver, n=0): links_list = list() print('getting page: '+page) driver.get(page) print('done') html = driver.page_source soup = BeautifulSoup(html, "lxml") tr_list = soup.findAll('tr', attrs = {'data-topic_id' : True}) for tr_element in tr_list: topic_id = tr_element['data-topic_id'] tr_element_1 = tr_element.findAll('td', { 'class' : 'cc' }) section = tr_element_1[0].getText().replace('\t', '') length = tr_element_1[1].getText().replace('\t', '') tr_element_2 = tr_element.find('a', { 'class' : 'agb' }) title = tr_element_2.getText().replace('\t', '') tr_element_2_1 = tr_element.find('a', { 'class' : 'userlink' }) user_link = tr_element_2_1['href'] user_name = tr_element_2_1.getText().replace('\t', '') tr_element_2_2 = tr_element.find('a', { 'class' : 'sectionlink' }) subsection = '' if tr_element_2_2: subsection = tr_element_2_2.getText().replace('\t', '') classes = ' '.join(tr_element_2['class']).replace('\t', '') link = tr_element_2['href'].replace('\t', '') tr_element_3 = tr_element.find('a', { 'class' : 'sectionlink-gray' }) link_attributes = '%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s' % (topic_id, link, section, subsection, length, title, user_link, user_name, classes) links_list.append(link_attributes) next_link_tag = soup.find('a', text='&lt;&lt;') if next_link_tag: nex_page_link = base_url+next_link_tag['href'] else: nex_page_link = '' filename = URL_TO_SAVE + '/' + '{0:0&gt;10}'.format(n) + '_' + binascii.hexlify(page) + '.txt' file = open(filename,'w') for link in links_list: file.write(link + '\n') file.close() return nex_page_link current_url = 'http://www.forum.mista.ru/index.php?id=30309&amp;after=2000/07/06_14:17:00' n = 1 while current_url != '': current_url = save_links_list_on_page(current_url, driver, n) n += 1 print('next page to process: '+current_url) vdisplay.stop()</span></span></code> </pre> <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- # export PYTHONIOENCODING=UTF-8 import base64 import selenium from selenium import webdriver from selenium.webdriver.common.keys import Keys from selenium.webdriver.support.ui import WebDriverWait from bs4 import BeautifulSoup from urllib import quote from xvfbwrapper import Xvfb import sys import codecs import binascii import os import datetime import re from dateutil import parser from pytz import timezone reload(sys) sys.setdefaultencoding("utf-8") URL_TO_SAVE = 'users_bans' if not os.path.exists(URL_TO_SAVE): os.makedirs(URL_TO_SAVE) vdisplay = Xvfb() vdisplay.start() def get_empty_ban(): empty_ban = {} empty_ban['ban_user_id'] = '' empty_ban['ban_type'] = '' empty_ban['ban_user_ip'] = '' empty_ban['ban_section'] = '' empty_ban['ban_subsection'] = '' empty_ban['ban_date'] = '' empty_ban['ban_end_date'] = '' empty_ban['ban_moderator_id'] = '' empty_ban['ban_reason'] = '' empty_ban['ban_topic_id'] = '' return empty_ban def get_list_of_users_on_page(source): tz = timezone('Europe/Moscow') fmt = '%Y-%m-%d %H:%M:%S %Z%z' def parse_message_time(str_message_time): message_time = parser.parse(str_message_time) message_time = tz.localize(message_time) return message_time.strftime(fmt) soup = BeautifulSoup(source, "html.parser") table = soup.find('table', { 'bgcolor' : '#CCCCCC' }) tr_elements = table.findAll('tr', { 'class' : 'active' }) ban_list = list() for user_element in tr_elements: ban = get_empty_ban() tds = user_element.findAll('td') ban['ban_user_id'] = tds[0].find('a')['data-user_id'] ban['ban_type'] = tds[1].getText() ban['ban_user_ip'] = tds[2].getText() ban['ban_section'] = tds[3].getText() ban['ban_subsection'] = tds[4].getText() ban['ban_date'] = parse_message_time(tds[8].getText()) ban['ban_end_date'] = parse_message_time(tds[5].getText()) ban['ban_moderator_id'] = tds[7].find('a')['href'].split('=')[1] ban['ban_reason'] = tds[9].getText() ban['ban_topic_id'] = tds[10].getText() print ('%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s' % ( ban['ban_user_id'].encode('utf-8') , ban['ban_type'].encode('utf-8') , ban['ban_user_ip'].encode('utf-8') , ban['ban_section'].encode('utf-8') , ban['ban_subsection'].encode('utf-8') , ban['ban_date'].encode('utf-8') , ban['ban_end_date'].encode('utf-8') , ban['ban_moderator_id'].encode('utf-8') , ban['ban_reason'].encode('utf-8') , ban['ban_topic_id'])) ban_list.append(ban) return ban_list def _convert(param): if isinstance(param, str): return param.decode('utf-8') else: return param def get_driver(): url = "http://www.forum.mista.ru/index.php" driver = webdriver.Chrome() return driver def authenticate(url, driver): driver.get(url) username = " " password = "11" uname = driver.find_element_by_name("user_name") uname.send_keys(_convert(username)) passw = driver.find_element_by_name("user_password") passw.send_keys(password) submit_button = driver.find_element_by_class_name("sendbutton").click() url_edit = "http://www.forum.mista.ru/users.php?action=edit" driver.get(url_edit) a = driver.find_element_by_xpath("//a[@href='#tab3']") a.click() topics = driver.find_element_by_name("topics_per_page") topics.clear() topics.send_keys(99) section = driver.find_element_by_name("column_forum") if not section.is_selected(): section.click() section = driver.find_element_by_name("column_replies") if not section.is_selected(): section.click() section = driver.find_element_by_name("column_section") if not section.is_selected(): section.click() section = driver.find_element_by_name("show_topic_section") if not section.is_selected(): section.click() section = driver.find_element_by_name("column_author") if not section.is_selected(): section.click() section = driver.find_element_by_name("column_updated") if not section.is_selected(): section.click() submit_button = driver.find_element_by_name("Submit").click() base_url = 'http://www.forum.mista.ru/' driver = get_driver() authenticate(base_url, driver) def save_links_list_on_page(page, driver, n=0): driver.get(page) ban_list = get_list_of_users_on_page(driver.page_source) html = driver.page_source.replace('\t', ' ').replace('\n', ' ') .replace('\r', ' ').encode('utf-8') soup = BeautifulSoup(html, "html.parser") noindex_tag = soup.find('noindex') a_tag =noindex_tag.findAll('a') if len(a_tag) == 1: link_to_return = '' else: link_to_return = base_url+a_tag[1]['href'] return link_to_return current_url = 'http://www.forum.mista.ru/ban_list.php' n = 1 while current_url != '': current_url = save_links_list_on_page(current_url, driver, n) n += 1 if current_url == '' or current_url == 'http://www.forum.mista.ru/ban_list.php?next=': break vdisplay.stop()</span></span></code> </pre> <br><p>      4   ‚Äî   ,  - ,     . </p><br><p>              " ",         .     1  20     data  .       Google Cloud Storage      ,     - ,    .              ,     ,   ,      GCS  . </p><br><p>  ,       : </p><br><pre> <code class="bash hljs">cat * &gt; combo</code> </pre> <br><p>    : </p><br><pre> <code class="bash hljs">-bash: /bin/cat: Argument list too long</code> </pre> <br><p>    ,    : </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> f <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> *.txt; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> (cat <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${f}</span></span></span><span class="hljs-string">"</span></span>) &gt;&gt; ~/combo; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>;</code> </pre> <br><p>   ,          - . ,     ,  : </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> * | xargs paste -s -d \n &gt; ~/foo.txt</code> </pre> <br><p>      ‚Äî    .     . </p><br><p>   : </p><br><ol><li>  30     </li><li>  500  200    (  ) </li><li>  100    </li><li>  500    </li></ol><br><p>     . </p><br><h3 id="parsing-stage"> Parsing stage </h3><br><p>      : </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- # export PYTHONIOENCODING=UTF-8 from bs4 import BeautifulSoup from dateutil import parser from pytz import timezone import datetime import re import sys reload(sys) sys.setdefaultencoding("utf-8") def get_empty_message(): message = {} message['message_id'] = '' message['message_date_time'] = '' message['message_user_id'] = '' message['message_user_name'] = '' message['message_user_id'] = '' message['message_user_class'] = '' message['message_text'] = '' message['message_reply_to'] = '' message['message_external_links'] = '' return message def get_list_of_messages_on_page(source): tz = timezone('Europe/Moscow') fmt = '%Y-%m-%d %H:%M:%S %Z%z' def parse_message_time(str_message_time): str_message_time = '-'.join(str_message_time.split('-')[-2:]) message_time = parser.parse(str_message_time) message_time = tz.localize(message_time) return message_time.strftime(fmt) soup = BeautifulSoup(source, "html.parser") message_elements = soup.findAll('tr', id=re.compile("^message_\d+")) message_list = list() for message_element in message_elements: message = {} # message info message['message_id'] = int(re.sub("message_", "", message_element['id'])) message_date_time = message_element .find('div', { 'class' : 'message-info' }) .getText().replace(u'\xa0', u'') message['message_date_time'] = parse_message_time(message_date_time) # message user info user_info_element = message_element .find('td', id=re.compile("^tduser\d+")) .find('a', attrs = {'data-user_id' : True}) if user_info_element: message['message_user_id'] = user_info_element['data-user_id'] message['message_user_name'] = user_info_element['data-user_name'] .replace('\t','') message['message_user_id'] = user_info_element['href'] .replace('users.php?id=','') message['message_user_class'] = ' '.join(user_info_element['class']) .replace('\t','') else: user_info_element = message_element .find('span', { 'class' : 'anonym-user' }) message['message_user_id'] = '' message['message_user_name'] = user_info_element.getText() .replace('\t','') message['message_user_id'] = '' message['message_user_class'] = 'anonym-user' # message content message_text_element = message_element .find('div', { 'class' : 'message-text' }) if not message_text_element: message['message_text'] = '' message['message_reply_to'] = '' message['message_external_links'] = '' else: answer_link_elements = message_text_element .findAll('a', { 'class' : 'answer-link' }) for answer_link_element in answer_link_elements: answer_link_element.decompose() inner_link_elements = message_text_element .findAll('a', { 'class' : 'interlink', 'data-rel' : re.compile("^#\d+") }) inner_link_list = list() for inner_link_element in inner_link_elements: inner_link_list.append(inner_link_element.extract().getText() .encode('utf-8')) other_link_elements = message_text_element.findAll('a') other_link_list = list() for other_link_element in other_link_elements: other_link = other_link_element.extract()['href'] other_link_list.append(other_link.encode('utf-8')) message_text = message_text_element.getText() message_text = message_text.replace('\t',' ').replace('\n',' ') .replace('()','').strip() message['message_text'] = message_text message['message_reply_to'] = ' '.join(inner_link_list) message['message_external_links'] = ' '.join(other_link_list) message_list.append(message) return message_list if __name__ == "__main__": for line in sys.stdin: try: topic_id, page_number, link, source = line.strip().split('\t') except Exception as e: continue if source == '&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;  .&lt;/body&gt;&lt;/html&gt;': message_list = list() message = get_empty_message() message_list.append(message) else: try: message_list = get_list_of_messages_on_page(source) except Exception as e: message_list = list() message = get_empty_message() message['message_user_name'] = 'ERRORERRORERROR' message['message_text'] = str(e) message_list.append(message) for message in message_list: # 12 columns print ('%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s' % ( topic_id , page_number , link , message['message_id'] , message['message_date_time'].encode('utf-8') , message['message_user_name'].encode('utf-8') , message['message_user_id'].encode('utf-8') , message['message_user_class'].encode('utf-8') , message['message_text'].encode('utf-8') , message['message_reply_to'].encode('utf-8') , message['message_external_links'].encode('utf-8')))</span></span></code> </pre> <br><p>   ,      ,         tsv.       BeautifulSoup. ,   ,      .       . </p><br><p>         : </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- # export PYTHONIOENCODING=UTF-8 from bs4 import BeautifulSoup from dateutil import parser from pytz import timezone import datetime import re import sys reload(sys) sys.setdefaultencoding("utf-8") def get_empty_user(): empty_user = {} empty_user['user_id'] = '' empty_user['user_name'] = '' empty_user['user_full_name'] = '' empty_user['user_email'] = '' empty_user['user_contacts'] = '' empty_user['user_url'] = '' empty_user['user_city_country'] = '' empty_user['user_dob'] = '' empty_user['user_timezone'] = '' empty_user['user_gender'] = '' empty_user['user_position'] = '' empty_user['user_achievement'] = '' empty_user['user_interests'] = '' empty_user['user_forum_role'] = '' empty_user['user_registration'] = '' empty_user['user_messages'] = '' empty_user['user_topics'] = '' return empty_user months_dic = {} months_dic[''] = 'January' months_dic[''] = 'February' months_dic[''] = 'March' months_dic[''] = 'April' months_dic[''] = 'May' months_dic[''] = 'June' months_dic[''] = 'July' months_dic[''] = 'August' months_dic[''] = 'September' months_dic[''] = 'October' months_dic[''] = 'November' months_dic[''] = 'December' def get_user_info_on_page(source): fmt = '%Y-%m-%d' def parse_str_date(str_date): if str_date == '': return ''; try: date_str = str_date.split(';')[0] if date_str[4:5] == ' ': dd = '01' mm = 'January' yy = date_str[:4] date = parser.parse(' '.join([dd, mm, yy])) else: dd, mm, yy = date_str.split(' ') date = parser.parse(' '.join([dd, months_dic[mm], yy])) return date.strftime(fmt) except Exception as e: return '' user = get_empty_user() soup = BeautifulSoup(source, "html.parser") id_tag = soup.find('a', href=re.compile('index.php\?user_id=\d+')) if id_tag: user['user_id'] = id_tag['href'].split('=')[1].encode('utf-8').strip() main_table = soup.findAll('table', { 'class' : 'table' }) main_table = main_table[len(main_table)-1] main_table_rows = main_table.findAll('tr') user['user_name'] = main_table_rows[0].findAll('td')[1].getText() .encode('utf-8').strip() user['user_full_name'] = main_table_rows[1].findAll('td')[1].getText() .encode('utf-8').strip() user['user_email'] = main_table_rows[3].findAll('td')[1].getText() .encode('utf-8').strip() user['user_contacts'] = main_table_rows[4].findAll('td')[1].getText() .encode('utf-8').strip() user['user_url'] = main_table_rows[5].findAll('td')[1].getText() .encode('utf-8').strip() user['user_city_country'] = main_table_rows[6].findAll('td')[1].getText() .encode('utf-8').strip() str_dob = main_table_rows[7].findAll('td')[1].getText().encode('utf-8').strip() user['user_dob'] = parse_str_date(str_dob) user['user_timezone'] = main_table_rows[8].findAll('td')[1].getText() .encode('utf-8').strip() user['user_gender'] = main_table_rows[9].findAll('td')[1].getText() .encode('utf-8').strip() user['user_position'] = main_table_rows[10].findAll('td')[1].getText() .encode('utf-8').strip() user['user_achievement'] = main_table_rows[11].findAll('td')[1].getText() .encode('utf-8').strip() user['user_interests'] = main_table_rows[12].findAll('td')[1].getText() .encode('utf-8').strip() user['user_forum_role'] = main_table_rows[13].findAll('td')[1].getText() .encode('utf-8').strip() str_reg = main_table_rows[14].findAll('td')[1].getText() .encode('utf-8').strip() user['user_registration'] = parse_str_date(str_reg) user['user_messages'] = main_table_rows[15].findAll('td')[1].getText() .encode('utf-8').strip() user['user_topics'] = main_table_rows[16].findAll('td')[1].getText() .encode('utf-8').strip() return user if __name__ == "__main__": for line in sys.stdin: try: source = line.strip() except Exception as e: continue if source == '' or source == '&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;    :    id  .&lt;/body&gt;&lt;/html&gt;': user = get_empty_user() else: user = get_empty_user() try: user = get_user_info_on_page(source) except Exception as e: user = get_empty_user() user['user_name'] = 'ERRORERRORERROR' user['user_full_name'] = str(e) print ('%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s' % ( user['user_id'] , user['user_name'] , user['user_full_name'] , user['user_email'] , user['user_contacts'] , user['user_url'] , user['user_city_country'] , user['user_dob'] , user['user_timezone'] , user['user_gender'] , user['user_position'] , user['user_achievement'] , user['user_interests'] , user['user_forum_role'] , user['user_registration'] , user['user_messages'] , user['user_topics']))</span></span></code> </pre> <br><p>    . </p><br><h3 id="hadoop-and-distributed-computing"> Hadoop and distributed computing </h3><br><p>      Hadoop  MapReduce.       MapReduce  WordCount   ,  ,         .     GCP    ,         distributed computing   . </p><br><blockquote> GCP       DataProc.    ,        (    High Availability)        .     2-3 ,      (Hadoop, HDFS, Spark etc).              .   ‚Äî    job   .   , Hadoop   c Google Storage Platform     HDSF (..       HDFS  ).   ‚Äî      ,  job  ,      .           .  Those.        2    5    20    30 .           ,   ,    ? </blockquote><p>        20     <code>n1-standard-1</code> (1CPUs 3.75Gb),             .     : </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/bash gcloud dataproc clusters create cluster-west \ --region europe-west1 \ --zone europe-west1-b \ --bucket mistabucket-west \ --subnet default \ --master-machine-type n1-standard-1 \ --master-boot-disk-size 100 \ --num-workers 20 \ --worker-machine-type n1-standard-1 \ --worker-boot-disk-size 100 \ --scopes 'https://www.googleapis.com/auth/cloud-platform' \ --project new-mista-project \ --initialization-actions 'gs://mistabucket-europe/install_environment.sh'</span></span></code> </pre> <br><blockquote>          <code>preemptible</code> ,      hdfs   . </blockquote><p>  3           (  ,    -). </p><br><p><img src="https://habrastorage.org/webt/zh/eu/ss/zheusspoczvcrtdyz1arwe8xwgc.png" alt="Cluster"></p><br><p> ,        Google Cloud Shell: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash PARSER_FILE="gs://mistabucket-west/mapper_parser.py" IN_DIR="gs://mistabucket-west/grabbing_results_html/messages_big" OUT_DIR="gs://mistabucket-west/output_mid" gsutil rm -r ${OUT_DIR} &gt; /dev/null gsutil cp mapper_parser.py ${PARSER_FILE} gcloud dataproc jobs submit hadoop \ --cluster cluster-west \ --region europe-west1 \ --jar file:///usr/lib/hadoop-mapreduce/hadoop-streaming.jar \ -- \ -D mapred.jab.name="Parsing mista pages job 1 (parsing)" \ -files ${PARSER_FILE} \ -mapper mapper_parser.py \ -reducer 'cat' \ -input ${IN_DIR} \ -output ${OUT_DIR} IN_DIR="gs://mistabucket-west/output_mid" OUT_DIR="gs://mistabucket-west/grabbing_results_tsv/messages_dirty" gsutil rm -r ${OUT_DIR} &gt; /dev/null gcloud dataproc jobs submit hadoop \ --cluster cluster-west \ --region europe-west1 \ --jar file:///usr/lib/hadoop-mapreduce/hadoop-streaming.jar \ -- \ -D mapred.jab.name="Parsing mista pages job 2 (sorting)" \ -mapper 'cat' \ -reducer 'sort -k1,1n -k2,2n -k4,4n' \ -input ${IN_DIR} \ -output ${OUT_DIR} gsutil rm -r ${IN_DIR} &gt; /dev/null</span></span></code> </pre> <br><p>     ,  ‚Äî . </p><br><p>   ,       : </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash IN_DIR="gs://mistabucket-west/grabbing_results_html/messages" OUT_DIR="gs://mistabucket-west/output_mid" OUT_LOG=out.$(date +"%s%6N").log gsutil rm -r ${OUT_DIR} &gt; /dev/null hadoop jar /usr/lib/hadoop-mapreduce/hadoop-streaming.jar \ -D mapred.jab.name="Parsing mista pages job 1 (parsing)" \ -files mapper_parser.py \ -mapper mapper_parser.py \ -reducer 'cat' \ -input ${IN_DIR} \ -output ${OUT_DIR} &gt; /dev/null 2&gt;${OUT_LOG} IN_DIR="gs://mistabucket-west/output_mid" OUT_DIR="gs://mistabucket-west/grabbing_results_tsv/messages_dirty" gsutil rm -r ${OUT_DIR} &gt; /dev/null hadoop jar /usr/lib/hadoop-mapreduce/hadoop-streaming.jar \ -D mapred.jab.name="Parsing mista pages job 2 (sorting)" \ -mapper 'cat' \ -reducer 'sort -k1,1n -k2,2n -k4,4n' \ -input ${IN_DIR} \ -output ${OUT_DIR} gsutil rm -r ${IN_DIR} &gt; /dev/null</span></span></code> </pre> <br><blockquote>        -       . </blockquote><p>        : </p><br><p><img src="https://habrastorage.org/webt/mc/8p/vr/mc8pvrz2pgthxwkstxbtnfzjp5c.png" alt="Cluster performance"></p><br><p>      : </p><br><pre> <code class="hljs coffeescript">CPU[<span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">####93.8%] Mem[|||||||||||||||||||||||||||||||||||||||||||#********** 2112/3711MB] Swp[ 0/0MB] PID USER PRI NI VIRT RES SHR S CPU% MEM% TIME+ Command 10054 yarn 20 0 60432 36780 8224 R 25.0 1.0 3:04.25 python /hadoop... 10182 yarn 20 0 64908 41096 8156 R 25.0 1.1 2:28.96 python /hadoop... 10257 yarn 20 0 70280 46392 8288 R 25.0 1.2 2:17.99 python /hadoop... 10982 igab 20 0 25244 4376 2940 R 16.7 0.1 0:00.02 htop -C 10015 yarn 20 0 2420M 394M 26584 S 8.3 10.6 0:01.21 /usr/lib/jvm/j... 10039 yarn 20 0 2420M 394M 26584 R 8.3 10.6 0:00.85 /usr/lib/jvm/j... 10008 yarn 20 0 2420M 394M 26584 S 8.3 10.6 0:13.12 /usr/lib/jvm/j... 1 root 20 0 29640 5872 3104 S 0.0 0.2 0:06.54 /sbin/init 144 root 20 0 41524 6392 4012 S 0.0 0.2 0:00.40 /lib/systemd/s... 147 root 20 0 40808 3300 2772 S 0.0 0.1 0:00.07 /lib/systemd/s... 259 root 20 0 25400 7856 892 S 0.0 0.2 0:00.00 dhclient -v -p... 314 root 20 0 37080 2728 2296 S 0.0 0.1 0:00.00 /sbin/rpcbind ... 323 statd 20 0 37280 3060 2468 S 0.0 0.1 0:00.00 /sbin/rpc.stat... 337 root 20 0 23356 204 4 S 0.0 0.0 0:00.00 /usr/sbin/rpc.... 338 root 20 0 27476 2732 2500 S 0.0 0.1 0:00.01 /usr/sbin/cron... 355 root 20 0 252M 3344 2700 S 0.0 0.1 0:00.02 /usr/sbin/rsys... 356 root 20 0 252M 3344 2700 S 0.0 0.1 0:00.00 /usr/sbin/rsys... 357 root 20 0 252M 3344 2700 S 0.0 0.1 0:00.06 /usr/sbin/rsys... 339 root 20 0 252M 3344 2700 S 0.0 0.1 0:00.09 /usr/sbin/rsys... 343 messagebu 20 0 42120 3300 2920 S 0.0 0.1 0:00.27 /usr/bin/dbus-... 377 root 20 0 19856 2564 2296 S 0.0 0.1 0:00.11 /lib/systemd/s... 379 root 20 0 4256 1624 1480 S 0.0 0.0 0:00.00 /usr/sbin/acpi... 386 root 20 0 14416 1936 1784 S 0.0 0.1 0:00.00 /sbin/agetty -... 387 root 20 0 14236 2040 1888 S 0.0 0.1 0:00.00 /sbin/agetty -... 391 ntp 20 0 29168 4028 3452 S 0.0 0.1 0:00.62 /usr/sbin/ntpd... 425 root 20 0 55184 5400 4724 S 0.0 0.1 0:00.00 /usr/sbin/sshd... 431 root 20 0 53908 19460 7224 S 0.0 0.5 0:00.99 /usr/bin/pytho... 434 root 20 0 53484 19304 7224 S 0.0 0.5 0:00.43 /usr/bin/pytho... 435 root 20 0 55556 19192 7124 S 0.0 0.5 0:00.77 /usr/bin/pytho...</span></span></code> </pre> <br><p>    4 : </p><br><pre> <code class="hljs vhdl">gomista@cluster-west-m:~/mista/mapreduce$ ./parser_pages_run.sh CommandException: No URLs matched: gs://mistabucket-west/output_mid <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span> INFO gcs.GoogleHadoopFileSystemBase: GHFS version: <span class="hljs-number"><span class="hljs-number">1.6</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>-ha... packageJobJar: [] [/usr/lib/hadoop-mapreduce/hadoop-streaming-<span class="hljs-number"><span class="hljs-number">2.8</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>.jar] /tmp... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span> INFO client.RMProxy: Connecting <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ResourceManager at clust... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span> INFO client.RMProxy: Connecting <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ResourceManager at clust... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">25</span></span> INFO mapred.FileInputFormat: Total input files <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">process</span></span> :... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">25</span></span> INFO mapreduce.JobSubmitter: number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> splits:<span class="hljs-number"><span class="hljs-number">238</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">25</span></span> INFO mapreduce.JobSubmitter: Submitting tokens <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> job: job... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span> INFO impl.YarnClientImpl: Submitted application application... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span> INFO mapreduce.Job: The url <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> track the job: http://cluste... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span> INFO mapreduce.Job: Running job: job_1516327218763_0003 <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span> INFO mapreduce.Job: Job job_1516327218763_0003 running <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> u... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% ... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% ... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% ... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">98</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% ... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">99</span></span>% reduce <span class="hljs-number"><span class="hljs-number">30</span></span>% <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>% reduce <span class="hljs-number"><span class="hljs-number">30</span></span>% ... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>% reduce <span class="hljs-number"><span class="hljs-number">99</span></span>% <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>% reduce <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span> INFO mapreduce.Job: Job job_1516327218763_0003 completed su... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span> INFO mapreduce.Job: Counters: <span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-keyword"><span class="hljs-keyword">File</span></span> System Counters <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes read=<span class="hljs-number"><span class="hljs-number">6430372113</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes written=<span class="hljs-number"><span class="hljs-number">12899232930</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> large read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> write operations=<span class="hljs-number"><span class="hljs-number">0</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes read=<span class="hljs-number"><span class="hljs-number">31919556146</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes written=<span class="hljs-number"><span class="hljs-number">6347504555</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> large read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> write operations=<span class="hljs-number"><span class="hljs-number">0</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes read=<span class="hljs-number"><span class="hljs-number">28798</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes written=<span class="hljs-number"><span class="hljs-number">0</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> read operations=<span class="hljs-number"><span class="hljs-number">238</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> large read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> write operations=<span class="hljs-number"><span class="hljs-number">0</span></span> Job Counters Killed <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">10</span></span> Launched <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">248</span></span> Launched reduce tasks=<span class="hljs-number"><span class="hljs-number">22</span></span> Rack-local <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">248</span></span> Total <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> maps <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> occupied slots (ms)=<span class="hljs-number"><span class="hljs-number">3439064804</span></span> Total <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reduces <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> occupied slots (ms)=<span class="hljs-number"><span class="hljs-number">144019192</span></span> Total <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks (ms)=<span class="hljs-number"><span class="hljs-number">859766201</span></span> Total <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reduce tasks (ms)=<span class="hljs-number"><span class="hljs-number">18002399</span></span> Total vcore-milliseconds taken by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">859766201</span></span> Total vcore-milliseconds taken by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reduce tasks=<span class="hljs-number"><span class="hljs-number">18002399</span></span> Total megabyte-milliseconds taken by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">880400589824</span></span> Total megabyte-milliseconds taken by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reduce tasks=<span class="hljs-number"><span class="hljs-number">36868913152</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span>-Reduce Framework <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> input records=<span class="hljs-number"><span class="hljs-number">1062462</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> output records=<span class="hljs-number"><span class="hljs-number">16818747</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> output bytes=<span class="hljs-number"><span class="hljs-number">6372056899</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> output materialized bytes=<span class="hljs-number"><span class="hljs-number">6430403397</span></span> Input split bytes=<span class="hljs-number"><span class="hljs-number">28798</span></span> Combine input records=<span class="hljs-number"><span class="hljs-number">0</span></span> Combine output records=<span class="hljs-number"><span class="hljs-number">0</span></span> Reduce input groups=<span class="hljs-number"><span class="hljs-number">957787</span></span> Reduce shuffle bytes=<span class="hljs-number"><span class="hljs-number">6430403397</span></span> Reduce input records=<span class="hljs-number"><span class="hljs-number">16818747</span></span> Reduce output records=<span class="hljs-number"><span class="hljs-number">16818747</span></span> Spilled Records=<span class="hljs-number"><span class="hljs-number">33637494</span></span> Shuffled Maps =<span class="hljs-number"><span class="hljs-number">5236</span></span> Failed Shuffles=<span class="hljs-number"><span class="hljs-number">0</span></span> Merged <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> outputs=<span class="hljs-number"><span class="hljs-number">5236</span></span> GC <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> elapsed (ms)=<span class="hljs-number"><span class="hljs-number">188467</span></span> CPU <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent (ms)=<span class="hljs-number"><span class="hljs-number">277329350</span></span> Physical memory (bytes) snapshot=<span class="hljs-number"><span class="hljs-number">115141345280</span></span> Virtual memory (bytes) snapshot=<span class="hljs-number"><span class="hljs-number">682591932416</span></span> Total committed heap usage (bytes)=<span class="hljs-number"><span class="hljs-number">89168744448</span></span> Shuffle Errors BAD_ID=<span class="hljs-number"><span class="hljs-number">0</span></span> CONNECTION=<span class="hljs-number"><span class="hljs-number">0</span></span> IO_ERROR=<span class="hljs-number"><span class="hljs-number">0</span></span> WRONG_LENGTH=<span class="hljs-number"><span class="hljs-number">0</span></span> WRONG_MAP=<span class="hljs-number"><span class="hljs-number">0</span></span> WRONG_REDUCE=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">File</span></span> Input Format Counters Bytes Read=<span class="hljs-number"><span class="hljs-number">31919556146</span></span> <span class="hljs-keyword"><span class="hljs-keyword">File</span></span> Output Format Counters Bytes Written=<span class="hljs-number"><span class="hljs-number">6347504555</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span> INFO streaming.StreamJob: Output directory: gs://mistabucke... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span> INFO gcs.GoogleHadoopFileSystemBase: GHFS version: <span class="hljs-number"><span class="hljs-number">1.6</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>-ha... packageJobJar: [] [/usr/lib/hadoop-mapreduce/hadoop-streaming-<span class="hljs-number"><span class="hljs-number">2.8</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>.jar] /tmp... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span> INFO client.RMProxy: Connecting <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ResourceManager at clust... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">18</span></span> INFO client.RMProxy: Connecting <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ResourceManager at clust... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span> INFO mapred.FileInputFormat: Total input files <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">process</span></span> :... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span> INFO mapreduce.JobSubmitter: number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> splits:<span class="hljs-number"><span class="hljs-number">198</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span> INFO mapreduce.JobSubmitter: Submitting tokens <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> job: job... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span> INFO impl.YarnClientImpl: Submitted application application... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span> INFO mapreduce.Job: The url <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> track the job: http://cluste... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span> INFO mapreduce.Job: Running job: job_1516327218763_0004 <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span> INFO mapreduce.Job: Job job_1516327218763_0004 running <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> u... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% ... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% ... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">93</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">97</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">99</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% ... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">25</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>% reduce <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> INFO mapreduce.Job: Job job_1516327218763_0004 completed su... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> INFO mapreduce.Job: Counters: <span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-keyword"><span class="hljs-keyword">File</span></span> System Counters <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes read=<span class="hljs-number"><span class="hljs-number">6430372113</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes written=<span class="hljs-number"><span class="hljs-number">12893310310</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> large read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> write operations=<span class="hljs-number"><span class="hljs-number">0</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes read=<span class="hljs-number"><span class="hljs-number">6348254123</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes written=<span class="hljs-number"><span class="hljs-number">6347504555</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> large read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> write operations=<span class="hljs-number"><span class="hljs-number">0</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes read=<span class="hljs-number"><span class="hljs-number">18810</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes written=<span class="hljs-number"><span class="hljs-number">0</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> read operations=<span class="hljs-number"><span class="hljs-number">198</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> large read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> write operations=<span class="hljs-number"><span class="hljs-number">0</span></span> Job Counters Killed <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">2</span></span> Launched <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">199</span></span> Launched reduce tasks=<span class="hljs-number"><span class="hljs-number">22</span></span> Rack-local <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">199</span></span> Total <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> maps <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> occupied slots (ms)=<span class="hljs-number"><span class="hljs-number">17328576</span></span> Total <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reduces <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> occupied slots (ms)=<span class="hljs-number"><span class="hljs-number">5680336</span></span> Total <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks (ms)=<span class="hljs-number"><span class="hljs-number">4332144</span></span> Total <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reduce tasks (ms)=<span class="hljs-number"><span class="hljs-number">710042</span></span> Total vcore-milliseconds taken by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">4332144</span></span> Total vcore-milliseconds taken by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reduce tasks=<span class="hljs-number"><span class="hljs-number">710042</span></span> Total megabyte-milliseconds taken by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">4436115456</span></span> Total megabyte-milliseconds taken by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reduce tasks=<span class="hljs-number"><span class="hljs-number">1454166016</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span>-Reduce Framework <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> input records=<span class="hljs-number"><span class="hljs-number">16818747</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> output records=<span class="hljs-number"><span class="hljs-number">16818747</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> output bytes=<span class="hljs-number"><span class="hljs-number">6372056899</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> output materialized bytes=<span class="hljs-number"><span class="hljs-number">6430398117</span></span> Input split bytes=<span class="hljs-number"><span class="hljs-number">18810</span></span> Combine input records=<span class="hljs-number"><span class="hljs-number">0</span></span> Combine output records=<span class="hljs-number"><span class="hljs-number">0</span></span> Reduce input groups=<span class="hljs-number"><span class="hljs-number">957787</span></span> Reduce shuffle bytes=<span class="hljs-number"><span class="hljs-number">6430398117</span></span> Reduce input records=<span class="hljs-number"><span class="hljs-number">16818747</span></span> Reduce output records=<span class="hljs-number"><span class="hljs-number">16818747</span></span> Spilled Records=<span class="hljs-number"><span class="hljs-number">33637494</span></span> Shuffled Maps =<span class="hljs-number"><span class="hljs-number">4356</span></span> Failed Shuffles=<span class="hljs-number"><span class="hljs-number">0</span></span> Merged <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> outputs=<span class="hljs-number"><span class="hljs-number">4356</span></span> GC <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> elapsed (ms)=<span class="hljs-number"><span class="hljs-number">104202</span></span> CPU <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent (ms)=<span class="hljs-number"><span class="hljs-number">849850</span></span> Physical memory (bytes) snapshot=<span class="hljs-number"><span class="hljs-number">99081195520</span></span> Virtual memory (bytes) snapshot=<span class="hljs-number"><span class="hljs-number">580507611136</span></span> Total committed heap usage (bytes)=<span class="hljs-number"><span class="hljs-number">78608355328</span></span> Shuffle Errors BAD_ID=<span class="hljs-number"><span class="hljs-number">0</span></span> CONNECTION=<span class="hljs-number"><span class="hljs-number">0</span></span> IO_ERROR=<span class="hljs-number"><span class="hljs-number">0</span></span> WRONG_LENGTH=<span class="hljs-number"><span class="hljs-number">0</span></span> WRONG_MAP=<span class="hljs-number"><span class="hljs-number">0</span></span> WRONG_REDUCE=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">File</span></span> Input Format Counters Bytes Read=<span class="hljs-number"><span class="hljs-number">6348254123</span></span> <span class="hljs-keyword"><span class="hljs-keyword">File</span></span> Output Format Counters Bytes Written=<span class="hljs-number"><span class="hljs-number">6347504555</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> INFO streaming.StreamJob: Output directory: gs://mistabucke...</code> </pre> <br><p>       ,           ,     ,   4     20      4 .       html/xml           <code>BeautifulSoup</code> ,    . ,  <code>BeautifulSoup</code>        <a href="http://lxml.de/tutorial.html">lxml  etree</a> .            .        : </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- # export PYTHONIOENCODING=UTF-8 from bs4 import BeautifulSoup from dateutil import parser as parserDate from pytz import timezone import datetime import re import sys from lxml import etree from io import StringIO, BytesIO reload(sys) sys.setdefaultencoding("utf-8") def get_empty_message(): message = {} message['message_id'] = '' message['message_date_time'] = '' message['message_user_id'] = '' message['message_user_name'] = '' message['message_user_link'] = '' message['message_user_class'] = '' message['message_text'] = '' message['message_reply_to'] = '' message['message_external_links'] = '' return message def get_list_of_messages_on_page(source): tz = timezone('Europe/Moscow') fmt = '%Y-%m-%d %H:%M:%S %Z%z' def parse_message_time(str_message_time): str_message_time = '-'.join(str_message_time.split('-')[-2:]) message_time = parserDate.parse(str_message_time) message_time = tz.localize(message_time) return message_time.strftime(fmt) parser = etree.HTMLParser() tree = etree.parse(StringIO(source.decode('utf-8')), parser) message_elements = tree.xpath("//tr[starts-with(@id, 'message_')]") message_list = list() for message_element in message_elements: message = get_empty_message() message['message_id'] = int(re.sub("message_", "", message_element.attrib['id'])) message_date_time = message_element .xpath(".//div[@class = 'message-info']//text()")[0] .replace(u'\xa0', u'') message['message_date_time'] = parse_message_time(message_date_time) user_info_elements = message_element .xpath(".//td[starts-with(@id, 'tduser')]/a") if len(user_info_elements) == 1: user_info_element = user_info_elements[0] message['message_user_id'] = user_info_element.attrib['data-user_id'] message['message_user_name'] = user_info_element.attrib['data-user_name'] .replace('\t','') message['message_user_link'] = user_info_element.attrib['href'] message['message_user_class'] = user_info_element.attrib['class'] .replace('\t','') else: user_info_element = message_element .xpath(".//span[@class = 'anonym-user']/text()")[0] message['message_user_id'] = '' message['message_user_name'] = user_info_element.replace('\t','') message['message_user_link'] = '' message['message_user_class'] = 'anonym-user' message_text_elements = message_element .xpath(".//div[@class = 'message-text']") if len(message_text_elements) == 1: message_text_element = message_text_elements[0] message_text = message_text_element.xpath("table/tbody/tr/td/text()") + message_text_element.xpath("text()") message['message_text'] = ''.join(message_text).replace('\t',' ') .replace('\n',' ').replace('( )','') .replace('()','').strip() #answer_link_elements = message_text_element .xpath(".//a[@class='answer-link interlink']") inner_link_elements = message_text_element .xpath(".//a[@class='interlink']") inner_link_list = list() for inner_link_element in inner_link_elements: inner_link_list.append(inner_link_element.attrib['href'] .replace('#','')) other_link_elements = message_text_element .xpath(".//a[not(@class='interlink') and not(@class='answer-link interlink')]") other_link_list = list() for other_link_element in other_link_elements: other_link_list.append(other_link_element.attrib['href']) message['message_reply_to'] = ' '.join(inner_link_list) message['message_external_links'] = ' '.join(other_link_list) else: message['message_text'] = '' message['message_user_name'] = 'HIDDEN MESSAGE' message['message_reply_to'] = '' message['message_external_links'] = '' message_list.append(message) return message_list if __name__ == "__main__": for line in sys.stdin: try: topic_id, page_number, link, source = line.strip().split('\t') except Exception as e: continue if source == '&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;  .&lt;/body&gt;&lt;/html&gt;': message_list = list() message = get_empty_message() message_list.append(message) else: try: message_list = get_list_of_messages_on_page(source) except Exception as e: message_list = list() message = get_empty_message() message['message_user_name'] = 'ERRORERRORERROR' message['message_text'] = str(e) message_list.append(message) for message in message_list: # 12 columns print ('%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s' % ( topic_id , page_number , link , message['message_id'] , message['message_date_time'] , message['message_user_name'] , message['message_user_id'] , message['message_user_class'] , message['message_text'] , message['message_reply_to']</span></span></code> </pre> <br><p>      Hadoop Streaming job   .    12 : </p><br><pre> <code class="hljs vhdl">gomista@cluster-west-m:~/mista/mapreduce$ ./parser_pages_lxml_run.sh Removing gs://mistabucket-west/output_mid/#<span class="hljs-number"><span class="hljs-number">1516326888923617</span></span>... Removing gs://mistabucket-west/output_mid/_temporary/#<span class="hljs-number"><span class="hljs-number">1516326889037377</span></span>... Removing gs://mistabucket-west/output_mid/_temporary/<span class="hljs-number"><span class="hljs-number">1</span></span>/#<span class="hljs-number"><span class="hljs-number">1516326889036731</span></span>... / [<span class="hljs-number"><span class="hljs-number">3</span></span> objects] Operation completed over <span class="hljs-number"><span class="hljs-number">3</span></span> objects. <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span> INFO gcs.GoogleHadoopFileSystemBase: GHFS version: <span class="hljs-number"><span class="hljs-number">1.6</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>-ha... packageJobJar: [] [/usr/lib/hadoop-mapreduce/hadoop-streaming-<span class="hljs-number"><span class="hljs-number">2.8</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>.jar] /tmp... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span> INFO client.RMProxy: Connecting <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ResourceManager at clust... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span> INFO client.RMProxy: Connecting <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ResourceManager at clust... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">46</span></span> INFO mapred.FileInputFormat: Total input files <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">process</span></span> :... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span> INFO mapreduce.JobSubmitter: number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> splits:<span class="hljs-number"><span class="hljs-number">238</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span> INFO mapreduce.JobSubmitter: Submitting tokens <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> job: job... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span> INFO impl.YarnClientImpl: Submitted application application... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span> INFO mapreduce.Job: The url <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> track the job: http://cluste... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span> INFO mapreduce.Job: Running job: job_1516327218763_0001 <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span> INFO mapreduce.Job: Job job_1516327218763_0001 running <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> u... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% ... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% ... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% ... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">12</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">99</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>% reduce <span class="hljs-number"><span class="hljs-number">2</span></span>% ... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>% reduce <span class="hljs-number"><span class="hljs-number">99</span></span>% <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>% reduce <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> INFO mapreduce.Job: Job job_1516327218763_0001 completed su... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> INFO mapreduce.Job: Counters: <span class="hljs-number"><span class="hljs-number">56</span></span> <span class="hljs-keyword"><span class="hljs-keyword">File</span></span> System Counters <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes read=<span class="hljs-number"><span class="hljs-number">6193967355</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes written=<span class="hljs-number"><span class="hljs-number">12426341774</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> large read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> write operations=<span class="hljs-number"><span class="hljs-number">0</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes read=<span class="hljs-number"><span class="hljs-number">31919556146</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes written=<span class="hljs-number"><span class="hljs-number">6110532053</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> large read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> write operations=<span class="hljs-number"><span class="hljs-number">0</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes read=<span class="hljs-number"><span class="hljs-number">28798</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes written=<span class="hljs-number"><span class="hljs-number">0</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> read operations=<span class="hljs-number"><span class="hljs-number">238</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> large read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> write operations=<span class="hljs-number"><span class="hljs-number">0</span></span> Job Counters Killed <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">8</span></span> Killed reduce tasks=<span class="hljs-number"><span class="hljs-number">1</span></span> Launched <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">246</span></span> Launched reduce tasks=<span class="hljs-number"><span class="hljs-number">23</span></span> Rack-local <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">246</span></span> Total <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> maps <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> occupied slots (ms)=<span class="hljs-number"><span class="hljs-number">143665988</span></span> Total <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reduces <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> occupied slots (ms)=<span class="hljs-number"><span class="hljs-number">5776576</span></span> Total <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks (ms)=<span class="hljs-number"><span class="hljs-number">35916497</span></span> Total <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reduce tasks (ms)=<span class="hljs-number"><span class="hljs-number">722072</span></span> Total vcore-milliseconds taken by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">35916497</span></span> Total vcore-milliseconds taken by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reduce tasks=<span class="hljs-number"><span class="hljs-number">722072</span></span> Total megabyte-milliseconds taken by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">36778492928</span></span> Total megabyte-milliseconds taken by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reduce tasks=<span class="hljs-number"><span class="hljs-number">1478803456</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span>-Reduce Framework <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> input records=<span class="hljs-number"><span class="hljs-number">1062462</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> output records=<span class="hljs-number"><span class="hljs-number">16828105</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> output bytes=<span class="hljs-number"><span class="hljs-number">6135355287</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> output materialized bytes=<span class="hljs-number"><span class="hljs-number">6193998639</span></span> Input split bytes=<span class="hljs-number"><span class="hljs-number">28798</span></span> Combine input records=<span class="hljs-number"><span class="hljs-number">0</span></span> Combine output records=<span class="hljs-number"><span class="hljs-number">0</span></span> Reduce input groups=<span class="hljs-number"><span class="hljs-number">957787</span></span> Reduce shuffle bytes=<span class="hljs-number"><span class="hljs-number">6193998639</span></span> Reduce input records=<span class="hljs-number"><span class="hljs-number">16828105</span></span> Reduce output records=<span class="hljs-number"><span class="hljs-number">16828105</span></span> Spilled Records=<span class="hljs-number"><span class="hljs-number">33656210</span></span> Shuffled Maps =<span class="hljs-number"><span class="hljs-number">5236</span></span> Failed Shuffles=<span class="hljs-number"><span class="hljs-number">0</span></span> Merged <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> outputs=<span class="hljs-number"><span class="hljs-number">5236</span></span> GC <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> elapsed (ms)=<span class="hljs-number"><span class="hljs-number">120521</span></span> CPU <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent (ms)=<span class="hljs-number"><span class="hljs-number">10644810</span></span> Physical memory (bytes) snapshot=<span class="hljs-number"><span class="hljs-number">111635165184</span></span> Virtual memory (bytes) snapshot=<span class="hljs-number"><span class="hljs-number">682604023808</span></span> Total committed heap usage (bytes)=<span class="hljs-number"><span class="hljs-number">89146138624</span></span> Shuffle Errors BAD_ID=<span class="hljs-number"><span class="hljs-number">0</span></span> CONNECTION=<span class="hljs-number"><span class="hljs-number">0</span></span> IO_ERROR=<span class="hljs-number"><span class="hljs-number">0</span></span> WRONG_LENGTH=<span class="hljs-number"><span class="hljs-number">0</span></span> WRONG_MAP=<span class="hljs-number"><span class="hljs-number">0</span></span> WRONG_REDUCE=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">File</span></span> Input Format Counters Bytes Read=<span class="hljs-number"><span class="hljs-number">31919556146</span></span> <span class="hljs-keyword"><span class="hljs-keyword">File</span></span> Output Format Counters Bytes Written=<span class="hljs-number"><span class="hljs-number">6110532053</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span> INFO streaming.StreamJob: Output directory: gs://mistabucke... packageJobJar: [] [/usr/lib/hadoop-mapreduce/hadoop-streaming-<span class="hljs-number"><span class="hljs-number">2.8</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>.jar] /tmp... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span> INFO client.RMProxy: Connecting <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ResourceManager at clust... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span> INFO client.RMProxy: Connecting <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ResourceManager at clust... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span> INFO gcs.GoogleHadoopFileSystemBase: GHFS version: <span class="hljs-number"><span class="hljs-number">1.6</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>-ha... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span> INFO mapred.FileInputFormat: Total input files <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">process</span></span> :... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span> INFO mapreduce.JobSubmitter: number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> splits:<span class="hljs-number"><span class="hljs-number">199</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span> INFO mapreduce.JobSubmitter: Submitting tokens <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> job: job... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span> INFO impl.YarnClientImpl: Submitted application application... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span> INFO mapreduce.Job: The url <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> track the job: http://cluste... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span> INFO mapreduce.Job: Running job: job_1516327218763_0002 <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span> INFO mapreduce.Job: Job job_1516327218763_0002 running <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> u... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% ... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% ... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">91</span></span>% reduce <span class="hljs-number"><span class="hljs-number">0</span></span>% ... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span> INFO mapreduce.Job: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>% reduce <span class="hljs-number"><span class="hljs-number">100</span></span>% <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">28</span></span> INFO mapreduce.Job: Job job_1516327218763_0002 completed su... <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span> INFO mapreduce.Job: Counters: <span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-keyword"><span class="hljs-keyword">File</span></span> System Counters <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes read=<span class="hljs-number"><span class="hljs-number">6193967355</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes written=<span class="hljs-number"><span class="hljs-number">12420328221</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> large read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FILE</span></span>: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> write operations=<span class="hljs-number"><span class="hljs-number">0</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes read=<span class="hljs-number"><span class="hljs-number">6111257045</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes written=<span class="hljs-number"><span class="hljs-number">6110532053</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> large read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> GS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> write operations=<span class="hljs-number"><span class="hljs-number">0</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes read=<span class="hljs-number"><span class="hljs-number">18905</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bytes written=<span class="hljs-number"><span class="hljs-number">0</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> read operations=<span class="hljs-number"><span class="hljs-number">199</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> large read operations=<span class="hljs-number"><span class="hljs-number">0</span></span> HDFS: Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> write operations=<span class="hljs-number"><span class="hljs-number">0</span></span> Job Counters Killed <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">2</span></span> Launched <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">200</span></span> Launched reduce tasks=<span class="hljs-number"><span class="hljs-number">22</span></span> Rack-local <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">200</span></span> Total <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> maps <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> occupied slots (ms)=<span class="hljs-number"><span class="hljs-number">18822720</span></span> Total <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reduces <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> occupied slots (ms)=<span class="hljs-number"><span class="hljs-number">5538912</span></span> Total <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks (ms)=<span class="hljs-number"><span class="hljs-number">4705680</span></span> Total <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reduce tasks (ms)=<span class="hljs-number"><span class="hljs-number">692364</span></span> Total vcore-milliseconds taken by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">4705680</span></span> Total vcore-milliseconds taken by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reduce tasks=<span class="hljs-number"><span class="hljs-number">692364</span></span> Total megabyte-milliseconds taken by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> tasks=<span class="hljs-number"><span class="hljs-number">4818616320</span></span> Total megabyte-milliseconds taken by <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> reduce tasks=<span class="hljs-number"><span class="hljs-number">1417961472</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span>-Reduce Framework <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> input records=<span class="hljs-number"><span class="hljs-number">16828105</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> output records=<span class="hljs-number"><span class="hljs-number">16828105</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> output bytes=<span class="hljs-number"><span class="hljs-number">6135355287</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> output materialized bytes=<span class="hljs-number"><span class="hljs-number">6193993491</span></span> Input split bytes=<span class="hljs-number"><span class="hljs-number">18905</span></span> Combine input records=<span class="hljs-number"><span class="hljs-number">0</span></span> Combine output records=<span class="hljs-number"><span class="hljs-number">0</span></span> Reduce input groups=<span class="hljs-number"><span class="hljs-number">957787</span></span> Reduce shuffle bytes=<span class="hljs-number"><span class="hljs-number">6193993491</span></span> Reduce input records=<span class="hljs-number"><span class="hljs-number">16828105</span></span> Reduce output records=<span class="hljs-number"><span class="hljs-number">16828105</span></span> Spilled Records=<span class="hljs-number"><span class="hljs-number">33656210</span></span> Shuffled Maps =<span class="hljs-number"><span class="hljs-number">4378</span></span> Failed Shuffles=<span class="hljs-number"><span class="hljs-number">0</span></span> Merged <span class="hljs-keyword"><span class="hljs-keyword">Map</span></span> outputs=<span class="hljs-number"><span class="hljs-number">4378</span></span> GC <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> elapsed (ms)=<span class="hljs-number"><span class="hljs-number">116848</span></span> CPU <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> spent (ms)=<span class="hljs-number"><span class="hljs-number">914030</span></span> Physical memory (bytes) snapshot=<span class="hljs-number"><span class="hljs-number">98494140416</span></span> Virtual memory (bytes) snapshot=<span class="hljs-number"><span class="hljs-number">583041585152</span></span> Total committed heap usage (bytes)=<span class="hljs-number"><span class="hljs-number">78180368384</span></span> Shuffle Errors BAD_ID=<span class="hljs-number"><span class="hljs-number">0</span></span> CONNECTION=<span class="hljs-number"><span class="hljs-number">0</span></span> IO_ERROR=<span class="hljs-number"><span class="hljs-number">0</span></span> WRONG_LENGTH=<span class="hljs-number"><span class="hljs-number">0</span></span> WRONG_MAP=<span class="hljs-number"><span class="hljs-number">0</span></span> WRONG_REDUCE=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">File</span></span> Input Format Counters Bytes Read=<span class="hljs-number"><span class="hljs-number">6111257045</span></span> <span class="hljs-keyword"><span class="hljs-keyword">File</span></span> Output Format Counters Bytes Written=<span class="hljs-number"><span class="hljs-number">6110532053</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">01</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span> INFO streaming.StreamJob: Output directory: gs://mistabucke...</code> </pre> <br><p>  ,    20 ... </p><br><p>  ,    Spark job.      ( )      ,    : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyspark <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> SparkContext, SparkConf sc =SparkContext() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clear_user_id</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(line)</span></span></span><span class="hljs-function">:</span></span> line[<span class="hljs-number"><span class="hljs-number">6</span></span>]=line[<span class="hljs-number"><span class="hljs-number">6</span></span>].replace(<span class="hljs-string"><span class="hljs-string">'users.php?id='</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> line rdd = sc.textFile(<span class="hljs-string"><span class="hljs-string">"gs://mistabucket-west/grabbing_results_tsv/messages_dirty/*"</span></span>) \ .map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> line: str(line.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>)).split(<span class="hljs-string"><span class="hljs-string">"\t"</span></span>)) \ .filter(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> line: line[<span class="hljs-number"><span class="hljs-number">3</span></span>]&lt;&gt;<span class="hljs-string"><span class="hljs-string">''</span></span>) \ .map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> line: clear_user_id(line)) \ .sortBy(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> line: (int(line[<span class="hljs-number"><span class="hljs-number">0</span></span>]), int(line[<span class="hljs-number"><span class="hljs-number">1</span></span>]), int(line[<span class="hljs-number"><span class="hljs-number">3</span></span>]))) \ .repartition(<span class="hljs-number"><span class="hljs-number">100</span></span>) \ .map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> line: <span class="hljs-string"><span class="hljs-string">'\t'</span></span>.join(line)) \ .saveAsTextFile(<span class="hljs-string"><span class="hljs-string">"gs://mistabucket-west/grabbing_results_tsv/messages"</span></span>)</code> </pre> <br><p> Shell     : </p><br><pre> <code class="hljs mel">#!/bin/bash OUT_DIR=<span class="hljs-string"><span class="hljs-string">"gs://mistabucket-west/grabbing_results_tsv/messages"</span></span> gsutil -m rm -r ${OUT_DIR} &gt; /dev/null gcloud dataproc jobs submit pyspark \ <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>:<span class="hljs-comment"><span class="hljs-comment">///home/gomista/mista/pyspark/clear_messages.py \ --cluster cluster-west \ --region europe-west1</span></span></code> </pre> <br><p>    20     2 . </p><br><h3 id="making-a-sense"> Making a sense </h3><br><p>     (  -)       Hive. </p><br><p>          : </p><br><pre> <code class="hljs mel">#!/bin/bash gcloud dataproc jobs submit hive \ --<span class="hljs-keyword"><span class="hljs-keyword">cluster</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cluster</span></span>-west \ --region europe-west1 \ --<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> $1</code> </pre> <br><p>    : </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXTERNAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> messages (topic_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, page_number <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">link</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STRING</span></span>, message_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, message_date_time <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>, message_user_name <span class="hljs-keyword"><span class="hljs-keyword">STRING</span></span>, message_user_id <span class="hljs-keyword"><span class="hljs-keyword">STRING</span></span>, message_user_class <span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">STRING</span></span>&gt;, message_text <span class="hljs-keyword"><span class="hljs-keyword">STRING</span></span>, message_reply_to <span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">STRING</span></span>&gt;, message_external_links <span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">STRING</span></span>&gt;) <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-string"><span class="hljs-string">'Data contains users messages'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FORMAT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELIMITED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FIELDS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TERMINATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">'\t'</span></span> COLLECTION ITEMS <span class="hljs-keyword"><span class="hljs-keyword">TERMINATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STORED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> TEXTFILE LOCATION <span class="hljs-string"><span class="hljs-string">'gs://mistabucket-west/grabbing_results_tsv/messages'</span></span>;</code> </pre> <br><p>     : </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> messages;</code> </pre> <br><p>  Result: </p><br><pre> <code class="hljs ruby">+-----------+--+ <span class="hljs-params"><span class="hljs-params">| c0 |</span></span> +-----------+--+ <span class="hljs-params"><span class="hljs-params">| 16576543 |</span></span> +-----------+--+ <span class="hljs-number"><span class="hljs-number">1</span></span> row selected (<span class="hljs-number"><span class="hljs-number">51.307</span></span> seconds)</code> </pre> <br><p>       "   "      : </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATE_FORMAT</span></span>(message_date_time,<span class="hljs-string"><span class="hljs-string">'yyyy'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">year</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(message_id) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> total_messages <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> messages <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATE_FORMAT</span></span>(message_date_time,<span class="hljs-string"><span class="hljs-string">'yyyy'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">year</span></span>;</code> </pre> <br><p>  Result: </p><br><pre> <code class="hljs ruby">+-------+-----------------+--+ <span class="hljs-params"><span class="hljs-params">| year |</span></span> total_messages <span class="hljs-params"><span class="hljs-params">| +-------+-----------------+--+ |</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span> <span class="hljs-params"><span class="hljs-params">| 3412 |</span></span> <span class="hljs-params"><span class="hljs-params">| 2001 |</span></span> <span class="hljs-number"><span class="hljs-number">4900</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">2003</span></span> <span class="hljs-params"><span class="hljs-params">| 5854 |</span></span> <span class="hljs-params"><span class="hljs-params">| 2004 |</span></span> <span class="hljs-number"><span class="hljs-number">248704</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">2005</span></span> <span class="hljs-params"><span class="hljs-params">| 834114 |</span></span> <span class="hljs-params"><span class="hljs-params">| 2006 |</span></span> <span class="hljs-number"><span class="hljs-number">1319828</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">2007</span></span> <span class="hljs-params"><span class="hljs-params">| 1077894 |</span></span> <span class="hljs-params"><span class="hljs-params">| 2008 |</span></span> <span class="hljs-number"><span class="hljs-number">1071649</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">2009</span></span> <span class="hljs-params"><span class="hljs-params">| 1650880 |</span></span> <span class="hljs-params"><span class="hljs-params">| 2010 |</span></span> <span class="hljs-number"><span class="hljs-number">1704566</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">2011</span></span> <span class="hljs-params"><span class="hljs-params">| 1821790 |</span></span> <span class="hljs-params"><span class="hljs-params">| 2012 |</span></span> <span class="hljs-number"><span class="hljs-number">2041743</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">2013</span></span> <span class="hljs-params"><span class="hljs-params">| 1471078 |</span></span> <span class="hljs-params"><span class="hljs-params">| 2014 |</span></span> <span class="hljs-number"><span class="hljs-number">1218941</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-params"><span class="hljs-params">| 834300 |</span></span> <span class="hljs-params"><span class="hljs-params">| 2016 |</span></span> <span class="hljs-number"><span class="hljs-number">726237</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-params"><span class="hljs-params">| 529598 |</span></span> <span class="hljs-params"><span class="hljs-params">| 2018 |</span></span> <span class="hljs-number"><span class="hljs-number">11055</span></span> <span class="hljs-params"><span class="hljs-params">| +-------+-----------------+--+ 18 rows selected (100.316 seconds)</span></span></code> </pre> <br><p>         .     ,         ,        1 8.0.                   .     2007-2008 .  ,   ,      2009      35 .    " "  ,   "  ,    "   ,    "  "          .   (    )  ,   ,  2012  . </p><br><p>   .     2011     ,      2012,  ,      .      ?  For the same reason. ,   2012     ,     "" .       -  ,            ,   -  "  ",   ""         (     ,        ).  ‚Äî  2013      .            ,       ,  ,     ,  ,           ,        . </p><br><p>    2014 ,       .     ?  Right.   .       1          ,             .    ( 10 )      " ",   ,   -   "  "     "   ",    . </p><br><p>    ‚Äî      : 500    2017  (     10  ).       ,        5%  , ,        ,   ,    .    : </p><br><pre> <code class="hljs pgsql">gomista@<span class="hljs-keyword"><span class="hljs-keyword">cluster</span></span>-west-m:~$ cat data4 | python bar_chart.py -A # <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> ‚àé represents a count <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-number"><span class="hljs-number">665.</span></span> total <span class="hljs-number"><span class="hljs-number">531754</span></span> <span class="hljs-number"><span class="hljs-number">201701</span></span> [ <span class="hljs-number"><span class="hljs-number">48446</span></span>] ‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé <span class="hljs-number"><span class="hljs-number">201702</span></span> [ <span class="hljs-number"><span class="hljs-number">39747</span></span>] ‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé <span class="hljs-number"><span class="hljs-number">201703</span></span> [ <span class="hljs-number"><span class="hljs-number">49150</span></span>] ‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé <span class="hljs-number"><span class="hljs-number">201704</span></span> [ <span class="hljs-number"><span class="hljs-number">42766</span></span>] ‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé <span class="hljs-number"><span class="hljs-number">201705</span></span> [ <span class="hljs-number"><span class="hljs-number">47175</span></span>] ‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé <span class="hljs-number"><span class="hljs-number">201706</span></span> [ <span class="hljs-number"><span class="hljs-number">43566</span></span>] ‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé <span class="hljs-number"><span class="hljs-number">201707</span></span> [ <span class="hljs-number"><span class="hljs-number">45087</span></span>] ‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé <span class="hljs-number"><span class="hljs-number">201708</span></span> [ <span class="hljs-number"><span class="hljs-number">40789</span></span>] ‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé <span class="hljs-number"><span class="hljs-number">201709</span></span> [ <span class="hljs-number"><span class="hljs-number">40850</span></span>] ‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé <span class="hljs-number"><span class="hljs-number">201710</span></span> [ <span class="hljs-number"><span class="hljs-number">45386</span></span>] ‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé <span class="hljs-number"><span class="hljs-number">201711</span></span> [ <span class="hljs-number"><span class="hljs-number">43041</span></span>] ‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé <span class="hljs-number"><span class="hljs-number">201712</span></span> [ <span class="hljs-number"><span class="hljs-number">43595</span></span>] ‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé‚àé <span class="hljs-number"><span class="hljs-number">201801</span></span> [ <span class="hljs-number"><span class="hljs-number">2156</span></span>] ‚àé</code> </pre> <br><p>         ,  ,              50  100  .  ,               ,    ,  20              5. </p><br><p>        ‚Äî SparkSQL.      SparkSQL, ,   Hive     ,           <code>hive</code>  <code>spark-sql</code>   <code>gcloud dataproc jobs submit hive</code> .   ,     : </p><br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">2000</span></span> <span class="hljs-number"><span class="hljs-number">3412</span></span> <span class="hljs-number"><span class="hljs-number">2001</span></span> <span class="hljs-number"><span class="hljs-number">4900</span></span> <span class="hljs-number"><span class="hljs-number">2003</span></span> <span class="hljs-number"><span class="hljs-number">5854</span></span> <span class="hljs-number"><span class="hljs-number">2004</span></span> <span class="hljs-number"><span class="hljs-number">248704</span></span> <span class="hljs-number"><span class="hljs-number">2005</span></span> <span class="hljs-number"><span class="hljs-number">834114</span></span> <span class="hljs-number"><span class="hljs-number">2006</span></span> <span class="hljs-number"><span class="hljs-number">1319828</span></span> <span class="hljs-number"><span class="hljs-number">2007</span></span> <span class="hljs-number"><span class="hljs-number">1077894</span></span> <span class="hljs-number"><span class="hljs-number">2008</span></span> <span class="hljs-number"><span class="hljs-number">1071649</span></span> <span class="hljs-number"><span class="hljs-number">2009</span></span> <span class="hljs-number"><span class="hljs-number">1650880</span></span> <span class="hljs-number"><span class="hljs-number">2010</span></span> <span class="hljs-number"><span class="hljs-number">1704566</span></span> <span class="hljs-number"><span class="hljs-number">2011</span></span> <span class="hljs-number"><span class="hljs-number">1821790</span></span> <span class="hljs-number"><span class="hljs-number">2012</span></span> <span class="hljs-number"><span class="hljs-number">2041743</span></span> <span class="hljs-number"><span class="hljs-number">2013</span></span> <span class="hljs-number"><span class="hljs-number">1471078</span></span> <span class="hljs-number"><span class="hljs-number">2014</span></span> <span class="hljs-number"><span class="hljs-number">1218941</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">834300</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">726237</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">529598</span></span> <span class="hljs-number"><span class="hljs-number">2018</span></span> <span class="hljs-number"><span class="hljs-number">11055</span></span> <span class="hljs-type"><span class="hljs-type">Time</span></span> taken: <span class="hljs-number"><span class="hljs-number">22.113</span></span> seconds, Fetched <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>(s)</code> </pre> <br><p>  ‚Äî 22  SparkSQL  100  Hive.     , in-memory computation   MapReduce. </p><br><p>      ,       ‚Äî BigQuery.        Google Cloud Storage,         Standard SQL .     BigQuery      SQL   .      ‚Äî        (  ,    GCS)        (    ).     1        10    ‚Äî   . </p><br><p>   ,   ,     (  ) ,  <code>BigQuery supports loading and exporting nested and repeated data in the form of JSON and Avro files</code> .  Those.     <code>message_user_class</code> , <code>message_reply_to</code> , <code>message_external_links</code>    ,   ,           .  5        : </p><br><pre> <code class="hljs tex">#!/bin/bash bq load <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--field_delimiter "<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">t</span></span></span></span>" <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--quote '' <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--source_format CSV mistadataset.messages <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>gs://mistabucket-west/grabbing_results_tsv/messages/part-* <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>topic_id:INTEGER,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>page_number:INTEGER,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>link:STRING,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>message_id:INTEGER,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>message_date_time:TIMESTAMP,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>message_user_name:STRING,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>message_user_id:STRING,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>message_user_class:STRING,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>message_text:STRING,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>message_reply_to:STRING,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>message_external_links:STRING</code> </pre> <br><p>     : </p><br><pre> <code class="hljs sql">gomista@cluster-west-m:~$ bq <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> mistadataset.messages <span class="hljs-keyword"><span class="hljs-keyword">Table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-mista-<span class="hljs-keyword"><span class="hljs-keyword">project</span></span>:mistadataset.messages <span class="hljs-keyword"><span class="hljs-keyword">Last</span></span> modified <span class="hljs-keyword"><span class="hljs-keyword">Schema</span></span> Total <span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span> Total <span class="hljs-keyword"><span class="hljs-keyword">Bytes</span></span> <span class="hljs-comment"><span class="hljs-comment">----------------- ----------------------------------- ------------ ------------ 20 Jan 06:31:57 |- topic_id: integer 16576543 6013007928 |- page_number: integer |- link: string |- message_id: integer |- message_date_time: timestamp |- message_user_name: string |- message_user_id: string |- message_user_class: string |- message_text: string |- message_reply_to: string |- message_external_links: string</span></span></code> </pre> <br><p> ,         : </p><br><pre> <code class="hljs ruby">gomista@cluster-west-<span class="hljs-symbol"><span class="hljs-symbol">m:</span></span>~$ bq query <span class="hljs-string"><span class="hljs-string">'SELECT COUNT(*) FROM mistadataset.messages'</span></span> Waiting on bqjob_r3390fd1a48d7adbf_000001611c99d989_1 ... (0s) Current <span class="hljs-symbol"><span class="hljs-symbol">status:</span></span> D +----------+ <span class="hljs-params"><span class="hljs-params">| f0_ |</span></span> +----------+ <span class="hljs-params"><span class="hljs-params">| 16576543 |</span></span> +----------+</code> </pre> <br><p> ,          : </p><br><pre> <code class="hljs 1c">gomista@cluster-west-m:<span class="hljs-symbol"><span class="hljs-symbol">~$ bq query 'SELECT YEAR(message_date_time) AS year, COUNT(message_id) AS total_messages FROM [new-mista-project</span></span>:mistadataset.messages] GROUP BY year ORDER BY year, total_messages' Waiting on bqjob_rbad1e81f2c<span class="hljs-number"><span class="hljs-number">9554</span></span>d_<span class="hljs-number"><span class="hljs-number">00000161</span></span>1c9c09eb_1 ... (0s) Current status: DONE +------+----------------+ | year | total_messages | +------+----------------+ | <span class="hljs-number"><span class="hljs-number">2000</span></span> | <span class="hljs-number"><span class="hljs-number">3412</span></span> | | <span class="hljs-number"><span class="hljs-number">2001</span></span> | <span class="hljs-number"><span class="hljs-number">4900</span></span> | | <span class="hljs-number"><span class="hljs-number">2003</span></span> | <span class="hljs-number"><span class="hljs-number">5854</span></span> | | <span class="hljs-number"><span class="hljs-number">2004</span></span> | <span class="hljs-number"><span class="hljs-number">248704</span></span> | | <span class="hljs-number"><span class="hljs-number">2005</span></span> | <span class="hljs-number"><span class="hljs-number">834114</span></span> | | <span class="hljs-number"><span class="hljs-number">2006</span></span> | <span class="hljs-number"><span class="hljs-number">131982</span></span>8 | | <span class="hljs-number"><span class="hljs-number">2007</span></span> | <span class="hljs-number"><span class="hljs-number">107789</span></span>4 | | <span class="hljs-number"><span class="hljs-number">2008</span></span> | <span class="hljs-number"><span class="hljs-number">107164</span></span>9 | | <span class="hljs-number"><span class="hljs-number">2009</span></span> | <span class="hljs-number"><span class="hljs-number">165088</span></span>0 | | <span class="hljs-number"><span class="hljs-number">2010</span></span> | <span class="hljs-number"><span class="hljs-number">170456</span></span>6 | | <span class="hljs-number"><span class="hljs-number">2011</span></span> | <span class="hljs-number"><span class="hljs-number">182179</span></span>0 | | <span class="hljs-number"><span class="hljs-number">2012</span></span> | <span class="hljs-number"><span class="hljs-number">204174</span></span>3 | | <span class="hljs-number"><span class="hljs-number">2013</span></span> | <span class="hljs-number"><span class="hljs-number">147107</span></span>8 | | <span class="hljs-number"><span class="hljs-number">2014</span></span> | <span class="hljs-number"><span class="hljs-number">121894</span></span>1 | | <span class="hljs-number"><span class="hljs-number">2015</span></span> | <span class="hljs-number"><span class="hljs-number">834300</span></span> | | <span class="hljs-number"><span class="hljs-number">2016</span></span> | <span class="hljs-number"><span class="hljs-number">726237</span></span> | | <span class="hljs-number"><span class="hljs-number">2017</span></span> | <span class="hljs-number"><span class="hljs-number">529598</span></span> | | <span class="hljs-number"><span class="hljs-number">2018</span></span> | <span class="hljs-number"><span class="hljs-number">1105</span></span>5 | +------+----------------+</code> </pre> <br><p>  Quickly.      Hive  MapReduce  20   .   ,     (  ,   )  . </p><br><p>  20 ?  : </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> top_flooders <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> message_user_id, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mistadataset.messages <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> message_user_id &lt;&gt; <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> message_user_id <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> users.user_name, top.num <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> top_flooders <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> top <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> mistadataset.users <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(top.message_user_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> INT64) = users.user_id <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre> <br><p>     170       (     )  . </p><br><pre> <code class="hljs ruby">Waiting on bqjob_r37d1101a64142e8e_000001612d891e10_1 ... (<span class="hljs-number"><span class="hljs-number">2</span></span>s) Current <span class="hljs-symbol"><span class="hljs-symbol">status:</span></span> DONE +-------------------+--------+ <span class="hljs-params"><span class="hljs-params">| user_name |</span></span> num <span class="hljs-params"><span class="hljs-params">| +-------------------+--------+ |</span></span>  <span class="hljs-params"><span class="hljs-params">| 170049 |</span></span> <span class="hljs-params"><span class="hljs-params">|  |</span></span> <span class="hljs-number"><span class="hljs-number">116586</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> zak555 <span class="hljs-params"><span class="hljs-params">| 115577 |</span></span> <span class="hljs-params"><span class="hljs-params">| Guk |</span></span> <span class="hljs-number"><span class="hljs-number">101166</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> IamAlexy <span class="hljs-params"><span class="hljs-params">| 99148 |</span></span> <span class="hljs-params"><span class="hljs-params">| mishaPH |</span></span> <span class="hljs-number"><span class="hljs-number">94991</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> Mikeware <span class="hljs-params"><span class="hljs-params">| 89538 |</span></span> <span class="hljs-params"><span class="hljs-params">|   |</span></span> <span class="hljs-number"><span class="hljs-number">84311</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> skunk <span class="hljs-params"><span class="hljs-params">| 82373 |</span></span> <span class="hljs-params"><span class="hljs-params">|  |</span></span> <span class="hljs-number"><span class="hljs-number">80978</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> Aleksey <span class="hljs-params"><span class="hljs-params">| 71176 |</span></span> <span class="hljs-params"><span class="hljs-params">|  1 |</span></span> <span class="hljs-number"><span class="hljs-number">71161</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> mikecool <span class="hljs-params"><span class="hljs-params">| 70260 |</span></span> <span class="hljs-params"><span class="hljs-params">|  |</span></span> <span class="hljs-number"><span class="hljs-number">69461</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> NS <span class="hljs-params"><span class="hljs-params">| 69360 |</span></span> <span class="hljs-params"><span class="hljs-params">|  |</span></span> <span class="hljs-number"><span class="hljs-number">69062</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>   <span class="hljs-params"><span class="hljs-params">| 64987 |</span></span> <span class="hljs-params"><span class="hljs-params">| Fragster |</span></span> <span class="hljs-number"><span class="hljs-number">64890</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>  <span class="hljs-params"><span class="hljs-params">| 63229 |</span></span> <span class="hljs-params"><span class="hljs-params">| HADGEHOG s |</span></span> <span class="hljs-number"><span class="hljs-number">60784</span></span> <span class="hljs-params"><span class="hljs-params">| +-------------------+--------+</span></span></code> </pre> <br><p>    -   ‚Äî     ,   ,    . </p><br><blockquote>           ()     .   -   ‚Äî      ,   .         . </blockquote><p>        : </p><br><pre> <code class="hljs ruby">gomista@cluster-west-<span class="hljs-symbol"><span class="hljs-symbol">m:</span></span>~$ bq query <span class="hljs-string"><span class="hljs-string">'SELECT topic_id, message_id, message_user_id, message_reply_to FROM [new-mista-project:mistadataset.messages] WHERE message_user_id &lt;&gt; "" LIMIT 10'</span></span> Waiting on bqjob_r58c79111c4f526bd_000001612d23cda6_1 ... (0s) Current <span class="hljs-symbol"><span class="hljs-symbol">status:</span></span> DONE +----------+------------+-----------------+------------------+ <span class="hljs-params"><span class="hljs-params">| topic_id |</span></span> message_id <span class="hljs-params"><span class="hljs-params">| message_user_id |</span></span> message_reply_to <span class="hljs-params"><span class="hljs-params">| +----------+------------+-----------------+------------------+ |</span></span> <span class="hljs-number"><span class="hljs-number">415686</span></span> <span class="hljs-params"><span class="hljs-params">| 154 |</span></span> <span class="hljs-number"><span class="hljs-number">4810</span></span> <span class="hljs-params"><span class="hljs-params">| 151 |</span></span> <span class="hljs-params"><span class="hljs-params">| 420305 |</span></span> <span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-params"><span class="hljs-params">| 16570 |</span></span> <span class="hljs-number"><span class="hljs-number">51</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">422260</span></span> <span class="hljs-params"><span class="hljs-params">| 164 |</span></span> <span class="hljs-number"><span class="hljs-number">22278</span></span> <span class="hljs-params"><span class="hljs-params">| 160 159 161 163 |</span></span> <span class="hljs-params"><span class="hljs-params">| 424934 |</span></span> <span class="hljs-number"><span class="hljs-number">106</span></span> <span class="hljs-params"><span class="hljs-params">| 1906 |</span></span> <span class="hljs-number"><span class="hljs-number">103</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">628534</span></span> <span class="hljs-params"><span class="hljs-params">| 61 |</span></span> <span class="hljs-number"><span class="hljs-number">66521</span></span> <span class="hljs-params"><span class="hljs-params">| 56 |</span></span> <span class="hljs-params"><span class="hljs-params">| 628735 |</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-params"><span class="hljs-params">| 85082 |</span></span> NULL <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">629695</span></span> <span class="hljs-params"><span class="hljs-params">| 704 |</span></span> <span class="hljs-number"><span class="hljs-number">39974</span></span> <span class="hljs-params"><span class="hljs-params">| 702 |</span></span> <span class="hljs-params"><span class="hljs-params">| 415376 |</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span> <span class="hljs-params"><span class="hljs-params">| 3467 |</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">385506</span></span> <span class="hljs-params"><span class="hljs-params">| 95 |</span></span> <span class="hljs-number"><span class="hljs-number">12832</span></span> <span class="hljs-params"><span class="hljs-params">| NULL |</span></span> <span class="hljs-params"><span class="hljs-params">| 392876 |</span></span> <span class="hljs-number"><span class="hljs-number">95</span></span> <span class="hljs-params"><span class="hljs-params">| 12204 |</span></span> <span class="hljs-number"><span class="hljs-number">94</span></span> <span class="hljs-params"><span class="hljs-params">| +----------+------------+-----------------+------------------+</span></span></code> </pre> <br><p>    <code>message_id</code>   , <code>message_user_id</code>  ID ,  , <code>message_reply_to</code>  ,    .       <code>message_reply_to</code>     .        SQL ,       Hadoop Streaming (    BigQuery     ,     MapReduce   ). </p><br><p> ,   ,        : </p><br><pre> <code class="hljs smalltalk">#!/bin/bash # <span class="hljs-type"><span class="hljs-type">CREATE</span></span> <span class="hljs-type"><span class="hljs-type">CLUSTER</span></span> bash ../dataproc/create_cluster.sh # <span class="hljs-type"><span class="hljs-type">SUBMIT</span></span> <span class="hljs-type"><span class="hljs-type">JOB</span></span> <span class="hljs-type"><span class="hljs-type">BUCKET</span></span>=<span class="hljs-comment"><span class="hljs-comment">"gs://mistabucket-west/"</span></span> <span class="hljs-type"><span class="hljs-type">MAPPER_FILE</span></span>=<span class="hljs-comment"><span class="hljs-comment">"mapper.py"</span></span> <span class="hljs-type"><span class="hljs-type">REDUCER_FILE</span></span>=<span class="hljs-comment"><span class="hljs-comment">"reducer.py"</span></span> <span class="hljs-type"><span class="hljs-type">IN_DIR</span></span>=<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-comment"><span class="hljs-comment">"grabbing_results_tsv/messages"</span></span> <span class="hljs-type"><span class="hljs-type">OUT_DIR</span></span>=<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-comment"><span class="hljs-comment">"grabbing_results_tsv/users_to_users"</span></span> <span class="hljs-type"><span class="hljs-type">OUT_LOG</span></span>=out.<span class="hljs-string"><span class="hljs-string">$(</span></span>date +<span class="hljs-comment"><span class="hljs-comment">"%s%6N"</span></span>).log gsutil rm -r <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">OUT_DIR</span></span>} &gt; /dev/null gsutil cp <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">MAPPER_FILE</span></span>} <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">MAPPER_FILE</span></span>} gsutil cp <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">REDUCER_FILE</span></span>} <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">REDUCER_FILE</span></span>} gcloud dataproc jobs submit hadoop \ --cluster cluster-west \ --region europe-west1 \ --jar file:///usr/lib/hadoop-mapreduce/hadoop-streaming.jar \ -- \ -<span class="hljs-type"><span class="hljs-type">D</span></span> mapred.jab.name=<span class="hljs-comment"><span class="hljs-comment">"Users to users job"</span></span> \ -files <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">MAPPER_FILE</span></span>},<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">REDUCER_FILE</span></span>} \ -mapper <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">MAPPER_FILE</span></span>} \ -reducer <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">REDUCER_FILE</span></span>} \ -input <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">IN_DIR</span></span>} \ -output <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">OUT_DIR</span></span>} &gt; /dev/null <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">OUT_LOG</span></span>} gsutil cp <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">OUT_LOG</span></span>} <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-comment"><span class="hljs-comment">"logs/"</span></span><span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">OUT_LOG</span></span>} gsutil rm <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">MAPPER_FILE</span></span>} gsutil rm <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">REDUCER_FILE</span></span>} # <span class="hljs-type"><span class="hljs-type">DELETE</span></span> <span class="hljs-type"><span class="hljs-type">CLUSTER</span></span> bash ../dataproc/delete_cluster.sh</code> </pre> <br><p>            streaming    -     <a href="https://github.com/bbengfort/hadoop-fundamentals/tree/master/streaming">Benjamin Bengfort</a> : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> itertools <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groupby <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> operator <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> itemgetter SEPARATOR = <span class="hljs-string"><span class="hljs-string">"\t"</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Streaming</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> @staticmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_job_conf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name)</span></span></span><span class="hljs-function">:</span></span> name = name.replace(<span class="hljs-string"><span class="hljs-string">"."</span></span>, <span class="hljs-string"><span class="hljs-string">"_"</span></span>).upper() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> os.environ.get(name) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, infile=sys.stdin, separator=SEPARATOR)</span></span></span><span class="hljs-function">:</span></span> self.infile = infile self.sep = separator <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">status</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, message)</span></span></span><span class="hljs-function">:</span></span> sys.stderr.write(<span class="hljs-string"><span class="hljs-string">"reporter:status:{0}\n"</span></span>.format(message)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">counter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, counter, amount=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">, group=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Python Streaming"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> sys.stderr.write(<span class="hljs-string"><span class="hljs-string">"reporter:counter:{0},{1},{2}\n"</span></span>.format(group, counter, amount)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">emit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, key, value)</span></span></span><span class="hljs-function">:</span></span> sys.stdout.write(<span class="hljs-string"><span class="hljs-string">"{0}{1}{2}\n"</span></span>.format(key, self.sep, value)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.infile: <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> line.rstrip(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__iter__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.read(): <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> line <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mapper</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Streaming)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">map</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NotImplementedError(<span class="hljs-string"><span class="hljs-string">"Mappers must implement a map method"</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reducer</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Streaming)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reduce</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> NotImplementedError(<span class="hljs-string"><span class="hljs-string">"Reducers must implement a reduce method"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__iter__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> generator = (line.split(self.sep, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.read()) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> groupby(generator, itemgetter(<span class="hljs-number"><span class="hljs-number">0</span></span>)): <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> item</code> </pre> <br><p>     . Mapper: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python import re import os import sys from itertools import groupby from operator import itemgetter from framework import Streaming class Mapper(Streaming): def map(self): for line in self: line = line.split(self.sep) for reply_to_id in line[9].split(' '): if line[6] &lt;&gt; '': # topic_id, message_id, user_id, reply_to self.emit(line[0], '\t'.join((line[3], line[6], reply_to_id))) if __name__ == '__main__': mapper = Mapper(sys.stdin) mapper.map()</span></span></code> </pre> <br><p> Reducer: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python import re import os import sys from itertools import groupby from operator import itemgetter from framework import Streaming class Reducer(Streaming): def reduce(self): for line in self: try: for key, group in self: message_user = {} for item in group: # extract message_id, user_id, reply_to user_line = item[1].split(self.sep) # put topic_id, user_id, reply_to in dict with message_id message_user[user_line[0]] = (item[0], user_line[1], user_line[2]) iterator = sorted(message_user.iteritems(), key=lambda t: int(t[0])) for message_id, user_line in iterator: # emit topic_id, message_id, user_id, reply_to, user_id_to # (message_id, user_line[1], user_line[2], message_user[user_line[2]]) reply_to = user_line[2] if reply_to &lt;&gt; '' and reply_to in message_user.keys(): user_id = user_line[1] user_id_to = message_user[reply_to][1] if int(user_id) &lt;= int(user_id_to): self.emit(user_line[0], '\t'.join((user_id, user_id_to, message_id, reply_to, '1', '0'))) else: self.emit(user_line[0], '\t'.join((user_id_to, user_id, message_id, reply_to, '0', '1'))) except Exception as e: self.emit("ERROR", str(e)) def __iter__(self): generator = (line.split(self.sep, 1) for line in self.read()) for item in groupby(generator, itemgetter(0)): yield item if __name__ == '__main__': reducer = Reducer(sys.stdin) reducer.reduce()</span></span></code> </pre> <br><p>  quick-review       BigQuery: </p><br><pre> <code class="hljs ruby">gomista@cluster-west-<span class="hljs-symbol"><span class="hljs-symbol">m:</span></span>~$ bq query <span class="hljs-string"><span class="hljs-string">'SELECT topic_id, user1, user2, mes1, mes2, sender1, sender2 FROM [new-mista-project:mistadataset.users_to_users] LIMIT 10'</span></span> Waiting on bqjob_r62adcfd4b0bc4e83_000001612d362bc9_1 ... (0s) Current <span class="hljs-symbol"><span class="hljs-symbol">status:</span></span> DONE +----------+-------+-------+------+------+---------+---------+ <span class="hljs-params"><span class="hljs-params">| topic_id |</span></span> user1 <span class="hljs-params"><span class="hljs-params">| user2 |</span></span> mes1 <span class="hljs-params"><span class="hljs-params">| mes2 |</span></span> sender1 <span class="hljs-params"><span class="hljs-params">| sender2 |</span></span> +----------+-------+-------+------+------+---------+---------+ <span class="hljs-params"><span class="hljs-params">| 102028 |</span></span> <span class="hljs-number"><span class="hljs-number">4810</span></span> <span class="hljs-params"><span class="hljs-params">| 5948 |</span></span> <span class="hljs-number"><span class="hljs-number">110</span></span> <span class="hljs-params"><span class="hljs-params">| 101 |</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-params"><span class="hljs-params">| 0 |</span></span> <span class="hljs-params"><span class="hljs-params">| 119073 |</span></span> <span class="hljs-number"><span class="hljs-number">2811</span></span> <span class="hljs-params"><span class="hljs-params">| 4530 |</span></span> <span class="hljs-number"><span class="hljs-number">81</span></span> <span class="hljs-params"><span class="hljs-params">| 78 |</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-params"><span class="hljs-params">| 0 |</span></span> <span class="hljs-params"><span class="hljs-params">| 128776 |</span></span> <span class="hljs-number"><span class="hljs-number">5561</span></span> <span class="hljs-params"><span class="hljs-params">| 6398 |</span></span> <span class="hljs-number"><span class="hljs-number">58</span></span> <span class="hljs-params"><span class="hljs-params">| 49 |</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-params"><span class="hljs-params">| 0 |</span></span> <span class="hljs-params"><span class="hljs-params">| 131529 |</span></span> <span class="hljs-number"><span class="hljs-number">3566</span></span> <span class="hljs-params"><span class="hljs-params">| 4810 |</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span> <span class="hljs-params"><span class="hljs-params">| 39 |</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-params"><span class="hljs-params">| 0 |</span></span> <span class="hljs-params"><span class="hljs-params">| 133787 |</span></span> <span class="hljs-number"><span class="hljs-number">2126</span></span> <span class="hljs-params"><span class="hljs-params">| 10705 |</span></span> <span class="hljs-number"><span class="hljs-number">46</span></span> <span class="hljs-params"><span class="hljs-params">| 38 |</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-params"><span class="hljs-params">| 0 |</span></span> <span class="hljs-params"><span class="hljs-params">| 103025 |</span></span> <span class="hljs-number"><span class="hljs-number">3312</span></span> <span class="hljs-params"><span class="hljs-params">| 6101 |</span></span> <span class="hljs-number"><span class="hljs-number">92</span></span> <span class="hljs-params"><span class="hljs-params">| 90 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-params"><span class="hljs-params">| 1 |</span></span> <span class="hljs-params"><span class="hljs-params">| 116500 |</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-params"><span class="hljs-params">| 8311 |</span></span> <span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-params"><span class="hljs-params">| 52 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-params"><span class="hljs-params">| 1 |</span></span> <span class="hljs-params"><span class="hljs-params">| 117521 |</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-params"><span class="hljs-params">| 6789 |</span></span> <span class="hljs-number"><span class="hljs-number">52</span></span> <span class="hljs-params"><span class="hljs-params">| 50 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-params"><span class="hljs-params">| 1 |</span></span> <span class="hljs-params"><span class="hljs-params">| 119073 |</span></span> <span class="hljs-number"><span class="hljs-number">4530</span></span> <span class="hljs-params"><span class="hljs-params">| 4810 |</span></span> <span class="hljs-number"><span class="hljs-number">123</span></span> <span class="hljs-params"><span class="hljs-params">| 121 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-params"><span class="hljs-params">| 1 |</span></span> <span class="hljs-params"><span class="hljs-params">| 133787 |</span></span> <span class="hljs-number"><span class="hljs-number">2035</span></span> <span class="hljs-params"><span class="hljs-params">| 5985 |</span></span> <span class="hljs-number"><span class="hljs-number">209</span></span> <span class="hljs-params"><span class="hljs-params">| 208 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-params"><span class="hljs-params">| 1 |</span></span> +----------+-------+-------+------+------+---------+---------+</code> </pre> <br><p>         ,      69  6789   6789  69    ,  <code>69-&gt;6789</code>  <code>6789-&gt;69</code>   <code>69 6789 1 0</code>  <code>69 6789 0 1</code> .    ‚Äî     5948,   6789   69. </p><br><pre> <code class="hljs ruby">+----------+-------+-------+------+------+---------+---------+ <span class="hljs-params"><span class="hljs-params">| topic_id |</span></span> user1 <span class="hljs-params"><span class="hljs-params">| user2 |</span></span> mes1 <span class="hljs-params"><span class="hljs-params">| mes2 |</span></span> sender1 <span class="hljs-params"><span class="hljs-params">| sender2 |</span></span> +----------+-------+-------+------+------+---------+---------+ <span class="hljs-params"><span class="hljs-params">| 102028 |</span></span> <span class="hljs-number"><span class="hljs-number">4810</span></span> <span class="hljs-params"><span class="hljs-params">| 5948 |</span></span> <span class="hljs-number"><span class="hljs-number">110</span></span> <span class="hljs-params"><span class="hljs-params">| 101 |</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-params"><span class="hljs-params">| 0 |</span></span> <span class="hljs-params"><span class="hljs-params">| 117521 |</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-params"><span class="hljs-params">| 6789 |</span></span> <span class="hljs-number"><span class="hljs-number">52</span></span> <span class="hljs-params"><span class="hljs-params">| 50 |</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-params"><span class="hljs-params">| 1 |</span></span> +----------+-------+-------+------+------+---------+---------+</code> </pre> <br><p>   ,     20 ,      .      .            .   ,     <code>(77) ,    (43)</code> : </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> self_messaging <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> topic_id, user1, mes1, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> user1=user2 <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`mistadataset.users_to_users`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> topic_id, user1, mes1 <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> user1=user2 <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>) &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>), top_fools <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> user1, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">num</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> self_messaging <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> user1 <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> users.user_name, top.num <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> top_fools <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> top <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> mistadataset.users <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> top.user1 = users.user_id <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre> <br><p>  Result: </p><br><pre> <code class="hljs ruby">Waiting on bqjob_r22370ed3190e5fd8_000001612d7d126a_1 ... (<span class="hljs-number"><span class="hljs-number">16</span></span>s) Current <span class="hljs-symbol"><span class="hljs-symbol">status:</span></span> DONE +-------------------+------+ <span class="hljs-params"><span class="hljs-params">| user_name |</span></span> num <span class="hljs-params"><span class="hljs-params">| +-------------------+------+ |</span></span> Garykom <span class="hljs-params"><span class="hljs-params">| 6066 |</span></span> <span class="hljs-params"><span class="hljs-params">| bushd |</span></span> <span class="hljs-number"><span class="hljs-number">4080</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> IamAlexy <span class="hljs-params"><span class="hljs-params">| 3883 |</span></span> <span class="hljs-params"><span class="hljs-params">| Fragster |</span></span> <span class="hljs-number"><span class="hljs-number">3565</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> Guk <span class="hljs-params"><span class="hljs-params">| 3237 |</span></span> <span class="hljs-params"><span class="hljs-params">| Rie |</span></span> <span class="hljs-number"><span class="hljs-number">3219</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> wPa <span class="hljs-params"><span class="hljs-params">| 3139 |</span></span> <span class="hljs-params"><span class="hljs-params">|  |</span></span> <span class="hljs-number"><span class="hljs-number">2594</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> smaharbA <span class="hljs-params"><span class="hljs-params">| 2544 |</span></span> <span class="hljs-params"><span class="hljs-params">| trdm |</span></span> <span class="hljs-number"><span class="hljs-number">2321</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> Wobland <span class="hljs-params"><span class="hljs-params">| 2245 |</span></span> <span class="hljs-params"><span class="hljs-params">| opty |</span></span> <span class="hljs-number"><span class="hljs-number">2230</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> Looking <span class="hljs-params"><span class="hljs-params">| 2120 |</span></span> <span class="hljs-params"><span class="hljs-params">|   |</span></span> <span class="hljs-number"><span class="hljs-number">2044</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> zak555 <span class="hljs-params"><span class="hljs-params">| 1955 |</span></span> <span class="hljs-params"><span class="hljs-params">|  |</span></span> <span class="hljs-number"><span class="hljs-number">1936</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> ado <span class="hljs-params"><span class="hljs-params">| 1925 |</span></span> <span class="hljs-params"><span class="hljs-params">|  |</span></span> <span class="hljs-number"><span class="hljs-number">1899</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> Fish <span class="hljs-params"><span class="hljs-params">| 1818 |</span></span> <span class="hljs-params"><span class="hljs-params">| vde69 |</span></span> <span class="hljs-number"><span class="hljs-number">1809</span></span> <span class="hljs-params"><span class="hljs-params">| +-------------------+------+</span></span></code> </pre> <br><p>   20 . ,       .  Request: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> top_opponents <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> user1, user2, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>( sender1) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> sent_by_1, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>( sender2) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> sent_by_2, <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>( sender1) + <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>( sender2) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> sent_total <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`mistadataset.users_to_users`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> user1 &lt;&gt; user2 <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> user1, user2 <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> sent_total <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> users1.user_name <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> user1, users2.user_name <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> user2, top.sent_by_1, top.sent_by_2 <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> top_opponents <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> top <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> mistadataset.users <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> users1 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> top.user1 = users1.user_id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> mistadataset.users <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> users2 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> top.user2 = users2.user_id <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> top.sent_total <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre> <br><p>  Result: </p><br><pre> <code class="hljs ruby">Waiting on bqjob_r6ead7fb755f1ff06_000001612d98c243_1 ... (<span class="hljs-number"><span class="hljs-number">16</span></span>s) Current <span class="hljs-symbol"><span class="hljs-symbol">status:</span></span> DONE +------------------+------------------+-----------+-----------+ <span class="hljs-params"><span class="hljs-params">| user1 |</span></span> user2 <span class="hljs-params"><span class="hljs-params">| sent_by_1 |</span></span> sent_by_2 <span class="hljs-params"><span class="hljs-params">| +------------------+------------------+-----------+-----------+ |</span></span> mikecool <span class="hljs-params"><span class="hljs-params">| Vinianel |</span></span> <span class="hljs-number"><span class="hljs-number">2775</span></span> <span class="hljs-params"><span class="hljs-params">| 2972 |</span></span> <span class="hljs-params"><span class="hljs-params">|   |</span></span>  <span class="hljs-params"><span class="hljs-params">| 2870 |</span></span> <span class="hljs-number"><span class="hljs-number">2366</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>  <span class="hljs-params"><span class="hljs-params">| Vinianel |</span></span> <span class="hljs-number"><span class="hljs-number">1921</span></span> <span class="hljs-params"><span class="hljs-params">| 2787 |</span></span> <span class="hljs-params"><span class="hljs-params">| Mikeware |</span></span>  <span class="hljs-params"><span class="hljs-params">| 2614 |</span></span> <span class="hljs-number"><span class="hljs-number">1561</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>   <span class="hljs-params"><span class="hljs-params">|  |</span></span> <span class="hljs-number"><span class="hljs-number">2272</span></span> <span class="hljs-params"><span class="hljs-params">| 1743 |</span></span> <span class="hljs-params"><span class="hljs-params">| Oftan_Idy |</span></span> opty <span class="hljs-params"><span class="hljs-params">| 2003 |</span></span> <span class="hljs-number"><span class="hljs-number">1841</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> NS <span class="hljs-params"><span class="hljs-params">| opty |</span></span> <span class="hljs-number"><span class="hljs-number">1832</span></span> <span class="hljs-params"><span class="hljs-params">| 1977 |</span></span> <span class="hljs-params"><span class="hljs-params">|   |</span></span> Trigg <span class="hljs-params"><span class="hljs-params">| 1943 |</span></span> <span class="hljs-number"><span class="hljs-number">1791</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> Amra <span class="hljs-params"><span class="hljs-params">| rphosts |</span></span> <span class="hljs-number"><span class="hljs-number">1593</span></span> <span class="hljs-params"><span class="hljs-params">| 1614 |</span></span> <span class="hljs-params"><span class="hljs-params">| Sakura |</span></span> Amra <span class="hljs-params"><span class="hljs-params">| 1487 |</span></span> <span class="hljs-number"><span class="hljs-number">1712</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>  <span class="hljs-params"><span class="hljs-params">| Asmody |</span></span> <span class="hljs-number"><span class="hljs-number">1511</span></span> <span class="hljs-params"><span class="hljs-params">| 1665 |</span></span> <span class="hljs-params"><span class="hljs-params">| Wobland |</span></span>  <span class="hljs-params"><span class="hljs-params">| 1627 |</span></span> <span class="hljs-number"><span class="hljs-number">1500</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> mishaPH <span class="hljs-params"><span class="hljs-params">| zak555 |</span></span> <span class="hljs-number"><span class="hljs-number">1531</span></span> <span class="hljs-params"><span class="hljs-params">| 1516 |</span></span> <span class="hljs-params"><span class="hljs-params">| IamAlexy |</span></span> zak555 <span class="hljs-params"><span class="hljs-params">| 1361 |</span></span> <span class="hljs-number"><span class="hljs-number">1622</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> romix <span class="hljs-params"><span class="hljs-params">| opty |</span></span> <span class="hljs-number"><span class="hljs-number">1381</span></span> <span class="hljs-params"><span class="hljs-params">| 1565 |</span></span> <span class="hljs-params"><span class="hljs-params">|  |</span></span> Mikk <span class="hljs-params"><span class="hljs-params">| 1246 |</span></span> <span class="hljs-number"><span class="hljs-number">1663</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> insider <span class="hljs-params"><span class="hljs-params">|  |</span></span> <span class="hljs-number"><span class="hljs-number">1687</span></span> <span class="hljs-params"><span class="hljs-params">| 1138 |</span></span> <span class="hljs-params"><span class="hljs-params">|  |</span></span> gr13 <span class="hljs-params"><span class="hljs-params">| 1111 |</span></span> <span class="hljs-number"><span class="hljs-number">1697</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>  <span class="hljs-params"><span class="hljs-params">| Mikk |</span></span> <span class="hljs-number"><span class="hljs-number">1448</span></span> <span class="hljs-params"><span class="hljs-params">| 1289 |</span></span> <span class="hljs-params"><span class="hljs-params">| Guk |</span></span>   <span class="hljs-params"><span class="hljs-params">| 1220 |</span></span> <span class="hljs-number"><span class="hljs-number">1509</span></span> <span class="hljs-params"><span class="hljs-params">| +------------------+------------------+-----------+-----------+</span></span></code> </pre> <br><p>      .     ,                 . ,     .  For example: </p><br><pre> <code class="hljs 1c">  , , ,    <span class="hljs-keyword"><span class="hljs-keyword"></span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span>    , , ,    <span class="hljs-keyword"><span class="hljs-keyword"></span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span>       <span class="hljs-keyword"><span class="hljs-keyword"></span></span> <span class="hljs-number"><span class="hljs-number">50</span></span>       <span class="hljs-keyword"><span class="hljs-keyword"></span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> </code> </pre> <br><p>   ,       , , ,      ,      (   ).   ,    (  )       .      ,   ,            .           2011-2012 (   )‚Ä¶     .    . </p><br><p>     .             <a href="https://tech.yandex.ru/mystem/">MyStem</a>     ‚Äî      . - <a href="https://github.com/nlpub/pymystem3">pymystem3</a> ,     ‚Äî    .                   . ,       ,   <code>mystem = Mystem()</code>  ,    Spark  MapReduce.        (   <code>mystem = Mystem()</code>      ,    <code>mystem</code>       ),     <code>mystem</code>      MapReduce.      . </p><br><p> ,     (   ,    ): </p><br><pre> <code class="hljs smalltalk">#!/bin/bash # <span class="hljs-type"><span class="hljs-type">SUBMIT</span></span> <span class="hljs-type"><span class="hljs-type">JOB</span></span> <span class="hljs-type"><span class="hljs-type">BUCKET</span></span>=<span class="hljs-comment"><span class="hljs-comment">"gs://mistabucket-west/"</span></span> <span class="hljs-type"><span class="hljs-type">MAPPER_FILE</span></span>=<span class="hljs-comment"><span class="hljs-comment">"mapper.py"</span></span> <span class="hljs-type"><span class="hljs-type">REDUCER_STEM_FILE</span></span>=<span class="hljs-comment"><span class="hljs-comment">"reducer_stem.py"</span></span> <span class="hljs-type"><span class="hljs-type">IN_DIR</span></span>=<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-comment"><span class="hljs-comment">"grabbing_results_tsv/messages"</span></span> <span class="hljs-type"><span class="hljs-type">OUT_DIR</span></span>=<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-comment"><span class="hljs-comment">"grabbing_results_tsv/messages_stemed_pre"</span></span> gsutil rm -r <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">OUT_DIR</span></span>} &gt; /dev/null gsutil cp <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">MAPPER_FILE</span></span>} <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">MAPPER_FILE</span></span>} gsutil cp <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">REDUCER_STEM_FILE</span></span>} <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">REDUCER_STEM_FILE</span></span>} gcloud dataproc jobs submit hadoop \ --cluster cluster-west \ --region europe-west1 \ --jar file:///usr/lib/hadoop-mapreduce/hadoop-streaming.jar \ -- \ -<span class="hljs-type"><span class="hljs-type">D</span></span> mapred.jab.name=<span class="hljs-comment"><span class="hljs-comment">"Stem job 1"</span></span> \ -files <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">MAPPER_FILE</span></span>},<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">REDUCER_FILE</span></span>} \ -mapper <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">MAPPER_FILE</span></span>} \ -reducer <span class="hljs-string"><span class="hljs-string">'cat'</span></span> \ -input <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">IN_DIR</span></span>} \ -output <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">OUT_DIR</span></span>} gsutil rm <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">MAPPER_FILE</span></span>} <span class="hljs-type"><span class="hljs-type">IN_DIR</span></span>=<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-comment"><span class="hljs-comment">"grabbing_results_tsv/messages_stemed_pre"</span></span> <span class="hljs-type"><span class="hljs-type">OUT_DIR</span></span>=<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-comment"><span class="hljs-comment">"grabbing_results_tsv/messages_stemed"</span></span> gsutil rm -r <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">OUT_DIR</span></span>} &gt; /dev/null gcloud dataproc jobs submit hadoop \ --cluster cluster-west \ --region europe-west1 \ --jar file:///usr/lib/hadoop-mapreduce/hadoop-streaming.jar \ -- \ -<span class="hljs-type"><span class="hljs-type">D</span></span> mapred.jab.name=<span class="hljs-comment"><span class="hljs-comment">"Stem job 2"</span></span> \ -files <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">REDUCER_STEM_FILE</span></span>} \ -mapper <span class="hljs-string"><span class="hljs-string">'/tmp/mystem -lc'</span></span> \ -reducer <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">REDUCER_STEM_FILE</span></span>} \ -input <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">IN_DIR</span></span>} \ -output <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">OUT_DIR</span></span>} gsutil rm -r <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">IN_DIR</span></span>} &gt; /dev/null gsutil rm <span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">BUCKET</span></span>}<span class="hljs-string"><span class="hljs-string">${</span></span><span class="hljs-type"><span class="hljs-type">REDUCER_STEM_FILE</span></span>}</code> </pre> <br><p>  ,     : </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mapper</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Streaming)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">map</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self: line = line.split(self.sep) <span class="hljs-comment"><span class="hljs-comment"># topic_id, message_id, user_id, is link, text self.emit(line[0], '\t'.join((line[3], line[6], str(len(line[10])), line[8]))) if __name__ == '__main__': mapper = Mapper(sys.stdin) mapper.map()</span></span></code> </pre> <br><p>  ,     : </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reducer</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Streaming)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reduce</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> key, group <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> group: message_id, user_id, islink, words = item[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">'\t'</span></span>) words = re.sub(<span class="hljs-string"><span class="hljs-string">"[{}]"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, words) words = re.sub(<span class="hljs-string"><span class="hljs-string">"(\\|[^ ]+)"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, words) words = re.sub(<span class="hljs-string"><span class="hljs-string">"\\?"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, words) words = re.sub(<span class="hljs-string"><span class="hljs-string">"\xc2\xa0+"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>, words) words = words.translate(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, string.punctuation) words = re.sub(<span class="hljs-string"><span class="hljs-string">"\\s+"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>, words) self.emit(item[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-string"><span class="hljs-string">'\t'</span></span>.join((message_id, user_id, islink, words))) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__iter__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> generator = (line.split(self.sep, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.read()) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> groupby(generator, itemgetter(<span class="hljs-number"><span class="hljs-number">0</span></span>)): <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: reducer = Reducer(sys.stdin) reducer.reduce()</code> </pre> <br><p>     10 : </p><br><pre> <code class="hljs ruby">igab@new-mista-<span class="hljs-symbol"><span class="hljs-symbol">project:</span></span>~$ gsutil cat <span class="hljs-symbol"><span class="hljs-symbol">gs:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/mistabucket-west/grabbing</span></span>_results_tsv/messages_stemed/* <span class="hljs-params"><span class="hljs-params">| head -n 10 119048 4 8519 0         ... 119048 5 2358 0    119048 8 8487 18    119048 6 8487 0    119048 7 2358 0       119073 36 482 0       ... 119073 113 0      ... 119073 112 4530 0          ... 119073 111 4810 0  119073 110 4530 0  5  </span></span></code> </pre> <br><p>  wordcount: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> collections <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> namedtuple <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pyspark <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> SparkContext, SparkConf <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> codecs sc =SparkContext() stopwords_list = sc.textFile(<span class="hljs-string"><span class="hljs-string">'gs://mistabucket-west/stopwords-ru.txt'</span></span>) \ .map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> line: line.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>)) \ .collect() stopwords_list = [elem.strip() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> elem <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> stopwords_list] stopwords_list = sc.broadcast(stopwords_list) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">split_messages</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(row)</span></span></span><span class="hljs-function">:</span></span> words = list() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> word <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> row[<span class="hljs-number"><span class="hljs-number">4</span></span>].split(<span class="hljs-string"><span class="hljs-string">' '</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> word <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> stopwords_list.value <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> word.isdigit() <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> word != <span class="hljs-string"><span class="hljs-string">''</span></span>: word_lower = codecs.encode(codecs.decode(word, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>).lower(), <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) words.append((row[<span class="hljs-number"><span class="hljs-number">0</span></span>], row[<span class="hljs-number"><span class="hljs-number">1</span></span>], row[<span class="hljs-number"><span class="hljs-number">2</span></span>], row[<span class="hljs-number"><span class="hljs-number">3</span></span>], word_lower)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> words rdd = sc.textFile(<span class="hljs-string"><span class="hljs-string">"gs://mistabucket-west/grabbing_results_tsv/messages_stemed/part-*"</span></span>) \ .map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> line: str(line.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>)).split(<span class="hljs-string"><span class="hljs-string">"\t"</span></span>)) \ .flatMap(split_messages) \ .map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x:(x[<span class="hljs-number"><span class="hljs-number">4</span></span>],<span class="hljs-number"><span class="hljs-number">1</span></span>)) \ .reduceByKey(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x,y: x+y) \ .map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x: (x[<span class="hljs-number"><span class="hljs-number">1</span></span>], x[<span class="hljs-number"><span class="hljs-number">0</span></span>])) \ .sortByKey(<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) \ .cache() lines = rdd.top(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> lines: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> (<span class="hljs-string"><span class="hljs-string">"{0},{1}"</span></span>.format(i[<span class="hljs-number"><span class="hljs-number">0</span></span>], i[<span class="hljs-number"><span class="hljs-number">1</span></span>]))</code> </pre> <br><p>  20  ( <code></code>  4 ))): </p><br><pre> <code class="hljs 1c"><span class="hljs-number"><span class="hljs-number">731312</span></span>, <span class="hljs-number"><span class="hljs-number">560621</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">486599</span></span>, <span class="hljs-number"><span class="hljs-number">398495</span></span>, <span class="hljs-number"><span class="hljs-number">374898</span></span>, <span class="hljs-number"><span class="hljs-number">372843</span></span>, <span class="hljs-number"><span class="hljs-number">367060</span></span>,<span class="hljs-built_in"><span class="hljs-built_in"></span></span> <span class="hljs-number"><span class="hljs-number">353019</span></span>, <span class="hljs-number"><span class="hljs-number">330404</span></span>, <span class="hljs-number"><span class="hljs-number">325460</span></span>,<span class="hljs-type"><span class="hljs-type"></span></span> <span class="hljs-number"><span class="hljs-number">283849</span></span>,<span class="hljs-built_in"><span class="hljs-built_in"></span></span> <span class="hljs-number"><span class="hljs-number">283676</span></span>, <span class="hljs-number"><span class="hljs-number">277181</span></span>, <span class="hljs-number"><span class="hljs-number">273841</span></span>, <span class="hljs-number"><span class="hljs-number">266892</span></span>, <span class="hljs-number"><span class="hljs-number">265753</span></span>, <span class="hljs-number"><span class="hljs-number">265676</span></span>, <span class="hljs-number"><span class="hljs-number">259497</span></span>, <span class="hljs-number"><span class="hljs-number">257067</span></span>, <span class="hljs-number"><span class="hljs-number">254932</span></span>, <span class="hljs-number"><span class="hljs-number">251058</span></span>,</code> </pre> <br><p>       "" .    ,       .           .  ,  .  ‚Äî    / .             4500 ,     ,          .  ,     : </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> top_fuckers <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> user_id, ARRAY_AGG(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span>(word)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> word, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mistadataset.words <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (word <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> word <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mistadataset.mat)) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> user_id &lt;&gt; <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> user_id <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ROW_NUMBER() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> tt, users.user_name, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> users.user_forum_role = <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUBSTR</span></span>(users.user_forum_role,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">14</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> forum_role, top.num, <span class="hljs-keyword"><span class="hljs-keyword">SUBSTR</span></span>(ARRAY_TO_STRING(top.word, <span class="hljs-string"><span class="hljs-string">" "</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> words <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> top_fuckers <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> top <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> mistadataset.users <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(top.user_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> INT64) = users.user_id <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span></code> </pre> <br><p>     20 (     ): </p><br><pre> <code class="hljs ruby">igab@new-mista-<span class="hljs-symbol"><span class="hljs-symbol">project:</span></span>~<span class="hljs-regexp"><span class="hljs-regexp">/mista/bigquery</span></span>$ cat top_fuckers.q <span class="hljs-params"><span class="hljs-params">| bq query --use_legacy_sql=</span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">false</span></span></span><span class="hljs-params"> Waiting on bqjob_r72bb841a2e6c91dd_000001613ad70b72_1 ... (5s) Current status: DONE +----+-------------------+----------------+------+------------------------------+ |</span></span> tt <span class="hljs-params"><span class="hljs-params">| user_name |</span></span> forum_role <span class="hljs-params"><span class="hljs-params">| num |</span></span> words <span class="hljs-params"><span class="hljs-params">| +----+-------------------+----------------+------+------------------------------+ |</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-params"><span class="hljs-params">| IamAlexy |</span></span> <span class="hljs-params"><span class="hljs-params">| 5218 |</span></span>   ...<span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-params"><span class="hljs-params">|  1 |</span></span> <span class="hljs-params"><span class="hljs-params">| 4305 |</span></span>  <span class="hljs-comment"><span class="hljs-comment">#####  ...| | 3 |  | - | 3969 |  ####### ...| | 4 | Mikeware | | 3931 |   ######### ...| | 5 |  |   | 3785 |    ####...| | 6 | mishaPH | - | 3439 |  #####  ##########...| | 7 | Guk | - | 3333 |    ...| | 8 |   | | 3122 |    ######...| | 9 |  | | 3071 | #####   ...| | 10 |  | - | 2967 |  ########  ...| | 11 | Oftan_Idy | | 2883 |   ###### ...| | 12 |  | | 2724 | #####  ...| | 13 | skunk | | 2124 |     ...| | 14 |  | | 2114 | ########## ######## ######...| | 15 | Maniac | | 2091 |    ...| | 16 |  | | 2057 | #######  ########...| | 17 | - | | 2042 |  ###  ...| | 18 | Fragster | - | 2016 |  #####  ...| | 19 |  | - | 1985 | ########### #####  ...| | 20 | Defender aka LINN | | 1929 | #########  ...| +----+-------------------+----------------+------+------------------------------+</span></span></code> </pre> <br><p>  ,      ‚Äî  (  1  Mikeware      -),       .  Yes.  . </p><br><p>    ,      <code>ismat</code> ,        .  Request: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> words.topic_id, words.message_id, words.user_id, words.word, mat.word <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ismat <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mistadataset.words <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> words <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> mistadataset.mat <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> mat <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> words.word = mat.word</code> </pre> <br><p>    : </p><br><pre> <code class="hljs pgsql">Query Failed Error: Response too <span class="hljs-keyword"><span class="hljs-keyword">large</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>. Consider setting destinationTable <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> legacy <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> queries) setting allowLargeResults <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> your job <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> more details, see https://cloud.google.com/bigquery/troubleshooting-errors</code> </pre> <br><p>      <code>152107955</code>  <code>4766</code>      .  PySpark job  : </p><br><pre> <code class="python hljs">sc =SparkContext() mat_list = sc.textFile(<span class="hljs-string"><span class="hljs-string">'gs://mistabucket-west/mat.txt'</span></span>) \ .map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> line: line.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>)) \ .collect() mat_list = [elem.strip() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> elem <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> mat_list] mat_list = sc.broadcast(mat_list) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_word</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(row)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> row[<span class="hljs-number"><span class="hljs-number">4</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> mat_list.value: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (row[<span class="hljs-number"><span class="hljs-number">0</span></span>], row[<span class="hljs-number"><span class="hljs-number">1</span></span>], row[<span class="hljs-number"><span class="hljs-number">2</span></span>], row[<span class="hljs-number"><span class="hljs-number">3</span></span>], row[<span class="hljs-number"><span class="hljs-number">4</span></span>], <span class="hljs-string"><span class="hljs-string">'1'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (row[<span class="hljs-number"><span class="hljs-number">0</span></span>], row[<span class="hljs-number"><span class="hljs-number">1</span></span>], row[<span class="hljs-number"><span class="hljs-number">2</span></span>], row[<span class="hljs-number"><span class="hljs-number">3</span></span>], row[<span class="hljs-number"><span class="hljs-number">4</span></span>], <span class="hljs-string"><span class="hljs-string">'0'</span></span>) rdd = sc.textFile(<span class="hljs-string"><span class="hljs-string">"gs://mistabucket-west/grabbing_results_tsv/words/part-*"</span></span>) \ .map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> line: str(line.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>)).split(<span class="hljs-string"><span class="hljs-string">"\t"</span></span>)) \ .map(check_word) \ .map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> line: <span class="hljs-string"><span class="hljs-string">'\t'</span></span>.join(line)) \ .saveAsTextFile(<span class="hljs-string"><span class="hljs-string">"gs://mistabucket-west/grabbing_results_tsv/words_with_mats"</span></span>)</code> </pre> <br><p>    : </p><br><pre> <code class="hljs tex">bq load <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--field_delimiter "<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">t</span></span></span></span>" <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--quote '' <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--source_format CSV mistadataset.words_with_mats <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>gs://mistabucket-west/grabbing_results_tsv/words_with_mats/part-* <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>topic_id:INTEGER,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>message_id:STRING,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>user_id:STRING,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>islink:STRING,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>word:STRING,<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>ismat:INTEGER</code> </pre> <br><p>   ,               : </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> mes <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> topic_id, message_id, user_id, ARRAY_AGG(word) words, ARRAY_AGG(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span>(word)) words_distinct <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mistadataset.words_with_mats <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ismat = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> word = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> topic_id, message_id, user_id <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> ARRAY_LENGTH(words_distinct) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> UNNEST(words) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> x = <span class="hljs-string"><span class="hljs-string">''</span></span>)), mats_words <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> mes.topic_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> topic_id, mes.message_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> message_id, mes.user_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> user_id, flattened_words <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> word, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> num <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mes <span class="hljs-keyword"><span class="hljs-keyword">CROSS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> UNNEST(mes.words) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> flattened_words), results <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> mats_words.user_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> user_id, SUM(mats_words.num) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> num, ARRAY_TO_STRING(ARRAY_AGG(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span>(mats_words.word)), " ") <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> words <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mats_words <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> mats_words.word &lt;&gt; <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> user_id <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> num <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ROW_NUMBER() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> num <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> tt, users.user_name, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> users.user_forum_role = <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> SUBSTR(users.user_forum_role,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">14</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> forum_role, top.num, SUBSTR(top.words, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> words <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> results <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> top <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> mistadataset.users <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> users <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> CAST(top.user_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> INT64) = users.user_id <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> num <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span></code> </pre> <br><p>  20 ,          : </p><br><pre> <code class="hljs smalltalk">igab@new-mista-project:~/mista/bigquery<span class="hljs-string"><span class="hljs-string">$ </span></span>cat top_fuckers_putin.q | bq query --use_legacy_sql=<span class="hljs-keyword"><span class="hljs-keyword">false</span></span> <span class="hljs-type"><span class="hljs-type">Waiting</span></span> on bqjob_r45a530f3ec9955b5_000001613b5f9437_1 ... (<span class="hljs-number"><span class="hljs-number">0</span></span>s) <span class="hljs-type"><span class="hljs-type">Current</span></span> status: <span class="hljs-type"><span class="hljs-type">DONE</span></span> +----+------------------+----------------+-----+--------------------------------+ | tt | user_name | forum_role | num | words | +----+------------------+----------------+-----+--------------------------------+ | <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-type"><span class="hljs-type">Mikeware</span></span> | | <span class="hljs-number"><span class="hljs-number">143</span></span> |    #####...| | <span class="hljs-number"><span class="hljs-number">2</span></span> |  | | <span class="hljs-number"><span class="hljs-number">116</span></span> |     ...| | <span class="hljs-number"><span class="hljs-number">3</span></span> |  | - | <span class="hljs-number"><span class="hljs-number">100</span></span> |  ###### ## ### ...| | <span class="hljs-number"><span class="hljs-number">4</span></span> |  | - | <span class="hljs-number"><span class="hljs-number">85</span></span> |     ...| | <span class="hljs-number"><span class="hljs-number">5</span></span> | <span class="hljs-type"><span class="hljs-type">Oftan_Idy</span></span> | | <span class="hljs-number"><span class="hljs-number">71</span></span> |    ######### ...| | <span class="hljs-number"><span class="hljs-number">6</span></span> |  <span class="hljs-number"><span class="hljs-number">1</span></span> | | <span class="hljs-number"><span class="hljs-number">67</span></span> |   ###### #####...| | <span class="hljs-number"><span class="hljs-number">7</span></span> |  | | <span class="hljs-number"><span class="hljs-number">58</span></span> |     ...| | <span class="hljs-number"><span class="hljs-number">8</span></span> | <span class="hljs-type"><span class="hljs-type">Guk</span></span> | - | <span class="hljs-number"><span class="hljs-number">56</span></span> | ###########    ...| | <span class="hljs-number"><span class="hljs-number">9</span></span> |  | | <span class="hljs-number"><span class="hljs-number">49</span></span> |   ###### ...| | <span class="hljs-number"><span class="hljs-number">11</span></span> | bushd | | <span class="hljs-number"><span class="hljs-number">45</span></span> |   #### ...| | <span class="hljs-number"><span class="hljs-number">10</span></span> | <span class="hljs-type"><span class="hljs-type">IamAlexy</span></span> | | <span class="hljs-number"><span class="hljs-number">45</span></span> |     ...| | <span class="hljs-number"><span class="hljs-number">12</span></span> |   | | <span class="hljs-number"><span class="hljs-number">43</span></span> |    ...| | <span class="hljs-number"><span class="hljs-number">14</span></span> | dimoff | | <span class="hljs-number"><span class="hljs-number">28</span></span> |  ########  ...| | <span class="hljs-number"><span class="hljs-number">13</span></span> |  | | <span class="hljs-number"><span class="hljs-number">28</span></span> |   ########## ## ...| | <span class="hljs-number"><span class="hljs-number">15</span></span> | kot_bcc | - | <span class="hljs-number"><span class="hljs-number">27</span></span> |   ####  ...| | <span class="hljs-number"><span class="hljs-number">18</span></span> | <span class="hljs-type"><span class="hljs-type">Trigg</span></span> | | <span class="hljs-number"><span class="hljs-number">26</span></span> |   ## ######## ...| | <span class="hljs-number"><span class="hljs-number">17</span></span> | <span class="hljs-type"><span class="hljs-type">Mikk</span></span> | | <span class="hljs-number"><span class="hljs-number">26</span></span> |    ...| | <span class="hljs-number"><span class="hljs-number">16</span></span> |  | | <span class="hljs-number"><span class="hljs-number">26</span></span> |    ...| | <span class="hljs-number"><span class="hljs-number">19</span></span> |  | | <span class="hljs-number"><span class="hljs-number">25</span></span> |   ...| | <span class="hljs-number"><span class="hljs-number">20</span></span> | trdm | | <span class="hljs-number"><span class="hljs-number">21</span></span> |    ...| +----+------------------+----------------+-----+--------------------------------+</code> </pre> <br><p>    ,      .    ,   ,     .      "",   " <strong><strong>*  ***</strong></strong> <strong>**</strong>  ,   <strong>**</strong>   <strong>**</strong>   etc".             . </p><br><h3 id="share">  Share </h3><br><p> , ,          , ,  -   ,      .     .    ,  .            ,     .  ,          -   . </p><br><p>    : </p><br><p> <a href="https://drive.google.com/open%3Fid%3D1-EcfHKFozEy0tquiaRp672sDd7wQtRFq">messages_html</a> ‚Äî  html    . <br> <a href="https://drive.google.com/open%3Fid%3D1kuLVuHKAIEcKCyIfXLsVsH1wDNIot4uP">messages</a> ‚Äî      (tsv). <br> <a href="https://drive.google.com/open%3Fid%3D1CFyKkoFfbeG1rhg8qvGITiwUENhN-E1b">users_html</a> ‚Äî  html   . <br> <a href="https://drive.google.com/open%3Fid%3D16BnnY59XlCmPCQZqoKbWslzBQWNcdhFZ">users</a> ‚Äî     (tsv). <br> <a href="https://drive.google.com/open%3Fid%3D1cx9l1En1b0btxpK7ygJkAAZpdjdlTWSb">topics</a> ‚Äî   c   (tsv). <br> <a href="https://drive.google.com/open%3Fid%3D16X0xOK1tO3qPu_DWIiGtF8eL_to1dEe-">user_bans</a> ‚Äî   c   (tsv). <br> <a href="https://drive.google.com/open%3Fid%3D1_ltoBvNCCLuI4AgtAb2PTJV3Y5jNBk_5">words</a> ‚Äî        (tsv). <br> <a href="https://drive.google.com/open%3Fid%3D1ruKBRgCAhRhWgxYpl6whs6K1wYaC7fJr">mats</a> ‚Äî    (txt). <br> <a href="https://drive.google.com/open%3Fid%3D1fw1U9VCLXNT4g2eNoYFqc0RcnKRsdpgg">stopwords</a> ‚Äî   -(txt). </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/347096/">https://habr.com/ru/post/347096/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347086/index.html">Calculation snuffled modern rocket engines</a></li>
<li><a href="../347088/index.html">Information security models in the work of Windows VPS</a></li>
<li><a href="../347090/index.html">Scale blockchain while maintaining decentralization with Fairlayer</a></li>
<li><a href="../347092/index.html">Communication between computer and Android device through Processing</a></li>
<li><a href="../347094/index.html">Ship oranges barrels. Golang Releases</a></li>
<li><a href="../347098/index.html">Kubernetes success stories in production. Part 7: BlackRock</a></li>
<li><a href="../347100/index.html">#NotNULL Series - Twig</a></li>
<li><a href="../347104/index.html">Report c St. Petersburg Scala MeetUp 2017.3</a></li>
<li><a href="../347106/index.html">As I wrote a telegram bot and uploaded it to a remote server</a></li>
<li><a href="../347108/index.html">Peter Hinchens: The Psychology of Software Architecture</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>