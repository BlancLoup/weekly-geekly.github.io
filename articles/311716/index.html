<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>RetroBase - an analogue of Retrofit for database queries</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many developers use the Retrofit library in their projects, which allows you to turn the HTTP API into a java interface. This is very convenient, as i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>RetroBase - an analogue of Retrofit for database queries</h1><div class="post__text post__text-html js-mediator-article"> Many developers use the <a href="http://square.github.io/retrofit/">Retrofit</a> library in their projects, which allows you to turn the HTTP API into a java interface.  This is very convenient, as it allows you to get rid of excess code and use it very easily.  You just need to create an interface and hang a few annotations. <br><br>  Recently, I was developing an Android application that needed to make database queries through the JDBC driver.  Then I got the idea to create something like Retrofit just for database queries.  This is how RetroBase appeared, which I will tell you now. <br><a name="habracut"></a><br><br>  <a href="https://medium.com/%40qwert2603/retrobase-like-retrofit-but-for-database-ec32abfd4793">This article in English.</a>  <a href="https://medium.com/%40qwert2603/retrobase-like-retrofit-but-for-database-ec32abfd4793">This article is in English.</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order for the interface and annotations to become working code, Annotation Processing is required, which opens up truly tremendous possibilities for automating the writing of the same type of code.  And in combination with <a href="https://github.com/square/javapoet">JavaPoet, the</a> process of generating java-code becomes convenient and simple. <br><br>  On Habr√©, as well as on the Internet, there are several good <a href="http://blog.stablekernel.com/the-10-step-guide-to-annotation-processing-in-android-studio">articles</a> on this topic, so it‚Äôs easy to deal with Annotation Processing, and the necessary JavaPoet manual fits into its <a href="">README.md</a> . <br><br>  The basis of RetroBase is two annotations <code>DBInterface</code> and <code>DBQuery</code> along with <code>DBAnnotationProcessor</code> , which does all the work.  Using <code>DBInterface</code> , an interface with database <code>DBQuery</code> methods is marked, and <code>DBQuery</code> marks the methods themselves.  Methods can have parameters that will be used in a SQL query.  For example: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@DBInterface</span></span>(url = SpendDB.URL, login = SpendDB.USER_NAME, password = SpendDB.PASSWORD) <span class="hljs-meta"><span class="hljs-meta">@DBInterfaceRx</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SpendDB</span></span></span><span class="hljs-class"> </span></span>{ String USER_NAME = <span class="hljs-string"><span class="hljs-string">"postgres"</span></span>; String PASSWORD = <span class="hljs-string"><span class="hljs-string">"1234"</span></span>; String URL = <span class="hljs-string"><span class="hljs-string">"jdbc:postgresql://192.168.1.26:5432/spend"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@DBMakeRx</span></span>(modelClassName = <span class="hljs-string"><span class="hljs-string">"com.qwert2603.retrobase_example.DataBaseRecord"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@DBQuery</span></span>(<span class="hljs-string"><span class="hljs-string">"SELECT * from spend_test"</span></span>) <span class="hljs-function"><span class="hljs-function">ResultSet </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAllRecords</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@DBMakeRx</span></span> <span class="hljs-meta"><span class="hljs-meta">@DBQuery</span></span>(<span class="hljs-string"><span class="hljs-string">"DELETE FROM spend_test WHERE id = ?"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteRecord</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> SQLException</span></span>; }</code> </pre><br>  The most interesting thing happens in <code>DBAnnotationProcessor</code> , where the generation of the class that implements the interface is carried out, the generated class will have the name <code>*_* + Impl</code> interface_name <code>*_* + Impl</code> : <br><br><pre> <code class="java hljs">TypeSpec.Builder newTypeBuilder = TypeSpec.classBuilder(dbInterfaceClass.getSimpleName() + GENERATED_FILENAME_SUFFIX) .addSuperinterface(TypeName.get(dbInterfaceClass.asType())) .addField(mConnection) .addMethod(waitInit) .addModifiers(Modifier.PUBLIC, Modifier.FINAL);</code> </pre><br>  After that a connection to the database is created: <br><br><pre> <code class="java hljs">FieldSpec mConnection = FieldSpec.builder(Connection.class, <span class="hljs-string"><span class="hljs-string">"mConnection"</span></span>, Modifier.PRIVATE) .initializer(<span class="hljs-string"><span class="hljs-string">"null"</span></span>) .build();</code> </pre><br>  A <code>PreparedStatement</code> is also created for each request: <br><br><pre> <code class="java hljs">FieldSpec fieldSpec = FieldSpec .builder(PreparedStatement.class, executableElement.getSimpleName().toString() + PREPARED_STATEMENT_SUFFIX) .addModifiers(Modifier.PRIVATE) .initializer(<span class="hljs-string"><span class="hljs-string">"null"</span></span>) .build();</code> </pre><br>  ... and the implementation of the method for this query: <br><br><pre> <code class="java hljs">MethodSpec.Builder methodBuilder = MethodSpec.methodBuilder(executableElement.getSimpleName().toString()) .addAnnotation(Override.class) .addModifiers(Modifier.PUBLIC) .returns(returnTypeName);</code> </pre><br>  This takes into account the type of the return value of the method.  It can be either <code>void</code> if the SQL query is an INSERT, DELETE, or UPDATE.  Or <code>ResultSet</code> , if the SQL query is a SELECT. <br><br>  It also checks whether the method can throw a <code>SQLException</code> .  If it can, they will be dropped from the implementation of the method.  And if not - caught and displayed in <code>stderr</code> . <br><br>  All parameters of the annotated method are added to the overriding method, and an expression is generated for each parameter that allows you to transfer the value of the parameter to the <code>PreparedStatement</code> : <br><br><pre> <code class="java hljs">insertRecord_PreparedStatement.setString(<span class="hljs-number"><span class="hljs-number">1</span></span>, kind);</code> </pre><br>  Of course, the number and types of method parameters must match the parameters of the query transmitted using the <code>DBQuery</code> annotation. <br><br>  After the file has been generated, it is recorded using Annotation Processing: <br><br><pre> <code class="java hljs">JavaFileObject sourceFile = processingEnv.getFiler().createSourceFile(filename); Writer writer = sourceFile.openWriter(); writer.write(javaFile.toString());</code> </pre><br><h2>  Rx it! </h2><br>  Of course, it is convenient to get <code>ResultSet</code> , defining only the interface.  And it would be even more convenient to take advantage of the popular <a href="https://github.com/ReactiveX/RxJava">RxJava</a> and get <code>Observable</code> .  In addition, it will make it easy to solve the problem with the execution of queries in another thread. <br><br>  For this, <code>DBMakeRxAnnotationProcessor</code> was created along with <code>DBInterfaceRx</code> and <code>DBMakeRx</code> , which allow you to create a class with wrapper methods.  You could already see the application of these annotations in the example above.  The created class will have the name <code>*_* + Rx</code> interface_name <code>*_* + Rx</code> , and will also have an open constructor that accepts an interface object annotated with <code>DBInterfaceRx</code> , to which it will redirect requests, returning results in a reactive style. <br><br>  All that is needed is to add the <code>DBMakeRx</code> annotation to the method and pass the model class name to it.  The generated wrapper method will return an <code>Observable&lt;* *&gt;</code> .  In this case, the class name of the model can not be defined.  In this case, the generated method will return <code>io.reactivex.Completable</code> , which is convenient for INSERT, DELETE or UPDATE SQL queries that do not require returning a result. <br><br>  For example, for the methods of the <code>ResultSet getAllRecords();</code> interface <code>ResultSet getAllRecords();</code>  and <code>void deleteRecord(int id) throws SQLException;</code>  From the example above, the following wrapper methods will be generated: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> io.reactivex.Observable&lt;com.qwert2603.retrobase_example.DataBaseRecord&gt; getAllRecords() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Observable.generate(() -&gt; mDB.getAllRecords(), (resultSet, objectEmitter) -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (resultSet.next()) { objectEmitter.onNext(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> com.qwert2603.retrobase_example.DataBaseRecord(resultSet)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { objectEmitter.onComplete(); } } , ResultSet::close); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Completable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteRecord</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Completable.fromAction(() -&gt; mDB.deleteRecord(id)); }</code> </pre><br>  Here <code>mDB</code> is an interface object annotated by <code>DBInterfaceRx</code> that was passed to the constructor. <br><br>  As can be seen from the generated method, we will need to create model class objects from the <code>ResultSet</code> , so the model class must have an open constructor that accepts <code>ResultSet</code> . <br><br>  Naturally, the parameters of the generated method will correspond exactly to the parameters of the method that is called: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Completable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insertRecord</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String kind, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value, Date date)</span></span></span><span class="hljs-function"> </span></span>{ ... mDB.insertRecord(kind, value, date); ... }</code> </pre><br>  All exceptions that occur during the execution of a request are passed to Subscriber as it should be in Rx. <br><br>  An example of using all of the above can be as follows: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SpendDB mSpendDB = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpendDBImpl(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SpendDBRx mSpendDBRx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpendDBRx(mSpendDB); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Single&lt;List&lt;DataBaseRecord&gt;&gt; getAllRecords() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mSpendDBRx.getAllRecords() .toList() .compose(applySchedulers()); }</code> </pre><br>  And if you want to replace <code>new SpendDBImpl();</code>  or <code>new SpendDBRx(mSpendDB);</code>  to perform tests, you can use the popular <a href="http://square.github.io/dagger/">Dagger</a> . <br><br>  On github you can find <a href="https://github.com/qwert2603/RetroBase">source codes with comments</a> , as well as a <a href="https://github.com/qwert2603/RetroBaseExample">working example of</a> this small library. <br><br>  The purpose of this article was to show how useful Annotation Processing can be to get rid of writing the same type of code.  And, I hope, you may have new ideas on using this tool in your projects. <br><br>  <b>UPD.</b>  <b>1:</b> Thanks to the comments in the comments, subscriber unsubscribe check was added in RX wrapper methods.  (RetroBase version 1.0.4) <br><br>  <b>UPD.</b>  <b>2:</b> if you need to execute an INSERT query and get the id of the created record, get the number of rows changed as a result of an UPDATE query, or find out the id records that were deleted by the DELETE query, you can add the <code>returning id</code> construct to the end of the SQL query and get the <code>ResultSet</code> with the required id <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@DBMakeRx</span></span>(modelClassName = <span class="hljs-string"><span class="hljs-string">"com.qwert2603.spenddemo.model.Id"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@DBQuery</span></span>(<span class="hljs-string"><span class="hljs-string">"UPDATE spend_test SET kind=?, value=?, date=? WHERE id=? returning id"</span></span>) <span class="hljs-function"><span class="hljs-function">ResultSet </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateRecord</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String kind, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value, Date date, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> SQLException</span></span>;</code> </pre><br>  As you can see from the code, it is also possible to use the <code>DBMakeRx</code> annotation to get <code>Observable&lt;*id*&gt;</code> .  For you need to create a model class that gets the Id from the <code>ResultSet</code> and pass it to the <code>modelClassName</code> parameter of the <code>modelClassName</code> annotation.  The class of the model containing Id may look as follows: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Id</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mId; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Id</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ResultSet resultSet)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> SQLException </span></span>{ mId = resultSet.getInt(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mId; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id)</span></span></span><span class="hljs-function"> </span></span>{ mId = id; } }</code> </pre><br><br>  <b>UPD.</b>  <b>3:</b> in the version of RertoBase 1.1, a check of <code>java.sql.Connection#isValid(0)</code> added to automatically create a new connection to the database in case of an error (for example, the connection is lost). <br><br>  <b>UPD.</b>  <b>4:</b> in version RertoBase 1.2, all Rx code is generated for version RxJava 2.x.  An example of the generated methods you saw above.  Also in this way the problem of backpressure was solved, which was indicated in the comments. </div><p>Source: <a href="https://habr.com/ru/post/311716/">https://habr.com/ru/post/311716/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311702/index.html">Can I go to set up the equipment in Spain?</a></li>
<li><a href="../311704/index.html">How to design a super fast site</a></li>
<li><a href="../311706/index.html">Overview of deep convolutional neural network topologies</a></li>
<li><a href="../311708/index.html">How DLCs can increase the number of players: an example of Street Fighter V</a></li>
<li><a href="../311714/index.html">Installing OTRS 5 on a server with Nginx</a></li>
<li><a href="../311718/index.html">How much does it cost to enter the top cash categories of the app store and is there any point?</a></li>
<li><a href="../311720/index.html">WordCamp Europe in Vienna and the WordPress Development Vector</a></li>
<li><a href="../311722/index.html">All about Cisco FastLocation</a></li>
<li><a href="../311726/index.html">libsodium: Public-key authenticated encryption or how I decrypted the message without the private key</a></li>
<li><a href="../311728/index.html">Proof of Fermat's Big Theorem for a cube, as a key</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>