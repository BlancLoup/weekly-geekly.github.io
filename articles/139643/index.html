<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New aggregation framework in MongoDB 2.1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In release 2.1 , implementation of such functionality as a new data aggregation framework was announced . I would like to tell you about the first imp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>New aggregation framework in MongoDB 2.1</h1><div class="post__text post__text-html js-mediator-article">  In release 2.1 <a href="http://blog.mongodb.org/post/16015854270/operations-in-the-new-aggregation-framework">,</a> implementation of such functionality as a new data aggregation framework <a href="http://blog.mongodb.org/post/16015854270/operations-in-the-new-aggregation-framework">was announced</a> .  I would like to tell you about the first impressions of this very interesting thing.  This functionality should allow in some places to abandon Map / Reduce and writing JavaScript code in favor of fairly simple constructions designed to group the fields almost like in SQL. <br><br><a name="habracut"></a><br><br>  Documentation on innovations is located in the <a href="http://www.mongodb.org/display/DOCS/Aggregation%2BFramework">appropriate section of the</a> official site.  First, let's look at how this works and what MongoDB constructs will help us. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, the main difficulty in fetching data from MongoDB is working with arrays and data contained within some individual elements.  Yes, we can select them as in SQL, but we cannot aggregate by them directly during the selection.  The new framework is a declarative way to work with such data, based on a chain of special operators (there are only 7 of them).  The sample data is transferred from the output of one operator to the input of another, just like in unix.  Partly with the help of new operators you can repeat existing ones.  Let the test collection be a collection for storing data about people.  Standard sample: <br><br><pre><code class="javascript hljs">db.test.find({<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>});</code> </pre> <br>  will be similar <br><br><pre> <code class="javascript hljs">db.test.aggregate({<span class="hljs-attr"><span class="hljs-attr">$match</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>}});</code> </pre> <br>  But everything is a little more interesting, because in the second example we can build a data processing chain, listing the operators separated by commas.  The sorting operator is $ sort, for example: <br><br><pre> <code class="javascript hljs">db.test.aggregate({<span class="hljs-attr"><span class="hljs-attr">$match</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$sort</span></span>: {<span class="hljs-attr"><span class="hljs-attr">age</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}});</code> </pre> <br>  So we all those people with the name ‚ÄúIvan‚Äù and sort the sample by age.  And in order to choose the eldest Ivan, we need to cut the sample with one element: <br><br><pre> <code class="javascript hljs">db.test.aggregate({<span class="hljs-attr"><span class="hljs-attr">$match</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$sort</span></span>: {<span class="hljs-attr"><span class="hljs-attr">age</span></span>: <span class="hljs-number"><span class="hljs-number">-1</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$limit</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>});</code> </pre> <br>  You will say that this is a repetition of the existing functionality.  To some extent, yes, but we have not considered the new operators, allowing more flexibility to work with samples.  Let us examine them in more detail. <br><br><h5>  $ Project operator </h5><br><br>  It is intended for manipulating fields, it can add new ones, delete them and rename them in the documents received by him at the entrance.  The following structure will include in the document flow (filter) only the names and age of users: <br><br><pre> <code class="javascript hljs">{<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">age</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}}</code> </pre> <br>  All documents with only two fields will get to the input of the next operator, there will be no other fields in the stream (with the exception of the _id field, in order to exclude it, you must specifically specify _id: 0).  The number 1 includes, the number 0 excludes the transfer of the field.  In addition, this operator allows you to rename fields, ‚Äúget‚Äù fields from an embedded object of a field, or add new fields based on some <a href="http://www.mongodb.org/display/DOCS/Aggregation%2BFramework%2B-%2BExpression%2BReference">calculations</a> . <br><br><h5>  $ Unwind operator </h5><br><br>  In my opinion this is the most interesting operator.  It allows you to "expand" the nested arrays on each element of the sample documents.  For example, let us have the following base of people: <br><br><pre> <code class="javascript hljs">db.test.insert({<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>, <span class="hljs-attr"><span class="hljs-attr">likes</span></span>: [<span class="hljs-string"><span class="hljs-string">"Maria"</span></span>, <span class="hljs-string"><span class="hljs-string">"Anna"</span></span>]}); db.test.insert({<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Serge"</span></span>, <span class="hljs-attr"><span class="hljs-attr">likes</span></span>: [<span class="hljs-string"><span class="hljs-string">"Anna"</span></span>]});</code> </pre> <br>  Let field likes means which girls like which boy.  Apply the $ unwind operator: <br><br><pre> <code class="javascript hljs">db.test.aggregate({<span class="hljs-attr"><span class="hljs-attr">$unwind</span></span>: <span class="hljs-string"><span class="hljs-string">"$likes"</span></span>});</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"result"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f598de76a8f8bc74573e9fd"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>, <span class="hljs-string"><span class="hljs-string">"likes"</span></span> : <span class="hljs-string"><span class="hljs-string">"Maria"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f598de76a8f8bc74573e9fd"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>, <span class="hljs-string"><span class="hljs-string">"likes"</span></span> : <span class="hljs-string"><span class="hljs-string">"Anna"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f598e086a8f8bc74573e9fe"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Serge"</span></span>, <span class="hljs-string"><span class="hljs-string">"likes"</span></span> : <span class="hljs-string"><span class="hljs-string">"Anna"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br>  We see that the likes array has expanded and every document now has a likes field with every value of the array it had before.  If we want to find the most popular girl, just group the sample by the likes field.  For grouping is the next statement. <br><br><h5>  $ Group operator </h5><br><br>  For convenience, we will supplement the sample with another field filled with the number 1 (it will be easier to summarize this way): <br><br><pre> <code class="javascript hljs">db.test.aggregate({<span class="hljs-attr"><span class="hljs-attr">$unwind</span></span>: <span class="hljs-string"><span class="hljs-string">"$likes"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">likes</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">count</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$add</span></span>: [<span class="hljs-number"><span class="hljs-number">1</span></span>]}}});</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"result"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f598de76a8f8bc74573e9fd"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>, <span class="hljs-string"><span class="hljs-string">"likes"</span></span> : <span class="hljs-string"><span class="hljs-string">"Maria"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f598de76a8f8bc74573e9fd"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Ivan"</span></span>, <span class="hljs-string"><span class="hljs-string">"likes"</span></span> : <span class="hljs-string"><span class="hljs-string">"Anna"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f598e086a8f8bc74573e9fe"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Serge"</span></span>, <span class="hljs-string"><span class="hljs-string">"likes"</span></span> : <span class="hljs-string"><span class="hljs-string">"Anna"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> } ], <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br>  This will allow us to use the aggregation operator $ sum.  That is, now we simply add the value of the count field to the number field each time and group the whole selection by the likes field containing the name of the girl. <br><br><pre> <code class="javascript hljs">db.test.aggregate({<span class="hljs-attr"><span class="hljs-attr">$unwind</span></span>: <span class="hljs-string"><span class="hljs-string">"$likes"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">likes</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">count</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$add</span></span>: [<span class="hljs-number"><span class="hljs-number">1</span></span>]}}}, {<span class="hljs-attr"><span class="hljs-attr">$group</span></span>: {<span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-string"><span class="hljs-string">"$likes"</span></span>, <span class="hljs-attr"><span class="hljs-attr">number</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$sum</span></span>: <span class="hljs-string"><span class="hljs-string">"$count"</span></span>}}});</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"result"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"Anna"</span></span>, <span class="hljs-string"><span class="hljs-string">"number"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"Maria"</span></span>, <span class="hljs-string"><span class="hljs-string">"number"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> } ], <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br>  It remains to sort and limit the output to only one document: <br><br><pre> <code class="javascript hljs">db.test.aggregate({<span class="hljs-attr"><span class="hljs-attr">$unwind</span></span>: <span class="hljs-string"><span class="hljs-string">"$likes"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">likes</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">count</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$add</span></span>: [<span class="hljs-number"><span class="hljs-number">1</span></span>]}}}, {<span class="hljs-attr"><span class="hljs-attr">$group</span></span>: {<span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-string"><span class="hljs-string">"$likes"</span></span>, <span class="hljs-attr"><span class="hljs-attr">number</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$sum</span></span>: <span class="hljs-string"><span class="hljs-string">"$count"</span></span>}}}, {<span class="hljs-attr"><span class="hljs-attr">$sort</span></span>: {<span class="hljs-attr"><span class="hljs-attr">number</span></span>: <span class="hljs-number"><span class="hljs-number">-1</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$limit</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>});</code> </pre> <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"result"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"Anna"</span></span>, <span class="hljs-string"><span class="hljs-string">"number"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span> } ], <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br><br>  Our most popular girl is Anna. <br><br><h4>  And now a concrete example. </h4><br><br>  In order to penetrate <i>purely concretely</i> with new possibilities, suppose that we have a collection that stores data about animals in a zoo and solve several problems of data aggregation.  Here are our paws and tails: <br><br><pre> <code class="javascript hljs">db.zoo.insert({<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Lion"</span></span>, <span class="hljs-attr"><span class="hljs-attr">ration</span></span>: [{<span class="hljs-attr"><span class="hljs-attr">meat</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">fish</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">water</span></span>: <span class="hljs-number"><span class="hljs-number">30</span></span>}], <span class="hljs-attr"><span class="hljs-attr">holidays</span></span>: [<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>], <span class="hljs-attr"><span class="hljs-attr">staff</span></span>: {<span class="hljs-attr"><span class="hljs-attr">like</span></span>: [<span class="hljs-string"><span class="hljs-string">"Petrovich"</span></span>, <span class="hljs-string"><span class="hljs-string">"Mihalich"</span></span>], <span class="hljs-attr"><span class="hljs-attr">dislike</span></span>: <span class="hljs-string"><span class="hljs-string">"Maria"</span></span>}}); db.zoo.insert({<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Tiger"</span></span>, <span class="hljs-attr"><span class="hljs-attr">ration</span></span>: [{<span class="hljs-attr"><span class="hljs-attr">meat</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">water</span></span>: <span class="hljs-number"><span class="hljs-number">25</span></span>}], <span class="hljs-attr"><span class="hljs-attr">holidays</span></span>: [<span class="hljs-number"><span class="hljs-number">6</span></span>], <span class="hljs-attr"><span class="hljs-attr">staff</span></span>: {<span class="hljs-attr"><span class="hljs-attr">like</span></span>: [<span class="hljs-string"><span class="hljs-string">"Petrovich"</span></span>, <span class="hljs-string"><span class="hljs-string">"Maria"</span></span>]}}); db.zoo.insert({<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Monkey"</span></span>, <span class="hljs-attr"><span class="hljs-attr">ration</span></span>: [{<span class="hljs-attr"><span class="hljs-attr">banana</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">water</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">nuts</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}], <span class="hljs-attr"><span class="hljs-attr">holidays</span></span>: [<span class="hljs-number"><span class="hljs-number">2</span></span>], <span class="hljs-attr"><span class="hljs-attr">staff</span></span>: {<span class="hljs-attr"><span class="hljs-attr">like</span></span>: [<span class="hljs-string"><span class="hljs-string">"Anna"</span></span>], <span class="hljs-attr"><span class="hljs-attr">dislike</span></span>: <span class="hljs-string"><span class="hljs-string">"Petrovich"</span></span>}}); db.zoo.insert({<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"Panda"</span></span>, <span class="hljs-attr"><span class="hljs-attr">ration</span></span>: [{<span class="hljs-attr"><span class="hljs-attr">bamboo</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">dumplings</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">water</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>}], <span class="hljs-attr"><span class="hljs-attr">staff</span></span>: {<span class="hljs-attr"><span class="hljs-attr">like</span></span>: [<span class="hljs-string"><span class="hljs-string">"Petrovich"</span></span>, <span class="hljs-string"><span class="hljs-string">"Mihalich"</span></span>, <span class="hljs-string"><span class="hljs-string">"Maria"</span></span>, <span class="hljs-string"><span class="hljs-string">"Anna"</span></span>]}});</code> </pre> <br>  The <b>name</b> field stores the name, the <b>ration</b> field is an array of objects that store how much and what kind of food the beast needs daily, <b>holidays</b> are the days on which the beast rests and is not shown to visitors, <b>staff.like</b> - caretakers that he likes (pandas, enchantments, like everything else ), <b>staff.dislike</b> - do not like. <br><br>  Let's start with a simple sample - only the names of the animals, so that the director of the zoo would not forget who their names are.  Everything is simple: <br><br><pre> <code class="javascript hljs">db.zoo.aggregate({<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}});</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"result"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58b7f627f86b11258dc70c"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Lion"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58b86027f86b11258dc70d"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Tiger"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58b90c27f86b11258dc70e"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Monkey"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58b98727f86b11258dc70f"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Panda"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br><br><h5>  What kind of animals do you need boatstsa? </h5><br><br>  You have to be afraid of predators.  A predator is one who has meat in the diet.  Let's find them.  To begin with, we will filter the stream and select only two fields in the documents - the name and the diet. <br><br><pre> <code class="javascript hljs">db.zoo.aggregate({<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">ration</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}});</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"result"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Lion"</span></span>, <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"meat"</span></span> : <span class="hljs-number"><span class="hljs-number">20</span></span> }, { <span class="hljs-string"><span class="hljs-string">"fish"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }, { <span class="hljs-string"><span class="hljs-string">"water"</span></span> : <span class="hljs-number"><span class="hljs-number">30</span></span> } ] }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Tiger"</span></span>, <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"meat"</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span> }, { <span class="hljs-string"><span class="hljs-string">"water"</span></span> : <span class="hljs-number"><span class="hljs-number">25</span></span> } ] }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Monkey"</span></span>, <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"banana"</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span> }, { <span class="hljs-string"><span class="hljs-string">"water"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span> }, { <span class="hljs-string"><span class="hljs-string">"nuts"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> } ] }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Panda"</span></span>, <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"bamboo"</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span> }, { <span class="hljs-string"><span class="hljs-string">"dumplings"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span> }, { <span class="hljs-string"><span class="hljs-string">"water"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span> } ] } ], <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br><br>  Then we expand the ration array on the elements of the main array: <br><br><pre> <code class="javascript hljs">db.zoo.aggregate({<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">ration</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$unwind</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration"</span></span>});</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"result"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Lion"</span></span>, <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : { <span class="hljs-string"><span class="hljs-string">"meat"</span></span> : <span class="hljs-number"><span class="hljs-number">20</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Lion"</span></span>, <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : { <span class="hljs-string"><span class="hljs-string">"fish"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Lion"</span></span>, <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : { <span class="hljs-string"><span class="hljs-string">"water"</span></span> : <span class="hljs-number"><span class="hljs-number">30</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Tiger"</span></span>, <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : { <span class="hljs-string"><span class="hljs-string">"meat"</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Tiger"</span></span>, <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : { <span class="hljs-string"><span class="hljs-string">"water"</span></span> : <span class="hljs-number"><span class="hljs-number">25</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Monkey"</span></span>, <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : { <span class="hljs-string"><span class="hljs-string">"banana"</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Monkey"</span></span>, <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : { <span class="hljs-string"><span class="hljs-string">"water"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Monkey"</span></span>, <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : { <span class="hljs-string"><span class="hljs-string">"nuts"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Panda"</span></span>, <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : { <span class="hljs-string"><span class="hljs-string">"bamboo"</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Panda"</span></span>, <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : { <span class="hljs-string"><span class="hljs-string">"dumplings"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Panda"</span></span>, <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : { <span class="hljs-string"><span class="hljs-string">"water"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span> } } ], <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br><br>  Next, we filter the sample only for those fields where there is a field ration.meat <br><br><pre> <code class="javascript hljs">db.zoo.aggregate({<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">ration</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$unwind</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">$match</span></span>: {<span class="hljs-string"><span class="hljs-string">"ration.meat"</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$exists</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}}});</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"result"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Lion"</span></span>, <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : { <span class="hljs-string"><span class="hljs-string">"meat"</span></span> : <span class="hljs-number"><span class="hljs-number">20</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Tiger"</span></span>, <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : { <span class="hljs-string"><span class="hljs-string">"meat"</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span> } } ], <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br><br>  And the final conclusion is only the name of the predator. <br><br><pre> <code class="javascript hljs">db.zoo.aggregate({<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">ration</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$unwind</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">$match</span></span>: {<span class="hljs-string"><span class="hljs-string">"ration.meat"</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$exists</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}}}, {<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>}});</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"result"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Lion"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Tiger"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br><br><h5>  On which days at least one beast rests? </h5><br><br>  To do this, we ‚Äúbreak‚Äù the holidays array into the whole array of animals (the panda is usually available to everyone and always). <br><br><pre> <code class="javascript hljs">db.zoo.aggregate({<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">holidays</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$unwind</span></span>: <span class="hljs-string"><span class="hljs-string">"$holidays"</span></span>});</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"result"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58b7f627f86b11258dc70c"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Lion"</span></span>, <span class="hljs-string"><span class="hljs-string">"holidays"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58b7f627f86b11258dc70c"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Lion"</span></span>, <span class="hljs-string"><span class="hljs-string">"holidays"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58b86027f86b11258dc70d"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Tiger"</span></span>, <span class="hljs-string"><span class="hljs-string">"holidays"</span></span> : <span class="hljs-number"><span class="hljs-number">6</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58b90c27f86b11258dc70e"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Monkey"</span></span>, <span class="hljs-string"><span class="hljs-string">"holidays"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58b98727f86b11258dc70f"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Panda"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br><br>  And filter only those where the holidays field is a number greater than -1 (well, or 0, to whom it is more convenient) <br><br><pre> <code class="javascript hljs">db.zoo.aggregate({<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">holidays</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$unwind</span></span>: <span class="hljs-string"><span class="hljs-string">"$holidays"</span></span>},{<span class="hljs-attr"><span class="hljs-attr">$match</span></span>: {<span class="hljs-attr"><span class="hljs-attr">holidays</span></span> : {<span class="hljs-attr"><span class="hljs-attr">$gt</span></span>: <span class="hljs-number"><span class="hljs-number">-1</span></span>}}});</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"result"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58b7f627f86b11258dc70c"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Lion"</span></span>, <span class="hljs-string"><span class="hljs-string">"holidays"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58b7f627f86b11258dc70c"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Lion"</span></span>, <span class="hljs-string"><span class="hljs-string">"holidays"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58b86027f86b11258dc70d"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Tiger"</span></span>, <span class="hljs-string"><span class="hljs-string">"holidays"</span></span> : <span class="hljs-number"><span class="hljs-number">6</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58b90c27f86b11258dc70e"</span></span>), <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Monkey"</span></span>, <span class="hljs-string"><span class="hljs-string">"holidays"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span> } ], <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br><br>  Remove all unnecessary. <br><br><pre> <code class="javascript hljs">db.zoo.aggregate({<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">holidays</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$unwind</span></span>: <span class="hljs-string"><span class="hljs-string">"$holidays"</span></span>},{<span class="hljs-attr"><span class="hljs-attr">$match</span></span>: {<span class="hljs-attr"><span class="hljs-attr">holidays</span></span> : {<span class="hljs-attr"><span class="hljs-attr">$gt</span></span>: <span class="hljs-number"><span class="hljs-number">-1</span></span>}}}, {<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">holidays</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>}});</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"result"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"holidays"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }, { <span class="hljs-string"><span class="hljs-string">"holidays"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span> }, { <span class="hljs-string"><span class="hljs-string">"holidays"</span></span> : <span class="hljs-number"><span class="hljs-number">6</span></span> }, { <span class="hljs-string"><span class="hljs-string">"holidays"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span> } ], <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br><br><h5>  How many products a day must be purchased. </h5><br><br>  The most interesting, in my opinion, task.  To implement it, remember that $ project can create fields and create a <b>meat</b> field with the value of the <b>meat</b> property. <br><br><pre> <code class="javascript hljs">db.zoo.aggregate({<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">ration</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$unwind</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">ration</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">meat</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration.meat"</span></span>, <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>}});</code> </pre><br><br>  If this field in the properties of the diet of the animal is not, then it will not be created.  Here is an example of a sample part: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"result"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : { <span class="hljs-string"><span class="hljs-string">"meat"</span></span> : <span class="hljs-number"><span class="hljs-number">20</span></span> }, <span class="hljs-string"><span class="hljs-string">"meat"</span></span> : <span class="hljs-number"><span class="hljs-number">20</span></span> }, { <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : { <span class="hljs-string"><span class="hljs-string">"fish"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"ration"</span></span> : { <span class="hljs-string"><span class="hljs-string">"water"</span></span> : <span class="hljs-number"><span class="hljs-number">30</span></span> } }, ... }</code> </pre> <br><br>  Let's do this for all types of food and remove the output of the object itself ration: <br><br><pre> <code class="javascript hljs">db.zoo.aggregate({<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">ration</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$unwind</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">ration</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">meat</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration.meat"</span></span>, <span class="hljs-attr"><span class="hljs-attr">fish</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration.fish"</span></span>, <span class="hljs-attr"><span class="hljs-attr">water</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration.water"</span></span>, <span class="hljs-attr"><span class="hljs-attr">banana</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration.banana"</span></span>, <span class="hljs-attr"><span class="hljs-attr">bamboo</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration.bamboo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">nuts</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration.nuts"</span></span>, <span class="hljs-attr"><span class="hljs-attr">dumplings</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration.dumplings"</span></span>, <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>}});</code> </pre> <br><br>  as a result we get <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"result"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58e58227f86b11258dc713"</span></span>), <span class="hljs-string"><span class="hljs-string">"meat"</span></span> : <span class="hljs-number"><span class="hljs-number">20</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58e58227f86b11258dc713"</span></span>), <span class="hljs-string"><span class="hljs-string">"fish"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58e58227f86b11258dc713"</span></span>), <span class="hljs-string"><span class="hljs-string">"water"</span></span> : <span class="hljs-number"><span class="hljs-number">30</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58e5e127f86b11258dc714"</span></span>), <span class="hljs-string"><span class="hljs-string">"meat"</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58e5e127f86b11258dc714"</span></span>), <span class="hljs-string"><span class="hljs-string">"water"</span></span> : <span class="hljs-number"><span class="hljs-number">25</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58e60027f86b11258dc715"</span></span>), <span class="hljs-string"><span class="hljs-string">"banana"</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58e60027f86b11258dc715"</span></span>), <span class="hljs-string"><span class="hljs-string">"water"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58e60027f86b11258dc715"</span></span>), <span class="hljs-string"><span class="hljs-string">"nuts"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58e64a27f86b11258dc716"</span></span>), <span class="hljs-string"><span class="hljs-string">"bamboo"</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58e64a27f86b11258dc716"</span></span>), <span class="hljs-string"><span class="hljs-string">"dumplings"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span> }, { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : ObjectId(<span class="hljs-string"><span class="hljs-string">"4f58e64a27f86b11258dc716"</span></span>), <span class="hljs-string"><span class="hljs-string">"water"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span> } ], <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br><br>  It remains only to add / group the whole thing with the function $ group.  Specifying the <b>_id</b> field in the grouping here is mandatory, but we don‚Äôt need it in principle, so let it be some nonsense.  For each type of food, we create an appropriate field for summing up the individual rations of each animal: <br><br><pre> <code class="javascript hljs">db.zoo.aggregate({<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">ration</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$unwind</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">ration</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">meat</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration.meat"</span></span>, <span class="hljs-attr"><span class="hljs-attr">fish</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration.fish"</span></span>, <span class="hljs-attr"><span class="hljs-attr">water</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration.water"</span></span>, <span class="hljs-attr"><span class="hljs-attr">banana</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration.banana"</span></span>, <span class="hljs-attr"><span class="hljs-attr">bamboo</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration.bamboo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">nuts</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration.nuts"</span></span>, <span class="hljs-attr"><span class="hljs-attr">dumplings</span></span>: <span class="hljs-string"><span class="hljs-string">"$ration.dumplings"</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$group</span></span>: {<span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-string"><span class="hljs-string">"s"</span></span>, <span class="hljs-attr"><span class="hljs-attr">sum_meat</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$sum</span></span>: <span class="hljs-string"><span class="hljs-string">"$meat"</span></span>}, <span class="hljs-attr"><span class="hljs-attr">sum_fish</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$sum</span></span>: <span class="hljs-string"><span class="hljs-string">"$fish"</span></span>}, <span class="hljs-attr"><span class="hljs-attr">sum_water</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$sum</span></span>: <span class="hljs-string"><span class="hljs-string">"$water"</span></span>}, <span class="hljs-attr"><span class="hljs-attr">sum_banana</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$sum</span></span>: <span class="hljs-string"><span class="hljs-string">"$banana"</span></span>}, <span class="hljs-attr"><span class="hljs-attr">sum_nuts</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$sum</span></span>: <span class="hljs-string"><span class="hljs-string">"$nuts"</span></span>}, <span class="hljs-attr"><span class="hljs-attr">sum_bamboo</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$sum</span></span>: <span class="hljs-string"><span class="hljs-string">"$bamboo"</span></span>}, <span class="hljs-attr"><span class="hljs-attr">sum_dumplings</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$sum</span></span>: <span class="hljs-string"><span class="hljs-string">"$dumplings"</span></span>}}});</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"result"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"s"</span></span>, <span class="hljs-string"><span class="hljs-string">"sum_meat"</span></span> : <span class="hljs-number"><span class="hljs-number">35</span></span>, <span class="hljs-string"><span class="hljs-string">"sum_fish"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"sum_water"</span></span> : <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-string"><span class="hljs-string">"sum_banana"</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-string"><span class="hljs-string">"sum_nuts"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"sum_bamboo"</span></span> : <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-string"><span class="hljs-string">"sum_dumplings"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span> } ], <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br><br><h5>  Favorite Caretaker </h5><br><br>  Filter by fields and unwind the staff.like array: <br><br><pre> <code class="javascript hljs">db.zoo.aggregate({<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"staff.like"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$unwind</span></span>: <span class="hljs-string"><span class="hljs-string">"$staff.like"</span></span>});</code> </pre> <br>  Recall that $ project can raise the field to the next level: <br><br><pre> <code class="javascript hljs">db.zoo.aggregate({<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"staff.like"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$unwind</span></span>: <span class="hljs-string"><span class="hljs-string">"$staff.like"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"$staff.like"</span></span>}});</code> </pre> <br>  Since we chose all caretakers who at least like someone and someone like two animals, he is present in the sample two times. <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"result"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Petrovich"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Mihalich"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Petrovich"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Maria"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Anna"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Petrovich"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Mihalich"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Maria"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Anna"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br><br>  Now it is necessary to sum these fields.  But this is not so easy to do, since we do not have a field for summation, so we create this field with the already known chip. <br><br><pre> <code class="javascript hljs">db.zoo.aggregate({<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"staff.like"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$unwind</span></span>: <span class="hljs-string"><span class="hljs-string">"$staff.like"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"$staff.like"</span></span>, <span class="hljs-attr"><span class="hljs-attr">count</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$add</span></span>: [<span class="hljs-number"><span class="hljs-number">1</span></span>]}}});</code> </pre> <br>  As a result, one more field count will be added to each object with a value of 1. Group and summarize: <br><br><pre> <code class="javascript hljs">db.zoo.aggregate({<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"staff.like"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$unwind</span></span>: <span class="hljs-string"><span class="hljs-string">"$staff.like"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"$staff.like"</span></span>, <span class="hljs-attr"><span class="hljs-attr">count</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$add</span></span>: [<span class="hljs-number"><span class="hljs-number">1</span></span>]}}}, {<span class="hljs-attr"><span class="hljs-attr">$group</span></span>: {<span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-string"><span class="hljs-string">"$name"</span></span>, <span class="hljs-attr"><span class="hljs-attr">num</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$sum</span></span>: <span class="hljs-string"><span class="hljs-string">"$count"</span></span>}}});</code> </pre> <br>  We sort and limit the output to the very first element. <br><br><pre> <code class="javascript hljs">db.zoo.aggregate({<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"staff.like"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$unwind</span></span>: <span class="hljs-string"><span class="hljs-string">"$staff.like"</span></span>}, {<span class="hljs-attr"><span class="hljs-attr">$project</span></span>: {<span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"$staff.like"</span></span>, <span class="hljs-attr"><span class="hljs-attr">count</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$add</span></span>: [<span class="hljs-number"><span class="hljs-number">1</span></span>]}}}, {<span class="hljs-attr"><span class="hljs-attr">$group</span></span>: {<span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-string"><span class="hljs-string">"$name"</span></span>, <span class="hljs-attr"><span class="hljs-attr">num</span></span>: {<span class="hljs-attr"><span class="hljs-attr">$sum</span></span>: <span class="hljs-string"><span class="hljs-string">"$count"</span></span>}}}, {<span class="hljs-attr"><span class="hljs-attr">$sort</span></span>: {<span class="hljs-attr"><span class="hljs-attr">num</span></span>: <span class="hljs-number"><span class="hljs-number">-1</span></span>}}, {<span class="hljs-attr"><span class="hljs-attr">$limit</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>});</code> </pre> <br>  And we get the following: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"result"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"Petrovich"</span></span>, <span class="hljs-string"><span class="hljs-string">"num"</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span> } ], <span class="hljs-string"><span class="hljs-string">"ok"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br><br>  That's all.  For those interested, there are two simple reports in English on this topic: <a href="http://www.slideshare.net/cwestin63/mongodbs-new-aggregation-framework">one</a> and <a href="http://www.slideshare.net/cwestin63/mongodb-aggregation-mongosf-may-2011">two</a> . <br><br>  To be honest, I really like MongoDB, although we used it only for a part of the project to store scattered data.  The same Map / Reduce for me has always been something scary and incomprehensible, but a new piece of data aggregation allows you to partially eliminate JavaScript, because somehow it is an interpretable language, and therefore slow and replace it with ready-made, which means fast, elements of the language . <br><br>  PS It is worth noting that version 2.1 is still quite raw.  I constantly got any exceptions for assertion failed.  But I think that in 2.2 it will finally be stable and cool. </div><p>Source: <a href="https://habr.com/ru/post/139643/">https://habr.com/ru/post/139643/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139638/index.html">For the rest of us</a></li>
<li><a href="../139639/index.html">How to run Truckers 2 under Wine, patch ddraw.c</a></li>
<li><a href="../139640/index.html">Changes in the dropbox web interface</a></li>
<li><a href="../139641/index.html">OpenStreetMap News ‚Ññ14: Apple and geokeshery also leave Google Maps, monitoring of transport in St. Petersburg - on OSM, and our Linux users continue to ignore this success of freedom</a></li>
<li><a href="../139642/index.html">Max Skibinsky, entrepreneur, angel investor and business mentor</a></li>
<li><a href="../139645/index.html">Free tickets to developers on Yandex Mobile Camp</a></li>
<li><a href="../139646/index.html">Container packing (bin packing) using a genetic algorithm</a></li>
<li><a href="../139647/index.html">Binary clock do-it-yourself (Mega32, DS1307)</a></li>
<li><a href="../139649/index.html">PHP Reflection Features</a></li>
<li><a href="../139651/index.html">Demo that no one has ever seen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>