<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OpenVPN on Android: transparent switching between WiFi and Mobile data without disconnecting</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, let me share my experience. 

 There are applications that are critical to breaking the connection, reconnection is painful and not always. Set...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OpenVPN on Android: transparent switching between WiFi and Mobile data without disconnecting</h1><div class="post__text post__text-html js-mediator-article">  Hello, let me share my experience. <br><br>  There are applications that are critical to breaking the connection, reconnection is painful and not always.  Set a goal, make jumps of routes and physical connections transparent, so that the connection is constant and TCP connection is not torn. <br><a name="habracut"></a><br><br>  And the old, kind and lamp openvpn will help in this.  But installation and configuration is a topic that has been beaten for a long time, it is not planned to touch it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  What do we need: </h5><br><ul><li>  Linux server with constant IP (vps, vds, dedic or just home) </li><li>  Openvpn server and client configured to work on <b>UDP</b> . </li><li>  iproute2 - in fact, for the focus, you need a working ip utility on Android. </li><li>  You will also need to make changes to the source code of <a href="http://code.google.com/p/android-openvpn-settings/">openvpn-settings</a> with the subsequent build of apk. </li></ul><br><br><h5>  Let's get started </h5><br>  Let's start with editing openvpn-settings.  The bottom line is that for any change in the network configuration, the <i>SIGUSR1</i> command is sent to the native openvpn daemon, which causes it to disconnect and reconnect.  For our purposes, this is harmful, but we still want to be able to perform some actions when changing the network configuration. <br><br>  Someone will say, but there is a <b>persist-tun</b> .  I answer, it does not work the way I want, openvpn jerks the ‚Äúlie-up‚Äù scripts every time <i>SIGUSR1</i> arrives.  And, in principle, it is almost impossible to distinguish the restart from the start by the available variables, without frills.  This undermines the whole venture, but simply and reliably. <br><br>  Therefore, we will replace sending <i>SIGUSR1</i> with a shell script call. <br><br>  Download the source team <br> <code><a href="https://code.google.com/p/android-openvpn-settings/"></a> hg clone code.google.com/p/android-openvpn-settings</code> <br>  Open the file <br>  \ src \ de \ schaeuffelhut \ android \ openvpn \ service \ ManagementThread.java <br>  Find the function <u>public void sendSignal (int s)</u> and we will edit it. <br>  We comment on sending <i>SIGUSR1</i> and insert a call to our script with root rights. <br>  The script file will be called exactly the same as the connection file, but supplemented with the extension sh. <br><br>  It should work like this: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> SIGUSR1: <span class="hljs-comment"><span class="hljs-comment">//sendCommand( new SimpleCommand( "signal SIGUSR1" ) ); new Shell( "OpenVPN-Settings-ip-route", String.format( "/system/bin/sh %s.sh", Util.shellEscape(mDaemonMonitor.mConfigFile.getAbsolutePath()) ), Shell.SU ).run(); break;</span></span></code> </pre><br><br>  Everything can be collected, signed, installed.  Before installing, be sure to uninstall the old ‚Äúopenvpn-setting‚Äù from the system. <br><br>  Next, check the openvpn connection configuration. <br><br><h6>  Server </h6><br>  On the server, a <b>float</b> directive is required, since we will change the physical connection, and with it the IP.  Also, the server must transmit the internal address of our client to the external network.  For this, it is more convenient for me to use the <b>up</b> and <b>down</b> directives. <br><br>  up "/ bin / sh / etc / openvpn / androidupdown" <br>  down "/ bin / sh / etc / openvpn / androidupdown" <br><br>  The script should be something like this: <br><pre> <code class="bash hljs">NATGW=<span class="hljs-string"><span class="hljs-string">"1.2.3.4"</span></span> <span class="hljs-comment"><span class="hljs-comment"># ip      NATDEV="eth0" #          NATNET="10.9.8.0/24" # vpn ,       sysctl -w net.ipv4.ip_forward=1 ACT="A" [ "down" = "$script_type" ] &amp;&amp; ACT="D" iptables -t nat -$ACT POSTROUTING -s $NATNET -o $NATDEV -j SNAT --to-source $NATGW</span></span></code> </pre><br><br><h6>  Customer </h6><br>  First, you need to remove the <b>redirect-gateway</b> directive, if it has one.  But set <b>up</b> and <b>down</b> with an indication of the script that will configure the routes.  If you remember, we agreed that the file name will repeat the configuration name with the addition of sh.  Yes, we will call the same script from both the daemon and the monitor. <br><br>  If the configuration is called ‚Äútestconfig.ovpn‚Äù, then so be it: <br><br>  up "/ system / bin / sh /sdcard/openvpn/testconfig.ovpn.sh" <br>  down "/ system / bin / sh /sdcard/openvpn/testconfig.ovpn.sh" <br><br>  Script <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   export ANDROID_PROPERTY_WORKSPACE=12,66560 #     export PATH=/system/bin:/system/xbin:$PATH setprop net.dns1 8.8.8.8 #   DNS setprop net.dns2 8.8.4.4 #      openvpn. if [ "init" = "$script_context" ]; then ACT="add" [ "down" = "$script_type" ] &amp;&amp; ACT="del" ip route $ACT throw $remote_1 table 100 ip route $ACT default dev $dev table 100 ip rule $ACT table 100 pref 1000 fi</span></span></code> </pre><br><br>  Here it is worth explaining a little. <br>  We create an alternative routing table with the number 100 in which we specify the default vpn tunnel by the gateway.  And we add a routing rule that wraps all traffic in our table at number 100, before it gets into the main table called main. <br><br>  In an alternative table, there is a route that pushes packets destined for the server back into the chain of rules.  Further they will get to the main routing table.  There they will be able to find the main route of the physical connection.  But, and if they do not find it, it will happen during reconnects, then it is not terrible.  Openvpn may suffer for some time, but of course not forever.  Only messages in the logs will remind you that there is no connection for a short time. <br><br>  Do not forget the scripts should end with a line break. <br><br>  To allow running scripts on Android, you need to install the ‚ÄúBuilt-in + script‚Äù in the ‚ÄúPreferences‚Äù, which are called by a long tap on the connection.  Now you can try. <br><br>  As a result of testing, it turned out that some programs themselves check the status of the network and try to reconnect during any changes.  Then either ask the authors to correct the situation.  Either independently compile and correct.  In any case, the TCP session is closed, not by timeout, but as it should be. <br><br>  I would welcome any criticism and comments.  I wish a stable connection! </div><p>Source: <a href="https://habr.com/ru/post/157687/">https://habr.com/ru/post/157687/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../157673/index.html">Lo-dash</a></li>
<li><a href="../157675/index.html">One day of the Internet: statistics, figures, facts</a></li>
<li><a href="../157677/index.html">A couple of words about debugging applications from the App Store</a></li>
<li><a href="../157683/index.html">Calls from VimpelCom FMC</a></li>
<li><a href="../157685/index.html">Backing up user data in Android</a></li>
<li><a href="../157689/index.html">Index method for generating finite discrete distributions</a></li>
<li><a href="../157699/index.html">Aichi-Event.rf - all IT events of Runet!</a></li>
<li><a href="../157707/index.html">Video report from the first conference "Around the Cloud" in St. Petersburg</a></li>
<li><a href="../157709/index.html">Microsoft officially: Skype will replace Messenger</a></li>
<li><a href="../157715/index.html">Budgets for R & D or what is influenced by research in microelectronics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>