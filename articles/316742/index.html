<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to create a trading robot using genetic programming</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. In this article I will talk about creating a system in which genetic algorithms write robots. In theory, these robots could trade on the exc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to create a trading robot using genetic programming</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/130/85a/7f7/13085a7f7cd5429483521b6a0765ee3e.jpg"></div><br><br>  Good day.  In this article I will talk about creating a system in which genetic algorithms write robots.  In theory, these robots could trade on the exchange. <br><br>  I am a fan of three things - artificial intelligence, high-performance machines and the practical application of any knowledge.  Having some free time, I designed a small puzzle, purchased iron and sat down to create. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The project arose from the desire to try to practice genetic programming.  The first option was to create a bot for any game, but I stopped at trading robots, where the exchange is also a kind of game. <br><a name="habracut"></a><br>  This article assumes that you are familiar with the concept of genetic algorithms or genetic programming.  And also what trading robots do. <br><br><h3>  Where to begin? </h3><br>  I started by studying the platform for creating MetaTrader5 robots.  The MQL5 language is positioned as similar to C ++, with minor differences in syntax.  In simple terms, the platform has functions for accessing market data and functions for carrying out trading operations.  After studying and testing several dozen simple robots, work began on identifying a common elementary base on which these algorithms are built. <br><br>  For the convenience of working with logic inside the genetic algorithm, I had to create my own meta-language over MQL, let's call it SadLobster.  Without this generalization, it would be terribly difficult to force the machine to write code according to the rules of a programming language created for a person.  The whole project was designated as a prototype, so that it would be easier to accept many compromises and simplifications.  Otherwise, this development phase would never end. <br><br><h3>  How does one robot work </h3><br>  Let's see what the simplified version of the robot that will be created looks like. <br>  <em>(I had to throw away too much to make the article look like)</em> <br><br><div class="spoiler">  <b class="spoiler_title">Robot code</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// NoPos()  YesPos()    //     void NoPos(bool invert){ //       priceA__6  boolA__3 == true PUT_ORDER(boolA__3, priceA__6, STOP_ONLY); } //     void YesPos(bool invert){ //   stop loss   priceA__10 PUT_SL_ON_PRICE(priceA__10); } //      DEF_BOOL boolA__3(bool invert) { DEF_OFFSET var_2 = __value(1); DEF_PRICE var_4 = _HIGH(var_2, invert); DEF_PIPS_DOUBLE var_1 = MA_RANGE(8, dsD1, 1); DEF_PRICE var_0 = MA_HI_I(7, ds, 1, !invert); DEF_HPRICE_LEVEL var_3 = MAKE_HPRICE_LEVEL(var_0, var_1); DEF_BOOL var_5 = IS_INSIDE(var_3, var_4); return var_5; } //        DEF_PRICE priceA__10(bool invert) { DEF_PRICE var_2 = _HIGH_D1(1, invert); DEF_PRICE var_1 = _LOW_D1(1, invert); DEF_WAVE_INDEX var_0 = CALL_FUNC(waveState_38); DEF_BOOL var_3 = IS_WAVE(var_0, 1); DEF_PRICE var_4 = IF_ELSE(var_3, var_1, var_2); return var_4; }</span></span></code> </pre> </div></div><br>  The functions boolA__3 and priceA__10 process the information received from the quote charts. <br>  The boolA__3 function is launched to check if there is a signal for placing an order.  The first time we check if there is a buy signal.  The second time we run with the value invert = 1 and check if there is a sell signal. <br><br>  The priceA__10 function determines at what price an order should be placed. <br><br>  <strong>Sadlobster</strong> <br>  The second feature of the SadLobster language is that its syntax is compatible with C ++.  That is, the same code that I use for testing in MQL can be run through C ++ tester, which was written separately. <br><br>  <strong>MQL tester vs C ++ tester</strong> <br><br><ul><li>  This tester is two orders of magnitude faster than MQL and has the necessary API so that it can be controlled by a genetic algorithm. </li><li>  MQL also provides excellent opportunities for debugging and checking the correct operation of robots. </li></ul><br>  When applied to trading robots, there is such a term ‚Äú <strong>grail</strong> ‚Äù - this is a robot that earns a lot and stably even outside the training set.  During the development, I met their outlines several times.  And each of them was the result of a vulnerability in the C ++ tester.  As evolution progressed, robots found vulnerabilities in the testing framework ‚Äî performed impossible operations or found a way to look into future data and many other tricks.  <em>(I think the potential of genetic programming in testing is greatly underestimated.)</em> Here MQL came to the rescue.  Running the robot there, he lost the magic properties of the Grail, because there most of the vulnerabilities are already covered. <br><br>  A language consists of a list of functions that can be used.  The simplest are AND, OR, CREATE_LINE, IS_INSIDE, ... <br><br>  And the functions of access to data quotes and technical indicators - HIGH, LOW, FRACTAL, MA, MACD_SIGNAL.  These functions will be listed in list 1. <br><br><h3>  Simulation of trading history <br></h3><br>  The robot runs on a period of history, for example, from 2014 to 2016.  There is a trading simulation.  All his transactions are recorded and a report is generated for them.  My report looks like this: <br><br><img src="https://habrastorage.org/files/b5b/cee/a33/b5bceea3306c4b289f24f360b872c75c.png"><br><br>  or so <br><br><pre> <code class="python hljs"><span class="hljs-number"><span class="hljs-number">1.82</span></span> <span class="hljs-number"><span class="hljs-number">14.66</span></span> <span class="hljs-number"><span class="hljs-number">64.1</span></span>% <span class="hljs-number"><span class="hljs-number">1.02</span></span> <span class="hljs-number"><span class="hljs-number">-383</span></span>[+<span class="hljs-number"><span class="hljs-number">0.99</span></span>] <span class="hljs-number"><span class="hljs-number">451</span></span> (<span class="hljs-number"><span class="hljs-number">30.8</span></span>%) +<span class="hljs-number"><span class="hljs-number">6613</span></span> : <span class="hljs-number"><span class="hljs-number">179</span></span>F &lt;<span class="hljs-number"><span class="hljs-number">736</span></span>c&gt;</code> </pre><br>  These numbers mean: profitability, expectation of winnings, share of profitable deals, ratio of average profitable deal to average loss, drawdown, number of deals, time percentage in the market, net profit, robot identifier. <br><br>  The report shows a good robot or not.  I will try to tell about the strategy tester and its implementation another time. <br><br><h3>  Fitness function </h3><br>  An interesting module that needs attention is the fitness function.  To evaluate the results of trading, we need to simulate it, and then analyze all transactions.  There is the widest field for creativity.  The results depend on the fact that you will be considered the best robot.  And the more complex the system, the more difficult it is to do.  Since it is impossible to describe the behavior of the desired program with a single number. <br><br>  The first decision - the more the robot earned, the better it is.  But this raises the question of risks.  Such a robot is completely unviable.  Less risk - less profit, more risk more profit. <br><br>  Trading robots have several different characteristics.  The simplest of them are the profit factor (PF) and the expectation of profit per trade (EP), the maximum drawdown of funds, LR correlation, the Sharpe ratio. <br><br>  This is how the MetaTrader report on the work of one of the created robots looks like: <br><br><img src="https://habrastorage.org/files/c20/998/a8e/c20998a8ea7a43debee16328ff047c41.png"><br><br>  Each of the parameters has its own coefficient of importance.  In proportion to these numbers, the fitness function for each robot is calculated.  After which there are well-known processes of crossing and mutation.  And additionally set the threshold for the minimum number of transactions.  From 0.2 to 2 transactions per day, minimum. <br><br><pre> <code class="python hljs">self.KOEF = [<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>] self.KEYS = [<span class="hljs-string"><span class="hljs-string">'PF'</span></span>, <span class="hljs-string"><span class="hljs-string">'EP'</span></span>, <span class="hljs-string"><span class="hljs-string">'win_persent'</span></span>, <span class="hljs-string"><span class="hljs-string">'p_wiin_div_loss'</span></span>, <span class="hljs-string"><span class="hljs-string">'max_dd'</span></span>, <span class="hljs-string"><span class="hljs-string">'deals'</span></span>, <span class="hljs-string"><span class="hljs-string">'profit'</span></span>, <span class="hljs-string"><span class="hljs-string">'pfMonth'</span></span>, <span class="hljs-string"><span class="hljs-string">'LR'</span></span>]</code> </pre><br><h3>  Dynamics and Results of the Genetic Algorithm Launch <br></h3><br>  Graphic representation of the evolution or training schedule <br><br><img src="https://habrastorage.org/files/974/3f0/668/9743f066801344c396d3a8a2f05a408c.png"><br><br>  The red line on the left is the profit factor of the best robot, and the blue line is the cross test of the top 10 robots.  20 iterations are usually enough to evaluate the result.  The first ten iterations can be ignored, because there all restrictions are not imposed on robots.  At iterations from 10 to 20, we see how the forward results are improving. <br><br>  On the right is a histogram of the monthly profitability of the best of the robots in points.  It shows three years of study on the left, and one year of cross-test on the right. <br><br>  I also tried to avoid re-optimization, so I scored all the floating parameters with constants, with the expectation that there were enough degrees of freedom due to the combination of functions. <br><br><h3>  About complexity </h3><br>  The robot algorithm for simplicity has no internal memory or states.  This feature also helps to cache the results of calculations on each bar.  Which greatly speeds up the calculations.  Trying to use only functions with complexity O (1) or O (n) in logic, I strongly limited the functional.  But this required computational resources. <br><br><h3>  Random Tree Generation <br></h3><br>  How to get the function in the form in which it is presented in the first listing? <br><br><ol><li>  It is necessary to create a list of possible functions and describe them. </li><li>  Collect a random expression tree which is logic </li><li>  Convert to code </li></ol><br>  Here are some of the interface functions that are used in the logic of robots.  Each function name is a kind of macro, accessible from both MQL and C ++ test frameworks.  Implementations differ due to language differences.  Call it a list of 1. <br><br><div class="spoiler">  <b class="spoiler_title">Short list of functions.</b>  <b class="spoiler_title">List 1.</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#EXAMPLE {'name':'MORE_I', 'input':['DEF_PRICE','DEF_PRICE','invert'], 'result':'DEF_BOOL', 'price':4} {'name':'_CLOSE', 'input':['DEF_OFFSET'], 'result':'DEF_PRICE', 'price':1} {'name':'_HIGH', 'input':['DEF_OFFSET','invert'], 'result':'DEF_PRICE', 'price':1} {'name':'__value', 'input':['1'], 'result':'DEF_OFFSET', 'price':1} {'name':'_CLOSE_D1', 'input':['1'], 'result':'DEF_PRICE', 'price':1} #OTHER #ALGORITHMS {'name':'CALL_FUNC_v1', 'input':['FUNC_period'], 'result':'DEF_PERIOD', 'flags':['singleton']} {'name':'CALL_FUNC_v2', 'input':['FUNC_easyPrice'], 'result':'DEF_PRICE'} {'name':'CALL_FUNC_v3', 'input':['FUNC_easyPips'], 'result':'DEF_PIPS_DOUBLE' } #wave {'name':'CALL_FUNC_v4', 'input':['FUNC_waveState'], 'result':'DEF_WAVE_INDEX', 'flags':['singleton'] } {'name':'IS_WAVE', 'input':['DEF_WAVE_INDEX','wave_count'], 'result':'DEF_BOOL' } #DEF_PERIOD {'name':'makePeriodSinceLastDay', 'input':['ds'], 'result':'DEF_PERIOD'} {'name':'MAKE_PERIOD_v1', 'input':['6','60'], 'result':'DEF_PERIOD'} {'name':'MAKE_PERIOD_v2', 'input':['DEF_OFFSET','DEF_OFFSET'], 'result':'DEF_PERIOD'} #DEF_POINTS {'name':'determinatePeriodsAboutClose', 'input':['ds','specArray1'], 'result':'DEF_POINTS'} {'name':'DOWN_FRACTALS_ON_PERIOD', 'input':['ds','DEF_PERIOD','invert'], 'result':'DEF_POINTS'} {'name':'GetZZPoints', 'input':['zzPointsCount','ds','zzIndex'], 'result':'DEF_POINTS', 'flags':['singleton']} #DEF_POINT {'name':'MAX_PRICE_POINT', 'input':['ds','DEF_PERIOD','invert'], 'result':'DEF_POINT'} {'name':'GetPoint_v1', 'input':['DEF_POINTS','pointIndex'], 'result':'DEF_POINT'} {'name':'PROP_LINE_END', 'input':['DEF_LINE'], 'result':'DEF_POINT'} {'name':'PROP_LINE_START', 'input':['DEF_LINE'], 'result':'DEF_POINT'} {'name':'GetPoint', 'input':['DEF_POINTS','pointIndexInZZ'], 'result':'DEF_POINT'} {'name':'IF_ELSE_PO', 'input':['DEF_BOOL','DEF_POINT','DEF_POINT'], 'result':'DEF_POINT'} {'name':'MAXPOINT_I', 'input':['DEF_POINTS','invert'], 'result':'DEF_POINT'} {'name':'PROP_CENTER', 'input':['DEF_LINE'], 'result':'DEF_POINT'} #DEF_PRICE {'name':'PROP_PRICE', 'input':['DEF_POINT'], 'result':'DEF_PRICE'} {'name':'PROP_PRICE_BY_OFFSET', 'input':['DEF_LINE','DEF_OFFSET'], 'result':'DEF_PRICE'} {'name':'_CLOSE', 'input':['DEF_OFFSET'], 'result':'DEF_PRICE'} {'name':'_HIGH', 'input':['DEF_OFFSET', 'invert'], 'result':'DEF_PRICE'} {'name':'_LOW', 'input':['DEF_OFFSET', 'invert'], 'result':'DEF_PRICE'} {'name':'_OPEN', 'input':['DEF_OFFSET'], 'result':'DEF_PRICE'} {'name':'GET_MEDIAN_CLOSE_PRICE', 'input':['DEF_PERIOD','ds'], 'result':'DEF_PRICE'} {'name':'IF_ELSE_v2', 'input':['DEF_BOOL','DEF_PRICE','DEF_PRICE'], 'result':'DEF_PRICE'} {'name':'CENTER_PRICE_BETWEEN_LINES', 'input':['DEF_LINE','DEF_LINE','DEF_OFFSET'], 'result':'DEF_PRICE'} {'name':'_CLOSE_D1', 'input':['1'], 'result':'DEF_PRICE'} {'name':'_HIGH_D1', 'input':['1','invert'], 'result':'DEF_PRICE'} {'name':'_LOW_D1', 'input':['1','invert'], 'result':'DEF_PRICE'} {'name':'_OPEN_D1', 'input':['1'], 'result':'DEF_PRICE'} {'name':'PRICE_MAX_I', 'input':['DEF_PRICE','DEF_PRICE','invert'], 'result':'DEF_PRICE'} {'name':'MATH_AVR_v2', 'input':['DEF_PRICE','DEF_PRICE'], 'result':'DEF_PRICE'} {'name':'ADD_PRICE_PIPS_v1', 'input':['DEF_PRICE','DEF_PIPS_DOUBLE','invert'], 'result':'DEF_PRICE'} {'name':'SYNC_MA', 'input':['1','BARS_COUNT','ds'], 'result':'DEF_PRICE'} {'name':'MA_CLOSE_v1', 'input':['ma_bars_count','ds','DEF_OFFSET'], 'result':'DEF_PRICE'} {'name':'MA_HI_I_v1', 'input':['ma_range_size','ds','1','invert'], 'result':'DEF_PRICE'} {'name':'STD_DEV_8', 'input':['DEF_OFFSET'], 'result':'DEF_PIPS_DOUBLE'} {'name':'STD_DEV_20', 'input':['DEF_OFFSET'], 'result':'DEF_PIPS_DOUBLE'} #DEF_SLOPE {'name':'PROP_SLOPE', 'input':['DEF_LINE'], 'result':'DEF_SLOPE'} #DEF_LINE {'name':'PROP_MIRROR_LINE', 'input':['DEF_LINE'], 'result':'DEF_LINE'} {'name':'MAKE_SUPPORT', 'input':['DEF_POINTS','DEF_PERIOD','4','invert'], 'result':'DEF_LINE', 'check':'CHECK_LINE_OR_FALSE'} {'name':'NewLine', 'input':['DEF_POINT','DEF_POINT'], 'result':'DEF_LINE', 'check':'CHECK_LINE_OR_FALSE'} {'name':'IF_ELSE_LL', 'input':['DEF_BOOL','DEF_LINE','DEF_LINE'], 'result':'DEF_LINE'} {'name':'RegressionOnPointsV1', 'input':['DEF_POINTS'], 'result':'DEF_LINE'} #DEF_OFFSET {'name':'MAX_CANDLE', 'input':['ds','DEF_PERIOD'], 'result':'DEF_OFFSET'} #DEF_BOOL {'name':'MORE_I', 'input':['DEF_PRICE','DEF_PRICE','invert'], 'result':'DEF_BOOL'} {'name':'IS_INSIDE', 'input':['DEF_HPRICE_LEVEL','DEF_PRICE'], 'result':'DEF_BOOL',} {'name':'DIFF', 'input':['DEF_PRICE','DEF_PRICE','DEF_AWS'], 'result':'DEF_BOOL'} {'name':'DIFF_MORE', 'input':['DEF_PRICE','DEF_PRICE','DEF_AWS'], 'result':'DEF_BOOL'} {'name':'HAS_CROSS_FUTURE', 'input':['DEF_LINE','DEF_LINE','const_10'], 'result':'DEF_BOOL'} {'name':'IF_ELSE_v1', 'input':['DEF_BOOL','DEF_BOOL','DEF_BOOL'], 'result':'DEF_BOOL'} {'name':'MORE_v4', 'input':['DEF_PIPS_DOUBLE','DEF_PIPS_DOUBLE'], 'result':'DEF_BOOL'} {'name':'MORE_MULT', 'input':['DEF_PIPS_DOUBLE','DEF_PIPS_DOUBLE','float_fibo_mult'], 'result':'DEF_BOOL'} {'name':'AND2', 'input':['DEF_BOOL','DEF_BOOL'], 'result':'DEF_BOOL'} {'name':'AND3', 'input':['DEF_BOOL','DEF_BOOL','DEF_BOOL'], 'result':'DEF_BOOL'} {'name':'OR2', 'input':['DEF_BOOL','DEF_BOOL'], 'result':'DEF_BOOL'} {'name':'OR3', 'input':['DEF_BOOL','DEF_BOOL','DEF_BOOL'], 'result':'DEF_BOOL'} {'name':'NOT', 'input':['DEF_BOOL'], 'result':'DEF_BOOL'} {'name':'EQ_BOOL', 'input':['DEF_BOOL','DEF_BOOL'], 'result':'DEF_BOOL'} {'name':'PROP_IS_UP_I', 'input':['DEF_LINE','invert'], 'result':'DEF_BOOL'} {'name':'MORE_I_v3', 'input':['DEF_SLOPE','DEF_SLOPE','invert'], 'result':'DEF_BOOL'} {'name':'MORE_ABS', 'input':['DEF_SLOPE','DEF_SLOPE'], 'result':'DEF_BOOL'} {'name':'DIFF_MULT', 'input':['DEF_PIPS_DOUBLE','DEF_PIPS_DOUBLE','DEF_AWS','float_small'], 'result':'DEF_BOOL'} {'name':'MORE', 'input':['DEF_PIPS_DOUBLE','DEF_PIPS_DOUBLE'], 'result':'DEF_BOOL'} #DEF_HPRICE_LEVEL {'name':'MAKE_HPRICE_LEVEL', 'input':['DEF_PRICE','DEF_PIPS_DOUBLE'], 'result':'DEF_HPRICE_LEVEL'} #DEF_AWS {'name':'MakeAWS', 'input':['DEF_POINTS'], 'result':'DEF_AWS', 'flags':['singleton']} #DEF_PIPS_DOUBLE {'name':'PROP_SIZE', 'input':['DEF_LINE'], 'result':'DEF_PIPS_DOUBLE'} {'name':'SIZE_CAST', 'input':['DEF_AWS'], 'result':'DEF_PIPS_DOUBLE'} {'name':'PIPS_MAX', 'input':['DEF_PIPS_DOUBLE','DEF_PIPS_DOUBLE'], 'result':'DEF_PIPS_DOUBLE'} {'name':'PIPS_MIN', 'input':['DEF_PIPS_DOUBLE','DEF_PIPS_DOUBLE'], 'result':'DEF_PIPS_DOUBLE'} {'name':'MATH_AVR_v1', 'input':['DEF_PIPS_DOUBLE','DEF_PIPS_DOUBLE'], 'result':'DEF_PIPS_DOUBLE'} {'name':'MULT_ABS_v1', 'input':['DEF_SLOPE','DEF_BARS_COUNT'], 'result':'DEF_PIPS_DOUBLE'} {'name':'DISTANCE', 'input':['DEF_PRICE','DEF_PRICE'], 'result':'DEF_PIPS_DOUBLE'} {'name':'MA_RANGE_v1', 'input':['ma_range_size','ds','1'], 'result':'DEF_PIPS_DOUBLE'} {'name':'MA_RANGE_v2', 'input':['ma_range_size','dsD1','1'], 'result':'DEF_PIPS_DOUBLE'} {'name':'STDDEV8_RANGE_MIN_END', 'input':['10'], 'result':'DEF_PIPS_DOUBLE'} {'name':'STDDEV20_RANGE_MIN_END', 'input':['10'], 'result':'DEF_PIPS_DOUBLE'} {'name':'STDDEV8_RANGE_MAX_END', 'input':['10'], 'result':'DEF_PIPS_DOUBLE'} {'name':'STDDEV20_RANGE_MAX_END', 'input':['10'], 'result':'DEF_PIPS_DOUBLE'} {'name':'STD_DEV_4_D1', 'input':['1'], 'result':'DEF_PIPS_DOUBLE'} {'name':'STD_DEV_8_D1', 'input':['1'], 'result':'DEF_PIPS_DOUBLE'} {'name':'STD_DEV_20_D1', 'input':['1'], 'result':'DEF_PIPS_DOUBLE'}</span></span></code> </pre><br></div></div><br>  Consider the simple MORE_I function. <br><br><pre> <code class="python hljs">{<span class="hljs-string"><span class="hljs-string">'name'</span></span>:<span class="hljs-string"><span class="hljs-string">'MORE_I'</span></span>, <span class="hljs-string"><span class="hljs-string">'input'</span></span>:[<span class="hljs-string"><span class="hljs-string">'DEF_PRICE'</span></span>,<span class="hljs-string"><span class="hljs-string">'DEF_PRICE'</span></span>,<span class="hljs-string"><span class="hljs-string">'invert'</span></span>], <span class="hljs-string"><span class="hljs-string">'result'</span></span>:<span class="hljs-string"><span class="hljs-string">'DEF_BOOL'</span></span>, <span class="hljs-string"><span class="hljs-string">'price'</span></span>:<span class="hljs-number"><span class="hljs-number">4</span></span>}</code> </pre><br>  This function takes two price parameters (and an auxiliary parameter invert, you can ignore it).  It returns a boolean value.  The price parameter means a certain abstract complexity of this function, which was intended to control the complexity of the entire logic of each robot. <br><br>  And here there is a good <strong>olympiad problem</strong> : it is necessary to collect all possible logics with the given complexity and type of result from the source functions.  Logic is an expression of the type F (X) -&gt; Y. <br><br>  Example - we want the function of deciding whether to enter a long position.  We need a boolean solution - DEF_BOOL, then the options are as follows: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MORE_I(_CLOSE(__value(<span class="hljs-number"><span class="hljs-number">1</span></span>)), _HIGH(__value(<span class="hljs-number"><span class="hljs-number">1</span></span>)), invert);<span class="hljs-comment"><span class="hljs-comment">//1 return MORE_I(_CLOSE_D1(1), _HIGH(__value(1)), invert);//2 //__value    ‚Äú1‚Äù    . //PS           .</span></span></code> </pre><br>  Trying to finish the prototype, I was very wrong with the random () function where I would have to use smarter logic.  But the whole idea was to start the car entirely and, having weighed it with tests, to start iterative improvements.  Below is a description of the algorithm on which I stopped. <br><br>  The task of the algorithm is to generate a function that will return DEF_BOOL.  The expression notation is LISP-like: [Function Name, param1, param2 ...].  Parameters that begin with DEF are a type.  The expression in which there is such a parameter is not final, requires clarification.  The notation does not indicate the type of return value as unnecessary. <br><br><ol><li>  Let's create a pool of such expressions, where we will generate them. </li><li>  We check if there are functions in our pool without parameters that need clarification.  If so, select it and return as result.  If not, continue. <br></li><li>  Randomly choose one of the following possible actions - add one more function (4) to the pool or fill in the existing unspecified parameters (5). <br></li><li>  Add a new expression.  Since we only need functions that will return the type DEF_BOOL, we select all such functions from the list of SP1.  Now select a random function and write it to the pool in the form ['IS_INSIDE', 'DEF_HPRICE_LEVEL', 'DEF_PRICE']. <br></li><li>  Extend the existing function.  In the IS_INSIDE function, two parameters need clarification.  We are looking for a function that can fill the parameter DEF_PRICE in SP1. <br>  We get ['IS_INSIDE', 'DEF_HPRICE_LEVEL', ['MA_HI_I_v2', '8', 'dsD1', '1', 'invert']]]. </li><li>  Returning to paragraph 2. </li></ol><br>  The result of the algorithm will be a similar expression. <br><br><pre> <code class="python hljs">[<span class="hljs-string"><span class="hljs-string">'IS_INSIDE'</span></span>, [<span class="hljs-string"><span class="hljs-string">'MAKE_HPRICE_LEVEL'</span></span>, [<span class="hljs-string"><span class="hljs-string">'MA_CLOSE_v2'</span></span>, <span class="hljs-string"><span class="hljs-string">'3'</span></span>, <span class="hljs-string"><span class="hljs-string">'dsD1'</span></span>, <span class="hljs-string"><span class="hljs-string">'1'</span></span>], [<span class="hljs-string"><span class="hljs-string">'STDDEV8_RANGE_MAX_END'</span></span>, <span class="hljs-string"><span class="hljs-string">'10'</span></span>]], [<span class="hljs-string"><span class="hljs-string">'MA_HI_I_v2'</span></span>, <span class="hljs-string"><span class="hljs-string">'8'</span></span>, <span class="hljs-string"><span class="hljs-string">'dsD1'</span></span>, <span class="hljs-string"><span class="hljs-string">'1'</span></span>, <span class="hljs-string"><span class="hljs-string">'invert'</span></span>]]</code> </pre><br>  To create another function of the same type, the pool can be reused without zeroing, which significantly speeds up the work.  Also, the function can be disassembled and create from it a pool that will be used for crossing or mutation functions. <br><br>  This is the third implementation of the algorithm, the first two were not so successful.  It was very useful to get acquainted with the 4th volume of Knut, namely chapter 7.2.1.6 Generation of all trees.  If you need an improved version, be sure to re-read it again.  The disadvantages of this algorithm are: <br><br><ol><li>  We need to make sure that SP1 is capable of generating expressions in the right quantity and variety.  For this, I just have a test that shows that out of 10,000 generated functions, 90% are unique. <br></li><li>  It is also not clear what the distribution of basic functions in the expression. <br></li><li>  I would like to know how many different functions can generate a specific list of basic functions. <br></li><li>  Ps.  This, by the way, is one of those parts of the system where we replaced the whole power of the person‚Äôs analytical mind with the simple function Random ().  The person who creates the robot should already know the answer to the question. <em>How?</em>  this robot will work and <em>why</em> .  The GA here simply serves as an optimized brute force. <br></li></ol><br><h3>  Broadcast to the final form </h3><br>  Next, this LISP-like expression is turned into a listing in SadLobster, where each indivisible expression is a new variable.  The logical expression remains the same. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">DEF_BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">boolA_001</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> invert)</span></span></span><span class="hljs-function"> </span></span>{ DEF_PRICE var_2 = MA_HI_I(<span class="hljs-number"><span class="hljs-number">8</span></span>, dsD1, <span class="hljs-number"><span class="hljs-number">1</span></span>, invert); DEF_PIPS_DOUBLE var_1 = STDDEV8_RANGE_MAX_END(<span class="hljs-number"><span class="hljs-number">10</span></span>); DEF_PRICE var_0 = MA_CLOSE(<span class="hljs-number"><span class="hljs-number">3</span></span>, dsD1, <span class="hljs-number"><span class="hljs-number">1</span></span>); DEF_HPRICE_LEVEL var_3 = MAKE_HPRICE_LEVEL(var_0, var_1); DEF_BOOL var_4 = IS_INSIDE(var_3, var_2); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> var_4; }</code> </pre><br><h3>  SadLobster is not Haskell with pure functions. </h3><br>  Although I aspired to this.  One of the problems that arise when creating a language is error handling.  Immediately, there was a desire to use the mechanism of execs, but MQL does not support them.  The most frequent problem is a failed object.  It would be ideal to use nil values, we will not complicate ahead of time.  This can be improved in future versions.  And in the current implementation, it is simply checked whether the object is valid, if not, then the function ends immediately.  This is done by a macro of type CHECK_LINE_OR_FALSE. <br><br><pre> <code class="cpp hljs">DEF_PERIOD var_1 = makePeriodSinceLastDay(ds); DEF_POINTS var_0 = GetZZPoints(<span class="hljs-number"><span class="hljs-number">5</span></span>, ds, <span class="hljs-number"><span class="hljs-number">0</span></span>); DEF_LINE var_3 = MAKE_SUPPORT(var_0, var_1, <span class="hljs-number"><span class="hljs-number">4</span></span>, !invert); CHECK_LINE_OR_FALSE(var_3);</code> </pre><br><h3>  Expression optimization </h3><br>  Consider the option when the expression looks like this: <br><br><pre> <code class="python hljs">[<span class="hljs-string"><span class="hljs-string">'IS_INSIDE'</span></span>, [<span class="hljs-string"><span class="hljs-string">'MAKE_HPRICE_LEVEL'</span></span>, [<span class="hljs-string"><span class="hljs-string">'GET_MEDIAN_CLOSE_PRICE'</span></span>, [<span class="hljs-string"><span class="hljs-string">'makePeriodToday'</span></span>, <span class="hljs-string"><span class="hljs-string">'ds'</span></span>], <span class="hljs-string"><span class="hljs-string">'ds'</span></span>], //<span class="hljs-number"><span class="hljs-number">1</span></span> [<span class="hljs-string"><span class="hljs-string">'MA_RANGE_v2'</span></span>, <span class="hljs-string"><span class="hljs-string">'7'</span></span>, <span class="hljs-string"><span class="hljs-string">'dsD1'</span></span>, <span class="hljs-string"><span class="hljs-string">'1'</span></span>]], [<span class="hljs-string"><span class="hljs-string">'GET_MEDIAN_CLOSE_PRICE'</span></span>, [<span class="hljs-string"><span class="hljs-string">'makePeriodToday'</span></span>, <span class="hljs-string"><span class="hljs-string">'ds'</span></span>], <span class="hljs-string"><span class="hljs-string">'ds'</span></span>]] //<span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre><br>  Expressions 1 and 2 are the same.  After translating and extracting variables, var_2 is used in both places and no duplication of code. <br><br><pre> <code class="cpp hljs"> DEF_PIPS_DOUBLE var_1 = MA_RANGE(<span class="hljs-number"><span class="hljs-number">7</span></span>, dsD1, <span class="hljs-number"><span class="hljs-number">1</span></span>); DEF_PERIOD var_0 = makePeriodToday(ds); DEF_PRICE var_2 = GET_MEDIAN_CLOSE_PRICE(var_0, ds); DEF_HPRICE_LEVEL var_3 = MAKE_HPRICE_LEVEL(var_2, var_1); DEF_BOOL var_4 = IS_INSIDE(var_3, var_2);</code> </pre><br><h3>  Development requires infrastructure </h3><br>  I wanted to create a very robust base for designing robots.  Analyzing the examples of PBX orders on the freelance exchange, I have embedded new features / requirements from the TOR into the overall system.  So I tried to expand the diversity in the behavior of robots, because the diversity in the code base could lead to the creation of the same algorithmic patterns. <br><br>  At some point, and this is normal, the development emphasis shifted towards the writing of analytical tools, to automate the analysis of what these or other algorithms do.  These are mostly single page scripts of the type: <br><br><ol><li>  Log data to the database while the GA is running </li><li>  Remove from the database and process </li><li>  Display graphically with mathplotlib </li></ol><br>  Here is an example of one of them, shows the result of trading hundreds of robots superimposed on one chart, to assess the distribution of the executed orders. <br><br><img src="https://habrastorage.org/files/2d8/552/59f/2d855259f3a1437581cf5c3dab02fd0b.png"><br><br><h3>  A few words about performance </h3><br>  Testing is very fast for several reasons: <br><br><ul><li>  All robots are compiled into machine code. </li><li>  Testing run multithreaded. </li><li>  Parallel even linking process. </li><li>  From the strategy tester a lot of checks have been cut. </li><li>  Used caching for heavy functions </li><li>  Testing of robots is very rough, there are no scalpers or HFT, the analysis takes place on the hourly charts. </li><li>  I used a 12-thread processor with overclocking up to 4GHz Intel Core i7-5820K for testing. </li></ul><br><h3>  How it works? </h3><br>  I want to clarify that, depending on the settings of the GA, of which there are a lot, you can get robots with diametrically different characteristics.  Suppose that it is important for us to get a robot that will have a positive return on the results of the next year after the training, and made a lot of transactions to evaluate the non-randomness of the results. <br><br>  Let's look at this experiment - we run the GA 15 times, because each GA is a series of very many random events of generation, mutation, crossing and roulette. <br><br>  I want to clarify that Money Management is not used in the works and the trade is conducted with the same minimum volume. <br><br><img src="https://habrastorage.org/files/f48/2e2/cb0/f482e2cb0119477890b5137955414ae0.png"><br><br>  $ 158 is the average profit per month for training, $ 21 is the average profit for the next 12 months.  The results balance around zero profit plus margin of error.  On the other hand, it can be compared with a random robot that will simply lose on the spread.  Do not forget that the game on the stock exchange is a game with a negative amount.  In another period of study, the results are likely to be different. <br><br><h3>  Hepienda will not </h3><br>  It turned out to make GA create robots with a specific task.  This project expanded my understanding and expertise in the topic described above.  And then a terrible thing happened - the goal of the project was achieved.  The project for generating robots is ready.  This article draws a line on the work done. <br><br><h3>  I want to divide the conclusion into two points </h3><br>  <strong>Subjective</strong> - in the course of the work there are a lot of options that could be tested in the framework of this system, for which it was created.  For example: <br><br><ul><li>  Use random data, or not random, to see how the system is trained in intelligible patterns. </li><li>  Expand the arsenal of basic logic by orders of magnitude. </li><li>  Run training on all available data at once. </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Run an experiment in the form of a real evolution, where each iteration at the input is supplied with new data without repetitions. </font></font><br></li></ul><br> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Objective</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - technical analysis of the instrument is like driving a car looking into the rearview mirror. </font><font style="vertical-align: inherit;">A simple pattern for a trading robot could not be found. </font><font style="vertical-align: inherit;">Without a complete market model, it is not clear why certain robots work, and when it will stop. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And most importantly, I see the future of this project in the sandbox format for the development of AI in the field of writing algorithms. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I am pleased to answer your questions, suggestions and comments. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thank you for your time. </font></font><br><br> <a href="https://goo.gl/BsIh57"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">My blog on Medium</font></font></a> </div><p>Source: <a href="https://habr.com/ru/post/316742/">https://habr.com/ru/post/316742/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316732/index.html">Logux: Connection lost, data synchronized - interview with Andrey Sitnik (Evil Martians)</a></li>
<li><a href="../316734/index.html">Personal experience of implementing the GLPI system. Part 2</a></li>
<li><a href="../316736/index.html">The Tale of Cleopatra and Russian Cryptography (Continued)</a></li>
<li><a href="../316738/index.html">Advent of Code 2016</a></li>
<li><a href="../316740/index.html">Efficient storage: as we did from 50 Pb, 32 Pb</a></li>
<li><a href="../316746/index.html">Dual-pane using fragments</a></li>
<li><a href="../316748/index.html">Functional languages ‚Äã‚Äãin hardware design</a></li>
<li><a href="../316750/index.html">Security Week 48: Tech Support Locker, Mirai Mutations, Vulnerability in Firefox and Tor Browser</a></li>
<li><a href="../316752/index.html">The story of a single plugin</a></li>
<li><a href="../316754/index.html">Death transit traffic?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>