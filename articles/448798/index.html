<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Python Testing with pytest. Using pytest with other tools, CHAPTER 7</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Return 


 Typically, pytest is not used on its own, but in a testing environment with other tools. This chapter discusses other tools that are often ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Python Testing with pytest. Using pytest with other tools, CHAPTER 7</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://habr.com/ru/post/448796/">Return</a> </p><br><p>  <em>Typically, pytest is not used on its own, but in a testing environment with other tools.</em>  <em>This chapter discusses other tools that are often used in conjunction with pytest for effective and efficient testing.</em>  <em>Although this is by no means an exhaustive list, the tools discussed here will give you an idea of ‚Äã‚Äãthe taste of pytest mixing power with other tools.</em> </p><br><p><img src="https://habrastorage.org/webt/hd/--/9w/hd--9w134j0rxhmxftrflbbdopy.png"></p><a name="habracut"></a><br><p>  The examples in this book are written using Python 3.6 and pytest 3.2.  pytest 3.2 supports Python 2.6, 2.7 and Python 3.3+. </p><br><blockquote>  The source code for the Tasks project, as well as for all the tests shown in this book, is available via the <a href="https://pragprog.com/titles/bopytest/source_code" title="https://pragprog.com/titles/bopytest/source_code">link</a> on the book's web page at <a href="https://pragprog.com/titles/bopytest" title="https://pragprog.com/titles/bopytest">pragprog.com</a> .  You do not need to download the source code to understand the test code;  The test code is presented in a convenient form in the examples.  But to follow along with the project objectives, or to adapt test examples to test your own project (your hands are untied!), You should go to the book‚Äôs web page and download the work.  In the same place, on the book‚Äôs web page there is a link for <a href="https://pragprog.com/titles/bopytest/errata" title="https://pragprog.com/titles/bopytest/errata">errata</a> messages and a <a href="https://forums.pragprog.com/forums/438" title="https://forums.pragprog.com/forums/438">discussion forum</a> . </blockquote><p>  Under the spoiler is a list of articles in this series. </p><br><div class="spoiler">  <b class="spoiler_title">Table of contents</b> <div class="spoiler_text"><ul><li>  <a href="https://habr.com/ru/post/426699/"><strong>Introduction</strong></a> </li><li>  <a href="https://habr.com/ru/post/448782/"><strong>Chapter 1: Getting Started with pytest</strong></a> </li><li>  <a href="https://habr.com/ru/post/448788/"><strong>Chapter 2: Writing Test Functions</strong></a> </li><li>  <a href="https://habr.com/ru/post/448786/"><strong>Chapter 3: Pytest Fixtures</strong></a> </li><li>  <a href="https://habr.com/ru/post/448792/"><strong>Chapter 4: Builtin Fixtures</strong></a> </li><li>  <a href="https://habr.com/ru/post/448794/"><strong>Chapter 5: Plugins</strong></a> </li><li>  <a href="https://habr.com/ru/post/448796/"><strong>Chapter 6: Configuration</strong></a> </li><li>  [ <strong>Chapter 7: Using pytest with other tools</strong> ] (This article) ( <a href="https://habr.com/ru/post/448798/">https://habr.com/ru/en/post/448798/</a> ) </li></ul></div></div><br><h2 id="pdb-debugging-test-failures">  pdb: Debugging Test Failures </h2><br><p> The <code>pdb</code> module is a Python debugger in the standard library.  You use <code>--pdb</code> to start the pytest debug session at the point of failure.  Let's take a look at <code>pdb</code> in action in the context of the Tasks project. </p><br><p>  In ‚ÄúParameterization Fixture‚Äù on page 64, we left the Tasks project with a few errors: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch3/c/tasks_proj $ pytest --tb=no -q .........................................FF.FFFF FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF.FFF........... 42 failed, 54 passed in 4.74 seconds</code> </pre> <br><p>  Before we look at how <code>pdb</code> can help us debug this test, let's take a look at the available pytest options to speed up the debugging of test errors that we first examined in the ‚ÄúUsing Options‚Äù section on page 9: </p><br><ul><li>  <code>--tb=[auto/long/short/line/native/no]</code> : Controls the trace style. </li><li>  <code>-v / --verbose</code> : Displays all test names passed or not. </li><li>  <code>-l / --showlocals</code> : Display local variables next to the stack trace. </li><li>  <code>-lf / --last-failed</code> : Run only tests that failed. </li><li>  <code>-x / --exitfirst</code> : Stops a test session on the first crash. </li><li>  <code>--pdb</code> : Runs an interactive debugging session at the point of failure. </li></ul><br><hr><br><p>  <em>Installing MongoDB</em> </p><br><hr><br><p>  As mentioned in chapter 3, ‚ÄúPytest Fixtures,‚Äù on page 49, <code>MongoDB</code> and <code>pymongo</code> required to run MongoDB tests. </p><br><p>  I tested the Community Server version found at <a href="https://www.mongodb.com/download-center">https://www.mongodb.com/download-center</a> .  pymongo is installed with <code>pip</code> : <code>pip install pymongo</code> .  However, this is the last example in a book using MongoDB.  To test the debugger without using MongoDB, you can run the pytest commands from <code>code/ch2/</code> , since this directory also contains several failed tests. </p><br><hr><br><p>  We just ran tests from <code>code/ch3/c</code> to make sure that some of them do not work.  We did not see tracebacks or test names, because <code>--tb=no</code> disables tracing, and we didn‚Äôt <code>--tb=no</code> on <code>--verbose</code> .  Let's repeat the mistakes (no more than three) with detailed text: </p><br><pre> <code class="plaintext hljs">$ pytest --tb=no --verbose --lf --maxfail=3 ============================= test session starts ============================= collected 96 items / 52 deselected run-last-failure: rerun previous 44 failures tests/func/test_add.py::test_add_returns_valid_id[mongo] ERROR [ 2%] tests/func/test_add.py::test_added_task_has_id_set[mongo] ERROR [ 4%] tests/func/test_add.py::test_add_increases_count[mongo] ERROR [ 6%] =================== 52 deselected, 3 error in 0.72 seconds ====================</code> </pre> <br><p>  Now we know which tests failed.  Let's look at just one of them, using <code>-x</code> , turning on tracing, not using <code>--tb=no</code> , and showing local variables with <code>-l</code> : </p><br><pre> <code class="plaintext hljs">$ pytest -v --lf -l -x ===================== test session starts ====================== run-last-failure: rerun last 42 failures collected 96 items tests/func/test_add.py::test_add_returns_valid_id[mongo] FAILED =========================== FAILURES =========================== _______________ test_add_returns_valid_id[mongo] _______________ tasks_db = None def test_add_returns_valid_id(tasks_db): """tasks.add(&lt;valid task&gt;) should return an integer.""" # GIVEN an initialized tasks db # WHEN a new task is added # THEN returned task_id is of type int new_task = Task('do something') task_id = tasks.add(new_task) &gt; assert isinstance(task_id, int) E AssertionError: assert False E + where False = isinstance(ObjectId('59783baf8204177f24cb1b68'), int) new_task = Task(summary='do something', owner=None, done=False, id=None) task_id = ObjectId('59783baf8204177f24cb1b68') tasks_db = None tests/func/test_add.py:16: AssertionError !!!!!!!!!!!! Interrupted: stopping after 1 failures !!!!!!!!!!!! ===================== 54 tests deselected ====================== =========== 1 failed, 54 deselected in 2.47 seconds ============</code> </pre><br><p>  Quite often this is enough to understand why the test failed.  In this particular case, it is pretty clear that <code>task_id</code> not an integer ‚Äî it is an ObjectId instance.  ObjectId is the type that MongoDB uses for object identifiers in a database.  My intention with the <code>tasksdb_pymongo.py</code> layer was to hide certain implementation details of MongoDB from the rest of the system.  It is clear that in this case it did not work. </p><br><p>  However, we want to see how to use pdb with pytest, so let's imagine that it is unclear why this test failed.  We can make pytest start a debugging session and start us right at the point of failure with <code>--pdb</code> : </p><br><pre> <code class="plaintext hljs">$ pytest -v --lf -x --pdb ===================== test session starts ====================== run-last-failure: rerun last 42 failures collected 96 items tests/func/test_add.py::test_add_returns_valid_id[mongo] FAILED &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; traceback &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; tasks_db = None def test_add_returns_valid_id(tasks_db): """tasks.add(&lt;valid task&gt;) should return an integer.""" # GIVEN an initialized tasks db # WHEN a new task is added # THEN returned task_id is of type int new_task = Task('do something') task_id = tasks.add(new_task) &gt; assert isinstance(task_id, int) E AssertionError: assert False E + where False = isinstance(ObjectId('59783bf48204177f2a786893'), int) tests/func/test_add.py:16: AssertionError &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; entering PDB &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; &gt; /path/to/code/ch3/c/tasks_proj/tests/func/test_add.py(16) &gt; test_add_returns_valid_id() -&gt; assert isinstance(task_id, int) (Pdb)</code> </pre> <br><p>  Now that we are in the prompt (Pdb), we have access to all the interactive features of pdb debugging.  When viewing failures, I regularly use these commands: </p><br><ul><li>  <code>p/print expr</code> : Prints the value of exp. </li><li>  <code>pp expr</code> : Pretty prints the value of expr. </li><li>  <code>l/list</code> : Lists the point of failure and five lines of code above and below. </li><li>  <code>l/list begin,end</code> : Lists specific line numbers. </li><li>  <code>a/args</code> : Prints the arguments of the current function with their values. </li><li>  <code>u/up</code> : Moves up one level on the stack path. </li><li>  <code>d/down</code> : Moves down one level in the stack trace. </li><li>  <code>q/quit</code> : Terminates the debug session. </li></ul><br><p>  Other navigation commands, such as step and next, are not very useful, as we sit directly in the assert statement.  You can also just enter the variable names and get the values. </p><br><p>  You can use <code>p/print expr</code> similarly to the <code>-l/--showlocals</code> to view the values ‚Äã‚Äãin the function: </p><br><pre> <code class="plaintext hljs">(Pdb) p new_task Task(summary='do something', owner=None, done=False, id=None) (Pdb) p task_id ObjectId('59783bf48204177f2a786893') (Pdb)</code> </pre> <br><p>  Now you can exit the debugger and continue testing. </p><br><pre> <code class="plaintext hljs">(Pdb) q !!!!!!!!!!!! Interrupted: stopping after 1 failures !!!!!!!!!!!! ===================== 54 tests deselected ====================== ========== 1 failed, 54 deselected in 123.40 seconds ===========</code> </pre> <br><p>  If we didn't use <code>-</code> , pytest would open Pdb again in the next test.  More information about using the pdb module is available in the <a href="https://docs.python.org/3/library/pdb.html">Python documentation</a> . </p><br><h2 id="coveragepy-opredelenie-obema-testiruemogo-koda">  Coverage.py: Determining the amount of code under test </h2><br><p>  Code coverage is an indication of what percentage of code being tested is tested by a test suite.  When you run tests for the Tasks project, some Tasks functions are performed with each test, but not with all. </p><br><p>  Code coverage tools are great for letting you know which parts of the system are completely missing from the tests. </p><br><p>  <code>Coverage.py</code> is the preferred Python coverage tool that measures code coverage. </p><br><p>  You will use it to check the Tasks project code using pytest. </p><br><p>  To use <code>coverage.py</code> you need to install it.  It <code>pytest-cov</code> n't hurt to install a plugin called <code>pytest-cov</code> , which allows you to call <code>coverage.py</code> from pytest with some additional pytest options.  Since <code>coverage</code> is one of the dependencies of <code>pytest-cov</code> , it is enough to install <code>pytest-cov</code> and it will attract <code>coverage.py</code> : </p><br><pre> <code class="plaintext hljs">$ pip install pytest-cov Collecting pytest-cov Using cached pytest_cov-2.5.1-py2.py3-none-any.whl Collecting coverage&gt;=3.7.1 (from pytest-cov) Using cached coverage-4.4.1-cp36-cp36m-macosx_10_10_x86 ... Installing collected packages: coverage, pytest-cov Successfully installed coverage-4.4.1 pytest-cov-2.5.1</code> </pre> <br><p>  Let's run a coverage report for the second version of the tasks.  If you still have the first version of the Tasks project installed, uninstall it and install version 2: </p><br><pre> <code class="plaintext hljs">$ pip uninstall tasks Uninstalling tasks-0.1.0: /path/to/venv/bin/tasks /path/to/venv/lib/python3.6/site-packages/tasks.egg-link Proceed (y/n)? y Successfully uninstalled tasks-0.1.0 $ cd /path/to/code/ch7/tasks_proj_v2 $ pip install -e . Obtaining file:///path/to/code/ch7/tasks_proj_v2 ... Installing collected packages: tasks Running setup.py develop for tasks Successfully installed tasks $ pip list ... tasks (0.1.1, /path/to/code/ch7/tasks_proj_v2/src) ...</code> </pre> <br><p>  Now that the next version of the tasks is installed, you can run a baseline coverage report: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch7/tasks_proj_v2 $ pytest --cov=src ===================== test session starts ====================== plugins: mock-1.6.2, cov-2.5.1 collected 62 items tests/func/test_add.py ... tests/func/test_add_variety.py ............................ tests/func/test_add_variety2.py ............ tests/func/test_api_exceptions.py ......... tests/func/test_unique_id.py . tests/unit/test_cli.py ..... tests/unit/test_task.py .... ---------- coverage: platform darwin, python 3.6.2-final-0 ----------- Name Stmts Miss Cover -------------------------------------------------- src\tasks\__init__.py 2 0 100% src\tasks\api.py 79 22 72% src\tasks\cli.py 45 14 69% src\tasks\config.py 18 12 33% src\tasks\tasksdb_pymongo.py 74 74 0% src\tasks\tasksdb_tinydb.py 32 4 88% -------------------------------------------------- TOTAL 250 126 50% ================== 62 passed in 0.47 seconds ===================</code> </pre> <br><p>  Since the current directory is <code>tasks_proj_v2</code> , and the source code under test is in src, adding the option <code>--cov=src</code> creates a coverage report only for this directory being tested. </p><br><p>  As you can see, some files are quite low and even 0% coverage.  These are useful reminders: <code>tasksdb_pymongo.py</code> 0%, because we have disabled testing for MongoDB in this version.  Some of them are pretty low.  The project will certainly have to put tests for all these areas before it is ready for prime time. </p><br><p>  I believe that several files have a higher percentage of coverage: <code>api.py</code> and <code>tasksdb_tinydb.py</code> .  Let's look at <code>tasksdb_tinydb.py</code> and see what's missing.  I think the best way to do this is to use HTML reports. </p><br><p>  If you run <code>coverage.py</code> again with the <code>--cov-report=html</code> parameter, an <code>--cov-report=html</code> will be generated: </p><br><pre> <code class="plaintext hljs">$ pytest --cov=src --cov-report=html ===================== test session starts ====================== plugins: mock-1.6.2, cov-2.5.1 collected 62 items tests/func/test_add.py ... tests/func/test_add_variety.py ............................ tests/func/test_add_variety2.py ............ tests/func/test_api_exceptions.py ......... tests/func/test_unique_id.py . tests/unit/test_cli.py ..... tests/unit/test_task.py .... ---------- coverage: platform darwin, python 3.6.2-final-0 ----------- Coverage HTML written to dir htmlcov ================== 62 passed in 0.45 seconds ===================</code> </pre> <br><p>  You can then open <code>htmlcov/index.html</code> in a browser that shows the output on the following screen: </p><br><p><img src="https://habrastorage.org/webt/vs/sc/84/vssc84hovxefvf2g65740gu3ll0.png"></p><br><p>  Clicking on <code>tasksdb_tinydb.py</code> will display a report for one file.  The top of the report shows the percentage of covered lines, plus how many lines are covered and how many are not, as shown in the following screen: </p><br><p><img src="https://habrastorage.org/webt/os/pc/-o/ospc-o_yzzdfh1lzllw_1qtilrc.png"></p><br><p>  Scrolling down, you can see the missing lines, as shown in the following screen: </p><br><p><img src="https://habrastorage.org/webt/85/rg/lt/85rgltocwrunycedzbeweix4zyc.png"></p><br><p>  Even if this screen is not the complete page for this file, it is enough to tell us that: </p><br><ol><li>  We do not test <code>list_tasks()</code> with an established owner. </li><li>  We do not test <code>update()</code> or <code>delete()</code> . </li><li>  Perhaps we are not thoroughly testing <code>unique_id()</code> . </li></ol><br><p>  Fine.  We can include them in our TO-DO testing list along with configuration system testing. </p><br><p>  Although code coverage tools are extremely useful, striving for 100% coverage can be dangerous.  When you see code that is not tested, it may mean that a test is needed.  But it can also mean that there are some functions of the system that are not needed and can be deleted.  Like all software development tools, code coverage analysis does not replace thinking. </p><br><p>  More information can be found in the <a href="https://coverage.readthedocs.io/"><code> coverage.py</code></a> and <a href="https://pytest-cov.readthedocs.io/"><code>pytest-cov</code></a> . </p><br><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://habr.com/ru/post/448796/">Return</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/448798/">https://habr.com/ru/post/448798/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../448788/index.html">Python Testing with pytest. Chapter 2, Writing Test Functions</a></li>
<li><a href="../448790/index.html">SpaceVIL - cross-platform GUI framework for development on .Net Core, .Net Standard and JVM</a></li>
<li><a href="../448792/index.html">Python Testing with pytest. Builtin Fixtures, Chapter 4</a></li>
<li><a href="../448794/index.html">Python Testing with pytest. Plugins, CHAPTER 5</a></li>
<li><a href="../448796/index.html">Python Testing with pytest. Configuration, CHAPTER 6</a></li>
<li><a href="../448806/index.html">Creating an extension system on the Qt library</a></li>
<li><a href="../448810/index.html">How I caught a hacker</a></li>
<li><a href="../448812/index.html">Lunar mission ‚ÄúBereshit‚Äù - the search for the first lunar library started after the accident of its carrier</a></li>
<li><a href="../448814/index.html">Bosque language is a new programming language from Microsoft</a></li>
<li><a href="../448828/index.html">Tesla's transformer with printed coils, soldered three components - and ready</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>