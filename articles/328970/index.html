<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Building a modular architecture of the application on Forwarding decorators (author's translation)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When a developer plans the architecture of his future web application, it is useful to think about its extensibility in advance. The modular architect...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Building a modular architecture of the application on Forwarding decorators (author's translation)</h1><div class="post__text post__text-html js-mediator-article">  When a developer plans the architecture of his future web application, it is useful to think about its extensibility in advance.  The modular architecture of the application can provide a good degree of extensibility.  There are quite a few ways to implement such an architecture, but all of them are similar in their fundamental principles: the separation of concepts, self-sufficiency, mutual compatibility of all components. <br><br>  However, there is one approach that can be found quite rarely in PHP.  It includes the use of native inheritance and allows you to patch the code "more better" (c).  We call this method ‚ÄúForwarding Decorator‚Äù.  It seems to us quite effective, and, by the way, spectacular too, although the latter is not so important in production. <br><br>  As the author of the original English-language article " <a href="https://www.sitepoint.com/achieving-modular-architecture-with-forwarding-decorators/">Achieving Modular Architecture with Forwarding Decorators</a> ", published on SitePoint, I present to you the author's version of the translation. <a name="habracut"></a>  In it, I kept the originally conceived meaning and idea, but I tried to improve the flow as much as possible. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Introduction </h3><br>  In this article, we will look at the implementation of the approach using Forwarding Decorator, as well as its pros and cons.  Let's compare this approach with other well-known alternatives, namely with the use of hooks, code patching or DI (dependency injection).  For clarity, there is a demo application <a href="https://github.com/sitepoint-editors/decorators-demo">here in this GitHub repository</a> . <br><br>  The basic idea is to treat each class as a service, and modify this service by inheriting and reversing the chain of heirs when compiling code. <br><br>  In a system based on such an idea, in any module you can create a special decorator class (marked in a special way).  Such a class will receive fields and methods of another class through the inheritance mechanism, but after compilation it will be used everywhere instead of the original class. <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/60f/947/be1/60f947be1acdb9acebf72734e996af96.png" alt="image"></div>  Actually, this is why we call such classes Forwarding decorators: these decorators are a superstructure over the original implementation, but they are being pushed forward at the places of use. <br><br>  The advantages of this approach are obvious: <br><br><ul><li>  Any part of the system can be extended with the help of a module - any class, any public / protected method.  No need to pre-mark the extension points with a special code. </li><li>  One subsystem can be modified by several modules at the same time. </li><li>  Subsystems are weakly interconnected, so they can be updated separately, independently of each other. </li><li>  You can limit extensibility using familiar constructs: private methods and private (final) classes. </li></ul><br>  However, this approach also has its disadvantages: <br><br><ul><li>  First of all, it is the lack of clear interfaces of interaction with the expandable system.  We can expand everything that is not explicitly prohibited through private, but the system can not expect that it was entered from the wrong end and will work inadequately in cases that the developer of the module did not think about.  You need to carefully inspect the code for unwanted side effects. </li><li>  You will have to implement a kind of compiler (details below). </li><li>  When developing modules, one should strictly observe the public interface of the subsystems and not violate <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B8%25D0%25BD%25D1%2586%25D0%25B8%25D0%25BF_%25D0%25BF%25D0%25BE%25D0%25B4%25D1%2581%25D1%2582%25D0%25B0%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B8_%25D0%2591%25D0%25B0%25D1%2580%25D0%25B1%25D0%25B0%25D1%2580%25D1%258B_%25D0%259B%25D0%25B8%25D1%2581%25D0%25BA%25D0%25BE%25D0%25B2">the Liskov substitution principle</a> , otherwise these modules will break the system. </li><li>  The presence of an additional compiler complicates debugging code.  You cannot run XDebug directly on the source code; any change to the code first requires running the compiler.  However, this problem can be solved using tricky PHP tricks so that the compiled files will run, but you will see the source code in the debugger. </li></ul><br>  This way of expanding the system is in some sense an intermediate solution between direct code patching (low-level, no rules of the game, god mode, greatest power but with greatest responsibility, etc.) and plug-in-based architecture, with a clear definition of how may be a plugin, which subsystems and how it can change \ provide.  The system of decorators allows to solve a certain range of tasks well, but this is not a silver bullet at all and is not an ideal way to organize modularity. <br><br><h3>  How can such a system be used? </h3><br>  Here is an example: <br><br><pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'baz'</span></span>; } }</code> </pre> <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Module1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *    ,    DecoratorInterface ( :    ,   ) */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModifiedFoo</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DecoratorInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::bar(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">' modified'</span></span>; } }</code> </pre><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// ... -    $object = new Foo(); $object-&gt;bar(); // will echo 'baz modified'</span></span></code> </pre><br>  How did that happen?  This is street magic) We are turning the chain of inheritance back.  The original class is without internal code.  As a result of the compilation, we preprocess the code so that the contents of the original class go into a separate class, which will be the new parent for the chain: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//    ,   ,     class Foo extends \Module1\ModifiedFoo { // move the implementation from here to FooOriginal }</span></span></code> </pre><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Module1</span></span>; <span class="hljs-comment"><span class="hljs-comment">//     ,         abstract class ModifiedFoo extends \FooOriginal implements \DecoratorInterface { public function bar() { parent::bar(); echo ' modified'; } }</span></span></code> </pre><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//      .        class FooOriginal { public function bar() { echo 'baz'; } }</span></span></code> </pre><br>  In short, a compiler is built into the application, which builds intermediate classes, and an autoloader, which will load these intermediate classes instead of the original ones. <br><br>  And now a little more.  The compiler builds a list of all classes used in the system, and for each class that is not a decorator, it finds all the subclasses that will decorate it using <b>DecoratorInterface</b> .  It creates a tree of decorators, checks if there are no cycles, sorts the decorators by their priority about this in more detail later) and builds intermediate classes where the inheritance chain will be reversed.  The source code is converted to a new class, which will become the new parent class for the inheritance chain. <br><br>  It sounds hard.  So it is, it is really a complex system.  However, it allows very flexible combination of modules, and with the help of these modules you can modify absolutely any part of your application. <br><br><h3>  And if one class is rewritten by several modules? </h3><br>  If several decorators come into play at the same time, they fall into the chain of decoration according to their priority.  Priority can be set using annotations (we use Doctrine \ Annotations) or configs. <br><br>  Consider an example: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'baz'</span></span>; } }</code> </pre><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Module1</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DecoratorInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::bar(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">' modified'</span></span>; } }</code> </pre><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Module2</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Decorator</span></span></span><span class="hljs-comment">\After("Module1") */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DecoratorInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::bar(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">' twice'</span></span>; } }</code> </pre><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// ... -    $object = new Foo(); $object-&gt;bar(); //  'baz modified twice'</span></span></code> </pre><br>  In this example, the <b>Decorator \ After</b> annotation is used to put the decorator of another Module 1 in front of Module 2. The compiler will analyze the files, take into account the annotations and build an intermediate class with this inheritance chain: <br><img src="https://habrastorage.org/getpro/habr/post_images/301/74a/0a4/30174a0a46ddff8e37ecfb190247a32c.png" alt="image"><br>  You can also use the following annotations: <br><br><ul><li>  <b>Decorator \ Before</b> (to place the decorator in front of the decorators of another module or higher in weight) </li><li>  <b>Decorator \ Depend</b> (to enable the decorator, only if the specified module is enabled in the system) </li></ul><br>  This set of annotations (Before, After, Depend) is absolutely enough to build any combination of modules and classes. <br><br><h3>  Are there any working examples? </h3><br>  There is!  For clarity, I have prepared an application demo, it is located <a href="https://github.com/sitepoint-editors/decorators-demo">in this GitHub repository</a> .  This PHP application has a modular architecture, and modules can mix in code without recompilation.  In this case, the modules can be added and removed, but in this case, recompilation is already required.  In more detail all this is described in the <a href="">readme</a> file. <br><br>  There are quite "combat" examples.  There are already several software products on the market that use this approach.  In particular, something very similar is used in OXID eShop.  By the way, they have a <a href="https://oxidforge.org/en/developing-email-templates-for-oxid-eshop.html">cool blogging style</a> .  In another platform, X-Cart 5, this approach is implemented exactly in the form in which I described it - the <a href="https://www.x-cart.com/features.html">X-Cart 5</a> code was even taken as a basis for this article.  This allowed us to create a very flexible e-commerce solution, which can be expanded as far as the developer‚Äôs imagination (or customer‚Äôs money =) suffices, and without breaking subsequent kernel upgrades. <br><br><h3>  Hooks and patches are better!  Or not? </h3><br>  As with the Forwarding Decorators approach, using hooks and head-on patching has its pros and cons. <br><br><ul><li>  <b>Hooks</b> (or any implementation of the Observer template) are widely used in many popular applications, such as Wordpress.  Among the advantages is a well-defined API, a transparent way to register an Observer.  The biggest drawback is the limited number of entry points for embedding extensions, also the inconvenience is the order of execution (it is difficult to rely on the result of other hooks) <br><br></li><li>  <b>Patching in the forehead</b> is the most trivial and obvious way of expansion, but it seems to us quite risky.  Firstly, it significantly complicates the reading and analysis of the code, secondly, it complicates the rollback of changes in case of their incorrectness.  Also, the imposition of several patches at the same time is complicated so that they do not contradict each other and do not break the functionality.  In other words, this is the least controlled and controlled way, and if it justifies itself in simple solutions, then with the complication of the system, these disadvantages grow in proportion to its complexity. <br><br></li><li>  <b>Dependency Injection</b> - the code in the system with DI is built around the understanding that the necessary dependencies are not obtained manually, but are delivered from somewhere outside, or they are accessed indirectly - again through some supplier (most often it is some kind of IoC container). <br><br>  Dependencies satisfy some interface and are a complete implementation of some functionality.  Through the extension system, one implementation of the dependency can be substituted for another based on the current system configuration. <br><br>  Implementations can be inherited from the base or decorated in the classical sense of the decorator - as in Symfony 2, for example, <a href="http://symfony.com/doc/current/service_container/service_decoration.html">as described here</a> .  The problem with this architecture is that all code must be built using DI-style dependencies.  The difference from the system described in the article is that the forwarding decorator allows you to replace the classes completely transparent at all points of use. <br><br>  In addition, it is not clear how to organize the composition of several modules that extend the same service - you will have to write a separate system, since popular IoC containers do not solve this problem (this is outside the responsibility of such libraries). <br></li></ul><br><h3>  Conclusion </h3><br>  Forwarding decorators are an approach that at least deserves attention.  It can be used to solve the problem of developing an extensible modular architecture of applications in PHP.  This will use familiar constructs, such as inheritance or the field of view of fields / methods / classes. <br><br>  Implementing such a concept is not a trivial task, there may be difficulties with debugging, but they are surmountable provided that you spend some time properly setting up the compiler. <br><br>  If there is interest in this material, in the next article I will write how to make an optimal compiler with an autoloader and use streaming filters (PHP Stream filters) to enable step-by-step debugging of the source code via XDebug.  Interesting?  Let us know in the comments.  And I will be happy for your questions, advice and constructive criticism. </div><p>Source: <a href="https://habr.com/ru/post/328970/">https://habr.com/ru/post/328970/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328958/index.html">Network microsegmentation in examples: how this cleverly twisted thing reacts to different attacks</a></li>
<li><a href="../328960/index.html">Ionic 2 vs React Native: a comparison of frameworks for creating corporate mobile applications</a></li>
<li><a href="../328962/index.html">Android and architecture</a></li>
<li><a href="../328964/index.html">Analysis of errors in the seller</a></li>
<li><a href="../328966/index.html">How are developed industry and specialized solutions for 1C: ERP</a></li>
<li><a href="../328972/index.html">Nice to meet you. LANIT</a></li>
<li><a href="../328974/index.html">Top designs by Behance users</a></li>
<li><a href="../328976/index.html">Scheduling: myths and reality. Yandex experience</a></li>
<li><a href="../328978/index.html">How and why to create a NginX module - theory, practice, profit</a></li>
<li><a href="../328980/index.html">When you need a corporate app store</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>