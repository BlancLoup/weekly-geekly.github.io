<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tale of sysctl (penguin folk story)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Very often, administrators configure the system simply by setting up basic things - ip, dns, hostname, install software, and everything else is applic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tale of sysctl (penguin folk story)</h1><div class="post__text post__text-html js-mediator-article">  Very often, administrators configure the system simply by setting up basic things - ip, dns, hostname, install software, and everything else is application settings.  In most cases this is the case, since in linux there are very reasonable defaults and, in most cases, these defaults are enough and everyone lives happily.  Among the very beginners there are legends about some sysctl'yah, and those who are more experienced and even ruled something. <br><br>  But the moment comes when the admin in his campaigns on the system meets this beast - sysctl.  Most likely, he meets someone from the net.ipv4 or vm family, even most likely net.ipv4.ip_forward, if the hike is behind a router or vm.swappinness, if he is concerned about a grown-up swap of his penguin.  The first beast allows the penguin to accept packets from one wing and give to others (allows routing), and the second helps to cope with the use of swap in a quiet system and to regulate its use - in a loaded one. <br><br><img src="https://habrastorage.org/webt/59/ef/60/59ef60ae73130650626622.jpeg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>  A meeting with any of these ‚Äúanimals‚Äù opens the gates to a whole world of system settings and kernel components, there are several families, the names of most of which speak for themselves: net ‚Äî the network;  kern is the core;  vm - memory and caches.  But this is all a ‚Äúfairy tale‚Äù, the reality is much more interesting. <br><br>  Having got acquainted with this configuration of settings, an inexperienced administrator, like a moth into the world, flies and wants, rather, rather, to set them all up, to make the system better and more optimal.  Oh yeah!  His temptation is great and the goal is good, but the chosen path sometimes leads to a completely different direction.  The name of that way is ‚Äúgoogle-tuning‚Äù. <br><br>  After all, what a temptation to quickly google ‚Äúthe optimal sysctl settings‚Äù and apply some recipe from the beginning of the article without really going into what is written below - ibid TL; DR.  In most cases, the system does not get any worse, because the load or configuration is not the way for problems to surface.  Later, with experience, digging into the system settings for a particular case, you will understand that this is some kind of nonsense was written. <br><br>  Here, for example, the parameters net.ipv4.tcp_mem, rmem, wmem - look very similar, three numbers like ‚Äú4096 87380 6291456‚Äù, but that's bad luck, for [rw] mem these are bytes, and for mem these are pages and, if if all three parameters are given the same value, then there will be an ‚Äúexplosive‚Äù configuration, since  tcp_mem is responsible for managing the memory consumed by tcp, and [rw] mem for socket buffers. <br><br>  And there are sysctl'i which, until you meet and do not ogrebsh - you do not think about what this sysctl, as, for example, net.ipv4.conf.all.rp_filter.  The worst thing that shoots only when you have a need to do asymmetric routes, that is, your router has a 2+ interface and traffic can come from one interface, and return through another, that is, quite rarely.  Called Reverse Path Filtering, blocks packets that come from an address that is not routed through the interface from where they come from. <br>  There are some very useful parameters, but they require careful study of documentation and calculations to find out how they can help you in your particular situation.  I repeat that the defaults in linux are good enough.  This is especially true for tcp settings and the network as a whole. <br><br>  The parameters that have to be played often enough are: <br><br>  <b>vm.swappiness</b> - setting the aggressiveness of ‚Äúdropping out‚Äù memory.  This is necessary in order to keep as much RAM as possible available for applications and operation.  In the default value of 60, the system transfers into swap those pages of memory that have not been used for some long time, in the value 0 or 1, the system tries to use a swap only when it cannot allocate physical memory or when the amount of available memory goes to the specified in vm.min_free_kbytes.  This is not to say that the use of a swap is definitely good or bad.  It all depends on the situation and the profile of memory usage, and this knob allows us to control the system's attitude to the swap from 0 - I don‚Äôt like it at all, up to 100 - oh yeah, sooooop! <br><br>  <b>vm.min_free_kbytes</b> - (since already mentioned in vm.swappiness) Determines the minimum amount of free memory that must be maintained.  If set too small - the system will break; if too large, the OOM (Out Of Memory) killer will often come. <br><br>  <b>vm.overcommit_memory</b> - allows / prohibits ‚Äúallocating‚Äù more memory than is: 0 - the system checks each time whether there is enough free memory;  1 - the system always assumes that there is memory and allows allocation while the memory is really there;  2 - prohibit asking for more memory than there is - you can allocate no more than RAM + SWAP.  This may fire when you have an application, for example redis, which consumes&gt; ¬Ω of memory and decides to write data to disk, for which it forks and copies all the data, but because the available memory may not be enough - either the recording may break on the disk or come oom and kill something you need. <br><br>  <b>net.ipv4.ip_forward</b> - enable or <b>disable</b> packet routing.  With the need to twist this handle, we are faced when setting up the router.  Everything is more or less clear: 0 - turn off;  1 - enable. <br><br>  <b>net.ipv4. {all, default, interface} .rp_filter</b> - controls the Reverse Path Filtering option: 0 - do not check, disable;  1 - ‚Äústrict‚Äù mode, when packets are discarded, the answers that would not leave through the interface from which the packet came;  2 - ‚Äúrelaxed‚Äù mode - only those packets are rejected, the route to which is unknown (if there is a default route, in my opinion, it should lead to the same effect as 0). <br><br>  <b>net.ipv4.ip_local_port_range</b> - defines the minimum and maximum ports that is used to create a local client socket.  If your system makes a large number of calls to network resources, then you may have a problem of lack of local ports for setting up connections.  This parameter allows you to adjust the range of ports that is used to establish client connections.  It can also be useful in order to secure your services that ‚Äúlisten‚Äù to high ports. <br><br>  <b>net.ipv4.ip_default_ttl</b> is the default packet lifetime (TTL).  It may be necessary when you need to mislead the CC operator when using your phone as a modem, or when you need to make sure that the packets from this host do not go beyond the perimeter of the network. <br><br>  <b>net.core.netdev_max_backlog</b> - adjusts the size of the packet queue between the network card and the kernel.  If the kernel does not have time to process packets and the queue is full, then new packets are discarded.  you may need to tweak in certain situations to cope with <b>peak</b> loads and not experience network problems. <br><br>  Below are two parameters responsible for the queue of connections, that is, TCP.  These two parameters are primarily subjected to tuning on the loaded web-services, in the case when problems arise. <br><br>  To understand, you need to know how connections work in tcp: <br><br><ol><li>  The program opens the listening socket: socket () -&gt; listen ().  As a result, it receives, for example *: 80 (port 80 on all interfaces). </li><li>  The client establishes a connection: a) sends a syn-packet to the server (this is where tcp_max_syn_backlog works);  b) receives a syn-ack from the server;  c) sends ack to the server (and somaxconn is already working here) </li><li>  Through the accept call, the connection is processed and passed to the process for working with a specific client. </li></ol><br>  <b>net.core.somaxconn</b> - the size of the queue of established connections of pending accept ().  If we have small peaks of load on the application - perhaps you can help increase this parameter. <br><br>  <b>net.ipv4.tcp_max_syn_backlog</b> is the size of the queue of <b>not established connections</b> . <br><br>  For most TCP settings, as well as, actually, all the others, an understanding of the mechanisms that govern these settings is required. <br>  For example, how tcp transmits data.  Since this protocol ‚Äúguarantees delivery‚Äù, it requires confirmation of the delivery from the second side of the connection.  These acknowledgments are called ACKnoweledgement.  Confirms the received range of bytes.  We also know that we can transfer data to the network in blocks equal to the MTU size (even, for simplicity, 1500 bytes), and we need to transfer more, say 1500000 bytes, that is, 1000 frames, the data will be fragmented.  If we have a server on the same network at a distance of one patch cord from each other, we will not notice any problems, but if we are sharing with a remote system, then waiting for confirmation of each packet is very long, because we have to wait until THERE our package will come and from there the confirmation of receipt will return it will greatly affect the data transfer rate.  To resolve this issue, tcp_window was entered, the size of which is allocated 16 bits in the tcp header.  Roughly speaking, this is the number of bytes that we can send without confirmation.  In 16 bits, we can store a value of a maximum of 2 ^ 16 = 65536 (65Kb), which in our age of multi-gigabit networks is not much at all. <br><br>  To understand how we can transfer data, say, from Moscow to Novosibirsk (RTT (Round Trip Time) = 50ms) via the 1Gbit channel, let's do a few calculations (below are VERY rough calculations). <br><ol><li>  Without tcp_window.  It turns out that we can only send 1500 bytes to .05s, 1500 / 0.05 = 30,000 bytes / second.  Not enough, despite the fact that the channel speed is 1Gbit / s, which is roughly equal to 100Mb / s.  ~ 30Kb / s vs ~ 100Mb / s - there is a problem, we do not recycle the available band. </li><li>  With tcp_window equal to 65536 (the maximum that can be specified in the header).  Those.  we can immediately send all our 65K.  65536 / 0.05 = 1310720 = 1.25Mb / s.  1.25Mb / s vs ~ 100Mb / s is still not enough, the difference is about 80 times. </li><li>  So how much do we need in order to dispose of at least 900Mbit?  carry out the inverse calculations.  (900000000/8) b / s * 0.05s = 5625000b ~ = 5.36 Mb.  This is the window size we need to efficiently transfer data.  But since we have a very long link, we may have problems there =&gt; losses.  This will also affect throughput.  In order to be able to notify about the size of a window larger than 65K through a 16-bit field, the tcp_window_scaling option was introduced. </li></ol><br>  <b>net.ipv4.tcp_window_scaling</b> - 0 - disables window scaling;  1 - includes window scaling.  This should be supported on both sides and serves to optimize the use of a channel band. <br><br>  But it is not enough to be able to specify a window larger than 65K, you also need to be able to keep all the necessary data in memory allocated for the socket, in our case in tcp_buffer: <br><br>  <b>net.ipv4.tcp_wmem, net.ipv4.tcp_rmem</b> ‚Äî the Read and Write settings of the buffers look the same.  These are three numbers in bytes, ‚Äúmin default max‚Äù is the minimum guaranteed buffer size, the default size and the maximum size, which the system will not increase to a buffer.  It is worthwhile to approach the setting of these parameters with an understanding of how many connections you expect, how much data you intend to transfer and how slow your clients / servers are. <br><br>  <b>net.ipv4.tcp_mem</b> ‚Äî tcp stack memory management settings.  3 numbers in PAGES ‚Äúmin pressure max‚Äù, which describe: min - the threshold of memory use by buffers below which the system will not care about the displacement of buffers;  pressure - threshold at which the system will take care of reducing memory consumption by buffers, as long as it is possible;  max - threshold at which memory will not be allocated and buffers will not be able to grow. <br><br>  Sometimes applications fall, so to speak, ‚Äúinto the crust‚Äù.  This crust (‚Äúmemory dump‚Äù) can be used to debug a problem with gdb.  A thing is definitely useful when set up.  By default, the coredump is saved to the faceless core file in the working directory of the application, it may be accompanied by the pid of the application, but you can make everything much more convenient: <br><br>  <b>kernel.core_pattern</b> - allows you to specify the format of the name (and path) that will be used to save the core dump.  For example, ‚Äú/var/core/%E.%t.%p‚Äù will save the ‚Äúcrust‚Äù to the / var / core / directory using the full path in the name to the program that fell (replacing / on!) And adding timestamp events and pid applications.  You can even redirect the core to an external analysis program.  More details can be found in man 5 core. <br><br>  This is all just the tip of the iceberg, if you describe everything in more detail - you can write a whole book. <br><br>  Good luck in the console. <br><br>  Here is such a small note that we have prepared as part of our course " <a href="https://otus.pw/1ccIiq4I/">Linux Administrator</a> ".  The topic was chosen by our listeners with a vote, so we hope that the note will be interesting and useful for you. </div><p>Source: <a href="https://habr.com/ru/post/340870/">https://habr.com/ru/post/340870/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340858/index.html">As I stopped worrying and started cutting rectangles in Unity correctly</a></li>
<li><a href="../340860/index.html">Forward to the past: IT departments of companies 2018</a></li>
<li><a href="../340862/index.html">Linux Piter # 3: what about this time?</a></li>
<li><a href="../340866/index.html">Google Forms: we fix event of sending the form in Google Analytics</a></li>
<li><a href="../340868/index.html">Design for iPhone X. Guidelines for iOS 11</a></li>
<li><a href="../340872/index.html">Cloud Digest: about technologies, SSL certificates and IaaS provider operation</a></li>
<li><a href="../340874/index.html">‚ÄúActive Search‚Äù: how we chose the search engine for the DLP system</a></li>
<li><a href="../340876/index.html">Check whether the service pack is present on the system before installation</a></li>
<li><a href="../340878/index.html">Exantech Code Jam: Hacktoberfest 2017</a></li>
<li><a href="../340880/index.html">Bad Rabbit: a new wave of attacks using a ciphering virus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>