<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Serverless application with AWS and Bitbucket Pipelines CI / CD implementation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is about deploying a Django application in the AWS cloud using Bitbucket Pipelines. For those who are interested in this topic, welcome u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Serverless application with AWS and Bitbucket Pipelines CI / CD implementation</h1><div class="post__text post__text-html js-mediator-article">  This article is about deploying a Django application in the AWS cloud using Bitbucket Pipelines.  For those who are interested in this topic, welcome under cat. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/445/0fd/209/4450fd2092d42c04d341f1ab3c73a9c5.jpg" alt="image"></div><br>  Go on the mines! <br><a name="habracut"></a><br><h4>  Creating an application framework </h4><br>  The project is a typical Django application.  The only difference is that the application settings will be pulled through environment variables.  The repository of the project is on the beatback.  To create a similar one, install the requirements from the list: <br><br><pre><code class="hljs swift">zappa==<span class="hljs-number"><span class="hljs-number">0.45</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> django-rest-swagger==<span class="hljs-number"><span class="hljs-number">2.1</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span> djangorestframework==<span class="hljs-number"><span class="hljs-number">3.7</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span> django-<span class="hljs-built_in"><span class="hljs-built_in">filter</span></span>==<span class="hljs-number"><span class="hljs-number">1.1</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">Django</span></span>==<span class="hljs-number"><span class="hljs-number">2.0</span></span> psycopg2==<span class="hljs-number"><span class="hljs-number">2.7</span></span>.<span class="hljs-number"><span class="hljs-number">3.2</span></span> django-storages==<span class="hljs-number"><span class="hljs-number">1.6</span></span>.<span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre> <br>  As you can see, a typical set of dependencies for building a REST API and connecting PostgreSQL.  Next we go through the steps of creating a typical Django application.  Add to the project settings the settings for connecting to the database and placing statics on S3. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="python hljs">STATICFILES_STORAGE = <span class="hljs-string"><span class="hljs-string">'storages.backends.s3boto3.S3Boto3Storage'</span></span> DEFAULT_FILE_STORAGE = <span class="hljs-string"><span class="hljs-string">'storages.backends.s3boto3.S3Boto3Storage'</span></span> <span class="hljs-comment"><span class="hljs-comment">##################################### # ENV VARIABLES ##################################### RDS_DB_NAME = os.environ.get('RDS_DB_NAME') RDS_USERNAME = os.environ.get('RDS_USERNAME') RDS_PASSWORD = os.environ.get('RDS_PASSWORD') RDS_HOSTNAME = os.environ.get('RDS_HOSTNAME') RDS_PORT = os.environ.get('RDS_PORT') S3_BUCKET = os.environ.get('S3_BUCKET') ##################################### ##################################### # THIS SETTINGS CAN'T BE OVERRIDED # ##################################### # Database # https://docs.djangoproject.com/en/2.0/ref/settings/#databases DATABASES = { 'default': { 'ENGINE': 'django.db.backends.postgresql_psycopg2', 'NAME': RDS_DB_NAME, 'USER': RDS_USERNAME, 'PASSWORD': RDS_PASSWORD, 'HOST': RDS_HOSTNAME, 'PORT': RDS_PORT, } } AWS_STORAGE_BUCKET_NAME = S3_BUCKET AWS_S3_CUSTOM_DOMAIN = '%s.s3.amazonaws.com' % AWS_STORAGE_BUCKET_NAME STATIC_ROOT = 'static' STATIC_URL = "https://%s/" % AWS_S3_CUSTOM_DOMAIN</span></span></code> </pre><br>  <a href="https://github.com/Miserlou/Zappa">Zappa</a> is a framework that simplifies the deployment of wsgi applications based on API Gateway and Lambda.  Under the hood, it has a generator Cloudformation template and an adapter for the Lambda event in a wsgi query, which allows you to use the classical scheme of the application.  The final touch is adding dependencies for tests. <br><br><pre> <code class="hljs">pytest==3.3.1 pylint==1.8.1 tox==2.9.1 pytest-django==3.1.2 docstringtest==0.3.0</code> </pre><br>  and add configuration files for tox, pylint and pytest <br><br><h4>  Zappa configuration </h4><br>  It is a JSON or YAML file with a set of variables.  In my version, it is stored on a hidden bucket in the settings of Pipelines S3 and is copied each time an artifact is created. <br>  I will give an example: <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"dev1"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"environment_variables"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"RDS_DB_NAME"</span></span>: <span class="hljs-string"><span class="hljs-string">"dbname"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"RDS_USERNAME"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"RDS_PASSWORD"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"RDS_HOSTNAME"</span></span>: <span class="hljs-string"><span class="hljs-string">"host"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"RDS_PORT"</span></span>: <span class="hljs-string"><span class="hljs-string">"5432"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"S3_BUCKET"</span></span>: <span class="hljs-string"><span class="hljs-string">"s3-bucket"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"aws_region"</span></span>: <span class="hljs-string"><span class="hljs-string">"us-east-1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"django_settings"</span></span>: <span class="hljs-string"><span class="hljs-string">"sample.settings"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"project_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"serverless"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"runtime"</span></span>: <span class="hljs-string"><span class="hljs-string">"python3.6"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"s3_bucket"</span></span>: <span class="hljs-string"><span class="hljs-string">"app-bucket"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"domain"</span></span>:<span class="hljs-string"><span class="hljs-string">"example.com"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"certificate_arn"</span></span>:<span class="hljs-string"><span class="hljs-string">"&lt;ACM certificate arn&gt;"</span></span> } }</code> </pre><br>  Everything related to the project settings is written in environment_variables.  See the zappa documentation for details of the rest. <br><br><h4>  Bitbucket Pipelines Configuration </h4><br>  Those who do not know what it is, refer to my other articles.  Here I will try to consider in detail the configuration of the pipeline.  For CI / CD, I use the following shell script: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash setup () { echo ------- SETUP ------- apt-get update # required to install zip apt-get install -y zip pip install virtualenv virtualenv --python=python3 env source env/bin/activate pip install -r requirements.txt return $? } tests() { echo ------- TESTS ------- pip install -r requirements-test.txt # for tests tox return $? } deploy() { echo ------- DEPLOY ------- echo $1 pip install awscli aws s3 cp s3://$CMDB/zappa_settings.json . zappa update $1 || zappa deploy $1 zappa certify $1 --yes zappa manage $1 "migrate --noinput" zappa manage $1 "collectstatic --noinput" return $? } setup &amp;&amp; test &amp;&amp; deploy $1</span></span></code> </pre><br>  The script works in a standard for a bitbucket pipeline container (image: python: 3.6.1) on Debian.  Pipeline allows you to use any container with DockerHub, but the script adaptation will remain on your conscience. <br><br>  The actual configuration of the pipeline is as follows: <br><br><pre> <code class="hljs sql">image: python:3.6.1 pipelines: tags: <span class="hljs-keyword"><span class="hljs-keyword">release</span></span>-*: - step: caches: - pip script: - ./ci.sh prod1 branches: <span class="hljs-keyword"><span class="hljs-keyword">master</span></span>: - step: caches: - pip script: - ./ci.sh dev1</code> </pre><br>  image points to the container, the deployment of the production is done by tags, the master brunch is deployed in the dev1 environment.  Those interested can add their own test run to the remaining branches.  It's simple. <br><br>  After adding the configuration files, it remains only to configure the bitpack itself.  Turn on pipelines and set the environment variables: <br><br><img src="https://habrastorage.org/webt/5v/wb/iw/5vwbiwjiysxpss6vdlrdudhdmmw.png" alt="image"><br><br>  Everything, now you can push in the master, cut off the tags and ... well, give the repository to the developers, they know what to do with it. <br><br>  The topic of encrypting secrets and using Cloudfront, as well as the settings of RDS, ACM, IAM, Route53, remained behind the scenes, but this is already beyond the scope of the article.  Those interested can find all this in the AWS documentation. <br><br>  Once again the <a href="https://bitbucket.org/random1st/serverless">link to the repository</a> </div><p>Source: <a href="https://habr.com/ru/post/348578/">https://habr.com/ru/post/348578/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348564/index.html">We write scalable and supported servers on Node.js and TypeScript</a></li>
<li><a href="../348566/index.html">Flask Mega-Tutorial, Part X: Email Support (Edition 2018)</a></li>
<li><a href="../348570/index.html">7 Free Data Science Courses for Beginners</a></li>
<li><a href="../348572/index.html">Security week 3: a thief from a bitcoin thief stole, your trojan could be here, ten days without computers</a></li>
<li><a href="../348574/index.html">From regular office to fully distant work: how we built an effective corporate culture</a></li>
<li><a href="../348582/index.html">Some interesting data drawn from the ‚ÄúMy Circle‚Äù autocompletion</a></li>
<li><a href="../348584/index.html">How to avoid performance problems when creating React-applications</a></li>
<li><a href="../348586/index.html">Experiment with binary code in Glimmer</a></li>
<li><a href="../348588/index.html">Black Friday 2017 through the eyes of IT and developers. As we stood black Friday with a 10 times increase in traffic</a></li>
<li><a href="../348590/index.html">What is not written in the documentation, or the subtleties of refactoring on .Net Core</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>