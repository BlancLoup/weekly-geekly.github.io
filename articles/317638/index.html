<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Overcoming difficulties: Gravity Defied on sed</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, this article is dedicated to those who like to solve non-standard tasks on tools not intended for this. Here I will describe the main problems enc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Overcoming difficulties: Gravity Defied on sed</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/077/94b/ea9/07794bea979d4e8a8ade3c1e54113433.png" alt="image" align="left">  So, this article is dedicated to those who like to solve non-standard tasks on tools not intended for this.  Here I will describe the main problems encountered during the creation of the analogue of the game Gravity defied using a streaming text editor (sed). <br><br>  <i>Further, it is assumed that the reader is at least a little familiar with the syntax of sed and the writing of scripts under bash.</i> <br><a name="habracut"></a><br>  The peaceful evening of December ceased to be peaceful when I received a message from a teacher of approximately the following content: <br><blockquote>  On sed: <br>  Gravity defied <br>  ... <br>  It must be cool <br></blockquote><br>  Frankly, for the first half hour I was sitting with the thought of how this is possible at all.  But then I managed to pull myself together and I began to understand. <br><br>  Attempts to google on sed games led to <a href="https://github.com/aureliojargas/sed-scripts/">arkanoid and sokoban</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Before we begin to analyze the problems, I want to share the <a href="https://github.com/Firemoon777/gravity-defied">repository with the project</a> and the <a href="https://asciinema.org/a/9clhjp8g01qg4vo5if80xhbkn">video demonstration of the</a> result <br><br>  So, <b>Problem one: the</b> view in the memory of sed should somehow keep the current state of the game.  We have two places for magic <b>hold space <b>and</b> pattern space</b> . <br><br>  Hold space will store the state of the game between iterations (iteration I will call the processing of one incoming character), and in the pattern space we will change the state of the game. <br>  Algorithm like this: <br><br><ol><li>  Moving on to the action that is tied to the symbol that we received at the input </li><li>  Write to the pattern space the contents of hold space. </li><li>  Change the contents of the pattern space in accordance with the logic of action </li><li>  Write the contents of the pattern space in hold space </li><li>  We apply effects to the pattern space (at this step we are from our ‚Äúservice‚Äù state of the game to what the user will see) </li><li>  We display the contents of the pattern space on the screen </li><li>  Repeat with p.1 for each character entered </li></ol><br>  To simplify the analysis of the entered text, we take it on faith that of the entire incoming line, only the first character is important to us. <br><br>  The first thing is initialization.  Create a print label that will create the game field at the initial time.  From the moment of launching the game, only once a situation will arise when an empty line is passed to the sed input: the very start of the game. <br><br>  In this way, <br><br><pre><code class="bash hljs">/^$/b <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> ... :<span class="hljs-built_in"><span class="hljs-built_in">print</span></span> <span class="hljs-comment"><span class="hljs-comment">#   ,    g s/.*/\ +-----------------------+\ |BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB1\ |BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB2\ |BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB3\ |BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB4\ |BBBBBBBBBBBBBBBBBBBBBUPPABBBBBBBBBBBB5\ |BBBBBBBBBBBBBBBBBBBBUBBBABBBBBAPPPPPP6\ |DBBBBBBBBBBBBBBBBBUPBBBBABBBBBABBBBBB7\ |BDBSBFBBBBBBBBBBBUBBBBBBABBBBBABBBBBB8\ |BBPPPPPPPPPPPPPPPBBBBBBBPPPPPPPBBBBBB9\ +-----------------------+\ b end</span></span></code> </pre> <br>  At this stage, it all depends on your imagination.  You decide what each character is responsible for.  My B is an empty place, F and S are bike wheels, in A, D, P, U is a road (four kinds, for beauty, but more on that later). <br><br>  We need to display everything received on the screen.  As you can see, at the end of print, we go to the end label. <br><br>  end is the overall completion of <b>any</b> action. <br><br><pre> <code class="bash hljs">:end <span class="hljs-comment"><span class="hljs-comment">#     hold space h #     -    #     i\ ^[[H #   pattern space   p</span></span></code> </pre><br>  <b>Note:</b> ^ [[H is not worth copying, it is an escape sequence.  For example, in vim it is entered like this: Ctrl + V Ctrl + ESC [H <br><br>  Run our script with <code>sed -nf gravity.sed</code> .  Congratulations on a static picture! <br><br>  When we have a field, simply write commands that will move our improvised wheels left and right: <br><br><pre> <code class="bash hljs">s/FB/BF/ s/SB/BS/</code> </pre><br>  Moving up is a little more difficult, but we are not afraid of difficulties, right? <br><br><pre> <code class="bash hljs">s/B(.{39})F)/F\1B/</code> </pre><br>  Here the whole point is in the figure 39. This is the number of characters in the line. <br><br>  Add a couple of tags and ‚Äúbind‚Äù them to the right keys, and voila, we have some abstract bike (well, two wheels) for which there are no borders and physics.  But if you want to write a maze, then you just need it. <br><br>  Checking the game is not difficult, but pressing Enter after each character entered is a pleasure below average, so you need to automate this process. <br><br>  <b>Problem two:</b> clocking <br><br>  Since the ‚Äúheart‚Äù of the game is sed, we need a shell that will hit enter for us every time we press a button.  The endless cycle is the most it. <br><br>  Sample code: <br><br><pre> <code class="bash hljs">(<span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> -s -n 1 key <span class="hljs-comment"><span class="hljs-comment">#           key echo $key done) | sed ...</span></span></code> </pre><br>  The game will now be a little more joyful, but it still has a big drawback: the player can influence the course of time.  The faster the player pokes the keys, the faster the course of the game.  We are not satisfied with this, so we need <b>clocking</b> .  Now we have two data sources - a clock generator and a user.  The simplest solution that comes to mind is to use the -t key for read.  If the user does not enter anything for the specified number of seconds, then read will not block the script.  This decision did not suit me: on SunOS read, it refused to accept a fractional number of seconds, and a dynamic game with one frame per second is somehow strange.  The second solution is to use a named pipe: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  (  ) pipe    rm -f gravity-fifo; mkfifo gravity-fifo; #     pipe    sleep 99999999 &gt; gravity-fifo &amp; #   sed -nf gravity.sed gravity-fifo &amp; #  ,    $TIME * 10^-6     t  pipe while true do echo t &gt; gravity-fifo usleep $TIME done &amp; #   (while true do read -s -n 1 key echo $key [[ $key == "q" ]] &amp;&amp; pkill -P $$ done ) | $SED -u -e '/t/d' &gt; gravity-fifo</span></span></code> </pre><br>  A bit of explanation: <br><br>  pkill is a good way to kill a clock and sleep. <br><br>  And if you don‚Äôt understand why you need this sleep, you can check without it: with the first echo pipe it will close and sed will catch the EOF.  Along the way, we prohibit the user to write a clocking character ‚Äî we drive a bike here, and not time. <br><br>  <b>Problem Three:</b> Physics <br><br>  We have a clocking symbol that is called at constant intervals.  It is in the handler of this symbol that you can register the whole physics of the game.  I cannot give general advice here, all physics is a set of regulars who check everything that is checked. <br><br>  <b>Problem four:</b> post-processing <br><br>  Immediately after we went to the end label and saved the changes to the hold space, we can begin to apply effects.  I mentioned earlier that I use four types of roads.  I came to this by trial and error.  In the first versions, the roads were of the same type: R, and at the post-processing stage I tried to write regulars that would do an ascent / descent depending on the relative position of the roads. <br><br>  The idea was rejected: the algorithm constantly failed, it is easier to register the type of roads. <br>  We arm ourselves with a <a href="http://ascii-table.com/ansi-escape-sequences.php">table of ANSI</a> escape <a href="http://ascii-table.com/ansi-escape-sequences.php">sequences</a> , I also additionally used the Unicode table and it turned out ... <br><br><pre> <code class="bash hljs">s/A/^[[107;38;5;82m‚ñà^[[0m/g s/D/^[[107;38;5;82m‚ñö^[[0m/g s/P/^[[107;38;5;82m‚ñÄ^[[0m/g s/U/^[[107;38;5;82m‚ñû^[[0m/g</code> </pre><br>  There are pitfalls here too: when using unicode, the search pattern should not contain the exact number of characters.  Unicode characters are recognized as two characters and the logic of such a regular breaks down. <br><br>  <b>Problem Five:</b> small space <br><br>  Not so many symbols fit on the screen, and I would like to make a map more.  Here comes the Scroll Buffer.  This is a place invisible to the user, which will keep a piece of the continuation of the card.  For a comfortable scrolling, you should number the lines, and at the very end add a line that numbers the zone, for example, z1. <br><br>  Work algorithm: <br><br><ol><li>  If any part of the player is closer than N characters to the right edge of the card, go to the next item. </li><li>  Delete the second symbol of the card (the first one is a frame) </li><li>  By the end of each line, before the number we add </li><li>  If we have exactly M characters #, then we execute the next item, otherwise we skip </li><li>  We check the current zone number and replace all # with the map corresponding to this zone, change the name of the zone to the name of the next zone </li><li>  Go to the end mark. </li><li>  At the post-processing stage, we cut the visible part so that the # symbols never fall into the visible area, as well as delete auxiliary data, for example, the zone number. </li></ol><br>  Hooray!  Now we have the basic knowledge of how to create a game on sed.  What for?  Because we can. <br><br>  <b>PS</b> Assignment courtesy of Zhmilyov S.A.  I hope the next generations will take part of my experience and do something more wonderful.  x) </div><p>Source: <a href="https://habr.com/ru/post/317638/">https://habr.com/ru/post/317638/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317628/index.html">Java hardcore in Novosibirsk: a review and video of the best reports JBreak 2016. And the announcement of the JBreak 2017</a></li>
<li><a href="../317630/index.html">I gave up PGP</a></li>
<li><a href="../317632/index.html">A few tips to automate data center monitoring. Part 1</a></li>
<li><a href="../317634/index.html">Current strength: how mobile communications changed our attitude to energy</a></li>
<li><a href="../317636/index.html">Docker, GitLab, free SSL certificates and other modern web development buns</a></li>
<li><a href="../317640/index.html">How does Netflix streaming work</a></li>
<li><a href="../317642/index.html">One tool for all subscriptions - newsletters, RSS, telegram feeds, social networking pages</a></li>
<li><a href="../317644/index.html">Ransomware Trojans - security theme of the year</a></li>
<li><a href="../317648/index.html">How we solved the problem of parental committees and earned a million rubles.</a></li>
<li><a href="../317650/index.html">Overclocking Swift build project in Xcode</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>