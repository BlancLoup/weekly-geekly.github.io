<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Why unit tests do not work in scientific applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I want to share my experience in the development of scientific applications, and tell why Test-Driven Development and unit tests are ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Why unit tests do not work in scientific applications</h1><div class="post__text post__text-html js-mediator-article">  In this article, I want to share my experience in the development of scientific applications, and tell why Test-Driven Development and unit tests are not a panacea, as is commonly believed lately, at least in terms of finding software bugs.  Why so? <br><a name="habracut"></a><br>  The article will consist of several sections: <br><ol><li>  ‚ÄúIntroduction‚Äù in which I will tell why I decided to write it </li><li>  "An illustrative algorithm."  A scientific problem and an algorithm that will illustrate the following discussion will be briefly described here. </li><li>  ‚ÄúUnit Test Disadvantages‚Äù Here are arguments explaining the unit test deficiencies for scientific applications. </li><li>  Conclusion </li></ol><br>  Immediately, I note that I do not see the benefits of TDD as a way of developing an architecture, but only from the point of view of testing the program. <br><br><h4>  Introduction </h4><br>  During the week of ballooning on Habr√©, the main article was Digital Planes [1], and an entertaining commentary to it [2] that 20 years ago there were no unit tests and generally normal development methods, so the ‚Äútriple-triple redundant architecture ‚Äù, in particular, writing the same program by three different teams in different languages ‚Äã‚Äãin order to eliminate program errors. <br><br>  However, according to eyewitness accounts ([3], by the way, this is another excellent book by an excellent scientist Richard Feynman, who has found a second life in Habr√©), if not Test Driven Development (TDD), then manual testing was a very important development stage. <br>  That is why I had a desire to analyze the approach to the development of scientific applications and to share thoughts on this subject, in particular, to say that TDD is not a silver bullet to search for errors, as one might think at first. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Illustrative algorithm </h4><br>  In the last 20 years, an unusual method for modeling hydrodynamics has been developed: Lattice-Boltzmann Method (hereinafter - LBM) [4], [5].  I participated in the implementation of this algorithm in C ++ for the Max Planck Institute in Germany. <br><br>  To avoid inevitable questions: yes, commercial and open packages already exist that use this method [6];  but initially it was planned to use a modification of the method, which was supposed to give a gain in performance and memory consumption;  nevertheless, we have consistently refused it (first for mass transfer, then for heat transfer).  By that time a lot of code was written, and we decided to continue with our own implementation. <br><br>  Hydrodynamics, as is known, is described by the Navier-Stokes equation.  When modeling it, you can use, for example, the Finite Element Method [7].  Unfortunately, it has drawbacks - the relative complexity of parallelization, the impossibility of modeling multiphase flows, the difficulty of modeling flows in porous media.  These deficiencies are devoid of LBM. <br><br>  For rarefied gases, the Boltzmann equation [8] is valid, which describes how the density of the particle velocity distribution changes at each point in space with time.  Macroscopically, this equation is equivalent to the Navier-Stokes equation (that is, after the transition to macroscopic quantities ‚Äî density and velocity). <br><br>  Now watch your hands: in spite of the fact that for dense liquids, the Boltzmann equation is not applicable, if we learn to model it, then we can also model the Navier-Stokes equation for these fluids.  That is, we thereby replace the underlying level of abstractions (microscopic equation for dense liquids) with a physically incorrect implementation (microscopic equation for rarefied gases), but so that the upper level (the macroscopic Navier-Stokes equation) is described correctly. <br><br>  The next stage is the discretization of the Boltzmann equation: by time, by spatial coordinates (we obtain spatial nodes for modeling) and by possible directions of particles in each spatial node.  Directions are chosen in a special way, and always point to some neighboring nodes. <br><br>  Thus, these are the features that are critical for further examples: 1. The algorithm uses complex formulas 2. The algorithm is nonlocal, that is, in order to calculate the state of the system in a given node, it is necessary to use information from the previous step about neighboring nodes. <br><br><h4>  Disadvantages of unit tests </h4><br>  Finally, we turn to why unit tests cannot fully cover a complex scientific application. <br>  The main idea of ‚Äã‚Äãthe section is that complex algorithms interfere with testing ... yourself. <br><br><h5>  Lack of simple tests </h5><br>  For complex algorithms and methods it is hard to come up with simple tests. <br><br>  This, in general, is obvious.  It is often difficult to choose simple input parameters of the formula so that the output will get a simple and understandable number.  That is, you, of course, separately on a piece of paper or in Matlab, you can calculate what parameters you need to submit to the input in order to get a unit at the output of the test method;  but the input parameters and the output unit will be more like magic numbers.  An example is the Maxwell distribution [9].  In the LBM algorithm, it is used in a slightly modified form. <br><br><h5>  Small coverage area </h5><br>  Even if you manage to come up with a simple test for a complex formula or algorithm, then this test most likely will not find most of the errors. <br><br>  Indeed, sometimes a simple and easy-to-read test can be thought up: for example, if you are testing, as you wrote the rotation matrixes in your 3D engine (I think many inhabitants of Habr indulged in this), then turning to zero angles along all axes should return the unit matrix.  However, often these tests do not detect most errors.  For example, if instead of a sine of a rotation angle (in the elements of a rotation matrix) you begin to use the tangent, then such a simple test will pass. <br><br>  Another example: you need to implement the boundary conditions for the LBM algorithm.  These conditions should complement the state of the node when the latter is not completely surrounded by ‚Äúliquid‚Äù neighbors (for example, it is located at the wall).  You can also come up with a simple test - if all the neighbors are in equilibrium states (that is, the speeds are distributed according to Maxwell law), then after the iteration the boundary node will also be in equilibrium.  However, it turned out that this test misses most of the errors ... <br><br>  One could argue that in business applications, tests are also not intended to cover all possible input parameters.  However, the difference of scientific applications is that they usually operate with sets of other powers [10].  Business applications mainly work with finite or countable sets (of finite power or power of alef-null: boolean variables, strings, integers), and scientific ones with uncountable sets (real or complex numbers). <br><br><h5>  Slow error rate </h5><br>  Due to the fact that typical sets are uncountable, it is difficult to immediately detect the error. <br><br>  The fact is that if you mix up ‚Äúor‚Äù and ‚Äúand‚Äù in a method that uses only Boolean variables, then you will immediately get something wrong at its output.  And if you mix up plus and minus in a formula that works with small values ‚Äã‚Äãof input parameters, then you may well not detect the error after one method call with this formula.  You will need to call this method several hundred thousand times to detect a discrepancy.  It is also worth remembering that in a test that works with real numbers, you need to think about how to avoid false positives. <br><br>  Example: in one of the important cycles of the LBM algorithm, continue was confused with break.  However, all tests passed.  An error was detected only after manual verification of the algorithm on a simple system ‚Äî the Poiseuille flow [11], when after 100,000 iterations, or 5 minutes (!) Of modeling a 32x64 node system (starting from a stationary state), the velocity distribution turned out to be somewhat asymmetric (the maximum relative error was about 1e -ten). <br><br><h5>  Lack of modularity </h5><br>  For many methods it is impossible to create unit tests. <br><br>  Complex physical modeling algorithms are rarely local.  That is, each spatial modeling node can interact with neighboring nodes, and you can not avoid it, and this makes it impossible to unit test. <br><br>  For example, to test a typical LBM algorithm step or typical boundary conditions in a two-dimensional space, a system of at least 3x3 nodes is required.  They need to specify densities, speeds, temperatures, carry out preliminary calculations, set the modeling context (such as various providers of physical properties and models), etc. As a result, the modularity of the test is gradually hidden in the haze of integration. <br><br>  Another (not so characteristic) example: if you need to test the collision algorithm in the physics engine of the game, then you must specify at least two bodies that will collide, their coordinates, speeds, geometry, etc., which again turns the unit test into an integration test. <br><br><h5>  Large facades </h5><br>  If the algorithm is nontrivial, then one public method of the class implementing this algorithm can hide 10-15 methods and 300-400 lines of complex code [12]. <br><br>  Even so: 300-400 lines of austere, ruthless, unresponsive code.  In this class there can be 5 variables of the type a, b, gamma, calls to the methods of the LAPACK libraries [13], BLAS, generation of random numbers and who knows what else.  And with all your heart you may wish to call the variable ‚Äúa‚Äù somehow normal, because you know that when developing a corporate application you would have been scolded for such a name for a long time, but you cannot, because it is so called in the original article, and because does not have any obvious meaning.  The best thing you can do is provide a link to the article at the beginning of the class. <br><br>  And even if you come up with a simple unit test, with simple input parameters for this only public method, and with a simple output value, and it stops to pass at one point, then you will not be able to find an error in this class even by selfless debag or the ultimate method attentive reading. <br><br>  After a collision with such a situation, the best solution was to rewrite this algorithm on MATLAB and compare the calculations line by line. <br><br><h4>  Conclusion </h4><br>  I hope I managed to bring sufficiently strong arguments and convince the readers of Habr that often writing the same program in different languages ‚Äã‚Äãby different teams is an excellent and (in the case of vital systems) inevitable addition to unit testing, TDD, Interface Driven Development, Agile and other modern techniques. <br><br>  Thanks for reading! <br><br><h4>  Links </h4><br>  [1] <a href="http://habrahabr.ru/blogs/popular_science/83534/">Digital airplanes</a> <br>  [2] <a href="http://habrahabr.ru/blogs/popular_science/83534/">Comment on the article Digital Airplanes</a> <br>  [3] <a href="http://fictionbook.ru/author/feynman_richard_phillips/kakoe_tebe_delo_do_togo_chto_dumayut_drugie/">What do you care about what others think of you</a> , the chapter "The long-suffering application" <br>  [4] <a href="http://en.wikipedia.org/wiki/Lattice_Boltzmann_methods">Lattice Boltzmann method</a> <br>  [5] <a href="http://www.lbmethod.org/literature:books">Books on LBM</a> .  Some are available through google books <br>  [6] <a href="http://www.lbmethod.org/palabos/">Parallel Lattice Boltzmann Solver</a> <br>  [7] <a href="http://en.wikipedia.org/wiki/Finite_element_method">Finite element method</a> <br>  [8] <a href="http://en.wikipedia.org/wiki/Boltzmann_equation">Boltzmann equation</a> <br>  [9] <a href="http://en.wikipedia.org/wiki/Maxwell-Boltzmann_distribution">Maxwell-Boltzmann distribution</a> <br>  [10] <a href="http://en.wikipedia.org/wiki/Cardinality">Cardinality</a> <br>  [11] <a href="http://en.wikipedia.org/wiki/Hagen%25E2%2580%2593Poiseuille_flow_from_the_Navier%25E2%2580%2593Stokes_equations">Poiseuille Stream</a> <br>  [12] <a href="http://en.wikipedia.org/wiki/Facade_pattern">Pattern Facade</a> <br>  [13] <a href="http://en.wikipedia.org/wiki/LAPACK">LAPACK</a> <br><br>  PS I guess that for most readers of the site, the algorithm is somewhat exotic, however, I think this is the best illustration.  In the end, where do without scientific algorithms in the article about them the most. <br><br>  PPS Links to scientific articles, I do not cite, because they are all available only by subscription. <br><br>  PPS Thanks to <a href="http://habrahabr.ru/users/sychevigor/" class="user_link">SychevIgor</a> user for invite! <br><br><h4>  UPD </h4><br>  After reading the comments, I think that it is necessary to get rid of the phobia of magic numbers and write for all modules (like BoltzmannDistributionProvider) table tests for comparison with calculations from Matlaba or calculations of the running state of the application.  And also add similar system tests (for example, calculate the dynamics of a 5x5 node system once, write to a file, and compare the results of a run with this file each time).  Thank you all for the tips! </div><p>Source: <a href="https://habr.com/ru/post/92038/">https://habr.com/ru/post/92038/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../92027/index.html">3D printing for everyone</a></li>
<li><a href="../92033/index.html">Difficult password does not need to be remembered</a></li>
<li><a href="../92035/index.html">We are listening to the world of your music!</a></li>
<li><a href="../92036/index.html">5 ways how the Google Books Agreement will change the future of reading</a></li>
<li><a href="../92037/index.html">Air synchronization</a></li>
<li><a href="../92041/index.html">Android Application for 2 days</a></li>
<li><a href="../92042/index.html">The Legend of NASA's "Space Pen" for a Million Dollars</a></li>
<li><a href="../92043/index.html">Flance.ru - the entire freelance Runet</a></li>
<li><a href="../92045/index.html">HTC Desire for ~ 16K is a reality! But how?!</a></li>
<li><a href="../92047/index.html">Jan Mette is dead</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>