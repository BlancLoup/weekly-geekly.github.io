<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we created a fast event stream processing device on FPGA</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The device is called a CEPappliance. CEP - from Complex Event Processing , and appliance - (and so it should be clear, but just in case) the ‚Äúdevice‚Äù ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we created a fast event stream processing device on FPGA</h1><div class="post__text post__text-html js-mediator-article">  The device is called a CEPappliance.  CEP - from <a href="https://en.wikipedia.org/wiki/Complex_event_processing">Complex Event Processing</a> , and appliance - (and so it should be clear, but just in case) the ‚Äúdevice‚Äù from English. <br><br>  We started it back in 2010 as a hobby, working on it after the main work in the long evenings, gradually turning into short nights, and on weekends.  For 5 years of such work, we created 3 prototypes in search of solutions with minimal delays and a simple programming model of data processing logic. <br><br>  In 2015, we realized that we had a decent creation that allows us to process data streams with a guaranteed delay of 2-3 microseconds.  And we began to look for opportunities to turn the business into a commercial product and, probably, to stop working for the ‚Äúuncle‚Äù, to work only on our product, devoting all our time to it.  At the end of 2015, we found our first client, left ‚Äúuncle‚Äù and set off for ‚Äúfree swimming‚Äù. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Today we can say for sure that the device we got.  We have not yet implemented all our plans and we still have to work a lot to add new functionality, sometimes to correct errors.  But our device has been in commercial operation for a year. <br><a name="habracut"></a><br>  Working on the "uncle" we have studied well the technical aspects and needs of trading financial instruments on exchanges and were guided primarily by them.  These are automated trading (HFT, Algo Trading), risk control (Pre-trade), organization of ‚Äúdirect‚Äù access to trading (Direct Market Access), etc. <br><br>  But we managed to make the CEP appliance a fairly universal device, applicable in areas where you need to pump a lot of data and do it not only quickly, but with guaranteed low latency.  With built-in support for standard network protocols and the introduction of minimal delays, the device is applicable in telecommunications for detecting security breaches in networks and managing network load.  The device can be used in telematics when it is necessary to make a decision in a few microseconds and react to the arrival of signals from the sensors.  In this case, the logic of data processing device can be complex.  For its description (programming) we use some techniques of the Complex Event Processing ( <a href="https://en.wikipedia.org/wiki/Complex_event_processing">CEP</a> ) technology. <br><br>  CEPappliance was conceived and created to solve problems, which in a simplified form can be formulated as follows: with a total delay of less than 3 microseconds <br><br><ol><li>  receive input data (signal) via the network interface in the format of Ethernet, TCP / IP, UDP, <a href="https://en.wikipedia.org/wiki/Financial_Information_eXchange">FIX</a> , <a href="https://en.wikipedia.org/wiki/FAST_protocol">FAST</a> , <a href="https://habrahabr.ru/company/moex/blog/321280/">TWIME</a> (FIX SBE), etc .; </li><li>  parse and extract user data; </li><li>  analyze user data; </li><li>  generate the output (reaction) and send it via the network interface. </li></ol><br>  CEPappliance differs from software solution running on architectures with a central processor in that the core of the device architecture is a user-programmable gate array ( <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D1%2583%25D0%25B5%25D0%25BC%25D0%25B0%25D1%258F_%25D0%25BF%25D0%25BE%25D0%25BB%25D1%258C%25D0%25B7%25D0%25BE%25D0%25B2%25D0%25B0%25D1%2582%25D0%25B5%25D0%25BB%25D0%25B5%25D0%25BC_%25D0%25B2%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D0%25BB%25D1%258C%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BC%25D0%25B0%25D1%2582%25D1%2580%25D0%25B8%25D1%2586%25D0%25B0">FPGA</a> ), on which all the steps of solving the described tasks are implemented. <br><br>  Central processor architectures are evolving.  Hybrid versions appear (see <a href="https://habr.com/ru/post/334574/">Fig. 1</a> , <a href="https://habr.com/ru/post/334574/">Fig. 2</a> and <a href="https://habr.com/ru/post/334574/">Fig. 3</a> ), in which the delivery time of data from network interfaces to the processor (and vice versa) is reduced by transferring processing of network and application protocol protocols from the central processor to network cards.  However, the data delivery time is 1‚Äì3 microseconds (one way) and makes a tangible contribution to the delay, which separates the response time from the moment the signal arrives <sup><a href="https://habr.com/ru/post/334574/">1</a></sup> . <br><br>  On the FPGA, we placed components for parsing, extracting, analyzing input data and generating output data on a single chip, figuratively speaking ‚Äúwithout intermediaries‚Äù (see <a href="https://habr.com/ru/post/334574/">Fig. 4</a> ), which are necessarily present in solutions with a central processor. <br><br><a name="pic1"></a><div style="text-align:center;"><img src="https://habrastorage.org/web/074/454/e9f/074454e9f6994c62ba994d64171bfac4.png" alt="Logic diagram of a traditional solution with a central processor"></div><br>  Fig.  1. Logic of a traditional solution with a central processor <br><br><a name="pic2"></a><div style="text-align:center;"><img src="https://habrastorage.org/web/a8a/36d/07f/a8a36d07f6d44daa84a50e2b75fddd5b.png" alt="Logical hybrid solution with a central processor and TCP Offload Engine on a network card"></div><br>  Fig.  2. The logic diagram of the hybrid solution with a central processor and TCP Offload Engine on a network card <br><br><a name="pic3"></a><div style="text-align:center;"><img src="https://habrastorage.org/web/b7b/306/e1a/b7b306e1ac544b408cabaaddb63037b7.png" alt="Logic diagram of a hybrid solution with a central processor, TCP Offload Engine and implementation of application layer protocols in a network card"></div><br>  Fig.  3. A hybrid solution logic diagram with a central processor, TCP Offload Engine and implementation of application layer protocols in a network card <br><br><a name="pic4"></a><div style="text-align:center;"><img src="https://habrastorage.org/web/053/7e1/71c/0537e171cea94078bba55be4e4beac7a.png" alt="CEPappliance Logic"></div><br>  Fig.  4. CEPappliance logic <br><br>  In CEPappliance, components for parsing, extracting, analyzing input data and generating output data are located on an FPGA chip and directly interact with each other. <br><br>  To do this, I had to ‚Äúreinvent the wheel‚Äù again.  Let me remind you that we started work (back in 2010) on CEPappliance in hobby mode.  They did everything themselves ‚Äúas it should and rightly‚Äù.  As a result, among other things, we implemented Ethernet, TCP / IP, UDP, FIX, FAST and TWIME from scratch. <br><br>  We managed to create these components in such a way that the input data is parsed at the speed of their arrival (at <a href="https://en.wikipedia.org/wiki/Wire_speed">wire speed</a> ).  Components implement relevant standards that are ‚Äúcarved in stone‚Äù and do not change often.  For standard protocols, we have provided a configuration mechanism.  For example, the modules of the FIX, FAST, TWIME, and other protocols are configured using user-defined parameters and patterns or schemes that describe the structure of messages. <br><br>  At the same time, we proceeded from the assumption that (user-defined) data processing algorithms may change.  For example, trading strategies or checks performed by a broker to minimize risks (pre-trade risk checks) follow a change in the market situation, the modernization of the micro-architecture of the exchange or the requirements of regulators. <br><br>  Developing algorithms for FPGA directly in hardware languages ‚Äã‚Äã(VHDL, Verilog, etc.) requires significantly more time for coding, debugging, and testing than development in high-level languages <a href="https://habr.com/ru/post/334574/">[2]</a> .  This also requires special skills that programmers who write programs in high-level languages, as a rule, do not possess.  And if you plan to use FPGA to speed up the execution of your algorithms, then you will have to pass a detailed description of the algorithm to the FPGA developer who will implement it.  Sometimes this is highly undesirable, since the transfer of the description of the algorithm creates for its owner the risk of losing competitive advantage. <br><br>  Our device allows the user to describe the data processing algorithm himself.  For this we have developed <br><br><ul><li>  high-level algorithmic language </li><li>  processor of the original architecture and </li><li>  an optimizing compiler that translates programs from a high-level language to processor codes, and which can automatically parallelize program execution on several processors running at the same time. </li></ul><br>  Our own programming language, processor and compiler allow us to implement functions available to the user on FPGA (hardware).  These functions can be parts of the algorithm or the entire algorithm entirely - it depends on the appropriateness of such an implementation, the wishes and capabilities of the user.  This approach can significantly speed up the execution of programs at CEPappliance in some cases. <br><br>  Having provided the user with the opportunity to independently program the CEP appliance, we obviously had to provide tools for debugging these programs.  Without such tools, it will be difficult to take full advantage of the CEPappliance.  Therefore, we developed a device emulator that is 100% compatible with the device itself.  Having debugged the program on the emulator, you can change the configuration (in most cases it is changing the IP address) and immediately start the program on the device. <br><br>  In addition to debugging tools, the device emulator allows you to evaluate the program execution delays by the device itself.  Using the delay measurements thus obtained, you can optimize the program. <br><br>  And for automatic testing of user programs written for CEPappliance, we have a special tool - Test Bench, which reads test scripts in tabular form and executes them.  The same set of tests can be performed with both the device and its emulator. <br><br>  Well, summing up some of the results ... Our fees are in the data center of the Moscow Stock Exchange and successfully trade.  We cannot tell about the results of the auction - this is not our topic, but the client is very pleased (and this text has been agreed with it). <br><br>  There is a lot of work on the development of the device, the search for customers in areas outside the stock exchange trading and many new ideas! <br><br><hr><br><a name="1"></a>  <sup>1</sup> About how this delay is formed in the case of TCP / IP data exchange can be found in <a href="https://habr.com/ru/post/334574/">[1]</a> .  And <a href="http://habrahabr.ru/post/163371/">here it is</a> described how this delay can be reduced by implementing a hybrid architecture using FPGA. <br><br><h4>  Links </h4><br><a name="ref1"></a>  1. S. Larsen and P. Sarangam, ‚ÄúArchitectural Breakdown of the End-to-End Latency in a TCP / IP Network,‚Äù International Journal of Parallel Programming, Springer, 2009. <br><a name="ref2"></a>  2. David F. Bacon, Rodric Rabbah, and Sunil Shukla.  <a href="https://queue.acm.org/detail.cfm%3Fid%3D2443836">FPGA Programming for the Masses</a> .  ACM Queue, Vol 11 (2), February 2013. </div><p>Source: <a href="https://habr.com/ru/post/334574/">https://habr.com/ru/post/334574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../334564/index.html">Defice ask.mcdonalds.ru</a></li>
<li><a href="../334566/index.html">7 ways to use blue in your company colors</a></li>
<li><a href="../334568/index.html">Generative models from OpenAI</a></li>
<li><a href="../334570/index.html">Upgrading traders' workplace infrastructure</a></li>
<li><a href="../334572/index.html">10 steps to set up the Create React App + TypeScript + Ant-Design</a></li>
<li><a href="../334576/index.html">How to configure Travis CI for a .NET Core + PostgreSQL project</a></li>
<li><a href="../334578/index.html">Oracle Storage Cloud Services - everything your enterprise data warehouse needs</a></li>
<li><a href="../334580/index.html">Create your own software 3D-engine</a></li>
<li><a href="../334582/index.html">Roslyn analyzers: habits and habitats</a></li>
<li><a href="../334584/index.html">Interplanetary File System - Switch your site to localhost (local IPFS gateway)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>