<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DIY mail cluster</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Immediately make a reservation that the task can be solved in several ways. This is one of the possible. 
 The article is intended for those who know ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DIY mail cluster</h1><div class="post__text post__text-html js-mediator-article">  Immediately make a reservation that the task can be solved in several ways.  This is one of the possible. <br>  The article is intended for those who know how Exim and Dovecot are configured and work, and I will not dwell on the basic settings of these services in it. <br><br>  I hope that someone, after reading the note, will receive the necessary knowledge or ideas to implement their decision. <br><br>  The task is to build a fault-tolerant service, with mail storage on servers, with access via IMAP. <br>  The cluster will serve the company with approximately 60 branches, each of which has its own 3rd level domain. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The main task of the service, continuous access to the mail.  Therefore, for storage we will use two geographically separated servers, with synchronization of mail directories. <br>  Both servers will be active, which means that we will distribute the load between the nodes.  Some domains will be served by one node, some domains by another.  In case of failure of one of the nodes, customers switch to another. <br>  We will use Nginx with the mail module as a front-end for <s>load distribution of</s> client routing.  To receive mail, we will use two smtp servers. <br><br>  <b>Scheme:</b> <br><img src="https://habrastorage.org/files/319/723/d2e/319723d2e8b04e4eb8a3e12d95030399.jpg"><br><a name="habracut"></a><br>  <b>STORAGE</b> : Mailbox Store.  It consists of two nodes. <br>  Each node is a dedicated server with 2x4TB HDD located on different hostings <br>  DNS: storage-01.domain.ru and storage-02.domain.ru <br>  OS: FreeBSD, <br>  Software: Dovecot, Exim, Postgresql and Nginx <br><br>  <b>SMTP</b> : Servers processing SMTP traffic, two nodes. <br>  Virtual servers located on different hosting, <br>  DNS: smtp-01.domain.ru and smtp-02.domain.ru <br>  OS: FreeBSD, <br>  Software: Exim, Postgresql <br><br>  <b>PROXY</b> : Proxy server for user access to the IMAP, POP3, SMTP service. <br>  Virtual server  The only non-duplicated link in the cluster, but due to its simplicity, it rises within a few minutes from snapshot. <br>  DNS: mail.domain.ru <br>  OS: FreeBSD, <br>  Software: Nginx <br><br>  <b>STORAGE.</b> <br>  Dovecot was chosen as MDA since it is able to cluster out of the box.  To store mail, the Maildir format was chosen, since  deduplication immediately wanted, but more on that below. <br>  Datastors accept mail only from their smtp servers and PROXY.  Mail to the world sent by themselves, bypassing the smtp servers.  You can hide them altogether, and send outgoing mail through smtp nodes. <br>  Path in the file system to the boxes <b>/ usr / mail / domain level 2 / domain level 3 / box /</b> <br>  In the authorization, the full mailbox mail@ldomain.mdomain.ru is used as the login <br><br>  DB: <br>  Description of tables: <br>  <b>mail</b> table to store mailboxes <br><ul><li>  <b>id</b> </li><li>  <b>mailbox</b> - the name of the mailbox </li><li>  <b>password</b> - password in MD5 </li><li>  <b>ldomain_id</b> - id of the 3rd level domain from the ldomain table </li><li>  <b>mdomain_id</b> - id of the 2nd level domain from the mdomain table </li><li>  <b>active</b> - mailbox status.  on off </li></ul><br><br>  <b>ldomain</b> table to describe 3rd level domains <br><ul><li>  <b>id</b> </li><li>  <b>domain</b> - <b>domain</b> name </li><li>  <b>active</b> - domain status.  on off </li></ul><br>  <b>mdomain</b> table for the description of domains of the 2nd level <br><ul><li>  <b>id</b> </li><li>  <b>domain</b> - <b>domain</b> name </li><li>  <b>active</b> - domain status.  on off </li></ul><br>  <b>maps</b> routing table <br><ul><li>  <b>id</b> </li><li>  <b>ldomain_id</b> - id of the 3rd level domain from the ldomain table </li><li>  <b>mdomain_id</b> - id of the 2nd level domain from the mdomain table </li><li>  <b>storage1</b> - basic storage </li><li>  <b>storage2</b> - backup storage (not yet used) </li></ul><br>  As I wrote above, I distribute the load (mail domains) across two storage, in the <b>maps</b> table it determines on which of the storage the 3rd level domain is located. <br><br><pre><code class="sql hljs">mail=<span class="hljs-comment"><span class="hljs-comment"># select * from maps limit 3; id | ldomain_id | mdomain_id | storage1 | storage2 ----+------------+------------+--------------------+--------------- 56 | 56 | 2 | storage-01.domain.ru | storage-02.domain.ru 57 | 57 | 2 | storage-02.domain.ru | storage-01.domain.ru 58 | 58 | 2 | storage-01.domain.ru | storage-02.domain.ru (3 )</span></span></code> </pre> <br>  Based on this table, Exms of storages and smtp nodes will determine where to send letters.  And Nginx, to what storazhu connect users. <br><br>  Creating a database and tables: <br><pre> <code class="sql hljs"> psql -Upgsql template1 ctreate database mail; \q</code> </pre><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> mail ( <span class="hljs-string"><span class="hljs-string">"id"</span></span> BIGSERIAL PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, <span class="hljs-string"><span class="hljs-string">"mailbox"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARYING</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARYING</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>), <span class="hljs-string"><span class="hljs-string">"ldomain_id"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"mdomain_id"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, active <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">"mail_ldomain_id_check"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHECK</span></span> ((<span class="hljs-string"><span class="hljs-string">"ldomain_id"</span></span> &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>)) ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">"ldomain"</span></span> ( <span class="hljs-string"><span class="hljs-string">"id"</span></span> BIGSERIAL PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, <span class="hljs-string"><span class="hljs-string">"domain"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARYING</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"active"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> ldomain_k <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">"mdomain"</span></span> ( <span class="hljs-string"><span class="hljs-string">"id"</span></span> BIGSERIAL PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, <span class="hljs-string"><span class="hljs-string">"domain"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARYING</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"active"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> mdomain_k <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">"maps"</span></span> ( <span class="hljs-string"><span class="hljs-string">"id"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SERIAL</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, <span class="hljs-string"><span class="hljs-string">"ldomain_id"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"mdomain_id"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"storage1"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARYING</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"storage2"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARYING</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> maps_ldomain_k <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (ldomain_id) );</code> </pre><br><br>  <b>Dovecot</b> <br>  Dovecot performs the MDA function.  I will leave the basic setting of Dovecot beyond the scope of this article, I‚Äôll dwell only on those points that are important for connecting it with DB and MTA <br><pre> <code class="bash hljs">/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/dovecot/dovecot.conf protocols = imap pop3 lmtp <span class="hljs-comment"><span class="hljs-comment">#    Exim   LMTP</span></span></code> </pre><br><pre> <code class="bash hljs">/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/dovecot/dovecot-sql.conf.ext driver = pgsql connect = host=localhost dbname=mail user=mail password=password default_pass_scheme = MD5 iterate_query = \ SELECT mail.mailbox || <span class="hljs-string"><span class="hljs-string">'@'</span></span> || ldomain.domain || <span class="hljs-string"><span class="hljs-string">'.'</span></span> || mdomain.domain AS user \ FROM mail \ INNER JOIN mdomain ON ( mail.mdomain_id = mdomain.id ) \ INNER JOIN ldomain ON ( mail.ldomain_id = ldomain.id ) password_query = \ SELECT mail.mailbox || <span class="hljs-string"><span class="hljs-string">'@'</span></span> || ldomain.domain || <span class="hljs-string"><span class="hljs-string">'.'</span></span> || mdomain.domain AS mail, mail.password \ FROM mail \ INNER JOIN mdomain ON ( mail.mdomain_id = mdomain.id ) \ INNER JOIN ldomain ON ( mail.ldomain_id = ldomain.id ) \ WHERE mailbox = <span class="hljs-string"><span class="hljs-string">'%n'</span></span> AND \ ldomain.domain || <span class="hljs-string"><span class="hljs-string">'.'</span></span> || mdomain.domain = <span class="hljs-string"><span class="hljs-string">'%d'</span></span> AND \ mail.active = <span class="hljs-literal"><span class="hljs-literal">true</span></span> AND \ ldomain.active = <span class="hljs-string"><span class="hljs-string">'true'</span></span> user_query = \ SELECT <span class="hljs-string"><span class="hljs-string">'/usr/mail/'</span></span> || ldomain.domain || <span class="hljs-string"><span class="hljs-string">'.'</span></span> || mdomain.domain || <span class="hljs-string"><span class="hljs-string">'/'</span></span> || mail.mailbox AS home \ FROM mail \ INNER JOIN ldomain ON ( mail.ldomain_id = ldomain.id ) \ INNER JOIN mdomain ON ( mail.mdomain_id = mdomain.id ) \ WHERE mail.mailbox = <span class="hljs-string"><span class="hljs-string">'%n'</span></span> AND \ ldomain.domain || <span class="hljs-string"><span class="hljs-string">'.'</span></span> || mdomain.domain = <span class="hljs-string"><span class="hljs-string">'%d'</span></span></code> </pre><br><pre> <code class="bash hljs">/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/dovecot/conf.d/10-auth.conf auth_username_format = %Lu <span class="hljs-comment"><span class="hljs-comment">#    mail@ldomain.mdomain.ru !include auth-sql.conf.ext</span></span></code> </pre><br><pre> <code class="bash hljs">/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/dovecot/conf.d/10-mail.conf mail_location = maildir:/usr/mail/%d/%n/Maildir <span class="hljs-comment"><span class="hljs-comment">#      /usr/mail/ 2- / 3- //</span></span></code> </pre><br><br>  <b>Storage synchronization</b> <br>  Initially, I set up synchronization with the means of Dovecot (dsync) myself, but during operation a very unpleasant problem got out.  As it turned out, the problem was related to the type of storage Maildir.  Dsync began to fail, to produce copies of letters by fattening the free space on the disks.  By that time, I could not transfer all mailboxes to dbox (Dovecot proprietary format), so I had to abandon synchronization via dsync.  In general, there were no other complaints about this mechanism. <br>  I had to contact rsync, with a simple script it takes from the database those domains that are serviced by the server on which it starts up and synchronizes their directories to the second server.  Correspondingly, on the second server the same script drives its first directories to the first one.  Of course, this mechanism is less reliable since rsync runs on a schedule, there is a window between launches in which if the server goes down we lose letters. <br><br>  the script is launched with two parameters - local_server_name remote_server_name <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#mailrsync.pl storage-01.domain.ru storage-02.domain.ru</span></span></code> </pre><br>  sync script: <br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/local/bin/perl use DBI; use threads; use Net::Nslookup; use Sys::Hostname; @host = split('\.',hostname); $dbn="mail"; $dbuser="mail"; $dbpass = "password" $curdata=`date +%Y-%m`; chop $curdata; $conn=DBI-&gt;connect("DBI:Pg:dbname=$dbn;host=localhost","$dbuser","$dbpass") or die "Cannot connect"; ($localhostname,$remotehost)=@ARGV; $mail_dir = "/usr/mail/"; sub domains { $q = "SELECT ldomain.domain,mdomain.domain,maps.storage1 FROM mail INNER JOIN ldomain on (mail.ldomain_id = ldomain.id) INNER JOIN mdomain on (mail.mdomain_id = mdomain.id) INNER JOIN maps on (maps.ldomain_id=ldomain.id) WHERE maps.storage1='".$localhostname."' AND mail.mailbox ='dir'"; $domain = $conn-&gt;prepare($q) or die "Can't prepare statement: $DBI::errstr"; $domain-&gt;execute(); while ( my @domain = $domain-&gt;fetchrow_array ) { @domains=(@domains,$domain[0].".".$domain[1]); } print "count of domains: ".($#domains + 1)."\n"; $dt = 2; #      $count = ($#domains / $dt ); print "count: ".$count."\n"; $i1 = 0; for ($i2 = 0; $i2&lt; $count; $i2++){ if ($dt &gt; $#domains ){$dt = $#domains ;} print $dt."\n"; print "loop: ".$i2."\n"; foreach $item (@domains[$i1..$m]){ print "in \@domains: ".$mail_dir.$item."\n"; @stack = (@stack,$mail_dir.$item."/"); } push @threads,threads-&gt;create(\&amp;sync,\@stack); $i1 = $dt+1; $dt = $dt + 2; @stack=(); } } sub sync { print "sync\n"; foreach $target (@stack){ system(`/usr/local/bin/rsync -H --delete-during -azz -e "/usr/bin/ssh -i /root/.ssh/dovecot_dsa" $target vmail\@$remotehost:$target`); print $target."\n"; } } domains(); foreach $thread (@threads) { $thread-&gt;join(); }</span></span></code> </pre><br><br>  On this with Dovecot, everything. <br><br>  <b>Exim</b> <br>  we define local domains based on the records in the maps table so that Exim ‚Äúknows‚Äù its domains. <br><pre> <code class="bash hljs">domainlist LOCAL_DOMAINS = \ <span class="hljs-variable"><span class="hljs-variable">${lookup pgsql{\ SELECT ldomain.domain || '.' || mdomain.domain AS domainname \ FROM ldomain, mdomain,maps \ WHERE ldomain.domain || '.' || mdomain.domain = LOWER('${quote_pgsql:$domain}</span></span><span class="hljs-string"><span class="hljs-string">') \ AND ldomain.active = '</span></span><span class="hljs-literal"><span class="hljs-literal">true</span></span><span class="hljs-string"><span class="hljs-string">' \ AND maps.storage1 = '</span></span>storage-01.domain.ru<span class="hljs-string"><span class="hljs-string">' \ AND maps.ldomain_id = ldomain.id}}</span></span></code> </pre><br><br>  in hostlist relay_from_hosts I specify the addresses of the smtp node and the proxy, I accept mail from them without authorization (clients are authorized to proxy). <br><pre> <code class="bash hljs"> relay_from_hosts = localhost : smtp01.domain.ru : smtp02.domain.ru : mail.domain.ru</code> </pre><br>  I give incoming mail through LMPT Dovecot.  Everything else is standard.  Requests to the database to search for boxes and passwords are the same as in the listing for Dovecot <br><br>  <b>SMTP nodes</b> <br>  The database is the same as on the stack, except that the mail table does not have a password field, because  users do not connect to these servers.  smtp nodes handle only incoming traffic from the world.  The database checks if the box exists, skipping further letters only for existing boxes. <br><br>  <b>Exim</b> <br>  Standard config, except for the request to determine the route <br><pre> <code class="sql hljs">ROUTE_LIST = "${lookup pgsql{\ <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(storage1,<span class="hljs-string"><span class="hljs-string">''</span></span>) || <span class="hljs-string"><span class="hljs-string">' : '</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(storage2,<span class="hljs-string"><span class="hljs-string">''</span></span>) \ <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (\ <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> storage1,storage2 \ <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> maps \ <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ldomain <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ( maps.ldomain_id = ldomain.id ) \ <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> mdomain <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ( maps.mdomain_id = mdomain.id ) \ <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ldomain.domain || <span class="hljs-string"><span class="hljs-string">'.'</span></span> || mdomain.domain = <span class="hljs-string"><span class="hljs-string">'${quote_pgsql:$domain}'</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL \ <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> storage1,storage2 \ <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> co_maps \ <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> co_domain <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ( co_maps.domain_id = co_domain.id ) \ <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> co_domain.domain = <span class="hljs-string"><span class="hljs-string">'${quote_pgsql:$domain}'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> foo}}<span class="hljs-string"><span class="hljs-string">"</span></span></code> </pre><br>  SQL query pulls the name of the stack for the recipient, then the address of the stack is specified in the router, in the directive route_list.  Thus, the letter is sent to the site where the active domain for this mailbox is located. <br><pre> <code class="bash hljs">begin routers DATASTORE: driver = manualroute domains = DOMAINS transport = remote_smtp condition = MAILS route_list = * ROUTE_LIST no_more</code> </pre><br>  Requests to the database to search for boxes and passwords are the same as in the listing for Dovecot. <br><br>  <b>PROXY</b> <br>  Dovecot can act as a proxy, but I chose Nginx, it seemed simpler and clearer in this regard.  There was one task, to tell nginx in some way where to send the user. <br><br>  nginx.conf on PROXY <br><pre> <code class="bash hljs">cat /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/nginx/nginx.conf worker_processes 1; worker_rlimit_nofile 8192; pid /var/run/nginx.pid; error_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx-error.log debug; error_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx-error.log notice; error_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx-error.log info; events { worker_connections 8192; multi_accept on; use kqueue; } mail { ssl_certificate /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/ssl/proxy.crt; ssl_certificate_key /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/ssl/proxy.key; ssl_session_timeout 5m; xclient off; auth_http storage-01.domain.ru:8185/auth; pop3_capabilities <span class="hljs-string"><span class="hljs-string">"LAST"</span></span> <span class="hljs-string"><span class="hljs-string">"TOP"</span></span> <span class="hljs-string"><span class="hljs-string">"USER"</span></span> <span class="hljs-string"><span class="hljs-string">"PIPELINING"</span></span> <span class="hljs-string"><span class="hljs-string">"UIDL"</span></span> <span class="hljs-string"><span class="hljs-string">"RESP-CODES"</span></span> <span class="hljs-string"><span class="hljs-string">"EXPIRE"</span></span> <span class="hljs-string"><span class="hljs-string">"IMPLEMENTATION"</span></span>; imap_capabilities <span class="hljs-string"><span class="hljs-string">"IMAP4"</span></span> <span class="hljs-string"><span class="hljs-string">"IMAP4rev1"</span></span> <span class="hljs-string"><span class="hljs-string">"UIDPLUS"</span></span> <span class="hljs-string"><span class="hljs-string">"IDLE"</span></span> <span class="hljs-string"><span class="hljs-string">"LITERAL+"</span></span> <span class="hljs-string"><span class="hljs-string">"QUOTA"</span></span> <span class="hljs-string"><span class="hljs-string">"LIST-EXTENDED"</span></span>; smtp_capabilities <span class="hljs-string"><span class="hljs-string">"SIZE 52428800"</span></span> <span class="hljs-string"><span class="hljs-string">"8BITMIME"</span></span> <span class="hljs-string"><span class="hljs-string">"PIPELINING"</span></span> <span class="hljs-string"><span class="hljs-string">"STARTTLS"</span></span> <span class="hljs-string"><span class="hljs-string">"HELP"</span></span>; server { smtp_auth login plain; listen 25; protocol smtp; proxy on; starttls on; } server { smtp_auth login plain; listen 587; protocol smtp; proxy on; starttls on; } server { listen 110; protocol pop3; proxy on; starttls on; } server { listen 995; protocol pop3; proxy on; starttls on; } server { listen 143; protocol imap; proxy on; starttls on; } server { listen 993; protocol imap; proxy on; starttls on; } }</code> </pre><br>  Pay attention to the directive <code>auth_http storage-01.domain.ru:8185/auth;</code> <br>  Nginx also works <b>on the stack</b> (on both!), But in the web server mode, with the sole purpose of processing storage-01.domain.ru:8185/auth request <br>  This request in case of successful authorization of the client returns the authorization status, the name of the store and the port of the service <br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"Auth-Status"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>; <span class="hljs-string"><span class="hljs-string">"Auth-Server"</span></span>, <span class="hljs-string"><span class="hljs-string">"storage-01.domain.ru"</span></span>; <span class="hljs-string"><span class="hljs-string">"Auth-Port"</span></span>, <span class="hljs-string"><span class="hljs-string">"143"</span></span>;</code> </pre><br>  After that, nginx on PROXY sends a client to the store who returned in response. <br>  One could of course exclude nginx on the stack, but for this, it would be necessary to keep a base with users on PROXY.  In general, there could be options. <br><br>  Below is the Nginx config on the stack, with a perl module for implementing the above. <br><pre> <code class="bash hljs">worker_processes 4; worker_rlimit_nofile 8192; error_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/nginx-error.log info; events { worker_connections 8192; multi_accept on; } http { perl_modules perl/lib; perl_require mailauth.pm; perl_require Digest.pm; access_log off; server { listen 8185; ssl_certificate /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/ssl/storage-01.crt; ssl_certificate_key /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/ssl/storage-01.key; ssl_session_timeout 5m; location /auth { perl mailauth::handler; proxy_set_header X-Real-IP <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; } } }</code> </pre><br><br>  mailauth.pm module <br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> mailauth; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> nginx; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBI; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Net::Nslookup; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Digest::MD5 <span class="hljs-string"><span class="hljs-string">qw(md5_hex)</span></span>; $pg_user = <span class="hljs-string"><span class="hljs-string">"mail"</span></span>; $pg_pass = <span class="hljs-string"><span class="hljs-string">"password"</span></span>; $passhost = <span class="hljs-string"><span class="hljs-string">"localhost"</span></span>; $mapshost = <span class="hljs-string"><span class="hljs-string">"localhost"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">our</span></span> $auth_ok; $protocol_ports-&gt;{<span class="hljs-string"><span class="hljs-string">'pop3'</span></span>}=<span class="hljs-number"><span class="hljs-number">110</span></span>; $protocol_ports-&gt;{<span class="hljs-string"><span class="hljs-string">'imap'</span></span>}=<span class="hljs-number"><span class="hljs-number">143</span></span>; $protocol_ports-&gt;{<span class="hljs-string"><span class="hljs-string">'smtp'</span></span>}=<span class="hljs-number"><span class="hljs-number">25</span></span>; $protocol_ports-&gt;{<span class="hljs-string"><span class="hljs-string">'smtpssl'</span></span>}=<span class="hljs-number"><span class="hljs-number">465</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-function"> </span></span>{ $r = <span class="hljs-keyword"><span class="hljs-keyword">shift</span></span>; $Passdbh=DBI-&gt;<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>(<span class="hljs-string"><span class="hljs-string">"DBI:Pg:dbname=mail;host=$passhost"</span></span>,<span class="hljs-string"><span class="hljs-string">"$pg_user"</span></span>,<span class="hljs-string"><span class="hljs-string">"$pg_pass"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$Passdbh) { $r-&gt;header_out(<span class="hljs-string"><span class="hljs-string">"Auth-Status"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>) ; $r-&gt;header_out(<span class="hljs-string"><span class="hljs-string">"Auth-Server"</span></span>, <span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>); $r-&gt;header_out(<span class="hljs-string"><span class="hljs-string">"Auth-Port"</span></span>, $protocol_ports-&gt;{$r-&gt;header_in(<span class="hljs-string"><span class="hljs-string">"Auth-Protocol"</span></span>)}); $r-&gt;send_http_header(<span class="hljs-string"><span class="hljs-string">"text/html"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> OK; <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; }; $Mapsdbh=DBI-&gt;<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>(<span class="hljs-string"><span class="hljs-string">"DBI:Pg:dbname=mail;host=$mapshost"</span></span>,<span class="hljs-string"><span class="hljs-string">"$pg_user"</span></span>,<span class="hljs-string"><span class="hljs-string">"$pg_pass"</span></span>); $auth_ok=<span class="hljs-number"><span class="hljs-number">0</span></span>; $mailbox = $r-&gt;header_in(<span class="hljs-string"><span class="hljs-string">"Auth-User"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">our</span></span> $get_pass_from_db=$Passdbh-&gt;prepare(<span class="hljs-string"><span class="hljs-string">"SELECT password FROM mail INNER JOIN ldomain ON ( mail.ldomain_id = ldomain.id ) INNER JOIN mdomain ON ( mail.mdomain_id = mdomain.id ) WHERE mail.mailbox || '\@' || ldomain.domain || '.' || mdomain.domain = ? "</span></span>); $get_pass_from_db-&gt;execute($mailbox); @row=$get_pass_from_db-&gt;fetchrow_array(); $passfromDB=@row[<span class="hljs-number"><span class="hljs-number">0</span></span>]; $md5passFromConnect = md5_hex($r-&gt;header_in(<span class="hljs-string"><span class="hljs-string">"Auth-Pass"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( $passfromDB eq $md5passFromConnect ){ $auth_ok=<span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($auth_ok==<span class="hljs-number"><span class="hljs-number">1</span></span>){ @domain = <span class="hljs-keyword"><span class="hljs-keyword">split</span></span>(<span class="hljs-string"><span class="hljs-string">'\@'</span></span>,$mailbox); $get_server_from_maps = $Mapsdbh-&gt;prepare( <span class="hljs-string"><span class="hljs-string">"SELECT storage1 FROM maps INNER JOIN ldomain ON ( maps.ldomain_id = ldomain.id ) \ INNER JOIN mdomain ON ( maps.mdomain_id = mdomain.id ) \ WHERE ldomain.domain || '.' || mdomain.domain = ? "</span></span> ); $get_server_from_maps-&gt;execute(@domain[<span class="hljs-number"><span class="hljs-number">1</span></span>]); @row=$get_server_from_maps-&gt;fetchrow_array(); $server_from_maps = nslookup(<span class="hljs-string"><span class="hljs-string">host =&gt;</span></span> $row[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-string"><span class="hljs-string">type =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">"A"</span></span>); $r-&gt;header_out(<span class="hljs-string"><span class="hljs-string">"Auth-Status"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>) ; $r-&gt;header_out(<span class="hljs-string"><span class="hljs-string">"Auth-Server"</span></span>, $server_from_maps); $r-&gt;header_out(<span class="hljs-string"><span class="hljs-string">"Auth-Port"</span></span>, $protocol_ports-&gt;{$r-&gt;header_in(<span class="hljs-string"><span class="hljs-string">"Auth-Protocol"</span></span>)}); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $r-&gt;header_out(<span class="hljs-string"><span class="hljs-string">"mail:"</span></span>, $r-&gt;header_in(<span class="hljs-string"><span class="hljs-string">"Auth-User"</span></span>)); $r-&gt;header_out(<span class="hljs-string"><span class="hljs-string">"Auth-Status"</span></span>, <span class="hljs-string"><span class="hljs-string">"Invalid login or password"</span></span>) ; } $r-&gt;send_http_header(<span class="hljs-string"><span class="hljs-string">"text/html"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> OK; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">db_fail</span></span></span><span class="hljs-function"> </span></span>{ $r-&gt;header_out(<span class="hljs-string"><span class="hljs-string">"Auth-Status"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>) ; $r-&gt;header_out(<span class="hljs-string"><span class="hljs-string">"Auth-Server"</span></span>, <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>); $r-&gt;send_http_header(<span class="hljs-string"><span class="hljs-string">"text/html"</span></span>); } <span class="hljs-number"><span class="hljs-number">1</span></span>; __END_<span class="hljs-number"><span class="hljs-number">_</span></span></code> </pre><br><br>  <b>Adjustment of balancing, and switching to the backup node</b> <br>  Now switching to the backup node occurs in manual mode.  Just in the maps table, the value in the storage1 field changes.  T.K.  all servers are monitored by monitoring so far have been enough. <br><br>  <b>CONCLUSION</b> <br>  The cluster has been operating for 3 years.  During this time, survived several drops of one of the nodes (as a result, this node moved to another DC). <br><br>  Someone may seem this design complex, confusing and "bicycle".  But I want to emphasize that the architecture of this solution was based on the decision to use cheap, "unreliable" hardware.  As a result, we have a reliable service with a minimum cost of server rental. <br><br>  Perhaps the note was not clear enough, and I did not display some important details.  In the comments, if they will, I will supplement. <br><br>  PS  The article turned out to be long, so I‚Äôll tell you about the deduplication and another, not mentioned here service management of this cluster in the next article, if this is interesting. <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/324538/">https://habr.com/ru/post/324538/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324524/index.html">Spring aggravation: design school in Innopolis, methodological intensive and informational information meeting</a></li>
<li><a href="../324528/index.html">Yandex.Money staged a vote for the abolition of the commission for transfers between wallets</a></li>
<li><a href="../324530/index.html">A little bit about the privacy of real Git repositories.</a></li>
<li><a href="../324532/index.html">Unpredictable effects of Chrome performance optimization</a></li>
<li><a href="../324534/index.html">Why 90% of landings do not sell? How to close customer objections 2 times more effective than competitors</a></li>
<li><a href="../324540/index.html">Clustering text documents according to semantic features (part one: algorithm description)</a></li>
<li><a href="../324544/index.html">Columnstore Index - selection from SQL Server Product Team</a></li>
<li><a href="../324546/index.html">How we created a hosting provider with our own data center (continued)</a></li>
<li><a href="../324548/index.html">.NET programming language development strategy</a></li>
<li><a href="../324550/index.html">Source Code Analysis Another World</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>