<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Around the badge for 80 days: on the other side OFFZONE</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! Last time we told how the OFFZONE 2019 international cyber security badge came out and what it is with. Today we will share behind-the-scene...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Around the badge for 80 days: on the other side OFFZONE</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  <a href="https://habr.com/ru/company/bizone/blog/457070/">Last time</a> we told how the OFFZONE 2019 international cyber security badge came out and what it is with.  Today we will share behind-the-scenes stories: how we came to create it and what it cost us to invent and produce a series of 2000 devices.  Chronology of events, the pitfalls of development, purchase, installation and other joys from the world of electronics under the cut.  Go! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tk/2r/br/tk2rbrw385czta4aurclcd4suqo.png"></div><br><a name="habracut"></a><br>  Each practical cybersecurity conference acquires interactive badges.  In our case, the badge should at least serve as a wallet for the internal currency of the event - OFFCOIN. <br><br>  Last year, a Java card handled this task, to which we screwed a few tasks, a game of tanchiki and a sokoban.  The logical development of the badge-2019 seemed to be the same map, only now with NFC: here there is continuity, evolution, and a sea of ‚Äã‚Äãideas for assignments.  And for her there is all the groundwork - this is important if in the first shift you are looking for vulnerabilities, and in the second you are organizing a conference. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We were slowly preparing for production when the news came from the hardware analysis laboratory: our colleagues will present at OFFZONE their <a href="https://www.bi.zone/ru/research/attacks_on_hardware/">overview of attacks on embedded systems</a> .  Photos of the prepared boards were filled in by working chats, in the corridors they discussed side-channel types, the hardware theme didn‚Äôt capture our economists.  And we realized that for OFFZONE 2019 you need to file your own device. <br><br>  So, we had 80 days before the start of the conference, a target of 2,000 devices and 2 electronics developers.  Here is how this epic looked through the eyes of one of the developers. <br><br><h3>  80 days </h3><br>  The first thing we started off with was brainstorming with colleagues and giving us the badge concept.  Among the ideas were a single-board with an interpreter of some BASIC on board, a badge business card with an E-ink display, something from the world of IoT devices based on ESP32 or a similar module, and a basic motherboard prepared in advance for retrofitting with additional modules. <br><br><h3>  79‚Äì65 days </h3><br>  We go, we drink coffee, we digest our thoughts.  Weigh the pros and cons.  We read tweeters and see <a href="https://hackaday.io/list/25935-conference-badges">what others are doing</a> . <br><br><h3>  64‚Äì60 days </h3><br>  Spent another brainstorm. <br><br>  The idea of ‚Äã‚Äãa single board thrown.  It was too expensive because of the abundance of components and installation: there would be more than 30 buttons alone. And no one would be surprised by such a device - <a href="https://hackaday.com/2018/10/17/the-supercon-badge-is-a-freakin-computer/">The Supercon Badge</a> and similar crafts are immediately remembered. <br><br>  The business card with the E-ink display is also shallow: they could not find an interesting use for it and decide how to tie the potential tasks to the badge.  And ESP32 somehow looked frivolous - we would have thought that we were just beginners!  (Although I will return to the Arduino topic.).  There remains the idea of ‚Äã‚Äãa motherboard with the ability to retrofit it with modules for solving tasks. <br><br>  A couple of days polished the idea.  In the end, we chose the shape of a 3.5-inch floppy disk, decided on the main functionality and body kits.  As the latter, they took a DIP Switch for 8 switches, an OLED display, an IR receiver, an RFID transceiver of 13.56 MHz, and a separate receiver and transmitter of the 433 MHz band.  The STM32F1 microcontroller was assigned to control this bitty zoo, as on the popular <a href="https://elchupanibrei.livejournal.com/30157.html">Blue Pill</a> board. <br><br>  At the same time, an idea arose to make a Craft.Zone pad on OFFZONE, where everyone can come in to smell the rosin and personally retrofit their badge with electronic components.  The soldering zone is one more knight's move!  Firstly, it is interesting and unusual for an industry conference, secondly, it will entice even beginners, and thirdly, we will speed up the installation of the final batch of devices.  All parties win! <br><br>  As a result, in the first weeks we approved the concept, main functionality and component base of the future device.  Then the fun begins. <br><br><h3>  59‚Äì50 days </h3><br>  We managed to make a schemata, dilute, make and manually mount the first version of the badge board.  At this stage, the choice of the power source turned out to be the most painful. <br><br>  Obviously, the badge must be a standalone device.  As a guarantor of this autonomy, a lithium-polymer battery of 0.5 Ah was suggested and the corresponding charge control system on a simple controller type TP4096.  But did you try to buy a couple of thousand batteries in Moscow without a preliminary order, and even from a trusted manufacturer?  We tried - we did not succeed.  They did not dare to order from China: the battery is too important and a fire hazardous element, and our guests should have worn it around their necks.  It was then that we returned to the good old batteries.  Estimated consumption, conducted a series of simple experiments and stopped on the configuration of four AA-size batteries.  They gave 16-20 hours of operation of the device, depending on the activity of use. <br><br>  We broke our heads over writing the firmware.  In other circumstances, we would write software using Eclipse (arm-none-eabi-gcc), Keil, IAR and other human and not very IDE.  However, our team of volunteer developers for the most part consisted of forsenics and pentesters.  It was unreasonable to hope that at leisure they quickly learn how to write firmware for embedded systems. <br><br>  I promised that without arduina will not do?  I did not lie!  To simplify the software development process, we used the Arduino IDE.  Fortunately, there is a good project <a href="https://github.com/stm32duino">STM32Duino</a> , which out of the box implements an Arduinov bootloader for our target stone STM32F1, and the Arduino IDE supports it.  In the latter there are most of the libraries we need to work with modules and other pleasures regarding high-level programming.  Of course, not everything is so smooth with libraries, but you can live.  To adapt most of them under the STM32, it is enough to rewrite platform-specific functions - and that‚Äôs all.  But to edit the library code is almost like inserting quotes! <br><br><blockquote>  <b>Interesting fact.</b>  To implement the functionality of the badge, we used the following libraries: <br><br><ul><li>  Adafruit_SSD1306 for OLED display, </li><li>  MFRC522 for RFID, </li><li>  RCSwitch for 433 MHz radio, </li><li>  irmp-master for IR transmitter. </li></ul><br></blockquote><br>  And now the first version of the board is ready.  She came out green, without the necessary milled holes and practically did not work. <br><br><blockquote>  <b>Interesting fact.</b>  The prototypes of the board were ordered on ‚ÄúRezonite‚Äù under the special program ‚ÄúWe really need it yesterday,‚Äù components were purchased from retail stores in Moscow, and the installation was carried out on its own. </blockquote><br>  Most of the problems of the first version could have been avoided; we first assembled the main part of the circuit on the breadboard.  We probably would have noticed that the receiver and transmitter require different input voltage ratings: 5 V for the receiver and 3‚Äì12 V for the transmitter (in the trial version, both modules were powered from 3 V).  Would not have passed by and sleeping USB.  Careful reading of the Blue Pill's circuit boards helped to understand that USB will not work until the USB_P line is pulled up by a 5‚Äì10 kŒ© resistor to 5 V. <br><br><blockquote>  <b>Interesting fact.</b>  Trying to reanimate the USB and poking an oscilloscope into the board, I was surprised to find out: although the supply voltage on it is 5 V, the data lines D + and D- pull up to 3.3 V. This is how you turn! <br></blockquote><br>  Because of the tight deadlines, we had to make compromises and work on the principle of not ‚Äúmeasure seven times,‚Äù but ‚Äúdo-test-correct‚Äù.  But it is only suitable for stress-resistant enthusiasts - we do not recommend repeating at home. <br><br><blockquote>  <b>Council</b>  Do not neglect the design and carefully read the datasheets! </blockquote><br><h3>  49‚Äì40 days </h3><br>  Fixed problems and produced a batch of badges v2.0.  It is still green, but it almost works.  This is what the hand is full of! <br><br><img src="https://habrastorage.org/webt/fq/ey/sm/fqeysmncbfcjcyzcc37gmnl5u-0.png"><br><br>  If you look at the photo of the badge, you will see two curved bar codes on the front side (yes, we know about the existence of QR codes, but decided that we want a warm lamp bar code).  This was an unsuccessful attempt to place a link to the website with information about the conference and operating instructions.  The barcode did not reach the final version: we could not decide how to arrange it so that it looked laconically on the board.  In a smaller version, it was not read by the application on the mobile, and in the current size it looked too monstrous. <br><br><blockquote> <b>Interesting fact.</b>  The right barcode on the photo is working and contains an easter egg.  Those interested can try to count it. </blockquote><br>  In the second version of the badge we corrected USB, corrected the connection of the modules, correctly created zones for milling.  Also removed the extra components and most of the debug jumpers - but not all. <br><br><blockquote>  <b>Interesting fact.</b>  I had to leave 0 Om jumpers for the display, since the I2C OLED displays with a diagonal of 0.96 inches have two pinouts that differ in the arrangement of the power and ground contacts.  We could not say in advance which version of this display will come to us, and we had to provide both options. <br></blockquote><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-y/wd/nr/-ywdnr2zkuqp9oeoc6s6z6bkmfe.png"></div><br>  <i>Note the location of the power and ground contacts</i> <br><br>  At the same stage, we started to purchase the main part of the components.  For the badge only popular STM32F1, WS2812B and other consumer goods were required - we did not expect their deficit and therefore did not rush.  But it turned out, everything is about scale.  Buy 10 controllers in stock in Moscow is easy, 100 is also not a question.  But with 1000 and more, difficulties begin.  We did not manage to find a single seller in the capital who, for sane term and adequate money, would have delivered 2000 MK STM32F1.  I had to order from Yekaterinburg! <br><br>  The same difficulties arose with the purchase of 8,000 WS2812B LEDs.  The latter flew to us from the European warehouse and lingered at the customs, which was great for our nerves. <br><br>  The only thing that got a little blood - these are passive SMD components like resistors and capacitors of size 0603. Here they were in bulk in warehouses of Moscow. <br><br><blockquote>  <b>Interesting fact.</b>  Additional modules ordered 200 pieces of each type.  They came from China - there was no closer number. <br></blockquote><br>  Looking ahead, I will say that all the components managed to get in 3-4 weeks.  But this is luck, we will not risk it anymore. <br><br><blockquote>  <b>Council</b>  If you have to buy components for 100, 500 or more devices, do not delay the task in the back box.  With such series, set aside a month or more for purchase, especially if we are talking about microchips. <br></blockquote><br><h3>  39‚Äì30 days </h3><br>  Party v3.0.  The badge is already black and fully functional!  There is only ma-a-a-scarlet nuance.  Somehow, from the first version of the badge, there was an error in the location of the power and data contacts on the 433 MHz transmitter. <br><br>  Because of this error, our colleague who wrote a task on the radio almost turned gray.  His transfer on the arduino makette confidently worked for about 30 meters, but on the badge it‚Äôs good if it was half a meter from the board.  A few days, until we found a bug in the layout, a colleague suffered and did not understand what was happening.  Fedor, forgive us!  Although a mystery why the device with the tangled pins worked at all ?! <br><br>  So, they found a bug, fixed two tracks on the board, for convenience, changed the miniUSB connector to microUSB, crossed themselves, ordered a final v7.1 for 2000 pieces. <br><br><h3>  29‚Äì15 days </h3><br>  We walk, worry for the supply of components from different parts of the world.  Along the way, the guys finish their task. <br><br><blockquote>  <b>Interesting fact.</b>  During the development of the game Flappy Quote, one of the colleagues managed to drink the bot in about half an hour. <br></blockquote><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ho/si/3e/hosi3e-xut4yb46jvdqymcuxvmk.png"></div><br><br><h3>  14 days </h3><br>  Boards came, components came, we give to installation!  We worked with the "M-board", which mounted all 2000 devices in a week. <br><br><blockquote>  <b>Council</b>  If you have 100 or more devices, forget about manual installation and get ready for an automatic one on the assembly line.  Consider this when developing a PCB.  (Check with the selected manufacturer - they can tell a lot. General recommendations are also available on <a href="https://www.rezonit.ru/mont/preparation/">the Resonit website</a> .) <br></blockquote><br><blockquote>  <b>Council</b>  The PCB maker can often take over some of the work of preparing the board for automatic installation.  In our case, the plant grouped several boards into one blank, created the necessary technical fields and plotted reference points on the boards, and also left all the technical documentation needed to prepare the assembly line in a third organization. </blockquote><br><img src="https://habrastorage.org/webt/yj/0a/p-/yj0ap-vyodatc6pa6zmltiwh77s.png"><br><br><h3>  10 days </h3><br>  We take away trial 12 boards from installation, we check, we exhale: everything works as it should. <br><br><img src="https://habrastorage.org/webt/ig/9r/6p/ig9r6pmcy0a1s9u7ynbgcivb2qs.png"><br><br><h3>  9‚Äì5 days </h3><br>  We are actively completing the task, and at the same time we are preparing for the final overcoming of common sense.  After all, all 2000 devices we have to flash manually.  To simplify the combat task, they wrote a pit-script using the console version of the STM32 utility ST-LINK Utility and prepared two dozen cheap ST-Link v2. <br><br><img src="https://habrastorage.org/webt/gr/fo/h3/grfoh315yynx3afm6w7ura9xark.png"><br><br><blockquote>  <b>Council</b>  The boards could be flashed at the final assembly stage at the factory and without the heroic efforts of BI.ZONE personnel.  We did not take advantage of this opportunity only because by the end of the build the final version of the software was not ready. <br></blockquote><br><h3>  96 hours before the conference </h3><br>  We pick up the boards from the installation, turn off mobile phones, lock ourselves in the office and fill in all 2000 devices in the evening. <br><br><blockquote>  <b>Interesting fact.</b>  Of the 2000 devices, signs of life did not submit only 2. The percentage of rejects at the c installation output is 0.1. <br></blockquote><br><img src="https://habrastorage.org/webt/tt/wn/yo/ttwnyonex8bczzki0-ihrru6xhs.png"><br><br>  There is joy on our faces, but thoughts are already far away.  What will be the badge next year?  Will we fix the idea with E-ink or invent something completely new?  Let's return to the concept of plastic cards or we will be inspired by the Olympics in Tokyo and write down the paper badge-origami?  If you have fresh ideas, go to the comments: it is possible that some of the cyber security experts from different countries of the world will hang on their necks in a year! <br><br><h2>  Instead of conclusion </h2><br>  OFFZONE 2019 passed a month ago, but we are still being asked the questions "can we somehow get a badge fee."  Yes you can!  100 badges will go to those who have time to write an e-mail to <a href="">info@offzone.moscow</a> .  Ship to Russia and the CIS.  The event will last two weeks from the date of publication of the article and closes exactly on August 2 at 13:37 Moscow time. </div><p>Source: <a href="https://habr.com/ru/post/460631/">https://habr.com/ru/post/460631/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../46062/index.html">Startup: "Startup Cemetery"</a></li>
<li><a href="../460621/index.html">Tic Tac Toe, Part 4: Interacting with the Flask backend using HTTP</a></li>
<li><a href="../460623/index.html">About torture of Julian Assange</a></li>
<li><a href="../460629/index.html">The probability that 2 miners have the same world</a></li>
<li><a href="../46063/index.html">‚ÄúAttention Profile‚Äù and ‚ÄúFavorite Authors‚Äù</a></li>
<li><a href="../460633/index.html">Details of the implementation of RSTP and proprietary Extended Ring Redundancy</a></li>
<li><a href="../460635/index.html">CLRium # 6: Concurrency</a></li>
<li><a href="../460637/index.html">Light control on ZigBee</a></li>
<li><a href="../46064/index.html">The British encroached on the "Classmates"</a></li>
<li><a href="../460641/index.html">YouTokenToMe: tool for quick tokenization of text from the VKontakte Team</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>