<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>VPS as an anonymous proxy and not only ...</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today, every Internet user can purchase a VPS and use a remote server, for example, to host their own website or organize a DNS server. In this post I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>VPS as an anonymous proxy and not only ...</h1><div class="post__text post__text-html js-mediator-article">  Today, every Internet user can purchase a VPS and use a remote server, for example, to host their own website or organize a DNS server.  In this post I will talk about the non-standard use of VPS: how to create a personal anonymous proxy server and provide backup access to existing services. <br><a name="habracut"></a><br><h4>  <b><u>Initial data:</u></b> </h4><br><ul><li>  VPS in Europe (FreeBSD8.3 OS) with white ip (yyy.yyy.yyy.yyy) </li><li>  Internet gateway in Russia (FreeBSD8.1 OS) with white ip (xxx.xxx.xxx.xxx) </li><li>  Local network behind the gateway with servers (HTTP-SERVER, HTTPS-SERVER, PROXY-SERVER) </li></ul><br><h4>  <b><u>Access to the Internet resource through an anonymous proxy server</u></b> </h4><br>  Client ---&gt; Internet Gateway (PF) --rdr -&gt; Local Proxy Server (SQUID) --vpn -&gt; VPS Proxy Server (SQUID) ---&gt; Internet <br><br><h5>  <i>PF Firewall on the Internet Gateway</i> </h5><br>  For anonymous access to certain resources, we will create a special PF ip address table: <br><pre><code class="bash hljs">table &lt;anonymous&gt; persist file <span class="hljs-string"><span class="hljs-string">"/etc/pf/iplists/anonymsites.txt"</span></span></code> </pre> <br>  In our scheme, the client uses a transparent proxy, so in PF you need to create a redirect: <br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$ext_ip</span></span>=<span class="hljs-string"><span class="hljs-string">"xxx.xxx.xxx.xxx"</span></span> <span class="hljs-variable"><span class="hljs-variable">$int_if</span></span>=<span class="hljs-string"><span class="hljs-string">" "</span></span> rdr on <span class="hljs-variable"><span class="hljs-variable">$int_if</span></span> proto tcp from <span class="hljs-variable"><span class="hljs-variable">$clients</span></span> to &lt;anonymous&gt; port 80 -&gt; <span class="hljs-variable"><span class="hljs-variable">$ext_ip</span></span> port 3129 rdr on <span class="hljs-variable"><span class="hljs-variable">$int_if</span></span> proto tcp from <span class="hljs-variable"><span class="hljs-variable">$clients</span></span> to &lt;anonymous&gt; port 443 -&gt; <span class="hljs-variable"><span class="hljs-variable">$ext_ip</span></span> port 3129</code> </pre> <br>  We redirect traffic from clients on ports 80, 443 to certain resources through a local proxy server (port 3129). <br><br><h5>  <i>Local proxy server SQUID</i> </h5><br>  In the standard SQUID2.7 configuration, as a proxy for the local network, the following directives should be made: <br><pre> <code class="bash hljs">http_port 3129 <span class="hljs-comment"><span class="hljs-comment">#    header_access From deny all header_access Server deny all header_access User-Agent deny all header_access WWW-Authenticate deny all header_access Link deny all header_access X-Forwarded-For deny all header_access Via deny all header_access Cache-Control deny all forwarded_for off #          VPS  vpn- cache_peer 10.10.10.250 parent 3128 0 no-query no-digest cache_peer_access 10.10.10.250 allow all never_direct allow all</span></span></code> </pre><br><h5>  <i>OpenVPN based tunnel</i> </h5><br>  Create a vpn-tunnel between the Internet gateway and the VPS by installing the openvpn server (10.10.10.1) on the gateway and the client on the VPS (10.10.10.250). <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># OpenVPN  mode server tls-server port 2080 proto udp dev tun ca /etc/openvpn/keys/ca.crt cert /etc/openvpn/keys/server.crt key /etc/openvpn/keys/server.key dh /etc/openvpn/keys/dh1024.pem tls-auth /etc/openvpn/keys/ta.key 0 topology subnet ifconfig 10.10.10.1 255.255.255.0 keepalive 10 120 max-clients 10 comp-lzo cipher DES-EDE3-CBC user nobody group nogroup persist-key persist-tun verb 4 mute 20 client-to-client client-config-dir /etc/openvpn/ccd status /var/log/openvpn/openvpn-status.log log-append /var/log/openvpn/openvpn.log</span></span></code> </pre><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># OpenVPN  client dev tun proto udp remote xxx.xxx.xxx.xxx 2080 pull topology subnet user nobody group nobody persist-key persist-tun ca /usr/local/etc/openvpn/keys/ca.crt cert /usr/local/etc/openvpn/keys/vps.crt key /usr/local/etc/openvpn/keys/vps.key tls-client tls-auth /usr/local/etc/openvpn/keys/ta.key 1 cipher DES-EDE3-CBC comp-lzo verb 3 status /var/log/openvpn-status.log log /var/log/openvpn.log mute 20</span></span></code> </pre><br><h5>  <i>VPS proxy server SQUID</i> </h5><br>  Standard configuration SQUID2.7 with anonymous access. <br><pre> <code class="bash hljs">http_port 3128 <span class="hljs-comment"><span class="hljs-comment">#   header_access From deny all header_access Server deny all header_access User-Agent deny all header_access WWW-Authenticate deny all header_access Link deny all header_access X-Forwarded-For deny all header_access Via deny all header_access Cache-Control deny all forwarded_for off</span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  <b><u>Backup access to servers (HTTP, HTTPs) from outside</u></b> </h4><br>  Internet ---&gt; VPS (PF) --vpn + stunnel -&gt; Internet Gateway (PF) ---&gt; local server (HTTP, HTTPs) <br><br><h5>  <i>PF Firewall on VPS</i> </h5><br>  Add a redirect to the PF firewall on the VPS: <br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$ext_if</span></span>=<span class="hljs-string"><span class="hljs-string">" "</span></span> rdr on <span class="hljs-variable"><span class="hljs-variable">$ext_if</span></span> proto tcp from any to <span class="hljs-variable"><span class="hljs-variable">$ext_if</span></span> port 80 -&gt; 127.0.0.1 port 8180 rdr on <span class="hljs-variable"><span class="hljs-variable">$ext_if</span></span> proto tcp from any to <span class="hljs-variable"><span class="hljs-variable">$ext_if</span></span> port 443 -&gt; 127.0.0.1 port 4443</code> </pre><br>  We will redirect traffic destined for the web server behind the Internet gateway to the local loop address ports 8180 and 4443, on which Stunnel runs. <br><br><h5>  <i>Stunnel Tunnel</i> </h5><br>  It was possible, of course, to do without Stunnel, simply adding a static route and forwarding ports on the PF to the local server, but decided to experiment.  In this case, Stunnel is required for proxying external traffic to the local web server (192.168.XXX.YYY).  Stunnel configuration on VPS and Internet gateway: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#stunnel.conf  VPS pid = /var/run/stunnel.pid debug = 4 output = /var/log/stunnel.log cert = /usr/local/etc/stunnel/stunnel.cert key = /usr/local/etc/stunnel/stunnel.key sslVersion = SSLv3 options = DONT_INSERT_EMPTY_FRAGMENTS ciphers = AES256-SHA socket = l:TCP_NODELAY=1 socket = r:TCP_NODELAY=1 compression = rle [http] client = yes accept = 8180 connect = 10.10.10.1:8180 TIMEOUTclose = 0 [https] client = yes accept = 4443 connect = 10.10.10.1:4443 TIMEOUTclose = 0</span></span></code> </pre><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#stunnel.conf  - pid = /var/run/stunnel.pid debug = 4 output = /var/log/stunnel.log cert = /usr/local/etc/stunnel/stunnel.cert key = /usr/local/etc/stunnel/stunnel.key sslVersion = SSLv3 options = DONT_INSERT_EMPTY_FRAGMENTS ciphers = AES256-SHA socket = l:TCP_NODELAY=1 socket = r:TCP_NODELAY=1 compression = rle [http] accept = 8180 connect = 192.168.XXX.YYY:80 TIMEOUTclose = 0 [https] accept = 4443 connect = 192.168.XXX.YYY:443 TIMEOUTclose = 0</span></span></code> </pre><br>  So, you can provide backup access to the service via an additional white ip.  For example, the <code>example.com</code> domain in DNS can map the main external ip, and the subdomain <code><a href="http://www.example.com/"></a> www.example.com</code>  <code><a href="http://www.example.com/"></a> www.example.com</code> (often an alias for the main one) - ip of the remote VPS. <br></div><p>Source: <a href="https://habr.com/ru/post/217629/">https://habr.com/ru/post/217629/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../217611/index.html">Remote in Russian. New book from 37signals</a></li>
<li><a href="../217615/index.html">Lectorium launches MOOC direction</a></li>
<li><a href="../217617/index.html">Testing ‚Äúfast MongoDB‚Äù - TokuMX in conditions close to reality</a></li>
<li><a href="../217625/index.html">First look at the prototype Yotaphone 2</a></li>
<li><a href="../217627/index.html">Asynchronous C # program update</a></li>
<li><a href="../217631/index.html">Python-digest # 20. News, interesting projects, articles and interviews [March 23, 2014 - March 30, 2014]</a></li>
<li><a href="../217633/index.html">Automatic update programs in C #. Part 2</a></li>
<li><a href="../217637/index.html">Certification of goods in the Russian Federation or 9 circles of hell</a></li>
<li><a href="../217639/index.html">Working with SQL Server in Hybrid Cloud Scripts. Part 2</a></li>
<li><a href="../217641/index.html">New hub "Chrome Extensions" (from October 2014 - "Extensions for browsers")</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>