<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Search by MAC address on Juniper switches</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On a local network, you often need to find out which switch port the device‚Äôs specific MAC address is on. The problem is solved easily if there are se...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Search by MAC address on Juniper switches</h1><div class="post__text post__text-html js-mediator-article">  On a local network, you often need to find out which switch port the device‚Äôs specific MAC address is on.  The problem is solved easily if there are several switches in the network, but when there are more than 30 of them, everything becomes much more complicated.  I want to share a small Python script that looks for the desired MAC address on the network and returns the name and port of the switch on which this MAC is registered. <br><br><img src="https://habrastorage.org/webt/ui/sl/tm/uisltmawb4week0qnbf04l0p7um.png"><br><br>  Constructive criticism is welcome.  Details under the cut. <br><a name="habracut"></a><br>  If the network design is correct, that is, the root switch <b>CORE</b> , to which distribution switches <b>DS</b> (Distribution Switch) are connected, and, in turn, switches of access level <b>AS</b> (Access Switch).  This rule is not always executed, access switches can be connected in series.  In any case, the port of the upstream switch contains all the MAC addresses of devices connected to the downstream switch. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For example, if the device of interest to us is connected to the <b>AS3</b> switch, then, starting the search with <b>CORE</b> , we will find this address on the port leading to <b>DS1</b> .  Going to <b>DS1</b> , we find this MAC on the port leading to <b>AS2</b> , going to <b>AS2</b> , we see that it leads us to <b>AS3</b> , and only on <b>AS3</b> will we find the specific port to which the device of interest is connected. <br><br>  I didn‚Äôt want to do all this with my hands, sort through all the switches in the loop and determine where the uplink and where not, too, so the next solution was born, which I want to share. <br><br><h4>  A bit of theory. </h4><br>  To find the MAC <b>08: 62: 66: c7: b3: 45</b> on the Juniper switch, run the following command: <br><br><pre><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">show</span></span> ethernet-switching <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">62</span></span>:<span class="hljs-number"><span class="hljs-number">66</span></span>:c7:b3:<span class="hljs-number"><span class="hljs-number">45</span></span></code> </pre> <br>  If there is such a MAC, the answer will be as follows: <br><br><pre> <code class="hljs ruby">vlan151 08<span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">62</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">66</span></span><span class="hljs-symbol"><span class="hljs-symbol">:c7</span></span><span class="hljs-symbol"><span class="hljs-symbol">:b3</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">45</span></span> D - xe-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">23.0</span></span></code> </pre> <br>  The last column will be the interface name of the switch on which the MAC is registered.  But how to understand where this interface leads?  And here <b>Interface Descriptions</b> come to the rescue.  These are lines in the switch configuration file that allow you to assign text labels to interfaces. <br><br>  Team <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">show</span></span> interfaces xe<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">23</span></span> descriptions</code> </pre> <br>  will show the following: <br><br><pre> <code class="hljs pgsql">Interface <span class="hljs-keyword"><span class="hljs-keyword">Admin</span></span> Link Description xe<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">23</span></span> up up SW&gt;DS1</code> </pre> <br>  In the configuration, we indicate that this interface leads to the downstream switch: <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> interfaces xe-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">23</span></span> description <span class="hljs-type"><span class="hljs-type">SW</span></span>&gt;<span class="hljs-type"><span class="hljs-type">DS1</span></span></code> </pre> <br><h4>  Implementation </h4><br>  The proposed script will do the following: <br><br><ol><li>  connect via SSH to the root switch; </li><li>  check which interface is the MAC address transmitted in the parameters; </li><li>  check the description of this interface; </li><li>  if the interface leads to the switch, recursively go to the next switch in the chain. </li></ol><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#       searchpass = [] #main      MAC-    checkswitch,           MAC-.       searchpass   json. def main(argv): mac_addr = argv[0] checkswitch('CORE',mac_addr) for switch in searchpass: print (json.dumps(switch, ensure_ascii=False)) if __name__ == "__main__": main(sys.argv[1:]) #   MAC- def checkswitch(hostname,mac_addr): try: #    ,  host    returnvalue = {} returnvalue['host']=hostname #sendCommand      SSH     MAC-    answer = sendCommand(hostname,'show ethernet-switching table | match '+mac_addr) #   ,      #vlan151 08:62:66:c7:b3:45 D - xe-0/0/23.0 if(answer!=0): iface = answer.split()[4] returnvalue['iface']=iface # description ,    2  .0       #xe-0/0/23 up up SW&gt;DS01 answer = sendCommand(hostname,'show interfaces '+iface[:-2]+' descriptions | last 1 | no-more') iface = answer.split() # description   ,      ,     SW&gt;.  ,   3 ,         . if(len(iface)&gt;2): iface=iface[3] returnvalue['description']=iface else: returnvalue['description']='none' searchpass.append(returnvalue) if (iface[:3]=='SW&gt;'): checkswitch(iface[3:],mac_addr) else: returnvalue['iface']='none' searchpass.append(returnvalue) except Exception as e: print(e)</span></span></code> </pre> <br>  Thus, the script will go through all switches on the network, starting with the kernel, and will try to find the necessary MAC.  For successful work, it is enough to keep descriptions on the interfaces up to date, and the topology can be of almost any complexity. <br><br>  An example of the script: <br><br><pre> <code class="hljs ruby">python findmac.py <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">17</span></span><span class="hljs-symbol"><span class="hljs-symbol">:fc</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">21</span></span><span class="hljs-symbol"><span class="hljs-symbol">:e8</span></span><span class="hljs-symbol"><span class="hljs-symbol">:f9</span></span> {<span class="hljs-string"><span class="hljs-string">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"CORE"</span></span>, <span class="hljs-string"><span class="hljs-string">"iface"</span></span>: <span class="hljs-string"><span class="hljs-string">"xe-0/0/23.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"SW&gt;DS1"</span></span>} {<span class="hljs-string"><span class="hljs-string">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"DS1"</span></span>, <span class="hljs-string"><span class="hljs-string">"iface"</span></span>: <span class="hljs-string"><span class="hljs-string">"xe-0/0/11.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"SW&gt;AS2"</span></span>} {<span class="hljs-string"><span class="hljs-string">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"AS2"</span></span>, <span class="hljs-string"><span class="hljs-string">"iface"</span></span>: <span class="hljs-string"><span class="hljs-string">"xe-1/0/1.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"SW&gt;AS3"</span></span>} {<span class="hljs-string"><span class="hljs-string">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"AS3"</span></span>, <span class="hljs-string"><span class="hljs-string">"iface"</span></span>: <span class="hljs-string"><span class="hljs-string">"ge-0/0/26.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"none"</span></span>}</code> </pre> <br>  If the MAC is missing, we get <br><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"CORE"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"iface"</span></span>: <span class="hljs-string"><span class="hljs-string">"none"</span></span>}</code> </pre> <br>  The last line is the switch and port of interest to us, but at the same time we can track the entire search path. <br><br>  The full code is under the spoiler, thank you for your attention. <br><br><div class="spoiler">  <b class="spoiler_title">findmac.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> paramiko <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> threading <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging login = <span class="hljs-string"><span class="hljs-string">'user1'</span></span> password = <span class="hljs-string"><span class="hljs-string">'pass1234'</span></span> searchpass = [] port = <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LogPipe</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(threading.Thread)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, level)</span></span></span><span class="hljs-function">:</span></span> threading.Thread.__init__(self) self.daemon = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> self.level = level self.fdRead, self.fdWrite = os.pipe() self.pipeReader = os.fdopen(self.fdRead) self.start() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fileno</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.fdWrite <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> iter(self.pipeReader.readline, <span class="hljs-string"><span class="hljs-string">''</span></span>): logging.log(self.level, line.strip(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>)) self.pipeReader.close() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> os.close(self.fdWrite) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute_ssh_command</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(host, port, username, password, command)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-comment"><span class="hljs-comment"># Create the SSH client. ssh = paramiko.SSHClient() ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy()) # Connect to the host. ssh.connect(host, port, username, password, look_for_keys=False) # Send the command (non-blocking) stdin, stdout, stderr = ssh.exec_command(command) # Wait for the command to terminate while not stdout.channel.exit_status_ready() and not stdout.channel.recv_ready(): time.sleep(1) stdoutstring = stdout.readlines() stderrstring = stderr.readlines() return stdoutstring, stderrstring finally: if ssh is not None: # Close client connection. ssh.close() def sendCommand (hostname,command): returnvalue = 0 logging.info('Host '+hostname+', command: '+command) Try: #add .mydomain for FQDN (stdoutstring, stderrstring) = execute_ssh_command(hostname+'.mydomain', port, login, password, command+'\n') if (len(stdoutstring)&gt;0): logging.info(stdoutstring[0]) if (len(stderrstring)&gt;0): logging.info(stderrstring[0]) except Exception as e: return returnvalue else: returnvalue = stdoutstring[0] finally: return returnvalue def checkswitch(hostname,mac_addr): try: returnvalue = {} returnvalue['host']=hostname answer = sendCommand(hostname,'show ethernet-switching table | match '+mac_addr) if(answer!=0): iface = answer.split()[4] returnvalue['iface']=iface #cut .0 prefix in the interface name answer = sendCommand(hostname,'show interfaces '+iface[:-2]+' descriptions | last 1 | no-more') iface = answer.split() if(len(iface)&gt;2): iface=iface[3] returnvalue['description']=iface else: returnvalue['description']='none' searchpass.append(returnvalue) if (iface[:3]=='SW&gt;'): checkswitch(iface[3:],mac_addr) else: returnvalue['iface']='none' searchpass.append(returnvalue) except Exception as e: logging.info(e) def main(argv): mac_addr = argv[0] #configure log logging.basicConfig(filename='/var/log/findmac.log', level=logging.INFO, format='%(asctime)s %(message)s') logging.info('Find MAC: '+mac_addr) checkswitch('CORE',mac_addr) for switch in searchpass: print (json.dumps(switch, ensure_ascii=False)) if __name__ == "__main__": main(sys.argv[1:])</span></span></code> </pre> <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/420013/">https://habr.com/ru/post/420013/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../420001/index.html">Introducing 3CX v15.5 Update 6 BETA and WebRTC browser softphone</a></li>
<li><a href="../420003/index.html">Window with JavaFX buttons:</a></li>
<li><a href="../420007/index.html">FidgetPen, strange lamp and splitter cubes: getting to know Allocacoc</a></li>
<li><a href="../420009/index.html">Subtleties of product design</a></li>
<li><a href="../420011/index.html">How to choose a 3D printer: a guide for beginners</a></li>
<li><a href="../420015/index.html">How to measure the speed of the Internet channel and stop looking like a fool in the eyes of your provider</a></li>
<li><a href="../420017/index.html">The art of picking someone else's passwords</a></li>
<li><a href="../420019/index.html">Client-server interaction in a new mobile PvP-shooter and game server device: problems and solutions</a></li>
<li><a href="../420021/index.html">Why do you need Splunk? IoT and industrial data</a></li>
<li><a href="../420023/index.html">State saving in android applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>