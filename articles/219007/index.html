<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pattern state machines for Ash Entity System framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Two years ago, I got acquainted with the most wonderful framework for developing games on Actionscript Ash (almost immediately after meeting him, it c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pattern state machines for Ash Entity System framework</h1><div class="post__text post__text-html js-mediator-article">  Two years ago, I got acquainted with the most wonderful framework for developing games on Actionscript <a href="http://www.ashframework.org/">Ash</a> (almost immediately after meeting him, it came to be understood that the framework would suit any language. And even a little later, the ports of the framework for other languages ‚Äã‚Äãappeared - at the time of writing the translation there are 7 pieces).  For some time, I was bursting with the desire to share the find with the Russian-speaking community, until I was ahead of the <a href="http://habrahabr.ru/post/197920/">transfer to Habr√©</a> .  Now I want to put in a translation regarding the implementation of the almost indispensable <i>Finite-State Machine</i> pattern for the <i>Ash Entity System</i> framework. <br><a name="habracut"></a><br>  Note: the naming of basic concepts from the <i>Entity System</i> framework (ES framework) will be written with a capital letter - to avoid possible ambiguities: System ( <i>System</i> ), Component ( <i>Component</i> ), Node ( <i>Entity</i> ) <br><br><h4>  Pattern state machines for Ash Entity System framework </h4><br>  <a href="http://en.wikipedia.org/wiki/Finite-state_machine">Finite state machines</a> (FSM) - one of the main constructions in game dev.  During the game, game objects can repeatedly change their states and effective management of these states is very important. <br><br>  The complexity of the FSM in the ES framework can be expressed in one sentence - FSM does not work with the ES framework.  Any ES framework uses a data-oriented approach (data-oriented paradigm), in which gaming entities are not encapsulated OOP objects.  Thus, you will not be able to use FSM or its variants.  All data is in Components, all logic is in Systems. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If there are few states or they are simple, then you can use the good old <i>switch statement</i> inside the System, if the data for all possible states of the gaming entity (enclosed in the corresponding Components) are also used by this System.  But I would not recommend it. <br><br>  When developing <a href="http://www.sticksports.com/mobile/stick-tennis.php">Stick Tennis,</a> I faced the problem of managing states.  The sequence of changes in these states was similar to something similar ... <br><ul><li>  prepare to serve </li><li>  filing start </li><li>  tossing the ball </li><li>  swing of the racket </li><li>  kick the ball </li><li>  completion of the blow </li><li>  moving to a good position </li><li>  reaction to a ball hit by an opponent </li><li>  moving to intercept the ball </li><li>  swing of the racket </li><li>  kick the ball </li><li>  completion of the blow </li><li>  moving to a good position </li><li>  reaction to a ball hit by an opponent </li><li>  etc. </li></ul><br><br>  <i>Stick Tennis</i> is a complex example, and I cannot show the program code, instead I will show something simpler. <br><br>  <b>Example</b> <br><br>  Let's imagine the game character - the guard.  A guard patrols along a route, looking around carefully.  When an enemy is detected, it attacks. <br><br>  In traditional OOP-oriented FSM, we need to create classes for each state. <br><br><pre><code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PatrolState</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> guard : Character; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path : Vector.&lt;Point&gt;; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PatrolState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( guard : Character, path : Vector.&lt;Point&gt; )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.guard = guard; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.path = path; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( time : Number )</span></span></span><span class="hljs-function"> : void </span></span>{ moveAlongPath( time ); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> enemy : Character = lookForEnemies(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( enemy ) { guard.changeState( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AttackState( guard, enemy ) ); } } }</code> </pre> <br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AttackState</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> guard : Character; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> enemy : Character; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AttackState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( guard : Character, enemy : Character )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.guard = guard; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.enemy = enemy; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( time : Number )</span></span></span><span class="hljs-function"> : void </span></span>{ guard.attack( enemy ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( enemy.isDead ) { guard.changeState( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PatrolState( guard, PatrolPathFactory.getPath( guard.id ) ); } } }</code> </pre><br><br>  In the <i>Entity System</i> architecture, we must take a slightly different approach.  In this case, the basic principle of FSM, where it is possible to change states by means of a set of corresponding classes, when a particular state corresponds to each class, can still be applied.  To implement FSM in the ES framework in this case we can use one System for one particular state. <br><br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PatrolSystem</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListIteratingSystem</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PatrolSystem</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( PatrolNode, updateNode ); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( node : PatrolNode, time : Number )</span></span></span><span class="hljs-function"> : void </span></span>{ moveAlongPath( node ); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> enemy : Enemy = lookForEnemies( node ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( enemy ) { node.entity.remove( Patrol ); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> attack : Attack = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Attack(); attack.enemy = enemy; node.entity.add( attack ); } } }</code> </pre><br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AttackSystem</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListIteratingSystem</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AttackSystem</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( AttackNode, updateNode ); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( node : PatrolNode, time : Number )</span></span></span><span class="hljs-function"> : void </span></span>{ attack( node.entity, node.attack.enemy ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( node.attack.enemy.get( Health ).energy == <span class="hljs-number"><span class="hljs-number">0</span></span> ) { node.entity.remove( Attack ); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> patrol : Patrol = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Patrol(); patrol.path = PatrolPathFactory.getPath( node.entity.name ); node.entity.add( patrol ); } } }</code> </pre><br>  <i>PatrolSystem</i> will be responsible for the behavior of the guard <i>character</i> , if the <i>PatrolComponent</i> Component is included in it, and <i>AttakSystem</i> will be responsible for the behavior during the Attack Component component, if it is included in it.  By changing these components, we can switch the status of the character guard. <br><br>  These Components and Nodes will look something like this ... <br><br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Patrol</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path : Vector.&lt;Point&gt;; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Attack</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> enemy : Entity; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Position</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> point : Point; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Health</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> energy : Number; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PatrolNode</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> patrol : Patrol; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> position : Position; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AttackNode</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> attack : Attack; }</code> </pre><br>  So, by changing the Components of the Entity, we change the states of the Entity and System that are responsible for their behavior. <br><br>  <b>Another example</b> <br><br>  Here I will present another example, more complex from the game <a href="https://github.com/richardlord/Asteroids">Asteroids example game</a> , with the help of which I illustrate the work of the <i>Ash Framework</i> .  I had to add another state for the spacecraft - the death of the ship.  Instead of simply removing the spacecraft at the time of death, I show a short animation of its destruction.  While I am demonstrating this animation, the player is deprived of the ability to control the ship, and the ship itself is not involved in handling collisions with other objects. <br><br>  This required the following two states of the ship: <br><br><ol><li>  the ship is alive <ul><li>  looks like a spaceship </li><li>  the player can control it </li><li>  the player can fire his weapon </li><li>  the ship may collide with asteroids </li></ul></li><li>  the ship is dead <ul><li>  looks like wreckage drifting in space </li><li>  the player cannot control it </li><li>  the player cannot fire his weapon </li><li>  the ship cannot collide with asteroids </li><li>  after a certain time the ship is removed from the game </li></ul></li></ol><br><br>  The corresponding code where the ship is killed is in the <i>CollisionSystem</i> .  Without the second state, it looks like this: <br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( spaceship = spaceships.head; spaceship; spaceship = spaceship.next ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( asteroid = asteroids.head; asteroid; asteroid = asteroid.next ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( Point.distance( asteroid.position.position, spaceship.position.position ) &lt;= asteroid.position.collisionRadius + spaceship.position.collisionRadius ) { creator.destroyEntity( spaceship.entity ); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }</code> </pre><br>  The code checks whether the ship collided with an asteroid, and if this happened, removes the ship from the game.  On the other hand, <a href="">GameManager</a> handles the situation when there is no space ship in the game and creates a new one.  If all ‚Äúlives‚Äù are exhausted - the end of the game.  So - instead of simply removing the ship from the game, we have to change its state ‚Äî show flying debris.  Let's try‚Ä¶ <br><br>  We can deprive the player of control by simply removing the components of <a href="">MotionControls</a> and <a href="">GunControls</a> from the Essence of the spacecraft.  We also need to remove the <a href="">Motion</a> and <a href="">Gun</a> components, since they are still not used without the appropriate controllers.  Those.  we measure the code above: <br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( spaceship = spaceships.head; spaceship; spaceship = spaceship.next ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( asteroid = asteroids.head; asteroid; asteroid = asteroid.next ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( Point.distance( asteroid.position.position, spaceship.position.position ) &lt;= asteroid.position.collisionRadius + spaceship.position.collisionRadius ) { spaceship.entity.remove( MotionControls ); spaceship.entity.remove( Motion ); spaceship.entity.remove( GunControls ); spaceship.entity.remove( Gun ); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }</code> </pre><br>  Then we need to change the appearance of the ship (on the wreckage) and cancel the handling of collisions: <br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( spaceship = spaceships.head; spaceship; spaceship = spaceship.next ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( asteroid = asteroids.head; asteroid; asteroid = asteroid.next ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( Point.distance( asteroid.position.position, spaceship.position.position ) &lt;= asteroid.position.collisionRadius + spaceship.position.collisionRadius ) { spaceship.entity.remove( MotionControls ); spaceship.entity.remove( Motion ); spaceship.entity.remove( GunControls ); spaceship.entity.remove( Gun ); spaceship.entity.remove( Collision ); spaceship.entity.remove( Display ); spaceship.entity.add( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Display( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpaceshipDeathView() ) ); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }</code> </pre> <br>  Finally, we need to ensure that the wreckage of the ship is removed after some period of time.  For this we need a new system and component: <br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeathThroes</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> countdown : Number; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeathThroes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( duration : Number )</span></span></span><span class="hljs-function"> </span></span>{ countdown = duration; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeathThroesNode</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> death : DeathThroes; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeathThroesSystem</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListIteratingSystem</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> creator : EntityCreator; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeathThroesSystem</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( creator : EntityCreator )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( DeathThroesNode, updateNode ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.creator = creator; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateNode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( node : DeathThroesNode, time : Number )</span></span></span><span class="hljs-function"> : void </span></span>{ node.death.countdown -= time; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( node.death.countdown &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span> ) { creator.destroyEntity( node.entity ); } } }</code> </pre><br>  We add <i>DeathThroesSystem</i> to the game from the very beginning, and at the right moment it will react to the ‚Äúdeath‚Äù of the Essence.  It remains to add the <i>DeathThroes</i> Component to the Essence of the spacecraft. <br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( spaceship = spaceships.head; spaceship; spaceship = spaceship.next ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( asteroid = asteroids.head; asteroid; asteroid = asteroid.next ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( Point.distance( asteroid.position.position, spaceship.position.position ) &lt;= asteroid.position.collisionRadius + spaceship.position.collisionRadius ) { spaceship.entity.remove( MotionControls ); spaceship.entity.remove( Motion ); spaceship.entity.remove( GunControls ); spaceship.entity.remove( Gun ); spaceship.entity.remove( Collision ); spaceship.entity.remove( Display ); spaceship.entity.add( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Display( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpaceshiopDeathView() ) ); spaceship.entity.add( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DeathThroes( <span class="hljs-number"><span class="hljs-number">5</span></span> ) ); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }</code> </pre><br>  As a result, we get the necessary state of the spacecraft.  The transition between the states itself was provided by ‚Äúshuffling‚Äù the components of the spacecraft. <br><br><h4>  The specific state is encapsulated in the Component Set. </h4><br>  The main rule of the <i>Entity System Architecture</i> is the <i>Entity</i> state encapsulated in the Component Set.  If you want to change the behavior of the Entity, you must change the set of Components.  Changing the set of Components in turn will change the set of Systems - and the behavior of the Entity will change. <br><br><h5>  Standardized code for FSM </h5><br>  For ease of working with FSM, I added a corresponding set of classes to the framework - <a href="https://github.com/richardlord/Ash/tree/master/src/ash/fsm">standard state machine classes</a> .  A set of these classes will help identify new states, manage them. <br><br>  FSM is an instance of the <a href="">EntityStateMachine</a> class.  When you create an instance, you give it a link to the Entity, the states of which it will manage.  The <i>EntityStateMachine</i> instance <i>itself is</i> usually stored in some Component in the Entity, and thus any System has access to it. <br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stateMachine : EntityStateMachine = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EntityStateMachine( guard );</code> </pre><br>  FSM stores states, and these states can be changed by calling the <i>EntityStateMachine.changeState ()</i> method.  Each specific state is identified by a string (name) that is associated with the state when it was created and used when calling <i>EntityStateMachine.changeState (stateName)</i> . <br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> patrolState : EntityState = stateMachine.createState( <span class="hljs-string"><span class="hljs-string">"patrol"</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> attackState : EntityState = stateMachine.createState( <span class="hljs-string"><span class="hljs-string">"attack"</span></span> );</code> </pre><br><br>  <b>What is the state added to the FSM for?</b> <br><ol><li>  adds the necessary Components when the Entity enters this state; </li><li>  removes previously added components when leaving the current state. </li></ol><br><br>  The <i>EntityStateMachine.add ()</i> method sets the Component type necessary for the defined state and follows the rules indicating how to create this Component. <br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> patrol : Patrol = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Patrol(); patrol.path = PatrolPathFactory.getPath( node.entity.name ); patrolState.add( Patrol ).withInstance( patrol ); attackState.add( Attack );</code> </pre><br><h4>  There are four standard methods: </h4><br>  <b>entityState.add (type: Class);</b> <br>  Without any indication, FSM will create a new instance of the Component of this type, for later adding it to the Entity.  And it will be repeated each time with repeated returns to this state. <br>  <b>entityState.add (type: Class) .withType (otherType: Class);</b> <br>  This instruction creates a new instance of otherType each time it enters this state.  <i>otherType</i> must be of type <i>type</i> or an extension of <i>type</i> <br>  <b>entityState.add (type: Class) .withInstance (instance: *);</b> <br>  This method makes it possible to use the same instance of the Component class when returning to this state. <br><br>  And finally <br><br>  <b>entityState.add (type: Class) .withSingleton ();</b> <br>  or <br>  <b>entityState.add (type: Class) .withSingleton (otherType: Class);</b> <br>  will create a singleton and will use it every time it returns to this state.  This is the same as using the <i>withInstance</i> method, but the <i>withSingleton</i> method <i>will</i> not create an instance of the class until it is needed.  If <i>otherType is</i> not specified, a singleton of type is created.  If <i>otherType</i> is specified, it must be of type <i>type</i> , or extend it. <br><br>  Finally, you can define the Component yourself by implementing the <a href="">IComponentProvider</a> interface <a href="">.</a> <br>  <b>entityState.add (type: Class) .withProvider (provider: IComponentProvider);</b> <br>  The <i>IComponentProvider</i> interface <i>is</i> defined as follows. <br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IComponentProvider</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getComponent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : *</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">identifier</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : *</span></span>; }</code> </pre><br>  The <i>getComponent</i> method returns an instance of the component.  The <i>identifier</i> property is used to compare two providers to ensure that they return the same Component.  This is necessary in order to exclude the replacement of the Component, if two different states use the same Component. <br><br>  The methods are designed to be ‚Äúchained‚Äù so that you can create flexible interfaces, as you will see in the following example. <br><br>  <b>Back to examples</b> <br><br>  If we apply these new tools for example with a space ship, the code will take the following form <br><br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fsm : EntityStateMachine = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EntityStateMachine( spaceshipEntity ); fsm.createState( <span class="hljs-string"><span class="hljs-string">"playing"</span></span> ) .add( Motion ).withInstance( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Motion( <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span> ) ) .add( MotionControls ) .withInstance( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MotionControls( Keyboard.LEFT, Keyboard.RIGHT, Keyboard.UP, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span> ) ) .add( Gun ).withInstance( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Gun( <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0.3</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> ) ) .add( GunControls ).withInstance( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GunControls( Keyboard.SPACE ) ) .add( Collision ).withInstance( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Collision( <span class="hljs-number"><span class="hljs-number">9</span></span> ) ) .add( Display ).withInstance( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Display( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpaceshipView() ) ); fsm.createState( <span class="hljs-string"><span class="hljs-string">"destroyed"</span></span> ) .add( DeathThroes ).withInstance( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DeathThroes( <span class="hljs-number"><span class="hljs-number">5</span></span> ) ) .add( Display ).withInstance( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Display( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpaceshipDeathView() ) ); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> spaceshipComponent : Spaceship = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Spaceship(); spaceshipComponent.fsm = fsm; spaceshipEntity.add( spaceshipComponent ); fsm.changeState( <span class="hljs-string"><span class="hljs-string">"playing"</span></span> );</code> </pre><br><br>  As a result, the change of the current State will be simplified as much as possible: <br><br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( spaceship = spaceships.head; spaceship; spaceship = spaceship.next ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( asteroid = asteroids.head; asteroid; asteroid = asteroid.next ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( Point.distance( asteroid.position.position, spaceship.position.position ) &lt;= asteroid.position.collisionRadius + spaceship.position.collisionRadius ) { spaceship.spaceship.fsm.changeState( <span class="hljs-string"><span class="hljs-string">"destroyed"</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }</code> </pre><br></div><p>Source: <a href="https://habr.com/ru/post/219007/">https://habr.com/ru/post/219007/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../218993/index.html">Configuring Intel Galileo from scratch to installing Debian full version</a></li>
<li><a href="../218995/index.html">The path from the concept to the "mature" prototype device</a></li>
<li><a href="../218997/index.html">The introduction of open source vocational education in secondary schools. Is it possible to?</a></li>
<li><a href="../218999/index.html">The task of finding the minimum domain containing all the specified sequences</a></li>
<li><a href="../219001/index.html">Building Test Environments with OpenStack</a></li>
<li><a href="../219011/index.html">Robot printer</a></li>
<li><a href="../219013/index.html">Managerial fights - technology managers training, assessment tool and sport</a></li>
<li><a href="../219015/index.html">Delivering updates from a MySQL database to an application using the libslave replication client</a></li>
<li><a href="../219019/index.html">ART runtime issues on Android</a></li>
<li><a href="../219021/index.html">Google will provide all US residents the opportunity in one day to buy Google Glass glasses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>