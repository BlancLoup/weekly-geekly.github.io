<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Microsoft Moles Isolation Framework, digging deeper</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you understand from the title, it will be about the product from Microsoft Research - Microsoft Moles Isolation Framework . I met him for the first...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Microsoft Moles Isolation Framework, digging deeper</h1><div class="post__text post__text-html js-mediator-article">  As you understand from the title, it will be about the product from Microsoft Research - <a href="http://research.microsoft.com/en-us/projects/moles/">Microsoft Moles Isolation Framework</a> .  I met him for the first time after reading the <a href="http://habrahabr.ru/blogs/net/98571/">post</a> alak_sys <a href="http://alek-sys.habrahabr.ru/">habrauser</a> .  I liked the mole so much that I decided to share my experience of using it. <br><br><h4>  <b>What for?</b> </h4><br>  To begin with, let's try to decide for what purposes Microsoft.Moles is intended and what we can achieve with it: <br><ul><li>  Complete isolation of the tested logic from the external environment. </li><li>  The ability to quickly and easily create unit tests, whereby the testing of class logic becomes possible even if there is no implementation of the classes whose user is the class under test. </li><li>  It becomes easy to organize test cases or model the state of related objects to create test conditions. </li><li>  At times, the execution time of unit tests is reduced, frequent test runs become real </li><li>  Violation of the logic of a unit does not entail the fall of a hundred or two tests not intended for its testing. </li><li>  Convenient testing of methods with complex workflow </li></ul><br><a name="habracut"></a><br><h4>  <b>About unit testing in general</b> </h4><br>  If you have the above goals raise doubts, it is worth a little to refresh the main points of the testing unit.  If you have any doubts, you can skip to the next <a href="https://habr.com/ru/post/101408/">section</a> . <br><br><h5>  What is unit testing for? </h5><ul><li>  Isolate the individual units of the program and show that individually (or a combination of several units) are operational. </li><li>  Documenting the logic of units - in order to understand how a unit functions - it is enough to read the code of its tests. </li><li>  Simplification of refactoring - you can easily check that the code works without errors after making changes. </li><li>  Reducing the time of bugfix due to the correction of most errors in the development process.  Minimize the possibility of regression. </li></ul><h5>  Unit Test Requirements </h5><ul><li>  The test should test the minimum amount of class code, and the number of tests for this code should be proportional to the number of code execution paths. </li><li>  Test implementation should be as simple as possible and not require initialization of the test environment outside of the test (for example, preparing test data in the database). </li><li>  The test must be self-documenting - an outside developer must understand the logic of the unit after reading the tests implemented for this unit.  Without the need to examine the contents of the database or other sources of test data </li><li>  The test should be as simple as possible - it is much easier to understand a dozen simple tests implemented for each individual test case than in a single test that tests all these test cases. </li><li>  A test crash should not be related to logic for which it was not intended to be tested. </li><li>  Passing the test should not depend on external systems (database server, web server, file system, external device controllers), if it is not designed to test interaction with these systems. </li><li>  You need maximum code coverage with tests with minimum time to complete them. </li></ul><br><h5>  What problems arise when using unit tests? </h5><ul><li>  The challenges of preparing a test environment are the creation of large test data sets, the creation of various connections to servers, the description of configuration files, the need to create external device emulators, and so on. </li><li>  The complexity of testing a particular class, since a class is often a user of other classes, and the presence of errors in their work entails a drop in the test, which is not in line with the unit testing paradigm - the test should fall if the tested logic is broken. </li><li>  The difficulty of ensuring 100% code coverage of tests (as a rule, this is due to the developer‚Äôs laziness and the first two problems) </li><li>  The complexity of the maintenance (debugging, fix) tests that comes from the first two reasons. </li><li>  The impossibility of accessing (except for reflection) to the hidden members of classes, the impossibility of initializing readonly members with test values. </li><li>  Often the drop in the test is due to the fact that the logic of another unit (and not the one being tested) was violated.  We have to spend time looking for errors in the wrong places. </li><li>  Test time - the main requirement for unit tests is their frequent execution (made a change in the unit, drove the tests), but it is often impossible to do this because the tests run too long, for large projects this time can be measured in hours.  Moreover, most of the time is taken by processes not directly related to testing - reading / writing of the database, file system, web servers, etc., initialization of the associated logic, which is not directly related to the test. </li></ul><br><h5>  Toolkit for unit testing. </h5><br>  At the moment there are a large number of frameworks (NUnit, JUnit, DUnit, xUnit, MSTest) for a variety of programming languages ‚Äã‚Äãdesigned to create and use automated tests for various purposes (Unit Tests, Integration Tests, Functional Tests, UI Tests).  As a rule, they do not allow creating full-fledged unit tests in a pure form, since they cannot ensure complete isolation of the code under test from the surrounding logic.  Developers have to resort to various tricks, create a cloud of additional mock classes, use reflection, and so on.  And here comes the help of Isolation Frameworks, which allow you to quickly and conveniently organize an isolated environment for performing unit tests, and Microsoft Moles is one of them. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  <b>What can Microsoft.Moles?</b> </h4><br>  I will try to demonstrate the capabilities that Moles provides us with an example (I tried to make it as simple as possible, but difficult enough to use Moles in it). <br><br>  Suppose we have a FileUpdater class, with the only method UpdateFileFromService (string fileId), whose task is to update the file in the local storage with the file downloaded from the remote storage if the local and remote file hashes do not match. <br>  As you can see from the listing, the UpdateFileFromService method uses the FileManager and StorageService classes to access local and remote storage.  I intentionally do not provide an implementation of the methods of the FileManager and StorageService classes, so all we need to know is their interface. <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> FileUpdater <br> { <br> <font color="#0000ff">private</font> StorageService storageService; <br> <br> <font color="#0000ff">public</font> StorageService Service <br> { <br> <font color="#0000ff">get</font> <br> { <br> <font color="#0000ff">if</font> (storageService == <font color="#0000ff">null</font> ) <br> { <br> storageService = <font color="#0000ff">new</font> StorageService(); <br> } <br> <font color="#0000ff">return</font> storageService; <br> } <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> UpdateFileFromService( <font color="#0000ff">string</font> fileId) <br> { <br> <font color="#0000ff">if</font> ( <font color="#0000ff">string</font> .IsNullOrEmpty(fileId)) <br> { <br> <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">"fileId is empty"</font> ); <br> } <br> <font color="#0000ff">var</font> fileManager = <font color="#0000ff">new</font> FileManager(); <br> <font color="#0000ff">string</font> localFileHash = fileManager.GetFileHash(fileId); <br> <font color="#0000ff">string</font> remoteFileHash = Service.GetFileHash(fileId); <br> <font color="#0000ff">if</font> (localFileHash != remoteFileHash) <br> { <br> <font color="#2B91AF">FileStream</font> file = Service.DownloadFile(fileId); <br> fileManager.SaveFile(fileId, remoteFileHash, file); <br> } <br> } <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> FileManager <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> GetFileHash( <font color="#0000ff">string</font> fileId) <br> { <br> <font color="#0000ff">throw</font> <font color="#0000ff">new</font> NotImplementedException(); <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> SaveFile( <font color="#0000ff">string</font> fileId, <font color="#0000ff">string</font> remoteFileHash, <font color="#2B91AF">FileStream</font> file) <br> { <br> <font color="#0000ff">throw</font> <font color="#0000ff">new</font> NotImplementedException(); <br> } <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> StorageService <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> GetFileHash( <font color="#0000ff">string</font> fileId) <br> { <br> <font color="#0000ff">throw</font> <font color="#0000ff">new</font> NotImplementedException(); <br> } <br> <br> <font color="#0000ff">public</font> <font color="#2B91AF">FileStream</font> DownloadFile( <font color="#0000ff">string</font> fileId) <br> { <br> <font color="#0000ff">throw</font> <font color="#0000ff">new</font> NotImplementedException(); <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  The following embodiments of the <b>UpdateFileFromService</b> method are <b>obvious</b> : <br><ol><li>  fileId - empty string </li><li>  local and remote file hashes are not identical </li><li>  local and remote file hashes are identical </li></ol>  We will not consider the remaining situations, since this implementation of the FileUpdater class does not contain their processing. <br>  Let's try to create tests for options 2 and 3 using Microsoft.Moles, since the implementation of the test for the first case is elementary using standard tools of any test framework. <br><br><h6>  Generation of Mole and Stub classes </h6><br>  First of all, it is necessary to generate a Moled assembly for libraries in which there are classes, the logic of which we will replace with custom delegates (otherwise, Stub-methods).  This can be done using the command line using mole.exe, which comes in the installation package with Microsoft.Moles, as well as through the Visual Studio 2008/2010 interface.  We use the second method. <br>  As you can see, after installing Microsoft.Moles, a new item of the context menu <b>‚ÄúAdd Moles Assembly‚Äù</b> appeared for the reference assemblies (Fig. 1). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c2a/3c7/26d/c2a3c726dd75ae0e947b6a7f6ddc6cc7.jpg" title="Figure 1: Adding the Moled Assembly to the ClassLibrary1 assembly"><br><br>  After executing this command on the ClassLibrary1 assembly, we get a new group of <b>ClassLibrary1.moles</b> files (Fig.2), from which the ClassLibrary1.moles file is the Moled assembly handle, which contains its generation parameters and which can be changed if necessary.  The rest of the files are automatically regenerated with each build, and there is no point in editing them. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f20/f80/33d/f20f8033d47617972466d73aeadc6463.jpg" title="Fig.2 Generated Microsoft.Moles classes for assembling ClassLibrary1"><br><br>  Microsoft.Moles allows you to use two types of deputy classes - Stubs &amp; Moles. <br><ul><li>  Stub provides a lightweight isolation framework that is designed to fake implementations of abstract, virtual methods and interface members.  Suitable for substituting virtual methods or members that are implementations of interfaces </li><li>  Mole uses a powerful call forwarding framework that uses the code profiler APIs to intercept calls to the classes used, which redirects calls to the fake object.  Allows you to redirect a call to any member of the class. </li></ul>  For me personally, both options were equally convenient, and did not cause any difficulties in use. <br>  The generated assembly ClassLibrary1.Moles.dll by default contains pairs of classes M% ClassName% and S% ClassName% for each of the classes contained in the assembly ClassLibrary1.dll. <br>  Where: <br><ul><li>  M% ClassName% - Mole class </li><li>  S% ClassName% - Stub class </li></ul><br>  If you wish, by making changes to the <b>ClassLibrary1.moles</b> file, you can ensure that Moles or Stubs are generated only for certain classes (which greatly reduces generation time), or you can turn off generation of Moles or Stubs altogether if you do not use it, and also set other generation parameters (Intellisence will prompt a list of valid parameters and their purpose).  You can also use the ClassLibrary1.moles <b>file</b> when generating with the command line moles.exe (you can familiarize yourself with the list of moles.exe parameters by running moles.exe without parameters). <br><br><h6>  Using Mole Classes </h6><br>  Since the use of Moles and Stubs is somewhat similar, and the article does not pretend to provide a complete description of all the functionality of Microsoft.Moles - we‚Äôll dwell only on the examples of using Mole. <br>  To make the examples clearer, I would immediately note the particular naming of members of the generated Mole and Stub classes ‚Äî first the name of the member of the original class comes, and then the names of the types of the parameters passed are added to it.  For example, <b>MFileManager.AllInstances.GetFileHashString</b> is a property to <b>override the FileManager.GetFileHash</b> method <b>(string fileId)</b> .  I think this style is associated with the need to ensure the uniqueness of the members generated for the overloaded methods. <br>  With Mole, we get the ability to replace any methods and properties of classes in various ways: <br><ul><li>  Replacing all instances of a class <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">MFileManager.AllInstances.GetFileHashString = (fileManager, fileId) =&gt; <br> { <br> <font color="#008000">//       GetFileHash(string fileId)    FileManager</font> <br> <font color="#0000ff">return</font> <font color="#2B91AF">Guid</font> .NewGuid().ToString(); <br> };</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Substitution of static classes and static properties is performed in the same way, only without specifying <b>AllInstances</b> . <br></li><li>  Substitution of a specific class instance <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">var</font> storageServiceMole = <font color="#0000ff">new</font> MStorageService(); <br> storageServiceMole.GetFileHashString = (fileId) =&gt; <br> { <br> <font color="#008000">//       GetFileHash(string fileId)  storageService  StorageService</font> <br> <font color="#0000ff">return</font> testRemoteHash; <br> }; <br> <font color="#0000ff">var</font> storageService = storageServiceMole.Instanc</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  or so, with the transfer of the initialized class object in the constructor <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">var</font> storageService = <font color="#0000ff">new</font> StorageService(); <br> <font color="#0000ff">var</font> storageServiceMole = <font color="#0000ff">new</font> MStorageService(storageService); <br> storageServiceMole.GetFileHashString = (fileId) =&gt; <br> { <br> <font color="#008000">//       GetFileHash(string fileId)  storageService  StorageService</font> <br> <font color="#0000ff">return</font> testRemoteHash; <br> };</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> </li><li>  Replacing the class constructor in order to override the necessary members of the Mole class with objects for all instances of the class. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">MFileUpdater.Constructor = (@ <font color="#0000ff">this</font> ) =&gt; <br> { <br> <font color="#0000ff">var</font> mole = <font color="#0000ff">new</font> MFileUpdater(@ <font color="#0000ff">this</font> ); <br> mole.ServiceGet = (x) =&gt; initializedServiceInstance; <br> };</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> </li><li>  Substitution with further reference to the original implementation of the class.  If you need to perform some checks on incoming values ‚Äã‚Äãbefore calling the original class method, use the following method <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">var</font> fileUpdaterMole = <font color="#0000ff">new</font> MFileUpdater() { InstanceBehavior = MoleBehaviors.Fallthrough }; <br> fileUpdaterMole.UpdateFileFromServiceString = (y) =&gt; <br> { <br> fileUpdaterMole.UpdateFileFromServiceString = <font color="#0000ff">null</font> ; <font color="#008000">//     </font> <br> fileUpdaterMole.Instance.UpdateFileFromService(y); <font color="#008000">//      FileUpdater.UpdateFileFromService</font> <br> }; <br> fileUpdaterMole.Instance.UpdateFileFromService( <font color="#2B91AF">Guid</font> .NewGuid().ToString());</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> </li></ul><br>  It is obvious that in lambda expressions you can perform various checks of Assert incoming values ‚Äã‚Äãor simulate some de <br>  Activity with the return of a predetermined result. <br><br><h6>  InstanceBehavior </h6><br>  It is also worth noting the possibility of specifying the behavior of members of the class to whom we do not explicitly specify a replacement delegate.  Each Mole generated class has an InstanceBehavior property, which can have the following values <br><ul><li>  <b>MoleBehaviors.DefaultValue</b> - the unsubstituted members of the class will be replaced with an empty delegate and return the default value of the return type <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">var</font> storageService = <font color="#0000ff">new</font> StorageService(); <br> <font color="#0000ff">var</font> storageServiceMole = <font color="#0000ff">new</font> MStorageService(storageService) { InstanceBehavior = MoleBehaviors.DefaultValue }; <br> <font color="#008000">//    null;</font> <br> <font color="#0000ff">var</font> result = storageService.GetFileHash( <font color="#2B91AF">Guid</font> .NewGuid().ToString());</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> </li><li>  <b>MoleBehaviors.NotImplemented</b> - when accessing an unsubstituted member, a <i>NotImplementedException</i> exception will occur <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">var</font> storageService = <font color="#0000ff">new</font> StorageService(); <br> <font color="#0000ff">var</font> storageServiceMole = <font color="#0000ff">new</font> MStorageService(storageService) { InstanceBehavior = MoleBehaviors.NotImplemented }; <br> <font color="#008000">//    NotImplementedException</font> <br> storageService.GetFileHash( <font color="#A31515">"328576BA-7345-4847-84AC-170EF03FFA7A"</font> );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> </li><li>  <b>MoleBehaviors.Fallthrough</b> - calls to unsubstituted members will be processed according to their original implementation in the class being replaced. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">var</font> storageService = <font color="#0000ff">new</font> StorageService(); <br> <font color="#0000ff">var</font> storageServiceMole = <font color="#0000ff">new</font> MStorageService() {InstanceBehavior = MoleBehaviors.Fallthrough}; <br> <font color="#008000">//        StorageService.GetFileHash(string fileId)</font> <br> storageService.GetFileHash( <font color="#A31515">"328576BA-7345-4847-84AC-170EF03FFA7A"</font> );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> </li><li>  <b>MoleBehaviors.Current</b> - default behavior of unsubstituted methods after overlaying the instance of the Mole class with a class.  When calling an unsubstituted member, a <i>MoleNotImplementedException</i> exception will be thrown <i>.</i> <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">var</font> storageService = <font color="#0000ff">new</font> StorageService(); <br> <font color="#0000ff">var</font> storageServiceMole = <font color="#0000ff">new</font> MStorageService() {InstanceBehavior = MoleBehaviors.Current}; <br> <font color="#008000">//    MoleNotImplementedException</font> <br> storageService.GetFileHash( <font color="#A31515">"328576BA-7345-4847-84AC-170EF03FFA7A"</font> );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> </li><li>  <b>MoleBehaviors.CurrentProxy</b> leaves the current behavior for all non-overlapping members of the class instance that is being blocked <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">var</font> storageService = <font color="#0000ff">new</font> StorageService(); <br> <font color="#0000ff">var</font> storageServiceMole1 = <font color="#0000ff">new</font> MStorageService(storageService) { InstanceBehavior = MoleBehaviors.NotImplemented }; <br> storageServiceMole1.GetFileHashString = (fileId) =&gt; <br> { <br> <font color="#0000ff">return</font> <font color="#2B91AF">Guid</font> .NewGuid().ToString(); <br> }; <br> <font color="#0000ff">var</font> storageServiceMole2 = <font color="#0000ff">new</font> MStorageService(storageService) { InstanceBehavior = MoleBehaviors.CurrentProxy }; <br> storageServiceMole2.DownloadFileString = (fileId) =&gt; <br> { <br> <font color="#0000ff">return</font> testFileStream; <br> }; <br> <font color="#008000">//     storageServiceMole1.GetFileHashString</font> <br> storageService.GetFileHash( <font color="#A31515">"328576BA-7345-4847-84AC-170EF03FFA7A"</font> ); <br> <font color="#008000">//     storageServiceMole2.GetFileHashString</font> <br> storageService.DownloadFile( <font color="#A31515">"328576BA-7345-4847-84AC-170EF03FFA7A"</font> );</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> </li><li>  Custom behavior implementation - possible if you create your own IMoleBehavior interface implementation </li></ul><br><h6>  Test implementation example </h6><br>  This is actually a test of the situation when the hashes of the local and remote files are different. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">///</font> <br> <font color="#008000">///  ,       </font> <br> <font color="#008000">///</font> <br> [TestMethod] <br> [HostType( <font color="#A31515">"Moles"</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> TestUpdateFileNonMatchedHash() <br> { <br> <font color="#0000ff">var</font> callOrder = 0; <font color="#008000">//        </font> <br> <font color="#0000ff">var</font> testFileId = <font color="#2B91AF">Guid</font> .NewGuid().ToString(); <br> <font color="#0000ff">var</font> testLocalHash = <font color="#2B91AF">Guid</font> .NewGuid().ToString(); <br> <font color="#0000ff">var</font> testRemoteHash = <font color="#2B91AF">Guid</font> .NewGuid().ToString(); <br> <font color="#0000ff">var</font> testFileStream = <font color="#0000ff">new</font> <font color="#2B91AF">FileStream</font> ( <font color="#A31515">@"c:\testfile.txt"</font> , <font color="#2B91AF">FileMode</font> .OpenOrCreate); <br> <br> <font color="#0000ff">var</font> storageServiceMole = <font color="#0000ff">new</font> MStorageService() { InstanceBehavior = MoleBehaviors.Fallthrough }; <br> <font color="#008000">//  GetFileHash  StorageService</font> <br> storageServiceMole.GetFileHashString = (fileId) =&gt; <br> { <br> Assert.AreEqual(1, callOrder++); <font color="#008000">//      </font> <br> Assert.AreEqual(testFileId, fileId); <br> Assert.AreNotEqual(testLocalHash, testRemoteHash); <br> <font color="#0000ff">return</font> testRemoteHash; <br> }; <br> storageServiceMole.DownloadFileString = (fileId) =&gt; <br> { <br> Assert.AreEqual(2, callOrder++); <br> Assert.AreEqual(testFileId, fileId); <br> <font color="#0000ff">return</font> testFileStream; <br> }; <br> <font color="#008000">//   FileManager.</font> <br> <font color="#008000">//MFileManager.AllInstances      FileManager     UpdateFile</font> <br> <font color="#008000">//         ,    </font> <br> <font color="#008000">//    FileManager</font> <br> MFileManager.AllInstances.GetFileHashString = (fileManager, fileId) =&gt; <br> { <br> Assert.AreEqual(0, callOrder++); <br> Assert.AreEqual(testFileId, fileId); <br> <font color="#0000ff">return</font> <font color="#2B91AF">Guid</font> .NewGuid().ToString(); <br> }; <br> MFileManager.AllInstances.SaveFileStringStringFileStream = (fileManager, fileId, fileHash, fileStream) =&gt; <br> { <br> Assert.AreEqual(3, callOrder++); <br> Assert.AreEqual(testFileId, fileId); <br> Assert.AreEqual(testRemoteHash, fileHash); <br> Assert.AreSame(testFileStream, fileStream); <br> }; <br> <font color="#0000ff">var</font> fileUpdaterMole = <font color="#0000ff">new</font> MFileUpdater <br> { <br> InstanceBehavior = MoleBehaviors.Fallthrough, <br> <font color="#008000">// getter  FileUpdater.Service  ,      moled   StorageService</font> <br> ServiceGet = () =&gt; storageServiceMole.Instance <br> }; <br> <font color="#0000ff">var</font> fileUpdater = fileUpdaterMole.Instance; <br> <br> fileUpdater.UpdateFileFromService(testFileId); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  For the second situation - when the hashes are identical, try implementing the test yourself. <br><br><h5>  additional information </h5><br><ul><li>  Mole types cannot be used in multi-threaded tests. </li><li>  Moles cannot be used to replace certain types of mscorlib. </li><li>  Tests using Microsoft.Moles must be instrumented by Moles ‚Äî for MSTest, this is an attribute of the <b>HostType</b> test method <b>(‚ÄúMoles‚Äù)</b> .  For other test frameworks, you need to run tests using moles.runner.exe (for nunit, it will look like <i>moles.runner.exe "yourTestDLLName" /runner:nunit-console.exe</i> ) Accordingly, those who like to work with the test framework via the GUI will also have to run shell via mole.exe </li><li>  Nant task configuration example for invoking tests that moles instructs <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">target</font> <font color="#ff0000">name</font> <font color="#0000ff">="runTests"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">exec</font> <font color="#ff0000">basedir</font> <font color="#0000ff">="${build.dir.unittests}"</font> <font color="#ff0000">program</font> <font color="#0000ff">="${microsoft.moles.dir}moles.runner.exe"</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">arg</font> <font color="#ff0000">value</font> <font color="#0000ff">="/Runner:${nunit.console.dir}nunit-console.exe"</font> <font color="#0000ff">&gt;&lt;/</font> <font color="#800000">arg</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;</font> <font color="#800000">arg</font> <font color="#ff0000">value</font> <font color="#0000ff">="${build.dir.unittests}My.UnitTests.dll"</font> <font color="#0000ff">&gt;&lt;/</font> <font color="#800000">arg</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">exec</font> <font color="#0000ff">&gt;</font> <br> <font color="#0000ff">&lt;/</font> <font color="#800000">target</font> <font color="#0000ff">&gt;</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> </li></ul><br><br>  At this point I‚Äôll finish, it may be continued if this information turns out to be interesting. <br><br><h4>  <b>Sources</b> </h4><br>  <a href="http%253A%252F%252Fresearch.microsoft.com%252Fen-us%252Fprojects%252Fpex%252Fmolesmanual.docx%26ei%3DySBcTKTfLNaVOJin9aIP%26usg%3DAFQjCNF1LNwin6xDwqqzZBl4aUvPOwKHHQ%26sig2%3DdfcI3bSSOAkdkzTvxhCFuQ">Microsoft Moles Reference Manual</a> <br>  <a href="http://thecodersperspective.posterous.com/using-ms-moles-with-nunit-nant-and-net-35">Using MS Moles with NUnit, NAnt and .NET 3.5</a> <br>  <a href="http://msdn.microsoft.com/en-us/library/ff798506.aspx">MSDN - The Moles Framework</a> </div><p>Source: <a href="https://habr.com/ru/post/101408/">https://habr.com/ru/post/101408/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../101398/index.html">iPhoDroid 0.6 R13 1Shot - Almost Ready</a></li>
<li><a href="../101400/index.html">Layout of the text in two columns in pure CSS</a></li>
<li><a href="../101401/index.html">The communication link between the car and the tires was hacked</a></li>
<li><a href="../101403/index.html">Scrum implementation in TrackStudio</a></li>
<li><a href="../101405/index.html">One day file storage service</a></li>
<li><a href="../101409/index.html">Gigabit IPA Beer</a></li>
<li><a href="../101410/index.html">Chaos and order: peaceful coexistence</a></li>
<li><a href="../101411/index.html">Do Google and Verizon comply with net neutrality principles?</a></li>
<li><a href="../101412/index.html">BIizlimit Internet: can come out, maybe not!</a></li>
<li><a href="../101413/index.html">3D is gaining momentum, now on MTV</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>