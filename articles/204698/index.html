<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Solution Zeronights Crackme 2013 and where does the matrix</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello to all. Recently, an article appeared on Habr√© describing a crackme from Kaspersky Lab from the ZeroNights 2013 conference. I also managed to cr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Solution Zeronights Crackme 2013 and where does the matrix</h1><div class="post__text post__text-html js-mediator-article">  Hello to all.  Recently, <a href="http://habrahabr.ru/post/204432/">an article</a> appeared on Habr√© describing a crackme from Kaspersky Lab from the ZeroNights 2013 conference. I also managed to crack this crackme, but I used a slightly different approach to creating keys than Darwin, because I noticed that crackme uses matrix operations.  Unlike Darwin, I only used debugging with OllyDbg. <br><a name="habracut"></a><br>  Enter random values.  Get MessageBox with Fail: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0b6/de5/88a/0b6de588a3f48fe7579b4ba9afc6d78d.png" alt="image"><br><br>  Open the Modules window (large M) in an ollie.  Press Ctrl + B (Search).  Enter the value fail in the ASCII field.  Hit on search - found: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/a83/7c1/1bd/a837c11bdbacfa5165f3c51214f8bee2.png" alt="image"><br><br>  Right-click on the first byte of the message, Breakpoit -&gt; Memory -&gt; On Access. <br><br>  We start debugging.  Enter the same values ‚Äã‚Äãin the crackme fields.  We get on passing the MessageBox parameters: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/635/622/850/635622850c646cf5f9827798044a2b97.png" alt="image"><br><br>  Before push with our line the conditional transition JNZ is visible.  Before him TEST EAX, EAX.  That is, if EAX is not zero, then MessageBox crashes with the string <blockquote>  Good work, serial is valid! </blockquote>  .  We look, whence we receive EAX.  Before comparison, there is a CALL.  Apparently, in this function the key is checked.  Let's see what's being passed on to her.  Through the stack, the length of the password and the pointer to the mail line are transmitted.  In the ECX register, a pointer is passed to the string with the password.  Enter the function: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6a7/207/c15/6a7207c156e7da592925ce8f8026a5d6.png" alt="image"><br><br>  We look at the first JNZ.  Before it, the password length is compared with 0x12 (18 in decimal).  If not, Fail.  Next is the cycle (it is highlighted with a black bracket on the left), in which the password character is checked.  They must belong to the sets 0-9, AZ and az.  From the comments on the right one can understand that not all functions are important for reverse.  Some are simply functions of copying or highlighting arrays and are not of particular interest.  The first function after the loop is very important, so we will consider it in detail: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/949/50c/55f/94950c55f20d4510176c44f3771b4307.png" alt="image"><br><br>  Immediately noticeable two cycles.  What happens in them?  In the first, we fill the array in memory with values ‚Äã‚Äãfrom 0 to 255. <br>  In the second cycle, everything is not so simple.  Two pointers are taken: on the array, filled in the first cycle, and on the line with the mail.  An array element is taken by the cycle number and a character from the mail by the cycle number modulo the mail length.  These bytes are summed modulo 256 (AND AND EDI operation, 0xFF is equivalent to __edi% 0x100 in syntax C).  2 item numbers are obtained in a loop step and received at the expense of mail.  These 2 elements are swapped.  Mail is the key with which the substitution of elements from 0 to 256 is performed. Simply the array is mixed.  We leave from this function back to the general.  Next, the array is allocated to 9 bytes and the first 9 characters of the password are copied into it.  We will not consider these functions.  Let's enter the function with a comment on translit starting with ‚ÄúhHeap zabivajetsa‚Äù: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/390/9b5/d8d/3909b5d8d45a7740ecaba034ec760446.png" alt="image"><br><br>  It looks scary, but if you look closely, you can see that the actions are repeated, which means that we have a developed cycle.  It is enough to consider only one iteration, everything else is identical. <br><br>  The first character of the array of 9 bytes is placed in EDX.  That is the first character of the password.  Further magic: <br><br>  MOV EAX, EDX <br>  SHR EAX, 4 <br>  SHL EAX, 3 <br>  SUB EDX, EAX <br>  AND EDX, 0F <br><br>  In C, it will be: <pre><code class="cpp hljs">EDX=(EDX- ((EDX &gt;&gt;<span class="hljs-number"><span class="hljs-number">4</span></span> )&lt;&lt;<span class="hljs-number"><span class="hljs-number">3</span></span>))%<span class="hljs-number"><span class="hljs-number">16</span></span></code> </pre> <br><br>  Replace the password character in hHeap with the value from our mixed array using the EDX number.  For the remaining characters is similar.  Exit the function. <br><br>  Another array is allocated for 9 bytes and the values ‚Äã‚Äãfrom the first array are transferred to it, but according to certain rules: <br><br><img src="https://habrastorage.org/storage3/b37/ca8/1b9/b37ca81b9d43ef37c4ec71aaea2f2afa.png" alt="image"><br><br>  Moving is a block of MOV and MOVZX.  Let the first array A, and the second - B. On C: <br><pre> <code class="cpp hljs">b[<span class="hljs-number"><span class="hljs-number">0</span></span>]=a[<span class="hljs-number"><span class="hljs-number">0</span></span>]; b[<span class="hljs-number"><span class="hljs-number">1</span></span>]=a[<span class="hljs-number"><span class="hljs-number">1</span></span>]; b[<span class="hljs-number"><span class="hljs-number">2</span></span>]=a[<span class="hljs-number"><span class="hljs-number">2</span></span>]; b[<span class="hljs-number"><span class="hljs-number">3</span></span>]=a[<span class="hljs-number"><span class="hljs-number">5</span></span>]; b[<span class="hljs-number"><span class="hljs-number">4</span></span>]=a[<span class="hljs-number"><span class="hljs-number">3</span></span>]; b[<span class="hljs-number"><span class="hljs-number">5</span></span>]=a[<span class="hljs-number"><span class="hljs-number">4</span></span>]; b[<span class="hljs-number"><span class="hljs-number">6</span></span>]=a[<span class="hljs-number"><span class="hljs-number">8</span></span>]; b[<span class="hljs-number"><span class="hljs-number">7</span></span>]=a[<span class="hljs-number"><span class="hljs-number">6</span></span>]; b[<span class="hljs-number"><span class="hljs-number">8</span></span>]=a[<span class="hljs-number"><span class="hljs-number">7</span></span>];</code> </pre><br><br>  After that, copy from second to first.  It turns out, just mixed. <br><br>  All actions with an array of nine bytes are repeated for the second part of the password.  We get two arrays: <br><br><img src="https://habrastorage.org/storage3/257/d7b/be0/257d7bbe0dd3328a0715db2052122b03.png" alt="image"><br><br>  Go to the function "moshnaja obrabotka kuchi": <br><br><img src="https://habrastorage.org/storage3/cfd/6b9/207/cfd6b9207c1a36514b437f5cf43334e4.png" alt="image"><br><br>  We see the transfer of the second array to the stack.  We denote the array by B, and the beginning of the region to which we are transferred - D. On : <br><br><pre> <code class="cpp hljs">D[<span class="hljs-number"><span class="hljs-number">0</span></span>]=B[<span class="hljs-number"><span class="hljs-number">0</span></span>]; D[<span class="hljs-number"><span class="hljs-number">1</span></span>]=B[<span class="hljs-number"><span class="hljs-number">3</span></span>]; D[<span class="hljs-number"><span class="hljs-number">2</span></span>]=B[<span class="hljs-number"><span class="hljs-number">6</span></span>]; D[<span class="hljs-number"><span class="hljs-number">3</span></span>]=B[<span class="hljs-number"><span class="hljs-number">1</span></span>]; D[<span class="hljs-number"><span class="hljs-number">4</span></span>]=B[<span class="hljs-number"><span class="hljs-number">4</span></span>]; D[<span class="hljs-number"><span class="hljs-number">5</span></span>]=B[<span class="hljs-number"><span class="hljs-number">7</span></span>]; D[<span class="hljs-number"><span class="hljs-number">6</span></span>]=B[<span class="hljs-number"><span class="hljs-number">2</span></span>]; D[<span class="hljs-number"><span class="hljs-number">7</span></span>]=B[<span class="hljs-number"><span class="hljs-number">5</span></span>]; D[<span class="hljs-number"><span class="hljs-number">8</span></span>]=B[<span class="hljs-number"><span class="hljs-number">8</span></span>];</code> </pre><br><br>  Next is a long cycle that runs 3 times: <br><br><img src="https://habrastorage.org/storage3/b1e/b2e/73d/b1eb2e73da6a06c0ae07d0bd69664995.png" alt="image"><br><br><img src="https://habrastorage.org/storage3/8a0/6c4/66c/8a06c466c832b1ed11b3a329b0a6288b.png" alt="image"><br>  Not everyone will have enough patience, so just replace it with the algorithm in C. Let A be the first array, D the array in the stack, and E the new array for output, everything else is intermediate variables, and I am the decompiler.  Then: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;<span class="hljs-number"><span class="hljs-number">3</span></span>;i++){ X[<span class="hljs-number"><span class="hljs-number">0</span></span>]=A[<span class="hljs-number"><span class="hljs-number">0</span></span>+i*<span class="hljs-number"><span class="hljs-number">3</span></span>]; X[<span class="hljs-number"><span class="hljs-number">1</span></span>]=A[<span class="hljs-number"><span class="hljs-number">1</span></span>+i*<span class="hljs-number"><span class="hljs-number">3</span></span>]; X[<span class="hljs-number"><span class="hljs-number">2</span></span>]=A[<span class="hljs-number"><span class="hljs-number">2</span></span>+i*<span class="hljs-number"><span class="hljs-number">3</span></span>]; E[<span class="hljs-number"><span class="hljs-number">0</span></span>+i*<span class="hljs-number"><span class="hljs-number">3</span></span>]=((X[<span class="hljs-number"><span class="hljs-number">0</span></span>]*D[<span class="hljs-number"><span class="hljs-number">0</span></span>])%<span class="hljs-number"><span class="hljs-number">7</span></span>+(X[<span class="hljs-number"><span class="hljs-number">1</span></span>]*D[<span class="hljs-number"><span class="hljs-number">1</span></span>])%<span class="hljs-number"><span class="hljs-number">7</span></span>+(X[<span class="hljs-number"><span class="hljs-number">2</span></span>]*D[<span class="hljs-number"><span class="hljs-number">2</span></span>])%<span class="hljs-number"><span class="hljs-number">7</span></span>)%<span class="hljs-number"><span class="hljs-number">7</span></span>; E[<span class="hljs-number"><span class="hljs-number">1</span></span>+i*<span class="hljs-number"><span class="hljs-number">3</span></span>]=((X[<span class="hljs-number"><span class="hljs-number">0</span></span>]*D[<span class="hljs-number"><span class="hljs-number">3</span></span>])%<span class="hljs-number"><span class="hljs-number">7</span></span>+(X[<span class="hljs-number"><span class="hljs-number">1</span></span>]*D[<span class="hljs-number"><span class="hljs-number">4</span></span>])%<span class="hljs-number"><span class="hljs-number">7</span></span>+(X[<span class="hljs-number"><span class="hljs-number">2</span></span>]*D[<span class="hljs-number"><span class="hljs-number">5</span></span>])%<span class="hljs-number"><span class="hljs-number">7</span></span>)%<span class="hljs-number"><span class="hljs-number">7</span></span>; E[<span class="hljs-number"><span class="hljs-number">2</span></span>+i*<span class="hljs-number"><span class="hljs-number">3</span></span>]=((X[<span class="hljs-number"><span class="hljs-number">0</span></span>]*D[<span class="hljs-number"><span class="hljs-number">6</span></span>])%<span class="hljs-number"><span class="hljs-number">7</span></span>+(X[<span class="hljs-number"><span class="hljs-number">1</span></span>]*D[<span class="hljs-number"><span class="hljs-number">7</span></span>])%<span class="hljs-number"><span class="hljs-number">7</span></span>+(X[<span class="hljs-number"><span class="hljs-number">2</span></span>]*D[<span class="hljs-number"><span class="hljs-number">8</span></span>])%<span class="hljs-number"><span class="hljs-number">7</span></span>)%<span class="hljs-number"><span class="hljs-number">7</span></span>; }</code> </pre><br><br>  We leave the function, and the array of values ‚Äã‚Äãin E is compared with the array [1,0,0,0,1,0,0,0,1]: <br><br><img src="https://habrastorage.org/storage3/88d/a19/826/88da198267c4aaa3d8d2766c22acfa01.png" alt="image"><br><br>  If matched, then the serial is correct. <br><br>  So what is the matrix.  First, any array of nine elements can be represented as a 3 by 3 matrix. We use this assumption.  It turns out that the two parts of the password are two matrices.  Remember that strange shuffle: <br><br><pre> <code class="cpp hljs">b[<span class="hljs-number"><span class="hljs-number">0</span></span>]=a[<span class="hljs-number"><span class="hljs-number">0</span></span>]; b[<span class="hljs-number"><span class="hljs-number">1</span></span>]=a[<span class="hljs-number"><span class="hljs-number">1</span></span>]; b[<span class="hljs-number"><span class="hljs-number">2</span></span>]=a[<span class="hljs-number"><span class="hljs-number">2</span></span>]; b[<span class="hljs-number"><span class="hljs-number">3</span></span>]=a[<span class="hljs-number"><span class="hljs-number">5</span></span>]; b[<span class="hljs-number"><span class="hljs-number">4</span></span>]=a[<span class="hljs-number"><span class="hljs-number">3</span></span>]; b[<span class="hljs-number"><span class="hljs-number">5</span></span>]=a[<span class="hljs-number"><span class="hljs-number">4</span></span>]; b[<span class="hljs-number"><span class="hljs-number">6</span></span>]=a[<span class="hljs-number"><span class="hljs-number">8</span></span>]; b[<span class="hljs-number"><span class="hljs-number">7</span></span>]=a[<span class="hljs-number"><span class="hljs-number">6</span></span>]; b[<span class="hljs-number"><span class="hljs-number">8</span></span>]=a[<span class="hljs-number"><span class="hljs-number">7</span></span>];</code> </pre><br><br>  Each line of the matrix is ‚Äã‚Äãshifted to its number. <br><br>  Now let's take a closer look at transferring the second array to the stack: <br><br><pre> <code class="cpp hljs">D[<span class="hljs-number"><span class="hljs-number">0</span></span>]=B[<span class="hljs-number"><span class="hljs-number">0</span></span>]; D[<span class="hljs-number"><span class="hljs-number">1</span></span>]=B[<span class="hljs-number"><span class="hljs-number">3</span></span>]; D[<span class="hljs-number"><span class="hljs-number">2</span></span>]=B[<span class="hljs-number"><span class="hljs-number">6</span></span>]; D[<span class="hljs-number"><span class="hljs-number">3</span></span>]=B[<span class="hljs-number"><span class="hljs-number">1</span></span>]; D[<span class="hljs-number"><span class="hljs-number">4</span></span>]=B[<span class="hljs-number"><span class="hljs-number">4</span></span>]; D[<span class="hljs-number"><span class="hljs-number">5</span></span>]=B[<span class="hljs-number"><span class="hljs-number">7</span></span>]; D[<span class="hljs-number"><span class="hljs-number">6</span></span>]=B[<span class="hljs-number"><span class="hljs-number">2</span></span>]; D[<span class="hljs-number"><span class="hljs-number">7</span></span>]=B[<span class="hljs-number"><span class="hljs-number">5</span></span>]; D[<span class="hljs-number"><span class="hljs-number">8</span></span>]=B[<span class="hljs-number"><span class="hljs-number">8</span></span>];</code> </pre><br><br>  And this is the interpolation of the matrix.  Why do you need interpolation?  Because a function that takes two arrays of nine bytes per input multiplies them as matrices.  And where does% 7 come from?  It's simple.  The matrix cells use modular arithmetic in the field modulo 7. <br>  Then the array [1,0,0,0,1,0,0,0,1] is also clear.  In the matrix view, this is the identity matrix. <br><br>  So, how do we find the key for our mail?  I did not write Keigen, because there is no key for any mail, and now you will understand why. <br><br>  After mixing the array by mail, we get 16 items that we can use.  That is, we can put any of these elements in any cell of our two matrices.  Since then only modular arithmetic will be used, it is possible to establish the equivalence of these elements to the members of the field modulo 7. From these elements we need to choose two opposite matrices so that when multiplied, we obtain the identity matrix.  We try: <br><br><img src="https://habrastorage.org/storage3/15b/fe5/e70/15bfe5e705df85ff585db544a959cc33.png" alt="image"><br><br>  The main thing - do not forget about the offset to the line number. <br><br>  As we select opposite matrices: <br>  We find a symbol that turns into 0 and we find two symbols that turn into opposite elements (for example, 4 and 2). <br>  If we have 1 - we are lucky. <br><br>  The problem of Keygen is that we do not always have elements from which it is possible to make opposite matrices. <br><br>  Any tips and comments are welcome.  Thank you for reading to the end. </div><p>Source: <a href="https://habr.com/ru/post/204698/">https://habr.com/ru/post/204698/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../204684/index.html">8 HTML elements that you do not use (and should)</a></li>
<li><a href="../204686/index.html">Choosing a CASE tool for developing processes in BPMN</a></li>
<li><a href="../204688/index.html">The biggest bitcoin scam is happening right now</a></li>
<li><a href="../204692/index.html">Modern software design technologies in the context of communication theory and decomposition method</a></li>
<li><a href="../204696/index.html">DVHack 2013. It was great. Or the first hackathon in the Far East</a></li>
<li><a href="../204700/index.html">Continuous Integration with buildbot: introduction</a></li>
<li><a href="../204702/index.html">From 0 to 9 and from 9 to 0</a></li>
<li><a href="../204708/index.html">Sending large files in Microsoft Outlook 2010 using VBA and PHP</a></li>
<li><a href="../204710/index.html">Perseus LT Konus. For those who want to know where to follow the stars and planets</a></li>
<li><a href="../204712/index.html">Interview with Devananda van der Veen, OpenStack Ironic Technical Project Manager</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>