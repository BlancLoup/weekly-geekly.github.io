<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Blend @PreAuthorize in Spring Security with arbitrary types and simple inspected DSL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Spring Security is a must-have component in Spring-based applications, as it is responsible for authenticating the user, as well as authorizing some o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Blend @PreAuthorize in Spring Security with arbitrary types and simple inspected DSL</h1><div class="post__text post__text-html js-mediator-article"><p> <a href="http://projects.spring.io/spring-security/">Spring Security</a> is a must-have component in Spring-based applications, as it is responsible for authenticating the user, as well as authorizing some of his actions in the system.  One of the authorization methods in Spring Security is to use the <code>@PreAuthorize</code> annotation, in which using expressions you can visually describe the rules, following which the authorization module decides whether to allow the operation or prohibit it. </p><br><p>  In my REST service, it became necessary to provide an access point to the description of authorization rules for all methods of service controllers.  And, if possible, avoid revealing the specifics of <a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html">SpEL</a> expressions (i.e., instead of <code>permitAll</code> , something like <code>anybody</code> needed, and the <code>principal</code> should be avoided as a redundant expression), but return your expressions with which you can do anything. </p><br><a name="habracut"></a><br><h2>  Start </h2><br><p>  Let's imagine a small service and rules for access to it. </p><br><ul><li>  <code>IGreetingService.java</code> - describes a small service with a minimum set of operations </li></ul><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IGreetingService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sayHelloTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull String name)</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sayGoodByeTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull String name)</span></span></span></span>; }</code> </pre> <br><ul><li>  <code>GreetingService.java</code> - the simplest implementation of the service itself, which also contains the rules for accessing methods, taking into account the <code>@PreAuthorize</code> annotation </li></ul><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GreetingService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IGreetingService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-meta"><span class="hljs-meta">@PreAuthorize</span></span>(<span class="hljs-string"><span class="hljs-string">"@A.maySayHelloTo(principal, #name)"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sayHelloTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( @P(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"name"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> @Nonnull </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> String name ) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"hello "</span></span> + name; } <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-meta"><span class="hljs-meta">@PreAuthorize</span></span>(<span class="hljs-string"><span class="hljs-string">"@A.maySayGoodByeTo(principal, #name)"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sayGoodByeTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( @P(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"name"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> @Nonnull </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> String name ) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"good bye"</span></span> + name; } }</code> </pre> <br><ul><li>  <code>IAuthorizationComponent.java</code> is an equally simple interface containing several rules. </li></ul><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IAuthorizationComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">maySayHelloTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull UserDetails principal, @Nonnull String name)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">maySayGoodByeTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull UserDetails principal, @Nonnull String name)</span></span></span></span>; }</code> </pre> <br><ul><li>  <code>AuthorizationComponent.java</code> - implementation of authorization rules (instead of the current <code>true</code> and <code>false</code> you can submit more complex rules that take into account the input parameters, but more on that below) </li></ul><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span>(<span class="hljs-string"><span class="hljs-string">"A"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthorizationComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IAuthorizationComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">maySayHelloTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> UserDetails principal, @Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">maySayGoodByeTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> UserDetails principal, @Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre> <br><h2>  From <code>boolean</code> to expressions </h2><br><p>  Having only the result of logical expressions available, one cannot get descriptions of the rule itself.  It is necessary to somehow determine which rules are responsible for a specific action.  Suppose we decide to use not a <code>boolean</code> , but an object that describes the rule at a higher level.  We would have only two requirements for such an object: </p><br><ul><li>  be able to fully influence the work of authorization, i.e.  just return a boolean about whether to allow or deny the operation; </li><li>  be able to turn into textual representations that are easily readable by a person (although it is possible to turn such expressions into other, more machine-readable representations, but this is still unnecessary here). </li></ul><br><p>  Based on the requirements, it is enough for us to have something of the type at your disposal: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IAuthorizationExpression</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mayProceed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toHumanReadableExpression</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p>  And slightly change the authorization component: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IAuthorizationComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-function"><span class="hljs-function">IAuthorizationExpression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">maySayHelloTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull UserDetails principal, @Nonnull String name)</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-function"><span class="hljs-function">IAuthorizationExpression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">maySayGoodByeTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull UserDetails principal, @Nonnull String name)</span></span></span></span>; }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span>(<span class="hljs-string"><span class="hljs-string">"A"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthorizationComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IAuthorizationComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IAuthorizationExpression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">maySayHelloTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> UserDetails principal, @Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> simpleAuthorizationExpression(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IAuthorizationExpression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">maySayGoodByeTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> UserDetails principal, @Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> simpleAuthorizationExpression(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } }</code> </pre> <br><ul><li>  <code>SimpleAuthorizationExpression.java</code> is the simplest expression depending on a single logical value. </li></ul><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleAuthorizationExpression</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IAuthorizationExpression</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> IAuthorizationExpression mayProceedExpression = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleAuthorizationExpression(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> IAuthorizationExpression mayNotProceedExpression = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleAuthorizationExpression(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> mayProceed; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SimpleAuthorizationExpression</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> mayProceed)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mayProceed = mayProceed; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IAuthorizationExpression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">simpleAuthorizationExpression</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> mayProceed)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mayProceed ? mayProceedExpression : mayNotProceedExpression; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mayProceed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mayProceed; } <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toHumanReadableExpression</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mayProceed ? <span class="hljs-string"><span class="hljs-string">"TRUE"</span></span> : <span class="hljs-string"><span class="hljs-string">"FALSE"</span></span>; } }</code> </pre> <br><p>  Unfortunately, in the normal mode, <code>@PreAuthorize</code> works in such a way that its expressions can only return boolean values.  Therefore, when accessing the service methods, the following exception will occur: </p><br><pre> <code class="hljs dos">Exception <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> thread "main" java.lang.IllegalArgumentException: Failed to evaluate expression '@A.maySayHelloTo(principal, #name)' <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> org.springframework.security.access.expression.ExpressionUtils.evaluateAsBoolean(ExpressionUtils.java:<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> org.springframework.security.access.expression.method.ExpressionBasedPreInvocationAdvice.before(ExpressionBasedPreInvocationAdvice.java:<span class="hljs-number"><span class="hljs-number">59</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> org.springframework.security.access.prepost.PreInvocationAuthorizationAdviceVoter.vote(PreInvocationAuthorizationAdviceVoter.java:<span class="hljs-number"><span class="hljs-number">72</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> org.springframework.security.access.prepost.PreInvocationAuthorizationAdviceVoter.vote(PreInvocationAuthorizationAdviceVoter.java:<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> org.springframework.security.access.vote.AffirmativeBased.decide(AffirmativeBased.java:<span class="hljs-number"><span class="hljs-number">63</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> org.springframework.security.access.intercept.AbstractSecurityInterceptor.beforeInvocation(AbstractSecurityInterceptor.java:<span class="hljs-number"><span class="hljs-number">233</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> org.springframework.security.access.intercept.aopalliance.MethodSecurityInterceptor.invoke(MethodSecurityInterceptor.java:<span class="hljs-number"><span class="hljs-number">65</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:<span class="hljs-number"><span class="hljs-number">179</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:<span class="hljs-number"><span class="hljs-number">213</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> com.sun.proxy.$Proxy38.sayHelloTo(Unknown Source) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> test.springfx.security.app.Application.lambda$main$<span class="hljs-number"><span class="hljs-number">0</span></span>(Application.java:<span class="hljs-number"><span class="hljs-number">23</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> test.springfx.security.app.Application$$Lambda$<span class="hljs-number"><span class="hljs-number">7</span></span>/<span class="hljs-number"><span class="hljs-number">2043106095</span></span>.run(Unknown Source) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> test.springfx.security.fakes.FakeAuthentication.withFakeAuthentication(FakeAuthentication.java:<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> test.springfx.security.app.Application.main(Application.java:<span class="hljs-number"><span class="hljs-number">23</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="hljs-number"><span class="hljs-number">62</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="hljs-number"><span class="hljs-number">43</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> java.lang.reflect.Method.invoke(Method.java:<span class="hljs-number"><span class="hljs-number">497</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> com.intellij.rt.execution.application.AppMain.main(AppMain.java:<span class="hljs-number"><span class="hljs-number">144</span></span>) Caused by: org.springframework.expression.spel.SpelEvaluationException: EL1001E:(pos <span class="hljs-number"><span class="hljs-number">0</span></span>): <span class="hljs-built_in"><span class="hljs-built_in">Type</span></span> conversion problem, cannot <span class="hljs-built_in"><span class="hljs-built_in">convert</span></span> from @javax.annotation.Nonnull test.springfx.security.app.auth.IAuthorizationExpression$<span class="hljs-number"><span class="hljs-number">1</span></span> to java.lang.Boolean <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> org.springframework.expression.spel.support.StandardTypeConverter.convertValue(StandardTypeConverter.java:<span class="hljs-number"><span class="hljs-number">78</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> org.springframework.expression.common.ExpressionUtils.convertTypedValue(ExpressionUtils.java:<span class="hljs-number"><span class="hljs-number">53</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> org.springframework.expression.spel.standard.SpelExpression.getValue(SpelExpression.java:<span class="hljs-number"><span class="hljs-number">301</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> org.springframework.security.access.expression.ExpressionUtils.evaluateAsBoolean(ExpressionUtils.java:<span class="hljs-number"><span class="hljs-number">26</span></span>) ... <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-built_in"><span class="hljs-built_in">more</span></span> Caused by: org.springframework.core.<span class="hljs-built_in"><span class="hljs-built_in">convert</span></span>.ConverterNotFoundException: No converter found capable of converting from <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> [@javax.annotation.Nonnull test.springfx.security.app.auth.IAuthorizationExpression$<span class="hljs-number"><span class="hljs-number">1</span></span>] to <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> [java.lang.Boolean] <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> org.springframework.core.<span class="hljs-built_in"><span class="hljs-built_in">convert</span></span>.support.GenericConversionService.handleConverterNotFound(GenericConversionService.java:<span class="hljs-number"><span class="hljs-number">313</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> org.springframework.core.<span class="hljs-built_in"><span class="hljs-built_in">convert</span></span>.support.GenericConversionService.<span class="hljs-built_in"><span class="hljs-built_in">convert</span></span>(GenericConversionService.java:<span class="hljs-number"><span class="hljs-number">195</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> org.springframework.expression.spel.support.StandardTypeConverter.convertValue(StandardTypeConverter.java:<span class="hljs-number"><span class="hljs-number">74</span></span>) ... <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-built_in"><span class="hljs-built_in">more</span></span></code> </pre> <br><h2>  Configure <code>@PreAuthorize</code> </h2><br><p>  First of all, to fix a problem with non-null values, you need to set up <code>GlobalMethodSecurityConfiguration</code> , because it allows you to set the context of expression evaluation in <code>@PreAuthorize</code> .  The so-called  <code>TypeConverter</code> , which is pretty easy to get to: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomTypesGlobalMethodSecurityConfiguration</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GlobalMethodSecurityConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> ApplicationContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applicationContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> ConversionService </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">conversionService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> MethodSecurityExpressionHandler </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createExpressionHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ApplicationContext applicationContext = applicationContext(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> TypeConverter typeConverter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StandardTypeConverter(conversionService()); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DefaultMethodSecurityExpressionHandler handler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultMethodSecurityExpressionHandler() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> StandardEvaluationContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createEvaluationContextInternal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Authentication authentication, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MethodInvocation methodInvocation)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> StandardEvaluationContext decoratedStandardEvaluationContext = <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.createEvaluationContextInternal(authentication, methodInvocation); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ForwardingStandardEvaluationContext() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> StandardEvaluationContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">standardEvaluationContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> decoratedStandardEvaluationContext; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> TypeConverter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTypeConverter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> typeConverter; } }; } }; handler.setApplicationContext(applicationContext); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> handler; } }</code> </pre> <br><p>  There are a few points here.  First, we will use the standard <code>DefaultMethodSecurityExpressionHandler</code> , which will do most for us, simply by redefining the context returned to them.  Secondly, the ancestor of <code>DefaultMethodSecurityExpressionHandler</code> , namely <code>AbstractSecurityExpressionHandler</code> , forbids the creation of its context, but we can create a so-called  internal context in which we redefine <code>TypeConverter</code> .  Third, we need to write a forwarding decorator for the <code>StandardEvaluationContext</code> so as not to break the behavior of the original context: </p><br><ul><li>  <code>ForwardingStandardEvaluationContext.java</code> - the forwarding decorator for the <code>StandardEvaluationContext</code> </li></ul><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ForwardingStandardEvaluationContext</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StandardEvaluationContext</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> StandardEvaluationContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">standardEvaluationContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// @formatter:off @Override public void setRootObject(final Object rootObject, final TypeDescriptor typeDescriptor) { standardEvaluationContext().setRootObject(rootObject, typeDescriptor); } @Override public void setRootObject(final Object rootObject) { standardEvaluationContext().setRootObject(rootObject); } @Override public TypedValue getRootObject() { return standardEvaluationContext().getRootObject(); } @Override public void addConstructorResolver(final ConstructorResolver resolver) { standardEvaluationContext().addConstructorResolver(resolver); } @Override public boolean removeConstructorResolver(final ConstructorResolver resolver) { return standardEvaluationContext().removeConstructorResolver(resolver); } @Override public void setConstructorResolvers(final List&lt;ConstructorResolver&gt; constructorResolvers) { standardEvaluationContext().setConstructorResolvers(constructorResolvers); } @Override public List&lt;ConstructorResolver&gt; getConstructorResolvers() { return standardEvaluationContext().getConstructorResolvers(); } @Override public void addMethodResolver(final MethodResolver resolver) { standardEvaluationContext().addMethodResolver(resolver); } @Override public boolean removeMethodResolver(final MethodResolver methodResolver) { return standardEvaluationContext().removeMethodResolver(methodResolver); } @Override public void setMethodResolvers(final List&lt;MethodResolver&gt; methodResolvers) { standardEvaluationContext().setMethodResolvers(methodResolvers); } @Override public List&lt;MethodResolver&gt; getMethodResolvers() { return standardEvaluationContext().getMethodResolvers(); } @Override public void setBeanResolver(final BeanResolver beanResolver) { standardEvaluationContext().setBeanResolver(beanResolver); } @Override public BeanResolver getBeanResolver() { return standardEvaluationContext().getBeanResolver(); } @Override public void addPropertyAccessor(final PropertyAccessor accessor) { standardEvaluationContext().addPropertyAccessor(accessor); } @Override public boolean removePropertyAccessor(final PropertyAccessor accessor) { return standardEvaluationContext().removePropertyAccessor(accessor); } @Override public void setPropertyAccessors(final List&lt;PropertyAccessor&gt; propertyAccessors) { standardEvaluationContext().setPropertyAccessors(propertyAccessors); } @Override public List&lt;PropertyAccessor&gt; getPropertyAccessors() { return standardEvaluationContext().getPropertyAccessors(); } @Override public void setTypeLocator(final TypeLocator typeLocator) { standardEvaluationContext().setTypeLocator(typeLocator); } @Override public TypeLocator getTypeLocator() { return standardEvaluationContext().getTypeLocator(); } @Override public void setTypeConverter(final TypeConverter typeConverter) { standardEvaluationContext().setTypeConverter(typeConverter); } @Override public TypeConverter getTypeConverter() { return standardEvaluationContext().getTypeConverter(); } @Override public void setTypeComparator(final TypeComparator typeComparator) { standardEvaluationContext().setTypeComparator(typeComparator); } @Override public TypeComparator getTypeComparator() { return standardEvaluationContext().getTypeComparator(); } @Override public void setOperatorOverloader(final OperatorOverloader operatorOverloader) { standardEvaluationContext().setOperatorOverloader(operatorOverloader); } @Override public OperatorOverloader getOperatorOverloader() { return standardEvaluationContext().getOperatorOverloader(); } @Override public void setVariable(final String name, final Object value) { standardEvaluationContext().setVariable(name, value); } @Override public void setVariables(final Map&lt;String, Object&gt; variables) { standardEvaluationContext().setVariables(variables); } @Override public void registerFunction(final String name, final Method method) { standardEvaluationContext().registerFunction(name, method); } @Override public Object lookupVariable(final String name) { return standardEvaluationContext().lookupVariable(name); } @Override public void registerMethodFilter(final Class&lt;?&gt; type, final MethodFilter filter) throws IllegalStateException { standardEvaluationContext().registerMethodFilter(type, filter); } // @formatter:on }</span></span></code> </pre> <br><p>  Yes, Java doesn‚Äôt look better here, and it would be great if Java knew how <a href="https://kotlinlang.org/docs/reference/delegation.html">by</a> Kotlin, so that you don‚Äôt have to write so much.  Or, for example, <a href="https://projectlombok.org/features/Delegate.html">@Delegate</a> from Lombok.  Of course, it was possible to use the field, not an abstract method, but the abstract method seems to me a bit more flexible (however, I don‚Äôt know if Kotlin and Lombok can delegate to the method that returns the object being decorated). </p><br><p>  I would take the two classes above from the ‚Äúlibrary‚Äù layer, i.e.  It can be used in several applications separately and can be customized for each application.  And now in the ‚Äúapplication layer‚Äù you can now easily add your converter from <code>IAuthorizationExpression</code> to <code>boolean</code> : </p><br><ul><li>  <code>SecurityConfiguration.java</code> - here we simply link the application context and the translation service </li></ul><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableGlobalMethodSecurity</span></span>(prePostEnabled = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, securedEnabled = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, jsr250Enabled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SecurityConfiguration</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomTypesGlobalMethodSecurityConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ApplicationContext applicationContext; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ConversionService conversionService; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SecurityConfiguration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( @Autowired </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ApplicationContext applicationContext, @Autowired </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ConversionService conversionService )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.applicationContext = applicationContext; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.conversionService = conversionService; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> ApplicationContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applicationContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> applicationContext; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> ConversionService </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">conversionService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> conversionService; } }</code> </pre> <br><ul><li>  <code>ConversionConfiguration.java</code> - and, in fact, the configuration of the service itself, in which one more converter is simply added to the list of already existing ones </li></ul><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConversionConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ConversionService </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">conversionService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DefaultConversionService conversionService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultConversionService(); conversionService.addConverter(IAuthorizationExpression.class, Boolean.class, IAuthorizationExpression::mayProceed); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> conversionService; } }</code> </pre> <br><p>  Now <code>IAuthorizationExpression</code> works as a <code>boolean</code> and can participate in logical operations directly. </p><br><h2>  More complex expressions </h2><br><p>  Since we already have an expression object available, we can extend its basic functionality and create expressions that are more complicated than <code>SimpleAuthorizationExpression</code> .  This will allow us to combine expressions of any complexity, while observing the requirements mentioned above. </p><br><p>  I have always liked fluent interfaces, whose methods can be combined conveniently.  For example, <a href="http://mockito.org/">Mockito</a> and <a href="http://hamcrest.org/">Hamcrest</a> use this approach with might and main.  And Java is now also for basic interfaces such as <code>Function</code> , <code>Supplier</code> , <code>Consumer</code> , <code>Comparator</code> , etc.  Java 8 introduced a bunch of good features into the language, and one of them, namely the default methods, can be used to extend the basic functionality of expressions.  For example, you can add a simple AND predicate to <code>IAuthorizationExpression</code> : </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> IAuthorizationExpression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">and</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IAuthorizationExpression r)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IAuthorizationExpression() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mayProceed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IAuthorizationExpression.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mayProceed() &amp;&amp; r.mayProceed(); } <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toHumanReadableExpression</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"("</span></span>) .append(IAuthorizationExpression.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.toHumanReadableExpression()) .append(<span class="hljs-string"><span class="hljs-string">" AND "</span></span>) .append(r.toHumanReadableExpression()) .append(<span class="hljs-string"><span class="hljs-string">')'</span></span>) .toString(); } }; }</code> </pre> <br><p>  As you can see, the AND operation is very simple.  In the <code>mayProceed</code> method, <code>mayProceed</code> can simply get the result of the composition of expressions using <code>&amp;&amp;</code> , and in <code>toHumanReadableExpression</code> , you can form a string just for this expression.  Now you can combine an expression using the AND operation, for example, like this: </p><br><pre> <code class="hljs pgsql">simpleAuthorizationExpression(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">and</span></span>(simpleAuthorizationExpression(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>))</code> </pre> <br><p>  And at the same time the string representation for such an expression will be: </p><br><pre> <code class="hljs pgsql">(<span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>)</code> </pre> <br><p>  Very good.  You can also add support for the OR operation or the unary NOT operation without problems.  In addition, you can create more complex expressions without trivial operations, since <code>SimpleAuthorizationExpression</code> does not make much sense.  For example, an expression that determines whether the user is root: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IsRootAuthorizationExpression</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IAuthorizationExpression</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> UserDetails userDetails; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsRootAuthorizationExpression</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> UserDetails userDetails)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userDetails = userDetails; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IAuthorizationExpression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isRoot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> UserDetails userDetails)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IsRootAuthorizationExpression(userDetails); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mayProceed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Objects.equals(userDetails.getUsername(), <span class="hljs-string"><span class="hljs-string">"root"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toHumanReadableExpression</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"isRoot"</span></span>; } }</code> </pre> <br><p>  Or whether the string represented by the name variable is forbidden: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IsNamePermittedAuthorizationExpression</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IAuthorizationExpression</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Collection&lt;String&gt; bannedStrings = emptyList(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String name; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsNamePermittedAuthorizationExpression</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.name = name; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IAuthorizationExpression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isNamePermitted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IsNamePermittedAuthorizationExpression(name); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mayProceed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !bannedStrings.contains(name.toLowerCase()); } <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toHumanReadableExpression</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder() .append(<span class="hljs-string"><span class="hljs-string">"(name NOT IN ("</span></span>) .append(bannedStrings.stream().collect(joining())) .append(<span class="hljs-string"><span class="hljs-string">"))"</span></span>) .toString(); } }</code> </pre> <br><p>  Authorization rules can now be presented differently: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IAuthorizationExpression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">maySayHelloTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> UserDetails principal, @Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> isNamePermitted(name); } <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IAuthorizationExpression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">maySayGoodByeTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> UserDetails principal, @Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> isRoot(principal).and(isNamePermitted(name)); }</code> </pre> <br><p>  The code is quite readable and it is perfectly clear what exactly these expressions do.  This is how the string representations themselves look like: </p><br><ul><li> <code>(name NOT IN ())</code> </li> <li> <code>(isRoot AND (name NOT IN ()))</code> </li> </ul><br><p>  The analogy on the face, right? </p><br><h2>  Convert <code>@PreAuthorize</code> to <code>IAuthorizationExpression</code> and string representation </h2><br><p>  Now it only remains to get these expressions at runtime.  Suppose there is a separate opportunity to get a list of all the methods that we need (there may be a lot of specifics, and we are not really interested in it now).  Having such a set of methods, it remains just to ‚Äúvirtually‚Äù execute expressions from <code>@PreAuthorize</code> , replacing the missing variables with some values.  For example: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DiscoverService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDiscoverService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> UserDetails userDetailsMock = (UserDetails) newProxyInstance( DiscoverService.class.getClassLoader(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class&lt;?&gt;[]{ UserDetails.class }, (proxy, method, args) -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AssertionError(method); } ); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Authentication authenticationMock = (Authentication) newProxyInstance( DiscoverService.class.getClassLoader(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class&lt;?&gt;[]{ Authentication.class }, (proxy, method, args) -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> ( method.getName() ) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"getPrincipal"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> userDetailsMock; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"isAuthenticated"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AssertionError(method); } } ); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ApplicationContext applicationContext; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ConversionService conversionService; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DiscoverService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( @Autowired </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ApplicationContext applicationContext, @Autowired </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ConversionService conversionService )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.applicationContext = applicationContext; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.conversionService = conversionService; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-meta"><span class="hljs-meta">@Nullable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toAuthorizationExpression</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T object, @Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Class&lt;? extends T&gt; inspectType, @Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String methodName, @Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Class&lt;?&gt;... parameterTypes)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchMethodException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Method method = inspectType.getMethod(methodName, parameterTypes); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DefaultMethodSecurityExpressionHandler expressionHandler = createMethodSecurityExpressionHandler(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MethodInvocation invocation = createMethodInvocation(object, method); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> EvaluationContext evaluationContext = createEvaluationContext(method, expressionHandler, invocation); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Object value = evaluate(method, evaluationContext); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resolveAsString(value); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> DefaultMethodSecurityExpressionHandler </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createMethodSecurityExpressionHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DefaultMethodSecurityExpressionHandler expressionHandler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultMethodSecurityExpressionHandler(); expressionHandler.setApplicationContext(applicationContext); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> expressionHandler; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">MethodInvocation </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createMethodInvocation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T object, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Method method)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Parameter[] parameters = method.getParameters(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleMethodInvocation(object, method, Stream.of(parameters).map(&lt;...&gt;).toArray(Object[]::<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> EvaluationContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createEvaluationContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Method method, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> SecurityExpressionHandler&lt;MethodInvocation&gt; expressionHandler, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MethodInvocation invocation)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> EvaluationContext decoratedExpressionContext = expressionHandler.createEvaluationContext(authenticationMock, invocation); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> TypeConverter typeConverter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StandardTypeConverter(conversionService); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ForwardingEvaluationContext() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> EvaluationContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evaluationContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> decoratedExpressionContext; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> TypeConverter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTypeConverter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> typeConverter; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lookupVariable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &lt;...&gt;; } }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evaluate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Method method, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> EvaluationContext evaluationContext)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ExpressionParser parser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpelExpressionParser(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> PreAuthorize preAuthorizeAnnotation = method.getAnnotation(PreAuthorize.class); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Expression expression = parser.parseExpression(preAuthorizeAnnotation.value()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> expression.getValue(evaluationContext, Object.class); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resolveAsString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Object value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( value <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> IAuthorizationExpression ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((IAuthorizationExpression) value).toHumanReadableExpression(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.valueOf(value); } }</code> </pre> <br><p>  This code is a bit more complicated, but in reality there is nothing complicated about it.  Difficulties may arise unless finding the missing variables in for expressions (for example, <code>#name</code> from the examples above).  Instead of <code>&lt;...&gt;</code> you need to substitute your own implementation for argument substitution in parameters.  In fact, you can often get by with just a <code>null</code> , but in some cases this solution does not work for obvious reasons.  And one more not very pleasant feature: you need to manually create another <code>ForwardingEvaluationContext</code> by the same principle as the <code>ForwardingStandardEvaluationContext</code> above: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ForwardingEvaluationContext</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EvaluationContext</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> EvaluationContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evaluationContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// @formatter:off @Override public TypedValue getRootObject() { return evaluationContext().getRootObject(); } @Override public List&lt;ConstructorResolver&gt; getConstructorResolvers() { return evaluationContext().getConstructorResolvers(); } @Override public List&lt;MethodResolver&gt; getMethodResolvers() { return evaluationContext().getMethodResolvers(); } @Override public List&lt;PropertyAccessor&gt; getPropertyAccessors() { return evaluationContext().getPropertyAccessors(); } @Override public TypeLocator getTypeLocator() { return evaluationContext().getTypeLocator(); } @Override public TypeConverter getTypeConverter() { return evaluationContext().getTypeConverter(); } @Override public TypeComparator getTypeComparator() { return evaluationContext().getTypeComparator(); } @Override public OperatorOverloader getOperatorOverloader() { return evaluationContext().getOperatorOverloader(); } @Override public BeanResolver getBeanResolver() { return evaluationContext().getBeanResolver(); } @Override public void setVariable(final String name, final Object value) { evaluationContext().setVariable(name, value); } @Override public Object lookupVariable(final String name) { return evaluationContext().lookupVariable(name); } // @formatter:on }</span></span></code> </pre> <br><p>   :       <code>@PreAuthorize</code>         ,          . </p><br><h2>      </h2><br><p>   ,   ,         ,    .    <a href="http://resthub.org/springmvc-router/">Springmvc-router</a> ,         .   ,      ,      ,       .     ,  <code>@PreAuthorize</code> ,    . </p><br><p>              - : </p><br><ul><li>    ; </li><li>       (     ); </li><li>     ,     . </li></ul><br><p> ‚ÄúEffective Java‚Äù ‚Äî  .   <code>final</code>  nullability- ‚Äî   ,       ‚Äî   . </p><br><p>  And the last.  <code>@PreAuthorize</code>           . -,       ,        ,     (   ,   ). -,             . -,      ,         <code>@PreAuthorize</code> .   ,      ,      .    IDE    . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/307558/">https://habr.com/ru/post/307558/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307548/index.html">Welcome to Tarantool meetup August 25</a></li>
<li><a href="../307550/index.html">The collapse of the cloud technology exchange. What's next?</a></li>
<li><a href="../307552/index.html">Path indie developers on the market Steam Greenlight: Project ‚Ññ1</a></li>
<li><a href="../307554/index.html">Understanding Go: bytes and strings packages</a></li>
<li><a href="../307556/index.html">Planning usability testing. Part 1</a></li>
<li><a href="../307560/index.html">Use powershell scripts in icinga2</a></li>
<li><a href="../307562/index.html">Soprocess: -What, -how, -why?</a></li>
<li><a href="../307564/index.html">The Golden Key is an unavoidable possibility of a full bypass of Secure Boot on most Windows devices.</a></li>
<li><a href="../307568/index.html">Search for invalid passports or learn how to prepare binary files</a></li>
<li><a href="../307570/index.html">The final release of Vivaldi 1.3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>