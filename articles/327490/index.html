<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Powershell Empire and FuzzBunch: exploiting the notorious ETERNALBLUE vulnerability</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On April 14, 2017, a new dump from a group of hackers calling themselves The Shadow Brokers was published. Among other things, the dump contains the F...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Powershell Empire and FuzzBunch: exploiting the notorious ETERNALBLUE vulnerability</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/81c/f93/550/81cf935500ee2f21cd18abae14406bce.jpg" alt="image"><br><br>  On April 14, 2017, a new dump from a group of hackers calling themselves The Shadow Brokers was published.  Among other things, the dump contains the FuzzBunch framework, which allows you to exploit the dangerous RCE vulnerabilities of the Windows operating system almost automatically.  The vulnerability has been fixed with the release of the MS17-010 patch: it fixes six Windows SMB Server problems, five of which allow to execute arbitrary code through the creation of a special Server Message Block (SMB) 1.0 package.  In this article, we will look at how attackers could exploit the ETERNALBLUE vulnerability. <br><a name="habracut"></a><br>  <b>The article is research in nature.</b>  <b>When writing it used publicly available information.</b>  <b>The use of the described techniques or methods, or their parts in illegal and unlawful actions is prohibited.</b>  <b>Observe legislation.</b> <br><br>  By default, the <a href="https://defcon.ru/infosec-news/4556/">Kali Linux</a> arsenal allows for many attacks on machines running Windows, but it lacks two modern tools.  This article focuses on the tools Empire and FuzzBunch, which should complement your distribution, to significantly expand the possibilities for operating and post-operating Windows systems on the network. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Powershell Empire </h2><br>  Powershell Empire provides a modular post-operation platform using the power of Windows PowerShell automation. <br><br>  Empire agents work completely in RAM and are difficult to detect with means of protection, i.e.  Antivirus software and intrusion prevention systems due to the fact that they are written in a scripting language and at runtime between the agent and the antivirus software is an interpreter of the scripting language, in contrast to the classic payload compiled into an assembler and executable file. <br><br><h3>  Installation </h3><br>  Download Empire from github <a href="https://github.com/EmpireProject/Empire">github.com/EmpireProject/Empire</a> <br>  Run the Empire / setup / install.sh script to install dependencies into the system. <br>  Next, run the script to initialize the Empire / setup / setup_database.py database <br>  Installation completed. <br><br><h3>  Startup and Basic Setup </h3><br>  We start the framework with the script ./empire and get to the main menu <br><br><img src="https://habrastorage.org/files/1e9/366/a89/1e9366a89c6b48fb9ea2fa6f79a5d738.png"><br><br>  The basic concepts that we will encounter are listener, stager and agent. <br>  <b>Listener</b> - local IP address and port to which the agent should connect if successfully performed on the victim's side. <br><br>  With the listeners command, we switch to the configuration mode of the slider and create a new listner at <a href="http://192.168.1.3/">192.168.1.3</a> : 8080 <br><br><img src="https://habrastorage.org/files/fe7/d0e/309/fe7d0e3094ab45d1afb264a995d5b067.png"><br><br>  As you can see, the port is now listening: <br><br><img src="https://habrastorage.org/files/645/eca/bd3/645ecabd3837456ab35744e954261c95.png"><br><br>  <b>Stager</b> is a Powershell Empire agent delivery method on a victim's machine.  By analogy with the Metasploit framework, there is a stage0 and stage1, where we assume that stage0 is the Empire's delivery method for the agent, and stage1 is the agent itself.  In fact, the delivery process is somewhat more complicated, as can be read in detail on the official website. <br><br>  Using the usestager command, you can select the following options for stage0 (hereinafter referred to the stager): <br><br><img src="https://habrastorage.org/files/344/91c/15f/34491c15f7064043bec43a7aff477659.png"><br><br>  The most common stager is the launcher, select it and configure it to connect to the test listener we created in the previous step. <br><br><img src="https://habrastorage.org/files/265/f30/c49/265f30c49c894e1882b70eca815eed25.png"><br><br>  Further, you can configure some parameters for the stager: <br><br><img src="https://habrastorage.org/files/ab6/4f2/612/ab64f2612075421cadc7c7a3b57fb6e4.png"><br><br>  In particular, the default Proxy option is set to default, which means using the system proxy settings on the victim side. <br><br>  The generate command creates a launcher steager. <br><br><img src="https://habrastorage.org/files/cc4/383/c13/cc4383c130c344528085aee306c02f98.png"><br><br>  It is a powers64-encoded base64 command that must be executed on the victim‚Äôs side. <br>  An alternative way to generate stage0 commands for a launcher pager is the command <br>  launcher [namelist] from the listeners menu. <br><br>  There are other layers that can be used depending on the situation.  We list the main ones. <br><br><ul><li>  launcher_bat - the agent is delivered to the victim's machine when the bat file is launched. </li><li>  launcher_vbs - the agent is delivered to the victim's machine during the execution of the vbs-script. </li><li>  macro - a code will be generated for a macro that can be embedded in an MS Office document. </li><li>  dll - launching powershell agent inside a process other than powershell.exe using the Reflective DLL technique loading. </li></ul><br>  Steager dll allows Empire to integrate with Metasploit framework and other modern tools.  With the help of an exploit, it is required to inject a malicious DLL into the attacked process, after which the Empire agent will be loaded into the RAM of the victim‚Äôs machine and executed. <br><br>  Run the generated code of our launcher pager on the victim machine: <br><br><img src="https://habrastorage.org/files/408/ec4/26d/408ec426d4334449b6a0930d39612cfb.png"><br><br>  On the attacker's machine in the Empire interface we see the message: <br><br><img src="https://habrastorage.org/files/c4c/26b/2fe/c4c26b2fed01460f813ebc9fa8999ef2.png"><br><br>  This means that the connection between the attacker‚Äôs machine and the victim‚Äôs machine is now established and the agent is ready to receive commands. <br><br>  For convenience, you can rename the agent: <br><br><img src="https://habrastorage.org/files/d48/7b9/2c7/d487b92c796b4beab75e6c0c30de69ef.png"><br><br>  Next, to switch to the interaction mode, execute the interact command and using the help command, we will see the available options: <br><br><img src="https://habrastorage.org/files/12b/28c/682/12b28c6827314c388438f2652bf02812.png"><br><br><h2>  Post-operation </h2><br>  After receiving an active session with the agent, we are available to many teams.  Documentation on all the capabilities of the framework can be found on the official website powershellempire.com. <br><br><img src="https://habrastorage.org/files/91a/779/d59/91a779d590784af08e83c3a56de3652d.png"><br><br>  All modules are divided into groups.  As an example, we will demonstrate the work of several modules. <br>  A credentials / powerdump module for collecting user hashes. <br><br><img src="https://habrastorage.org/files/bd4/e7a/819/bd4e7a819f9846b89563de2031221c89.png"><br><br><img src="https://habrastorage.org/files/98c/3f9/b20/98c3f9b208d44a6dbb969de5c8a05212.png"><br><br>  Starting mimikatz from the Empire Agent menu <br><br><img src="https://habrastorage.org/files/d34/f05/984/d34f059840b947dda375107f29b4d08e.png"><br><br>  Received the password in clear text from the supplier WDijest <br><br><img src="https://habrastorage.org/files/876/229/55b/87622955b064492989513b8d52fb08b7.png"><br><br><h2>  Fuzzbunch </h2><br>  On April 14, 2017, a new dump from a group of hackers calling themselves The Shadow Brokers was published.  Among other things, the dump contains the FuzzBunch framework, which allows you to exploit the dangerous RCE vulnerabilities of the Windows operating system almost automatically.  The main portion of the disclosed vulnerabilities is described in Microsoft bulletin MS17-010.  Also for the exploitation of vulnerabilities, promulgated by The Shadow Brokers, modules for the Metasploit framework have already been created. <br><br><h3>  Installation </h3><br>  To install FuzzBunch, you will need either a 32-bit Windows machine, or Kali Linux with the Wine environment installed.  We will use the second option so that both tools, Empire and FuzzBunch, are in the same distribution.  Download files to your Kali Linux machine from github <br><br>  <b>git clone <a href="">github.com/fuzzbunch/fuzzbunch.git</a></b> <br><br>  For FuzzBunch to work. We need Python 2.6 and, in order not to clutter up your main Wine environment, I recommend creating a new one.  First, install / update Wine, if you haven't done it yet. <br><br><pre><code class="hljs swift">apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> instal wine winbind</code> </pre> <br>  Create and initialize a new environment: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">mkdir</span></span> ~/.wine_fuzzbunch WINEPREFIX=<span class="hljs-string"><span class="hljs-string">"/root/.wine_fuzzbunch/"</span></span> winecfg</code> </pre> <br><img src="https://habrastorage.org/files/d14/061/de3/d14061de38e34b70a96a4a3dd7bc7aed.png"><br><br>  We leave everything unchanged: <br><br><img src="https://habrastorage.org/files/ae8/fb1/154/ae8fb115444542f7b0aab926eeaa4cfd.png"><br><br>  <b>export WINEPREFIX = / root / .wine_fuzzbunch /</b> <br>  We check that the environment was created successfully: <br><br><img src="https://habrastorage.org/files/559/7da/018/5597da0187a34413997499bca387e3fc.png"><br><br>  Add the required directories to the PATH <br>  <b>wine regedit.exe</b> <br><br><img src="https://habrastorage.org/files/a21/453/0df/a214530df8dd49e2a9f23f761e26130d.png"><br><br>  Set fuzzbunch to the Wine environment: <br><br><pre> <code class="hljs ruby">mkdir -p ~<span class="hljs-regexp"><span class="hljs-regexp">/.wine_fuzzbunch/drive</span></span>_c/nsa/windows cd ~<span class="hljs-regexp"><span class="hljs-regexp">/.wine/drive</span></span>_c/nsa/windows cp -R [<span class="hljs-number"><span class="hljs-number">_</span></span><span class="hljs-number"><span class="hljs-number">_</span></span>_fuzzbunch]/* . wget <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/www.python.org/ftp</span></span><span class="hljs-regexp"><span class="hljs-regexp">/python/</span></span><span class="hljs-number"><span class="hljs-number">2.6</span></span>/python-<span class="hljs-number"><span class="hljs-number">2.6</span></span>.msi wget <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/downloads.sourceforge.net/project</span></span><span class="hljs-regexp"><span class="hljs-regexp">/pywin32/pywin</span></span>32/Build%<span class="hljs-number"><span class="hljs-number">20219</span></span>/pywin32-<span class="hljs-number"><span class="hljs-number">219</span></span>.win32-py2.<span class="hljs-number"><span class="hljs-number">6</span></span>.exe?r=&amp;ts=<span class="hljs-number"><span class="hljs-number">1493192168</span></span>&amp;use_mirror=netcologne</code> </pre> <br>  Install Python <br><br><pre> <code class="hljs mel">wine msiexec /i <span class="hljs-keyword"><span class="hljs-keyword">python</span></span><span class="hljs-number"><span class="hljs-number">-2.6</span></span>.msi</code> </pre> <br>  Install pywin32 <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">wine</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pywin32-219</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.win32-py2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span></code> </pre> <br>  Post installation: <br><br><pre> <code class="hljs dos">wine <span class="hljs-built_in"><span class="hljs-built_in">cmd</span></span>.exe <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> C:\Python26\Scripts python pywin32_postinstall.py -install <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> C:\nsa\windows <span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> listeningposts</code> </pre> <br><h3>  Startup and operation MS17-010 </h3><br>  From the Wine environment, execute the following command: <br><br><img src="https://habrastorage.org/files/5c5/2ef/c65/5c52efc657aa4802a21dcc36436f2409.png"><br><br>  We will attack the 64-bit Windows 7 machine with the IP address 192.168.1.10, while the attacking machine has the IP address 192.168.1.3. <br><br>  We set these parameters at startup. <br><br>  To execute malicious code, we will use a vulnerability in the SMB protocol called Eternalblue. <br><br>  use Eternalblue <br><br>  We answer affirmatively to the question about checking the parameters: <br><br><img src="https://habrastorage.org/files/d7c/6aa/447/d7c6aa447fcd4bca9bb22d6890701345.png"><br><br>  We leave everything unchanged, except for the item on the method of delivery.  Here we choose FB. <br><br><img src="https://habrastorage.org/files/9a1/96f/f33/9a196ff33f8644dab00a7a80c322e683.png"><br><br>  In the end, we launch the module for execution and see the message Eternalblue Succeeded. <br><br><img src="https://habrastorage.org/files/eff/0eb/371/eff0eb3714f843f6979d75a6f77c40ae.png"><br><br><h3>  Post-exploitation in conjunction with Powershell Empire </h3><br>  Create a new listener: <br><br><img src="https://habrastorage.org/files/ea4/33c/cf7/ea433ccf737945c5b203c297a56d125e.png"><br><br>  As an agent delivery mechanism, we use this time dll.  If you used Empire on a separate machine, then for delivering the pager to the machine with FuzzBunch, it would be convenient to save it to the web server directory and then download over the network. <br><br><img src="https://habrastorage.org/files/056/952/889/05695288983a4813b3ccb22a94d66d54.png"><br><br>  If you have Powershell Empire and FuzzBunch on the same machine, as in my case, then save the file to the root of the C drive of the Wine environment. <br><br><img src="https://habrastorage.org/files/ea2/870/ebd/ea2870ebd07041689ac0d9bf062638d6.png"><br><br>  Go back to FuzzBunch, where the session is open with the victim's machine, and use the DoublePulsar module. <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DoublePulsar</code> </pre> <br>  Choose a 64-bit architecture: <br><br><img src="https://habrastorage.org/files/2bc/3e7/77a/2bc3e777aeee47ad8e8774b55dc168d7.png"><br><br>  As a payload, we will inject a DLL created in Empire. <br><br><img src="https://habrastorage.org/files/f1f/494/fae/f1f494fae71a401e8c49bb4b1edee13e.png"><br><br>  Specify the full path to the DLL: <br><br><img src="https://habrastorage.org/files/b45/6e9/616/b456e9616fbd47b597dc4e6194e228a1.png"><br><br>  C: \ launcher.dll <br>  Execute the module: <br><br><img src="https://habrastorage.org/files/32b/5e7/5fe/32b5e75fe08b410b80de8b63f4f2aaa7.png"><br><br>  In the Empire interface, we get a new session and execute Mimikatz. <br><br><img src="https://habrastorage.org/files/ae0/be3/911/ae0be39118b948b7adaecd7c2804090c.png"><br><br>  Get user logins and passwords. <br><br><img src="https://habrastorage.org/files/c78/bb3/f60/c78bb3f602b54671b9a5f429fac878ec.png"><br><br><img src="https://habrastorage.org/files/8f5/c16/121/8f5c161216e7499e9f4d4fc463281ec8.png"><br><br>  At the same time, the victim‚Äôs operating system does not detect attacks.  In Microsoft Security Essentials logs is empty, the system is stable.  Thus, our distribution Kali Linux has acquired two modern tools for operating and post-operating the Windows OS. <br><br><h3>  Protective measures </h3><br>  As a means of protection, it is recommended to update the Windows system (if you have not done this for some reason), use a means of detecting and blocking attacks ‚Äî a firewall, etc. <br><br>  For example, this can be done using the following commands: <br><br><pre> <code class="hljs pgsql">netsh advfirewall firewall <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> dir=<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> action=block protocol=TCP localport=<span class="hljs-number"><span class="hljs-number">135</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>="Block_TCP-135"</code> </pre> <br><pre> <code class="hljs pgsql">netsh advfirewall firewall <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> dir=<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> action=block protocol=TCP localport=<span class="hljs-number"><span class="hljs-number">445</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>="Block_TCP-445"</code> </pre> </div><p>Source: <a href="https://habr.com/ru/post/327490/">https://habr.com/ru/post/327490/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327480/index.html">Java and isomorphic React</a></li>
<li><a href="../327482/index.html">How do i write code</a></li>
<li><a href="../327484/index.html">My upgrade byndyusoft.Infrastructure | DDD + CQRS + WebApi</a></li>
<li><a href="../327486/index.html">Paparazzo. Powerful, stylish, your own. Part II</a></li>
<li><a href="../327488/index.html">What is the Cyber-Kill Chain and why should it be taken into account in the protection strategy?</a></li>
<li><a href="../327492/index.html">‚ÄúIn a year or two, .NET Core will replace Java in the enterprise solution market‚Äù, - Interview with Jon Skeet, Google</a></li>
<li><a href="../327494/index.html">How we optimized Twitter Lite</a></li>
<li><a href="../327498/index.html">How to learn to see the brain. Review of the book "Visual Thinking" by Dan Roem</a></li>
<li><a href="../327500/index.html">14 useful services and applications for learning English</a></li>
<li><a href="../327502/index.html">5 worst domestic design techniques from the 90s</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>