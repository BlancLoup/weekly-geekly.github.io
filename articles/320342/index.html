<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tale of the impossible bug: big.LITTLE and caching</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When someone says the word multi-core, we unconsciously mean SMP. This worked successfully for us until recently, until ARM announced big.LITTLE. The ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tale of the impossible bug: big.LITTLE and caching</h1><div class="post__text post__text-html js-mediator-article">  When someone says the word multi-core, we unconsciously mean SMP.  This worked successfully for us until recently, until ARM announced big.LITTLE.  The ARM <a href="https://en.wikipedia.org/wiki/ARM_big.LITTLE">big.LITTLE architecture</a> is the first massively produced example <a href="http://www.embedded.com/design/mcus-processors-and-socs/4429496/Multicore-basics">of the AMP architecture</a> , and as we will see later, it raises the bar for multi-core programming complexity even higher. <br><a name="habracut"></a><br><h3>  Tale of the impossible bug </h3><br>  It all started <a href="https://bugzilla.xamarin.com/show_bug.cgi%3Fid%3D39859">with an error message</a> from the phone with the processor used by the Exynos chipset on Samsung phones in Europe.  Applications created with our software fell from <code>SIGILL</code> in completely random places.  Nothing could reasonably explain what was happening, and the crash itself occurred with valid processor instructions.  This immediately made us suspect an unsuccessful clearing of the instruction cache. <br><br>  After reviewing the entire JIT code for flushing the cache, we were confident that we were <code>__clear_cache</code> correctly.  This made us look at how other <a href="">virtual machines</a> or <a href="">compilers</a> reset the cache on the ARM64, and we found a <a href="https://silver.arm.com/download/Unspecified/BX500-DA-10400-r0p0-08rel0/Cortex_A53_MPCore_Software_Developers_Errata_Notice_v18.pdf">list of typos / corrections for the Cortex A53 specification</a> .  The descriptions of these problems from ARM are vague and difficult to understand, so we tried to find a workaround.  But here, nothing happened. <br><br>  Then we went from the other side.  Or maybe the problem is in the signal handler?  Not.  Awkward CPU emulation in user space?  Not.  Broken <code>libc</code> implementation?  Nice try.  Faulty hardware?  We reproduced it on several devices.  Bad luck or karma?  Yes! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Some of us could not fall asleep with such an amazing puzzle in front of us and continued to look at the application dumps.  But there was one funny thing: the faulty address was always on the third or fourth line of memory dumps. <br><br><img src="https://habrastorage.org/files/b74/3ef/2cc/b743ef2cc1844a528f1834f510c6f98a.png"><br><br>  This was our only clue, and when it comes to such an error that is so difficult to understand, then there can be no question of any coincidences.  Our memory dumps were 16-byte aligned, while <code>SIGILL</code> <a href="https://gist.github.com/lewurm/97dff0a56929b56a0fc5ab49af06fd06">always occurred in the range between</a> <code>0x40-0x7f</code> or <code>0xc0-0xff</code> .  Therefore, we formatted the snapshots of memory in such a way that it was easier to check the operation of the allocator: <br><br><pre> <code class="bash hljs">$ grep SIGILL *.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> custom_01.log:E/mono (13964): SIGILL at ip=0x0000007f4f15e8d0 custom_02.log:E/mono (13088): SIGILL at ip=0x0000007f8ff76cc0 custom_03.log:E/mono (12824): SIGILL at ip=0x0000007f68e93c70 custom_04.log:E/mono (12876): SIGILL at ip=0x0000007f4b3d55f0 custom_05.log:E/mono (13008): SIGILL at ip=0x0000007f8df1e8d0 custom_06.log:E/mono (14093): SIGILL at ip=0x0000007f6c21edf0 [...]</code> </pre><br>  Using this, they formulated the first good hypothesis: an unsuccessful cache flush always occurred on the high 64 bytes of each 128-byte block.  These numbers, if you are dealing with low-level programming, will immediately remind you of the size of the cache lines.  From that moment on, everything began to acquire meaning. <br><br>  Below is the pseudo-code of how <code>libgcc</code> <a href="">resets the arm64 cache</a> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __clear_cache (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *address, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size) { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cache_line_size = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!cache_line_size) cache_line_size = get_current_cpu_cache_line_size (); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; size; i += cache_line_size) flush_cache_line (address + i); }</code> </pre><br>  In the example above, <code>get_current_cpu_cache_line_size</code> is a processor instruction that returns the size of the cache lines, and <code>flush_cache_line</code> clears the cache line at the specified address. <br><br>  At that time, we used our own implementation of this function, so we decided to launch it separately and display the size of the cache lines by the processor.  And suddenly it printed 128 and 64. We double checked that it was in fact.  After that, we took the directory of this processor, and it turned out that the older cores (big) have a cache line size of 128 bytes, and the youngest (LITTLE) - 64. <br><br>  It turned out that at first <code>__clear_cache</code> could be called on a big-core with 128 byte instruction cache lines, and then on one of the LITTLE-cores, skipping all the others at reset.  There is simply no place.  We deleted the caching and it all worked. <br><br><h3>  findings </h3><br>  Some ARM processors big.LITTLE may have cores with different sizes of cache lines, and to a large extent no code is ready to deal with this, since  all kernels are assumed to be symmetrical. <br><br>  Worse, even the ARM instruction set is not ready for this.  An insightful reader can guess that calculating the cache line on each call is not enough for user code: it may happen that the process runs on one core, and executes <code>__clear_cache</code> with a certain size of the cache line on the other, which may not be true.  Thus, we should try to figure out the global minimum cache line size among all cores.  Here is our fix for Mono: <a href="https://github.com/mono/mono/pull/3549">Pull Request</a> .  Other projects have already borrowed our fix: <a href="https://github.com/dolphin-emu/dolphin/pull/4204">Dolphin</a> and <a href="https://github.com/hrydgard/ppsspp/pull/8769">PPSSPP</a> . <br></div><p>Source: <a href="https://habr.com/ru/post/320342/">https://habr.com/ru/post/320342/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320324/index.html">Wonderful sketches of the game Super Mario Bros</a></li>
<li><a href="../320326/index.html">All the best from Lean Startup methodology, and how testers live with it</a></li>
<li><a href="../320330/index.html">How to "make friends" Mitel SIP-DECT and Asterisk</a></li>
<li><a href="../320336/index.html">Labor market overview in the field of big data and data science</a></li>
<li><a href="../320338/index.html">Observed models in Realm Xamarin</a></li>
<li><a href="../320344/index.html">Olympiad of MIPT on electronics for schoolchildren</a></li>
<li><a href="../320346/index.html">Docker implementation for a small project in Production, part 2</a></li>
<li><a href="../320348/index.html">How to establish a trust relationship between the computer and the main domain</a></li>
<li><a href="../320350/index.html">Five years, five educational projects: briefly about the main and the history of teachers</a></li>
<li><a href="../320354/index.html">How were born the IT-dynasties in Belarus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>