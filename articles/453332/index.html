<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About the strange method of saving hard disk space</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Another user wants to write to the hard disk a new piece of data, but he does not have enough free space for this. I also do not want to delete anythi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About the strange method of saving hard disk space</h1><div class="post__text post__text-html js-mediator-article"><p>  Another user wants to write to the hard disk a new piece of data, but he does not have enough free space for this.  I also do not want to delete anything, since "everything is very important and necessary."  And what should we do with it? </p><br><p>  This problem does not come up to him alone.  On our hard drives terabytes of information are resting, and this number does not tend to decrease.  But how unique is it?  In the end, because all files are just sets of bits of a certain length and, most likely, the new one is not much different from the one that is already stored. </p><br><p>  It is clear that looking for already stored pieces of information on a hard disk is a task if not a failure, then at least not effective.  On the other hand, because if the difference is small, then you can adjust a little ... </p><br><p><img src="https://habrastorage.org/webt/sp/ho/gl/sphoglurqinhyzqmkyvbrgkox0y.jpeg" alt="Image from rematelier.ru"></p><br><p>  TL; DR - the second attempt to talk about a strange method of optimizing data using JPEG files, now in a more understandable form. </p><a name="habracut"></a><br><h2 id="o-bitah-i-raznice">  About bits and difference </h2><br><p>  If you take two completely random pieces of data, then they contain on average half of the bits contained.  And indeed, among the possible layouts for each pair ('00, 01, 10, 11 ') exactly half has the same values, everything is simple. </p><br><p>  But of course, if we just take two files and fit one under the second, then we will lose one of them.  If we keep the changes, then simply re <a href="https://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B5%25D0%25BB%25D1%258C%25D1%2582%25D0%25B0-%25D0%25BA%25D0%25BE%25D0%25B4%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">-</a> inventing the <a href="https://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B5%25D0%25BB%25D1%258C%25D1%2582%25D0%25B0-%25D0%25BA%25D0%25BE%25D0%25B4%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">delta encoding</a> , which already exists perfectly without us, although it is not usually used for the same purposes.  You can try to build a smaller sequence into a larger one, but even so, we risk losing critical data segments when used thoughtlessly with everything. </p><br><p>  Between what and what then can the difference be eliminated?  Well, that is, a user-written new file is just a sequence of bits with which we cannot do anything by itself.  Then you just need to find such bits on your hard disk so that you can change them without having to store the difference, so that you can relive their loss without serious consequences.  Yes, and it makes sense to change not just the file itself on the file system, but some less sensitive information inside it.  But what and how? </p><br><h3 id="metody-podgonki">  Fitting methods </h3><br><p>  Files compressed with losses come to the rescue.  All of these jpeg, mp3 and others, although they are lossy, contain a bunch of bits that are available for a safe change.  It is possible to use advanced techniques that in an imperceptible way modify their components in different parts of the coding.  Wait.  Advanced technology ... inconspicuous modification ... some bits to others ... yes, this is almost <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D0%25B5%25D0%25B3%25D0%25B0%25D0%25BD%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D1%2584%25D0%25B8%25D1%258F">steganography</a> ! </p><br><p>  And the truth is, embedding one information into another like nothing resembles its methods.  Also imperceptible to the invisibility of the changes to the human senses.  This is where the paths diverge is in secrecy: our task is to add additional information to the user‚Äôs hard drive, it will only hurt him.  Forget more. </p><br><p>  Therefore, although we can use them, we need to make some modifications.  And then I will tell and show them on the example of one of the existing methods and the common file format. </p><br><h2 id="o-shakalah">  About jackals </h2><br><p>  If we compress, then the most compressible in the world.  This is, of course, about JPEG files.  Not only is there a ton of tools and existing methods for embedding data in it, it is also the most popular graphic format on this planet. </p><br><p><img src="https://habrastorage.org/storage/a555b701/12995be3/c44b46cd/8787f59d.png" alt="JPEG !!!"></p><br><p>  However, in order not to engage in dog breeding, you need to limit your field of activity in files of this format.  No one likes monochrome squares, arising from excessive compression, so you need to limit yourself to working with an already compressed file, <strong>avoiding transcoding</strong> .  More specifically, with integer coefficients, which remain after the operations responsible for data loss - DCT and quantization, which is beautifully displayed on the coding scheme (thanks to the Wiki National Library named after Bauman): <br><img src="https://habrastorage.org/webt/jj/zi/j8/jjzij8i5sln2tlbnyk6yibzbcb8.jpeg" alt="JPEG encoding"></p><br><p>  There are many possible methods for optimizing jpeg files.  There is a lossless optimization (jpegtran), there is a <a href="https://tinyjpg.com/">lossless</a> optimization, which in fact still contribute, but they don‚Äôt care about us.  After all, if a user is ready to embed one information into another in order to increase free disk space, then he either optimized his images for a long time, or doesn‚Äôt want to do this at all, for fear of losing quality. </p><br><h2 id="f5">  F5 </h2><br><p>  Under this condition fits a whole family of algorithms, which can be found <a href="https://www2.htw-dresden.de/~westfeld/publikationen/f5.pdf">in this good presentation</a> .  The most advanced of these is the <a href="https://ru.bmstu.wiki/F5_(%25D0%25A1%25D1%2582%25D0%25B5%25D0%25B3%25D0%25B0%25D0%25BD%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D1%2584%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9_%25D0%25B0%25D0%25BB%25D0%25B3%25D0%25BE%25D1%2580%25D0%25B8%25D1%2582%25D0%25BC)">F5</a> algorithm, authored by Andreas Westfeld, which works with the coefficients of the luminance component, since the human eye is the least sensitive to its changes.  Moreover, it uses the embedding method based on the matrix coding, so it is possible to make the less their changes when embedding the same amount of information, the larger the size of the container used. </p><br><p>  The changes themselves are reduced to reducing the absolute value of the coefficients by one in certain conditions (that is, not always), which allows you to use F5 to optimize the storage of data on the hard disk.  The fact is that the coefficient after such a change is likely to occupy a smaller number of bits after performing Huffman coding due to the statistical distribution of values ‚Äã‚Äãin JPEG, and new zeros will give a gain when encoding them using RLE. </p><br><p>  The necessary modifications are reduced to eliminating the part responsible for secrecy (password permutation), which saves resources and execution time, and adds a mechanism for working with multiple files instead of one at a time.  In more detail, the process of changing the reader is unlikely to be interesting, so go to the description of the implementation. </p><br><h2 id="vysokie-tehnologii">  High tech </h2><br><p>  To demonstrate the operation of this approach, I implemented the method on pure C and performed a number of optimizations both in terms of execution speed and memory (you can‚Äôt imagine how much these pictures weigh without compression even before DCT).  Cross-platform is achieved using a combination of <a href="http://libjpeg.sourceforge.net/">libjpeg</a> , <a href="http://pcre.org/">pcre</a> and <a href="https://github.com/cxong/tinydir">tinydir libraries</a> , for which they thank you.  All this is going to 'make''om, so Windows users for evaluation want to install some Cygwin for themselves, or deal with Visual Studio and libraries on their own. </p><br><p>  The implementation is available in the form of a console utility and library.  More information about the use of the latter can be found in the readme in the githaba repository, a link to which I will attach at the end of the post. </p><br><h3 id="kak-ispolzovat">  How to use? </h3><br><p>  Carefully.  Images used for packaging are selected by searching for a regular expression in a given root directory.  Upon completion, the files can be moved, renamed and copied at will within it, change the file and operating systems, etc. However, it is worth being extremely careful and not to change the direct content in any way.  The loss of the value of even one bit can make it impossible to recover information. </p><br><p>  Upon completion, the utility leaves a special archive file containing all the information necessary for unpacking, including data about used images.  By itself, it weighs the order of a couple of kilobytes and does not have any significant effect on the occupied disk space. </p><br><p>  You can analyze the possible capacity using the '-a' flag: './f5ar -a [search folder] [Perl-compatible regular expression]'.  Packing is done with the command './f5ar -p [search folder] [Perl-compatible regular expression] [packaged file] [archive name]', and unpacking with './f5ar -u [archive file] [restored file name]' . </p><br><h3 id="demonstraciya-raboty">  Demonstration of work </h3><br><p> To show the effectiveness of the method, I uploaded a collection of 225 absolutely free photos of dogs from the <a href="https://unsplash.com/">Unsplash</a> service and opened a large pdf-ku 45 meters in the second volume of the second volume of Knut's <a href="https://ru.wikipedia.org/wiki/%25D0%2598%25D1%2581%25D0%25BA%25D1%2583%25D1%2581%25D1%2581%25D1%2582%25D0%25B2%25D0%25BE_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F">Art of Programming</a> in documents. </p><br><p>  The sequence is pretty simple: </p><br><pre><code class="bash hljs">$ du -sh knuth.pdf dogs/ 44M knuth.pdf 633M dogs/ $ ./f5ar -p dogs/ .*jpg knuth.pdf dogs.f5ar Reading compressing file... ok Initializing the archive... ok Analysing library capacity... <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 17.0s Detected somewhat guaranteed capacity of 48439359 bytes Detected possible capacity of upto 102618787 bytes Compressing... <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 39.4s Saving the archive... ok $ ./f5ar -u dogs/dogs.f5ar knuth_unpacked.pdf Initializing the archive... ok Reading the archive file... ok Filling the archive with files... <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1.4s Decompressing... <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 21.0s Writing extracted data... ok $ sha1sum knuth.pdf knuth_unpacked.pdf 5bd1f496d2e45e382f33959eae5ab15da12cd666 knuth.pdf 5bd1f496d2e45e382f33959eae5ab15da12cd666 knuth_unpacked.pdf $ du -sh dogs/ 551M dogs/</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Screenshots for fans</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/-y/by/6h/-yby6h4ssyerd6uorenw23vfvu8.png" alt="Skrnsht"></p><br><p>  The unzipped file can still and should be read: </p><br><p><img src="https://habrastorage.org/webt/0m/qu/js/0mqujsqlcrzzq3pdc1mook5znqq.png"></p></div></div><br><p>  As you can see, from the original 633 + 36 == 669 megabytes of data on the hard disk, we came up with a more pleasant 551. This radical difference is explained by a decrease in the coefficients that affect their subsequent lossless compression: reducing one can only calmly " cut "a couple of bytes from the final file.  Nevertheless, it is still data loss, albeit extremely small, which will have to put up with. </p><br><p>  Fortunately, they are absolutely not visible to the eye.  Under the spoiler (since habrastorage does not know how to large files) the reader can estimate the difference both by eye and by intensity, obtained by subtracting the values ‚Äã‚Äãof the modified component from the original: the <a href="https://vk.com/doc21127172_502646354">original</a> , <a href="https://vk.com/doc21127172_502646406">with the information inside</a> , the <a href="https://vk.com/doc21127172_502646459">difference</a> (the dimmer the color, the smaller the difference in the block ). </p><br><h2 id="vmesto-zaklyucheniya">  Instead of conclusion </h2><br><p>  Looking at all these difficulties, buying a hard disk or uploading everything to the cloud may seem like a much simpler solution to a problem.  But even now we are living in such a wonderful time, there are no guarantees that tomorrow you can still go online and upload all your extra data somewhere.  Or come to the store and buy another hard drive per thousand terabytes.  But you can always use already lying at home. </p><br><p>  -&gt; <a href="https://github.com/LabunskyA/f5ar">GitHub</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/453332/">https://habr.com/ru/post/453332/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../453324/index.html">Diode as rectifier</a></li>
<li><a href="../453326/index.html">How to automate IT infrastructure management - we discuss three trends</a></li>
<li><a href="../453328/index.html">Ten years away</a></li>
<li><a href="../45333/index.html">What can a robot feel?</a></li>
<li><a href="../453330/index.html">What to do when RAM fails. Medical history and treatment methods</a></li>
<li><a href="../453334/index.html">Let's talk about PAKE</a></li>
<li><a href="../453336/index.html">CNC Burning Machine Selection Guide</a></li>
<li><a href="../453338/index.html">Rust 1.35.0 release</a></li>
<li><a href="../453340/index.html">Perl 5.30 released</a></li>
<li><a href="../453342/index.html">Myths about remote employees that we destroyed ourselves</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>