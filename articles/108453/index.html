<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>IPoE, as well as Client-VLAN and DHCP Option 82</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will describe what the Internet access technology IPoE is, which actually does not exist. And also I will tell about the Client-VLAN...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>IPoE, as well as Client-VLAN and DHCP Option 82</h1><div class="post__text post__text-html js-mediator-article">  In this article I will describe what the Internet access technology IPoE is, which actually does not exist.  And also I will tell about the Client-VLAN scheme and about the DHCP option 82 (DHCP Option 82), which have become an integral part of this non-existent technology.  All this, of course, from a technical point of view and with examples of configs. <br><a name="habracut"></a><br>  There are many technologies of Internet access for end users.  Two are especially popular in Russia: PPTP and PPPoE.  In both cases, a PPP tunnel is created, authentication is performed, and subscriber IP traffic flows inside the tunnel.  The main difference between these protocols is that they work at different levels of the OSI network model.  <strong>PPPoE</strong> operates at the second (link) level, adding special tags that identify a specific tunnel in Ethernet frames.  <strong>PPTP</strong> operates at the third (network) level, packaging IP packets in GRE. <br><br><h4>  IPoE </h4><br>  <strong>IPoE is</strong> fundamentally different from PPTP and PPPoE.  In general, this technology does not exist.  There is no RFC, there are no standards describing it.  The term itself was coined most likely in Russia and is abstract.  It means the following: <strong><em>IP over Ethernet</em></strong> .  The meaning is exactly the same as decryption - IP-traffic over Ethernet, roughly speaking, is a regular LAN.  The subscriber is given at best a static or dynamic white IP address, at worst a gray IP with NAT.  Access control in this case can be done using IP-MAC bindings on access switches or BRAS or allocating VLAN for each subscriber (the so-called Client-VLAN). <br><br><h4>  Client-VLAN </h4><br>  When using <strong>Client-VLAN</strong> technology, the problem arises: how to save IP-addresses?  After all, if you think about it, each client should be assigned a / 30 subnet.  In fact, the problem is easily solved.  I give an example for a Linux based router: <br><pre>  ip route add unreachable 192.0.2.0/24
 ip addr add 192.0.2.1/32 dev lo<font></font>
<font></font>
 vconfig add eth0 101
 ip link set eth0.101 up
 ip route add 192.0.2.101/32 dev eth0.101 src 192.0.2.1 </pre><br><blockquote>  The subnet 192.0.2.0/24 is recommended by the IANA for use in the examples. </blockquote><br>  This is a classic Cisco <em>ip unnumbered</em> Linux implementation.  The IP gateway (192.0.2.1) hangs on the loopback interface, is made <code>unreachable</code> for the entire subnet, so that the packets go only to the hosts for which routing is registered.  Next, the VLAN rises and the routing is written to a specific host (mask / 32) from the <code>src</code> gateway.  And you can do a little differently (this once again demonstrates the flexibility of Linux): <br><pre>  ip route add unreachable 192.0.2.0/24<font></font>
<font></font>
 vconfig add eth0 101
 ip link set eth0.101 up
 ip addr add 192.0.2.1/32 dev eth0.101
 ip route add 192.0.2.101/32 dev eth0.101 </pre><br>  Or so: <br><pre>  ip route add unreachable 192.0.2.0/24<font></font>
<font></font>
 vconfig add eth0 101
 ip link set eth0.101 up
 ip addr add 192.0.2.1/24 dev eth0.101
 ip route del 192.0.2.0/24 dev eth0.101
 ip route add 192.0.2.101/32 dev eth0.101 </pre><br>  All these options work, you can choose the one in which the interfaces are displayed in the most convenient way.  In all cases, the subscriber IP is 192.0.2.101/24. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Proxy_arp </h4><br>  Another problem you may encounter is that there is no connection between subscribers in different VLANs and with IP from the same subnet.  Indeed, the subscriber system sees that the destination IP address is on the same subnet as it, and sends ARP requests to determine the MAC, but nothing comes of this, since  they are in different vlans.  The <strong>proxy_arp</strong> technology serves to solve this problem.  Its essence is that the router, when receiving ARP requests from the interface, will check whether it has the requested IP on other interfaces.  If there is, then in response to an ARP request, it will issue its MAC.  Thus, the packets will be sent to the router, which will take care of their delivery.  The proxy_arp for a specific interface is enabled as follows: <br><pre>  sysctl net.ipv4.conf.eth0 / 101.proxy_arp = 1 </pre><br>  or <br><pre>  echo 1&gt; /proc/sys/net/ipv4/conf/eth0.101/proxy_arp </pre><br><br><h4>  DHCP Option 82 </h4><br>  When using IPoE, DHCP simplifies network configuration on the subscriber side to zero.  Stuck patchkord and you're online.  Only the question arises: how does DHCP know to whom to issue which address?  You can identify by MAC, especially if you are already using IP-MAC bindings.  But MAC bindings are fraught with frequent support calls, since  Subscribers sometimes change equipment.  The extension of the protocol DHCP - <strong>Option 82</strong> will help to cope with this problem.  Option 82 contains two fields: <br><ul><li>  Agent Circuit ID ‚Äî The DHCP Relay port number on which the DHCP request arrived. </li><li>  Agent Remote ID is a certain identifier of DHCP Relay itself. </li></ul><br>  At the same time, access switches to which subscribers are directly connected act as DHCP relays.  The Agent Remote ID is usually used as a switch MAC (by default in D-Link).  Option 82 is supported by a wide range of equipment, including those typical for the Russian providers D-Link DES-3526/3028/3200. <br>  There are two DHCP Relay modes on <strong>D-Link</strong> switches: dhcp_relay and dhcp_local_relay.  dhcp_relay works globally, for all ports and VLANs, option 82 is added and the request is no longer transmitted by Broadcast, but directly to the DHCP server, i.e.  This is a full DHCP Relay.  dhcp_local_relay works for specific VLANs, but the query is not actually relaits, and option 82 is simply added to it. <br>  Basic dhcp_relay settings on D-Link: <br><pre>  enable dhcp_relay
 config dhcp_relay option_82 state enable
 config dhcp_relay add ipif System 192.168.0.1 </pre><br>  192.168.0.1 - The IP address of the DHCP server available in the management VLAN. <br>  Basic settings dhcp_local_relay: <br><pre>  enable dhcp_local_relay
 config dhcp_local_relay vlan 101 state enable </pre><br>  Finally, I will provide the basic config for ISC's DHCP with comments: <br><pre>  # write to the log
 log (info, "***");
 if exists agent.circuit-id {
	 # option 82 is present
	 # write to the log the given IP address, Agent Remote ID, Agent Circuit ID
	 log (info, concat ("* Leased", binary-to-ascii (10,8, ".", leased-address), "(with opt82)"));
	 log (info, concat ("* Remote-ID:", binary-to-ascii (16.8, ":", substring (option agent.remote-id, 2,6))));
	 log (info, concat ("* Port:", binary-to-ascii (10,8, "", suffix (option agent.circuit-id, 1))));
 } else {
	 # no option 82
	 # write to the log the given IP address
	 log (info, concat ("* Leased", binary-to-ascii (10,8, ".", leased-address), "(without opt82)"));
 }
 log (info, "***");<font></font>
<font></font>
<font></font>
 # in this example 192.0.2.101/24 - IP of the subscriber connected to the switch with MAC 0: c: 29: ec: 23: 64, on port 1
 # MAC address left, taken from VMWare virtuals
 # 192.168.0.0/24 - switch management subnet, DHCP requests will come from addresses on this subnet
 # these two subnets should be combined into one shared-network for proper operation<font></font>
<font></font>
 shared-network test {<font></font>
<font></font>
 subnet 192.0.2.0 netmask 255.255.255.0 {<font></font>
<font></font>
	 # define class<font></font>
<font></font>
	 class "v101" {<font></font>
<font></font>
		 # determine the conditions for compliance with the class:
		 # Agent Circuit ID = 1, Agent Remote ID = 0: c: 29: ec: 23: 64
		 # note - leading zeros are not written in Agent Remote ID (ie, c instead of 0c, etc.)<font></font>
<font></font>
		 match if (binary-to-ascii (10,8, "", suffix (option agent.circuit-id, 1)) = "1") and
			 (binary-to-ascii (16.8, ":", substring (option agent.remote-id, 2.6)) = "0: c: 29: ec: 23: 64");
	 }<font></font>
<font></font>
	 # actually issue IP class<font></font>
<font></font>
	 pool {
		 range 192.0.2.101;
		 allow members of "v101";
	 }
 }<font></font>
<font></font>
 subnet 192.168.0.0 netmask 255.255.255.0 {
 }<font></font>
<font></font>
 } </pre></div><p>Source: <a href="https://habr.com/ru/post/108453/">https://habr.com/ru/post/108453/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../108441/index.html">Testing various ICQ clients on the Android platform</a></li>
<li><a href="../108443/index.html">Hg Init: Part 1. Re-training for Subversion users</a></li>
<li><a href="../108448/index.html">How to find traffic statistics in site statistics?</a></li>
<li><a href="../108449/index.html">Mobile Developer Day: developers present startups</a></li>
<li><a href="../108452/index.html">Report on the excursion to the largest commercial data center in Russia. Built by Megaphone (this data center will soon also become a hosting site)</a></li>
<li><a href="../108454/index.html">Prelink and Preload to speed up the launch of programs in Linux</a></li>
<li><a href="../108456/index.html">Peripeteia detection and unpacking</a></li>
<li><a href="../108457/index.html">Highload on cheap hosting: a hash table in MySQL</a></li>
<li><a href="../108458/index.html">Penguins Without Borders: How the Character was Created for an Internet Provider</a></li>
<li><a href="../108459/index.html">PDF from the point of view of the programmer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>