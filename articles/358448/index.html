<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatically build Unity projects for Android and iOS using Gitlab CI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I want to talk about the approach to building Unity-projects on android and ios via Gitlab on my own collectors with macOS. 


 I work...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatically build Unity projects for Android and iOS using Gitlab CI</h1><div class="post__text post__text-html js-mediator-article"><p>  In this article I want to talk about the approach to building Unity-projects on android and ios via Gitlab on my own collectors with macOS. </p><br><p>  I work in a small gamedev company, and the task of automating the assembly appeared due to the following problems: </p><br><ul><li>  5 distributed teams must collect projects from anywhere in the world </li><li>  different unit versions must be supported </li><li>  the assembler must provide at least 5 assemblies per week from each team </li><li>  certificates must be stored centrally, not by developers </li><li>  assembled builds should be available via link anywhere in the world. </li><li>  projects should be checked for the presence of mandatory libraries (advertising sdk and codes, localization, preservation) </li><li>  configuring the build for teams should be done in one place </li></ul><a name="habracut"></a><br><p>  To solve these problems, ready-made solutions have already been created: Unity Cloud Build, TeamCity, Jenkins, Gitlab CI, Bitbucket Pipelines. </p><br><p>  The first of them, although prepared for the assembly of Unity-projects, but does not allow to automate the work with certificates, and for each project they have to start manually.  TeamCity and Jenkins require customization of the project in the admin area (this makes configuration a bit harder for developers), installing additional software on a separate server and supporting it.  As a result, the simplest and fastest in implementation remained two options - Gitlab and Bitbucket. <br>  At the time of solving the problem, Bitbucket Pipelines had not yet announced, so it was decided to use Gitlab. </p><br><p>  To implement the approach, the following steps were performed: </p><br><ul><li>  Project Setup </li><li>  Runner setup </li><li>  Build build scripts </li></ul><br><h2 id="1-nastroyka-proekta">  1. Setting up the project </h2><br><p>  Projects that are built on the picker we store on Gitlab.  The free version of the service does not limit the repositories themselves and their number. <br>  For each project, a runner is turned on (a service that executes commands from a gitlab server) running on a poppy. <br>  The configuration for the collector lies in the project root in the form of a .gitlab-ci.yml file.  It describes the application id, the required signing identity (keystore for android and account name for ios), the required version of Unity, the branch, the launch mode: manual or automatic, and the command that starts the build (if necessary, gitlab supports much more parameters, <a href="https://docs.gitlab.com/ee/ci/yaml/">documentation</a> ) . </p><br><div class="spoiler">  <b class="spoiler_title">Sample configuration file .gitlab-ci.yml</b> <div class="spoiler_text"><pre><code class="bash hljs">variables: BUNDLE: com.banana4apps.evolution SIGNING: banana4apps UNITY_VERSION: 2017.1 build:android: script: - buildAndroid.sh <span class="hljs-variable"><span class="hljs-variable">$BUNDLE</span></span> <span class="hljs-variable"><span class="hljs-variable">$SIGNING</span></span> <span class="hljs-variable"><span class="hljs-variable">$UNITY_VERSION</span></span> only: - releaseAndroid when: manual build:ios: script: - buildIOS.sh <span class="hljs-variable"><span class="hljs-variable">$BUNDLE</span></span> <span class="hljs-variable"><span class="hljs-variable">$SIGNING</span></span> <span class="hljs-variable"><span class="hljs-variable">$UNITY_VERSION</span></span> only: - releaseIOS when: manual</code> </pre> </div></div><br><h2 id="2-nastroyka-rannera">  2. Runner setup </h2><br><p>  Gitlab CI works with shared and own runners ( <a href="https://docs.gitlab.com/runner/">documentation</a> ).  The free version limits the number of hours of use of shared runners, but allows you to use your own runners unlimitedly.  Shared runners run on linux, so iOS applications cannot be assembled on them (but it will work to launch Unity, there was an article about this in Habr√©).  Because of this, I had to raise runners on my own poppies.  In the example above, the runner runs the buildAndroid.sh or buildIOS.sh script (depending on the branch), which describes the preparatory steps, the launch of Unity and the notification of the build result. <br>  The process of setting up a runner is well described in the documentation and comes down to running <code>gitlab-runner install</code> and <code>gitlab-runner start</code> . <br>  After that, the necessary Unity versions are installed on the Mac. </p><br><h2 id="3-sozdanie-skriptov-sborki">  3. Creating build scripts </h2><br><p>  For each of the platforms, due to differences in the build process, I had to write my own script.  But the algorithm is the same: </p><br><ul><li>  we check the correctness of the project id, the availability of certificates for the required signing identity </li><li>  determine the path to the SDK, Java </li><li>  Create a class in the C # project with a method to run the assembly </li><li>  check the availability of the required version of Unity and run the assembly.  If not, then try to build on the default version </li><li>  Check for apk or Xcode of the project, and if they are not there, we signal an error in Slack </li><li>  for iOS: build an Xcode project </li><li>  upload artifacts (apk, ipa) to the server (for example, Amazon S3) </li><li>  signaling a successful build in Slack and sending a link to download artifacts </li></ul><br><p>  A feature of the Unity project build is that Unity in batch mode allows you to perform only the static method of the class present in the project.  Therefore, the build script ‚Äúthrows‚Äù into the project a class with methods for running the build: </p><br><div class="spoiler">  <b class="spoiler_title">CustomBuild.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomBuild</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> outputProjectsFolder = Environment.GetEnvironmentVariable(<span class="hljs-string"><span class="hljs-string">"OutputDirectory"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> xcodeProjectsFolder = Environment.GetEnvironmentVariable(<span class="hljs-string"><span class="hljs-string">"XcodeDirectory"</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuildAndroid</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { BuildTarget target = BuildTarget.Android; EditorUserBuildSettings.SwitchActiveBuildTarget(target); PlayerSettings.applicationIdentifier = Environment.GetEnvironmentVariable(<span class="hljs-string"><span class="hljs-string">"AppBundle"</span></span>); PlayerSettings.Android.keystoreName = Environment.GetEnvironmentVariable(<span class="hljs-string"><span class="hljs-string">"KeystoreName"</span></span>); PlayerSettings.Android.keystorePass = Environment.GetEnvironmentVariable(<span class="hljs-string"><span class="hljs-string">"KeystorePassword"</span></span>); PlayerSettings.Android.keyaliasName = Environment.GetEnvironmentVariable(<span class="hljs-string"><span class="hljs-string">"KeyAlias"</span></span>); PlayerSettings.Android.keyaliasPass = Environment.GetEnvironmentVariable(<span class="hljs-string"><span class="hljs-string">"KeyPassword"</span></span>); BuildPipeline.BuildPlayer(GetScenes(), <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"{0}/{1}.apk"</span></span> , outputProjectsFolder, PlayerSettings.applicationIdentifier), target, options); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuildIOS</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { BuildTarget target = BuildTarget.iOS; EditorUserBuildSettings.SwitchActiveBuildTarget(target); PlayerSettings.applicationIdentifier = Environment.GetEnvironmentVariable(<span class="hljs-string"><span class="hljs-string">"AppBundle"</span></span>); PlayerSettings.iOS.appleDeveloperTeamID = Environment.GetEnvironmentVariable(<span class="hljs-string"><span class="hljs-string">"GymTeamId"</span></span>); BuildPipeline.BuildPlayer(GetScenes(), xcodeProjectsFolder, target, options); } <span class="hljs-comment"><span class="hljs-comment">//        static string[] GetScenes() { var projectScenes = EditorBuildSettings.scenes; List&lt;string&gt; scenesToBuild = new List&lt;string&gt;(); for (int i = 0; i &lt; projectScenes.Length; i++) { if (projectScenes[i].enabled) { scenesToBuild.Add(projectScenes[i].path); } } return scenesToBuild.ToArray(); } }</span></span></code> </pre> </div></div><br><p>  The Environment.GetEnvironmentVariable method gets the value of environment variables that were previously specified in bash scripts. </p><br><p>  <strong>Sample build script for Android</strong> </p><br><div class="spoiler">  <b class="spoiler_title">buildAndroid.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs">GREEN=<span class="hljs-string"><span class="hljs-string">'\033[0;32m'</span></span> RED=<span class="hljs-string"><span class="hljs-string">'\033[0;33m'</span></span> NC=<span class="hljs-string"><span class="hljs-string">'\033[0m'</span></span> <span class="hljs-comment"><span class="hljs-comment"># No Color export COMMIT=$(git log -1 --oneline ‚Äîno-merges) if [ "$1" = "" ]; then echo -e "${RED}You must provide application Id${NC}" exit 1 fi export ANDROID_HOME=/Library/Android export OutputDirectory=./ export AppBundle=$1 if [ "$2" = "account1" ]; then export KeystoreName="$CI_DATA_PATH/keystores/account1.keystore" export KeystorePassword="..." export KeyAlias="..." export KeyPassword="..." elif [ "$2" = "account2" ]; then export KeystoreName="$CI_DATA_PATH/keystores/account2.keystore" export KeystorePassword="..." export KeyAlias="..." export KeyPassword="..." else echo "${RED}No keystore config found for $2${NC}" exit 1 fi echo -e "${GREEN}BundleId: ${AppBundle}${NC}" echo -e "${GREEN}Signing: ${KeyAlias}${NC}" #      mkdir -p $CI_PROJECT_DIR/Assets/Editor &amp;&amp; cp $CI_DATA_PATH/CustomBuild.cs "$_" #   Unity if [ "$3" = "5.5" ]; then /Applications/Unity5.5/Unity.app/Contents/MacOS/Unity -buildTarget android -projectPath $CI_PROJECT_DIR -batchmode -executeMethod CustomBuild.Android -quit -logFile /dev/stdout -username "..." -password "..." elif [ "$3" = "2017.1" ]; then /Applications/Unity2017.1/Unity.app/Contents/MacOS/Unity -buildTarget android -projectPath $CI_PROJECT_DIR -batchmode -executeMethod CustomBuild.Android -quit -logFile /dev/stdout -username "..." -password "..." else /Applications/Unity5.6.4/Unity.app/Contents/MacOS/Unity -buildTarget android -projectPath $CI_PROJECT_DIR -batchmode -executeMethod CustomBuild.Android -quit -logFile /dev/stdout -username "..." -password "..." fi #  ,   apk export APK="${CI_PROJECT_DIR}/${OutputDirectory}/${AppBundle}.${CI_BUILD_ID}.apk" echo "Testing apk exists: ${APK}..." if [ -f ${APK} ]; then echo -e "${GREEN}BUILD FOR ANDROID SUCCESS${NC}" #  apk      aws s3 cp ${APK} s3://ci-data/android/${AppBundle}.${CI_BUILD_ID}.apk --grants read=uri=http://acs.amazonaws.com/groups/global/AllUsers echo "&lt;html&gt;&lt;title&gt;Download apk: ${AppBundle}&lt;/title&gt;&lt;body&gt;&lt;a href=\"https://ci-data.s3.amazonaws.com/android/${AppBundle}.${CI_BUILD_ID}.apk\"&gt;Install&lt;br&gt;&lt;br&gt;&lt;strong&gt;${AppBundle}&lt;/strong&gt;&lt;br&gt;&lt;small&gt;${COMMIT}&lt;br&gt;(build ${CI_BUILD_ID} - android)&lt;/small&gt;&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;" &gt;&gt; ${CI_PROJECT_DIR}/download.html #  html      aws s3 cp ${CI_PROJECT_DIR}/download.html s3://ci-data/android/${AppBundle}.${CI_BUILD_ID}.html --grants read=uri=http://acs.amazonaws.com/groups/global/AllUsers #    Slack ${CI_DATA_PATH}/notifySlack.sh android success "https://ci-data.s3.amazonaws.com/android/${AppBundle}.${CI_BUILD_ID}.html" exit 0 else echo -e "${RED}BUILD FOR ANDROID FAILED${NC}" ${CI_DATA_PATH}/notifySlack.sh android failure exit 1 fi</span></span></code> </pre> </div></div><br><p>  <strong>Sample build script for iOS</strong> <br>  Building projects is carried out in two steps: the formation of the Xcode project from Unity and the assembly of the Xcode project.  Developers can not directly influence the Xcode project, which introduces restrictions: you can not directly change the project settings, build information. <br>  Also, the build feature on iOS is that test devices must be registered in the provisioning profile of the application.  And in order to build an Xcode project, you need to create a certificate, provisioning profile and application id in the Apple developer console before assembly. <br>  To automate this process is used <a href="https://fastlane.tools/">fastlane</a> .  This tool creates and synchronizes certificates, profiles and allows you to upload builds and meta-information to itunes connect. </p><br><p>  When building Unity projects without access to Xcode, there are nuances: </p><br><ul><li>  in Unity, before building the project, you need to specify TeamId, which is in the developer console - this is done through PlayerSettings.iOS.appleDeveloperTeamID </li><li>  In the postprocess project script, you must pre-process the Xcode project: set up info.plist, build settings <br>  The release and Ad-Hoc builds also have different scripts that differ in the formation of the result: the release loads the archive into itunes connect, and ad-hoc loads the ipa, creates a manifest and a page for downloading over the air, the link to which is sent to all interested parties. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Ad-hoc build: buildAdhocIOS.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs">GREEN=<span class="hljs-string"><span class="hljs-string">'\033[0;32m'</span></span> RED=<span class="hljs-string"><span class="hljs-string">'\033[0;33m'</span></span> NC=<span class="hljs-string"><span class="hljs-string">'\033[0m'</span></span> <span class="hljs-comment"><span class="hljs-comment"># No Color export COMMIT=$(git log -1 --oneline --no-merges) if [ "$1" = "" ]; then echo -e "${RED}You must provide application Id${NC}" exit 1 fi if [ "$2" = "account1" ]; then #    fastlane  export AccountName="account email" export AccountDesc="account description" export FastlanePassword="..." export GymExportTeamId="..." export FastlaneRepository="fastlane-keys.git" export ProduceTeamName="team name" else echo "${RED}No keystore config found for $2${NC}" exit 1 fi echo -e "${GREEN}BundleId: ${AppBundle}${NC}" echo -e "${GREEN}Account: ${AccountDesc} (${2})${NC}" #      mkdir -p $CI_PROJECT_DIR/Assets/Editor &amp;&amp; cp $CI_DATA_PATH/CustomBuild.cs "$_" #   Unity if [ "$3" = "5.5" ]; then /Applications/Unity5.5/Unity.app/Contents/MacOS/Unity -buildTarget ios -projectPath $CI_PROJECT_DIR -batchmode -executeMethod CustomBuild.IOS -quit -logFile /dev/stdout -username "..." -password "..." elif [ "$3" = "2017.1" ]; then /Applications/Unity2017.1/Unity.app/Contents/MacOS/Unity -buildTarget ios -projectPath $CI_PROJECT_DIR -batchmode -executeMethod CustomBuild.IOS -quit -logFile /dev/stdout -username "..." -password "..." else /Applications/Unity5.6.4/Unity.app/Contents/MacOS/Unity -buildTarget ios -projectPath $CI_PROJECT_DIR -batchmode -executeMethod CustomBuild.IOS -quit -logFile /dev/stdout -username "..." -password "..." fi # ,  Unity  XCode  XCODE_FILES="${CI_PROJECT_DIR}/${XcodeDirectory}" if [ -d ${XCODE_FILES} ]; then #    Apple Developer Console export PRODUCE_APP_IDENTIFIER=${AppBundle} export PRODUCE_APP_NAME=${AppBundle} export PRODUCE_USERNAME=${AccountName} export PRODUCE_SKU=${AppBundle} # skip_itc     itunes connect -  adhoc   fastlane produce --app_version "1.0" --language "English" --skip_itc #    code signing keys and profiles cd "${CI_PROJECT_DIR}/${XcodeDirectory}" rm -f Matchfile echo "git_url \"${FastlaneRepository}\"" &gt;&gt; Matchfile echo "app_identifier [\"${AppBundle}\"]" &gt;&gt; Matchfile echo "username \"${AccountName}\"" &gt;&gt; Matchfile # ,      export MATCH_PASSWORD='...' #     ,    # force_for_new_devices true     ,    developer console fastlane match adhoc --force_for_new_devices true #  Gymfile   XCode project   Ad-Hoc  rm -f Gymfile echo "export_options(" &gt;&gt; Gymfile echo " manifest: {" &gt;&gt; Gymfile echo " appURL: \"https://ci-data.s3.amazonaws.com/ios/${AppBundle}.${CI_BUILD_ID}.ipa\"," &gt;&gt; Gymfile echo " displayImageURL: \"https://ci-data.s3.amazonaws.com/ios-icon.png\"," &gt;&gt; Gymfile echo " fullSizeImageURL: \"https://ci-data.s3.amazonaws.com/ios-icon-big.png\"" &gt;&gt; Gymfile echo " }," &gt;&gt; Gymfile echo ")" &gt;&gt; Gymfile fastlane gym --scheme "Unity-iPhone" --export_method ${GYM_EXPORT_METHOD} --xcargs "DEVELOPMENT_TEAM=\"${GYM_EXPORT_TEAM_ID}\" PROVISIONING_PROFILE_SPECIFIER=\"match AdHoc ${AppBundle}\" CODE_SIGN_IDENTITY=\"iPhone Distribution: ${AccountDesc}\"" -o "${CI_PROJECT_DIR}/" -n "${AppBundle}.${CI_BUILD_ID}.ipa" #      S3 export IPA="${CI_PROJECT_DIR}/${AppBundle}.${CI_BUILD_ID}.ipa" ls -l "${CI_PROJECT_DIR}/${XcodeDirectory}/*.ipa" echo "Testing ipa exists: ${IPA}..." if [ -f ${IPA} ]; then echo -e "Begin uploading to S3..." aws s3 cp ${CI_PROJECT_DIR}/${AppBundle}.${CI_BUILD_ID}.ipa s3://ci-data/ios/${AppBundle}.${CI_BUILD_ID}.ipa --grants read=uri=http://acs.amazonaws.com/groups/global/AllUsers aws s3 cp ${CI_PROJECT_DIR}/manifest.plist s3://ci-data/ios/${AppBundle}.${CI_BUILD_ID}.plist --grants read=uri=http://acs.amazonaws.com/groups/global/AllUsers echo "&lt;html&gt;&lt;title&gt;Download ipa: ${AppBundle}&lt;/title&gt;" &gt;&gt; ${CI_PROJECT_DIR}/download.html echo "&lt;body&gt;&lt;a href=\"itms-services://?action=download-manifest&amp;url=https://ci-data.s3.amazonaws.com/ios/${AppBundle}.${CI_BUILD_ID}.plist\"&gt;Install&lt;br&gt;&lt;br&gt;&lt;strong&gt;${AppBundle}&lt;/strong&gt;&lt;br&gt;&lt;small&gt;${COMMIT}&lt;br&gt;(build ${CI_BUILD_ID} - iOS)&lt;/small&gt;&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;" &gt;&gt; ${CI_PROJECT_DIR}/download.html aws s3 cp ${CI_PROJECT_DIR}/download.html s3://ci-data/ios/${AppBundle}.${CI_BUILD_ID}.html --grants read=uri=http://acs.amazonaws.com/groups/global/AllUsers ${CI_DATA_PATH}/notifySlack.sh ios ad-hoc "https://ci-data.s3.amazonaws.com/ios/${AppBundle}.${CI_BUILD_ID}.html" echo -e "${GREEN}BUILD AD-HOC FOR IOS SUCCESS${NC}" exit 0 else echo -e "${RED}BUILD AD-HOC FOR IOS FAILED${NC}" ${CI_DATA_PATH}/notifySlack.sh ios failure exit 1 fi else echo -e "${RED}BUILD FOR IOS FAILED${NC}" ${CI_DATA_PATH}/notifySlack.sh ios failure exit 1 fi</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Build release: buildIOS.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs">GREEN=<span class="hljs-string"><span class="hljs-string">'\033[0;32m'</span></span> RED=<span class="hljs-string"><span class="hljs-string">'\033[0;33m'</span></span> NC=<span class="hljs-string"><span class="hljs-string">'\033[0m'</span></span> <span class="hljs-comment"><span class="hljs-comment"># No Color export COMMIT=$(git log -1 --oneline --no-merges) if [ "$1" = "" ]; then echo -e "${RED}You must provide application Id${NC}" exit 1 fi if [ "$2" = "account1" ]; then #    fastlane  export AccountName="account email" export AccountDesc="account description" export FastlanePassword="..." export GymExportTeamId="..." export FastlaneRepository="fastlane-keys.git" export ProduceTeamName="team name" else echo "${RED}No keystore config found for $2${NC}" exit 1 fi echo -e "${GREEN}BundleId: ${AppBundle}${NC}" echo -e "${GREEN}Account: ${AccountDesc} (${2})${NC}" #      mkdir -p $CI_PROJECT_DIR/Assets/Editor &amp;&amp; cp $CI_DATA_PATH/CustomBuild.cs "$_" #   Unity if [ "$3" = "5.5" ]; then /Applications/Unity5.5/Unity.app/Contents/MacOS/Unity -buildTarget ios -projectPath $CI_PROJECT_DIR -batchmode -executeMethod CustomBuild.IOS -quit -logFile /dev/stdout -username "..." -password "..." elif [ "$3" = "2017.1" ]; then /Applications/Unity2017.1/Unity.app/Contents/MacOS/Unity -buildTarget ios -projectPath $CI_PROJECT_DIR -batchmode -executeMethod CustomBuild.IOS -quit -logFile /dev/stdout -username "..." -password "..." else /Applications/Unity5.6.4/Unity.app/Contents/MacOS/Unity -buildTarget ios -projectPath $CI_PROJECT_DIR -batchmode -executeMethod CustomBuild.IOS -quit -logFile /dev/stdout -username "..." -password "..." fi # ,  Unity  XCode  XCODE_FILES="${CI_PROJECT_DIR}/${XcodeDirectory}" if [ -d ${XCODE_FILES} ]; then #    Apple Developer Console and Itunes Connect export PRODUCE_APP_IDENTIFIER=${AppBundle} export PRODUCE_APP_NAME=${AppBundle} export PRODUCE_USERNAME=${AccountName} export PRODUCE_SKU=${AppBundle} fastlane produce --app_version "1.0" --language "English" #    code signing keys and profiles cd "${CI_PROJECT_DIR}/${XcodeDirectory}" rm -f Matchfile echo "git_url \"${FastlaneRepository}\"" &gt;&gt; Matchfile echo "app_identifier [\"${AppBundle}\"]" &gt;&gt; Matchfile echo "username \"${AccountName}\"" &gt;&gt; Matchfile # ,      export MATCH_PASSWORD='...' #    fastlane match appstore #   XCode fastlane gym --scheme "Unity-iPhone" --xcargs "DEVELOPMENT_TEAM=\"${GymExportTeamId}\" PROVISIONING_PROFILE_SPECIFIER=\"match AppStore ${AppBundle}\" CODE_SIGN_IDENTITY=\"iPhone Distribution: ${AccountDesc}\"" -o "${CI_PROJECT_DIR}/" -n "${AppBundle}.${CI_BUILD_ID}.ipa" #   itunes connect export IPA="${CI_PROJECT_DIR}/${AppBundle}.${CI_BUILD_ID}.ipa" ls -l "${CI_PROJECT_DIR}/${XcodeDirectory}/*.ipa" echo "Testing ipa exists: ${IPA}..." if [ -f ${IPA} ]; then rm -f Deliverfile echo "app_identifier \"${AppBundle}\"" &gt;&gt; Deliverfile echo "username \"${AccountName}\"" &gt;&gt; Deliverfile echo "ipa \"${IPA}\"" &gt;&gt; Deliverfile echo "submit_for_review false" &gt;&gt; Deliverfile echo "force true" &gt;&gt; Deliverfile fastlane deliver echo -e "${GREEN}BUILD FOR IOS SUCCESS${NC}" exit 0 else echo -e "${RED}BUILD FOR IOS FAILED${NC}" ${CI_DATA_PATH}/notifySlack.sh ios failure exit 1 fi else echo -e "${RED}BUILD FOR IOS FAILED${NC}" ${CI_DATA_PATH}/notifySlack.sh ios failure exit 1 fi</span></span></code> --xcargs "DEVELOPMENT_TEAM = \" $ {GymExportTeamId} \ "PROVISIONING_PROFILE_SPECIFIER = \" match AppStore $ {AppBundle} \ "CODE_SIGN_IDENTITY = \" iPhone Distribution: $ {AccountDesc} \ "" <code class="bash hljs">GREEN=<span class="hljs-string"><span class="hljs-string">'\033[0;32m'</span></span> RED=<span class="hljs-string"><span class="hljs-string">'\033[0;33m'</span></span> NC=<span class="hljs-string"><span class="hljs-string">'\033[0m'</span></span> <span class="hljs-comment"><span class="hljs-comment"># No Color export COMMIT=$(git log -1 --oneline --no-merges) if [ "$1" = "" ]; then echo -e "${RED}You must provide application Id${NC}" exit 1 fi if [ "$2" = "account1" ]; then #    fastlane  export AccountName="account email" export AccountDesc="account description" export FastlanePassword="..." export GymExportTeamId="..." export FastlaneRepository="fastlane-keys.git" export ProduceTeamName="team name" else echo "${RED}No keystore config found for $2${NC}" exit 1 fi echo -e "${GREEN}BundleId: ${AppBundle}${NC}" echo -e "${GREEN}Account: ${AccountDesc} (${2})${NC}" #      mkdir -p $CI_PROJECT_DIR/Assets/Editor &amp;&amp; cp $CI_DATA_PATH/CustomBuild.cs "$_" #   Unity if [ "$3" = "5.5" ]; then /Applications/Unity5.5/Unity.app/Contents/MacOS/Unity -buildTarget ios -projectPath $CI_PROJECT_DIR -batchmode -executeMethod CustomBuild.IOS -quit -logFile /dev/stdout -username "..." -password "..." elif [ "$3" = "2017.1" ]; then /Applications/Unity2017.1/Unity.app/Contents/MacOS/Unity -buildTarget ios -projectPath $CI_PROJECT_DIR -batchmode -executeMethod CustomBuild.IOS -quit -logFile /dev/stdout -username "..." -password "..." else /Applications/Unity5.6.4/Unity.app/Contents/MacOS/Unity -buildTarget ios -projectPath $CI_PROJECT_DIR -batchmode -executeMethod CustomBuild.IOS -quit -logFile /dev/stdout -username "..." -password "..." fi # ,  Unity  XCode  XCODE_FILES="${CI_PROJECT_DIR}/${XcodeDirectory}" if [ -d ${XCODE_FILES} ]; then #    Apple Developer Console and Itunes Connect export PRODUCE_APP_IDENTIFIER=${AppBundle} export PRODUCE_APP_NAME=${AppBundle} export PRODUCE_USERNAME=${AccountName} export PRODUCE_SKU=${AppBundle} fastlane produce --app_version "1.0" --language "English" #    code signing keys and profiles cd "${CI_PROJECT_DIR}/${XcodeDirectory}" rm -f Matchfile echo "git_url \"${FastlaneRepository}\"" &gt;&gt; Matchfile echo "app_identifier [\"${AppBundle}\"]" &gt;&gt; Matchfile echo "username \"${AccountName}\"" &gt;&gt; Matchfile # ,      export MATCH_PASSWORD='...' #    fastlane match appstore #   XCode fastlane gym --scheme "Unity-iPhone" --xcargs "DEVELOPMENT_TEAM=\"${GymExportTeamId}\" PROVISIONING_PROFILE_SPECIFIER=\"match AppStore ${AppBundle}\" CODE_SIGN_IDENTITY=\"iPhone Distribution: ${AccountDesc}\"" -o "${CI_PROJECT_DIR}/" -n "${AppBundle}.${CI_BUILD_ID}.ipa" #   itunes connect export IPA="${CI_PROJECT_DIR}/${AppBundle}.${CI_BUILD_ID}.ipa" ls -l "${CI_PROJECT_DIR}/${XcodeDirectory}/*.ipa" echo "Testing ipa exists: ${IPA}..." if [ -f ${IPA} ]; then rm -f Deliverfile echo "app_identifier \"${AppBundle}\"" &gt;&gt; Deliverfile echo "username \"${AccountName}\"" &gt;&gt; Deliverfile echo "ipa \"${IPA}\"" &gt;&gt; Deliverfile echo "submit_for_review false" &gt;&gt; Deliverfile echo "force true" &gt;&gt; Deliverfile fastlane deliver echo -e "${GREEN}BUILD FOR IOS SUCCESS${NC}" exit 0 else echo -e "${RED}BUILD FOR IOS FAILED${NC}" ${CI_DATA_PATH}/notifySlack.sh ios failure exit 1 fi else echo -e "${RED}BUILD FOR IOS FAILED${NC}" ${CI_DATA_PATH}/notifySlack.sh ios failure exit 1 fi</span></span></code> </pre> </div></div><br><h3 id="kak-s-etoy-sistemoy-rabotayut-drugie">  How do others work with this system? </h3><br><ul><li>  The developer adds a template .gitlab-ci.yml file to the project root, includes a runner in the project settings for gitlab.com, and pushes the code to the correct branch. </li><li>  Game designer and tester receive in Slack a notification of successful build and a link to download apk and ipa archives. </li><li>  I follow the builds, I see logs and I can help developers deal with errors.  Logs and running builds can be seen right on gitlab.  Of the minuses - now in the interface you can not see the build queue for a specific runner. </li></ul><br><p>  Interface for viewing the build logs: </p><br><p><img src="https://habrastorage.org/webt/jf/kx/lk/jfkxlke2pwzx2y38iyxanpg9jng.png" alt="image"></p><br><h3 id="rezultaty">  results </h3><br><p>  Thus, the resulting system is easy to use, allows you to add checks and validations from the server (code style, tests), while managers see links to assemblies in Slack and there are no problems with assembling on iOS. </p><br><p>  From minuses - its support is necessary for adding new versions of Unity, signing identity and ensuring the health of poppies. </p><br><p>  At the moment we have two runners (about two years), more than 4000 assemblies have passed through the system.  The build speed depends on the runner‚Äôs characteristics and the number of assets in the project, because they are re-imported every time and it varies from 3 to 30 minutes for Android and 10 to 60 for iOS. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/358448/">https://habr.com/ru/post/358448/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358436/index.html">Ubuntu DSVM Review: Alchemy</a></li>
<li><a href="../358438/index.html">How not to miss a single message</a></li>
<li><a href="../358440/index.html">Entering text in Linux (ibus)</a></li>
<li><a href="../358442/index.html">Tester Tools</a></li>
<li><a href="../358444/index.html">Remove trash from Xcode</a></li>
<li><a href="../358450/index.html">How to identify and develop talents in IT: the results of the first Team Leader meetup</a></li>
<li><a href="../358452/index.html">Ramda Thinking: Pointless Notation</a></li>
<li><a href="../358456/index.html">UK encryption devices: English restraint in every detail</a></li>
<li><a href="../358458/index.html">The digest of interesting materials for the mobile developer # 252 (May 7 - May 13)</a></li>
<li><a href="../358460/index.html">Natural Motion Simulation: Steering Behaviors - 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>