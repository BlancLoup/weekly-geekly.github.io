<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Deep learning on R, we train word2vec</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Word2vec is practically the only deep learning algorithm that can be run relatively easily on a regular PC (and not on video cards) and which builds a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Deep learning on R, we train word2vec</h1><div class="post__text post__text-html js-mediator-article">  Word2vec is practically the only deep learning algorithm that can be run relatively easily on a regular PC (and not on video cards) and which builds a distributed representation of words in a reasonable time, at least so they think on <a href="https://www.kaggle.com/c/word2vec-nlp-tutorial/details/part-2-word-vectors">Kaggle</a> .  After reading <a href="http://habrahabr.ru/post/249215/">here</a> about what tricks you can do with a trained model, I realized that I just had to try such a thing.  There is only one problem, I mostly work in the R language, but I could not find the official implementation of word2vec under R, I think it simply does not exist. <br><a name="habracut"></a><br>  But there are <a href="http://word2vec.googlecode.com/svn/trunk/">word2vec</a> sources in C and a <a href="https://code.google.com/p/word2vec/">description</a> on Google, and in R you can use external libraries in C, C ++ and Fortran.  By the way, the fastest R libraries are made specifically in C and C ++.  There is also an R-wrap <a href="https://r-forge.r-project.org/R/%3Fgroup_id%3D1571">tmcn.word2vec</a> , which is still under development.  Its author <br>  <a href="http://jianl.org/">Jian Li</a> (site in Chinese) did something like a demo for the Chinese language (it also works with English, I have not tried it with Russian yet).  The problems with this version are as follows: <br><ul><li>  First, all parameters are sewn in C code; </li><li>  Secondly, the author made only one function for working with the trained model - distance, which evaluates the similarity of words and displays 20 variants with the maximum value; </li><li>  Thirdly, I was unable to build a package under x64 Windows.  On win32, the package is installed without problems. </li></ul><br>  Having estimated all this ‚Äúwealth‚Äù, I decided to make my own version of the R-interface to word2vec.  To tell you the truth, I don‚Äôt know C very well, I had to write only simple programs, so I decided to use the Jian Li <a href="https://github.com/rforge/tmcn/tree/master/pkg">source code</a> as a basis, because they are compiled under Windows for sure, otherwise there wouldn‚Äôt be a package.  If something does not work, they can always be checked with the original. <br><br><h4>  Training </h4><br>  In order to compile the C code for R under Windows, you need to additionally install <a href="http://cran.r-project.org/bin/windows/Rtools/">Rtools</a> .  This toolkit contains the gcc compiler, which runs under Cygwin.  After installing Rtools, you need to check the PATH variable.  There should be something like: <br><pre> D: \ Rtools \ bin; D: \ Rtools \ gcc-4.6.3 \ bin; D: \ R \ bin
</pre><br>  Under OS X, no Rtools are required.  You need an installed compiler, the presence of which is checked by the gcc --version command.  If not, you need to install <a href="https://developer.apple.com/xcode/downloads/">Xcode</a> and through Xcode - Command Line Tools. <br><br>  About calling C libraries from R you need to know the following: <br><ol><li>  When calling a function, all values ‚Äã‚Äãare passed in the form of pointers, and care must be taken to explicitly state their type.  The most reliable way is to pass char parameters with the subsequent conversion to the necessary type already in C; </li><li>  The called function does not return a value, i.e.  must be of type void; </li><li>  In the C-code you need to add the instruction #include &lt;Rh&gt;, and if there is a complicated math, then also #include &lt;R.math&gt;; </li><li>  If you need to display something on the R console, instead of printf () it is better to use Rprintf ().  True, my printf () also works. </li></ol><br>  To begin, I decided to do something very simple, such as Hello, World!  But so that any value is transferred there.  Rstudio, which I usually use, allows me to write C and C ++ code and highlights everything correctly.  After writing and saving the code in hello.c, I called up the command line, went to the correct directory and started the compiler with the following command: <br><pre> &gt; R --arch x64 CMD SHLIB hello.c
</pre><br>  Under win32, the architecture key is not needed: <br><pre> &gt; R CMD SHLIB hello.c
</pre><br>  As a result, two files appeared in the directory, hello.o (it can be safely removed) and the hello.dll library.  (On OS X, instead of dll, you get a file with the extension so).  Calling the received hello function in R is done with the following code: <br><pre><code class="hljs pgsql">dyn.<span class="hljs-keyword"><span class="hljs-keyword">load</span></span>("hello.dll") hellof &lt;- <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(n) { .C("hello", <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.integer(n)) } hellof(<span class="hljs-number"><span class="hljs-number">5</span></span>)</code> </pre> <br>  The test showed that everything works correctly and it remains to prepare the data for experimenting with word2vec.  I decided to take them to <a href="https://www.kaggle.com/c/word2vec-nlp-tutorial">Kaggle</a> from the ‚ÄúBag of Words Meets Bags of Popcorn‚Äù task.  <a href="https://www.kaggle.com/c/word2vec-nlp-tutorial/data">There</a> is a training, test and unpartitioned sample, which together contain a hundred thousand review films from IMDB.  After downloading these files, I removed HTML tags, special characters, numbers, punctuation marks, stop words and tokenized ones.  I omit the details of the processing, I already <a href="http://habrahabr.ru/post/255143/">wrote</a> about them. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Word2vec accepts data for training in the form of a text file with one long line containing words separated by spaces (I found this out by analyzing examples of working with word2vec from official documentation).  I stuck data sets in one line and saved it in a text file. <br><br><h4>  Model </h4><br>  In the variant Jian Li, these are two files word2vec.h and word2vec.c.  The first one contains the main code, which basically coincides with the original word2vec.c.  In the second, a wrapper for calling the TrainModel () function.  The first thing I decided to do was pull out all the parameters of the model in the R-code.  It was necessary to edit the R-script and the wrapper in word2vec.c, it turned out this construction: <br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">dyn</span></span>.load(<span class="hljs-string"><span class="hljs-string">"word2vec.dll"</span></span>) word2vec &lt;- function(train_file, output_file, binary, cbow, num_threads, num_features, window, min_count, sample) { //...    ... <span class="hljs-type"><span class="hljs-type">OUT</span></span> &lt;- .<span class="hljs-type"><span class="hljs-type">C</span></span>(<span class="hljs-string"><span class="hljs-string">"CWrapper_word2vec"</span></span>, train_file = <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.character(train_file), output_file = <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.character(output_file), binary = <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.character(binary), //...    ) //...      <span class="hljs-type"><span class="hljs-type">OUT</span></span>... } word2vec(<span class="hljs-string"><span class="hljs-string">"train_data.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"model.bin"</span></span>, binary=<span class="hljs-number"><span class="hljs-number">1</span></span>, # output format, <span class="hljs-number"><span class="hljs-number">1</span></span>-binary, <span class="hljs-number"><span class="hljs-number">0</span></span>-txt cbow=<span class="hljs-number"><span class="hljs-number">0</span></span>, # skip-gram (<span class="hljs-number"><span class="hljs-number">0</span></span>) or continuous bag <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> words (<span class="hljs-number"><span class="hljs-number">1</span></span>) num_threads = <span class="hljs-number"><span class="hljs-number">1</span></span>, # num <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> workers num_features = <span class="hljs-number"><span class="hljs-number">300</span></span>, # word vector dimensionality window = <span class="hljs-number"><span class="hljs-number">10</span></span>, # context / window size min_count = <span class="hljs-number"><span class="hljs-number">40</span></span>, # minimum word count sample = <span class="hljs-number"><span class="hljs-number">1e-3</span></span> # downsampling <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> frequent words )</code> </pre><br>  A few words about the parameters: <br>  <b>binary</b> - model output format; <br>  <b>cbow</b> - which algorithm to use for teaching skip-gram or bag of words (cbow).  Skip-gram runs slower, but gives better results in rare words; <br>  <b>num_threads</b> - the number of processor threads involved in building the model; <br>  <b>num_features</b> - the dimension of the word space (or a vector for each word), recommended from tens to hundreds; <br>  <b>window</b> - how many words from the context the learning algorithm should take into account; <br>  <b>min_count</b> - limits the size of the dictionary for meaningful words.  Words that are not found in the text more than the specified number are ignored.  The recommended value is from ten to one hundred; <br>  <b>sample</b> - the lower limit of the frequency of occurrence of words in the text, it is recommended from .00001 to .01. <br><br>  Compiled with the following command with the keys recommended in the <a href="http://word2vec.googlecode.com/svn/trunk/makefile">makefile</a> : <br><pre> &gt; R --arch x64 CMD SHLIB -lm -pthread -O3 -march = native -Wall -funroll-loops -Wno-unused-result word2vec.c
</pre><br>  The compiler issued a number of warnings, but nothing serious, the cherished word2vec.dll appeared in the working directory.  Without problems, I loaded it into R with the dyn.load function (‚Äúword2vec.dll‚Äù) and started the function of the same name.  I think only the pthread key is useful.  You can do without the rest (some of them are registered in the Rtools configuration). <br><br>  Result: <br>  There were a total of 11.5 million words in my file, a dictionary - 19133 words, the model building time is 6 minutes on a computer with an Intel Core i7.  To check if my options work, I changed the value of num_threads from one to six.  It would be possible not to look at the monitoring of resources, the time to build the model was reduced to one and a half minutes.  That is, this thing can handle eleven million words in minutes. <br><br><h4>  Similarity score </h4><br>  In the distance, I practically did not change anything, just pulled out the parameter for the number of returned values.  Then I compiled the library, loaded it into R and checked it on two words ‚Äúbad‚Äù and ‚Äúgood‚Äù, considering that I am dealing with positive and negative reviews: <br><pre> Word: bad Position in vocabulary: 15
          Word CosDist
 1 terrible 0.5778409
 2 horrible 0.5541780
 3 lousy 0.5527389
 4 awful 0.5206609
 5 laughably 0.4910716
 6 atrocious 0.4841466
 7 horrid 0.4808238
 8 good 0.4805901
 9 worse 0.4726501
 10 horrendous 0.4579800

 Word: good Position in vocabulary: 6
         Word CosDist
 1 decent 0.5678578
 2 nice 0.5364762
 3 great 0.5197815
 4 bad 0.4805902
 5 excellent 0.4554003
 6 ok 0.4365533
 7 alright 0.4361723
 8 really 0.4153538
 9 liked 0.4061105
 10 fine 0.4004776
</pre><br>  Everything turned out again.  It is interesting that from bad to good the distance is more than from good to bad if you count in words.  Well, as they say "from love to hate ..." is closer than the other way around.  The algorithm calculates the similarity as the cosine of the angle between the vectors using the following formula (picture from the <a href="http://en.wikipedia.org/wiki/Cosine_similarity">wiki</a> ): <br><img src="https://habrastorage.org/files/971/a14/2d0/971a142d059d4cc5a3de0e9b3d283936.png"><br>  So, having a trained model, you can calculate the distance without C, and instead of a similarity, evaluate, for example, differences.  To do this, you need to build a model in text format (binary = 0), load it into R with read.table () and write some amount of code, which I did.  Code without exception handling: <br><pre> <code class="hljs matlab">similarity &lt;- <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(word1, word2, model)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ncol</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(model)</span></span></span><span class="hljs-function">-1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vec1</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[model$word==word1,2:size]</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vec2</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[model$word==word2,2:size]</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sim</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(vec1 * vec2)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sim</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sim</span></span></span><span class="hljs-function">/</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sqrt(sum(vec1^2)</span></span></span><span class="hljs-function">)*</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sqrt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sum(vec2^2)</span></span></span><span class="hljs-function">)) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sim)</span></span></span><span class="hljs-function"> } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">difference</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string, model)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">words</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tokenize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">num_words</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">length</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(words)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">diff_mx</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matrix</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rep(0,num_words^2)</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nrow</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">num_words</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ncol</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">num_words</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i in 1:num_words)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(j in 1:num_words)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sim</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">similarity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(words[i],words[j],model)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i!=j)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">diff_mx</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[i,j]</span></span></span><span class="hljs-function">=</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sim</span></span></span><span class="hljs-function"> } } } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(words[which.min(rowSums(diff_mx)</span></span></span><span class="hljs-function">)]) }</span></span></code> </pre><br>  Here is built a square matrix of the number of words in the query for the number of words.  Then for each pair of unmatched words, a similarity is calculated.  Then the values ‚Äã‚Äãare summarized in rows, the row with the minimum amount is found.  The line number corresponds to the ‚Äúextra‚Äù position in the query.  Work can be accelerated if you count only half the matrix.  A couple of examples: <br><pre> &gt; difference ("squirrel deer human dog cat", model)
 [1] "human"
 &gt; difference ("bad red good nice awful", model)
 [1] "red"
</pre><br><h4>  Analogies </h4><br>  Finding analogies allows you to solve puzzles such as "man refers to a woman as the king refers to?".  The special word-analogy function is only in the original Google code, so I had to tinker with it.  I wrote a wrapper to call a function from R, removed the infinite loop from the code, and replaced the standard I / O streams with parameter passing.  Then compiled into the library and did some experiments.  I didn‚Äôt manage a piece with the king-queen, apparently eleven million words are not enough (authors of word2vec recommend around a billion).  A few good examples: <br><pre> &gt; analogy ("model300.bin", "man woman king", 3)
       Word CosDist
 1 throne 0.4466286
 2 lear 0.4268206
 3 princess 0.4251665

 &gt; analogy ("model300.bin", "man woman husband", 3)
         Word CosDist
 1 wife 0.6323696
 2 unfaithful 0.5626401
 3 married 0.5268299

 &gt; analogy ("model300.bin", "man woman boy", 3)
      Word CosDist
 1 girl 0.6313665
 2 mother 0.4309490
 3 teenage 0.4272232
</pre><br><h4>  Clustering </h4><br>  After reading the documentation, I realized that it turns out that word2 clustering is embedded in word2vec.  And in order to use it, it is enough to ‚Äúpull out‚Äù another parameter in R - classes.  This number of clusters, if it is more than zero, word2vec will produce a text file format word - cluster number.  Three hundred clusters were not enough to get something sane.  Heuristics from developers: dictionary size divided by 5. Chose 3000 accordingly. Let me give you a few successful clusters (successful in the sense that I understand why these words are side by side): <br><pre>            word id
 335 humor 2952
 489 serious 2952
 872 clever 2952
 1035 humor 2952
 1796 references 2952
 1916 satire 2952
 2061 slapstick 2952
 2367 quirky 2952
 2810 crude 2952
 2953 irony 2952
 3125 outrageous 2952
 3296 farce 2952
 3594 broad 2952
 4870 silliness 2952
 4979 edgy 2952

         word id
 1025 cat 241
 3242 mouse 241
 11189 minnie 241

            word id
 1089 army 322
 1127 military 322
 1556 mission 322
 1558 soldier 322
 3254 navy 322
 3323 combat 322
 3902 command 322
 3975 unit 322
 4270 colonel 322
 4277 commander 322
 7821 platoon 322
 7853 marines 322
 8691 naval 322
 9762 pow 322
 10391 gi 322
 12452 corps 322
 15839 infantry 322
 16697 diver 322
</pre><br>  Using clustering, it is easy to do a sentiment analysis.  To do this, you need to build a "bag of clusters" - a matrix the size of the number of reviews for the maximum number of clusters.  In each cell of such a matrix there should be the number of hits of the words from the review in the given cluster.  I have not tried, but I don‚Äôt see any problems here.  <a href="https://www.kaggle.com/c/word2vec-nlp-tutorial/details/part-3-more-fun-with-word-vectors">It is said</a> that the accuracy for the IMDB review is the same or slightly less than if it is done through the ‚ÄúBag of Words‚Äù. <br><br><h4>  Phrases </h4><br>  Word2vec can work with phrases, or rather with stable combinations of words.  To do this, the original code has a word2phrase procedure.  Its task is to find frequently occurring combinations of words and replace the space between them with an underscore.  The file that is obtained after the first pass contains two words.  If you send it back to word2phrase, triples and fours will appear.  The result can then be used to train word2vec. <br>  Made a call to this procedure from R by analogy with word2vec: <br><pre> <code class="hljs lisp">word2phrase(<span class="hljs-string"><span class="hljs-string">"train_data.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"train_phrase.txt"</span></span>, min_count=5, threshold=100)</code> </pre><br>  The <b>min_count</b> parameter allows not to consider phrases occurring less than the specified value, the <b>threshold</b> controls the sensitivity of the algorithm, the larger the value, the fewer phrases will be found.  After the second pass, I got about six thousand combinations.  To look at the phrases themselves, I first made a model in text format, pulled out a column of words, and filtered it by the underscore.  Here is an example snippet: <br><pre> [5887] "works_perfectly" "four_year_old" "multi_million_dollar"               
 [5890] "fresh_faced" "return_living_dead" "seemed_forced"                      
 [5893] "freddie_prinze_jr" "re_lucky" "puerto_rico"                        
 [5896] "every_sentence" "living_hell" "went_straight"                      
 [5899] "supporting_cast_including" "action_set_pieces" "space_shuttle"     
</pre><br>  I selected several phrases for distance (): <br><pre> &gt; distance ("p_model300_2.bin", "crouching_tiger_hidden_dragon", 10)
 Word: crouching_tiger_hidden_dragon Position in vocabulary: 15492
                  Word CosDist
 1 tsui_hark 0.6041993
 2 ang_lee 0.5996884
 3 martial_arts_films 0.5541546
 4 kung_fu_hustle 0.5381692
 5 blockbusters 0.5305687
 6 kill_bill 0.5279162
 7 grindhouse 0.5242150
 8 churned 0.5224440
 9 budgets 0.5141657
 10 john_woo 0.5046486

 &gt; distance ("p_model300_2.bin", "academy_award_winning", 10)
 Word: academy_award_winning Position in vocabulary: 15780
                    Word CosDist
 1 nominations 0.4570983
 2 ever_produced 0.4558123
 3 francis_ford_coppola 0.4547777
 4 producer_director 0.4545878
 5 set_standard 0.4512480
 6 participation 0.4503479
 7 won_academy_award 0.4477891
 8 michael_mann 0.4464636
 9 huge_budget 0.4424854
 10 directorial_debut 0.4406852
</pre><br><br>  At this point, I have completed the experiments.  One important note is that word2vec ‚Äúcommunicates‚Äù with memory directly, as a result of which R may become unstable and crash the session.  Sometimes this is due to the output of diagnostic messages from the OS, which R cannot correctly process.  If there are no errors in the code, it helps to restart the interpreter or Rstudio. <br><br>  R-code, C source code and Windows dll compiled under x64 in my <a href="https://github.com/khmelkoff/Deepl">repository</a> . <br><br>  <b>UPD:</b> <br>  As a result of the dispute with <a href="https://habrahabr.ru/users/servponomarev/" class="user_link">ServPonomarev</a> and the subsequent analysis of the word2vec code, we managed to find out that the algorithm is trained in lines of 1000 words, in which the window moves in plus / minus 5 words.  When an EOL character is detected, which the algorithm converts to a special word with zero numbers in the dictionary, the window movement stops and continues in a new line.  The representation of words separated by EOL in the model will differ from the representation of the same words, separated by a space.  Conclusion: if the source text is a collection of documents, as well as phrases or paragraphs, separated by a newline, you should not get rid of this additional information, ie  leave EOL symbols in the training set.  Unfortunately, it is very difficult to illustrate with examples. </div><p>Source: <a href="https://habr.com/ru/post/258983/">https://habr.com/ru/post/258983/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258967/index.html">Sensors and microcontrollers. Part 1. The materiel</a></li>
<li><a href="../258973/index.html">Content Iconification</a></li>
<li><a href="../258977/index.html">Some interesting and useful things for web developer # 44</a></li>
<li><a href="../258979/index.html">Is Asynchronous PHP a Myth? Reality! Video with DevConf 2014</a></li>
<li><a href="../258981/index.html">Reliability Analysis in Wolfram SystemModeler 4.1</a></li>
<li><a href="../258985/index.html">Krita: levels of detail or how to paint with a 1k brush on a 10k pixel canvas</a></li>
<li><a href="../258987/index.html">Action instead of transition: the link is capable of more</a></li>
<li><a href="../258989/index.html">20 and other numbers</a></li>
<li><a href="../258991/index.html">Creating Dragon Age: Inquisition</a></li>
<li><a href="../258993/index.html">Oberon is dead, long live Oberon! Part 2. Modules</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>