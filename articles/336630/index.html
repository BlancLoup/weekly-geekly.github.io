<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linux graphical environment without a single break</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="TL; DR - If your Linux graphical environment while watching a video, playing a game or scrolling an interactive web page does not have time to update ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Linux graphical environment without a single break</h1><div class="post__text post__text-html js-mediator-article"><p>  TL; DR - If your Linux graphical environment while watching a video, playing a game or scrolling an interactive web page does not have time to update the entire picture in time, then it makes sense for you to install the latest stable kernel version ‚â• 4.10. </p><br><p>  A long time ago, that is, a few years ago, every implementation of the X11 protocol involved <a href="https://habrahabr.ru/post/321470/">changing the video mode</a> directly, across the kernel kernel.  Then KMS (kernel mode setting) appeared and this important function passed to the kernel.  But there were some rough edges.  Atomic mode change is a further improvement of the KMS mechanism. </p><br><p>  What are KMS atomic operations for?  Mainly in order to avoid such moments. </p><br><img src="https://habrastorage.org/web/52a/d25/77a/52ad2577a3334e2a9ca8aa5eae7805de.png"><br><p><br></p><a name="habracut"></a><br><h3 id="atomarnaya-smena-rezhima-video">  Atomic video mode change </h3><br><p>  DRM driver with support for atomic mode change, a ‚Ä§  k ‚Ä§  a ‚Ä§  <em>Atomic mode setting</em> has a useful feature, which is that video mode changes are fully tested before they take effect.  This is done in order to ensure their correct performance in the drivers and on the display in order to save users from flickering, tearing and other image artifacts.  The speed of execution also increases.  It sounds good, but how does it work? </p><br><ul><li>  <strong>Framebuffer</strong> - Video memory, but in KMS terminology it is rather a pool of video memory sources - GEM objects, for which such characteristics as the active memory zone, or what will be shown, as well as the data format, step length are specified. </li></ul><br><p>  <em>Framebuffer</em> </p><br><img src="https://habrastorage.org/web/726/4e7/a05/7264e7a058b448c4908914ef31699400.png"><br><p><br></p><br><pre><code class="hljs cpp">DRM/KMS Components: Framebuffer <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">drm_framebuffer</span></span></span><span class="hljs-class"> {</span></span> [...] <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pitches[<span class="hljs-number"><span class="hljs-number">4</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> offsets[<span class="hljs-number"><span class="hljs-number">4</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> width; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> height; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> flags; [...]</code> </pre> <br><ul><li>  <strong>CRTC</strong> - Abbreviation stands for Cathode Ray Tube Controller, CRT Controller.  Few people currently use monitors on cathode-ray tubes, but the historical name is preserved from the form of iron abstraction, which reads bytes from the video card's memory and sends pixels to the data bus. </li><li>  <strong>Encoder</strong> - Interface between disparate video sources, reads from <code>CRTC</code> and transmits to the connector, a  k ‚Ä§  a ‚Ä§  <code>Connector</code> .  A <code>CRTC</code> may have several encoders. </li><li>  <strong>Connector</strong> - This can be a view for the monitor connector or the monitor itself in the case of embedded devices with an external screen connected. </li><li>  <strong>Planes</strong> - Layer or image plan on <code>CRTC</code> . </li></ul><br><img src="https://habrastorage.org/web/7db/055/d22/7db055d2291b416a9ab23ffad6f90f29.png"><br><p><br></p><br><p>  To do this, you need to understand how the video mode changes <strong>without</strong> this innovation.  Consider the usual scenario in which the user is watching a video in a browser or player window, <em>not</em> full-screen, using hardware acceleration.  The video forms the foreground, window, and scenery of the browser or player; this is the second - the background. </p><br><ol><li>  A list of various parameters is transmitted to the video driver: frame buffer, CRTC, screens, mode. </li><li>  The user moves the player window. </li><li>  To do this, upload a new page, a ‚Ä§  k ‚Ä§  a ‚Ä§  <em>page flip</em> , for example. </li><li>  If the new page is not synchronized between the foreground and background, the video will shift relative to its window. </li></ol><br><pre> <code class="hljs rust"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">drm_mode_crtc_page_flip</span></span></span></span> { __<span class="hljs-built_in"><span class="hljs-built_in">u32</span></span> crtc_id; __<span class="hljs-built_in"><span class="hljs-built_in">u32</span></span> fb_id; __<span class="hljs-built_in"><span class="hljs-built_in">u32</span></span> flags; __<span class="hljs-built_in"><span class="hljs-built_in">u32</span></span> reserved; __<span class="hljs-built_in"><span class="hljs-built_in">u64</span></span> user_data; };</code> </pre> <br><p>  There is no mechanism to ensure synchronization in the penultimate step; <code>ioctl()</code> missing to do all the work.  For example, only the basic plan had a mechanism for non-blocking updates of critical events with precise completion.  And in order for the updates to occur in several layers, a lot of system calls from the user space were required <em>in the hope that they would end synchronously</em> .  At the same time, atomic KMS operations have built-in protection against this.  Instead of three different <code>ioctl()</code> , all changes take place in <strong>a single</strong> <code>ioctl()</code> . </p><br><p>  In fact, the problem of lack of synchronization between the active zone and the background while watching a video was solved by arranging everything with GL, since the latter can update frames synchronously with VBlank.  Everything would be fine, but <em>for mobile devices this is not acceptable</em> due to the high memory and power requirements of the GL linker. </p><br><p>  Work on the "atomic" project began in 2015 with <a href="https://www.mail-archive.com/linux-kernel%40vger.kernel.org/msg919869.html">patches of Dave Airlie (Dave Airlie)</a> , affecting Intel's <code>i915</code> and a few more drivers, plus a new atomic API. </p><br><p>  At the moment, the atomic update process is as follows. </p><br><ol><li>  All changes are transferred to the kernel with one <em>property</em> list (in the middle of the <code>Properties</code> image). </li><li>  The kernel generates <em>a device state</em> (on the right in the <code>State</code> picture). </li><li>  <code>atomic_check()</code> checks the validity of all items in the <em>property</em> list.  If there is an error, ioctl () will return an error notification and cancel the update. </li><li>  <code>atomic_commit()</code> also, in accordance with the name, introduces changes into action if <code>atomic_check()</code> completed in the previous step without errors. </li></ol><br><img src="https://habrastorage.org/web/202/492/ad0/202492ad0f6848369f54198fca3bd8b4.png"><br><p><br></p><br><p>  The structure of the atomic KMS is defined in the <code>/usr/include/uapi/drm/drm_mode.h</code> file. </p><br><pre> <code class="hljs rust">#define DRM_MODE_PAGE_FLIP_EVENT <span class="hljs-number"><span class="hljs-number">0x01</span></span> #define DRM_MODE_PAGE_FLIP_ASYNC <span class="hljs-number"><span class="hljs-number">0x02</span></span> #define DRM_MODE_ATOMIC_TEST_ONLY <span class="hljs-number"><span class="hljs-number">0x0100</span></span> #define DRM_MODE_ATOMIC_NONBLOCK <span class="hljs-number"><span class="hljs-number">0x0200</span></span> #define DRM_MODE_ATOMIC_ALLOW_MODESET <span class="hljs-number"><span class="hljs-number">0x0400</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">drm_mode_atomic</span></span></span></span> { __<span class="hljs-built_in"><span class="hljs-built_in">u32</span></span> flags; __<span class="hljs-built_in"><span class="hljs-built_in">u32</span></span> count_objs; __<span class="hljs-built_in"><span class="hljs-built_in">u64</span></span> objs_ptr; __<span class="hljs-built_in"><span class="hljs-built_in">u64</span></span> count_props_ptr; __<span class="hljs-built_in"><span class="hljs-built_in">u64</span></span> props_ptr; __<span class="hljs-built_in"><span class="hljs-built_in">u64</span></span> prop_values_ptr; __<span class="hljs-built_in"><span class="hljs-built_in">u64</span></span> reserved; __<span class="hljs-built_in"><span class="hljs-built_in">u64</span></span> user_data; };</code> </pre> <br><p>  For open source Nouveau drivers from Nvidea, atomic KMS is enabled by default starting with Linux 4.10, for Intel drivers starting from 4.12.  Further more! </p><br><h4 id="ispolzovannye-materialy">  Used materials </h4><br><ul><li>  <a href="https://lwn.net/Articles/653071/">Atomic mode setting design overview, part 1</a> </li><li>  <a href="https://lwn.net/Articles/653466/">Atomic mode setting design overview, part 2</a> </li><li>  <a href="http://events.linuxfoundation.org/sites/events/files/slides/20151005-elce.pdf">Anatomy of atomic KMS driver</a> </li><li>  <a href="https://www.youtube.com/watch%3Fv%3D5uHMpjz68HE">Anatomy of atomic KMS driver, YouTube</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/336630/">https://habr.com/ru/post/336630/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336614/index.html">How to stop DDoS-attack + WireX Botnet code analysis</a></li>
<li><a href="../336620/index.html">As a newcomer to Go, cont.</a></li>
<li><a href="../336622/index.html">Submit the cool project: utbone core library for unit testing</a></li>
<li><a href="../336624/index.html">Heading "We read articles for you." August 2017</a></li>
<li><a href="../336626/index.html">Interview with Sergey Vakula: ‚ÄúI don‚Äôt believe that blockchain and cryptocurrency will become massive‚Äù</a></li>
<li><a href="../336632/index.html">Developing games for the console at the Arduino summer camp</a></li>
<li><a href="../336634/index.html">When is the inevitable serverless future?</a></li>
<li><a href="../336636/index.html">How to prepare for the ISTQB exam? Testers of the Krasnodar studio Plarium share their experience</a></li>
<li><a href="../336638/index.html">Links around the blocks</a></li>
<li><a href="../336640/index.html">UPS on lithium-ion batteries: understand the pros and cons of the example of Schneider Electric products</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>