<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Backups of Hyper-V virtual machines and regular computers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share with you the experience that took me a lot of time - about backups of virtual machines and ordinary computers. How to make cheap and b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Backups of Hyper-V virtual machines and regular computers</h1><div class="post__text post__text-html js-mediator-article">  I want to share with you the experience that took me a lot of time - about backups of virtual machines and ordinary computers.  How to make cheap and beautiful. <br><br>  Perhaps I'll start with the fact that if you want backups on VMWare, then get ready to pay.  Free VMWare is free as long as it‚Äôs not about migrations, backups, and so on.  At this place you can start an endless holivar, but without my participation.  My narrations will be only about Hyper-V on Windows Server 2012R2.  Although part of the article can be applied to VMWare, there are likely to be pitfalls. <br><br>  We can back up to Hyper-V for free, or rather, with the Windows tools we already paid for by purchasing Windows Server licenses.  For the convenience of working with our backups (we also paid for it), we will use WDS and deduplication (maybe group policies). <br><a name="habracut"></a><br><h2>  1. Backup from inside virtual machines </h2><br><h3>  1.1.  Backup of today </h3><br>  As far as we know, any Windows can backup.  Moreover, any Windows backup settings through the interface are reduced, ultimately, to the background use of the wbadmin utility.  And what, in fact, can wbadmin?  And she knows how to do a backup image with the system partition, and backup individual folders.  In this part of the article, we are only interested in the backup image (of the system partition).  The rest is specific data of virtual machines and it is necessary to back up separately.  Hence the conclusion: Do not store any valuable information and databases, individual applications on the system partition of virtual machines (and on ordinary computers too).  MS SQL Server / MS Exchange / "Application Server 1C" and another set only on non-system partitions or on separate disks. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, what does it take for the backup to work?  And only one team is needed: <br><br><pre><code class="hljs sql">wbadmin.exe <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">backup</span></span> -backupTarget:\\\ -allCritical -quiet</code> </pre> <br>  Actually, for this command special rights are needed, but about them later.  Now it is important to understand one thing.  This command does not just backup.  It makes an incremental backup.  <s>Moreover, for server and desktop (client) Windows backups are formed different.</s>  <s>And the difference lies in the fact that for server OS we will get pictures of each backup, but for the desktop OS, only the last one will remain.</s>  <s>Ask, what is this incremental backup?</s>  <s>And ‚Äúincremental‚Äù it remains, because</s> we are not backing up the whole image, but only the changed part since the last backup (and therefore less traffic and a backup is created faster). <br><br>  Those who are faced with a similar situation will notice that the backup will always be "incremental" (full).  Since backup occurs in our case on a network drive.  <s>That is, for server-side Windows, the snapshots also remain the last</s> <br><br>  <u>Later, I discovered that there is no difference in the work of wbadmin on the server and client OS.</u>  <u>Is that the difference is in the interface.</u>  <u>wbadmin makes an incremental backup (except for the first backup) if the hard disk is specified in the -backupTarget key (the command uses the default -vssSopy key).</u>  <u>Or it makes a full backup if you add the -vssFull switch.</u> <br><br><h3>  1.2.  Backup with the history of previous shots </h3><br>  At the moment, we made a backup of images of virtual machines.  But this is a backup of only today's pictures.  Tomorrow it will be completely different ... But what will happen if you back up backups?  Yes, and still truly incremental.  So do. <br><br><pre> <code class="hljs sql">wbadmin.exe <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">backup</span></span> -backupTarget:e: -allCritical -<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>:d: -quiet <span class="hljs-comment"><span class="hljs-comment">#  D -   ,   E -   </span></span></code> </pre><br>  But this was not enough for me and I did this: <br><br><pre> <code class="hljs sql">( echo <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> vdisk <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>=<span class="hljs-string"><span class="hljs-string">"\\2\2\2.vhdx"</span></span> echo attach vdisk ) | diskpart</code> </pre><br>  The script connects the virtual disk from the network.  After backup, a similar script disables the disk.  The OS remembers that the drive has an E letter. But God forbid to slip someone else's drive with the same letter E, the backup will work out to the fullest (not incrementally and onto someone else's drive).  Keep this in mind and use the letter closer to the end of the alphabet (X, Y, Z) ... <br><br>  I note right away that if today's backup will be made in parallel with the backup with history, we will end up with a backup that cannot be raised. <br><br>  To get the backup of the previous days, you can use the interface (GUI) of the server on which backups with history are made.  Moreover, all the launches of the wbadmin command in the Windows console know and remember.  Recovery service will enable you to select the desired archive in backups with history. <br><br><h2>  2. Backup of vhdx files of virtual machines </h2><br>  It is made easily and naturally: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">wbadmin</span></span> start backup -backupTarget:<span class="hljs-variable"><span class="hljs-variable">$BackupPath</span></span> -hyperv:<span class="hljs-variable"><span class="hljs-variable">$VMList</span></span> -Quiet</code> </pre><br>  But with some features.  This command should be executed in PowerShell and with a preliminary receipt of the list of virtual machines into a variable.  For a detailed example, go to Google. <br><br>  Backup of virtual machines in Windows Server 2012 R2 is performed using Hyper-V snapshots.  Also note that there is a suspension of the work of virtual machines if there is a Linux kernel on them or there are no Hyper-V drivers.  I personally refused to back up virtual machines in this way.  The reason is that on Windows Server 2012 (not R2), it was necessary to stop the virtual machines before backup.  <s>And now, on Windows Server 2012 R2, the suspension of Linux does not suit me when there is a first good way to backup.</s>  (there is a remark in the comments to this article).  After the next update in Windows Server 2012 R2, backup of any virtual machines passes without interruption.  Linux can also be backed up from the inside using Dump (CentOS, Ubuntu), but this is a separate topic with puppet and other software in my case. <br><br><h2>  3. Restoring backup and WDS </h2><br>  And now, in my opinion, the most useful part of this article about backups. <br><br>  WDS is Windows Deployment Services (Windows Deployment Services) and part of the functionality of Windows Server 2012R2.  Previously, this service was called RIS, but I did not come across it.  In general, the essence of WDS is simple.  They were registered in DHCP (automatically for DHCP Windows Server) as separate parameters and then downloaded to the computer via the network (such as setting the computer's BIOS to boot via the network) via TFTP WDS loader.  Next, the WDS loader allows you to choose from the Windows ‚Äúboot loader‚Äù images available on it.  Boot loaders are different - this is the images of the installer loaders, and PE, and RE images.  The installer bootloader still needs the Windows images themselves in the WDS, but this is in case you need to install Windows over the network.  We are interested in RE images that allow you to pick up the car from the backup. <br><br>  How and what works in the WDS will not explain in detail.  But here are the important notes: <br><br><ol><li>  If your RE bootloader loads on a Hyper-V virtual machine over the network, but the keyboard does not work in it.  Congratulations, your RE image for WinXP or older and does not know about the existence of Hyper-V drivers. </li><li>  If your system starts restoring a backup, it stops.  Delete all partitions on the hard disk (on which the backup is restored) and try again.  Just do not forget that a backup can be broken and after deleting all partitions on hard you can have nothing left from the old information. </li><li>  If you backup UEFI, and you want to restore to a computer without UEFI, then you should not waste time.  Most likely to deploy the backup will not work. </li><li>  A backup with UEFI boot and GPT partitions can be restored to machines with a different processor / motherboard, but it is unlikely to be able to deploy with MBR format partitions and with loading a regular BIOS on another machine.  Well, I definitely did not succeed. </li><li>  If you try to deploy a backup to a disk with a smaller volume, then this will not work.  Even if the disk in the backup was almost empty.  In this case, recovery to a virtual machine with a dynamic disk helps.  Further reduction of this disk and creation of a new backup.  But this is possible only with the UEFI bootloader in the backup (why, read the previous paragraph). </li><li>  It is necessary to disable extra disks before restoring a backup in order not to overwrite the information on them. </li></ol><br><h2>  4. Features of deduplication </h2><br>  You can deduplicate running virtual machines.  You can deduplicate backups of today and you can deduplicate backups with history.  All this gives a big positive plus to the amount of hard drives (both for HDD and SSD).  But do not forget about some things: <br><br><ol><li>  If deduplication works with disks with a volume of more than 1 TB, then the deduplication optimizer will use a lot of memory. </li><li>  If deduplication works with compressed data, but with a compressed volume of more than 10 TB, the duration of the deduplication optimizer will be too long.  This can happen if you simply copy the data daily on a deduplitsirovanny disk in different folders. </li><li>  Backups on the HDD can be stored and even necessary, but working virtual machines should not be stored on the HDD in an amount greater than 5-10.  By deduplication this is the only way that the deduplication of such working virtual machines will reduce the HDD performance to zero. </li></ol><br><h2>  5. Group policies </h2><br>  Here you can implement the installation of the backup script using GPO for a long time and in different ways.  But I would like to draw attention to the important points: <br><br><ol><li>  Backup is carried out only on behalf of a separate user account. </li><li>  Do not store scripts with passwords in group policies. </li><li>  Run a script with special rights to read all the system information. </li></ol><br>  Well, in fact, the <b>conclusion</b> : Backup with the help of wbadmin tools is possible, fully implementable and most importantly viable.  But only if you have time and a lot of patience for all sorts of little things.  For example, the article does not say how to monitor successfully created backups.  I managed to do monitoring at Zabbix, but you can write a couple more articles about this ... I hope the article will be useful for you and save you a lot of precious time. </div><p>Source: <a href="https://habr.com/ru/post/267307/">https://habr.com/ru/post/267307/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../267293/index.html">Mikrotik RouterOS + PHP script on the site. Empowerment</a></li>
<li><a href="../267295/index.html">RC5 encryption algorithm and its implementation in python</a></li>
<li><a href="../267297/index.html">Free Firebird large database seminar</a></li>
<li><a href="../267301/index.html">Automate Java EE Testing Web Services with SoapUI and Arquillian</a></li>
<li><a href="../267305/index.html">Modifiers private and private [this] in Scala</a></li>
<li><a href="../267311/index.html">We carry the general functionality of applications and configurations of Gradle into separate modules</a></li>
<li><a href="../267315/index.html">Skype has collapsed and is not working around the world</a></li>
<li><a href="../267317/index.html">The evolution of network communication methods. Part II</a></li>
<li><a href="../267319/index.html">Skype came tight and paralyzed the activities of many companies.</a></li>
<li><a href="../267321/index.html">And again about 1C</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>