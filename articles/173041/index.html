<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sieve: server-side mail filtering</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After Google closed the Reader, I lost faith in a big company that makes me a tool for solving important tasks for me. I decided to build my own Luna ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sieve: server-side mail filtering</h1><div class="post__text post__text-html js-mediator-article">  After Google closed the Reader, I lost faith in a big company that makes me a tool for solving important tasks for me.  I decided to build my own Luna Park with readers, aggregators, bolters, etc.  Mail on your domain is the first thing that comes to mind.  It‚Äôs not a question to register the MX record, put Postfix on local delivery, install the Dovecot IMAP server and Roundcube webmail client, the question is to repeat the functionality of the ‚Äúbig‚Äù system, first of all, sorting.  I will not duplicate the existing instructions, I will describe only non-obvious points. <br><br>  What does not suit me in Gmail?  This is the ideology of labels, which can be attached to the same letter several, and in IMAP to display them in the form of folders.  As a result, the root folder is always full of letters, and I am such a person (perhaps my case is unique) that I delete all the ‚Äúextra‚Äù mail, and put all the ‚Äúnecessary‚Äù mail into folders.  I erase all notifications from web stores, forums, services, etc., that do not fit Google‚Äôs ideology ‚Äúwhy remove if the place is infinite?‚Äù.  Google wants to see as much as I can, but I do not want to see trash.  Further, I used iCloud / me.com, everything is simple there: the rules for sorting incoming mail just don't work and that's all. <br><a name="habracut"></a><br>  So, the task is: for Dovecot to arrange mail in IMAP folders.  Honestly, I spent about 20 minutes searching for ‚Äúwhere's the filtering settings for Roundcube?‚Äù, And then I started reading instructions.  Unfortunately, everything that can be found on the web does not contain a complete list of rakes that can be stepped on, I will try to describe them here without hesitation. <br><br>  First, you need to learn the word <a href="http://ru.wikipedia.org/wiki/Sieve">sieve</a> , this is a whole language for the description of filtering rules, created by Cyrusoft while working on the Cyrus mail server (it will not be remembered by the night).  It allows you to write such self-evident rules: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">require [<span class="hljs-string"><span class="hljs-string">"fileinto"</span></span>]; <span class="hljs-comment"><span class="hljs-comment"># rule:[LinkedIn] if header :contains "From" "linkedin.com" { fileinto "INBOX/LinkedIn"; stop; } # rule:[Drupal Alerts] if header :contains "Subject" "yet another home page" { fileinto "INBOX/Drupal Alerts"; stop; } if header :contains "From" [ "user@example.com" ] { addflag "\\flagged"; fileinto "Trash"; stop; } # rule:[Paypal] if allof (header :contains "From" "paypal") { fileinto "INBOX/Ebay, Paypal"; stop; }</span></span></code> </pre> <br><br>  Of course, I don‚Äôt really want to go to the console to write a new filtering rule, fortunately, there is a managesieve protocol that allows the email client to steer the rules on the server.  Fortunately, both Dovecot and Roundcub support both features.  And then, start the rake. <br><br>  First of all, the simplest and most natural thing that is done to enable seive is setting mail_plugins = sieve somewhere globally for the entire Dovecot.  It is not right!  It will be like this: <br><br><pre> <code class="bash hljs">Error: dlopen(/usr/lib64/dovecot/lib90_sieve_plugin.so) failed: /usr/lib64/dovecot/libdovecot-sieve.so.0: undefined symbol: mail_deliver_get_log_var_expand_table</code> </pre><br><br>  The variable should be set in /etc/dovecot/conf.d/15-lda.conf, for lda, local delivery.  The inclusion of managesieve in Dovecot and Roundcube does not cause problems (plug-ins are in the standard package), you just have to remember to register the port.  You can start writing rules, they will not work, because although the mail is expanded in the folder from the client, the ‚Äúlocal delivery agent‚Äù is still Postfix and INBOX not in / home / username, but in / var / mail / username.  You must add mailbox_command = / usr / lib / dovecot / deliver -d "$ USER" to main.cf.  Now it seems that everything is fine: almost all letters are arranged according to almost all the rules.  I spent the day trying to find out why the mail does not fall into the folder and took my colleagues out of myself with my experiments.  I thought that I incorrectly describe the properties of the header, since there the envelope and delivery data are different (because the communication takes place on the mailing list server, and everything should look like from the other person to the interlocutor).  Then I saw an error: <br><br><pre> <code class="bash hljs">Mar 16 17:53:01 DJBZ002 dovecot: lda(shaman007): Error: write() failed with mbox file /home/shaman007/mail/INBOX/LOR: File too large (process was started with <span class="hljs-built_in"><span class="hljs-built_in">ulimit</span></span> -f <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span>) Mar 16 17:53:01 DJBZ002 dovecot: lda(shaman007): Error: sieve: msgid=&lt;d068a42487535146ce3e7ec8b6557b27@andreybondarenko.com&gt;: failed to store into mailbox <span class="hljs-string"><span class="hljs-string">'INBOX/LOR'</span></span>: Internal error occurred. Refer to server <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> more information. [2013-03-16 17:52:57] Mar 16 17:53:01 DJBZ002 dovecot: lda(shaman007): sieve: msgid=&lt;d068a42487535146ce3e7ec8b6557b27@andreybondarenko.com&gt;: stored mail into mailbox <span class="hljs-string"><span class="hljs-string">'INBOX'</span></span> Mar 16 17:53:01 DJBZ002 dovecot: lda(shaman007): Error: sieve: execution of script /home/shaman007/.dovecot.sieve failed, but implicit keep was successful (user logfile /home/shaman007/.dovecot.sieve.log may reveal additional details) Mar 16 17:53:01 DJBZ002 postfix/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>[13359]: 4575811F76E: to=&lt;shaman007@andreybondarenko.com&gt;, orig_to=&lt;me@andreybondarenko.com&gt;, relay=<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>, delay=3.9, delays=0.21/0.02/0/3.7, dsn=2.0.0, status=sent (delivered to <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>: /usr/libexec/dovecot/dovecot-lda -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$SENDER</span></span></span><span class="hljs-string">"</span></span> -a <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$RECIPIENT</span></span></span><span class="hljs-string">"</span></span>) Mar 16 17:53:01 DJBZ002 postfix/qmgr[29435]: 4575811F76E: removed</code> </pre><br><br>  File too large!  As many as 100 megabytes!  It turned out that although it triggers a Dovecot error, the point is Postfix‚Äôs mailbox_size_limit parameter.  By default, there are 5 megabytes of something, you need to set it to 0. It seems this is all a rake. </div><p>Source: <a href="https://habr.com/ru/post/173041/">https://habr.com/ru/post/173041/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../173023/index.html">StateController. Event model in the development of interfaces. Part 1</a></li>
<li><a href="../173025/index.html">4D printing - new front</a></li>
<li><a href="../173029/index.html">Other side 22nm: unknown heroes of Silicon Valley</a></li>
<li><a href="../173031/index.html">Enhance SSH Access Security on Juniper SRX Routers</a></li>
<li><a href="../173037/index.html">Interesting possibilities of storage systems HP 3PAR. Part 3 - Peer Motion</a></li>
<li><a href="../173045/index.html">So what is this ‚Äúterrible‚Äù point at the end of the domain name?</a></li>
<li><a href="../173049/index.html">Data preprocessing and model analysis</a></li>
<li><a href="../173059/index.html">Oracle ADF. Business Components</a></li>
<li><a href="../173063/index.html">Moving and renaming files in GitHub</a></li>
<li><a href="../173065/index.html">The digest of news from the world of mobile development for the last week ‚Ññ6 (March 11 - 17, 2013)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>