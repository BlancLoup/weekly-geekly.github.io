<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>[C # /. NET] Generate machine code using LLVM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this topic, I will show how to generate and execute machine code using the Low Level Virtual Machine without much difficulty using the example of a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>[C # /. NET] Generate machine code using LLVM</h1><div class="post__text post__text-html js-mediator-article">  In this topic, I will show how to generate and execute machine code using the <a href="http://llvm.org/">Low Level Virtual Machine</a> without much difficulty using the example of a function that calculates the answer to the main question of life, the universe and all that. <br><br><h4>  And for the work we need </h4><a name="habracut"></a>  Precompiled versions of LLVM as a Windows DLL.  <a href="http://codeblock.codeplex.com/releases/view/49752">CodePlex</a> <br>  They need to be copied to the appropriate system folders or to the folders where the executable file of your test project will be located. <br><br>  Binding code written in C #. <br>  Mercurial: <a href="https://hg01.codeplex.com/codeblock">https://hg01.codeplex.com/codeblock</a> <br>  <a href="http://codeblock.codeplex.com/SourceControl/list/changesets">Source Codeplex Code</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Actually from the source code, you only need the LLVM project, which, respectively, lies in the LLVM folder.  Please note that the project was created in Visual Studio 2010 and is aimed at .NET 4.0, but from the same .cs files you can also assemble a binding for the old version of .NET. <br><br><h4>  Getting Started </h4><br>  Create a new C # console project, add the LLVM project to the solution.  From your project, make a link to LLVM. <br><br>  Add a link to the corresponding namespace in the Program.cs header (this is the default name for the source file): <br><blockquote><code><font color="black"><font color="#0000ff">using</font> LLVM; <br> <font color="#0000ff">using</font> Type = LLVM.Type;</font></code> </blockquote> <br>  Now you can start working with LLVM. <br><br><h4>  Initializing the target platform and creating common elements </h4><br>  Declare static context variables of type Context, module of type Module and engine of type ExecutionEngine. <br><blockquote> <code><font color="black"><font color="#0000ff">static</font> Context context; <br> <font color="#0000ff">static</font> Module module; <br> <font color="#0000ff">static</font> ExecutionEngine engine;</font></code> </blockquote> <br>  What the context is for at this stage is not important, so we simply use the global context LLVM. <br>  A module in LLVM is a kind of library equivalent.  It may contain descriptions of the function and static variables.  In this case, the definitions of functions are not required to lie in the same module, i.e.  It may have unresolved links. <br>  Execution engine - is responsible for the execution of the generated code directly during the execution of the program.  It can be an interpreter or a compiler. <br><br>  Next is the initialization of the necessary structures for the system in which the LLVM is running, as well as the actual initialization of the specified objects: <br><blockquote> <code><font color="black"><font color="#2B91AF">Console</font> .Write( <font color="#A31515">"initializing native target..."</font> ); <br> Target.InitializeNative(); <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"OK"</font> ); <br> <br> <font color="#2B91AF">Console</font> .Write( <font color="#A31515">"reading global context..."</font> ); <br> context = Context.Global; <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"OK"</font> ); <br> <br> <font color="#2B91AF">Console</font> .Write( <font color="#A31515">"creating module..."</font> ); <br> module = <font color="#0000ff">new</font> Module( <font color="#A31515">"test"</font> , context); <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"OK"</font> ); <br> <br> <font color="#2B91AF">Console</font> .Write( <font color="#A31515">"creating execution engine..."</font> ); <br> engine = <font color="#0000ff">new</font> ExecutionEngine(module); <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"OK"</font> );</font></code> </blockquote> <br><h4>  Return 42 </h4><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">delegate</font> <font color="#0000ff">int</font> IntFunc(); <br> <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">void</font> Function42() <br> { <br> <font color="#2B91AF">Console</font> .Write( <font color="#A31515">"creating ret42..."</font> ); <br> <font color="#008000">//       ret42  int(void)</font> <br> <font color="#0000ff">var</font> rettype = IntegerType.GetInt32(context); <br> <font color="#0000ff">var</font> intfunc = <font color="#0000ff">new</font> FunctionType(rettype); <br> <font color="#0000ff">var</font> ret42 = module.CreateFunction( <font color="#A31515">"ret42"</font> , intfunc); <br> <font color="#008000">//       .NET,   stdcall</font> <br> ret42.CallingConvention = CallingConvention.StdCallX86; <br> <br> <font color="#008000">//    .           </font> <br> <font color="#008000">//        </font> <br> <font color="#0000ff">var</font> block = <font color="#0000ff">new</font> Block( <font color="#A31515">"ret42root"</font> , context, ret42); <br> <font color="#008000">//  - 42</font> <br> <font color="#0000ff">var</font> c42 = rettype.Constant(42, <font color="#0000ff">true</font> ); <br> <font color="#008000">//       </font> <br> <font color="#008000">//          </font> <br> <font color="#0000ff">var</font> instructions = <font color="#0000ff">new</font> InstructionBuilder(context, block); <br> <font color="#008000">//  ,   </font> <br> instructions.Return(c42); <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"OK"</font> ); <br> <br> <font color="#2B91AF">Console</font> .Write( <font color="#A31515">"compiling ret42..."</font> ); <br> <font color="#008000">//   -  ,       </font> <br> <font color="#008000">//   ,  LLVM         </font> <br> <font color="#008000">//      ,  - - </font> <br> <font color="#008000">//  -  (  { i32 i32 }    32- int)</font> <br> <font color="#0000ff">var</font> wrapper = engine.CreateWrapper(ret42, context, module); <br> <font color="#008000">//  .NET-   .    LLVM      </font> <br> <font color="#0000ff">var</font> fun = engine.GetDelegate&lt;IntFunc&gt;(wrapper); <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"OK"</font> ); <br> <br> <font color="#2B91AF">Console</font> .Write( <font color="#A31515">"executing..."</font> ); <br> <font color="#2B91AF">Console</font> .WriteLine(func()); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br></div><p>Source: <a href="https://habr.com/ru/post/92070/">https://habr.com/ru/post/92070/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../92063/index.html">The first YouTube video turned 5 years old</a></li>
<li><a href="../92064/index.html">Fractals and GUI</a></li>
<li><a href="../92065/index.html">DEVCONF 2010 - May 17th the program is published - authors PHP, MySQL, Perl, Ruby, Sphinx come</a></li>
<li><a href="../92066/index.html">What are the controllers in PR2?</a></li>
<li><a href="../92068/index.html">uHHHuu.ru - an attempt to make life easier for a motorist in a big city</a></li>
<li><a href="../92072/index.html">Annoying "Apple" - or how I got the job</a></li>
<li><a href="../92074/index.html">RapidShare begins to take domains from satellite sites</a></li>
<li><a href="../92076/index.html">CloudMade Navigation supports maneuver restrictions</a></li>
<li><a href="../92078/index.html">Features of e-commerce in China</a></li>
<li><a href="../92079/index.html">The Truth About Numonyx PCM: A Revolution That Hasn't Happened</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>