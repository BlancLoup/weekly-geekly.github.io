<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The policy of backward compatibility in the development framework for the example of Magento 2. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="* A broken crane in the Magento office and a quick solution implemented by one of the engineers is a typical Backward Compatible fix. 


 Why backward...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The policy of backward compatibility in the development framework for the example of Magento 2. Part 1</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/fe3/80a/388/fe380a3885271f9f516e8e4e62599565.png" alt="image"><br>  <i>* A broken crane in the Magento office and a quick solution implemented by one of the engineers is a typical Backward Compatible fix.</i> <br><a name="habracut"></a><br><br><h3>  Why backward compatibility is important </h3><br><br>  When developing a framework, after the release of several versions of it, you encounter the fact that the user (or in the case of Magento, the customer) who bought / downloaded / installed it, as well as the programmer, who develops his own extensions and modules based on the framework, want to upgrade between versions was as easy as possible. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For the customer / user, the process must be cost effective.  The costs spent on moving to a new version of the product, which include: the upgrade itself, automated testing after the upgrade, regression testing, fixing the bugs introduced by the new version of the platform, updating customizations and third-party modules;  should be minimal. <br><br>  A programmer developing his extension for the platform wants his module to be <a href="https://en.wikipedia.org/wiki/Forward_compatibility">forward-compatible</a> as long as possible, and so that he knows in advance in which release the code of his module will be broken by changes in the system so that he can prepare in advance a version of his module compatible with the new release. <br><br>  As a result, the framework developer comes to an unexpected dilemma: the more changes you need to make (including bug fixes), the more likely that incompatible changes will be made that will break someone. <br><br><h3>  Code Backward Compatibility Policy </h3><br><br><img src="https://habrastorage.org/files/3f7/a54/5aa/3f7a545aa93140099abaa57d4b0c2e75.jpg" alt="image"><br><br>  <a href="http://semver.org/lang/ru/">Semantic versioning</a> (SemVer) provides an answer to the dilemma, helping not to refuse any of the options (frequent backward compatible releases). <br><br>  The version numbers of the framework components are specified as MAJOR.MINOR.PATCH, where the update is: <br><ul><li>  <b>MAJOR</b> - talks about incompatible API changes. </li><li>  <b>MINOR</b> - says that backward compatible functionality has been added </li><li>  <b>PATCH</b> - talks about backward fix bug </li></ul><br>  The backward compatibility policy applies to entities that are annotated with <a href="https://phpdoc.org/docs/latest/references/phpdoc/tags/api.html">@api</a> in the code base. <br><br><h3>  The concept of public and private code </h3><br><br>  Developers with experience working with C ++ or Java are familiar with this concept.  When the output of the program is delivered as a .h (header) file containing descriptions of external contracts, the semantics of the methods are easy to read by any text editor and the DLL file containing the compiled and compiled code that is hard to read and cannot be changed. <br><br>  PHP at the language level does not provide this feature.  Therefore, the frameworks written in this language have been looking for the ‚Äúright‚Äù approach for a long time.  For example, Magento 1, like many other frameworks of that time (Symfony 1) used the Inheritance Based API, when the framework for customizing and expanding its components offered to inherit from any of its classes, and redefine or extend behavior in the class of the heir.  Accordingly, in Magento 1, private properties and methods were not used at all, and Magento core developers were obliged to follow two contracts (Public is a contract that forms public properties, methods and constants of entities; Protected is a contract of entity inheritance) and prevent the addition of backward incompatible changes to both .  When all entities and all methods of these entities in the code base are API, then adding new changes and fixing bugs in any case can break someone. <br><br>  In this regard, Magento 2 decided to follow a different approach - the Inheritance Based API was banned for internal use, and do not recommend using this approach to customize the framework classes or modules by third-party developers.  Prohibited the use of Protected access modifier for attributes and methods of classes.  The main idea in these changes is that having only Public and Private - we need to monitor only one contract - public.  We have no contract inheritance. <br><br>  The next step was to divide the code into <b>Public</b> (analog header files) - code and annotation <code>@api</code> and <b>Private</b> (analog compiled DLL) - code that is not annotated, saying that this is an API. <br>  Closed code is not intended to be used by third-party developers.  Thus, its changes will only increase the component's PATCH version, where this code has been changed. <br><br>  Changes in Public Code always increase the MINOR or MAJOR version of the component. <br><br>  We promise to be backward compatible for classes marked with <code>@api</code> inside the MINOR and PATCH component releases.  In the case when we need to make changes to the class / method marked as <code>@api</code> , we mark it as @deprecated and it will be removed not earlier than the next MAJOR release of the component. <br><br>  Examples of what falls under the definition of the Public Code in Magento 2 <br><br><ul><li>  PHP interfaces marked with <code>@api</code> </li><li>  PHP classes tagged with <code>@api</code> </li><li>  JavaScript interfaces marked <code>@api</code> </li><li>  JavaScript classes tagged with <code>@api</code> </li><li>  Virtual Type marked <code>@api</code> </li><li>  Paths url </li><li>  Console commands and their arguments </li><li>  Less Variables &amp; Mixins </li><li>  AMQP message queue topics and their data types </li><li>  Declaration of UI components </li><li>  Layout declaration of modules </li><li>  Events triggered by modules </li><li>  Module configuration schema added </li><li>  System Configuration Structure </li></ul><br><br><h3>  API vs SPI (Extension Points) </h3><br><br>  PHP contracts in Magento can be used in different ways.  There are 3 ways to use them: <br><br><ul><li>  <b>API usage</b> : interface methods are called in PHP code </li><li>  <b>Service Provider Interface (SPI) usage</b> : the interface can be implemented, allowing the new implementation to extend the current behavior of the platform </li><li>  <b>API and SPI at the same time</b> </li></ul><br>  We expect that all calls to the module will pass through the API (service module contracts), modules also provide interfaces, implementing which external developers and customizers can provide an alternative implementation or extend the implementation out of the box.  For example, for the Search functionality, there is an agnostic <a href="https://github.com/magento/magento2/blob/develop/lib/internal/Magento/Framework/Api/Search/SearchInterface.php">contract</a> for an adapter that executes a query.  And it is assumed that this contract will be used as an API (just called in the business logic code).  While a set of interfaces is provided, for implementing search adapters, by providing their own implementation, a third-party developer can add support for a new search engine, for example Sphinx.  And this <b>should not break the</b> business logic that uses the Search API. <br><br>  API and SPI are not mutually exclusive, so we do not separate them separately in the code.  SPI have the same annotation as the API - <code>@api</code> . <br><br><h4>  <i>But who then determines what API is and what SPI is?</i>  - Those who use them, i.e.  external developers </h4><br><br><h3>  Rules for specifying dependencies </h3><br><br>  First of all, why modules should depend on each other in different ways depending on how they use another module. <br>  Imagine that you have a <a href="https://github.com/magento/magento2/blob/develop/app/code/Magento/Catalog/Api/CategoryRepositoryInterface.php">product category repository</a> interface <a href="https://github.com/magento/magento2/blob/develop/app/code/Magento/Catalog/Api/CategoryRepositoryInterface.php">.</a> <br>  with methods: <br><ul><li>  get </li><li>  save </li><li>  delete </li></ul>  The interface has already been published in the previous release of the system and it is used. <br>  At some point, you realize that you forgot to add a getList method to this interface to search for categories by the specified search criteria.  If you add this method to the current interface (and the implementation to the class that implements it), does it break the code that uses it? <br>  If the code uses the interface as an API, i.e.  just calls get / save / delete methods in business logic - the emergence of a new method will not bring problems.  Existing code will continue to work.  If the module code provides an alternative implementation for this interface (SPI), then we get an error during the build process, since the implementation interface class does not provide an implementation for one of its methods. <br><br>  So we had a separate <a href="https://github.com/magento/magento2/blob/develop/app/code/Magento/Catalog/Api/CategoryListInterface.php">service to search for categories</a> . <br><br>  In the case of removing a method from an interface, the opposite is true; for SPI, using it is not breaking changes; for an API, this is a problem. <br><img src="https://habrastorage.org/getpro/habr/post_images/b42/361/f9f/b42361f9fcecf74f0f3a8ffb78c5c8bc.png" alt="image"><br><br><h4>  API </h4><br>  If a module uses (calls) contracts declared by another Magento module, it must depend on the MAJOR version of this module.  And the system provides backward compatibility for the entire major release. <br><br><pre> <code class="javascript hljs">{ ... <span class="hljs-string"><span class="hljs-string">"require"</span></span>: { <span class="hljs-string"><span class="hljs-string">"magento/module-customer"</span></span>: <span class="hljs-string"><span class="hljs-string">"~100.0"</span></span>, <span class="hljs-comment"><span class="hljs-comment">// (&gt;=100.0 &lt;101.0.0) }, ... }</span></span></code> </pre><br><br><h3>  SPI (Extension Points) </h3><br>  If a module offers its implementation for contracts declared by another Magento module, it should depend on the MAJOR + MINOR version of this module.  And the system provides backward compatibility in a minor release. <br><br><pre> <code class="javascript hljs">{ ... <span class="hljs-string"><span class="hljs-string">"require"</span></span>: { <span class="hljs-string"><span class="hljs-string">"magento/module-customer"</span></span>: <span class="hljs-string"><span class="hljs-string">"~100.0.0"</span></span>, <span class="hljs-comment"><span class="hljs-comment">// (&gt;=100.0.0 &lt;100.1.0) }, ... }</span></span></code> </pre><br><br><h4>  Dependency on private code </h4><br><br>  If the module depends on an entity that is not marked as <code>@api</code> , then the module should depend on the MAJOR + MINOR + PATCH version.  And already an upgrade to the next patch release can turn into problems for this module. <br><br><pre> <code class="javascript hljs">{ ... <span class="hljs-string"><span class="hljs-string">"require"</span></span>: { <span class="hljs-string"><span class="hljs-string">"magento/module-customer"</span></span>: <span class="hljs-string"><span class="hljs-string">"100.0.0"</span></span>, <span class="hljs-comment"><span class="hljs-comment">// (==100.0.0 &lt;100.0.1) }, ... }</span></span></code> </pre><br><br><h3>  The nearest major commercial release 2.2 - What to expect? </h3><br><br>  In current versions of Magento 2.0.x and 2.1.x, you cannot do without dependencies on the private code. <br>  Because we have insufficient <code>@api</code> coverage for this.  Some modules do not have service contracts at all (for example, wishlist).  Therefore, third-party developers have no other choice except as a dependency on unlabeled api annotation classes. <br><br>  API development is the most complex process in software design and development.  And since we do not yet know exactly when the work on adding service contracts to all Magento modules will end, we decided in release 2.2 to mark <code>@api</code> all entities that are necessary for writing / customizing modules for magento by third-party programmers. <br>  Those.  in 2.2 we note all ‚Äú <i>fair contracts</i> ‚Äù, i.e.  if the functionality that the module provides is implemented by a helper or a resource model.  And it is impossible to get this functionality by calling the API module, then we mark this helper as <code>@api</code> . <br>  For example, we have a ProductInterface that defines a set of operations on the product entity.  And there is a product model that implements this interface.  Since now the product model is inherited from an abstract model and accordingly has an abstract model contract, we cannot say now that a third-party developer can only rely on ProductInterface, and if someone provides their own implementation of this interface, they can easily change the internal implementation of Magento (if it is not a heir to the product model).  Those.  Quite a lot of code in Magento uses the get / setData method that came from an abstract model.  Therefore, in 2.2 we will mark the product model as <code>@api</code> , despite the fact that we already have an API in the form of ProductInterface. <br><br>  <i>Before release 2.2.</i>  <i>we consider all code as public, i.e.</i>  <i>all classes are subject to backward compatibility policy.</i>  <i>Not just for classes labeled <code>@api</code> .</i>  <i>The division of the concept into public and private will begin with the 2.2 release.</i> <br><br><h4>  Now, how do we determine what is used and what is not. </h4><br>  We analyze what dependencies between modules Magento uses internally.  We also analyze which dependencies are used by extensions on the Marketplace (non api dependency).  And if the dependencies are valid, i.e.  this result cannot be obtained using the current API of the module - we mark the entity as <code>@api</code> <br><br>  <i>* This article is part 1;</i>  <i>Part 2, which will be released soon, will describe the limitations in the code that are introduced by the backward compatibility policy and what we are doing to stop refactoring from following BC policy and not accumulating technical debt due to these restrictions</i> </div><p>Source: <a href="https://habr.com/ru/post/324450/">https://habr.com/ru/post/324450/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324440/index.html">Tales of the project manager</a></li>
<li><a href="../324442/index.html">How clouds change the colocation market in data centers</a></li>
<li><a href="../324444/index.html">We are inventing a name for the new hypervisor for MIPS architecture with hardware-supported virtualization</a></li>
<li><a href="../324446/index.html">Vkontakte made another breakthrough. For a short time, all users of the social network received moderator rights.</a></li>
<li><a href="../324448/index.html">Release Rust 1.16</a></li>
<li><a href="../324454/index.html">Factors Affecting Failures and Conversions According to Artificial Intelligence</a></li>
<li><a href="../324456/index.html">Cryptocurrency Ethereum: write an exploit under a vulnerable smart contract and get tokens</a></li>
<li><a href="../324458/index.html">Differences, advantages, disadvantages: public and private blockchains</a></li>
<li><a href="../324460/index.html">Intel launches first SSD with 3D Xpoint technology</a></li>
<li><a href="../324462/index.html">He tested the most famous methods of personal effectiveness and wrote one of the best books on productivity.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>