<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Korutin to Kotlin (guide)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Simon Wirtz in his blog publishes a lot of interesting posts about Kotlin. 
 I present to you the translation of one of them. 
 Introduction and Motiv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Korutin to Kotlin (guide)</h1><div class="post__text post__text-html js-mediator-article"><p> <a href="https://habrahabr.ru/company/alfa/blog/336228/"><img src="https://habrastorage.org/web/f0c/0fe/425/f0c0fe42537a4190ab20e148cc34ed8c.png"></a> </p><br><blockquote>  Simon Wirtz in his <a href="https://blog.simon-wirtz.de/about-me/">blog</a> publishes a lot of interesting posts about Kotlin. <br>  I present to you the translation of one of them. </blockquote><a name="habracut"></a><br><h1 id="vvedenie-i-motivaciya">  Introduction and Motivation </h1><br><p>  As I mentioned on <a href="https://twitter.com/s1m0nw1/status/879747752183422977">Twitter a</a> few days ago, I planned to take a closer look at the Kortlin Korutin, which I did.  But unfortunately, it took longer than I expected.  For the most part, this is due to the fact that corintins are a very voluminous topic, especially if you are not familiar with their concept.  Anyway, I want to share my view with you and I hope to give you a comprehensive review. </p><br><p>  Korutin is undoubtedly one of the ‚Äúbig features,‚Äù as stated in the <em>JetBrains</em> <a href="https://blog.jetbrains.com/kotlin/2016/07/first-glimpse-of-kotlin-1-1-coroutines-type-aliases-and-more/">blog</a> : </p><br><blockquote> We all know that it is bad to block under load, that <em>GO</em> is set as an example almost everywhere, and that the world is becoming increasingly asynchronous and based on the processing of notifications.  Many languages ‚Äã‚Äã(starting with <em>C #</em> in 2012) support out-of-the-box asynchronous programming using constructs such as <code>async/await</code> .  In <em>Kotlin,</em> we proceeded from the fact that such constructions can be declared in the library, and async will not be a keyword, but a simple function.  This design allows you to implement a different asynchronous API: <code>future/promises</code> , <code>callback-passing</code> , etc.  It also has everything you need to implement lazy generators ( <code>yield</code> ) and some other functionalities. </blockquote><p>  In other words, cortinos were introduced for the simple implementation of multi-threaded programming.  Surely many of you have worked with <em>Java</em> , its Thread-class and classes for multi-threaded programming.  I myself have worked a lot with them and am convinced of the maturity of their decisions. </p><br><h1 id="mnogopotochnost-java-vs-kotlin-korutiny">  Multithreading <em>Java v Kotlin</em> Korutiny </h1><br><p>  If you are still experiencing difficulty with threads and multithreading in <em>Java</em> , then I recommend the book <a href="https://www.amazon.de/gp/product/B004V9OA84/ref%3Das_li_tl%3Fie%3DUTF8%26camp%3D1638%26creative%3D6742%26creativeASIN%3DB004V9OA84%26linkCode%3Das2%26tag%3Dsimonwirtzde-21%26linkId%3D24205a95b8920c44a408aa2d8ada0587">Java Concurrency in Practice</a> . </p><br><p>  Of course, the implementation of <em>Java</em> , from an engineering point of view, is well designed, but it is difficult to use in everyday work and it is quite verbose.  In addition, there <em>are</em> not so many implementations for non-blocking programming in <em>Java</em> .  You can often catch yourself by starting a stream, you completely forget that you quickly find yourself in a blocking code (on locks, expectations, etc.). An alternative <a href="http://tutorials.jenkov.com/java-concurrency/non-blocking-algorithms.html">non-blocking approach is</a> difficult to use in everyday work, and it is easy to make mistakes in it. </p><br><p>  Qorutinas, on the other hand, look like simple sequential code, hiding all the complexity inside libraries.  At the same time, they provide the ability to run asynchronous code without any locks, which opens up great opportunities for various applications.  Instead of blocking threads, calculations become interrupted.  <em>JetBrains</em> describe cortinos as ‚Äúlightweight threads,‚Äù of course, not the <em>Threads</em> that we know in <em>Java</em> .  Korutin are very cheap to create, and the overhead in comparison with the threads do not go to any comparison.  As you will see later, cortinas are launched in <em>Threads</em> under library management.  Another significant difference is limitations.  The number of threads is limited, since they actually correspond to native threads.  Creating korutiny, on the other hand, is practically free, and even thousands of them can be easily launched. </p><br><h1 id="stili-mnogopotochnogo-programmirovaniya">  Multithreaded programming styles </h1><br><p>  There are many different approaches to multithreaded programming in various languages: based on <code>callback</code> (JavaScript), <code>future/promise</code> (Java, JavaScript), <code>async/await</code> approach ( #), etc.  All of them can be implemented with the help of Corutin due to the fact that they do not impose a programming style.  On the contrary, any style is either already implemented or can be implemented with their help. </p><br><p>  As one of the advantages, compared to the <code>callback</code> based approach, corutines allow you to implement asynchronous code that will look like a serial one.  And even though coroutines can run in multiple threads, your code will still look consistent and therefore easy to understand. </p><br><h1 id="koncepciya-korutin">  Concept korutin </h1><br><p>  This is not to say that the concept of ‚Äúcoroutine‚Äù is new.  According to an article from <em>Wikipedia</em> , the name itself was already known in 1958.  Many modern programming languages ‚Äã‚Äãprovide native support: <em>C #</em> , <em>Go</em> , <em>Python</em> , <em>Ruby</em> , etc.  The implementation of Korutin, including in <em>Kotlin</em> , is often based on the so-called ‚Äú <a href="https://en.wikipedia.org/wiki/Continuation">Continuations</a> ‚Äù, which are an abstract representation of a controlled state in computer programs.  We will return to <a href="https://blog.simon-wirtz.de/kotlin-coroutines-guide/">how they work (implementation of korutin)</a> . </p><br><h1 id="nachalo-osnovy">  Start.  The basics </h1><br><p>  There is an exhaustive material available on the site <a href="https://kotlinlang.org/docs/tutorials/coroutines-basic-jvm.html">kotlinlang.org</a> , which is well described how to set up a project to work with coroutines.  Look in more detail at the material from the previous link, or simply take as a basis the code from my repository on <a href="https://github.com/s1monw1/Kotlin_Examples">GitHub</a> . </p><br><h1 id="ingredienty-korutin">  Ingredients Korutin </h1><br><p>  As already mentioned, the library with corortes provides a clear high-level <em>API</em> that allows us to quickly get started.  The only modifier you need to learn is to suspend.  It is used as an additional modifier in methods to mark them as interruptible. </p><br><p>  A little later, we will look at a few simple examples from the <em>API</em> , but for now, to begin with, let's take a closer look at what the function <code>suspend</code> . </p><br><h1 id="preryvaemye-funkcii">  Interrupted functions </h1><br><p>  Korutiny based on the keyword <code>suspend</code> , which is used to show that the function can be interrupted.  In other words, the call to such a function can be interrupted at any time.  Such functions can only be called from Corutin, which, in turn, requires at least one running function. </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre> <br><p>  As can be seen from the example above, the function with interruption looks like a normal function with an additional modifier.  Keep in mind that such functions can only be called from Corutin, otherwise it will lead to compilation errors. </p><br><p>  The quotes can be either a sequence of normal functions or functions with an interrupt with an optional result that will be available after execution. </p><br><h1 id="pereydem-k-primeram">  Let's go over to examples. </h1><br><p>  After all the blah blah blah let's go over to specific examples.  Let's start with the basics: </p><br><pre> <code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(args: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Array</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span> = runBlocking { <span class="hljs-comment"><span class="hljs-comment">//(1) val job = launch(CommonPool) { //(2) val result = suspendingFunction() //(3) println("$result") } println("The result: ") job.join() //(4) } &gt;&gt; prints "The result: 5"</span></span></code> </pre> <br><p>  In this example, two functions, (1) <code>runBlocking</code> and (2) <code>launch</code> , are examples of the use of Coruntine builders.  There are a large number of different builders, each of which creates a corutin for different purposes: <code>launch</code> (create and forget), <code>async</code> (return <code>promise</code> ), <code>runBlocking</code> (block the stream), and so on. </p><br><p>  The internal cortina created with (2) <code>launch</code> does all the work.  The call of the interrupted function (3) can be interrupted at any time, the result will be output after the calculation.  In the main thread after the start of the corutin, the <code>String</code> value will be displayed before the corutin is completed.  Korutina, launched via <code>launch</code> , returns immediately a <code>Job</code> , which can be used to cancel execution or to wait for calculations using (4) <code>join()</code> .  And since the call to <code>join()</code> can be interrupted, we need to wrap it in another corute, which is often used in <code>runBlocking</code> .  This builder (1) was specially created to provide the ability for code written in the style of interrupts to be called in the usual blocking form ‚Äù(Note from the <a href="">API</a> ).  If, however, remove <code>join</code> (4), the program will end before the quorutine displays the value of the result. </p><br><h1 id="zaglyanem-glubzhe-v-krolichyu-noru">  Look deeper into the rabbit hole </h1><br><p>  Consider an example more close to reality.  Imagine that in the application you need to send an email.  Request recipients and generate text messages take considerable time.  Both processes are independent, and accordingly we can execute them in parallel. </p><br><pre> <code class="hljs bash"><span class="hljs-built_in"><span class="hljs-built_in">suspend</span></span> fun sendEmail(r: String, msg: String): Boolean { //(6) delay(2000) println(<span class="hljs-string"><span class="hljs-string">"Sent '</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$msg</span></span></span><span class="hljs-string">' to </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$r</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">suspend</span></span> fun getReceiverAddressFromDatabase(): String { //(4) delay(1000) <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-string"><span class="hljs-string">"coroutine@kotlin.org"</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">suspend</span></span> fun sendEmailSuspending(): Boolean { val msg = async(CommonPool) { //(3) delay(500) <span class="hljs-string"><span class="hljs-string">"The message content"</span></span> } val recipient = async(CommonPool) { //(5) getReceiverAddressFromDatabase() } println(<span class="hljs-string"><span class="hljs-string">"Waiting for email data"</span></span>) val sendStatus = async(CommonPool) { sendEmail(recipient.await(), msg.await()) //(7) } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> sendStatus.await() //(8) } fun main(args: Array&lt;String&gt;) = runBlocking(CommonPool) { //(1) val job = launch(CommonPool) { sendEmailSuspending() //(2) println(<span class="hljs-string"><span class="hljs-string">"Email sent successfully."</span></span>) } job.join() //(9) println(<span class="hljs-string"><span class="hljs-string">"Finished"</span></span>) }</code> </pre> <br><blockquote>  You can slightly simplify the author's code </blockquote><br><div class="spoiler">  <b class="spoiler_title">Code for sendEmailSuspending and main</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendEmailSuspending</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> msg = async(CommonPool) { delay(<span class="hljs-number"><span class="hljs-number">500</span></span>) <span class="hljs-string"><span class="hljs-string">"The message content"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> recipient = async(CommonPool) { getReceiverAddressFromDatabase() } println(<span class="hljs-string"><span class="hljs-string">"Waiting for email data"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sendEmail(recipient.await(), msg.await()) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(args: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Array</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span> = runBlocking(CommonPool) { sendEmailSuspending() println(<span class="hljs-string"><span class="hljs-string">"Email sent successfully."</span></span>) println(<span class="hljs-string"><span class="hljs-string">"Finished"</span></span>) }</code> </pre> </div></div><br><p>  First, as we have seen in the previous example, we use (1) <code>launch</code> builder inside <code>runBlocking</code> , so we can (9) wait for the execution of the coroutine.  In (2), we call the <code>sendEmailSuspending</code> interrupted function.  Inside this method, we use two parallel tasks: (3) to get the message text and (4) to call <code>getReceiverAddressFromDatabase</code> to get the address.  Both tasks are performed in parallel korutinah using <code>async</code> .  It is also worth noting that the call to delay is not blocking, it is used to interrupt the execution of cortina. </p><br><h1 id="async-bilder">  async builder </h1><br><p>  This builder is really simple in its concept.  In other languages, he would return a <a href="https://en.wikipedia.org/wiki/Futures_and_promises">promise</a> , which, strictly speaking, is represented in <em>Kotlin</em> as a type <code>Deferred</code> .  All of these entities as <code>promise</code> , <code>future</code> , <code>deferred</code> or <code>delay</code> are usually interchangeable and are descriptions of the same.  An asynchronous object that ‚Äúpromises‚Äù to return the result of the calculation and which can be waited at any time. </p><br><p>  We have already seen the ‚Äúwaiting‚Äù part of the <code>Deferred</code> objects from <em>Kotlin</em> in (7), where the interrupted function was called with the results of waiting for both methods.  The <code>await()</code> method is called on an instance of a <em>Deferred</em> object whose call is interrupted until the result is available.  The call to <code>sendEmail</code> also wrapped in an asynchronous builder so that we can wait for execution. </p><br><h1 id="chto-propustili-coroutinecontext">  What missed: CoroutineContext </h1><br><p>  An important part of the examples above is the first parameter passed to the build function, which is an instance of the <code>CoroutineContext</code> class.  This context is what we pass into coruntine and what provides access to our current <code>Job</code> . </p><br><p>  The current context can be used to start the internal quorutine, and as a result, the child <code>Job</code> will be a descendant of the external.  This, in turn, allows you to override the entire hierarchy of quorutin with a single call on the parent <code>Job</code> . <br>  <code>CoroutineContext</code> contains various <code>Element</code> types, one of which is <code>CoroutineDispather</code> . </p><br><p>  In all the examples above, <code>CommonPool</code> used, which is the very <code>dispatcher</code> .  He is responsible for ensuring that the cortinas are executed in a thread pool under the control of the framework.  Alternatively, we can use either a limited flow, either specially created, or using our own pool.  The context can be easily combined using the + operator: </p><br><pre> <code class="hljs mel"><span class="hljs-keyword"><span class="hljs-keyword">launch</span></span>(CommonPool + CoroutineName(<span class="hljs-string"><span class="hljs-string">"mycoroutine"</span></span>)){...}</code> </pre> <br><h1 id="obschee-izmenyaemoe-sostoyanie">  General changeable state </h1><br><p>  You, probably, have already thought: corortines look, of course, good, but how will we perform synchronization and how will we exchange data between different coroutines? </p><br><p>  Well, this is exactly the question I was asked recently, and this is a reasonable question for most Corutin using a pool of threads.  For synchronization, we can use different techniques: thread-safe data structures, restriction on execution in one thread, or use locks (see <code>Mutex</code> for <code>Mutex</code> ) <br>  In addition to common patterns, <em>Kotlin</em> cortuettes encourage us to use the ‚Äúexchange through communication‚Äù style (see <a href="https://blog.simon-wirtz.de/kotlin-coroutines-guide/">QA</a> ). </p><br><p>  In particular, the actor is well suited for communication.  It can be used in quotes that can send / receive messages from it.  Let's look at an example: </p><br><h1 id="aktory">  Actors </h1><br><pre> <code class="hljs pgsql">sealed <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CounterMsg { <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> IncCounter : CounterMsg() // one-way message <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">increment</span></span> counter class GetCounter(val response: SendChannel&lt;Int&gt;) : CounterMsg() // a request with channel for reply. } fun counterActor() = actor&lt;CounterMsg&gt;(CommonPool) { //(<span class="hljs-number"><span class="hljs-number">1</span></span>) var counter = <span class="hljs-number"><span class="hljs-number">0</span></span> //(<span class="hljs-number"><span class="hljs-number">9</span></span>) actor state, <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> shared <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (msg <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> channel) { // handle incoming messages <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (msg) { <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> CounterMsg.IncCounter -&gt; counter++ //(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> CounterMsg.GetCounter -&gt; msg.response.send(counter) //(<span class="hljs-number"><span class="hljs-number">3</span></span>) } } } suspend fun getCurrentCount(counter: ActorJob&lt;CounterMsg&gt;): <span class="hljs-type"><span class="hljs-type">Int</span></span> { //(<span class="hljs-number"><span class="hljs-number">8</span></span>) val response = Channel&lt;<span class="hljs-type"><span class="hljs-type">Int</span></span>&gt;() //(<span class="hljs-number"><span class="hljs-number">2</span></span>) counter.send(CounterMsg.GetCounter(response)) val receive = response.receive() println("Counter = $receive") <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> receive } fun main(args: <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>&lt;String&gt;) = runBlocking&lt;Unit&gt; { val counter = counterActor() launch(CommonPool) { //(<span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(getCurrentCount(counter) &lt; <span class="hljs-number"><span class="hljs-number">100</span></span>){ delay(<span class="hljs-number"><span class="hljs-number">100</span></span>) println("sending IncCounter message") counter.send(CounterMsg.IncCounter) //(<span class="hljs-number"><span class="hljs-number">7</span></span>) } } launch(CommonPool) { //(<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( getCurrentCount(counter) &lt; <span class="hljs-number"><span class="hljs-number">100</span></span>) { delay(<span class="hljs-number"><span class="hljs-number">200</span></span>) } }.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>() counter.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>() // shutdown the actor }</code> </pre> <br><p>  In the example above, we used <code>Actor</code> , which is coruntine by itself and can be used in any context.  Actor contains the current state of the application, which is contained in <code>counter</code> .  Here we also meet another interesting functionality (2) <code>Channel</code> </p><br><h1 id="kanaly-channel">  Channels </h1><br><p>  <a href="">Channels</a> provide us with the ability to exchange a stream of values, which is very similar to how we use <code>BlockingQueue</code> (implementing the producer-consumer pattern) in <em>Java</em> , only without blocking.  In addition, <code>send</code> and <code>receive</code> are interrupted functions and are used to receive and send messages through a channel that implements the <em>FIFO</em> strategy. </p><br><p>  The actor by default contains such a channel and can be used in other quotes to send messages to it.  In the example above, the actor iterates over messages from its own channel ( <code>for</code> works here with interrupted calls), processing them according to their type: message (4) <code>IncCounter</code> increases the <code>counter</code> value in the actor, while message (3) <code>GetCounter</code> causes the actor to return the value of counter in the form of sending an independent value to the <code>SendChannel</code> channel from <code>GetCounter</code> . </p><br><p>  The first korutin in method (5) <code>main</code> just for convenience, it sends the message (7) <code>IncCounter</code> to the actor as long as the counter value is less than 100. The second (6) waits for the counter value to be less than 100. Both coroutines use an interrupted function (8) <code>getCurrentCounter</code> , to which <code>GetCounter</code> messages are <code>GetCounter</code> and interrupted while waiting for a <code>receive</code> to be returned. </p><br><p>  As we see, the entire state is isolated in a particular actor.  This solves the problem of the overall changeable state. </p><br><h1 id="drugie-funkcionalnosti-i-primery">  Other functionalities and examples </h1><br><p>  If you want to dive deeper into Korutiny and work with them, then I recommend reading the <em>Kotlin</em> documentation in more detail and, in particular, see the excellent <a href="">guide</a> . </p><br><h2 id="kak-oni-rabotayut---realizaciya-korutin">  How they work - the implementation of Corutin </h2><br><p>  I will not dive too deep into the details so as not to overload the post.  In addition, in the next few weeks I plan to write a sequel with more detailed information on the implementation, along with examples of bytecode generation.  Therefore, we now confine ourselves to a simple description ‚Äúon the fingers‚Äù. </p><br><p>  Korutin are not based on <em>JVM</em> functionality or operating system functionality.  Instead, the cortices and interrupted functions are converted by the compiler into a state machine that can interrupt interrupts and send them to interrupted functions while maintaining the state.  All this is possible thanks to the <code>Continuation</code> , which is added by the compiler, as an additional implicit parameter, to each call of the function being interrupted.  This is the so-called <a href="https://en.wikipedia.org/wiki/Continuation-passing_style">Continuation-passing</a> style.  More detailed description can be found <a href="">here</a> . </p><br><h1 id="sovety-ot-romana-elizarova">  Tips from Roman Elizarov </h1><br><p>  Not long ago, I was able to talk with Roman Elizarov from <em>JetBrains</em> , thanks to which in many ways Korutins appeared in <em>Kotlin</em> .  Let me share the information with you: </p><br><p>  Q: The first question that arises in me is: when should I use coroutines and are there any situations where it will still be necessary to use streams? </p><br><p>  A: Korutiny needed for asynchronous tasks that expect something most of the time.  Threads for intensive <em>CPU</em> tasks. </p><br><p>  Q: I mentioned that the phrase ‚Äúlightweight threads‚Äù sounds a bit deceptive to me, especially considering that the corutines are based on threads and run in the thread pool.  It seems to me that the Korutinians are more like ‚Äútask‚Äù, which is executed, interrupted, stopped. </p><br><p>  A: The phrase ‚Äúlightweight streams‚Äù is rather superficial, korutiny largely behave like streams from the point of view of users. </p><br><p>  Q: I would like to know about synchronization.  If the corutines are in many ways similar to the flows, then it will be necessary to implement synchronization of the general state between the different corutins. </p><br><p>  A: You can use known patterns for synchronization, but it‚Äôs still preferable not to have a common state at all when using quorutin.  Instead, the korutinas ‚Äúencourage a style of communication through communication.‚Äù </p><br><h1 id="vyvody">  findings </h1><br><p>  Korutiny is a very powerful feature that appeared in <em>Kotlin</em> .  Until I met Corutinos, it seemed to me that multithreading from <em>Java was</em> enough. </p><br><p>  In contrast to <em>Java</em> , <em>Kotlin</em> presents a completely different style of competitive programming, not blocking in nature, which does not force us to run a huge number of native threads.  In <em>Java,</em> it is quite normal to create another additional thread or a new pool, without thinking that this is a huge overhead and this can slow down the application in the future.  Alternatively, korutins are the so-called ‚Äúlightweight streams‚Äù, emphasizing that they do not correlate one to one in native streams and are not subject to such problems as <code>deadlocks</code> , <code>starvation</code> , etc.  As we have already seen, you can not worry about blocking threads, synchronization with corints, they look more straightforward, especially if we adhere to ‚Äúcommunication through communication‚Äù </p><br><p>  Korutin also allow us to use different approaches to write competitive code, each of which is either already implemented in the library ( <em>kotlinx.coroutine</em> ), or can be easily implemented with its help. </p><br><p>  <em>Java</em> developers are probably more accustomed to sending tasks to the thread pool and waiting for the <code>future</code> result using <code>ExecutorService</code> , which, as we have seen, is easily implemented using <code>async/await</code> .  Yes, this is not a fully equivalent replacement, but it is still a significant improvement. </p><br><p>  Redefine your approach to competitive programming in <em>Java</em> , all of these checked exceptions, hard-blocking strategies, and a huge amount of generic code.  It is quite normal to write code sequentially with corortines using <code>suspend</code> function calls, communicating with other corutines, waiting for the result, canceling corutines, etc. </p><br><h1 id="perspektivy">  Perspectives </h1><br><p>  Nevertheless, I am convinced that the Corutins are truly incredible.  Of course, only time will tell if they are really mature for high-load multi-threaded applications.  Maybe even many programmers will think and reconsider their approaches to programming.  Curious to see what will happen next.   ,      , , <em>JetBrains</em>       ,    ,              . </p><br><p>  Fine!      . ,    -   .    . </p><br><p> Simon </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/336228/">https://habr.com/ru/post/336228/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336218/index.html">36 materials on neural networks: books, articles and recent research</a></li>
<li><a href="../336220/index.html">How to automatically pause an Adwords campaign when a site crashes</a></li>
<li><a href="../336222/index.html">Engineering systems of our data centers and their monitoring, part two</a></li>
<li><a href="../336224/index.html">How stores attract customers with technology: 7 effective tools</a></li>
<li><a href="../336226/index.html">From gamer to quality director</a></li>
<li><a href="../336230/index.html">XBRL: just about the complex - Chapter 6. Immersion in XBRL - Part 4. How to make life easier</a></li>
<li><a href="../336232/index.html">Reverse engineering malicious fraud script</a></li>
<li><a href="../336234/index.html">With the wind! How we introduced contactless payment of trips to the subway</a></li>
<li><a href="../336236/index.html">Fill in "Agreements, taxes and banking information" in iTunes connect for Russian LLC</a></li>
<li><a href="../336240/index.html">Welcome to South DevFest 2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>