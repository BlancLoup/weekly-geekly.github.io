<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>NVIDIA Jetson Nano: tests and first impressions - part 2, AI tests</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr. 

 In the first part , NVIDIA Jetson Nano was considered - a board in the Raspberry Pi form factor, focused on performance computing usin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>NVIDIA Jetson Nano: tests and first impressions - part 2, AI tests</h1><div class="post__text post__text-html js-mediator-article">  Hello, Habr. <br><br>  In the <a href="https://habr.com/ru/post/460723/">first part</a> , NVIDIA Jetson Nano was considered - a board in the Raspberry Pi form factor, focused on performance computing using the GPU.  It is time to test the board for what it was designed for - for AI-oriented calculations. <br><br><img src="https://habrastorage.org/webt/91/1a/7i/911a7i0fv9k20_edm9oftroelpq.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Consider how different tasks go on the board, such as classifying images or recognizing pedestrians or seals (where without them).  For all tests, the source codes that can be run on the desktop, Jetson Nano or Raspberry Pi are given.  For those who are interested, continued under the cut. <br><a name="habracut"></a><br>  There are two ways to use this board.  The first is to run standard frameworks like Keras and Tensorflow.  It will work in principle, it will, but as already seen from the first part, Jetson Nano, of course, is inferior to a full-fledged desktop or laptop video card.  The user will have to take on the task of optimizing the model.  The second way is to take ready-made classes that come with the board.  It is simpler and works ‚Äúout of the box‚Äù, the minus is that all implementation details are hidden to a much greater extent, in addition, you will have to study and use custom-sdk, which, besides these boards, will not be useful anywhere else.  However, we will look at both ways, start with the first. <br><br><h2>  Image classification </h2><br>  Consider the problem of image recognition.  To do this, we will use the ResNet50 model supplied with Keras (this model was the winner of the ImageNet Challenge in 2015).  To use it, a few lines of code are enough. <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tensorflow <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tf <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time IMAGE_SIZE = <span class="hljs-number"><span class="hljs-number">224</span></span> IMG_SHAPE = (IMAGE_SIZE, IMAGE_SIZE, <span class="hljs-number"><span class="hljs-number">3</span></span>) resnet = tf.keras.applications.ResNet50(input_shape=IMG_SHAPE) img = tf.contrib.keras.preprocessing.image.load_img(<span class="hljs-string"><span class="hljs-string">'cat.png'</span></span>, target_size=(IMAGE_SIZE, IMAGE_SIZE)) t_start = time.time() img_data = tf.contrib.keras.preprocessing.image.img_to_array(img) x = tf.contrib.keras.applications.resnet50.preprocess_input(np.expand_dims(img_data, axis=<span class="hljs-number"><span class="hljs-number">0</span></span>)) probabilities = resnet.predict(x) print(tf.contrib.keras.applications.resnet50.decode_predictions(probabilities, top=<span class="hljs-number"><span class="hljs-number">5</span></span>)) print(<span class="hljs-string"><span class="hljs-string">"dT"</span></span>, time.time() - t_start)</code> </pre> <br>  I did not even begin to remove the code under the spoiler, because  he is very small.  As you can see, the image is first resized to 224x224 (this is the input network format), at the end, the predict function does all the work. <br><br>  We take a photo of the cat and run the program. <br><br><img src="https://habrastorage.org/webt/_q/e8/ln/_qe8ln2w3hsmbw4dqcy7kdnuft0.png"><br><br>  Results: <br><br><pre> <code class="python hljs">[[(<span class="hljs-string"><span class="hljs-string">'n02123045'</span></span>, <span class="hljs-string"><span class="hljs-string">'tabby'</span></span>, <span class="hljs-number"><span class="hljs-number">0.765179</span></span>), (<span class="hljs-string"><span class="hljs-string">'n02123159'</span></span>, <span class="hljs-string"><span class="hljs-string">'tiger_cat'</span></span>, <span class="hljs-number"><span class="hljs-number">0.19059166</span></span>), (<span class="hljs-string"><span class="hljs-string">'n02124075'</span></span>, <span class="hljs-string"><span class="hljs-string">'Egyptian_cat'</span></span>, <span class="hljs-number"><span class="hljs-number">0.013605555</span></span>), (<span class="hljs-string"><span class="hljs-string">'n04493381'</span></span>, <span class="hljs-string"><span class="hljs-string">'tub'</span></span>, <span class="hljs-number"><span class="hljs-number">0.0025916891</span></span>), (<span class="hljs-string"><span class="hljs-string">'n04553703'</span></span>, <span class="hljs-string"><span class="hljs-string">'washbasin'</span></span>, <span class="hljs-number"><span class="hljs-number">0.0021566998</span></span>)]]</code> </pre> <br>  Once again, upset by his knowledge of English (I wonder how many non-native people know what ‚Äútabby‚Äù is?), I checked the output with the dictionary, yes, everything works. <br><br>  The PC code execution time was <b>0.5 s</b> for calculations on the CPU and 2 s (!) For calculations on the GPU.  Judging by the log, the problem is either in the model or in Tensorflow, but when it starts, the code tries to allocate a lot of memory, getting several warnings like ‚ÄúAllocator (GPU_0_bfc) ran out of memory trying to allocate 2.13GiB with freed_by_count = 0.‚Äù .  This is a warning and not an error, while the code works, but much slower than it should. <br><br>  On Jetson Nano, it‚Äôs still slower: <b>2.8c</b> on the CPU and <b>18.8c</b> on the GPU, while the output looks like this: <br><br><img src="https://habrastorage.org/webt/t6/ok/ja/t6okja2fzqx_tjvmd6evens5dn8.png"><br><br>  In general, even 3s per image, this is not yet real time.  Setting the gpu_options.allow_growth option recommended on stack overflow does not help, if anyone knows another way, write in the comments. <br><br>  <b>Edit</b> : as suggested in the comments, the first start of tensorflow always takes a long time, and it‚Äôs incorrect to measure time using it.  Indeed, when processing the second and subsequent files, the results are much better - 0.6s without a GPU and 0.2s with a GPU.  On the desktop, speed is, however, 2.0s and 0.05s, respectively. <br><br>  A convenient feature of ResNet50 is that at the first start it pumps out the entire model to disk (about 100 MB), then the code works completely autonomously, without registration and SMS.  Which is especially nice, given that most modern AI-services work only on the server, and without the Internet, the device turns into a "pumpkin". <br><br><h2>  Cats vs dogs </h2><br>  Consider the following problem.  Using Keras, we‚Äôll create a neural network that can distinguish between cats and dogs.  It will be a convolutional neural network (CNN - Convolutional Neural Network), we will take network design from <a href="https://medium.com/%40ferhat00/deep-learning-with-keras-classifying-cats-and-dogs-part-1-982067594856">this</a> publication.  A training set of images of cats and dogs is already included in the tensorflow_datasets package, so you don‚Äôt have to photograph them yourself. <br><br>  We load a set of images and divide it into three blocks - training, verification and test.  We ‚Äúnormalize‚Äù each picture, bringing the colors to the range 0..1. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tensorflow <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tf <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tensorflow.keras <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> layers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tensorflow_datasets <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tfds <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.preprocessing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> image <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time IMAGE_SIZE = <span class="hljs-number"><span class="hljs-number">64</span></span> IMG_SHAPE = (IMAGE_SIZE, IMAGE_SIZE, <span class="hljs-number"><span class="hljs-number">3</span></span>) splits = tfds.Split.TRAIN.subsplit(weighted=(<span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>)) (cat_train, cat_valid, cat_test), info = tfds.load(<span class="hljs-string"><span class="hljs-string">'cats_vs_dogs'</span></span>, split=list(splits), with_info=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, as_supervised=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) label_names = info.features[<span class="hljs-string"><span class="hljs-string">'label'</span></span>].int2str <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pre_process_image</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(image, label)</span></span></span><span class="hljs-function">:</span></span> image = tf.cast(image, tf.float32) image = image / <span class="hljs-number"><span class="hljs-number">255.0</span></span> <span class="hljs-comment"><span class="hljs-comment"># Normalize image: 0..255 -&gt; 0..1 image = tf.image.resize(image, (IMAGE_SIZE, IMAGE_SIZE)) return image, label BATCH_SIZE = 32 SHUFFLE_BUFFER_SIZE = 1000 train_batch = cat_train.map(pre_process_image).shuffle(SHUFFLE_BUFFER_SIZE).repeat().batch(BATCH_SIZE) validation_batch = cat_valid.map(pre_process_image).repeat().batch(BATCH_SIZE)</span></span></code> </pre><br>  We write the function of generating a convolutional neural network. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">custom_model</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Source: https://medium.com/@ferhat00/deep-learning-with-keras-classifying-cats-and-dogs-part-1-982067594856 classifier = tf.keras.Sequential() # Step 1 ‚Äî Convolution classifier.add(layers.Conv2D(32, (3, 3), input_shape=IMG_SHAPE, activation='relu')) # Step 2 ‚Äî Pooling classifier.add(layers.MaxPooling2D(pool_size=(2, 2))) # Adding a second convolutional layer classifier.add(layers.Conv2D(32, (3, 3), activation='relu')) classifier.add(layers.MaxPooling2D(pool_size=(2, 2))) # Step 3 ‚Äî Flattening classifier.add(layers.Flatten()) # Step 4 ‚Äî Full connection classifier.add(layers.Dense(units=128, activation='relu')) classifier.add(layers.Dense(units=1, activation='sigmoid')) # Compiling the CNN we shall use the Adam stochastic optimisation method, binary cross entropy loss function classifier.compile(optimizer=tf.keras.optimizers.Adam(), loss='binary_crossentropy', metrics=['accuracy']) return classifier</span></span></code> </pre><br>  Now we can run network training on our ‚Äúcat-dog‚Äù kit.  Training takes a long time (20 minutes on the GPU and 1-2 hours on the CPU), so when finished, save the model to a file. <br><br><pre> <code class="python hljs">tl_model = custom_model() t_start = time.time() tl_model.fit(train_batch, steps_per_epoch=<span class="hljs-number"><span class="hljs-number">8000</span></span>, epochs=<span class="hljs-number"><span class="hljs-number">2</span></span>, validation_data=validation_batch, validation_steps=<span class="hljs-number"><span class="hljs-number">10</span></span>, callbacks=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) print(<span class="hljs-string"><span class="hljs-string">"Training done, dT:"</span></span>, time.time() - t_start) print(tl_model.summary()) validation_steps = <span class="hljs-number"><span class="hljs-number">20</span></span> loss0, accuracy0 = tl_model.evaluate(validation_batch, steps=validation_steps) print(<span class="hljs-string"><span class="hljs-string">"Loss: {:.2f}"</span></span>.format(loss0)) print(<span class="hljs-string"><span class="hljs-string">"Accuracy: {:.2f}"</span></span>.format(accuracy0)) tl_model.save(<span class="hljs-string"><span class="hljs-string">"dog_cat_model.h5"</span></span>)</code> </pre><br>  By the way, the attempt to start training directly on the Jetson Nano failed - the board in 5 minutes overheated and hung.  For resource-intensive calculations, a cooler is required for the board, although by and large, there is no sense in doing such tasks directly on Jetson Nano - the model can be trained on a PC, and the finished saved file can be used on Nano. <br><br>  Then another pitfall came out - the tensowflow version 14 library was installed on the PC, and the latest version for Jetson Nano so far is 13. And the model saved in the 14th version was not read in the 13th, I had to install the same versions using pip. <br><br>  Finally, we can load the model from a file and use it to recognize images. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">predict_model</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(model, image_file)</span></span></span><span class="hljs-function">:</span></span> img = image.load_img(image_file, target_size=(IMAGE_SIZE, IMAGE_SIZE)) t_start = time.time() img_arr = np.expand_dims(img, axis=<span class="hljs-number"><span class="hljs-number">0</span></span>) result = model.predict_classes(img_arr) print(<span class="hljs-string"><span class="hljs-string">"Result: {}, dT: {}"</span></span>.format(label_names(result[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>]), time.time() - t_start)) model = tf.keras.models.load_model(<span class="hljs-string"><span class="hljs-string">'dog_cat_model.h5'</span></span>) predict_model(model, <span class="hljs-string"><span class="hljs-string">"cat.png"</span></span>) predict_model(model, <span class="hljs-string"><span class="hljs-string">"dog1.png"</span></span>) predict_model(model, <span class="hljs-string"><span class="hljs-string">"dog2.png"</span></span>)</code> </pre><br>  The photo of the cat was used the same, but for the ‚Äúdog‚Äù test 2 pictures were used: <br><br><img src="https://habrastorage.org/webt/2m/0m/6f/2m0m6fvejlzvcdfuewdq2m9b5ug.png"><br><br>  The first guessed correctly, and the second at first had errors and the neural network thought it was a cat, I had to increase the number of iterations of training.  However, I would probably be wrong the first time too;) <br><br>  The execution time on Jetson Nano turned out to be quite small - the very first photo was processed in 0.3s, but all subsequent ones were much faster, apparently the data is cached in memory. <br><br><img src="https://habrastorage.org/webt/hx/w1/vg/hxw1vgfb217p1usxaftimpmkybo.png"><br><br>  In general, we can assume that on such simple neural networks the board speeds are quite enough even without any optimizations, 100fps is a value sufficient even for video in real time. <br><br><h2>  Conclusion </h2><br>  As you can see, even standard models from Keras and Tensorflow can be used on Nano, albeit with varying success - something works, something doesn't.  However, the results can be improved, instructions on optimizing the model and reducing memory size can be read <a href="https://www.dlology.com/blog/how-to-run-keras-model-on-jetson-nano/">here</a> . <br><br>  But fortunately for us, manufacturers have already done this for us.  If readers still have interest, the final part will be devoted to <a href="https://github.com/dusty-nv/jetson-inference">ready-made libraries</a> optimized for working with Jetson Nano. </div><p>Source: <a href="https://habr.com/ru/post/460971/">https://habr.com/ru/post/460971/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460961/index.html">Setting up Unit tests in mixed Swift + Objective-C projects</a></li>
<li><a href="../460965/index.html">Split Controller without these your storyboards</a></li>
<li><a href="../460967/index.html">Troy Hunt: 10 personal financial lessons for information technology professionals</a></li>
<li><a href="../460969/index.html">Margaret Hamilton: ‚ÄúThey were worried that men might rebel; but it didn‚Äôt happen ‚Äù</a></li>
<li><a href="../46097/index.html">Debian stuff - apt-build</a></li>
<li><a href="../460973/index.html">Contact welding for 18650 batteries</a></li>
<li><a href="../460979/index.html">Rejuvenation biotechnologies are real and inevitable</a></li>
<li><a href="../46098/index.html">How to buy books, software, iTunes Gift Card directly on the iPhone. For WebMoney.</a></li>
<li><a href="../460981/index.html">MVVM implementation of a WPF application configuration built on the basis of the Catel framework</a></li>
<li><a href="../460983/index.html">I'm not real</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>