<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Observed models in Realm Xamarin</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you are annoyed by the aspect of updating the data stored in the models, and you think about how great it would be if the model could be more indep...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Observed models in Realm Xamarin</h1><div class="post__text post__text-html js-mediator-article">  If you are annoyed by the aspect of updating the data stored in the models, and you think about how great it would be if the model could be more independent and notify about changes, welcome to cat. <br><br><img src="https://habrastorage.org/files/92a/86c/9f2/92a86c9f2f414543ae724fc80e106667.jpg"><br><a name="habracut"></a><br>  <i>Note.</i>  <i>Further, the story will be conducted on behalf of the author.</i> <br><br>  As a .NET developer, I‚Äôm partial to MVVM and data binding.  Thanks to them, I can untie ideas from application logic, and, in most cases, write an application without having to worry about updating the user interface.  However, one annoying aspect remains - updating the data stored in the models.  Most often, I get a network call that takes certain data, stores it on disk, and then updates the view models by wrapping the corresponding model, whether by comparing changes or updating the entire interface.  But it would be great if the model could take care of this independently and notify us about the changes, wouldn‚Äôt it?  It turns out that when using <a href="https://aka.ms/habr_320338_1">Realm</a> for long-term data storage, this becomes possible. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This may come as a surprise to some, but all objects stored in the Realm are initially available for observation.  And even including functional dependencies and query results!  And because of this, it is extremely easy to transfer them directly to data binding.  In this post, I‚Äôll focus on Xamarin.Forms, because they come with a data-binding-friendly visualization engine, but you can easily use a project with a native UI with frameworks such as <a href="https://aka.ms/habr_320338_2">MvvmCross</a> and <a href="https://aka.ms/habr_320338_3">MVVM Light</a> .  So let's take a look at an example of how using Realm, you can create a very simple contact application with it. <br><br><h2>  Models </h2><br>  Since we do not want to complicate anything here, let's define only one model class - User: <br><br><pre><code class="javascript hljs">public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RealmObject</span></span></span><span class="hljs-class"> </span></span>{ public string Id { get; set; } = Guid.NewGuid().ToString(); public string Name { get; set; } <span class="hljs-comment"><span class="hljs-comment">/*    ‚Äì ,   . . */</span></span> }</code> </pre> <br>  Here we specify the saved object, which, thanks to Realm, will be constantly updated.  So, as soon as you have an instance of the <code>User</code> class, there is no need to ‚Äúupdate‚Äù it, because whenever you access the property, the current information is saved.  In addition, <code>RealmObject</code> implements <code>INotifyPropertyChanged</code> , which allows you to subscribe and receive notifications about any possible changes.  And although these are just a few lines of code, their impact is very significant.  And even better, there are actually no templates here - there is no manual triggering of the event, SQL mapping, and, of course, the update logic. <br><br><h2>  List of contacts </h2><br>  First of all, the contacts application is expected to have the functionality to display, as a matter of fact, a list of contacts.  In the MVVM world, this usually means providing an <code>ObservableCollection&lt;User&gt;</code> in a <code>ViewModel</code> , linking it, and then updating when models are changed (for example, after adding a new contact).  It sounds like it is very difficult, but look at how we will cope with this task with the help of Realm: <br><br><pre> <code class="javascript hljs">public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContactsViewModel</span></span></span><span class="hljs-class"> </span></span>{ private readonly Realm _realm; public IEnumerable&lt;User&gt; Users { get; } public ContactsViewModel() { _realm = Realm.GetInstance(); Users = _realm.All&lt;User&gt;().OrderBy(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">u</span></span></span><span class="hljs-function"> =&gt;</span></span> u.Name); } }</code> </pre> <br>  And here is our page (we have to set the <code>ContactsViewModel</code> in the code as a <code>BindingContext</code> , but there‚Äôs nothing interesting there, so let's just assume that we did it): <br><br><pre> <code class="javascript hljs">&lt;ContentPage x:Class=<span class="hljs-string"><span class="hljs-string">"Contacts.ContactsPage"</span></span>&gt; &lt;ContentPage.Content&gt; &lt;ListView ItemsSource="{Binding Users}" x:Name="ContactsListView"&gt; &lt;ListView.ItemTemplate&gt; &lt;DataTemplate&gt; &lt;ViewCell&gt; &lt;Label Text="{Binding Name}"/&gt; &lt;/ViewCell&gt; &lt;/DataTemplate&gt; &lt;/ListView.ItemTemplate&gt; &lt;/ListView&gt; &lt;/ContentPage.Content&gt; &lt;/ContentPage&gt;</code> </pre> <br>  And here is the result!  One-time initialization - and manual updating of <code>Users</code> no longer required.  The runtime type of the collection returned by <a href="https://aka.ms/habr_320338_4">Realm.All</a> implements <a href="https://aka.ms/habr_320338_5">INotifyCollectionChanged</a> , which is monitored by the Xamarin Forms data binding mechanism, so that the interface is notified of any changes that occur in the collection.  When working with a native UI project, you can either convert this type yourself, or use the <a href="https://aka.ms/habr_320338_6">AsRealmCollection</a> extension <a href="https://aka.ms/habr_320338_6">method</a> .  Now, in confirmation of my words, let's consider how we can make certain changes. <br><br><h2>  Editing a single contact </h2><br><pre> <code class="javascript hljs">public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EditContactViewModel</span></span></span><span class="hljs-class"> </span></span>{ public User User { get; } public EditContactViewModel(User user) { User = user; } }</code> </pre> <br>  And the corresponding page: <br><br><pre> <code class="javascript hljs">&lt;ContentPage x:Class=<span class="hljs-string"><span class="hljs-string">"Contacts.EditContactPage"</span></span> Title=<span class="hljs-string"><span class="hljs-string">"{Binding User.Name}"</span></span>&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ContentPage.Content</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Entry</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Text</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"{Binding User.Name}"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Placeholder</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"Contact name"</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ContentPage.Content</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ContentPage</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br>  From the moment the <code>Entry</code> bindings become bidirectional by default, whenever you change a username, the change is saved to disk and the page title is updated.  And since our ListView on the main screen is associated with an ‚Äúactive‚Äù query, it will update the relevant new data already by pressing the ‚Äúback‚Äù button.  Connecting navigation to view models is not so fun, so I will not dwell on this here.  But with one of the ways to do this can be found in the <a href="https://aka.ms/habr_320338_7">finished example</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/68d/e6f/569/68de6f5697464e36aac80436d2ad6d24.gif"></div><br><h2>  Add contact to favorites </h2><br>  Let's expand a bit the functionality of our ‚Äúraw‚Äù application so far, that is, we add the ability to mark a contact as a favorite.  First, add a new property to our User: <br><br><pre> <code class="javascript hljs">public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RealmObject</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* previous properties */</span></span> public bool IsFavorite { get; set; } }</code> </pre> <br>  After that, we update the <code>ContactsViewModel</code> so that the selected contacts are shown above, and also add the command ‚ÄúSwitch favorites‚Äù: <br><br><pre> <code class="javascript hljs">public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContactsViewModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* Other properties */</span></span> public Command&lt;User&gt; ToggleIsFavoriteCommand { get; } public ContactsViewModel() { _realm = Realm.GetInstance(); Users = _realm.All&lt;User&gt;<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OrderByDescending</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">u =&gt; u.IsFavorite</span></span></span><span class="hljs-function">) .</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ThenBy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">u =&gt; u.Name</span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ToggleIsFavoriteCommand</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Command</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">User</span></span></span><span class="hljs-function">&gt;(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user =&gt; { _realm.Write((</span></span></span><span class="hljs-function">) =&gt;</span></span> user.IsFavorite = !user.IsFavorite); }); } }</code> </pre> <br>  Due to this, the selected contacts will rise up, but, moreover, both groups will still be distributed in alphabetical order.  And finally, let's add the ‚òÜ button to our element (if you are interested in alternating the ‚òÜ and ‚òÖ buttons depending on whether the contact is added to your favorites or not, see the <a href="https://aka.ms/habr_320338_7">ready example</a> ): <br><br><pre> <code class="javascript hljs">&lt;ViewCell&gt; &lt;Grid&gt; &lt;Grid.ColumnDefinitions&gt; &lt;ColumnDefinition Width="*" /&gt; &lt;ColumnDefinition Width="60" /&gt; &lt;/Grid.ColumnDefinitions&gt; &lt;/Grid&gt; &lt;Label Text="{Binding Name}"/&gt; &lt;Button Text="‚òÜ" Grid.Column="1" Command="{Binding Path=BindingContext.ToggleIsFavoriteCommand, Source={x:Reference Name=ContactsListView}}" CommandParameter="{Binding .}"/&gt; &lt;/ViewCell&gt;</code> </pre> <br>  That's all.  Nothing supernatural, of course, but in this way we were able to clearly demonstrate the extent to which it is easier to add new functions when models are available for observation and are constantly updated. <br><br><img src="https://habrastorage.org/files/86b/953/eca/86b953eca9904ff9926f71a3e29b1bf8.gif"><br><br><h2>  Possible performance implications </h2><br>  This question constantly emerges when it comes to observable and active objects - ‚ÄúHow do they affect performance?‚Äù Of course, nothing comes for free.  And the ability to monitor changes is no exception.  So for using this function, you have to pay a small premium in resource consumption.  The good news is that this change watch only happens when you subscribe to <code>PropertyChanged</code> or <code>CollectionChanged</code> and stop as soon as the subscription stops.  This means that if you have a million objects processed and you do not want to receive notifications about them, then the possibility of observing <code>RealmObjects</code> will not in any way affect you.  And if you care about changes and use <code>RealmObjects</code> for data binding, then the slowdown caused by notifications will be negligible compared to the logic of data binding and layout calculations that are performed by Xamarin Forms with each update. <br><br><h2>  Conclusion </h2><br>  Realm allows you to easily develop the user interface of the application based on the data on the disk.  Thanks to this, it is possible to develop truly capacious offline applications.  And also, more importantly, create a user interface that will be independent of where the model changes occur.  They can be the result of a user action, a web request, or even synchronization with a server through the <a href="https://aka.ms/habr_320338_8">Realm Mobile Platform</a> (which will <a href="https://aka.ms/habr_320338_9">very soon</a> join Xamarin services).  And no matter what the result they will be - the user will see each update as soon as it appears. <br><br>  If you have a few minutes left, <a href="https://aka.ms/habr_320338_10">take a</a> look and <a href="https://aka.ms/habr_320338_10">pick up the database</a> (it was created on the basis of open source code and is available for free).  Or if you are like me and like to play with a ready-made project, before reading blog posts, get the code on <a href="https://aka.ms/habr_320338_7">GitHub</a> . <br><br><h2>  Thank you for the translation. </h2><br><img src="https://habrastorage.org/files/cd5/d4d/eba/cd5d4deba4fb4819a5383ecd863cde63.jpg" align="left" width="120">  <b><a href="https://aka.ms/habr_320338_11">Alexander Alekseev</a></b> - Xamarin-developer, freelancer.  Works with the .NET platform since 2012.  Participated in the development of a procurement automation system at Digamma.  C 2015 went into freelancing and switched to mobile development using Xamarin.  Currently working at StecPoint on an iOS application. <br><br>  It <a href="https://aka.ms/habr_320338_11/">manages the XamDev.ru</a> resource and the Xamarin Developers community in social networks: <a href="https://aka.ms/vk_xamarin_developers">VK</a> , <a href="https://aka.ms/fb_xamdev">Facebook</a> , <a href="https://aka.ms/telegram_xamarin_russia">Telegram</a> . <br><br>  <i>Other articles from our Xamarin blog can be found at <a href="https://habrahabr.ru/search/%3Ftarget_type%3Dposts%26q%3D%255Bxamarincolumn%255D%26order_by%3Ddate">#xamarincolumn</a> .</i> </div><p>Source: <a href="https://habr.com/ru/post/320338/">https://habr.com/ru/post/320338/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320322/index.html">How to make localization for the Japanese market</a></li>
<li><a href="../320324/index.html">Wonderful sketches of the game Super Mario Bros</a></li>
<li><a href="../320326/index.html">All the best from Lean Startup methodology, and how testers live with it</a></li>
<li><a href="../320330/index.html">How to "make friends" Mitel SIP-DECT and Asterisk</a></li>
<li><a href="../320336/index.html">Labor market overview in the field of big data and data science</a></li>
<li><a href="../320342/index.html">Tale of the impossible bug: big.LITTLE and caching</a></li>
<li><a href="../320344/index.html">Olympiad of MIPT on electronics for schoolchildren</a></li>
<li><a href="../320346/index.html">Docker implementation for a small project in Production, part 2</a></li>
<li><a href="../320348/index.html">How to establish a trust relationship between the computer and the main domain</a></li>
<li><a href="../320350/index.html">Five years, five educational projects: briefly about the main and the history of teachers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>