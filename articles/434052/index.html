<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>BLACK HAT conference. How to make a spy phone. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Host: Kevin McNami is director of the Bell Labs Security Studies Lab, which is part of Alcatel-Lucent. His presentation is called "How to make a spy p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>BLACK HAT conference. How to make a spy phone. Part 1</h1><div class="post__text post__text-html js-mediator-article"> <b>Host:</b> Kevin McNami is director of the Bell Labs Security Studies Lab, which is part of Alcatel-Lucent.  His presentation is called "How to make a spy phone", and if you have any questions, please save them until the end of the speech, so that we know that we have enough time left for them. <br><br>  <b>Kevin McNami: I</b> welcome everyone, I am glad that I am speaking here today.  I'm going to talk about how to make a good spy phone, but I think that the basis of your interest will be how you can take this SpyPhone spy phone module and put it in an Android application. <br><br><img src="https://habrastorage.org/webt/dr/hx/-2/drhx-2kmcqms3gbkq7b132fjxly.jpeg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      My performance will consist of 3 parts.  The first is a demonstration of SpyPhone in action, then we will talk a little about the special design of the ‚Äúspy phone‚Äù.  The third part of the conversation will be devoted to how you can inject the SpyPhone service into the application, and at the end I will summarize the results and answer the questions. <a name="habracut"></a><br><br>  The next slide shows how people used to perceive a ‚Äúspy phone‚Äù.  Basically, they believed that such a phone allows you to spy on other people. <br><br><img src="https://habrastorage.org/webt/hg/ak/j_/hgakj_n3t3xngdbjcz_y2qkh4oe.jpeg"><br><br>  Modern spy phone looks different, it is a regular smartphone running the Android OS.  Android is a very flexible platform that is easy to work with, it is very open and allows you to do many things.  So, this is what a modern SpyPhone looks like.  I think that the same can be done with phones running iOS, but I focused my efforts on Android. <br><br><img src="https://habrastorage.org/webt/cc/kj/9j/cckj9juwbf-6zfxflyuldvv2kgk.jpeg"><br><br>  Previously, for the organization of outdoor surveillance, you would need a variety of equipment, ranging from tape recorders to recording telephone conversations to tape and ending with cars with hidden surveillance equipment.  Today, all you need is an Android phone.  You use such a phone with special software installed on it and can track the person who owns this phone.  You can monitor his phone calls, you can control his location, you can even send messages from that person‚Äôs phone, view a list of contacts, etc. <br><br><img src="https://habrastorage.org/webt/5p/yz/4m/5pyz4m9usmzfr0w0eparr6k6jj4.jpeg"><br><br>  This is a very powerful type of cyber surveillance device.  If someone's phone is infected with this spyware application and this person brings it to the office, you can follow this person at work, watch business meetings and so on.  Management and control of the spy device is carried out through the Internet.  Spy module does not require any special additional equipment, everything is located inside the phone.  When he has something to convey interesting, he communicates with you through the site command &amp; control and transmits information.  Later I will show you a demo how it works. <br><br>  Now consider the countermeasures.  In the old days, the so-called ‚Äúcone of silence‚Äù was used to prevent eavesdropping.  If someone was spying on you, you could always enter the "cone of silence" and communicate with the interlocutor completely freely. <br><br><img src="https://habrastorage.org/webt/vh/5y/_e/vh5y_en9esxra-bn-sze6liqtac.jpeg"><br><br>  Today's "cone of silence" looks a little different.  The company in which I work has developed a technology that can be placed on the network and which automatically detects the traffic of command &amp; control, mediated by the transfer of which is the phone on the Android platform. <br><br><img src="https://habrastorage.org/webt/kw/ac/kf/kwackfpsxr5969mwjrmcsshtpbw.jpeg"><br><br>  That is why we created the SpyPhone module, which we use as a demonstration when we go to our customers, who are mainly providers of mobile communication services and mobile Internet.  We show them a ‚Äúspy phone‚Äù to show that there is a huge security problem in the mobile network.  This threat is still in its infancy, but could potentially cause great damage in the future.  We use this module to educate our customers on hazards, so it‚Äôs natural that the second part of the demonstration is the presentation of our product, which can counter these hazards. <br><br>  The smartphone is a very powerful device.  It provides access to your location, connects to the Internet from almost anywhere, has a microphone, a camera, connects to local networks via Wi-Fi, and all this makes it an ideal platform for espionage. <br><br>  I would say that a smartphone is an ideal cyber espionage tool that can be used to track a victim‚Äôs location, upload personal information, intercept and send messages, record conversations and take pictures without the owner‚Äôs knowledge.  In the context of BYOD and APT, this is the ideal platform for launching internal attacks against corporate or government networks. <br><br>  I think I‚Äôve talked enough about this, so let's move on to the demonstration.  On the left you see a screenshot from the screen of the phone, which will soon become spyware, this is the phone that I use now.  On the right you can see the command &amp; control console, which will be used by the person tracking this phone. <br><br><img src="https://habrastorage.org/webt/_4/6a/jg/_46ajgs8j-rdxilitp23c6gtauw.jpeg"><br><br>  So, we took the malware, the SpyPhone module, and embedded it in a copy of the very popular game Angry Birds.  Then we sent an email to one guy saying that he can download this cool game and play it.  We can also place this infected game on third-party sites, where the user can download it.  Now I‚Äôll go to my browser to browse my received email. <br><br>  So, when this guy receives a letter, he clicks on the link and goes to the real working app store for Android on the page with our game.  We decided to name it Very Angry Birds (‚ÄúVery Angry Birds‚Äù) because it contains the SpyPhone module. <br><br><img src="https://habrastorage.org/webt/kj/ou/aw/kjouawinr68g9gmqxjkvt4ownem.jpeg"><br><br>  So, the user downloads this game.  On an Android phone, when you install an application, it provides you with a list of all the permissions it needs for its work. <br><br><img src="https://habrastorage.org/webt/ho/pr/6g/hopr6ggpo_asy9ahqwnolkca1fu.jpeg"><br><br>  It says that the application needs access to your location, personal information, network communications, data storage, paid services, phone calls.  Since the user wants to install the application, he usually does not pay attention to all these permissions, which constantly appear during the installation of programs, and simply presses the "Install" button.  Now you can see on the screen how the installation process is going.  Next, we run the installed application.  Now on the left you see a running game, and on the right - information of the command &amp; control site that the smartphone is under control, and you can hear the sounds that accompany the game. <br><br><img src="https://habrastorage.org/webt/uj/2l/qg/uj2lqgnuqhkbagarhwtw-79kgsi.jpeg"><br><br>  I will turn off the sound because it annoys me.  So, note that the game is going on as usual, there is nothing extraordinary here that could attract the user's attention.  There is no evidence that something strange is happening with the phone. <br><br>  The user is playing, this is very cool, but even when he stops playing and closes the game, the spy module will continue its work in the background.  Even if you restart the phone, the SpyPhone service will be restarted, now it is constantly present on this smartphone.  So, this phone is infected with a cyber spy and is now displayed here in the console command &amp; control.  If I click on this line, the site will give me the information stored on this device.  We can get a map with the location of this device - this is Las Vegas. <br><br><img src="https://habrastorage.org/webt/pc/7n/jb/pc7njbtwgwmbhm1sm7t_raj_weg.jpeg"><br><br>  Let me emphasize that here the connection between the phone and the computer is not carried out directly, but via the Internet using a web server, which is located in Ottawa, where I work.  The only reason why I connected this phone with a cable to a computer is the need to take screenshots.  The console shows that we have other phones working at the same time.  Here is one of them, located in China, so you can create an international network of "spy phones" and monitor them all the time while they are online. <br><br>  So back to our phone in Las Vegas.  You can see that here is the email address of the phone‚Äôs owner‚Äôs account, phone number, CDMA communication standard, network type, IMEI, country of the cellular operator, its name, SIM card status, location coordinates and phone owner‚Äôs contacts.  All this information is uploaded to the command &amp; control server, and we can track the owner of this phone 24 hours a day, 7 days a week, and use all the information that the phone provides, including downloading the contact list of this particular person.  This will give us a list of other potential targets, if we use a kind of industrial cyber espionage, when we want to know who the owner of the phone communicates with and who does business with.  We could use this contact list to target specific individuals. <br><br>  You can imagine that an attacker distributes this game to all stores Android applications, and after people download it, you focus on some employee of a particular company, on the list of his contacts and so on. <br><br>  Another thing we can do is update the installed spyware and send messages to the infected phone.  You can use it for other purposes, for example, just to frighten people with such messages.  We can access SMS messages and email, determine the location of the phone.  All these operations are indicated in the upper part of the management console of the captured phone, they are highlighted by the blue interface.  Another thing you can do is turn on the camera of the phone, I will try to do it right now.  I take the phone in my hands and click on the ‚ÄúPeep‚Äù function in the control console, it will take some time, since you need to take a photo and send it to the command &amp; control site.  As you can see, my photo made by the front camera first appears, followed by a photo of this room taken by the rear camera.  Thus, I can remotely take pictures on the infected phone and receive these photos. <br><br>  If you notice, the game is still on the screen, so that the person will not even notice that the photo was taken.  This is done in the background without the user's knowledge.  We can use the same technology to shoot video.  The last thing I want to demonstrate is the listening function.  So, I say to the phone "This is a test, one, two, three, this is a test, one, two, three."  Then I click on the Play Audio button, the connection takes a little time, and now you hear the repetition of my words. <br><br><img src="https://habrastorage.org/webt/up/3d/tj/up3dtj_py5rll1icl17ltkdhsek.jpeg"><br><br>  So, I recorded the conversation through the microphone of the phone and uploaded it to the command &amp; control site, so this is pretty cool.  So this was a demonstration of what SpyPhone technology can do. <br><br>  Now let's talk a little about how we developed the design and technology of our software and why we made such design decisions.  I will go back to the previous slides. <br><br><img src="https://habrastorage.org/webt/nz/dn/fb/nzdnfbiuj4adzssaa23fhdeojwo.jpeg"><br><br>  First, we wanted to combine our malware with the original functions of the phone and create a trojan-type spyware program with remote access that would work with the phone on the Android platform.  We took as a basis the demo application called ‚ÄúSearchable dictionary‚Äù and modified it so that it could insert a spyware module, and implemented it as a normal application for ‚ÄúAndroid‚Äù. <br><br>  That is, we have adhered to the design of the original programs for "Android" using Java.  We needed it to contain all the necessary components inside, to work in the background, even if the application was stopped, started when the phone was loaded.  Our second task was to provide easy integration of SpyPhone into official applications.  It worked, and our malware didn‚Äôt interfere at all with other applications installed on the phone.  As the command and control command &amp; control server, we chose NodJS a web server with HTTP data transfer.  For the teams managing our program, we used the JS interface, and the teams themselves looked like this: <br><br>  update - send information to the server, <br>  toast - display a message on the screen, <br>  shutdown - stop working SpyPhone, <br>  sms - send SMS message to contact <br>  location ‚Äî send phone location information to the server, <br>  peep - take a photo and send it to the server, <br>  listen - record sound and send to server. <br><br>  All of this was fairly easy to program, since the creators of Android provided their system with a fairly powerful full set of SDK development tools.  This set provides an interface for everything you want.  We have never been engaged in the development of programs for Android, but thanks to this SDK we didn‚Äôt even have to learn anything and we developed this thing in a few weeks. <br><br>  The next slide shows the initial ‚ÄúSearchable dictionary‚Äù design, on the basis of which we created the SpyPhone, using the Java codes that you see here.  We added a part to this app called droidwhisper. <br><br><img src="https://habrastorage.org/webt/x1/kj/xb/x1kjxbeuhd0hdapmjaljlqlxl2c.jpeg"><br><br>  This is the part that we were going to cut and paste into the appropriate application later.  We had no experience creating special exploits that would exploit application vulnerabilities, so we imported a standard API that Android provides: <br><br>  User information <br>  - import android.accounts.Account; <br>  - import android.accounts.AccountManager. <br>  Phone and SMS <br>  ‚ÄìImport android.telephony.SmsManager; <br>  ‚ÄìImport android.telephony.TelephonyManager. <br>  Location <br>  ‚ÄìImport android.location.Location; <br>  ‚ÄìImport android.location.LocationListener; <br>  ‚ÄìImport android.location.LocationManager; <br>  Record media files (audio and video) <br>  - import android.media.MediaRecording. <br>  Camera <br>  ‚ÄìImport android.hardware.Camera; <br>  ‚ÄìImport android.hardware.Camera.PictureCallback; <br>  ‚ÄìImport android.hardware.Camera.PreviewCallback; <br>  ‚ÄìImport android.hardware.Camera.Size; <br>  ‚ÄìImport android.media.AudioManager; <br>  ‚ÄìImport android.view.SurfaceHolder; <br>  ‚ÄìImport android.view.SurfaceView. <br>  the Internet <br>  ‚ÄìImport org.apache.http.HttpResponse; <br>  ‚ÄìImport org.apache.http.NameValuePair; <br>  ‚ÄìImport org.apache.http.client.ClientProtocolException; <br>  ‚ÄìImport org.apache.http.client.HttpClient. <br><br>  Someone said that recording video and taking pictures when the phone is in the user's pocket is not very good.  Therefore, if you want to make a good photo, you send a text message to the owner, because we have his phone number.  He receives a message, holds the phone face to himself to read it, and during this time you take a photo with the front camera.  If you just call him, he brings the phone to his ear, and at that moment you can take a picture with the rear camera. <br><br><img src="https://habrastorage.org/webt/6z/_2/gs/6z_2gsau6ryamdbty0z1ahrzdbm.jpeg"><br><br>  Making the camera work is a bit more complicated, so we used a whole set of classes, for example, AudioManager, SurfaceHolder, and the like.  We had to provide for a temporary shutdown of the click sound when a photo is taken so as not to attract the user's attention, if this function is activated in the settings of his camera.  In addition, we made sure that the taken spy photos or videos were displayed in the phone gallery in the form of 1-pixel thumbnails so that the user could not see them.  So we had to use several tricks to ensure the invisible work of our spyware module.  As I have already noted, almost everything to ensure communication with the command &amp; control server is contained in the phone itself.  We also used some of the security flaws of Android. <br><br>  As you know, these applications must be signed to be installed on the phone, but this is not a problem, because you can use any old certificate for signing, because the main thing is that the application has a certificate at all, no matter which one.  Later I will tell you more about it. <br><br>  So, this was a brief description of the design that we used to create the application.  Now I will tell you about the implementation process, that is, how we took our malicious module and inserted it into the application. <br><br>  The first thing we did was choose the game Angry Birds.  We chose it not because it is a very good game, but because of its popularity.  Our SpyPhone module can be entered into absolutely any application.  First of all, we need a copy of the original .apk file.  This is an archive containing all the components of the application.  Inside the application file is Java code, or rather, not quite Java ‚Äî this is the code for the Dalvik virtual machine to work.  This code can be replaced with other content, this is called a master key vulnerability.  So, we have to open this .apk file and disassemble it, that is, have a list of all the components to be disassembled. <br>  So, first of all, we extract all the components of the Angry Birds 2000 application. <br><br><img src="https://habrastorage.org/webt/jn/-q/hr/jn-qhrdpn4wnuagyq5qc9e3ijhu.jpeg"><br><br>  Then we insert our example / android / droidwhisper directory into the smali directory, and it is in the final droidwhisper folder that we find the modified files of the Searchable dictionary application containing our spyware module. <br><br><img src="https://habrastorage.org/webt/yw/ia/tz/ywiatzuo8p6m4ljxd-w62lqbkz4.jpeg"><br><br>  We downloaded the Angry Birds game from the Google Play Market and made a copy of it.  The next thing we‚Äôre worried about is signature keys.  All these files you see in our directory called inject. <br><br>  During the disassembly process, we used Apk_tools, a tool for managing .apk files.  Now, using the command line, I show how we proceeded to disassembling Angry Birds. <br><br><img src="https://habrastorage.org/webt/lr/nl/ez/lrnlezy_e4ablfcgfp3akq8oyrw.jpeg"><br><br>  Then we started directly disassembling the application.  We created the Angry Birds directory where we inserted all the components of the application.  Since this is a demo, you have to wait a bit until the disassembly process is over.  So, you see rad catalogs, the assets folder is located first, there are such things as sounds, then there are resourses folders, lib libraries, but the key is the smali directory, which contains the code and the assembly language format. <br><br>  23:00 min <br><br>  <a href="https://habr.com/company/ua-hosting/blog/434054/">BLACK HAT conference.</a>  <a href="https://habr.com/company/ua-hosting/blog/434054/">How to make a spy phone.</a>  <a href="https://habr.com/company/ua-hosting/blog/434054/">Part 2</a> <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/h98KtUgUOsg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Thank you for staying with us.  Do you like our articles?  Want to see more interesting materials?  Support us by placing an order or recommending to friends, <b>30% discount for Habr users on a unique analogue of the entry-level servers that we invented for you:</b> <a href="https://habr.com/company/ua-hosting/blog/347386/">The whole truth about VPS (KVM) E5-2650 v4 (6 Cores) 10GB DDR4 240GB SSD 1Gbps from $ 20 or how to share the server?</a>  (Options are available with RAID1 and RAID10, up to 24 cores and up to 40GB DDR4). <br><br>  <b>VPS (KVM) E5-2650 v4 (6 Cores) 10GB DDR4 240GB SSD 1Gbps until January free of charge</b> if you pay for a period of six months, you can order <a href="https://ua-hosting.company/vpsnl">here</a> . <br><br>  <b>Dell R730xd 2 times cheaper?</b>  Only we have <b><a href="https://ua-hosting.company/serversnl">2 x Intel Dodeca-Core Xeon E5-2650v4 128GB DDR4 6x480GB SSD 1Gbps 100 TV from $ 249</a> in the Netherlands and the USA!</b>  Read about <a href="https://habr.com/company/ua-hosting/blog/329618/">How to build an infrastructure building.</a>  <a href="https://habr.com/company/ua-hosting/blog/329618/">class c using servers Dell R730xd E5-2650 v4 worth 9000 euros for a penny?</a> </div><p>Source: <a href="https://habr.com/ru/post/434052/">https://habr.com/ru/post/434052/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../434040/index.html">Digest of ITMO University: we talk about the projects of the university, the successes and achievements of our graduates</a></li>
<li><a href="../434044/index.html">Two-factor authentication (2FA) resistant to phishing</a></li>
<li><a href="../434046/index.html">GLSL: Center or centroid? Or when shaders attack</a></li>
<li><a href="../434048/index.html">Facebook develops cryptocurrency for WhatsApp</a></li>
<li><a href="../434050/index.html">Java Enterprise vs Android in 2019 - what to choose a newbie?</a></li>
<li><a href="../434054/index.html">BLACK HAT conference. How to make a spy phone. Part 2</a></li>
<li><a href="../434056/index.html">Need to know where to put zero</a></li>
<li><a href="../434058/index.html">A technical presentation of the new SpaceX spacecraft Starship / BFS from SpaceX is planned in March-April 2019</a></li>
<li><a href="../434060/index.html">Should I save the length of the array to a local variable in C #</a></li>
<li><a href="../434062/index.html">Amazon sent Alexa's 1,700 audio recordings to a random person.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>