<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The Adventures of the Elusive Malvar, Part III: Intricate VBA Scripts for Laughter and Gain</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is part of the Fileless Malware series. All other parts of the series: 



- The Adventures of the Elusive Malvar, Part I 
- The Adventur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The Adventures of the Elusive Malvar, Part III: Intricate VBA Scripts for Laughter and Gain</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/d7/wm/qw/d7wmqwc9d8lggs8ryalumg3ivrm.png"><br><br>  This article is part of the Fileless Malware series.  All other parts of the series: <br><br><ul><li>  <a href="https://habr.com/ru/company/varonis/blog/456440/">The Adventures of the Elusive Malvar, Part I</a> </li><li>  <a href="https://habr.com/ru/company/varonis/blog/458010/">The Adventures of the Elusive Malvari, Part II: Secretive VBA Scripts</a> </li><li>  The Adventures of the Elusive Malvari, Part III: Intricate VBA Scripts for Laughter and Profit (We're Here) </li></ul><br>  In the last two posts ( <a href="https://habr.com/ru/company/varonis/blog/456440/">here</a> and <a href="https://habr.com/ru/company/varonis/blog/458010/">here</a> ) we talked about fileless, but quite harmless methods of attack.  Now we are finally ready to take on real fileless hardware.  The <a href="https://www.hybrid-analysis.com/">hybrid analysis</a> site (hereinafter referred to as HA) is the resource I rely on to find these malicious "creatures."  Typically, the information that HA provides for each sample: system calls, Internet traffic, etc.  - enough to satisfy typical IT security requirements.  I am inexorably drawn to plunge into one of these highly entangled code samples to see what is actually happening there. <br><a name="habracut"></a><br>  If you want to repeat after me, then I recommend that you do this in a sandbox, for example, in Amazon Web Services.  And if you check it on your computer, do not forget to comment out the system calls that launch PowerShell. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Inside the confusing VBA code </h2><br>  The malware I eventually found on the hybrid analysis site is a VBA script that was embedded in a Word document.  As I mentioned last time, in order to see the actual code, you will need Frank Baldwin's <a href="http://www.reconstructer.org/main.html">OfficeMalScanner</a> . <br>  After extracting the script, I loaded the code into the MS Word macro library, and then launched its step-by-step debugging using the built-in debugger.  My goal was to better understand what was hidden behind obfuscation: to play in the information security analyst and to experience the successes and frustrations associated with this work. <br><br>  If you, like me, first decided to do this in the debugger, then most likely you will drink more than one cup of tea (or coffee), making your way through the breathtakingly complex code or watching the variable L_JEK, which is assigned the string "77767E6C797A6F6" . <br>  Working with this confusing VBA script, I realized that only a very <i>small</i> part of it does a good job.  Most of the code is there only to lead you astray. <br>  In the end, I took a screenshot of a small piece of code that does all the evil work of starting the PowerShell command line, which eventually runs on the VBA macro. <br><br><img src="https://habrastorage.org/webt/ga/6i/of/ga6iofetd7knuemnp840w7yj8kg.jpeg"><br><p>  <i>Slyly: just take the hex value and subtract 7 for real ASCII.</i> </p><br>  It is very simple.  VBA code contains a summary of the command line in hexadecimal representation in several variables, and then simply converts it to a character string.  The only snag here was that the hexadecimal values ‚Äã‚Äãwere shifted to 0x07.  So, for example, the first part of a hexadecimal string is obtained from L_JEK, which was assigned the value "77767E6C797A6F6".  If you take 0x77 and subtract 0x07, you get hex 0x70.  Do the same for 0x76 and you will get hex 0x6F.  Look at them in any ASCII code table, and you will see that it corresponds to the first two letters of ‚Äúpowershell‚Äù. <br><br>  In fact, this is not the most difficult confusing, but this is not required!  All you need to do is skip past antivirus scanners looking for specific keywords or their representations in the form of ASCII strings.  That this pattern is good enough and does.  Finally, after the script recreates the command line, it runs it through the CreateProcess function (see below): <br><br><img src="https://habrastorage.org/webt/l6/ef/44/l6ef44p-f-k1kyxnhb-68nr4rh4.jpeg"><br><p>  <i>Comment out system calls or set a breakpoint in front of them.</i> </p><br>  Think about it for a second.  A Word document was sent to an employee in a phishing email.  When opening a document, this VBA script automatically starts a PowerShell session to start the next stage of the attack.  No executable files, and obfuscated scripts quietly shy away from antivirus and other scanners. <br><br>  Here it is Evil! <br><br>  For the sake of curiosity, I downloaded another macro from the HA site (below) to see what else happens.  This second code does roughly the same as the one above. <br><br><img src="https://habrastorage.org/webt/jk/ze/pg/jkzepgkpjqmjjvhx3ibylk1xyt4.jpeg"><br><p>  <i>Secret code embedded in VBA.</i> </p><br>  But this code is a bit more inventive in how it restores the command line.  There is a decoding function, called ‚Äúd,‚Äù which filters out characters from the base line, comparing them with the second control line.  This is already the idea of ‚Äã‚Äãa high school level, and it also does its job perfectly: it easily evades from scanners and deceives admins who only glance at the logs for unusual actions. <br><br><h2>  Next stop </h2><br>  In my series of first publications on <a href="https://www.varonis.com/blog/powershell-obfuscation-stealth-through-confusion-part-i/">obfuscation,</a> I showed that the Windows event log records quite a lot of details from PowerShell sessions, that is, if you enable the appropriate settings to be able to perform in-depth analysis after the <i>fact of hacking</i> . <br><br>  Of course, this also has a certain complexity of fileless attacks, since it is almost impossible to determine if a PowerShell script does something bad by simply checking the commands there while viewing security log events. <br><br>  Why, you ask? <br><br>  Because PowerShell sessions run all the time, and the evil code from a PowerShell session of a single hacker can be run at the same time as the legitimate code from a respectable IT administrator from PowerShell.  If notifications come to you every time the PS script downloads something from the Internet, too many false positive positives will be generated. <br><br>  <strong>The conclusion</strong> can be drawn as follows: we see the inability of traditional perimeter defenses to stop such attacks, phishing scams and FUD malware, and great promise for <a href="https://sites.varonis.com/ru/user-behavior-analytics">behavioral analytics tools</a> . <br><br>  In short, this is a losing battle to try to stop hackers from entering the perimeter.  The best strategy is to identify unusual and suspicious access to files and launch applications, and then respond to them by deactivating accounts or taking another measure in response to a violation. <br><br>  In the next section, we will look at more advanced types of fileless attacks. </div><p>Source: <a href="https://habr.com/ru/post/459506/">https://habr.com/ru/post/459506/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459498/index.html">Slurm - an easy way to break into the Kubernetes topic</a></li>
<li><a href="../4595/index.html">Web 3.0 will stir up human civilization</a></li>
<li><a href="../459500/index.html">HTML is the web</a></li>
<li><a href="../459502/index.html">We continue to develop an adventure platform for Russians: interface features and summer preferences</a></li>
<li><a href="../459504/index.html">Young Game Designer Course: How to count the balance of characters and equipment without mathematics</a></li>
<li><a href="../459508/index.html">5 slides that are ignored by experienced presenters</a></li>
<li><a href="../459514/index.html">.NET: Tools for working with multithreading and asynchrony. Part 2</a></li>
<li><a href="../459518/index.html">Explanation of a Python task with a job interview</a></li>
<li><a href="../45952/index.html">Online Counseling Systems Review</a></li>
<li><a href="../459520/index.html">Model of the natural series of numbers and its elements. Diamonds</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>