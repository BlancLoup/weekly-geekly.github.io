<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sewing DB2 JDBC under .NET</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In a very strange time, we live. NET becomes cross-platform, JAVA becomes sweeter. But while we are moving together towards a common bright future, th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sewing DB2 JDBC under .NET</h1><div class="post__text post__text-html js-mediator-article">  In a very strange time, we live. NET becomes cross-platform, JAVA becomes sweeter.  But while we are moving together towards a common bright future, there are many inherited solutions that need to be supported.  And while this is possible with a jigsaw and file ... <br><a name="habracut"></a><br><h3>  Before </h3><br>  Currently, the driver supports only the functionality that is needed in our projects.  You can always join the project <a href="">Wintegra.Data</a> <br><br><h3>  Story </h3>  (for impatient, you can immediately go to the item <a href="https://habr.com/ru/post/303878/">Pilim</a> ) <br><br>  Although lately, relational databases are somehow not in the hype and give everyone CAP systems - fast, convenient, sometimes consistent and scalable.  And yet, Interprize lives on old and proven solutions, one of which is the Blue Giant database ‚Äî IBM and its name is <a href="https://en.wikipedia.org/wiki/IBM_DB2">DB2</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Moderately fast, reliable, no worse and no better than Oracle and MS SQL.  There is something, there is something, but in general SQL supports notation (although it didn‚Äôt do without offense at dogs @) <br><br>  IBM supplies an ODBC driver to work with its base for .NET, which is not bad in general, but uses a small native code cart. <br><br>  On the other hand, under JAVA there is a fully working driver without any use of third-party dll, its name is JCC (JDBC 4.0 Driver (db2jcc4.jar)). <br><br>  And it's not clear what prevents IBM from implementing the ‚Äúright‚Äù diver for .NET. <br><br>  Since the .NET Core is not far off, and rewriting tons of code under JAVA with C # looks more than strange, then why not kill two birds with one stone - leave the code, and use the JDBC driver. <br><br>  First we will use <a href="https://ru.wikipedia.org/wiki/IKVM.NET">IKVM.NET</a> to convert jar to dll and use it in .NET.  The author claims that you can safely run <a href="http://weblog.ikvm.net/2014/12/01/RunningMinecraftOnIKVMNET.aspx">Minecraft</a> .  So the JDBC driver did not cause any problems. <br><br>  Create the necessary library simply by running the command: <br><br><pre><code class="bash hljs">ikvmc.exe -classloader:ikvm.runtime.AppDomainAssemblyClassLoader -target:library db2jcc4.jar db2jcc_license_cu.jar -out:db2jcc4.dll</code> </pre> <br>  Now all we need is to connect the created dll to our solution and use it. <br><br><div class="spoiler">  <b class="spoiler_title">Java code in .NET</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> com.ibm.db2.jcc; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> java.sql; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Thread = java.lang.Thread; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Class = java.lang.Class; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> String = System.String; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Connection = java.sql.Connection; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Statement = java.sql.Statement; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> DriverManager = java.sql.DriverManager; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ResultSet = java.sql.ResultSet; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">jdbc</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { Class.forName( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(com.ibm.db2.jcc.DB2Driver).AssemblyQualifiedName, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, Thread.currentThread().getContextClassLoader()); String url = <span class="hljs-string"><span class="hljs-string">"jdbc:db2://192.168.72.135:50000/DB1:user=root;password=password;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Connection conn = DriverManager.getConnection(url)) { String sql = <span class="hljs-string"><span class="hljs-string">"SELECT * FROM TABLE(VALUES( CAST( :p AS VARCHAR(100)) , 'It is work')) AS T(ID, LOG)"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stmt = conn.prepareCall(sql)) { stmt.setString(<span class="hljs-string"><span class="hljs-string">"p"</span></span>,<span class="hljs-string"><span class="hljs-string">"1234"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (ResultSet rs = stmt.executeQuery()) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (rs.next()) { <span class="hljs-comment"><span class="hljs-comment">//Retrieve by column name String id = rs.getString("ID"); String log = rs.getString("LOG"); global::System.Console.WriteLine("LOG: " + id + " : " + log); } } } } } } }</span></span></code> </pre><br></div></div><br>  However, I don‚Äôt think that .NET developers will appreciate the syntax in the form of java.lang. *, But recalling inherited projects that explicitly run at least on top of IDbConnetion and often through <a href="https://en.wikipedia.org/wiki/Dapper_ORM">Dapper</a> , our result can be interesting only as an optional entertainment. <br><br><a name="Description"></a><h3>  Sawing </h3><br>  Having prepared a jigsaw and a file, we will make our bike, as far as we need it. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Db2Connection</span></span> : <span class="hljs-title"><span class="hljs-title">DbConnection</span></span>, <span class="hljs-title"><span class="hljs-title">ICloneable</span></span></code> </pre><br>  It is quite enough to create a connection and work Dapper. <br><br><div class="spoiler">  <b class="spoiler_title">Db2connection</b> <div class="spoiler_text">  <b>A bit of magic from the world of JAVA</b> <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Db2Connection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Class.forName( <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(com.ibm.db2.jcc.DB2Driver).AssemblyQualifiedName, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, Thread.currentThread().getContextClassLoader()); }</code> </pre><br>  We load the JDBC driver, almost the same as in JAVA as <br><br><pre> <code class="java hljs">Class.forName(<span class="hljs-string"><span class="hljs-string">"com.ibm.db2.jcc.DB2Driver"</span></span>);</code> </pre><br>  <b>Database connection</b> - one to one of JAVA: <br><br><pre> <code class="cs hljs">connector = DriverManager.getConnection(_connectionString);</code> </pre><br>  It should be noted that the connection string is the same as in JDBC (although, if necessary, you can use Db2ConnectionStringBuilder to set your own or ODBC-compatible parameters). <br><br><pre> <code class="cmake hljs">jdbc:db2://<span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">72.135</span></span>:<span class="hljs-number"><span class="hljs-number">50000</span></span>/DB1:currentSchema=DB01;user=root;password=password;fullyMaterializeLobData=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>;DB2NETNamedParam=<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br>  Connection to the server, port, database, scheme, login and password.  For customization, you can look at the Blue Giant website <a href="http://www.ibm.com/support/knowledgecenter/en/SSEPEK_10.0.0/com.ibm.db2z10.doc.java/src/tpc/imjcc_r0052342.html">URL format for the IBM Data Server Driver for JDBC and SQLJ type 4 connectivity</a> . <br><br>  Like everything that could be interesting ... <br></div></div><br>  To bring benefits to the database, we need commands; we need to do it: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Db2Command</span></span> : <span class="hljs-title"><span class="hljs-title">DbCommand</span></span>, <span class="hljs-title"><span class="hljs-title">ICloneable</span></span></code> </pre><br>  Where I had to tinker with it so Dapper. <br><br><div class="spoiler">  <b class="spoiler_title">Db2command</b> <div class="spoiler_text">  <b>Dapper stubbornly replaces the parameter: XML_BODY of the XmlDocument type</b> with an indistinct (: XML_BODY1,: XML_BODY2) - I had to write a non-complex regular. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Regex(<span class="hljs-string"><span class="hljs-string">@"\(:(?&lt;n&gt;\w+)\d+,:\1\d+\)"</span></span>);</code> </pre><br>  Although yes, it was possible to file TypeHandler, for the curious <a href="http://www.codegur.site/32991877/dapper-ulong-throwing-system-argumentexception">Dapper - ulong throwing System.ArgumentException</a> .  But first, the wrapper on ODBC already worked with an XmlDocument, and second, the use of the magic commands of the form, at the beginning of the application: <br><br><pre> <code class="cs hljs">SqlMapper.AddTypeHandler(DapperULongHandler.Default);</code> </pre><br>  always fraught with errors. <br><br><h3>  Magic method number of times </h3><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> CallableStatement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PrepareExecute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Db2Connection connection, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> query, Db2ParameterCollection parameters</span></span></span><span class="hljs-function">)</span></span></code> </pre><br>  Returns a query prepared for execution. <br><br>  The explanation of using prepareCall ( <i>CallableStatement</i> ) in the place prepareStatement ( <i>PreparedStatement</i> ) deserves special attention.  The use of positional parameters is simpler, but in some cases it is not convenient; the use of named parameters requires some additional work, which reduces the speed quickly and increases the complexity of the code.  The preference was given to the named parameters, since with them it is easier to debug the requests going to the server and gives a bonus in the case when a multi-request is executed. <br><br>  For his magic uses the other two. <br><br><h3>  Magic method number two </h3><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PrepareCommandText</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> query, Db2ParameterCollection parameters, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> parameter</span></span></span><span class="hljs-function">)</span></span></code> </pre><br>  Replaces positional parameters with named ones. <br><br>  Dapper's little hoax cost as much as two goto.  And although it was possible to do without them, the solution is simple and left as satisfactory. <br><br>  <i>ref int parameter</i> - needed for Db2DataReader and implementation of multi queries. <br><br><h3>  Last magic method </h3><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PrepareParameters</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CallableStatement stmt, Db2ParameterCollection parameters</span></span></span><span class="hljs-function">)</span></span></code> </pre><br>  Sets the parameters. <br><br>  A weighty if and calling the set of methods stmt.setXXX (name, <br></div></div><br>  For commands, parameters are needed: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Db2ParameterCollection</span></span> : <span class="hljs-title"><span class="hljs-title">DbParameterCollection</span></span>, <span class="hljs-title"><span class="hljs-title">IList</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Db2Parameter</span></span>&gt;</code> </pre><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Db2Parameter</span></span> : <span class="hljs-title"><span class="hljs-title">DbParameter</span></span>, <span class="hljs-title"><span class="hljs-title">ICloneable</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">Db2parameter</b> <div class="spoiler_text">  <b>For Dapper,</b> you need to conjure a little over the method: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> DbType DbType</code> </pre><br>  since it is used for type casting, otherwise we implement the interface. <br><br>  And you need to be very careful about the method: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Clone</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span></code> </pre><br>  As we need to create copies of parameters at multi requests. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Db2ParameterCollection</b> <div class="spoiler_text">  It deserves attention only because of the presence of a small optimization of the method: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IndexOf</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> parameterName</span></span></span><span class="hljs-function">)</span></span></code> </pre>  otherwise nothing substantial. <br></div></div><br>  And at the end: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Db2DataReader</span></span> : <span class="hljs-title"><span class="hljs-title">DbDataReader</span></span></code> </pre><br>  Implementing multi query through JDBC. <br><br><div class="spoiler">  <b class="spoiler_title">Db2DataReader</b> <div class="spoiler_text">  Perhaps this is not the best solution, but why not. <br><br>  <b>First</b> , you need to split the query into subqueries.  No surprises simple regular expression <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Regex(<span class="hljs-string"><span class="hljs-string">@"(?&lt;q&gt;[^;]+);?"</span></span>);</code> </pre><br>  <b>Secondly</b> , it is necessary to prepare for each of the subqueries its own set of parameters.  Take advantage of <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Regex(<span class="hljs-string"><span class="hljs-string">@"(?&lt;n&gt;:\w+)"</span></span>);</code> </pre>  and the familiar Db2Command.PrepareCommandText method for replacing positional parameters with their named parameters (as a bonus: Dapper can properly work on named parameters in multi queries). <br><br>  <b>Thirdly</b> , a small hack in public override bool NextResult (), to move from one command to the next. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b = _statement.getMoreResults(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (b) { _rs = _statement.getResultSet(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _statement = PrepareStatementAndResultSet(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_statement != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _rs = _statement.executeQuery(); b = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre><br></div></div><br><h3>  Results </h3><br>  Of course, the project is not completed yet, but in the future there is a desire to replace the shell implementation above db2jcc4.jar with a ‚Äúnormal‚Äù driver implementation under .NET without any extra squats. <br><br>  What may be needed? <br><br>  Well, firstly, you can not put the ODBC driver on the user's machine, although yes you will not win in volume. <br>  Secondly, you can slowly move your backend to linux from mono.  Which is very convenient with a little <a href="https://ru.wikipedia.org/wiki/Docker">Docker</a> whisper <br><br>  And of course, not much for the fan, may the complex request come with you: <br><br><div class="spoiler">  <b class="spoiler_title">SELECT</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> r.ID , r.INCOME , r.GU_CODE <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> GuCode , r.NO <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> , r.DIVISION , d.NAME <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DivisionName , u.LNAME || <span class="hljs-string"><span class="hljs-string">' '</span></span> || u.FNAME || nvl(<span class="hljs-string"><span class="hljs-string">' '</span></span> || u.MNAME, <span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CreaterName , r.SIGNED , r.SIGNED_SYSUSER_ID <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> SignedID , su.LNAME || <span class="hljs-string"><span class="hljs-string">' '</span></span> || su.FNAME || nvl(<span class="hljs-string"><span class="hljs-string">' '</span></span> || su.MNAME, <span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> SignedName <span class="hljs-comment"><span class="hljs-comment">--, (select count(*) from PACK_ENTRY p where p.REGISTRY_ID = r.ID) as PackCount -- Use C# code --, (select count(*) -- from PACK_ENTRY p -- join FILE_ENTRY f on f.PACK_ID=p.ID -- where p.REGISTRY_ID = r.ID) as FileCount -- Use C# code -- TODO 2016-04-13 emiya:  .      REGISTRY_ENTRY , (select p.CLOSE_DATE from PACK_ENTRY p join REGISTRY_TO_PACK p2p on p2p.REGISTRY_ID = r.ID and p2p.PACK_ID = p.ID order by p.INCOME fetch first 1 rows only) as CloseDate , (select p.CATEGORY_ID from PACK_ENTRY p join REGISTRY_TO_PACK p2p on p2p.REGISTRY_ID = r.ID and p2p.PACK_ID = p.ID order by p.INCOME fetch first 1 rows only) as CategoryCode , (select l.SHORTNAME from PACK_ENTRY p join CATEGORY_LIST l on l.ID = p.CATEGORY_ID join REGISTRY_TO_PACK p2p on p2p.REGISTRY_ID = r.ID and p2p.PACK_ID = p.ID order by p.INCOME fetch first 1 rows only) as CategoryName , p2p.REGISTRY_ID , p.ID , p.INCOME , p.CLOSE_DATE as CloseDate , p.CATEGORY_ID as CategoryCode , l.SHORTNAME as CategoryName , p.GU_CODE as GuCode , p.NO , p.DIVISION , p.SYSUSER_ID as SysUserID , (select count(*) from FILE_ENTRY where PACK_ID = p.ID) as Count , r.SIGNED , p.PLACE , p2p.STATUS , p2p.NOTE from REGISTRY_ENTRY r join DIVISION d on d.CODE=r.DIVISION join SYSUSER u on u.ID=r.SYSUSER_ID LEFT JOIN SYSUSER su ON su.ID=r.SIGNED_SYSUSER_ID join REGISTRY_TO_PACK p2p on p2p.REGISTRY_ID = r.ID join PACK_ENTRY p on p.ID = p2p.PACK_ID join CATEGORY_LIST l on l.ID = p.CATEGORY_ID WHERE r.ID=? AND @DIVISION order by r.ID,p.GU_CODE,p.NO</span></span></code> </pre><br></div></div><br>  Link to the package in <a href="https://www.nuget.org/packages/Wintegra.JDBC/">NuGet</a> . </div><p>Source: <a href="https://habr.com/ru/post/303878/">https://habr.com/ru/post/303878/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303866/index.html">We work with Azure IoT devices from UWP applications</a></li>
<li><a href="../303868/index.html">Report with Symfony Moscow Meetup June 2</a></li>
<li><a href="../303870/index.html">How to build a multivoron using the example of Mailchimp and Google Analytics and optimize it</a></li>
<li><a href="../303874/index.html">Moscow Exchange became the first Russian financial organization to participate in the international blockchain consortium</a></li>
<li><a href="../303876/index.html">Apple fixed a serious vulnerability in its AirPort routers</a></li>
<li><a href="../303880/index.html">Kirill "isox" Yermakov, chief security officer of QIWI, talks about his work, about black, about anonymity and about adult information security.</a></li>
<li><a href="../303882/index.html">PyCon 2016 in Portland: video of all important reports and master classes</a></li>
<li><a href="../303884/index.html">How could Jack Ma fix the main mistake of his life?</a></li>
<li><a href="../303886/index.html">Siri integration or ‚ÄúThat's what I managed to find in your application‚Äù</a></li>
<li><a href="../303888/index.html">3DO and Android NDK and how not to get into anything ...</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>