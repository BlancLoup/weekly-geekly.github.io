<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>“Dense_rank ()” vs “Max ()” or an investigation with an unexpected end</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello colleagues. 
 In this article I will talk about my research in the question: "And what is better: dense_rank () or max ()" and, of course, why t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">🔎</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">📜</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">⬆️</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">⬇️</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>“Dense_rank ()” vs “Max ()” or an investigation with an unexpected end</h1><div class="post__text post__text-html js-mediator-article">  Hello colleagues. <br>  In this article I will talk about my research in the question: "And what is better: dense_rank () or max ()" and, of course, why this research ended with an unexpected, at least for me, result. <br><a name="habracut"></a><br><h5>  Background: </h5><br>  So there were stars that I need to look for work now.  Before each interview I study the company to which I was invited, in order to understand what the company does, what I will learn if I get an offer, etc.  And so, at one fine moment, I received an invitation for an interview, for the position of a PL / SQL developer, from one excellent company.  After reading about it, it seemed to me that I was in love and I want to work there.  When I came to the interview itself and at that moment when everything was ready for the interview, but it had not yet begun simply because people were getting to know each other, hr offers coffee, etc., I already knew that I wanted, I really want to, here work. <br><br>  For all the interviews with the team leader, I was once offered to write a simple request, otherwise everything took place in the mode: question-answer. <br><br>  The challenge sounded like this: <br>  “We have a table of operations, it has 4 columns: the operation id, the client id, the date of the operation, the amount of the operation.  It is necessary to withdraw the last transactions for each client with the maximum amount for a certain period. " 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And I, of course, began frantically to think how to write so that it was beautiful and effective.  And besides oracle, I also worked with a teradata and at that moment my brain issued the following request: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/*id  - oper_id, id  - client_id,   - input_date,   - amount*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.* , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(t.amount) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> t.client_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m_a <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> some_table t qualify oper_id = <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(t.oper_id) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> t.client_id) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> m_a = amount</code> </pre> </div></div>  And in the case of the cheater, this would work, but not with the Oracle, alas.  And clearly remembering that there is no “qualify” in the oracle, I wrote on a piece of paper something like: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> some_table t <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> amount = <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(t.oper_id) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> t.client_id)</code> </pre></div></div><br><br>  To which I was asked a question: “Why was max () used instead of dense_rank ()?”, I don’t remember what I said exactly, but it sounded like this: “I used max () more often and I can, more or less Exactly, imagine what he will return to me, unlike dense_rank (). ”  I will not describe the interview further; I will only say that I, of course, were refused.  Later, at home, in trying to analyze everything and understand the mistakes, I came to the conclusion that I wanted to work too hard and I was worried, otherwise I cannot explain the mess in my head during the interview.  It was something akin to the feeling when a schoolboy tries to talk to a girl whom he secretly loves even from kindergarten, but these attempts more and more embarrass him.  Similarly, I, trying to look calm and adequate, showed myself as a worthless specialist.  In general, I decided for myself to find out that it is better to use dense_rank () or max () when solving this problem. <br><br><h5>  Study </h5><br>  If you want to see with my own eyes everything that I write and touch it all with my own hands - I have prepared a set of data creation scripts for the test: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/* */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> habr_test_table_220414 ( oper_id <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, client_id <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, input_date <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>, amount <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> habr_test_table_220414_pk primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (oper_id) ); <span class="hljs-keyword"><span class="hljs-keyword">grant</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> habr_test_table_220414 <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* ,   oper_id   -  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> habr_test_sequence_220414 <span class="hljs-keyword"><span class="hljs-keyword">increment</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">grant</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> habr_test_sequence_220414 <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* ,     ,    oper_id    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> habr_test_trigger_220414 <span class="hljs-keyword"><span class="hljs-keyword">before</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> habr_test_table_220414 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> :new.oper_id := habr_test_sequence_220414.nextval; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*           */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     ,     10- */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* ,     cost = 3,   20000 ,    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   -          counter */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> counter <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> := <span class="hljs-number"><span class="hljs-number">10000</span></span>; i number := 0; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> habr_test_table_220414 ( client_id , input_date , amount ) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> ( trunc (dbms_random.value (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>)) , <span class="hljs-keyword"><span class="hljs-keyword">to_date</span></span>(trunc(dbms_random.value(to_char(<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'2013-01-01'</span></span>,<span class="hljs-string"><span class="hljs-string">'j'</span></span>),to_char(<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'2013-12-31'</span></span>,<span class="hljs-string"><span class="hljs-string">'j'</span></span>))),<span class="hljs-string"><span class="hljs-string">'j'</span></span>) , trunc (dbms_random.value (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">100000</span></span>)) ); exit when (i = counter); i := i + 1; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   ,         */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  :*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> habr_test_table_220414 <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> habr_test_table_220414; <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   id   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre> </div></div><br><br>  So, the test data is created, it’s time to proceed to the actual queries.  In order not to cut off our 20,000 lines, we will not limit our sample to any specific period, it’s important for us to understand which method is better and more efficient, and <pre> <code class="sql hljs">where input_date between to_date('01.01.2013','dd.mm.yyyy') and to_date('01.05.2013','dd.mm.yyyy')</code> </pre>  we can add and then. <br><br><div class="spoiler">  <b class="spoiler_title">Request using max ()</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.* , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(c.oper_id) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> c.client_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m_o<span class="hljs-comment"><span class="hljs-comment">/*max_operation*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.* , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(t.amount) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> t.client_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m_a<span class="hljs-comment"><span class="hljs-comment">/*max_amount*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> habr_test_table_220414 t ) c <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> c.m_a = c.amount ) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> m_o = oper_id;</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Request using dense_rank ()</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.* , <span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> c.client_id <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> c.oper_id <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m_o<span class="hljs-comment"><span class="hljs-comment">/*max_operation*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.* , <span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> t.client_id <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> t.amount <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m_a<span class="hljs-comment"><span class="hljs-comment">/*max_amount*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> habr_test_table_220414 t ) c <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> c.m_a = <span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> m_o = <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> </div></div><br><br>  Preliminary plans for these queries (obtained in pl / sql developer): <br><br>  Max: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/687/044/819/6870448191c492151933e633f7597f4a.png" alt="image"></div></div><br>  Dense_rank: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/414/2ff/f82/4142fff8297a649af85eab30e6d83364.png" alt="image"></div></div><br><br>  But these are preliminary plans; we’ll get real plans with the help of the SQLTUNE utility: <br><br><div class="spoiler">  <b class="spoiler_title">Training:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/*   max()*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> my_task_name varchar2(<span class="hljs-number"><span class="hljs-number">30</span></span>);my_sqltext clob;rep_tuning clob; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Begin</span></span> DBMS_SQLTUNE.DROP_TUNING_TASK(<span class="hljs-string"><span class="hljs-string">'my_sql_tuning_task_max'</span></span>); exception when others then NULL; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; MY_SQLTEXT:= '<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.* , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(c.oper_id) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> c.client_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m_o<span class="hljs-comment"><span class="hljs-comment">/*max_operation*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.* , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(t.amount) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> t.client_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m_a<span class="hljs-comment"><span class="hljs-comment">/*max_amount*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> habr_test_table_220414 t ) c <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> c.m_a = c.amount ) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> m_o = oper_id<span class="hljs-string"><span class="hljs-string">'; MY_TASK_NAME:=DBMS_SQLTUNE.CREATE_TUNING_TASK(SQL_TEXT =&gt; my_sqltext, TIME_LIMIT =&gt; 60, --     TASK_NAME =&gt;'</span></span>my_sql_tuning_task_max<span class="hljs-string"><span class="hljs-string">', DESCRIPTION=&gt; my_task_name , SCOPE =&gt; DBMS_SQLTUNE.scope_comprehensive); begin DBMS_SQLTUNE.EXECUTE_TUNING_TASK('</span></span>my_sql_tuning_task_max<span class="hljs-string"><span class="hljs-string">'); exception when others then null; end; END; /*   dense_rank()*/ DECLARE my_task_name varchar2(30);my_sqltext clob;rep_tuning clob; BEGIN Begin DBMS_SQLTUNE.DROP_TUNING_TASK('</span></span>my_sql_tuning_task_dense<span class="hljs-string"><span class="hljs-string">'); exception when others then NULL; end; MY_SQLTEXT:= '</span></span><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.* , <span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> c.client_id <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> c.oper_id <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m_o<span class="hljs-comment"><span class="hljs-comment">/*max_operation*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.* , <span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> t.client_id <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> t.amount <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m_a<span class="hljs-comment"><span class="hljs-comment">/*max_amount*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> habr_test_table_220414 t ) c <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> c.m_a = <span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> m_o = <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">'; MY_TASK_NAME:=DBMS_SQLTUNE.CREATE_TUNING_TASK(SQL_TEXT =&gt; my_sqltext, TIME_LIMIT =&gt; 60, --     TASK_NAME =&gt;'</span></span>my_sql_tuning_task_dense<span class="hljs-string"><span class="hljs-string">', DESCRIPTION=&gt; my_task_name , SCOPE =&gt; DBMS_SQLTUNE.scope_comprehensive); begin DBMS_SQLTUNE.EXECUTE_TUNING_TASK('</span></span>my_sql_tuning_task_dense<span class="hljs-string"><span class="hljs-string">'); exception when others then null; end; END; /* ,              */ /* ,     */</span></span></code> </pre> </div></div>  and these real plans look like this: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DBMS_SQLTUNE.REPORT_TUNING_TASK(<span class="hljs-string"><span class="hljs-string">'my_sql_tuning_task_max'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DUAL;</code> </pre> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/56b/6e8/13a/56b6e813aaf84feb6a39d0bd8e2d3669.png" alt="image"><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DBMS_SQLTUNE.REPORT_TUNING_TASK(<span class="hljs-string"><span class="hljs-string">'my_sql_tuning_task_dense'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DUAL;</code> </pre> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/beb/32c/1e0/beb32c1e0669c362bbcaaf701198192c.png" alt="image"></div></div><br><br>  In addition to the real plan, SQLTUNE also gives recommendations on how to optimize the script, in our case it recommends collecting statistics, but since we have one tablet, the requests are in the same conditions. <br><br><h5>  Preliminary result </h5>  After all these manipulations, it is clear to me, as I hope you will, that when solving this task, max () works faster than dense_rank () 2 times and eats half the CPU time.  Well, it is understandable so, without plans and other things, because max () is just the search for the greatest, while dense_rank () is, first of all, sorting, and only then numbering. <br><br>  But it was not this that prompted me to write an article. <br><br><h5>  Suddenly </h5>  In the process of initial filling in the table for the test, I realized the scripts for the article, and for the first time everything happened almost in manual mode, and to check the condition of the experimental table, I used a query with <code>order by</code> . <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/*  10   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> habr_test_table_220414...; .... .... <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> habr_test_table_220414...; <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> habr_test_table_220414 t <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> t.client_id; <span class="hljs-comment"><span class="hljs-comment">/*    :*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> habr_test_table_220414 <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> habr_test_table_220414; <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> habr_test_table_220414 t <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> t.client_id; <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span></code> </pre></div></div>  After that, I modified this request to the final state “request with max ()”, without removing the <code>order by</code> . <div class="spoiler">  <b class="spoiler_title">Here's what happened:</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.* , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(c.oper_id) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> c.client_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m_o<span class="hljs-comment"><span class="hljs-comment">/*max_operation*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.* , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(t.amount) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> t.client_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m_a<span class="hljs-comment"><span class="hljs-comment">/*max_amount*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> habr_test_table_220414 t <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> t.client_id ) c <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> c.m_a = c.amount ) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> m_o = oper_id</code> </pre></div></div><br><br>  Later I wrote a “request with dense_rank ()” and started comparing plans, but noticing this ill-fated <code>order by</code> in the request with max (), deleted <code>order by</code> , but I saw the cost and remembered it.  And when I saw the cost in the request with max () without an <code>order by</code> very surprised, because: <br><br><div class="spoiler">  <b class="spoiler_title">Preliminary plan</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/198/d66/5b8/198d665b891a54e8d6a20e6a2c7fe0c0.png" alt="image"></div></div><div class="spoiler">  <b class="spoiler_title">SQLTUNE real plan</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/fd4/56f/f86/fd456ff864417a8cc4e0390a8780fd5c.png" alt="image"></div></div><br><br>  Anyway, to say that I was very surprised - to say nothing ... How did it happen?  Why <code>order by</code> speed the request 10 times faster?  Decided to find the answer in the trace.  I will not write exactly how to shoot the route in the Oracle, because this is a topic for a separate article, and articles describing this process are easy to find on the world wide web.  I will provide only a set of scripts with which I conducted a trace and a link to such an article, I found it for quite some time, since it has been helping me out: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">  <a href="http://www.sql.ru/faq/faq_topic.aspx%3Ffid%3D389">Link to article on enabling tracing</a> <pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> timed_statistics=<span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">session</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> tracefile_identifier=<span class="hljs-string"><span class="hljs-string">'test_for_habr_220414'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">session</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">events</span></span> <span class="hljs-string"><span class="hljs-string">'10046 trace name context forever, level 12'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.* , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(c.oper_id) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> c.client_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m_o<span class="hljs-comment"><span class="hljs-comment">/*max_operation*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.* , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(t.amount) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> t.client_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m_a<span class="hljs-comment"><span class="hljs-comment">/*max_amount*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> habr_test_table_220414 t <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> client_id ) c <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> c.m_a = c.amount ) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> m_o = oper_id; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">session</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">events</span></span> <span class="hljs-string"><span class="hljs-string">'10046 trace name context off'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> v$parameter p <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=<span class="hljs-string"><span class="hljs-string">'user_dump_dest'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*      tkprof*/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     'test_for_habr_220414'*/</span></span></code> </pre> </div></div>  In the track we are interested in a piece that describes the actions of the oracle when executing the request, namely: <div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> c.* , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(c.oper_id) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> c.client_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m_o<span class="hljs-comment"><span class="hljs-comment">/*max_operation*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.* , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(t.amount) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> t.client_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> m_a<span class="hljs-comment"><span class="hljs-comment">/*max_amount*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> habr_test_table_220414 t <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> client_id ) c <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> c.m_a = c.amount ) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> m_o = oper_id <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> cpu elapsed disk <span class="hljs-keyword"><span class="hljs-keyword">query</span></span> <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-comment"><span class="hljs-comment">------- ------ -------- ---------- ---------- ---------- ---------- ---------- Parse 1 0.01 0.00 0 1 0 0 Execute 1 0.00 0.00 0 0 0 0 Fetch 1 0.03 0.02 0 84 0 10 ------- ------ -------- ---------- ---------- ---------- ---------- ---------- total 3 0.04 0.03 0 85 0 10 Misses in library cache during parse: 1 Optimizer mode: ALL_ROWS Parsing user id: SYS Rows Row Source Operation ----- --------------------------------------------------- 10 VIEW (cr=84 pr=0 pw=0 time=28155 us cost=23 size=1592850 card=21525) 20 WINDOW BUFFER (cr=84 pr=0 pw=0 time=28145 us cost=23 size=1313025 card=21525) 20 VIEW (cr=84 pr=0 pw=0 time=21628 us cost=23 size=1313025 card=21525) 22010 WINDOW SORT(cr=84 pr=0 pw=0 time=24393 us cost=23 size=1033200 card=21525) 22010 TABLE ACCESS FULL HABR_TEST_TABLE_220414(cr=84 pr=0 pw=0 time=5172 us cost=23 size=1033200 card=21525)</span></span></code> </pre></div></div><br><br><h5>  Results </h5><br>  From here we see that both the preliminary and the real plans are not erroneous, there seems to be no dirty trick and one can rejoice at the tenfold acceleration.  Is it true? <br><br>  PS I could not answer this question and still do not believe that the request is really accelerated many times with the help of order by.  I will continue to try to find out this moment, to which I urge you.  And may the hidden secrets of oracle open before us! <br><br>  PPS Thank you all for your attention!  If you carried out a test with me, we don’t forget to clean the base behind you, especially if it is a bank of some kind. <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">trigger</span></span> habr_test_trigger_220414; <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> habr_test_sequence_220414; <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> habr_test_table_220414;</code> </pre> </div></div></div><p>Source: <a href="https://habr.com/ru/post/220455/">https://habr.com/ru/post/220455/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../220437/index.html">Full stack web developer</a></li>
<li><a href="../220445/index.html">PrintBox3d. 3d printer in Russian</a></li>
<li><a href="../220447/index.html">How in Russia they press businesses dealing with Bitcoin</a></li>
<li><a href="../220449/index.html">SIEM in practice: make friends with Prelude + Cisco IPS and identify the operation of HeartBleed through correlation</a></li>
<li><a href="../220451/index.html">Scientists from IBM have discovered an interesting physical phenomenon on the example of "nanowires" of semiconductors</a></li>
<li><a href="../220463/index.html">Style and new technologies in medicine: 3D printed tire</a></li>
<li><a href="../220465/index.html">Bra Analytics Tools: Hub Audience</a></li>
<li><a href="../220467/index.html">The third meeting of the Scala User Group in Moscow: the last day of registration!</a></li>
<li><a href="../220469/index.html">Scala 2.11.0 release</a></li>
<li><a href="../220471/index.html">Browser extension to extract text from images</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>