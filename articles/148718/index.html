<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Returning to multitasking in PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Write this article I was led by a completely depressing, in my opinion, the situation with the solution of multitasking in PHP. 
 Most programmers cla...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Returning to multitasking in PHP</h1><div class="post__text post__text-html js-mediator-article">  Write this article I was led by a completely depressing, in my opinion, the situation with the solution of multitasking in PHP. <br>  Most programmers claim that there is no multitasking in PHP, so do not even try, and the less blinkered still try to distort themselves by running a lot of scripts or, at best, they come up with some very private solutions for parallelizing downloads, for example. <br><br>  The article is intended to demonstrate the idea of ‚Äã‚Äãhow to actually implement multitasking in virtually any programming language. <br>  So say the proof of concept. <br>  As they say, everything new is well forgotten old. <br><a name="habracut"></a><br>  Although there is a complete implementation of this method, I will immediately warn you that I will not give a ready-made solution. <br>  What exactly is the problem of organizing multitasking in most programming languages ‚Äã‚Äãand in particular in PHP? <br><br>  Consider a simple example: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is required to write a function that waits for a certain time interval. <br><pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wait</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($delta)</span></span></span><span class="hljs-function"> </span></span>{ $time=microtime(<span class="hljs-number"><span class="hljs-number">1</span></span>)+$delta; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>($time &lt;= microtime(<span class="hljs-number"><span class="hljs-number">1</span></span>)) {} }</code> </pre> <br><br>  Everything is just like a rake, but a problem arises - this function will not return control until the specified time has elapsed. <br>  Now, if we could get out of the cycle, and then return there again ... <br>  In principle, it is possible to consider this function as a task, only the trouble is that two such tasks cannot be launched in parallel. <br>  What is the difference between the wait function and the wait task?  Essentially nothing. <br>  Any task can be written as one function, but then what makes a function a task? <br>  Right!  The task is an algorithm for processing EVENTS.  This is what actually makes function a task. <br>  And what does the task do most of the time?  Again, they guessed it - waiting for some kind of event.  So you need to figure out how to wait without waiting. <br>  What's the problem?  Let's look at it a little differently. <br><br>  In fact, any task can be represented as a finite state machine, and in this example, this machine has only 3 states. <br>  That's what we would need. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wait</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($delta)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>($state) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'init'</span></span>: $time=microtime(<span class="hljs-number"><span class="hljs-number">1</span></span>)+$delta; $state=<span class="hljs-string"><span class="hljs-string">'wait'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'wait'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($time &lt;= microtime(<span class="hljs-number"><span class="hljs-number">1</span></span>)) { $state=<span class="hljs-string"><span class="hljs-string">'exit'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'exit'</span></span>: <span class="hljs-comment"><span class="hljs-comment">//      //        case 'wait',     break; } }</span></span></code> </pre><br>  With this description it is clear that the function will return its control immediately and will not wait for anything. <br>  Suppose that the first time the function is called, it is always $ state = 'init'; <br>  If you regularly call this function, it will go through all its states, no matter how long <br>  she practically didn‚Äôt take time in any state of time, because she makes a very small number of operations with each call. <br><br>  It remains to solve the questions of how to initialize the $ state variable, how to save local variables between function calls, how to call this task, and how to stop its execution? <br><br>  Let's start with the call. <br>  let's get an array that will contain tasks for execution <br><pre> <code class="php hljs">$tasks=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>();</code> </pre> <br><br>  Then the creation of the task will be reduced to adding the necessary data to this array. <br>  For simplicity, we assume that the task will take only 1 parameter.  In fact, this is enough, although not very convenient. <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startTask</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($name,$param)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> $tasks; <span class="hljs-comment"><span class="hljs-comment">//          $t=array( 'name'=&gt;$name, 'param'=&gt;$param, 'local'=&gt;array('state'=&gt;'init',), //      'init' ); //     $tasks $tasks[]=$t; //  id  end($tasks); $id=key($tasks); return $id; } //         function task_end($id) { global $tasks; unset($tasks[$id]); } //         function poll() { global $tasks; foreach($tasks as $id=&gt;$p) { call_user_func($p['name'],$id,$p['param']); } } //     wait //          $id //         function wait($id,$delta) { global $tasks; $p=&amp;$tasks[$id]; $local=&amp;$p['local']; $state=&amp;$local['state']; switch($state) { case 'init': $local['time']=microtime(1)+$delta; $state='wait'; break; case 'wait': if($local['time'] &lt;= microtime(1)) { $state='exit'; } break; case 'exit': //      //        case 'wait',     task_end($id); break; } } //     $i=5; while($i--) { startTask('wait', mt_rand(10,100)/100); } //     wait    ,          //        while(count($tasks)) { poll(); //          //             usleep //           poll. usleep(10000); //  10  } echo 'done';</span></span></code> </pre> <br><br>  I want to note that by modifying $ tasks [$ id] ['name'] and $ tasks [$ id] ['param'], a task can <br>  to force in the next cycle to perform another function instead of the current one.  Those.  the function will be different, but the task will remain the same. <br><br>  Further development is possible towards more convenient functions for working with this mechanism. <br>  For example, there is no limit on the number of parameters to be passed, a call to another task as a subtask of the current task, etc., but I will leave the implementation of these mechanisms to interested readers. <br><br>  It all works just insanely fast. <br>  And I want to note that all the above-written is not a ready-made solution, but a purely demonstration of the approach itself. <br>  But its application opens up tremendous opportunities.  For example, the use of multi_curl or sockets designed as tasks allows you to run multiple parallel download tasks, each of which can have its own result handlers and its own logic for working with data, besides other tasks at the same time can do other things. <br><br>  You can write demons in PHP and even some hardware drivers. <br>  For example, in one of the projects, the daemon served several devices on COM ports, each of which had its own data exchange protocol, was a TCP server for external clients, acted as a client for the central server and implemented all the logic of managing a payment terminal and at the same time occupied only 3% processor resources. <br>  And all this was done by just one running script. <br><br>  With multitasking, it all becomes very simple to implement. <br><br>  There are cases when some kind of operation takes a lot (by the standards of the speed of other operations) time. <br>  Then it is advisable to run them as external processes, but at the same time still making out their launch and monitoring their execution as tasks. <br><br>  A demo showing the real work data of a similar example, <br>  located here <a href="http://tester.in/rt/task_test.php">http://tester.in/rt/task_test.php</a> . </div><p>Source: <a href="https://habr.com/ru/post/148718/">https://habr.com/ru/post/148718/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148708/index.html">New IP DECT from Grandstream DP715 / DP710</a></li>
<li><a href="../148711/index.html">Tool-assisted speedrunning</a></li>
<li><a href="../148712/index.html">The finalists of the Evernote Devcup 2012 Developer Championship are determined.</a></li>
<li><a href="../148715/index.html">Why computer vision is used very little in practice</a></li>
<li><a href="../148717/index.html">Heuristics in scheduling classes</a></li>
<li><a href="../148719/index.html">Opened CFP at ZeroNights 2012</a></li>
<li><a href="../148720/index.html">How masterhost for their mistakes "apologizes"</a></li>
<li><a href="../148721/index.html">Web architecture</a></li>
<li><a href="../148722/index.html">Denial: iPhone design has not been stolen from Sony</a></li>
<li><a href="../148723/index.html">Tariff "Free". Hacking a payphone at PHDays</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>