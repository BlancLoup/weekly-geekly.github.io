<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Introduction to IL2CPP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Unity continues to improve the IL2CPP technology, and we publish a translation of an article on how it works. 




 About a year ago we wrote about th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Introduction to IL2CPP</h1><div class="post__text post__text-html js-mediator-article"> Unity continues to improve the IL2CPP technology, and we publish a translation of an article on how it works. <br><br><img src="https://habrastorage.org/files/ab8/462/3aa/ab84623aa5e14738b0696c7e66a0048e.jpg"><br><a name="habracut"></a><br><br>  About a year ago we wrote <a href="http://blogs.unity3d.com/2014/05/20/the-future-of-scripting-in-unity/">about the future of scripting in Unity.</a>  The new scripting technology IL2CPP was supposed to provide the engine with a high-performance portable virtual machine.  In January, we released our first platform on <a href="http://blogs.unity3d.com/2015/01/29/unity-4-6-2-ios-64-bit-support/">64-bit iOS</a> , using IL2CPP.  With the release of Unity 5, another platform has appeared - <a href="http://blogs.unity3d.com/2014/04/29/on-the-future-of-web-publishing-in-unity/">WebGL</a> .  With the support of a huge community of users, we have released many patches and <a href="http://blogs.unity3d.com/2015/04/07/weekly-ios-64-bit-and-metal-update/">updates</a> for the IL2CPP, gradually optimizing the compiler and increasing the speed of the environment. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the meantime, we continue to improve the technology IL2CPP, it would be nice to talk about how it works.  We plan to write a series of articles on such topics: <br><br>  1. Basics - a set of tools and command line arguments (this article). <br>  2. Excursion on the generated code. <br>  3. Tips for debugging generated code. <br>  4. Method calls: ordinary methods, virtual methods and others. <br>  5. Implementation of the general exchange. <br>  6. P / Invoke wrappers for types and methods. <br>  7. Integrate the garbage collector. <br>  8. Testing and application of frameworks. <br><br>  In these articles we will discuss some features of the implementation of IL2CPP.  I hope this information is useful to you. <br><br>  <b>What is IL2CPP?</b> <br><br>  The IL2CPP technology consists of two parts: <br><br>  ‚Ä¢ Ahead-of-time compiler (AOT); <br>  ‚Ä¢ an executable library to support the virtual machine. <br><br>  The AOT compiler translates an intermediate language (IL) from .NET compilers into C ++ source code.  The executable library provides services and abstractions (such as a garbage collector), cross-platform access to streams and files, as well as methods for implementing internal calls (unmanaged code that directly modifies the managed data structures). <br><br>  <b>AOT compiler</b> <br><br>  The AOT compiler for IL2CPP is called il2cpp.exe.  On Windows, you can find it in the Editor \ Data \ il2cpp directory, and on OS X, in the Contents / Frameworks / il2cpp / build directory in the Unity installation location.  The il2cpp.exe utility is written entirely in C # and compiled using .NET and Mono compilers. <br><br>  This utility accepts managed assemblies compiled by the Mono compiler shipped with Unity and generates the C ++ code that we pass to the C ++ compiler for a specific platform. <br>  The IL2CPP toolbox can be schematically represented as follows: <br><br><img src="https://habrastorage.org/files/994/c20/d61/994c20d61f644eb19b9da3509b106cf3.png"><br><br>  <b>Executable library</b> <br><br>  The second part of the IL2CPP technology is an executable library to support the virtual machine.  We wrote this library almost entirely in C ++ (there is some platform code in it, but let it stay between us) and called it libil2cpp.  It comes in the form of a static library associated with the player's executable file, and its simplicity and portability are among the key advantages of the IL2CPP technology. <br><br>  You can get a clearer picture of the organization of the libil2cpp code by looking at the header files supplied with Unity (you can find them in the Editor \ Data \ PlaybackEngines \ webglsupport \ BuildTools \ Libraries \ libil2cpp \ include directory in Windows, or in the Contents / Frameworks / directory il2cpp / libil2cpp - on OS X).  For example, the interface between C ++ code generated by il2cpp.exe and libil2cpp is in the header file codegen / il2cpp-codegen.h. <br><br>  One of the key elements of the environment is the garbage collector.  Unity 5 comes with libgc, a Boehm-Demers-Weiser garbage collector.  However, libil2cpp supports other collectors.  For example, we are considering the possibility of integration with Microsoft GC - an open source assembler in the CoreCLR bundle.  In one of the following articles we will tell about it in more detail. <br><br>  <b>How to run il2cpp.exe?</b> <br><br>  Let's look at an example.  For this, I will create a new empty project in Unity 5.0.1 on Windows.  So that we have at least one user script, I will add a simple component MonoBehaviour to the main camera: <br><br><img src="https://habrastorage.org/files/519/7a6/b5e/5197a6b5e58e4cc694a79dd9ede25a98.png"><br><br>  When building for the WebGL platform, I can use Process Explorer to see the command to run il2cpp.exe: <br><br> <code>"C:\Program Files\Unity\Editor\Data\MonoBleedingEdge\bin\mono.exe" "C:\Program Files\Unity\Editor\Data\il2cpp/il2cpp.exe" --copy-level=None --enable-generic-sharing --enable-unity-event-support --output-format=Compact --extra-types.file="C:\Program Files\Unity\Editor\Data\il2cpp\il2cpp_default_extra_types.txt" "C:\Users\Josh Peterson\Documents\IL2CPP Blog Example\Temp\StagingArea\Data\Managed\Assembly-CSharp.dll" "C:\Users\Josh Peterson\Documents\IL2CPP Blog Example\Temp\StagingArea\Data\Managed\UnityEngine.UI.dll" "C:\Users\Josh Peterson\Documents\IL2CPP Blog Example\Temp\StagingArea\Data\il2cppOutput" <br></code> <br><br>  This is a fairly long string, so let's break it down in parts.  First, Unity runs this executable file: <br><br>  "C: \ Program Files \ Unity \ Editor \ Data \ MonoBleedingEdge \ bin \ mono.exe" <br><br>  The next argument is the il2cpp.exe utility itself. <br><br>  "C: \ Program Files \ Unity \ Editor \ Data \ il2cpp / il2cpp.exe" <br><br>  The remaining arguments are passed to il2cpp.exe, not mono.exe.  Let's take them apart.  First, Unity passes 5 flags of il2cpp.exe: <br><br>  ‚Ä¢ -copy-level = None <br>  Indicates that il2cpp.exe should not perform special copies of the files generated by C ++ code. <br><br>  ‚Ä¢ -enable-generic-sharing <br>  Reduces the size of the code and binary file.  Over time, we will publish the process of executing generic methods in IL2CPP. <br><br>  ‚Ä¢ -enable-unity-event-support <br>  Provides correct code generation for Unity events triggered by reflection. <br><br>  ‚Ä¢ -output-format = Compact <br>  Generates C ++ code in a format with fewer characters for type names and methods.  Given that the names in the intermediate language are not saved, such code is harder to debug, but it does compile faster because the C ++ compiler needs to parse less code. <br><br>  ‚Ä¢ -extra-types.file = "C: \ Program Files \ Unity \ Editor \ Data \ il2cpp \ il2cpp_default_extra_types.txt" <br>  Uses standard empty file for additional types.  You can add it to a Unity project so that il2cpp.exe knows which generic or indexable types are created at runtime, but are not listed in the IL code. <br><br>  It is worth noting that this set of command line arguments for il2cpp.exe is still unstable and is likely to change in future versions. <br><br>  So, the command line contains 2 files and 1 directory: <br><br>  ‚Ä¢ ‚ÄúC: \ Users \ Josh Peterson \ Documents \ IL2CPP Blog Example \ Temp \ StagingArea \ Data \ Managed \ Assembly-CSharp.dll‚Äù <br>  ‚Ä¢ ‚ÄúC: \ Users \ Josh Peterson \ Documents \ IL2CPP Blog Example \ Temp \ StagingArea \ Data \ Managed \ UnityEngine.UI.dll‚Äù <br>  ‚Ä¢ ‚ÄúC: \ Users \ Josh Peterson \ Documents \ IL2CPP Blog Example \ Temp \ StagingArea \ Data \ il2cppOutput‚Äù <br><br>  The il2cpp.exe utility accepts a list of all IL assemblies to be converted.  In our case, this includes my simple MonoBehavior script, Assembly-CSharp.dll and UnityEngine.UI.dll.  Please note that there are clearly several assemblies missing.  Obviously, my script refers to UnityEngine.dll, which means that at least mscorlib.dll, and possibly other assemblies are needed.  But where are they?  The fact is that the resolution of assemblies occurs inside il2cpp.exe.  They can be mentioned on the command line, but this is optional.  It turns out, Unity needs only to specify root assemblies (to which other assemblies do not refer). <br><br>  The last command line argument, il2cpp.exe, is the directory in which the C ++ files are created.  If you're interested, you can familiarize yourself with the generated files, but we'll talk more about them in the next article.  Before you open the directory, you should choose the Development Player option in the WebGL assembly settings.  This removes the -output-format = Compact argument and improves the mapping of type names and methods in C ++ code. <br><br>  Try playing with the Player Settings WebGL or iOS settings.  You will see various command line parameters passed to il2cpp.exe and are responsible for the different stages of code generation.  For example, by setting the Enable Exceptions parameter in WebGL Player Settings to Full, you will add the arguments -emit-null-checks, -enable-stacktrace and -enable-array-bounds-check to the command line. <br><br>  <b>What does IL2CPP not do?</b> <br><br>  I would like to draw attention to one difficulty, which we decided to bypass and thus avoided many problems.  We did not attempt to rewrite the standard C # library under IL2CPP.  When you create a Unity project using IL2CPP, all the code in the standard C # libraries (mscorlib.dll, System.dll, etc.) is an exact copy of the Mono script code. <br><br>  We use the code of standard C # libraries, because it has already managed to establish itself well in many projects.  Thus, if an error occurs somewhere, we can be sure that the problem is in the AOT compiler or the executable library. <br><br>  <b>Development, testing and release of IL2CPP</b> <br><br>  Since the first official release of IL2CPP version 4.6.1p5 in January, we released 6 full updates and 7 patches (for Unity 4.6 and 5.0), in which we fixed more than a hundred bugs. <br><br>  To ensure continuous optimization, we are developing updates based on a single version of the code.  Before each release, we transfer all changes to a specific release branch, conduct testing and check whether all errors have been successfully corrected.  Our QA and Sustained Engineering teams are doing their utmost to keep things going at this pace, and bugs are fixed every week. <br><br>  Our community has provided us with invaluable assistance by providing many useful error messages.  We are very grateful to users for all the reviews that help to continuously improve IL2CPP. <br><br>  For IL2CPP developers, testing comes first.  We often take as a basis development techniques through testing and rarely send inclusion requests if the code has not been fully tested.  This strategy works well for technologies such as the IL2CPP, where there are clear inputs and outputs.  This means that the overwhelming majority of the errors we encounter are special cases rather than unexpected system behavior ( <a href="http://forum.unity3d.com/threads/4-6-3-il2cpp-xcode-build-errors.299561/">for example</a> , using 64-bit IntPtr as a 32-bit array index can result in a C ++ compiler error).  Thus, we can quickly identify and fix any bugs. <br>  With the support of our community, we are making IL2CPP more stable and more productive all the time. <br><br>  <b>To be continued</b> <br>  I'm afraid I mention the following articles too often.  Just want to tell a lot, and it does not fit in one post.  Next time we will dig into the code generated by il2cpp.exe and talk about the work of the C ++ compiler. </div><p>Source: <a href="https://habr.com/ru/post/276589/">https://habr.com/ru/post/276589/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276579/index.html">Moscow Python Meetup ‚Ññ32</a></li>
<li><a href="../276581/index.html">Multi-source replication in MySQL5.7</a></li>
<li><a href="../276583/index.html">New leader in price-performance among storage systems?</a></li>
<li><a href="../276585/index.html">About using React with the canvas element</a></li>
<li><a href="../276587/index.html">Analysis of the current situation in the Russian BIM market in the field of civil engineering</a></li>
<li><a href="../276593/index.html">Creating a program architecture or how to design a stool</a></li>
<li><a href="../276595/index.html">Quadcopter navigation using monocular vision</a></li>
<li><a href="../276597/index.html">Binding Request Traker 4.x on Ubuntu to ldap using the example of ActiveDirectory</a></li>
<li><a href="../276599/index.html">What brings the idea (Objective-C) - target-action on the blocks and a lot of runtime</a></li>
<li><a href="../276603/index.html">Evgeny Kaspersky spoke about cybercrime at Innopolis University [video]</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>