<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Basics of working with IOKit. Driver programming subtleties</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As part of supporting blog development under Mac OS X, I submit my article on low-level development under Mac OS X. Usually, driver development is not...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Basics of working with IOKit. Driver programming subtleties</h1><div class="post__text post__text-html js-mediator-article"><br>  As part of supporting blog development under Mac OS X, I submit my article on low-level development under Mac OS X. Usually, driver development is not so popular, but here Mac OS X stands out from a number of other operating systems.  Yes, writing drivers for Mac OSX is easy!  Easier than ever before! <a name="habracut"></a><br><br><br><h3>  Excursion into the depths of the theory </h3>  Very often I hear phrases that Mac OS X is Linux.  Or that OS X is based on the FreeBSD kernel and therefore the drivers are easy to port from one system to another.  And no!  Very often, the concept of development for Mac OS X contradicts the classical principles, for example, instead of traditional spin locks (spin lock) Apple suggests using the IOCommandGate primitive to synchronize access.  Also quite strictly regulated the use of nuclear memory.  Apple's approximate advice looks like this: ‚ÄúAllocate as much memory in the kernel as you need to use and not byte more.  Prefer the bulk of work with large memory buffers to transfer to user mode (user space). " <br><br>  The heart, i.e.  the kernel, Mac OS X is XNU.  XNU is a hybrid kernel that combines many advantages, as well as disadvantages, of monolithic and microkernel OSs.  Actually, XNU consists of the mach microkernel developed by the Carnegie Malone Institute, the Posix subsystem from BSD 4.3 (later this part was synchronized with the last FreeBSD branch, added by Apple itself, as well as by 3 persons), and the IOKit object-oriented framework responsibility to interact with Mac hardware.  It is worth mentioning that the mach core provides the following services to the operating system: a thread and process scheduler that pushes multitasking (pre-emptive), a virtual memory mechanism, memory protection, mach-IPC (through message passing), a kernel debugger. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <br><h3>  Something about IOKit </h3> And so, what exactly is IOKit?  Like many other things, IOKit is a legacy of NeXT Computer (brilliant people apparently worked in NeXT).  IOKit is an object-oriented framework implementing the Mac OS X driver model. IOKit is written in C ++, or rather, in its reduced version Embedded C ++ [1].  Simply put, this is the good old C ++ without multiple inheritance, RTTI, patterns, and exceptions.  Also in IOKit it is forbidden to define constructors and destructors of classes.  However, if you really want to, then you can use everything except RTTI and exceptions, but Apple will not caress your head for it!  IOKit was previously written in Objective-C, like the Cocoa framework, and was called the Driver Kit.  However, to simplify the development of drivers by 3 persons, the Driver Kit was rewritten in C ++.  However, according to one of the main developers of IOKit, Godfrey van der Linden (Godfrey van der Linden), this decision was erroneous.  However, in IOKit you can see with the naked eye the legacy of Objective C, for example, the mechanism of reference counting and retain / release, the naming of classes (OS and IO prefixes), the naming of class methods, and much more.  Another interesting fact: Godfrey van der Linden is a student at the University of Nicta, the same Australian research institute, who opened the research project Darbat [2]. <br><br>  In order to get down to business you just have the Xcode SDK installed, the IDE Xcode itself, as well as Terminal.app for downloading the drivers.  When creating a new project, select Generic IOKit Driver and Xcode will create an empty project for you.  All you have to do is add the driver code, compile it, and load it with the following lines (it is assumed that the driver is called SampleDriver.kext): <br><br> <code>sudo chmod ‚ÄìR 0755 ./SampleDriver.kext <br> sudo chown ‚ÄìR root:wheel ./SampleDriver.kext <br> sudo kextload ‚Äìt ./SampleDriver.kext</code> <br> <br>  As can be seen from the above lines: the driver is loaded with root rights using the third-party kextload program (from the utils kext set, which in turn is included in xnu utils).  A driver, like any Mac OS X application (with the exception of simple console applications), is a bundle, i.e.  the directory in which data is stored that directly relates to the driver, namely: the Info.plist file, the file with localized strings, and of course the binary driver file itself (SampleDriver.kext / Contents / MacOS / SampleDriver).  Also, the driver may contain additional resources (SampleDriver.kext / Contents / Resources) or other drivers (SampleDriver.kext / Contents / PlugIns). <br><br>  IOKit in its concept actively exploits two paradigms of the PLO: inheritance and polymorphism.  Inheritance allows you to reduce the amount of used nuclear memory: any IOKit driver inherits a certain base class that is specific to each stack of devices in the system.  For example, for LAN device drivers, these are IOEthernetController, WAN devices ‚Äî IO80211Controller, sound cards ‚Äî IOAudioDevice, etc.  The mechanism of virtual functions allows the driver to easily override certain methods of the base class, thus implementing the necessary functionality. <br><br><br><h3>  Attempt at writing </h3>  Any class in the IOKit driver must be directly or indirectly inherited from the OSObject class.  This class provides reference counting, support for pseudo-RTTI at the expense of macros and additional meta-information, primitives for creating an instance of the class (overloaded operator new) in the IOKit environment, and much more.  The simplest IOKit class looks like this: <br><br>  * .h file: <br>  <font color="black"><font color="#0000ff">class</font> MyIOKitClass: <font color="#0000ff">public</font> OSObject</font> <font color="black"><br></font>  <font color="black">{</font> <font color="black"><br></font>  <font color="black">OSDeclareDefaultStructors (MyIOKitClass)</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">public</font> :</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">virtual</font> <font color="#0000ff">bool</font> init ();</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">protected</font> :</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">virtual</font> <font color="#0000ff">void</font> free ()</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">private</font> :</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">void</font> * fSimpleMember;</font> <font color="black"><br><br></font>  <font color="black">};</font> <font color="black"><br></font> <br><br>  * .cpp file: <br>  <font color="black"><font color="#0000ff">bool</font> MyIOKitClass :: init ()</font> <font color="black"><br></font>  <font color="black">{</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">if</font> (! OSObject :: init ())</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">return</font> <font color="#0000ff">false</font> ;</font> <font color="black"><br><br></font>  <font color="black"><font color="#008000">// TO-DO: Add basic initialization here</font></font> <font color="black"><br></font>  <font color="black">fSimpleMember = NULL;</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">return</font> <font color="#0000ff">true</font> ;</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">void</font> MyIOKitClass :: free ()</font> <font color="black"><br></font>  <font color="black">{</font> <font color="black"><br></font>  <font color="black"><font color="#008000">// TO-DO: Add deinitialization code here</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">if</font> (fSimpleMember)</font> <font color="black"><br></font>  <font color="black">{</font> <font color="black"><br></font>  <font color="black"><font color="#008000">// ...</font></font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br><br></font>  <font color="black">OSObject :: free ();</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br></font> <br>  Our class MyIOKitClass is inherited from the OSObject class, it overrides two methods: <ol><li>  bool init () - this method will be called when a new instance is created.  The method recommends initial initialization of the class fields, in general, everything that you would have done in the constructor. </li><li>  void free () - this method will be called at the time when the last release is called for an instance of the class and its reference count will be 0. That is,  the role of the method is the destructor of the class. </li></ol><br><br>  Also in the overridden methods, you must call the methods of the ancestor class in order for IOKit to do the bulk of the work of initializing / destroying the class instance for you. <br><br>  Only auxiliary classes can be inherited from OSObject, which are necessary when implementing a larger system.  The main driver class (and any other class that claims to provide certain services to the operating system) is directly or indirectly inherited from the IOService class. <br><br>  IOService helps to implement in your driver support Plug'n'Play, Power Management (organizes interaction with the Power Domain operating system), interaction with IORegistry and other system drivers.  Here I should also mention IORegistry - this is nothing more than the dynamic tree of Mac OS X devices. The boot loader, the OS kernel, and the auxiliary drivers start building this tree.  For example, the IOACPIPlatformExpert driver builds in IORegistry a tree of all PCI devices in the system, based on information from ACPI tables, as well as the APIC interrupt controller. <br><br>  IOService has two quite useful methods that you probably should implement in most of your drivers: <ol><li>  bool start (IOService * provider) - this method will be called during the start of your driver.  Here you can put the code that will be engaged in the allocation of resources required by the driver. </li><li>  void stop (IOService * provider) - this method will be called during the stop of your driver. </li></ol><br><br>  In the signature of the above methods, you might notice the provider parameter.  And so, what does it mean, and what is it for?  It's very simple, as mentioned earlier, in Mac OS X there is a dynamic list of IORegistry devices.  There is a bunch nab driver in it.  Any driver can register its services in the system and make them nubs for any other drivers.  So, nab is a class that another system driver has registered with IORegistry, and now this nab can be passed as a provider to your driver.  For example, for PCI device drivers, a nabom is an instance of the IOPCIDevice class.  Nabe information and device identifiers are specified in the Info.plist driver file.  The following section of the Info.plist file illustrates this technique (this code was taken from my network driver): <br><br>  <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">dict</font> <font color="#0000ff">&gt;</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">key</font> <font color="#0000ff">&gt;</font> Realtek RTL8111B / RTL8168 NIC <font color="#0000ff">&lt;/</font> <font color="#800000">key</font> <font color="#0000ff">&gt;</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">dict</font> <font color="#0000ff">&gt;</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">key</font> <font color="#0000ff">&gt;</font> CFBundleIdentifier <font color="#0000ff">&lt;/</font> <font color="#800000">key</font> <font color="#0000ff">&gt;</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">string</font> <font color="#0000ff">&gt;</font> rtl.r1000.nic.ext <font color="#0000ff">&lt;/</font> <font color="#800000">string</font> <font color="#0000ff">&gt;</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">key</font> <font color="#0000ff">&gt;</font> IOClass <font color="#0000ff">&lt;/</font> <font color="#800000">key</font> <font color="#0000ff">&gt;</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">string</font> <font color="#0000ff">&gt;</font> RealtekR1000 <font color="#0000ff">&lt;/</font> <font color="#800000">string</font> <font color="#0000ff">&gt;</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">key</font> <font color="#0000ff">&gt;</font> IOPCIMatch <font color="#0000ff">&lt;/</font> <font color="#800000">key</font> <font color="#0000ff">&gt;</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">string</font> <font color="#0000ff">&gt;</font> 0x816910ec 0x816710ec 0x816810ec 0x813610ec <font color="#0000ff">&lt;/</font> <font color="#800000">string</font> <font color="#0000ff">&gt;</font></font> <font color="black"><font color="#0000ff"><br></font></font>  <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">key</font> <font color="#0000ff">&gt;</font> iOProbeScore <font color="#0000ff">&lt;/</font> <font color="#800000">key</font> <font color="#0000ff">&gt;</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">integer</font> <font color="#0000ff">&gt;</font> 500 <font color="#0000ff">&lt;/</font> <font color="#800000">integer</font> <font color="#0000ff">&gt;</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">key</font> <font color="#0000ff">&gt;</font> IOProviderClass <font color="#0000ff">&lt;/</font> <font color="#800000">key</font> <font color="#0000ff">&gt;</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">&lt;</font> <font color="#800000">string</font> <font color="#0000ff">&gt;</font> IOPCIDevice <font color="#0000ff">&lt;/</font> <font color="#800000">string</font> <font color="#0000ff">&gt;</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">&lt;/</font> <font color="#800000">dict</font> <font color="#0000ff">&gt;</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">&lt;/</font> <font color="#800000">dict</font> <font color="#0000ff">&gt;</font></font> <br><br><br>  We describe the most significant parameters: <ul><li>  IOProviderClass - indicates the type of naba that IOKit will pass to the start method of our driver. </li><li>  IOClass is the name of our driver class.  If you refer to our previous example, this is MyIOKitClass. </li><li>  CFBundleIdentifier - bundle identifier of our driver; in other words, this parameter uniquely identifies our driver in the system. </li><li>  IOPCIMatch is a list of DeviceID-VendorID PCI devices that our driver will service.  For example, take 0x816810ec, 0x8168 is the DeviceID of our network controller, 0x10ec is VendorID, in this case Realtek. </li></ul><br><br>  The remaining parameters are subject to another article;) The approximate code of our start method will look like this: <font color="black"><font color="#0000ff">bool</font> RealtekR1000 :: start (IOService * provider)</font> <font color="black"><br></font>  <font color="black">{</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">if</font> (! IOEthernetController :: start (pciDev))</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">return</font> <font color="#0000ff">false</font> ;</font> <font color="black"><br><br></font>  <font color="black">IOPCIDevice * pciDev = NULL;</font> <font color="black"><br><br></font>  <font color="black">pciDev = OSDynamicCast (IOPCIDevice, provider);</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">if</font> (! pciDev)</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">return</font> <font color="#0000ff">false</font> ;</font> <font color="black"><br><br></font>  <font color="black">pciDev-&gt; retain ();</font> <font color="black"><br></font>  <font color="black">pciDev-&gt; open ( <font color="#0000ff">this</font> );</font> <font color="black"><br><br></font>  <font color="black"><font color="#008000">// Add initialization of device here</font></font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">return</font> <font color="#0000ff">true</font> ;</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br></font> <br><br>  I hope that this code is more or less clear to you, I will add only that OSDynamicCast is a macro that replaces the absence of RTTI in IOKit by using additional meta-information. <br><br><br><h3>  Do something useful? </h3>  All you need to do to create your network driver: <ul><li>  Create a skeleton for the driver, as described above. </li><li>  Inherit the driver class from the IOEthernetController class. </li><li>  Override the necessary methods in its class (about 10-12 in total). </li><li>  Set the necessary parameters in the Info.plist file. </li></ul><br><br>  And the driver is ready!  As you can see, Mac OS X once again amazes us with grace.  There are no huge * .inf files, no miniport system, and other non-obvious things.  Porting a driver for a network controller with Linux on Mac OS X took me about 7 days, despite the fact that I also had to learn the basics of IOKit from scratch. <br><br><br>  At this stage, I deliberately pause until the next article, if, of course, someone will be interested in this topic on the desktop.  I omitted such interesting things as: Power Management, work with IO ports and DMA, interaction with user space, etc.  I can recommend IOKit Fundamentals [3] for those who wish to learn IOKit, and for interested users, a list of low-level development topics that they would be most interested in.  Please leave your feedback and suggestions;) <br><br><br><h3>  useful links </h3><br>  [1] <a href="http://en.wikipedia.org/wiki/Embedded_C%252B%252B">Embedded C ++</a> <br>  [2] <a href="http://ertos.nicta.com.au/software/darbat/">Darbat project</a> <br>  [3] <a href="http://developer.apple.com/documentation/DeviceDrivers/Conceptual/IOKitFundamentals/Introduction/chapter_1_section_1.html">IOKit Fundamentals</a> </div><p>Source: <a href="https://habr.com/ru/post/36875/">https://habr.com/ru/post/36875/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../368739/index.html">How Dell laptops improve the efficiency of training in the oil and gas industry</a></li>
<li><a href="../36874/index.html">The idea for mashup'a soc. nets</a></li>
<li><a href="../368743/index.html">Banks in Denmark began to pay interest to mortgage borrowers</a></li>
<li><a href="../368747/index.html">Smart float with a video camera and Wi-Fi will help you find a "fish" place</a></li>
<li><a href="../368749/index.html">Andy Grove and the turning points of Intel history</a></li>
<li><a href="../368751/index.html">Watch Shock Clock: the discharge of electricity and fear - the key to success awakening</a></li>
<li><a href="../368753/index.html">3D printing and safe sex toys at home (DIY) (18+)</a></li>
<li><a href="../368755/index.html">Space Run or four lectures in five days</a></li>
<li><a href="../368757/index.html">We open the cards: why the HEPA filter in the air cleaner does not need an efficiency of 99.95%</a></li>
<li><a href="../368759/index.html">A new algorithm for calculating the rating of "Kinopoisk" prefers movies with a paid view. Mini investigation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>