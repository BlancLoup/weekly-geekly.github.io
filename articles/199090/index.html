<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Practical application of LD_PRELOAD or replacement of functions in Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 In 2010, shoumikhin wrote a wonderful article Redirecting Functions in Shared ELF Libraries . That article is very well written, complete, bu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Practical application of LD_PRELOAD or replacement of functions in Linux</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br>  In 2010, <a href="http://habrahabr.ru/users/shoumikhin/" class="user_link">shoumikhin</a> wrote a wonderful article <a href="http://habrahabr.ru/post/106107/">Redirecting Functions in Shared ELF Libraries</a> .  That article is very well written, complete, but it describes a more hard way to replace functions.  In this article, we will use the standard dynamic linker feature - the environment variable LD_PRELOAD, which can load your library before loading the rest. <br><br><h5>  How it works? </h5><br>  It's very simple - the linker loads your library with your ‚Äústandard‚Äù functions first, and who is the first, the one and the sneaker.  And from your library you can download the real ones, and ‚Äúproxy‚Äù calls, while doing whatever you want. <br><br><h4>  Real Use-Case # 1: Block mimeinfo.cache in Opera </h4><br>  I really like the Opera browser.  I also use KDE.  Opera does not really respect the priorities of KDE applications, and often it also strives to open the downloaded ZIP archive in mcomix, the PDF in imgur-uploader, in general, you get the gist.  However, if she is forbidden to read the mimeinfo.cache file, then she will open everything through ‚Äúkioclient exec‚Äù, and he knows better what I want to open this or that file. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      How can an application open a file?  Two functions come to mind: <b>fopen</b> and <b>open</b> .  In my case, opera used the 64-bit analog of fopen - <b>fopen64</b> .  You can determine this by using the ltrace utility, or simply by looking at the import table with the objdump utility. <a name="habracut"></a><br><br>  What do we need to write a library?  First of all, you need to make a prototype of the original function. <br>  Judging by <b>man fopen</b> , the prototype of this function is as follows: <br><pre><code class="hljs objectivec">FILE *fopen(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *path, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *mode)</code> </pre>  And it returns a pointer to FILE, or NULL, if the file cannot be opened.  Ok, write the code: <br><pre> <code class="hljs lua">#define _GNU_SOURCE #include &lt;stdio.h&gt; #include &lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>.h&gt; #include &lt;dlfcn.h&gt; static FILE* (*fopen64_orig)(const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> * mode) = NULL; FILE* fopen64(const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> * mode) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fopen64_orig == NULL) fopen64_orig = dlsym(RTLD_NEXT, <span class="hljs-string"><span class="hljs-string">"fopen64"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strstr(<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, <span class="hljs-string"><span class="hljs-string">"mimeinfo.cache"</span></span>) != NULL) { printf(<span class="hljs-string"><span class="hljs-string">"Blocking mimeinfo.cache read\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NULL; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fopen64_orig(<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>, mode); }</code> </pre> <br>  As you can see, everything is simple: we declare the function fopen64, load the ‚Äúnext‚Äù (original), in relation to our, function, and check if we open the ‚Äúmimeinfo.cache‚Äù file.  Compile it with the following command: <br><pre> <code class="hljs vhdl">gcc -<span class="hljs-keyword"><span class="hljs-keyword">shared</span></span> -fPIC -ldl -O2 -o opera-<span class="hljs-keyword"><span class="hljs-keyword">block</span></span>-mime.so opera-<span class="hljs-keyword"><span class="hljs-keyword">block</span></span>-mime.c</code> </pre> <br>  And run the opera: <br><pre> <code class="hljs vhdl">LD_PRELOAD=./opera-<span class="hljs-keyword"><span class="hljs-keyword">block</span></span>-mime.so opera</code> </pre>  And we see: <pre> <code class="hljs pgsql">Blocking mimeinfo.cache <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> Blocking mimeinfo.cache <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> Blocking mimeinfo.cache <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> Blocking mimeinfo.cache <span class="hljs-keyword"><span class="hljs-keyword">read</span></span></code> </pre> <br>  Success! <br><br><h4>  Real Use-Case # 2: Turning a file into a socket </h4><br>  I have a proprietary application that uses direct access to the printer (device file / dev / usb / lp0).  I wanted to write my own server for debugging purposes.  What does open () return?  File descriptor  What does socket () return?  The same file descriptor on which read () and write () work exactly the same.  Getting Started: <br><pre> <code class="hljs lua">#define _GNU_SOURCE #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;dlfcn.h&gt; #include &lt;strings.h&gt; #include &lt;sys/socket.h&gt; #include &lt;netinet/<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>.h&gt; static int (*orig_open)(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span> * filename, int flags) = NULL; int <span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span> * filename, int flags) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (orig_open == NULL) orig_open = dlsym(RTLD_NEXT, <span class="hljs-string"><span class="hljs-string">"open"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strcmp(filename, <span class="hljs-string"><span class="hljs-string">"/dev/usb/lp0"</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { //opening tcp socket struct sockaddr_in servaddr, cliaddr; int socketfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number"><span class="hljs-number">0</span></span>); bzero(&amp;servaddr,sizeof(servaddr)); servaddr.sin_family = AF_INET; servaddr.sin_addr.s_addr=inet_addr(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>); // addr servaddr.sin_port=htons(<span class="hljs-number"><span class="hljs-number">32000</span></span>); // port <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (connect(socketfd, (struct sockaddr *)&amp;servaddr, sizeof(servaddr)) == <span class="hljs-number"><span class="hljs-number">0</span></span>) printf(<span class="hljs-string"><span class="hljs-string">"[Open] TCP Connected\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> printf(<span class="hljs-string"><span class="hljs-string">"[Open] TCP Connection failed!\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> socketfd; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> orig_open(filename, flags); }</code> </pre> <br><br><h4>  Not really real Use-Case # 3: Intercepting C ++ methods </h4><br>  With C ++, it's a little different.  Let's say we have a class: <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Testclass</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setvar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> val</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getvar</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; };</code> </pre> <br><pre> <code class="hljs kotlin">#include &lt;stdio.h&gt; #include <span class="hljs-string"><span class="hljs-string">"class.h"</span></span> void Testclass() { int <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; } int Testclass::setvar(int <span class="hljs-keyword"><span class="hljs-keyword">val</span></span>) { printf(<span class="hljs-string"><span class="hljs-string">"setvar!\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">val</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } int Testclass::getvar() { printf(<span class="hljs-string"><span class="hljs-string">"getvar! %d\n"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>; }</code> </pre> <br>  But the functions will not be called ‚ÄúTestclass :: getvar‚Äù and ‚ÄúTestclass :: setvar‚Äù in the resulting file.  To find out the names of functions, just look at the export table: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">nm</span></span> -D libclass.so ‚Ä¶ <span class="hljs-number"><span class="hljs-number">0000000000000770</span></span> T _Z9Testclassv 00000000000007b0 T _ZN9Testclass6getvarEv <span class="hljs-number"><span class="hljs-number">0000000000000780</span></span> T _ZN9Testclass6setvarEi</code> </pre>  This is called name mangling. <br>  There are two ways out: either to create an interceptor library in C ++, describing the class in the same way it was in the original, but in this case, you are likely to have problems accessing a particular instance of the class, or else make a library on C, calling the function as it is exported; in this case, the first parameter is the pointer to the instance: <br><pre> <code class="hljs mel">#define _GNU_SOURCE #include &lt;stdio.h&gt; #include &lt;dlfcn.h&gt; typedef <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> (*orig_getvar_type)(void* <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _ZN9Testclass6getvarEv(void* <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span>) { printf(<span class="hljs-string"><span class="hljs-string">"Wrapped getvar! %d\n"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span>); orig_getvar_type orig_getvar; orig_getvar = (orig_getvar_type)dlsym(RTLD_NEXT, <span class="hljs-string"><span class="hljs-string">"_ZN9Testclass6getvarEv"</span></span>); printf(<span class="hljs-string"><span class="hljs-string">"orig getvar %d\n"</span></span>, orig_getvar(<span class="hljs-keyword"><span class="hljs-keyword">instance</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><br>  That is, in fact, all that I wanted to talk about.  I hope it will be useful to someone. </div><p>Source: <a href="https://habr.com/ru/post/199090/">https://habr.com/ru/post/199090/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../199070/index.html">ICANN helped to combat child porn in Russia</a></li>
<li><a href="../199078/index.html">Hackers on the screen - 2</a></li>
<li><a href="../199080/index.html">Returns for Windows 8 on Lenovo Notebook Notebook</a></li>
<li><a href="../199086/index.html">Russian universities have become partners Coursera</a></li>
<li><a href="../199088/index.html">Fast compilation of a large number of invalid objects in the database</a></li>
<li><a href="../199092/index.html">Accelerate the understanding of a commercial or technical text: how to stop being afraid to write simply</a></li>
<li><a href="../199094/index.html">Writing Hello World in assembly language under Windows RT using winapi</a></li>
<li><a href="../199102/index.html">How to find a developer in a garage startup: from personal experience</a></li>
<li><a href="../199104/index.html">The story of a graduate school in the United States. Part 4.1: What next?</a></li>
<li><a href="../199110/index.html">Continuous integration in xcode5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>