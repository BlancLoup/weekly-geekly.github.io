<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make an LXC container on a router running LEDE</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From time to time people are tempted to do something strange. Why - in fact it does not matter, some kind of argument that it is necessary to do this ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make an LXC container on a router running LEDE</h1><div class="post__text post__text-html js-mediator-article"><p>  From time to time people are tempted to do something strange.  Why - in fact it does not matter, some kind of argument that it is necessary to do this way - will be.  But the main thing is the desire to do something strange.  Well, once decided to do something strange, then why not describe this process. </p><br><p>  So, how to run an LXC container with Debian, not somewhere out there, but on a piece of hardware running under <a href="https://lede-project.org/">LEDE</a> (also known as OpenWRT fork)? </p><br><p>  (it is assumed that the reader himself will figure out why he needs LXC on the router and is already familiar with this container technology) </p><a name="habracut"></a><br><h3 id="popytka-optimistichnaya">  Attempt optimistic </h3><br><p>  For the desired frauds we take a piece of metal (or better, while x86 virtuals for the test) with LEDE installed and see: </p><br><pre><code class="hljs pgsql">root@lede:~# opkg find lxc* lxc - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - LXC <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> the userspace control package <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Linux Containers, a lightweight virtual <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> mechanism sometimes described <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> "chroot on steroids". lxc-attach - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-attach <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-auto - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - LXC <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> the userspace control package <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Linux Containers, a lightweight virtual <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> mechanism sometimes described <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> "chroot on steroids". This package adds <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> initscript <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> starting <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> stopping the containers <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> boot <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> shutdown. lxc-autostart - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-autostart <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-cgroup - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-cgroup <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-checkconfig - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-checkconfig <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-clone - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-clone <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-common - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - LXC common files lxc-config - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-config <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-configs - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - LXC virtual machine common config files lxc-console - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-console <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-destroy - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-destroy <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-device - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-device <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-<span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-<span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-<span class="hljs-keyword"><span class="hljs-keyword">freeze</span></span> - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-<span class="hljs-keyword"><span class="hljs-keyword">freeze</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-hooks - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - LXC virtual machine hooks lxc-<span class="hljs-keyword"><span class="hljs-keyword">info</span></span> - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-<span class="hljs-keyword"><span class="hljs-keyword">info</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-init - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - LXC Lua bindings lxc-ls - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-ls <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-lua - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - LXC Lua bindings lxc-monitor - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-monitor <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-monitord - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-monitord <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-<span class="hljs-keyword"><span class="hljs-keyword">snapshot</span></span> - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-<span class="hljs-keyword"><span class="hljs-keyword">snapshot</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-stop - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-stop <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-templates - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - LXC virtual machine templates lxc-unfreeze - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-unfreeze <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-unshare - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-unshare <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>-nic - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>-nic <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-usernsexec - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-usernsexec <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools lxc-wait - <span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> - Utility lxc-wait <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the LXC userspace tools</code> </pre> <br><p>  Hm  This seems easier than expected.  True, everything is broken into separate utilities, but oh well.  We first <code>lxc-checkconfig</code> and see what it thinks of our core. </p><br><pre> <code class="hljs vhdl">root@lede:~# lxc-checkconfig Kernel <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> found at /proc/config.gz; searching... lxc-checkconfig: unable <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> retrieve kernel <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> Try recompiling <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> IKCONFIG_PROC, installing the kernel headers, <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> specifying the kernel <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> path <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>: CONFIG=&lt;path&gt; lxc-checkconfig</code> </pre> <br><p>  Oops.  Thinking nothing.  Some time later, it turns out that the default LEDE core is built without LXC support, and the packages in the repository are for manual manipulations only.  But there are packages, and the kernel is quite fresh - it means you can rebuild the kernel and use it.  So do. </p><br><h3 id="razbiraemsya-so-sborkoy-lede">  Understanding the LEDE Build </h3><br><p>  Let's go to collect <a href="https://lede-project.org/docs/guide-developer/quickstart-build-images">a brief guide assembly LEDE</a> .  We put the necessary packages for your OS.  I recommend to start with the configuration with the default configuration to verify that errors are caused by not including LXC support and you need to dig the cause separately from this note. </p><br><pre> <code class="hljs php">git <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> https:<span class="hljs-comment"><span class="hljs-comment">//git.lede-project.org/source.git build cd build git checkout v17.01.4 ./scripts/feeds update -a ./scripts/feeds install -a</span></span></code> </pre> <br><p>  You can build LEDE using the official image settings for the desired hardware.  To do this, go to <a href="https://downloads.lede-project.org/releases/">https://downloads.lede-project.org/releases/</a> select the current release (at the time of writing it is 01/17/4), then in the <code>targets/</code> our architecture and find the file <code>config.seed</code> next to the LEDE image.  For example, for x86, the address is <code>https://downloads.lede-project.org/releases/17.01.4/targets/x86/generic/config.seed</code> </p><br><p>  Download this file to the build directory under the name <code>.config</code> and use <code>make defconfig</code> expand it into a full build file. </p><br><pre> <code class="hljs lua">wget -O .<span class="hljs-built_in"><span class="hljs-built_in">config</span></span> https://downloads.lede-project.org/releases/<span class="hljs-number"><span class="hljs-number">17.01</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span>/targets/x86/generic/<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>.seed make defconfig <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> make</code> </pre> <br><p>  I‚Äôve had about one and a half hours, to look for ready-made images in <code>bin/targets/</code> . </p><br><p>  In general, <code>make</code> can be called in several threads, but I was impressed with the warning in the build documentation. <code>But this might expose bugs!</code>  and decided not to hurry anywhere. </p><br><p>  And pay attention to the disk space was enough.  Take 20GB is quite simple. </p><br><h3 id="dobavlyaem-lxc">  Add LXC </h3><br><p>  A little familiar with the build, now it's time to add kernel options to support LXC.  Many thanks to almost the only article <a href="http://www.gnuton.org/blog/2016/02/lxc-on-openwrt/">on building OpenWRT with LXC</a> for the starting point.  But the article is old, and the options for the current LXC is not all.  Add to our <code>.config</code> package of options: </p><br><pre> <code class="hljs delphi">CONFIG_KERNEL_AIO=y CONFIG_KERNEL_BLK_CGROUP=y CONFIG_KERNEL_BLK_DEV_BSG=y CONFIG_KERNEL_CGROUPS=y CONFIG_KERNEL_CGROUP_CPUACCT=y CONFIG_KERNEL_CGROUP_DEVICE=y CONFIG_KERNEL_CGROUP_FREEZER=y CONFIG_KERNEL_CGROUP_PIDS=y CONFIG_KERNEL_CGROUP_SCHED=y CONFIG_KERNEL_CPUSETS=y # CONFIG_KERNEL_DEBUG_FS <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> # CONFIG_KERNEL_DEBUG_INFO <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> # CONFIG_KERNEL_DEBUG_KERNEL <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> CONFIG_KERNEL_DEVPTS_MULTIPLE_INSTANCES=y CONFIG_KERNEL_DEVTMPFS=y CONFIG_KERNEL_DEVTMPFS_MOUNT=y CONFIG_KERNEL_DIRECT_IO=y CONFIG_KERNEL_FANOTIFY=y CONFIG_KERNEL_FHANDLE=y CONFIG_KERNEL_FREEZER=y CONFIG_KERNEL_IPC_NS=y # CONFIG_KERNEL_KALLSYMS <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> CONFIG_KERNEL_LXC_MISC=y CONFIG_KERNEL_MEMCG=y CONFIG_KERNEL_MEMCG_SWAP=y CONFIG_KERNEL_MM_OWNER=y CONFIG_KERNEL_NAMESPACES=y CONFIG_KERNEL_NETPRIO_CGROUP=y CONFIG_KERNEL_NET_CLS_CGROUP=y CONFIG_KERNEL_NET_NS=y CONFIG_KERNEL_PID_NS=y CONFIG_KERNEL_POSIX_MQUEUE=y CONFIG_KERNEL_PROC_PID_CPUSET=y CONFIG_KERNEL_RESOURCE_COUNTERS=y CONFIG_KERNEL_USER_NS=y CONFIG_KERNEL_UTS_NS=y CONFIG_PACKAGE_ip-tiny=y CONFIG_PACKAGE_ipset=y CONFIG_PACKAGE_iptables-<span class="hljs-keyword"><span class="hljs-keyword">mod</span></span>-conntrack-extra=y CONFIG_PACKAGE_iptables-<span class="hljs-keyword"><span class="hljs-keyword">mod</span></span>-ipopt=y CONFIG_PACKAGE_kmod-<span class="hljs-number"><span class="hljs-number">8021</span></span>q=y CONFIG_PACKAGE_kmod-fuse=y CONFIG_PACKAGE_kmod-ip6tables-extra=y CONFIG_PACKAGE_kmod-ipt-conntrack-extra=y CONFIG_PACKAGE_kmod-ipt-ipopt=y CONFIG_PACKAGE_kmod-ipt-ipset=y CONFIG_PACKAGE_kmod-ipt-nat-extra=m CONFIG_PACKAGE_kmod-ipt-nat6=m CONFIG_PACKAGE_kmod-macvlan=y CONFIG_PACKAGE_kmod-nf-nat6=m CONFIG_PACKAGE_kmod-nfnetlink=y CONFIG_PACKAGE_kmod-veth=y CONFIG_PACKAGE_terminfo=y</code> </pre> <br><p>  In principle, all this can be found in the usual <code>make menuconfig</code> .  Now you can call it, these parameters will not be lost and you can customize the assembly for yourself. </p><br><p>  But, unfortunately, this is not all options.  Some are not in <code>make menuconfig</code> and need to change the configuration of the kernel itself.  In theory, the right way is to </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">make</span></span> kernel_menuconfig</code> </pre> <br><p>  And putting down all the corresponding marks there.  But somehow it is a chore to look for them, so the path is wrong: we re-run the updated <code>.config</code> </p><br><pre> <code class="hljs 1c">make defconfig <span class="hljs-meta"><span class="hljs-meta"># </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  -   menuconfig  </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta"> ,   </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta"> .  make prepare</span></span></code> </pre> <br><p>  We find somewhere around <code>build_dir/target-i386_pentium4_musl-1.1.16/linux-x86_generic/linux-4.4.92/.config</code> generated kernel configuration file (the path, as you can see, differs from the heap of parameters).  And add to the end of another pack of settings </p><br><pre> <code class="hljs pgsql">CONFIG_CHECKPOINT_RESTORE=y CONFIG_CGROUP_FREEZER=y CONFIG_FREEZER=y CONFIG_IKCONFIG=y CONFIG_IKCONFIG_PROC=y CONFIG_NETFILTER_XT_TARGET_CHECKSUM=m CONFIG_NETLINK_DIAG=y CONFIG_PACKET_DIAG=y CONFIG_INET_DIAG=y CONFIG_UNIX_DIAG=y CONFIG_FHANDLE=y CONFIG_INET_UDP_DIAG=m # CONFIG_PROC_STRIPPED <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> CONFIG_CFQ_GROUP_IOSCHED=y</code> </pre> <br><p>  <code>CONFIG_IKCONFIG_PROC</code> and <code>CONFIG_IKCONFIG</code> are just the thing that <code>lxc-checkconfig</code> could not say.  And <code>CONFIG_PROC_STRIPPED</code> are <a href="https://unix.stackexchange.com/questions/344047/proc-net-netstat-not-found">OpenWRT patches that</a> <code>CONFIG_PROC_STRIPPED</code> some files from the <code>/proc</code> pseudo <code>/proc</code> .  The setting should reduce the amount of memory consumed, but the varings were obtained with <code>lxc-start</code> .  But LXC with a lack of memory and is not needed. </p><br><p>  After such an intervention (and it must be repeated after <code>make prepare</code> every time) we do </p><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">time</span></span> make</code> </pre> <br><p>  Now a lot of everything has already been compiled and will not be recompiled, therefore it works much faster.  For 15 minutes, I had an update. </p><br><p>  We load the resulting image onto a piece of iron or a virtual machine and try to execute <code>lxc-checkconfig</code> .  Must see a neat picture like this: </p><br><pre> <code class="hljs mel">root@lede:~# lxc-checkconfig --- Namespaces --- Namespaces: enabled Utsname <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span>: enabled Ipc <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span>: enabled Pid <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span>: enabled User <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span>: enabled Network <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span>: enabled Multiple /dev/pts instances: enabled --- Control groups --- Cgroup: enabled Cgroup clone_children flag: enabled Cgroup device: enabled Cgroup sched: enabled Cgroup cpu account: enabled Cgroup <span class="hljs-keyword"><span class="hljs-keyword">memory</span></span> controller: enabled --- Misc --- Veth pair device: enabled Macvlan: enabled Vlan: enabled Bridges: enabled Advanced netfilter: enabled CONFIG_NF_NAT_IPV4: enabled CONFIG_NF_NAT_IPV6: enabled CONFIG_IP_NF_TARGET_MASQUERADE: enabled CONFIG_IP6_NF_TARGET_MASQUERADE: enabled CONFIG_NETFILTER_XT_TARGET_CHECKSUM: enabled --- Checkpoint/Restore --- checkpoint restore: enabled CONFIG_FHANDLE: enabled CONFIG_EVENTFD: enabled CONFIG_EPOLL: enabled CONFIG_UNIX_DIAG: enabled CONFIG_INET_DIAG: enabled CONFIG_PACKET_DIAG: enabled CONFIG_NETLINK_DIAG: enabled File capabilities: enabled Note : Before booting a new kernel, you can check its configuration usage : CONFIG=/path/to/config /usr/bin/lxc-checkconfig</code> </pre> <br><p>  Ok, here is the core and ready. </p><br><h3 id="podgotovka-konteynera">  Container preparation </h3><br><p>  Now we put a small packet of packages (in fact, they can be rolled up immediately into an image that is going to <code>make</code> , but I didn‚Äôt understand this) </p><br><pre> <code class="hljs sql">opkg <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> lxc-<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> lxc-attach lxc-<span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> lxc-ls lxc-monitor lxc-monitord lxc-checkconfig</code> </pre> <br><p>  I prefer not to use templates from <code>lxc-templates</code> - my scripts have been available since openvz, and the LXC config is pretty typical.  But I checked the debian build in LEDE for the article, more packages are needed: </p><br><pre> <code class="hljs sql">opkg <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> lxc-<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> lxc-templates debootstrap bash getopt rsync</code> </pre> <br><p>  Then a surprise, out of the box still does not work.  <code>/var/cache</code> exists in LEDE as nodev and debootstrap cannot go there.  Therefore, instead of <code>/var/cache</code> we are doing a symlink somewhere. </p><br><pre> <code class="hljs sql">mkdir /mnt/<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ln</span></span> -s /mnt/<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> lxc-<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -n testlxc -t debian <span class="hljs-comment"><span class="hljs-comment">-- -r jessie</span></span></code> </pre> <br><p>  So, container rootfs is ready.  Let's try to run: </p><br><pre> <code class="hljs pgsql">lxc-<span class="hljs-keyword"><span class="hljs-keyword">start</span></span> -n testlxc -d</code> </pre> <br><p>  The task of connecting to the container was in trouble.  <code>lxc-console</code> complains about the <code>bad file descriptor</code> .  But the container itself is running and is active.  Well, they wanted a strange, strange received.  We do: </p><br><pre> <code class="hljs pgsql">lxc-attach -n testlxc <span class="hljs-comment"><span class="hljs-comment">-- bash</span></span></code> </pre> <br><p>  And here we are with console access inside the container.  What is wrong with <code>lxc-console</code> could not be <code>lxc-console</code> out, but uncritically, I left it like this. </p><br><p>  It is possible to place a directory with containers by and large anywhere, as long as the path to this directory is specified in <code>/etc/lxc/lxc.conf</code> . </p><br><h3 id="avtozapusk-konteynerov">  Containers autostart </h3><br><p>  The last detail remains: configure the autostart of the container (s) with the system.  Install the <code>lxc-auto</code> package </p><br><pre> <code class="hljs sql">opkg <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> lxc-<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span></code> </pre> <br><p>  And we get the init-script and the reference configuration file <code>/etc/config/lxc-auto</code> .  We bring it to the desired form from the required number of container name transfers: </p><br><pre> <code class="hljs pgsql">config container <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span> testlxc</code> </pre> <br><p>  And send the system to reboot for verification.  The init script unfortunately turns out to be rather silly: it calls <code>lxc-stop &amp;</code> for all containers from the config and goes to sleep by default for 300 seconds.  So even if the containers are turned off quickly - the script will still sleep. </p><br><p>  PS: at first I tried to run LEDE in an LXC container on Debian.  After some time, the trials with gdb even managed this, but on the task it was normal to start the <code>firewall</code> from the regular configs stalled and went from the reverse. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/341370/">https://habr.com/ru/post/341370/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341356/index.html">Digest: ITMO University developments in 2017</a></li>
<li><a href="../341360/index.html">Deobfuscation of a single script with popups</a></li>
<li><a href="../341364/index.html">11 rules of data visualization</a></li>
<li><a href="../341366/index.html">Implementation of multi-boot files with progress indicators on ASP.NET</a></li>
<li><a href="../341368/index.html">GDG DevFest Gorky 2017</a></li>
<li><a href="../341372/index.html">C ++ User Group News</a></li>
<li><a href="../341374/index.html">6 IT infrastructure trends: forecast for 2018</a></li>
<li><a href="../341376/index.html">Pebble Kombat. Javascript Watch Game Development History</a></li>
<li><a href="../341378/index.html">DotNext 2017 Moscow: the return of hardcore</a></li>
<li><a href="../341380/index.html">CarPrice in Japan: features of the national auto auction</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>