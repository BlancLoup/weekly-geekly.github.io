<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>History of one oscilloscope on stm32</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Just over a year ago, I had the idea that it would be good to make an oscilloscope. Then I wanted it to be an independent device with its own TFT disp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>History of one oscilloscope on stm32</h1><div class="post__text post__text-html js-mediator-article"><img src="https://hubstub.ru/uploads/q.png"><br><br>  Just over a year ago, I had the idea that it would be good to make an oscilloscope.  Then I wanted it to be an independent device with its own <b>TFT</b> display, and indeed, the idea of ‚Äã‚Äãdealing with TFT displays seemed very promising to me.  After some time, a 3.2-inch TFT with a <b>SSD1289</b> driver was ordered for Ali. <br><br>  At that time, I already had the experience of programming <b>AVR microcontrollers</b> , so I decided to launch the display on my favorite Atmega16.  Whether it came to creating an oscilloscope then did not yet know, but I knew for sure that I would use TFT in my projects, so I did not search for third-party libraries, but decided to write my own, which I use to this day. <br><a name="habracut"></a><br>  After it was possible to initialize the display, it became clear that an oscilloscope could not be made on the Atmega16.  It is very slow for a display of this size.  And something inside told me that it was time to switch to the STM32, but it also stopped me.  In general, the deliberation process was short and a board with STM32F103VET6 was ordered on Ali.  But besides the reason described above, there was another reason to switch to <b>STM32</b> - the built-in 12-bit ADC at 1Msps, which can be used to digitize the signal. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To my surprise, after several weeks of working with STM32, it became clear that there was nothing difficult in them and I stopped understanding why I did not switch to them earlier.  It was not difficult to transfer the code written for AVR to STM32, but the thought that I needed the display to work at maximum speed did not give rest, and for that I had to deal with the <b>FSMC</b> .  In fact, everything turned out to be simple here - it took me one weekend.  At this preparatory events with the display were completed and it was possible to go directly to the implementation of the oscilloscope. <br><br>  The primary task was to learn how to display a signal on the display, for this purpose I accumulated the required number of ADC samples, then displayed them on the screen, filled the screen with black color and so on in a circle.  By the way, even then, DMA was used to save data to the buffer. <br><br>  The first step was taken and I was overwhelmed with joy and pride for the work done.  Further, I wanted the sinusoid not to run, but to stand, for this it was necessary to learn how to start the conversion of the ADC by trigger. <br>  This can be done using a conventional comparator, as shown in the diagram below. <br><br><div style="text-align:center;"><img src="https://hubstub.ru/uploads/1.png"></div><br>  <i><font color="#999999">Comparator at the shelter.</font></i> <br><br>  A reference voltage is applied to the inverting input, which is formed using PWM and RC chains.  A direct input signal is the same that is fed to the input of the ADC. <br><br>  When the voltage at the direct input becomes higher or lower than the voltage at the inverted input, the polarity at the output of the OU changes.  This change fixes the output of the MC configured for external interrupt.  By changing the active front, for an external interruption, you can capture both on the rising and on the falling edge. <br><br>  Further, DMA is enabled in the interrupt and works until the buffer is full.  Yes, it is DMA, ADC always works in my implementation.  The feedback resistor is needed to increase the rate of rise, and the OS itself for this business, it is advisable to choose quickly. <br><br>  After some time, I came across a review of DSO 138 and from the same review I learned that its scheme is available on the Internet and decided to borrow a piece from there. <br><br><div style="text-align:center;"><img src="https://hubstub.ru/uploads/2.png"></div><br>  <i><font color="#999999">Fragment of the DSO scheme 138.</font></i> <br><br>  <i>What makes this piece of circuit?</i> <br>  The voltage range with which the ADC can operate determines the reference voltage levels ( <b>+ VREF</b> and <b>-VREF</b> ), they should not go beyond the power supply range of the microcontroller.  The lower limit of the range is limited to 0 volts, the upper - 3.3 volts.  From here it becomes clear that measuring the negative voltages of the <b>ADC</b> cannot, and this is necessary. <br><br>  In order for the ADC to sense negative voltages, it is necessary that, in the absence of a signal, half of the reference voltage in our case is fed to 1.6 volts.  In this case, when measuring a negative voltage, for example, minus 0.3 volts, the voltage at the ADC input decreases by 0.3 volts and becomes equal to 1.6 - 0.3 = 1.3 volts.  This voltage ADC easily digitized.  This example is approximate because it does not take into account the gain of the circuit (in this case, we took it for 1), but it is clear. <br><br>  I would also like to note that the power supply of the op amp is bipolar, this is necessary in order for the op amp to work with negative voltage.  If the op amp power is unipolar (0 is fed to one power pin, 5 volts to the second) and a negative voltage is applied to the input, the op amp will not feel it and cannot do anything with it, that's it. <br><br>  For the implementation of bipolar power, I used two charges from the phone, connecting plus one with minus to the other, and took the potential of this connection as a reference point, that is, the ground. <br><br>  The scheme was assembled on a breadboard and now the oscilloscope could capture by trigger and measure negative voltages, I had no idea what to do next in terms of hardware, so I switched to software. <br><br>  At that time, I already had a clear understanding that the buffer should be circular, and the size borrowed from the DSO 138, that is, 4096 points. <br><br>  <i>Why so many points?</i> <br>  Such a number of points using thinning allows you to implement some scans that can not be implemented in hardware.  For STM32, the conversion duration is 12.5 cycles, in order to find the sampling period, add a value to the conversion duration, which is determined by the SMPx bit field [2: 0].  At the moment, the DSO 138 reduced the buffer size to 1024 points, I have 4096 left. <br><br>  <i>So what is the ring buffer for?</i> <br>  The ring buffer is necessary to change the ratio of the number of pre and post samples on fast sweeps.  Prefetches - samples before trigger trigger, postfetches - samples after trigger trigger.  The algorithm of operation is as follows, after the oscillogram is drawn: <br><br><ol><li>  we accumulate the necessary quantity of pre-election; </li><li>  allow external interrupts; </li><li>  MK starts to perform some third-party tasks, until, until the external interrupt signal comes. </li></ol><br>  On this signal, the buffer is supplemented with post-samples and the entire waveform is displayed. <br>  The user can set the number of pre-selections only on fast sweeps; on slow ones immediately after capturing, points are drawn on the screen, bypassing the buffer.  In fact, of course, there is a buffer, because from the time it became clear that to paint the workspace after each drawing is unreasonable, you can simply draw the same waveform only in black and restore the markup, thus reducing the time of drawing one waveform and disappears, such an unpleasant effect like flicker. <br><br>  The result can be seen on video. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/YSC2J1qom2g%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhi4CUA1EBzv0EtqDLrGAazGJ9wSPg" frameborder="0" allowfullscreen=""></iframe><br><br>  <i>What could the prototype of the oscilloscope at that time? (And what he could something?)</i> <br>  It was possible to change the sweep time, select the trigger type, select the active front, change the number of pre and post samples, change the trigger level, also change the base level. <br>  As for the type of trigger, in the auto mode, everything happens just like in the norm mode, except that if the signal causing an external interrupt does not come within 100 milliseconds, then a timer interrupt occurs and the buffer is filled in it. <br><br>  <i>In order to implement the remaining functions, I had to return to the hardware again.</i>  <i>And I think many have a question, why not zayuzat the entire scheme from DSO138?</i> <br>  Quite simply, I wanted the position of the attenuator to be switched by electronics, not by switches and, most importantly, when the open input was changed to the closed one and vice versa, the relay would click)) <br>  In general, I was faced with the task of finding the analog part that would meet my requirements.  In fact, this is not an easy task, if it were not for one thing ... <br>  At one point, I remembered that I had an oscilloscope, and its developer answered me questions on skype about a year ago, in general, I decided to write to him. <br>  After I told him about my plans to make an oscilloscope, he offered me several options for the analog part, I chose the most comprehensible scheme for me, asked him my questions and set about implementing it.  A few months later the oscilloscope was ready. <br><br>  <b>The result was an oscilloscope with the following characteristics:</b> <br>  Power supply: 9 V <br>  Current consumption: 110 mA <br>  Sampling Frequency: 1 MSa / s <br>  Analog Bandwidth: 0 - 200 kHz <br>  Vertical resolution: 12 bits <br>  Maximum input voltage: 50 V <br>  Vertical sensitivity: 10 mV / div - 10 V / div <br>  Horizontal scan time: 10 ¬µs / div to 200 ms / div <br>  Input Impedance: 1 MŒ© / 20 pF <br>  Input Modes: DC, AC, Ground <br>  Start Modes - Sweep: Auto, Normal, Single <br><br><img src="https://hubstub.ru/uploads/img_5167.jpg"><br><br><img src="https://hubstub.ru/uploads/img_5182.jpg"><br><br>  The result can be seen on video. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/XunPF4EfLps%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhiqF82nSrLAm_7GRSvUCjaBrmvgVw" frameborder="0" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/358330/">https://habr.com/ru/post/358330/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358320/index.html">Designing low-power DC-DC for the organization of emergency power. Part 3</a></li>
<li><a href="../358322/index.html">Indication of output parameters and implementation of load protection in the UPS. Part 4.1</a></li>
<li><a href="../358324/index.html">Implementation of the program code for the display module on ILI9341 + STM32. Part 4.2</a></li>
<li><a href="../358326/index.html">Productronic 2015</a></li>
<li><a href="../358328/index.html">Symmetric cards as a means of minimizing Boolean functions</a></li>
<li><a href="../358332/index.html">Arduino LLC and Arduino SRL Are United Again</a></li>
<li><a href="../358334/index.html">Determine the length of the tracks on the board</a></li>
<li><a href="../358336/index.html">Vapor soldering, or as soldered in production</a></li>
<li><a href="../358338/index.html">New features LCD serial interfaces</a></li>
<li><a href="../358340/index.html">Russian production of embedded systems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>