<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The history of the game Triplex, or how many squares do you need to break your head</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To master the basics of Web programming, I decided to write an HTML5 puzzle game called Triplex ( www.quadpuzzle.ru ). Writing a game for yourself and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The history of the game Triplex, or how many squares do you need to break your head</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/9e7/00c/53b/9e700c53b5e59e5e9444fedd76448f5b.png">  To master the basics of Web programming, I decided to write an HTML5 puzzle game called Triplex ( <a href="http://www.quadpuzzle.ru/">www.quadpuzzle.ru</a> ).  Writing a game for yourself and for friends is half the battle.  I wanted to bring the project to mind, making a game a product for a wide range of users.  How it happened - to judge you. <br><br>  The rules of the game are simple.  On the playing field laid out the figures of the squares.  The goal of the game is to lay all the shapes in the specified rectangle.  You can rotate only one shape, marked with a circle, if it is.  The solution in each problem exists and only. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ed0/b4d/6e7/ed0b4d6e730702344567fb340beee6bd.png" width="66" title="task"><img src="https://habrastorage.org/getpro/habr/post_images/69a/d08/8b5/69ad088b5acf59416435c6eed54d6bac.png" width="66" title="decision">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  Works in new versions of the following browsers: Opera, Opera-mobile, Safari (Windows, iPad2), Android (HTC Desire, Samsung Galaxy Tab 10.1), Chrome, FireFox and IE9. <br><br>  Implemented the following ideas: <ol><li>  The game consists of a single html file.  It can be downloaded to your local disk and play without the Internet.  IE9 does not support this mode. </li><li>  If there is a network connection, then you can mark your passing levels on the server and see the results of all the noted players. </li><li>  The table of records for each level stores the name of the player who decided this level first.  Also stored statistics on the passage of levels by other players. </li><li>  Each next level is encoded by the decision of the previous one.  So just take and go through the last level will not work, despite the fact that all levels are stored in a single html file. </li><li>  The game is translated into 5 languages: Russian, English, French, German and Chinese. </li></ol><br><br><h3>  Similar games </h3><br>  It would be dishonest to say that I did not invent the game.  The prototype of Triplex was a very similar game BlockPuzzle 500 ( <a href="http://www.mtoy.biz/">www.mtoy.biz</a> ), in which I had the opportunity to play on my first Android phone. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fb0/c79/569/fb0c7956937d992d9f2e4e48a91637ac.png" width="66"><img src="https://habrastorage.org/getpro/habr/post_images/de5/ccf/0f6/de5ccf0f62e9b8a6267a69b04750514f.png" width="66"><br><br>  In essence Triplex differs from it in the following: <ul><li>  size of figures: <br>  BlockPuzzle uses figures from 2, 3, 4 and 5 squares, in Triplex there are figures from only 2 and 3; </li><li>  Triplex can have several identical figures on the same level, and BlockPuzzle is all different; </li><li>  there are no rotating figures in BlockPuzzle, in some Triplex there is one rotating figure on some levels; </li><li>  BlockPuzzle is only for Android, and Triplex can be played on any device, if it has a browser with HTML5 support. <br>  Honestly, on Android it is more pleasant to play BlockPuzzle - the interface is more responsive.  I would be glad if someone wants to port Triplex on Android or another platform.  All you need is in triplex.html. </li></ul><br><br><h3>  Where the tasks come from </h3><br>  The level generator for this game was developed first.  At first, just for the sake of curiosity.  I wanted to understand the nature and properties of such tasks.  How many of them all, how difficult it is to find such tasks, how difficult it is to solve them ... There was written a program in the Java language that can generate levels.  I wanted to play, touch and solve with these levels.  Apparently, in childhood I did not play enough with cubes, so now I wanted to play with the squares.  The idea arose not only to make a level visualization program with user interface elements, but also to make a game out of it. <br><br>  The generator looked for levels as follows: <ol><li>  went through all the combinations in the fields 3x2, 3x3, 4x3, ... with 3 or more figures from 2 and 3 squares; </li><li>  eliminated all similar (up to turns and reflections); </li><li>  chose those in which there is only one solution; </li><li>  chose one rotated shape, if it did not add other solutions. </li></ol><br><br><h4>  Computational complexity of the algorithm </h4><br>  Initially, the program was conceived for the selection of tasks with an arbitrary number and size of shapes of arbitrary sizes.  The algorithm works by <a href="http://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B4_%25D0%25B2%25D0%25B5%25D1%2582%25D0%25B2%25D0%25B5%25D0%25B9_%25D0%25B8_%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BD%25D0%25B8%25D1%2586">the branch and bound method</a> . <br><br>  Let the decision figure be a rectangular figure of size WxH consisting of other figures (figures from the problem condition).  Consider all pairs of contiguous squares (squares with a common face) that make up the solution.  All such faces (2 * W * H - W - H). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/369/2aa/969/3692aa9693e5141a40e8b0b01bdd9a84.png"><br><br>  Each face can be in one of two states: <br>  0. closed - adjacent squares may belong to different figures; <br>  1. open - two adjacent squares belong to the same figure. <br><br>  Let's call N-ku from (2 * W * H - W - H) binary values ‚Äã‚Äãa set of states of all faces.  Obviously, an arbitrary set of states uniquely corresponds to a partition of a rectangle into shapes (see the description of the <a href="https://habr.com/ru/post/141085/">partition coloring</a> algorithm).  Obviously, for any partition there is at least one set of states. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/127/12c/b4c/12712cb4cb0b0423660e5c6fd8f31a49.png"><br><br>  The set of various sets of states contains 2 <sup>(2 * W * H - W - H)</sup> elements.  That is, to iterate over all possible partitions, it is enough to start the cycle from 0 to 2 <sup>(2 * W * H - W - H)</sup> -1, and consider every i-th bit of the binary representation of the index variable state of the i-th face.  If the complexity of the cycle body is limited to a constant, then the total complexity of enumeration of all combinations will be exponential of the solution area.  Let's estimate how many iterations will work out. <br><table><tbody><tr><th>  dimension </th><th>  quantity <br>  iterations </th></tr><tr><td>  1x1 </td><td>  2 <sup>(2 * 1 * 1 - 1 - 1)</sup> = 2 <sup>0</sup> = 1 </td></tr><tr><td>  2x1 </td><td>  2 <sup>(2 * 2 * 1 - 2 - 1)</sup> = 2 <sup>1</sup> = 2 </td></tr><tr><td>  2x2 </td><td>  2 <sup>(2 * 2 * 2 - 2 - 2)</sup> = 2 <sup>4</sup> = 16 </td></tr><tr><td>  2x3 </td><td>  2 <sup>(2 * 2 * 3 - 2 - 3)</sup> = 2 <sup>7</sup> = 128 </td></tr><tr><td>  2x4 </td><td>  2 <sup>(2 * 2 * 4 - 2 - 4)</sup> = 2 <sup>10</sup> = 1024 </td></tr><tr><td>  3x3 </td><td>  2 <sup>(2 * 3 * 3 - 3 - 3)</sup> = 2 <sup>12</sup> = 4096 </td></tr><tr><td>  ... </td><td>  ... </td></tr><tr><td>  6x6 </td><td>  2 <sup>(2 * 6 * 6 - 6 - 6)</sup> = 2 <sup>60</sup> </td></tr></tbody></table><br>  That is, the loop index for the 6x6 task is still placed in a 64-bit integer type.  If you start such a cycle with an empty body at a speed of 1 processor clock per iteration on a processor with a frequency of 3GHz, then the program will run for 12 years = 2 <sup>60</sup> / (3 * 10 <sup>9</sup> * 3600 * 24 * 365). <br><br><h5>  Reduce brute force filtering </h5><br>  In order to significantly reduce the brute force, you need to try to throw away entire groups of such partitions that are obviously not suitable.  For this, the following filtering mechanism was invented.  Sort all the squares in descending order from left to right and from top to bottom: the upper left is the oldest, the lower right is the youngest.  Each square uniquely corresponds to its pair of faces: right and bottom.  So, the order on the squares, in a natural way, induces order on the adjoining faces: let it be the lower - the oldest, the right - the younger.  Each split passes from one filter to the next through a filter function that either skips the split further or not.  If the split passes all the filters, then it falls into our game.  If the partition does not satisfy the condition of any filter, then the filter may indicate the least significant square, due to which the condition is not fulfilled.  Then the search for partitions continues not from the lowest face, but from the lowest face of the specified square. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/909/8da/8e7/9098da8e7c4411f6cb2b872a22d9d457.png"><br><br>  In the general case, for an arbitrary filter it is difficult to estimate how much one can thus reduce the number of partitions.  However, a very simple example shows that sometimes significantly.  So, thanks to the filter that drops partitions with isolated squares (squares that are an independent figure from one square), the number of partitions at the first step is reduced by 25%: the highest square must have at least one common face with one of two neighbors.  That is, instead of 12 years, we have enough 9. If the 4 corner squares are not neighbors, the filter of the ‚Äúisolated squares‚Äù reduces the search by 25% for each of them, and this is (1 - (3/4) <sup>4</sup> ) = 68 %  Similar considerations for the remaining squares add up to a reduction in the search of the order O (2 <sup>W * H</sup> ). <br><br>  To generate Triplex levels, the following filters were used in the following order: <br><br>  1. 2x2Duplicates <br>  - filter discarding partitions in which there are four small squares (2x2) belonging to one shape, but at least one of the four common faces is not common. <br><img src="https://habrastorage.org/getpro/habr/post_images/cb4/2ea/841/cb42ea8411617d0ae05e8e2f689a51a0.png"><br>  2. 1x1Cell <br>  - filter of isolated squares, described above. <br>  3. StraightCut <br>  - filter discarding partitions with straight horizontal or vertical cuts.  Such a cut divides the split into two parts, rearranging which, we get the second solution.  This rule is not executed only when both parts of the split consist of the same sets.  In this case, the second solution does not work, but for our game the partition is not of interest, because each part of the partition is an independent task of a smaller dimension. <br>  4. Shapes3 <br>  - filter discarding tasks with the number of figures less than 3. It is not at all interesting to solve puzzles from two figures. <br>  5. Shape23 <br>  - filter discarding partitions in which there are figures of 4 or more squares.  This filter is specific to Triplex. <br>  6. RotatedAndReflected <br>  - a filter that rejects the same partitions - such partitions, which are obtained from each other by turning 90, 180 or 270 degrees and / or mirror reflection.  Each partition is thus assigned 8 identical partitions.  Since we have introduced a linear order on the set of partitions, then from each eight, we can choose the minimum partition.  If the filtered partition is not minimal, then we discard it.  This means that we have already considered the partition from this eight. <br>  7. Solver <br>  - filter discarding partitions for which there is more than one solution.  This filter is probably the most interesting, but I don‚Äôt want to describe the algorithm of its work, in order not to make the task easier for programmers who want to write their own solver to get through the game.  I would like to say, however, that Solver selects solutions by the branch and bound method.  The number of leaves on the 'branches' (the number of combinations) is calculated by the formula <br>  C! / (C <sub>1</sub> ! C <sub>2</sub> ! ... C <sub>m</sub> !), <br>  where C is the number of figures in the partition, m is the number of different figures in the partition (the number of groups of identical figures), C <sub>i</sub> is the number of identical figures in each of the groups.  For example, if all the figures are the same, then the combination is only one: m = 1 and C = C <sub>1</sub> .  The first level (3 different figures, until we pay attention to the rotating figure) gives 3! / (1! 1! 1!) = 6 combinations.  The tenth level (6 figures in four groups) gives 6! / (2! 2! 1! 1!) = 180 combinations.  The hundredth level (9 figures, in five groups) gives 9! / (3! 3! 1! 1! 1!) = 10080 combinations.  The sixth level gives about 10 <sup>11</sup> combinations.  Despite the fact that there are many combinations, Solver solves all the tasks of Triplex in 1-2 seconds.  This suggests that finding tasks is much more difficult than solving them.  For example, when searching for 6x6 tasks, Solver solved 5887655 tasks, choosing only 46 of them. <br><br>  For Triplex, with figures of two and three squares, the described filter set is far from optimal.  But the program was designed to generate more complex tasks, and Triplex is just a special case, for which there is a completely different, simpler algorithm, which I will discuss next. <br>  It is worth noting that the order of the filters greatly affects the performance of the program.  At the top of the list, you need to put filters that have the least algorithmic complexity, and those that reject the maximum number of bad partitions in large groups.  For example, Solver, if you put it first, most likely, it will throw away the greatest number of splits.  However, it will work unacceptably long, evaluating the splits one by one. <br><br><h5>  Generator report </h5><br>  Consider the task generation report for 6x6 dimensions.  The following table shows how many breaks were processed and by what filters. <br><table><tbody><tr><th>  checked </th><th>  accepted </th><th>  thrown away </th><th>  discarded% </th><th>  discarded% <br>  from the general <br>  numbers </th><th>  filter </th></tr><tr><td>  596745944245 </td><td>  295317406559 </td><td>  301428537686 </td><td>  50.51 </td><td>  50.51 </td><td>  2x2Duplicates </td></tr><tr><td>  295317406559 </td><td>  110686580321 </td><td>  184630826238 </td><td>  62.52 </td><td>  30.94 </td><td>  1x1Cell </td></tr><tr><td>  110686580321 </td><td>  79876633976 </td><td>  30809946345 </td><td>  27.84 </td><td>  5.16 </td><td>  Straightcut </td></tr><tr><td>  79876633976 </td><td>  79875530828 </td><td>  1103148 </td><td>  0.00 </td><td>  0.00 </td><td>  Shapes3 </td></tr><tr><td>  79875530828 </td><td>  47094698 </td><td>  79828436130 </td><td>  99.94 </td><td>  13.38 </td><td>  Shape23 </td></tr><tr><td>  47094698 </td><td>  5887701 </td><td>  41206997 </td><td>  87.50 </td><td>  0.01 </td><td>  RotatedAndReflected </td></tr><tr><td>  5887701 </td><td>  46 </td><td>  5887655 </td><td>  100.00 </td><td>  0.00 </td><td>  Solver </td></tr><tr><td>  596745944245 </td><td>  46 </td><td>  596745944199 </td><td>  100.00 </td><td>  100.00 </td><td>  Total </td></tr></tbody></table><br>  The first thing you want to pay attention to is the total number of checked partitions - 596745944245 &lt;2 <sup>40</sup> .  That is, thanks to the mechanism of 'boundaries', it was possible to reduce the check from 2 <sup>60</sup> to 2 <sup>40</sup> .  If we consider that this task was spinning for 12 days, then without the mechanism of 'boundaries' it would work for 12 * 2 <sup>20</sup> ~ 12 * 10 <sup>6</sup> days or it would be necessary to use a million processor cores instead of one.  This table lacks one very interesting column that would show how each filter reduced brute force to understand what the divider 2 <sup>20</sup> consists of. <br>  As one would expect, RotatedAndReflected threw 7/8 = 87.5% of all partitions given to it, choosing only one of each eight identical tasks.  It is interesting to note that among the considered partitions, more than a million different variants were found, rejected by the Shapes3 filter, which are split variants from two figures.  It is even hard to imagine that from the <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D1%2581%25D1%2582%25D0%25B5%25D0%25BC%25D1%258B_%25D0%25BD%25D0%25B0%25D0%25B8%25D0%25BC%25D0%25B5%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F_%25D1%2587%25D0%25B8%25D1%2581%25D0%25B5%25D0%25BB">quintillon</a> (2 <sup>60</sup> ~ 10 <sup>18</sup> ) 6x6 partitions for Triplex, only 46 were chosen. As the saying goes, ‚Äúall the best‚Äù. <br><br><h5>  Timeline </h5><br>  This is how for the 6x6 task the graphs of the number of found levels (LEVELS FOUND) versus time and% of considered partitions (WORK DONE) versus time (in days) look like. <br><img src="https://habrastorage.org/getpro/habr/post_images/d2d/645/acf/d2d645acf9bca180dcac08e0e47f6d93.png"><br>  I would like to note two points: <ul><li>  First, WORK DONE starts at 25% due to the filter of the isolated small squares applied to the upper left square, as explained above. </li><li>  Secondly, despite the fact that the program worked 12 <br>  days, all levels were found in the first 4 days at WORK DONE values ‚Äã‚Äãfrom 25% to 40%.  With other dimensions the same thing - most of the found levels were found at the beginning of the search.  This is due to the RotatedAndReflected filter, in which the minimum of the eight similar tasks is selected. </li></ul><br><br><h5>  Task Dimension Table </h5><br>  This table provides data for all tasks that hit the game. <br><table><tbody><tr><th>  Square <br>  solutions </th><th>  Dimension </th><th>  amount <br>  levels </th><th>  Time </th><th>  General <br>  quantity <br>  levels </th><th>  General <br>  time </th></tr><tr><td>  eight </td><td>  4x2 </td><td>  2 </td><td>  0s </td><td>  2 </td><td>  0s </td></tr><tr><td>  9 </td><td>  3x3 </td><td>  one </td><td>  0s </td><td>  3 </td><td>  0s </td></tr><tr><td>  ten </td><td>  5x2 </td><td>  one </td><td>  0s </td><td>  four </td><td>  0s </td></tr><tr><td>  12 </td><td>  4x3 </td><td>  four </td><td>  0s </td><td>  eight </td><td>  0s </td></tr><tr><td>  15 </td><td>  5x3 </td><td>  6 </td><td>  0s </td><td>  14 </td><td>  0s </td></tr><tr><td>  sixteen </td><td>  4x4 </td><td>  five </td><td>  0s </td><td>  nineteen </td><td>  0s </td></tr><tr><td>  18 </td><td>  6x3 </td><td>  eight </td><td>  0s </td><td>  27 </td><td>  0s </td></tr><tr><td>  20 </td><td>  5x4 </td><td>  48 </td><td>  0s </td><td>  75 </td><td>  0s </td></tr><tr><td>  21 </td><td>  7x3 </td><td>  sixteen </td><td>  0s </td><td>  91 </td><td>  0s </td></tr><tr><td rowspan="2">  24 </td><td>  6x4 </td><td>  27 </td><td>  2 minutes </td><td>  118 </td><td>  2 minutes </td></tr><tr><td>  8x3 </td><td>  sixteen </td><td>  1 minute </td><td>  134 </td><td>  3 min </td></tr><tr><td>  25 </td><td>  5x5 </td><td>  22 </td><td>  3 min </td><td>  156 </td><td>  6min </td></tr><tr><td>  27 </td><td>  9x3 </td><td>  nineteen </td><td>  12min </td><td>  175 </td><td>  17min </td></tr><tr><td>  28 </td><td>  7x4 </td><td>  45 </td><td>  41min </td><td>  220 </td><td>  59min </td></tr><tr><td rowspan="2">  thirty </td><td>  6x5 </td><td>  55 </td><td>  3h </td><td>  275 </td><td>  4h </td></tr><tr><td>  10x3 </td><td>  nineteen </td><td>  2h </td><td>  294 </td><td>  6h </td></tr><tr><td>  32 </td><td>  8x4 </td><td>  112 </td><td>  17h </td><td>  406 </td><td>  23h </td></tr><tr><td>  33 </td><td>  11x3 </td><td>  22 </td><td>  20h </td><td>  428 </td><td>  2 days </td></tr><tr><td>  35 </td><td>  7x5 </td><td>  158 </td><td>  7d </td><td>  586 </td><td>  9d </td></tr><tr><td rowspan="3">  36 </td><td>  6x6 </td><td>  46 </td><td>  12d </td><td>  632 </td><td>  21d </td></tr><tr><td>  9x4 </td><td>  69 </td><td>  16d </td><td>  701 </td><td>  37d </td></tr><tr><td>  12x3 </td><td>  20+ </td><td>  8 days + </td><td>  720+ </td><td>  45 days + </td></tr></tbody></table><br>  It is worth noting that: <ul><li>  The generator worked more than 45 days. </li><li>  Tasks up to square 32 were generated on the first day. </li><li>  The search for tasks with an area of ‚Äã‚Äã36 took 36 days. </li><li>  An unexpectedly large number of tasks were found for 8x4 and 7x5 dimensions: 112 and 158, respectively.  This is significantly more than for other dimensions. </li></ul><br><br><h5>  Coloring coloring </h5><br>  The first three filters operate only on face states as a set of bits.  The following filters operate in terms of shapes.  To translate a set of binary states into a set of figures, use a single-pass algorithm for coloring partitions into separate figures: <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> color = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; H; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; W; ++j) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (painted[i][j] == <span class="hljs-number"><span class="hljs-number">0</span></span>) { flood(i, j, color++); } } }</code> </pre> <br>  Here, the flood function fills the shape, starting at the cell (i, j), using a queue of adjacent cells belonging to the same shape.  The total complexity of this coloring algorithm is linear in the number of squares - O (W * H). <br><br><h4>  Rotation figures </h4><br>  Rotated figures are searched in selected brute force splits.  For each figure, a set of all possible turns and reflections ‚Äî transformations ‚Äî is considered: 4 turns and a reflection ‚Äî a total of eight options.  For Triplex, the maximum is 4: at the rods 2 each, at the corners 4. If in the initial set of figures, one is replaced with any transformation of it, and a solution cannot be made from the new set, then this <br>  the shape can be allowed to rotate - the solution will remain the same.  Further, from the set of rotated figures, one is chosen for the game, which most complicates the task of finding a Solver solution.  The selected shape is rotated randomly. <br>  Intuitively, it seems that tasks with turning figures are easier to solve - we collect all the figures, leaving free space. <br>  for turning, and then more likely that the figure will fit into the left place.  However, when you consider that by making a figure <br>  when turning, we do not add new solutions, the number of combinations that Solver has to check, <br>  increases by as many times as many different transformations of a rotated figure (2 or 4 for Triplex). <br>  One could choose several rotated figures, for example, one of the most complicating decision subsets of figures.  Perhaps in future versions this will be done. <br><br><h4>  How tasks are ordered </h4><br>  Solver solves problems in a natural way, sequentially going through possible combinations.  Solving the problem, Solver assigns it a difficulty level - the number of iteration cycles performed, which is limited from above by the number of possible combinations, calculated using the formula C! / (C <sub>1</sub> ! C <sub>2</sub> ! ... C <sub>m</sub> !).  Triplex tasks are ordered by increasing the level of complexity described.  Such an assessment of complexity does not coincide with the complexity experienced by a person.  In order to estimate the complexity of each task from the player‚Äôs point of view, anonymous statistics of the solution time of each task are kept on the server.  In the future, I hope, such statistics will help streamline tasks better. <br><br><h4>  Other variants of the generation algorithm </h4><br>  The search for all possible partitions is not the only possible way to search for all tasks that satisfy the condition of the game.  You can search for tasks by going through all sorts of sets of figures, which by the total area coincide with the area of ‚Äã‚Äãthe solution.  In Triplex, for example, there are a total of 8 different figures: two double sticks, two triple sticks and four triple corners. <br><img src="http://www.quadpuzzle.ru/triplex/img/story/Story-shapes8.png"><br><br>  For the 6x6 = 36 task, the maximum number of figures is 18, the minimum is 12. Thus, the number of sets can be estimated from above with the value of 8 <sup>18</sup> / (2! <sup>6</sup> 3! 3!) = 2 <sup>48/9</sup> &lt;2 <sup>45</sup> (each of the 18 figures can be one of 8 possible, and divided by the minimum number of permutations) and below 8 <sup>12</sup> / (8! 4!)&gt; 2 <sup>16</sup> (each of the 12 figures can be one of 8, and divided by the maximum number of permutations).  For ordered sets, the formulas are the same, but without divisors.  On the one hand, there will be more ordered options, but, most likely, it will be possible to come up with a more optimal border traversal. <br>  It is possible to sort through all possible eights of numbers (a <sub>1</sub> , a <sub>2</sub> , ... a <sub>8</sub> ), where a <sub>i</sub> is the number of i-th figures in the solution.  For such eights, there is a linear restriction on the total area of ‚Äã‚Äãthe figures: <br>  2 * a <sub>1</sub> + 2 * a <sub>2</sub> + 3 * a <sub>3</sub> + 3 * a <sub>4</sub> + ... + 3 * a <sub>8</sub> = 36 <br>  The program, which worked according to this algorithm, found all levels of Triplex in 2 hours.  This is 500 times faster than it took to iterate over partitions.  The truth is worth noting that the complexity increases exponentially.  Over the next two weeks, this method found only 1300 levels. <br><br><h3>  Client part of the game </h3><br>  An important part of the game is a program that provides the player with the opportunity to solve the generated tasks.  The game is written in HTML, CSS and JavaScript (total 2100 lines).  All logic, all resources and even all 700+ levels fit in one html file.  Therefore, once you download the game, you can go through to the very end without a network connection. <br><br><h4>  Graphic design </h4><br>  The graphics in the game is very simple, without pictures, not counting the background.  The squares are made in the form of multicolored &lt;div&gt; s with a gradient fill.  The circle inside the rotated square is also a square, only with maximally rounded borders and a reverse gradient fill.  It turned out that IE9 does not provide such a trick and the gradient fill of the circle is still square. <br>  The background in the game I wanted to make alive.  On it should have been put to sleep slowly gray circles from divines.  Apparently inspired design HTC Sense.  However, I came across two obstacles. <br>  First of all: forcing them to fly very smoothly did not work: the movement for one pixel per second for some reason looked abrupt, jerked.  I tried to shift more often in increments of less than 1.0, but they still shifted discretely. <br>  Secondly: in some browsers for Android, even several large circles loaded the system very heavily.  So I just made a static image from the background and 'stitched' it inside the html file with this CSS spell: background-image: url (data: image / png; base64, / 9j / 4AAQSkZ ... =); <br>  To adjust the size of the squares to the size and resolution of the screen, I did not use sprites, because when scaling they become fuzzy. <br>  Maybe someone will ask why I did not use HTML5 Canvas for 2D graphics?  I agree that for such simple graphics, the Canvas functionality would fit very well.  But it so happened that when I wrote the prototype, I knew one unpleasant <a href="http://tomlee.co/2009/06/html-5-canvas-stroke-coordinates/">feature of</a> the Canvas grid: the integer coordinates indicate the intervals between pixels.  Also, the performance of the Canvas on my new tablet was not encouraging.  Therefore, the first prototype used HTML DOM and squares from DIV elements that survived to the final version. <br><br><h4>  Saving Levels Passed </h4><br>  The perception of HTML games for most people whom I showed Triplex, made them worry about saving the results of the passage.  Usually they asked somewhere at the 15-30 level: ‚ÄúAnd if the network turns off or the computer hangs, will you have to go through everything again?‚Äù <br>  Probably it is important to note that the game is automatically saved every 10 seconds in your browser profile on your hard drive.  Therefore, do not be afraid to turn off the computer or refresh the page.  The save mechanism uses <a href="http://freehabr.ru/blog/html/1041.html">HTML5 localStorage</a> .  This, as well as the fact that all levels are stored in the game itself, allows you to play without a network connection. <br>  However, localStorage has a reverse side of the coin, which I discovered during beta testing, deciding to register a new domain name and move the game to a new address.  The fact is that localStorage is tied to the domain name of the site.  It turns out that if a player downloads a game from another site, then he will have to start all over again.  To systematically approach the issue, let's clarify what localStorage is still attached to.  To a local disk, which means that you will not play on another device (either at work, or at home, or on the phone).  There is also a binding to the browser, we do not know where and in what format localStorage is stored.  Here my hands reached out to the good old checked cookies, logins, passwords and server support with clever scripts.  And while laziness resisted, it was decided to resort to an even more ancient method of those times, when our great-grandfathers were still pulling the ears off the black-and-white TV and the <a href="http://ru.wikipedia.org/wiki/Dendy">Dandy</a> console.  Yes, you guessed it, I'm talking about writing the level number and its code in pencil on a piece of paper.  The code can be found in the game options. <br><br><h4>  Internationalization and localization </h4><br>  I promised my aunt that I would finish the game and she could play.  Therefore, I decided to realize the opportunity to translate the game into Russian or another language.  This possibility is called internationalization, and in the circle of developers i18n is designated, because in the English word internacionalization there are 18 characters between the first i and the last n. <br>  I got such a simple idea of ‚Äã‚Äãimplementing i18n that I didn‚Äôt even have to look for ready-made solutions.  For each HTML element that contains language text, the class 'i18n' was specified.  For example: &lt;span class = 'i18n'&gt; simple graphics &lt;/ span&gt;.  In the game code, I18N structure is entered, which contains translations of all phrases: <br><br><pre> <code class="javascript hljs"> <span class="hljs-comment"><span class="hljs-comment">//   var I18N = { "OK": { ru: "OK", fr: "bon", de: "OK", zh: "??" }, "simple graphics": { ru: " ", fr: "graphiques simple", de: "einfache Graphik", zh: "????" }, ... }</span></span></code> </pre><br>  When the language is first changed, for all elements of the i18n class, their original content is stored in the origHTML field and replaced with the translation specified in the I18N structure. <br>  The phrase 'N seconds / minutes / hours / days ago' required a context-sensitive translation.  For this we had to complicate the logic a bit.  In the I18N structure, instead of translation, you can specify a function that translates depending on the context: <br><br><pre> <code class="javascript hljs"> <span class="hljs-string"><span class="hljs-string">"seconds ago"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">en</span></span>: i18nSecondsAgoEn, <span class="hljs-attr"><span class="hljs-attr">ru</span></span>: <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">b</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">i18nSecondsAgoRu</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">b</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>, <span class="hljs-attr"><span class="hljs-attr">fr</span></span>: <span class="hljs-string"><span class="hljs-string">" il ya quelques seconds"</span></span>, <span class="hljs-attr"><span class="hljs-attr">de</span></span>: i18nSecondsAgoDe, <span class="hljs-attr"><span class="hljs-attr">zh</span></span>: <span class="hljs-string"><span class="hljs-string">" ???"</span></span> }, ... function &lt;b&gt;i18nSecondsAgoRu&lt;<span class="hljs-regexp"><span class="hljs-regexp">/b&gt;(context) { return i18nNumberRu(context, '', '', ''); } ... function i18nNumberRu(context, num0, num1, num2) { var num = +context; var result; if (num &gt;= 20) { num = num % 10; } if (num == 1) { result = num1; } else if (2 &lt;= num &amp;&amp; num &lt;= 4) { result = num2; } else { result = num0; } return context + ' ' + result + ' '; }</span></span></code> </pre><br><br>  Russian localization (l10n = localization) was done by myself, French, German, and Chinese; I made friends: Julia, Masha, Sergei, and <a href="http://habrahabr.ru/users/AlexeiZavjalov/">Alexey</a> . <br><br><h3>  Table of achievements </h3><br>  For players who are interested in competitive spirit, the game is complemented by server support for the achievement table, which is available from the main page of the game.  The achievement table for each level stores the name of the player who decided this level first. <br>  Playing online: <ul><li>  all players see who and how long ago was the first to decide the current level; </li><li>  after passing each level, the time of passing the level is sent to the server, and if no one has passed this level yet, then you can also enter your name in the table. </li></ul><br><br><h4>  How to hack the game </h4><br>  I am sure that there will be craftsmen who will try to enroll in the table of records, not solving the problem of the game.  I want to say that in the forehead this will not work.  To mark on the server your passing level, you must provide a checksum of the solution.  This checksum is also needed in order to proceed to the next level.  That is, each level in the game is encoded by the decision of the previous one. <br>  I also tried to protect the server side from hacking: <ul><li>  there are checks for all input parameters; </li><li>  escaping special characters in SQL queries; </li><li>  escaping special HTML characters in the high score table. </li></ul><br>  It is easy to spoil the statistics on the passage time, but it does not affect the game in any way, and is made only for an approximate assessment of the difficulty levels. <br><br><h3>  Questions of preparing the site and placing the game on the Internet </h3><br>  To share the game not only with friends, but also with a large Internet audience, I had to immerse myself in the study of a large number of related technologies: hosting, domain name registration, forums, social networks, web services, openID, ... All these terms are well-known among most users. but even in order to simply decide whether or not this or that technology is suitable for solving specific problems, it is necessary to study it more deeply. <br><br><h3>  Money issue </h3><br>  It turned out that not everything in this world can be done for free.  While the cost of the game is quite modest: 150 rubles / year for a domain name, 300 rubles / year for a simple hosting, not burdened by advertising.  Recently, I transferred the game to a free hosting service provided by friends ( <a href="http://habrahabr.ru/users/AlexeiZavjalov/" rel="friend">AlexeiZavjalov</a> , <a href="http://habrahabr.ru/users/vitroot/" rel="friend">vitroot</a> ) and installed the <a href="http://www.phpbb.com/">phpBB3</a> forum engine on it.  I do not plan to transfer Triplex to commercial rails, and I will try to keep the game free and free from advertising.  In the future, perhaps, I will lay out the source code of the level generator.  Although, I think, it will not be difficult for any programmer to write it himself by reading this article. <br><br><h2>  Conclusion </h2><br>  Well, that seems to be all that while there was time to tell.  I hope you enjoy the game as much as I was interested in creating it. </div><p>Source: <a href="https://habr.com/ru/post/141085/">https://habr.com/ru/post/141085/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../141078/index.html">Facebook Welcome Page and Other Custom Tabs Guide</a></li>
<li><a href="../141080/index.html">Assert. What is it?</a></li>
<li><a href="../141082/index.html">IBM Science and Technology Center in Moscow</a></li>
<li><a href="../141083/index.html">How we are working</a></li>
<li><a href="../141084/index.html">Developer Toolkit: SQL Assistant</a></li>
<li><a href="../141086/index.html">Modal windows for rails</a></li>
<li><a href="../141087/index.html">LG Cinema 3D 2012 - new design, new filling, new quality 3D video</a></li>
<li><a href="../141088/index.html">Installing Hackintosh on the example of Packard Bell TM85</a></li>
<li><a href="../141089/index.html">Online courses Stanford University, Berkley and MIT in an accessible form</a></li>
<li><a href="../141090/index.html">A child in a family geek or baby monitor with his own hands</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>