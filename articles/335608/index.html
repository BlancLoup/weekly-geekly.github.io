<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>In a section: the news aggregator on Android with backend. Configuration Management System (Puppet)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction (with links to all articles) 

 In ITIL (v3), among the described processes, there are 2 particularly interesting ones: the ‚ÄúConfiguratio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>In a section: the news aggregator on Android with backend. Configuration Management System (Puppet)</h1><div class="post__text post__text-html js-mediator-article">  <a href="https://habrahabr.ru/post/334510/">Introduction (with links to all articles)</a> <br><br>  In ITIL (v3), among the described processes, there are 2 particularly interesting ones: the ‚ÄúConfiguration Management Process‚Äù and the ‚ÄúChange Management Process‚Äù, intended for analyzing and managing system configuration changes.  To continue the narration, you need to decide what the "system" is.  This concept includes a huge number of components that affect (directly or indirectly) the provision of services: <br><br><ul><li>  servers 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  security settings (users, groups, rights, firewalls); </li><li>  installed applications and libraries; </li><li>  application settings (limits on descriptors, memory, CPU time, etc.); </li><li>  backup; </li></ul><br></li><li>  monitoring systems for the application and system software; </li><li>  configuration files of the product itself, its components, auxiliary system and application applications </li><li>  ... </li></ul><br>  Trying to minimize the contour of the system of your project (type, backup does not relate to the functioning of the system) - it means to dig yourself a pit into which you will fall sooner or later. <br><a name="habracut"></a><br><br>  This list of system components is at least for most projects deployed on more than one server (and even on one).  At the same time, their number changes as the project develops and grows.  In the absence of any process of their accounting, it becomes obvious what this leads to: you have a test stand (or development stand) on which everything works perfectly, but an attempt to duplicate it on production or create a new stand leads to: <br><br><ul><li>  a very long process of deployment / duplication (everyone remembers what and how is set up as failures occur and often compares the settings with the existing stand); </li><li>  Suddenly, there are problems in the operation of the deployed product (they forget to make any adjustments that they made at the last moment on the test bench, but did not transfer to the product); </li><li>  the testing process is slowed down (each publication of a new build, even for internal testers, is a feat in both time and complexity); </li><li>  and finally - there is fear among developers before the release of the new version and, as a result, delaying the calculation of the new release (no one will say a real serious problem, but its effect will be felt constantly). </li></ul><br>  As a result, the environment for the correct operation of your product is a way out of your control and the available automation and version tools. <br><br><h3>  Motivation </h3><br>  Things seem obvious, but in most development groups their eyes are closed - many people argue that they have only one server, few settings, competence of workers (the argument ‚Äúwe have professionals and are not going to leave‚Äù, simply dumped me), small risks, etc.  etc. <br><br>  Despite the seeming complexity and redundancy of what is described in ITIL (there really is a lot of things written), first of all we need to take the requirements for automation of these processes from it.  Automating the assembly, automating the testing, automating the search for a vulnerability is all implemented and is considered by all as a necessary minimum during development.  Automation speeds up the process, instills confidence, provides transparency and a guaranteed result, as well as removes fear from the performers for the timing and result. <br><br><h3>  Motivation for a lone developer </h3><br>  Taking into account the powerful introductory part in the previous paragraph, the advantages for a single developer will be described more easily and more briefly: <br><br><ul><li>  because  development is not carried out daily, as a result, some features of the deployment disappear smoothly after a couple of days; </li><li>  automation for a loner - the most reliable partner; </li><li>  The speed of work performed by automation allows us not to lose the ignition and the desire to develop the project (this is a very important specific moment). </li></ul><br><h3>  Important disclaimer about ITIL </h3><br>  Do not try to take, from the processes described in ITIL, all the steps that are described there - the situation will be worse than before!  I know how such steps are implemented in some banking systems and what this leads to (especially without automation) - the bureaucratic machine will stifle any dynamically developing project / system. <br><br><h3>  Puppet </h3><br>  In my case, <a href="https://puppet.com/">Puppet</a> was chosen.  When choosing between <a href="https://www.chef.io/chef/">Chef</a> and <a href="https://www.ansible.com/">Ansible</a> , the choice in favor of it was made taking into account a <a href="https://docs.puppet.com/">good documentation base</a> , good support, a <a href="https://forge.puppet.com/">large number of modules (from developers and the community)</a> , active project development and implementation in Ruby (which is more or less familiar to me). <br><br>  Frankly, the learning curve for Puppet was anything but gentle.  Due to the fact that a large number of all sorts of elements are used in the developed system, each of them can be configured differently and all this can be deployed on different stands - the study of the tool required a complete and thorough.  As the tool was studied, some of its drawbacks (in most cases, ‚Äúby-design‚Äù) and limitations (a <a href="http://radar.oreilly.com/2015/04/the-puppet-design-philosophy.html">good article on the Puppet philosophy explaining some architectural solutions</a> ) became obvious.  Also, as I studied the already and partial implementation of the necessary scripts, I learned a little more about Ansible, in which some problems that exist in Puppet were solved (which will not cancel the possibility of having their own problems, which are absent in Puppet).  So, the subsequent story is not an advertisement for Puppet, but a description of the possibilities and experience of use. <br><br><h3>  Little bit about puppet </h3><br>  Puppet uses its own configuration language (DSL), which was designed to be accessible to system administrators.  The Puppet language is positioned as a non-formal programming knowledge and its syntax was influenced by the format of the Nagios configuration files. <br><br>  The main purpose of the Puppet language is to identify resources (resources in Puppet are files, directories, services, limits, firewalls, users, etc.).  All other parts of the language exist only to add flexibility and convenience in how resources are defined. <br><br>  Resource groups can be organized into classes that are larger configuration units.  While a resource can describe a single file / directory or package, a class can describe everything that is needed to configure a service or application (including the required number of packages, configuration files, daemons / services, and maintenance tasks).  Smaller classes can be combined into large ones that describe the whole system role - ‚Äúdatabase server‚Äù or ‚Äúworking cluster node‚Äù. <br><br>  An example of a class with resources inside: <br><br><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">apache</span></span></span><span class="hljs-class"> </span></span>(String $version = <span class="hljs-string"><span class="hljs-string">'latest'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> {<span class="hljs-string"><span class="hljs-string">'httpd'</span></span>: ensure =&gt; $version, # Using the <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parameter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">above</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">before</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">File</span></span></span><span class="hljs-class">['/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">etc</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">httpd</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">conf</span></span></span><span class="hljs-class">'], </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">} file {'/etc/httpd.conf': ensure =&gt; file</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">owner =&gt; 'httpd'</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">content =&gt; template</span></span></span></span>(<span class="hljs-string"><span class="hljs-string">'apache/httpd.conf.erb'</span></span>), # Template from a module } service {<span class="hljs-string"><span class="hljs-string">'httpd'</span></span>: ensure =&gt; running, enable =&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>, subscribe =&gt; File[<span class="hljs-string"><span class="hljs-string">'/etc/httpd.conf'</span></span>], } }</code> </pre> <br>  Machines that perform different roles should, in general, get a different set of classes.  The task of configuring which classes will be applied to which machines is the task of the Puppet nodes. <br><br>  Examples of determining Puppet nodes: <br><br><pre> <code class="hljs pgsql">node <span class="hljs-string"><span class="hljs-string">'www1.example.com'</span></span>, <span class="hljs-string"><span class="hljs-string">'www2.example.com'</span></span>, <span class="hljs-string"><span class="hljs-string">'www3.example.com'</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> common <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> apache, squid } node /^(foo|bar)\.example\.com$/ { <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> common }</code> </pre> <br>  Hiera Facts and Database.  Before executing the Puppet code, information about the node is collected, the collected information is arranged in the form of predefined facts - variables that can be used anywhere in the code.  Hiera is a built-in ‚Äúkey-value‚Äù database.  By default, the YAML or JSON format files are used as the data source, although an extension is possible to use any data source.  Due to its hierarchy and the possibility of changing data depending on the node - its use is an integral part of the work of most modules / classes. <br><br>  Modules are self-contained blocks of code and data (classes, templates, files, etc.).  These reusable, publicly accessible elements are the basic building blocks of Puppet. <br><br>  Those planning to use Puppet will basically have to create classes and sometimes modules. <br><br><h3>  Deployment Options </h3><br>  When implementing Puppet, 2 options are possible with and without centralized configuration storage: <br><br><ul><li>  Centralized storage configuration: the advantages are clearly seen in the presence of a large number of servers.  In this case, information relating only to the machine itself is transmitted to client machines, which also provides some level of security and minimizes traffic. </li><li>  Decentralized configuration storage: justified with a small number of servers, while the machines must have a complete set of configuration scripts and files and when they start up the agents will be compiled and executed on the part related to this machine.  It is implemented by the usual cron-task, launched every 15 minutes. </li></ul><br>  My script looks like this: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh PUPPET_BIN='/opt/puppetlabs/bin/puppet' #      apt-get update &amp;&amp; apt-get -y install git mc htop apt-transport-https nano wget lsb-release apt-utils curl python #    `puppet-agent` if [ ! -d /etc/puppetlabs ]; then rm *.deb.* *.deb # possible trash wget https://apt.puppetlabs.com/puppetlabs-release-pc1-xenial.deb &amp;&amp; dpkg -i puppetlabs-release-pc1-xenial.deb apt-get update &amp;&amp; apt-get -y install puppet-agent fi #   `environment` /opt/puppetlabs/bin/puppet config set environment $PUPPET_ENV if [ ! -d /etc/puppetlabs/code/environments/$PUPPET_ENV ]; then cp -r /etc/puppetlabs/code/environments/production /etc/puppetlabs/code/environments/$PUPPET_ENV fi # Install puppet modules $PUPPET_BIN module install puppetlabs-ntp $PUPPET_BIN module install aco-oracle_java $PUPPET_BIN module install puppetlabs-firewall $PUPPET_BIN module install saz-ssh $PUPPET_BIN module install saz-sudo $PUPPET_BIN module install saz-limits $PUPPET_BIN module install thias-sysctl $PUPPET_BIN module install yo61-logrotate $PUPPET_BIN module install puppetlabs-apt $PUPPET_BIN module install puppet-archive # git pull "deployment" project and go in it only if POVISION_NO_GIT_CLONE set to "true" if [ ${POVISION_NO_GIT_CLONE:-"false"} = "true" ]; then echo "do nothing" else LOCAL_REV="" if [ -f local_latest.sha1 ]; then LOCAL_REV=`cat local_latest.sha1` fi REMOTE_REV=`git ls-remote --tags | grep "latest" | awk '{print $1}'` if [ $LOCAL_REV = $REMOTE_REV ]; then exit 0 fi git fetch --all --tags --prune git checkout -f tags/latest fi # replace puppet configs cp puppet_config/hiera.yaml /etc/puppetlabs/code/environments/$PUPPET_ENV/ # replace hiera db rm /etc/puppetlabs/code/environments/$PUPPET_ENV/hieradata/* cp -r $PUPPET_ENV/hieradata/* /etc/puppetlabs/code/environments/$PUPPET_ENV/hieradata # replace storyline_* modules rm -r /etc/puppetlabs/code/environments/$PUPPET_ENV/modules/storyline_* cp -r modules/* /etc/puppetlabs/code/environments/$PUPPET_ENV/modules # copy site.pp cp $PUPPET_ENV/site.pp /etc/puppetlabs/code/environments/$PUPPET_ENV/manifests/site.pp #echo "hostname:" #hostname $PUPPET_BIN apply /etc/puppetlabs/code/environments/$PUPPET_ENV/manifests/site.pp echo $REMOTE_REV &gt; local_latest.sha1</span></span></code> </pre> <br>  In my case, of course, a decentralized system is used, since  it is easier to implement (from the point of view of the organization of the infrastructure) and it greatly simplifies the build scripts for deploying a test bench, which I create and run several dozen times a day. <br><br>  When running the specified script: <br><br><ol><li>  the Puppet client itself and the necessary packages are installed </li><li>  the necessary Puppet modules are installed </li><li>  checking the change of the commit number for the ‚Äúlatest‚Äù label (done with successful integration testing of the new version) </li><li>  replaces the configuration (hiera.yaml) of the Hiera Puppet database in the current environment ($ PUPPET_ENV variable); </li><li>  replaces the YAML data files for the Hiera Puppet database; </li><li>  copied with the replacement of the description of my modules; </li><li>  the configuration with nodes (servers of my system) is copied; </li><li>  invokes all the settings that were copied / set ($ PUPPET_BIN apply ....) </li></ol><br>  The list of tasks that the Puppet client performs at startup is huge (checking and doing it with your hands would be simply impossible): <br><br><ul><li>  limits are set for open files, the amount of memory involved, swapping and the number of connections; </li><li>  log rotation is configured (both for the system, and for my application and the services it needs); </li><li>  create the necessary user accounts for administration with the necessary groups and powers; </li><li>  the NTP server is installed and configured; </li><li>  SSH server is installed and configured; </li><li>  installs Oracle JDK; </li><li>  firewall is configured; </li><li>  A large number of components necessary for the operation of a project or its component on this particular node are installed and configured. </li></ul><br><br><h3>  Life examples </h3><br>  When developing the Puppet script system for my stand, I developed my own modules that are copied to the machine / container on which the Puppet code was executed.  The modules contain data (in most configuration files) and Puppet code for configuration.  I carried out the basic settings from the scripts in Hiera - as a result, the scripts turned out to be quite universal and independent of the nodes on which they are executed. <br><br>  I will give some examples of code and settings. <br><br>  Setting up ngnix (not from the packages, but from the native repository) (hiding the spoiler in the block due to the size. But for those interested - required to view A lot of the nuances are visible when studying it) <br><div class="spoiler">  <b class="spoiler_title">The nginx class from the storyline_infra module</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk">class storyline_infra::nginx () { <span class="hljs-string"><span class="hljs-string">$p</span></span>arams = lookup({<span class="hljs-comment"><span class="hljs-comment">"name"</span></span> =&gt; <span class="hljs-comment"><span class="hljs-comment">"storyline_infra.nginx"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"merge"</span></span> =&gt; {<span class="hljs-comment"><span class="hljs-comment">"strategy"</span></span> =&gt; <span class="hljs-comment"><span class="hljs-comment">"deep"</span></span>}}) <span class="hljs-string"><span class="hljs-string">$r</span></span>everse_port = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'reverse_port'</span></span>] <span class="hljs-string"><span class="hljs-string">$r</span></span>everse_url = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'reverse_url'</span></span>] <span class="hljs-string"><span class="hljs-string">$p</span></span>id_file = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'pid_file'</span></span>] <span class="hljs-string"><span class="hljs-string">$i</span></span>nit_script = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'init_script'</span></span>] <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_data = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'dir_data'</span></span>] <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_logs = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'dir_logs'</span></span>] <span class="hljs-string"><span class="hljs-string">$v</span></span>ersion = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'version'</span></span>] <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_startup = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'enabled_startup'</span></span>] <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_running = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'enabled_running'</span></span>] # topology_configuration <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_topology_configuration = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'enabled_topology_configuration'</span></span>] <span class="hljs-string"><span class="hljs-string">$t</span></span>opology_configuration_port = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'topology_configuration_port'</span></span>] #    ( ) user { <span class="hljs-string"><span class="hljs-string">'nginx'</span></span>: ensure =&gt; <span class="hljs-comment"><span class="hljs-comment">"present"</span></span>, managehome =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, } #    ( ) exec { <span class="hljs-comment"><span class="hljs-comment">"nginx-mkdir"</span></span>: command =&gt; <span class="hljs-comment"><span class="hljs-comment">"/bin/mkdir -p /data/db &amp;&amp; /bin/mkdir -p /data/logs"</span></span>, cwd =&gt; <span class="hljs-comment"><span class="hljs-comment">"/"</span></span>, unless =&gt; <span class="hljs-string"><span class="hljs-string">'/usr/bin/test -d /data/db -a -d /data/logs'</span></span>, } -&gt; # working dir file { [ <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_logs, <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_data] : ensure =&gt; <span class="hljs-comment"><span class="hljs-comment">"directory"</span></span>, recurse =&gt; <span class="hljs-comment"><span class="hljs-comment">"true"</span></span>, owner =&gt; <span class="hljs-comment"><span class="hljs-comment">"nginx"</span></span>, group=&gt; <span class="hljs-comment"><span class="hljs-comment">"nginx"</span></span>, require =&gt; <span class="hljs-type"><span class="hljs-type">Exec</span></span>[<span class="hljs-string"><span class="hljs-string">'nginx-mkdir'</span></span>], } #       ( ) # see by <span class="hljs-comment"><span class="hljs-comment">"gpg --verify keyfile"</span></span> apt::key { <span class="hljs-string"><span class="hljs-string">'nginx-key'</span></span>: id =&gt; <span class="hljs-string"><span class="hljs-string">'573BFD6B3D8FBC641079A6ABABF5BD827BD9BF62'</span></span>, source =&gt; <span class="hljs-string"><span class="hljs-string">'http://nginx.org/keys/nginx_signing.key'</span></span>, } -&gt; #   ( ) # deb http://nginx.org/packages/ubuntu/ xenial nginx apt::source { <span class="hljs-string"><span class="hljs-string">'nginx-repo'</span></span>: comment =&gt; <span class="hljs-string"><span class="hljs-string">'nginx repo'</span></span>, location =&gt; <span class="hljs-comment"><span class="hljs-comment">"http://nginx.org/packages/ubuntu/"</span></span>, release =&gt; <span class="hljs-comment"><span class="hljs-comment">"xenial"</span></span>, repos =&gt; <span class="hljs-comment"><span class="hljs-comment">"nginx"</span></span>, include =&gt; { <span class="hljs-string"><span class="hljs-string">'deb'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">'deb-src'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, }, } -&gt; #    ( ) package { <span class="hljs-string"><span class="hljs-string">'nginx'</span></span>: ensure =&gt; <span class="hljs-string"><span class="hljs-string">$v</span></span>ersion, # notify =&gt; <span class="hljs-type"><span class="hljs-type">Exec</span></span>[<span class="hljs-string"><span class="hljs-string">'disable_nginx'</span></span>], } ‚Üí #        ( ).        ,    .   !!! file { <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/nginx.conf"</span></span>: replace =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, content =&gt; epp(<span class="hljs-string"><span class="hljs-string">'storyline_infra/nginx.epp'</span></span>), owner =&gt; <span class="hljs-comment"><span class="hljs-comment">"nginx"</span></span>, group=&gt; <span class="hljs-comment"><span class="hljs-comment">"nginx"</span></span>, notify =&gt; <span class="hljs-type"><span class="hljs-type">Service</span></span>[<span class="hljs-string"><span class="hljs-string">'nginx'</span></span>], }-&gt; #        ( ) file { <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/conf.d/default.conf"</span></span>: replace =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, content =&gt; epp(<span class="hljs-string"><span class="hljs-string">'storyline_infra/nginx_default.epp'</span></span>), owner =&gt; <span class="hljs-comment"><span class="hljs-comment">"nginx"</span></span>, group=&gt; <span class="hljs-comment"><span class="hljs-comment">"nginx"</span></span>, notify =&gt; <span class="hljs-type"><span class="hljs-type">Service</span></span>[<span class="hljs-string"><span class="hljs-string">'nginx'</span></span>], }‚Üí #        ( ) file { <span class="hljs-string"><span class="hljs-string">$i</span></span>nit_script: replace =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, content =&gt; epp(<span class="hljs-string"><span class="hljs-string">'storyline_infra/nginx_startup.epp'</span></span>), mode=&gt;<span class="hljs-comment"><span class="hljs-comment">"ug=rwx,o=r"</span></span>, notify =&gt; <span class="hljs-type"><span class="hljs-type">Service</span></span>[<span class="hljs-string"><span class="hljs-string">'nginx'</span></span>], }‚Üí #  /  ( ) service { <span class="hljs-string"><span class="hljs-string">'nginx'</span></span>: ensure =&gt; <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_running, enable =&gt; <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_startup, start =&gt; <span class="hljs-comment"><span class="hljs-comment">"${init_script} start"</span></span>, stop =&gt; <span class="hljs-comment"><span class="hljs-comment">"${init_script} stop"</span></span>, status =&gt; <span class="hljs-comment"><span class="hljs-comment">"${init_script} status"</span></span>, restart =&gt; <span class="hljs-comment"><span class="hljs-comment">"${init_script} restart"</span></span>, hasrestart =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, hasstatus =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, } #   nginx ( ) if <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_topology_configuration { file { <span class="hljs-comment"><span class="hljs-comment">"/etc/nginx/conf.d/topology.conf"</span></span>: replace =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, content =&gt; epp(<span class="hljs-string"><span class="hljs-string">'storyline_infra/nginx_topology.epp'</span></span>), mode=&gt;<span class="hljs-comment"><span class="hljs-comment">"ug=rwx,o=r"</span></span>, notify =&gt; <span class="hljs-type"><span class="hljs-type">Service</span></span>[<span class="hljs-string"><span class="hljs-string">'nginx'</span></span>], } } #     ( ) if <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_startup != <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> { exec { <span class="hljs-comment"><span class="hljs-comment">"disable_nginx"</span></span>: require =&gt; <span class="hljs-type"><span class="hljs-type">Package</span></span>[<span class="hljs-string"><span class="hljs-string">'nginx'</span></span>], command =&gt; <span class="hljs-comment"><span class="hljs-comment">"/bin/systemctl disable nginx"</span></span>, cwd =&gt; <span class="hljs-comment"><span class="hljs-comment">"/"</span></span>, } } }</code> </pre><br></div></div><br>  As you can see in each comments before the definition of the resource indicated - "if necessary."  Puppet will never perform any operations if the state of the resource already matches its definition. <br><br>  In this case, you can see how using the code <code>¬´$params = lookup({"name" =&gt; "storyline_infra.nginx", "merge" =&gt; {"strategy" =&gt; "deep"}})¬ª</code> get data from Hiera (examples I will give her data later), which are further used to fill all variables. <br><br>  Hiera configuration file: <br><pre> <code class="hljs objectivec">--- version: <span class="hljs-number"><span class="hljs-number">5</span></span> defaults: datadir: <span class="hljs-string"><span class="hljs-string">"hieradata"</span></span> data_hash: yaml_data hierarchy: - name: <span class="hljs-string"><span class="hljs-string">"1"</span></span> path: <span class="hljs-string"><span class="hljs-string">"nodes/%{trusted.certname}.yaml"</span></span> - name: <span class="hljs-string"><span class="hljs-string">"2"</span></span> path: <span class="hljs-string"><span class="hljs-string">"version.yaml"</span></span> - name: <span class="hljs-string"><span class="hljs-string">"3"</span></span> path: <span class="hljs-string"><span class="hljs-string">"common.yaml"</span></span></code> </pre><br>  In this case, the hierarchy is visible (the ‚Äúhierarchy key‚Äù) source, where each source at a higher level overrides the values ‚Äã‚Äãof the keys at a lower level.  This allows you to have a key, for example, ‚Äúwww.server.port‚Äù with a value of ‚Äú80‚Äù in ‚Äúcommon.yaml‚Äù and with a value of ‚Äú81‚Äù in ‚Äúnodes / webserver1.yaml‚Äù - in the end we will get the value of this key when executing Puppet code: "81" on the host named "webserver1" and "80" on all others. <br><br>  Hiera's common.yaml <br><pre> <code class="hljs kotlin">--- limits::entries: <span class="hljs-string"><span class="hljs-string">'*/nofile'</span></span>: both: <span class="hljs-number"><span class="hljs-number">1048576</span></span> <span class="hljs-string"><span class="hljs-string">'*/memlock'</span></span>: both: unlimited logrotate::config: su_user: root su_group: syslog compress: <span class="hljs-literal"><span class="hljs-literal">true</span></span> # sysctl sysctl::base::purge: <span class="hljs-literal"><span class="hljs-literal">false</span></span> sysctl::base::values: net.core.somaxconn: value: <span class="hljs-string"><span class="hljs-string">'65536'</span></span> vm.swappiness: ensure: absent fs.file-max: value: <span class="hljs-string"><span class="hljs-string">'500000'</span></span> vm.max_map_count: value: <span class="hljs-string"><span class="hljs-string">'262144'</span></span> storyline_base: oracle_java: version: <span class="hljs-string"><span class="hljs-string">"8u92"</span></span> storyline_infra: collectd: server_address: <span class="hljs-string"><span class="hljs-string">"XXX.nlp-project.ru"</span></span> pid_file: <span class="hljs-string"><span class="hljs-string">'/data/logs/collectd/collectd.pid'</span></span> init_script: <span class="hljs-string"><span class="hljs-string">'/etc/init.d/collectd'</span></span> dir_data: <span class="hljs-string"><span class="hljs-string">'/data/db/collectd'</span></span> dir_logs: <span class="hljs-string"><span class="hljs-string">'/data/logs/collectd'</span></span> version: <span class="hljs-string"><span class="hljs-string">"1.2.0-1"</span></span> enabled_mongodb: <span class="hljs-literal"><span class="hljs-literal">false</span></span> mongodb_user: <span class="hljs-string"><span class="hljs-string">"collectd"</span></span> mongodb_password: <span class="hljs-string"><span class="hljs-string">"######"</span></span> enabled_storm: <span class="hljs-literal"><span class="hljs-literal">false</span></span> enabled_elasticsearch: <span class="hljs-literal"><span class="hljs-literal">false</span></span> elasticsearch_port: <span class="hljs-string"><span class="hljs-string">"####"</span></span> elasticsearch_cluster: <span class="hljs-string"><span class="hljs-string">"elastic_storyline"</span></span> enabled_startup: <span class="hljs-literal"><span class="hljs-literal">false</span></span> enabled_running: <span class="hljs-literal"><span class="hljs-literal">true</span></span> influxdb: port_http: <span class="hljs-string"><span class="hljs-string">"####"</span></span> port_rpc: <span class="hljs-string"><span class="hljs-string">"####"</span></span> pid_file: <span class="hljs-string"><span class="hljs-string">'/data/logs/influxdb/influxdb.pid'</span></span> init_script: <span class="hljs-string"><span class="hljs-string">'/etc/init.d/influxdb'</span></span> dir_data: <span class="hljs-string"><span class="hljs-string">'/data/db/influxdb'</span></span> dir_logs: <span class="hljs-string"><span class="hljs-string">'/data/logs/influxdb'</span></span> version: <span class="hljs-string"><span class="hljs-string">"present"</span></span> enabled_auth: <span class="hljs-literal"><span class="hljs-literal">true</span></span> enabled_startup: <span class="hljs-literal"><span class="hljs-literal">false</span></span> enabled_running: <span class="hljs-literal"><span class="hljs-literal">true</span></span> ‚Ä¶.</code> </pre><br><br>  site.pp (Puppet site definition file) <br><pre> <code class="hljs ruby">node <span class="hljs-string"><span class="hljs-string">"XXX.nlp-project.ru"</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:limits</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:sysctl</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:base</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:logrotate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> storyline_base::ntp <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> storyline_base::srv_oper <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> storyline_base::ssh <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> storyline_base::oracle_java ‚Ä¶.. <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> storyline_infra::monit <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> storyline_base::firewall } node <span class="hljs-string"><span class="hljs-string">"YYYY.nlp-project.ru"</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:limits</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:sysctl</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:base</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-symbol"><span class="hljs-symbol">:logrotate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> storyline_base::ntp <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> storyline_base::srv_oper <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> storyline_base::ssh <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> storyline_base::oracle_java ‚Ä¶. <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> storyline_infra::zookeeper <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> storyline_components::server_storm <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> storyline_infra::monit <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> storyline_base::firewall }</code> </pre><br>  If someone is interested in a specific implementation of any of the tasks: write - write off the implementation in the comments or add to ‚ÄúTips‚Äù. <br><br>  Puppet is actively developing: there is a clear improvement in the syntax and unification of the behavior of classes depending on the context of use (however, there are still some specific features of the resolution of variables in different contexts, which sometimes leads to confusion). <br><br><h3>  Tips </h3><br><ul><li>  When developing a module, remember to write code not only to add a function, but also to disable it.  In the absence of such functionality, when transferring a component to another server, you will have 2 of them: in the new and in the old place ‚Äî in the old one you will need to be removed by hands, which contradicts the main task of automating configuration management; </li><li>  Good books on Puppet for beginners - <a href="https://www.amazon.com/Learning-Puppet-Second-Jussi-Heinonen/dp/1784399833">Learning Puppet</a> and <a href="https://www.amazon.com/Puppet-Essentials-Second-Felix-Frank-ebook/dp/B0166Y6YIU">Puppet 4 Essentials</a> ; </li><li>  A good module for getting artifacts from nexus sonatype (https://github.com/cescoffier/puppet-nexus); </li><li>  Take the maximum number of parameters into the Hiera data files for ease of node configuration and achieving the universality of the code for the modules themselves. </li></ul><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/335608/">https://habr.com/ru/post/335608/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335590/index.html">Social Organism - as a form of effective team interaction. Part 2</a></li>
<li><a href="../335592/index.html">Cisco Digital Network Architecture: Key Features of the New Platform</a></li>
<li><a href="../335600/index.html">Internet bicycles - how IT helps to lead a healthy lifestyle and reduce harmful emissions</a></li>
<li><a href="../335602/index.html">The hunt for malicious npm-packages</a></li>
<li><a href="../335606/index.html">Useful books on the development of mobile games on Android and iOS</a></li>
<li><a href="../335610/index.html">World Machine + UE4: Full Workflow</a></li>
<li><a href="../335612/index.html">How to conduct a non-ideal interview of a tester and why there is no ideal</a></li>
<li><a href="../335614/index.html">Log it: the method of the logarithmic derivative in machine learning</a></li>
<li><a href="../335616/index.html">Graphic Designers for the Mind and Soul: 20 New Lessons</a></li>
<li><a href="../335618/index.html">Why backup? We have the same RAID</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>