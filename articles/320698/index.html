<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rspamd mail anti-spam integration with opensmtpd</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The network has quite a bit of information about such integration. The fact that the problem is solved is indicated by rare comments on the sites, but...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rspamd mail anti-spam integration with opensmtpd</h1><div class="post__text post__text-html js-mediator-article"><p>  The network has quite a bit of information about such integration.  The fact that the problem is solved is indicated by rare comments on the sites, but I have not found a ready-made solution.  Perhaps this is due to the fact most use postfix / exim. </p><br><p>  Objectives of the article: </p><br><ol><li>  Describe the problem solving technique to make it easier for those who follow in my footsteps; </li><li>  To divert the attention of the community from the old-good-old postfix and company. </li></ol><br><a name="habracut"></a><br><h1 id="vvedenie">  Introduction </h1><br><p>  In the process of moving the finished web / mail / server infrastructure from the old server to the new server, I was faced with the need to re-deploy the mail infrastructure. </p><br><p>  The original mail system was deployed in 2012m year.  Ansible then only was born.  Configuration systems were not as common as they are now.  I then loved automating the work less than now, so everything was configured by hand. </p><br><p>  The new system should have been built on the docker (which means the most detailed description of building the system "for the future") and working in the docker cluster. </p><br><p>  The configs of the old system are preserved, but I really did not want to go back to the "dnl" sendmail, a bunch of lines describing postfix logic, an incomprehensible process of setting up amavis + spamasassin, a lot of memory that amavis + spamasassin needed.  It was decided to look for alternatives. </p><br><p>  So that no one says ‚Äúuse some kind of marginal software because you haven‚Äôt mastered postfix‚Äù, I‚Äôll clarify: mastered.  The original system consisted of postfix + dovecot + amavisd-new + spamasassin + dkim-proxy + razor + pyzord + dcc. </p><br><p>  Looking ahead: the final system consists of opensmtpd + dbmail + dkim-proxy + rspamd. </p><br><h1 id="nemnogo-teorii">  Some theory </h1><br><p>  opensmtpd is a lightweight mail daemon, with an elementary configuration process from the OpenBSD command.  The rules for configuring are so simple and intuitive that they are immediately remembered and allow you to describe in ten lines the complete logic of the mail server. </p><br><p>  dbmail - mail storage with pop / imap interface.  The main feature is mail storage in the database, which allows you to create an arbitrary number of entry points. </p><br><p>  rspamd - mail anti-spam system from developers from Rambler. </p><br><p>  More alternatives?  Why not Zimbra?  Why not some kind of <a href="https://github.com/mail-in-a-box/mailinabox">ready-made solution like mail-in-a-box</a> , which contains all the necessary components? </p><br><p>  Zimbra fell away because of Java - I did not want to spend resources. </p><br><p>  mail-in-a-box - again, all the same postfix and company. </p><br><h1 id="opisanie-problemy">  Description of the problem </h1><br><p>  opensmtpd is a great daemon, but it has flaws that make it difficult to integrate it with rspamd. </p><br><p>  It: </p><br><ol><li><p>  Lack of support for the "milter" protocol.  This protocol (extension) would allow integration with rspamd using standard tools. </p><br></li><li><p>  No filter support.  The rspamd developer for integration recommends the use of opensmtpd filters.  The development of filters has been going on for several years already, but still not in production.  There is even a filter for rspamd, but still in a separate thread on github. </p><br><p>  After certain improvements in the code, I succeeded in compiling and running this filter, but it gave errors in the process of work and there was no further desire to understand the code. </p><br></li><li>  No method of receiving mail except by mail protocols. </li></ol><br><p>  Also, the situation was complicated by the following points: </p><br><ol><li><p>  Remoteness of services from each other: demons work in docker containers with different IP.  In fact, the container with opensmtpd and the container with rspamd can be thought of as running on different servers. </p><br></li><li>  Software heterogeneity: opensmtpd is in the stable version of Alpine Linux (the linux version, which is often used as the base Docker image), but there is no rspamd there.  And vice versa: rspamd is in the unstable version of Alpine, but opensmtpd does not work there. </li></ol><br><p>  So, as the original task, we have opensmtpd, which is waiting for incoming mail on port 25 and waiting for mail on port 10029, which rspamd has checked. </p><br><h1 id="reshenie-problemy">  Solution to the problem </h1><br><p>  In opensmtpd there are mda.  Probably, it stands for mail delivery agent.  Redirecting a letter to mda causes an external program to start.  Example of the letter redirection rule: </p><br><pre><code class="hljs pgsql">accept tagged <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span> &lt;domains&gt; userbase &lt;virtual_users&gt; deliver <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> mda "/usr/local/bin/rspamd.sh %{sender} %{rcpt}" <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span></code> </pre> <br><p>  Here we call some external script, where we send the sender's address and the recipient's address. </p><br><p>  Included with rspamd is rspamc - this is an analog mail mta for rspamd.  This program allows you to accept a letter as input, transfer it to rspamd via HTTP API and issue a response. </p><br><p>  The integration of mda and rspamd is as follows </p><br><pre> <code class="hljs pgsql">/usr/bin/rspamc <span class="hljs-comment"><span class="hljs-comment">--mime -h rspamd.example.ru:11333</span></span></code> </pre> <br><p>  On the STDIN script, we send a letter, specify the rspamd address and say the --mime parameter to add message handling headers (which will be used to determine spam later). </p><br><p>  After the letter has been processed by rspamd, it must somehow be sent back to opensmtpd.  But the standard mta (complete with opensmtpd) can send only to port 25 (we are waiting for a verified letter on another port). </p><br><p>  Solution: to form communication over the mail protocol itself (well, it is simple) and send data to the correct port using netcat. </p><br><p>  The final mda script rspamd.sh integration opensmtpd and rspamd </p><br><pre> <code class="hljs mel">#!/usr/bin/<span class="hljs-keyword"><span class="hljs-keyword">env</span></span> sh mail_file=$(mktemp) echo <span class="hljs-string"><span class="hljs-string">'HELO localhost'</span></span> &gt;&gt; $mail_file echo <span class="hljs-string"><span class="hljs-string">"MAIL FROM: &lt;$1&gt;"</span></span> &gt;&gt; $mail_file echo <span class="hljs-string"><span class="hljs-string">"RCPT TO: &lt;$2&gt;"</span></span> &gt;&gt; $mail_file echo <span class="hljs-string"><span class="hljs-string">'DATA'</span></span> &gt;&gt; $mail_file /usr/bin/rspamc --mime -h rspamd.example.ru:<span class="hljs-number"><span class="hljs-number">11333</span></span> &gt;&gt; $mail_file echo <span class="hljs-string"><span class="hljs-string">''</span></span> &gt;&gt; $mail_file echo <span class="hljs-string"><span class="hljs-string">'.'</span></span> &gt;&gt; $mail_file echo <span class="hljs-string"><span class="hljs-string">'QUIT'</span></span> &gt;&gt; $mail_file cut_file=$(mktemp) sed <span class="hljs-string"><span class="hljs-string">'/Delivered-To/d'</span></span> $mail_file &gt; $cut_file rm <span class="hljs-string"><span class="hljs-string">"$mail_file"</span></span> count=<span class="hljs-number"><span class="hljs-number">0</span></span>; IFS=<span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> read -r line ; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"$count"</span></span> -gt <span class="hljs-string"><span class="hljs-string">"5"</span></span> ]; then sleep <span class="hljs-number"><span class="hljs-number">0.05</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> sleep <span class="hljs-number"><span class="hljs-number">0.1</span></span>; fi; echo <span class="hljs-string"><span class="hljs-string">"$line"</span></span>; count=$((count+<span class="hljs-number"><span class="hljs-number">1</span></span>)); done &lt; <span class="hljs-string"><span class="hljs-string">"$cut_file"</span></span> | netcat localhost <span class="hljs-number"><span class="hljs-number">10029</span></span> rm <span class="hljs-string"><span class="hljs-string">"$cut_file"</span></span></code> </pre><br><p>  Features of this script: </p><br><ol><li>  Sending data via netcat should be delayed after each line of the connection setup phase.  To do this, we make delays between the return lines. </li><li>  From the original letter, cut out the "Delivered-To" header, which adds opensmtpd.  Otherwise, opensmtpd will consider this letter to be looped. </li></ol><br><p>  Solving the problem of combining opensmtpd and rspamd in one container: using the Docker image based on Debian sid, where the rspamd repository is connected and the latest version is installed from it.  Installation example: </p><br><pre> <code class="hljs pgsql">wget -O- https://rspamd.com/apt-<span class="hljs-keyword"><span class="hljs-keyword">stable</span></span>/gpg.key | apt-key <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> - \ &amp;&amp; echo "deb http://rspamd.com/apt-stable/ sid main" &gt; /etc/apt/sources.list.d/rspamd.list \ &amp;&amp; apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> \ &amp;&amp; apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install <span class="hljs-comment"><span class="hljs-comment">--no-install-recommends --no-install-suggests -y \ rspamd</span></span></code> </pre> <br><h1 id="itogi">  Results </h1><br><p>  As a result of switching from postfix + amavis to opensmtpd + rspamd, I got the simplicity of the service configuration, low memory consumption and less spam in the mail. </p><br><p>  The implementation of the final Docker container can be viewed <a href="https://github.com/kak-tus/docker-opensmtpd/tree/master/debian">here</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/320698/">https://habr.com/ru/post/320698/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320686/index.html">The practice of metaprogramming in C ++: binary search tree at compile time</a></li>
<li><a href="../320690/index.html">Notify at any cost about the fall of the site. Practical advice</a></li>
<li><a href="../320692/index.html">Three product lines and version control</a></li>
<li><a href="../320694/index.html">Hack.me: Another platform for honing skills in the field of information security</a></li>
<li><a href="../320696/index.html">Native Android and iOS code in Qt using the status bar example</a></li>
<li><a href="../320700/index.html">DNS provider substitution</a></li>
<li><a href="../320702/index.html">Virtual cinematography for VR trailers</a></li>
<li><a href="../320704/index.html">Subversion vs. Git: Debunking Myths About Debunking Myths</a></li>
<li><a href="../320706/index.html">Another JNCIE-SP exam history</a></li>
<li><a href="../320708/index.html">Thinking about a one-way mirror</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>