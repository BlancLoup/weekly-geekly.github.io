<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SQLite and UNICODE</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The first part is introductory . 
 The second part is a quick start . 
 The third part - features . 

 Despite the fact that this topic was touched on...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SQLite and UNICODE</h1><div class="post__text post__text-html js-mediator-article">  The first part is <a href="http://habrahabr.ru/post/149356/">introductory</a> . <br>  The second part is a <a href="http://habrahabr.ru/post/149390/">quick start</a> . <br>  The third part - <a href="http://habrahabr.ru/post/149635/">features</a> . <br><br>  Despite the fact that this topic was touched on Habr√© before, some key things did not sound.  This article attempts to "close the topic."  Addition / correction notes are welcome. <br><br><a name="habracut"></a><br><h5>  Format strings in the database </h5><br>  The SQLite database can store text (string values) in UTF-8 format or in UTF-16 format in a database.  In this case, the byte order in 16-bit UTF-16 characters can be either little-endian or big-endian. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      That is, in reality there are <i>three</i> different SQLite database formats: <i>UTF-8, UTF-16le, UTF-16be</i> . <br><br>  Any of these formats can be used on any platform (i.e., nothing prevents you from creating a UTF-16be base on x86, although this is unwise, see below). <br><br>  The row format is a <a href="http://www.sqlite.org/pragma.html">database setting</a> that is set <i>before</i> the database is created.  After creating the database, <i>you cannot</i> change the format;  attempts to do this are silently ignored by the SQLite kernel. <br><br>  So, <br>  <b>SQLite database string format can be one of:</b> <b><br></b>  <b>- UTF-8 (used by default);</b> <b><br></b>  <b>- UTF-16le (native to x86);</b> <b><br></b>  <b>- UTF-16be</b> <b><br></b>  <b>and you cannot change it after creating a database.</b> <br><br>  <u>Notes</u> <br><br>  1. Both UTF-8 and UTF-16 (see ‚Äúsurrogate pairs‚Äù) use a variable (not fixed) number of bytes to store one character. <br><br>  2. ATTACH to the database, you can only base with the same row format, otherwise there will be an error. <br><br>  3. From your version of SQLite, support for UTF-16 may have been ‚Äúremoved‚Äù during the build (see sqlite3.c for <i>SQLITE_OMIT_UTF16</i> ). <br><br><h5>  Passing Strings to API Calls </h5><br>  SQLite API calls (in C language) are divided into two types: receiving strings in UTF-16 format (byte order "native" for the platform) and receiving strings in UTF-8 format.  For example: <br><br><pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sqlite3_prepare_v2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> sqlite3 *db, </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* Database handle */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *zSql, </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* SQL statement, UTF-8 encoded */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nByte, </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* Maximum length of zSql in bytes. */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sqlite3_stmt **ppStmt, </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* OUT: Statement handle */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **pzTail </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* OUT: Pointer to unused portion of zSql */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sqlite3_prepare16_v2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> sqlite3 *db, </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* Database handle */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *zSql, </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* SQL statement, UTF-16 encoded */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nByte, </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* Maximum length of zSql in bytes. */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sqlite3_stmt **ppStmt, </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* OUT: Statement handle */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **pzTail </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* OUT: Pointer to unused portion of zSql */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>;</code> </pre> <br><br>  If the format of the base string does not match the format of the string that was passed to the API, then the transferred string will be encoded on the fly into the base format.  This process is bad because it takes resources and, of course, it should be avoided.  However, he is not only bad because of this, see below. <br><br><h5>  Collation: a way to compare strings </h5><br>  The next topic is related to the ordering of the lines relative to each other (ascending or descending) and the answer to the question "are these two lines equal".  There is no ‚Äúnatural‚Äù way to compare two strings.  At a minimum, the question arises: case-insensitive or case-insensitive comparison?  Moreover, in the same database, both such comparisons can be used for different fields. <br><br>  In SQLite (and in any database), the notion of <b>collation</b> is introduced: a way to compare two strings to each other.  There are standard (built-in) collation and you can create your own in any quantity. <br><br>  Collation is, in essence, a method that receives strings A and B and returns one of three results: <br>  <i>"String A is less than string B",</i> <i><br></i>  <i>"Lines A and B are equal",</i> <i><br></i>  <i>"String A is greater than string B".</i> <br><br>  But that's not all.  String comparisons must be <i>transitive</i> , otherwise it will ‚Äúbreak‚Äù the search mechanisms that come from certain assumptions.  More strictly: for all lines A, B and C it must be guaranteed that: <br>  <i>1. If A == B, then B == A.</i> <i><br></i>  <i>2. If A == B and B == C, then A == C.</i> <i><br></i>  <i>3. If A &lt;B then B&gt; A.</i> <i><br></i>  <i>4 If A &lt;B and B &lt;C, then A &lt;C.</i> <br>  If this is not the case (that is, you created a collation that violates some of the rules and use it), then <i>‚Äúthe behavior of SQLite is undefined‚Äù</i> (‚ÄúSQLite behavior is not defined‚Äù). <br><br>  Usually collation is set for a table column and determines what type of comparison is used for the values ‚Äã‚Äãof this column. <br><br>  And when do you even need to use string comparison? <br>  1. to create and update an index by string values; <br>  2. in the process of calculating SQL expressions with string values ‚Äã‚Äãwith operations "=", "&lt;", "&gt;" <br>  ( <i>... WHERE name = 'Alice')</i> . <br><br>  So, <br>  <b>when SQLite needs to compare two strings, this comparison is <i>always</i> based on some collation.</b> <br><br>  If the collation of the compared strings do not match, then a clever mechanism of preference of one collation to another is used, which is better not to run up. <br><br><h5>  Standard (built-in) collation </h5><br>  Full support for comparing any UNICODE characters (case insensitive) requires quite a lot of additional data (tables).  The SQLite developers did not ‚Äúinflate‚Äù the kernel and built in the simplest methods of comparison. <br><br>  There are three built-in collations: <br>  <b>BINARY</b> : the usual byte comparison of two blocks of memory: good old <i>memcmp ()</i> <br>  (used by default if no other collation is specified); <br>  <b>RTRIM</b> : the same as BINARY, but ignores trailing spaces ('abc' = 'abc'); <br>  <b>NOCASE</b> : the same as BINARY, but ignores case for 26 letters of the Latin alphabet (and only for them). <br><br><h5>  Implementation of standard collation </h5><br>  Let's look ‚Äúinside‚Äù SQLite and look at the implementation of comparison functions for different collation. <br><br>  The function <i>binCollFunc ()</i> .  If <i>padFlag &lt;&gt; 0</i> , it makes a comparison <i>RTRIM</i> , otherwise <i>BINARY</i> : <br><br><pre> <code class="hljs cpp"><span class="hljs-comment"><span class="hljs-comment">/* ** Return true if the buffer z[0..n-1] contains all spaces. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">allSpaces</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *z, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>( n&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; z[n<span class="hljs-number"><span class="hljs-number">-1</span></span>]==<span class="hljs-string"><span class="hljs-string">' '</span></span> ){ n--; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n==<span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* ** This is the default collating function named "BINARY" which is always ** available. ** ** If the padFlag argument is not NULL then space padding at the end ** of strings is ignored. This implements the RTRIM collation. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">binCollFunc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *padFlag, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nKey1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pKey1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nKey2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pKey2 )</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rc, n; n = nKey1&lt;nKey2 ? nKey1 : nKey2; rc = <span class="hljs-built_in"><span class="hljs-built_in">memcmp</span></span>(pKey1, pKey2, n); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( rc==<span class="hljs-number"><span class="hljs-number">0</span></span> ){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( padFlag &amp;&amp; allSpaces(((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)pKey1)+n, nKey1-n) &amp;&amp; allSpaces(((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)pKey2)+n, nKey2-n) ){ <span class="hljs-comment"><span class="hljs-comment">/* Leave rc unchanged at 0 */</span></span> }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ rc = nKey1 - nKey2; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rc; }</code> </pre><br><br>  And here is the string comparison function for collation <i>NOCASE</i> : <br><br><pre> <code class="hljs cpp"><span class="hljs-comment"><span class="hljs-comment">/* ** ** IMPLEMENTATION-OF: R-30243-02494 The sqlite3_stricmp() and ** sqlite3_strnicmp() APIs allow applications and extensions to compare ** the contents of two buffers containing UTF-8 strings in a ** case-independent fashion, using the same definition of "case ** independence" that SQLite uses internally when comparing identifiers. */</span></span> <span class="hljs-function"><span class="hljs-function">SQLITE_API </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sqlite3_stricmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *zLeft, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *zRight)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *a, *b; a = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)zLeft; b = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)zRight; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>( *a!=<span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; UpperToLower[*a]==UpperToLower[*b]){ a++; b++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UpperToLower[*a] - UpperToLower[*b]; } <span class="hljs-function"><span class="hljs-function">SQLITE_API </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sqlite3_strnicmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *zLeft, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *zRight, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> N)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *a, *b; a = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)zLeft; b = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)zRight; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>( N-- &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; *a!=<span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; UpperToLower[*a]==UpperToLower[*b]){ a++; b++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> N&lt;<span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-number"><span class="hljs-number">0</span></span> : UpperToLower[*a] - UpperToLower[*b]; } <span class="hljs-comment"><span class="hljs-comment">// UpperToLower -  ,    " "     'A'..'Z' (   'a'..'z')</span></span></code> </pre><br><br>  What attracts attention?  That string is supposedly in UTF-8 format, but all the characters in the string are processed in a row: there is no extraction and transcoding of characters in UTF-32. <br><br>  If you meditate on this code for a long time, you can understand that, oddly enough, it works correctly on both UTF-8 strings and on any other single-character encoding (for example, <i>windows-1251</i> ).  Revelations in the understanding of "why so" can be divided in the comments :). <br><br>  This smoothly brings us to the understanding of the important thesis that <br><br>  <b>SQLite is not interested in the actual format of the UTF-8 string until the time when the transcoding of the string into UTF-16 is required</b> . <br><br>  Of course, ordering real UTF-8 strings with standard collation will give rather strange results.  But equality will work correctly, and the comparison will be transitive and will not disrupt SQLite. <br><br>  It turns out, indeed, in the SQLite database you can store strings encoded in, say, <i>windows-1251</i> , provided that you are not using UTF-16 anywhere.  This also applies to string literals inside SQL, as well as strings passed through parameter bindings. <br><br><h5>  Arguments in favor of the format UTF-8 as the format of "default" </h5><br>  Let's take a look at the code of the <i>sqlite3Prepare16 ()</i> API function that performs the parsing and compilation of the SQL statement.  We are interested in the comment at the beginning of the body function. <br><br><pre> <code class="hljs cs"><span class="hljs-comment"><span class="hljs-comment">/* ** Compile the UTF-16 encoded SQL statement zSql into a statement handle. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sqlite3Prepare16</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> sqlite3 *db, </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* Database handle. */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *zSql, </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* UTF-16 encoded SQL statement. */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nBytes, </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* Length of zSql in bytes. */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> saveSqlFlag, </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* True to save SQL text into the sqlite3_stmt */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sqlite3_stmt **ppStmt, </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* OUT: A pointer to the prepared statement */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **pzTail </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* OUT: End of parsed string */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* This function currently works by first transforming the UTF-16 ** encoded string to UTF-8, then invoking sqlite3_prepare(). The ** tricky bit is figuring out the pointer to return in *pzTail. */</span></span> ... <span class="hljs-comment"><span class="hljs-comment">//  }</span></span></code> </pre><br><br>  I.e, <br><br>  <b>A parser of SQL statements in UTF-16 format does not currently exist in the SQLite kernel (which does not exclude its appearance in the future)</b> . <br><br>  So, if a string with a SQL statement is transmitted in UTF-16 format, it is <i>always</i> first converted to UTF-8 format. <br><br>  Thus, in favor of the UTF-8 format: <br>  - there are no unnecessary conversions when compiling SQL; <br>  - data (as a rule) occupy less disk space; <br>  - it is possible to store data in any ‚Äúbyte-by-character‚Äù encoding if UTF-16 is not used anywhere (and written collations take into account the new string format). <br><br><h5>  How to create and use your own collation </h5><br>  Use the API function <a href="http://www.sqlite.org/c3ref/create_collation.html"><i>sqlite3_create_collation_v2 ()</i></a> : <br><br><pre> <code class="hljs cs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sqlite3_create_collation_v2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> sqlite3*, //    </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *zName, //  </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> eTextRep, //      </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pArg, // custom- </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">(*xCompare</span></span></span><span class="hljs-function">)(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">*,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">*,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">*</span></span></span><span class="hljs-function">), </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">//    void(*xDestroy)(void*) );</span></span></span></span></code> </pre><br><br>  In the <i>eTextRep</i> parameter, <i>you</i> need to specify in which format the lines are expected: <br><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">SQLITE_UTF8</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">SQLITE_UTF16</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">SQLITE_UTF16BE</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">SQLITE_UTF16LE</span></span> = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">SQLITE_ANY</span></span> = <span class="hljs-number"><span class="hljs-number">5</span></span>;</code> </pre><br><br>  You can set several functions for the same collation, but accepting different formats. <br><br>  SQLite tries to choose a method for the format, otherwise (if the formats of the transmitted string and the registered function are different), the encoding is performed again on the fly.  The comparison function should return a negative number if the first line is less than the second;  zero - if the lines are equal;  positive number if the first line is greater than the second.  The comparison, as already mentioned, must be transitive. <br><br>  Create a collation (named "RU"), which will give us: <br>  - case-insensitive comparison for Cyrillic and Latin <br>  - the usual comparison for all other characters; <br>  - the correct position in the alphabet of the letter "" (more precisely, "" is considered to be equal to "e"). <br><br>  This, so far, is not a full-fledged support for UNICODE, but this is a simple solution that suits 95% of cases. <br><br>  Examples will be on Delphi, do not be alarmed. <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">unit</span></span> UnicodeUnit; <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-comment"><span class="hljs-comment">//        UTF-8    UTF-32   -1,     function GetCharUTF8(var P: PByte; var L: integer): integer; //    UTF-32    (    !) function LowerUTF32(ACode: integer): integer; //   UTF-8  (case-insensitive    ) function CompareUTF8IgnoreCase(L1: integer; P1: PByte; L2: integer; P2: PByte): integer; implementation uses SysUtils; //    UTF-8 type TParseItem = record Mask: integer; Count: integer; end; var //    UTF-8 ParseTable: array[0..255] of TParseItem; //      LowerTable: array[0..65535] of integer; function CompareUTF8IgnoreCase(L1: integer; P1: PByte; L2: integer; P2: PByte): integer; var C1, C2: integer; begin repeat if (L1 = 0) and (L2 = 0) then begin result := 0; exit; end; //     C1 := GetCharUTF8(P1, L1); if C1 &lt; 0 then begin result := -1; exit; end; C2 := GetCharUTF8(P2, L2); if C2 &lt; 0 then begin result := +1; exit; end; //         if C1 &lt; 65536 then C1 := LowerTable[C1]; if C2 &lt; 65536 then C2 := LowerTable[C2]; if C1 &lt; C2 then begin result := -1; exit; end else if C1 &gt; C2 then begin result := +1; exit; end; until false; end; function LowerUTF32(ACode: integer): integer; begin case ACode of 1105, 1025: // ,  result := 1077; //  1040..1071: result := ACode + 32; //  Ord('A')..Ord('Z'): result := ACode + 32; //  else result := ACode; end; end; function GetCharUTF8(var P: PByte; var L: integer): integer; var B: byte; I: integer; begin if L &gt; 0 then begin B := P^; Inc(P); Dec(L); with ParseTable[B] do if Count &gt; 0 then begin //      result := B and Mask; //      for I := 1 to Count - 1 do if L &gt; 0 then begin result := (result shl 6) or (P^ and $3F); Inc(P); Dec(L); end else begin result := -1; exit; end; exit; end; end; result := -1; end; var I: integer; initialization //    UTF-8 for I := 0 to 255 do with ParseTable[I] do if I &lt;= 127 then begin Mask := $7F; Count := 1; end else if I &gt;= 248 then begin Mask := 0; Count := 0; end else if I &gt;= 240 then begin Mask := 7; Count := 4; end else if I &gt;= 224 then begin Mask := 15; Count := 3; end else if I &gt;= 192 then begin Mask := $1F; Count := 2; end else begin Mask := 0; Count := 0; end; //  Lower for I := 0 to 65535 do LowerTable[I] := LowerUTF32(I); end.</span></span></code> </pre><br><br>  The code, in general, is simple and probably does not need additional explanations. <br><br>  How to use: <br><br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">//       function RU_CollationCompare(UserData: pointer; l1: integer; p1: pointer; l2: integer; p2: pointer): integer; cdecl; begin result := CompareUTF8IgnoreCase(L1, P1, L2, P2); end; ... //     collation RU sqlite3_create_collation(Fdb, 'RU', SQLITE_UTF8, nil, RU_CollationCompare);</span></span></code> </pre><br><br>  When creating a table, set the comparison type for the <i>name</i> column: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> foo( <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> RU, ... )</code> </pre><br><br>  Important!  Registration of collation is performed <u>in conjunction with the database</u> (not in the database itself).  This is, in essence, attaching your code to the SQLite code.  Another connection that did not specify the same collation will not be able to use this base. <br><br><h5>  LIKE, upper (), lower (), etc. </h5><br>  The collation code ‚ÄúRU‚Äù is, of course, easy to modify to support other alphabets.  And you can make a (almost) full-fledged UNICODE comparison if you use the Windows API calls to populate the LowerTable table. <br><br>  <i>Why "almost"?</i>  <i>There is such a thing as ‚Äúnormalization‚Äù of UNICODE, that is, a reduction to an unambiguous representation.</i>  <i>Google to the rescue!</i> <br><br>  However, UNICODE support is not only in collation alone.  There is still: <br>  - operator LIKE (pattern matching); <br>  - SQL functions <i>lower ()</i> and <i>upper ()</i> (translate characters of the string to lower / upper case). <br><br>  And some other string manipulation functions: <i>fold (), title ()</i> , etc. <br><br>  These are separate <i>mechanisms</i> that do not use collation. <br><br>  SQLite, however, allows you to override these functions (LIKE is also a function) with your own. <br><br>  To do this, use the <a href="http://www.sqlite.org/c3ref/create_function.html">sqlite3_create_function_v2 ()</a> API call. <br><br><h5>  UNICODE almost full of little blood </h5><br>  In previous articles, <a href="http://site.icu-project.org/">ICU: International Components for Unicode</a> libraries were mentioned.  This is full UNICODE support.  The trouble, however, is that it drags a huge amount of code and data, which in 95% of cases is not needed.  If your SQLite already has a built-in ICU, then you can not read further. <br><br>  So, there was one clever guy who sawed out of this code is not necessary and created a kind of "residue" from the ICU. <br><br>  His original message apparently is <a href="http://www.mail-archive.com/sqlite-users%40sqlite.org/msg30403.html">this</a> . <br><br>  This is about that.  Based on the ICU code, he created the file <i><a href="http://lmgtfy.com/%3Fq%3Dsqlite3_unicode.c">sqlite3_unicode.c</a></i> , which is compiled into a DLL (usually it is <i>sqlite3u.dll</i> ).  The resulting DLL exports the <i>sqlite3_unicode_init ()</i> function: <br><br><pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sqlite3_unicode_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(db: TSQLiteDB)</span></span></span><span class="hljs-function">:</span></span> Integer; <span class="hljs-keyword"><span class="hljs-keyword">cdecl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> <span class="hljs-string"><span class="hljs-string">'sqlite3u.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-string"><span class="hljs-string">'sqlite3_unicode_init'</span></span>;</code> </pre><br><br>  If you call this function for a connection, then it: <br>  - register <i>almost</i> full-fledged UNICODE-versions of the functions lower, upper, fold, title, unaccent; <br>  - will introduce <i>almost</i> full UNICODE case-insensitive LIKE. <br><br>  The size of this DLL is only 80 Kb and it works quickly (tables are used).  The reservation ‚Äúalmost‚Äù is important - this is not a full-fledged UNICODE, but in 95% of cases this library will suffice. <br><br>  Notes. <br><br>  1. if LIKE is overridden, then SQLite will not be able to optimize it with an index (A LIKE 'XXX%' will not use an index with A, if it exists). <br><br>  2. functions lower (), upper (), etc., generally speaking, are not required to be in the base engine, it is possible to perform these transformations in the application code. <br><br>  <i>Yuz zis laybrari et er oyun risk</i> , that is, the author of this article is never responsible for anything. </div><p>Source: <a href="https://habr.com/ru/post/150543/">https://habr.com/ru/post/150543/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150537/index.html">Geeks On A Plane Moscow - startups unite!</a></li>
<li><a href="../150538/index.html">Communication factories and what they eat</a></li>
<li><a href="../150539/index.html">Feelings that were confirmed by numbers</a></li>
<li><a href="../150541/index.html">Space Engine - Universe in the palm of your hand</a></li>
<li><a href="../150542/index.html">Host and Request_Uri in the list of Oracle sessions</a></li>
<li><a href="../150544/index.html">Drupal as a gaming platform (part 1)</a></li>
<li><a href="../150547/index.html">Technologies, techniques, attacks and research on ZeroNights 2012</a></li>
<li><a href="../150548/index.html">Sifteo Cubes. Board games of new generation</a></li>
<li><a href="../150549/index.html">JQuery UI widget factory</a></li>
<li><a href="../150550/index.html">Amazon is working on a new Kindle: LCD + eInk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>