<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hardware password manager or how to stop entering passwords and start living</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My name is% username%, I'm n years old and I'm paranoid. And every day the information world complicates my life. There is more technology, the thresh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hardware password manager or how to stop entering passwords and start living</h1><div class="post__text post__text-html js-mediator-article">  My name is% username%, I'm n years old and I'm paranoid.  And every day the information world complicates my life.  There is more technology, the threshold of entry into IT is reduced, and we get a reality, where gross security errors are normal.  And also the power of computing is growing every year.  As a result, our passwords, stored as it will turn out, become public. <br><br>  Security is not dead, but is encapsulated and agonizing.  And every year the knocking on the lid of the black box is quieter, and the choked screams are no longer audible at all.  It hurts a lot of abstractions over. <br><br>  We do not know how the next service stores our passwords, so we ourselves must take care of our security, but it also becomes more and more difficult every year.  And the number of services required for a comfortable life is only growing.  And for everyone you need to have your strong and unique password.  This was not my personal life. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Therefore, we came up with our hacker approach to storing and <b>entering</b> passwords. <br><br><img src="https://habrastorage.org/files/b5f/78b/a16/b5f78ba1683f4f01afa86ad773485e88.png"><br><br>  <b>Briefly: the</b> phone is connected via Bluetooth with a special device that emulates a keyboard.  Loss of the device and the phone does not allow to get passwords.  The loss of the device and the master password is also not terrible.  How so?  Welcome under the cat (there are 7 pictures, but they are pretty). <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">DISCLAIMER</b> <div class="spoiler_text">  This is not a promotional article.  This is a description of the solution that I invented and implemented with my colleague.  The purpose of this article is to describe an interesting solution to an existing problem and collect opinions about it from the IT community. <br><br>  PSD is NOT a replacement for cryptographic tokens.  These are completely different areas.  Here we are talking only about character passwords that will be entered automatically through keyboard emulation. <br></div></div><br><h4>  What problem i solve </h4><br>  Character passwords are a legacy that will be used by a large number of services for quite a long time.  I will not even begin now about the fact that not all <i>people_ who_programm</i> use the correct techniques for storing passwords on the server. <br><br><div class="spoiler">  <b class="spoiler_title">An example of a safer password storage method.</b> <div class="spoiler_text">  hash (hash (pass) + user_id + salt) <br></div></div><br>  For the most part, I solve the problem of the convenience of entering a password.  And this is more important than it seems. <br><br>  When you come up with a password, you always keep in mind that later it may be necessary to enter with your hands.  For example, if this is the password for an encrypted disk with the OS.  Or for authorization in your favorite operating system.  Even the same password entry from the phone will be a pain in the fingers for a 16-character password with characters and letters in different registers.  And all this may force you to use some kind of simplification, which will reduce the strength of the password. <br><br><div class="spoiler">  <b class="spoiler_title">Simplification example</b> <div class="spoiler_text">  ICloud users can easily be calculated by their passwords, as they often have an uppercase first or last letter.  Often used name and date of birth / age <br></div></div><br><h4>  How to solve the problem before me </h4><br>  Some password managers allow you to fill in some fields automatically.  But no program manager will work without a loaded operating system that allows you to run foreign binaries.  Moreover, it is impossible to collect manager code for all existing operating systems.  Which leads to the problem of the impossibility of automated password input in a large number of uskeys. <br><br>  Here are some of them: <br><br><ul><li>  OS not yet loaded <br>  ‚Ä¢ OS disk is encrypted <br>  ‚Ä¢ partitions with OS are encrypted </li><li>  Authorization required in OS </li><li>  OS does not allow the use of storage devices (corporate policy) </li><li>  OS prohibits the execution of any custom code (corporate policy) </li><li>  OS is not supported by password manager <br>  ‚Ä¢ uncommon OS <br>  ‚Ä¢ outdated OS </li></ul><br><h4>  PSD from the user's point of view </h4><br>  Actually, a hardware password manager was invented with the ability to store and enter passwords of up to 128 characters.  If you do not consider the principles of the system (which provide security in case of loss of devices), then the hardware manager emulates the keyboard and enters the password selected from the phone.  Communication between devices via Bluetooth. <br><br><h5>  Slightly more </h5><br>  The system consists of three devices. <br><br>  <b>Home computer (MAIN_PC) with a program on it:</b> <br><br><img src="https://habrastorage.org/files/22a/176/a7a/22a176a7a186479bb6ccdc7a7e8819d3.png"><br><br>  <b>Phone with Bluetooth (PHONE) and the program:</b> <br><br><img src="https://habrastorage.org/files/183/6b0/04a/1836b004abf94b1c93a5df7c61ee2a79.png"><br><br>  <b>Special Device (PSD):</b> <br><br><img src="https://habrastorage.org/files/3e4/35d/634/3e435d634a904521b490df51ca54ab9b.png"><br>  <i>PSD stands for Paranoia Satisfaction Device</i> <br><br>  How to enter passwords into the system: <br><br><ol><li>  Connect the PSD and telephone to the host computer </li><li>  Using a special program to record your passwords in the database </li><li>  Transfer one of the received databases to the phone </li></ol><br>  The base is duplicated.  After the passwords are written to the program, 2 base files will be created and another base will be recorded in the PSD.  The first base remains on the computer to prevent the loss of passwords.  The second must be transferred to the phone. <br><br>  How to use it all: <br><br><ol><li>  Connect PSD to usb of any computer to which you need to enter a password (FOREIGN_PC) </li><li>  In the application on the phone, select the password that you want to enter </li></ol><br>  After that, PSD will enter the password.  The computer will think that the password is entered from the connected hardware keyboard. <br><br><h4>  Security psd </h4><br>  And now the really interesting part.  We must make it all safe.  Of course, you can‚Äôt make an unbreakable system, but you can minimize the number of attack vectors, which we will do. <br><br>  The goals that I set for the system: <br><br><ul><li>  Loss of PSD, phone or both devices will not reveal user passwords and will not allow to decrypt intercepted bluetooth traffic </li><li>  Imperceptibly for the user, it is impossible to get the base with PSD </li><li>  If a master password leaks, losing one of the devices will not reveal passwords. </li></ul><br>  To paraphrase, we come to the concept: <i>you need to have all the data and devices that the user has to get passwords.</i>  <i>The manager should never lower security.</i> <br><br><h5>  Storage </h5><br>  Let's start with the base on the computer.  This is the first thing that the user creates and everything is trite in it.  This is just encrypted JSON.  Encryption - AES256 / CBC / PKCS7Padding.  In the near future we plan to switch to the KeePass format. <br><br>  Do not forget that from any device can be considered memory.  Therefore, to store passwords in the clear on the PSD can not in any case.  But encryption is of little help, since then the password will be stored in the same memory.  Therefore, the decision was chosen not to store full passwords in general (except for the backup database on MAIN_PC). <br><br>  The password storage algorithm is very simple: <br><br><ol><li>  We write 128 random bytes to password_part_1 </li><li>  Make the user password XOR with password_part_1 and get password_part_2 </li></ol><br>  As a result, for each password we get 2 parts (password_part_1, password_part_2), whose XOR will give us the original password (with padding from \ 0 at the end).  Since we have a lot of passwords, password is an array.  Accordingly, we will have an array of password parts on each device. <br>  password_part_1 [i] ‚äï password_part_2 [i] == password [i] <br><br>  We will store the first parts (password_part_1) on the phone and password_part_2 on the PSD.  To enter the password, we will send password_part_1 [PassId] via Bluetooth and XOR with password_part_2 [PassId] on the PSD.  In this way, we will get a password using the PassId index, which we will enter on the computer (FOREIGN_PC), emulating a hard keyboard. <br><br><img src="https://habrastorage.org/files/22c/cb4/1e9/22ccb41e97a841bca828f47dfd7d84f1.png"><br><br><h5>  Traffic encryption </h5><br>  But what if the hacker decides to intercept traffic and steal the PSD.  He can still read the memory from the EEPROM and get passwords, parts of which he got from the traffic.  So traffic must be encrypted (not very original, yes). <br><br>  Traffic must be encrypted so that if you lose your PSD, you cannot decrypt packets.  The problem is that the hacker knows everything that PSD knows.  If PSD can decrypt traffic using information on it, then the hacker will be able to decipher the traffic.  We will use one-time keys, updated with each new package.  PSD will have a key only for the next package, but not for the one received earlier.  Initially the same keys are set by the computer (MAIN_PC) when writing databases. <br><br>  BtKey and HBtKey are keys for encrypting and verifying package integrity.  They both change with each message.  The integrity check is based on the SHA256 based HMAC.  The key for him is HBtKey [i].  To encrypt the packet itself, use AES256 / CBC / PKCS7Padding.  In the packet, password_part_1 and PassId are transmitted.  Also in the package there are keys for decrypting the next package (HBtKey [i + 1], BtKey [i + 1]). <br><br><img src="https://habrastorage.org/files/e47/47e/7ef/e4747e7eff6e47c5b4d321a1ba36fda5.png"><br><br>  As soon as the packet gets on the PSD and is decrypted, the telephone will immediately generate an answer.  This is sha256 (HBtKey [i]).  HBtKey [i] is the previous key for HMAC.  Then passwords in the PSD memory are replaced with new ones (i + 1).  And a password is entered on FOREIGN_PC. <br><br><img src="https://habrastorage.org/files/3fc/468/be6/3fc468be696644adbb7a906685046840.png"><br><br>  After that, the phone sends the answer that everything is entered correctly (sha256 (HBtKey [i])) and the phone deletes the old keys, replacing them with new ones. <br><br><img src="https://habrastorage.org/files/e1c/fe1/c15/e1cfe1c15a354b53990aaf0528932bd6.png"><br><br>  More lists for god lists: <br><br><ol><li>  The phone generates BtKey [i + 1] and HBtKey [i + 1] </li><li>  EncryptedPayload = AES256 (key: BtKey [i], input: PassId || password_part_1 || BtKey [i + 1] || HBtKey [i + 1]) </li><li>  EncryptedMessage = IV ||  EncryptedPayload ||  HMACsha256 (key: HBtKey [i], input: EncryptedPayload) </li><li>  phone sends EncryptedMessage packet to PSD </li><li>  PSD decrypts EncryptedMessage using BtKey [i] and verifies integrity with HBtKey [i] </li><li>  PSD generates a response to the phone (but does not send).  Response = sha256 (HBtKey [i]) </li><li>  PSD changes its HBtKey [i] and BtKey [i] to new ones, obtained from the package (i + 1).  Old ones are deleted </li><li>  PSD collects the password (password_part_1 ‚äï password_part_2 [PassId]) and enters it on the computer (FOREIGN_PC), pretending to be a keyboard </li><li>  PSD sends response to phone </li><li>  The phone checks the response and changes the keys to new ones. </li><li>  i ++ </li></ol><br>  The result is that the passwords for decrypting packets already sent no longer exist.  There are only passwords to decrypt the next packet. <br><br><h4>  Conclusion </h4><br>  It turned out quite comfortable, interesting and safe thing. <br><br>  Unfortunately, I can not describe the entire system in one article.  I have already gone beyond 13k characters, and told only the basic concept of a common system.  If this article was interesting to someone, then I can write another one that will cover the rest of security.  There are quite interesting approaches. <br><br>  The application on the phone also has some interesting features that help keep the balance between security and convenience (access to the encrypted database has only a service that allows you to enter a password once and apply different reset policies. For example, 30 minutes after entering). <br><br>  And the device will be able to launch custom firmware to implement any functionality that is required (for example, a bluetooth usb keyboard).  And there are also some interesting things about security approaches. <br><br>  Now we have a working prototype of the device, firmware on the device, an Android program and two programs (gui and console) on the computer. <br><br>  Computer programs are written in .net and works well under mono.  But under Linux, the library I use to communicate with the PSD does not see the device, but I plan to fix it. <br><br>  All code for the phone and for the computer is open.  It can be found <a href="https://github.com/dc914337/PSD">on the githaba</a> . <br><br>  We have the following plans: <br><br><ol><li>  Based on the results of your reaction, evaluate the need for the device and what components we can allow to use there </li><li>  Support for setting passwords from everything that has mono (Linux, Mac OS) </li><li>  Switch to KeePass format for base on MAIN_PC </li><li>  Bluetooth 4.0 </li><li>  The ability to collect the base, having only the phone and PSD </li><li>  Ability to add passwords from the phone </li><li>  Ability to synchronize passwords without MAIN_PC </li></ol><br>  We are going to continue to engage in the project, but it would be very interesting to know the opinion of the habrasoobshchestva about the prospects.  There are a lot of people among my acquaintances who would like to use such a device, so I have the prerequisites to conduct a small survey. <br><br><h4>  Vulnerability Scan </h4><br>  By the way, in the <i>described</i> protocol there is a logical vulnerability.  It can not be operated remotely (easier to put the keylogger) and it is fixed without crutches.  You can try your hand at finding this vulnerability (the vulnerability is logical, and not at the code level) and we promise to give the first person who finds it a ready device (if we start mass production). <br><br>  Naturally, in the case of release, this vulnerability will be closed. <br><br>  Answer hash: 28dbc42aa86100dc5e325c4bea80c67c980cfd26 </div><p>Source: <a href="https://habr.com/ru/post/276967/">https://habr.com/ru/post/276967/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276951/index.html">WhatsApp architecture Facebook bought for $ 19 billion</a></li>
<li><a href="../276953/index.html">We are looking for Mega developers: turn on the idea generator</a></li>
<li><a href="../276955/index.html">Rumors confirmed - Opera Software is sold to China</a></li>
<li><a href="../276957/index.html">Carefully about counting single bits</a></li>
<li><a href="../276961/index.html">Nginx 1.9.11 released with support for dynamic modules</a></li>
<li><a href="../276969/index.html">Dash opened source code for vending machine with InstantX</a></li>
<li><a href="../276971/index.html">RxSwift in action - we write reactive application</a></li>
<li><a href="../276973/index.html">Explaining the inexplicable. Part 2</a></li>
<li><a href="../276975/index.html">FRUSDR update for optimal server performance (INTEL platform)</a></li>
<li><a href="../276977/index.html">Domain telephony</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>