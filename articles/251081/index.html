<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Developing a simple game in Code :: blocks using Direct3D 9</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to talk about my first experience in game dev. Immediately it is worth making a reservation that the article will be purely technical, since my...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Developing a simple game in Code :: blocks using Direct3D 9</h1><div class="post__text post__text-html js-mediator-article">  I want to talk about my first experience in game dev.  Immediately it is worth making a reservation that the article will be purely technical, since my goal was just to gain skills in developing graphic applications using Direct3D, without involving high-level development tools for games like Unity.  Accordingly, there will be no talk about the introduction, monetization and promotion of the game.  The article focuses on newcomers to programming Direct3D applications, as well as simply on people interested in the key mechanisms for the operation of such applications.  Also at the end I cite a list of references on game development, carefully selected by me from more than a hundred books on game programming and computer graphics. <br><a name="habracut"></a><br><h4>  Introduction </h4><br>  So, in my free time I decided to explore the popular graphic API.  After reading a few books and examining a bunch of examples and tutorials (including from the DirectX SDK), I realized that the very moment had come when it was worth trying your own efforts.  The main problem was that most of the existing examples simply demonstrate this or that API capability and are implemented procedurally in almost one cpp-file, and even using the DXUT wrapper, and do not give an idea of ‚Äã‚Äãwhat structure the final application should have what classes need to be designed and how it should all interact with each other, so that everything is beautiful, readable and efficiently work.  This disadvantage also applies to books on Direct3D: for example, for many newbies, it is not obvious that render states do not always need to be updated when every frame is drawn, and also that most heavy operations (such as filling the vertex buffer) should be performed just once when the application is initialized (or when the game level is loaded). <br><br><h4>  Idea </h4><br>  The first thing I needed was to decide on the very idea of ‚Äã‚Äãthe game.  The old game from 1992 under MS-DOS came to mind, which I think is familiar to many.  This is a logical game <a href="https://ru.wikipedia.org/wiki/Lines">Lines of the</a> company Gamos. <br><br>  Well, the challenge is accepted.  Here is what we have: <br><ul><li>  there is a square box of cells; </li><li>  in the cells on the field there are multicolored balls; </li><li>  after moving the ball, new balls appear; </li><li>  the player‚Äôs goal is to build one-color balls in a line: the accumulation of a certain number of one-color balls in one line leads to their detonation and scoring; </li><li>  The main task is to hold out as long as possible, until the free cells on the field run out. </li></ul><br>  Now let's look from the point of view of the Direct3D application: <br><ul><li>  we will make a field of cells in the form of a three-dimensional platform with protrusions, each cell will be something like a podium; </li><li>  Three types of ball animation should be implemented: <br><ol><li>  the appearance of the ball: first a small ball appears, which in a short time grows to an adult size; </li><li>  movement of the ball: just a sequential movement in the cells; </li><li>  bouncing ball: when choosing a ball with the mouse, it should be activated and start jumping on the spot; </li></ol></li><li>  A particle system must be implemented that will be used to animate the explosion; </li><li>  Text output must be implemented: to display points earned on the screen; </li><li>  Virtual camera control should be implemented: rotation and zoom. </li></ul><br>  In fact, the points listed above are a pathetic likeness of a document called a design project.  I strongly recommend, before starting development, to paint it in every detail, print it out and keep it in front of your eyes!  Looking ahead, I immediately show a demo video for clarity of the implementation of the points (by the way, the video was recorded using the <a href="http://www.ezvid.com/">ezvid</a> program, so do not be intimidated by their splash screen in the beginning): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/bbYg1L2U01I%3Ffeature%3Doembed&amp;xid=17259,15700002,15700023,15700186,15700191,15700253&amp;usg=ALkJrhjZoWSHCdgiMKLK04a6xm-YE1vR0w" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  Start of development </h4><br>  So far I have not mentioned which tools were used.  First, you need the DirectX software development kit (SDK), always available for free download on the Microsoft website: <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D6812">DirectX SDK</a> .  If you are going to use the version of Direct3D 9, like me, then after installation you need to open the DirectX Control Panel through the main menu and on the Direct3D 9 tab choose which version of libraries will be used during assembly - retail or debug (this affects whether Direct3D will report debugger on the results of its activities): <br><br><div class="spoiler">  <b class="spoiler_title">Debug or retail</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/b2b/281/058/b2b281058eef46f3bfe4e39da8b72db2.jpg"><br></div></div><br>  Why Direct3D version 9?  Because this is the latest version, where there is still a fixed function pipeline, that is, a fixed graphics pipeline, which includes, for example, the functions of lighting calculation, vertex processing, mixing, and so on.  Starting from the 10th version, developers are invited to independently implement these functions in shaders, which is an indisputable advantage, but, in my opinion, it is difficult to understand at the first experiments with Direct3D. <br><br>  Why Code :: blocks?  It was probably silly to use a cross-platform IDE to develop an application using a non-cross-platform API.  Just Code :: blocks takes up several times less space than Visual Studio, which turned out to be very relevant for my country PC. <br><br>  Starting development with Direct3D was very simple.  I created an empty project in Code :: blocks, then I had to do two things in the build options: <br><br>  1) On the search directories tab and the compiler subtab, add the path to the include DirectX SDK directory - for example, like this: <br><div class="spoiler">  <b class="spoiler_title">Search directories</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/626/95d/7ef/62695d7ef707496eba131b6e27339624.jpg"><br></div></div><br>  2) On the linker tab add two libraries - d3d9.lib and d3dx9.lib: <br><div class="spoiler">  <b class="spoiler_title">Linker</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/0a2/5c6/b30/0a25c6b30abb4e74b3298974b03d95d7.jpg"><br></div></div><br>  After that, in the source code of the application you will need to include Direct3D header files: <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"d3d9.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"d3dx9.h"</span></span></span></span></code> </pre> <br><h4>  Application structure </h4><br>  Here I made the first mistake: I started thinking about which design pattern to choose.  He came to the conclusion that the MVC (model-view-controller) is best suited: the model will be the game class (game), including all the logic - calculating the paths of movement, the appearance of balls, analysis of explosive combinations;  the presentation will be the engine class responsible for drawing and interaction with Direct3D;  the controller will be the actual wrapper (app) - this includes the message processing cycle, processing user input, and, most importantly, the state manager and ensuring the interaction of game and engine objects.  It seems to be simple, and you can start writing header files, but it was not there!  At this stage, it turned out to be very difficult to navigate and understand what methods these classes should have.  It is clear that this was a complete lack of experience, and I decided to resort to the advice of one of the books: <b>‚ÄúDo not try to write the perfect code from the very beginning, let it be non-optimal and confused.</b>  <b>Understanding comes with time, and you can do refactoring later. ‚Äù</b> As a result, after several iterations of the refactoring of an <b>already working layout, the</b> definition of the three main classes took the form: <br><br><div class="spoiler">  <b class="spoiler_title">Class tgame</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TGame</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: BOOL gameOver; TCell *cells; WORD *path; WORD pathLen; LONG score; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ClearField</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">WORD </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetSelected</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">WORD </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNeighbours</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WORD cellId, WORD *pNeighbours)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckPipeDetonate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WORD *pPipeCells)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: TGame(); ~TGame(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">New</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateBalls</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WORD count)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Select</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WORD cellId)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryMove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WORD targetCellId)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DetonateTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">WORD </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNewBallList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TBallInfo **ppNewList)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">WORD </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetLastMovePath</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WORD **ppMovePath)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">WORD </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDetonateList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WORD **ppDetonateList)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">LONG </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetScore</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsGameOver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; };</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">TEngine class</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TEngine</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: HWND hWindow; RECT WinRect; D3DXVECTOR3 CameraPos; LPDIRECT3D9 pD3d; LPDIRECT3DDEVICE9 pDevice; LPDIRECT3DTEXTURE9 pTex; LPD3DXFONT pFont; D3DPRESENT_PARAMETERS settings; <span class="hljs-keyword"><span class="hljs-keyword">clock_t</span></span> currentTime; TGeometry *cellGeometry; TGeometry *ballGeometry; TParticleSystem *psystem; TBall *balls; TAnimate *jumpAnimation; TAnimate *moveAnimation; TAnimate *appearAnimation; LONG score; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitD3d</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitGeometry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DrawPlatform</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DrawBalls</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: TEngine(HWND hWindow); ~TEngine(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AppearBalls</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TBallInfo *ballInfo, WORD count)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MoveBall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WORD *path, WORD pathLen)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DetonateBalls</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WORD *detonateList, WORD count)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSelected</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsMoving</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsAppearing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsDetonating</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnResetGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">WORD </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WORD x, WORD y, BOOL *IsCell)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnRotateY</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(INT offset)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnRotateX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(INT offset)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnZoom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(INT zoom)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnResize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnUpdateScore</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LONG score)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; };</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">TApplication class</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TApplication</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: HINSTANCE hInstance; HWND hWindow; POINT mouseCoords; TEngine* engine; TGame* game; BOOL moveStarted; BOOL detonateStarted; BOOL appearStarted; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegWindow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> LRESULT CALLBACK </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MsgProc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: TApplication(HINSTANCE hInstance, INT cmdShow); ~TApplication(); <span class="hljs-function"><span class="hljs-function">TEngine* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEngine</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">TGame* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">INT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainLoop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; };</code> </pre><br></div></div><br>  The TGame class has only 3 methods that the user himself can initiate - New (new game), Select (ball selection) and TryMove (attempt to move the ball).  The remaining auxiliary ones are called by the controller in special cases.  For example, DetonateTest (test for explosive combinations) is called after the appearance of new balls or after an attempt to move.  GetNewBallList, GetLastMovePath, GetDetonateList are called, respectively, after the balls appear, after moving and after the explosion, with one goal: to get a list of specific balls and pass it to the engine object for processing so that it can draw something.  I don‚Äôt want to dwell on the logic of TGame, since there are <a href="https://github.com/psylancer/balls">source codes with comments</a> .  I can only say that the definition of the path of displacement of the ball is implemented using <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D0%25BB%25D0%25B3%25D0%25BE%25D1%2580%25D0%25B8%25D1%2582%25D0%25BC_%25D0%2594%25D0%25B5%25D0%25B9%25D0%25BA%25D1%2581%25D1%2582%25D1%2580%25D1%258B">the Dijkstra algorithm</a> using an undirected graph with equal weights of all edges. <br><br>  Let us consider the classes of the engine and controller. <br><br><h4>  TEngine </h4><br><ul><li>  The class defines fields for storing the handle of the window and its rectangle.  They are used in the OnResize method, which the controller calls when the window is resized, to calculate the new projection matrix. </li><li>  The CameraPos field stores the coordinates of the observer in world space.  The vector of the direction of sight is not necessary to store, because according to my idea the camera is always directed to the origin of coordinates, which, by the way, coincides with the center of the platform. </li><li>  There are also pointers to Direct3D interfaces: LPDIRECT3D9, which is needed only to create a device;  LPDIRECT3DDEVICE9 - in fact, the Direct3D device itself, the main interface with which to work;  LPD3DXFONT and LPDIRECT3DTEXTURE9 for working with text and texture. </li><li>  The currentTime field is used to store the current time in milliseconds and is required to draw a smooth animation.  The fact is that each frame takes a different number of milliseconds, so you have to measure these milliseconds each time and use it as a parameter when interpolating the animation.  This method is known as <b>time synchronization</b> and is used everywhere in modern graphic applications. </li><li>  Pointers to objects of the TGeometry class (cellGeometry and ballGeometry) store the geometry of a single cell and one ball.  The TGeometry object itself, as the name implies, is designed to work with geometry and contains vertex and index buffers, as well as a description of the material (D3DMATERIAL9).  When drawing, we can change the world matrix and call the Render method of the TGeometry object, which will lead to drawing several cells or balls. </li><li>  TParticleSystem is a class of a particle system that has methods for initializing a set of particles, updating their positions in space and, of course, rendering. </li><li>  TBall * balls - an array of balls with color and status information [bouncing, moving, appearing]. </li><li>  Three objects of type TAnimate - to provide animation.  The class has a method for initializing keyframes, which are world transformation matrixes, and methods for calculating the current animation position and applying the transformation.  In the rendering procedure, the engine object sequentially draws the balls and, if necessary, calls the ApplyTransform method of the desired animation in order to create or move the ball. </li><li>  InitD3d, InitGeometry, InitAnimation are called only from the TEngine constructor and are separated into separate methods for clarity.  In InitD3d, a Direct3D device is created and all necessary render states are installed, including the installation of a point light source with a specular component right above the center of the platform. </li><li>  The three methods AppearBalls, MoveBall and DetonateBalls trigger the appearance, move and explosion animations, respectively. </li><li>  The methods IsSelected, IsMoving, IsAppearing, IsDetonating are used in the state manager function to track the end of the animation. </li><li>  Methods with the prefix On are called by the controller when the corresponding events occur: mouse click, camera rotation, etc. </li></ul><br>  Consider the main Render method: <br><br><div class="spoiler">  <b class="spoiler_title">TEngine :: Render ()</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> TEngine::Render() { <span class="hljs-comment"><span class="hljs-comment">//,         clock_t elapsed=clock(), deltaTime=elapsed-currentTime; currentTime=elapsed; //  ,    if(jumpAnimation-&gt;IsActive()) { jumpAnimation-&gt;UpdatePosition(deltaTime); } if(appearAnimation-&gt;IsActive()) { appearAnimation-&gt;UpdatePosition(deltaTime); } if(moveAnimation-&gt;IsActive()) { moveAnimation-&gt;UpdatePosition(deltaTime); } pDevice-&gt;Clear(0,NULL,D3DCLEAR_STENCIL|D3DCLEAR_TARGET|D3DCLEAR_ZBUFFER,D3DCOLOR_XRGB(0,0,0),1.0f,0); pDevice-&gt;BeginScene(); //  DrawPlatform(); //  DrawBalls(); //   ,          if(psystem-&gt;IsActive()) { pDevice-&gt;SetTexture(0,pTex); psystem-&gt;Update(deltaTime); psystem-&gt;Render(); pDevice-&gt;SetTexture(0,0); } //   char buf[255]="Score: ",tmp[255]; itoa(score,tmp,10); strcat(buf,tmp); RECT fontRect; fontRect.left=0; fontRect.right=GetSystemMetrics(SM_CXSCREEN); fontRect.top=0; fontRect.bottom=40; pFont-&gt;DrawText(NULL,_T(buf),-1,&amp;fontRect,DT_CENTER,D3DCOLOR_XRGB(0,255,255)); pDevice-&gt;EndScene(); pDevice-&gt;Present(NULL,NULL,NULL,NULL); }</span></span></code> </pre><br></div></div><br>  At the very beginning, it calculates how many milliseconds have passed since the previous Render () call, then the progress of the animations are updated if they are active.  The buffers are cleared by the Clear method and the platform, the balls and the particle system are sequentially drawn if it is active.  Finally, a line is displayed with the current value of points earned. <br><br><h4>  TApplication </h4><br><ul><li>  The class has a field for storing mouse coordinates, since we will need to calculate the values ‚Äã‚Äãof relative cursor offsets in order to rotate the camera. </li><li>  The Boolean flags appearStarted, moveStarted, and detonateStarted are needed to track the status of the corresponding animations. </li><li>  The RegWindow method renders the code for registering the window class. </li><li>  The MsgProc static method is the so-called window procedure. </li><li>  ProcessGame is a simplified version of the state manager, in which the current state of the game is evaluated and, depending on it, some actions are taken. </li><li>  MainLoop - message loop. </li></ul><br>  Here is a lightweight controller.  A similar message loop can be found in any book on Direct3D: <br><br><div class="spoiler">  <b class="spoiler_title">TApplication :: MainLoop ()</b> <div class="spoiler_text"><pre> <code class="cpp hljs">INT TApplication::MainLoop() { MSG msg; ZeroMemory(&amp;msg,<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(MSG)); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(msg.message!=WM_QUIT) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(PeekMessage(&amp;msg,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,PM_REMOVE)) { TranslateMessage(&amp;msg); DispatchMessage(&amp;msg); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  ,        ProcessGame(); engine-&gt;Render(); } } return (INT)msg.wParam; }</span></span></code> </pre><br></div></div><br>  Only what is inside the else block deserves attention - this is the so-called IdleFunction, which is executed in the absence of messages. <br><br>  And here is the state manager function: <br><br><div class="spoiler">  <b class="spoiler_title">TApplication :: ProcessGame ()</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> TApplication::ProcessGame() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(moveStarted) { <span class="hljs-comment"><span class="hljs-comment">//     if(!engine-&gt;IsMoving()) { //  -    moveStarted=FALSE; if(game-&gt;DetonateTest()) { //     WORD *detonateList, count=game-&gt;GetDetonateList(&amp;detonateList); detonateStarted=TRUE; engine-&gt;DetonateBalls(detonateList,count); engine-&gt;OnUpdateScore(game-&gt;GetScore()); } else { //    if(game-&gt;CreateBalls(APPEAR_COUNT)) { TBallInfo *appearList; WORD count=game-&gt;GetNewBallList(&amp;appearList); appearStarted=TRUE; engine-&gt;AppearBalls(appearList,count); } else { //game over! } } } } if(appearStarted) { //     if(!engine-&gt;IsAppearing()) { appearStarted=FALSE; //  -       if(game-&gt;DetonateTest()) { //     WORD *detonateList, count=game-&gt;GetDetonateList(&amp;detonateList); detonateStarted=TRUE; engine-&gt;DetonateBalls(detonateList,count); engine-&gt;OnUpdateScore(game-&gt;GetScore()); } } } if(detonateStarted) { //     if(!engine-&gt;IsDetonating()) { //   detonateStarted=FALSE; } } }</span></span></code> </pre><br></div></div><br>  Well, perhaps that's all! <br><br><h4>  Conclusion </h4><br>  Here is the place to list the shortcomings.  Of course, in the code a lot of places for optimizations.  In addition, I did not mention such things as changing video mode parameters (screen resolution, multisampling) and device loss handling (LostDevice).  On account of the latter there is a detailed discussion <a href="http://www.gamedev.ru/code/forum/%3Fid%3D81910">on the gamedev.ru site</a> . <br><br>  I hope my research will benefit someone.  By the way, the <a href="https://github.com/psylancer/balls">source code on github</a> . <br><br>  <b>Thanks for attention!</b> <br><br><h4>  Promised literature </h4><br>  1. Frank D. Luna Introduction to programming 3D games with DirectX 9.0 - to understand the basics; <br>  2. Gornakov S. DirectX9 programming lessons in C ++ are also the basics, but there are chapters on DirectInput, DirectSound and DirectMusic.  In the examples of programs sometimes errors are found; <br>  3. Flenov ME DirectX and C ++ the art of programming is an amusing style of presentation.  Basically, the purpose of the book is to create animated videos using interesting effects, including shaders.  Judge for yourself by the name of the sections: heart attack, fire dragon; <br>  4. Barron Todd. Programming strategic games with DirectX 9 - fully devoted to the topics related to strategic games: block graphics, AI, creating maps and landscapes, sprites, special effects with particle systems, as well as developing screen interfaces and working with DirectSound / Music; <br>  5. Bill Fleming 3D Creature WorkShop - a book not on programming, but on the development of three-dimensional character models in LightWave, 3D Studio Max, Animation Master; <br>  6. Thorn Alan DirectX 9 User interfaces Design and implementation - a detailed book on the development of graphical interfaces with DirectX.  A hierarchical model of screen form components, similar to that implemented in Delphi, is considered; <br>  7. Adams Jim Advanced Animation with DirectX - discusses the types of animation (skeletal, morphing and varieties) and their implementation, as well as working with geometry and animation from X-files; <br>  8. Lamot Andre Programming games for Windows.  Tips from a professional - this book is already more serious: questions of optimization, selection of data structures for various tasks, multithreading, physical modeling, AI are being considered.  The last chapter describes the creation of a game about a spacecraft and aliens; <br>  9. David H. Eberly 3D Game Engine Design is a good book for understanding the whole theory of game development: first, graphics API technologies are described (transformation, rasterization, shadowing, blending, multitexturing, fog, etc.), then topics such as the scene graph , object selection, collision detection, character animation, level of detail, landscapes; <br>  10. Daniel S√°nchez-Crespo Dalmau - details the algorithms and data structures used in game-building tasks, such as AI, scripting, rendering in closed and in open spaces, clipping algorithms, procedural techniques, ways to implement shadows , the implementation of the camera, etc .; <br>  11. Andre Lamoth Programming Role Playing Games with directX 9 - a thousand-page detailed RPG development guide.  Includes both theoretical chapters on programming with Direct3D, DirectInput, DirectSound, DirectPlay, and application chapters that are directly related to the game engine. </div><p>Source: <a href="https://habr.com/ru/post/251081/">https://habr.com/ru/post/251081/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../251065/index.html">/ ^ 777 $ / or / ^ 7 {3} $ / or number of luck</a></li>
<li><a href="../251069/index.html">Lenovo laptops come with Superfish malware and its CA certificate and private key in storage</a></li>
<li><a href="../251073/index.html">Own Flash on HTML5: the union of vector images (part 1)</a></li>
<li><a href="../251077/index.html">Some interesting and useful things for web developer # 39</a></li>
<li><a href="../251079/index.html">Increase conversion with callback widget UpToCall</a></li>
<li><a href="../251083/index.html">Chat VKontakte as a terminal</a></li>
<li><a href="../251085/index.html">Quantum sandbox: part 2</a></li>
<li><a href="../251087/index.html">Tube amplifier</a></li>
<li><a href="../251089/index.html">Anti-design patterns: Functional Decomposition</a></li>
<li><a href="../251091/index.html">Pointers, references, and arrays in C and C ++: dots above i</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>