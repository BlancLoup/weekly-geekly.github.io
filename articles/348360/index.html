<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OpenVPN OSPF between two servers, multiple tunnels</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="OpenVPN is well documented and there are articles on installation in Habr√©, for example: 
 this one 

 But so that at once several tunnels, between tw...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OpenVPN OSPF between two servers, multiple tunnels</h1><div class="post__text post__text-html js-mediator-article">  OpenVPN is well documented and there are articles on installation in Habr√©, for example: <br>  <a href="https://habrahabr.ru/post/67209/">this one</a> <br><br>  But so that at once several tunnels, between two servers and automatic fault tolerance are not found.  In my case, the servers on which OpenVPN and OSPF will be located are both behind NAT.  This somewhat complicates the decision, but mainly due to the need to control traffic leaving the interfaces of the border router. <br><br><h4>  Given: </h4><br>  Centos 7 Two Border Routers: <br><a name="habracut"></a><br>  <b>r01:</b> <br>  ens0 1.1.1.1 - provider 1 <br>  ens1 2.2.2.2 - provider 2 <br>  ens2 10.0.0.1 - virtual network between the gateway and the OpenVPN server. <br>  <b>r02:</b> <br>  ens0 3.3.3.3 - provider 3 <br>  ens1 4.4.4.4 - provider 4 <br>  ens2 10.1.1.1 - virtual network between the gateway and the OpenVPN server. <br><cut></cut><br>  Two Centos 7 OpenVPN / OSPF Servers: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>host01:</b> <br>  ens0 10.0.0.2 - SNAT via network provider 1. <br>  ens0 10.0.0.3 - SNAT via network provider 2. <br>  ens1 192.168.0.0/23 - local area network. <br>  <b>host02:</b> <br>  ens0 10.1.1.2 - SNAT via network provider 3. <br>  ens0 10.1.1.3 - SNAT via network provider 4. <br>  ens1 192.168.4.0/23 - local area network. <br><br>  All providers in this scheme are different, have different speed, cost. <br><br><h4>  Task: </h4><br>  Create 4 tunnels between host01 and host02 so that they are always active and if any of the providers fail, the route should switch to a slower or more expensive channel.  Even if both providers fail (one on each server), the channel should also function.  At the same time, if the preferred channel works, the server will have to switch to it. <br><br>  In this article I will not describe in detail the process of generating keys, installing OpenVPN, Quagga.  Let me just say that it is enough to generate keys for the server and client once, since you can use DH and all other keys and certificates for all instances at the same time.  But, of course, if you are very concerned about security, you can generate two certificates for each tunnel.  In my case, there was one certificate for server services and one for client services. <br><br><h4>  Installation: </h4><br>  CentOS Linux release 7.4.1708 (Core) / 3.10.0-693.5.2.el7.x86_64. <br>  yum install openvpn easy-rsa quagga <br>  software versions that were used: <br><br><pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">openvpn</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">x86_64</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">easy-rsa</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.el7</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">quagga</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x86_64</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.99</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.22</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4-4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.el7</span></span></code> </pre> <br><h4>  Setup: </h4><br>  The following ports are selected for the tunnels: <br><br>  udp 1150 - 1.1.1.1-3.3.3.3 <br>  udp 1151 - 2.2.2.2-4.4.4.4 <br>  udp 1152 - 1.1.1.1-4.4.4.4 <br>  udp 1153 - 2.2.2.2-3.3.3.3 <br><br>  It should be noted that OpenVPN requires that the port from which the server and client send packets is the same as the packet receiving port, when using NAT, the outgoing packet port may differ and the tunnel will not rise with this error: <br>  <i>TCP / UDP: Incoming packet rejected from [AF_INET] 1.1.1.1: 1194 [2], expected peer address: [AF_INET] 1.1.1.1: 2364 (allow this incoming source address to be added by --float )</i> <br><br>  To ensure that the port is always correct, you must configure the border router and OpenVPN server: <br><br>  host01: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">-A</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">POSTROUTING</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-p</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">udp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--dport</span></span> 1150 <span class="hljs-selector-tag"><span class="hljs-selector-tag">-o</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ens0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-j</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SNAT</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--to-source</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1050</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-A</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">POSTROUTING</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-p</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">udp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--dport</span></span> 1151 <span class="hljs-selector-tag"><span class="hljs-selector-tag">-o</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ens0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-j</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SNAT</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--to-source</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1051</span></span></code> </pre> <br>  In turn, on the border router it will be like this (r01): <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">-A</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">POSTROUTING</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-p</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">udp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-s</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--dport</span></span> 1150 <span class="hljs-selector-tag"><span class="hljs-selector-tag">-o</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ens0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-j</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SNAT</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--to-source</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1150</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-A</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">POSTROUTING</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-p</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">udp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-s</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--dport</span></span> 1151 <span class="hljs-selector-tag"><span class="hljs-selector-tag">-o</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ens1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-j</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SNAT</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--to-source</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1151</span></span></code> </pre> <br>  Next, we configure the tunnels, I will give the configuration of one client / server pair, the rest are also configured, the port, addresses and the tun number of the interface just change. <br><br>  Server configuration: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">dev</span></span> tun1 proto udp topology subnet remote <span class="hljs-number"><span class="hljs-number">1.1.1.1</span></span> ifconfig <span class="hljs-number"><span class="hljs-number">10.10.11.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255.255.252</span></span> cipher AES-<span class="hljs-number"><span class="hljs-number">256</span></span>-CBC persist-tun persist-key ping <span class="hljs-number"><span class="hljs-number">10</span></span> ping-restart <span class="hljs-number"><span class="hljs-number">30</span></span> tls-server daemon dh /etc/openvpn/dh2048.pem ca /etc/openvpn/ca.crt cert /etc/openvpn/srv.crt key /etc/openvpn/srv.key reneg-sec <span class="hljs-number"><span class="hljs-number">300</span></span> port <span class="hljs-number"><span class="hljs-number">1150</span></span> verb <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br><br>  Client configuration: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">dev</span></span> tun1 proto udp topology subnet remote <span class="hljs-number"><span class="hljs-number">3.3.3.3</span></span> ifconfig <span class="hljs-number"><span class="hljs-number">10.10.11.2</span></span> <span class="hljs-number"><span class="hljs-number">255.255.255.252</span></span> cipher AES-<span class="hljs-number"><span class="hljs-number">256</span></span>-CBC ping <span class="hljs-number"><span class="hljs-number">10</span></span> ping-restart <span class="hljs-number"><span class="hljs-number">30</span></span> tls-client daemon ca /etc/openvpn/ca.crt cert /etc/openvpn/cli.crt key /etc/openvpn/cli.key reneg-sec <span class="hljs-number"><span class="hljs-number">300</span></span> port <span class="hljs-number"><span class="hljs-number">1150</span></span> verb <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br>  An important parameter in the configuration of the <i>topology subnet</i> tunnel, it allows you to address the tunnel so that it looks like a subnet and not a point-to-point interface.  The parameter is not the default parameter and is recommended for modern servers.  Without it, there is no possibility to exchange broadcast packets inside the tunnel, thus it will not be possible to configure OSPF. <br><br>  When raising the tunnel ifconfig on the server and the client will look like this: <br><br><pre> <code class="hljs pgsql">tun1: flags=<span class="hljs-number"><span class="hljs-number">4305</span></span>&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt; mtu <span class="hljs-number"><span class="hljs-number">1500</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.252</span></span> destination <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span></code> </pre> <br><pre> <code class="hljs pgsql">tun1: flags=<span class="hljs-number"><span class="hljs-number">4305</span></span>&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt; mtu <span class="hljs-number"><span class="hljs-number">1500</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> netmask <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.252</span></span> destination <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span></code> </pre> <br>  After all 4 tunnels are raised, this picture is obtained. <br><br>  udp 1150 - 1.1.1.1-3.3.3.3 - tun1 - 10.10.11.1-10.10.11.2 <br>  udp 1151 - 2.2.2.2-4.4.4.4 - tun2 - 10.10.12.1-10.10.12.2 <br>  udp 1152 - 1.1.1.1-4.4.4.4 - tun3 - 10.10.15.1-10.10.15.2 <br>  udp 1153 - 2.2.2.2-3.3.3.3 - tun4 - 10.10.16.1-10.10.16.2 <br><br>  No additional static routes are required, except for adding firewall rules: <br><br><pre> <code class="hljs matlab">-A FORWARD -o tun1 -m comment --comment <span class="hljs-string"><span class="hljs-string">"1"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> ACCEPT -A FORWARD -<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> tun1 -m comment --comment <span class="hljs-string"><span class="hljs-string">"1"</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> ACCEPT -A FORWARD -o tun2 -m comment --comment <span class="hljs-string"><span class="hljs-string">"2"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> ACCEPT -A FORWARD -<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> tun2 -m comment --comment <span class="hljs-string"><span class="hljs-string">"2"</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> ACCEPT -A FORWARD -o tun3 -m comment --comment <span class="hljs-string"><span class="hljs-string">"3"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> ACCEPT -A FORWARD -<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> tun3 -m comment --comment <span class="hljs-string"><span class="hljs-string">"3"</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> ACCEPT -A FORWARD -o tun4 -m comment --comment <span class="hljs-string"><span class="hljs-string">"4"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> ACCEPT -A FORWARD -<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> tun4 -m comment --comment <span class="hljs-string"><span class="hljs-string">"4"</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> ACCEPT</code> </pre> <br><h3>  Fault tolerance. </h3><br>  It is possible to achieve route switching using scripts, but it would be a cumbersome and not at all elegant solution.  Previously, I have not had the opportunity to use dynamic routing in practice.  There are a lot of protocols, I stopped at OSPF, by and large, because I found more information and methods of use.  Protocol linkstate type, takes into account the state of the channels, interfaces and exchanges it.  I think that it is quite possible to implement this on BGP or RIP.  I would love to look at the BGP version of the solution. <br>  In order for OSPF to receive and send LSA service packets, a Link State Advertisement will need to open ports on the firewall: <br><br><pre> <code class="hljs matlab">-A INPUT -<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> tun1 -p <span class="hljs-number"><span class="hljs-number">89</span></span> -m comment --comment <span class="hljs-string"><span class="hljs-string">"multicast tun1"</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> ACCEPT -A INPUT -<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> tun2 -p <span class="hljs-number"><span class="hljs-number">89</span></span> -m comment --comment <span class="hljs-string"><span class="hljs-string">"multicast tun2"</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> ACCEPT -A INPUT -<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> tun3 -p <span class="hljs-number"><span class="hljs-number">89</span></span> -m comment --comment <span class="hljs-string"><span class="hljs-string">"multicast tun3"</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> ACCEPT -A INPUT -<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> tun4 -p <span class="hljs-number"><span class="hljs-number">89</span></span> -m comment --comment <span class="hljs-string"><span class="hljs-string">"multicast tun4"</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> ACCEPT</code> </pre> <br><h4>  Let's move on to setting up Quagga. </h4><br>  First you need to make sure that the folders and files that appear in the work of the Quagga services belonged to the user under which the service starts: <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">chown</span></span> -R quagga:quagga /etc/quagga <span class="hljs-keyword"><span class="hljs-keyword">chown</span></span> -R quagga:quagga /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/quagga/ospfd.log</code> </pre> <br>  We start services: <br><br><pre> <code class="hljs pgsql">systemctl <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> zebra systemctl <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> ospfd</code> </pre> <br>  After that, you can begin to configure OSPF. <br><br>  You can get to the console in two ways, <i>telnet</i> or <i>vtysh</i> , I chose the second one. <br>  It is better to immediately try to write to check the rights to the configuration files, otherwise all the commands you enter will not be saved, it should turn out like this: <br><br><pre> <code class="hljs vhdl">host01# wr Building <span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span>... <span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span> saved <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> /etc/quagga/zebra.conf <span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span> saved <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> /etc/quagga/ospfd.conf [OK]</code> </pre> <br>  Check if all your interfaces are available for zebra. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sh</span></span> inter</code> </pre> <br>  If the routed networks through OSPF and all tun interfaces are in place, you can continue. <br>  First of all, you need to configure the cost of tunnels, the lower the cost, the more priority the tunnel.  You can do it like this: <br><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tun1</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ip</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ospf</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cost</span></span></span><span class="hljs-class"> 10</span></span></code> </pre> <br>  And further for other tun2 30, tun3 15, tun4 20 in my case. <br><br>  Then you can start the router: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">router</span></span> ospf ospf router-id <span class="hljs-number"><span class="hljs-number">192.168.1.0</span></span> redistribute connected route-map LAN passive-interface default <span class="hljs-literal"><span class="hljs-literal">no</span></span> passive-interface ens0 <span class="hljs-literal"><span class="hljs-literal">no</span></span> passive-interface tun1 <span class="hljs-literal"><span class="hljs-literal">no</span></span> passive-interface tun2 <span class="hljs-literal"><span class="hljs-literal">no</span></span> passive-interface tun3 <span class="hljs-literal"><span class="hljs-literal">no</span></span> passive-interface tun4 network <span class="hljs-number"><span class="hljs-number">10.10.11.0</span></span>/<span class="hljs-number"><span class="hljs-number">30</span></span> area <span class="hljs-number"><span class="hljs-number">0.0.0.0</span></span> network <span class="hljs-number"><span class="hljs-number">10.10.12.0</span></span>/<span class="hljs-number"><span class="hljs-number">30</span></span> area <span class="hljs-number"><span class="hljs-number">0.0.0.0</span></span> network <span class="hljs-number"><span class="hljs-number">10.10.15.0</span></span>/<span class="hljs-number"><span class="hljs-number">30</span></span> area <span class="hljs-number"><span class="hljs-number">0.0.0.0</span></span> network <span class="hljs-number"><span class="hljs-number">10.10.16.0</span></span>/<span class="hljs-number"><span class="hljs-number">30</span></span> area <span class="hljs-number"><span class="hljs-number">0.0.0.0</span></span> network <span class="hljs-number"><span class="hljs-number">192.168.1.0</span></span>/<span class="hljs-number"><span class="hljs-number">23</span></span> area <span class="hljs-number"><span class="hljs-number">0.0.0.0</span></span> ! ip prefix-list LAN seq <span class="hljs-number"><span class="hljs-number">10</span></span> permit <span class="hljs-number"><span class="hljs-number">192.168.4.0</span></span>/<span class="hljs-number"><span class="hljs-number">23</span></span> ip prefix-list LAN seq <span class="hljs-number"><span class="hljs-number">100</span></span> deny any ! route-map LAN permit <span class="hljs-number"><span class="hljs-number">10</span></span> match ip address prefix-list LAN</code> </pre> <br>  In this configuration, the redistribute connected parameter is used to advertise not all routes to another server, but only the necessary ones, and the route-map LAN parameter allows filtering networks. <br><br>  Exactly the same configuration should be on the other side of the tunnel.  After activating the ospfd service, after about 10 seconds, the neighbors' routes will appear on both servers and the tunnel will be selected according to the cost.  If the preferred tunnel stops working, it will automatically switch to another tunnel and so on, until the tunnels remain.  And also, if a better interface is activated again, routing will go through it. <br><br>  The estimated update time for routes is 10 seconds, you can vary the ip ospf hello-interval and ip ospf dead-interval parameters to shorten this time. <br><br>  Do not forget to add all services to autoload, for example my OpenVPN configuration files are called srv-1050.conf and cli-1050.conf, in this case the commands will look like this: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">systemctl</span></span> enable openvpn<span class="hljs-variable"><span class="hljs-variable">@srv</span></span>-<span class="hljs-number"><span class="hljs-number">1050</span></span> systemctl enable openvpn<span class="hljs-variable"><span class="hljs-variable">@cli</span></span>-<span class="hljs-number"><span class="hljs-number">1050</span></span></code> </pre> <br>  Thank you for your attention, I will believe that it will be useful to someone. </div><p>Source: <a href="https://habr.com/ru/post/348360/">https://habr.com/ru/post/348360/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348350/index.html">Updating strings on the fly in mobile apps: part 2</a></li>
<li><a href="../348352/index.html">How to work with Jira plugin from ScriptRunner or how to avoid code duplication</a></li>
<li><a href="../348354/index.html">How ZFS Stores Data</a></li>
<li><a href="../348356/index.html">Transition from AngularJS to Angular: goals, plans and rules for transferring elements (1/3)</a></li>
<li><a href="../348358/index.html">10 Gigabit Ethernet: Newbie Tips</a></li>
<li><a href="../348362/index.html">Where in Siberia to talk about IT</a></li>
<li><a href="../348364/index.html">BitPaymer (FriedEx) coder created by Dridex banker trojan authors</a></li>
<li><a href="../348366/index.html">Personal experience with Firebase Cloud Firestore</a></li>
<li><a href="../348368/index.html">Dynamic font size change throughout an Android application using Configuration.fontScale</a></li>
<li><a href="../348374/index.html">Translation of the book "Social Architecture": Chapter 5. Design, development, innovation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>