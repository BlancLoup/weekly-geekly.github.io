<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linux-vserver or every sandbox service</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently on Habr√© published articles on openvz and lxc. It reminded me that this article is still in the sandbox ... 

 For the purposes of placing pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Linux-vserver or every sandbox service</h1><div class="post__text post__text-html js-mediator-article">  Recently on Habr√© published articles on openvz and lxc.  It reminded me that this article is still in the sandbox ... <br><br>  For the purposes of placing projects, I use this scheme: each service is launched in an isolated environment: combat - separately, test - separately, telephony - separately, web - separately.  This reduces the risk of hacking systems, allows you to backup everything and everyone with one rsync to the neighboring server across the crown, and in the case of a hardware rush, simply pick up on the next hardware.  (And using drbd + corosync allows you to do this automatically also) <br><br>  To create an isolated environment, there are two approaches called VDS (hardware virtualization) and VPS / jail (process space virtualization). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To create VDS isolation use XEN, VirtualBox, VMWare and other virtual machines. <br>  To create a VPS on linux, use either linux-vserver, or openvz, or lxc. <br><br>  Advantages of VDS: the system inside can be absolutely any, you can keep different versions of the cores, you can install another OS. <br>  The disadvantages of VDS are high IO performance losses, excessive CPU and RAM consumption for services duplicating those running on the server OS. <br><br>  VPS advantages: extremely low performance loss, only for insulation, only those services that are really needed are launched. <br>  Cons VPS: you can run only linux and the kernel will be only the version that is already running. <br><br>  Since I don‚Äôt need different operating systems, I‚Äôm using linux-vserver everywhere (historically, I‚Äôve been using it since 2004, and openvz was released to the public in 2005), and lxc, in my understanding, is not old enough to produce (although it‚Äôs very close already). <br><br>  I will quote from the FAQ: <br>  ‚ÄúWhat is the status of Linux-VServer? <br>  Linux-VServer has more than a decade of maturity and is actively developed.  Two projects are similar to Linux-VServer, [LXC], and [OpenVZ].  Of the two, OpenVZ offers some similar functionality to Linux-VServer.  LXC is solely based on kernel mechanisms such as cgroups that are in modern kernels.  It will continue to be mature.  As this occurs, the Linux-VServer will take advantage of the LXC and continue to provide it.  Currently, LXC offers significantly less functionality and isolation than Linux-vserver.  "For the use of the LXC <br><br>  Below I will describe the basic operations for launching a LAMP server in an isolated environment. <br><a name="habracut"></a><br>  OS: debian-stable, 64bit <br>  Starting from Wheezy, vserver support with the debian command has been removed, so I use the <a href="http://repo.psand.net/info/">repo.psand.net/info kernel</a> <br><br><h4>  Configuring the root system to run linux-vserver </h4><br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://repo.psand.net/ wheezy main"</span></span> &gt; /etc/apt/sources.list.d/psand.list wget -O - http://repo.psand.net/pubkey.txt | sudo apt-key add - aptitude update aptitude search linux-image-vserver <span class="hljs-comment"><span class="hljs-comment">#      aptitude install linux-image-vserver-3.13-beng util-vserver curl bzip2 #  3.13      curl http://dev.call2ru.com/vs/nss_vserver_64.tar.bz2 | tar xfj - cd nss_vserver_64 make make install ln -s var/lib/vservers / curl http://dev.call2ru.com/vs/vserverauth.tar.gz | tar xfz - cd vserverauth/vslogin/ make cp vslogin /sbin/ chmod u+s /sbin/vslogin echo /sbin/vslogin &gt;&gt; /etc/shells echo -e "auto dummy0\niface dummy0 inet static\n\taddress 192.168.1.250\n\tnetmask 255.255.255.0\n" &gt;&gt; /etc/network/interfaces echo -e "\tpre-up /sbin/iptables -t nat -A POSTROUTING -s 192.168.1.0/24 ! -d 192.168.1.0/24 -j MASQUERADE\n" &gt;&gt; /etc/network/interfaces echo -e "\tpost-down /sbin/iptables -t nat -D POSTROUTING -s 192.168.1.0/24 ! -d 192.168.1.0/24 -j MASQUERADE\n" &gt;&gt; /etc/network/interfaces</span></span></code> </pre> <br>  After installation - reboot into the new kernel. <br><br>  What we did: <br><ul><li>  Installed a kernel with linux-vserver support, installed utilities for creating / managing vservers. </li><li>  Installed my nss_vserver [1] module and vslogin, which allows you to log in via ssh directly into vserver </li><li>  Configured dummy0 interface to create a ‚Äúprivate‚Äù network for virtual machines. </li></ul><br><br>  This allows you to use a single server IP to start different services, dividing them by login (for example, to log in to the web virtual machine you just need to log in as web root or as root @ web). <br><br>  After that, new servers can be launched on the server, tying them to the dummy0 interface. <br>  Everything is fine, but the created servers respond to 192.168.1.x, and it is necessary that it be accessible from the outside. <br><br>  To solve this, on the root we will need nginx: <br><pre> <code class="bash hljs"> aptitude install nginx cat &gt; /etc/nginx/sites-available/proxy &lt;&lt;END server { listen 80; <span class="hljs-comment"><span class="hljs-comment">#  IP:PORT proxy_set_header Host $host; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-SSL no; if ($http_host ~ "(?i)(somesite\.ru)$") { rewrite ^(.*) /web/$1 last; } #    if'      #  catch-all    rewrite ^(.*) /web/$1 last; #     location /web// { proxy_pass http://192.168.1.57/; proxy_read_timeout 500; } } END ln -s ../sites-available/proxy /etc/nginx/sites-enabled/ /etc/init.d/nginx reload</span></span></code> </pre><br><br>  This allows all incoming requests to the 80th port to scatter across different virtual machines, depending on the name. <br>  If necessary, you can use proxy_pass to a different external IP, which allows you to move virtual servers across different machines without having to wait for the full update of DNS records, but this is a topic for a separate conversation. <br><br>  Now we need to create a new virtual machine (number 57, web name) in which we install LAMP. <br><br><h4>  Creating a new vserver </h4><br><pre> <code class="bash hljs"> MIRROR=http://ftp.de.debian.org/debian NAME=web DOMAIN=mydom.ru CONTEXT=57 vserver <span class="hljs-variable"><span class="hljs-variable">$NAME</span></span> build -m debootstrap --context <span class="hljs-variable"><span class="hljs-variable">$CONTEXT</span></span> --hostname <span class="hljs-variable"><span class="hljs-variable">$NAME</span></span>.<span class="hljs-variable"><span class="hljs-variable">$DOMAIN</span></span> --interface dummy0:192.168.1.<span class="hljs-variable"><span class="hljs-variable">$CONTEXT</span></span>/24 -- -d squeeze -m <span class="hljs-variable"><span class="hljs-variable">$MIRROR</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> default &gt; /etc/vservers/<span class="hljs-variable"><span class="hljs-variable">$NAME</span></span>/app/init/mark vserver <span class="hljs-variable"><span class="hljs-variable">$NAME</span></span> start vserver <span class="hljs-variable"><span class="hljs-variable">$NAME</span></span> enter aptitude update aptitude install locales <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">"en_US.UTF-8 UTF-8\nru_RU.UTF-8 UTF-8\n"</span></span> &gt;&gt; /etc/locale.gen locale-gen <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">"127.0.0.1 localhost.localdomain localhost vhost\n192.168.1.250 vroot\n"</span></span> &gt; /etc/hosts</code> </pre><br>  This establishes the base system, makes it autorun when the root system is rebooted. <br><br>  Now the virtual machine is ready to install the necessary software in it.  For example, the usual LAMP: <br><pre> <code class="bash hljs"> aptitude install apache2 libapache2-mod-php5 mysql-server php5-mysql php5-mysqli libapache2-mod-rpaf editor /etc/apache2/mods-available/rpaf.conf <span class="hljs-comment"><span class="hljs-comment"># (  "RPAFproxy_ips 127.0.0.1"       192.168.1.57 (IP )) a2enmod rpaf /etc/init.d/apache2 restart exit</span></span></code> </pre><br><br>  Everything!  Now your server is running Apache in a completely isolated environment. <br><br><h5>  Problems of this approach include: </h5><br>  1. Direct entry to virtual servers is possible only by password. <br>  2. On the root system, no one should be allowed access, so the root system should only have a verified minimum of software (ssh, nginx, iptables and nothing else). <br>  3. If you need direct access to any ports inside virtual machines, forwarding needs to be done using iptables. <br><br><h5>  Moments left behind the scenes for simplicity of the article. </h5><br>  1. / var / lib / vservers / * it is desirable to place on lvm in order to be able to manage the allocation of space for virtual machines independently. <br>  2. Resource management: simply created virtual machine can eat all the resources of the machine.  Learn more about setting limits <a href="http://linux-vserver.org/Resource_Limits">linux-vserver.org/Resource_Limits</a> <br>  3. / tmp /.  Inside the default virtualok / tmp / is created as a ramdisk in 16m size.  Or right before ‚Äúvserver $ NAME start‚Äù, fix / etc / vservers / $ NAME / fstab <br>  4. Useful information, information, etc. about linux-vserver can be found on <a href="http://linux-vserver.org/">linux-vserver.org</a> <br><br>  If there are useful questions, I will put the detailed answers to them in the topic. </div><p>Source: <a href="https://habr.com/ru/post/213995/">https://habr.com/ru/post/213995/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../213983/index.html">Force majeure, or how people lost their data</a></li>
<li><a href="../213985/index.html">Sonar as a source of tasks for regular refactoring</a></li>
<li><a href="../213987/index.html">Overclocking Guide: How to overclock Corsair Dominator Platinum RAM to 2800 MHz</a></li>
<li><a href="../213991/index.html">The world's fastest data transmission network from MegaFon</a></li>
<li><a href="../213993/index.html">Impact Mapping - how can a dev team stop doing what they need and start doing what they need?</a></li>
<li><a href="../213997/index.html">Testing retail systems</a></li>
<li><a href="../214001/index.html">New Graphene Application: High Efficiency Water Filters</a></li>
<li><a href="../214005/index.html">The experience of writing an article in a Chinese newspaper</a></li>
<li><a href="../214007/index.html">Rolls-Royce plans to build giant unmanned ships for maritime freight</a></li>
<li><a href="../214009/index.html">GitHab will soon launch a rich text editor.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>