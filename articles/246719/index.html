<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>InterSystems iKnow. We load data from VKontakte</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article continues the cycle of stories ( one , two ) about the main ways / scenarios for using iKnow - the Natural Language Processing tool from ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>InterSystems iKnow. We load data from VKontakte</h1><div class="post__text post__text-html js-mediator-article">  This article continues the cycle of stories ( <a href="http://habrahabr.ru/company/intersystems/blog/243217/">one</a> , <a href="http://habrahabr.ru/company/intersystems/blog/244697/">two</a> ) about the main ways / scenarios for using iKnow - the Natural Language Processing tool from the InterSystems technology stack. <br>  Previous posts on this topic were mainly devoted to working with data after they were placed in the domain (the place where the entire text analysis takes place).  The same article will be about how to correctly and conveniently upload information to iKnow.  As an example, we will consider downloading information about users on Vkontakte: their personal data, posts, etc. <br>  The article implies some basic background in the field of InterSystems technologies (in particular, Cach√© ObjectScript). <br><a name="habracut"></a><br><h2>  Long road to the domain </h2><br><img src="https://habrastorage.org/files/c42/e80/774/c42e80774b9944e8a25e43616f2d0f23.png" alt="alt text" title="The data load model in the domain"><br><br>  According to <a href="">official documentation</a> , there are two scenarios for loading data into an existing domain: <br><ol><li> An instance of the class <code>%iKnow.Source.Loader</code> .  It is bound to a specific domain (the one whose id was transferred to the constructor).  An instance of the class that implements the lister interface is created.  This instance calls the <code>AddListToBatch</code> method with some arguments specifying the load information.  Thus, a new list of download information is added to the current domain batch.  This can be done several times.  In order to load the current batch into the domain, the loader should call the <code>ProcessBatch</code> method.  This option is better suited for high volume downloads. </li><li>  An instance of the class that implements the <a href="">Lister</a> interface is <a href="">created</a> , the <code>ProcessList</code> method is called for this instance with some arguments specifying the information to be loaded, and the load is immediately <a href="">sent</a> to the domain directly.  This variant is better for low volume loads. </li></ol><br><h2>  Listing customization </h2><br>  The standard library offers many ready-made implementations of the lister (RSS-lister, file lister, global lister).  However, the final programmer has the opportunity to write his own implementation, suitable for his own needs. <br>  Before writing a lister for Vkontakte posts, I wrote a wrapper for some of the <a href="https://vk.com/dev">Vkontakte API</a> methods on <abbr title="Cach√© ObjectScript">COS</abbr> , which operate on data in open access.  All code is available on <a href="https://github.com/intersystems-ru/iknowSocial">github</a> in the <code>VKReader</code> package. <br>  I decided that it would be interesting if Lister could download the latest posts for some keyword, well, and some other parameters.  It turned out that this is not difficult to achieve.  <a href="">The head of the documentation</a> on customization says that to create your own lister, you need to inherit from the system class and override several methods. <br>  So, all in the same package, I created a class <code>VKReader.Lister</code> , inherited from the class <code>%iKnow.Source.Lister</code> .  If you are writing your lister, it must also inherit from this class. <br>  Each lister should be assigned a unique short name (alias) by which the iKnow system methods will access it.  If this name is not specified, the full class name of this lister will be used instead. <br>  To specify alias, simply redefine the <code>GetAlias</code> class method in your class.  For our Lister Vkontakte I did it like this: <br><br>  <font color="#000080">ClassMethod</font> <font color="#000000">GetAlias ‚Äã‚Äã()</font> <font color="#000080">As% String</font> <font color="#000080"><br></font>  <font color="#000000">{</font> <font color="#000000"><br></font>  <font color="#0000ff">Quit</font> <font color="#008000">"VKAPI"</font> <font color="#008000"><br></font>  <font color="#000000">}</font> <font color="#000000">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </font>  <font color="#000000">All data sources submitted for download have an external id, which must contain the short name of the lister and full reference, which, in turn, consists of the name of the source group and the local reference.</font> <font color="#000000"><br></font>  <font color="#000000">For the lister to work, you need to override the <code>BuildFullRef</code> and <code>SplitFullRef</code> class methods, respectively, collecting full reference from groupname and local reference and breaking it into these two parts.</font> <font color="#000000"><br></font>  <font color="#000000">Extrenal id in our case is the following:</font> <font color="#000000"><br> <code>VKAPI:searchQuery:::vkPostId</code> <br></font>  <font color="#000000">Here VKAPI is the short name of our lister, the search query plays the role of the name of the source group, and the Vkontakte post id is the local reference.</font> <font color="#000000"><br></font>  <font color="#000000">Code of methods <code>BuildFullRef</code> and <code>SplitFullRef</code> :</font> <font color="#000000"><br><br></font>  <font color="#000000"><font color="#000080">ClassMethod</font> <font color="#000000">SplitFullRef (</font> <font color="#ff00ff">domainId</font> <font color="#000080">As% Integer</font> <font color="#000000">,</font> <font color="#ff00ff">fullRef</font> <font color="#000080">As% String</font> <font color="#000000">,</font> <font color="#000080">Output</font> <font color="#ff00ff">groupName</font> <font color="#000080">As% String</font> <font color="#000000">,</font></font> <font color="#000000"><br></font>  <font color="#000000"><font color="#000080">Output</font> <font color="#ff00ff">localRef</font> <font color="#000080">As% String</font> <font color="#000000">)</font> <font color="#000080">As% Status</font> <font color="#000000">[</font> <font color="#000080">Private</font> <font color="#000000">]</font></font> <font color="#000000"><font color="#000000"><br></font></font>  <font color="#000000"><font color="#000000">{</font></font> <font color="#000000"><font color="#000000"><br></font></font>  <font color="#000000"><font color="#0000ff">set</font> <font color="#800000">delim</font> <font color="#000000">=</font> <font color="#008000">":::"</font></font> <font color="#000000"><font color="#008000"><br></font></font>  <font color="#000000"><font color="#0000ff">set</font> <font color="#800000">localRef</font> <font color="#000000">=</font> <font color="#0000ff">$ piece</font> <font color="#000000">(</font> <font color="#800000">fullRef</font> <font color="#000000">,</font> <font color="#800000">delim</font> <font color="#000000">,</font> <font color="#0000ff">$ l</font> <font color="#000000">(</font> <font color="#800000">fullRef</font> <font color="#000000">,</font> <font color="#800000">delim</font> <font color="#000000">))</font></font> <font color="#000000"><font color="#000000"><br></font></font>  <font color="#000000"><font color="#0000ff">set</font> <font color="#800000">groupName</font> <font color="#000000">=</font> <font color="#0000ff">$ e</font> <font color="#000000">(</font> <font color="#800000">fullRef</font> <font color="#000000">, 1, * -</font> <font color="#0000ff">$ l</font> <font color="#000000">(</font> <font color="#800000">localRef</font> <font color="#000000">) -</font> <font color="#0000ff">$ l</font> <font color="#000000">(</font> <font color="#800000">delim</font> <font color="#000000">))</font></font> <font color="#000000"><font color="#000000"><br></font></font>  <font color="#000000"><font color="#0000ff">Quit $$$ OK</font></font> <font color="#000000"><font color="#0000ff"><br></font></font>  <font color="#000000"><font color="#000000">}</font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000080">ClassMethod</font> <font color="#000000">BuildFullRef (</font> <font color="#ff00ff">domainId</font> <font color="#000080">As% Integer</font> <font color="#000000">,</font> <font color="#ff00ff">groupName</font> <font color="#000080">As% String</font> <font color="#000000">,</font> <font color="#ff00ff">localRef</font> <font color="#000080">As% String</font> <font color="#000000">)</font> <font color="#000080">As% String</font> <font color="#000000">[</font> <font color="#000080">Private</font> <font color="#000000">]</font></font> <font color="#000000"><font color="#000000"><br></font></font>  <font color="#000000"><font color="#000000">{</font></font> <font color="#000000"><font color="#000000"><br></font></font>  <font color="#000000"><font color="#0000ff">quit</font> <font color="#800000">groupName</font> <font color="#000000">_</font> <font color="#008000">":::"</font> <font color="#000000">_</font> <font color="#800000">localRef</font></font> <font color="#000000"><font color="#800000"><br></font></font>  <font color="#000000"><font color="#000000">}</font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000">You also need to specify which <code>Processor</code> will be standard for this Lister.</font></font>  <font color="#000000"><font color="#000000">In iKnow <code>Processor</code> , this is an object that deals with the immediate processing of downloaded data.</font></font>  <font color="#000000"><font color="#000000">There are several types of different handlers ( <code>Processor</code> ), but since in our case the data will be stored only directly in memory, I decided to use a handler for temporary storage.</font></font>  <font color="#000000"><font color="#000000">The handler is also specified via override.</font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000"><font color="#000080">ClassMethod</font> <font color="#000000">DefaultProcessor ()</font> <font color="#000080">As% String</font></font></font> <font color="#000000"><font color="#000000"><font color="#000080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#000000">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">Quit</font> <font color="#008000">"% iKnow.Source.Temp.Processor"</font></font></font> <font color="#000000"><font color="#000000"><font color="#008000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#000000">}</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font> <br></font></font>  <font color="#000000"><font color="#000000">All the main boot activity occurs in another <code>ExpandList</code> method with the eloquent name <code>ExpandList</code> .</font></font>  <font color="#000000"><font color="#000000">This method expands the list to load into the domain.</font></font>  <font color="#000000"><font color="#000000">The arguments to the ProcessList and AddListToBatch methods are the same as you define them in the <code>ExpandList</code> .</font></font> <font color="#000000"><font color="#000000"><br></font></font>  <font color="#000000"><font color="#000000">We first give all the code of the method for our case.</font></font> <font color="#000000"><font color="#000000"><br></font></font>  <font color="#000000"><font color="#000000">We will have the following arguments (in order): the query word by which we want to search for records;</font></font>  <font color="#000000"><font color="#000000">number of entries;</font></font>  <font color="#000000"><font color="#000000">a boolean value corresponding to whether we want to check the load list for the existence of a source with the same local reference;</font></font>  <font color="#000000"><font color="#000000">restrictions on the post publication time.</font></font> <font color="#000000"><font color="#000000"><br><br></font></font> <div class="spoiler">  <font color="#000000"><font color="#000000"><b class="spoiler_title">A lot of code under the spoiler</b></font></font> <div class="spoiler_text">  <font color="#000000"><font color="#000000"><font color="#000080">Method</font> <font color="#000000">ExpandList (</font> <font color="#ff00ff">listparams</font> <font color="#000080">As% List</font> <font color="#000000">)</font> <font color="#000080">As% Status</font></font></font> <font color="#000000"><font color="#000000"><font color="#000080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#000000">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">query</font> <font color="#000000">=</font> <font color="#0000ff">$ li</font> <font color="#000000">(</font> <font color="#800000">listparams</font> <font color="#000000">, 1)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">count</font> <font color="#000000">=</font> <font color="#0000ff">$ li</font> <font color="#000000">(</font> <font color="#800000">listparams</font> <font color="#000000">, 2)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">checkExists</font> <font color="#000000">= +</font> <font color="#0000ff">$ lg</font> <font color="#000000">(</font> <font color="#800000">listparams</font> <font color="#000000">, 3, 1)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">startDate</font> <font color="#000000">=</font> <font color="#0000ff">$ lg</font> <font color="#000000">(</font> <font color="#800000">listparams</font> <font color="#000000">, 4)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">startTime</font> <font color="#000000">=</font> <font color="#0000ff">$ lg</font> <font color="#000000">(</font> <font color="#800000">listparams</font> <font color="#000000">, 5)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">endDate</font> <font color="#000000">=</font> <font color="#0000ff">$ lg</font> <font color="#000000">(</font> <font color="#800000">listparams</font> <font color="#000000">, 6)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">endTime</font> <font color="#000000">=</font> <font color="#0000ff">$ lg</font> <font color="#000000">(</font> <font color="#800000">listparams</font> <font color="#000000">, 7)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">#dim</font> <font color="#800000">response</font> <font color="#0000ff">As</font> <font color="#008080">% ListOfObjects</font></font></font> <font color="#000000"><font color="#000000"><font color="#008080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tSC</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">VKReader.Requests.APIPublicMethodsCaller</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">NewsfeedSearch</font> <font color="#000000">(.</font> <font color="#800000">Response</font> <font color="#000000">,</font> <font color="#800000">query</font> ,</font></font> <font color="#000000"><font color="#000000"><br><font color="#000000">&nbsp;</font></font></font>  <font color="#000000"><font color="#000000"><font color="#800000">count</font> <font color="#000000">,,,</font> <font color="#800000">startDate</font> <font color="#000000">,</font> <font color="#800000">startTime</font> <font color="#000000">,</font> <font color="#800000">endDate</font> <font color="#000000">,</font> <font color="#800000">endTime</font> <font color="#000000">)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">quit</font> <font color="#000000">:</font> <font color="#0000ff">$$$ ISERR</font> <font color="#000000">(</font> <font color="#800000">tSC</font> <font color="#000000">)</font> <font color="#800000">tSC</font></font></font> <font color="#000000"><font color="#000000"><font color="#800000"><br><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">do</font> <font color="#000000">..</font> <font color="#0000ff">RegisterMetadataKeys</font> <font color="#000000">(</font> <font color="#0000ff">$ lb</font> <font color="#000000">(</font> <font color="#008000">"PostDate"</font> <font color="#000000">,</font> <font color="#008000">"PostTime"</font> <font color="#000000">,</font> <font color="#008000">"AuthorID"</font> <font color="#000000">,</font> <font color="#008000">"AuthorCity"</font> <font color="#000000">,</font> <font color="#008000">"AuthorCountry"</font> ,</font></font> <font color="#000000"><font color="#000000"><br><font color="#000000">&nbsp;</font></font></font>  <font color="#000000"><font color="#000000"><font color="#008000">"AuthorDOB"</font> <font color="#000000">,</font> <font color="#008000">"AuthorSex"</font> <font color="#000000">))</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">userIds</font> <font color="#000000">=</font> <font color="#008000">"1"</font></font></font> <font color="#000000"><font color="#000000"><font color="#008000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">groupIds</font> <font color="#000000">=</font> <font color="#008000">"1"</font></font></font> <font color="#000000"><font color="#000000"><font color="#008000"><br><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">for</font> <font color="#800000">i</font> <font color="#000000">= 1: 1:</font> <font color="#800000">response</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">Count</font> <font color="#000000">()</font> <font color="#800080">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">if</font> <font color="#000000">(</font> <font color="#800000">response</font> <font color="#000000">.</font> <font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">i</font> <font color="#000000">).</font> <font color="#0000ff">FromID</font> <font color="#000000">&lt;0)</font> <font color="#800080">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">groupIds</font> <font color="#000000">=</font> <font color="#800000">groupIds</font> <font color="#000000">_</font> <font color="#008000">","</font> <font color="#000000">_ (- (</font> <font color="#800000">response</font> <font color="#000000">.</font> <font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">i</font> <font color="#000000">).</font> <font color="#0000ff">FromID</font> <font color="#000000">))</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#800080">}</font> <font color="#0000ff">else</font> <font color="#800080">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">userIds</font> <font color="#000000">=</font> <font color="#800000">userIds</font> <font color="#000000">_</font> <font color="#008000">","</font> <font color="#000000">_</font> <font color="#800000">response</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">i</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">FromID</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#800080">}</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#800080">}</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tSC</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">VKReader.Requests.APIPublicMethodsCaller</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">UsersGet</font> <font color="#000000">(.</font> <font color="#800000">ResponseUsers</font> <font color="#000000">,</font> <font color="#800000">userIds</font> ,</font></font> <font color="#000000"><font color="#000000"><br><font color="#000000">&nbsp;</font></font></font>  <font color="#000000"><font color="#000000"><font color="#008000">"sex, city, bdate, country"</font> <font color="#000000">)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">quit</font> <font color="#000000">:</font> <font color="#0000ff">$$$ ISERR</font> <font color="#000000">(</font> <font color="#800000">tSC</font> <font color="#000000">)</font> <font color="#800000">tSC</font></font></font> <font color="#000000"><font color="#000000"><font color="#800000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tSC</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">VKReader.Requests.APIPublicMethodsCaller</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GroupsGetById</font> <font color="#000000">(.</font> <font color="#800000">ResponseGroups</font> <font color="#000000">,</font> <font color="#800000">groupIds</font> ,</font></font> <font color="#000000"><font color="#000000"><br><font color="#000000">&nbsp;</font></font></font>  <font color="#000000"><font color="#000000"><font color="#008000">"city, country"</font> <font color="#000000">)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">quit</font> <font color="#000000">:</font> <font color="#0000ff">$$$ ISERR</font> <font color="#000000">(</font> <font color="#800000">tSC</font> <font color="#000000">)</font> <font color="#800000">tSC</font></font></font> <font color="#000000"><font color="#000000"><font color="#800000"><br><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">for</font> <font color="#800000">i</font> <font color="#000000">= 1: 1:</font> <font color="#800000">response</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">Count</font> <font color="#000000">()</font> <font color="#800080">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tPostDate</font> <font color="#000000">=</font> <font color="#800000">response</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">i</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">Date</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tPostTime</font> <font color="#000000">=</font> <font color="#800000">response</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">i</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">Time</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tOwnerID</font> <font color="#000000">=</font> <font color="#800000">response</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">i</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">OwnerID</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tFromID</font> <font color="#000000">=</font> <font color="#800000">response</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">i</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">FromID</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tID</font> <font color="#000000">=</font> <font color="#800000">response</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">i</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">ID</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">#dim</font> <font color="#800000">tTextStream</font> <font color="#0000ff">as</font> <font color="#008080">% GlobalCharacterStream</font></font></font> <font color="#000000"><font color="#000000"><font color="#008080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tTextStream</font> <font color="#000000">=</font> <font color="#800000">response</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">i</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">Text</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">if</font> <font color="#000000">(</font> <font color="#800000">tFromID</font> <font color="#000000">&lt;0)</font> <font color="#800080">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tAuthorCity</font> <font color="#000000">=</font> <font color="#800000">responseGroups</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(-</font> <font color="#800000">tFromID</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">City</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tAuthorCountry</font> <font color="#000000">=</font> <font color="#800000">responseGroups</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(-</font> <font color="#800000">tFromID</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">Country</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tAuthorDOB</font> <font color="#000000">=</font> <font color="#008000">""</font></font></font> <font color="#000000"><font color="#000000"><font color="#008000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tAuthorSex</font> <font color="#000000">=</font> <font color="#008000">""</font></font></font> <font color="#000000"><font color="#000000"><font color="#008000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#800080">}</font> <font color="#0000ff">else</font> <font color="#800080">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tAuthorCity</font> <font color="#000000">=</font> <font color="#800000">responseUsers</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">tFromID</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">City</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tAuthorCountry</font> <font color="#000000">=</font> <font color="#800000">responseUsers</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">tFromID</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">Country</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tAuthorDOB</font> <font color="#000000">=</font> <font color="#800000">responseUsers</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">tFromID</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">DOB</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tAuthorSex</font> <font color="#000000">=</font> <font color="#800000">responseUsers</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">tFromID</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">Sex</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#800080">}</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tLocalRef</font> <font color="#000000">=</font> <font color="#800000">tOwnerID</font> <font color="#000000">_</font> <font color="#008000">"#"</font> <font color="#000000">_</font> <font color="#800000">tFromID</font> <font color="#000000">_</font> <font color="#008000">"#"</font> <font color="#000000">_</font> <font color="#800000">tID</font></font></font> <font color="#000000"><font color="#000000"><font color="#800000"><br><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">if</font> <font color="#000000">(</font> <font color="#800000">checkExists</font> <font color="#000000">)</font> <font color="#800080">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">continue</font> <font color="#000000">: ..</font> <font color="#0000ff">RefExists</font> <font color="#000000">(</font> <font color="#800000">query</font> <font color="#000000">,</font> <font color="#800000">tLocalRef</font> <font color="#000000">,</font> <font color="#800000">checkExists</font> <font color="#000000">- 1)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#800080">}</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tRef</font> <font color="#000000">=</font> <font color="#0000ff">$ lb</font> <font color="#000000">(i% ListerClassId, ..</font> <font color="#0000ff">AddGroup</font> <font color="#000000">(</font> <font color="#800000">query</font> <font color="#000000">),</font> <font color="#800000">tLocalRef</font> <font color="#000000">)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">do</font> <font color="#800000">tTextStream</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">Rewind</font> <font color="#000000">()</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">if</font> <font color="#000000">(</font> <font color="#800000">tTextStream</font> <font color="#000000">.</font> <font color="#0000ff">Size</font> <font color="#000000">= 0)</font> <font color="#800080">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">continue</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#800080">}</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">len</font> <font color="#000000">= 32000</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">while</font> <font color="#000000">(</font> <font color="#800000">len</font> <font color="#000000">= 32000)</font> <font color="#800080">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">do</font> <font color="#000000">..</font> <font color="#0000ff">StoreTemp</font> <font color="#000000">(</font> <font color="#800000">tRef</font> <font color="#000000">,</font> <font color="#800000">tTextStream</font> <font color="#000000">.</font> <font color="#0000ff">Read</font> <font color="#000000">(.</font> <font color="#800000">len</font> <font color="#000000">))</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#800080">}</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">do</font> <font color="#000000">..</font> <font color="#0000ff">SetMetadataValues</font> <font color="#000000">(</font> <font color="#800000">tRef</font> <font color="#000000">,</font> <font color="#0000ff">$ lb</font> <font color="#000000">(</font> <font color="#800000">tPostDate</font> <font color="#000000">,</font> <font color="#800000">tPostTime</font> <font color="#000000">,</font> <font color="#800000">tFromID</font> <font color="#000000">,</font> <font color="#800000">tAuthorCity</font> <font color="#000000">,</font> <font color="#800000">tAuthorCountry</font> ,</font></font> <font color="#000000"><font color="#000000"><br><font color="#000000">&nbsp;</font></font></font>  <font color="#000000"><font color="#000000"><font color="#800000">tAuthorDOB</font> <font color="#000000">,</font> <font color="#800000">tAuthorSex</font> <font color="#000000">))</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#800080">}</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#800080">}</font></font></font> <font color="#000000"><font color="#000000"><br></font></font> </div></div> <font color="#000000"><font color="#000000"><br></font></font>  <font color="#000000"><font color="#000000">Go through the code in more detail.</font></font> <font color="#000000"><font color="#000000"><br></font></font>  <font color="#000000"><font color="#000000">First we select the arguments.</font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">query</font> <font color="#000000">=</font> <font color="#0000ff">$ li</font> <font color="#000000">(</font> <font color="#800000">listparams</font> <font color="#000000">, 1)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">count</font> <font color="#000000">=</font> <font color="#0000ff">$ li</font> <font color="#000000">(</font> <font color="#800000">listparams</font> <font color="#000000">, 2)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">checkExists</font> <font color="#000000">= +</font> <font color="#0000ff">$ lg</font> <font color="#000000">(</font> <font color="#800000">listparams</font> <font color="#000000">, 3, 1)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">startDate</font> <font color="#000000">=</font> <font color="#0000ff">$ lg</font> <font color="#000000">(</font> <font color="#800000">listparams</font> <font color="#000000">, 4)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">startTime</font> <font color="#000000">=</font> <font color="#0000ff">$ lg</font> <font color="#000000">(</font> <font color="#800000">listparams</font> <font color="#000000">, 5)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">endDate</font> <font color="#000000">=</font> <font color="#0000ff">$ lg</font> <font color="#000000">(</font> <font color="#800000">listparams</font> <font color="#000000">, 6)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">endTime</font> <font color="#000000">=</font> <font color="#0000ff">$ lg</font> <font color="#000000">(</font> <font color="#800000">listparams</font> <font color="#000000">, 7)</font></font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000">Make a request to the API Vkontakte through our method-wrapper.</font></font>  <font color="#000000"><font color="#000000">The result of the work of this method is a list of objects of the class <code>VKReader.Data.Post</code> , which contains some characteristic fields for recording Vkontakte.</font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">#dim</font> <font color="#800000">response</font> <font color="#0000ff">As</font> <font color="#008080">% ListOfObjects</font></font></font> <font color="#000000"><font color="#000000"><font color="#008080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tSC</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">VKReader.Requests.APIPublicMethodsCaller</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">NewsfeedSearch</font> <font color="#000000">(.</font> <font color="#800000">Response</font> <font color="#000000">,</font> <font color="#800000">query</font> ,</font></font> <font color="#000000"><font color="#000000"><br><font color="#000000">&nbsp;</font></font></font>  <font color="#000000"><font color="#000000"><font color="#800000">count</font> <font color="#000000">,,,</font> <font color="#800000">startDate</font> <font color="#000000">,</font> <font color="#800000">startTime</font> <font color="#000000">,</font> <font color="#800000">endDate</font> <font color="#000000">,</font> <font color="#800000">endTime</font> <font color="#000000">)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">quit</font> <font color="#000000">:</font> <font color="#0000ff">$$$ ISERR</font> <font color="#000000">(</font> <font color="#800000">tSC</font> <font color="#000000">)</font> <font color="#800000">tSC</font></font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000">We will register metadata keys for further easy saving of meta-information.</font></font>  <font color="#000000"><font color="#000000">In the metadata we want to store the date and time of publication of the record, as well as the id, city, country and date of birth of the author.</font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">do</font> <font color="#000000">..</font> <font color="#0000ff">RegisterMetadataKeys</font> <font color="#000000">(</font> <font color="#0000ff">$ lb</font> <font color="#000000">(</font> <font color="#008000">"PostDate"</font> <font color="#000000">,</font> <font color="#008000">"PostTime"</font> <font color="#000000">,</font> <font color="#008000">"AuthorID"</font> <font color="#000000">,</font> <font color="#008000">"AuthorCity"</font> <font color="#000000">,</font> <font color="#008000">"AuthorCountry"</font> ,</font></font> <font color="#000000"><font color="#000000"><br><font color="#000000">&nbsp;</font></font></font>  <font color="#000000"><font color="#000000"><font color="#008000">"AuthorDOB"</font> <font color="#000000">,</font> <font color="#008000">"AuthorSex"</font> <font color="#000000">))</font></font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000">Save the comma-separated-list id of users and groups that are authors of the records we found.</font></font>  <font color="#000000"><font color="#000000">Id groups, as in the API Vkontakte, are negative integers, and user id - positive.</font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">userIds</font> <font color="#000000">=</font> <font color="#008000">"1"</font></font></font> <font color="#000000"><font color="#000000"><font color="#008000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">groupIds</font> <font color="#000000">=</font> <font color="#008000">"1"</font></font></font> <font color="#000000"><font color="#000000"><font color="#008000"><br><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">for</font> <font color="#800000">i</font> <font color="#000000">= 1: 1:</font> <font color="#800000">response</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">Count</font> <font color="#000000">()</font> <font color="#800080">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">if</font> <font color="#000000">(</font> <font color="#800000">response</font> <font color="#000000">.</font> <font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">i</font> <font color="#000000">).</font> <font color="#0000ff">FromID</font> <font color="#000000">&lt;0)</font> <font color="#800080">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">groupIds</font> <font color="#000000">=</font> <font color="#800000">groupIds</font> <font color="#000000">_</font> <font color="#008000">","</font> <font color="#000000">_ (- (</font> <font color="#800000">response</font> <font color="#000000">.</font> <font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">i</font> <font color="#000000">).</font> <font color="#0000ff">FromID</font> <font color="#000000">))</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#800080">}</font> <font color="#0000ff">else</font> <font color="#800080">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">userIds</font> <font color="#000000">=</font> <font color="#800000">userIds</font> <font color="#000000">_</font> <font color="#008000">","</font> <font color="#000000">_</font> <font color="#800000">response</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">i</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">FromID</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#800080">}</font></font></font> <font color="#000000"><font color="#000000"><br></font></font>  <font color="#000000"><font color="#000000">}</font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000">Get information about these users and groups using wrapper methods.</font></font>  <font color="#000000"><font color="#000000">They return lists of objects of the <code>VKReader.Data.User</code> and <code>VKReader.Data.Group</code> , containing fields specific to users and Vkontakte groups (such as a city, a country, and everything else).</font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tSC</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">VKReader.Requests.APIPublicMethodsCaller</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">UsersGet</font> <font color="#000000">(.</font> <font color="#800000">ResponseUsers</font> <font color="#000000">,</font> <font color="#800000">userIds</font> ,</font></font> <font color="#000000"><font color="#000000"><br><font color="#000000">&nbsp;</font></font></font>  <font color="#000000"><font color="#000000"><font color="#008000">"sex, city, bdate, country"</font> <font color="#000000">)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">quit</font> <font color="#000000">:</font> <font color="#0000ff">$$$ ISERR</font> <font color="#000000">(</font> <font color="#800000">tSC</font> <font color="#000000">)</font> <font color="#800000">tSC</font></font></font> <font color="#000000"><font color="#000000"><font color="#800000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tSC</font> <font color="#000000">=</font> <font color="#000080">## class</font> <font color="#000000">(</font> <font color="#008080">VKReader.Requests.APIPublicMethodsCaller</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GroupsGetById</font> <font color="#000000">(.</font> <font color="#800000">ResponseGroups</font> <font color="#000000">,</font> <font color="#800000">groupIds</font> ,</font></font> <font color="#000000"><font color="#000000"><br><font color="#000000">&nbsp;</font></font></font>  <font color="#000000"><font color="#000000"><font color="#008000">"city, country"</font> <font color="#000000">)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">quit</font> <font color="#000000">:</font> <font color="#0000ff">$$$ ISERR</font> <font color="#000000">(</font> <font color="#800000">tSC</font> <font color="#000000">)</font> <font color="#800000">tSC</font></font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000">In the cycle we will process all found posts.</font></font>  <font color="#000000"><font color="#000000">First, we select all the resulting meta-information into local variables.</font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tPostDate</font> <font color="#000000">=</font> <font color="#800000">response</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">i</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">Date</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tPostTime</font> <font color="#000000">=</font> <font color="#800000">response</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">i</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">Time</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tOwnerID</font> <font color="#000000">=</font> <font color="#800000">response</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">i</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">OwnerID</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tFromID</font> <font color="#000000">=</font> <font color="#800000">response</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">i</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">FromID</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tID</font> <font color="#000000">=</font> <font color="#800000">response</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">i</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">ID</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">#dim</font> <font color="#800000">tTextStream</font> <font color="#0000ff">as</font> <font color="#008080">% GlobalCharacterStream</font></font></font> <font color="#000000"><font color="#000000"><font color="#008080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tTextStream</font> <font color="#000000">=</font> <font color="#800000">response</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">i</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">Text</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">if</font> <font color="#000000">(</font> <font color="#800000">tFromID</font> <font color="#000000">&lt;0)</font> <font color="#800080">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tAuthorCity</font> <font color="#000000">=</font> <font color="#800000">responseGroups</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(-</font> <font color="#800000">tFromID</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">City</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tAuthorCountry</font> <font color="#000000">=</font> <font color="#800000">responseGroups</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(-</font> <font color="#800000">tFromID</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">Country</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tAuthorDOB</font> <font color="#000000">=</font> <font color="#008000">""</font></font></font> <font color="#000000"><font color="#000000"><font color="#008000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tAuthorSex</font> <font color="#000000">=</font> <font color="#008000">""</font></font></font> <font color="#000000"><font color="#000000"><font color="#008000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#800080">}</font> <font color="#0000ff">else</font> <font color="#800080">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tAuthorCity</font> <font color="#000000">=</font> <font color="#800000">responseUsers</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">tFromID</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">City</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tAuthorCountry</font> <font color="#000000">=</font> <font color="#800000">responseUsers</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">tFromID</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">Country</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tAuthorDOB</font> <font color="#000000">=</font> <font color="#800000">responseUsers</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">tFromID</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">DOB</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tAuthorSex</font> <font color="#000000">=</font> <font color="#800000">responseUsers</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">GetAt</font> <font color="#000000">(</font> <font color="#800000">tFromID</font> <font color="#000000">).</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">Sex</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#800080">}</font></font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000">Local reference - wall owner id, sender id and record id, separated by a grid.</font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tLocalRef</font> <font color="#000000">=</font> <font color="#800000">tOwnerID</font> <font color="#000000">_</font> <font color="#008000">"#"</font> <font color="#000000">_</font> <font color="#800000">tFromID</font> <font color="#000000">_</font> <font color="#008000">"#"</font> <font color="#000000">_</font> <font color="#800000">tID</font></font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000">If necessary, check if there are sources with the same local reference.</font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">if</font> <font color="#000000">(</font> <font color="#800000">checkExists</font> <font color="#000000">)</font> <font color="#800080">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">continue</font> <font color="#000000">: ..</font> <font color="#0000ff">RefExists</font> <font color="#000000">(</font> <font color="#800000">query</font> <font color="#000000">,</font> <font color="#800000">tLocalRef</font> <font color="#000000">,</font> <font color="#800000">checkExists</font> <font color="#000000">- 1)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#800080">}</font></font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000">The following code could be different if another source handler were chosen.</font></font>  <font color="#000000"><font color="#000000">I use a handler for temporary storage, so I need to expand the list using the <code>StoreTemp</code> method (for more information on each handler, see the page with its documentation).</font></font>  <font color="#000000"><font color="#000000">Also I need to set the values ‚Äã‚Äãobtained for the metadata fields.</font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">tRef</font> <font color="#000000">=</font> <font color="#0000ff">$ lb</font> <font color="#000000">(i% ListerClassId, ..</font> <font color="#0000ff">AddGroup</font> <font color="#000000">(</font> <font color="#800000">query</font> <font color="#000000">),</font> <font color="#800000">tLocalRef</font> <font color="#000000">)</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">do</font> <font color="#800000">tTextStream</font> <font color="#000000">.</font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">Rewind</font> <font color="#000000">()</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">if</font> <font color="#000000">(</font> <font color="#800000">tTextStream</font> <font color="#000000">.</font> <font color="#0000ff">Size</font> <font color="#000000">= 0)</font> <font color="#800080">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">continue</font></font></font> <font color="#000000"><font color="#000000"><font color="#0000ff"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#800080">}</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">set</font> <font color="#800000">len</font> <font color="#000000">= 32000</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">while</font> <font color="#000000">(</font> <font color="#800000">len</font> <font color="#000000">= 32000)</font> <font color="#800080">{</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">do</font> <font color="#000000">..</font> <font color="#0000ff">StoreTemp</font> <font color="#000000">(</font> <font color="#800000">tRef</font> <font color="#000000">,</font> <font color="#800000">tTextStream</font> <font color="#000000">.</font> <font color="#0000ff">Read</font> <font color="#000000">(.</font> <font color="#800000">len</font> <font color="#000000">))</font></font></font> <font color="#000000"><font color="#000000"><font color="#000000"><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#800080">}</font></font></font> <font color="#000000"><font color="#000000"><font color="#800080"><br><br></font></font></font>  <font color="#000000"><font color="#000000"><font color="#0000ff">do</font> <font color="#000000">..</font> <font color="#0000ff">SetMetadataValues</font> <font color="#000000">(</font> <font color="#800000">tRef</font> <font color="#000000">,</font> <font color="#0000ff">$ lb</font> <font color="#000000">(</font> <font color="#800000">tPostDate</font> <font color="#000000">,</font> <font color="#800000">tPostTime</font> <font color="#000000">,</font> <font color="#800000">tFromID</font> <font color="#000000">,</font> <font color="#800000">tAuthorCity</font> <font color="#000000">,</font> <font color="#800000">tAuthorCountry</font> ,</font></font> <font color="#000000"><font color="#000000"><br><font color="#000000">&nbsp;</font></font></font>  <font color="#000000"><font color="#000000"><font color="#800000">tAuthorDOB</font> <font color="#000000">,</font> <font color="#800000">tAuthorSex</font> <font color="#000000">))</font></font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000">Everything.</font></font>  <font color="#000000"><font color="#000000">Lister is written!</font></font> <font color="#000000"><font color="#000000"><br></font></font>  <font color="#000000"><font color="#000000">Let's test his work.</font></font> <font color="#000000"><font color="#000000"><br><br></font></font> <h2>  <font color="#000000"><font color="#000000">Testing Lister</font></font> </h2> <font color="#000000"><font color="#000000"><br></font></font>  <font color="#000000"><font color="#000000">I wrote a small web application that, using the Lister we implemented, allows you to view, search for similar ones, add them on request, and delete records from the domain.</font></font>  <font color="#000000"><font color="#000000">Here are some screenshots:</font></font> <font color="#000000"><font color="#000000"><br><br></font></font>  <font color="#000000"><font color="#000000">Initially empty domain.</font></font> <font color="#000000"><font color="#000000"><br><br><img src="https://habrastorage.org/files/9d2/c67/06c/9d2c6706c70e4ae6967b5357a3cb0dcc.png" alt="alt text"><br></font></font>  <font color="#000000"><font color="#000000">Click on the plus sign to add new posts.</font></font> <font color="#000000"><font color="#000000"><br></font></font>  <font color="#000000"><font color="#000000">In the form that appears, fill in the fields and click on the button to add entries.</font></font> <font color="#000000"><font color="#000000"><br><br><img src="https://habrastorage.org/files/62e/0b7/4cc/62e0b74cc8af484c84078702e552998f.png" alt="alt text"><br></font></font>  <font color="#000000"><font color="#000000">We are waiting for some time and records are added.</font></font> <font color="#000000"><font color="#000000"><br><br><img src="https://habrastorage.org/files/c91/e56/204/c91e5620430843778bafdb18b4bf24bc.png" alt="alt text"><br></font></font>  <font color="#000000"><font color="#000000">For those users or groups who have provided data about themselves in open access, our Lister stores them in the meta-information fields, and this small demo displays them in a not-too-elegant table.</font></font> <font color="#000000"><font color="#000000"><br></font></font>  <font color="#000000"><font color="#000000">Out of the box, iKnow can show similar entries: click on the button with the target near some post and make sure that it works.</font></font> <font color="#000000"><font color="#000000"><br><br><img src="https://habrastorage.org/files/bc2/a5c/2ac/bc2a5c2acd5e4241a0cf687edaf03649.png" alt="alt text"><br></font></font> <h2>  <font color="#000000"><font color="#000000">Summary</font></font> </h2> <font color="#000000"><font color="#000000"><br></font></font>  <font color="#000000"><font color="#000000">In the course of the article, we figured out how data loading to the domain works, discussed in detail how the average lister works and how to write our own lister, which will also work.</font></font>  <font color="#000000"><font color="#000000">They wrote their lister to work with Vkontakte data, and also made sure that it really works in the modulus of the fact that the domain and configuration were created somewhere behind the scenes.</font></font> <font color="#000000"><font color="#000000"><br></font></font>  <font color="#000000"><font color="#000000">In case there is a desire to look behind these scenes, all the code that was stated, used or mentioned in the article can be found on the project page on <a href="https://github.com/intersystems-ru/iknowSocial">github</a> .</font></font> </div><p>Source: <a href="https://habr.com/ru/post/246719/">https://habr.com/ru/post/246719/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../246707/index.html">Parsing formulas with functions</a></li>
<li><a href="../246709/index.html">How to disable updates in Skype and advertising at the same time</a></li>
<li><a href="../246711/index.html">Named C ++ Parameters. Not useful</a></li>
<li><a href="../246713/index.html">Registration of offshore company in Belize</a></li>
<li><a href="../246717/index.html">Christmas tales engineer post</a></li>
<li><a href="../246721/index.html">DriverPack on the threshold of 2015: statistics</a></li>
<li><a href="../246723/index.html">Rzborda, or How to Make an Internet-Controlled Typewriter</a></li>
<li><a href="../246725/index.html">Brand management mistakes</a></li>
<li><a href="../246727/index.html">Massage and IT</a></li>
<li><a href="../246729/index.html">Earnings in the system of mobile motivation AppBonus. Organizational model of the platform and its use</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>