<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Clever cache deletion (php 5 + Mongodb + memcached)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 In our time, a huge number of high-loaded projects topic caching something that was not as relevant as ever. Cached as requests from the da...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Clever cache deletion (php 5 + Mongodb + memcached)</h1><div class="post__text post__text-html js-mediator-article"><h4>  Foreword </h4><br>  In our time, a huge number of high-loaded projects topic caching something that was not as relevant as ever.  Cached as requests from the database, the individual blocks of the page, and all pages entirely. <br><br>  For myself, I decided to cache only the results of queries to the database, because, IMHO, to load the cache with huge (or not so) html blocks - in some way wasting resources.  (This statement is most likely true only if you are not using the template engine).  And of course, as a caching service, I use the well-known memcached. <br>  Now let's see - what problems await us with this caching. <br>  And the problem is only one, but not the most biased - keeping the cache always up to date. <br><br>  Under the cut - my solution to the problem, allowing the cache to live forever (unless of course it is relevant and you have not run out of RAM). <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Read more </h4><br>  Adhering to the current MVC model, all requests to the database will be carried out in models.  In my projects for each section of the site I have my own separate model, as well as a general model, the data from which are needed in each section. <br><br>  The key of the cache entry thus consists of the name of the section, the name of the function and the parameters passed to this function.  All this turns into md5 in order to prevent too long drains or the transfer of an array of parameters as part of the cache key. <br><br>  Now, when updating information in the database in 90% of cases, we will definitely know the cache of what functions we need to reset.  But this is not always the case.  For example, the user deleted the last 5 messages from his personal account, but since all messages are broken, say 10 per page, resetting only the last page cache, all other pages remain cached in the old state, and this is no longer good.  The task is to reset the function cache, knowing only 1 of its parameter (user id), but not knowing the second (page number). <br><br><h4>  So my solution </h4><br>  In short, each time a new entry is added to the cache, the key components are written to Mongo, thereby giving the opportunity to completely recreate the cache key, knowing only a part of it.  I will not go into details, just run through the code. <br><pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cache</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Memcached</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $registry; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::__construct(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addServer(<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-number"><span class="hljs-number">11211</span></span>); $m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mongo(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;registry = $m-&gt;local-&gt;cache_registry; <span class="hljs-comment"><span class="hljs-comment">// ,      } public function set($name, $content) { //    $this-&gt;registry-&gt;insert(array('id' =&gt; $name)); parent::set(md5(print_r($name, 1)), $content); } public function delete($name) { //    $this-&gt;registry-&gt;remove(array('id' =&gt; $name)); parent::delete(md5(print_r($name, 1))); } public function get($name) { return parent::get(md5(print_r($name, 1))); } public function smart_delete($params) { //    $criteria = array(); $size = sizeof($params); for ($i = 0; $i &lt; 2; $i++) { //       $criteria['id.' . $i] = $params[$i]; } if ($size == 3) { //     for ($i = 0; $i &lt; sizeof($params[2]); $i++) { $criteria['id.2.' . $i] = $params[2][$i]; } } elseif ($size &gt; 3) throw new Exception('Size of input parameters is out of expected range'); $cursor = $this-&gt;registry-&gt;find($criteria); while ($cursor-&gt;hasNext()) { //          $data = $cursor-&gt;getNext(); $id = $data['_id']; parent::delete(md5(print_r($data['id'], 1))); $this-&gt;registry-&gt;remove(array('_id' =&gt; new MongoId($id))); } } }</span></span></code> </pre> <br><br>  And an example of a call, so that everything finally falls into place: <br><pre> <code class="php hljs">$cache = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Cache(); $cache-&gt;smart_delete(<span class="hljs-string"><span class="hljs-string">'user'</span></span>, <span class="hljs-string"><span class="hljs-string">'messages'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>));<span class="hljs-comment"><span class="hljs-comment">/*    messages   user    = 1*/</span></span></code> </pre><br><br>  As you can see, all the indecency is simple and quite a lot of profit <br><ol><li>  Delete all entries from a specific section </li><li>  Delete all entries in the section by function name only </li><li>  Delete all function entries, knowing only the required parameter and discarding unnecessary ones. </li></ol><br><br>  Of course, despite the fact that it is implemented now it is impossible to delete a record, knowing only the second parameter and not knowing the first one, which obliges you to think through the order of parameters at the moment of creating the function.  Or delete records of the same functions from different sections (why not?), But I think that if there is free time, all this is completely realizable. <br><br>  PS All with the last holidays! </div><p>Source: <a href="https://habr.com/ru/post/111508/">https://habr.com/ru/post/111508/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111502/index.html">The British are planning to create a jumping rover</a></li>
<li><a href="../111503/index.html">Installing Ubuntu Desktop on LVM</a></li>
<li><a href="../111504/index.html">MultiTouch Ltd introduced the 46-inch multi-touch touchpad at CES</a></li>
<li><a href="../111505/index.html">Wine 1.3.11 release</a></li>
<li><a href="../111507/index.html">Ways of visualization in multi-dimensional games</a></li>
<li><a href="../111509/index.html">Role information modeling in programming</a></li>
<li><a href="../111510/index.html">A simple implementation of RC4 in C #</a></li>
<li><a href="../111511/index.html">Android PC Game Controller</a></li>
<li><a href="../111512/index.html">Threats Inside: we initialize channels of leakage of corporate information</a></li>
<li><a href="../111513/index.html">Reverse engineering android applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>