<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Oracle SQL: Model dialect in examples. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is a continuation of an article on using the SELECT statement extension ‚Äî the Model construct. From the first part, you already have an idea of ‚Äã...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Oracle SQL: Model dialect in examples. Part 2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/habraeffect/c7/3c/c73c6af9fd32c0687fbf65831c9b5602.jpg" alt="image" vspace="2" align="left" hspace="2">  This is a continuation of an article on using the SELECT statement extension ‚Äî the Model construct.  From the <a href="http://habrahabr.ru/blogs/oracle/101003/">first part,</a> you already have an idea of ‚Äã‚Äãthe purpose and some features of its use, as well as are familiar with half the syntax.  Further, several complex examples will be analyzed, as well as an analysis of the scope and performance. <br><a name="habracut"></a><br>  The use of the MODEL construction prohibits the use of aggregate functions inside other SELECT blocks (in general, all selectable columns should be derived from those mentioned in MODEL) - instead, these functions should be declared inside PARTITION BY, DIMENSION BY or MEASURES. For example, the following simple query <br><br><blockquote><code><font color="#0000ff">SELECT</font> employee_id, sum(amount) <br> <font color="#0000ff">FROM</font> sales <br> <font color="#0000ff">GROUP BY</font> employee_id;</code> </blockquote> <br>  will be equivalent <br><br><blockquote> <code><font color="#0000ff">SELECT</font> employee_id, amt <br> <font color="#0000ff">FROM</font> sales <br> <font color="#0000ff">GROUP BY</font> employee_id <br> <font color="#0000ff">MODEL PARTITION BY</font> (employee_id) <br> <font color="#0000ff">DIMENSION BY</font> (0 dummy) <br> <font color="#0000ff">MEASURES</font> (sum(amount) amt) <br> <font color="#0000ff">RULES</font> ();</code> </blockquote> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To control the changes made by the rules, there are three semantics: UPDATE, UPSERT, UPSERT ALL.  UPDATE only allows elements to be updated, UPSERT (works by default) to change and add using positional links, and UPSERT ALL allows elements to be created using symbolic links.  You can change the semantics both for an individual rule (in this case, the directive is written before it), and at the level of the whole block (then the directive must be specified after RULES). <br><br>  It is important to know that UPSERT ALL does not work in the same way as the FOR loop.  The creation of new elimination in this case occurs in four steps. <br><ol><li>  All items that match the symbolic link are found. </li><li>  For each dimension is a set of unique index values. </li><li>  The Cartesian product of these sets is calculated. </li><li>  All non-existing elements present in the work are created. </li></ol><br><h4>  Challenging examples </h4><br><img src="https://habrastorage.org/storage/habraeffect/ce/a3/cea3945f610af8b102c31286e68afea5.jpg" alt="image" vspace="2" align="right" hspace="2">  At the end of a couple of examples that show how different tasks can be solved with the help of MODEL.  To begin with we will display a list of drunk coffee for each day in one line: <br><br><blockquote> <code><font color="#0000ff">SELECT</font> day, substr(type, 2) listing <br> <font color="#0000ff">FROM</font> coffee <br> <font color="#0000ff">MODEL RETURN UPDATED ROWS</font> <br> <font color="#0000ff">PARTITION BY</font> (day) <br> <font color="#0000ff">DIMENSION BY</font> (row_number() <font color="#0000ff">OVER</font> ( <font color="#0000ff">PARTITION BY</font> day <font color="#0000ff">ORDER BY</font> type) position) <br> <font color="#0000ff">MEASURES</font> (type, cnt) <br> <font color="#0000ff">RULES ITERATE</font> (100500) <font color="#0000ff">UNTIL</font> (presentv(type[iteration_number + 2], 1, 0) = 0) ( <br> type[0] = type[0] || <font color="#a31515">', '</font> || cnt[iteration_number + 1] || <font color="#a31515">' x '</font> || type[iteration_number + 1] <br> ) <br> <font color="#0000ff">ORDER BY</font> day; <br> <br> DAY LISTING <br> ---------- ---------------------------------------- <br> 1 1 x espresso, 1 x turkish <br> 2 1 x black, 1 x espresso, 2 x turkish <br> 3 3 x latte <br> 4 2 x black, 1 x ice</code> </blockquote> <br>  From the new function here, <em>presentv (ref, arg1, arg2)</em> , it returns <em>arg1</em> if the <em>ref</em> reference points to an existing element with a NOT NULL value and <em>arg2</em> otherwise.  For row numbering and sorting by name, an analytical function is used (row_number () OVER (PARTITION BY day ORDER BY type)).  Processing separately for each day is provided by partitioning (PARTITION BY) both in the model and in the analytical function. <br><br>  And, at the end, a geometric example.  On the straight line is given a set of intersecting segments [p1, p2], it is required to display a sorted list of ranges completely covered with segments: <br><br><blockquote> <code><font color="#0000ff">SELECT</font> * <font color="#0000ff">FROM</font> lines; <br> <br> P1         P2 <br> ---------- ---------- <br> 1          6 <br> 5          7 <br> 2          4 <br> 8         20 <br> 11         28 <br> 30         32</code> </blockquote> <br><br>  It is believed that p2&gt; = p1, the solution for arbitrarily stored segments is left for the warm-up by those interested.  So, the example code: <br><br><blockquote> <code><font color="#0000ff">SELECT</font> p1, max(p2) p2 <br> <font color="#0000ff">FROM</font> ( <br> <font color="#0000ff">SELECT</font> p1, p2 <font color="#0000ff">FROM</font> lines <br> <font color="#0000ff">MODEL DIMENSION BY</font> (row_number() <font color="#0000ff">OVER</font> ( <font color="#0000ff">ORDER BY</font> p1, p2) rn) <br> <font color="#0000ff">MEASURES</font> (p1, p2) <br> <font color="#0000ff">RULES AUTOMATIC ORDER</font> ( <br> p1[rn &gt; 1] <font color="#0000ff">ORDER BY</font> rn = <font color="#0000ff">CASE</font> sign(p2[cv(rn) - 1] - p1[cv(rn)]) <br> <font color="#0000ff">WHEN</font> 1 <font color="#0000ff">THEN</font> p1[cv(rn) - 1] <br> <font color="#0000ff">ELSE</font> p1[cv(rn)] <br> <font color="#0000ff">END</font> , <br> p2[rn &gt; 1] <font color="#0000ff">ORDER BY</font> rn = greatest(p2[cv(rn) - 1], p2[cv(rn)]) <br> ) <br> ) <br> <font color="#0000ff">GROUP BY</font> p1 <br> <font color="#0000ff">ORDER BY</font> p1; <br> <br> P1         P2 <br> ---------- ---------- <br> 1          7 <br> 8         28 <br> 30         32</code> </blockquote> <br><br>  The segments in the model are first sorted by left points and numbered (row_number () OVER (ORDER BY p1, p2)), and then viewed from the top down by the number (ORDER BY rn directive).  Notice that the symbolic link is used for the first time on the left side of the equality; this is why you must specify the order in which the elements will be processed.  If the point <em>p1 of the</em> viewed segment belongs to the previous segment, then it is replaced by <em>p1 of the</em> previous segment.  <em>p2</em> is replaced by the rightmost <em>p2</em> among the current and previous segments).  Thus, going down, we expand the range covered by segments.  The AUTOMATIC ORDER directive is used so that <em>p1</em> and <em>p2 are</em> counted in turn for the <u>current</u> segment.  If you remove the directive, the first rule for <u>all</u> lines will be executed first, and only then the second one.  In general, this directive takes into account the dependencies between elements when processing rules and may violate the order of their traversal (as described above). <br><br><h4>  Practical application and performance </h4><br>  In general, MODEL is used <s>extremely</s> rarely.  This happens because 90% of really complex things are solved by analytic functions, and those 10% that remain for MODEL are traditionally removed from the database level.  Despite this, here are the main application scenarios: <br><ul><li>  it is necessary to generate a really complex report (readability and maintainability are priority); </li><li>  sampling is not feasible even with the use of analytical functions; </li><li>  the query is dynamically generated in a high-level language (it is easier to generate rules in MODEL than analytics); </li><li>  resource-intensive iterative calculations are used, when MODEL is still enough, and the PL / SQL transition leads to a drop in performance; </li><li>  academic interest (declarative approach instead of procedural). </li></ul>  Performance is simple.  In most cases, MODEL is faster than a similar PL / SQL code, but slower than using analytic functions.  With EXPLAIN PLAN you can learn some details about processing a request. <br><ul><li>  SQL MODEL ORDERED [FAST] - means that the rules are processed in the sequence specified in the query (by default); </li><li>  SQL MODEL ACYCLIC [FAST] - cell dependencies are automatically calculated; </li><li>  SQL MODEL CYCLIC is the slowest option, with complex inter-cell dependencies. </li></ul>  The presence of FAST annotation means that everything is just fine.  This happens under the condition that all the left-hand sides of equalities are positional links, or on the left-hand side there are symbolic links, but on the right side there are simple arithmetic aggregate functions (sum, avg, etc.).  Accordingly, MODEL FAST is close in speed to the use of analytical functions, and MODEL CYCLIC can lose implementations in PL / SQL. <br><br><h4>  Literature </h4><br><ol><li>  Oracle¬Æ Database Data Warehousing Guide 11g Release 2 - Chapter 22 "SQL for Modeling". <a href="http://download.oracle.com/docs/cd/E11882_01/server.112/e10810/sqlmodel.htm"><img src="https://habrastorage.org/storage/habraeffect/b1/79/b179cb5a2357c720cc8ed0b2adeb213f.jpg" alt="image"></a> </li><li>  The SQL Model Clause of Oracle Database 10g. <a href="http://www.oracle.com/technology/products/bi/pdf/10gr1_twp_bi_dw_sqlmodel.pdf"><img src="https://habrastorage.org/storage/habraeffect/51/4c/514c2a361c8e468ecca61abd9d2b3599.jpg" alt="image"></a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/101301/">https://habr.com/ru/post/101301/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../101294/index.html">Apache Lenya - an unusual opensource CMS in Java</a></li>
<li><a href="../101297/index.html">We consider the reputation of users of social networks</a></li>
<li><a href="../101298/index.html">On the server park, clusters and data centers Intel</a></li>
<li><a href="../101299/index.html">Installing Debian \ Ubuntu 10.04 on a RAID 5 array</a></li>
<li><a href="../101300/index.html">vds64 - silence of the lambs</a></li>
<li><a href="../101303/index.html">Five free invitations to Patterns & Practices Summit Russia 2010</a></li>
<li><a href="../101304/index.html">Vertical scroll with Javascript</a></li>
<li><a href="../101305/index.html">Ironic illustrated HTML5 video tutorial</a></li>
<li><a href="../101307/index.html">Youtube has opened for Russian advertisers</a></li>
<li><a href="../101308/index.html">The future of bynet in questions and answers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>