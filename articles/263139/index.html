<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pussy: Refactoring. Part two or addiction treatment</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This translation is a continuation of a series of articles on refactoring from Matthias Noback. 

 The world is not so reliable to rely on it 
 During...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pussy: Refactoring. Part two or addiction treatment</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/389/bf3/282/389bf3282a848b64b37aa11a60bce887.jpg" alt="image" title="Franz Marc - Girl with cat II, 1912" align="left">  This translation is a <a href="http://habrahabr.ru/post/262995/">continuation of a</a> series of articles on refactoring from Matthias Noback. <br><br><h4>  The world is not so reliable to rely on it </h4><br>  During unit testing there is no need for the external environment to be involved in the testing process itself.  Making real queries to the database, HTTP requests or writing to files, you slow down the tests, because these operations are unpredictable.  For example, if the server to which you make inquiries during testing has fallen or has not responded in the best way - the unit test will fall even if everything else works correctly.  This is bad, as unit tests should fall only when the code does something that it should not do. <br><br>  As you can see in the last article, both classes (CachedCatApi and RealCatApi) depend on external factors.  The first one writes files to the file system, the second one makes real HTTP requests, while these moments are rather low-level and the right tools are not used for them.  Moreover, these classes do not take into account a large number of borderline cases. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Both classes may be deprived of such dependencies and for this it is enough that the new classes encapsulate all these low-level details.  For example, we can easily remove the call to file_get_contents () in another class called FileGetContentsHttpClient. <br><br><pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FileGetContentsHttpClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($url)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> @file_get_contents($url); } }</code> </pre> <br><a name="habracut"></a><h4>  Again inversion of dependencies </h4><br>  As in the previous article, you can‚Äôt just take and render some code to another class.  For the new class, you need to enter the interface, because without it it will be difficult to write a normal test: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HttpClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string|false Response body */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($url)</span></span></span></span>; }</code> </pre><br>  Now you can pass HttpClient as an argument to the constructor of RealCatApi: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RealCatApi</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CatAPi</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $httpClient; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HttpClient $httpClient)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;httpClient = $httpClient; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRandomImage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $responseXml = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;httpClient-&gt;get(<span class="hljs-string"><span class="hljs-string">'http://thecatapi.com/api/images/get?format=xml&amp;type=jpg'</span></span>); ... } }</code> </pre><br><h4>  Real Unit Test </h4><br>  From now on, we will have a really cool unit test for RealCatApi.  It is only necessary to replace (stand-in?) HttpClient, so that he returned a predefined XML-response: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RealCatApiTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PHPUnit_Framework_TestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@test</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">it_fetches_a_random_url_of_a_cat_gif</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $xmlResponse = &lt;&lt;&lt;EOD &lt;response&gt; &lt;data&gt; &lt;images&gt; &lt;image&gt; &lt;url&gt;http:<span class="hljs-comment"><span class="hljs-comment">//24.media.tumblr.com/tumblr_lgg3m9tRY41qgnva2o1_500.jpg&lt;/url&gt; &lt;id&gt;bie&lt;/id&gt; &lt;source_url&gt;http://thecatapi.com/?id=bie&lt;/source_url&gt; &lt;/image&gt; &lt;/images&gt; &lt;/data&gt; &lt;/response&gt; EOD; $httpClient = $this-&gt;getMock('HttpClient'); $httpClient -&gt;expect($this-&gt;once()) -&gt;method('get') -&gt;with('http://thecatapi.com/api/images/get?format=xml&amp;type=jpg') -&gt;will($this-&gt;returnValue($xmlResponse)); $catApi = new RealCatApi($httpClient); $url = $catApi-&gt;getRandomImage(); $this-&gt;assertSame( 'http://24.media.tumblr.com/tumblr_lgg3m9tRY41qgnva2o1_500.jpg', $url ); } }</span></span></code> </pre><br>  Now this is the correct test that verifies the following RealCatApi behavior: it must call HttpClient with a specific URL and return the field value from the XML response. <br><br><h4>  Separate API from file_get_contents () </h4><br>  There remains one more thing to fix: the get () method of the HttpClient class still depends on the behavior of file_get_contents (), that is, returns false if the request was unsuccessful, or the response body as a string if the request is successful.  We can easily <i>hide this implementation detail by</i> converting some return values ‚Äã‚Äã(like false, for example) into exceptions defined for them (custom action).  Thus, we strictly limit the number of processed entities that pass through our objects.  In our case, this is only a function argument, a returned string or an exception: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FileGetContentsHttpClient</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HttpClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($url)</span></span></span><span class="hljs-function"> </span></span>{ $response = @file_get_contents($url); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($response === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpRequestFailed(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $response; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HttpClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string Response body * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> HttpRequestFailed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($url)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HttpRequestFailed</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RuntimeException</span></span></span><span class="hljs-class"> </span></span>{ }</code> </pre><br>  It remains to slightly change RealCatApi so that it can catch exceptions instead of reacting to false: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RealCatApi</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CatAPi</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRandomImage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $responseXml = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;httpClient-&gt;get(<span class="hljs-string"><span class="hljs-string">'http://thecatapi.com/api/images/get?format=xml&amp;type=jpg'</span></span>); ... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (HttpRequestFailed $exception) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'http://cdn.my-cool-website.com/default.jpg'</span></span>; } ... } }</code> </pre><br>  You noticed that before we only had a unit test of the correct address?  We tested only the successful file_get_contents () result with a valid XML response.  It was not possible to test a dropped HTTP request, since it is not clear how you can forcefully block the HTTP request, except by pulling the network cable? <br><br>  Now we have full control over the HttpClient and we can simulate a request drop - for this you just need to throw the HttpRequestFailed exception: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RealCatApiTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PHPUnit_Framework_TestCase</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@test</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">it_returns_a_default_url_when_the_http_request_fails</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $httpClient = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getMock(<span class="hljs-string"><span class="hljs-string">'HttpClient'</span></span>); $httpClient -&gt;expect(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;once()) -&gt;method(<span class="hljs-string"><span class="hljs-string">'get'</span></span>) -&gt;with(<span class="hljs-string"><span class="hljs-string">'http://thecatapi.com/api/images/get?format=xml&amp;type=jpg'</span></span>) -&gt;will(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;throwException(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpRequestFailed()); $catApi = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RealCatApi($httpClient); $url = $catApi-&gt;getRandomImage(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;assertSame( <span class="hljs-string"><span class="hljs-string">'http://cdn.my-cool-website.com/default.jpg'</span></span>, $url ); } }</code> </pre><br><h4>  Getting rid of the file system </h4><br>  We can repeat the same steps for the CachedCatApi file system dependency: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cache</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isNotFresh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($lifetime)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($url)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FileCache</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cache</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $cacheFilePath; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheFilePath = <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/../../cache/random'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isNotFresh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($lifetime)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !file_exists(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheFilePath) || time() - filemtime(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheFilePath) &gt; $lifetime } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($url)</span></span></span><span class="hljs-function"> </span></span>{ file_put_contents(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheFilePath, $url); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> file_get_contents(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cacheFilePath); } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CachedCatApi</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CatApi</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $cache; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CatApi $realCatApi, Cache $cache)</span></span></span><span class="hljs-function"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache = $cache; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRandomImage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache-&gt;isNotFresh()) { ... <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache-&gt;put($url); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $url; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache-&gt;get(); } }</code> </pre><br>  Finally, finally, we can get rid of these terrible sleep () calls in CachedCatApiTest!  And all this is due to the fact that we have a simple wrapper for Cache.  I will leave this part as an independent exercise for the reader. <br><br>  There were several problems: <br><br><ol><li>  I do not like the Cache interface API.  The isNotFresh () method is hard to understand.  It also does not correspond to already existing abstractions (for example, that from Doctrine), which makes it incomprehensible for people familiar with caching in PHP. </li><li>  The cache path is still hardcoded in the FileCache class.  This is bad for testing - there is no way to change it. </li></ol><br>  The first can be solved by renaming some methods and inverting some boolean logic.  The second is solved by passing the required path as a constructor argument. <br><br><h4>  Conclusion </h4><br>  In this part, we have hidden out of sight a lot of low-level details related to the file system and HTTP requests.  This allows you to write really the right unit tests. <br><br>  Of course, the code in FileCache and FileGetContentsHttpClient still needs to be tested, the article ends, and the tests are still slow and fragile.  But you can do this: refuse to test them in favor of using existing solutions for <a href="https://github.com/thephpleague/flysystem">working with files</a> or <a href="https://github.com/guzzle/guzzle">performing HTTP requests</a> .  The burden of testing such libraries lies entirely on their developers, but it allows you to focus on the important parts of your code and make your tests faster. <br><br>  <b>UPD</b> : <a href="http://habrahabr.ru/post/263333/">Pussies: Refactoring.</a>  <a href="http://habrahabr.ru/post/263333/">Part three or brushing roughness</a> </div><p>Source: <a href="https://habr.com/ru/post/263139/">https://habr.com/ru/post/263139/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263117/index.html">10 years "on the knee" and forced evolution - note for young</a></li>
<li><a href="../263121/index.html">We continue to get acquainted with Intel Xeon Phi: "native" code</a></li>
<li><a href="../263125/index.html">International Mathematical Olympiad for Schoolchildren 2015. Am I? If I want to? Will I decide?</a></li>
<li><a href="../263129/index.html">Microsoft has released an unscheduled security update for Windows MS15-078</a></li>
<li><a href="../263131/index.html">Clojure web application. Part 2</a></li>
<li><a href="../263143/index.html">Geek online vacations of a modern child</a></li>
<li><a href="../263147/index.html">Hacked site AshleyMadison.com</a></li>
<li><a href="../263149/index.html">We get acquainted with Vorlon.js - debugging of web applications</a></li>
<li><a href="../263151/index.html">Google vs. Microsoft: Whose Clouds Are Better?</a></li>
<li><a href="../263153/index.html">Together with Visual Studio 2015 release TypeScript 1.5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>