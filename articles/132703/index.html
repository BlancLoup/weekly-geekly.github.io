<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JDK Secrets</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About Unsafe in Java did not hear just lazy, but this is not the only magic class in the Sun / Oracle JDK, erasing the boundaries of the Java platform...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JDK Secrets</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/5d063b9c/9423d47d/69c873a1/f0609a1d.png"><br>  About Unsafe in Java did not hear just lazy, but this is not the only magic class in the Sun / Oracle JDK, erasing the boundaries of the Java platform and opening paths that are not mapped to the public API card.  I will talk about some of them that have benefited in real projects.  But remember: undocumented features deprive your application of portability to other Java platforms and, in addition, are a potential source of non-trivial errors.  I even wrote the word "application" for nothing.  It is better to say that the classes described below are not suitable for applications!  Rather, they are of interest only for system software and for curious programmers, i.e.  for you :) <br><a name="habracut"></a><br><br><h3>  Cleaner </h3><br>  Every good Java programmer knows that <a href="http://www.informit.com/articles/article.aspx%3Fp%3D1216151%26seqNum%3D7">finalizers are evil</a> .  But how can we replace them if there is no guarantee that everyone using our library, like decent programmers, will call close ()?  In the end, what is used inside the JDK itself? <br>  In system classes, sun.misc.Cleaner, based on PhantomReference, is used as a more reliable and lightweight replacement for finalizers.  As soon as the garbage collector detects that the object referenced by Cleaner has become <a href="http://download.oracle.com/javase/6/docs/api/java/lang/ref/package-summary.html">phantom-reachable</a> , the specified Runnable will be started, as a rule, to release resources: <br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NeedsCleanup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.resource = unsafe.allocateMemory(<span class="hljs-number"><span class="hljs-number">16</span></span>*<span class="hljs-number"><span class="hljs-number">1024</span></span>*<span class="hljs-number"><span class="hljs-number">1024</span></span>); Cleaner.create(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Destructor(resource)); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Destructor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Runnable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> resource; Destructor(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> resource) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.resource = resource; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ unsafe.freeMemory(resource); } }</code> </pre> <br><br>  Despite its useful sides, this class is not destined to become part of a public API, since, if misused, it can block the Reference Handler stream, or even stop the application. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Unmapping MappedByteBuffer </h3><br>  And here is just an example of Cleaner in the JDK system classes. <br>  Whoever used the Java memory-mapped files with FileChannel.map () probably more than once regretted that MappedByteBuffer does not have a unmap () method.  There are <a href="http://bugs.sun.com/view_bug.do%3Fbug_id%3D4724038">reasons for this</a> . <br>  But, as in the saying, if you can not, but really want - you can.  The implementation of MappedByteBuffer creates a Cleaner to perform unmap after garbage collection when the buffer becomes unreachable.  So, this Cleaner can also be called manually: <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unmap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MappedByteBuffer bb)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bb <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> sun.nio.ch.DirectBuffer) { ((sun.nio.ch.DirectBuffer) bb).cleaner().clean(); } }</code> </pre><br><br><h3>  SharedSecrets </h3><br>  An intriguing name, isn't it?  sun.misc.SharedSecrets is a utility class that provides interfaces for accessing certain private data of system classes.  Although there are not so many interesting things.  You can, say, get to the constant pool of any loaded class ... just do not ask why :) <br>  From what I‚Äôve been able to use, I‚Äôm getting a native (OS-level) file descriptor from a Java FileDescriptor object.  This is done like this: <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNativeFD</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FileDescriptor fd)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SharedSecrets.getJavaIOFileDescriptorAccess().get(fd); }</code> </pre><br>  Or, for example, how to find out the encoding of the console from which the Java application is running: <br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (System.console() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { System.out.println(SharedSecrets.getJavaIOAccess().charset()); }</code> </pre><br><br><h3>  Signalhandler </h3><br>  Did you know that in a Java program you can catch and process POSIX signals, for example, SIGINT? <br>  Yes, using the sun.misc.Signal and sun.misc.SignalHandler classes. <br>  However, I will not dwell on this, since there <a href="http://habrahabr.ru/blogs/java/78035/">has already been</a> an article on this subject. <br><br><h3>  Magicaccessor </h3><br>  And the most magical class, as the name implies, is today sun.reflect.MagicAccessorImpl.  Being inherited from it, your class will miraculously get the opportunity to access all private fields and methods of any classes!  The trick is that the bytecode verifier simply omits access checks for the classes that succeed MagicAccessorImpl. <br>  It was very useful to me to implement my own fast serialization mechanism.  After all, the serializer should be able to read and write any class fields, including private ones.  Traditionally this is achieved by means of Reflection, which is rather slow, or with the help of Unsafe.  But there is no way faster than accessing the fields directly via getfield / putfield bytecodes, which are literally compiled into one machine instruction. <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// ----- A.java ----- class A { private int privateField = 5; } // ----- B.java ----- class B extends sun.reflect.MagicAccessorBridge { public static void main(String[] args) { A a = new A(); a.privateField = 10; System.out.println(a.privateField); } } // ----- MagicAccessorBridge.java ----- package sun.reflect; public class MagicAccessorBridge extends MagicAccessorImpl { // Since MagicAccessorImpl is package-private, we'll make a public bridge }</span></span></code> </pre><br>  Only one problem: only the JVM knows about the magic accessor, but not javac, which will persistently continue to swear for unauthorized access.  To test an example, you first have to change the field modifier to public in class A, compile everything, then return the private modifier back and recompile class A separately.  Of course, inconvenient, therefore, in practice, inheriting from MagicAccessorImpl makes sense only when dynamically generating a class.  By the way, the JDK treasury contains tools for this case: sun.tools.asm.Assembler and the whole package sun.tools.asm. <br><br><h3>  Warning: Sun proprietary API </h3><br>  As soon as you try to dilute your program with one of the above classes or with any other from the sun package. *, You will certainly receive a warning from the compiler <br><blockquote>  warning: sun.misc.Unsafe is Sun proprietary API <br></blockquote><br>  which cannot be suppressed by any annotations, and rightly so! <br><br>  You can rejoice or grieve, but in JDK 7, finally, the opportunity to hide the annoying warning.  However, again, only with the help of a secret key :) <br><br>  Add annotation to method or class <br> <code>@SuppressWarnings("sunapi") <br></code> <br>  and run javac with parameter <br> <code>javac -XDenableSunApiLintControl TestUnsafe.java <br></code> <br>  That's all, the way to experiment is free! </div><p>Source: <a href="https://habr.com/ru/post/132703/">https://habr.com/ru/post/132703/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132697/index.html">Internet Foundation "For the sake of Dobra.ru". Innovative charity</a></li>
<li><a href="../132698/index.html">OOP in javascript</a></li>
<li><a href="../132699/index.html">The final design of the Raspberry Pi circuit</a></li>
<li><a href="../132700/index.html">IPod nano replacement program (1st generation)</a></li>
<li><a href="../132702/index.html">Analog computer on operational amplifiers</a></li>
<li><a href="../132707/index.html">Implementing and receiving payment in linkCharge</a></li>
<li><a href="../132708/index.html">XP Days in Ukraine</a></li>
<li><a href="../132709/index.html">Development add-on for MODx Revolution. Part 3</a></li>
<li><a href="../132710/index.html">Government communication based on Asterisk!</a></li>
<li><a href="../132712/index.html">Conference DrupalConf - December 3 in Moscow!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>