<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We are switching from STM32 to the Russian K1986BE92QI microcontroller. Practical application: Generate and reproduce sound. Part one: we generate a square and sinusoidal signal. Mastering the DAC (DAC)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 In the previous article we talked about setting the clock frequency of the microcontroller. Now I would like to consider options for wo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We are switching from STM32 to the Russian K1986BE92QI microcontroller. Practical application: Generate and reproduce sound. Part one: we generate a square and sinusoidal signal. Mastering the DAC (DAC)</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  <a href="http://habrahabr.ru/post/255479/">In the previous article</a> we talked about setting the clock frequency of the microcontroller.  Now I would like to consider options for working with sound: its generation and reproduction.  At first I wanted to write one big article in which everything would be considered.  From the generation of rectangular pulses to FLAC playback from a microSD card.  But the article turned out just gigantic.  So I decided to break it up into several smaller articles.  In each of which I parse one peripheral module. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">For those who do not like the implementation of tasks in the article.</b> <div class="spoiler_text">  Immediately make a reservation.  I will solve the tasks set in the article only with the help of the knowledge that has already been described.  I understand that using DMA, somewhere, timers, and so on will be more true.  But all this will be discussed further. <br></div></div><br><br><h4>  Understanding the simple sound generation method. </h4><br>  Before writing this article, I had only a vague idea of ‚Äã‚Äãhow sound is generated, but after reading <a href="http://avr-start.ru/%3Fp%3D476">this article,</a> everything fell into place.  From the above article we can single out the most important thing - the principle. <br><blockquote>  To create a sound, we need to make the speaker membrane oscillate with a certain frequency.  Each note corresponds to its own frequency, for example, a note To 1 octave, corresponds to a frequency of 261 Hz.  Those.  jerking the foot of the microcontroller connected to the speaker, at a speed of 261 times per second, we will hear the sound of this note.  For those who are not strong in musical theory, the sound closer from 1kHz and higher will be more squeaky, below 300Hz will bass. </blockquote><br>  Our board has a Jack 3.5 connector and an amplifier for it.  Consider the concept. <br><br><img src="https://habrastorage.org/files/83d/cd0/d49/83dcd0d49b944acbb8adc45f6e158d3c.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As we can see, the amplifier is connected to the controller via pin PE0.  After switching the jumper ‚ÄúDAC_OUT_SEL‚Äù on the board, we can generate a sound that we can hear by connecting, for example, headphones to Jack. <br><br><h4>  The implementation of a simple tweeter </h4><br>  Armed with theory, you can try to write a program that will squeak with the frequency of the note to the first octave. <br>  Set up our pin.  Immediately agree that the code is written with the amendment to the fact that the port has nothing but our amplifier.  In the future, make a universal function is not difficult. <br><br><pre><code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">//--------------------------------------------------------- // ,   . //--------------------------------------------------------- #define PER_CLOCK_PORTE (1&lt;&lt;25) //    E. #define PORT_OE_OUT_PORTE_0 (1&lt;&lt;0) //    PORTE_0  "". #define ANALOG_EN_DIGITAL_PORTE_0 (1&lt;&lt;0) //     PORTE_0. #define PWR_MAX_PORTE_0 (3&lt;&lt;0) //    PORTE_0    . #define PORT_RXTX_PORTE_0_OUT_1 (1&lt;&lt;0) //    "1"  . void Buzzer_out_init (void) { RST_CLK-&gt;PER_CLOCK |= PER_CLOCK_PORTE; //   E. PORTE-&gt;OE |= PORT_OE_OUT_PORTE_0; //. PORTE-&gt;ANALOG |= ANALOG_EN_DIGITAL_PORTE_0; //. PORTE-&gt;PWR |= PWR_MAX_PORTE_0; //  ( 10 ). }</span></span></code> </pre> <br>  Now we need to decide how often we will squeak.  This helped me <a href="http://gtwiki.2102.su/index.php%3Ftitle%3D%25D0%259D%25D0%25BE%25D1%2582%25D1%258B_%25D0%25B8_%25D1%2587%25D0%25B0%25D1%2581%25D1%2582%25D0%25BE%25D1%2582%25D0%25B0">this table of frequencies</a> .  For clarity, is presented below. <br><br><img src="https://habrastorage.org/files/5b2/d56/97a/5b2d5697a1c34096bbb558debb14b699.png"><br><br>  The note to (C) of the first octave has a frequency of 261.63 Hertz.  This means that 261.63 periods pass in one second.  In each of which we change the state of a bit 2 times.  And of that, we need to change the state of the bit 523.26 times per second.  Dividing 1 second to 523.26 we get 0.0019110958223445, which is approximately 191 * 10 ^ (- 5) seconds.  This is a "pause" between the switchings. <br><br>  Now that we know the approximate value of the delay, we can configure the SysTick timer and the delay to it.  We need to configure it to interrupt once every 10 ^ (- 5) seconds.  To do this, slightly change our function from <a href="http://habrahabr.ru/post/255415/">this article</a> .  We get the following. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Init_SysTick (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) <span class="hljs-comment"><span class="hljs-comment">//   10^(-5) . { SysTick-&gt;LOAD = (8000000/100000)-1; SysTick-&gt;CTRL |= CLKSOURCE|TCKINT|ENABLE; } volatile uint32_t Delay_dec = 0; //  SysTick . void SysTick_Handler (void) { if (Delay_dec) Delay_dec--; } void Delay (uint32_t Delay_Data) //    SysTick . { Delay_dec = Delay_Data; while (Delay_dec) {}; }</span></span></code> </pre><br>  Well, now, finally, we will use all of the above. <br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> main (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { Buzzer_out_init(); <span class="hljs-comment"><span class="hljs-comment">//   . Init_SysTick(); //       10^(-5) . while (1) //    261.63 . { PORTE-&gt;RXTX |= PORT_RXTX_PORTE_0_OUT_1; // "1"  ,   . Delay(191); PORTE-&gt;RXTX = 0; Delay(191); } }</span></span></code> </pre><br>  All is good, but here the first rake.  As you can see, in the main function there is not a single line of code for setting the clocking.  The controller is clocked by HSI.  In our example, this led to the fact that instead of a note up to the first octave, a note was played for the small octave (2 full tones lower).  To correct this error, we add the function of switching the clock source from HSI to HSE (external quartz resonator). <br><br>  About the clocking system was discussed <a href="http://habrahabr.ru/post/255479/">in this lesson</a> . <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> main (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { HSE_Clock_ON(); <span class="hljs-comment"><span class="hljs-comment">//  HSE . HSE_Clock_OffPLL(); // ""      HSE . Buzzer_out_init(); //   . Init_SysTick(); //       10^(-5) . while (1) //    261.63 . { PORTE-&gt;RXTX |= PORT_RXTX_PORTE_0_OUT_1; // "1"  ,   . Delay(191); PORTE-&gt;RXTX = 0; Delay(191); } }</span></span></code> </pre><br>  Slightly complicate the task.  We write a program that will play us a range of 12 semitones (7 white keys and 5 black keys, if you look at the piano).  To do this, create an array with the duration of all delays.  We calculate them in the same way as the previous one: 100000 / frequency_notes / 2 = duration_delay.  We divide 100,000 because we have an interruption every 0.00001 seconds (10 ^ (- 5)). <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> uint32_t MES[<span class="hljs-number"><span class="hljs-number">13</span></span>] = {<span class="hljs-number"><span class="hljs-number">191</span></span>, <span class="hljs-number"><span class="hljs-number">180</span></span>, <span class="hljs-number"><span class="hljs-number">170</span></span>, <span class="hljs-number"><span class="hljs-number">161</span></span>, <span class="hljs-number"><span class="hljs-number">152</span></span>, <span class="hljs-number"><span class="hljs-number">143</span></span>, <span class="hljs-number"><span class="hljs-number">135</span></span>, <span class="hljs-number"><span class="hljs-number">128</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">114</span></span>, <span class="hljs-number"><span class="hljs-number">107</span></span>, <span class="hljs-number"><span class="hljs-number">101</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>};</code> </pre> <br>  Now let's change the main function a little. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> main (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { HSE_Clock_ON(); <span class="hljs-comment"><span class="hljs-comment">//  HSE . HSE_Clock_OffPLL(); // ""      HSE . Buzzer_out_init(); //   . Init_SysTick(); //       10^(-5) . while (1) //    261.63 . { for (uint32_t Nambe = 0; Nambe&lt;13; Nambe++) //   . { for (uint32_t LoopN = 0; LoopN&lt;MES[12-Nambe]*3; LoopN++) //     . { PORTE-&gt;RXTX |= PORT_RXTX_PORTE_0_OUT_1; // "1"  ,   . Delay(MES[Nambe]); PORTE-&gt;RXTX = 0; Delay(MES[Nambe]); } } } }</span></span></code> </pre><br>  A small explanation of the code.  Since the length of the sound sample (one period of the sound wave) is different for each note, in order to more or less make the sound of each note the same, the waiting cycle was composed as follows.  The number of the longest note (the note with the largest number of delay) sounded the ‚Äúdelay time‚Äù the shortest.  I will explain.  The note before the first octave (191) was played 96 * 3 times, and the note before the second octave (96) was played 191 times * 3. The three is the duration factor.  Next will be considered a more correct way to measure the delay. <br><br>  This is what our wave looks like. <br><br><img src="https://habrastorage.org/files/f21/bac/5da/f21bac5da2d8434aab6e0ad2e7abd30e.png"><br><br>  If you look closer, you can see its imperfection.  It does not even closely resemble rectangular pulses. <br><br><img src="https://habrastorage.org/files/f58/384/5e8/f583845e8c974fdeb0ef4a1fec30a2f3.png"><br><br>  Download the sound file <a href="">here</a> .  <a href="">File simple tweeters</a> . <br><br><h4>  Mastering the DAC </h4><br>  Considering the pattern of our "wave" and it does not occur to the head that there is a sinusoid.  Studying the issue of creating a sine wave and generally a signal of any shape on a microcontroller, I came across <a href="http://avrdevices.ru/r-2r-cap-praktitcheskoe-primenenie/">this article</a> .  This article came across to me for a long time.  And then I read it just for fun.  Now it is of practical interest.  The article describes the creation and use of a simple DAC (digital-to-analog converter).  A DAC is a device for converting a voltage value into, directly, the analog voltage at the output.  I already wanted to collect the scheme from the article, but once again studying the documentation I saw the item. <br><blockquote>  MDR_DAC controller ................................................ .................................................. ......................... 326 </blockquote><br>  It was a very pleasant surprise for me.  Never before have I seen the DAC directly in the microcontroller itself.  But first you need to understand whether you can connect the DAC to the amplifier.  To do this, open the circuit board and see the following. <br><br><img src="https://habrastorage.org/files/a4c/222/4a2/a4c2224a2d6d4d91aac475e06fd08e97.png"><br><br>  The output of our amplifier is connected directly to the PE0 to which the DAC is connected.  Fine.  You can start customization.  But before that we will study a little DAC. <br><blockquote>  The microcontroller has two DACs.  To enable the DAC, you need to set the Cfg_ON_DACx bit to 1, the used D / A port pins of the E port have been configured as analog and any internal braces have been disabled.  Both DACs can work independently or jointly.  When the DAC operates independently (Cfg_SYNC_A bit = 0), after writing data to the DACx_DATA data register, the voltage level corresponding to the recorded value is generated at the DACx_OUT output.  During synchronous operation (Cfg_SYNC_A = 1 bit), the data of both DACs can be updated with one entry in one of the DACx_DATA registers.  The DAC can operate from the internal support Cfg_M_REFx = 0, then the DAC generates an output signal in the range from 0 to the supply voltage AUCC.  In the mode of operation with external support, Cfg_M_REFx = 1, the DAC generates an output voltage in the range from 0 to the value DACx_REF. </blockquote><br>  Here, we can say, described the entire setting.  Take a look at the registers. <br><br><img src="https://habrastorage.org/files/269/b6a/7cb/269b6a7cb90a414ebbe0ffb2247b8b3f.png"><br><br>  There are only three registers for two DACs here.  Of these, two registers to store the value at the output of each of the DAC.  Consider the register settings. <br><br><img src="https://habrastorage.org/files/3c4/c5d/996/3c4c5d996b1c4298bebb23f86ccbfc17.png"><br><br>  Getting Started.  Just do not forget about the clocking DAC.  Well, for the test, we set the maximum voltage at the output (0xFFF = 4095). <br><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">//--------------------------------------------------------- //. //--------------------------------------------------------- #define PCLK_EN_DAC (1&lt;&lt;18) //   . #define CFG_Cfg_ON_DAC0 (1&lt;&lt;2) //  1. void ADC_Init (void) { RST_CLK-&gt;PER_CLOCK |= PCLK_EN_DAC; //  . DAC-&gt;CFG = CFG_Cfg_ON_DAC0; // 1. .   . }</span></span></code> </pre><br>  Next, do not forget about the exit.  In the previous lesson we set it up as a digital output.  Now, according to the recommendation, you need to configure as analog. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Buzzer_out_DAC_init (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { RST_CLK-&gt;PER_CLOCK |= PER_CLOCK_PORTE; <span class="hljs-comment"><span class="hljs-comment">//   E. PORTE-&gt;OE |= PORT_OE_OUT_PORTE_0; //. PORTE-&gt;ANALOG = 0; //. PORTE-&gt;PWR |= PWR_MAX_PORTE_0; //  ( 10 ). }</span></span></code> </pre><br>  Well, add all this to the main function. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> main (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { HSE_Clock_ON(); <span class="hljs-comment"><span class="hljs-comment">//  HSE . HSE_Clock_OffPLL(); // ""      HSE . Buzzer_out_DAC_init(); //   . ADC_Init(); // . Init_SysTick(); //       10^(-5) . DAC-&gt;DAC1_DATA = 0xFFF; //  (). while (1) { } }</span></span></code> </pre><br>  Now, if we measure the voltage on the pin, we should get about three volts.  BUT.  This is not happening.  On the pin we have about 0.08 volts.  What is not good.  We go to understand.  First of all, I checked if the DAC was tampered. Everything was fine.  The debugger reports that all registers are filled correctly.  Next, I decided to look at the pin table and found the following. <br><br><img src="https://habrastorage.org/files/22b/d5b/a11/22bd5ba112fe4db692ba766f3bec2af0.png"><br><br>  What a news.  PE0 is not connected to DAC1, but to DAC2!  Here is one more mistake ... We are changing the function of the DAC. <br><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">//--------------------------------------------------------- //. //--------------------------------------------------------- #define PCLK_EN(DAC) (1&lt;&lt;18) //   . #define CFG_Cfg_ON_DAC0 (1&lt;&lt;2) //  1. #define CFG_Cfg_ON_DAC1 (1&lt;&lt;3) void ADC_Init (void) { RST_CLK-&gt;PER_CLOCK |= PCLK_EN(DAC); //  . DAC-&gt;CFG = CFG_Cfg_ON_DAC1; // 2. .   . }</span></span></code> </pre><br>  We try to run.  Now everything is fine.  At the output of 3.28 volts.  Now, following the example of a simple tweeter, we try to generate sound with rectangular pulses.  To do this, just change the code of the previous project. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> uint32_t MES[<span class="hljs-number"><span class="hljs-number">13</span></span>] = {<span class="hljs-number"><span class="hljs-number">191</span></span>, <span class="hljs-number"><span class="hljs-number">180</span></span>, <span class="hljs-number"><span class="hljs-number">170</span></span>, <span class="hljs-number"><span class="hljs-number">161</span></span>, <span class="hljs-number"><span class="hljs-number">152</span></span>, <span class="hljs-number"><span class="hljs-number">143</span></span>, <span class="hljs-number"><span class="hljs-number">135</span></span>, <span class="hljs-number"><span class="hljs-number">128</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">114</span></span>, <span class="hljs-number"><span class="hljs-number">107</span></span>, <span class="hljs-number"><span class="hljs-number">101</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> main (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { HSE_Clock_ON(); <span class="hljs-comment"><span class="hljs-comment">//  HSE . HSE_Clock_OffPLL(); // ""      HSE . Buzzer_out_DAC_init(); //   . ADC_Init(); // . Init_SysTick(); //       10^(-5) . while (1) { for (uint32_t Nambe = 0; Nambe&lt;13; Nambe++) //   . { for (uint32_t LoopN = 0; LoopN&lt;MES[12-Nambe]*3; LoopN++) //     . { DAC-&gt;DAC2_DATA = 0xFFF; Delay(MES[Nambe]); DAC-&gt;DAC2_DATA = 0; Delay(MES[Nambe]); } } } }</span></span></code> </pre><br>  Purely on sensations the sound is much more pleasant than in the previous example.  Yes, and it sounds much louder.  <a href="">Here is a sound recording</a> .  <a href="">Here is the file for this project</a> .  But for comparison, our wave. <br><br><img src="https://habrastorage.org/files/885/df6/797/885df6797e3c40a6b275ec5fa6708d7e.png"><br><img src="https://habrastorage.org/files/5e1/39f/003/5e139f003ebb461eabb400cb67c9332d.png"><br><img src="https://habrastorage.org/files/b10/b72/a67/b10b72a67b0a4b6d8c3e85fe966e7dd7.png"><br><br>  Retreat: the amplifier on the board is very hot.  If you leave it in this mode for 10 minutes, it turns into a furnace ... Therefore, I turn off the jumper after listening to the sound.  So it does not heat up. <br><br><h4>  Generation of a sine wave. </h4><br>  Having figured out how to generate a voltage at the output of a different level, I wondered where to get the values ‚Äã‚Äãof this voltage?  Literally immediately after the start of the search, I came across <a href="http://habrahabr.ru/post/126835/">this article</a> .  In it, I found the most important thing.  The code for obtaining the sine wave values.  Slightly remaking the code, I got a program that, by querying the wavelength and sample frequency, generates an array of voltage values ‚Äã‚Äãfor our code.  <a href="">Here is the code on Pascal ABC</a> (All the same, you need to prepare for the exam and sometimes write on pascal.). <br><br><pre> <code class="objectivec hljs">Program Sin_wav; Var Real_Data, PR: <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>; <span class="hljs-comment"><span class="hljs-comment">// . samplerate: word; // . wavefrequency: double;// . Loop: word; //. Name: string; // . Begin write(' : '); readln(samplerate); // . write(' : '); readln(wavefrequency); write(' : '); readln(Name); write('const uint16_t ', Name, '[', samplerate, '] = {'); PR:=samplerate/2; // . for Loop:=0 to samplerate-1 do //-1, ..   0. Begin Real_Data := 2047*sin(Loop*pi/PR) + 2047; // sine-. //..       -  0  . //  2048-1 ( 0  4095) = 0,  2045 = -2. //2047 -    .  +,  -.  0. write(Round(Real_Data)); if (Loop&lt;&gt;samplerate-1) then write(', '); End; write('};') End.</span></span></code> </pre><br>  I will explain a little.  A sinusoid can take both positive and negative values.  Our DAC can generate only positive voltage.  Since the fluctuations, roughly speaking, are due to voltage changes, I decided that 0 would be at half the resolution of the DAC.  In other words, 2047 = 0, 2045 = -2, 2049 = 2. The total amplitude is 4095 (If you keep score from 0).  Here is an example of the execution of a code that generates a sine wave to the first octave (according to the table, the frequency of the wave is 261.63 Hertz).  We will break this sinusoid into 100 plots. <br><br><div class="spoiler">  <b class="spoiler_title">Note to (C) the first octave, 100 plots.</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"> : <span class="hljs-number"><span class="hljs-number">100</span></span>  : <span class="hljs-number"><span class="hljs-number">261.63</span></span>  : C_4 <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> uint16_t C_4[<span class="hljs-number"><span class="hljs-number">100</span></span>] = {<span class="hljs-number"><span class="hljs-number">2047</span></span>, <span class="hljs-number"><span class="hljs-number">2176</span></span>, <span class="hljs-number"><span class="hljs-number">2304</span></span>, <span class="hljs-number"><span class="hljs-number">2431</span></span>, <span class="hljs-number"><span class="hljs-number">2556</span></span>, <span class="hljs-number"><span class="hljs-number">2680</span></span>, <span class="hljs-number"><span class="hljs-number">2801</span></span>, <span class="hljs-number"><span class="hljs-number">2919</span></span>, <span class="hljs-number"><span class="hljs-number">3033</span></span>, <span class="hljs-number"><span class="hljs-number">3144</span></span>, <span class="hljs-number"><span class="hljs-number">3250</span></span>, <span class="hljs-number"><span class="hljs-number">3352</span></span>, <span class="hljs-number"><span class="hljs-number">3448</span></span>, <span class="hljs-number"><span class="hljs-number">3539</span></span>, <span class="hljs-number"><span class="hljs-number">3624</span></span>, <span class="hljs-number"><span class="hljs-number">3703</span></span>, <span class="hljs-number"><span class="hljs-number">3775</span></span>, <span class="hljs-number"><span class="hljs-number">3841</span></span>, <span class="hljs-number"><span class="hljs-number">3899</span></span>, <span class="hljs-number"><span class="hljs-number">3950</span></span>, <span class="hljs-number"><span class="hljs-number">3994</span></span>, <span class="hljs-number"><span class="hljs-number">4030</span></span>, <span class="hljs-number"><span class="hljs-number">4058</span></span>, <span class="hljs-number"><span class="hljs-number">4078</span></span>, <span class="hljs-number"><span class="hljs-number">4090</span></span>, <span class="hljs-number"><span class="hljs-number">4094</span></span>, <span class="hljs-number"><span class="hljs-number">4090</span></span>, <span class="hljs-number"><span class="hljs-number">4078</span></span>, <span class="hljs-number"><span class="hljs-number">4058</span></span>, <span class="hljs-number"><span class="hljs-number">4030</span></span>, <span class="hljs-number"><span class="hljs-number">3994</span></span>, <span class="hljs-number"><span class="hljs-number">3950</span></span>, <span class="hljs-number"><span class="hljs-number">3899</span></span>, <span class="hljs-number"><span class="hljs-number">3841</span></span>, <span class="hljs-number"><span class="hljs-number">3775</span></span>, <span class="hljs-number"><span class="hljs-number">3703</span></span>, <span class="hljs-number"><span class="hljs-number">3624</span></span>, <span class="hljs-number"><span class="hljs-number">3539</span></span>, <span class="hljs-number"><span class="hljs-number">3448</span></span>, <span class="hljs-number"><span class="hljs-number">3352</span></span>, <span class="hljs-number"><span class="hljs-number">3250</span></span>, <span class="hljs-number"><span class="hljs-number">3144</span></span>, <span class="hljs-number"><span class="hljs-number">3033</span></span>, <span class="hljs-number"><span class="hljs-number">2919</span></span>, <span class="hljs-number"><span class="hljs-number">2801</span></span>, <span class="hljs-number"><span class="hljs-number">2680</span></span>, <span class="hljs-number"><span class="hljs-number">2556</span></span>, <span class="hljs-number"><span class="hljs-number">2431</span></span>, <span class="hljs-number"><span class="hljs-number">2304</span></span>, <span class="hljs-number"><span class="hljs-number">2176</span></span>, <span class="hljs-number"><span class="hljs-number">2047</span></span>, <span class="hljs-number"><span class="hljs-number">1918</span></span>, <span class="hljs-number"><span class="hljs-number">1790</span></span>, <span class="hljs-number"><span class="hljs-number">1663</span></span>, <span class="hljs-number"><span class="hljs-number">1538</span></span>, <span class="hljs-number"><span class="hljs-number">1414</span></span>, <span class="hljs-number"><span class="hljs-number">1293</span></span>, <span class="hljs-number"><span class="hljs-number">1175</span></span>, <span class="hljs-number"><span class="hljs-number">1061</span></span>, <span class="hljs-number"><span class="hljs-number">950</span></span>, <span class="hljs-number"><span class="hljs-number">844</span></span>, <span class="hljs-number"><span class="hljs-number">742</span></span>, <span class="hljs-number"><span class="hljs-number">646</span></span>, <span class="hljs-number"><span class="hljs-number">555</span></span>, <span class="hljs-number"><span class="hljs-number">470</span></span>, <span class="hljs-number"><span class="hljs-number">391</span></span>, <span class="hljs-number"><span class="hljs-number">319</span></span>, <span class="hljs-number"><span class="hljs-number">253</span></span>, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">144</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">36</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">36</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">144</span></span>, <span class="hljs-number"><span class="hljs-number">195</span></span>, <span class="hljs-number"><span class="hljs-number">253</span></span>, <span class="hljs-number"><span class="hljs-number">319</span></span>, <span class="hljs-number"><span class="hljs-number">391</span></span>, <span class="hljs-number"><span class="hljs-number">470</span></span>, <span class="hljs-number"><span class="hljs-number">555</span></span>, <span class="hljs-number"><span class="hljs-number">646</span></span>, <span class="hljs-number"><span class="hljs-number">742</span></span>, <span class="hljs-number"><span class="hljs-number">844</span></span>, <span class="hljs-number"><span class="hljs-number">950</span></span>, <span class="hljs-number"><span class="hljs-number">1061</span></span>, <span class="hljs-number"><span class="hljs-number">1175</span></span>, <span class="hljs-number"><span class="hljs-number">1293</span></span>, <span class="hljs-number"><span class="hljs-number">1414</span></span>, <span class="hljs-number"><span class="hljs-number">1538</span></span>, <span class="hljs-number"><span class="hljs-number">1663</span></span>, <span class="hljs-number"><span class="hljs-number">1790</span></span>, <span class="hljs-number"><span class="hljs-number">1918</span></span>};</code> </pre><br></div></div><br><br><h4>  Experiments with a sine wave. </h4><br>  Having received a sinusoid broken into 100 parts, we recall that this sinusoid should be played at a frequency of 261.63 hertz.  Now calculate the interrupt interval.  Second / (100 parts * 261, 63) = 0.00003822191 seconds.  Well.  I will say right away.  I spent a lot of experimentation to get sound.  Briefly tell about them.  Since the frequency of 8 MHz was obviously not enough for such a speed, I decided to pamper myself and overclocked the chip to 80 MHz, hoping that this was enough for me.  But it was not there.  By setting the SysTick interrupts to 10,000,000 times per second, the controller did not even reach the cycle in which the data was output.  After I decided that it would be much easier to issue data immediately in the interrupt.  It turned out the following. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Init_SysTick (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) <span class="hljs-comment"><span class="hljs-comment">// 10000000   . { SysTick-&gt;LOAD = (80000000/10000000)-1; SysTick-&gt;CTRL |= CLKSOURCE|TCKINT|ENABLE; } const uint16_t C_4[100] = {2047, 2176, 2304, 2431, 2556, 2680, 2801, 2919, 3033, 3144, 3250, 3352, 3448, 3539, 3624, 3703, 3775, 3841, 3899, 3950, 3994, 4030, 4058, 4078, 4090, 4094, 4090, 4078, 4058, 4030, 3994, 3950, 3899, 3841, 3775, 3703, 3624, 3539, 3448, 3352, 3250, 3144, 3033, 2919, 2801, 2680, 2556, 2431, 2304, 2176, 2047, 1918, 1790, 1663, 1538, 1414, 1293, 1175, 1061, 950, 844, 742, 646, 555, 470, 391, 319, 253, 195, 144, 100, 64, 36, 16, 4, 0, 4, 16, 36, 64, 100, 144, 195, 253, 319, 391, 470, 555, 646, 742, 844, 950, 1061, 1175, 1293, 1414, 1538, 1663, 1790, 1918}; volatile uint16_t Loop = 0; volatile uint32_t Delay_dec = 0; //  SysTick . void SysTick_Handler (void) { Delay_dec++; if (Delay_dec==(382-1)) { DAC-&gt;DAC2_DATA = C_4[Loop]; if (Loop&lt;99) Loop++; else Loop = 0; Delay_dec=0; } }</span></span></code> </pre><br>  The main function was: <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> main (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { HSE_Clock_ON(); <span class="hljs-comment"><span class="hljs-comment">//  HSE . HSE_Clock_OffPLL(); // ""      HSE . Buzzer_out_DAC_init(); //   . ADC_Init(); // . HSE_PLL(10); //8  -&gt; 80 . Init_SysTick(); //    . while (1) { } }</span></span></code> </pre><br>  The sound was: <br><br><img src="//habrastorage.org/files/e5e/934/4ff/e5e9344ffddc48e687f7b39ab5ae5b16.png"><br><br>  A closer look shows the following: <br><br><img src="//habrastorage.org/files/bee/38f/eba/bee38febaa494746a8fcc66aebc351b0.png"><br><br>  Here is an approximate increase in "sinusoid": <br><br><img src="//habrastorage.org/files/d20/3ff/999/d203ff999b724710a5403bdec29a4b94.png"><br><br>  Visible huge error.  And also the sound was very low.  Maybe la small octave.  Not higher.  Which indicates that the code in the interrupt simply does not have time to run.  Even with a frequency of 80 MHz.  We proceed otherwise.  Reduce the quality a bit.  We make the interruption a little less.  And round off the wait cycle in the interrupt.  We get the following. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Init_SysTick (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) <span class="hljs-comment"><span class="hljs-comment">// 10000000   . { SysTick-&gt;LOAD = (80000000/1000000)-1; SysTick-&gt;CTRL |= CLKSOURCE|TCKINT|ENABLE; } const uint16_t C_4[100] = {2047, 2176, 2304, 2431, 2556, 2680, 2801, 2919, 3033, 3144, 3250, 3352, 3448, 3539, 3624, 3703, 3775, 3841, 3899, 3950, 3994, 4030, 4058, 4078, 4090, 4094, 4090, 4078, 4058, 4030, 3994, 3950, 3899, 3841, 3775, 3703, 3624, 3539, 3448, 3352, 3250, 3144, 3033, 2919, 2801, 2680, 2556, 2431, 2304, 2176, 2047, 1918, 1790, 1663, 1538, 1414, 1293, 1175, 1061, 950, 844, 742, 646, 555, 470, 391, 319, 253, 195, 144, 100, 64, 36, 16, 4, 0, 4, 16, 36, 64, 100, 144, 195, 253, 319, 391, 470, 555, 646, 742, 844, 950, 1061, 1175, 1293, 1414, 1538, 1663, 1790, 1918}; volatile uint16_t Loop = 0; volatile uint32_t Delay_dec = 0; //  SysTick . void SysTick_Handler (void) { Delay_dec++; if (Delay_dec==(38-1)) { DAC-&gt;DAC2_DATA = C_4[Loop]; if (Loop&lt;99) Loop++; else Loop = 0; Delay_dec=0; } }</span></span></code> </pre><br>  Now the interrupt has time to handle.  We get a sound almost identical to the note of Do.  But still at the hearing (when compared with the piano) you can hear the inaccuracy.  You can listen <a href="">here</a> .  Project file <a href="">here</a> . <br>  Our sound wave has the following form: <br><br><img src="//habrastorage.org/files/f73/f08/38d/f73f0838da9c4132a569073a83bbffc5.png"><br><br>  Raising the "sinusoid" has the following form: <br><br><img src="//habrastorage.org/files/a1b/afb/ce9/a1bafbce9a374e56a3dccfa0f4cd9f68.png"><br><br>  As we see, there is no sense in our 100 parts.  DAC just does not have time to change the voltage.  (It seemed to me at the time of the study.) Let's change our project so that the sinusoid consists of 20 parts.  We get the following array. <br><br><pre> <code class="objectivec hljs"> : <span class="hljs-number"><span class="hljs-number">20</span></span>  : <span class="hljs-number"><span class="hljs-number">261.63</span></span>  : C_4 <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> uint16_t C_4[<span class="hljs-number"><span class="hljs-number">20</span></span>] = {<span class="hljs-number"><span class="hljs-number">2047</span></span>, <span class="hljs-number"><span class="hljs-number">2680</span></span>, <span class="hljs-number"><span class="hljs-number">3250</span></span>, <span class="hljs-number"><span class="hljs-number">3703</span></span>, <span class="hljs-number"><span class="hljs-number">3994</span></span>, <span class="hljs-number"><span class="hljs-number">4094</span></span>, <span class="hljs-number"><span class="hljs-number">3994</span></span>, <span class="hljs-number"><span class="hljs-number">3703</span></span>, <span class="hljs-number"><span class="hljs-number">3250</span></span>, <span class="hljs-number"><span class="hljs-number">2680</span></span>, <span class="hljs-number"><span class="hljs-number">2047</span></span>, <span class="hljs-number"><span class="hljs-number">1414</span></span>, <span class="hljs-number"><span class="hljs-number">844</span></span>, <span class="hljs-number"><span class="hljs-number">391</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">391</span></span>, <span class="hljs-number"><span class="hljs-number">844</span></span>, <span class="hljs-number"><span class="hljs-number">1414</span></span>};</code> </pre><br>  Calculate the interrupt frequency now.  A second / (20 parts * 261.63) = 0.00019110958 seconds ~ 191 * 10 ^ (- 6).  This is better than before.  Configure interrupts and delay.  We get the following. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Init_SysTick (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) <span class="hljs-comment"><span class="hljs-comment">// 1000000   . { SysTick-&gt;LOAD = (80000000/1000000)-1; SysTick-&gt;CTRL |= CLKSOURCE|TCKINT|ENABLE; } const uint16_t C_4[20] = {2047, 2680, 3250, 3703, 3994, 4094, 3994, 3703, 3250, 2680, 2047, 1414, 844, 391, 100, 0, 100, 391, 844, 1414}; volatile uint16_t Loop = 0; volatile uint32_t Delay_dec = 0; //  SysTick . void SysTick_Handler (void) { Delay_dec++; if (Delay_dec==(191-1)) { DAC-&gt;DAC2_DATA = C_4[Loop]; if (Loop&lt;19) Loop++; else Loop = 0; Delay_dec=0; } }</span></span></code> </pre><br>  We got a sound even closer to the note of Do.  Sound can be taken <a href="">here</a> . <br><br>  Take a look at the wave: <br><br><img src="//habrastorage.org/files/c68/d42/07e/c68d4207e2f8406cbadc9b21a4a97df8.png"><br><img src="//habrastorage.org/files/8de/c63/789/8dec63789be84b73972643ec2b1a1c39.PNG"><br><br>  To my surprise, practically rectangular impulses are in front of me again!  Although there should have been a sinusoid.  Somewhere I was wrong ... "What if I reduce the amplitude of the oscillation?" - I thought.  I changed the parameter in Pascal program, which shows the ‚Äúwave height‚Äù from ‚Äú0‚Äù to ‚Äúlimit‚Äù from 2047 to 1500. But this did not lead to anything.  And then I looked at the program menu in more detail and saw. <br><br><img src="//habrastorage.org/files/ede/1be/f70/ede1bef707644ace823719a4fb726309.png"><br><br>  From -1 volt to 1 volt!  In other words, an amplitude of 2 volts!  And I had a 3 + amp!  I was too lazy to look for documentation on the amplifier, therefore, by selecting I learned that the ideal amplitude is 70 * 2.  <a href="">Here is the code for the modified pascal program</a> . <br><br><pre> <code class="objectivec hljs">Program Sin_wav; Var Real_Data, PR: <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>; <span class="hljs-comment"><span class="hljs-comment">// . samplerate: word; // . wavefrequency: double;// . Loop: word; //. Name: string; // . Begin write(' : '); readln(samplerate); // . write(' : '); readln(wavefrequency); write(' : '); readln(Name); write('const uint16_t ', Name, '[', samplerate, '] = {'); PR:=samplerate/2; // . for Loop:=0 to samplerate-1 do //-1, ..   0. Begin Real_Data := 70*sin(Loop*pi/PR) + 2047; // sine-. //..       -  0  . //  2048-1 ( 0  4095) = 0,  2045 = -2. //2047 -    .  +,  -.  0. write(Round(Real_Data)); if (Loop&lt;&gt;samplerate-1) then write(', '); End; write('};') End.</span></span></code> </pre><br>  Here is a good array: <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> uint16_t C_4[<span class="hljs-number"><span class="hljs-number">20</span></span>] = {<span class="hljs-number"><span class="hljs-number">2047</span></span>, <span class="hljs-number"><span class="hljs-number">2069</span></span>, <span class="hljs-number"><span class="hljs-number">2088</span></span>, <span class="hljs-number"><span class="hljs-number">2104</span></span>, <span class="hljs-number"><span class="hljs-number">2114</span></span>, <span class="hljs-number"><span class="hljs-number">2117</span></span>, <span class="hljs-number"><span class="hljs-number">2114</span></span>, <span class="hljs-number"><span class="hljs-number">2104</span></span>, <span class="hljs-number"><span class="hljs-number">2088</span></span>, <span class="hljs-number"><span class="hljs-number">2069</span></span>, <span class="hljs-number"><span class="hljs-number">2047</span></span>, <span class="hljs-number"><span class="hljs-number">2025</span></span>, <span class="hljs-number"><span class="hljs-number">2006</span></span>, <span class="hljs-number"><span class="hljs-number">1990</span></span>, <span class="hljs-number"><span class="hljs-number">1980</span></span>, <span class="hljs-number"><span class="hljs-number">1977</span></span>, <span class="hljs-number"><span class="hljs-number">1980</span></span>, <span class="hljs-number"><span class="hljs-number">1990</span></span>, <span class="hljs-number"><span class="hljs-number">2006</span></span>, <span class="hljs-number"><span class="hljs-number">2025</span></span>};</code> </pre> <br>  <a href="">Audio Recording</a>  Now take a look at our signal.  Finally, something like a sine wave! <br><br><img src="//habrastorage.org/files/f00/f5b/de1/f00f5bde13ee4d0ba3d7b0fd6885aee0.png"><br><br>  Now, when I was able to create a sinusoid of 20 parts, use the code discussed earlier, and try to make a sinusoid of 100 parts.  Here is the resulting array. <br><br><pre> <code class="objectivec hljs"> : <span class="hljs-number"><span class="hljs-number">100</span></span>  : <span class="hljs-number"><span class="hljs-number">261.63</span></span>  : C_4 <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> uint16_t C_4[<span class="hljs-number"><span class="hljs-number">100</span></span>] = {<span class="hljs-number"><span class="hljs-number">2047</span></span>, <span class="hljs-number"><span class="hljs-number">2051</span></span>, <span class="hljs-number"><span class="hljs-number">2056</span></span>, <span class="hljs-number"><span class="hljs-number">2060</span></span>, <span class="hljs-number"><span class="hljs-number">2064</span></span>, <span class="hljs-number"><span class="hljs-number">2069</span></span>, <span class="hljs-number"><span class="hljs-number">2073</span></span>, <span class="hljs-number"><span class="hljs-number">2077</span></span>, <span class="hljs-number"><span class="hljs-number">2081</span></span>, <span class="hljs-number"><span class="hljs-number">2085</span></span>, <span class="hljs-number"><span class="hljs-number">2088</span></span>, <span class="hljs-number"><span class="hljs-number">2092</span></span>, <span class="hljs-number"><span class="hljs-number">2095</span></span>, <span class="hljs-number"><span class="hljs-number">2098</span></span>, <span class="hljs-number"><span class="hljs-number">2101</span></span>, <span class="hljs-number"><span class="hljs-number">2104</span></span>, <span class="hljs-number"><span class="hljs-number">2106</span></span>, <span class="hljs-number"><span class="hljs-number">2108</span></span>, <span class="hljs-number"><span class="hljs-number">2110</span></span>, <span class="hljs-number"><span class="hljs-number">2112</span></span>, <span class="hljs-number"><span class="hljs-number">2114</span></span>, <span class="hljs-number"><span class="hljs-number">2115</span></span>, <span class="hljs-number"><span class="hljs-number">2116</span></span>, <span class="hljs-number"><span class="hljs-number">2116</span></span>, <span class="hljs-number"><span class="hljs-number">2117</span></span>, <span class="hljs-number"><span class="hljs-number">2117</span></span>, <span class="hljs-number"><span class="hljs-number">2117</span></span>, <span class="hljs-number"><span class="hljs-number">2116</span></span>, <span class="hljs-number"><span class="hljs-number">2116</span></span>, <span class="hljs-number"><span class="hljs-number">2115</span></span>, <span class="hljs-number"><span class="hljs-number">2114</span></span>, <span class="hljs-number"><span class="hljs-number">2112</span></span>, <span class="hljs-number"><span class="hljs-number">2110</span></span>, <span class="hljs-number"><span class="hljs-number">2108</span></span>, <span class="hljs-number"><span class="hljs-number">2106</span></span>, <span class="hljs-number"><span class="hljs-number">2104</span></span>, <span class="hljs-number"><span class="hljs-number">2101</span></span>, <span class="hljs-number"><span class="hljs-number">2098</span></span>, <span class="hljs-number"><span class="hljs-number">2095</span></span>, <span class="hljs-number"><span class="hljs-number">2092</span></span>, <span class="hljs-number"><span class="hljs-number">2088</span></span>, <span class="hljs-number"><span class="hljs-number">2085</span></span>, <span class="hljs-number"><span class="hljs-number">2081</span></span>, <span class="hljs-number"><span class="hljs-number">2077</span></span>, <span class="hljs-number"><span class="hljs-number">2073</span></span>, <span class="hljs-number"><span class="hljs-number">2069</span></span>, <span class="hljs-number"><span class="hljs-number">2064</span></span>, <span class="hljs-number"><span class="hljs-number">2060</span></span>, <span class="hljs-number"><span class="hljs-number">2056</span></span>, <span class="hljs-number"><span class="hljs-number">2051</span></span>, <span class="hljs-number"><span class="hljs-number">2047</span></span>, <span class="hljs-number"><span class="hljs-number">2043</span></span>, <span class="hljs-number"><span class="hljs-number">2038</span></span>, <span class="hljs-number"><span class="hljs-number">2034</span></span>, <span class="hljs-number"><span class="hljs-number">2030</span></span>, <span class="hljs-number"><span class="hljs-number">2025</span></span>, <span class="hljs-number"><span class="hljs-number">2021</span></span>, <span class="hljs-number"><span class="hljs-number">2017</span></span>, <span class="hljs-number"><span class="hljs-number">2013</span></span>, <span class="hljs-number"><span class="hljs-number">2009</span></span>, <span class="hljs-number"><span class="hljs-number">2006</span></span>, <span class="hljs-number"><span class="hljs-number">2002</span></span>, <span class="hljs-number"><span class="hljs-number">1999</span></span>, <span class="hljs-number"><span class="hljs-number">1996</span></span>, <span class="hljs-number"><span class="hljs-number">1993</span></span>, <span class="hljs-number"><span class="hljs-number">1990</span></span>, <span class="hljs-number"><span class="hljs-number">1988</span></span>, <span class="hljs-number"><span class="hljs-number">1986</span></span>, <span class="hljs-number"><span class="hljs-number">1984</span></span>, <span class="hljs-number"><span class="hljs-number">1982</span></span>, <span class="hljs-number"><span class="hljs-number">1980</span></span>, <span class="hljs-number"><span class="hljs-number">1979</span></span>, <span class="hljs-number"><span class="hljs-number">1978</span></span>, <span class="hljs-number"><span class="hljs-number">1978</span></span>, <span class="hljs-number"><span class="hljs-number">1977</span></span>, <span class="hljs-number"><span class="hljs-number">1977</span></span>, <span class="hljs-number"><span class="hljs-number">1977</span></span>, <span class="hljs-number"><span class="hljs-number">1978</span></span>, <span class="hljs-number"><span class="hljs-number">1978</span></span>, <span class="hljs-number"><span class="hljs-number">1979</span></span>, <span class="hljs-number"><span class="hljs-number">1980</span></span>, <span class="hljs-number"><span class="hljs-number">1982</span></span>, <span class="hljs-number"><span class="hljs-number">1984</span></span>, <span class="hljs-number"><span class="hljs-number">1986</span></span>, <span class="hljs-number"><span class="hljs-number">1988</span></span>, <span class="hljs-number"><span class="hljs-number">1990</span></span>, <span class="hljs-number"><span class="hljs-number">1993</span></span>, <span class="hljs-number"><span class="hljs-number">1996</span></span>, <span class="hljs-number"><span class="hljs-number">1999</span></span>, <span class="hljs-number"><span class="hljs-number">2002</span></span>, <span class="hljs-number"><span class="hljs-number">2006</span></span>, <span class="hljs-number"><span class="hljs-number">2009</span></span>, <span class="hljs-number"><span class="hljs-number">2013</span></span>, <span class="hljs-number"><span class="hljs-number">2017</span></span>, <span class="hljs-number"><span class="hljs-number">2021</span></span>, <span class="hljs-number"><span class="hljs-number">2025</span></span>, <span class="hljs-number"><span class="hljs-number">2030</span></span>, <span class="hljs-number"><span class="hljs-number">2034</span></span>, <span class="hljs-number"><span class="hljs-number">2038</span></span>, <span class="hljs-number"><span class="hljs-number">2043</span></span>};</code> </pre><br>  Replace the array using the old code and get this: <br><br><img src="//habrastorage.org/files/8a9/2b9/7af/8a92b97af6244015853418f4810f1634.png"><br><br>  We got a very high quality sine wave!  You can listen <a href="">here</a> .  Download the project <a href="">here</a> . <br><br><h4>  Lyrical digression </h4><br>  While recording sound with an amplitude of&gt; 3 Volts, speakers slightly connected to the same laptop sound card showed slightly modified sound from the device.  At first, I thought it was because the background of the program was on.  But as soon as it dawned on me to reduce the amplitude - I realized that it was not.  Since the sound is gone.  I suspect that a little bit more and I would have burned the sound card. <br><br>  For recording and analyzing sound, I used the completely free <b>Audacity</b> program.  It allows you to record sound in arbitrarily high quality without restrictions and allows you to save it in any format (including FLAC, in which I gave examples). <br><br>  I also want to add that I do not have an oscilloscope.  This program has replaced it for me. <br><br><h4>  Instead of a conclusion. </h4><br>  In the next article, the DMA module and its conjugation with the DAC will be disassembled.  <a href="">Files for lessons.</a> <br><br><div class="spoiler">  <b class="spoiler_title">List of previous articles.</b> <div class="spoiler_text">  1. <a href="http://habrahabr.ru/post/255199/">We turn from STM32F103 to K1986BE92QI.</a>  <a href="http://habrahabr.ru/post/255199/">Or the first acquaintance with the Russian microcontroller.</a> <br>  2. <a href="http://habrahabr.ru/post/255323/">We are switching from STM32 to the Russian K1986BE92QI microcontroller.</a>  <a href="http://habrahabr.ru/post/255323/">Setup project in keil and flashing LED.</a> <br>  3. <a href="http://habrahabr.ru/post/255415/">We are switching from STM32 to the Russian K1986BE92QI microcontroller.</a>  <a href="http://habrahabr.ru/post/255415/">System Timer (SysTick).</a> <br>  4. <a href="http://habrahabr.ru/post/255479/">We are switching from STM32 to the Russian K1986BE92QI microcontroller.</a>  <a href="http://habrahabr.ru/post/255479/">Setting the clock frequency.</a> <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/255513/">https://habr.com/ru/post/255513/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255501/index.html">Stories about the developers: Russian Brainy Studio, the winner of the Imagine Cup</a></li>
<li><a href="../255505/index.html">Weekly assembly Vivaldi 1.0.151.7</a></li>
<li><a href="../255507/index.html">Project Maelstrom went public beta</a></li>
<li><a href="../255509/index.html">The French TV channel was hacked after an interview with an employee on the background of stickers with passwords.</a></li>
<li><a href="../255511/index.html">Pure CSS3 Calculator</a></li>
<li><a href="../255519/index.html">Return oriented programming. We collect exploit in pieces</a></li>
<li><a href="../255523/index.html">SQL Language Tutorial (DDL, DML) on the example of MS SQL Server dialect. Part two</a></li>
<li><a href="../255525/index.html">Encryption and decryption - accessing the OpenSSL API using JNI calls</a></li>
<li><a href="../255527/index.html">Ordinary Primes: The Secrets of the Weavers' Secret Society</a></li>
<li><a href="../255529/index.html">Use Java smart cards to protect software. Chapter 1. General Information</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>