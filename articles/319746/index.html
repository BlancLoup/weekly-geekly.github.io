<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Weather station from Arduino and Orienteer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On New Year's Eve comes the desire to develop something non-standard. This time I decided to start collecting and processing weather data near my home...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Weather station from Arduino and Orienteer</h1><div class="post__text post__text-html js-mediator-article">  On New Year's Eve comes the desire to develop something non-standard.  This time I decided to start collecting and processing weather data near my home.  And, of course, I chose Arduino as hardware, but the Orienteer business application designer, mentioned recently in <a href="https://habrahabr.ru/company/orienteer/blog/312844/">Habrahabr</a> , was used as a storage and viewing tool.  So what happened, I will share in this article. <br><br><img src="https://habrastorage.org/files/d30/aba/6aa/d30aba6aafd54e48b64d7eed494fe215.png"><br><a name="habracut"></a><br>  Why this bundle, because you can do without Arduino on a bare Atmel microcontroller and use PHP / MySQL bundle as storage?  It's simple: I didn‚Äôt want to mess around with <a href="http://easyelectronics.ru/sozdanie-pechatnoj-platy-metodom-lazernogo-utyuga.html">LUT</a> , because there was no laser printer at hand, and PHP was pretty tired.  And most importantly - I wanted to try this <a href="http://orienteer.org/">Orienteer</a> in combat conditions, and not poke buttons in the <a href="http://demo.orienteer.org/">demo application</a> . <br><br>  The principle of operation is simple: we poll sensors, form and send a REST request to Orienteer. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Due to the small amount of iron under the Arduino, the following bundle of iron was selected in my arsenal: <br><br><ol><li>  Arduino UNO R3 (more precisely, its Chinese clone with CH340) </li><li>  Temperature and humidity sensor DHT22 </li><li>  Ethernet Shield </li><li>  Connecting wires </li></ol><br><img src="https://habrastorage.org/files/8da/d44/407/8dad444076b14b728ede2c923995bda7.jpg"><br><br><h3>  Hardware </h3><br><img src="https://habrastorage.org/files/296/15c/aff/29615caff7604e26a4969aaa69ad2541.png"><br><br>  As you can see the wiring diagram is very simple, strapping for the sensor is not required.  We take Arduino, we connect Ethernet shild, we connect the sensor.  I used the DHT22 sensor, it measures the temperature and the percentage of humidity, you can use whatever you have at hand. <br><br>  Let's go to the <a href="">sketch code</a> for the Arduino.  At the very beginning, everything is standard: the necessary libraries are connected.  In my case, it took: <a href="https://github.com/adafruit/Adafruit_Sensor">Adafruit Unified Sensor Driver</a> and <a href="https://github.com/adafruit/DHT-sensor-library">Adafruit DHT Humidity &amp; Temperature Unified Sensor Library</a> , as well as libraries to work with Ethernet. <br><br><div class="spoiler">  <b class="spoiler_title">Code with the connection of the necessary libraries</b> <div class="spoiler_text"><pre><code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#include</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">Adafruit_Sensor</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.h</span></span>&gt; <span class="hljs-selector-id"><span class="hljs-selector-id">#include</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">DHT</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.h</span></span>&gt; <span class="hljs-selector-id"><span class="hljs-selector-id">#include</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">DHT_U</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.h</span></span>&gt; <span class="hljs-selector-id"><span class="hljs-selector-id">#include</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">SPI</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.h</span></span>&gt; <span class="hljs-selector-id"><span class="hljs-selector-id">#include</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">Ethernet</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.h</span></span>&gt;</code> </pre> <br></div></div><br>  Further, constants are declared for quick editing, the names speak for themselves, but for beginners in Arduino I will explain: <br><ul><li>  <b>DHTPIN</b> - Arduino connector to which the sensor is connected. </li><li>  <b>DHTTYPE</b> - type of sensor used by the Adafruit library </li><li>  <b>DELAY_MILLIS</b> - data sending interval, the default value is <i>30000UL</i> , which means 30 seconds </li><li>  <b>REST</b> - part of the URL for the REST protocol </li><li>  <b>SERVER_NAME</b> - IP address or host of the server where Orienteer is running </li><li>  <b>SERVER_PORT</b> - server port </li><li>  <b>AUTH_BASE64</b> - encoded in BASE64 encoding string <i>login: password</i> for <a href="https://en.wikipedia.org/wiki/Basic_access_authentication">Basic HTTP</a> authentication (in our case admin: admin) </li><li>  <b>DEVICE_ID</b> is the identifier of the data acquisition device, that is, our Arduino, it is assumed to be collected from several points (for example: house / street) </li></ul><br>  Further, everything is also standard - the initialization of the sensor, Ehternet Shilda.  To send REST data to Orienteer, you need to prepare JSON with information - class and data.  I submitted the code for sending the request to a separate function.  It is worth paying attention to sending a POST request and basic authorization if you are recently learning about Arduino. <br><br><div class="spoiler">  <b class="spoiler_title">Sending HTTP headers</b> <div class="spoiler_text"><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">sprintf</span></span>(outBuf,<span class="hljs-string"><span class="hljs-string">"POST %s HTTP/1.1"</span></span>,page); client.println(outBuf); <span class="hljs-keyword"><span class="hljs-keyword">sprintf</span></span>(outBuf,<span class="hljs-string"><span class="hljs-string">"Authorization: Basic %s"</span></span>, AUTH_BASE64); client.println(outBuf); <span class="hljs-keyword"><span class="hljs-keyword">sprintf</span></span>(outBuf,<span class="hljs-string"><span class="hljs-string">"Host: %s"</span></span>,domainBuffer); client.println(outBuf); client.println(F(<span class="hljs-string"><span class="hljs-string">"Connection: close\r\nContent-Type: application/x-www-form-urlencoded"</span></span>));</code> </pre> <br></div></div><br>  JSON generation for sending data is generated using the <b>sprintf ()</b> function: <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">sprintf</span></span>(params,<span class="hljs-string"><span class="hljs-string">"{'@class':'Weather', 'temperature':%i, 'humidity':%i, 'device':'%s'}"</span></span>, temperature, humidity, DEVICE_ID);</code> </pre> <br>  The interval to send is implemented using the <b>millis ()</b> function.  In case of an error, we swear to the serial interface. <br><br><h2>  Orienteer and its setting </h2><br>  That came to the server side.  Launch and configure the Orienteer platform for receiving data and displaying graphs. <br><br>  You can start the platform from <a href="https://github.com/OrienteerBAP/Orienteer">sources</a> , or you can <a href="https://hub.docker.com/r/orienteer/orienteer/">docker container</a> (for more, see <a href="https://orienteer.gitbooks.io/orienteer/content/installation.html">official documentation</a> ).  Thanks to the authors that they packed the whole thing in a container, a very convenient way to deliver the application.  To deploy, assume that you have <a href="https://www.docker.com/">Docker</a> installed and have minimal skills to work with it, such as starting and stopping a container.  If it is not, then you are <a href="https://docs.docker.com/engine/installation/">here</a> and <a href="https://docs.docker.com/engine/getstarted/step_one">here</a> . <br><br>  To get started, download the latest image of the container with the application, I worked on Ubuntu OS: <br><br><pre> <code class="bash hljs">sudo docker pull orienteer/orienteer</code> </pre> <br>  You will see the following: <br><br><img src="https://habrastorage.org/files/a2c/6df/102/a2c6df102f334b898dea12e632b1030d.png"><br><br>  After a short wait, the image will download and you can run it: <br><br><pre> <code class="bash hljs">sudo docker run -p 8080:8080 orienteer/orienteer</code> </pre> <br>  We go to the address <i>localhost: 8080</i> in the browser, we enter with the login-password pair: <i>admin / admin</i> .  Select the menu <b><i>Schema ‚Üí Classes ‚Üí + Create</i></b> to create a class of data model and specify the class name - <i>Weather</i> .  Do not forget to save the new class: <br><br><img src="https://habrastorage.org/files/0de/1bf/b85/0de1bfb85d4a4d3ba1f181348f60170c.png"><br><br>  Now we will create class properties.  We need to maintain: temperature, percentage of humidity, device name, and device reversal time.  On the property page of the class ( <i>localhost: 8080 / class / Weather</i> ) add the properties: <br><br><img src="https://habrastorage.org/files/fa9/9ea/b51/fa99eab515654708a8170e7f25c403d9.png"><br><br>  For the dateTime property, we will use the <b>sysdate ()</b> function as the default value to get the current time at the moment data <b>arrives</b> from the device.  The error even in a few seconds is not critical in our case. <br><br>  Done, check - come our data?  Everything is fine, there is a contact! <br><br><img src="https://habrastorage.org/files/f31/e91/e9b/f31e91e9b0f44ecea9bc4aec351608ae.png"><br><br>  But, as we see - the data is not very conveniently presented to us.  It does not matter, Orienteer has wonderful widgets Pivot Table, HTML / JS, and you can even create your own page for display, but we‚Äôll focus on widgets.  We need to display the latest incoming data: temperature, percentage of humidity, time of the last update;  average for days. <br><br>  To add a widget, go to <b><i>Schema ‚Üí Weather ‚Üí Browse Class</i></b> and click on the gear icon in the upper right corner.  Click <b><i>Add widget</i></b> and add <b><i>Html Js Pane</i></b> widget.  Save the widget state by pressing <b><i>Save</i></b> .  Next, go to the settings of the widget for <b><i>Actions ‚Üí Settings</i></b> , click the <b><i>Edit</i></b> button. <br><br><img src="https://habrastorage.org/files/d98/97c/b52/d9897cb528594babb3067034ba2269d3.png"><br><br>  Add a resource to display - <i>Weather</i> (this means that this widget will be shown only if we are on the page of viewing objects of this class), we specify the HTML and JS codes of the widget. <br><br><div class="spoiler">  <b class="spoiler_title">HTML</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"last-temp"</span></span></span><span class="hljs-tag">&gt;</span></span>Update...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"last-hum"</span></span></span><span class="hljs-tag">&gt;</span></span>Update...<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"last-datetime"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Javascript</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getWeather</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = <span class="hljs-string"><span class="hljs-string">"/orientdb/query/db/sql/SELECT temperature, humidity, dateTime.format('dd.MM.yyyy HH:mm') AS dt FROM Weather ORDER BY dateTime.asLong() DESC LIMIT 1/1?rnd="</span></span>+<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random(); $.getJSON( url, {}) .done(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> data </span></span></span><span class="hljs-function">) </span></span>{ $(<span class="hljs-string"><span class="hljs-string">'#last-temp'</span></span>).html(data.result[<span class="hljs-number"><span class="hljs-number">0</span></span>].temperature + <span class="hljs-string"><span class="hljs-string">'¬∞'</span></span>); $(<span class="hljs-string"><span class="hljs-string">'#last-hum'</span></span>).html(data.result[<span class="hljs-number"><span class="hljs-number">0</span></span>].humidity+ <span class="hljs-string"><span class="hljs-string">'%'</span></span>); $(<span class="hljs-string"><span class="hljs-string">'#last-datetime'</span></span>).html(data.result[<span class="hljs-number"><span class="hljs-number">0</span></span>].dt); }); } (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ getWeather(); })();</code> </pre><br></div></div><br>  And save - click <b><i>Save</i></b> . <br><br>  Similar actions add Pivot Table widgets to display graphs.  In one, to display the average temperature per day, in the settings, specify the SQL query for the average temperature: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> dateTime, <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(temperature) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> temp <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Weather LET $<span class="hljs-keyword"><span class="hljs-keyword">day</span></span> = dateTime.format(<span class="hljs-string"><span class="hljs-string">'yyyy-MM-dd'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">day</span></span></code> </pre> <br>  In the widget editing mode, we will set the configuration to the graphic: <br><br><img src="https://habrastorage.org/files/f84/d02/e19/f84d02e198924992a6914a1720aeb406.png"><br><br>  And in the second widget to display the average percentage of humidity per day the following SQL: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> dateTime, <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(humidity) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> hum <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Weather LET $<span class="hljs-keyword"><span class="hljs-keyword">day</span></span> = dateTime.format(<span class="hljs-string"><span class="hljs-string">'yyyy-MM-dd'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">day</span></span></code> </pre> <br>  But in the configuration of the graph, we indicate the <i>hum</i> value from the result of the SQL query: <br><br><img src="https://habrastorage.org/files/cbd/09a/5b6/cbd09a5b698b48c8991d1e7963396077.png"><br><br>  And in the end we got a great system for collecting and displaying weather data. <br><br><div class="spoiler">  <b class="spoiler_title">Long screenshot</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/c75/1c0/878/c751c08787c449fcb4459d91f7fcc584.png"><br></div></div><br>  In the plans: <br><br><ul><li>  Add additional sensors: pressure, <a href="https://geektimes.ru/post/258874/">CO2</a> , light level </li><li>  Add a real-time clock (correct implementation when we have a read time, not a data acquisition time) </li><li>  Pre-caching to SD memory card for unloading data slice </li><li>  Displaying weather data and sensor error messages or communication problems <br>  widget setup </li></ul><br>  All updates will be on <a href="https://github.com/ivanscm/orienteer-weather-arduino">github</a> .  In the meantime, I climbed on Aliexpress to order iron to improve my system.  I also want to try Orienteer as a backend application for AngularJS or Android applications, but this is a topic for a separate article. </div><p>Source: <a href="https://habr.com/ru/post/319746/">https://habr.com/ru/post/319746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319734/index.html">Interview with Eddie Willems (G Data Software AG): Smart Security and the ‚ÄúInternet of Troubles‚Äù</a></li>
<li><a href="../319736/index.html">ARC CrossCompilation</a></li>
<li><a href="../319738/index.html">CES 2017 exhibition: payment, e-commerce and fintech trends</a></li>
<li><a href="../319740/index.html">Research trends in the behavior of retail customers</a></li>
<li><a href="../319744/index.html">QR codes - security issues: have we not rushed?</a></li>
<li><a href="../319748/index.html">MySpace syndrome, which is also peculiar to Facebook</a></li>
<li><a href="../319750/index.html">Why payments are at the heart of tourist experience</a></li>
<li><a href="../319752/index.html">Zelle launch - proof that fintech companies can influence large banks</a></li>
<li><a href="../319754/index.html">How to create a virtual machine in Google Spreadsheets</a></li>
<li><a href="../319756/index.html">Reaching for milleniali: trends and mobile marketing techniques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>