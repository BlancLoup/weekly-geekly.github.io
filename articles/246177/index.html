<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Build library packages for rpm-based Linux distributions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many of our projects use open-source libraries. When development is carried out under one specific platform, it makes no sense to collect the same lib...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Build library packages for rpm-based Linux distributions</h1><div class="post__text post__text-html js-mediator-article"> Many of our projects use open-source libraries.  When development is carried out under one specific platform, it makes no sense to collect the same libraries from source codes each time a new developer joins the project.  In addition, installing libraries a la <code>make &amp;&amp; sudo make install</code> is considered bad form because the system is clogged with orphan files that are not listed in the RPM package manager database. <br><br>  As a solution, it is proposed to compile RPM packages from compiled libraries and store them in a single repository accessible to all developers.  Below are instructions and some tips for building packages. <br><a name="habracut"></a><br>  The tutorial will be based on the example of Red Hat Enterprise Linux 6, but with minor changes it can be adapted for other distributions.  For example, we will build a package from the zeromq library. <br><br><h4>  Before building the package </h4><br>  The first thing to do before assembling is to make sure that the package you need is not collected by someone before you.  Often you can find what you need on resources such as <a href="http://www.rpmfind.net/">rpmfind.net</a> and <a href="http://rpm.pbone.net/">rpm.pbone.net</a> .  But if the necessary version of the library was not found or if there is no assembly for your platform, then you will have to build the package yourself. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  rpmbuild </h5><br>  Packages are built using the <b>rpmbuild</b> utility.  Before using it, you must configure the build environment.  Create the necessary directory tree, for example, in the ~ / rpmbuild directory: <br><br><pre> <code class="bash hljs">$ mkdir ~/rpmbuild $ mkdir ~/rpmbuild/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}</code> </pre><br>  Create the rpmbuild utility configuration file so that it finds out where the created directory tree is: <br><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'%_topdir %(echo $HOME)/rpmbuild'</span></span> &gt;~/.rpmmacros</code> </pre><br>  <b>rpmbuild</b> at startup will search for package files in the ~ / rpmbuild / BUILDROOT / &lt;package_name&gt; directory.  Let's look at how RPM packages are named, using the zeromq example: <br><br> <code>zeromq-3.2.4-1.rhel6.x86_64.rpm</code> <br> <br>  Here: <br><ul><li>  <code>zeromq</code> - actually, the name of the packaged software; </li><li>  <code>3.2.4</code> - software version; </li><li>  <code>1.rhel6</code> - package build number (release number) - how many times this software version was assembled into an rpm package.  The rhel6 or el6 suffix usually has packages for Red Hat Enterprise Linux 6; </li><li>  <code>x86_64</code> - processor architecture, under which the software is compiled. </li></ul><br>  Notice the signs separating the package name fields.  They should be exactly as in the example. <br><br>  So, create a directory for zeromq in BUILDROOT: <br><br><pre> <code class="bash hljs">$ mkdir ~/rpmbuild/BUILDROOT/zeromq-3.2.4-1.rhel6.x86_64</code> </pre><br><h5>  Build a library </h5><br>  Of course, before building a binary package, you need to compile the library itself.  If the library uses the GNU Autotools build system, then this is usually done with the commands: <br><br><pre> <code class="bash hljs">$ ./configure $ make</code> </pre><br>  Now install the library in the directory we created in BUILDROOT: <br><br><pre> <code class="bash hljs">$ make install DESTDIR=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOME</span></span></span><span class="hljs-string">/rpmbuild/BUILDROOT/zeromq-3.2.4-1.rhel6.x86_64"</span></span></code> </pre><br>  The DESTDIR parameter is not always processed in makefiles.  For example, qmake generates makefiles that ignore this parameter.  If the library uses an assembly system other than GNU Autotools, then read in the appropriate manual what parameters need to be passed during assembly to install the library in the specified directory. <br><br><h4>  package spec file </h4><br>  In RPM-packages in addition to the archived tree of files is stored meta-information about this package.  When building, it should be specified in a spec file, which is located in the ~ / rpmbuild / SPECS folder.  Consider an example zmq.spec file for the zeromq library: <br><br><pre> <code class="hljs sql">Name: zeromq Version: 3.2.4 <span class="hljs-keyword"><span class="hljs-keyword">Release</span></span>: <span class="hljs-number"><span class="hljs-number">1.</span></span>rhel6 Summary: Software <span class="hljs-keyword"><span class="hljs-keyword">library</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fast</span></span>, message-based applications Packager: My <span class="hljs-keyword"><span class="hljs-keyword">organization</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Group</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">System</span></span> Environment/libraries License: LGPLv3+ <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exceptions</span></span> %description The <span class="hljs-number"><span class="hljs-number">0</span></span>MQ lightweight messaging kernel <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">library</span></span> which extends the standard socket interfaces <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> features traditionally provided <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> specialized messaging middle-ware products. <span class="hljs-number"><span class="hljs-number">0</span></span>MQ sockets provide an abstraction <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">asynchronous</span></span> message queues, multiple messaging patterns, message filtering (subscriptions), seamless <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> multiple transport protocols <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> more. This <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> contains the ZeroMQ <span class="hljs-keyword"><span class="hljs-keyword">shared</span></span> <span class="hljs-keyword"><span class="hljs-keyword">library</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">versions</span></span> <span class="hljs-number"><span class="hljs-number">3.</span></span>x. %post /sbin/ldconfig %postun /sbin/ldconfig %files %defattr(-,root,root) /usr/lib64/libzmq.so<span class="hljs-number"><span class="hljs-number">.3</span></span> /usr/lib64/libzmq.so<span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> %<span class="hljs-keyword"><span class="hljs-keyword">package</span></span> devel Summary: Development files <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> zeromq3 <span class="hljs-keyword"><span class="hljs-keyword">Group</span></span>: Development/Libraries Requires: %{<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>} = %{<span class="hljs-keyword"><span class="hljs-keyword">version</span></span>}-%{<span class="hljs-keyword"><span class="hljs-keyword">release</span></span>} %description devel The zeromq3-devel <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> contains libraries <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> header files <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> developing applications that <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> zeromq3 <span class="hljs-number"><span class="hljs-number">3.</span></span>x. %files devel %defattr(-,root,root) /usr/<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span> /usr/lib64/pkgconfig /usr/lib64/libzmq.so /usr/lib64/libzmq.a /usr/lib64/libzmq.la</code> </pre><br>  At the beginning of the file indicates the minimum set of fields with information about the package.  From the values ‚Äã‚Äãof the first three fields ( <i>Name</i> , <i>Version</i> , <i>Release</i> ) the name of the package is formed, so it is important that the correct values ‚Äã‚Äãare indicated there.  If the values ‚Äã‚Äãdo not match the name of the directory with the file tree of the package being built, rpmbuild will generate an error.  The <i>License</i> field is also required - without it, rpmbuild will refuse to build the package. <br><br>  The purpose of the <b>% description</b> section is obvious.  The <b>% post</b> and <b>% postun sections</b> contain scripts that run after installing the package files into the system and after removing the package files from the system, respectively.  This is useful if the package installs dynamic libraries (.so) in non-standard directories (that is, not in / lib, / usr / lib, / lib64 or / usr / lib64).  In this case, the package must provide a configuration file for ldconfig and install it in /etc/ld.so.conf.d.  The <b>ldconfig</b> command refreshes the dynamic loader cache by adding all the libraries found in the directories specified in the configuration files. <br><br>  The <b>% files</b> section <b>contains a</b> list of files that are packaged in rpm.  The <b>% defattr directive</b> specifies the default file attributes in the format: <br><br>  <b>% defattr</b> (&lt;file mode&gt;, &lt;user&gt;, &lt;group&gt;, &lt;dir mode&gt;) <br><br>  &lt;file mode&gt; is indicated in octal, for example, "644" for rw-r - r--.  The attribute &lt;dir mode&gt; may be omitted.  Instead of attributes that should not change for the files to be installed, you can specify a hyphen.  The directories specified in the <b>% files</b> section will be included in the package along with all their contents. <br><br>  Next is the most interesting.  In fact, there are two types of library RPMs.  Some of them contain the actual dynamic library files themselves, which are necessary for the work of programs that are linked with these libraries.  For example, the zeromq-3.2.4-1.rhel6.x86_64.rpm package provides only two files: /usr/lib64/libzmq.so.3.0.0 and a symbolic link to it, /usr/lib64/libzmq.so.3.  Another type of package contains the files necessary for developing applications using the provided library.  The suffix "-devel" is added to the name of such packages, for example, zeromq-devel-3.2.4-1.el6.x86_64.rpm.  Such packages usually contain C / C ++ header files, documentation, static libraries (.a), and these packages are dependent on packages of the first type. <br><br>  In the spec file above, the <b>% package</b> directive allows you to build a ‚Äúchild‚Äù package with one single run of rpmbuild.  The values ‚Äã‚Äãof the header fields of the child package are inherited from the parent, but they can be overridden.  The <i>Requires</i> field defines an additional dependency on the parent package.  Note that the <b>% files</b> section of the zeromq-devel package contains the file /usr/lib64/libzmq.so.  This is a symbolic link to a real dynamic library file.  It is necessary for the ld linker at the stage of building an application using the library, since it searches for dynamic library files starting with ‚Äúlib‚Äù and ending with ‚Äú.so‚Äù. <br><br><h4>  Assembly </h4><br>  Two things to keep in mind before assembling. <br>  First, if the rpmbuild package is successfully built, it will clear the BUILDROOT directory.  So just in case, back up the packaged files. <br>  Second: never build packages as root.  <a href="https://fedoraproject.org/wiki/How_to_create_an_RPM_package">It</a> explains why you should not do this. <br><br>  Now everything is ready to build the package.  Run rpmbuild: <br><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/rpmbuild/SPECS $ rpmbuild -bb zmq.spec</code> </pre><br>  The -bb parameter means ‚Äúbuild binary‚Äù, that is, build a binary package.  In addition to binary packages, there are also source packages, but they are not discussed here. <br><br>  If successful, the resulting rpm-package will be saved in the RPMS folder. <br><br><h4>  Couple of tips </h4><br>  If you don‚Äôt know what to write in the header fields of the spec file for the library being packaged, you can take an RPM package for another distribution from the above resources and see what they write there: <br><br><pre> <code class="bash hljs">$ rpm -qip package.rpm</code> </pre><br>  Here "q" means "query mode (query)", "i" - getting information about the package, "p" - getting information about the specified package file (without this option you will get information about the package installed in the system, if it is installed) . <br><br>  If you do not know which files belong to the devel package and which ones belong to the library package, but you have both packages for another distribution, you can unpack the tree of files provided by this package into the current directory: <br><br><pre> <code class="bash hljs">$ rpm2cpio package.rpm | cpio -di</code> </pre><br>  The rpm2cpio utility writes a standard cpio archive stored in an rpm package;  The cpio utility unpacks the archive taken from the standard input.  The ‚Äúi‚Äù parameter turns on decompression mode, and ‚Äúd‚Äù creates the necessary directories. <br><br>  You can see which files are provided by the package without unpacking it using the ‚Äúl‚Äù option: <br><br><pre> <code class="bash hljs">$ rpm -qlp package.rpm</code> </pre><br><h4>  Total </h4><br>  Packing the used libraries in RPM, you can save your colleagues from having to download the source code of the required version of the library each time, save them from problems during the build (if, for example, you need to apply a patch to the downloaded library sources) and generally unify the process of adding the library in the project.  The article does not describe all the subtleties of building packages and writing spec files (for example, the separation of configuration files, documentation, etc.), but to build library packages this, by and large, is not necessary. </div><p>Source: <a href="https://habr.com/ru/post/246177/">https://habr.com/ru/post/246177/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../246161/index.html">C # for AS3 developers. Part 1: Class Basics</a></li>
<li><a href="../246169/index.html">Meet the service HockeyApp - your assistant for analyzing the work of mobile applications</a></li>
<li><a href="../246171/index.html">How to organize an online conference in a minute: Integration of the Kato messenger and UberConference</a></li>
<li><a href="../246173/index.html">Playing 5 LXBOX'ov!</a></li>
<li><a href="../246175/index.html">Trojan Stealing Steam Items</a></li>
<li><a href="../246179/index.html">A story about how I found logs with the help of logs</a></li>
<li><a href="../246181/index.html">How to increase conversion and traffic online store only through internal optimization</a></li>
<li><a href="../246187/index.html">New FSTEK certificate for Kerio Control Appliance 8.2</a></li>
<li><a href="../246189/index.html">Protection of Microsoft service accounts</a></li>
<li><a href="../246191/index.html">Home accounting on the platform CUBA. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>