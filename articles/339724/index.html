<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Kubernetes success stories in production. Part 4: SoundCloud (by Prometheus)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The series of articles about large and successful Kubernetes users continues with a story about a popular online service for distributing audio conten...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Kubernetes success stories in production. Part 4: SoundCloud (by Prometheus)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/59/dd/d2/59ddd2854497c188421317.png"><br><br>  The series of articles about large and successful Kubernetes users continues with a story about a popular online service for distributing audio content - <b>SoundCloud</b> .  Last year, Spotify AB was going to buy this company <i>(it has Swedish roots, like SoundCloud)</i> , and more recently, the Chinese Internet giant Tencent.  Even servicing ~ 175 million active users per month, SoundCloud has recently been experiencing financial problems, which became known due to a large reduction (173 employees) last summer, however, according to the latest data, the situation <a href="https://techcrunch.com/2017/08/11/soundcloud-saved/">has improved</a> .  Anyway, we are much more interested in the technological side of the issue, or rather, the <b>use of Kubernetes</b> , and here is what is known about SoundCloud from public sources ... <a name="habracut"></a><br><br><h2>  Begin migration to Kubernetes </h2><br>  At the first annual Kubernetes conference - KubeCon 2015, held in San Francisco in November 2015, Tobias Schmidt, an engineer for SoundCloud, spoke about the company's way to microservice architecture <i>(this happened by 2014)</i> , and later to Kubernetes: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/59/dd/d1/59ddd1062815b191113622.jpeg"><br><br>  In SoundCloud, they started with a <b>monolithic application</b> <i>(‚Äú4-5 years ago‚Äù)</i> on Ruby on Rails (+ MySQL, + RabbitMQ), which was used for rolling out Capistrano, and for describing the infrastructure - Chef.  Among the main problems of that time were: slow scaling, painfulness and instability of the deployment scheme, laborious deployment of new applications.  For these reasons, the company came to the creation of its system - <b>Bazooka</b> , which was dubbed as "PaaS in the style of Heroku".  By managing containers (based on LXC), she provided developers with simple commands to deploy applications and scale them.  At that time, the company had 400-500 services (not all of them were in production), and with Bazooka it was possible to solve the problems of fast rollback and rollback of application releases, their scaling, as well as the independence of the teams (the developers no longer needed to contact operation specialists for new resources). <br><br>  During these experiments, SoundCloud experts have definitely <b>fallen in love with the containers and the Go language</b> .  At the same time, Bazooka created inside has ceased to be suitable for working with significantly expanded microservices that have evolved from simple HTTP request handlers to complex and resource-demanding applications (they have already <a href="https://developers.soundcloud.com/blog/building-products-at-soundcloud-part-1-dealing-with-the-monolith">been written</a> in Scala, Clojure, JRuby).  In addition, supporting and developing Bazooka was becoming increasingly difficult with the company's existing resources, and in the container world, Docker gained considerable popularity (and SoundCloud developers already loved it by starting to use CI / CD).  All this prompted the engineers to decide to move to some third-party system for orchestration. <br><br><h3>  Why Kubernetes? </h3><br>  In SoundCloud, Kubernetes was compared with the native Bazooka and other DevOps products available in the world such as Mesos, and also compared the capabilities of this system with their actual requirements.  The selection in favor of Kubernetes is explained in the report by the following reasons: <br><br><ul><li>  Simple and clear basic objects that are enough for users / developers to work with: containers, trays, services, <a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicationcontroller/">Replication Controller</a> . </li><li>  Powerful network capabilities: flexible configuration of different applications with different traffic and resources at the network level, convenient audit of user connections, secure traffic distribution. </li><li>  Planning at the hearth level, in which you can place different containers connected by a common life cycle. </li><li>  A labeling system for grouping resources, finding them and setting limits on them. </li><li>  A large and vibrant community, as well as the availability of commercial support. </li><li>  In the understanding of SoundCloud engineers, the Kubernetes project in its essence expanded the ideas that were laid in Bazooka. </li></ul><br>  Bottom line: as of late 2015, SoundCloud actively experimented with Kubernetes within the Google Cloud Platform and its bare metal cluster in the data center.  The nearest plans at that time were: completion of the construction of the CI pipeline (while it was ‚Äúmostly set up‚Äù), full integration with Prometheus for monitoring, and resolution of logging problems.  The story of the Prometheus mentioned in these plans deserves special attention ... <br><br><h2>  Prometheus </h2><br>  Hardly anyone from the engineers working with Kubernetes today has heard of <a href="https://prometheus.io/">Prometheus</a> - this is one of the first <a href="https://www.cncf.io/projects/">projects</a> of the CNCF organization (Clound Native Computing Foundation), formally standing behind K8s itself.  To date, this Open Source project is positioned as a ‚Äúmonitoring system for systems and services‚Äù, collecting metrics from specified devices at specified time intervals, applying rules to them, demonstrating the results obtained and calling triggers if certain conditions for the specified values ‚Äã‚Äãare met.  The main components of Prometheus are written in the Go language, and the actual overall architecture looks like this <i>(the diagram is <a href="https://prometheus.io/docs/introduction/overview/">taken from the documentation</a> )</i> : <br><br><img src="https://habrastorage.org/webt/59/e0/a7/59e0a7cfb2ef2978381849.png"><br><br>  Why is this CNCF project paid special attention in the SoundCloud and Kubernetes article?  The fact is that this company was engaged in its initial development, and this happened back in 2012 - <b>long before</b> SoundCloud engineers could even theoretically think about switching to Kubernetes <i>(it wasn‚Äôt there at the time)</i> .  Over time, the popularity of using Prometheus led him to become an independent project, supported by the wide community, and in 2016 he joined the ranks of CNCF, becoming the second (after Kubernetes) project of the organization. <br><br>  What's even more interesting is that the former Google employee Matt Proud is behind Prometheus in SoundCloud.  By 2012, SoundCloud was unhappy with the utilities used for statistics and monitoring (StatsD and Graphite), and began searching for alternatives.  The engineer from Google who joined the company at that time did not find suitable Open Source products that allow storing data such as time series in a multidimensional format and using a simple query language to select from them.  This is how the Prometheus project started, created ‚Äúunder the inspiration that he [Matt Proud] knew about <b>Borgmon</b> - the satellite of the cluster manager and task scheduler Google Borg [who, as everyone knows, became the ancestor of Kubernetes]‚Äù. <br><br>  As a result, Matt Proud, having come to SoundCloud for only 2 years <i>(left the company at the end of 2013, and in 2014 returned to Google)</i> , initiated the creation of Prometheus, which was joined by other SoundCloud engineers, who continued its development after the departure of their ideologue.  Already in 2012, the project was published on <a href="https://github.com/prometheus/prometheus">GitHub</a> , and a year later began to be used in production at SoundCloud itself. <br><br><blockquote>  ‚ÄúPrometheus is an excellent example of what was written before the existence of Kubernetes and what was written for a world in which many applications of various types need to be monitored.  Prometheus is not just monitoring for applications in Kubernetes, it is for Mesos, Docker, OpenStack, and other platforms.  Much more will only appear, and I personally believe that there will be more main platforms.  So this is truly a ubiquitous and powerful tool.  We try to choose good tools that fit the different use cases, and not the only case.  Optionally, these will be containers ‚Äî there may be virtual machines. ‚Äù <br><br>  <i>- Alexis Richardson, Head of CNCF Technical Committee and Head of Weaveworks, in 2016, when Prometheus <a href="https://www.cncf.io/announcement/2016/05/09/cloud-native-computing-foundation-accepts-prometheus-as-second-hosted-project/">received the</a> official status of an incubated project at CNCF.</i> <br></blockquote><br><h2>  Production to SoundCloud </h2><br>  According to <a href="http://knowledgeofficer.com/knowledge/41-transition-to-microservices-while-running-under-full-steam-is-not-easy">an interview</a> given by Bj√∂rn Rabenstein, the leader of Production Engineering at SoundCloud in April 2016, the company had <b>already used</b> Prometheus and Kubernetes in production at that time, calling these products the perfect combination for addressing infrastructure needs. <br><br>  As specified in this interview, when choosing a replacement for Bazooka, the victory of Kubernetes happened ‚Äúslightly ahead‚Äù of other decisions, the reason for which was the relative youth of the project, which was yet to receive / develop many of its capabilities. <br><br>  At the 2016 European DevOps Events ( <a href="https://docs.google.com/presentation/d/12kdCqW0w1uNE81BXV79LTlWyBhuCzbi9yHr1zS8RUi4/edit%3Fusp%3Dsharing">JAX DevOps in London</a> , <a href="https://www.youtube.com/watch%3Fv%3D8bIxBtJQBzQ">CoreOS Fest in Berlin</a> , <a href="https://www.youtube.com/watch%3Fv%3DHnN_HEwo3VY">DevOpsCon 2015 in Berlin</a> ) Bj√∂rn spoke with Fabian Reinartz, one of the main developers of Prometheus and an engineer from CoreOS, who previously worked at SoundCloud, telling about how monitor Kubernetes using Prometheus: <br><br><img src="https://habrastorage.org/webt/59/dd/9f/59dd9f04930ee335426226.jpeg"><br><br>  The experience described in this report has already relied on the production environment at SoundCloud, and was soon supplemented by a <a href="https://www.youtube.com/watch%3Fv%3DXvE-tC36BCI">performance</a> by the same Tobias Schmidt company engineer - on ContainerDays NYC 2016 in November 2016.  <i>(Those who are interested in the example described in the Prometheus configuration report for Kubernetes can find it in a <a href="https://github.com/grobie/prometheus-on-kubernetes">special repository</a> on GitHub.)</i> <br><br>  Unfortunately, there is practically no details about the SoundCloud infrastructure itself.  However, there is a screenshot, which, according to the author, is taken from the real infrastructure.  In particular, it is possible to see an indicator of <b>19 thousand for RPS</b> from incoming requests (HTTP + Thrift): <br><br><img src="https://habrastorage.org/webt/59/dd/be/59ddbeaccacf3266986630.jpeg"><br><br>  From a SoundCloud <a href="https://betalist.com/jobs/62130-production-engineer-at-soundcloud">vacancy</a> to the Production Engineer position, it is known that the infrastructure involves ‚Äútechnologies such as Kubernetes, Kafka, Distributed Storage and Prometheus‚Äù, and from the position <a href="https://betalist.com/jobs/32772-backend-engineer-infrastructure-core-at-soundcloud">Backend Engineer</a> that the company still uses the Scala, Java and Go languages ‚Äã‚Äãfor the backend, as well as Spark and Hadoop technologies.  <i>(By the way, there is a <a href="https://peter.bourgon.org/go-in-production/">separate article</a> about using Go in the SoundCloud production infrastructure, but it‚Äôs probably already partially outdated.)</i> <br><br>  Finally, it is known that in the SoundCloud production infrastructure: <br><br><ul><li>  microservices <a href="https://www.slideshare.net/pcalcado/finaglebased-microservices-at-soundcloud">use</a> <a href="https://github.com/twitter/finagle"><b>Finagle's</b></a> Open Source framework, developed on Twitter as an ‚Äúextensible RPC system for JVM, used to create servers with active parallel processing‚Äù; </li><li>  part of the data <a href="https://developers.soundcloud.com/blog/building-products-at-soundcloud-part-3-microservices-in-scala-and-finagle">is stored</a> in memcached, Redis and MySQL; </li><li>  AWS cloud services (S3 and Glacier) <a href="https://aws.amazon.com/ru/solutions/case-studies/soundcloud/">are used</a> for storing data measured by petabytes, as well as for transcoding (Amazon EC2) and analyzing user behavior (Amazon Redshift); </li><li>  Elasticsearch <a href="https://www.elastic.co/use-cases/soundcloud">serves</a> real-time search queries for multiple users. </li><li>  IPVS (L4) and HAProxy (L7) are <a href="https://conferences.oreilly.com/velocity/vl-ny-2016/public/schedule/detail/50620">used</a> for load balancing, and Consul for service discovery. </li></ul><br>  Let the operating characteristics of Kubernetes and specific figures for the SoundCloud production environment are not publicly advertised (possibly due to the fact that the company's engineers are more busy promoting the Prometheus-grown monitoring equipment), the facts of its application are not only evident, but also make service of one of the early users of Kubernetes in a truly large-scale production. <br><br><h2>  Other articles from the cycle </h2><br><ul><li>  ‚Äú <a href="https://habrahabr.ru/company/flant/blog/334140/">Kubernetes success stories in production.</a>  <a href="https://habrahabr.ru/company/flant/blog/334140/">Part 1: <b>4,200 pods and TessMaster on eBay</b></a> . ‚Äù </li><li>  ‚Äú <a href="https://habrahabr.ru/company/flant/blog/334770/">Kubernetes success stories in production.</a>  <a href="https://habrahabr.ru/company/flant/blog/334770/">Part 2: <b>Concur and SAP</b></a> . ‚Äù </li><li>  ‚Äú <a href="https://habrahabr.ru/company/flant/blog/335814/">Kubernetes success stories in production.</a>  <a href="https://habrahabr.ru/company/flant/blog/335814/">Part 3: <b>GitHub</b></a> . </li><li>  ‚Äú <a href="https://habrahabr.ru/company/flant/blog/342412/">Kubernetes success stories in production.</a>  <a href="https://habrahabr.ru/company/flant/blog/342412/">Part 5: <b>Monzo Digital Bank</b></a> . </li><li>  ‚Äú <a href="https://habrahabr.ru/company/flant/blog/345780/">Kubernetes success stories in production.</a>  <a href="https://habrahabr.ru/company/flant/blog/345780/">Part 6: <b>BlaBlaCar</b></a> . </li><li>  ‚Äú <a href="https://habrahabr.ru/company/flant/blog/347098/">Kubernetes success stories in production.</a>  <a href="https://habrahabr.ru/company/flant/blog/347098/">Part 7: <b>BlackRock</b></a> . </li><li>  ‚Äú <a href="https://habrahabr.ru/company/flant/blog/349940/">Kubernetes success stories in production.</a>  <a href="https://habrahabr.ru/company/flant/blog/349940/">Part 8: <b>Huawei</b></a> . </li><li>  ‚Äú <a href="https://habr.com/company/flant/blog/349940/">Kubernetes success stories in production.</a>  <a href="https://habr.com/company/flant/blog/349940/">Part 9: <b>CERN and 210 K8s clusters.</b></a> ‚Äù </li><li>  ‚Äú <a href="https://habr.com/ru/company/flant/blog/441754/">Kubernetes success stories in production.</a>  <a href="https://habr.com/ru/company/flant/blog/441754/">Part 10: <b>Reddit</b></a> . </li></ul></div><p>Source: <a href="https://habr.com/ru/post/339724/">https://habr.com/ru/post/339724/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339714/index.html">Two pictures with the customer</a></li>
<li><a href="../339716/index.html">Java XML API: we select correctly. StAX: we work with pleasure</a></li>
<li><a href="../339718/index.html">Optimize ES2015 Proxy in V8</a></li>
<li><a href="../339720/index.html">How to interview software engineers</a></li>
<li><a href="../339722/index.html">Battle of applications: am.ru, auto.ru, drom.ru</a></li>
<li><a href="../339730/index.html">Indie's main headache: how to make sales before you go bust</a></li>
<li><a href="../339734/index.html">From where Hamster Marketplace will attract manufacturers of DIY and indie electronics</a></li>
<li><a href="../339736/index.html">Bitcoin hardfork stopped. What's next?</a></li>
<li><a href="../339738/index.html">What we came up with for the next billion users: a project risk analysis</a></li>
<li><a href="../339740/index.html">Circles of friends, ants clashes and Russian roulette: unusual questions at interviews in financial companies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>