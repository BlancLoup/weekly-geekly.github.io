<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FIDO2 - Passwords must die</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think you all have repeatedly heard that "passwords are dead," "passwords are dying out," "new technology will kill passwords," and the like. 

 We ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FIDO2 - Passwords must die</h1><div class="post__text post__text-html js-mediator-article">  I think you all have repeatedly heard that "passwords are dead," "passwords are dying out," "new technology will kill passwords," and the like. <br><br>  We in the FIDO Alliance just came to inform you that the passwords will die out ... in authentication. <br><a name="habracut"></a><br>  Before we start talking about the mass destruction of verbose reptiles, let's go back to our most popular protocol <a href="https://habr.com/post/305508/">FIDO U2F about which I wrote earlier</a> . <br><br><img src="https://habrastorage.org/webt/f9/uh/sn/f9uhsnowrcpajopiggwkc26opvm.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      That is, the authentication script with U2F is: <br><br><h4>  Check in: </h4><br>  - User is registered using login and password <br>  - The server hashes the password using scrypt, argon2, bcrypt and saves to the database <br>  - The user adds his device, storing on the server the public key and the id key pair on the device <br><br><h4>  Authentication: </h4><br>  - User enters login and password <br>  - The server hashes the password and compares it with the hash in the database <br>  - The server generates a random "call" and sends to the client along with the ID <br>  - The client sends the call, id, token binding, and origin of the U2F session to the token <br>  - The authenticator signs all this with a private key and sends it to the client, and that to the server <br>  - Profit <br><br>  Today, multifactor authentication using U2F is the easiest, most phishing-resistant and secure authentication method.  But even this method has its drawbacks. <br><br>  Which ones? <br><br>  Passwords! <br><br><img src="https://habrastorage.org/webt/1d/ti/mz/1dtimzm4z3v77qwap_fqeextpsw.png"><br><br>  Passwords can still be stolen at all stages of authentication: <br><br>  - Can be stolen using keylogger; <br>  - Can be stolen with problems with TLS (see Heartbleed); <br>  - Can be stolen if the server is vulnerable to code injection, or if there are errors in the code (see Twitter) <br>  - Can be stolen if passwords are weakly hashed or have not been hashed at all. <br><br><h3>  While there is a password, it can be stolen </h3><br>  And what if you remove the password at all? <br><br>  Actually, that's what we thought at the FIDO Alliance (we have nothing to do with the hypertext fidonet, although we can potentially be used there) and made FIDO2 <br><br><img src="https://habrastorage.org/webt/wi/kc/cl/wikcclffmchzt0s5ljkstkaxshy.png"><br><br>  For those who have not heard of us, the FIDO Alliance is a consortium that develops open standards for secure authentication.  Above in the picture you can see our board members, who actually develop standards. <br><br>  FIDO2 is our last project, which we have been developing for more than three years.  It consists of two parts: <br><br>  - WebAuthn - JS API for account management on public keys.  This is the W3C standard, so it will be required for all browsers.  Chrome, Firefox and Edge itself have already publicly announced their work on its support. <br>  - CTAP2 - Client-to-Authenticator 2 is a standard that describes the CBOR protocol for communicating with an authenticator via USB, NFC and BLE. <br><br><h3>  User </h3><br>  For the user, it‚Äôs just: <br><br>  - User enters name <br>  - Pass verification <br>  - Profit! <br><br><img src="https://habrastorage.org/webt/td/rx/76/tdrx76f7q0ft7gmmhlkpseurtuo.png"><br><br>  Actually, a demonstration: <br><br><img src="https://habrastorage.org/webt/zc/jg/q0/zcjgq0qaq9n4lkgazl26jutcsve.gif"><br><br><h3>  Protocol </h3><br>  FIDO2 is a member of the FIDO call-response family.  There are six basic security mechanisms in the protocol: <br><br><h4>  1. Call-answer </h4><br><img src="https://habrastorage.org/webt/or/2a/9u/or2a9uxalinc-a1uj5qiba0lofg.png"><br><br>  The first mechanism is call-answer.  The server generates a random call and sends it to the client.  The client transfers this call to the authenticator, who signs the call and returns it to the client, and the latter in turn to the server.  The server, knowing the call, signature and public key, can confirm the signature and thus authenticate the client. <br><br><h4>  2. Phishing protection </h4><br><img src="https://habrastorage.org/webt/ox/ra/hx/oxrahxkxxifwcajvejeqxocfviw.png"><br><br>  The second mechanism is a session-dependent transaction.  When the client receives a call from the server, it adds to the call information about the session: origin (approx: <a href="https://example.com/">example.com</a> ), token binding.  This information is signed by the authenticator and returned to the server.  The server decodes the response and looks at or in the source was himself, and if the user has undergone a phishing attack, the server will be able to see that the source was for example <a href="https://attacker.com/">attacker.com</a> and not <a href="https://example.com/">example.com</a> and thus prevent the attack. <br><br><h4>  3. Protection against replay attacks </h4><br><img src="https://habrastorage.org/webt/xh/jr/go/xhjrgo3lytcaviwb-hpafwbhfsw.png"><br><br>  To protect against replay attacks, there is a counter in the transaction that is incremented by one for every operation.  If the server received a response with a counter whose value is less than or equal to the last saved value, then the server can say for sure that this is a replay attack. <br><br><h4>  4. Privacy </h4><br><img src="https://habrastorage.org/webt/ex/ev/u6/exevu6ix8xuams4kctwog7njb84.png"><br><br>  The fourth protection mechanism is registration-unique key pairs.  At each registration, the authenticator generates a random key pair with a random identifier.  Thus, even if you and your partner use the same authenticator for both accounts, the server will not be able to recognize this. <br><br>  During authentication, the identifier of a key pair is transferred to the authenticator, and the latter, using origin and identifier, will find your key pair in its secured database and return the signature. <br><br><img src="https://habrastorage.org/webt/xw/wi/2g/xwwi2gtlffumkigq0ft0vmetfs0.png"><br><br>  An alternative to transmitting an identifier is to use resident keys (RK).  During authentication, the authenticator will return signatures for all RK key pairs.  The client gives the user a choice of a pair and returns the signature to the server.  In more detail RK I will paint below. <br><br><h4>  5. Certification </h4><br><img src="https://habrastorage.org/webt/e_/_z/la/e__zlacbb13ps4ieww9dedzakzg.png"><br><br>  The fifth mechanism is certification.  Sometimes the site needs to know the type of device from the user.  For example, in the US, all government agencies are required to use only FIPS (Federal Information Processing Standards) certified devices.  There are similar requirements in France, Israel, Russia and other countries.  For all this, there is certification. <br><br>  In the production of authenticators, for every hundred thousand devices the company generates a ‚Äúlot certificate‚Äù and the keys to it and installs them on each device.  When registering, the device signs all information with the private key of the party certificate and returns the certificate instead of the public key.  The certificate contains information about the authenticator and its AAGUID (Authenticator Attestation GUID).  Also, upon receipt of FIDO certification, the company issues a special metadata document, or simply a metadata, and places metadata in our repository accessible to all.  The metadata contains information about the authenticator, including its cryptographic characteristics, biometric characteristics if it supports biometrics, algorithms, security levels, a basic description and a lot of other information.  On the basis of the available information, the server can judge whether it should receive the authenticator or not. <br><br>  Certification is different.  There is a full version of certification in which the server returns a certificate.  There is a self-certification, in which the device does not support certificates, but instead returns the public key of the newly generated pair. <br><br>  The user can also customize the method by which he wants to return certification.  So for example, the user can forbid to return the certification at all and the client will simply delete it, returning the registration response without certification.  I will tell about it later. <br><br><h4>  6. User availability test </h4><br>  One of the fundamental requirements of FIDO is a test for user availability.  In this case, it is meant that the authenticator is obliged to make sure that the user is present ... This can be done in different ways: just pressing a button, a fingerprint, a pin code, and more. <br><br><h3>  WebAuthn </h3><br>  In this section, we will look at the JS API for working with FIDO2. <br><br><h5>  Credential Management API </h5><br>  WebAuthn is an add-on to the Credential Management API for managing public key accounts.  CredMan API is an API (unexpectedly!) For managing user credentials or, to put it simply, it is an API for accessing auto-completion in a browser. <br><br>  Next, we will look at an example of creating credentials: <br><br><pre><code class="javascript">navigator.credentials.store({
    'type': 'password',
    'id': 'alice',
    'password': 'VeryRandomPassword123456'
})
</code></pre><br>
           : <br>
<br>
<pre><code class="javascript">navigator.credentials
    .get({ 'password': true })
    .then(credential =&gt; {
        if (!credential) {
            throw new Error('No credentials returned!')
        }

        let credentials = {
            'username': credential.id,
            'password': credential.password
        }

        return fetch('https://example.com/loginEndpoint', {
            method: 'POST',
            body: JSON.stringify(credentials),
            credentials: 'include'
        })
    })
    .then((response) =&gt; {
        ...
    })
</code></pre><br>
         CredManAPI<br>
<a href="https://pusher.com/sessions/meetup/js-monthly-london/building-a-better-login-with-the-credential-management-api">pusher.com/sessions/meetup/js-monthly-london/building-a-better-login-with-the-credential-management-api</a><br>
<br>
<h5>Create public-key credential</h5><br>
  Public-Key Credential    navigator.credentials.create ,   CreateCredential   ¬´publicKey¬ª.<br>
<br>
<pre><code class="javascript">        var randomChallengeBuffer = new Uint8Array(32);
        window.crypto.getRandomValues(randomChallengeBuffer);

        var base64id = 'MIIBkzCCATigAwIBAjCCAZMwggE4oAMCAQIwggGTMII='
        var idBuffer = Uint8Array.from(window.atob(base64id), c=&gt;c.charCodeAt(0))

        var publicKey = {
            challenge: randomChallengeBuffer,

            rp: { name: "FIDO Example Corporation" },

            user: {
                id: idBuffer,
                name: "alice@example.com",
                displayName: "Alice von Wunderland"
            },
            attestation: 'direct',
            pubKeyCredParams: [
                { type: 'public-key',  alg: -7  }, // ES256
                { type: 'public-key', alg: -257 }  // RS256
            ]
        }

        // Note: The following call will cause the authenticator to display UI.
        navigator.credentials.create({ publicKey })
            .then((newCredentialInfo) =&gt; {
                console.log('SUCCESS', newCredentialInfo)
            })
            .catch((error) =&gt; {
                console.log('FAIL', error)
            })
</code></pre><br>
,     ,      :<br>
 ‚Äî challenge  user.id   <br>
 ‚Äî pubKeyCredParams ‚Äî   ,   .      FIDO2  : RSA-PSS 2048  SHA256/384/512, RSA-PKCS1_3  SHA256/384/512/1, EC  SHA256/384/512,    secp256/384/521p1(NIST)  secp256k1,  EdDSA ED25519.<br>
 ‚Äî attestation ‚Äî    ,  .    : none, direct, indirect. Direct , ,  . None    ,           AAGUID    0x00000000000000000000000000000000. Indirect    privacy-ca. - attestation   none.      ,       .    ,            'none'    .<br>
<br>
<img src="https://habrastorage.org/webt/ze/bd/x6/zebdx6vq5oxpzcj0dzzdtyatpv8.png"><br>
<br>
          Firefox Nightly<br>
<br>
     :<br>
<br>
<img src="https://habrastorage.org/webt/bn/mw/fp/bnmwfpq9cawzhbkryvxu4qffx2w.png"><br>
<br>
   :<br>
<br>
 ‚Äî id/rawId ‚Äî        credId. id  base64url    rawId.<br>
 ‚Äî response.clientDataJSON ‚Äî   CollectedDataJSON, JSON       .   clientDataJSON:<br>
<br>
<pre><code>{
	"challenge": "1KnytoY-it44IiEMx0lK5GBlBvAJeVULPSCw5E-5qpA",
	"origin": "http://localhost:3000",
	"tokenBinding": {
		"status": "not-supported"
	},
	"type": "webauthn.create"
}
</code></pre><br>
 ‚Äî attestationObject ‚Äî  <a href="https://habr.com/post/208690/">CBOR</a> ,  ,   , ,    .<br>
<br>
<img src="https://habrastorage.org/webt/7k/c_/mo/7kc_mojxuv6cwfnaqgor_z7l7pk.png"><br>
<br>
 ‚Äî authData ‚Äî   ,     rpIdHash, , ,   ,        .<br>
 ‚Äî fmt ‚Äî   .    WebAuthn  ¬´packed¬ª, ¬´fido-u2f¬ª, ¬´android¬ª, ¬´tpm¬ª  ¬´safety-net¬ª .<br>
 ‚Äî attStmt ‚Äî     . ,    .<br>
<br>
      clientDataJSON   clientDataHash.    authData  clientDataHash   signatureBase.         attStmt.sig,       signatureBase.<br>
<br>
<img src="https://habrastorage.org/webt/dv/qa/qw/dvqaqwgsp3bsw9c1yxyf313h1ug.png"> <br>
<br>
<h5>Get assertion</h5><br>
         navigator.credentials.create ,     ¬´publicKey¬ª.<br>
<br>
var randomChallengeBuffer = new Uint8Array(32);<br>
 window.crypto.getRandomValues(randomChallengeBuffer);<br>
<br>
<pre><code class="javascript">    var idBuffer = encoder.encode("mFuXJYt-0qYZDUBFyN_SW_Cach6U56mrnHA_ZuxtlOnjHLhjfWjYVftbxr4WMmxp1-MG3nRRNQoI7WvvAM0pmw")
    var options = {
      challenge: randomChallengeBuffer,
      allowCredentials: [{ type: "public-key", id: idBuffer }]
    }

    navigator.credentials.get({ "publicKey": options })
            .then((assertion) =&gt; {
                console.log('SUCCESS', assertion)
            })
            .catch((error) =&gt; {
                console.log('FAIL', error)
            })
</code></pre><br>
allowCredentials ‚Äî     ,        (credId).        allowCredentials c credId  .          authenticatorSelection.requireResidentialKey,        allowCredentials.<br>
<br>
     :<br>
<br>
<img src="https://habrastorage.org/webt/xw/o2/sb/xwo2sb7mwmryavxcggbrtft68uq.png"><br>
<br>
  ,   ,    :<br>
 ‚Äî clientDataJSON.type   ¬´webauthn.get¬ª<br>
<br>
<pre><code>{
	"challenge": "-0NPkC-1zxpcGanUJMbKFdd7Ze0kRphWFy1_Sgc4FpI",
	"origin": "http://localhost:3000",
	"tokenBinding": {
		"status": "not-supported"
	},
	"type": "webauthn.get"
}
</code></pre><br>
 ‚Äî attestationObject <br>
 ‚Äî authenticatorData  authData,    authenticatorAttestation <br>
 ‚Äî signature  <br>
 ‚Äî userHandle ‚Äî   ,         user.id<br>
<br>
    ,      .<br>
<br>
UPD:  <a href="https://webauthn.org/">webauthn.org</a> ( U2F )<br>
<br>
        .           CTAP2(Client-to-Authenticator 2).<br>
<br>
       .</div><p>Source: <a href="https://habr.com/ru/post/354638/">https://habr.com/ru/post/354638/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354626/index.html">Linux Mood Color, Mac OS Mood Color</a></li>
<li><a href="../354628/index.html">Erlang cluster on the knee</a></li>
<li><a href="../354630/index.html">Saving JS and CSS resources in the browser's local storage</a></li>
<li><a href="../354632/index.html">Installing and configuring OpenVPN server using docker-compose</a></li>
<li><a href="../354636/index.html">Visualization in CAD: why we wrote another 3D engine and how it works</a></li>
<li><a href="../354640/index.html">The history of moving the system administrator in Germany. Part Two: Moving and First Steps</a></li>
<li><a href="../354642/index.html">Conclusion of the Telegram channel on your website</a></li>
<li><a href="../354646/index.html">On the topic of the day: a cross-platform client for Telegram on .NET Core and Avalonia</a></li>
<li><a href="../354648/index.html">Software creation of a type library</a></li>
<li><a href="../354650/index.html">Snake layout and "quantum" particles in Android applications (Part 2)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>