<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHP Data Encryption Guide</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From the translator: in the process of programming, I never forget that I am dangerously incompetent in cryptography , and I advise everyone to procee...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHP Data Encryption Guide</h1><div class="post__text post__text-html js-mediator-article">  <i>From the translator: in the process of programming, I never forget that <a href="http://habrahabr.ru/post/181372/">I am dangerously incompetent in cryptography</a> , and I advise everyone to proceed from this thesis (well, maybe apart from you and another cool guy).</i>  <i>However, one way or another, in the process of work there are tasks related to the protection of data, and they must be solved.</i>  <i>Therefore, I offer you the translation of the article by Finnish developer <a href="http://timoh6.github.io/">Timo H</a> , which seemed to me quite interesting and useful.</i> <br><br>  <i><b>Important update</b> : in the comments <a href="https://habrahabr.ru/users/samdark/" class="user_link">SamDark</a> made a remark that the Mcrypt library has not been supported for a long time and has a number of flaws, therefore it is recommended to use OpenSSL.</i>  <i>If you need to rewrite the existing code, <a href="http://thefsb.tumblr.com/post/111035508040/porting-php-code-from-mcrypt-to-openssl">this article</a> can help.</i>  <i>In addition, there is evidence that <a href="https://wiki.php.net/rfc/removal_of_dead_sapis_and_exts">Mcrypt can be removed in PHP7</a> .</i> <br><br>  This is a quick tutorial on how to avoid common errors with symmetric encryption in PHP. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We will consider the case when data is processed on the server side (in particular, encryption occurs on the server, and data can be received, for example, from the client in the form of clear text, password, etc.), which is a typical case for PHP applications . <br><br>  The information in this guide should not be used to create encrypted network connections that have more complex requirements.  For such cases, you must use <a href="https://www.tarsnap.com/spiped.html">spiped</a> or <a href="https://ru.wikipedia.org/wiki/TLS">TLS</a> . <br><br>  Naturally, the recommendations given here are not the ‚Äúonly possible way‚Äù to organize encryption in PHP.  The goal of this guide is to try to leave less room for mistakes and complex ambiguous solutions. <a name="habracut"></a><br><br><h4>  PHP encryption features </h4><br>  Use <a href="http://php.net/mcrypt">Mcrypt</a> or <a href="http://php.net/openssl">OpenSSL</a> extensions. <br><br><h4>  Encryption algorithm and its mode of operation, one-time code (initialization vector) </h4><br>  Use AES-256 in CTR mode with a random one-time code ( <i>approx. Trans .: <a href="https://ru.wikipedia.org/wiki/Nonce">nonce</a></i> ).  AES is a standard, so you can use the functions of any of the extensions - Mcrypt or OpenSSL. <br><br>  Always generate a new one-time code.  In this case, you must use a cryptographically stable source of random numbers.  A little more about the generation of random numbers, see below.  The one-time code is not a secret, and can be concatenated with a ciphertext for transmission and subsequent decryption. <br><br>  The one-time code must be 128 bits long (16 bytes), just a string of bytes without any encoding. <br><br>  The Mcrypt AES extension is known as Rijndael-128 ( <i>this is not an error. <a href="http://stackoverflow.com/a/17249813">AES-256! = Rijndael-256</a></i> ) <i>, although it‚Äôs about AES-256</i> .  In OpenSSL, respectively, AES-256-CTR. <br><br>  An example of using Mcrypt: <br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// $key length must be exactly 256 bits (32 bytes). // $nonce length must be exactly 128 bits (16 bytes). $ciphertext = mcrypt_encrypt(MCRYPT_RIJNDAEL_128, $key, $plaintext, 'ctr', $nonce); // Mcrypt</span></span></code> </pre> <br>  OpenSSL usage example: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// $key length must be exactly 256 bits (32 bytes). // $nonce length must be exactly 128 bits (16 bytes). $ciphertext = openssl_encrypt($plaintext, 'AES-256-CTR', $key, true, $nonce); // OpenSSL</span></span></code> </pre><br>  Make sure that the encryption works correctly using <a href="http://csrc.nist.gov/publications/nistpubs/800-38a/sp800-38a.pdf">test vectors</a> ( <i>note re.: For AES-256-CTR, see clause F.5.5 on page 57</i> ). <br><br>  For CTR mode, there are some restrictions on the total amount of encrypted data.  Perhaps you will not encounter this in practice, but keep in mind that it is not necessary to encrypt more than 2 ^ 64 bytes of data with one key, without any message being one long message or many short ones. <br><br>  CTR mode retains durability only if you do not use the same one-time code with the same key.  For this reason, it is important to generate one-time codes using a cryptographically strong source of randomness.  In addition, this means that you should not encrypt more than 2 ^ 64 messages with one key.  Since the length of a one-time code is 128 bits, it is important to limit the number of messages (and the corresponding one-time codes) to 2 ^ 128/2 due to the Birthdays paradox ( <i>comment perev .: <a href="https://ru.wikipedia.org/wiki/%25CF%25E0%25F0%25E0%25E4%25EE%25EA%25F1_%25E4%25ED%25E5%25E9_%25F0%25EE%25E6%25E4%25E5%25ED%25E8%25FF">more about the paradox</a></i> ). <br><br>  And remember that encryption will not hide the fact how much data you send.  As an example of an extreme case, if you encrypt messages containing only ‚Äúyes‚Äù or ‚Äúno‚Äù, obviously, encryption will not hide this information. <br><br><h4>  Data authentication </h4><br>  Always perform authentication and data integrity. <br>  To do this, use <a href="http://www.daemonology.net/blog/2009-06-24-encrypt-then-mac.html">MAC</a> after encryption.  Those.  first, the data is encrypted, and then the HMAC-SHA-256 is taken from the received ciphertext, including the actual ciphertext and one-time code. <br><br>  When deciphering, first test the HMAC using a time-resistant attack comparison algorithm.  Do not directly compare $ user_submitted_mac and $ calculated_mac using comparison operators == or ===.  It is better to even use the " <a href="https://www.isecpartners.com/blog/2011/february/double-hmac-verification.aspx">double check HMAC</a> ". <br><br>  If the HMAC test succeeds, it can be safely decrypted.  If the HMAC does not fit, shut down immediately. <br><br><h4>  Encryption and authentication keys </h4><br>  Ideally, use keys derived from a cryptographically secure source of randomness.  AES-256 requires 32 bytes of random data (the ‚Äúraw‚Äù line is a sequence of bits without using any encoding). <br><br>  If you rely on a key ( <i>comment perev .: the key entered by the user is called "password"</i> ) entered by the user or specified in the configuration, then it needs to be converted before being used as an encryption key.  Use PBKDF2 to turn the password into an encryption key.  Read more <a href="http://php.net/hash_pbkdf2">http://php.net/hash_pbkdf2</a> . <br><br>  If the application is running under PHP version below 5.5, where there is no PBKDF2 embedded implementation, you will have to use your own PHP implementation, an example of which can be found here: <a href="https://defuse.ca/php-pbkdf2.htm">https://defuse.ca/php-pbkdf2.htm</a> .  Keep in mind that, relying on your own implementation, you may not be able to convert the key properly, as the built-in function hash_pbkdf2 () does. <br><br>  Do not use the same key for encryption and authentication.  As stated above, 32 bytes per encryption key and 32 bytes per authentication key (HMAC) are required.  With PBKDF2, you can get 64 bytes from a password and use, say, the first 32 bytes as the encryption key, and the remaining 32 bytes for the authentication key. <br><br>  If your passwords are stored in a file, for example, in the form of a HEX string, do not re-encode them before feeding the encryption functions.  Instead, use PBKDF2 to convert keys from HEX encoding immediately to a quality encryption or authentication key.  Or use SHA-256 with output without additional coding (just a string of 32 bytes) for hashing passwords.  Using regular password hashing gives you enough entropy.  Details are described in the following paragraphs. <br><br><h4>  Key Stretch </h4><br>  First, the use of low entropy keys should be avoided.  But still, if you need to use, for example, user passwords, you should definitely use PBKDF2 with a large number of iterations to maximize the security of the key. <br><br>  One of the parameters for PBKDF2 is the number of hash iterations.  And the higher it is, the more key security can be expected.  If your code works on a 64-bit platform, use SHA-512 as a hashing algorithm for PBKDF2.  For a 32-bit platform, use SHA-256. <br><br>  However, it is not possible to use a relatively high number of iterations in online applications due to the risk of a DoS attack.  Therefore, the key quality will not be as high as in offline applications that can afford a large number of iterations without such a risk.  As a rule, for online applications, such a number of hashing iterations is selected so that PBKDF2 can work no more than 100 ms. <br><br>  In case you can use passwords with high entropy, it is not necessary to carry out a ‚Äústretch‚Äù, as for passwords with low entropy.  For example, if you create the "master_key_ encryption" and "master_key_autification" using / dev / urandom, then the need for PBKDF2 is completely eliminated.  Just be sure to use the keys as bit sequences, without any coding. <br><br>  In addition, using PBKDF2 makes it easy to get both keys for encryption and authentication from one master password (just use a small number of iterations or even one).  This is useful if you have only one ‚Äúmaster password‚Äù used for both encryption and authentication. <br><br><h4>  Key Storage and Management </h4><br>  The best thing is to use a separate, dedicated key storage device ( <a href="http://en.wikipedia.org/wiki/Hardware_security_module">HSM</a> ). <br><br>  If this is not possible, then to complicate the attack, you can use file encryption with keys or a configuration file (in which the actual encryption / authentication keys are stored) using a key stored in a separate place (outside the home directory or the site root).  For example, you can use the Apache environment variable in httpd.conf to save the key needed to decrypt the file with the actual keys: <br><pre> <code class="apache hljs"><span class="hljs-section"><span class="hljs-section">&lt;VirtualHost *:80&gt;</span></span> <span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">SetEnv</span></span></span></span> keyfile_key crypto_strong_high_entropy_key # You can access this variable in PHP using $_SERVER['keyfile_key'] # Rest of the config &lt;/VirtualHost&gt;</code> </pre><br>  Now, if the files in the root of the site and below, including files with keys, are compromised (for example, if a backup is leaked), the encrypted data will remain intact because the key stored in the environment variable has not been compromised.  It is important to remember that the httpd.conf files should be backed up separately, and not compromise the keyfile_key variable through, for example, the output of phpinfo (). <br><br>  If instead of a configuration parameter you use a file, then it is possible to organize the rotation of keys.  In the worst case, if the adversary has acquired your encryption and authentication keys, and this fact has gone unnoticed, the rotation of the keys with some frequency can limit its access (provided that it cannot acquire the new keys).  This technique will help reduce the damage, because the enemy will not be able to use the compromised keys indefinitely. <br><br><h4>  Data compression </h4><br>  In general, you should not compress the source text before encryption.  This may give the opponent an additional analysis tool. <br><br>  For example, if you store session data in an encrypted cookie, with some of this data provided by the user, and some of the secret information, the adversary may learn additional information about the secret by sending as a regular user certain data generated and measuring how the length of the received ciphertexts varies. <br><br>  Text is compressed more efficiently if there are duplicate sections.  By manipulating user data, you can choose so that they partially coincide with secret data.  The greater the match, the smaller the size of the ciphertext will be output.  This type of attack is called <a href="http://en.wikipedia.org/wiki/CRIME">CRIME</a> . <br><br>  If you do not have a hard need to compress the data, do not compress. <br><br><h4>  Server environment </h4><br>  As a rule, you should not place security-demanding applications on a shared server.  For example, on a shared hosting, where an adversary can access a virtual machine on the same physical server as you. <br><br>  There are various reasons that make shared servers a questionable place to host security-critical applications.  For example, attacks between virtual servers were recently demonstrated: <a href="http://eprint.iacr.org/2014/248.pdf">eprint.iacr.org/2014/248.pdf</a> .  This is a good reminder that attack techniques do not degrade, but rather sharpen and improve over time.  You should always take into account such pitfalls. <br><br><h4>  Expert advice </h4><br>  Last but not least, consult with an expert, let him review your security code. <br><br>  <a href="https://twitter.com/rootlabs/status/474741767607033856">@rootlabs</a> , June 5, 2014: <br><blockquote>  @plo @veorq I have been working in cryptography since 1997, and so far all my decisions and implementations are reviewed by a third party. </blockquote><br><h4>  Cryptographically resistant random numbers </h4><br>  Use a random source provided by the OS.  In PHP, for example, mcrypt_create_iv ($ count, MCRYPT_DEV_URANDOM) or read directly from / dev / urandom. <br><br>  Always check that the correct number of bytes is received from the source.  If this is not the case, do not attempt to correct this error yourself using self-made pseudo-randomness algorithms. </div><p>Source: <a href="https://habr.com/ru/post/257439/">https://habr.com/ru/post/257439/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257425/index.html">Why not RemoteFX, as well as more information about NVIDIA GRID VGPU technology</a></li>
<li><a href="../257427/index.html">Adjustable power supply from ATX power supply to TL494. Part 1 - iron</a></li>
<li><a href="../257431/index.html">Implement an even more secure VPN protocol</a></li>
<li><a href="../257433/index.html">How we did the subway breakdown alert</a></li>
<li><a href="../257437/index.html">SkillsWiki conference materials: .NET-developer through the eyes of employers in Russia and abroad</a></li>
<li><a href="../257443/index.html">GPS-monitor for android "KidsTrack"</a></li>
<li><a href="../257445/index.html">thd or triggerhappy global hotkey daemon</a></li>
<li><a href="../257449/index.html">Redmine main menu</a></li>
<li><a href="../257451/index.html">Create your site to manage Arduine</a></li>
<li><a href="../257453/index.html">Announcements Ignite - a new Microsoft conference dedicated to IT Pro, business and productivity tools</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>