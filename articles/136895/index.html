<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dependency injection in the MVC 3 Framework by the example of Autofac</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is currently difficult to imagine an application on MVC3Framework without using Dependency injection. This article is intended for those who know w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dependency injection in the MVC 3 Framework by the example of Autofac</h1><div class="post__text post__text-html js-mediator-article"> It is currently difficult to imagine an application on MVC3Framework without using Dependency injection.  This article is intended for those who know what DI is, but have never used Autofac for this. <br>  Also note that in more detail about Autofac you can read <a href="http://code.google.com/p/autofac/w/list">here.</a> <br><br>  First we need to download and include the Autofac libraries in the project.  For this, I use NuGet.  Type in the console: <br>  <code>PM&gt; Install-Package Autofac</code> Install Autofac yourself <br>  <code>PM&gt; Install-Package Autofac.Mvc3</code> And additions to Mvc3 <br><br>  You can also use NuGet's visual editor, or simply download and connect these assemblies. <br>  The following code is written to initialize Autofac, I tried to include the main initialization options here. <br><a name="habracut"></a><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Application_Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Trace.TraceInformation(<span class="hljs-string"><span class="hljs-string">"Website initialization started"</span></span>); AreaRegistration.RegisterAllAreas(); RegisterGlobalFilters(GlobalFilters.Filters); RegisterRoutes(RouteTable.Routes); <span class="hljs-comment"><span class="hljs-comment">// Setup IoC container var builder = new ContainerBuilder(); builder.RegisterModule(new ServicesModule()); builder.Register(c =&gt; new Entities()).As&lt;IEntities&gt;() .OnActivated(e =&gt; { var config = DependencyResolver.Current.GetService&lt;IGlobalSettings&gt;(); e.Instance.RawConnectionString = config.Data.SqlServerConnectionString; }).InstancePerHttpRequest(); builder.RegisterType&lt;LocalizationContext&gt;().PropertiesAutowired().InstancePerHttpRequest(); builder.Register(c =&gt; new DefaultGlobalSettings()).As&lt;IGlobalSettings&gt;().SingleInstance(); builder.RegisterGeneric(typeof(MongoRepository&lt;&gt;)) .As(typeof(IMongoRepository&lt;&gt;)).InstancePerHttpRequest(); builder.Register(c =&gt; EnvironmentContext()).As&lt;IEnvironmentContext&gt;().InstancePerHttpRequest(); builder.RegisterModule(new AutofacWebTypesModule()); builder.RegisterSource(new ViewRegistrationSource()); builder.RegisterModelBinders(Assembly.GetExecutingAssembly()); builder.RegisterModelBinderProvider(); builder.RegisterFilterProvider(); IContainer container = builder.Build(); DependencyResolver.SetResolver(new AutofacDependencyResolver(container)); Trace.TraceInformation("Website has been successfully initialized"); }</span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now consider what actually happened here. <br>  Registering a module for Autofac.  This is very useful for initializing classes (classes with the access modifier internal) that are in a separate assembly.  We just have to leave ServicesModule in the same assembly, and enjoy all the delights of DI <br><pre> <code class="cs hljs"> builder.RegisterModule(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServicesModule());</code> </pre><br>  The method that must be performed to obtain the required object can be specified as follows: <br><pre> <code class="cs hljs"> builder.Register(c =&gt; EnvironmentContext()).As&lt;IEnvironmentContext&gt;().InstancePerHttpRequest()</code> </pre><br>  The same but in the form of an anonymous delegate. <br><pre> <code class="cs hljs"> builder.Register(c =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Entities()).As&lt;IEntities&gt;() .OnActivated(e =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = DependencyResolver.Current.GetService&lt;IGlobalSettings&gt;(); e.Instance.RawConnectionString = config.Data.SqlServerConnectionString; }).InstancePerHttpRequest();</code> </pre><br>  You can compare the class with the interface as follows: <br><pre> <code class="cs hljs"> builder.Register(c =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultGlobalSettings()).As&lt;IGlobalSettings&gt;().InstancePerHttpRequest();</code> </pre><br>  In order to register Generic classes, use the following code: <br><pre> <code class="cs hljs"> builder.RegisterGeneric(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(MongoRepository&lt;&gt;)) .As(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IMongoRepository&lt;&gt;)).InstancePerHttpRequest();</code> </pre><br>  In order to inject properties of a class, it is enough to do the following initialization.  I note that the DI in the constructor is much faster than on the property, so such an injection should be used only in extreme cases. <br><pre> <code class="cs hljs"> builder.RegisterType&lt;LocalizationContext&gt;().PropertiesAutowired().InstancePerHttpRequest();</code> </pre><br>  If the property is known in advance, you can use this initialization: <br><pre> <code class="cs hljs"> builder.Register(c =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LocalizationContext { GlobalSettings = c.Resolve&lt;IGlobalSettings&gt;() });</code> </pre><br>  Initialization of the classes HttpContextBase, HttpRequestBase, HttpResponseBase, HttpServerUtilityBase, HttpSessionStateBase, HttpApplicationStateBase, HttpBrowserCapabilitiesBase, HttpCachePolicyBase, VirtualPathProvider is in place; <br><pre> <code class="cs hljs"> builder.RegisterModule(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AutofacWebTypesModule());</code> </pre><br>  Autofac allows injection in ModelBinder. <br><pre> <code class="cs hljs"> builder.RegisterModelBinders(Assembly.GetExecutingAssembly()); builder.RegisterModelBinderProvider();</code> </pre><br>  Injection into filters (classes derived from ActionFilterAttribute) is as follows: <br><pre> <code class="cs hljs"> builder.RegisterFilterProvider();</code> </pre><br>  Injection in the View is the registration of the next module. <br><pre> <code class="cs hljs"> builder.RegisterSource(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ViewRegistrationSource());</code> </pre><br>  As you noticed, the code is accompanied by a call: <br>  .InstancePerDependency () - used by default, creates a new object with each call. <br>  .InstancePerHttpRequest () is a single instance on HttpRequest <br>  .SingleInstance () - creates only one instance of the class. <br>  .InstancePerLifetimeScope () - creates an instance for a specific LifetimeScope is used as follows: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lifetime = container.BeginLifetimeScope()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> component = lifetime.Resolve&lt;SomeComponent&gt;(); <span class="hljs-comment"><span class="hljs-comment">// component, and any of its disposable dependencies, will // be disposed of when the using block completes }</span></span></code> </pre><br>  We receive a copy of the container. <br><pre> <code class="cs hljs"> IContainer container = builder.Build();</code> </pre><br>  Install DependencyResolver <br><pre> <code class="cs hljs"> DependencyResolver.SetResolver(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AutofacDependencyResolver(container));</code> </pre><br><br>  That's all.  Now you have the minimum skills to work with autofac, and you can safely begin to use it in your project.  It was quite difficult for me to pick out exactly those moments that would help you master Autofac in a short time.  If I haven't covered any topic enough: please write it down in the comments. </div><p>Source: <a href="https://habr.com/ru/post/136895/">https://habr.com/ru/post/136895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136886/index.html">Three approaches to the methodology of building a complex client application</a></li>
<li><a href="../136887/index.html">Universal Startup Class</a></li>
<li><a href="../136888/index.html">How I stopped being afraid and fell in love with the UEFI Security Boot</a></li>
<li><a href="../136893/index.html">Windows Azure Toolkits for Devices - using Windows Azure on mobile platforms</a></li>
<li><a href="../136894/index.html">I do not share the tribulation of MegaUpload</a></li>
<li><a href="../136896/index.html">Glonass in Ukraine</a></li>
<li><a href="../136897/index.html">HTML KickStart is another way to quickly create an interface for your web application.</a></li>
<li><a href="../136899/index.html">How not to drown in megabytes javascript code? // Reports from the Mail.Ru Technology Forum 2011: text of the report, video, presentation</a></li>
<li><a href="../136900/index.html">Pavel Durov spoke at the DLD 2012 conference</a></li>
<li><a href="../136901/index.html">Form Analytics - new Yandex.Metrics tool</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>