<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Instant design</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="People learn architecture from old books that were written for Java. The books are good, but they give a solution to the tasks of that time with the t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Instant design</h1><div class="post__text post__text-html js-mediator-article">  People learn architecture from old books that were written for Java.  The books are good, but they give a solution to the tasks of that time with the tools of that time.  Time has changed, C # already looks more like a light Scala than Java, and there are few good new books. <br><br>  In this article we will look at the criteria for good code and bad code, how and what to measure.  We will see an overview of typical tasks and approaches, analyze the pros and cons.  At the end there will be recommendations and best practices for designing web applications. <br><br>  This article is a transcript of my report from the conference DotNext 2018 Moscow.  In addition to the text, under the cut there is a video and a link to the slides. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/qu/ur/ih/quurihchxowghlgnkanhvmb5o7e.jpeg"><br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/qJPwSvDLmQE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><blockquote>  <a href="https://assets.ctfassets.net/9n3x4rtjlya6/3TzGJj7fKwISGYQw4ku4c0/54a2ac651d438607970854d91f2f7f1a/Maksim_Arshinov_Bystrorastvorimoye_proyektirovaniye.pdf"><b>Slides</b></a> and <a href="https://2018.dotnext-moscow.ru/2018/msk/talks/1siysgi5tsumw6o22e6iue/">report page on the site</a> . </blockquote>  Briefly about me: I am from Kazan, I work in the ‚ÄúHightech Group‚Äù company.  We develop business software.  Recently, I have been teaching a course called Corporate Software Development at the Kazan Federal University.  From time to time I still write articles on Habr about engineering practices, about developing corporate software. <br><br>  As you, probably, could guess, today I will talk about the development of corporate software, namely, how to structure modern web applications: <br><br><ul><li>  criteria </li><li>  a brief history of the development of architectural thought (what was, what has become, what problems exist); </li><li>  review of the flaws of the classical puff architecture </li><li>  decision </li><li>  step-by-step analysis of sales without immersion in details </li><li>  totals. </li></ul><br><h1>  Criteria </h1><br>  We formulate the criteria.  I really don't like it when the talk about design is conducted in the style of "my kung fu is stronger than your kung fu."  Business has, in principle, one specific criterion, which is called "money."  Everyone knows that time is money, so these two components are most often the most important. <br><br><img src="https://habrastorage.org/webt/pu/2e/fh/pu2efhyhoibrcu9lav6fzdg48da.jpeg"><br><br>  So, the criteria.  In principle, business most often asks us "as many features as possible per unit of time", but with one nuance - these features should work.  And the first stage at which it may break is the review code.  That is, it seems, the programmer said: "I will do it in three hours."  Three hours have passed, the review has come to the code, and the team leader says: "Oh, no, redo it."  There are three more - and how many iterations the review code has passed, you need to multiply three hours by that. <br><br>  The next moment is the return from the acceptance test phase.  Same.  If the feature does not work, then it is not done, these three hours stretch for a week, two - well, as usual there.  The last criterion is the number of regressions and bugs, which nevertheless, despite testing and acceptance, were passed in production.  This is also very bad.  There is one problem with this criterion.  It is difficult to track, because the connection between the fact that we have launched something into the repository, and the fact that after two weeks something broke, it can be difficult to track.  But, nevertheless, it is possible. <br><br><h1>  Architecture development </h1><br>  Long ago, when programmers were just starting to write programs, there was still no architecture, and everyone did everything the way they like. <br><br><img src="https://habrastorage.org/webt/27/l7/oq/27l7oqmpgjyxndbw-4trowmrmem.jpeg"><br><br>  Therefore, such an architectural style was obtained.  We call it ‚Äúnoodles‚Äù, abroad they say ‚Äúspaghetti code‚Äù.  Everything is connected with everything: we change something at point A - at point B it breaks, to understand what is connected with what is absolutely impossible.  Naturally, the programmers quickly realized that this would not work, and we needed to do some kind of structure, and decided that some layers would help us.  Now, if you imagine that minced meat is a code, and lasagna are such layers, here is an illustration of a layered architecture.  The stuffing was still stuffing, but now the stuffing from layer No. 1 cannot just go and talk to the stuffing from layer No. 2. We gave the code some form: even in the picture you can see that the lasagna is more framed. <br><br><img src="https://habrastorage.org/webt/yx/_j/cu/yx_jcumnfvnensrmrbjwi9lyyqa.jpeg"><br><br>  Everyone is familiar with the <b>classical layered architecture</b> : there is a UI, there is a business logic and there is a Data Access layer.  There are still all sorts of services, facades and layers, named after the architect who left the company, there can be an unlimited number of them. <br><br><img src="https://habrastorage.org/webt/dd/28/qj/dd28qjfaycsftyr71tczg5ykxjo.jpeg"><br><br>  The next stage was the so-called <b>onion architecture</b> .  It would seem a huge difference: before that there was a square, and then there were circles.  It seems that is completely different. <br><br><img src="https://habrastorage.org/webt/pe/8r/rx/pe8rrxifll2tswmz63paezukklq.jpeg"><br><br>  Not really.  The only difference is that somewhere at this time the principles of SOLID were formulated, and it turned out that in classical onion there is a problem with dependency inversion, because the abstract domain code for some reason depends on the implementation, on Data Access, therefore Data Access decided to deploy , and made Data Access dependent on the domain. <br><br><img src="https://habrastorage.org/webt/8o/eb/we/8oebwed-cag1f-zvake5t9lmhl8.jpeg"><br><br>  I practiced drawing and drawing onion architecture here, but not classically with ‚Äúlittle rings‚Äù.  I got something between a polygon and circles.  I did this to simply show that if you came across the words ‚Äúonion,‚Äù ‚Äúhexagonal,‚Äù or ‚Äúports and adapters,‚Äù they are all the same.  The point is that the domain in the center, it is wrapped in services, they can be domain or application-services, as you like.  And the outside world in the form of UI, tests and infrastructure, where the DAL moved - they communicate with the domain through this service layer. <br><br><h2>  A simple example.  Email update </h2><br>  Let's see how in such a paradigm will look like a simple use case - update the user's email. <br><br><img src="https://habrastorage.org/webt/ta/fg/x-/tafgx-5pwfraeofdjg323ewoova.jpeg"><br><br>  We need to send a request, perform a validation, update the value in the database, send a notification to the new email: ‚ÄúEverything is fine, you changed the email, we know everything is fine‚Äù, and to answer the browser ‚Äú200‚Äù everything is okay. <br><br><img src="https://habrastorage.org/webt/xs/vm/0f/xsvm0f4b6zhpypwnixjazbv3ufi.jpeg"><br><br>  The code might look something like this.  Here we have standard <a href="https://dotnet.microsoft.com/apps/aspnet">ASP.NET</a> MVC validation, there is an ORM to read and update data, and there is some email-sender that sends a notification.  It seems like everything is fine, yes?  One nuance - in an ideal world. <br><br>  In the real world, the situation is slightly different.  The point is to add authorization, error checking, formatting, logging and profiling.  All this has nothing to do with our use case, but it should be.  And that little piece of code has become big and scary: with a lot of nesting, with a lot of code, with the fact that it is hard to read, and most importantly, the infrastructure code is larger than the domain code. <br><br><img src="https://habrastorage.org/webt/lh/xr/xd/lhxrxdbyaacgxsxrjcsoinbq-c8.jpeg"><br><br>  ‚ÄúWhere are the services?‚Äù You will say.  I wrote all the logic in the controllers.  Of course, this is a problem, now I will add services, and everything will be fine. <br><br><img src="https://habrastorage.org/webt/c6/nd/ca/c6ndcaxmuebeyawelqctgsh19ig.jpeg"><br><br>  We add services, and it really gets better, because instead of a big footcloth, we got one small beautiful line. <br><br>  Got better?  It has become!  And now we can reuse this method in different controllers.  The result is obvious.  Let's look at the implementation of this method. <br><br><img src="https://habrastorage.org/webt/up/xx/rx/upxxrx8d_fc-5qmzbk-d0afuht4.jpeg"><br><br>  But here everything is not so good.  This code has not gone away.  All the same, we just transferred to the services.  We decided not to solve the problem, but simply disguise it and move it to another place.  That's all. <br><br><img src="https://habrastorage.org/webt/m0/bo/fj/m0bofjvz471nmxub7ubqhshqwgi.jpeg"><br><br>  In addition, there are some other issues.  Should we do validation in the controller or here?  Well, sort of, in the controller.  And if you need to go to the database and see what such an ID is or that there is no other user with such an email?  Hmm, well, then in the service.  But error handling here?  This error handling is probably here, and the error handling that will be answered by the browser in the controller.  And the SaveChanges method, is it in service or do I need to transfer it to the controller?  It can be both so and so, because if the service is called one, it is more logical to call in the service, and if you have three controller methods in the controller that need to be called, then you need to call it outside of these services so that there is one transaction.  These are the thoughts that suggest that maybe the layers do not solve any problems. <br><br><img src="https://habrastorage.org/webt/9d/s6/gd/9ds6gdwecmtqyjjv3rko5l-rccg.jpeg"><br><br>  And this idea occurred to more than one person.  If you google, at least three of these honorable husbands write about the same thing.  From top to bottom: Stephen .NET Junkie (unfortunately, I don‚Äôt know his last name, because it doesn‚Äôt appear anywhere on the Internet) by IoC container <a href="https://simpleinjector.org/index.html">Simple Injector</a> .  Next, Jimmy Bogard - the author of <a href="https://automapper.org/">AutoMapper</a> .  And below is Scott Vlashin, the author of the site <a href="https://fsharpforfunandprofit.com/">‚ÄúF # for fun and profit‚Äù</a> . <br><br><img src="https://habrastorage.org/webt/pu/lt/rz/pultrzyz_24mf5fycqif--zcbpe.jpeg"><br><br>  All these people talk about the same thing and offer to build applications not on the basis of layers, but on the basis of use options, that is, the requirements for which the business asks us.  Accordingly, the use case in C # can be defined using the IHandler interface.  It has input values, output values, and there is the method itself that actually executes this use case. <br><br><img src="https://habrastorage.org/webt/9m/lj/hw/9mljhwhphjkuckh2r5tvegoyzg0.jpeg"><br><br>  And inside this method there can be either a domain model, or any denormalized model for reading, maybe with the help of Dapper or with the help of Elastic Search, if you need to look for something, and maybe you have Legacy -system with stored procedures - no problem, as well as network requests - well, in general, anything you might need.  But if there are no layers, how to be? <br><br><img src="https://habrastorage.org/webt/lg/iw/se/lgiwseqpyf9krjfkv4j9ciluxri.jpeg"><br><br>  First, let's get rid of UserService.  Remove the method and create a class.  And also remove, and remove again.  And then take and remove the class. <br><br><img src="https://habrastorage.org/webt/xx/tv/z1/xxtvz10bmxyzpefudhd2cw7892y.jpeg"><br><br>  Let's think, are these classes equivalent or not?  The GetUser class returns data and does not change anything on the server.  This, for example, about the request "Give me the user ID."  The UpdateEmail and BanUser classes return the result of the operation and change state.  For example, when we say to the server: ‚ÄúPlease change the state, you need to change something here.‚Äù <br><br><img src="https://habrastorage.org/webt/yj/qs/tn/yjqstnlgzw9lwrk8s1nr0j2s47u.jpeg"><br><br>  Look at the HTTP protocol.  There is a GET method that, according to the HTTP protocol specification, should return data and not change the state of the server. <br><br><img src="https://habrastorage.org/webt/uq/ql/7i/uqql7icixrsmjce88qwxwuxouss.jpeg"><br><br>  And there are other methods that can change the state of the server and return the result of the operation. <br><br><img src="https://habrastorage.org/webt/zu/u3/l6/zuu3l6-bulai-mgo4fozlyru8ci.jpeg"><br><br>  The CQRS paradigm seems to have been specially created for the HTTP protocol.  Query is GET operations, and commands are PUT, POST, DELETE ‚Äî you don‚Äôt need to invent anything. <br><br><img src="https://habrastorage.org/webt/2t/wk/yp/2twkypfgr9s5xxslujdjfelkkx4.jpeg"><br><br>  We will define our Handler and define additional interfaces.  IQueryHandler, which differs only in that we hang constraint that the type of input values ‚Äã‚Äãis IQuery.  IQuery is a marker interface, there is nothing in it except for this generic.  We need a generic in order to place constraint in the QueryHandler, and now, when declaring the QueryHandler, we cannot transfer there not Query, but passing the Query object there, we know its return value.  This is convenient if you have some interfaces, so that you do not look for their implementation in the code, and again not to make a mess of it.  You write IQueryHandler, write the implementation there, and you cannot substitute another type of return value in TOut.  It just won't compile.  Thus, it is immediately apparent which input values ‚Äã‚Äãcorrespond to which input data. <br><br><img src="https://habrastorage.org/webt/e5/k9/pd/e5k9pdmjpohmvppi9j5mco2lpz8.jpeg"><br><br>  Absolutely the same situation for the CommandHandler with one exception: this generic will be needed for one more trick, which we will see a little further. <br><br><h3>  Handler implementation </h3><br>  Handlers, we announced what kind of implementation they have? <br><br><img src="https://habrastorage.org/webt/xb/ye/no/xbyeno8s7xry4tv5n1t2sgig4fk.jpeg"><br><br>  Any problem, yes?  It seems that something did not help. <br><br><h3>  Decorators rush to the rescue </h3> <br>  But it did not help, because we are still in the middle of the road, we still need to refine a little, and this time we will need to use the <a href="https://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B5%25D0%25BA%25D0%25BE%25D1%2580%25D0%25B0%25D1%2582%25D0%25BE%25D1%2580_(%25D1%2588%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)">decorator</a> pattern, namely, its remarkable layout feature.  The decorator can be wrapped in the decorator, wrapped in the decorator, wrapped in the decorator - continue until you get bored. <br><br><img src="https://habrastorage.org/webt/pj/oj/m2/pjojm2jkr9q2q3of-rgouuydrjc.jpeg"><br><br>  Then everything will look like this: there is an input Dto, it enters the first decorator, the second, the third, then we go into the Handler and also exit it, go through all the decorators and return Dto in the browser.  We declare an abstract base class in order to later inherit, the body of Handler is passed to the constructor, and we declare the abstract method Handle, in which the additional logic of the decorators will be hung. <br><br><img src="https://habrastorage.org/webt/4k/df/ha/4kdfha-rrtuvomibpp8tuadhcrw.jpeg"><br><br>  Now with the help of decorators you can build a pipeline.  Let's start with the teams.  What did we have?  Input values, validation, access control, the logic itself, some events that occur as a result of this logic, and return values. <br><br><img src="https://habrastorage.org/webt/zp/yw/3i/zpyw3iastzi8ggkluwnk_dhdes0.jpeg"><br><br>  Let's start with validation.  We announce the decorator.  IEnumerable comes from the constructor of this validator of type T validators. We execute them all, check if validation fails and the return type is <code>IEnumerable&lt;validationresult&gt;</code> , then we can return it because the types are the same.  And if this is some other Hander, well then you have to throw Exception, because there is no result here, the type of the other return value. <br><br><img src="https://habrastorage.org/webt/wp/pi/bp/wppibp3w6wzoylmbhx8nsop6lda.jpeg"><br><br>  The next step is Security.  Also we declare the decorator, we do the CheckPermission method, we check.  If suddenly something went wrong, everything, we do not continue.  Now, after we have carried out all the checks and are sure that everything is fine, we can execute our logic. <br><br><h3>  <a href="https://habr.com/ru/post/266937/">Obsession with primitives</a> </h3><br>  Before showing the implementation of logic, I want to start a little bit earlier, namely, with the input values ‚Äã‚Äãthat come there. <br><br><img src="https://habrastorage.org/webt/gl/y5/ro/gly5roxocvdausjqf9dztn69jjk.jpeg"><br><br>  Now, if we single out such a class this way, then most often it can look something like this.  At least this is the code that I see in my daily work. <br><br><img src="https://habrastorage.org/webt/is/e4/6r/ise46rxpz-gsrqeqpqjwac-ir58.jpeg"><br><br>  In order for validation to work, we add here some attributes that tell us what kind of validation it is.  This will help in terms of data structure, but will not help with such validation as checking values ‚Äã‚Äãin the database.  Here, just EmailAddress, it is not clear how, where to check how to use these attributes in order to go to the database.  Instead of attributes, you can go to special types, then this problem will be solved. <br><br><img src="https://habrastorage.org/webt/oq/6b/3x/oq6b3xuwdmc5xh_04v71g02jkmo.jpeg"><br><br>  Instead of the primitive <code>int</code> declare such a type Id, which has a generic, that this is a certain entity with an int key.  And in the constructor, we either pass this entity, or pass it to Id, but at the same time we have to pass a function that, by Id, can take and return, check, null is there or not null. <br><br><img src="https://habrastorage.org/webt/tt/fk/ut/ttfkutansz1nzthl3x5adtxftde.jpeg"><br><br>  We do the same with Email.  Let's convert all Emails to the bottom line so that everything looks the same to us.  Next we take the Email attribute, declare it as static for compatibility with ASP.NET validation and here we just call it.  That is, so too can be done.  In order for the ASP.NET infrastructure to pick up all this, you will have to slightly change the serialization and / or ModelBinding.  The code is not very much there, it is relatively simple, so I will not stop there. <br><br><img src="https://habrastorage.org/webt/md/5k/zi/md5kzigojhdaybdbizxrvby2p5w.jpeg"><br><br>  After these changes, instead of primitive types, we have specialized types here: Id and Email.  And after these ModelBinder and updated deserializer have worked, we know for sure that these values ‚Äã‚Äãare correct, including the values ‚Äã‚Äãin the database.  "Invariants" <br><br><img src="https://habrastorage.org/webt/hu/ew/ul/huewulf5m8-mwkha62fbu3dm5sy.jpeg"><br><br>  The next point on which I would like to dwell is the state of invariants in the class, because quite often the <a href="https://habr.com/ru/post/224879/">anemic model</a> is used, in which there is just a class, many getters-setters, it is completely incomprehensible how they should work together.  We work with complex business logic, so it is important for us that the code be self-documenting.  Instead, it is better to declare a real constructor with an empty ORM, you can declare it protected so that programmers in their application code cannot call it, and ORM can.  Here we are no longer sending a primitive type, but an Email type, it is already exactly correct, if it is null, we still throw Exception.  You can use any Fody, PostSharp, but soon C # 8 comes out. Accordingly, there will be a Non-nullable reference type, and it is better to wait for its support in the language.  The next moment, if we want to change the name and surname, most likely we want to change them together, so there must be an appropriate public method that changes them together. <br><br><img src="https://habrastorage.org/webt/p8/ze/vw/p8zevw3bkth4ialnrabvlsk3hru.jpeg"><br><br>  In this public method, we also verify that the length of these strings corresponds to what we use in the database.  And if something is wrong, then stop execution.  Here I use the same trick.  I declare a special attribute and just call it in the application code. <br><br><img src="https://habrastorage.org/webt/tj/ae/mi/tjaemirkcgpbgkmknl9acjkhioa.jpeg"><br><br>  Moreover, such attributes can be reused in Dto.  Now, if I want to change the name and surname, I may have such a command to change.  Is it worth it to add a special constructor here?  It seems to be worth it.  It will become better, no one will change these values, will not break them, they will be exactly the right ones. <br><br><img src="https://habrastorage.org/webt/lt/hq/r1/lthqr1w63fzepclzgrcl6ykwaik.jpeg"><br><br>  Not really, really.  The fact is that Dto is not really objects at all.  This is such a dictionary, in which we shove deserialized data.  That is, they pretend to be objects, of course, but they have only one responsibility - to be serialized and deserialized.  If we try to deal with this structure, we will begin to declare some ModelBinder with designers, something to do, this is incredibly tedious, and, most importantly, it will break with new outputs of new frameworks.  All this is well described by Mark Simon in the article <a href="https://habr.com/ru/post/205108/">‚ÄúOn the boundaries of the program are not object-oriented,‚Äù</a> if you are interested, read his post, it‚Äôs all described in detail. <br><br><img src="https://habrastorage.org/webt/mf/bw/he/mfbwhegqg7nbmsw4iwj0y8w99c0.jpeg"><br><br>  In short, we have a dirty outside world, we put in the input of the check, convert it to our clean model, and then transfer it all back to serialization, to the browser, again to the dirty outside world. <br><br><h3>  Handler </h3><br>  After all these changes have been made, what will Hander look like? <br><br><img src="https://habrastorage.org/webt/o-/ov/wl/o-ovwlxyrkjuv2murrbk4ifttr4.jpeg"><br><br>  I wrote two lines here in order to make it easier to read, but in general can be written in one.  The data is exactly correct, because we have a type system, there is validation, that is, reinforced concrete correct data, we do not need to check them again.  This user also exists, there is no other user with such busy email, everything can be done.  However, there is still no call to the SaveChanges method, there is no notification, and there are no logs and profilers, right?  Moving on. <br><br><h3>  Events </h3><br>  Domain events. <br><br><img src="https://habrastorage.org/webt/fo/s8/tq/fos8tqpb3kq5ealyvsm3qu9ayhm.jpeg"><br><br>  Perhaps, for the first time, Udi Dahan popularized this concept in his post <a href="http://udidahan.com/2009/06/14/domain-events-salvation/">‚ÄúDomain Events - Salvation‚Äù</a> .  There he proposes to simply declare a static class with the Raise method and throw out such events.  A little later, Jimmy Bogard proposed a better implementation, and it is called <a href="https://lostechies.com/jimmybogard/2014/05/13/a-better-domain-events-pattern/">‚ÄúA better domain events events‚Äù</a> . <br><br><img src="https://habrastorage.org/webt/lq/e_/hq/lqe_hqerzlvb_vi4less4xr6lg4.jpeg"><br><br>  I will show the serialization of Bogard with one small change, but important.  Instead of throwing out events, we can declare some list, and in those places where some reaction should take place, right inside the entity, save these events.  In this case, this <code>email</code> getter is also a User class, and this class, this property, does not pretend to be a property with auto wipers and setters, but really adds something to this.  That is, it is a real encapsulation, not a profanation.  When we change, we check that the email is different and throw away the event.  This event is not going anywhere yet; we only have it in the internal list of entities. <br><br><img src="https://habrastorage.org/webt/ge/4c/nd/ge4cndzro2vbjuhb4qeujuot1qq.jpeg"><br><br>  Further, at that moment, when we call the SaveChanges method, we take a ChangeTracker, see if there are any entities that implement the interface, whether they have domain events.  And if there is, let's take all these domain events and send them to some dispatcher who knows what to do with them. <br><br>  The implementation of this dispatcher is a topic for a separate conversation, there are some difficulties with multiple dispatch in C #, but this is also done.  With this approach, there is another unobvious advantage.  Now, if we have two developers, one can write code that changes this very email, and the other can make a notification module.  They are absolutely not connected with each other, they write different code, they are connected only at the level of this domain event of the same Dto class.  The first developer simply throws out this class at some point, the second one reacts to it and knows that it needs to be sent to email, SMS, push notifications to the phone and all the other million notifications, taking into account all the preferences of users, which usually are. <br><br><img src="https://habrastorage.org/webt/pb/-r/op/pb-ropw5rupxtrrbdfes8_lvp6q.jpeg"><br><br>  Here is the smallest, but important note.  The Jimmy article uses an overload of the SaveChanges method, and it‚Äôs better not to.  And to do it better in the decorator, because if we overload the SaveChanges method and we needed dbContext in the Handler, we will get circular dependencies.  You can work with this, but the solutions are slightly less convenient and a little less beautiful.  Therefore, if the pipeline is built on decorators, then it makes no sense to do it differently. <br><br><h3>  Logging and profiling </h3><br><img src="https://habrastorage.org/webt/bg/nq/m_/bgnqm_jchmmhwbbl7bsvb-binni.jpeg"><br><br>  The nesting of the code remained, but in the original example we had first using MiniProfiler, then try catch, then if.  In total, there were three levels of nesting, now each of this level of nesting is in its decorator.  And inside the decorator, who is responsible for profiling, we have only one level of nesting, the code reads perfectly.  In addition, it is clear that in these decorators only one responsibility.  If the decorator is responsible for logging, then he will only log, if for profiling, respectively, only profiling, everything else is in other places. <br><br><h3>  Response </h3><br>  After the whole pipeline has completed, we just have to take Dto and send further to the browser, serialize JSON. <br><br><img src="https://habrastorage.org/webt/wc/tt/0h/wctt0hneqcetsw0pjtya_s5p5eg.jpeg"><br><br>  But one more small-small such thing that is sometimes forgotten: Exception can happen here at every stage, and in general it is necessary to process them somehow. <br><br><img src="https://habrastorage.org/webt/rh/ns/lh/rhnslhowdccmndavybt1a9pyfmy.jpeg"><br><br>  I can not fail to mention here again Scott Vlashin and his report <a href="https://habr.com/ru/post/339606/">‚ÄúRailway oriented programming‚Äù</a> .  Why?  The original report is entirely devoted to working with errors in the F # language, how to organize the flow a little differently, and why such an approach might be preferable to using Exception.  In F #, this really works very well, because F # is a functional language, and Scott uses the capabilities of a functional language. <br><br><img src="https://habrastorage.org/webt/wd/-7/gg/wd-7ggf6-mg0y1orcgz-2si45ci.jpeg"><br><br>  Since, probably, most of you still write in C #, then if you write <a href="https://habr.com/ru/post/267231/">an analogue in C #</a> , then this approach will look something like this.  Instead of throwing exceptions, we declare a Result class that has a successful branch and an unsuccessful branch.  Accordingly, two designers.  A class can only be in one state.  This class is a special case of a type-association, discriminated union from F #, but rewritten in C #, because there is no built-in support in C #. <br><br><img src="https://habrastorage.org/webt/jo/xu/p2/joxup2i8w_uziwqyawnwp6cty8e.jpeg"><br><br>  Instead of declaring public getters, which someone may not check for null in the code, Pattern Matching is used.  Again, in F # it would be embedded in the Pattern Matching language, in C # you have to write a separate method, to which we will pass one function, which knows what to do with a successful result of the operation, how to transform it further along the chain, and what is wrong.  That is, no matter which branch worked for us, we have to drop it to one return result.  In F #, this all works very well, because there is a functional composition, well, everything else that I have already listed.  In .NET, this works somewhat worse, because once you have more than one Result, and many - and almost every method can fail for one reason or another - almost all of your resulting function types become Result, and you need them as something to combine. <br><br><img src="https://habrastorage.org/webt/vb/s8/wd/vbs8wdzd81uocge3l2louammnwa.jpeg"><br><br>  The easiest way to combine them is to <a href="https://habr.com/ru/post/347284/">use LINQ</a> , because in general LINQ does not only work with IEnumerable, if you define the SelectMany and Select methods correctly, then the C # compiler will see what you can use for these types of LINQ syntax.  In general, tracing paper is obtained from Haskell do-notation or from the same Computation Expressions in F #.  How should this be read?  Here we have three results of the operation, and if everything is good there in all three cases, then take these results r1 + r2 + r3 and add.  The type of the resulting value will also be Result, but the new Result, which we declare in Select.  In general, this is even a working approach, if not for one thing. <br><br><img src="https://habrastorage.org/webt/ez/8d/lw/ez8dlwqtpilfzqbpsp_8zg1udvw.jpeg"><br><br>  For all other developers, as soon as you start writing such C # code, you start to look something like this.  ‚ÄúThese are bad scary Exceptions, don't write them!  They are evil!  It is better to write code that no one understands and cannot debug! ‚Äù <br><br><img src="https://habrastorage.org/webt/v4/v4/vd/v4v4vdhq2reierp3a0diyhtm-ws.jpeg"><br><br>  C # is not F #, it is somewhat different, there are no different concepts on the basis of which this is done, and when we are trying to pull an owl on the globe, it turns out, to put it mildly, it is unusual. <br><br><img src="https://habrastorage.org/webt/ns/w3/q7/nsw3q7lbpx2xqiewao1619j-t1s.jpeg"><br><br>  Instead, you can use the <a href="https://habr.com/ru/post/346308/">built-in normal tools</a> that are documented, that everyone knows and that will not cause developers cognitive dissonance.  ASP.NET has global Handler Exceptions. <br><br><img src="https://habrastorage.org/webt/i8/9i/vk/i89ivkfdyr5w8xmemg2by9qz0zs.jpeg"><br><br>  We know that if there are any problems with validation, you need to return code 400 or 422 (Unprocessable Entity).  If the problem is with authentication and authorization, there are 401 and 403. If something went wrong, then something went wrong.  And if something went wrong and you want to tell the user exactly what, define your Exception type, say it is IHasUserMessage, declare Message getter on this interface and just check: if this interface is implemented, then you can take the message from Exception and pass it to the JSON user.  If this interface is not implemented, it means that there is some kind of system error there, and we will simply say to the users that something went wrong, we are already engaged, we all know - well, as usual. <br><br><h3>  Query Pipeline </h3><br>  With this we finish with the teams and see what we have in the Read-stack.  As for the request, validation, response, it‚Äôs about the same thing, we will not stop separately.  There may be an additional cache here, but in general, there are also no major problems with the cache. <br><br><h3>  Security </h3><br>  We‚Äôll look better at security checks.  There may also be the same Security decorator, which checks whether this query can be made or not: <br><br><img src="https://habrastorage.org/webt/9k/y7/dr/9ky7drwhf3o5tk_r6wcapy4nqaw.jpeg"><br><br>  But there is another case where we print not one record, but print lists, and some users have to display a complete list (for example, some superadminators), and other users we have to display limited lists, the third - limited software. to another, well, and as is often the case in corporate applications, access rights can be extremely sophisticated, so you need to be sure that these lists are not crawled by data that these users do not intend. <br><br>  The problem is solved <a href="https://habr.com/ru/post/414897/">quite simply</a> .  We can add an interface (IPermissionFilter) to which the original queryable comes in and returns a queryable.  The difference is that by that queryable, which is returned, we have already hung up additional where clauses, checked the current user and said: ‚ÄúHere, return to this user only the data that ...‚Äù - and then all your logic related to permission'ami .  Again, if you have two programmers, one programmer goes to write permissions, he knows that he just needs to write a lot of permissionFilters and check that they work correctly for all entities.  And other programmers do not know anything about permission'y, in the list just always pass the correct data, that's all.  Because they receive at the entrance no longer the original queryable from dbContext, but limited by filters.  This permissionFilter also has a layout property, we can add and apply all permissionFilters.  As a result, we obtain the resulting permissionFilter, which will limit the selection of data to the maximum, taking into account all the conditions that are suitable for this entity. <br><br><img src="https://habrastorage.org/webt/25/2o/xj/252oxjpxf1p7zd_aq3nt55cenyi.jpeg"><br><br>  Why not do it with built-in ORM tools, for example, Global Filters in entity framework?  Again, in order not to dwell on all sorts of cyclical dependencies and not to drag in the context any additional story about your business layer. <br><br><h3>  Query Pipeline.  Read Model </h3><br>  It remains to look at the model of reading.  In the CQRS paradigm, the domain model in the reading stack is not used; instead, we simply immediately form the Dto that the browser needs at the moment. <br><br><img src="https://habrastorage.org/webt/2s/kc/0y/2skc0ygq4rmh9rs6cyg5czxa5rm.jpeg"><br><br>  If we are writing in C #, then most likely we are using LINQ, if there are not only some monstrous performance requirements, and if they are, then you may not have a corporate application.  In general, this task can be solved once and for all with LinqQueryHandler.  There is a pretty scary constraint on a generic: this is Query, which returns a list of projections, and it can still filter these projections and sort these projections.  It also works only with some types of entities and knows how to convert these entities to projections and return the list of such projections already in the form of Dto to the browser. <br><br><img src="https://habrastorage.org/webt/8e/vz/ax/8evzaxkzbhqx0mgxfadxacpek24.jpeg"><br><br>  The implementation of the Handle method can be quite simple.  Just in case, let's check if this TQuery filter implements the initial entity.  Further we do a projection, it is AutoMapper's queryable extension.  If someone still does not know, AutoMapper can build projections in LINQ, that is, those who will build the Select method, and not map it in memory. <br><br>  Then we apply filtering, sorting and give it all to the browser.     ,      DotNext,     ,        <a href="https://habr.com/ru/company/jugru/blog/423891/">  </a> ,  , , ,     expression' ,            . <br><br><h3>     <s></s>   SQL </h3><br>  Moving on.  ,       DotNext', ‚Äî      SQL.    Select , ,      ,  queryable-   . <br><br><img src="https://habrastorage.org/webt/3j/ns/3b/3jns3bzz_ebriubturd0ewzzwqg.jpeg"><br><br>      ,    .     ,    Title,  Title      ,     .      ,  .        SubTitle,      ,   ,     -      ,    queryable-   .    ,        . <br><br>      ,    .  ,    ,     .    ,   , .     ¬´JsonIgnore¬ª,     .    ,   ,  Dto.    ,     ,      .       JSON,  ,  Created  LastUpdated   ,  SubTitle ‚Äî   ,   .    ,   ,        ,   , ,       .          ,  -     . <br><br><img src="https://habrastorage.org/webt/uy/el/go/uyelgoxsnf7dzhsv6arfq0q16ly.jpeg"><br><br>      . ,  -,      ,    .    ,  pipeline,     .      ‚Äî      , ,  . ,      SaveChanges,   Query    SaveChanges.      ,    ,          ,   NuGet,         . <br><br>         .     ,    -  ,     ,     .   , ,   , , ,       ‚Äî   . ,  ,      : ¬´    ¬ª, ‚Äî   .  . <br><br><h2>   </h2><br>    ,    ? <br><br><img src="https://habrastorage.org/webt/rj/px/0i/rjpx0ig2zyqa7d9g47vibhbeccy.jpeg"><br><br>    -  .   . <br><br><img src="https://habrastorage.org/webt/d6/ag/p7/d6agp7a_t3m2ppxscq9vb7piagq.jpeg"><br><br>  , ,    ,     .   MediatR  ,         . ,    ,    ‚Äî ,    MediatR   pipeline behaviour.    ,      Request/Response, RequestHandler'      .    Simple Injector,    ‚Äî    . <br><br><img src="https://habrastorage.org/webt/qd/et/4g/qdet4g_b9ezljfr1mx9moe_m18y.jpeg"><br><br>       , ,  ,       ,  TIn: ICommand. <br><br><img src="https://habrastorage.org/webt/su/nb/vn/sunbvndlkmxley6clq7hs4hj70s.jpeg"><br><br>   Simple Injector'      constraint' .     ,    , ,     constraint',        Handler',     constraint. ,     constraint ICommand,      SaveChanges   constraint'  ICommand,  Simple Injector  ,    constraint' ,         Handler'. ,      ,          ,     . <br><br>  ? Simple Injector  MeriatR ‚Äî  ,       ,    Autofac', -,          ,    ,  .  , . <br><br><h2>   ,    </h2><br>          ,   ¬´¬ª. <br><br><img src="https://habrastorage.org/webt/8m/1l/lj/8m1lljzfrx2amaidftyjnthd3yc.jpeg"><br><br>   ,   ¬´Clean architecture¬ª.             . <br><br><img src="https://habrastorage.org/webt/ch/gm/jq/chgmjq7gihsvthnvinnydngrtcw.jpeg"><br><br>  - -     ,   MVC,   ,    . <br><br><img src="https://habrastorage.org/webt/g8/70/wz/g870wzkcrbvqeplit3m_i69uru4.jpeg"><br><br>  ,   ,   ,     Angular, ,       ,      ,    .  ,  : ¬´ ‚Äî MVC-¬ª,  : ¬´    Features,    :     ,    Blog     - Import,    -  ¬ª. <br><br>  , , ,  ,   MVC-,  ,   -  , .    MVC  .    ,   ,      ‚Äî     .       . <br><br><img src="https://habrastorage.org/webt/ix/8v/qo/ix8vqotanjad8uljd2rfz17xygg.jpeg"><br><br><img src="https://habrastorage.org/webt/xq/lj/bv/xqljbvd8zk59n6pdn1-q-x4czhc.jpeg"><br><br>    -     ,  -   -,        . <br><br> -,     ,   .            ,   .   ,          -   ,         User Service,   pull request',     ,       User Service    ,   .    ,      - ,     -  , . -       ,             . <br><br>  .         ,          .  ,    ,             ,   . , ,  ,  ,   ,     ,    ,     -   .    ,      (    ,    ),     ,    ¬´Delete¬ª:   ,      ,  .  . <br><br>          ‚Äî  ¬´¬ª, ,   ,       ,   .          ,    :   ,    ,     ,      .           ,   .      ,    ,   .      ,      ,      . <br><br>   :        .    ¬´ ¬ª,        :     ,     ,         . ,    ,    ,       , ,    ,  ,   .        ,   .  ,   - pull request    ,    ‚Äî  ,    ‚Äî -   ,    .          VCS    :     -  ,    ?       ,    -  ,         ,    . <br><br><img src="https://habrastorage.org/webt/ie/g2/i6/ieg2i6gpy-mp6nsmrvdvxot3x6o.jpeg"><br><br>   , ,    ,   .  :     .        ,     .  ,    ,      ,  ,   .    , ,    ,      . ,  , .    ¬´ ¬ª,        ,     .  ,   ,      ‚Äî  ,      ,   . <br><br>      :    , - , .           .  -      ,    ,  ,   ,  .       -        ,  -        ,      , ,      ,    .    . <br><br><img src="https://habrastorage.org/webt/8g/7g/3h/8g7g3htn43hhoprdfj2thj86wre.jpeg"><br><br> .         ,       IHandler     .    . <br><br>   IHandler    ICommandHandler  IQueryHandler  ,    .    ,     ,       .  ,   CommandHandler,      CommandHandler',       . <br><br>  Why is that?      ,    Query   ,   Query ‚Äî   .      ,     ,  ,    Hander,    CommandHandler  QueryHandler,   -  use case,     . <br><br>  ‚Äî     ,      ,  ,    ,     :  ,  . <br><br>      ,  .         ,    .    ,       -. <br><br>      C# 8,   nullable reference type      .  , , ,     ,  . <br><br>         ChangeTracker' ORM. <br><br>  Exception' ‚Äî     ,     F#,     C#.  ,   -     ,    -   , .        ,   ,      Exception', ,      LINQ,   ,  ,    ,     ,    , Dapper  - , ,  ,   .NET. <br><br>          ,  LINQ,  , permission' ‚Äî   . ,    ,   - ,    ,       .      ,     ‚Äî   . <br><br>          .  : <br><br><hr><br><ul><li> Vertical Slices <br><ul><li> <a href="https://www.youtube.com/watch%3Fv%3DSUiWfhAhgQw">www.youtube.com/watch?v=SUiWfhAhgQw</a> </li><li> <a href="https://www.cuttingedge.it/blogs/steven/pivot/entry.php%3Fid%3D91">www.cuttingedge.it/blogs/steven/pivot/entry.php?id=91</a> </li><li> <a href="https://cuttingedge.it/blogs/steven/pivot/entry.php%3Fid%3D92">cuttingedge.it/blogs/steven/pivot/entry.php?id=92</a> </li></ul><br></li><li>   <br><ul><li> <a href="https://habr.com/post/266937/">habr.com/post/266937</a> </li><li> <a href="https://habr.com/post/205088/">habr.com/post/205088</a> </li><li> <a href="https://habr.com/post/205108/">habr.com/post/205108</a> </li></ul></li><li> Domain Events <br><ul><li> <a href="http://udidahan.com/2009/06/14/domain-events-salvation/">udidahan.com/2009/06/14/domain-events-salvation</a> </li><li> <a href="https://lostechies.com/jimmybogard/2014/05/13/a-better-domain-events-pattern/">lostechies.com/jimmybogard/2014/05/13/a-better-domain-events-pattern</a> </li><li> <a href="https://enterprisecraftsmanship.com/2017/10/03/domain-events-simple-and-reliable-solution/">enterprisecraftsmanship.com/2017/10/03/domain-events-simple-and-reliable-solution</a> </li></ul><br></li><li> DDD: <a href="https://habr.com/post/334126/">habr.com/post/334126</a> </li><li> ROP <br><ul><li> <a href="https://fsharpforfunandprofit.com/rop/">fsharpforfunandprofit.com/rop</a> </li><li> <a href="https://habr.com/post/339606/">habr.com/post/339606</a> </li><li> <a href="https://habr.com/post/347284/">habr.com/post/347284</a> </li></ul><br></li><li> LINQ  Expressions: <br><ul><li> <a href="https://habr.com/company/jugru/blog/423891/">habr.com/company/jugru/blog/423891</a> </li></ul><br></li><li> Clean Architecture: <a href="https://www.youtube.com/watch%3Fv%3DJEeEic-c0D4">www.youtube.com/watch?v=JEeEic-c0D4</a> </li></ul><br><img src="https://habrastorage.org/webt/fm/ik/wu/fmikwu49krcbqw7xbefe1vm6tsq.jpeg"><br><br>   ‚Äî   .      .   ‚Äî     ¬´Domain Modeling Made Functional¬ª,   F#,          F#,      ,     ,     ,        ,      .       C# ,    ,         Exception'. <br><br>  ,  ,   ‚Äî  ¬´Entity Framework Core In Action¬ª.      ,    Entity Framework,         ,     DDD  ORM,   ,   ORM      DDD    . <br><br><blockquote>  Minute advertising. 15-16  2019  .NET- DotNext Piter,      .   <a href="https://dotnext-piter.ru/%3Futm_source%3Dhabr%26utm_medium%3D448526">  </a> ,      <a href="https://dotnext-piter.ru/registration/%3Futm_source%3Dhabr%26utm_medium%3D448526"> </a> . </blockquote></div><p>Source: <a href="https://habr.com/ru/post/447308/">https://habr.com/ru/post/447308/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447292/index.html">14 new products in Visual Studio 2019</a></li>
<li><a href="../447298/index.html">Knowledge management through competency models</a></li>
<li><a href="../447302/index.html">Weekend OS</a></li>
<li><a href="../447304/index.html">Miserly does not pay twice - we tune the memory on the AMD B450 platform and get free performance</a></li>
<li><a href="../447306/index.html">Tesla's transformer on a single square inch board</a></li>
<li><a href="../447310/index.html">How do we go from web development to game development</a></li>
<li><a href="../447314/index.html">What I understood about building a business, having worked for seven years at Airbnb</a></li>
<li><a href="../447318/index.html">Flea Gadgets: Why Buy a Packard Bell 20-Year Laptop for 10 Euros</a></li>
<li><a href="../447322/index.html">Principles of building a REST JSON API</a></li>
<li><a href="../447324/index.html">How does the computer inside the Hayabusy-2, which dropped a bomb on Ryuga. And photos of its developers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>