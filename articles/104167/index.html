<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Undo / Redo - Tail wags the dog</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we will continue to talk about how we did Undo / Redo in the XtraRichEdit text editor. 

 It all started with the fact that our team ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Undo / Redo - Tail wags the dog</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/31fbde8b/ba3793e8/b267c7f3/6fec4dc9.png" align="left"><br>  In this article, we will <a href="http://habrahabr.ru/company/devexpress/blog/104163/">continue to talk</a> about how we did Undo / Redo in the <a href="http://devexpress.com/XtraRichEdit">XtraRichEdit</a> text editor. <br><br>  It all started with the fact that our team gave the source code of the text editor concept with the wish to bring this concept to mind.  Despite the fact that only a month was spent on developing the concept, he knew a lot: you could enter and delete text, move the cursor horizontally and vertically. <br><br>  It remained for us to add the possibility of formatting sections of text (font, its size, etc.) and all the other ‚Äútrifles‚Äù such as paragraphs with all their properties, styles, etc.  And the concept did not know how to do Undo / Redo. <br><a name="habracut"></a><br>  During the two weeks that I had to delve into the sources of the concept, it finally became clear that the only way to tie Undo / Redo to it without rewriting it from scratch is to save the entire document state for every action: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DocumentHistoryItem</span></span> : <span class="hljs-title"><span class="hljs-title">HistoryItem</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DocumentState previousState; <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DocumentState nextState; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DocumentHistoryItem</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DocumentState previousState, DocumentState nextState</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.previousState = previousState; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.nextState = nextState; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Undo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Document document</span></span></span><span class="hljs-function">)</span></span> { document.ApplyState(previousState); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Redo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Document document</span></span></span><span class="hljs-function">)</span></span> { document.ApplyState(nextState); } }</code> </pre> <br>  This, of course, was unacceptable, because  this approach would use too much memory.  Imagine a document of at least 1 megabyte.  The task for the second-grader: how many keys must be pressed before the memory runs out, if each keystroke leads to a change in the document and entry in the undo buffer? <br><br>  Why couldn‚Äôt it be possible to screw Undo / Redo in a more acceptable way?  The fact is that when they developed the concept, they did not initially take into account the future implementation of Undo / Redo.  All text operations were implemented in such a way that performing the reverse operation was rather problematic.  Moreover, the very organization of storing text and the properties of its individual sections (font, text size, etc.) turned out to be extremely inconvenient for implementing Undo / Redo.  For each operation, it was necessary to save a fairly large amount of data. <br><br>  For example, it was not difficult to save data on changing the font name.  For this, it was necessary to save the old and new font name in order to be able to both undo and redo actions.  Similarly, for the font size - it was necessary to keep the old and new sizes.  However, if the name of the font and its size were changed in one action (for example, in the Font dialog), then it was necessary to save 2 elements in the undo buffer.  But apart from the actual name of the font and its size, it was necessary to store information to which part of the text these values ‚Äã‚Äãshould be applied. <br><br>  In the end, having made several unsuccessful attempts to integrate Undo / Redo into the existing code, we came to the conclusion: in order to avoid problems with Undo / Redo, it is necessary to redesign data structures and algorithms in a special way. <br><br>  It was decided that every user action on the document should be transformed into a sequence of elementary operations on the document.  Each such operation must be so elementary that it could be very easy for it to implement the inverse operation.  Such an operation also stores the minimum necessary amount of data necessary for its direct and reverse execution.  Elementary operations are packed into a single composite element and placed in an undo buffer: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CompositeHistoryItem</span></span> : <span class="hljs-title"><span class="hljs-title">HistoryItem</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> List&lt;HistoryItem&gt; items = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;HistoryItem&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddItem</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HistoryItem item</span></span></span><span class="hljs-function">)</span></span> { items.Add(item); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UndoCore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = items.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; i--) items[i].Undo(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RedoCore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = items.Count; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; count; i++) items[i].Redo(); } }</code> </pre> <br>  Note that the rollback of the elements of a composite operation is performed in the reverse order, and the roll forward is performed in the direct order. <br><br>  In order to break down actions into elementary operations, we had to organize data structures in a special way.  We divided the text inside paragraphs into intervals so that the formatting of the text inside each interval was the same. <br><br><img src="http://habrastorage.org/storage/02c18c91/ddbe3443/917f57ff/7d6000f8.png"><br><br>  When changing the formatting of an arbitrary selected text, the text was first divided into intervals according to the selection, and then the formatting of those intervals that were inside the selection was changed.  Thus, 3 elementary operations ‚Äúsplit interval‚Äù, ‚Äúmerge 2 neighboring intervals‚Äù and ‚Äúchange interval formatting‚Äù were selected. <br><br>  The last elementary operation deserves separate consideration.  To minimize the amount of data stored in the undo buffer, the object containing the text properties in the interval was divided into two sub-objects: variable (CharacterFormattingBase) and immutable (CharacterFormattingInfo).  Immutable objects were stored in the cache-list (CharacterFormattingInfoCache), and the elements of the list were unique and were never removed from the list.  Editable objects stored only an index of the immutable object in the list. <br><br><img src="http://habrastorage.org/storage/b0d7fcfe/630aa7f2/18a8993d/439aef49.png"><br><br>  This allowed changing any property (or several properties at once, this is a matter of technology) of a variable object to be reduced to searching the index cache for a suitable immutable object and storing it in the variable object.  If a suitable object could not be found, then it was created and added to the cache. <br><br>  Using this approach, we achieved only 2 indices, old and new, in the undo buffer to change any number of interval properties (of course, within a single transaction). <br><br>  At first glance, it seems that the ever-growing cache makes irrational use of memory.  But in reality it is not.  The fact is that there are not so many different combinations of text properties in real documents.  Moreover, most of the text, as a rule, has the same formatting.  And instead of duplicating all the values ‚Äã‚Äãof the properties responsible for formatting in each interval, we duplicate only the index of a single object in the cache. <br><br>  And finally, consider an example of an action and its division into elementary operations. <br><br>  Initially there is a solid and only part of the text: <br><br><img src="http://habrastorage.org/storage/f47a6ea8/64f1b2e9/15852f4f/a5bad4f2.png"><br><br>  Bold out some of the text "Wor". <br><br>  This action can be divided into 3 elementary operations: <br><br>  We divide the text section into 2 adjacent sections. <br><br><img src="http://habrastorage.org/storage/3076ea10/f9cc0606/07d1af3e/f7bc3792.png"><br><br>  We divide the right part of the text into 2 more sections. <br><br><img src="http://habrastorage.org/storage/f141246a/255bf2a8/f98a897b/b2d6cf6a.png"><br><br>  For the section with index 1, we use bold typeface. <br><br><img src="http://habrastorage.org/storage/4f259f6a/f82ce8a6/1e67d565/cfd8a71f.png"><br><br>  Each of the operations is extremely simple, easily reversible and stores a minimum of data.  So, for the operation of cutting a section of text, it is enough to keep the index of the section being cut and the index of the letter on the section before which the section will occur.  The operation of applying the font style saves the number of a section of the text (run index), as well as the old and new indices of CharacterFormattingInfo objects in the cache. <br><br>  It turns out that Undo / Redo dictates us how best to organize data.  Namely: the text should be divided into sections so that the entire text of one section had strictly the same formatting.  Parcels must be numbered.  It is with this organization of the data that a natural and simple splitting of the action into elementary operations is achieved.  And this, in turn, leads to a simplified implementation of Undo / Redo and minimizes the amount of data that needs to be stored. <br><br>  When developing <a href="http://devexpress.com/XtraRichEdit">XtraRichEdit,</a> we initially began to use the ‚Äúfrom Undo / Redo‚Äù approach.  When designing each action, we first of all thought through how to put this action into the Undo / Redo concept, what elementary operations to break it into, and how to get by with the minimum amount of data stored in the memory.  This allowed us to create a simple document model in implementation that uses memory efficiently and does not require significant computational resources both when traversing the model during document formatting and when making a variety of changes to it. <br><br>  <a href="http://habrahabr.ru/company/devexpress/blog/104163/">Previous article on this topic</a> |  <a href="http://habrahabr.ru/company/devexpress/blog/104168/">Next article on this topic</a> </div><p>Source: <a href="https://habr.com/ru/post/104167/">https://habr.com/ru/post/104167/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../104159/index.html">History of one keyboard</a></li>
<li><a href="../104161/index.html">OS / 2 Death</a></li>
<li><a href="../104163/index.html">Undo / Redo - The Illusion of Simplicity</a></li>
<li><a href="../104164/index.html">Toast on Programmer's Day</a></li>
<li><a href="../104165/index.html">Moscow City Duma proposes to prohibit torrents and penalize users</a></li>
<li><a href="../104168/index.html">What else is Undo / Redo capable of?</a></li>
<li><a href="../104169/index.html">Opera 10.70 (Win / Mac / Linux | 9046) September 8 and 13</a></li>
<li><a href="../104170/index.html">Microsoft will support Russian public organizations with free software</a></li>
<li><a href="../104171/index.html">Understanding node.js</a></li>
<li><a href="../104172/index.html">Exceptions and performance</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>