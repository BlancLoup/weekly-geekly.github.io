<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ten examples of how not to write PAC files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 


 Virtually any implementation of a Web Security Gateway, be it a cloud-based SaaS solution, such as Zscaler or an on-premises applianc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ten examples of how not to write PAC files</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/4ff/3a2/31d/4ff3a231d61a430ba5f7ba0d884fb204.jpg" alt="image"></p><br><h4 id="vvedenie">  Introduction </h4><br><p>  Virtually any implementation of a Web Security Gateway, be it a cloud-based SaaS solution, such as Zscaler or an on-premises appliance, such as Cisco WSA (IronPort), can‚Äôt do without configuring proxy servers in browsers with certain cases and therefore I often come across with proxy auto configuration files (PAC, proxy auto configuration).  In this article I would like to consider a few examples of optimizing their performance. </p><br><h4 id="zachem-nuzhna-eta-statya">  Why this article is needed </h4><br><p>  Why did I decide to write this article and is there any benefit in it?  I hope so, and here is why.  Essentially, the PAC file is a JavaScript function that matches the string / substring of url / host fields, which returns the proxy server name for the resource or tells the browser to use direct access to the resource bypassing the proxy.  Like any programming language, JavaScript code can also be optimized for execution.  In the conditions of large companies / enterprises with a complex, distributed infrastructure of access to the Internet and, as a result, PAC-files consisting of several hundred lines of code, the task of optimizing PAC-files no longer seems to be absolutely useless, because, for example , the percentages of the execution time of a single non-optimal or irrelevant function will obviously be multiplied by the number of its occurrences (applications) in the code. </p><br><p>  <em>Further under the cut.</em> </p><br><a name="habracut"></a><br><h4 id="disclaimer">  Disclaimer </h4><br><p>  This article does not intend to describe in detail the functions used in the PAC-files.  For a more detailed description of each function, I recommend to apply for help, for example, to the site <a href="http://findproxyforurl.com/">http://findproxyforurl.com</a> .  The results of the performance tests of various browsers in this article can be controversial and in no case do not claim to be the absolute truth, however, the author tried to exert maximum efforts in order to achieve a truthful result.  However, for the reason indicated by the controversy, the summary results of the tests are not given - the reader is asked to verify for himself the advantage of using one or another approach.  For this, wherever possible, references to tests will be given.  In my research, I primarily relied on the jsperf.com resource, which, by the way, if you have an account on github, you can create test scripts and measure the performance of the JavaScript code, this is where the test scripts for this article will be stored. </p><br><p>  Well, let's get down to business. </p><br><h4 id="primer-pervyy">  Example one </h4><br><p>  The first in my list is the simplest case when you need to choose a proxy for a strictly specific host.  Very often colleagues for some reason use in this case, checking the url out of place or framing the string "*".  This often happens when the PAC-file is already over a hundred lines and someone adds by analogy a new condition like the following: </p><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(url,<span class="hljs-string"><span class="hljs-string">"*cisco.com*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'PROXY MyProxy1:3128'</span></span>;</code> </pre> <br><p>  or so with the host: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(host,<span class="hljs-string"><span class="hljs-string">"cisco.com"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'PROXY MyProxy1:3128'</span></span>;</code> </pre> <br><p>  The problem here is not even that for Chrome 58 and IE11 the first version is almost 1% slower (for Firefox 53 there is almost no difference between them), the worst thing here is that, I hope, many of the readers guessed that for the URL, for example, ‚Äú <a href="">http://www.noncisco.com/evil/cisco.com</a> ‚Äù <strong>both</strong> results will return true.  The solution to the problem is very simple - do not use the shExpMatch function, which is not intended for this, but instead look for an exact match: </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (host == <span class="hljs-string"><span class="hljs-string">'www.cisco.com'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'PROXY MyProxy1:3128'</span></span>;</code> </pre> <br><p>  The downside here is also obvious.  The code above returns false for <a href="http://cisco.com/">http://cisco.com</a> , although, of course, no one bothers you to do two checks: </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((host == <span class="hljs-string"><span class="hljs-string">'www.cisco.com'</span></span>) || (host == <span class="hljs-string"><span class="hljs-string">'cisco.com'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'PROXY MyProxy1:3128'</span></span>;</code> </pre> <br><p>  Actually, the link to the test, for those who want to be convinced of the performance: <a href="https://jsperf.com/inefficient-shexpmatch">https://jsperf.com/inefficient-shexpmatch</a> </p><br><p>  By the way, how to test PAC-files?  Do not actually go through them manually in the browser?  Although this method will be ultimatum, I still use the resource <a href="http://home.thorsen.pm/proxyforurl">http://home.thorsen.pm/proxyforurl</a> for these purposes, which has not yet let me down and did not deceive me. </p><br><h4 id="primer-vtoroy">  Example two </h4><br><p>  Problem number two is very close in its essence to what we have considered above, and here again they use the function I dislike. <del>  default </del>  shExpMatch. <br>  The task is to use MyProxy2 for a specific domain.  What they do: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(host, <span class="hljs-string"><span class="hljs-string">"*.linkedin.com"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'PROXY MyProxy2:3128'</span></span>;</code> </pre> <br><p>  Again, not optimal, not exactly out of place.  We use the function </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dnsDomainIs(host,<span class="hljs-string"><span class="hljs-string">".linkedin.com"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'PROXY MyProxy2:3128'</span></span>;</code> </pre> <br><p>  Although, strictly speaking, for FF and Chrome browsers, these functions are almost equal in performance, for IE11 this is significant and the difference is more than 1%. <br>  Actually, the test: <br>  <a href="https://jsperf.com/dnsdomainis-vs-shexpmatch">https://jsperf.com/dnsdomainis-vs-shexpmatch</a> </p><br><h4 id="primer-tretiy">  Example three </h4><br><p>  Problem number three, which often arises due to the inattention of administrators, is in duplicate conditions.  Example: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(host, <span class="hljs-string"><span class="hljs-string">"192.168.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(host, <span class="hljs-string"><span class="hljs-string">"10.*.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isInNet(host, <span class="hljs-string"><span class="hljs-string">"192.168.88.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"255.255.255.0"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(url, <span class="hljs-string"><span class="hljs-string">"*10.10.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>;</code> </pre> <br><p>  Not only do the conditions duplicate (overlap) each other, they still don‚Äôt work out in principle if the user enters the domain name and not the ipv4 address in the address bar of the browser.  The solution is to eliminate duplicate conditions and perform name resolution, at least as follows: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"192.168.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"10.*.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>;</code> </pre> <br><h4 id="primer-chetvertyy">  Example four </h4><br><p>  Actually, problem number four is the development of what is described in the previous section.  Let the administrator wish for all subnets in the RFC1918 range to direct clients to bypass the proxy and do this: </p><br><pre> <code class="javascript hljs">‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"192.168.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"10.*.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"172.16.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"172.17.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"172.18.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"172.19.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"172.20.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"172.21.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"172.22.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"172.23.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"172.24.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"172.25.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"172.26.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"172.27.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"172.28.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"172.29.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"172.30.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(dnsResolve(host), <span class="hljs-string"><span class="hljs-string">"172.31.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; ‚Ä¶</code> </pre> <br><p>  Needless to say, it suggests once to resolve the name and then work with a variable in which the result will be written: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resolved_ip = dnsResolve(host); ... else <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"192.168.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"10.*.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.16.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.17.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.18.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.19.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.20.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.21.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.22.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.23.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.24.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.25.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.26.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.27.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.28.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.29.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.30.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.31.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; ...</code> </pre> <br><p>  Instead of 18 name resolution requests, in the worst case (for the last else if), we get predictable performance and ask for name resolution only once, which is undoubtedly more efficient without any additional tests. </p><br><h4 id="primer-pyatyy">  Fifth example </h4><br><p>  We continue our optimization recursion.  The block of code from the previous problem already due to its size suggests itself for optimization.  Suppose the function initially looked like this: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindProxyForURL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, host</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resolved_ip = dnsResolve(host); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"127.*.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"192.168.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"0.*.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"10.*.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.16.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.17.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.18.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.19.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.20.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.21.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.22.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.23.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.24.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.25.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.26.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.27.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.28.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.29.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.30.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"172.21.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"169.254.*.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(resolved_ip, <span class="hljs-string"><span class="hljs-string">"192.88.99.*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; ... }</code> </pre> <br><p>  Even if we optimize the code above and use logical or (||) instead of else if, according to the test results among the three browsers mentioned above, the most optimal was to use the regular expression test as follows: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindProxyForURL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, host</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> privateIP = <span class="hljs-regexp"><span class="hljs-regexp">/^(0|10|127|192\.168|172\.1[6789]|172\.2[0-9]|172\.3[01]|169\.254|192\.88\.99)\.[0-9.]+$/</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resolved_ip = dnsResolve(host); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (privateIP.test(resolved_ip)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; } }</code> </pre> <br><p>  Note that this is not only more efficient, but also looks more compact and sleeker.  But there is no limit to perfection, and if you use the specialized function IsInNet, you can achieve even more impressive results.  Compared to the previous example, the code below gives a performance boost of 0.2 to 2% in various browsers: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindProxyForURL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, host</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resolved_ip = dnsResolve(host); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((isInNet(resolved_ip , <span class="hljs-string"><span class="hljs-string">"192.168.0.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>)) || (isInNet(resolved_ip , <span class="hljs-string"><span class="hljs-string">"172.16.0.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"255.240.0.0"</span></span>)) || (isInNet(resolved_ip , <span class="hljs-string"><span class="hljs-string">"10.0.0.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"255.0.0.0"</span></span>)) || (isInNet(resolved_ip , <span class="hljs-string"><span class="hljs-string">"127.0.0.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"255.0.0.0"</span></span>)) || (isInNet(resolved_ip , <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"255.0.0.0"</span></span>)) || (isInNet(resolved_ip , <span class="hljs-string"><span class="hljs-string">"169.254.0.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>)) || (isInNet(resolved_ip , <span class="hljs-string"><span class="hljs-string">"192.88.99.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"255.255.255.0"</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; }</code> </pre> <br><p>  Here you can repeat the test itself: <a href="https://jsperf.com/privateip-test-vs-shexpmatch">https://jsperf.com/privateip-test-vs-shexpmatch</a> </p><br><h4 id="primer-shestoy">  Example Six </h4><br><p>  A slight departure from the main line for a change.  Consider the two lines of code below: </p><br><pre> <code class="javascript hljs">dnsDomainIs(<span class="hljs-string"><span class="hljs-string">"www.notmycompany.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"mycompany.com"</span></span>) dnsDomainIs(<span class="hljs-string"><span class="hljs-string">"www.MyCompany.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"mycompany.com"</span></span>)</code> </pre> <br><p>  If the first line returns expected true (yes, yes, it is true, this is just a search for a substring!), The second line, despite the apparent exact match, due to the difference in uppercase letters will return false (by the way, it seems like in FF version 52, the result would still be true, but the author read it somewhere on the network and did not check it himself). </p><br><p>  Thus, to solve the problem, it is highly desirable to perform the conversion of the url and host string at the very beginning of the PAC file, if later we work with them, for example, like this: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url_lc = url.toLowerCase(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> host_lc = host.toLowerCase();</code> </pre> <br><p>  And then work only with url_lc and host_lc. </p><br><h4 id="primer-sedmoy">  Example Seven </h4><br><p>  Very simple problem, but from that not less widespread.  As well as many problems, arises due to inattention, the example below is taken from the real case of introduction, but the names, of course, are fictional and any coincidences are pure coincidence: </p><br><pre> <code class="javascript hljs">... else <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(host, <span class="hljs-string"><span class="hljs-string">"files.company.ru"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY companyproxy7:3128"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(host, <span class="hljs-string"><span class="hljs-string">"mail.company.ru"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY companyproxy7:3128"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(host, <span class="hljs-string"><span class="hljs-string">"company.com"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY companyproxy7:3128"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(url, <span class="hljs-string"><span class="hljs-string">"*downloads*.company.com*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY companyproxy7:3128"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(host, <span class="hljs-string"><span class="hljs-string">"global.company.com"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY companyproxy7:3128"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(host, <span class="hljs-string"><span class="hljs-string">"db.company.com"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY companyproxy7:3128"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(host, <span class="hljs-string"><span class="hljs-string">"test.company.com"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY companyproxy7:3128"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(host, <span class="hljs-string"><span class="hljs-string">"blog.company.com"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY companyproxy7:3128"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(host, <span class="hljs-string"><span class="hljs-string">"servicedesk.company.com"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY companyproxy7:3128"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(url, <span class="hljs-string"><span class="hljs-string">"*training.company.com*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY companyproxy7:3128"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(url, <span class="hljs-string"><span class="hljs-string">"*farm.company.com*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY companyproxy7:3128"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(host, <span class="hljs-string"><span class="hljs-string">"*.fa.company.com"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY companyproxy7:3128"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(url, <span class="hljs-string"><span class="hljs-string">"https://servicedesk.company.com/*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY companyproxy7:3128"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shExpMatch(url, <span class="hljs-string"><span class="hljs-string">"https://servicedesk.company.com:8080/*"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY companyproxy7:3128"</span></span>; ‚Ä¶</code> </pre> <br><p>  And at the end of the file we see something like (and even with a comment!): </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* Default Traffic Forwarding */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY companyproxy7:3128"</span></span>;</code> </pre> <br><p>  In addition to the problems that we have already discussed earlier, the block of code above is completely useless and only slows down the browser, because in the end, the same proxy server is used by default. </p><br><h4 id="primer-vosmoy">  Example Eight </h4><br><p>  Problem number eight is related to the internal resources of the company. <br>  Let's say we have this code: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (host == <span class="hljs-string"><span class="hljs-string">'internal'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'DIRECT'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (host == <span class="hljs-string"><span class="hljs-string">'mail'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'DIRECT'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (host == <span class="hljs-string"><span class="hljs-string">'files'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'DIRECT'</span></span>;</code> </pre> <br><p>  That is, the PAC file checks whether the browser has accessed the internal resource by hostname without specifying a domain, since the search domains are set on the PC.  A good solution for optimizing such checks is to use only one function: </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isPlainHostName(host)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'DIRECT'</span></span>;</code> </pre> <br><h4 id="primer-devyatyy">  Example nine </h4><br><p>  The optimization problem number 9 is close to the previous one and again appears when using the internal resources of the organization.  What to do if a user can request the same site with or without a domain, as in the example below? </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (host == <span class="hljs-string"><span class="hljs-string">'mail'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'DIRECT'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (host == <span class="hljs-string"><span class="hljs-string">'mail.resource.lan'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'DIRECT'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (host == <span class="hljs-string"><span class="hljs-string">'files'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'DIRECT'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (host == <span class="hljs-string"><span class="hljs-string">'files.resource.lan'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'DIRECT'</span></span>;</code> </pre> <br><p>  It is quite simple to optimize such checks if you use the localHostOrDomainIs function: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (localHostOrDomainIs(host, <span class="hljs-string"><span class="hljs-string">"mail.resource.lan"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'DIRECT'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (localHostOrDomainIs(host, <span class="hljs-string"><span class="hljs-string">"files.resource.lan‚Äù) return 'DIRECT';</span></span></code> </pre> <br><h4 id="primer-desyatyy">  Example ten </h4><br><p>  The controversial problem of optimizing if conditions.  The bottom line is that in the PAC-files after checking for any if condition in the overwhelming majority of cases, there is a return from the FindProxyForURL function on return, so why use the construction below? </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> .. else <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> .. else</code> </pre> <br><p>  FF test results suggest that using the OR conditions (||) is optimal: </p><br><p><img src="https://habrastorage.org/web/2a3/c0a/2f2/2a3c0a2f28ae432b9d09a217e8135529.png" alt="image"></p><br><p>  For Chrome, the result will be somewhat different, but the if / else if block loses again: </p><br><p><img src="https://habrastorage.org/web/bef/34a/da0/bef34ada08254387bc37373b4b35bc74.png" alt="image"></p><br><p>  The reader can repeat the test for his surroundings here: <a href="https://jsperf.com/shexpmatch-vs-host-string-vs-dnsdomainis">https://jsperf.com/shexpmatch-vs-host-string-vs-dnsdomainis</a> </p><br><p>  Based on the above, we conclude that it would be more optimal to use an if statement or if + or, although testing IE11 gives a completely opposite result.  Perhaps it would be a good idea to use the switch statement, but I‚Äôm already adding this opus deep at night, and therefore I donate testing this case to the mercy of a highly respected reader. </p><br><h4 id="vmesto-zaklyucheniya">  Instead of conclusion </h4><br><p>  Instead of concluding, I would like to thank the reader if he has mastered this small work to the end and I sincerely hope that he will be useful not only as tips in optimization, but also more as a source of new knowledge or ideas in working with the access infrastructure on the Internet for the enterprise. </p><br><h4 id="poleznye-ssylki">  useful links </h4><br><p>  ‚Üí <a href="http://www.cisco.com/c/en/us/td/docs/security/web_security/connector/connector2972/PACAP.html">Cisco Systems about PAC files</a> <br>  ‚Üí <a href="http://findproxyforurl.com/">Useful site with a description of the functions used in the PAC-files</a> <br>  ‚Üí A <a href="https://jsperf.com/">website that provides a convenient interface for testing the performance of JavaScript code</a> <br>  ‚Üí <a href="http://home.thorsen.pm/proxyforurl">Here you can check the logic of the PAC file</a> <br>  ‚Üí <a href="http://www.jslint.com/">Another resource where you can debug JavaScript code, including PAC files</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/328316/">https://habr.com/ru/post/328316/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328304/index.html">Hi, SaaS | 5 reasons to stay with amoCRM</a></li>
<li><a href="../328306/index.html">What should a network engineer know? Check list</a></li>
<li><a href="../328308/index.html">The best tricks of minimal design</a></li>
<li><a href="../328310/index.html">Hackathon BlockchainLaB, May 26-27</a></li>
<li><a href="../328314/index.html">On the appearance of spirals in a cyclic cellular automaton</a></li>
<li><a href="../328318/index.html">One company - one site?</a></li>
<li><a href="../328320/index.html">Java 9 exit postponed again</a></li>
<li><a href="../328322/index.html">How to get an offer on the day of the interview and not wait a hundred years</a></li>
<li><a href="../328324/index.html">Results of cyber activity in Q1 2017</a></li>
<li><a href="../328326/index.html">Android + Gradle + CI + CD or How to set up a cat feeder</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>