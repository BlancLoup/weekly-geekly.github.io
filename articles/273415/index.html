<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Artistic approach to downloading images</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I, as an artist and web developer, eventually had a need for their own gallery. Usually, galleries have two main functions: display of the showcase - ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Artistic approach to downloading images</h1><div class="post__text post__text-html js-mediator-article">  I, as an artist and web developer, eventually had a need for their own gallery.  Usually, galleries have two main functions: display of the showcase - all (or some) of the paintings - and a detailed display of one.  The implementation of both functions is in almost any ready-made gallery.  But the ‚Äúworn out‚Äù appearance of the finished galleries and, having become the standard, the user interface is not suitable for the artist :).  And non-standard - it requires a special architecture and implementation of the code that loads and displays the pictures.  I will omit the display and user interface in this article.  The focus will be given to downloading pictures from the server.  The final organization of controlled loading using queues, asynchronous loader, processing of blob objects, promise cascades and with the possibility of suspension will be discussed. <br><br> <a href="http://habrahabr.ru/company/taggy/blog/273415/"><img src="https://habrastorage.org/files/7c0/d38/c78/7c0d38c78a7a408aae95dea67f6dd260.jpg"></a> <br><br>  Code samples written on coffeeScript <br><a name="habracut"></a><br><h2>  Tasks </h2><br><ol><li>  Loading all the paintings of the storefront takes time.  The instant appearance of all is impossible.  And the first appearance of pictures that the user will immediately see is possible. <br>  Therefore, one of the tasks was the ability to download pictures in the desired sequence.  My gallery is visually centro-oriented, hence the loading order is centrifugal, first the pictures are loaded in the center of the screen, and then the rest are spread out in circles.  Thus, small screens are filled quickly enough, and large screens allow access to view controls in the shortest possible time (the controls for moving and moving to a detailed view are concentrated around the central picture). <br></li><li>  Another task was the ability to pause the loading of images for the page from which they leave, without waiting until absolutely everything is loaded on it to immediately start loading data for the page that they are coming to.  To do this, you need to pause the sending of requests, remember which pictures did not load, and after returning to the previous page, resume the download. <br></li></ol>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For this, a three-tier architecture was applied: <br>  application -&gt; download manager -&gt; asynchronous loader <br> <a href=""><img src="https://habrastorage.org/files/969/638/e84/969638e844394659a07a4962dbbdc2c8.jpg"></a> <br><br><h2>  Application level </h2><br>  The application consistently receives the url of pictures that need to be downloaded and drawn on the screen.  The way urls are supplied is not interesting.  For each future picture, the application creates a DOM node img or div with a background. <br><pre><code class="coffeescript hljs">imgNode = ($ <span class="hljs-string"><span class="hljs-string">'&lt;div&gt;'</span></span>) .addClass(<span class="hljs-string"><span class="hljs-string">'item'</span></span> + num)</code> </pre> <br>  After that, he gives the task to the download manager, passing him the url of the pictures from the server.  The manager returns a promise ( <a href="https://api.jquery.com/deferred.promise/">jQuery promise</a> ), during which we will get the url before the blob instance with the loaded image data stored in the browser memory (the url will go to imgBlobUrl).  This is a new <a href="https://developer.mozilla.org/en-US/docs/Web/API/URL/createObjectURL">feature that appeared in HTML5, which allows you to create urls</a> to instances <a href="https://developer.mozilla.org/en/docs/Web/API/Blob">of the File or Blob classes</a> obtained in this case as a result of an ajax request. <br><pre> <code class="coffeescript hljs"> loadingIntoLocal = @downloadMan.addTask image.url <span class="hljs-comment"><span class="hljs-comment">#       done,  imgNode    ,       ((imgNode) -&gt; loadingIntoLocal.done (imgBlobUrl) -&gt; imgNode.attr(src: imgBlobUrl) )(imgNode)</span></span></code> </pre><br><br><h2>  Download Manager Level </h2><br>  The boot manager manages the queue of jobs ( <a href="https://habrahabr.ru/users/queue/" class="user_link">queue</a> ).  Each task indicates: which url should be downloaded, which promise we will fulfill when we get the result, and, optionally, the number of the download attempt for a non-first-time-successful download.  As soon as the task arrives, we put it in a queue, create a promise and return this promise to the application, so that it is not boring to wait.  We start tasks. <br><pre> <code class="coffeescript hljs"> addTask : <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(url)</span></span></span><span class="hljs-function"> -&gt;</span></span> downloading = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> $.Deferred() task = { url: url, promise: downloading numRetries: <span class="hljs-number"><span class="hljs-number">0</span></span> } @queue.push task @runTasks()</code> </pre><br>  To make the most efficient use of the channel, we will run several XMLHttpRequests simultaneously.  The browser allows you to do this.  Therefore, the @runTasks () method should ensure that at each moment in time there is not one, but N requests.  In my case, 3 rickshaws were chosen experimentally.  If there are free rickshaws, then we give the next task from the queue for execution. <br><pre> <code class="coffeescript hljs"> runTasks: <span class="hljs-function"><span class="hljs-function">-&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@curTaskNum &lt; @maxRunningTasks) &amp;&amp; !@paused @runNextTask()</code> </pre><br> <a href=""><img src="https://habrastorage.org/files/6ee/482/695/6ee48269536545f0a0d499f4bea30506.jpg"></a> <br><br>  "Rickshaw" takes the next task and using the asynchronous loader pulls up the image from the server, receiving the blob url. <br><pre> <code class="coffeescript hljs"> runNextTask: <span class="hljs-function"><span class="hljs-function">-&gt;</span></span> task = @queue.shift() @curTaskNum++ downloading = @asyncLoader.loadImage task.url</code> </pre><br>  As soon as the loader fulfills its promise, one of the rickshaws is released, and if there are still jobs in the queue, then the @runNextTask () method starts the following.  In this case, we report upward that the promise made to the application is fulfilled. <br><pre> <code class="coffeescript hljs"> downloading.done (imgBlobUrl) =&gt; task.promise.resolve imgBlobUrl @curTaskNum-- <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> @queue.length != <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; !@paused @runNextTask()</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Manager code (simplified version)</b> <div class="spoiler_text"><pre> <code class="coffeescript hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DownloadManager</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">constructor</span></span></span><span class="hljs-class">: -&gt; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">queue</span></span></span><span class="hljs-class"> = [] @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">maxRunningTasks</span></span></span><span class="hljs-class"> = 3 @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">curTaskNum</span></span></span><span class="hljs-class"> = 0 @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paused</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">asyncLoader</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncLoader</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addTask</span></span></span><span class="hljs-class"> : (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class">) -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">downloading</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">$</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Deferred</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task</span></span></span><span class="hljs-class"> = { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">promise</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">downloading</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">numRetries</span></span></span><span class="hljs-class">: 0 } @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">queue</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">push</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runTasks</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">downloading</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runTasks</span></span></span><span class="hljs-class">: -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">curTaskNum</span></span></span><span class="hljs-class"> &lt; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">maxRunningTasks</span></span></span><span class="hljs-class">) &amp;&amp; !@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paused</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runNextTask</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runNextTask</span></span></span><span class="hljs-class">: -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">queue</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shift</span></span></span><span class="hljs-class">() @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">curTaskNum</span></span></span><span class="hljs-class">++ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">numRetries</span></span></span><span class="hljs-class">++ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">downloading</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">asyncLoader</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">loadImage</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">downloading</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">done</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">imgBlobUrl</span></span></span><span class="hljs-class">) =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">promise</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resolve</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">imgBlobUrl</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">curTaskNum</span></span></span><span class="hljs-class">-- </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">queue</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class"> != 0 &amp;&amp; !@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paused</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runNextTask</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">downloading</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fail</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">numRetries</span></span></span><span class="hljs-class"> &lt; 3 @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">addTask</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pause</span></span></span><span class="hljs-class">: -&gt; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paused</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resume</span></span></span><span class="hljs-class">: -&gt; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paused</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runTasks</span></span></span><span class="hljs-class">()</span></span></code> </pre><br></div></div><br>  However, with this implementation of the pause through a flag indicating whether the next task can be started, stopping the download works roughly.  If the transition to another page occurred at the moment when loading was full on all pairs in three streams, then the interruptions of the current tasks do not occur, the following ones simply do not start. <br>  The implementation of a pause that makes XMLHttpRequest.abort () to tasks that are being executed is described in the ‚ÄúClever Pause‚Äù section. <br><br><h2>  Asynchronous Loader Level </h2><br>  The asynchronous loader is the lowest level of our architecture, this is the ‚Äútrain station‚Äù that sends XMLHttpRequest and accepts binary image data with subsequent placement in the ‚Äúfast access warehouse‚Äù. <br> <a href=""><img src="https://habrastorage.org/files/ffe/772/938/ffe7729386f042feb9c0ee576eb2ecc8.jpg"></a> <br><br>  We equip the "rickshaw" in a new trip and install handlers for its states.  Note that we expect to get data that is available as an ArrayBuffer object that contains raw bytes.  We send "rickshaw" in flight to the server.  And then we promise to the top that we will inform as soon as he returns. <br><pre> <code class="coffeescript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncLoader</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">loadImage</span></span></span><span class="hljs-class">: (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class">) -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">xhr</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XMLHttpRequest</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">xhr</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">onprogress</span></span></span><span class="hljs-class"> = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class">) =&gt; ... #      </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">xhr</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">onreadystatechange</span></span></span><span class="hljs-class"> = =&gt; ... #     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">xhr</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">responseType</span></span></span><span class="hljs-class"> = '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">arraybuffer</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">xhr</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">open</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GET</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">xhr</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">send</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">loadingImgBlob</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">$</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Deferred</span></span></span><span class="hljs-class">() </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">loadingImgBlob</span></span></span></span></code> </pre><br>  When the answer returned with the image data, create a blob object from them.  Now to get the url for this object, it is enough to make objectUrl from a blob. <br><pre> <code class="coffeescript hljs"> imgBlobUrl = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.URL.createObjectURL blob</code> </pre><br>  The resulting address in the "local warehouse" is returned to the manager.  At this point we reloaded the image. <br><pre> <code class="coffeescript hljs"> xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-function">=&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> xhr.readyState == <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xhr.status &gt;= <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> xhr.status &lt;= <span class="hljs-number"><span class="hljs-number">300</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> xhr.status == <span class="hljs-number"><span class="hljs-number">304</span></span> contentType = xhr.getResponseHeader <span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span> contentType = contentType ? <span class="hljs-string"><span class="hljs-string">'application/octet-binary'</span></span> blob = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Blob [xhr.response], type: contentType imgBlobUrl = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.URL.createObjectURL blob loadingImgBlob .resolve imgBlobUrl</code> </pre><br><br><h2>  A wise pause </h2><br>  For the correct solution of the second task (the suspension of the planned download for more urgent tasks), we change the average level of our DownloadManager architecture.  In addition to the main job <a href="https://habrahabr.ru/users/queue/" class="user_link">queue</a> , the download manager, in which tasks that have not yet been submitted for execution, becomes the owner of the @enRoute queue, in which tasks are already in progress and which should be stopped in case of a pause in order to start the resume. <br><pre> <code class="coffeescript hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DownloadManager</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">constructor</span></span></span><span class="hljs-class">: -&gt; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">queue</span></span></span><span class="hljs-class"> = [] @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">enRoute</span></span></span><span class="hljs-class"> = [] @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">maxRunningTasks</span></span></span><span class="hljs-class"> = 3 @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">curTaskNum</span></span></span><span class="hljs-class"> = 0 @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paused</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">asyncLoader</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncLoader</span></span></span><span class="hljs-class">()</span></span></code> </pre><br>  Thus, tasks can come in two types: the primary download and resume (if the picture has already got into the queue, started to load, and then was stopped).  Moreover, Chrome is precisely pumping the missing data, and does not begin to download again.  If we have already promised to download the image coming into the queue and wait for it, then we put it at the beginning of the queue.  If we have not yet begun to download it, requested the first time, then - at the end of the queue.  You can determine whether the picture has already been partially downloaded, by the existence of the promise object about loading it into addTask. <br><pre> <code class="coffeescript hljs"> addTask : <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(url, downloading)</span></span></span><span class="hljs-function"> -&gt;</span></span> add = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !downloading <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-string"><span class="hljs-string">'push'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">'unshift'</span></span> downloading ?= <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> $.Deferred() <span class="hljs-comment"><span class="hljs-comment">#     ,   ,   ,      task = { xhr: null, #       XMLHttpRequest'  .     .  xhr      loadImage  asyncLoader'e url: url, promise: downloading numRetries: 0 } @queue[add] task @runTasks() return downloading</span></span></code> </pre><br>  Starter @runTasks () each time checks whether there are outstanding tasks, whether there is anyone to carry them out and whether we are not paused.  If everything is so, we work. <br><pre> <code class="coffeescript hljs"> runTasks: <span class="hljs-function"><span class="hljs-function">-&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (@queue.length != <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp;&amp; (@curTaskNum &lt; @maxRunningTasks) &amp;&amp; !@paused @runNextTask()</code> </pre><br>  When paused, all requests that were in transit (@enRoute) are canceled (task.xhr. <a href="https://developer.mozilla.org/en-US/docs/Web/Events/abort">Abort ()</a> ) and re-scheduled for delivery next time.  This time will come as soon as <a href="https://habrahabr.ru/users/resume/" class="user_link">resume</a> () restarts the job starter. <br><pre> <code class="coffeescript hljs"> pause: <span class="hljs-function"><span class="hljs-function">-&gt;</span></span> @paused = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> @enRoute.length != <span class="hljs-number"><span class="hljs-number">0</span></span> task = @enRoute.shift() task.xhr.abort() @addTask task.url, task.promise <span class="hljs-comment"><span class="hljs-comment">#      @curTaskNum-- resume: -&gt; @paused = false @runTasks() runNextTask: -&gt; task = @queue.shift() @enRoute.push task @curTaskNum++ task.numRetries++ { downloading, xhr } = @asyncLoader.loadImage task.url #         xhr,    ,      . task.xhr = xhr downloading.done (imgBlobUrl) =&gt; i = @enRoute.indexOf task @enRoute.splice i, 1 task.promise.resolve imgBlobUrl @curTaskNum-- @runTasks() downloading.fail =&gt; if task.numRetries &lt; 3 @addTask task.url</span></span></code> </pre><br>  I tried to describe the full cycle of controlled loading.  A vivid example of the work of this architecture can be viewed on the <a href="http://art.tonight.io/">gallery</a> . <br>  <a href="http://zvezdochka.github.io/gallery_loader/">Demo</a> for the test.  The demo code for download and experiments is on <a href="https://github.com/Zvezdochka/gallery_loader/">github</a> . <br>  If you experiment with a demo, you will use another service that provides images, then you will need to configure resource sharing between different sources (Cross-origin resource sharing (CORS)) in order to allow the browser to send data to a script loaded from another domain.  In the simplest case, this means that the web server should return the Access-Control-Allow-Origin header in the response: *.  This will tell the browser that the server allows scripts from any other domains to make XHR requests.  More details can be read on <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS">MDN</a> . </div><p>Source: <a href="https://habr.com/ru/post/273415/">https://habr.com/ru/post/273415/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../273403/index.html">Some CSS CSS Tips</a></li>
<li><a href="../273405/index.html">Node.JS Get rid of require () forever</a></li>
<li><a href="../273407/index.html">Birthday of the founder of the oldest hacker club Chaos Computer Club</a></li>
<li><a href="../273411/index.html">How not to present the results of the static analyzer</a></li>
<li><a href="../273413/index.html">The algorithm for choosing the size of the image for social networks: Guide from the expert Buffer</a></li>
<li><a href="../273417/index.html">Advent of Code</a></li>
<li><a href="../273419/index.html">Myths and illusions of developers regarding playtests</a></li>
<li><a href="../273421/index.html">We become professional PHP developers. Part 1: Missing Link</a></li>
<li><a href="../273423/index.html">Children and parents on the web: the story of hacking services VTech</a></li>
<li><a href="../273425/index.html">Quickly raised is not considered to be dropped. Increase resiliency of embedded systems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>