<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Search Postgres using ZomboDb and elasticsearch</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At some point in the development of the project there was a question of searching for a large number of texts. Moreover, the texts have different leng...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Search Postgres using ZomboDb and elasticsearch</h1><div class="post__text post__text-html js-mediator-article"><p>  At some point in the development of the project there was a question of searching for a large number of texts.  Moreover, the texts have different lengths: from tweets to large articles.  At first, the main search engine was the built-in Postgres _ts <em>vector</em> .  To search for simple rules it was quite enough.  The array of texts grew at a high speed, and the search rules became more complicated, so the built-in engine did not cover the requirements. </p><br><p>  Yes, there is a sphinx, it has excellent integration with Postgres, but the goal was to find a solution to use elasticsearch with Postgres.  Why?  Elasticsearch showed good results in some project cases.  And already there was a server with it for storing logs logs.  There was also a desire to find such a tool that will completely take over the synchronization of data. </p><br><p>  As a result, the project <strong>ZomboDb</strong> was found on the open spaces of the network, which just fit the requirements. <a name="habracut"></a></p><br><p>  Project page on <a href="https://github.com/zombodb/zombodb">github</a> . </p><br><h2>  Extension installation </h2><br><p>  This section is a retelling of the official instructions. </p><br><p>  Currently supported package versions: </p><br><table><thead><tr><th>  Package </th><th>  Versions </th></tr></thead><tbody><tr><td>  Elasticsearch </td><td>  1.7.1+ (not 2.0) </td></tr><tr><td>  Postgres </td><td>  9.3, 9.4, 9.5 </td></tr></tbody></table><br><p>  My configuration: Postgres 9.4, elasticsearch 1.7.5 </p><br><ol><li>  From the <a href="">page</a> you need to download and install a package with a plug-in for Postgres ( <em>deb</em> or <em>rpm</em> ) </li><li><p>  Add the following line to <em>postgresql.conf</em> : </p><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">local_preload_libraries</span></span> = <span class="hljs-string"><span class="hljs-string">'zombodb.so'</span></span>`</code> </pre> <br></li><li><p>  Restart the database and create the extension: </p><br><pre> <code class="hljs swift">psql db_name -<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-string"><span class="hljs-string">"CREATE EXTENSION zombodb;"</span></span></code> </pre> <br></li><li><p>  Next, from the same page you need to download the plugin for elasticsearch and install it: </p><br><pre> <code class="hljs pgsql">bin/plugin -i zombodb -u file:///<span class="hljs-type"><span class="hljs-type">path</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>/zombodb-plugin-XXXzip</code> </pre> <br></li><li><p>  Add to <em>elasticsearch.yml</em> : </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">threadpool</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.bulk</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.queue_size</span></span>: 1024 <span class="hljs-selector-tag"><span class="hljs-selector-tag">threadpool</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.bulk</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.size</span></span>: 12 <span class="hljs-selector-tag"><span class="hljs-selector-tag">http</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.max_content_length</span></span>: 1024<span class="hljs-selector-tag"><span class="hljs-selector-tag">mb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">index</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.query</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.bool</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.max_clause_count</span></span>: 1000000</code> </pre> <br></li><li>  Restart elasticsearch. </li></ol><br><p>  This completes the installation. </p><br><h2>  Creating a test index </h2><br><p>  Suppose there is a table in which the tags are: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span>.tags ( id <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> nextval(<span class="hljs-string"><span class="hljs-string">'tags_id_seq'</span></span>::<span class="hljs-type"><span class="hljs-type">regclass</span></span>), word <span class="hljs-type"><span class="hljs-type">CHARACTER</span></span> <span class="hljs-type"><span class="hljs-type">VARYING</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> );</code> </pre> <br><p>  Create index: </p><br><pre> <code class="hljs lisp">CREATE INDEX tags_zdb_search_idx ON tags USING zombodb (<span class="hljs-name"><span class="hljs-name">zdb</span></span>('tags', tags.ctid), zdb(<span class="hljs-name"><span class="hljs-name">tags</span></span>)) WITH (<span class="hljs-name"><span class="hljs-name">url=</span></span>'http<span class="hljs-symbol"><span class="hljs-symbol">://localhost</span></span>:<span class="hljs-number"><span class="hljs-number">9200</span></span>/')<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  As a result of this query, an index is created, and the data immediately goes into elasticsearch. <br>  A query that <em>Mom</em> and <em>Dad</em> will find: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> tags <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> zdb(<span class="hljs-string"><span class="hljs-string">'tags'</span></span>, ctid) ==&gt; <span class="hljs-string"><span class="hljs-string">'word:(,)'</span></span>;</code> </pre> <br><p>  Where word is the name of the field that will be searched.  The search is implemented using the operator <em>==&gt;</em> . </p><br><p>  Also, ZomboDb provides the <em>text</em> and <em>fulltext</em> domains based on the <em>text</em> type.  Using your own domains, you can define mapping for elasticsearch. </p><br><h2>  Query language </h2><br><p>  Using queries, you can search for individual fields of the indexed table, as well as for all fields. <br>  Queries support logical operations ( <em>and</em> , <em>or</em> , <em>not</em> ), brackets. <br>  It is possible to use various search operators.  For example, the query </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> texts <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> zdb(<span class="hljs-string"><span class="hljs-string">'texts'</span></span>, ctid) ==&gt; <span class="hljs-string"><span class="hljs-string">'text:'</span></span>;</code> </pre> <br><p>  where the operator is a colon, returns texts containing the word <em>papa</em> . <br>  The operations <em>more like this</em> and <em>fuzzy like this are</em> also supported through the operators: @ and: @ ~, respectively. <br>  Example: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> texts <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> zdb(<span class="hljs-string"><span class="hljs-string">'texts'</span></span>, ctid) ==&gt; <span class="hljs-string"><span class="hljs-string">'(text:@ and title:@) or text:'</span></span>;</code> </pre> <br><p>  Also, there is support for comparison operators: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> texts <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> zdb(<span class="hljs-string"><span class="hljs-string">'texts'</span></span>, ctid) ==&gt; <span class="hljs-string"><span class="hljs-string">'comments &gt; 10'</span></span>;</code> </pre> <br><p>  A detailed description of the query language in the <a href="">documentation</a> . </p><br><h2>  findings </h2><br><p>  The project is a good product that works out of the box.  Well documented, updated (the latest version of Postgres is supported, the latest commit at the time of this writing is 27 days old).  If you show yourself well and consistently in production, I will write a wrapper for sqlalchemy. </p><br><p>  Thanks for attention! </p><br><p>  <strong>UPD I</strong> wrote a quick <a href="https://github.com/xxxbobrxxx/sqlalchemy_zombodb">note of sqlalchemy extension</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/303744/">https://habr.com/ru/post/303744/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303734/index.html">ONLYOFFICE: open like never before</a></li>
<li><a href="../303736/index.html">Now your HTTPS will be monitored, and you must install the certificate for MitM yourself.</a></li>
<li><a href="../303738/index.html">Practice successful monetization API based on Azure API Management</a></li>
<li><a href="../303740/index.html">Solving square equations through derivatives</a></li>
<li><a href="../303742/index.html">Experience in developing management software for the questroom</a></li>
<li><a href="../303746/index.html">CTO "Medusa" - Samat Galimov briefly about what it is to be the main development in the media</a></li>
<li><a href="../303748/index.html">What hides Array # sort: reverse engineering by improvised means</a></li>
<li><a href="../303750/index.html">Methodical notes on the selection of informative features (feature selection)</a></li>
<li><a href="../303752/index.html">Emsisoft experts found another JavaScript extortionist</a></li>
<li><a href="../303754/index.html">Alan Kay, the creator of the PLO, about the development of Lisp and PLO</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>