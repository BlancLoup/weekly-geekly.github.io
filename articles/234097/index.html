<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Power Pivot: DAX Window Functions (some more spices)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuing the article on comparing the capabilities of SQL Server window functions and DAX formulas 

 In the last article , aspects of the operation...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Power Pivot: DAX Window Functions (some more spices)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/de2/ec8/b2d/de2ec8b2d98a41d9a9b349211dd6031f.gif" alt="image"><br>  Continuing the article on comparing the capabilities of SQL Server window functions and DAX formulas <br><a name="habracut"></a><br>  In the <a href="http://habrahabr.ru/post/229583/">last article</a> , aspects of the operation of PowerPivot functions were considered and a hypothetical example demonstrated the analogy between the window functions sql server and DAX functions. <br>  Let me remind you that the original example suggested finding incorrect data using DAX, namely: <br>  search in the source data (detailed to the lines of the consignment note) names of outlets with more than one address in the city. <br>  As a result, this goal was achieved, but it would be possible to get much more practical benefits if you force PowerPivot to perform certain actions on these occasions.  At the same time, this is an excellent occasion to show some more useful things from the DAX arsenal. <br><br>  A little thought about how best to handle the events of our example (and their nature lies either in moving the point to a new address, or in banal typos when entering the address), the first thing that comes to mind is to standardize such addresses by adding a single address for several different addresses in the ‚Äúpoint-of-town‚Äù tuple.  The most logical in this case will be the assignment of a single address for the entire sales history of the outlet in the city to the last shipping address. <br>  For this, it would be nice first for each ‚Äúwindow‚Äù [= name of an outlet + city] to get the latest date of activity (sale). <br>  Well, everything is simple, on the sql server the date search request for each atomic entry will look like this: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-string"><span class="hljs-string">'t1. '</span></span>, <span class="hljs-string"><span class="hljs-string">'t1.'</span></span>, <span class="hljs-string"><span class="hljs-string">'t1.'</span></span>, <span class="hljs-string"><span class="hljs-string">'t1.'</span></span>, <span class="hljs-string"><span class="hljs-string">'t1.‚Ññ '</span></span>, <span class="hljs-string"><span class="hljs-string">'t1. '</span></span>, <span class="hljs-string"><span class="hljs-string">'t1., '</span></span>, <span class="hljs-string"><span class="hljs-string">'t1.  '</span></span>, <span class="hljs-string"><span class="hljs-string">'t1.    '</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>( <span class="hljs-string"><span class="hljs-string">'t1. '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-string"><span class="hljs-string">'t1.'</span></span>, <span class="hljs-string"><span class="hljs-string">'t1. '</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> maxdate <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t1</code> </pre> <br>  After reading the previous article, implementing the calculated field in DAX is not difficult: <br><pre> <code class="sql hljs">MaxDatePosInTown:=CALCULATE(MAX('1'[ ]);ALLEXCEPT('1';'1'[ ];'1'[]))</code> </pre><br><img src="https://habrastorage.org/files/88e/01e/007/88e01e0079564e86b5bf227ac799a2a0.jpg" alt="image"><br><br>  Now, having the date of the last sale, it can be used as an auxiliary field to form the corresponding subset. <br>  Functionally, the subset should be formed as follows: <br>  For each record in the initial data set, you need to get a window from the name of the outlet + city and in this window get a subset of records where the date corresponds to the last sale date in this window. <br>  From the list of DAX functions, the FILTER function is the most suitable for this. <br>  Here is a snippet of help: <br><img src="https://habrastorage.org/files/63c/f00/667/63cf00667cd043f6b7c81dfc04e07326.jpg" alt="image"><br>  On DAX, the subset we need now will look like this: <br><pre> <code class="sql hljs"> FILTER( ALLEXCEPT('1';'1'[ ]; '1'[]); '1'[ ]= '1'[MaxDatePosInTown])</code> </pre><br>  where in the role of table is the window = point + city, in the role of filtering condition filter: 'Table1' [Date of consignment note] = 'Table1' [MaxDatePosInTown] 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Pay attention to the condition from the certificate: <br>  ‚ÄúThe FILTER function is not used independently, but embedded in other functions, the argument of which should be a table.  ‚Äû <br>  That is, the problem is that from the resulting subset, select any one record (exactly one) and take the column we need from it. <br>  The overall picture of the final formula is already visible: <br><pre> <code class="sql hljs">=CALCULATE( ('1'[]); FILTER( ALLEXCEPT('1';'1'[ ]; '1'[]); '1'[ ]= '1'[MaxDatePosInTown]))</code> </pre><br>  (The need for the CALCULATE function is described in the <a href="http://habrahabr.ru/post/229583/">last article</a> ) <br><br>  Among the list of available formulas the most suitable catches the eye LOOKUPVALUE <br><img src="https://habrastorage.org/files/374/38d/650/37438d6501bc4cfdbbb1570a941a3b1c.jpg" alt="image"><br><br>  But attempts to launch it did not bring success.  In the same topic I found confirmation from the overseas blog: <br><br><img src="https://habrastorage.org/files/2dc/f34/7f4/2dcf347f429c41e7b72604ad0c186b80.jpg" alt="image"><br><br>  Therefore, pay attention to FIRSTNONBLANK, which takes the following arguments: <br><img src="https://habrastorage.org/files/188/82d/3d2/18882d3d25554301b5420601710dbd1f.jpg" alt="image"><br><br>  The only point is that the function requires an expression, but here you can slip it TRUE <br>  As a result, the formula will have the final form: <br><pre> <code class="sql hljs">=CALCULATE( FIRSTNONBLANK('1'[]; TRUE()); FILTER( ALLEXCEPT('1';'1'[ ];'1'[]); '1'[ ]='1'[MaxDatePosInTown]))</code> </pre><br><br><img src="https://habrastorage.org/files/9a8/0ad/8c8/9a80ad8c876a4e03a837a28865d2858e.jpg" alt="image"><br><br>  An analogue in SQL Server is something like: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> a1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-string"><span class="hljs-string">'t1. '</span></span>, <span class="hljs-string"><span class="hljs-string">'t1.'</span></span>, <span class="hljs-string"><span class="hljs-string">'t1.'</span></span>, row_number() <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-string"><span class="hljs-string">'t1. '</span></span>, <span class="hljs-string"><span class="hljs-string">'t1.'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-string"><span class="hljs-string">'t1. '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> rv <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'1'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">Select</span></span> <span class="hljs-string"><span class="hljs-string">'t1. '</span></span>, <span class="hljs-string"><span class="hljs-string">'t1.'</span></span>, <span class="hljs-string"><span class="hljs-string">'t1.'</span></span>, <span class="hljs-string"><span class="hljs-string">'t1.'</span></span>, <span class="hljs-string"><span class="hljs-string">'t1.‚Ññ '</span></span>, <span class="hljs-string"><span class="hljs-string">'t1. '</span></span>, <span class="hljs-string"><span class="hljs-string">'t1., '</span></span>, <span class="hljs-string"><span class="hljs-string">'t1.  '</span></span>, <span class="hljs-string"><span class="hljs-string">'t1.    '</span></span>, <span class="hljs-string"><span class="hljs-string">'a1.'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t1 <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> a1 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-string"><span class="hljs-string">'t1. '</span></span>=<span class="hljs-string"><span class="hljs-string">'a1. '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">'t1.'</span></span>= <span class="hljs-string"><span class="hljs-string">'a1.'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> a1.rw=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  The end result from PowerPivot on the end-to-end example will look like this: <br><img src="https://habrastorage.org/files/114/187/b68/114187b6834c46febe362362443ca570.jpg" alt="image"><br>  PS You can try another such alternative that gives the same result. <br><pre> <code class="axapta hljs">=calculate(LASTNONBLANK(<span class="hljs-string"><span class="hljs-string">'1'</span></span>[];<span class="hljs-number"><span class="hljs-number">1</span></span>);Filter(<span class="hljs-string"><span class="hljs-string">'1'</span></span>;<span class="hljs-string"><span class="hljs-string">'1'</span></span>[ ]=earlier(<span class="hljs-string"><span class="hljs-string">'1'</span></span>[MaxDatePosInTown]) &amp;&amp; <span class="hljs-string"><span class="hljs-string">'1'</span></span>[ ]=earlier(<span class="hljs-string"><span class="hljs-string">'1'</span></span>[ ])))</code> </pre><br>  But it seems to me that it is somewhat more difficult for perception. <br><br>  I hope it was interesting. <br>  Ananiev Heinrich. </div><p>Source: <a href="https://habr.com/ru/post/234097/">https://habr.com/ru/post/234097/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../234089/index.html">MS SQL (Win1251) - (?) -> Qt (Unicode)</a></li>
<li><a href="../23409/index.html">MacHeist back in the ranks!</a></li>
<li><a href="../234091/index.html">Club $ 40,000 and a business built on the sale of open-source hardware</a></li>
<li><a href="../234093/index.html">Two years on Mars - what does Curiosity look like now?</a></li>
<li><a href="../234095/index.html">Java and Microsoft Cloud - Brief Essays</a></li>
<li><a href="../234099/index.html">MIT scientists use old acid car batteries to create solar panels</a></li>
<li><a href="../2341/index.html">78% of families in the United States are connected to fast Internet lines</a></li>
<li><a href="../234101/index.html">Reverse engineering and game patch on Unity3d</a></li>
<li><a href="../234103/index.html">Yttrium Al-Diode Laser with Neodymium Doping</a></li>
<li><a href="../234105/index.html">Restoring a deleted TrueCrypt partition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>