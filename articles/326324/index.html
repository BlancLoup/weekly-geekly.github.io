<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implement a custom UI element for timing. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On November 17, in Moscow, in the framework of the MBLTdev International Conference of Mobile Developers , Alexander Zimin made a presentation on the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implement a custom UI element for timing. Part 1</h1><div class="post__text post__text-html js-mediator-article"> On November 17, in Moscow, in the framework of the <a href="https://mbltdev.ru/en">MBLTdev</a> International Conference of Mobile Developers <a href="https://mbltdev.ru/en">,</a> Alexander Zimin made a presentation on the topic ‚ÄúVisualize beyond the standard UIKit components‚Äù.  First of all, this report will interest iOS developers who want to learn more about the development of custom UI elements.  He was interested in me by the example of custom control, which I decided to implement and refine, taking into account the theses voiced in the report.  The example was implemented in <code>Swift</code> , I implement it in <code>Objective-C</code> . <br><a name="habracut"></a><br><h4>  <b>How to develop custom UI-elements:</b> </h4><br><ul><li>  It is necessary to understand how the base element works: examine all its properties, methods, <code>delegate</code> and <code>dataSource</code> . </li><li>  Design <code>UIView+</code> dependent elements.  You need to make a universal solution that will display any <code>UIView</code> .  For example, our item has a <code>contentView</code> .  It should be designed so that the user can assign any <code>UIView</code> without thinking about the implementation of our UI element. </li><li>  Do not forget about <code>UIControl</code> .  If you need any custom button or other control, it is better to inherit from <code>UIControl</code> , rather than from <code>UIView</code> .  <code>UIControl</code> has a <code>Target-Action</code> system that allows you to pull <code>IBAction</code> from <code>Interface Builder</code> directly from the button into the code.  Its advantage over <code>UIView</code> is the presence of states and the best tracking of touches. </li><li>  You should study components close to yours. </li><li>  Do not forget about the features of different devices, in particular, about the tactile vibration of the iPhone 7 ( <code>UIImpactFeedbackGenerator</code> class) when working with action components. </li></ul><br><h4>  <b>What will be implemented</b> </h4><br>  The report was an example of a custom <code>UIView</code> , which resembles a <code>UIPickerView</code> .  It was meant for timing. <br><br><img src="https://habrastorage.org/files/511/78d/ab2/51178dab2e0a4aa998d9ed30f7687b98.jpg"><br><br>  This component is similar to <code>UIPickerView</code> .  Accordingly, we need to implement: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  automatic twist; </li><li>  the drum stops at the element; <br></li><li>  iPhone 7 needs feedback vibration (not implemented by me). </li></ul><br><h4>  <b>How to implement?</b> </h4><br>  Take a <code>UIView</code> , make it round and hang a <code>UILabel</code> with numbers on it.  To rotate, add a <code>UIScrollView</code> with infinite <code>contentSize</code> and based on the shift we will calculate the angle of rotation. <br><br><img src="https://habrastorage.org/files/a99/8ac/fbe/a998acfbe14e43918412a00aed603961.png"><br><br>  It is necessary: <br><br><ul><li>  calculate the <code>x</code> , <code>y</code> shift on <code>UIScrollView</code> , </li><li>  recognize the direction </li><li>  twist <code>contentView</code> , </li><li>  screw up to the desired item </li><li>  give the opportunity to substitute any <code>UIView</code> . </li></ul><br><h4>  <b>Hierarchy preparation</b> </h4><br>  Create an <code>AYNCircleView</code> .  This will be the class that contains our entire custom element.  At this stage, he has nothing public, we make everything private.  Next, we begin to create a hierarchy.  First we build our <code>view</code> in <code>Interface Builder</code> .  Let's make <code>AYNCircleView.xib</code> and deal with the hierarchy. <br><br><img src="https://habrastorage.org/files/153/9d3/689/1539d368996640b4910adb6505f21082.jpg"><br><br>  The hierarchy consists of the following elements: <br><br><ul><li>  <code>contentView</code> - a circle on which all other <code>subviews</code> will be, </li><li>  <code>scrollView</code> will provide rotation. </li></ul><br>  We will place <code>constraints</code> .  We are most interested in the height of the <code>contentView</code> and the <code>bottom space</code> .  They will ensure the size and position of our circle.  The remaining <code>constraints</code> do not allow the <code>contentView</code> to get out of the <code>superview</code> .  For convenience, we denote the side by <code>contentSize</code> the <code>scrollView</code> .  This does not greatly affect the performance, but simulates the "infinity" of rotation.  If you are attentive to the details, you can implement a "jump" system to significantly reduce the <code>contentSize</code> the <code>scrollView</code> . <br><br>  Create a class <code>AYNCircleView</code> . <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AYNCircleView</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIView</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">static</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CGFloat</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">kAYNCircleViewScrollViewContentSizeLength</span></span></span><span class="hljs-class"> = 1000000000; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AYNCircleView</span></span></span><span class="hljs-class"> () @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assign</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BOOL</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">isInitialized</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assign</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CGFloat</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">circleRadius</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">weak</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IBOutlet</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIView</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">contentView</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">weak</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IBOutlet</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIScrollView</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">scrollView</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">weak</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IBOutlet</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSLayoutConstraint</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">contentViewDimension</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">property</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">weak</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nonatomic</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IBOutlet</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSLayoutConstraint</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">contentViewOffset</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Let's redefine initializers for cases when our <code>view</code> is initialized from <code>Interface Builder</code> and in code. <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AYNCircleView</span></span></span><span class="hljs-class"> #</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pragma</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mark</span></span></span><span class="hljs-class"> - </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Initializers</span></span></span><span class="hljs-class"> - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instancetype</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initWithFrame</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CGRect</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">frame</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> initWithFrame:frame]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> commonInit]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; } - (<span class="hljs-keyword"><span class="hljs-keyword">instancetype</span></span>)initWithCoder:(<span class="hljs-built_in"><span class="hljs-built_in">NSCoder</span></span> *)aDecoder { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> initWithCoder:aDecoder]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> commonInit]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; } <span class="hljs-meta"><span class="hljs-meta">#pragma mark - Private - (void)commonInit { UIView *nibView = [[NSBundle mainBundle] loadNibNamed:NSStringFromClass([self class]) owner:self options:nil].firstObject; [self addSubview:nibView]; self.scrollView.contentSize = CGSizeMake(kAYNCircleViewScrollViewContentSizeLength, kAYNCircleViewScrollViewContentSizeLength); self.scrollView.contentOffset = CGPointMake(kAYNCircleViewScrollViewContentSizeLength / 2.0, kAYNCircleViewScrollViewContentSizeLength / 2.0); self.scrollView.delegate = self; }</span></span></code> </pre><br>  Place our hierarchy.  You cannot do this in initializers, because we do not know the actual size of the views at the moment.  We can recognize them in the method <code>- (void)layoutSubviews</code> , so we adjust the dimensions there.  To do this, enter the radius of the circle, which depends on the minimum width and height. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">assign</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> circleRadius;</code> </pre> <br>  Enter a flag indicating that initialization is done. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">assign</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> isInitialized;</code> </pre> <br>  Since scrolling leads to a call <code>- (void)layoutSubviews</code> , it would be wrong to constantly calculate the position of our hierarchy.  Update constraints to set the correct size of our <code>views</code> . <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#pragma mark - Layout - (void)layoutSubviews { [super layoutSubviews]; if (!self.isInitialized) { self.isInitialized = YES; self.subviews.firstObject.frame = self.bounds; self.circleRadius = MIN(CGRectGetWidth(self.bounds), CGRectGetHeight(self.bounds)) / 2; self.contentView.layer.cornerRadius = self.circleRadius; self.contentView.layer.masksToBounds = YES; [self setNeedsUpdateConstraints]; } } - (void)updateConstraints { self.contentViewDimension.constant = self.circleRadius * 2; self.contentViewOffset.constant = self.circleRadius; [super updateConstraints]; }</span></span></code> </pre> <br>  Is done.  We look at the result of building the hierarchy.  Let's create a <code>view controller</code> on which our control will be located. <br><br><img src="https://habrastorage.org/files/061/02b/7e2/06102b7e25e7428a8ec077f59d9029b3.jpg"><br><br>  Now look at the live hierarchy. <br><br><img src="https://habrastorage.org/files/2f7/62a/6a5/2f762a6a5e1a45f58e8c2a35dee6dbfc.png"><br><br>  The hierarchy is built right, we continue. <br><br><h4>  <b>Background <code>UIView</code></b> </h4><br>  Next step: make <code>backgroundView</code> support.  Our custom control thinks so that you can put any <code>view</code> on the background, and the user of this control does not think about implementation. <br><br>  We make a public property that contains information about <code>backgroundView</code> : <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> *backgroundView;</code> </pre> <br>  Now we define how it will be added to the hierarchy.  Override the <code>setter</code> . <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)setBackgroundView:(<span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> *)backgroundView { [_backgroundView removeFromSuperview]; _backgroundView = backgroundView; [_contentView insertSubview:_backgroundView atIndex:<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_isInitialized) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> layoutBackgroundView]; } }</code> </pre> <br>  What is the logic here?  Remove the previous <code>view</code> from the hierarchy, add a new <code>backgroundView</code> to the lowest level of the hierarchy and change its size in the method. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)layoutBackgroundView { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.backgroundView.frame = <span class="hljs-built_in"><span class="hljs-built_in">CGRectMake</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.circleRadius * <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.circleRadius * <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.backgroundView.layer.masksToBounds = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.backgroundView.layer.cornerRadius = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.circleRadius; }</code> </pre> <br>  Also consider the case when the <code>view</code> only created.  To resize correctly, add a call to this method in <code>- (void)layoutSubviews</code> . <br><br>  Consider a new hierarchy.  Add a red <code>UIView</code> and look at the hierarchy. <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> *redView = [<span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> new]; redView.backgroundColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> redColor]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.circleView.backgroundView = redView;</code> </pre> <br><img src="https://habrastorage.org/files/d53/ef6/6e1/d53ef66e1aba46a1836f2b8a0886706a.png"><img src="https://habrastorage.org/files/870/c8f/ad3/870c8fad30c14a3da4d61c5ead47c938.png"><br><br>  Everything is good! <br><br><h4>  <b>Dial realization</b> </h4><br>  To implement the dial use <code>UILabel</code> .  If you need to improve performance, <code>CoreGraphics</code> down to the level of <code>CoreGraphics</code> and add signatures already there.  Our solution is a category over <code>UILabel</code> , where we define a ‚Äúrotated‚Äù <code>label</code> .  I added a little customization to the method: text color and font. <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UILabel</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AYNHelpers</span></span></span><span class="hljs-class">) + (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UILabel</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ayn_rotatedLabelWithText</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">angle</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CGFloat</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">angle</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">circleRadius</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CGFloat</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">circleRadius</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">offset</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CGFloat</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">offset</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">font</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIFont</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">font</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textColor</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIColor</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textColor</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br>  The method allows you to place a <code>label</code> on a circle.  <code>circleRadius</code> defines the radius of this circle, <code>offset</code> defines the offset relative to this circle, <code>angle</code> is the central angle.  Create a rotated <code>label</code> in the center of this circle, and then use <code>xOffset</code> and <code>yOffset</code> shift the center of this <code>label</code> to the right place. <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"UILabel+AYNHelpers.h"</span></span></span><span class="hljs-meta"> @implementation UILabel (AYNHelpers) + (UILabel *)ayn_rotatedLabelWithText:(NSString *)text angle:(CGFloat)angle circleRadius:(CGFloat)circleRadius offset:(CGFloat)offset font:(UIFont *)font textColor:(UIColor *)textColor { UILabel *rotatedLabel = [[UILabel alloc] initWithFrame:CGRectZero]; rotatedLabel.text = text; rotatedLabel.font = font ?: [UIFont boldSystemFontOfSize:22.0]; rotatedLabel.textColor = textColor ?: [UIColor blackColor]; [rotatedLabel sizeToFit]; rotatedLabel.transform = CGAffineTransformMakeRotation(angle); CGFloat angleForPoint = M_PI - angle; CGFloat xOffset = sin(angleForPoint) * (circleRadius - offset); CGFloat yOffset = cos(angleForPoint) * (circleRadius - offset); rotatedLabel.center = CGPointMake(circleRadius + xOffset, circleRadius + yOffset); return rotatedLabel; } @end</span></span></code> </pre><br>  Is done.  Now we need to add a method <code>- (void)addLabelsWithNumber:</code> to our <code>contentView</code> labels.  For this, it is convenient to store the step of the angle along which the captions are located.  If we take a circle of 360 degrees, and signatures 12, then the step will be 360/12 = 30 degrees.  Create a property, it is useful to us to normalize the angle of rotation. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">assign</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> angleStep;   offset  ,    . <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CGFloat</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> kAYNCircleViewLabelOffset = <span class="hljs-number"><span class="hljs-number">10</span></span>;</code> </pre> <br>  We make constant <code>offset</code> for the labels, which will also be needed later. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)addLabelsWithNumber:(<span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span>)numberOfLabels { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (numberOfLabels &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.contentView.subviews enumerateObjectsUsingBlock:^(__kindof <span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> * _Nonnull obj, <span class="hljs-built_in"><span class="hljs-built_in">NSUInteger</span></span> idx, <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> * _Nonnull stop) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([obj isKindOfClass:[<span class="hljs-built_in"><span class="hljs-built_in">UILabel</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]]) { [obj removeFromSuperview]; } }]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.angleStep = <span class="hljs-number"><span class="hljs-number">2</span></span> * M_PI / numberOfLabels; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; numberOfLabels; i++) { <span class="hljs-built_in"><span class="hljs-built_in">UILabel</span></span> *rotatedLabel = [<span class="hljs-built_in"><span class="hljs-built_in">UILabel</span></span> ayn_rotatedLabelWithText:[<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithFormat:<span class="hljs-string"><span class="hljs-string">@"%ld"</span></span>, i] angle:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.angleStep * i circleRadius:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.circleRadius offset:kAYNCircleViewLabelOffset font:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.labelFont textColor:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.labelTextColor]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.contentView addSubview:rotatedLabel]; } } }</code> </pre><br>  The step will be calculated when placing the numbers on the dial. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">assign</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">NSUInteger</span></span> numberOfLabels;</code> </pre><br>  Now we add a public property to set the number of digits on the dial. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)setNumberOfLabels:(<span class="hljs-built_in"><span class="hljs-built_in">NSUInteger</span></span>)numberOfLabels { _numberOfLabels = numberOfLabels; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_isInitialized) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> addLabelsWithNumber:_numberOfLabels]; } }</code> </pre> <br>  And we define <code>setter</code> for it by analogy with <code>backgroundView</code> . <br>  Is done.  When the <code>view</code> already created, set the number of digits on the dial.  Do not forget about the method <code>- (void)layoutSubviews</code> and initialization of <code>AYNCircleView</code> .  There should also be signed. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)layoutSubviews { [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> layoutSubviews]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.isInitialized) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.isInitialized = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; ‚Ä¶. [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> addLabelsWithNumber:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.numberOfLabels]; ... } }</code> </pre><br>  Now <code>- (void)viewDidLoad</code> controller, on the <code>view</code> which our control is shown, has the following form: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)viewDidLoad { [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> viewDidLoad]; <span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> *redView = [<span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> new]; redView.backgroundColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> redColor]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.circleView.backgroundView = redView; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.circleView.numberOfLabels = <span class="hljs-number"><span class="hljs-number">12</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.circleView.delegate = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; }</code> </pre><br>  Look at the hierarchy of <code>views</code> and the arrangement of numbers. <br><br><img src="https://habrastorage.org/files/870/c8f/ad3/870c8fad30c14a3da4d61c5ead47c938.png"><img src="https://habrastorage.org/files/b3d/77c/566/b3d77c566b65435caac5d06c7ae78385.png"><br><br>  The hierarchy turned out to be true - all the labels are located on the <code>contentView</code> . <br><br><h4>  <b>Interface rotation support</b> </h4><br>  Please note that some applications use the horizontal orientation of the screen.  To handle this situation, let's track the notification ( <code>NSNotification</code> class) about changing the orientation of the interface.  We are interested in <code>UIDeviceOrientationDidChangeNotification</code> . <br><br>  Let's add <code>observer</code> this notification in the initializer of our control and process it in the same block. <br><br><pre> <code class="objectivec hljs">__<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> __<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) weakSelf = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; [[<span class="hljs-built_in"><span class="hljs-built_in">NSNotificationCenter</span></span> defaultCenter] addObserverForName:<span class="hljs-built_in"><span class="hljs-built_in">UIDeviceOrientationDidChangeNotification</span></span> object:<span class="hljs-literal"><span class="hljs-literal">nil</span></span> queue:<span class="hljs-literal"><span class="hljs-literal">nil</span></span> usingBlock:^(<span class="hljs-built_in"><span class="hljs-built_in">NSNotification</span></span> * _Nonnull note) { __<span class="hljs-keyword"><span class="hljs-keyword">strong</span></span> __<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(weakSelf) strongSelf = weakSelf; strongSelf.isInitialized = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; [strongSelf setNeedsLayout]; }];</code> </pre> <br>  Since blocks implicitly capture <code>self</code> , this can lead to a <code>retain cycle</code> , so loosening the <code>self</code> reference.  When the orientation changes, we kind of re-initialize the controls to recalculate the radius of the circle, the new center, etc. <br><br>  Do not forget to unsubscribe from the alerts in the method <code>- (void)dealloc</code> . <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)dealloc { [[<span class="hljs-built_in"><span class="hljs-built_in">NSNotificationCenter</span></span> defaultCenter] removeObserver:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> name:<span class="hljs-built_in"><span class="hljs-built_in">UIDeviceOrientationDidChangeNotification</span></span> object:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; }</code> </pre> <br>  Dial is realized.  Read about the mathematics of rotation and the next steps in creating custom controls in the <a href="https://habrahabr.ru/company/e-Legion/blog/326388/">second part of the article</a> . <br><br>  The whole project is available on the <a href="https://github.com/haron1020/CustomControl">gita</a> . </div><p>Source: <a href="https://habr.com/ru/post/326324/">https://habr.com/ru/post/326324/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326314/index.html">Delta has lost $ 150 million due to the desire of the manufacturer of emergency generators for the data center</a></li>
<li><a href="../326316/index.html">Useful Plugins and Security Tips for WordPress</a></li>
<li><a href="../326318/index.html">In the Canadian airport discovered devices to spy on smartphones</a></li>
<li><a href="../326320/index.html">(Not) for protothreads lovers dedicated to: High-level functions for working with 1-Wire</a></li>
<li><a href="../326322/index.html">5 stages of implementation of a CRM system. Fascinating about the important</a></li>
<li><a href="../326328/index.html">Bash scripts, part 3: command line options and keys</a></li>
<li><a href="../326330/index.html">First steps to the web SCADA-system. We animate the mnemonic in the browser using AngularJS</a></li>
<li><a href="../326332/index.html">Results of the first round of the Russian Code Cup 2017</a></li>
<li><a href="../326334/index.html">The logic of consciousness. Part 12. The search for patterns. Combinatorial space</a></li>
<li><a href="../326336/index.html">Antifraud. Law. Cellular: my questions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>