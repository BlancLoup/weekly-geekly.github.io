<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Application Monitoring with Prometheus</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good evening! 

 This week we are launching the fourth in a row ‚ÄúDevOps: practices and tools‚Äù course, so by tradition a small interesting article is f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Application Monitoring with Prometheus</h1><div class="post__text post__text-html js-mediator-article">  Good evening! <br><br>  This week we are launching the fourth in a row <a href="https://otus.pw/Qsex/">‚ÄúDevOps: practices and tools‚Äù</a> course, so by tradition a small interesting article is for you. <br><br>  Go 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this practical guide, we will look at how to integrate Prometheus monitoring into an existing application.  Monitoring the application can give an idea of ‚Äã‚Äãhow and when the application is used.  Moreover, potential problems can be foreseen. <br><br>  Key points: <br><br><ul><li>  Learn how to monitor applications and servers with Prometheus; </li><li>  Run Prometheus in Docker; </li><li>  Monitoring and Instrumenting a Golang Sample Application; </li><li>  Deploy Prometheus with Docker Stacks; </li><li>  A brief tutorial with PromQL examples. </li></ul><br><img src="https://habrastorage.org/webt/bs/ej/wh/bsejwhdyftu2_pyszaibcocsu_q.jpeg"><a name="habracut"></a><br><br>  <b>Value of Exporters</b> <br><br>  Prometheus is a time series database with a UI and a very complex query language (PromQL).  Prometheus can parse metrics, counters, indicators and histograms over HTTP using plaintext and a more efficient protocol. <br><br>  <i>Glossary:</i> <br>  Embedding endpoints / metrics into an existing application is called instrumentation.  And when endpoint / metrics is part of an autonomous process, the exporter (Expoter). <br><br>  <b>NodeExporter</b> <br><br>  One of the most popular exporters is NodeExporter.  When NodeExporter is running on a host, it provides details of the I / O load, memory, disk, and CPU.  It can be run as a Docker container, but it requires a large number of additional flags, so it is recommended to run it directly on the host being monitored. <br><br>  <b>Built-in exporter</b> <br><br>  Prometheus provides its own set of metrics - which, in essence, is dogfooding (using your own products for testing purposes).  It is already built in and usually enabled by default. <br><br>  <b>Community Exporters</b> <br><br>  Interesting exporters written for the Docker Summit in Berlin are the Docker Hub and GitHub exporters by Edward Marshall.  These exporters collect Docker Hub and GitHub site metrics by periodically querying the API and passing these values. <br><br>  <i>Ed used <a href="https://github.com/prometheus/client_python">the Python client libraries to</a> create the exporter, but other language bindings are available.</i> <br><br><ul><li>  <a href="https://github.com/infinityworksltd/docker-hub-exporter/">Docker Hub Exporter</a> , written in Python </li></ul><br>  One of the first exporters I wrote was to monitor the Bitcoin mining statistics ‚Äî how many dollars I earned, how many solutions (hashes) my hardware processes per second. <br><br>  <i>My Bitcoin exporter is written in Node.js and uses the Histogram and Radial Sensor type metrics.</i> <br><br><ul><li>  <a href="">Bitcoin Mining Exporter</a> on Node.js </li></ul><br>  <i>Other exporters are highlighted in the documentation.</i>  <i>For example, MySQL, Mongo, Redis, NATS, Nginx, and JenkinsCI.</i> <br><br>  <b>Creating your exporter</b> <br><br>  And then everything becomes much more interesting - you can monitor almost anything.  Imagine that we have a shop in Shopify (that is: a pocket online store) in which we monitor sales and order status. <br><br>  Here are some ideas for metrics you can follow: <br><br><ul><li>  best selling product; </li><li>  best selling category; </li><li>  total number of orders for a certain time; </li><li>  waiting time between payment and sending the order; </li><li>  total number of reviews; </li><li>  average rating in reviews; </li><li>  total number of registrations. </li></ul><br>  And if this kind of data is already available, you can simply monitor lower-level metrics: <br><br><ul><li>  the number of transactions processed; </li><li>  payment gateway response time; </li><li>  HTTP errors, such as 403 and 404; </li><li>  geolocation of buyers using IP addresses. </li></ul><br>  Let's look at a simple Prometheus recipe with Docker, and then back to writing your own instrumentation for a test application. <br><br>  <b>Prometheus with Docker</b> <br><br>  Prometheus is written in Golang and can be used as a standalone statically compiled binary file without dependencies.  The project also packs a binary file with a reasonable configuration in a Docker container. <br><br>  <b>Run Prometheus in Docker</b> <br><br>  Define the Docker Compose, which allows command lines to remain simple and repeatable: <br><br><pre><code class="go hljs">version: <span class="hljs-string"><span class="hljs-string">"3"</span></span> services: prometheus: image: quay.io/prometheus/prometheus:latest ports: - <span class="hljs-number"><span class="hljs-number">9090</span></span>:<span class="hljs-number"><span class="hljs-number">9090</span></span></code> </pre> <br>  Expand the stack file: <br><br>  <i>Swarm mode is required for deployment of stack files, so run docker swarm init, if you haven‚Äôt done so before.</i> <br><br><pre> <code class="bash hljs">$ docker swarm init $ docker stack deploy monitoring --compose-file=./docker-compose.yml</code> </pre> <br>  Go to <a href="http://localhost:9090/">http: // localhost: 9090 /</a> for a look at the interface. <br><br><img src="https://habrastorage.org/webt/lg/b-/um/lgb-umql1kajdg5i8qm-ktvcjg4.jpeg"><br><br>  In the screenshot above, you can see the number of go_routines used, recorded by Prometheus itself.  To see the raw metrics that Prometheus collects about itself, open a browser and go to <a href="http://localhost:9090/metrics">http: // localhost: 9090 / metrics</a> <br><br>  <i>The go routine is a lightweight version of the stream that is used in Golang to ensure competitiveness.</i> <br><br>  You probably do not need to monitor Prometheus.  But the fact of having such an opportunity means that you can immediately get acquainted with the metrics. <br><br>  <b>Application Instrumentation</b> <br><br>  Look at the instrumentation of your application. <br><br>  There are two approaches to instrumentation, but both include the need to open or implement an HTTP / s endpoint.  The default endpoint is / metrics, but you can migrate it to your prometheus.yml file.  Prometheus will use the endpoint to collect metrics at regular intervals of 5s or 30s. <br><br>  <b>Do I need to edit the application code?</b> <br><br>  You can make / metrics endpoint part of the existing application code.  This is feasible if you already have the details and data to interact with payment levels or databases.  Minus - you need to include a new library, endpoint and dependency in your product or project. <br><br>  <b>What is the other option?</b> <br><br>  You can write a separate process that acts as an interlayer for accessing information from your application or environment.  In the case of the <a href="https://github.com/infinityworksltd/docker-hub-exporter/">Docker Hub exporter</a> , data was read from an external API that could not be managed.  Therefore, if it is difficult for you to obtain permission to modify an existing application, this method may work. <br><br>  The advantage of a separate process is that you do not have to redeploy the application if you need to update what you are monitoring. <br><br>  <b>Endpoint implementation</b> <br><br>  Prometheus can read data from two ‚Äúexposure‚Äù formats.  Go to <a href="http://localhost/">localhost</a> : 9090 / metrics and look at the result of the previous go_routines example. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># HELP go_goroutines Number of goroutines that currently exist. # TYPE go_goroutines gauge go_goroutines 92</span></span></code> </pre> <br>  <b>Use client library</b> <br><br>  There are many libraries for working with metrics, and most of them can output text and the more efficient binary format (Protobuf) mentioned above. <br>  <a href="https://prometheus.io/docs/instrumenting/exposition_formats/">Prometheus Exposure Formats</a> <br><br>  <i>The project supports language bundles for Golang, Java, Python and Ruby, but there are many others in the public domain.</i> <i><br><br></i>  <i>The full list can be found here:</i> <br>  <a href="https://prometheus.io/docs/instrumenting/clientlibs/">Prometheus Libraries</a> <br><br>  <b>Should I write my own?</b> <br><br>  The plaintext format is so simple that you can easily embed a protocol by following <a href="https://prometheus.io/docs/instrumenting/exposition_formats/">the Prometheus exposure formats</a> . <br><br>  And before you create your own, make sure that you definitely will not be able to use existing trusted client libraries. <br><br>  <b>Instrumenting Golang Applications</b> <br><br>  Create a simple application and instrument it directly using the Golang Prometheus library. <br><br>  <b>Usage example:</b> <br><br>  You need to write a web service to provide SHA-256 hashes on demand.  For this you need to know a few things: <br><br><ul><li>  How many requests are received for hashes; </li><li>  What is the average time it takes to calculate a hash; </li><li>  How many 400 errors (bad request) we get. </li></ul><br>  Fortunately, you can get all of the above using a histogram metric, but the simplest example would be a counter (always increasing or staying the same) of a radial sensor (similar to a counter, but it can either rise or fall). <br><br>  <i>You can see on <a href="https://prometheus.io/docs/concepts/metric_types/">Metric Types</a></i> <br><br>  The full code, including the Dockerfile, is available on GitHub: <a href="https://github.com/alexellis/hash-browns">alexellis / hash-browns</a> <br><br>  Here is an example of the ‚Äúserver.go‚Äù file: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { histogram := prometheus.NewHistogramVec(prometheus.HistogramOpts{ Name: <span class="hljs-string"><span class="hljs-string">"hash_duration_seconds"</span></span>, Help: <span class="hljs-string"><span class="hljs-string">"Time taken to create hashes"</span></span>, }, []<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>{<span class="hljs-string"><span class="hljs-string">"code"</span></span>}) r := mux.NewRouter() r.Handle(<span class="hljs-string"><span class="hljs-string">"/metrics"</span></span>, prometheusHandler()) r.Handle(<span class="hljs-string"><span class="hljs-string">"/hash"</span></span>, hashHandler(histogram)) prometheus.Register(histogram) s := &amp;http.Server{ Addr: <span class="hljs-string"><span class="hljs-string">":8080"</span></span>, ReadTimeout: <span class="hljs-number"><span class="hljs-number">8</span></span> * time.Second, WriteTimeout: <span class="hljs-number"><span class="hljs-number">8</span></span> * time.Second, MaxHeaderBytes: <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">20</span></span>, Handler: r, } log.Fatal(s.ListenAndServe()) }</code> </pre> <br>  Here we register our application path and metrics. <br><br>  After that, you can record the time spent by calling histogram.Observe (seconds). <br><br><pre> <code class="bash hljs">start := time.Now() // Do something duration := time.Since(start) code := 200 // some HTTP Code histogram.WithLabelValues(fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"%d"</span></span>, code)).Observe(duration.Seconds())</code> </pre> <br>  You can generate a hash: <br><br><pre> <code class="bash hljs">$ curl localhost:8080/<span class="hljs-built_in"><span class="hljs-built_in">hash</span></span> -d <span class="hljs-string"><span class="hljs-string">"my_input_value_here"</span></span> 49b8c4256d603a68ee9bcd95f8e11eed784189bd40c354950014b6d7f7263d6c C ,   curl localhost:8080/metrics: <span class="hljs-comment"><span class="hljs-comment"># HELP hash_seconds Time taken to create hashes # TYPE hash_seconds histogram hash_seconds_bucket{code="200",le="1"} 2 hash_seconds_bucket{code="200",le="2.5"} 2 hash_seconds_bucket{code="200",le="5"} 2 hash_seconds_bucket{code="200",le="10"} 2 hash_seconds_bucket{code="200",le="+Inf"} 2 hash_seconds_sum{code="200"} 9.370800000000002e-05 hash_seconds_count{code="200"} 2</span></span></code> </pre> <br>  The last step is to edit prometheus.yml and start parsing the new application code.  After that you will find the metrics in the drop-down list and be able to visualize the values. <br><br>  <b>Union</b> <br><br>  We need to change the configuration of Prometheus, for this we will use a little trick to extract the default config from the official Docker image: <br><br><pre> <code class="bash hljs">$ docker run --entrypoint=<span class="hljs-string"><span class="hljs-string">''</span></span> -ti quay.io/prometheus/prometheus:latest /bin/cat /etc/prometheus/prometheus.yml &gt; prometheus.yml</code> </pre> <br>  Now fix the file prometheus.yml, created in the current directory.  In the scrape_config section, add the following: <br><br><pre> <code class="bash hljs">- job_name: <span class="hljs-string"><span class="hljs-string">'hashbrowns'</span></span> <span class="hljs-comment"><span class="hljs-comment"># metrics_path defaults to '/metrics' # scheme defaults to 'http'. static_configs: - targets: ['hashbrowns:8080']</span></span></code> </pre> <br>  Docker Swarm allows services to communicate with each other via the built-in DNS, so the target is simply a label (‚Äúhashbrowns‚Äù) from the layout file. <br><br>  Now create a new docker-compose.yml file: <br><br><pre> <code class="bash hljs">version: <span class="hljs-string"><span class="hljs-string">"3"</span></span> services: prometheus: image: quay.io/prometheus/prometheus:latest ports: - 9090:9090 volumes: - <span class="hljs-string"><span class="hljs-string">"./prometheus.yml:/etc/prometheus/prometheus.yml"</span></span> hashbrowns: image: alexellis2/<span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>-browns ports: - 8080:8080</code> </pre> <br>  Deploy the stack file: <br><br><pre> <code class="bash hljs">$ docker stack deploy tutorial --compose-file=./docker-compose.yml</code> </pre> <br>  <i>Note: Calling the service by name will work as long as you have only one replica.</i>  <i>If you want to scale the service, you'll have to figure out how to let Prometheus find the replicas separately.</i> <br><br>  Here‚Äôs how it looks in the Prometheus interface: <br><br><img src="https://habrastorage.org/webt/zd/n2/nh/zdn2nh9pn209p7esnzmuezgc_-e.jpeg"><br><br>  We give answers in the format of PromQL using the metrics that we have collected above.  It took me some time to get used to <a href="https://prometheus.io/docs/querying/basics/">PromQL</a> , but I was lucky that Julius wrote a very detailed article available <a href="https://www.digitalocean.com/community/tutorials/how-to-query-prometheus-on-ubuntu-14-04-part-1">here</a> . <br><br><ul><li>  Answer to the question: How many requests are received for hashes; </li></ul><br>  The PromQl expression written below gives the ascending rate for our hash function within 1 minute.  Frames can be reduced, but they must cover at least two samples. <br><br><pre> <code class="bash hljs">rate(hash_seconds_count[1m])</code> </pre> <br><ul><li>  The answer to the question: What is the average time it takes to calculate the hash; </li></ul><br>  To find out the average for the last 5 minutes, write: <br><br><pre> <code class="bash hljs">rate(hash_seconds_sum[5m]) / rate(hash_seconds_count[5m])</code> </pre> <br><ul><li>  The answer to the question: How many errors 400 (bad request) we get. </li></ul><br><pre> <code class="bash hljs">rate(hash_seconds_count{code=<span class="hljs-string"><span class="hljs-string">"400"</span></span>}[5m])</code> </pre> <br>  <b>Completion</b> <br><br><ul><li>  Does it work on an ARM processor or a Raspberry Pi? </li></ul><br>  Yes, I have a Docker image (alexellis2 / prometheus-armhf: 1.5.2), available on the Docker Hub for Prometheus, and the AlertManager project (alexellis2 / alertmanager-armhf: 0.5.1). <br><br>  THE END <br><br>  As always, we are waiting for questions and comments here or at <a href="https://otus.pw/mGRT/">the Open Day</a> . </div><p>Source: <a href="https://habr.com/ru/post/358588/">https://habr.com/ru/post/358588/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358576/index.html">How we played the game ‚ÄúStone - Scissors - Paper‚Äù on the Ethereum blockchain</a></li>
<li><a href="../358580/index.html">IP PBX Zeon + RetailCRM = Effective Internet Sales</a></li>
<li><a href="../358582/index.html">We build an effective interaction between engineering and product teams.</a></li>
<li><a href="../358584/index.html">Error notification: from each circuit in its own way</a></li>
<li><a href="../358586/index.html">Announcement mitap Sync.NET # 6 in Kharkov</a></li>
<li><a href="../358594/index.html">Utilize Groovy DSL features for configuring Java applications</a></li>
<li><a href="../358596/index.html">John Carmack: My stories about Steve Jobs</a></li>
<li><a href="../358600/index.html">Features of API development: which API is good?</a></li>
<li><a href="../358602/index.html">How to unleash the potential of a product manager? 30 typical PM interview questions</a></li>
<li><a href="../358604/index.html">PHP, GDB and arrays</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>