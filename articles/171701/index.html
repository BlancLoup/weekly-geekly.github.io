<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Search for the user's blocking source in Active Ditectory</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the work of an Active Directory domain administrator, quite often there is a need to find the reason for blocking a user. Sometimes the reason for ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Search for the user's blocking source in Active Ditectory</h1><div class="post__text post__text-html js-mediator-article">  In the work of an Active Directory domain administrator, quite often there is a need to find the reason for blocking a user.  Sometimes the reason for blocking a user is a PC infected with a virus - in such cases, the speed of detecting the source of the problem is particularly important.  In PowerShell 2 on Windows 2008 R2 there is an excellent Get-WinEvent cmdlet that allows you to solve this problem in 1-2 minutes even in a very large domain. <br>  <i>Note: all further described concerns only PowerShell&gt; = 2.0</i> <br><a name="habracut"></a><br><h5>  Necessary initial conditions. </h5><br>  Yes, there is no miracle, and to find the reason for blocking users, some configuration of security auditing on domain controllers will be required.  The following audit subcategories on domain controllers should be included: <br><table><tbody><tr><th>  Audit category </th><th>  Audit subcategory </th><th>  Audit type </th><th>  EventID of interest </th></tr><tr><td>  Audit Account Logon Events </td><td>  Kerberos Authentication Service (Kerberos Authentication Service Audit) </td><td>  Renouncement </td><td>  4771 Kerberos pre-authentication failed. </td></tr><tr><td>  Audit Logon Events (Login / Logout) </td><td>  Logon (Login Audit) </td><td>  Renouncement </td><td>  4625 An account failed to log on. </td></tr><tr><td>  Audit Logon Events (Login / Logout) </td><td>  Account Lockout (Audit Account Lockout) </td><td>  Success </td><td>  4740 Account locked </td></tr></tbody></table><br><br><h5>  The search algorithm for the source of the lock </h5><br><ol><li>  Determine which controller owns the role of the PDC emulator </li><li>  Find the event 4740 in the ‚ÄúTargetUserName‚Äù field in the security log of the PDC emulator with the name of the user that interests us </li><li>  In the field ‚ÄúTargetDomainName‚Äù of the same event find the name of the domain controller that served the authorization </li><li>  Find in the security log of the controller that served the authorization an event with the code 4625 (unsuccessful NTLM authorization) or 4771 (unsuccessful kerberos authorization) </li><li>  From the event found, get the values ‚Äã‚Äãof the ‚ÄúIpAddress‚Äù fields - the address of the PC from which the authorization was attempted </li></ol><br><br>  This will be enough to quickly find a PC with malware picking up user passwords.  As a rule, quickly enough to calculate the source of the problem and isolate it for further investigation.  The process search algorithm of the user directly blocking is highly dependent on the software installed on the target PC. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Used PowerShell cmdlets </h5><br><ul><li>  <a href="http://technet.microsoft.com/en-us/library/ee617217.aspx">Get-ADDomainController</a> - to determine the owner of the role of the PDC emulator </li><li>  <a href="http://technet.microsoft.com/en-us/library/hh849682.aspx">Get-WinEvent</a> - "magic" cmdlet, thanks to which quick search became possible </li></ul><br><br>  What is the "magic" of Get-WinEvent? <br>  First, it searches for events from the end and has the -MaxEvents parameter, which allows you to find only the most recent event or some of the most recent events. <br>  Secondly, it has an excellent -FilterHashtable parameter that allows you to set the event search conditions in a very flexible way. <br><br><h5>  Search script </h5><br>  For myself, I prepared a small PowerShell script. <br>  At the entrance, the script accepts either the name of the user for whom the blocking source is to be found, or the number (by default - 1) of the last blocked users. <br><pre><code class="hljs mel">param ( $User, $Count = <span class="hljs-number"><span class="hljs-number">1</span></span> ) $result = New-Object <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.Data.DataTable <span class="hljs-string"><span class="hljs-string">"Locks"</span></span> $col1 = New-Object <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.Data.DataColumn Username,([<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]) $col2 = New-Object <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.Data.DataColumn DCFrom,([<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]) $col3 = New-Object <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.Data.DataColumn LockTime,([<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]) $col4 = New-Object <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.Data.DataColumn eventID,([<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]) $col5 = New-Object <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.Data.DataColumn SourceHost,([<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]) $col6 = New-Object <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.Data.DataColumn LogonType,([<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]) $col7 = New-Object <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.Data.DataColumn LogonProcessName,([<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]) $col8 = New-Object <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.Data.DataColumn FalureTime,([<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]) $result.columns.add($col1) $result.columns.add($col2) $result.columns.add($col3) $result.columns.add($col4) $result.columns.add($col5) $result.columns.add($col6) $result.columns.add($col7) $result.columns.add($col8) $PDC = [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>](Get-ADDomainController -Discover -Service PrimaryDC).Hostname $FilterHash = @{} $FilterHash.LogName = <span class="hljs-string"><span class="hljs-string">"Security"</span></span> $FilterHash.ID = <span class="hljs-string"><span class="hljs-string">"4740"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($User) { $FilterHash.data =$User $Count = <span class="hljs-number"><span class="hljs-number">1</span></span> } $FilterHash2 = @{} $FilterHash2.LogName = <span class="hljs-string"><span class="hljs-string">"Security"</span></span> $FilterHash2.ID = @(<span class="hljs-string"><span class="hljs-string">"4625"</span></span>, <span class="hljs-string"><span class="hljs-string">"4771"</span></span>) Get-WinEvent -Computername $PDC -FilterHashtable $FilterHash -MaxEvents $Count | foreach { $Row = $result.NewRow() $Username = ([xml]$_.ToXml()).Event.EventData.Data | ? {$_.Name -eq ‚ÄúTargetUserName‚Äù} | %{$_.<span class="hljs-string"><span class="hljs-string">"#text"</span></span>} $DCFrom = ([xml]$_.ToXml()).Event.EventData.Data | ? {$_.Name -eq ‚ÄúTargetDomainName‚Äù} | %{$_.<span class="hljs-string"><span class="hljs-string">"#text"</span></span>} $LockTime = $_.TimeCreated $FilterHash2.data = $username Get-WinEvent -Computername $dcfrom -FilterHashtable $FilterHash2 -MaxEvents <span class="hljs-number"><span class="hljs-number">3</span></span> | foreach { $Row = $result.NewRow() $Row.Username = $Username $Row.DCFrom = $DCFrom $Row.LockTime = $LockTime $Row.eventID = $_.ID $Row.SourceHost = ([xml]$_.ToXml()).Event.EventData.Data | ? {$_.Name -eq ‚ÄúIpAddress‚Äù} | %{$_.<span class="hljs-string"><span class="hljs-string">"#text"</span></span>} $Row.LogonType = ([xml]$_.ToXml()).Event.EventData.Data | ? {$_.Name -eq ‚ÄúLogonType‚Äù} | %{$_.<span class="hljs-string"><span class="hljs-string">"#text"</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> ($Row.LogonType) { <span class="hljs-string"><span class="hljs-string">"2"</span></span> {$Row.LogonType = <span class="hljs-string"><span class="hljs-string">"Interactive"</span></span>} <span class="hljs-string"><span class="hljs-string">"3"</span></span> {$Row.LogonType = <span class="hljs-string"><span class="hljs-string">"Network"</span></span>} <span class="hljs-string"><span class="hljs-string">"4"</span></span> {$Row.LogonType = <span class="hljs-string"><span class="hljs-string">"Batch"</span></span>} <span class="hljs-string"><span class="hljs-string">"5"</span></span> {$Row.LogonType = <span class="hljs-string"><span class="hljs-string">"Service"</span></span>} <span class="hljs-string"><span class="hljs-string">"7"</span></span> {$Row.LogonType = <span class="hljs-string"><span class="hljs-string">"Unlock"</span></span>} <span class="hljs-string"><span class="hljs-string">"8"</span></span> {$Row.LogonType = <span class="hljs-string"><span class="hljs-string">"NetworkCleartext"</span></span>} <span class="hljs-string"><span class="hljs-string">"9"</span></span> {$Row.LogonType = <span class="hljs-string"><span class="hljs-string">"NewCredentials"</span></span>} <span class="hljs-string"><span class="hljs-string">"10"</span></span> {$Row.LogonType = <span class="hljs-string"><span class="hljs-string">"RemoteInteractive"</span></span>} <span class="hljs-string"><span class="hljs-string">"11"</span></span> {$Row.LogonType = <span class="hljs-string"><span class="hljs-string">"CachedInteractive"</span></span>} } $Row.LogonProcessName = ([xml]$_.ToXml()).Event.EventData.Data | ? {$_.Name -eq ‚ÄúLogonProcessName‚Äù} | %{$_.<span class="hljs-string"><span class="hljs-string">"#text"</span></span>} $Row.FalureTime = $_.TimeCreated $result.Rows.Add($Row) } } $result | Format-Table -AutoSize</code> </pre> <br><br>  Usage example: <br><pre> <code class="hljs dos">PS&gt; <span class="hljs-built_in"><span class="hljs-built_in">Find</span></span>-Locker.ps1 -User iiinanov PS&gt; <span class="hljs-built_in"><span class="hljs-built_in">Find</span></span>-Locker.ps1 -Count <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre><br><br><h5>  Instead of ps </h5><br>  Yes, there are <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D18465">Account Lockout and Management Tools</a> with the excellent LockoutStatus.exe utility, but it polls all domain controllers for a long time (and some of them may not be available). <br>  The proposed script does not pretend to replace LockoutStatus.exe (they have a completely different principle of operation).  I usually use them together. <br><br>  The finished script can be downloaded from Google Drive: <a href="https://docs.google.com/file/d/0Byd6SIGDJbOpWFpjZnBreUw5dzg/edit%3Fusp%3Dsharing">Find-Locker.ps1</a> </div><p>Source: <a href="https://habr.com/ru/post/171701/">https://habr.com/ru/post/171701/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../171689/index.html">Zotac nettop home server</a></li>
<li><a href="../171691/index.html">CeBIT 2013. Day one. Stands Thermaltake, MSI and Biostar</a></li>
<li><a href="../171693/index.html">Work should be a pleasure</a></li>
<li><a href="../171697/index.html">Use GYP to build a C / C ++ project.</a></li>
<li><a href="../171699/index.html">Useful HTML, CSS and JavaScript techniques</a></li>
<li><a href="../171703/index.html">Selenium 2.0 - WebDriver. Impressions, problems and tips on using</a></li>
<li><a href="../171705/index.html">Fujitsu LIFEBOOK UH572 Ultrabook Review</a></li>
<li><a href="../171707/index.html">Story about participating in the contest Intel Accelerate Your Code</a></li>
<li><a href="../171709/index.html">Combining responsive layout and templates for mobile</a></li>
<li><a href="../171711/index.html">Introduction to libuniset - library for creating ACS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>