<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mattermost. Integration with external services</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Choosing the replacement used by our messaging system, I came across the description of the Mattermost, and decided to try. One of the advantages of t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mattermost. Integration with external services</h1><div class="post__text post__text-html js-mediator-article"><p>  Choosing the replacement used by our messaging system, I came across the description of the Mattermost, and decided to try.  One of the advantages of the described system is simple integration with third-party services, the so-called "hooks" (outgoing and incoming hooks).  That's about setting up interaction through hooks with external systems and this article will be (in our particular case, this is zabbix and glpi). </p><a name="habracut"></a><br><h3 id="chast-pervaya-integraciya-s-glpi">  Part one.  GLPI Integration </h3><br><p>  Since we, in our work, use GLPI to account for equipment, software, connections, registration of calls to technical support, it would be logical to organize the possibility for users to send applications to TP from the mattermost. </p><br><h4 id="api">  API </h4><br><p>  For integration with external services, GLPI has http rest api.  Documentation on it is available in the installed system via the link <a href="http://glpi/apirest.php/">http: //glpi/apirest.php/#glossary</a> (where "glpi" is the address of your server). </p><br><p>  Slightly thinking about the task, it was decided to implement the exchange algorithm in php, this fact is supported by the fact that php is already installed in the system and the script was organically entered in glpi and is available at <a href="http://glpi/mm.php">http: //glpi/mm.php</a> .  It turned out, a kind of "proxy", which receives the request from mattermost, converts it into the desired format and sends it to GLPI.  All http requests are transmitted in JSON format. </p><br><p>  The work procedure consists of 5 parts: </p><br><ol><li>  Getting a request from mattermost </li><li>  Session initialization in glpi </li><li>  Retrieving data from a request </li><li>  Sending data to glpi </li><li>  Closing session </li></ol><br><p>  Before proceeding to the description of the script code, we will carry out the preparatory work both in the mattermost and in glpi. </p><br><h4 id="glpi">  GLPI </h4><br><ol><li>  We will create a helpdesk user, on whose behalf requests will be created, and going into the settings of this user, we will generate tokens: <br><img src="https://habrastorage.org/getpro/habr/post_images/64f/869/851/64f869851cfffa8daaddff55592580ba.png" alt="image"><br>  The one circled in red will be user_token. </li><li>  In the system settings you need to add a client to interact with the API.  To do this, go to "Settings" -&gt; "General" -&gt; "API" and click the "Add client" button, add a record and generate a token (app_token) </li></ol><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a8e/f8c/914/a8ef8c9147eb0d21189f2b3424f3e4bf.png" alt="image"></p><br><ol><li>  To identify the source of requests in the system, add an entry to the Directory "Query sources" and going to the newly added entry will remember its id (circled in red) <br><img src="https://habrastorage.org/getpro/habr/post_images/645/ee3/e1f/645ee3e1f0378e16c22494e5267a39b2.png" alt="image"></li></ol><br><p>  This completes the setup of the API in GLPI. </p><br><h4 id="mattermost">  Mattermost </h4><br><p>  In the client menu Mattermost go to "Inegration" -&gt; "Outgoing Webhooks" click "Add" and add a record.  On the screen, I highlighted significant fields.  There should be a digression: the mattermost "trigger" to start the procedure for sending a request is a word or phrase, which, being indicated at the beginning of the message, actually starts the process.  In our case, the word trigger is "112" (here is a direct association with the Ministry of Emergency Situations). </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/437/10a/7f6/43710a7f6049679081589ff9574c14a3.png" alt="image"></p><br><p>  You can add a default username and a link to the avatar (or you can not add it), since these parameters will be passed in the request.  But in order for mattermost to be able to process these parameters, in the server settings you need to change a couple of options in the <em>/opt/mattermost/config/config.json</em> file </p><br><pre><code class="plaintext hljs">"EnablePostUsernameOverride": true, "EnablePostIconOverride": true,</code> </pre> <br><p>  At this setting is over.  It is time to move on to writing code.  The script is copied to the root directory with glpi files, in my case it is <em>/var/www/html/glpi/mm.php</em> </p><br><pre> <code class="php hljs"> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment"># GLPI     $app_token = '7uizyyildM71x84j1UxeABXTuCHdPoLRW45Tx2wG'; $user_app_token ='dZdCqc10Xhb1TxCT4OsXp8qqDSEqILASf2wZot0w'; #    (  ,    ) $requesttypes_id = '7'; #    GLPI (1 - , 2 - ) $type = '1'; #      $postData = file_get_contents('php://input'); $data = json_decode($postData, true); #  json  MatterMost.       #         #$message_text = $data["text"]; #$user_name = $data["user_name"]; #$user_id = $data["user_id"]; #$channel_name = $data["channel_name"]; #$channel_id = $data["channel_id"]; #$team_domain = $data["team_domain"]; #$team_id = $data["team_id"]; #$post_id = $data["post_id"]; #  "112"  ,    4 . $message_text = substr($data["text"],4); #   POST ,      mattermost #HTTP/1.1 200 OK header('Content-Type: application/json'); $reply = array( 'response_type' =&gt; 'comment', 'text'=&gt; '      ' ); echo json_encode($reply); #     glpi #        #         if( $curl = curl_init() ) { curl_setopt($curl, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Authorization: user_token '.$user_app_token, 'App-Token: '.$app_token)); curl_setopt($curl, CURLOPT_URL, 'http://glpi/apirest.php/initSession'); curl_setopt($curl, CURLOPT_POST, true); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); $out = curl_exec($curl); $session = json_decode($out, true); $session_token = $session["session_token"]; #echo $session_token; curl_close($curl); } #       $json = array( 'input'=&gt; array( 'name'=&gt;'  '.$data["user_name"], 'requesttypes_id'=&gt;$requesttypes_id, 'content'=&gt;$message_text, 'type'=&gt;$type ) ); #   if( $curl = curl_init() ) { curl_setopt($curl, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'App-Token: '.$app_token, 'Session-token: '.$session_token)); curl_setopt($curl, CURLOPT_URL, 'http://glpi/apirest.php/Ticket'); curl_setopt($curl, CURLOPT_POST, true); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); curl_setopt($curl, CURLOPT_POSTFIELDS, json_encode($json)); $out = curl_exec($curl); curl_close($curl); } #   if( $curl = curl_init() ) { curl_setopt($curl, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'App-Token: '.$app_token, 'Session-token: '.$session_token)); curl_setopt($curl, CURLOPT_URL, 'http://glpi/apirest.php/killSession'); curl_setopt($curl, CURLOPT_POST, false); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); $out = curl_exec($curl); curl_close($curl); } ?&gt;</span></span></code> </pre> <br><p>  The result of this script will be an added query in the incident recording system in GLPI.  In pictures it looks like this: </p><br><p>  We write the message to mattermost: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c17/8f1/539/c178f1539ad3d37673927530edcf2797.png" alt="image"></p><br><p>  Go to GLPI "Support" -&gt; "Requests" and a new message should appear in the list: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5e4/adc/41c/5e4adc41cb07c63e45dda24efb603f68.png" alt="image"></p><br><p>  By clicking on the message header, more detailed information will open (the red outlined fields, the values ‚Äã‚Äãof which are transmitted in the script) </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/1ea/ea4/90f/1eaea490fb1b3ca94282eba05f86e5d5.png" alt="image"></p><br><p>  At this, the setting for sending messages to GLPI from the Mattermost can be considered complete.  Having worked a little on the code, nothing can prevent a change in the type of request (incident or request). </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/442402/">https://habr.com/ru/post/442402/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../442378/index.html">One click in the interface of Booking com can ruin a vacation or why a working rating system is important.</a></li>
<li><a href="../442380/index.html">Arrange chaos</a></li>
<li><a href="../442384/index.html">Expanding the functionality of the standard audio system</a></li>
<li><a href="../442386/index.html">Thymeleaf: Layout + Spring Boot 2 Dialect</a></li>
<li><a href="../442396/index.html">Digital events in Moscow from March 4 to March 10</a></li>
<li><a href="../442404/index.html">Mattermost. Integration with external services (part 2)</a></li>
<li><a href="../442406/index.html">Fintech Digest: free transfers in the SBP system, banks' vulnerability to attacks and other news</a></li>
<li><a href="../442408/index.html">Universal machine for carrying out tests do yourself part 1</a></li>
<li><a href="../442414/index.html">Studying at a foreign university from the first person</a></li>
<li><a href="../442416/index.html">Digest of research and development of ITMO University: discussing trends and new achievements of scientists</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>