<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Java REPL you do not ScriptEngine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! My name is Dima, I am a developer in the ‚ÄúArchitecture‚Äù team at hh.ru. Among other things, I make things easier for colleagues. Running c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Java REPL you do not ScriptEngine</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/mc/gi/1x/mcgi1xfknvfwnybvbjp4oci2v0q.jpeg"><br><br>  Hello, Habr!  My name is Dima, I am a developer in the ‚ÄúArchitecture‚Äù team at hh.ru.  Among other things, I make things easier for colleagues.  Running code in production is a typical task.  So when I heard that there are problems with this, I decided to fix them. <br><br>  Not always data changes can be made simple UPDATE / INSERT - sometimes you need to use validation, event buses, and more.  In such cases, the most optimal solution is to execute arbitrary code directly in the application.  We have Java, so when <a href="https://openjdk.java.net/jeps/222">JEP-222 appeared</a> , I immediately thought that JShell might be able to make scripting convenient again.  A miracle did not happen, and therefore under the cut you will find a not very deep comparison of the most famous Java interpreters (and "near-Java") for jvm with examples.  I invite everyone interested under cat. <br><a name="habracut"></a><br>  To run the scripts, we use <a href="https://github.com/beanshell/beanshell">BeanShell</a> , and for 2019 it is terrible: the last release from <a href="">2016</a> , the lack of support for lambdas and even generics - all this forces us to write code that no one has written since Java <a href="https://jcp.org/en/jsr/detail%3Fid%3D14">1.4</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Criteria </h3><br><br>  Before starting the comparison, we formulate the requirements for the built-in scripting engine.  Having scratched my head, I made up the following list: <br><br><ol><li>  support for current java syntax; </li><li>  the ability to pass an external context to the interpreter; </li><li>  ability to interrupt execution; </li><li>  ability to redirect I / O; </li><li>  informative feedback. </li></ol><br>  The more the language in which we write scripts resembles the one we are developing, the fewer errors - hands remember.  But when we make mistakes that were identified at the compilation stage, they should allow the developer to fix them - these are indications of the names of missing variables, lines, stacktracks etc. <br>  Next, the scripts should work in a specific context, with access to the Spring context, to the logger that will serve the scripts.  Without such an opportunity to transfer the context, its receipt turns into a quest. <br>  If the error nevertheless leaked into runtime, then restarting the entire instance to stop execution is a bad idea, so you need to be able to simply interrupt the execution of the script at any time. <br>  And the last - any messages to the system output during the script work only make sense in the context of this script.  In system logs, such a conclusion is of little use.  Therefore, I want to be able to redirect these messages in response. <br><br>  So let's go <br><br><h2>  <a href="">Jshell</a> </h2><br><br><ul><li>  support for current java syntax - <b>yes</b> </li><li>  the ability to convey context - <b>no</b> </li><li>  ability to interrupt execution - <b>yes</b> </li><li>  the ability to redirect I / O - <b>no</b> </li><li>  informative feedback - <b>yes</b> </li></ul><br>  I <u>must</u> say right <abbr title="Read-Eval-Print Loop">away</abbr> that <a href="https://openjdk.java.net/jeps/222">JEP-222</a> <u>does not</u> aim to create an embedded interpreter - its purpose is <abbr title="Read-Eval-Print Loop">REPL</abbr> , that is, the ability to quickly prototype code.  This is fraught with a number of consequences. <br><br>  First, life did not prepare the Java compiler for the fact that it is possible to declare a method outside the class, and in the body of the method to use variables that have not yet been declared.  Therefore, execution itself is hidden behind an impressive layer of abstraction. <br><br>  Secondly, REPL may well be executed not locally, but somewhere on a remote machine, so the API is made with such features in mind.  I think this is the main reason why the API does not have the ability to pass an external context to the interpreter and redirect I / O. <br>  In addition, there are different startup modes - <a href="">remote</a> when the shell connects to the machine via JDI, and <a href="">local</a> .  Since there is no possibility to convey the context programmatically, but we still really want to, the hope remains only in the local mode and that we can use <a href="">code generation</a> <br>  But, unfortunately, the local mode was clearly not conceived as the main one - <a href="">this kind of script</a> calls the <a href="">deadlock</a> on the compiler.  Despite the fact that the same code in JDI mode works without problems. <br><br>  Thus, I had to abandon the use of JShell, although in general the API is strange, but understandable - we give the script to the input, we get the stream of events, for each of them we can check the status, get errors and billing information.  Errors allow us to identify the expression in which it was allowed: <br><br><img src="https://habrastorage.org/webt/wz/4e/av/wz4eavhtrgwv8bbmgdff1pyigxe.png"><br><br><h2>  <a href="">Beanshell</a> </h2><br><br><ul><li>  support for current java syntax - <b>no</b> </li><li>  the ability to convey context - <b>yes</b> </li><li>  ability to interrupt execution - <b>yes</b> </li><li>  the ability to redirect I / O - <b>yes (but requires the use of special methods)</b> </li><li>  informative feedback - <b>yes</b> </li></ul><br>  Failure made us pay attention to what we are using now.  After a long break, the project seemed to come to life, and judging by the <a href="">roadmap</a> , it is confidently moving towards a release that will solve all our problems - a lot of features should work now. <br><br>  At the time of this writing, beanshell did indeed support generics, but lambdas still don't work.  Perhaps by the release of the situation the situation will change. <br>  But in terms of integration, the engine is quite friendly - support for standard javax.scripting, runtime errors are verbose enough: <br><br><img src="https://habrastorage.org/webt/xi/ir/xd/xiirxd41tinmhew-sjo9pveqmna.png"><br><br>  However, using lambda-free streams is hell that burns in hell.  It might even be easier to write in another language.  So I decided to take a closer look at the "near-java" segment.  And the first candidate for the role of a script interpreter here, of course <br><br><h2>  <a href="">Kotlin</a> </h2><br><ul><li>  support for current java syntax - <b>no</b> </li><li>  the ability to convey context - <b>no</b> </li><li>  ability to interrupt execution - <b>yes</b> </li><li>  the ability to redirect I / O - <b>no</b> </li><li>  informative feedback - <b>yes</b> </li></ul><br>  Java code, with much luck, will be valid kotlin code.  But I didn‚Äôt succeed in launching anything at least somehow adequate on java in kotlin, but nevertheless let's try. <br>  Kotlin has <a href="https://discuss.kotlinlang.org/t/embedding-kotlin-as-scripting-language-in-java-apps/2211">announced javax.scripting support</a> for a couple of years <a href="https://discuss.kotlinlang.org/t/embedding-kotlin-as-scripting-language-in-java-apps/2211">now</a> . <br><br>  The first problem we have to deal with is dependency-hell. <br>  Kotlin-compiler includes org.jdom classes that started to fight with org.jdom in the application and wrap it ... So, we have kotlin-compiler-embeddable, where all these classes are put into custom packages. <br><br>  However, after configuration, it turns out that the transfer of the external context does not work.  And now this is a serious problem, until its solution it makes no sense to dig deeper.  If you know what the problem is there and how to fix it - write in the comments. <br><br>  Errors are also quite verbose: <br><br><img src="https://habrastorage.org/webt/ua/mc/hu/uamchuyhpqrfrnttdj3z0iy0uew.png"><br><br><h2>  <a href="https://github.com/dzharikhin/java-interpreter-comparison/tree/master/groovy-example/src/main/java/org/jrx/interpreter/groovy">Groovy</a> </h2><br><br><ul><li>  support for current java syntax - <b>no, but there are analogues</b> </li><li>  the ability to convey context - <b>yes</b> </li><li>  ability to interrupt execution - <b>yes</b> </li><li>  the ability to redirect I / O - <b>yes</b> </li><li>  informative feedback - <b>yes</b> </li></ul><br>  Grooves, in addition to supporting javax.scripting, provides its own, more advanced API for interpreter integration.  For example, it is possible to pass an AST transformation, which allows you to add a <a href="">conditional interrupt after each expression</a> .  The thing is so powerful that it‚Äôs already <a href="">scary</a> . <br><br>  Moreover, Java (and especially beanshell) code can be quite valid groove code. <br>  Integration and test operation was successful, with the exception of sheet initialization and lambda syntax (they have to be wrapped in curly braces), the existing binshell scripts worked without problems.  Errors are more than verbose: <br><br><img src="https://habrastorage.org/webt/zz/fw/qt/zzfwqttombtbu8kw7bnc6dpf4oq.png"><br><br>  Perhaps today it is the only interpreter that, on the one hand, allows you to write code for the sample in 2019, and on the other hand, it meets all the requirements that it is reasonable to present to the interpreter. <br><br><h3>  What conclusions can we draw? </h3><br>  First and foremost: REPL is not a scripting engine.  It may seem that from the command line to integration into the application one step, but upon closer examination it turns out that these tools have different tasks, sometimes contradicting each other. <br><br>  The second - today there is not a single tool for executing scripts in Java, so if you need such a tool, be prepared to learn a new syntax. </div><p>Source: <a href="https://habr.com/ru/post/461027/">https://habr.com/ru/post/461027/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461013/index.html">Reserving internet connection</a></li>
<li><a href="../461015/index.html">Live and learn. Part 2. University: 5 years or 5 corridors?</a></li>
<li><a href="../461017/index.html">New GPU Tracking Algorithm: Wavefront Path Tracing</a></li>
<li><a href="../461019/index.html">How is life for developers in Iran</a></li>
<li><a href="../461021/index.html">Comet Lake - picture is clearing up</a></li>
<li><a href="../461029/index.html">A lake of marketing data - from monstrous tables to reports and visualizations</a></li>
<li><a href="../461031/index.html">We connect online maps to the navigator on the smartphone. Part 1 - standard raster maps</a></li>
<li><a href="../461033/index.html">Where does this config come from? [Debian / Ubuntu]</a></li>
<li><a href="../461035/index.html">Instructive episodes from the series Silicon Valley (Season 1)</a></li>
<li><a href="../461037/index.html">And here I am ‚Äúreal‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>