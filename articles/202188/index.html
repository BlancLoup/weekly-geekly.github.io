<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>HTML Purifier. Expanding opportunities</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Just a couple of paragraphs, I will pay attention to the features of the interaction of this library with the framework Yii, the rest is fully univers...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>HTML Purifier. Expanding opportunities</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/7b4/44e/925/7b444e9250e31a0f845e8e5f54936935.jpg"><br>  <i>Just a couple of paragraphs, I will pay attention to the features of the interaction of this library with the framework Yii, the rest is fully universal and will be interesting to anyone who uses or plans to use this library.</i> <br><br>  <i>If you are already familiar with Purifier, feel free to start reading <a href="https://habr.com/ru/company/smartprogress/blog/202188/">from here.</a></i> <br><br><h5>  A little bit about HTML Purifier </h5><br>  If you have not heard of such an excellent library (and the search on Habr√© speaks of not so much popularity) as <a href="http://htmlpurifier.org/">HTML Purifier</a> , I advise you to take a closer look at it, especially if your users generate content in html format.  This can be an ordinary user, a moderator, or even an administrator. <br>  What does this library do? <br>  According to the configuration, it clears any html code from all malicious, non-valid, prohibited (your configuration) parts of the code, including individual attributes. <br><a name="habracut"></a><br><h5>  Less words, more code </h5><br>  I think a couple of examples will speak for themselves. <br><pre><code class="php hljs">$config = HTMLPurifier_Config::createDefault(); $config-&gt;set(<span class="hljs-string"><span class="hljs-string">'Attr.AllowedClasses'</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'header'</span></span>)); <span class="hljs-comment"><span class="hljs-comment">//  Attr.ForbiddenClasses   CSS  $config-&gt;set('AutoFormat.AutoParagraph',true); //   &lt;p&gt;     $config-&gt;set('AutoFormat.RemoveEmpty',true); //   ,  * $config-&gt;set('HTML.Doctype','HTML 4.01 Strict'); //      &lt;strike&gt; $purifier = new HTMLPurifier($config); $clean_html = $purifier-&gt;purify($html);</span></span></code> </pre> <br>  <i>* - <a href="http://htmlpurifier.org/live/configdoc/plain.html">RemoveEmpty Exceptions</a></i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Source html:</b> <br><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">invalidAttribute</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"value"</span></span></span><span class="hljs-tag">&gt;</span></span>,    <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strike</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strike</span></span></span><span class="hljs-tag">&gt;</span></span>:<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>  - <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">invalidTag</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">invalidTag</span></span></span><span class="hljs-tag">&gt;</span></span>,<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"header error"</span></span></span><span class="hljs-tag">&gt;</span></span> - ,<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>  - ! <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript">alert(</span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">"hacked by Alexander Blok"</span></span></span><span class="actionscript">);</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  <b>The result of the <i>purify</i> function</b> <br><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>,    <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-decoration:line-through;"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span>:<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>  - ,<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"header"</span></span></span><span class="hljs-tag">&gt;</span></span> - ,<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> - !<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  <a href="http://htmlpurifier.org/live/configdoc/plain.html">The number of settings is</a> impressive and gives you the opportunity out of the box to get those buns that you need. <br><br><a name="pearl_buttons"></a><br><h5>  "Pearl Buttons" </h5><br>  But there would not be this post, if, as usual, we did not want something special, namely two things: <br><ol><li>  Replace all links to external sites with our site.ru/redirect?url=link link </li><li>  Add target attribute = _blank to all user links </li></ol><br>  The tasks did not seem too complicated, there is a good <a href="http://htmlpurifier.org/docs/enduser-uri-filter.html">article</a> on the docks in the first one, and the second is a bit too much - the HTML.TargetBlank config does the work for us. <br><br><h5>  Task 1 - replacing external links </h5><br>  Purifier has a great HTMLPurifier_URIFilter class and equally great <a href="">examples of</a> how this filter is implemented. <br>  I took the DisableExternalResources file as a basis and quickly rewrote it to fit my needs, namely replacing an external link with an internal one. <br><div class="spoiler">  <b class="spoiler_title">Filter file</b> <div class="spoiler_text">  A little description: <br>  In the <i>prepare</i> function we get the host of our site, divide by points, and expand the array. <br>  As a result, it gets array ('ru', 'site', 'subdomen'). <br>  In the <i>filter</i> function, we do the same with the user reference and compare the host, if it is the same, then we change nothing and return true, but if not, we create a new URI object with our address and insert a custom link into the GET parameter. <br>  <b>Important</b> The filter method should not return anything other than true or false.  Do not try to replace the link by returning it via return. <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HTMLPurifier_URIFilter_MakeRedirect</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HTMLPurifier_URIFilter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@type</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $name = <span class="hljs-string"><span class="hljs-string">'MakeRedirect'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@type</span></span></span><span class="hljs-comment"> array */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $ourHostParts = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> HTMLPurifier_Config $config * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($config)</span></span></span><span class="hljs-function"> </span></span>{ $our_host = $config-&gt;getDefinition(<span class="hljs-string"><span class="hljs-string">'URI'</span></span>)-&gt;host; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($our_host !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ourHostParts = array_reverse(explode(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, $our_host)); } } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> HTMLPurifier_URI $uri Reference * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> HTMLPurifier_Config $config * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> HTMLPurifier_Context $context * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$uri, $config, $context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_null($uri-&gt;host)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ourHostParts === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } $host_parts = array_reverse(explode(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, $uri-&gt;host)); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ourHostParts <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $i =&gt; $x) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($host_parts[$i]) || $host_parts[$i] != <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ourHostParts[$i]) { $path = Yii::app()-&gt;createUrl(<span class="hljs-string"><span class="hljs-string">'site/redirect'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  Yii,      url manager       /action,    $query = 'url='.urlencode($uri-&gt;toString()); $uri = new HTMLPurifier_URI('http', null, Yii::app()-&gt;request-&gt;getServerName(), // return $_SERVER['SERVER_NAME'] null, $path, $query, null); break; } } return true; } }</span></span></code> </pre><br></div></div><br><h5>  Apply filter </h5><br>  To do this, as the documentation suggests, we need to refer to the HTMLPurifier_Config object. <br><pre> <code class="php hljs"> $config = HTMLPurifier_Config::createDefault(); $uri = $config-&gt;getDefinition(<span class="hljs-string"><span class="hljs-string">'URI'</span></span>); $uri-&gt;addFilter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HTMLPurifier_URIFilter_MakeRedirect(), $config); $purifier = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HTMLPurifier($config); $clean_html = $purifier-&gt;purify($html);</code> </pre><br><h6>  Paragraph for happy users Yii </h6><br>  I am one of them ( <s>and no regrets</s> ).  Yii <a href="http://www.yiiframework.com/doc/api/1.1/CHtmlPurifier">out of the box</a> supports Purifier, but not everything is so smooth. <br>  <i>Example from documentation:</i> <br><pre> <code class="php hljs">$p = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CHtmlPurifier(); <span class="hljs-comment"><span class="hljs-comment">//   Yii $p-&gt;options = array('URI.AllowedSchemes'=&gt;array('http' =&gt; true, 'https' =&gt; true,)); //      $text = $p-&gt;purify($text);</span></span></code> </pre><br>  From there, we learn: <br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> mixed the options to be passed to HTML Purifier instance. * This can be a HTMLPurifier_Config object, an array of directives (Namespace.Directive =&gt; Value) * or the filename of an ini file. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@see</span></span></span><span class="hljs-comment"> http://htmlpurifier.org/live/configdoc/plain.html */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_options=<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>;</code> </pre><br>  It seems that everything is fine, you can pass an HTMLPurifier_Config object instead of an array, try: <br><pre> <code class="php hljs"> $purifier = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CHtmlPurifier(); $config = HTMLPurifier_Config::createDefault(); $config-&gt;set(<span class="hljs-string"><span class="hljs-string">'AutoFormat.RemoveEmpty'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $uri = $config-&gt;getDefinition(<span class="hljs-string"><span class="hljs-string">'URI'</span></span>); $uri-&gt;addFilter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HTMLPurifier_URIFilter_MakeRedirect(), $config); $purifier-&gt;options = $config; $clean_html = $purifier-&gt;purify($html);</code> </pre><br><pre> <code class="php hljs"> Warning Base directory /framework/vendors/htmlpurifier/standalone/HTMLPurifier/DefinitionCache/Serializer does not exist, please create <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> change using %Cache.SerializerPath</code> </pre><br>  Here we do not get upset and go into the <s>Goggle</s> CHtmlPurifier <s>mana</s> and find out that you need to set the Cache.SerializerPath parameter with the value Yii :: app () -&gt; getRuntimePath (), this will allow the driver to use this folder to store the cache <br>  We do: <br><pre> <code class="php hljs">$purifier = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CHtmlPurifier(); $config = HTMLPurifier_Config::createDefault(); $config-&gt;set(<span class="hljs-string"><span class="hljs-string">'AutoFormat.RemoveEmpty'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $config-&gt;set(<span class="hljs-string"><span class="hljs-string">'Cache.SerializerPath'</span></span>,Yii::app()-&gt;getRuntimePath()); <span class="hljs-comment"><span class="hljs-comment">// &lt;-- $uri = $config-&gt;getDefinition('URI'); $uri-&gt;addFilter(new HTMLPurifier_URIFilter_MakeRedirect(), $config); $purifier-&gt;options = $config; $clean_html = $purifier-&gt;purify($html);</span></span></code> </pre><br><pre> <code class="php hljs">Cannot set directive after finalization invoked on line <span class="hljs-number"><span class="hljs-number">127</span></span> in file /framework/web/widgets/CHtmlPurifier.php</code> </pre><br>  Now the driver does not like the fact that we define the parameter twice.  And CHtmlPurifier does it itself in the createNewHtmlPurifierInstance () method <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createNewHtmlPurifierInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_purifier=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HTMLPurifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOptions()); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_purifier-&gt;config-&gt;set(<span class="hljs-string"><span class="hljs-string">'Cache.SerializerPath'</span></span>,Yii::app()-&gt;getRuntimePath()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_purifier; }</code> </pre><br>  Here, I confess, I spent quite a bit of time looking for a beautiful solution, but alas.  I found nothing more beautiful than creating the GHtmlPurifier class and inheriting it from the CHtmlPurifier class by rewriting the createNewHtmlPurifierInstance () method. <br>  I put the new file in the <i>protected / components /</i> folder and the code finally worked. <br><pre> <code class="php hljs"> $htmlpurifier = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GHtmlPurifier(); $config = HTMLPurifier_Config::createDefault(); $config-&gt;set(<span class="hljs-string"><span class="hljs-string">'Cache.SerializerPath'</span></span>,Yii::app()-&gt;getRuntimePath()); $uri = $config-&gt;getDefinition(<span class="hljs-string"><span class="hljs-string">'URI'</span></span>); $uri-&gt;addFilter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HTMLPurifier_URIFilter_MakeRedirect(), $config); $htmlpurifier-&gt;options = $config; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $htmlpurifier-&gt;purify($text);</code> </pre><br><h5>  Task 2 - add target = _blank </h5><br>  I will not bother you with examples of non-working code and I will say right away that <a href="http://htmlpurifier.org/live/configdoc/plain.html">HTML.TargetBlank</a> works only with external links and its use is no longer necessary.  And URI filters cannot access the tag and its attributes. <br>  Already accustomed to good documentation on the library, I got into mana, but alas, the necessary <a href="http://htmlpurifier.org/docs/dev-advanced-api.html">Advanced API</a> section was empty and there was an inscription <i>‚ÄúFiled under Development‚Äù</i> . <br>  There was nothing left, how to plunge into the sources and find how the HTML.TargetBlank module is implemented. <br>  Here he is: <br><div class="spoiler">  <b class="spoiler_title">HTMLPurifier_AttrTransform_TargetBlank</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Adds target="blank" to all outbound links. This transform is * only attached if Attr.TargetBlank is TRUE. This works regardless * of whether or not Attr.AllowedFrameTargets */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HTMLPurifier_AttrTransform_TargetBlank</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HTMLPurifier_AttrTransform</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $parser; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;parser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HTMLPurifier_URIParser(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transform</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($attr, $config, $context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($attr[<span class="hljs-string"><span class="hljs-string">'href'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $attr; } <span class="hljs-comment"><span class="hljs-comment">// XXX Kind of inefficient $url = $this-&gt;parser-&gt;parse($attr['href']); $scheme = $url-&gt;getSchemeObj($config, $context); if ($scheme-&gt;browsable &amp;&amp; !$url-&gt;isBenign($config, $context)) { $attr['target'] = '_blank'; } return $attr; } }</span></span></code> </pre><br></div></div><br>  It was decided to create our own module, which will not include checking for external address, but will add target = _blank to all links that it finds. <br>  I think everyone can handle copying and deleting a pair of lines in the transform method.  Therefore, the listing will not result.  It is important not to forget to change the name of your module, I called it <i>HTMLPurifier_AttrTransform_TargetBlankAll</i> and put it in the same folder / protected / components /. <br>  But this was not enough, the module does not automatically pick up, and we need to create a class that will add a module to our configuration.  In the code I added a couple of comments, which was clear what needs to be changed if you want to write your own module. <br><div class="spoiler">  <b class="spoiler_title">HTMLPurifier_HTMLModule_TargetBlankAll.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HTMLPurifier_HTMLModule_TargetBlankAll</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HTMLPurifier_HTMLModule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $name = <span class="hljs-string"><span class="hljs-string">'TargetBlankAll'</span></span>; <span class="hljs-comment"><span class="hljs-comment">//      .     public function setup($config) { $a = $this-&gt;addBlankElement('a'); // ,        A $a-&gt;attr_transform_post[] = new HTMLPurifier_AttrTransform_TargetBlankAll(); //       //      $a-&gt;attr_transform_pre[] } }</span></span></code> </pre><br></div></div><br>  I also added this file to the / protected / components folder. <br>  Now it remains to add this module to our config and enjoy the result.  This is not entirely logical.  We need to get a reference to the HTML object, with the $ raw = true parameter, so that it is initialized and the __construct () method works in the HTMLPurifier_HTMLDefinition class. <br>  In the __construct () method, the $ this-&gt; manager variable is initialized, which we will use to connect our module. <br><pre> <code class="php hljs"> $htmlpurifier = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GHtmlPurifier(); $config = HTMLPurifier_Config::createDefault(); $config-&gt;set(<span class="hljs-string"><span class="hljs-string">'Cache.SerializerPath'</span></span>,Yii::app()-&gt;getRuntimePath()); $uri = $config-&gt;getDefinition(<span class="hljs-string"><span class="hljs-string">'URI'</span></span>); $uri-&gt;addFilter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HTMLPurifier_URIFilter_MakeRedirect(), $config); $html = $config-&gt;getHTMLDefinition(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-comment"><span class="hljs-comment">//     HTMLPurifier_HTMLDefinition $html-&gt;manager-&gt;addModule('TargetBlankAll'); //      $htmlpurifier-&gt;options = $config; return $htmlpurifier-&gt;purify($text);</span></span></code> </pre><br>  <b>Ta-dam:</b> <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://site.ru/"</span></span></span><span class="hljs-tag">&gt;</span></span>http://site.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://habrahabr.ru/"</span></span></span><span class="hljs-tag">&gt;</span></span>http://habrahabr.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://site.ru/"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">target</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_blank"</span></span></span><span class="hljs-tag">&gt;</span></span>http://site.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://site.ru/redirect/?url=http%3A%2F%2Fhabrahabr.ru%2F"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">target</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_blank"</span></span></span><span class="hljs-tag">&gt;</span></span>http://habrahabr.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Both tasks are completed! <br><hr><br>  I hope this article introduced you to this wonderful tool and will help make your website more interesting and safer at the same time, giving your users the opportunity to create interesting content using all the features of html. <br><br>  <i>This library is no different fast, so do not use it for data output on the fly.</i> </div><p>Source: <a href="https://habr.com/ru/post/202188/">https://habr.com/ru/post/202188/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../202178/index.html">Run Linux on the Realtek RTL-1185 media processor</a></li>
<li><a href="../202180/index.html">The Smithsonian Institution digitizes its exhibits by sharing 3D models</a></li>
<li><a href="../202182/index.html">The first stable version of the JVM-language from RedHat - Ceylon</a></li>
<li><a href="../202184/index.html">Airplane debugging? It is very easy!</a></li>
<li><a href="../202186/index.html">Remembering the past. About what they did 5 years ago</a></li>
<li><a href="../202190/index.html">Lock-free data structures. Inside Memory management circuits</a></li>
<li><a href="../202192/index.html">Google won an 8-year lawsuit: now the Google Books project is free from the claims of the Authors Guild</a></li>
<li><a href="../202194/index.html">Chinese Hackspace: Chaihuo Make Space</a></li>
<li><a href="../202196/index.html">Samsung MultiScreen SDK beta</a></li>
<li><a href="../202202/index.html">Overview of Drupal Learning Materials</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>