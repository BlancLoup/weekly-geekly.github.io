<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The story about msdb size of 42 GB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, there was a minute to see why the old test server shamelessly slowed down ... I had nothing to do with it, but I was overwhelmed with sports...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The story about msdb size of 42 GB</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/b5a/c99/1c7/b5ac991c785d44ad815fdf298e1112da.png" align="left" height="270">  Recently, there was a minute to see why the old test server shamelessly slowed down ... I had nothing to do with it, but I was overwhelmed with sports interest to figure out what was wrong with it. <br><br>  First of all, opened the <i>Resource Monitor</i> and looked at the total load.  The <i>sqlserv.exe</i> process loaded the CPU at 100% and formed a large disk queue that was over 300 ... despite the fact that a value above one is already considered problematic. <br><br>  When analyzing disk activity, I noticed continuous <i>IO</i> operations in <i>msdb</i> : 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="1c hljs">D:\SQL_2012\SYSTEM\MSDBData.mdf D:\SQL_2012\SYSTEM\MSDBLog.ldf</code> </pre> <br>  Looked at the size of <i>msdb</i> : <br><br><pre> <code class="1c hljs">SELECT name, size = size * <span class="hljs-number"><span class="hljs-number">8</span></span>. / <span class="hljs-number"><span class="hljs-number">1024</span></span>, space_used = FILEPROPERTY(name, 'SpaceUsed') * <span class="hljs-number"><span class="hljs-number">8</span></span>. / <span class="hljs-number"><span class="hljs-number">1024</span></span> FROM sys.database_files</code> </pre><br>  and turned on hand-face mode: <br><br><pre> <code class="1c hljs">name size space_used ------------ -------------- --------------- MSDBData <span class="hljs-number"><span class="hljs-number">42626.000000</span></span> <span class="hljs-number"><span class="hljs-number">42410.374395</span></span> MSDBLog <span class="hljs-number"><span class="hljs-number">459.125000</span></span> <span class="hljs-number"><span class="hljs-number">6.859375</span></span></code> </pre><br>  The data file occupied 42 GB ... Taking a short pause, I began to understand the reason for such an unhealthy <i>msdb</i> volume and how to overcome problems with server performance. <br><a name="habracut"></a><br>  Checked resource-intensive requests that were performed on the server: <br><br><pre> <code class="1c hljs">SELECT r.session_id , db = DB_NAME(r.database_id) , r.[status] , p.[text] --, sql_text = SUBSTRING(p.[text], (r.statement_start_offset / <span class="hljs-number"><span class="hljs-number">2</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>, -- CASE WHEN r.statement_end_offset = -<span class="hljs-number"><span class="hljs-number">1</span></span> -- THEN <span class="hljs-number"><span class="hljs-number">2147483647</span></span> -- ELSE ((r.statement_end_offset - r.statement_start_offset) / <span class="hljs-number"><span class="hljs-number">2</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span> -- END) , r.cpu_time , r.total_elapsed_time , r.reads , r.writes , r.logical_reads FROM sys.dm_exec_requests r CROSS APPLY sys.dm_exec_sql_text(r.[sql_handle]) p WHERE r.[sql_handle] IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AND r.session_id != @@SPID ORDER BY logical_reads DESC</code> </pre><br>  In the first place is the system stored procedure proudly: <br><br><pre> <code class="1c hljs">db status text elapsed_time reads writes logical_reads -------- -------- ------------------------------------- ------------ ------- ------- --------------- msdb running create procedure [sys].[sp_cdc_scan] <span class="hljs-number"><span class="hljs-number">6739344</span></span> <span class="hljs-number"><span class="hljs-number">618232</span></span> <span class="hljs-number"><span class="hljs-number">554324</span></span> <span class="hljs-number"><span class="hljs-number">2857923422</span></span></code> </pre><br>  From the name of which you can guess that we are talking about the <i>CDC</i> ( <i>Change Data Capture</i> ), which is used as a means to track the changed data.  <i>CDC is</i> based on reading the transaction log and always works asynchronously by using <i>Service Broker</i> . <br><br>  Due to configuration problems, when you try to send <i>Event Notification</i> to <i>Service Broker</i> , the message may not reach the destination and then it will be archived in a separate table ... Badly said ... In general, if <i>Service Broker</i> is used frequently, then you need to monitor <i>sys.sysxmitqueue</i> .  When in this table there is a constant increase in data, then this is either a bug, or we incorrectly use <i>Service Broker</i> . <br><br>  This query can return a list of objects and their size: <br><br><pre> <code class="1c hljs">USE msdb GO SELECT TOP(<span class="hljs-number"><span class="hljs-number">10</span></span>) o.[object_id] , obj = SCHEMA_NAME(o.[schema_id]) + '.' + o.name , o.[type] , i.total_rows , i.total_size FROM sys.objects o JOIN ( SELECT i.[object_id] , total_size = CAST(SUM(a.total_pages) * <span class="hljs-number"><span class="hljs-number">8</span></span>. / <span class="hljs-number"><span class="hljs-number">1024</span></span> AS DECIMAL(<span class="hljs-number"><span class="hljs-number">18</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>)) , total_rows = SUM(CASE WHEN i.index_id IN (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) AND a.[type] = <span class="hljs-number"><span class="hljs-number">1</span></span> THEN p.[rows] END) FROM sys.indexes i JOIN sys.partitions p ON i.[object_id] = p.[object_id] AND i.index_id = p.index_id JOIN sys.allocation_units a ON p.[partition_id] = a.container_id WHERE i.is_disabled = <span class="hljs-number"><span class="hljs-number">0</span></span> AND i.is_hypothetical = <span class="hljs-number"><span class="hljs-number">0</span></span> GROUP BY i.[object_id] ) i ON o.[object_id] = i.[object_id] WHERE o.[type] IN ('V', 'U', 'S') ORDER BY i.total_size DESC</code> </pre><br>  After execution, I obtained the following results: <br><br><pre> <code class="1c hljs">object_id obj type total_rows total_size ----------- -------------------------------- ---- ------------ ----------- <span class="hljs-number"><span class="hljs-number">68</span></span> sys.sysxmitqueue S <span class="hljs-number"><span class="hljs-number">6543502968</span></span> <span class="hljs-number"><span class="hljs-number">37188.90</span></span> <span class="hljs-number"><span class="hljs-number">942626401</span></span> dbo.sysmail_attachments U <span class="hljs-number"><span class="hljs-number">70</span></span> <span class="hljs-number"><span class="hljs-number">2566.00</span></span> <span class="hljs-number"><span class="hljs-number">1262627541</span></span> dbo.sysmail_attachments_transfer U <span class="hljs-number"><span class="hljs-number">35</span></span> <span class="hljs-number"><span class="hljs-number">2131.01</span></span> <span class="hljs-number"><span class="hljs-number">1102626971</span></span> dbo.sysmail_log U <span class="hljs-number"><span class="hljs-number">44652</span></span> <span class="hljs-number"><span class="hljs-number">180.35</span></span> <span class="hljs-number"><span class="hljs-number">670625432</span></span> dbo.sysmail_mailitems U <span class="hljs-number"><span class="hljs-number">19231</span></span> <span class="hljs-number"><span class="hljs-number">123.39</span></span> <span class="hljs-number"><span class="hljs-number">965578478</span></span> dbo.sysjobhistory U <span class="hljs-number"><span class="hljs-number">21055</span></span> <span class="hljs-number"><span class="hljs-number">69.05</span></span> <span class="hljs-number"><span class="hljs-number">366624349</span></span> dbo.backupfile U <span class="hljs-number"><span class="hljs-number">6529</span></span> <span class="hljs-number"><span class="hljs-number">14.09</span></span> <span class="hljs-number"><span class="hljs-number">727673640</span></span> dbo.sysssispackages U <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">2.98</span></span> <span class="hljs-number"><span class="hljs-number">206623779</span></span> dbo.backupset U <span class="hljs-number"><span class="hljs-number">518</span></span> <span class="hljs-number"><span class="hljs-number">1.88</span></span> <span class="hljs-number"><span class="hljs-number">286624064</span></span> dbo.backupfilegroup U <span class="hljs-number"><span class="hljs-number">3011</span></span> <span class="hljs-number"><span class="hljs-number">1.84</span></span></code> </pre><br>  I must say that we will not disregard all the tables in this list.  But first you need to clear <i>sys.sysxmitqueue</i> . <br><br>  Delete data directly from <a href="https://technet.microsoft.com/en-us/library/dd576261%2528v%3Dsql.100%2529.aspx"><i>sys.sysxmitqueue</i></a> will not work, because this table is a system object <i>(S)</i> .  After a brief search, I found a way to get <i>SQL Server to</i> clear this table.  When creating a new <a href="https://social.technet.microsoft.com/Forums/sqlserver/en-US/e89ed1c8-14a3-4ebf-9516-e90687d15dda/how-to-purge-sysxmitqueue-table-in-msdb-sql-server-2005"><i>Service Broker</i></a> , all messages associated with the old broker are automatically deleted. <br><br><pre> <code class="1c hljs">USE msdb GO ALTER DATABASE msdb SET NEW_BROKER WITH ROLLBACK IMMEDIATE</code> </pre><br>  But before executing the command, it is strongly recommended to disable <i>SQL Server Agent</i> and transfer <i>SQL Server</i> to <i>Single-User Mode</i> .  Deleting existing messages in all <i>Service Broker</i> queues took me about ten minutes.  Upon completion, I received the following message: <br><br><pre> <code class="1c hljs">Nonqualified transactions are being rolled back. Estimated rollback completion: <span class="hljs-number"><span class="hljs-number">100</span></span>%.</code> </pre><br>  After the restart of the <i>SQL Server</i> service, all the performance problems were gone ... my soul was happy and we could put an end to this.  But remember that this was not the only large table in <i>msdb</i> .  Let's deal with the rest ... <br><br>  For those who like to send mail through <i>Database Mail,</i> you need to know that <i>SQL Server</i> logs and stores all mailing lists in msdb.  All email attachments that are sent with the body of the letter are neatly stored there ... Therefore, it is highly recommended to periodically clear this information.  You can do it with your hands, i.e.  see which tables need to be cleaned: <br><br><pre> <code class="1c hljs">SELECT o.name, p.[rows] FROM msdb.sys.objects o JOIN msdb.sys.partitions p ON o.[object_id] = p.[object_id] WHERE o.name LIKE 'sysmail%' AND o.[type] = 'U' AND p.[rows] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  Or use the ready-made <a href="https://msdn.microsoft.com/en-us/library/ms190293.aspx"><i>sysmail_delete_mailitems_sp</i></a> and <a href="https://msdn.microsoft.com/en-us/library/ms189810.aspx"><i>sysmail_delete_log_sp</i></a> stored procedures: <br><br><pre> <code class="1c hljs">DECLARE @DateBefore DATETIME SET @DateBefore = DATEADD(DAY, -<span class="hljs-number"><span class="hljs-number">7</span></span>, GETDATE()) EXEC msdb.dbo.sysmail_delete_mailitems_sp @sent_before = @DateBefore --, @sent_status = 'sent' EXEC msdb.dbo.sysmail_delete_log_sp @logged_before = @DateBefore</code> </pre><br>  The <i>SQL Server Agent</i> job history is also saved in <i>msdb</i> .  When there are a lot of records in the log, it is not very convenient to work with it, so I try to clean it <a href="https://msdn.microsoft.com/en-us/library/ms175044.aspx"><i>sp_purge_jobhistory from time to time</i></a> : <br><br><pre> <code class="1c hljs">DECLARE @DateBefore DATETIME SET @DateBefore = DATEADD(DAY, -<span class="hljs-number"><span class="hljs-number">7</span></span>, GETDATE()) EXEC msdb.dbo.sp_purge_jobhistory @oldest_date = @DateBefore</code> </pre><br>  Still it is necessary to mention, about the information on backup copies which are logged in <i>msdb</i> .  You can delete old entries about created backups <a href="https://msdn.microsoft.com/en-us/library/ms188328.aspx"><i>sp_delete_backuphistory</i></a> : <br><br><pre> <code class="1c hljs">DECLARE @DateBefore DATETIME SET @DateBefore = DATEADD(DAY, -<span class="hljs-number"><span class="hljs-number">120</span></span>, GETDATE()) EXEC msdb.dbo.sp_delete_backuphistory @oldest_date = @DateBefore</code> </pre><br>  But one thing to keep in mind is that when you delete a database, its backup records are not removed from <i>msdb</i> : <br><br><pre> <code class="1c hljs">USE [master] GO IF DB_ID('backup_test') IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> BEGIN ALTER DATABASE [backup_test] SET SINGLE_USER WITH ROLLBACK IMMEDIATE DROP DATABASE [backup_test] END GO CREATE DATABASE [backup_test] GO BACKUP DATABASE [backup_test] TO DISK = N'backup_test.bak' GO DROP DATABASE [backup_test] GO SELECT * FROM msdb.dbo.backupset WHERE database_name = 'backup_test'</code> </pre><br>  In my case, when databases are often created and deleted, this can lead to an increase in <i>msdb</i> .  In a situation when backup information is not needed, you can delete it with the <a href="https://msdn.microsoft.com/en-us/library/ms178645.aspx"><i>sp_delete_database_backuphistory</i></a> : <br><br><pre> <code class="1c hljs">EXEC msdb.dbo.sp_delete_database_backuphistory @database_name = N'backup_test'</code> </pre><br>  <b>Small conclusions ...</b> <br><br>  The <i>msdb</i> system database <i>is</i> used by many components of <i>SQL Server</i> , such as <i>Service Broker</i> , <i>SQL Server Agent,</i> and <i>Database Mail</i> , for example.  It should be noted that there is no ready maintenance plan that would take into account what was written above, so it is important to periodically take preventive measures.  In my case, after removing unnecessary information and truncating a file, the size of <i>msdb</i> became 200 MB against the original 42 GB. <br><br>  I hope this post left an instructive story about the benefits of continuous administration ... not only user but also system databases. <br><br>  If you want to share this article with an English-speaking audience: <br>  <a href="http://blog.devart.com/reduce-msdb-big-size.html">How to reduce MSDB size from 42Gb to 200Mb</a> </div><p>Source: <a href="https://habr.com/ru/post/273633/">https://habr.com/ru/post/273633/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../273621/index.html">Playing in the hospital or as we studied and tested the work of the health care system in a European country</a></li>
<li><a href="../273623/index.html">The Hacking PostgreSQL course is coming soon</a></li>
<li><a href="../273625/index.html">Webolomka 2016</a></li>
<li><a href="../273627/index.html">Corporate GitHub: how Azure increased the number of employees on GitHub to two thousand</a></li>
<li><a href="../273629/index.html">Accidents are not accidental?</a></li>
<li><a href="../273635/index.html">Autonomous robot runs on the "eight"</a></li>
<li><a href="../273637/index.html">Spotify: User Interface Formation</a></li>
<li><a href="../273639/index.html">The main prize of a series of marathons "Mastercard" Master of Code took the team from Singapore</a></li>
<li><a href="../273645/index.html">Loukost hosting dedicated servers in Russia. Is it possible to?</a></li>
<li><a href="../273649/index.html">The history of victory at the annual competition Russian AI Cup 2015</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>