<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The tale of the compressor, which can be called, but I do not remember how</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Your attention is provided not entirely New Year's story, in which there is a plot, intrigue, detective investigation, chase, deceit, the wisdom of th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The tale of the compressor, which can be called, but I do not remember how</h1><div class="post__text post__text-html js-mediator-article">  Your attention is provided not entirely New Year's story, in which there is a plot, intrigue, detective investigation, chase, deceit, the wisdom of the ancients and a happy ending.  Under the cut, you are expected by the archaeological excavations of the Habr era of perestroika and a pinch of x86 assembler to taste. <br><img src="https://habrastorage.org/files/38f/728/596/38f72859643e4736a60fd73d3d758572.jpg"><br><a name="habracut"></a><br><h4>  Outset </h4><br>  I love to play old computer games that were released in the late 80s - early 90s.  They have their own indescribable old-fashioned surroundings, the predominance of game mechanics and plot over expressive means, and other things for which people love old school.  When I was in high school, I got the game <a href="http://www.emuparadise.me/Abandonware_Games/Skycat_(1991)(Gamos)/94921">Skycat</a> from Gamos, which was a 2d shooter with puzzle elements.  I was interested in playing it, but I could not even pass the first level.  In those days, I was already interested in Pascal programming and managed to rest against the limited graphics capabilities of the <code>GRAPH.TPU</code> module, so I slowly began to join the world of the x86 assembler.  And then one day, looking at <a href="https://ru.wikipedia.org/wiki/IDA">IDA</a> them.  Comrade  Gilfanova and on the file <code>SKYCAT.EXE</code> weighing some 15 kilobytes, I made a rash decision: to conduct a full reverse engineering of an impassable game to find out what she had inside there.  I have been doing this fascinating process for many years in a very leisurely mode, and upon its completion I plan to share the results with the community (I hope that not in as many years now it‚Äôs much closer to a successful end than to the beginning).  But this article is not exactly about that. <br><br>  On the New Year's holidays 2016, I decided to amuse myself by playing <a href="https://ru.wikipedia.org/wiki/Sid_Meier%2527s_Civilization">Sid Meier's Civilization</a> at the most difficult level.  As you already understood, I‚Äôm pretty crooked as a gamer, so after a couple of unsuccessful games I decided to look for the trainer in the game folder, <code>CIVHELP.EXE</code> , which does quite simple things - changes the year and the treasury in the game.  Having looked at the file size of 9 kilobytes and my moderately successful experience of reverse developing SkyCat, I made another rash decision - and why not pick something up, really!  IDA warned me with the message ‚ÄúPossibly packed file, continue?‚Äù, But in vain.  Miracles began under the hood. <br><br><h4>  Intrigue </h4><br>  After analyzing the file, the IDA produced a disappointing picture - a pitiful pinch of instructions for 300 bytes of weight was found in the file, everything else was detected as packed data.  Well, it doesn't matter - we will load into the Turbo Debugger, set a breakpoint right after unpacking, launch it, make a memory dump.  AND‚Ä¶ 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/96f/eae/754/96feae7543f644a9bd4ab7e38671539f.png"><br>  I got a pack of zeros instead of an unpacked program.  This happens when there is some kind of protection against debugging in the executable file, or the code is overwritten during the program execution.  In any case, the file cannot be unpacked for free, you need to at least have a look at the code of the unpacker. <br><br>  In order not to tire the reader, whose attention was probably dulled slightly from the New Year holidays, I will briefly describe what happens in these 300 Spartan bytes.  First, the unpacker code is moved to the higher memory addresses (so as not to lose its own code while unpacking), and the packed data segment is unpacked and transferred to the previous place.  These manipulations seemed to me not particularly complicated, but the code for the unpacker seemed familiar.  A similar thing unpacked sound files in SkyCat! <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/0LQaO908CCo%3Ffeature%3Doembed&amp;xid=17259,1500008,15700021,15700043,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgKbSRwLzRpoewrCs43P0Z6gxLSCw" frameborder="0" allowfullscreen=""></iframe><br>  <i>The voice of the robot in the screen saver is stored in a packed file</i> <br><br>  I was, to put it mildly, surprised.  It is useful to check the assembler code of the sound unpacker in SkyCat and the CIVHELP code.  They turned out to be identical up to the label name.  The conclusion suggested itself - the unpacker must be sufficiently known to get into two programs from different authors.  I did not wait for the third coming of the mysterious unpacker and decided to find out the name of the hero of the occasion.  But how to do it with a handful of assembly code? <br><br><h4>  Detective Investigation </h4><br>  The unpacker turned out to be not very difficult, therefore, picking up its code when analyzing SkyCat, I understood its working principle: read the control word from the input stream, read bit-by-bit commands from this word ‚Äî either copying a byte from the input stream to the output, or copying a part of an already decoded stream in the output, and when the control word is exhausted, scoop it again from the input stream until it is exhausted.  If the reader is not afraid of the ancient prophecies in the terrible x86 assembler language, then you can familiarize yourself with the received code <a href="http://pastebin.com/diW95quA">here</a> .  The rest of the university knowledge in my head suggested that <a href="https://ru.wikipedia.org/wiki/LZ77">the Lempel-Ziv algorithm</a> and all its numerous descendants were built on such an idea.  Accordingly, the circle of my searches narrowed (albeit only slightly) to the LZ family, leaving behind such remarkable manpower as <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25B4_%25D0%25A5%25D0%25B0%25D1%2584%25D1%2584%25D0%25BC%25D0%25B0%25D0%25BD%25D0%25B0">Huffman</a> , <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B5%25D0%25BE%25D0%25B1%25D1%2580%25D0%25B0%25D0%25B7%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%2591%25D0%25B0%25D1%2580%25D1%2580%25D0%25BE%25D1%2583%25D0%25B7%25D0%25B0_%25E2%2580%2594_%25D0%25A3%25D0%25B8%25D0%25BB%25D0%25B5%25D1%2580%25D0%25B0">Burrows, Wheeler</a> , <a href="https://ru.wikipedia.org/wiki/%25D0%2590%25D0%25BB%25D0%25B3%25D0%25BE%25D1%2580%25D0%25B8%25D1%2582%25D0%25BC_%25D0%25A8%25D0%25B5%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25BD%25D0%25B0_%25E2%2580%2594_%25D0%25A4%25D0%25B0%25D0%25BD%25D0%25BE">Fano and Shannon</a> .  Having studied the impressive <a href="https://en.wikibooks.org/wiki/Data_Compression/Dictionary_compression">list of LZ family algorithms</a> , I did not find a single implementation that used the approach of my mysterious decompressor - not to use when unpacking dictionaries, not to squander several bits per copy indication of a single character and other subtle points. <br><br>  The next idea (which, in fact, a reasonable person would come to mind first) - signature analysis.  Different programs often leave special byte markers in the files in order to understand which program has created this file and / or which program can read / edit / run it.  For example, DOS executables start with the characters <code>MZ</code> , BMP images contain the <code>BM</code> header.  As for SkyCat, I was sure that I knew the purpose of each byte, and therefore there could not have been any marks.  In the <code>CIVHELP.EXE</code> file <code>CIVHELP.EXE</code> after the unpacking code, there were 5 bytes of data, which, when converted to a string, looked like <code>*FAB*</code> .  A quick googling revealed that I could not find anything computer-based on this piece of text.  The attempt at signature analysis failed to fail before it began. <br><br>  In the excitement, I began to read on various websites about the successors of the Lempel and Ziv cases, to peer into their source codes, to study various logic of work, but nothing similar was found.  After several hours of searching, I came across a <a href="http://compression.ru/download/lz.html">collection of</a> various compressors with source codes, began downloading archives one by one, unpacking, viewing the source code ... and suddenly my eye caught the familiar assembler code! <br><br><h4>  Chase </h4><br><pre> <code class="lua hljs">; <span class="hljs-string"><span class="hljs-string">""</span></span> - ,     , ;         ;  (C)  <span class="hljs-number"><span class="hljs-number">1991</span></span></code> </pre><br>  The file <code>FROG.ASM</code> contained such an amusing description, and below it the code of the compressor itself!  It would seem that my search is over, but I still had a number of questions. <br>  In the folder with the compressor lay a document that read: <br><blockquote>  Yu. D. Krasilnikov.  File compression / expansion program and compressor .COM files. <br>  The motive for writing these programs was the article by I. Taranenko ‚ÄúThe procedure of data packing SQUEEZE‚Äù published earlier in Softpanoram.  The procedure used the principle of the packer LZEXE.  This algorithm is distinguished by simplicity, efficiency and very high speed of data unpacking. <br></blockquote><br>  Already from this it followed that Comrade Krasilnikov did not offer the packaging of EXE files, because Comrade Taranenko and the <code>LZEXE</code> utility were able to do this before him.  The further description stated that <code>FROG.ASM</code> is generally an auxiliary utility for unpacking, the COM-packer code is written in C. Who then packed <code>CIVHELP.EXE</code> and which program?  Why were the audio files in SkyCat packed as simple data? <br><br>  I decided to dig in the direction of <a href="http://bellard.org/lzexe.html">LZEXE</a> .  It turned out that its author, <a href="https://ru.wikipedia.org/wiki/%25D0%2591%25D0%25B5%25D0%25BB%25D0%25BB%25D0%25B0%25D1%2580,_%25D0%25A4%25D0%25B0%25D0%25B1%25D1%2580%25D0%25B8%25D1%2581">Fabrice Bellard,</a> is a very cool programmer, and I should be ashamed that I still didn‚Äôt know anything about him.  A mysterious line of <code>*FAB*</code> flashed through my head, and it became clear that this was the author's signature.  However, the source code of its remarkable compressor Fabris did not provide.  Some consolation was that Mitugu Currizono created the utility <code>UNLZEXE</code> , which razkoozhivala the result of life <code>LZEXE</code> to its original state.  Well, this is what we need!  I uncovered DosBox, typed in the command line <pre> <code class="bash hljs">UNLZEXE.EXE CIVHELP.EXE</code> </pre><br>  and got the message <br><pre> <code class="bash hljs">CIVHELP.EXE is not LZEXE file</code> </pre><br><br><h4>  Deceit </h4><br>  - Yes, what is it!  - I thought.  - This line <code>*FAB*</code> not be in the file just like that! <br><br>  Fortunately, at my disposal was a file <code>UNLZEXE.C</code> with a very concise source code.  From it it became clear that for unpacking in the EXE-file at offset <code>1C</code> should be located the line <code>"LZ91"</code> .  We correct with HEX-editor 4 bytes - voila!  We get as many as 12 from 8 kilobytes, the file is launched, IDA shows a large pile of code and a small group of human-readable lines.  For some reason, the title turned out to be insidious bytes, I do not know.  Fabrice claims that he released only two versions of the compressor, and both signatures were in place.  My guess is that it was done by hand to mask the traces of using a compressor.  Why was it to do when creating a small trainer for saves - a separate mystery. <br><br><h4>  The wisdom of the ancients </h4><br>  There was one question left - the origin of the compressor in the game SkyCat.  I have no exact answer, but there is a guess.  The frog program described above was published in <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BE%25D1%2584%25D1%2582%25D0%25BF%25D0%25B0%25D0%25BD%25D0%25BE%25D1%2580%25D0%25B0%25D0%25BC%25D0%25B0">Softpanoram, a</a> programmer‚Äôs newsletter, founded in 1989 by Nikolai Bezrukov.  The main objectives of "Softpanorama" were the free exchange of programs in source codes and protection against computer viruses.  Since the community was born earlier than Fidonet spread in the country, communication took place by sending and copying floppy disks.  It turns out this prehistoric Habr with a bias in programming, which deserves a separate serious article (and it is very desirable that someone from the then active participants write it).  I think it is likely that after reading one of the editions of "Softpanoram" the developers of the domestic company Gamos could borrow open source code from the national programmer Krasilnikov. <br><br><h4>  Happy ending </h4><br>  Since my search for the origin of the mysterious algorithm was crowned with success, I calmed down and was satisfied.  And the immersion in the <a href="http://www.softpanorama.org/Bulletin/index.shtml">archive of "Softpanorama"</a> brought me to the unforgettable world of programming news of the nineties, which to some extent made me happy.  I advise you to take part in the spirit of the era. </div><p>Source: <a href="https://habr.com/ru/post/274461/">https://habr.com/ru/post/274461/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274449/index.html">Own search by hand rutracker.org - implementation on Yii2</a></li>
<li><a href="../274451/index.html">Expansion of sections without data loss</a></li>
<li><a href="../274453/index.html">Black Hat USA 2015: the full story of the hacking of the very Jeep</a></li>
<li><a href="../274455/index.html">Creating a function on Rust that accepts a String or & str</a></li>
<li><a href="../274457/index.html">Defending Revel from CSRF attacks</a></li>
<li><a href="../274463/index.html">We write DXE-driver for taking screenshots from BIOS Setup and other UEFI-applications</a></li>
<li><a href="../274469/index.html">BlackEnergy Trojan is used in cyber attacks on media and industrial facilities in Ukraine</a></li>
<li><a href="../274471/index.html">Multiplication tables ... kind of</a></li>
<li><a href="../274473/index.html">Draw Elliptic Curves with SQL</a></li>
<li><a href="../274475/index.html">Rip network dictionaries using Node.js, part 1: static pages; CLI; DSL -> TXT, PDF, DjVu; related tasks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>