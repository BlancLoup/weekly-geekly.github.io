<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recovering data from CockroachDB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recovering data from cockroachdb is easy - just roll everything from backup. How not to make backups? For the base, which version 1.0 came out just si...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recovering data from CockroachDB</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/mw/cm/tx/mwcmtxbmix_ffcoh3-92ephiok8.jpeg" align="left" width="400">  Recovering data from cockroachdb is easy - just roll everything from backup.  How not to make backups?  For the base, which version 1.0 came out just six months ago?  Well, do not despair, most likely the data can be recovered.  I will talk about how I restored the database for my project of amusing social network in <a href="https://vbambuke.ru/">bamboo</a> and streaming this process on YouTube. <br><br><h3>  How will we recover </h3><br>  First you need to deal with what happened, why CockroachDB fell?  The reasons are different, but in any case the server no longer starts or does not respond to requests.  In my case, after a short googling, the base rocksdb was broken: <br><br><pre><code class="hljs go">E171219 <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>:<span class="hljs-number"><span class="hljs-number">36.541517</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> util/log/crash_reporting.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">82</span></span> a <span class="hljs-built_in"><span class="hljs-built_in">panic</span></span> has occurred! E171219 <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>:<span class="hljs-number"><span class="hljs-number">36.734485</span></span> <span class="hljs-number"><span class="hljs-number">74</span></span> util/log/crash_reporting.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">82</span></span> a <span class="hljs-built_in"><span class="hljs-built_in">panic</span></span> has occurred! E171219 <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>:<span class="hljs-number"><span class="hljs-number">37.241298</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> util/log/crash_reporting.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">174</span></span> Reported as error <span class="hljs-number"><span class="hljs-number">20</span></span>a3dd770da3404fa573411e2b2ffe09 <span class="hljs-built_in"><span class="hljs-built_in">panic</span></span>: Corruption: block checksum mismatch [recovered] <span class="hljs-built_in"><span class="hljs-built_in">panic</span></span>: Corruption: block checksum mismatch goroutine <span class="hljs-number"><span class="hljs-number">25</span></span> [running]: github.com/cockroachdb/cockroach/pkg/util/stop.(*Stopper).Recover(<span class="hljs-number"><span class="hljs-number">0xc4206c8500</span></span>, <span class="hljs-number"><span class="hljs-number">0x7fb299f</span></span>4b180, <span class="hljs-number"><span class="hljs-number">0xc4209d</span></span>e120) /<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>/src/github.com/cockroachdb/cockroach/pkg/util/stop/stopper.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">200</span></span> +<span class="hljs-number"><span class="hljs-number">0xb1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">panic</span></span>(<span class="hljs-number"><span class="hljs-number">0x1957a00</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4240398a0</span></span>) /usr/local/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>/src/runtime/<span class="hljs-built_in"><span class="hljs-built_in">panic</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">489</span></span> +<span class="hljs-number"><span class="hljs-number">0x2cf</span></span> github.com/cockroachdb/cockroach/pkg/storage.(*Store).processReady(<span class="hljs-number"><span class="hljs-number">0xc420223000</span></span>, <span class="hljs-number"><span class="hljs-number">0x103</span></span>) /<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>/src/github.com/cockroachdb/cockroach/pkg/storage/store.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">3411</span></span> +<span class="hljs-number"><span class="hljs-number">0x427</span></span></code> </pre> <a name="habracut"></a><br><h3>  Restoring RocksDB repository </h3><br>  If you beat rocksdb base, then to restore it to cockroach version 1.1, the necessary command is already built in: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs pgsql">$ cockroach <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span> rocksdb repair</code> </pre><br>  You may also need to specify the path to the data directory, if the path is custom. <br><br>  After recovery, you can try to restart cockroachdb.  In my case it did not help, but the error became different: <br><br><pre> <code class="hljs sql">E171219 13:12:47.618517 1 cli/error.go:68 cockroach server exited <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span>: cannot <span class="hljs-keyword"><span class="hljs-keyword">verify</span></span> <span class="hljs-keyword"><span class="hljs-keyword">empty</span></span> <span class="hljs-keyword"><span class="hljs-keyword">engine</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> bootstrap: unable <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">store</span></span> ident: <span class="hljs-keyword"><span class="hljs-keyword">store</span></span> has <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> been bootstrapped <span class="hljs-keyword"><span class="hljs-keyword">Error</span></span>: cockroach <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> exited <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span>: cannot <span class="hljs-keyword"><span class="hljs-keyword">verify</span></span> <span class="hljs-keyword"><span class="hljs-keyword">empty</span></span> <span class="hljs-keyword"><span class="hljs-keyword">engine</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> bootstrap: unable <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> <span class="hljs-keyword"><span class="hljs-keyword">store</span></span> ident: <span class="hljs-keyword"><span class="hljs-keyword">store</span></span> has <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> been bootstrapped</code> </pre><br>  Obviously, something was beaten somewhere in the settings, and I do not understand the cockroachdb storage format well enough to understand that it still doesn‚Äôt suffice.  Therefore, let's go the other way: we know that inside this Key-Value store and even approximately know what we need to look for, as the developers told ( <a href="https://www.cockroachlabs.com/blog/sql-in-cockroachdb-mapping-table-data-to-key-value-storage/">here</a> and <a href="https://www.cockroachlabs.com/blog/sql-cockroachdb-column-families/">here</a> ) about it in their blog. <br><br><h3>  We rip out data straight from RocksDB </h3><br>  Since the format of keys and records is approximately known to us, you can take a directory with data from a ‚Äúbroken‚Äù instance and try to go through all the keys and pull data directly from there.  I will talk about the single-host version, but if there are many hosts and the entire cluster has died, then you will need to learn how to remove duplicates and identify the latest key versions. <br><br>  We will write everything on go, of course.  At first I decided to try to take the <a href="https://github.com/tecbot/gorocksdb">github.com/tecbot/gorocksdb</a> library, and it even started up, but gave an error message that the comparator <code>cockroach_comparator</code> unknown to it.  I took the necessary comparator from the source code of the cockroach itself, but nothing has changed. <br><br>  Since I was too lazy to figure out what was happening, I decided to go a different way and just took and immediately prepared the package directly from the source code of the cockroachdb itself: everything in the package <a href="https://github.com/cockroachdb/cockroach/tree/master/pkg/storage/engine">github.com/cockroachdb/cockroach/pkg/storage/engine</a> is all that is needed for to work properly with KV-base. <br><br>  Therefore, we will open the database and start to iterate and try to look for the names of the keys, in the meaning of which there are some lines that we know for sure what is in the database: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/cockroachdb/cockroach/pkg/storage/engine"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { db, err := engine.NewRocksDB(engine.RocksDBConfig{ Dir: <span class="hljs-string"><span class="hljs-string">"/Users/yuriy/tmp/vbambuke"</span></span>, MustExist: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, engine.NewRocksDBCache(<span class="hljs-number"><span class="hljs-number">1000000</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatalf(<span class="hljs-string"><span class="hljs-string">"Could not open cockroach rocksdb: %v"</span></span>, err.Error()) } db.Iterate( engine.MVCCKey{Timestamp: hlc.MinTimestamp}, engine.MVCCKeyMax, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(kv engine.MVCCKeyValue)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> bytes.Contains([]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>(kv.Value), []<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>(<span class="hljs-string"><span class="hljs-string">"safari@apple.com"</span></span>)) { log.Printf(<span class="hljs-string"><span class="hljs-string">"Email key: %s"</span></span>, kv.Key) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }, ) }</code> </pre><br>  I got about this: <br><br><pre> <code class="hljs pgsql">Email key: /<span class="hljs-keyword"><span class="hljs-keyword">Table</span></span>/<span class="hljs-number"><span class="hljs-number">54</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">158473728194052097</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1503250869.243064075</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  This key has quite a lot of components, but this is what I managed to find out: <br><br>  0. Table means ‚Äútable‚Äù :) <br>  1. Table number (tables must be in the order of creation) <br>  2. Key type.  1 means normal entry, 2 means index <br>  3. The value of the primary key (1,2,3, ...) <br>  4. I do not know, apparently the version? <br>  5. timestamp <br><br>  That is, you can display all keys and their values ‚Äã‚Äãfor all tables in a separate file and split them by table number.  After that, it should become more or less clear how the tables are called (and what is their structure, because you have it preserved :)?). <br><br><h3>  Parse the format of records </h3><br>  I recovered data from cockroachdb version 1.0.4, so for later versions the details may differ.  But here's what I managed to understand: <br><br>  1. The first 6 bytes in the value can be ignored.  Apparently, this is a checksum of data and some other meta-information, for example, bits about nullable fields. <br>  2. Next are the data itself, and before each column, except the first, there is a separate byte with its type <br><br>  An example from the messages table (I used od to get a readable form of binary data): <br><br>  The structure of the messages table was as follows: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> messages ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SERIAL</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, user_id <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>, user_id_to <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>, is_out <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>, message <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>, ts <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> );</code> </pre><br><pre> <code class="hljs tex"><span class="hljs-formula"><span class="hljs-formula">$ head -n 2 messages | od -c 0000000 1 / 1 / 0 / 1 5 0 3 2 5 0 8 6 8 0000020 . 7 2 7 5 5 4 8 2 8 , 0 0000040 = 241 E 270 276 </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span></span><span class="hljs-formula"> # 202 200 230 316 0000060 316 ÀÅ ** 263 004 023 202 200 204 231 374 235 222 264 004 032 0000100 026 031 N ow I usereal 0000120 P ostgre SQL 023 230 277 256 217 0000140 240 320 375 342 ( </span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span></span><span class="hljs-formula"> 0000146</span></span></code> </pre><br>  Let's sort this data in order: <br><br>  1. First, in the file I wrote down the name of the key - in the fragment <br><pre> <code class="hljs">0000000 1 / 1 / 0 / 1 5 0 3 2 5 0 8 6 8 0000020 . 7 2 7 5 5 4 8 2 8 , 0 0000040 =</code> </pre> <br>  This is all a piece of the key from which we need to take the value of the primary key (the format of the keys is described above) <br><br>  2. Title.  On line 0000040 after the key there is a 6-byte header: <pre> <code class="hljs objectivec"><span class="hljs-number"><span class="hljs-number">241</span></span> E <span class="hljs-number"><span class="hljs-number">270</span></span> <span class="hljs-number"><span class="hljs-number">276</span></span> \n <span class="hljs-meta"><span class="hljs-meta">#</span></span></code> </pre>  it is always different, but for all my tables, the first 6 bytes needed to be simply skipped. <br><br>  3. The first field, user_id.  The numbers that I met in cockroachdb were always encoded by varint from the standard library.  The first column can be read <a href="https://golang.org/pkg/encoding/binary/">using binary.Varint</a> .  We will need to read the following piece: <br><pre> <code class="hljs cs"><span class="hljs-number"><span class="hljs-number">0000040</span></span> = <span class="hljs-number"><span class="hljs-number">241</span></span> E <span class="hljs-number"><span class="hljs-number">270</span></span> <span class="hljs-number"><span class="hljs-number">276</span></span> \n <span class="hljs-meta"><span class="hljs-meta">#  ---&gt; 202 200 230 316 0000060 316 ÀÅ ** 263 004 &lt;----  023 202 200 204 231 374 235 222 264 004 032</span></span></code> </pre><br>  4. The second field, user_id_to.  It turned out that at the beginning of the field is its type and 023 means a number and is also readable like varint.  You can write the corresponding functions to read such columns from a byte array: <br><pre> <code class="hljs go"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readVarIntFirst</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(v []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([]</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int64</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { res, ln := binary.Varint(v) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ln &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">panic</span></span>(<span class="hljs-string"><span class="hljs-string">"could not read varint"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v[ln:], res } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readVarInt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(v []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([]</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int64</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">'\023'</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">panic</span></span>(<span class="hljs-string"><span class="hljs-string">"invalid varint prefix"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> readVarIntFirst(v[<span class="hljs-number"><span class="hljs-number">1</span></span>:]) }</code> </pre><br>  5. Next comes the boolean field.  I had to tinker a bit, but I was able to find out that you can use the out-of-the-box function from the <code>github.com/cockroachdb/cockroach/pkg/util/encoding</code> package called <a href="https://godoc.org/github.com/cockroachdb/cockroach/pkg/util/encoding">encoding.DecodeBoolValue</a> This function works just like the ones just mentioned, it only returns an error instead of panic .  We use panic for convenience - we don‚Äôt need to handle errors in a one-time utility in a clever way. <br>  6. Next comes the message text.  Before the text fields is byte 026, then the length and then the content.  It looks like this: <br><br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">0000100</span></span> <span class="hljs-number"><span class="hljs-number">026</span></span> <span class="hljs-number"><span class="hljs-number">031</span></span> N ow I usereal <span class="hljs-number"><span class="hljs-number">0000120</span></span> P ostgre <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> <span class="hljs-number"><span class="hljs-number">023</span></span> <span class="hljs-number"><span class="hljs-number">230</span></span> <span class="hljs-number"><span class="hljs-number">277</span></span> <span class="hljs-number"><span class="hljs-number">256</span></span> <span class="hljs-number"><span class="hljs-number">217</span></span> <span class="hljs-number"><span class="hljs-number">0000140</span></span> <span class="hljs-number"><span class="hljs-number">240</span></span> <span class="hljs-number"><span class="hljs-number">320</span></span> <span class="hljs-number"><span class="hljs-number">375</span></span> <span class="hljs-number"><span class="hljs-number">342</span></span> ( \n</code> </pre><br>  One would think that the first byte is the length, and the text itself goes on.  If the values ‚Äã‚Äãare small (conditionally up to 100 bytes), then it even works.  But in fact, the length is encoded in another way, and the length can also be read using the functions from the encoding package: <br><br><pre> <code class="hljs go"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readStringFirst</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(v []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([]</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { v, _, ln, err := encoding.DecodeNonsortingUvarint(v) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">panic</span></span>(<span class="hljs-string"><span class="hljs-string">"could not decode string length"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v[ln:], <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(v[<span class="hljs-number"><span class="hljs-number">0</span></span>:ln]) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(v []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([]</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">'\026'</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">panic</span></span>(<span class="hljs-string"><span class="hljs-string">"invalid string prefix"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> readStringFirst(v[<span class="hljs-number"><span class="hljs-number">1</span></span>:]) }</code> </pre><br>  7. Well, the final regular number, read with the help of our function readVarInt. <br><br><h3>  Reading DATE Column </h3><br>  With a DATE column, I suffered because the encoding package did not immediately contain the necessary function :).  I had to improvise.  I will not torment you for a long time, the DATE format is a regular number (column type 023 hints), and it is recorded in it ... The number of seconds in UNIX TIME format divided by 86400 (the number of seconds in days).  That is, to read the date, multiply the read number by 86400 and treat it as unix time: <br><br><pre> <code class="hljs vbscript">v, birthdate := readVarInt(v) ts := <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.Unix(birthdate*<span class="hljs-number"><span class="hljs-number">86400</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) formatted := fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"%04d-%02d-%02d"</span></span>, ts.<span class="hljs-built_in"><span class="hljs-built_in">Year</span></span>(), ts.<span class="hljs-built_in"><span class="hljs-built_in">Month</span></span>(), ts.<span class="hljs-built_in"><span class="hljs-built_in">Day</span></span>())</code> </pre><br><h3>  Insert back into base </h3><br>  To insert the data back into the database, I personally wrote a simple function for escaping lines: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">escape</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(q </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b bytes.Buffer <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, c := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> q { b.WriteRune(c) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> c == <span class="hljs-string"><span class="hljs-string">'\''</span></span> { b.WriteRune(c) } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> b.String() }</code> </pre><br>  And used it to compile SQL queries manually: <br><br><pre> <code class="go hljs">fmt.Printf( <span class="hljs-string"><span class="hljs-string">"INSERT INTO messages2(id, user_id, user_id_to, is_out, message, ts) VALUES(%s, %d, %d, %v, '%s', %d);\n"</span></span>, pk, userID, userIDTo, isOut, escape(message), ts, )</code> </pre><br>  But you can create a CSV, use your model for the base, use prepared expressions, etc.  - as you please.  This is not a problem after you parsed binary data storage format in CockroachDB :). <br><br><h3>  Links, conclusions </h3><br>  Thank you for scrolling to the end :).  Better make backups, and don't act like me.  But if suddenly you really need to pull data from CockroachDB, then this article should help you a bit.  Do not lose data! <br><br>  <a href="https://www.cockroachlabs.com/">Cockroachdb</a> <br>  <a href="https://vbambuke.ru/">My funny social network</a> <br>  <a href="">Sources of my data recovery utility</a> <br>  <a href="https://www.youtube.com/watch%3Fv%3DROcXSJHWcI4">Process on youtube (2 of 3 videos)</a> </div><p>Source: <a href="https://habr.com/ru/post/345990/">https://habr.com/ru/post/345990/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345976/index.html">Docker is dead</a></li>
<li><a href="../345978/index.html">What are the images of the future we draw the largest IT companies</a></li>
<li><a href="../345982/index.html">Emotional burnout volunteers</a></li>
<li><a href="../345984/index.html">What else you need to learn about OpenCL C before you write on it</a></li>
<li><a href="../345988/index.html">The principle of Anna Karenina in programming and IT</a></li>
<li><a href="../345994/index.html">About the shape of a rotating fluid</a></li>
<li><a href="../345998/index.html">Why is it bad to be an excellent student</a></li>
<li><a href="../346000/index.html">Business function modeling</a></li>
<li><a href="../346006/index.html">Beginners on Arduino: We pack the state machine in a separate class and library</a></li>
<li><a href="../346010/index.html">Path maker: from scratch to senor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>