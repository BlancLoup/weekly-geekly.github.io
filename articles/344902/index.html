<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple implementation of Token for mobile application interaction with WebAPI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I started developing mobile applications using Xamarin.Forms in connection with production needs. Of course, I will not talk about dancing w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple implementation of Token for mobile application interaction with WebAPI</h1><div class="post__text post__text-html js-mediator-article">  Recently, I started developing mobile applications using <a href="https://www.xamarin.com/forms">Xamarin.Forms</a> in connection with production needs.  Of course, I will not talk about dancing with tambourines in order to write and run the application ‚ÄúHello, World!‚Äù On the emulator, but the main development went smoothly enough. <br><br>  The benefit and understanding of the task was - namely, the interaction of the mobile application with the database of the internal CRM system in the company, add mobility to employees, but do not forget about security.  It was decided to create a WebAPI, because in order to work with already familiar ASMX web services in Xamarin you need to dance with tambourines. <br><br>  As I said above, including I wanted to make the ‚Äúlink‚Äù fairly secure, which means the mobile application must have authorization (to the heap and convenience, with the ability to save authorization and automatic login. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I didn‚Äôt want to dig deep into WebAPI implementations with authorization at the Token level, but I wanted to do something simpler, especially while I‚Äôve seen googled that people have such a desire in abundance, but all responses that were sent were either standard mechanisms or some packages from NuGet, which I would like to avoid as much as possible. <br><br>  The base of our own CRM already has all the information for authorization and stupidly did not want to fence something extra. <br><br>  As a result, after long ordeals, searches, etc.  - I think I got a pretty good solution, which I want to share with the <a href="https://habrahabr.ru/">community</a> . <br><a name="habracut"></a><br>  So, what we have: <br><br><h2>  Log in and get token </h2><br>  Again, I will not go into the details of creating WebAPI, I will give an example of the code of the authorization function. <br><br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">HttpPost</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> LoginResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Logining</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[FromBody] LoginInfo LogInf</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dc.Managers.Count(w =&gt; w.EMail.StartsWith(LogInf.PortalUserEMail)) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dc.Managers.Count(w =&gt; w.EMail.StartsWith(LogInf.PortalUserEMail) &amp;&amp; w.Password == LogInf.PortalUserPassword) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { Managers _man = dc.Managers.First(w =&gt; w.EMail.StartsWith(LogInf.PortalUserEMail)); _man.Token = GenerateToken(); dc.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginResult() { Error = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, Token = _man.Token, ValidUser = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, managerInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ManagerInfo() { ManagerId = _man.Id, ManagerName = _man.ManagerName } }; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginResult() { Error = <span class="hljs-string"><span class="hljs-string">" !"</span></span>, Token = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, ValidUser = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, managerInfo = <span class="hljs-literal"><span class="hljs-literal">null</span></span> }; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginResult() { Error = <span class="hljs-string"><span class="hljs-string">"   !"</span></span>, Token = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, ValidUser = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, managerInfo = <span class="hljs-literal"><span class="hljs-literal">null</span></span> }; } }</code> </pre> <br>  I don‚Äôt make sense to explain what the function does, too, but as a result, when calling the API, the mobile application receives information that the user is valid and generates the generated Token (I decided not to waste time and put the generation of a 1000-character string out of a large number of characters of the entire English and Russian keyboard, with capital and lowercase letters, numbers, and simple characters. <br><br>  I prescribe this ‚Äúpseudo‚Äù -Token in <pre> <code class="cs hljs">App.Current.Properties[<span class="hljs-string"><span class="hljs-string">"Token"</span></span>] = rez.Token;</code> </pre>  applications. <br><br>  By the way, I think it‚Äôs worthwhile to separately mention 3 spent days, version rollbacks, etc.  to deal with this very <b>App.Current.Properties</b> . <br><br>  There was a situation that at some point when restarting the application on the emulator, the contents of App.Current.Properties was missing.  Long tormented and trying to understand why everything is lost. <br><br>  <b>It turns out that</b> while the application is active in App.Current.Properties, any objects can be stored, including objects with data of their own classes, but if the process is ‚Äúkilled‚Äù, if there was something different from ‚Äúsimple‚Äù objects, the contents of App.Current.Properties it is cleared, but if only simple objects are stored there - string, bool, int, etc.  then everything will remain saved! <br><br>  We continue.  All subsequent calls to the API, I provide an additional header: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> address = <span class="hljs-string"><span class="hljs-string">$"http://.../SomeWebApi/api/Works?ManId="</span></span> + ManagerId; client.DefaultRequestHeaders.Accept.Clear(); client.DefaultRequestHeaders.Accept.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Net.Http.Headers.MediaTypeWithQualityHeaderValue(<span class="hljs-string"><span class="hljs-string">"application/json"</span></span>)); client.DefaultRequestHeaders.Add(<span class="hljs-string"><span class="hljs-string">"Token"</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)App.Current.Properties[<span class="hljs-string"><span class="hljs-string">"Token"</span></span>]); HttpResponseMessage response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> client.GetAsync(address);</code> </pre><br>  What essentially adds to the request header.  Now all other WebAPI controllers, before "issuing" anything to the client, verify the presence and correspondence of the pseudo-Token. <br><br>  For example: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerable&lt;WorkInformation&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[FromUri] </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ManId</span></span></span><span class="hljs-function">)</span></span> { IEnumerable&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; UserToken; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Request.Headers.TryGetValues(<span class="hljs-string"><span class="hljs-string">"Token"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> UserToken)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } Managers _CurrManager = dc.Managers.First(w =&gt; w.Id == ManId); List&lt;WorkInformation&gt; _list = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;WorkInformation&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_CurrManager.Token != UserToken.ToArray()[<span class="hljs-number"><span class="hljs-number">0</span></span>]) { _list.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WorkInformation() { id = <span class="hljs-string"><span class="hljs-string">"-1"</span></span>, Client = <span class="hljs-string"><span class="hljs-string">"   "</span></span>, DTime = DateTime.Now, Comment = <span class="hljs-string"><span class="hljs-string">"  "</span></span>, EventImageName = <span class="hljs-string"><span class="hljs-string">""</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _list; } <span class="hljs-comment"><span class="hljs-comment">//      }</span></span></code> </pre><br>  As it seems to me, the resulting implementation of a pseudo-token has a right to exist and can help someone with implementations.  I hope the community does not shower with sticks, this is my first post, I hope that there will be not only criticism. </div><p>Source: <a href="https://habr.com/ru/post/344902/">https://habr.com/ru/post/344902/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344892/index.html">Useful to the designer: free new items to optimize design processes. 2nd Edition</a></li>
<li><a href="../344894/index.html">Legal aspects of operations with cryptocurrencies for residents of the Russian Federation</a></li>
<li><a href="../344896/index.html">We comprehend C deeper using assembler</a></li>
<li><a href="../344898/index.html">Tips for creating a modern Android application. Yandex lecture</a></li>
<li><a href="../344900/index.html">The digest of interesting materials for the mobile developer # 234 (December 11 - December 17)</a></li>
<li><a href="../344908/index.html">Configure Nginx + PHP-FPM and HTTPS from Let's Encrypt on AWS EC2 with Ubuntu Server 16.04 LTS</a></li>
<li><a href="../344910/index.html">Modular grid layout from scratch: analysis, calculation and construction</a></li>
<li><a href="../344912/index.html">The battle for network neutrality: wars with operators and first courts</a></li>
<li><a href="../344914/index.html">New generation of networks: the first specification 5G is introduced</a></li>
<li><a href="../344916/index.html">How does the frame render the Metal Gear Solid V engine: Phantom Pain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>