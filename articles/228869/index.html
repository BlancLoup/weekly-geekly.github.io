<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Intersystems Cach√©: Globals API for .NET - direct access to globals from C #</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently there was a need to compare the speed of writing / reading data from Intersystems Cach√© DBMS using different types of access - direct to glob...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Intersystems Cach√©: Globals API for .NET - direct access to globals from C #</h1><div class="post__text post__text-html js-mediator-article">  Recently there was a need to compare the speed of writing / reading data from Intersystems Cach√© DBMS using different types of access - direct to globals, object and relational.  Everything is clear with object and relational access, but we had to deal with direct (or direct access).  For those who, like me, at first glance, the documentation did not give a complete understanding of the process, and this article is intended.  For example, I will do a console application in the best traditions of procedural programming. <a name="habracut"></a><br><br>  Mini excursion into history ... When I first met Cach√©, I already had Cach√© eXTreme for Java, but there was no such technology for .NET yet.  And in version 2012.2 it finally appeared.  So if you have an older version, you can not even try to do something.  In addition, to work, you will need Visual Studio and the .Net Framework at least version 2.0.  So, if you have all this, then you can proceed to further settings of the environment. <br><br>  <b>Setting Environment Variables</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Especially for the purity of the experiment, put on a "clean" car for the first time Cach√©.  The installer did not register the necessary paths for working with Cach√© eXTreme into variable environments.  It must be done manually. <br><br><ol><li>  The variable <i>GLOBALS_HOME</i> should have the full path to the directory where you put the DBMS.  In my case, this is <i>C: \ InterSystems \ Cache \</i> <br><div class="spoiler">  <b class="spoiler_title">Setting the GLOBALS_HOME variable</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/04d/738/62e/04d73862e45af37480feb977b24ac441.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  Unlike the installation of the Cach√© DBMS, when installing the GlobalsDB DBMS, this path is recorded automatically!  Therefore, if you set up Cach√©, wrote your program, set up the system, and then for some reason set up GlobalsDB, a big surprise expects you: nothing will naturally work!  It will be necessary to manually re-register the path. </div></div><br></li><li>  The PATH variable must contain the full path to the Bin directory.  In my case, this is <i>C: \ InterSystems \ Cache \ Bin</i> <br><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  Again, if you have several versions of Cach√© on the same machine, the one that occurs in this variable first will be used in Cach√© eXTreme.  There are "pleasant" situations when one way is registered in GLOBALS_HOME, and another way in PATH.  In which of the database changes will be written in this case, I did not check.  But the situation is funny: everything seems to have worked without errors, but there is no data. </div></div><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  After you have set the necessary environment variables, it is not enough to reboot the database server, you need to reboot Windows (checked) or log out and log into the user (not verified). </div></div></li></ol><br>  <b>Links to libraries</b> <br><br>  After the environment variables are safely configured, we proceed to setting up the project.  In order to work, you need to add links to two libraries: <br><ul><li>  InterSystems.CacheExtreme.dll </li><li>  InterSystems.Data.CacheClient.dll </li></ul><br>  Both libraries can be found in the folder C: \ InterSystems \ Cache \ dev \ dotnet \ bin \ v2.0.50727 <br><div class="spoiler">  <b class="spoiler_title">Adding references</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/9de/c8b/82d/9dec8b82d58f5181d8c32ae675893cab.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/933/d7a/a26/933d7aa263b037d575127ea7556477f4.png"><br></div></div><br>  Naturally, in the corresponding module in the section you need to add: <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> InterSystems.Globals; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> InterSystems.Data.CacheClient;</code> </pre> <br>  <b>Data structure</b> <br><br>  Since Cach√© eXTreme allows you to record four types of data as indices (they are subscripts): int, double, string, long, and six data types as values: int, double, long, string, bytes [], ValueList, then I tried to come up with a structure for the global, in which there will be as many types as possible.  I took the data on bank card transactions as a subject area. <br><div class="spoiler">  <b class="spoiler_title">The result is a global with the following structure</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/62a/9c0/c35/62a9c0c356c37761ecfb44b2958316ac.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">It is filled with data</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/b6a/399/50e/b6a39950ece0f8b038e26f3e889a75ae.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">If you fill it in Cach√© Studio, it looks like this.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^CardInfo(<span class="hljs-number"><span class="hljs-number">111111111111</span></span>) = <span class="hljs-string"><span class="hljs-string">"  "</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^CardInfo(<span class="hljs-number"><span class="hljs-number">111111111111</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>) = <span class="hljs-number"><span class="hljs-number">14360570</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^CardInfo(<span class="hljs-number"><span class="hljs-number">111111111111</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-number"><span class="hljs-number">29244825509100</span></span>) = <span class="hljs-number"><span class="hljs-number">28741.35</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^CardInfo(<span class="hljs-number"><span class="hljs-number">111111111111</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-number"><span class="hljs-number">29244825509100</span></span>, <span class="hljs-number"><span class="hljs-number">2145632596588547</span></span>) = <span class="hljs-string"><span class="hljs-string">" /1965/Sidorov Petr"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^CardInfo(<span class="hljs-number"><span class="hljs-number">111111111111</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-number"><span class="hljs-number">29244825509100</span></span>, <span class="hljs-number"><span class="hljs-number">2145632596588547</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) = $lb(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">26032009100100</span></span>, <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-number"><span class="hljs-number">500.26</span></span>, <span class="hljs-string"><span class="hljs-string">"     "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^CardInfo(<span class="hljs-number"><span class="hljs-number">111111111111</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-number"><span class="hljs-number">29244825509100</span></span>, <span class="hljs-number"><span class="hljs-number">2145632596588547</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) = $lb(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">26118962412531</span></span>, <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-number"><span class="hljs-number">115.54</span></span>, <span class="hljs-string"><span class="hljs-string">"  "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^CardInfo(<span class="hljs-number"><span class="hljs-number">111111111111</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) = <span class="hljs-number"><span class="hljs-number">19807750</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^CardInfo(<span class="hljs-number"><span class="hljs-number">111111111111</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-number"><span class="hljs-number">26032009100100</span></span>) = <span class="hljs-number"><span class="hljs-number">65241.24</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^CardInfo(<span class="hljs-number"><span class="hljs-number">111111111111</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-number"><span class="hljs-number">26032009100100</span></span>, <span class="hljs-number"><span class="hljs-number">6541963285249512</span></span>) = <span class="hljs-string"><span class="hljs-string">" | 1965 | SidorovP"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^CardInfo(<span class="hljs-number"><span class="hljs-number">111111111111</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-number"><span class="hljs-number">26032009100100</span></span>, <span class="hljs-number"><span class="hljs-number">6541963285249512</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) = $lb(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">29244825509100</span></span>, <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-number"><span class="hljs-number">500.26</span></span>, <span class="hljs-string"><span class="hljs-string">"     "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^CardInfo(<span class="hljs-number"><span class="hljs-number">111111111111</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-number"><span class="hljs-number">26032009100100</span></span>, <span class="hljs-number"><span class="hljs-number">6541963285249512</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) = $lb(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">26008962495545</span></span>, <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-number"><span class="hljs-number">1015.10</span></span>, <span class="hljs-string"><span class="hljs-string">"     "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^CardInfo(<span class="hljs-number"><span class="hljs-number">111111111111</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) = <span class="hljs-number"><span class="hljs-number">14282829</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^CardInfo(<span class="hljs-number"><span class="hljs-number">111111111111</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-number"><span class="hljs-number">26008962495545</span></span>) = <span class="hljs-number"><span class="hljs-number">126.32</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^CardInfo(<span class="hljs-number"><span class="hljs-number">111111111111</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-number"><span class="hljs-number">26008962495545</span></span>, <span class="hljs-number"><span class="hljs-number">4567098712347654</span></span>) = <span class="hljs-string"><span class="hljs-string">" 1965 SidorovPetr"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^CardInfo(<span class="hljs-number"><span class="hljs-number">111111111111</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-number"><span class="hljs-number">26008962495545</span></span>, <span class="hljs-number"><span class="hljs-number">4567098712347654</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) = $lb(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">29244825509100</span></span>, <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-number"><span class="hljs-number">115.54</span></span>, <span class="hljs-string"><span class="hljs-string">"  "</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ^CardInfo(<span class="hljs-number"><span class="hljs-number">111111111111</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-number"><span class="hljs-number">26008962495545</span></span>, <span class="hljs-number"><span class="hljs-number">4567098712347654</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) = $lb(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">26032009100100</span></span>, <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-number"><span class="hljs-number">1015.54</span></span>, <span class="hljs-string"><span class="hljs-string">"     "</span></span>)</code> </pre><br></div></div><br>  Thus, our user ‚ÄúSidorov Peter Vitalyevich‚Äù has three card accounts opened in different banks, each of which has one card attached. <br><br>  When reading the documentation, I identified for myself three ways to fill in the data.  And on each of these accounts, I will show one of them. <br><br>  <b>Connect to the database</b> <br><br>  So, before you try to write or read something somewhere, you must first connect to the database.  Unlike object / relational access, when using Cach√© eXTreme, a TCP / IP connection is not made ‚Äî the application runs in the same stream as the database.  Therefore, the Cach√© server and the application itself must be on the same machine.  If you need to access data on a different server, you can use <a href="">Cach√© ECP</a> .  And this is where the restrictions mentioned in the section ‚ÄúSetting Environment Variables‚Äù come into effect, because it is for these settings that the system ‚Äúunderstands‚Äù where to <s>break it to</s> connect. <br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  When working with <a href="">Cach√© eXTreme Event Persistence (XEP), the</a> connection can be established either via TCP / IP or in the same process as the server (as in the Globals API). </div></div><br>  It should also be noted that in the process there is <b>only one</b> connection and all C # objects use this particular connection.  To get it, use the <i>ConnectionContext.GetConnection ()</i> method.  To check whether the connection is open or not, the <i>IsConnected ()</i> method is used.  To open a connection, use the <i>Connect ()</i> method to close - <i>Close ()</i> . <br><div class="spoiler">  <b class="spoiler_title">As a result, the program looks like this.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Connection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Connect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  Connection myConn = ConnectionContext.GetConnection(); //    if (!myConn.IsConnected()) { Console.WriteLine("  "); //   ,   myConn.Connect("User", "_SYSTEM", "SYS"); } if (myConn.IsConnected()) { Console.WriteLine("    "); //   ,     return myConn; } else { return null; } } static void Disconnect(Connection myConn) { //  ,        if (myConn.IsConnected()) myConn.Close(); } static void Main(string[] args) { try { Connection myConn1 = Connect(); //ToDo:       Disconnect(myConn1); } catch (Exception e) { Console.WriteLine(e.Message); } Console.ReadKey(); } }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Execution result</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/918/131/8af/9181318af00738065fcca0e7f210c695.png"><br></div></div><br>  <b>The first data entry option is adding indexes.</b> <br><br>  As already mentioned, I understood for myself three approaches to the construction of globals.  The first of these is the phased creation of a tree by adding indexes (deepening from the root). <br><br>  In order to start building a global one, you need to fix its root.  In our case, this is the <b>CardInfo</b> value.  This operation is performed using the <i>CreateNodeReference ()</i> method: <br><pre> <code class="cs hljs">NodeReference nodeRef = myConn1.CreateNodeReference(<span class="hljs-string"><span class="hljs-string">"CardInfo"</span></span>);</code> </pre><br>  Once we have fixed the pointer to the root of the tree, you can begin to build it.  The nodeRef variable will always store a pointer to the node in the tree that is currently active. <br><br>  To add a new index to a variable, use the <i>AppendSubscript ()</i> method, in which you can pass a double, int, long, or string value.  To insert a value into the global node, use the <i>Set ()</i> method.  It can accept values ‚Äã‚Äãof the type byte [], double, int, long, string, ValueList as the first parameter.  The second parameter will be considered further, now it is not needed yet.  If everything is clear with byte [], double, int, long, string, it is a standard byte array, real, integer and long integer value and a string, then the last data type is a special data type for working with Cach√© system lists in COS using the <i>$ ListBuild</i> function (also <i>known</i> as <i>$ lb</i> ). <br><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  In general, until the <i>Set ()</i> method is executed, the data will not be written to the database.  Those.  you can build trees with empty elements and thus get sparse arrays. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Thus, we can go down to the leaves of the tree, adding indexes at every step</b> <div class="spoiler_text"><pre> <code class="cs hljs"> node.AppendSubscript(<span class="hljs-string"><span class="hljs-string">"111111111111"</span></span>); node.Set(<span class="hljs-string"><span class="hljs-string">"  "</span></span>); node.AppendSubscript(<span class="hljs-string"><span class="hljs-string">" "</span></span>); node.Set(<span class="hljs-number"><span class="hljs-number">14360570</span></span>); node.AppendSubscript(<span class="hljs-number"><span class="hljs-number">29244825509100</span></span>); node.Set(<span class="hljs-number"><span class="hljs-number">28741.35</span></span>); node.AppendSubscript(<span class="hljs-number"><span class="hljs-number">2145632596588547</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> slip = <span class="hljs-string"><span class="hljs-string">" /1965/Sidorov Petr"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytes = System.Text.Encoding.GetEncoding(<span class="hljs-number"><span class="hljs-number">1251</span></span>).GetBytes(slip); node.Set(bytes); node.AppendSubscript(<span class="hljs-number"><span class="hljs-number">1</span></span>); ValueList myList = myConn.CreateList(); myList.Append(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">26032009100100</span></span>, <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-number"><span class="hljs-number">500.26</span></span>, <span class="hljs-string"><span class="hljs-string">"     "</span></span>); node.Set(myList); myList.Close();</code> </pre><br></div></div><br>  With each ‚Äústep‚Äù the pointer to the current node will be moved to the newly added index. <br><br>  However, we have another transaction.  To add it in the same way, you need to go up a level.  In order to do this (and generally jump to any other level), the <i>SetSubscriptCount ()</i> method is used, to which the number of node indices (level number) is passed to where the transition should be made. <br><div class="spoiler">  <b class="spoiler_title">In our case, it will look like this.</b> <div class="spoiler_text"><pre> <code class="cs hljs"> node.SetSubscriptCount(<span class="hljs-number"><span class="hljs-number">4</span></span>); node.AppendSubscript(<span class="hljs-number"><span class="hljs-number">2</span></span>); myList = myConn.CreateList(); myList.Append(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">26118962412531</span></span>, <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-number"><span class="hljs-number">115.54</span></span>, <span class="hljs-string"><span class="hljs-string">"  "</span></span>); node.Set(myList); myList.Close();</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Thus, the CreateFirstBranch () procedure will be called in the ToDo program in the program.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateFirstBranch</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NodeReference node, Connection myConn</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 1  -    node.AppendSubscript("111111111111"); //        -    node.Set("  "); // 2  -   node.AppendSubscript(" "); //        -   node.Set(14360570); // 3  -   node.AppendSubscript(29244825509100); //        -    node.Set(28741.35); // 4  -   node.AppendSubscript(2145632596588547); //        - SLIP-      string slip = " /1965/Sidorov Petr"; byte[] bytes = System.Text.Encoding.GetEncoding(1251).GetBytes(slip); node.Set(bytes); // 5  -     node.AppendSubscript(1); //   ValueList myList = myConn.CreateList(); //     ,   $lb:  /,   /,  /, ,  myList.Append(0, 26032009100100, "  ", 500.26, "     "); //      node.Set(myList); //  myList.Close(); //    4  node.SetSubscriptCount(4); // 5  -     node.AppendSubscript(2); //   myList = myConn.CreateList(); //     ,   $lb:  /,   /,  /, ,  myList.Append(0, 26118962412531, "  ", 115.54, "  "); //      node.Set(myList); //  myList.Close(); Console.WriteLine("      "); }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Execution result</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/153/f61/45f/153f6145f31a0d39ece16c5f35d561d8.png"><br></div></div><br>  <b>The second version of the data record is an explicit assignment of values.</b> <br><br>  The previous section mentioned that the <i>Set ()</i> method can take two parameters.  If only one is transmitted, then the value is inserted into the current global node.  The second parameter is intended for a list of indexes relative to the current node (to which the reference is stored in a variable of NodeReference type) where the value should be inserted. <br><br>  Thus, to add account data in the next bank, you must first return to the level of a single index.  To do this, use the <i>SetSubscriptCount ()</i> method with parameter 1. Again, using the <i>Set ()</i> method, we simply add indices. <br><div class="spoiler">  <b class="spoiler_title">In the program after the procedure CreateFirstBranch () we call the procedure CreateSecondBranch ()</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateSecondBranch</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NodeReference node, Connection myConn</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    1  node.SetSubscriptCount(1); //      2  -      node.Set(19807750, ""); //      3  -      ,              node.Set(65241.24, "", 26032009100100); //    SLIP-  string slip = " | 1965 | SidorovP"; byte[] bytes = System.Text.Encoding.GetEncoding(1251).GetBytes(slip); //      4  - SLIP-   ,      node.Set(bytes, "", 26032009100100, 6541963285249512); //      ValueList myList = myConn.CreateList(); myList.Append(1, 29244825509100, "  ", 500.26, "     "); //      5  -         node.Set(myList, "", 26032009100100, 6541963285249512, 1); myList.Close(); //      myList = myConn.CreateList(); myList.Append(0, 26008962495545, "  ", 1015.10, "     "); //      5  -         //        ,         1        node.Set(myList, "", 26032009100100, 6541963285249512, 2); myList.Close(); Console.WriteLine("     "); }</span></span></code> </pre><br></div></div><br>  You may notice that this approach most closely resembles COS code for creating globals.  In the same way, every time we write all the indices relative to some base one and add its value to be saved in the database. <br><div class="spoiler">  <b class="spoiler_title">Execution result</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/e2b/cf8/486/e2bcf848653d0ac365857a6c19df89dc.png"><br></div></div><br>  <b>The third way to write data is to explicitly set the number of indexes to create a value at this level of hierarchy</b> <br><br>  The final approach to creating global nodes is an explicit task of the level at which you want to add a new value.  At the same time, unlike the previous approach, the pointer moves through the tree. <br><br>  To indicate the level of the tree that needs to be moved, the <i>SetSubscript ()</i> method is used, to which the required number of indexes is transferred and the value of the new index to be added at this level.  To insert values ‚Äã‚Äãagain, the <i>Set ()</i> method is used, in which only one parameter is passed ‚Äî the value of the node. <br><div class="spoiler">  <b class="spoiler_title">In the program after the procedure CreateSecondBranch () we call the procedure CreateThirdBranch ()</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateThirdBranch</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NodeReference node, Connection myConn</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//,       2  -   node.SetSubscript(2, ""); //      -   node.Set(14282829); //,       3  -   node.SetSubscript(3, 26008962495545); //      -    node.Set(126.32); //,       4  -   node.SetSubscript(4, 4567098712347654); //    SLIP-  string slip = " 1965 SidorovPetr"; byte[] bytes = System.Text.Encoding.GetEncoding(1251).GetBytes(slip); //      - SLIP- node.Set(bytes); //,       5  -   node.SetSubscript(5, 1); //      ValueList myList = myConn.CreateList(); myList.Append(0, 29244825509100, "  ", 115.54, "  "); //      -    node.Set(myList); myList.Close(); //,        -   node.SetSubscript(5, 2); //      myList = myConn.CreateList(); myList.Append(1, 26032009100100, "  ", 1015.54, "     "); //      -    node.Set(myList); myList.Close(); Console.WriteLine("     "); }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Execution result</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/11c/1ff/07e/11c1ff07e6c545f84d1d8d54eadfeac7.png"><br></div></div><br>  In order to delete the existing global at the beginning of each program launch, you can call the <i>Kill ()</i> method. <br><div class="spoiler">  <b class="spoiler_title">After all these changes, the Main () procedure of our program is as follows.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Connection myConn1 = Connect(); NodeReference nodeRef = myConn1.CreateNodeReference(<span class="hljs-string"><span class="hljs-string">"CardInfo"</span></span>); nodeRef.Kill(); CreateFirstBranch(nodeRef, myConn1); CreateSecondBranch(nodeRef, myConn1); CreateThirdBranch(nodeRef, myConn1); nodeRef.Close(); <span class="hljs-comment"><span class="hljs-comment">//ToDo:    Disconnect(myConn1); } catch (Exception e) { Console.WriteLine(e.Message); } Console.ReadKey(); }</span></span></code> </pre><br></div></div><br>  <b>Reading data</b> <br><br>  After we have saved the data in the database, we may need to read it and somehow process it on the client side.  Since globals are like trees and we did not skip indexes in the example, we can safely recursively go around the whole global and output its values. <br><br>  To work around, we will use the familiar methods <i>SetSubscript ()</i> and <i>AppendSubscript ()</i> .  In addition to them, we will use the methods: <br><br><ul><li>  <i>NextSubscript ()</i> - returns the value of the next index at the same level, similar to the <i>$ Next</i> and <i>$ Order</i> functions in COS. </li><li>  <i>GetSubscriptCount ()</i> - returns the number of indexes at the current tree level. </li><li>  <i>HasData ()</i> - checks if there is a value in this node, i.e.  does it exist. </li><li>  <i>HasSubnodes ()</i> - checks if the current index has sub-indices. </li></ul><br><div class="spoiler">  <b class="spoiler_title">The result is a tree traversal procedure.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NodeReference node</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    node.AppendSubscript(""); //      string subscr = node.NextSubscript(); //    while (!subscr.Equals("")) { //  ,          node.SetSubscript(node.GetSubscriptCount(), subscr); //       if (node.HasData()) { //    Console.WriteLine(" ".PadLeft(node.GetSubscriptCount() * 4, '-') + subscr); //ToDo:    } //      , ..     if (node.HasSubnodes()) { // ,                 ReadData(node); } //       subscr = node.NextSubscript(); } } catch (GlobalsException ex) { Console.WriteLine(ex.Message); } finally { //  ,      node.SetSubscriptCount(node.GetSubscriptCount() - 1); } }</span></span></code> </pre><br></div></div><br>  which is called from the main program: <br><pre> <code class="cs hljs"> nodeRef = myConn1.CreateNodeReference(<span class="hljs-string"><span class="hljs-string">"CardInfo"</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"  :"</span></span>); ReadData(nodeRef); nodeRef.Close();</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Execution result</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/5ee/b47/048/5eeb4704853a9b531b803cd3b843da49.png"><br></div></div><br>  We see that all our indexes are beautifully displayed.  Now you need to add the node values ‚Äã‚Äãthemselves instead of ToDo. <br><br>  Considering that all data is stored in Cach√© as strings, then the program will need, first, to remember at what level what data is located and, second, to convert data types.  The <i>GetInt ()</i> , <i>GetDouble ()</i> , <i>GetLong ()</i> , <i>GetString ()</i> , <i>GetBytes ()</i> , <i>GetList (),</i> and <i>GetObject ()</i> functions are <i>used</i> to get global node values.  They return a value of type string and immediately convert it to type int, double, longInt, string, bytes [], ValueList, respectively.  The last function <i>GetObject ()</i> returns an object whose type can be checked and converted to the value of the desired type. <br><br>  As already noted, all data is returned as a string.  If, in fact, the data type is numeric, the system can determine this.  But the system always defines lists, arrays of bytes and the lines themselves as strings.  Therefore, the processing of such data must take into account at what level what type of data is stored.  In this connection, it is not necessary to store data of different types at the same level, otherwise nothing good will come out.  Moreover, the system does not return an error when trying to display a list using the methods of working with strings.  Instead, a beautiful (but incomprehensible) text will be displayed, and this is at best: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/868/e0e/567/868e0e5676c240d6886907c646f5dca5.png"><br><br>  This is how the list with payment data without conversion is displayed. <br><div class="spoiler">  <b class="spoiler_title">Instead of ToDo, we call the GetData () procedure, which appends the value of the corresponding global node to the string.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NodeReference node</span></span></span><span class="hljs-function">)</span></span> { Object <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = node.GetObject(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.GetSubscriptCount() == <span class="hljs-number"><span class="hljs-number">1</span></span>) { Console.WriteLine(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.ToString()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.GetSubscriptCount() == <span class="hljs-number"><span class="hljs-number">5</span></span>) { ValueList outList = node.GetList(); outList.ResetToFirst(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; outList.Length<span class="hljs-number"><span class="hljs-number">-1</span></span>; i++) { Console.Write(outList.GetNextObject()+<span class="hljs-string"><span class="hljs-string">", "</span></span>); } Console.WriteLine(outList.GetNextObject()); outList.Close(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node.GetSubscriptCount() == <span class="hljs-number"><span class="hljs-number">4</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> tempString = Encoding.GetEncoding(<span class="hljs-number"><span class="hljs-number">1251</span></span>).GetString(node.GetBytes()); Console.WriteLine(tempString); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) { Console.WriteLine(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.ToString()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) { Console.WriteLine(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.ToString()); } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Execution result</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/dfc/4ca/cad/dfc4cacad930f4b1b1b50cd436791448.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">In the database we can see the following information.</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/463/555/4b0/4635554b0ecd746629f7f583c5637a61.png"><br></div></div><br>  You may notice that some of the data is different in representation from those that were filled out using COS.  These are real numbers and byte arrays.  When filling through Cach√© eXTreme, an explicit reference to the data type appeared - <i>$ double ()</i> for real values. <br><br>  Thus, we recorded in the global information and then successfully read it. <br><br>  The project is available on <a href="https://github.com/Gra-ach/CacheNetDirectAccess">GitHub</a> . <br><br>  Official Cach√© eXTreme documentation: <a href="">Using .NET with Cach√© eXTreme</a> .  In it, you can find even more methods for working with indexes and global nodes and namespaces. <br><br>  Links to articles on Habr√©: <br>  <a href="http://habrahabr.ru/company/intersystems/blog/184882/">GlobalsDB is a universal NoSQL database.</a>  <a href="http://habrahabr.ru/company/intersystems/blog/184882/">Part 1</a> <br>  <a href="http://habrahabr.ru/company/intersystems/blog/185472/">GlobalsDB is a universal NoSQL database.</a>  <a href="http://habrahabr.ru/company/intersystems/blog/185472/">Part 2</a> <br>  <a href="http://habrahabr.ru/company/intersystems/blog/141546/">Part I. InterSystems GlobalsDB .Net - reconnaissance in force with peeping under the hood</a> <br><br>  <a href="http://www.youtube.com/playlist%3Flist%3DPLB8fOJIJvNZlgfOHeK0_2CRjd_WPmdkm_">Related Videos</a> <br><br>  Comments and questions are welcome! <br><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  It is worth noting that the meaning of working with globals from .NET and Java is almost the same.  Functions are repeated, signatures are very similar.  So for those who are familiar with Cach√© eXTreme for Java, dealing with Cach√© eXTreme for .NET will not be a problem. </div></div></div><p>Source: <a href="https://habr.com/ru/post/228869/">https://habr.com/ru/post/228869/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../228859/index.html">ThinkServer RD640 - Lenovo server, charged for work</a></li>
<li><a href="../228861/index.html">Transparent OpenGL</a></li>
<li><a href="../228863/index.html">AngularJS: select subtleties within the directive template</a></li>
<li><a href="../228865/index.html">The first photo of the far side of the moon: a bit of history</a></li>
<li><a href="../228867/index.html">Simple Science - Digest Experiences # 34</a></li>
<li><a href="../228871/index.html">Google closes orkut</a></li>
<li><a href="../228875/index.html">5 key elements of friendly notifications</a></li>
<li><a href="../228877/index.html">Where games grow from. Interview with David Helgason - CEO Unity</a></li>
<li><a href="../228879/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ116 (June 29 - July 6, 2014)</a></li>
<li><a href="../228881/index.html">We implement pull to refresh and infinite scrolling on Swift</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>