<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Node.js on Fidonet: read javascript echomail headers stored in JAM format</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today I have two reasons to run over the keys. 

 First, after last week I translated the jParser documentation (after reviewing the RReverser example...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Node.js on Fidonet: read javascript echomail headers stored in JAM format</h1><div class="post__text post__text-html js-mediator-article">  Today I have two reasons to run over the keys. <br><br>  First, after last week I translated the <a href="http://habrahabr.ru/post/144008/">jParser documentation</a> (after reviewing the RReverser example of <a href="http://habrahabr.ru/post/143985/">using jParser in analyzing <nobr>BMP files</nobr></a> ), it seems to me appropriate to go to the next step that is to follow: develop a theme, share my own example with readers using jParser to analyze a slightly more complex data structure.  (In part, this will be the answer <nobr>to the</nobr> <a href="http://habrahabr.ru/post/144008/">question</a> that <a href="http://habrahabr.ru/users/alekciy/" class="user_link">alekciy</a> asked, <a href="http://habrahabr.ru/users/alekciy/" class="user_link">taking</a> interest in further examples of the practical use of jParser.) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dc2/073/8ff/dc20738ff1408ac490828bff0437e3fd.png" align="right">  Secondly, about half a year ago <nobr>(</nobr> <a href="http://habrahabr.ru/post/133426/">November 26, 2011</a> ), <a href="http://habrahabr.ru/users/ertaquo/" class="user_link">ertaquo</a> asked why I wanted to use Node.js in Fidonet.  Then I said that I simply liked the name (I remember those times when the term ‚Äúnode‚Äù <nobr>or ‚Äúnow,‚Äù</nobr> if used without clarification, in the Russian computer world, by default meant a Fidonet node), but could not give any good example of a working code. and now bring. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, the example will be double.  I bring to your attention the analysis of the headers of letters from Fidonet echomail, stored in the JAM format.  This format has been popular in Fidonet since the days of the distant and immemorial <nobr>(</nobr> <a href="http://en.wikipedia.org/wiki/JAM_Message_Base_Format">Wikipedia</a> says that the appearance of JAM dates back to 1993).  I‚Äôll say <a href="http://en.wikipedia.org/wiki/Squish_(FidoNet)">right away</a> that I have long preferred JAM to another popular format <nobr>(</nobr> <a href="http://en.wikipedia.org/wiki/Squish_(FidoNet)">Squish</a> ), because this latter stores in the header of the letter identifiers of no more than nine responses to it, whereas JAM uses a more flexible data structure (a <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B2%25D1%258F%25D0%25B7%25D0%25BD%25D1%258B%25D0%25B9_%25D1%2581%25D0%25BF%25D0%25B8%25D1%2581%25D0%25BE%25D0%25BA">linked list</a> ) instead of an array of limited length, so which allows you to build a complete tree of answers, even in the most lively and extensive discussions. <br><br><a name="habracut"></a>  JAM documentation can be easily found on various fidosh BBSs, but BBS tends to close or change addresses over time, so for reliability I refer to my own <a href="http://groups.google.com/group/fido7.ru.ftn.develop/msg/e2f5486f80394418">letter</a> five years ago, in which I quoted this documentation literally and in its entirety.  (The Czech BBS, which then served as a source for me, is now already closed. Everything is ghostly in this raging world.) <br><br>  As you can see there, the headers of the Fidonet echomail letters are stored inside the <nobr>JHR file.</nobr>  This file consists of a fixed-length header ( <b>FixedHeaderInfoStruct</b> ), followed by the actual letter headers ( <b>MessageHeader</b> ), each of which consists, again, of a fixed-size structure ( <b>MessageFixedHeader</b> ) and a variable tail consisting of several fields ( <b>SubFieldXX</b> ), total length specified in the <b>SubfieldLen</b> field within the <b>MessageFixedHeader</b> structure.  The <b>SubFieldXX</b> field again consists of a fixed-size header followed by a string of bytes, the length of which is specified in the previous number <b>datlen</b> .  (This resembles the implementation of strings in the dialects of Pascal, common in the same nineties - <nobr>Turbo-Pascal,</nobr> <nobr>UCSD Pascal;</nobr> however, in Pascal the length was indicated by one byte, and in JAM the number <b>datlen</b> is of <nobr>the</nobr> <b>ulong</b> <nobr>type</nobr> , that is, it is thirty-two <b>bits</b> . This is prudent. ) <br><br>  Much less clear is another important fact: inside the <nobr>JHR file,</nobr> the <b>MessageHeader</b> headers are not necessarily end-to-end.  The subsection ‚ÄúUpdating message headers‚Äù indicates that if, after editing or processing a letter, its header grows in size, then it is placed at the end of the file, and the old header is marked as deleted.  The fate of the letters, whose title did not grow in volume, but decreased, doesn‚Äôt say <b>anything</b> - however, in practice many Fidonet programs write such a new title to the previous one, changing the value of <b>SubfieldLen accordingly</b> (and, if necessary, individual values ‚Äã‚Äãof <b>datlen</b> ).  Between this and the subsequent <b>MessageHeader</b> , there remains garbage consisting of the contents of the former last fields of <b>SubFieldXX</b> .  That is why, after reading the next <b>MessageHeader</b> header, there is no more reasonable way to go to the next <b>MessageHeader</b> header, besides searching for a string of three <nobr>ASCII characters</nobr> "JAM" followed by a null byte - this is the <b>Signature</b> sequence with which the <b>MessageFixedHeader</b> header must start. <br><br>  The module code for Node.js, which reads echomail headers <nobr>from a JHR file</nobr> into RAM, can therefore be sketched as follows: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> jParser = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'jParser'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ulong = <span class="hljs-string"><span class="hljs-string">'uint32'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ushort = <span class="hljs-string"><span class="hljs-string">'uint16'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> JAM = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">echotag</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> JAM)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JAM(echotag); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.echotag = echotag; <span class="hljs-comment"><span class="hljs-comment">// Buffers: this.JHR = null; /* this.JDT = null; this.JDX = null; this.JLR = null; */ } JAM.prototype.readJHR = function(callback){ // (err) if (this.JHR !== null) callback(null); fs.readFile(this.echotag+'.JHR', function (err, data) { if (err) callback(err); this.JHR = data; callback(null); }); } JAM.prototype.ReadHeaders = function(callback){ // err, struct this.readJHR(function(err){ if (err) callback(err); var thisJAM = this; var parser = new jParser(this.JHR, { 'reserved1000uchar': function(){ this.skip(1000); return true; }, 'JAM0' : ['string', 4], 'FixedHeaderInfoStruct': { 'Signature': 'JAM0', 'datecreated': ulong, 'modcounter': ulong, 'activemsgs': ulong, 'passwordcrc': ulong, 'basemsgnum': ulong, 'RESERVED': 'reserved1000uchar', }, 'SubField': { 'LoID': ushort, 'HiID': ushort, 'datlen': ulong, 'Buffer': ['string', function(){ return this.current.datlen }] /* 'type': function(){ switch( this.current.LoID ){ case 0: return 'OADDRESS'; break; case 1: return 'DADDRESS'; break; case 2: return 'SENDERNAME'; break; case 3: return 'RECEIVERNAME'; break; case 4: return 'MSGID'; break; case 5: return 'REPLYID'; break; case 6: return 'SUBJECT'; break; case 7: return 'PID'; break; case 8: return 'TRACE'; break; case 9: return 'ENCLOSEDFILE'; break; case 10: return 'ENCLOSEDFILEWALIAS'; break; case 11: return 'ENCLOSEDFREQ'; break; case 12: return 'ENCLOSEDFILEWCARD'; break; case 13: return 'ENCLOSEDINDIRECTFILE'; break; case 1000: return 'EMBINDAT'; break; case 2000: return 'FTSKLUDGE'; break; case 2001: return 'SEENBY2D'; break; case 2002: return 'PATH2D'; break; case 2003: return 'FLAGS'; break; case 2004: return 'TZUTCINFO'; break; default: return 'UNKNOWN'; break; } } */ }, 'MessageHeader': { 'Signature': 'JAM0', 'Revision': ushort, 'ReservedWord': ushort, 'SubfieldLen': ulong, 'TimesRead': ulong, 'MSGIDcrc': ulong, 'REPLYcrc': ulong, 'ReplyTo': ulong, 'Reply1st': ulong, 'Replynext': ulong, 'DateWritten': ulong, 'DateReceived': ulong, 'DateProcessed': ulong, 'MessageNumber': ulong, 'Attribute': ulong, 'Attribute2': ulong, 'Offset': ulong, 'TxtLen': ulong, 'PasswordCRC': ulong, 'Cost': ulong, 'Subfields': ['string', function(){ return this.current.SubfieldLen; } ], /* 'Subfields': function(){ var final = this.tell() + this.current.SubfieldLen; var sfArray = []; while (this.tell() &lt; final) { sfArray.push( this.parse('SubField') ); } return sfArray; }, */ 'AfterSubfields': function(){ var initial = this.tell(); var bytesLeft = thisJAM.JHR.length - initial - 4; var seekJump = 0; var sigFound = false; var raw = this; if (bytesLeft &lt;= 0) return 0; do { this.seek(initial + seekJump, function(){ var moveSIG = raw.parse('JAM0'); if (moveSIG === 'JAM\0') { sigFound = true; /* if (seekJump &gt; 0){ console.log( 'initial = ' + initial + ', seekJump = ' + seekJump + ', moveSIG = ' + moveSIG ); } */ } }); seekJump++; } while (!sigFound &amp;&amp; (seekJump &lt; bytesLeft) ); this.skip(seekJump-1); return seekJump-1; } }, 'JHR': { 'FixedHeader': 'FixedHeaderInfoStruct', 'MessageHeaders': function(){ var mhArray = []; while (this.tell() &lt; thisJAM.JHR.length - 69) { mhArray.push( this.parse('MessageHeader') ); } return mhArray; } } }); callback(null, parser.parse('JHR')); }); } module.exports = JAM;</span></span></code> </pre> <br>  This sketch uses raw data caching <nobr>from a JHR file</nobr> inside the exported <b>JAM</b> object (in the <nobr><b>JHR</b></nobr> field <nobr>) <b>‚Äîa</b></nobr> solution that is not economical from the point of view of the current module design, but it will be useful if, along with the <b>ReadHeaders</b> method, <b>you</b> need a simpler method that <b>reads</b> , for example Only the <b>FixedHeaderInfoStruct</b> header.  There are also fields for the other three JAM files (for JDT, and JDX, and JLR), but commented out.  (Ideally, the cache should also be kept up-to-date ‚Äî doing <nobr><b><a href="http://nodejs.org/docs/latest/api/fs.html">stat</a> ()</b> ,</nobr> and not <nobr><b><a href="http://nodejs.org/docs/latest/api/fs.html">watchFile</a> ()</b> ,</nobr> but it‚Äôs clear that for the initial draft of the module, this code will fit without it.) <br><br>  The data types from the JAM documentation (for example, <nobr><b>ulong</b> ) are</nobr> not specified by jParser tools (for example, <nobr>‚Äú <b>'ulong': 'uint32'</b> ‚Äù),</nobr> but are declared as JavaScript variables (for example, ‚Äú <b>var ulong = 'uint32'</b> ‚Äù), whose values ‚Äã‚Äãare used in description of data structures.  This is for speed: it is clear that the V8 JavaScript engine code will work much faster than the jParser module code. <br><br>  In the description of the <b>SubField</b> structure <b>,</b> you will find the commented <nobr><b>type</b></nobr> field <nobr>-</nobr> it is filled with a javascript function containing mnemonic field notations borrowed from the JAM documentation.  Can be used for debugging purposes. <br><br>  The <b>Subfields</b> field within the <b>MessageHeader</b> structure is defined in two ways.  The first (fast) reads this field as a string of bytes the size of <b>SubfieldLen</b> .  The second (commented out) fully processes this field, isolating the subfields by jParser - if the application using the module needs metadata from the variable part of the fidomail header in any case, then why postpone their analysis for a long time. <br><br>  The <b>AfterSubfields</b> field contains a simple search for a string of three <nobr>ASCII characters</nobr> ‚ÄúJAM‚Äù followed by a null byte ‚Äî the reason for this is set out in one of the previous paragraphs.  The commented out <b>console.log ()</b> call has a debugging meaning, no more.  (The name of the <b>moveSIG</b> internal variable is an allusion to the meme " <a href="http://en.wikipedia.org/wiki/All_your_base_are_belong_to_us">All your base are belong to</a> .") <br><br>  The number <b>69</b> in the description of the <b>MessageHeaders</b> field in the <b>JHR</b> structure is "magic";  its goal is to ensure that the analysis does not get too close to the end of the file, where you can also expect garbage data. <br><br>  I checked the speed of the analysis with the help of this test script: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> JAM = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> util = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'util'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().toLocaleString() ); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> blog = JAM(<span class="hljs-string"><span class="hljs-string">'blog-MtW'</span></span>); blog.ReadHeaders(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err,data</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> err; <span class="hljs-comment"><span class="hljs-comment">//console.log( util.inspect(data, false, Infinity, false) ); console.log( new Date().toLocaleString() ); });</span></span></code> </pre><br>  The script is in the <b>test</b> subdirectory, so the first line uses a call to the parent directory, where the text of the main module is in the <nobr><b>index.js</b></nobr> file <nobr>;</nobr>  since this name is <a href="http://nodejs.org/docs/latest/api/modules.html">implied by default in Node.js</a> , it suffices to specify only the parent directory. <br><br>  The test data in the <nobr><b>blog-MtW.jhr file</b></nobr> contains the headers of my Fidonet blogogues <nobr>( <b>Ru.Blog.Mithgol</b> )</nobr> blog <nobr><b>entries</b> that have been</nobr> accumulated since March 2007. <br><br>  A single-core Pentium IV (2.2 GHz) test runs shows that headers are processed <nobr>in three to four</nobr> seconds.  If the simple reading of the <b>Subfields</b> array <b>is</b> replaced by its analysis (which is now commented out), then this time is still doubled. <br><br>  This is a lot for a single ehoconference, because on the Fidonet node such ehoconferences can easily be more than a hundred, and the total time for analyzing the echomail headers will turn out to be multi-minute. <br><br><img src="http://traditio-ru.org/images/thumb/b/b2/%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_GoldEd%2B.png/218px-%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA_GoldEd%2B.png" align="right">  But fidoshnikam certainly do not need to be reminded that the popular Fidonet mail editor GoldED (GoldED +, <nobr>GoldED-NSF)</nobr> scans echo conferences (at the beginning of their work) much faster, and their names flash on the status bar on his screen saver so quickly that it is easy to see - on each spent a fraction of a second, no more.  One has to come to a unpleasant conclusion: javascript analysis of binary data, even on the fast V8 engine, works an order of magnitude slower - and not even slower than just one order of magnitude. <br><br>  It only remains cynically to suspect that at the beginning of work GoldED reads for speed not the entire file, but only one header structure <b>FixedHeaderInfoStruct</b> (there would be enough data from it to display the number of messages in echo conferences, and more than GoldED <nobr>does not do</nobr> anything at the beginning of work <nobr>)</nobr> , I can neither confirm nor deny this suspicion, because <nobr><a href="http://golded-plus.cvs.sourceforge.net/viewvc/golded-plus/golded%252B/">CVS GoldED +</a></nobr> did not have time to figure it out. <br><br>  I put the code for my module (JAM header reader) <a href="https://github.com/Mithgol/node-fidonet-jam">on Github</a> under a free MIT license. </div><p>Source: <a href="https://habr.com/ru/post/144268/">https://habr.com/ru/post/144268/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144261/index.html">Registration for the conference on computational linguistics "Dialogue"</a></li>
<li><a href="../144262/index.html">Inverted apple</a></li>
<li><a href="../144263/index.html">‚ÄúHow-to me‚Äù, or how to organize professional technical support</a></li>
<li><a href="../144265/index.html">DevExpress on DevCon again!</a></li>
<li><a href="../144267/index.html">Sudden May Update</a></li>
<li><a href="../144270/index.html">Photo report about connecting the most powerful switch in the world Black Diamond X8</a></li>
<li><a href="../144271/index.html">Earn on your hobby!</a></li>
<li><a href="../144274/index.html">Your main desktop environment in linux</a></li>
<li><a href="../144275/index.html">Organization of interaction architecture Activity and Service</a></li>
<li><a href="../144277/index.html">We write REST application on Sinatra and we fasten Redactor. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>