<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hyper-v cluster of two nodes, without external storage or hyperconvergence on the knee</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A long time ago, in a galaxy far far away ..., I had the task of organizing the connection of a new branch office to the central office. There were tw...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hyper-v cluster of two nodes, without external storage or hyperconvergence on the knee</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/dw/j1/wv/dwj1wv6_fwdwsbrgfymfncunu2q.jpeg" align="left">  A long time ago, in a galaxy far far away ..., I had the task of organizing the connection of a new branch office to the central office.  There were two servers available at the branch, and I thought it would be nice to organize a hyper-v failover cluster from two servers.  However, the times were long, even before the release of 2012 server.  Cluster organization requires external storage and failing to make two servers was in principle impossible. <br><br>  However, recently I came across an article by <a href="https://www.tech-coffee.net/2-node-hyperconverged-cluster-with-windows-server-2016/">Romain Serre</a> in which this problem was just solved using Windows Server 2016 and a new feature that is present in it - Storage Spaces Direct (S2D).  I just borrowed the picture from this article, because it seemed very appropriate. <br><a name="habracut"></a><br>  Technology Storage Spaces Direct has been repeatedly considered at <a href="https://special.habrahabr.ru/microsoft/hybridlaunch/article/748091/">Habr√©</a> .  But somehow I passed by, and I did not think that it could be used in the ‚Äúnational economy‚Äù.  However, this is the technology that allows you to assemble a cluster of two nodes, while creating a single shared storage between servers.  A single raid from the disks that are on different servers.  Moreover, the output of one of the disks or the whole server should not lead to data loss. <br><br><img src="https://habrastorage.org/webt/xt/_4/jl/xt_4jlsa2g0fpyqt4cnl-5coxao.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It sounds tempting and I was interested to know how it works.  However, I don‚Äôt have two test servers, so I decided to make a cluster in a virtual environment.  Benefit and nested virtualization in hyper-v recently appeared. <br><br>  For my experiments, I created 3 virtual machines.  On the first virtual machine, I installed Server 2016 with a GUI on which I picked up the AD controller and installed the remote administration tools of the RSAT server.  On the virtual machines for the nodes of the cluster, I installed Server 2016 in kernel mode.  This month, the mysterious Project Honolulu, turned into a release of the <a href="https://docs.microsoft.com/en-us/windows-server/manage/windows-admin-center/understand/windows-admin-center">Windows Admin Center</a> and I was also interested to see how convenient it would be to administer the server in kernel mode.  The quarter virtual machine will have to run inside the hyper-v cluster in the second level of virtualization. <br><br><img src="https://habrastorage.org/webt/-w/md/6s/-wmd6ss_kveqqp5jnxxx--hphio.png"><br><br>  Windows Server Datacenter 2016 is needed for cluster operation and Storage Spaces Direct service. Separately, pay attention to the hardware requirements for Storage Spaces Direct.  Network adapters between cluster nodes must be&gt; 10GB with support for remote direct memory access (RDMA).  The number of disks to pool is at least 4 (excluding disks for the operating system).  Supported NVMe, SATA, SAS.  Work with disks through RAID controllers is not supported.  <a href="https://docs.microsoft.com/ru-ru/windows-server/storage/storage-spaces/storage-spaces-direct-hardware-requirements">Learn</a> more about the requirements of <a href="https://docs.microsoft.com/ru-ru/windows-server/storage/storage-spaces/storage-spaces-direct-hardware-requirements">docs.microsoft.com</a> <br><br>  If you, like me, have never worked with hyper-v nested virtualization, then there are several nuances in it.  First, it is disabled by default on new virtual machines.  If you want to enable the hyper-v role in the virtual machine, you will get an error stating that the hardware does not support this role.  Secondly, the embedded virtual machine (at the second level of virtualization) will not have access to the network.  To organize access, you must either configure nat, or enable spoofing for the network adapter.  The third nuance, to create a node of the cluster, you can not use dynamic memory.  More on the <a href="https://docs.microsoft.com/ru-ru/virtualization/hyper-v-on-windows/user-guide/nested-virtualization">link</a> . <br><br>  Therefore, I created two virtual machines - node1, node2 and immediately disabled dynamic memory.  Then you need to enable support for nested virtualization: <br><br><pre><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>-VMProcessor -VMName node1,node2 -ExposeVirtualizationExtensions $<span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br>  We enable support for spoofing on VM network adapters: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-VMNetworkAdapter -VMName node1,node2 | <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>-VMNetworkAdapter -MacAddressSpoofing <span class="hljs-keyword"><span class="hljs-keyword">On</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/is/qz/rm/isqzrmwxjgpy94ddtvbhj3w96jk.png"><br>  HDD10 and HDD 20 I used as system partitions on nodes.  I added the remaining disks for shared storage and did not mark them. <br><br>  My Net1 network interface is configured to work with an external network and connect to a domain controller.  The Net2 interface is configured to operate the internal network, only between the nodes of the cluster. <br><br>  To shorten the presentation, I will omit the steps necessary to add nodes to the domain and configure the network interfaces.  Using the console utility <b>sconfig</b> is not a big deal.  I will only clarify that I installed Windows Admin Center using a script: <br><br><pre> <code class="hljs pgsql">msiexec /i "C:\WindowsAdminCenter1804.msi" /qn /L*v <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>.txt SME_PORT=<span class="hljs-number"><span class="hljs-number">6515</span></span> SSL_CERTIFICATE_OPTION=generate</code> </pre> <br>  On the network from the shared folder, the installation of Admin Center failed.  Therefore, we had to turn on the File Server Role service and copy the installer to each server, as they <a href="https://docs.microsoft.com/en-us/windows-server/manage/windows-admin-center/deploy/prepare-environment">recommend</a> in ms. <br><br>  When the preparatory part is ready and before starting to create a cluster, I recommend updating the nodes, because without the April updates, the Windows Admin Center will not be able to manage the cluster. <br><br>  Let's start creating a cluster.  Let me remind you that all the necessary consoles are installed on my domain controller.  Therefore, I connect to the domain and run Powershell ISE as administrator.  Then I install the necessary roles on the nodes to build the cluster using the script: <br><br><pre> <code class="hljs perl">$Servers = <span class="hljs-string"><span class="hljs-string">"node1"</span></span>,<span class="hljs-string"><span class="hljs-string">"node2"</span></span> $ServerRoles = <span class="hljs-string"><span class="hljs-string">"Data-Center-Bridging"</span></span>,<span class="hljs-string"><span class="hljs-string">"Failover-Clustering"</span></span>,<span class="hljs-string"><span class="hljs-string">"Hyper-V"</span></span>,<span class="hljs-string"><span class="hljs-string">"RSAT-Clustering-PowerShell"</span></span>,<span class="hljs-string"><span class="hljs-string">"Hyper-V-PowerShell"</span></span>,<span class="hljs-string"><span class="hljs-string">"FS-FileServer"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($server in $servers){ Install-WindowsFeature ‚ÄìComputername $server ‚ÄìName $ServerRoles}</code> </pre> <br>  And I overload the server after installation. <br><br>  Run the test to verify node availability: <br><br><pre> <code class="hljs pgsql">Test-<span class="hljs-keyword"><span class="hljs-keyword">Cluster</span></span> ‚ÄìNode "node1","node2" ‚Äì<span class="hljs-keyword"><span class="hljs-keyword">Include</span></span> "Storage Spaces Direct", "Inventory", "Network", "System Configuration</code> </pre> <br>  The report in the html format was formed in the folder C: \ Users \ Administrator \ AppData \ Local \ Temp.  The path to the report utility writes only if there are errors. <br><br>  Finally, we create a cluster with the name <b>hpvcl</b> and shared IP address 192.168.1.100 <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">New</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">Cluster</span></span> ‚Äì<span class="hljs-type"><span class="hljs-type">Name</span></span> hpvcl ‚ÄìNode "node1","node2" ‚ÄìNoStorage -StaticAddress <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span></code> </pre> <br>  After that we get the error that in our cluster there is no shared storage for fault tolerance.  Run the Failover cluster manager and check what we got. <br><br><img src="https://habrastorage.org/webt/xu/oj/nf/xuojnfniz_l6hyuzuyn6ejtheqs.png"><br><br>  Turn on (S2D) <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Enable</span></span>-ClusterStorageSpacesDirect ‚ÄìCimSession hpvcl</code> </pre> <br>  And we get a notification that no disks were found for the cache.  Since the test environment is on my SSD, and not on the HDD, we will not worry about this. <br><br>  Then we connect to one of the nodes using the powershell console and create a new volume.  It should be noted that of 4 disks of 40GB each, about 74GB is available for creating a mirrored volume. <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">New</span></span>-Volume -FriendlyName "Volume1" -FileSystem CSVFS_ReFS -StoragePoolFriendlyName S2D* -Size <span class="hljs-number"><span class="hljs-number">74</span></span>GB -ResiliencySettingName Mirror</code> </pre> <br><img src="https://habrastorage.org/webt/y8/va/zz/y8vazzg75tctdskvu9n82tqy_yy.jpeg"><br><br>  On each of the nodes, we have a common volume C: \ ClusterStorage \ Volume1. <br>  A shared disk cluster is ready.  Now we will create a VM virtual machine on one of the nodes and place it on the shared storage. <br><br><img src="https://habrastorage.org/webt/s9/g_/rj/s9g_rj-hvipsdnsbardroymrzxu.png"><br><br>  For the network settings of the virtual machine, you will need to connect with the hyper-v manager console and create a virtual network with external access on each of the nodes with the same name.  Then I had to restart the cluster service on one of the nodes to get rid of the error with the network interface in the failover cluster manager console. <br><br>  While the system is being installed on the virtual machine, we will try to connect to the Windows Admin Center.  We add our hyperconvergent cluster in it and get a sad smiley <br><br><img src="https://habrastorage.org/webt/wh/w0/qx/whw0qxepw17wcf0w5dz-87sa7eg.png"><br><br>  Connect to one of the nodes and execute the script: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>-ClusterResourceType -<span class="hljs-type"><span class="hljs-type">Name</span></span> "SDDC Management" -dll "$env:SystemRoot\Cluster\sddcres.dll" -DisplayName "SDDC Management"</code> </pre> <br>  Check the admin center and this time we get beautiful graphics <br><br><img src="https://habrastorage.org/webt/nf/wb/nw/nfwbnwqtvs0ryyrarx7pmmjrl3e.png"><br><br>  After installing the OS on a VM virtual machine inside the cluster, first of all I checked Live migration, moving it to the second node.  During the migration, I pinged the machine to check how fast the migration took place.  My connection disappeared only for 2 requests, which can be considered a very good result. <br><br>  And here it is worth adding a few spoons of tar to this hyper-convergent barrel of honey.  In a test and virtual environment, everything works well, but how this works on real hardware is an interesting question.  It is worth returning to the hardware requirements.  10GB network adapters with RDMA cost about $ 500, which, combined with the Windows Server Datacenter license, makes the decision not so cheap.  Of course, this is cheaper than dedicated storage, but the limitation is significant. <br><br>  The second and main spoon of tar is the news that the function (S2D) <a href="https://www.tech-coffee.net/dont-worry-storage-spaces-direct-not-dead/">will be removed from the next build of server 2016</a> .  I hope, the Microsoft employees reading Habr will comment on it. <br><br>  In conclusion I would like to say a few words about my impressions.  Familiarity with new technologies was a very interesting experience for me.  Call it useful until I can.  I'm not sure I can put these skills into practice.  Therefore, I have questions to the community: are you ready to consider a transition to hyper-convergent solutions in the future?  How do you feel about the placement of virtual domain controllers on the nodes themselves? </div><p>Source: <a href="https://habr.com/ru/post/354228/">https://habr.com/ru/post/354228/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354214/index.html">Payment Management Privat24 from Google-tables</a></li>
<li><a href="../354216/index.html">Forbes: Alibaba and Uber have become the most profitable companies for investors</a></li>
<li><a href="../354220/index.html">Applying recurrent layers to solve multiple paths</a></li>
<li><a href="../354224/index.html">slowpoke is not the fastest database</a></li>
<li><a href="../354226/index.html">Another option for generating thumbnails for images using AWS Lambda & golang + nodejs + nginx</a></li>
<li><a href="../354230/index.html">What is wrong with 3D PDF and eDrawings. How do we replace the 3D viewer in our application</a></li>
<li><a href="../354232/index.html">How not to go crazy with Scrum? Experience a growing project</a></li>
<li><a href="../354234/index.html">Release Node.js 10 and NPM 6</a></li>
<li><a href="../354236/index.html">Why the creation of a simple preview on the links in Wikipedia took four years</a></li>
<li><a href="../354238/index.html">Victor Gamov on Apache Kafka on jug.msk.ru</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>