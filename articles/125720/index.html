<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Getting an instance of a query class by its interface signature</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, an article ( link to the topic) of my colleague AlexanderByndyu was published on Habr√©, describing avoiding using Repository in the d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Getting an instance of a query class by its interface signature</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago, an <a title="Problem Repository Template" href="http://blog.byndyu.ru/2011/08/repository.html">article</a> ( <a title="Problem Repository Template" href="http://habrahabr.ru/blogs/net/125411/">link</a> to the topic) of my colleague <a href="https://habrahabr.ru/users/alexanderbyndyu/" class="user_link">AlexanderByndyu</a> was published on Habr√©, describing avoiding using Repository in the direction of using the QueryFactory bundle + Query query classes.  At the same time, a very interesting dispute broke out in the comments regarding the expediency of the decision given in the article.  There were a lot of interesting reviews, among which were the statements that, say, QueryFactory is not needed and is an extra burden that prevents painless adding, changing and deleting query classes.  In this article I want to show an approach that allows you to get rid of the use of QueryFactory, through the active use of the IoC container.  We used this organization of work with the class structure of queries in one of our recent projects, where Castle.Windsor was used as IoC. <br><a name="habracut"></a><br><br><h4>  Description of the approach </h4><br>  To begin with, I will describe the main idea embedded in the described approach.  Its essence is close to how the compiler determines which version of the overloaded method is used in a particular case, namely signature identification.  And if in the case when it comes to the method, its signature is the order, number and types of arguments passed, then if it is necessary to obtain a specific implementation of the interface from the IoC container, then the signature is determined by a set of generic parameters in the interface.  It is possible that there is some discrepancy in terms with those who are used to understanding the set of its methods under the interface signature, but in this article I propose to adopt the above interpretation of the concept. <br>  I hope it is generally understandable, and if not, then when viewing the above example, everything will fall into place. <br><br><h4>  Implementation </h4><br>  Suppose we have a common for all requests interface IQuery &lt;,&gt;: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">interface</font> IQuery&lt; <font color="#0000ff">in</font> TCriterion, <font color="#0000ff">out</font> TResult&gt; <br> <font color="#0000ff">where</font> TCriterion : ICriterion <br> { <br> TResult Execute(TCriterion criterion); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Accordingly, its signature is determined by the specific implementation of ICriterion, i.e.  an object containing the data necessary to build the query (mainly for Where filtering predicates), as well as the type of the returned result.  Thus, if there is a single implementation of the IQuery &lt;,&gt; interface with certain types of TCriterion and TResult generic parameters, knowing these types you can get an interface implementation. <br>  Below is the code in the WindsorInstaller class that registers all implementations of the IQuery &lt;,&gt; interface in an IoC container. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> WindsorInstaller : IWindsorInstaller <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> Install(IWindsorContainer container, IConfigurationStore store) <br> { <br> <font color="#0000ff">var</font> queries = AllTypes.FromAssemblyNamed( <font color="#A31515">"Domain.NHibernate"</font> ) <br> .BasedOn( <font color="#0000ff">typeof</font> (IQuery&lt;,&gt;)) <br> .WithService.FirstInterface() <br> .Configure(x =&gt; x.LifeStyle.Transient); <br> <br> container.Register(queries); <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  In this example, all implementations of the IQuery &lt;,&gt; interface from the Domain.NHibernate assembly contain them and the obtained types are registered in the container as implementations of their first interface (which again is IQuery &lt;,&gt;). <br>  For further use of a specific query in the controller or, let's say, in the form handler, it is necessary to write a small but very important auxiliary class.  But first, I would like to give an example of its use, so that you can understand the opportunities it provides and the appearance (for the developer) of the mechanism for obtaining the implementation of a request by interface signature.  Let's call this example listing 1. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">var</font> account = Query.For&lt;Account&gt;().With( <font color="#0000ff">new</font> LoginCriterion(login));</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  In this example, we receive a request by the signature of its interface, from which we want it to return the Account entity, and search to be done by the login of this account itself.  Login passed through LoginCriterion.  It is appropriate that the above code be more transparent I cite the request code that will be used in the above example, as well as the code of the LoginCriterion class. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> FindAccountByLoginQuery : LinqQueryBase&lt;Account&gt;, IQuery&lt;LoginCriterion, Account&gt; <br> { <br> <font color="#0000ff">public</font> FindAccountByLoginQuery(ILinqProvider linqProvider) <br> : <font color="#0000ff">base</font> (linqProvider) <br> { <br> } <br> <br> <font color="#0000ff">public</font> Account Execute(LoginCriterion criterion) <br> { <br> <font color="#0000ff">return</font> Query() <br> .SingleOrDefault(x =&gt; x.Login.ToLower() == criterion.Login.ToLower()); <br> } <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> LoginCriterion : ICriterion <br> { <br> <font color="#0000ff">public</font> LoginCriterion( <font color="#0000ff">string</font> login) <br> { <br> Login = login; <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> Login { <font color="#0000ff">get</font> ; <font color="#0000ff">set</font> ; } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Now, with regard to the auxiliary code, it is represented by two interfaces: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">interface</font> IQueryBuilder <br> { <br> IQueryFor&lt;TResult&gt; For&lt;TResult&gt;(); <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">interface</font> IQueryFor&lt; <font color="#0000ff">out</font> T&gt; <br> { <br> T With&lt;TCriterion&gt;(TCriterion criterion) <font color="#0000ff">where</font> TCriterion : ICriterion; <br> <br> T ById( <font color="#0000ff">int</font> id); <br> <br> <font color="#2B91AF">IEnumerable</font> &lt;T&gt; All(); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  ... and their implementations: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> QueryBuilder : IQueryBuilder <br> { <br> <font color="#0000ff">private</font> <font color="#0000ff">readonly</font> IDependencyResolver dependencyResolver; <br> <br> <font color="#0000ff">public</font> QueryBuilder(IDependencyResolver dependencyResolver) <br> { <br> <font color="#0000ff">this</font> .dependencyResolver = dependencyResolver; <br> } <br> <br> <font color="#0000ff">public</font> IQueryFor&lt;TResult&gt; For&lt;TResult&gt;() <br> { <br> <font color="#0000ff">return</font> <font color="#0000ff">new</font> QueryFor&lt;TResult&gt;(dependencyResolver); <br> } <br> <br> <font color="#0000ff">#region</font> Nested type: QueryFor <br> <br> <font color="#0000ff">private</font> <font color="#0000ff">class</font> QueryFor&lt;TResult&gt; : IQueryFor&lt;TResult&gt; <br> { <br> <font color="#0000ff">private</font> <font color="#0000ff">readonly</font> IDependencyResolver dependencyResolver; <br> <br> <font color="#0000ff">public</font> QueryFor(IDependencyResolver dependencyResolver) <br> { <br> <font color="#0000ff">this</font> .dependencyResolver = dependencyResolver; <br> } <br> <br> <font color="#0000ff">public</font> TResult With&lt;TCriterion&gt;(TCriterion criterion) <font color="#0000ff">where</font> TCriterion : ICriterion <br> { <br> <font color="#0000ff">return</font> dependencyResolver.GetService&lt;IQuery&lt;TCriterion, TResult&gt;&gt;().Execute(criterion); <br> } <br> <br> <font color="#0000ff">public</font> TResult ById( <font color="#0000ff">int</font> id) <br> { <br> <font color="#0000ff">return</font> dependencyResolver.GetService&lt;IFindByIdQuery&lt;TResult&gt;&gt;().Execute( <font color="#0000ff">new</font> IdCriterion(id)); <br> } <br> <br> <font color="#0000ff">public</font> <font color="#2B91AF">IEnumerable</font> &lt;TResult&gt; All() <br> { <br> <font color="#0000ff">return</font> dependencyResolver.GetService&lt;IFindAllQuery&lt;TResult&gt;&gt;().Execute( <font color="#0000ff">new</font> EmptyCriterion()); <br> } <br> } <br> <br> <font color="#0000ff">#endregion</font> <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  In fact, for the implementation of our approach, we could restrict ourselves to a single interface, but then we would have to explicitly specify a generic parameter such as an ICriterion implementation, which would make the IQueryBuilder interface heavy.  At the indicated implementation, only the type of the value returned from the request is explicitly indicated.  The immediate receipt of the request instance from the IoC container and its execution are performed by the QueryFor &lt;&gt; class.  It uses the interface to the IoC container provided by the internal ASP.NET MVC3, IDependencyResolver.  In our case, as a result, all requests to the container will be delegated to Castle.Windsor. <br>  One of the main features of using QueryBuilder is to register it in the IoC container as an implementation of the IQueryBuilder interface.  Due to the injection of dependencies into the constructor, as well as the implementation substitution mechanism introduced in ASP.NET MVC3 for all public properties of objects whose types are registered in the container, if the object instance itself is also obtained from the container, the following becomes possible (abstract example, the opening code UnitOfWork omitted). <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> AccountController : Controller <br> { <br> <font color="#0000ff">public</font> IQueryBuilder Query { <font color="#0000ff">get</font> ; <font color="#0000ff">set</font> ; } <br> <br> <font color="#0000ff">public</font> ActionResult Index( <font color="#0000ff">string</font> login) <br> { <br> <font color="#0000ff">var</font> account = Query.For&lt;Account&gt;().With( <font color="#0000ff">new</font> LoginCriterion(login)); <br> <br> <font color="#008000">//   - </font> <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Conclusion </h4><br>  This approach allows not only to get rid of QueryFactory, which makes adding, changing and deleting query classes painless, but also allows you to completely abstract from the concept of a query in the context of its place of use.  I would even call such a mechanism for receiving requests "real", since  it operates with two key concepts closely related to the query in the context of the CQS approach: these are the input criteria of the sample and the return result.  It would seem that different implementations of ICriterion can ‚Äúclutter up‚Äù the code, but in fact this is not the case, since  they can be reused for various requests. <br>  Such an approach to obtaining implementations by interface signature can be used not only for requests, but also for implementations of other generic interfaces, especially if there are many of these implementations and / or their composition is subject to frequent changes.  For example, commands can serve as similar objects (from the CQS approach). <br><br>  I hope for a good discussion in the comments and look forward to constructive suggestions on this approach from the habrasoobshchestva.  If you have comments on spelling and punctuation in this article, then please write them through private messages. </div><p>Source: <a href="https://habr.com/ru/post/125720/">https://habr.com/ru/post/125720/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125714/index.html">Fantasy sport: what it is, why it is, and how it affects real life</a></li>
<li><a href="../125716/index.html">N00ter software package allows you to avoid shaping by type of traffic</a></li>
<li><a href="../125717/index.html">Akka for Java developer (part 1)</a></li>
<li><a href="../125718/index.html">Connecting Facebook Credits for online stores</a></li>
<li><a href="../125719/index.html">Epidemic in the data</a></li>
<li><a href="../125721/index.html">Jimmy Wales: Wikipedia loses authors</a></li>
<li><a href="../125722/index.html">thank you!</a></li>
<li><a href="../125723/index.html">Survival Guide on Black Hat and Defcon conferences: how to escape from hackers</a></li>
<li><a href="../125725/index.html">You have added a block of functionality (method, class, module). Your actions:</a></li>
<li><a href="../125726/index.html">Examples of successful SMM campaigns in runet. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>