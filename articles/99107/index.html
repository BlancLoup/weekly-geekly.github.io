<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>NerdDinner. Step 3: Build a Model</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the third step of the free NerdDinner tutorial , which shows how to build a small but full-fledged web application using ASP. NET MVC. 

 In a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>NerdDinner. Step 3: Build a Model</h1><div class="post__text post__text-html js-mediator-article">  <i>This is the third step of the <a href="http://nerddinnerbook.s3.amazonaws.com/Intro.htm">free NerdDinner tutorial</a></i> <i>, which shows how to build a small but full-fledged web application using</i> <i>ASP.</i>  <i>NET</i> <i>MVC.</i> <br><br>  In a model-view-controller type framework, the term ‚Äúmodel‚Äù refers to objects that represent application data, as does the corresponding domain logic that integrates validation and business rules.  In many cases, the model is the ‚Äúheart‚Äù of the MVC application and, as we will see later, controls its basic behavior. <br><br>  ASP.NET MVC framework supports the use of any data access technology; therefore, developers can choose from various options for implementing their model, including: LINQ to Entities, LINQ to SQL, NHibernate, LLBLGen Pro, SubSonic, WilsonORM, or direct access via ADO.NET DataReader and DataSet . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For our NerdDinner application, we will use LINQ to SQL to create a simple model that is almost similar to the database structure, and also add some validation logic and business rules.  Later, we will implement a storage class that will help abstract the constant implementation of storing data from the rest of the application and make it easy to perform unit tests with it. <br><a name="habracut"></a><br><h3>  LINQ to SQL </h3><br>  LINQ to SQL is ORM (Object Relational Projection), which is supplied as part of .NET 3.5. <br><br>  LINQ to SQL provides an easy way to associate database tables with .NET classes.  For our NerdDinner applications we will use to link the Dinners tables and RSVP and the classes Dinner and RSVP.  The columns of the Dinners and RSVP tables will correspond to the properties of the Dinner and RSVP classes.  Each Dinner and RSVP object will represent a separate line in the Dinner or RSVP tables in the database. <br><br>  LINQ to SQL allows you to avoid manually building SQL queries to receive or update Dinner and RSVP objects with data in the database.  Instead, we declare Dinner RSVP classes, how they connect to the database and define the connections between them.  LINQ to SQL will take care of creating appropriate SQL logic for use while working with objects. <br><br>  We can use the LINQ language supported in VB and C # to write queries that return Dinner and RSVP objects from the database.  This minimizes the size of the code that we need to write and allows us to build really clean applications. <br><br><h3>  Adding LINQ to SQL classes to a project </h3><br>  We will start by pressing the right button on the ‚ÄúModels‚Äù folder in the project and select <b>Add&gt;</b> <b>New</b> <b>Item</b> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/530/9ef/417/5309ef4174253313d678e9d6e0af3d36.png"><br><br>  In the ‚ÄúAdd New Item‚Äù window, filter by the ‚ÄúData‚Äù category and select the ‚ÄúLINQ to SQL Classes‚Äù template: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/098/190/3cf/0981903cf3af12e7fc4ca25477563b31.png"><br><br>  Name the element ‚ÄúNerdDinner‚Äù and add it.  Visual Studio will add the NerdDinner.dbml file to the \ Models directory and open the link constructor for the LINQ to SQL object: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/80b/8b7/9ef/80b8b79ef1f13e4ea5ee375398343f5b.png"><br><br><h3>  Creating Data Model Classes with LINQ to SQL </h3><br>  LINQ to SQL allows us to quickly create data model classes from an existing database schema.  To do this, open the NerdDinner database in Server Explorer and select the tables for which you need to create a model: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f0d/ecb/366/f0decb366364d51e10c49f33f6303014.png"><br><br>  Next, drag tables into the LINQ to SQL constructor.  Once we do this, LINQ to SQL will automatically create the Dinner and RSVP classes using the table schema, including class properties that are associated with the columns of the database table: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e82/c65/39b/e82c6539b73b07020145765815d680cf.png"><br><br>  By default, the LINQ to SQL constructor automatically processes the plural in table names and column names during class creation.  For example: the ‚ÄúDinners‚Äù table becomes the ‚ÄúDinner‚Äù class.  This class naming helps the model to adhere to compatibility with the .NET naming rules, and even when you add a large number of tables, this is convenient.  If you do not like the name of the class or property that the constructor generated, you can always change it to a more appropriate one through editing in the constructor or in the properties. <br><br>  Also by default, the LINQ to SQL constructor finds the primary and foreign keys of the tables and, based on them, automatically creates links between different classes of models.  For example, when we dragged the Dinners and RSVP tables onto the LINQ to SQL designer, a one-to-many relationship was created because the RSVP table contains a foreign key to the Dinners table (indicated by the arrow in the designer): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4c2/428/e42/4c2428e42d74f2ceead482fabcd3ff5c.png"><br><br>  This link will allow LINQ to SQL to add the strongly typed ‚ÄúDinner‚Äù property to the RSVP class, which developers can use to access Dinner bound to RSVP.  It will also allow the Dinner class to contain a collection of RSVP properties, which gives developers the ability to get or modify RSVP objects bound to Dinner. <br><br>  Below is an example of intellisense in VisualStudio when we create a new RSVP object and add it to the RSVP collection of an object of the Dinner class.  Notice how LINQ to SQL automatically added an RSVP collection of objects to an object of class Dinner: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b96/67b/a43/b9667ba4322911447162f7153cd4cfc7.png"><br><br>  By adding an RSVP object to the RSVP collection of the Dinner object, we tell LINQ to SQL to link the string Dinner and RSVP in the database via a foreign key: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/556/c08/d5d/556c08d5d7d14b9c6aab4cfd53866e8f.png"><br><br>  If you, again, do not like the way the designer called the relationship between the tables, then you can change that.  Just click on the link arrow in the constructor and rename / delete / change it.  For our application, the default communication rules are great for the data model class. <br><br><h3>  Class NerdDinnerDataContext </h3><br>  Visual Studio automatically creates .NET classes that represent models and relationships using the LINQ to SQL constructor.  Also, a DataContext class is created for each file created by the LINQ to SQL constructor.  Since we called our LINQ to SQL class ‚ÄúNerdDinner‚Äù, the DataContext class will be named ‚ÄúNerdDinnerDataContext‚Äù, which directly interacts with the database. <br><br>  The NerdDinnerDataContext class contains two properties, ‚ÄúDinners‚Äù and ‚ÄúRVSPs‚Äù, which represent the two tables that we created in the database.  We can use C # to write LINQ queries with these properties, to get Dinner and RSVP objects from the database. <br><br>  The following code demonstrates the operation of the NerdDinnerDataContext object with a LINQ request to get a queue of upcoming dinners (Dinners).  Visual Studio provides full intellisense support while writing LINQ queries.  The objects that returned the query are strongly typed: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8a2/e89/cfb/8a2e89cfbf4054b6e9cbb1b542c2a560.png"><br><br>  In addition, the NerdDinnerDataContext automatically tracks any changes in Dinner and RSVP objects. You can use this functionality to easily save changes to the database, without the need to write SQL UPDATE code. <br><br>  For example, let's consider how to use a LINQ query to get a single object of the Dinner class from the database, change two Dinner properties and then save the changes back to the database: <br><blockquote><code><font color="black">NerdDinnerDataContext db = <font color="#0000ff">new</font> NerdDinnerDataContext(); <br> <br> <font color="#008000">//   Dinner,     DinnerID  1</font> <br> Dinner dinner = db.Dinners.Single(d =&gt; d.DinnerID == 1); <br> <br> <font color="#008000">//    Dinner </font> <br> dinner.Title = <font color="#A31515">"Changed Title"</font> ; <br> dinner.Description = <font color="#A31515">"This dinner will be fun"</font> ; <br> <br> <font color="#008000">//    </font> <br> db.SubmitChanges();</font></code> </blockquote> <br>  The NerdDinnerDataContext object automatically tracks the changes we made to the properties of the resulting Dinner object.  When we call the ‚ÄúSubmitChanges ()‚Äù method, it will execute the corresponding SQL ‚ÄúUPDATE‚Äù query to save the changes to the database. <br><br><h3>  Create a class DinnerRepository </h3><br>  For small applications, it is sometimes convenient when the controllers work directly with the LINQ to SQL DataContext class and LINQ queries reside in controllers.  But with the growth of the application, this campaign becomes cumbersome and inconvenient for testing.  We will also encounter LINQ code duplication in different places. <br><br>  But there is an approach that will facilitate the support and testing of the project - this is the design pattern of the Repository.  The class of the repository helps to encapsulate data requests and logic, abstracts the implementation details of the data from the application.  In addition, for cleaner code, the use of the repository pattern allows you to change the implementation of the data warehouse in the future, as well as facilitates unit testing of the application, since it does not require a real database. <br><br>  For our NerdDinner project, we will declare a DinnerRepositary class with the following signature: <br><blockquote> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> DinnerRepository { <br> <font color="#008000">//  </font> <br> <font color="#0000ff">public</font> IQueryable&lt;Dinner&gt; FindAllDinners(); <br> <font color="#0000ff">public</font> IQueryable&lt;Dinner&gt; FindUpcomingDinners(); <br> <font color="#0000ff">public</font> Dinner       GetDinner( <font color="#0000ff">int</font> id); <br> <br> <font color="#008000">// /</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> Add(Dinner dinner); <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> Delete(Dinner dinner); <br> <br> <font color="#008000">// </font> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> Save(); <br> }</font></code> </blockquote> <br>  <i>Later we will extract the IDinnerRepository interface from this class</i> <i>to allow dependency injection with it in our controllers.</i>  <i>But first we will work directly with the</i> <i>DinnerRepository</i> <i>class</i> <i>.</i> <br><br>  To implement this class, right-click on the ‚ÄúModels‚Äù folder and select <b>Add&gt;</b> <b>New</b> <b>Item</b> .  In the opened window, select the ‚ÄúClass‚Äù template and name the file ‚ÄúDinnerRepository.cs‚Äù: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bf1/bb9/2b8/bf1bb92b82834774688c19a88707808d.png"><br><br>  Next, we fill our DinnerRepository class with the following code: <br><blockquote> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> DinnerRepository { <br> <font color="#0000ff">private</font> NerdDinnerDataContext db = <font color="#0000ff">new</font> NerdDinnerDataContext(); <br> <br> <font color="#008000">//</font> <br> <font color="#008000">//  </font> <br> <font color="#0000ff">public</font> IQueryable&lt;Dinner&gt; FindAllDinners() { <br> <font color="#0000ff">return</font> db.Dinners; <br> } <br> <br> <font color="#0000ff">public</font> IQueryable&lt;Dinner&gt; FindUpcomingDinners() { <br> <font color="#0000ff">return</font> <font color="#0000ff">from</font> dinner <font color="#0000ff">in</font> db.Dinners <br> <font color="#0000ff">where</font> dinner.EventDate &gt; <font color="#2B91AF">DateTime</font> .Now <br> orderby dinner.EventDate <br> <font color="#0000ff">select</font> dinner; <br> } <br> <br> <font color="#0000ff">public</font> Dinner GetDinner( <font color="#0000ff">int</font> id) { <br> <font color="#0000ff">return</font> db.Dinners.SingleOrDefault(d =&gt; d.DinnerID == id); <br> } <br> <br> <font color="#008000">//</font> <br> <font color="#008000">//  Insert/Delete</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> Add(Dinner dinner) { <br> db.Dinners.InsertOnSubmit(dinner); <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> Delete(Dinner dinner) { <br> db.RSVPs.DeleteAllOnSubmit(dinner.RSVPs); <br> db.Dinners.DeleteOnSubmit(dinner); <br> } <br> <br> <font color="#008000">//</font> <br> <font color="#008000">// </font> <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> Save() { <br> db.SubmitChanges(); <br> } <br> }</font></code> </blockquote> <br><h3>  Retrieving, modifying, adding, and deleting data using the DinnerRepository class </h3><br>  Now that we have created the DinnerRepository class, let's take a look at a few examples that demonstrate the implementation of common tasks: <br><br><h4>  Query examples </h4><br>  The following code returns one dinner (Dinner) using the DinnerID value: <br><blockquote> <code><font color="black">DinnerRepository dinnerRepository = <font color="#0000ff">new</font> DinnerRepository(); <br> <br> <font color="#008000">//     DinnerID</font> <br> Dinner dinner = dinnerRepository.GetDinner(5);</font> <br></code> </blockquote><br>  The code below returns all upcoming dinners and loops through each one: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">DinnerRepository dinnerRepository = <font color="#0000ff">new</font> DinnerRepository(); <br> <br> <font color="#008000">//    </font> <br> <font color="#0000ff">var</font> upcomingDinners = dinnerRepository.FindUpcomingDinners(); <br> <br> <font color="#008000">//            </font> <br> <font color="#0000ff">foreach</font> (Dinner dinner <font color="#0000ff">in</font> upcomingDinners) { <br> Response.Write( <font color="#A31515">"Title"</font> + dinner.Title); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><h4>  Add and remove example </h4><br>  The following code demonstrates the addition of two new dinners.  Any additions or changes to the repository are not applied until we call the ‚ÄúSave ()‚Äù method.  LINQ to SQL automatically wraps all changes into a database transaction, hence either all changes or none are executed: <br><br><blockquote> <code><font color="black">DinnerRepository dinnerRepository = <font color="#0000ff">new</font> DinnerRepository(); <br> <br> <font color="#008000">//   </font> <br> Dinner newDinner1 = <font color="#0000ff">new</font> Dinner(); <br> newDinner1.Title = <font color="#A31515">"Dinner with Scott"</font> ; <br> newDinner1.HostedBy = <font color="#A31515">"ScotGu"</font> ; <br> newDinner1.ContactPhone = <font color="#A31515">"425-703-8072"</font> ; <br> <br> <font color="#008000">//   </font> <br> Dinner newDinner2 = <font color="#0000ff">new</font> Dinner(); <br> newDinner2.Title = <font color="#A31515">"Dinner with Bill"</font> ; <br> newDinner2.HostedBy = <font color="#A31515">"BillG"</font> ; <br> newDinner2.ContactPhone = <font color="#A31515">"425-555-5151"</font> ; <br> <br> <font color="#008000">//    </font> <br> dinnerRepository.Add(newDinner1); <br> dinnerRepository.Add(newDinner2); <br> <br> <font color="#008000">//  </font> <br> dinnerRepository.Save();</font></code> </blockquote> <br>  The code below returns an existing Dinner object and changes its two properties.  Properties are saved to the database after calling the ‚ÄúSave ()‚Äù repository method: <br><blockquote> <code><font color="black">DinnerRepository dinnerRepository = <font color="#0000ff">new</font> DinnerRepository(); <br> <br> <font color="#008000">//     DinnerID</font> <br> Dinner dinner = dinnerRepository.GetDinner(5); <br> <br> <font color="#008000">//   Dinner</font> <br> dinner.Title = <font color="#A31515">"Update Title"</font> ; <br> dinner.HostedBy = <font color="#A31515">"New Owner"</font> ; <br> <br> <font color="#008000">//  </font> <br> dinnerRepository.Save();</font></code> </blockquote> <br>  The following code returns dinner and adds RSVP to it.  It does this through the RSVP Dinner object collection, which was created by LINQ to SQL (based on foreign keys).  These changes will be sent to the database as a new line of the RSVP table when we call the ‚ÄúSave ()‚Äù method: <br><blockquote> <code><font color="black">DinnerRepository dinnerRepository = <font color="#0000ff">new</font> DinnerRepository(); <br> <br> <font color="#008000">//     DinnerID</font> <br> Dinner dinner = dinnerRepository.GetDinner(5); <br> <br> <font color="#008000">//    RSVP</font> <br> RSVP myRSVP = <font color="#0000ff">new</font> RSVP(); <br> myRSVP.AttendeeName = <font color="#A31515">"ScottGu"</font> ; <br> <br> <font color="#008000">//  RSVP   RSVP  Dinner</font> <br> dinner.RSVPs.Add(myRSVP); <br> <br> <font color="#008000">//  </font> <br> dinnerRepository.Save();</font></code> </blockquote> <br><h3>  Deletion example </h3><br>  The code below returns an existing Dinner object and then marks it as deleted.  When we call the ‚ÄúSave ()‚Äù method it will be removed from the database: <br><blockquote> <code><font color="black">DinnerRepository dinnerRepository = <font color="#0000ff">new</font> DinnerRepository(); <br> <br> <font color="#008000">//     DinnerID</font> <br> Dinner dinner = dinnerRepository.GetDinner(5); <br> <br> <font color="#008000">//    </font> <br> dinnerRepository.Delete(dinner); <br> <br> <font color="#008000">//  </font> <br> dinnerRepository.Save();</font></code> </blockquote> <br><h3>  Integrating business logic checks and rules into model classes </h3><br>  A key part of any application that works with data is the integration of checks and business logic rules. <br><br><h4>  Check schema </h4><br>  When model classes are declared using the LINQ to SQL constructor, the data types of the model class properties correspond to the data types of the database table.  For example: if the ‚ÄúEventData‚Äù column in the Dinners table is of the ‚Äúdatetime‚Äù type, then the data model class created by LINQ to SQL will be of the ‚ÄúDateTime‚Äù type, which is the native data type in .NET.  As a result, we will get errors at the compilation stage if we try to assign an integer or bool to this property, or an error occurs if you try to implicitly convert a string of an incorrect format during program execution. <br><br>  LINQ to SQL also automatically handles escape sequences, helping to protect the application from SQL injection. <br><br><h4>  Validation and rules of business logic </h4><br>  Validation of the scheme is useful as the first stage, but this is not enough.  Many real-world situations require the ability to define a more detailed algorithm for validation, which may include several properties, the execution of a specific code, the receipt of information from the model about the state (for example, it was created / changed / deleted or, according to the domain specification, ‚Äúarchived‚Äù) .  There are many different patterns and frameworks that can be used to define and apply validation rules for a model class, all of which are implemented by third-party .NET-based components.  You can use any of these in ASP.NET MVC applications. <br><br>  The goal of our NerdDinner application will be to use a fairly simple and easy-to-understand pattern, where we will extend the IsValid property and the GetRuleViolations () method of our object model Dinner.  The IsValid property will return true or false, depending on the success of passing validation and business rules.  The GetRuleViolations () method will return a list of errors that occurred. <br><br>  We implement IsValid and GetRuleViolations () for the Dinner model, adding a partial class to our project.  Partial classes are used to add methods / properties / events for classes that are controlled by a VS-constructor (like the Dinner class generated by the LINQ to SQL constructors) and help avoid chaos in our code.  We can add a new partial class to our project by right-clicking on the \ Models folder, selecting the "Add New Item" item.  Next, select the template ‚ÄúClass‚Äù and name it Dinner.cs. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ccb/9a3/f6d/ccb9a3f6d5fc9e5236dd436a4e1738a5.png"><br><br>  By clicking on the "Add" button, the Dinner.cs file is added to our project and opened in the IDE.  Next, we define the basic rules and validation framework using the following code: <br><blockquote> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">partial</font> <font color="#0000ff">class</font> Dinner { <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">bool</font> IsValid { <br> <br> <font color="#0000ff">get</font> { <font color="#0000ff">return</font> (GetRuleViolations().Count() == 0); } <br> <br> } <br> <br> <font color="#0000ff">public</font> <font color="#2B91AF">IEnumerable</font> &lt;RuleViolation&gt; GetRuleViolations() { <br> <br> <font color="#0000ff">yield</font> <font color="#0000ff">break</font> ; <br> <br> } <br> <br> <font color="#0000ff">partial</font> <font color="#0000ff">void</font> OnValidate(ChangeAction action) { <br> <br> <font color="#0000ff">if</font> (!IsValid) <br> <br> <font color="#0000ff">throw</font> <font color="#0000ff">new</font> ApplicationException( <font color="#A31515">"Rule violations prevent saving"</font> ); <br> <br> } <br> <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> RuleViolation { <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> ErrorMessage { <font color="#0000ff">get</font> ; <font color="#0000ff">private</font> <font color="#0000ff">set</font> ; } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> PropertyName { <font color="#0000ff">get</font> ; <font color="#0000ff">private</font> <font color="#0000ff">set</font> ; } <br> <br> <font color="#0000ff">public</font> RuleViolation( <font color="#0000ff">string</font> errorMessage, <font color="#0000ff">string</font> propertyName) { <br> <br> ErrorMessage = errorMessage; <br> <br> PropertyName = propertyName; <br> <br> } <br> <br> } <br></font></code> </blockquote><br>  A few notes on the code: <ul><li>  The Dinner class starts with the ‚Äúpartial‚Äù keyword - this means that the code placed in it will be combined with the class generated by the LINQ to SQL designer and compiled into a single class. </li><li>  The RuleViolation class is an auxiliary class that allows us to provide more details about rule violations. </li><li>  The Dinner.GetRuleViolations () method allows you to evaluate whether all the rules and business logic have been followed (we will implement it in just a couple of minutes).  It returns a sequence of RuleViolation objects that provide us with more detailed information about any violation of the rules. </li><li>  Dinner.IsValid is a handy auxiliary property that indicates whether RuleViolation is active or not.  The developer can check it through the Dinner object at any time (it will not cause any exceptions). </li></ul>  The Dinner.OnValidate () partial method is a hook provided by LINQ to SQL, which notifies us at any time that the Dinner object is ready to be stored in the database.  Our implementation of OnValidate () makes sure that Dinner does not contain any RuleViolation before saving.  If the state is not valid, then an exception is thrown, which interrupts the LINQ to SQL transaction. <br><br>  This approach provides a simple framework that integrates validation rules and business rules.  And now, let's add rules to our GetRuleViolations () method: <br><blockquote> <code><font color="black"><font color="#0000ff">public</font> <font color="#2B91AF">IEnumerable</font> &lt;RuleViolation&gt; GetRuleViolations() { <br> <br> <font color="#0000ff">if</font> ( <font color="#2B91AF">String</font> .IsNullOrEmpty(Title)) <br> <font color="#0000ff">yield</font> <font color="#0000ff">return</font> <font color="#0000ff">new</font> RuleViolation( <font color="#A31515">"Title required"</font> , <font color="#A31515">"Title"</font> ); <br> <br> <font color="#0000ff">if</font> ( <font color="#2B91AF">String</font> .IsNullOrEmpty(Description)) <br> <font color="#0000ff">yield</font> <font color="#0000ff">return</font> <font color="#0000ff">new</font> RuleViolation( <font color="#A31515">"Description required"</font> , <font color="#A31515">"Description"</font> ); <br> <br> <font color="#0000ff">if</font> ( <font color="#2B91AF">String</font> .IsNullOrEmpty(HostedBy)) <br> <font color="#0000ff">yield</font> <font color="#0000ff">return</font> <font color="#0000ff">new</font> RuleViolation( <font color="#A31515">"HostedBy required"</font> , <font color="#A31515">"HostedBy"</font> ); <br> <br> <font color="#0000ff">if</font> ( <font color="#2B91AF">String</font> .IsNullOrEmpty(Address)) <br> <font color="#0000ff">yield</font> <font color="#0000ff">return</font> <font color="#0000ff">new</font> RuleViolation( <font color="#A31515">"Address required"</font> , <font color="#A31515">"Address"</font> ); <br> <br> <font color="#0000ff">if</font> ( <font color="#2B91AF">String</font> .IsNullOrEmpty(Country)) <br> <font color="#0000ff">yield</font> <font color="#0000ff">return</font> <font color="#0000ff">new</font> RuleViolation( <font color="#A31515">"Country required"</font> , <font color="#A31515">"Country"</font> ); <br> <br> <font color="#0000ff">if</font> ( <font color="#2B91AF">String</font> .IsNullOrEmpty(ContactPhone)) <br> <font color="#0000ff">yield</font> <font color="#0000ff">return</font> <font color="#0000ff">new</font> RuleViolation( <font color="#A31515">"Phone# required"</font> , <font color="#A31515">"ContactPhone"</font> ); <br> <br> <font color="#0000ff">if</font> (!PhoneValidator.IsValidNumber(ContactPhone, Country)) <br> <font color="#0000ff">yield</font> <font color="#0000ff">return</font> <font color="#0000ff">new</font> RuleViolation( <font color="#A31515">"Phone# does not match country"</font> , <font color="#A31515">"ContactPhone"</font> ); <br> <br> <font color="#0000ff">yield</font> <font color="#0000ff">break</font> ; <br> } <br></font></code> </blockquote><br>  We use C # ‚Äúyield return‚Äù to return any RuleViolations sequence.  The first six rules check and prescribe that Dinner string properties cannot be null or empty.  The last rule is more interesting, it calls the auxiliary method PhoneValidator.IsValidNumber (), which we can add to our project to match the ContactPhone number format to the country where lunch is located. <br><br>  To check the phone number, we can also use regular expressions.  Below is a simple implementation of PhoneValidator, which allows you to check your phone via Regex: <br><blockquote> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> PhoneValidator { <br> <br> <font color="#0000ff">static</font> IDictionary&lt; <font color="#0000ff">string</font> , Regex&gt; countryRegex = <font color="#0000ff">new</font> Dictionary&lt; <font color="#0000ff">string</font> , Regex&gt;() { <br> { <font color="#A31515">"USA"</font> , <font color="#0000ff">new</font> Regex( <font color="#A31515">"^[2-9]\\d{2}-\\d{3}-\\d{4}$"</font> )}, <br> { <font color="#A31515">"UK"</font> , <font color="#0000ff">new</font> Regex( <font color="#A31515">"(^1300\\d{6}$)|(^1800|1900|1902\\d{6}$)|(^0[2|3|7|8]{1}[0-9]{8}$)|(^13\\d{4}$)|(^04\\d{2,3}\\d{6}$)"</font> )}, <br> { <font color="#A31515">"Netherlands"</font> , <font color="#0000ff">new</font> Regex( <font color="#A31515">"(^\\+[0-9]{2}|^\\+[0-9]{2}\\(0\\)|^\\(\\+[0-9]{2}\\)\\(0\\)|^00[0-9]{2}|^0)([0-9]{9}$|[0-9\\-\\s]{10}$)"</font> )}, <br> }; <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">bool</font> IsValidNumber( <font color="#0000ff">string</font> phoneNumber, <font color="#0000ff">string</font> country) { <br> <br> <font color="#0000ff">if</font> (country != <font color="#0000ff">null</font> &amp;&amp; countryRegex.ContainsKey(country)) <br> <font color="#0000ff">return</font> countryRegex[country].IsMatch(phoneNumber); <br> <font color="#0000ff">else</font> <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#2B91AF">IEnumerable</font> &lt; <font color="#0000ff">string</font> &gt; Countries { <br> <font color="#0000ff">get</font> { <br> <br> <font color="#0000ff">return</font> countryRegex.Keys; <br> } <br> } <br> } <br></font></code> </blockquote><br><h4>  Handling validation and business logic violations </h4><br>  By adding validation and business logic rules to the code, each time creating or changing a Dinner object, our validation rules will be enforced in the validation process. <br><br>  Developers can write code as shown below, determining in advance the valid Dinner object and getting a list of all violations without any exceptions: <br><blockquote> <code><font color="black">Dinner dinner = dinnerRepository.GetDinner(5); <br> <br> dinner.Country = <font color="#A31515">"USA"</font> ; <br> dinner.ContactPhone = <font color="#A31515">"425-555-BOGUS"</font> ; <br> <br> <font color="#0000ff">if</font> (!dinner.IsValid) { <br> <font color="#0000ff">var</font> errors = dinner.GetRuleViolations(); <br> <font color="#008000">//    </font> <br> } <br></font></code> </blockquote><br>  If we try to save Dinner with an invalid state, then after calling the Save () method, an exception is thrown in the DinnerRepository.  This will happen because LINQ to SQL will call our partial Dinner.OnValidate () method before the changes are saved, and earlier we added an exception to this method if there are violations of the rules in the Dinner object.  We can intercept this exception and instantly return the list of violations for correction: <br><blockquote> <code><font color="black">Dinner dinner = dinnerRepository.GetDinner(5); <br> <br> <font color="#0000ff">try</font> { <br> dinner.Country = <font color="#A31515">"USA"</font> ; <br> dinner.ContactPhone = <font color="#A31515">"425-555-BOGUS"</font> ; <br> dinnerRepository.Save(); <br> } <br> <font color="#0000ff">catch</font> { <br> <font color="#0000ff">var</font> errors = dinner.GetRuleViolations(); <br> <font color="#008000">//    </font> <br> } <br></font></code> </blockquote><br>  Our business rules and validation rules are implemented at the model level, and not at the level of the graphical interface, they will be applied and used under any circumstances in our application.  Later we can change or add any business rules and be sure that they will be unconditionally applied in every corner of the application. <br><br>  Having gained flexibility in managing business rules, eliminating the need to change their logic in the entire application where they are used, we achieved a properly written application.  All this thanks to the help of the MVC framework. <br><br><h3>  Next step </h3><br>  We have a model that can be used to get and change data in the database. <br><br>  Let's now add some controllers and views to the project. </div><p>Source: <a href="https://habr.com/ru/post/99107/">https://habr.com/ru/post/99107/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../99096/index.html">KC finally violated the rules of priority registration</a></li>
<li><a href="../99100/index.html">Bitcoin (‡∏ø): peer cryptocurrency</a></li>
<li><a href="../99101/index.html">Technical report launch eventr.com numbers</a></li>
<li><a href="../99104/index.html">Vulnerability Windows Help and Support Center (CVE-2010-1885) in numbers</a></li>
<li><a href="../99105/index.html">The long-awaited release of ActiveMesa R2P Lite</a></li>
<li><a href="../99108/index.html">Image resizing at 180 per second</a></li>
<li><a href="../99111/index.html">Scrum requirements assessment</a></li>
<li><a href="../99114/index.html">There is such an online service - leveling texts!</a></li>
<li><a href="../99115/index.html">We break deadlines</a></li>
<li><a href="../99116/index.html">eToro OpenBook: Twitter analog for traders</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>