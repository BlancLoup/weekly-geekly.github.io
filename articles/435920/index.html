<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Developer Cookbook: DDD Recipes (Part 4, Structures)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 


 So, we have already decided on the scope , methodology and architecture . Let's move from theory to practice, to writing code. I woul...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Developer Cookbook: DDD Recipes (Part 4, Structures)</h1><div class="post__text post__text-html js-mediator-article"><h1 id="vvedenie">  Introduction </h1><br><p>  So, we have already decided on <a href="https://habr.com/post/426663/">the scope</a> , <a href="https://habr.com/post/428209/">methodology</a> and <a href="https://habr.com/post/429750/">architecture</a> .  Let's move from theory to practice, to writing code.  I would like to start with design patterns that describe the business logic - <em>Service</em> and <em>Interactor</em> .  But before proceeding with them, <em>let's</em> examine the structural patterns - <em>ValueObject</em> and <em>Entity</em> .  We will develop in the language of <em>ruby</em> .  In future articles we will analyze all the patterns needed for development using <a href="https://habr.com/post/429750/">Variable architecture</a> .  All the developments that are annexes to this series of articles will be collected in a separate framework. </p><br><p><img src="https://habrastorage.org/webt/uc/iz/ea/ucizea6-xkpivfyv18q9fvds9wm.jpeg" alt="Blacjack &amp; hockers"></p><br><p>  And we have already picked up a suitable name - <strong>LunaPark</strong> . <br>  Current developments are <a href="https://github.com/am-team/luna_park">posted on Github</a> . <br>  Having examined all the templates, we will assemble one full-fledged microservice. </p><a name="habracut"></a><br><h1 id="tak-istoricheski-slozhilos">  So historically </h1><br><p>  There was a need to refactor a complex corporate application written in Ruby on Rails.  There was a ready-made team of ruby ‚Äã‚Äãdevelopers.  The Domain Driven Development methodology was fine for these tasks, but there was no ready-made solution in the language used.  Despite the fact that the choice of language was mainly due to our specialization, it turned out to be quite successful.  Among all the languages ‚Äã‚Äãthat are used for web-applications, ruby, in my opinion, is the most expressive.  And therefore it is more suitable for modeling real objects.  This is not just my opinion. </p><br><blockquote>  That is the java world.  Then you have the new comers like Ruby.  It is a very good language for DDD (although I have not heard of it).  Rails has been made a lot of excitement.  There is a great deal of freedom in the past.  It‚Äôs a little bit more than that.  It is a clear case for DDD.  (A few infrastructure pieces would probably have to be filled in.) <br><br>  Eric Evans 2006 </blockquote><p>  Unfortunately, over the past 13 years, nothing much has changed.  On the Internet, you can find attempts to adapt Rails for this, but they all look terrible.  The Rails framework is heavy, slow and inconsistent with the principles of SOLID.  Watching without tears how someone is trying to portray the implementation of the <em>Repository</em> pattern on the basis of <em>AstiveRecord is</em> very hard.  We decided to adopt some microframework and modify it to our needs.  We tried <a href="https://github.com/ruby-grape/grape">Grape</a> , the idea of ‚Äã‚Äãauto-documenting seemed good, but otherwise it was abandoned and we quickly abandoned the idea of ‚Äã‚Äãusing it.  And almost immediately began to use another solution - <a href="http://sinatrarb.com/">Sinatra</a> .  We still continue to use it for REST <em>Controllers</em> and <em>Endpoints</em> . </p><br><div class="spoiler">  <b class="spoiler_title">REST?</b> <div class="spoiler_text"><p>  If you developed web applications, you already have an idea about technology.  It has its pros and cons, a complete listing of which is beyond the scope of this article.  But for us, as developers of corporate applications, the main disadvantage is that REST (this is understandable even from the name) does not reflect the process, but its state.  And the advantage is its clarity - the technology is clear to both back-end developers and front-end developers. <br>  But then it may not focus on REST, but implement its http + json solution?  Even if you manage to develop your service API, then providing its description to third parties you will receive many questions.  Much more than if you provide the usual REST. <br>  We will consider using REST as a compromise solution.  We use JSON for brevity and <a href="https://jsonapi.org/">jsonapi</a> standard, so as not to waste developers time on holy wars about the format of requests. <br>  Later, when we analyze <em>Endpoint</em> , we will see that in order to get rid of rest, it is enough to rewrite just one class.  So REST should not bother at all if there are doubts about it. </p></div></div><br><p>  In the course of writing several microservices, we got some groundwork - a set of abstract classes.  Each such class can be written in half an hour, its code is easy to understand, if you know what this code is for. </p><br><p>  Here the main difficulties arose.  New employees who did not deal with DDD practitioners and clean architecture could not understand the code and its purpose.  If I saw this code for the first time before I read Evans, I would take it as legacy, over-engineering. </p><br><p>  To overcome this obstacle, it was decided to write documentation (guideline) describing the philosophy of the approaches used.  Sketches of this documentation seemed successful and it was decided to post them on Habr√©.  Abstract classes that were repeated from project to project were decided to be put into a separate gem. </p><br><h1 id="filosofiya">  Philosophy </h1><br><p><img src="https://habrastorage.org/webt/eg/zm/c8/egzmc89jktbwuobb67mh-stoijc.png" alt="legacy-way"><br>  If you recall some classic martial arts film, then there will be a tough guy who very cleverly draws a pole.  A pole is essentially a stick, a very primitive tool, one of the first to fall into a person‚Äôs arms.  But in the hands of the master, he becomes a formidable weapon. <br>  You can spend time creating a gun that doesn‚Äôt shoot you in the leg, or you can spend time learning how to use shooting techniques.  We have identified 4 basic principles: </p><br><ul><li>  You need to make complicated things simple. </li><li>  Knowledge is more important than technology.  Documentation is clearer to a person than a code; you should not replace one with another. </li><li>  Pragmatism is more important than dogmatism.  Standards should suggest the path, not the bounding box. </li><li>  Structurality in architecture, flexibility in the choice of solutions. </li></ul><br><p>  A similar philosophy can be traced such as ArchLinux - <a href="https://wiki.archlinux.org/index.php/The_Arch_Way_(%25D0%25A0%25D1%2583%25D1%2581%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9)">The Arch Way</a> .  On my Linux laptop for a long time I did not take root, sooner or later it broke and I constantly had to reinstall it.  This caused a number of problems, sometimes serious ones like breaking the deadline at work.  But after spending 2-3 days once on installing Arch, I figured out how my OS works.  After that, she began to work more stable, without failures.  My notes helped me install it on new PCs in a couple of hours.  And abundant documentation helped me solve new problems. </p><br><p>  The framework has an absolutely high-level character.  The classes that describe it are responsible for the structure of the application.  Third-party solutions are used to interact with databases, implement the http protocol and other low-level things.  We would like the programmer to peek into the code and understand how a particular class works, and the documentation would allow us to understand how to manage them.  Understanding the engine device will not allow you to drive a car. </p><br><h1 id="freymvork">  Framework </h1><br><p>  It is difficult to call LunaPark a framework in the usual sense.  Frame - frame, Work - work.  We urge not to limit ourselves to the framework.  The only frame that we declare is the one that prompts the class in which one or another logic should be described.  It is rather a set of tools with extensive instructions for them. <br>  Each class is abstract and has three levels: </p><br><pre><code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LunaPark</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#  module Forms #  class Single # / end end end</span></span></span></span></code> </pre> <br><p>  If you want to implement a form that creates one element, you inherit from this class: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Forms</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Create</span></span></span><span class="hljs-class"> &lt; LunaPark::Forms::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Single</span></span></span></span></code> </pre> <br><p>  If there are several elements, we will use another <em>Implementation</em> . </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Forms</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Create</span></span></span><span class="hljs-class"> &lt; LunaPark::Forms::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Multiple</span></span></span></span></code> </pre> <br><p>  At the moment, not all developments are given in perfect order and the gem is in the alpha version.  We will bring it in stages, in coordination with the publication of articles.  Those.  if you see an article about <code>ValueObject</code> and <code>Entity</code> , then these two templates have already been implemented.  By the end of the cycle, they will all be suitable for use on the project.  Since the framework itself is not very useful without a bundle with sinatra \ roda, a separate repository will be created, which will show how to ‚Äútie‚Äù everything for a quick start of your project. </p><br><p>  The framework is primarily a documentation supplement.  You should not take these articles as documentation for the framework. </p><br><p>  So let's get down to business. </p><br><h1 id="obekt-znachenie-value">  Object Value </h1><br><blockquote>  - How tall is your girlfriend? <br>  - 151 <br>  - You began to meet with the statue of liberty? </blockquote><p>  Something like this could happen in Indiana.  Human height is not just a number, but also a unit of measurement.  Object attributes are not always described by primitives only (Integer, String, Boolean, etc.), sometimes their combinations are required: </p><br><ul><li>  Money is not just a number, it is a number (amount) + currency. </li><li>  Date consists of day, month and year. </li><li>  To measure the weight we are not enough one number, it also requires a unit of measurement. </li><li>  Passport number consists of a series and, in fact, of the number. </li></ul><br><p>  On the other hand, this is not always a combination; perhaps this is some kind of primitive extension. <br>  The telephone number is often perceived as a number.  On the other hand, it is unlikely that he should have a method of addition or division.  Perhaps there is a method that will issue a country code and a method defining the city code.  Perhaps there will be some kind of decorative method that will present it not just with the string of numbers <code>79001231212</code> , but with the readable string: <code>7-900-123-12-12</code> . </p><br><div class="spoiler">  <b class="spoiler_title">maybe the decorator?</b> <div class="spoiler_text"><p>  If we proceed from dogma, then undoubtedly - yes.  If we approach this dilemma from the side of common sense, then when we decide to call this number, we will give the object itself to the telephone: </p><br><pre> <code class="ruby hljs">phone.call Values::PhoneNumber.new(<span class="hljs-number"><span class="hljs-number">79001231212</span></span>)</code> </pre> <br><p>  And if we decided to present it as a string, then this is clearly done for a person.  So why don't we make this line readable for a person right away? </p><br><pre> <code class="ruby hljs">Values::PhoneNumber.new(<span class="hljs-number"><span class="hljs-number">79001231212</span></span>).to_s</code> </pre> </div></div><br><p>  Imagine that we are creating an online casino website ‚ÄúThree Axes‚Äù and selling card games.  We need the class 'playing card'. </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Values</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayingCard</span></span></span><span class="hljs-class"> &lt; Lunapark::Values::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Compound</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_reader</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">suit</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rank</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  So, our class has two read-only attributes: </p><br><ul><li>  suit - card suit </li><li>  rank - card value </li></ul><br><p>  These attributes are set only when the map is created and cannot change when it is used.  Of course you can take a playing card and cross out <s>8</s> , write Q, but this is unacceptable.  In a decent society, you are likely to shoot.  The inability to change attributes after the creation of an object determines the first property of <em>the Value Object</em> - immunity. <br>  The second important property <em>of Value Object</em> is how we compare them. </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Values</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RSpec</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">describe</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayingCard</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">let</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">card</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">described_class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">suit</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clubs</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rank</span></span></span><span class="hljs-class">: 10 } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">let</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">described_class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">suit</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clubs</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rank</span></span></span><span class="hljs-class">: 10 } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">it</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">should</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">be</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">eql</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">expect</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">card</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">eq</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">other</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  This test will not pass, as they will be compared at.  In order for the test to pass, we must compare <em>Value-Obects</em> by value, for this we add the comparison method: </p><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">==</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> suit == other.suit &amp;&amp; rank == other.rank <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  Now our test will pass.  We can also add methods that are responsible for the comparison, but how do we compare 10 and K?  As you have probably guessed, we will also represent them in the form <em>of Value Objects</em> .  Ok, so now we will have to initiate the top ten of a club like this: </p><br><pre> <code class="ruby hljs">ten = Values::Rank.new(<span class="hljs-string"><span class="hljs-string">'10'</span></span>) clubs = Values::Suits.new(<span class="hljs-symbol"><span class="hljs-symbol">:clubs</span></span>) ten_clubs = Values::PlayingCards.new(<span class="hljs-symbol"><span class="hljs-symbol">rank:</span></span> ten, <span class="hljs-symbol"><span class="hljs-symbol">clubs:</span></span> clubs)</code> </pre> <br><p>  Three lines is quite a lot for ruby.  In order to circumvent this restriction, we introduce the third property of the <em>Object-Value</em> - turnover.  Let us have a special method of the class <code>.wrap</code> , which can take values ‚Äã‚Äãof various types and convert them to the desired one. </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayingCard</span></span></span><span class="hljs-class"> &lt; Lunapark::Values::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Compound</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">obj</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">obj</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is_a?</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#      PlayingCard obj #      case obj.is_a? Hash #    ,      new(obj) #    case obj.is_a String #    ,     new rank: obj[0..-2], suit:[-1] # ,  -  . else #       raise ArgumentError #  . end end def initialize(suit:, rank:) #     </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@suit</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = Suit.wrap(suit) #      </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@rank</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = Rank.wrap(rank) end end</span></span></span></span></code> </pre> <br><p>  This approach gives a great advantage: </p><br><pre> <code class="ruby hljs">ten = Values::Rank.new(<span class="hljs-string"><span class="hljs-string">'10'</span></span>) clubs = Values::Suits.new(<span class="hljs-symbol"><span class="hljs-symbol">:clubs</span></span>) from_values = Values::PlayingCard.wrap <span class="hljs-symbol"><span class="hljs-symbol">rank:</span></span> ten, <span class="hljs-symbol"><span class="hljs-symbol">suit:</span></span> clubs from_hash = Values::PlayingCard.wrap <span class="hljs-symbol"><span class="hljs-symbol">rank:</span></span> <span class="hljs-string"><span class="hljs-string">'10'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">suit:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:clubs</span></span> from_obj = Values::PlayingCard.wrap from_values from_str = Values::PlayingCard.wrap <span class="hljs-string"><span class="hljs-string">'10C'</span></span> <span class="hljs-comment"><span class="hljs-comment">#        utf ,  ,  .</span></span></code> </pre> <br><p>  All these cards will be equal to each other.  If the <code>wrap</code> method grows into good practice, it will be moved to a separate class.  From the point of view of a dogmatic approach, a separate class will also be mandatory. <br>  Hm, what about the place in the deck?  How to find out if this card is a trump card?  This is not a playing card.  This is the <em>value of the</em> playing card.  This is exactly the inscription 10, which you lead on the corner of cardboard. <br>  The <em>Value Object needs</em> to be treated the same way as a primitive, which for some reason was not implemented in ruby.  Hence the last property arises - <em>Object-Value is</em> not tied to any domain. </p><br><h2 id="rekomendacii">  Recommendations </h2><br><blockquote>  Among the variety of methods and tools used at each moment of each process, there is always one method and tool that works faster and better than others. <br><br>  <a href="https://ru.wikipedia.org/wiki/%25D0%25A4%25D1%2580%25D0%25B5%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B8%25D0%25BA_%25D0%25A2%25D0%25B5%25D0%25B9%25D0%25BB%25D0%25BE%25D1%2580">Frederick Taylor</a> 1914 </blockquote><br><h5 id="arifmeticheskie-operacii-dolzhny-vozvraschat-novyy-obekt">  Arithmetic operations must return a new object. </h5><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># GOOD class Money &lt; LunaPark::Values::Compound def +(other) other = self.class.wrap(other) raise ArgumentError unless same_currency? other self.class.new( amount: amount + other.amount, currency: currency ) end end</span></span></code> </pre> <br><h5 id="atributy-_obekta-znacheniya_-mogu-byt-tolko-primitivami-ili-drugimi-_obektami-znacheniya_">  <em>Object-Value</em> Attributes can only be primitives or other <em>Value Objects</em> </h5><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># GOOD class Weight &lt; LunaPark::Values::Compound def intialize(value:, unit:) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@value</span></span></span><span class="hljs-comment"> = value </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@unit</span></span></span><span class="hljs-comment"> = Unit.wrap(unit) end end # BAD class PlaingCard &lt; LunaPark::Value def initialize(rank:, suit:, deck:) ... </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@deck</span></span></span><span class="hljs-comment"> = Entity::Deck.wrap(deck) #    end end</span></span></code> </pre> <br><h5 id="prostye-operacii-derzhite-vnutri-metodov-klassa">  Keep simple operations inside class methods </h5><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># GOOD class Weight &lt; LunaPark::Values::Compound def &gt;(other) value &gt; other.convert_to(unit).value end end</span></span></code> </pre> <br><h5 id="esli-operaciya-konvertaciya-bolshaya-to-vozmozhno-est-smysl-vynesti-ee-v-otdelnyy-klass">  If the operation "conversion" is large, then it may be worthwhile to put it into a separate class. </h5><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># UGLY class Weight &lt; LunaPark::Values::Compound def convert_to(unit) unit = Unit.wrap(unit) case { self.unit.to_sym =&gt; unit.to_sym } when { :kg =&gt; :ft } Weight.new(value: 2.2046 * value, unit.to_sym) when # ... end end end # GOOD #./lib/values/weight/converter.rb class Weight class Converter &lt; LunaPark::Services::Simple def initialize(weight, to:) ... end end end #./lib/values/weight.rb class Weight &lt; LunaPark::Values::Compound def convert_to(unit) Converter.call! self, to: unit end end</span></span></code> </pre> <br><p>  Such a removal of logic into a separate <em>Service is</em> possible <strong>only</strong> if the <em>Service is</em> isolated: it does not use data from any external sources.  This service should be limited to the context of <em>the Value Object</em> itself. </p><br><h5 id="obekt-znachenie-ne-mozhet-nichego-znat-o-domennoy-logike">  Object value can not know anything about domain logic </h5><br><p>  Suppose we write an online store, and we have a rating of goods.  To get it, you need to make a request to the database via the <em>repository</em> . </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># DEADLY BAD class Rate &lt; LunaPark::Values::Single def top?(10) Repository::Rates.top(first: 10).include? self end end</span></span></code> </pre> <br><h1 id="suschnost-entity">  Entity </h1><br><p>  The <em>Essence</em> class is responsible for some real object.  It can be a contract, a chair, a real estate agent, a pie, an iron, a cat, a refrigerator ‚Äî anything.  Any object that you may need to model your business processes is the <em>Entity</em> . <br>  The concept of <em>Essence is</em> different in Evans and in Martin.  From the point of view of Evans, an entity is an object characterized by something that emphasizes its individuality. </p><br><div class="spoiler">  <b class="spoiler_title">Essence on Zvansu</b> <div class="spoiler_text"><blockquote>  If an object is determined by a unique individual existence, rather than a set of attributes, this property should be read most importantly when defining an object in a model.  The class definition should be simple and be built around the continuity and uniqueness of the object's life cycle.  Find a way to distinguish each object, regardless of its form or history.  Pay special attention to the technical requirements related to the comparison of objects by their attributes.  Set an operation that would necessarily give a unique result for each such object - perhaps, for this, you will have to associate a certain character with guaranteed uniqueness.  Such a means of identification may be of external origin, but it can also be an arbitrary identifier generated by the system for its own convenience.  However, such a tool must comply with the rules for distinguishing objects in a model.  The model should be given a precise definition of what is the same objects. </blockquote></div></div><br><p>  From the point of view of Martin, <em>Entity</em> is not an object, but a layer.  This layer will combine both the object and the business logic for its change. </p><br><div class="spoiler">  <b class="spoiler_title">Disenchantment from Martin</b> <div class="spoiler_text"><blockquote>  Application Independent Business rules.  They are not simply data objects.  They may hold references to data objects;  It can be used for many different applications. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Gateways return Entities.  This is where the implementation of the data is taken.  This can be done either with containment or inheritance. <br><br>  For example: <br><br>  public class MyEntity {private MyDataStructure data;} <br><br>  or <br><br>  public class MyEntity extends MyDataStructure {...} <br><br>  And remember, we are all pirates by nature;  and the rules. </blockquote></div></div><br><p>  We will mean only the structure under the <em>Essence</em> .  In its simplest form, the <em>Entity</em> class will look like this: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Entities</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MeatBag</span></span></span><span class="hljs-class"> &lt; LunaPark::Entities::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Simple</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_accessor</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hegiht</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">weight</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">birthday</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  A mutable object that describes the structure of a business model may contain primitive types and <em>Values</em> . <br>  The <code>LunaPark::Entites::Simple</code> class is incredibly simple, you can see its code, it gives us only one thing - easy initialization. </p><br><div class="spoiler">  <b class="spoiler_title">LunaPark :: Entites :: Simple</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LunaPark</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Entities</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Simple</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">set_attributes</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">params</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">set_attributes</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hash</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hash</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">each</span></span></span><span class="hljs-class"> { |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">k</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">send</span></span></span><span class="hljs-class">(:"</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{k}=", v) } end end end end</span></span></span></span></code> </pre> </div></div><br><p>  You can write: </p><br><pre> <code class="ruby hljs">john_doe = Entity::MeatBag.new( <span class="hljs-symbol"><span class="hljs-symbol">id:</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">name:</span></span> <span class="hljs-string"><span class="hljs-string">'John Doe'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">height:</span></span> <span class="hljs-string"><span class="hljs-string">'180cm'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">weight:</span></span> <span class="hljs-string"><span class="hljs-string">'80kg'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">birthday:</span></span> <span class="hljs-string"><span class="hljs-string">'01-01-1970'</span></span> )</code> </pre> <br><p>  As you may have guessed, we want to wrap the weight, height and date of birth in <em>Objects-values</em> . </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Entities</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MeatBag</span></span></span><span class="hljs-class"> &lt; LunaPark::Entites::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Simple</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_accessor</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_reader</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">heiht</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wight</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">birthday</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Values::Height</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">weight</span></span></span><span class="hljs-class">=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">height</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Values::Weight</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">weight</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">birthday</span></span></span><span class="hljs-class">=(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">day</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">birthday</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Date</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parse</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">day</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  In order not to waste time on such constructors, we have prepared a more complex <em>Implementation of</em> <a href=""><code>LunaPark::Entites::Nested</code></a> : </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Entities</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MeatBag</span></span></span><span class="hljs-class"> &lt; LunaPark::Entities::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Nested</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">heiht</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Values::Height</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">weight</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Values::Weight</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">birthday</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Values::Date</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parse</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  As the name suggests, this <em>implementation</em> allows you to make tree structures. </p><br><p>  Let's satisfy my passion for large-sized household appliances.  In the last article, we made an analogy between the <a href="https://habr.com/post/429750">"twist" of a washing machine and architecture</a> .  And now we describe such an important business object as a refrigerator: </p><br><p><img src="https://habrastorage.org/webt/xl/65/pj/xl65pjsr5ou5a4nurhdm9qxbo50.png" alt="Refregerator"></p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Refregerator</span></span></span><span class="hljs-class"> &lt; LunaPark::Entites::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Nested</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">brand</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">title</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">namespace</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fridge</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">namespace</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">door</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">upper</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Shelf</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lower</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Shelf</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">upper</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Shelf</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lower</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Shelf</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">namespace</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">main</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">namespace</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">door</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">first</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Shelf</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">second</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Shelf</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">third</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Shelf</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">namespace</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">boxes</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">left</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Box</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">right</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Box</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">first</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Shelf</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">second</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Shelf</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">third</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Shelf</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fourth</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Shelf</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">last_open_at</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">comparable</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  Such an approach saves us from creating unnecessary <em>Entities</em> such as the door from the refrigerator.  Without a refrigerator, it should be part of the refrigerator.  This approach is convenient for compiling relatively large documents, such as an application for the purchase of insurance. </p><br><p>  The <code>LunaPark::Entites::Nested</code> class has 2 more important properties: </p><br><p>  Comparability: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Entites</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> &lt; LunaPark::Entites::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Nested</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">email</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">registred_at</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">u1</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Entites::User</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">email</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">john</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">doe</span></span></span><span class="hljs-class">@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mail</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">registred_at</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Time</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">now</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">u2</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Entites::User</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">email</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">john</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">doe</span></span></span><span class="hljs-class">@</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mail</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">', </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">registred_at</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Time</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">now</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">u1</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">u2</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># =&gt; false</span></span></span></span></code> </pre> <br><p>  These two users are not equivalent, since  they were created at different times and therefore the value of the <code>registred_at</code> attribute will be different.  But if we delete the attribute from the list of compared: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Entites</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> &lt; LunaPark::Entites::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Nested</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">email</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">registred_at</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">comparable</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">false</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  then we get two comparable objects. </p><br><p>  This <em>implementation</em> also has the property of turnover - we can use the class method `wrap </p><br><pre> <code class="ruby hljs">Entites::User.wrap(<span class="hljs-symbol"><span class="hljs-symbol">email:</span></span> <span class="hljs-string"><span class="hljs-string">'john.doe@mail.com'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">registred_at:</span></span> Time.now)</code> </pre> <br><p>  You can use Hash, OpenStruct, or any gem you like to help you realize the structure of your entity. </p><br><p>  <em>Entity</em> is a business object model, keep it simple.  If a property is not used by your business, do not describe it. </p><br><h1 id="izmeneniya-suschnosti">  Entity changes </h1><br><p>  As you noticed, the <em>Essence</em> class does not have any methods of its own change.  All changes are made from the outside.  <em>The value object is</em> also immutable.  All those functions that are present in it, by and large decorate the essence or create new objects.  The essence itself remains unchanged.  For the developer of Ruby on Rails, this approach will be unusual.  From the outside it may seem that we generally use OOP-language for something else.  But if you look deeper, it is not.  Can a window open by itself?  Car get to work, hotel booked, cute cat get a new subscriber?  These are all external influences.  Something happens in the real world, and we reflect it in ourselves.  For each request, we make changes to our model.  And thus we keep it up to date, sufficient for our business tasks.  It is necessary to separate the state of the model and the processes causing changes in this state.  How to do this, we will look at the next article. </p></div><p>Source: <a href="https://habr.com/ru/post/435920/">https://habr.com/ru/post/435920/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../435908/index.html">Ascetic web: prototype flea market on go and js</a></li>
<li><a href="../435910/index.html">Why did BSD lose in the battle with GNU / Linux?</a></li>
<li><a href="../435912/index.html">The main problems of the development of modern interfaces</a></li>
<li><a href="../435914/index.html">Pack ASP.NET Core Applications with Docker</a></li>
<li><a href="../435916/index.html">Hacking VC, two-factor authentication will not save</a></li>
<li><a href="../435922/index.html">Java, Spring, Kurento and media services. Part 2</a></li>
<li><a href="../435924/index.html">The neural network generates images of dishes according to their recipes.</a></li>
<li><a href="../435926/index.html">The neural network brings together pieces of archaeological finds</a></li>
<li><a href="../435928/index.html">Refrigerator instead of Bruce Willis: Earth hits first</a></li>
<li><a href="../435930/index.html">The origin of thermoacoustics. Singing flame of Higgins. Riyke tube</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>