<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We set up a private Docker repository</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Docker is one of the hottest topics in development. Most of the new projects are built on Docker. At a minimum, it has proven itself for software dist...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We set up a private Docker repository</h1><div class="post__text post__text-html js-mediator-article"><p><img align="left" height="200" width="200" src="https://habrastorage.org/files/440/b2c/9f2/440b2c9f23c54cf289bfccf19da32e36.png">  Docker is one of the hottest topics in development.  Most of the new projects are built on Docker.  At a minimum, it has proven itself for software distribution, for example, our <a href="https://github.com/RD17/ambar">Ambar</a> document search system is installed using <code>docker-compose</code> . </p><br><p>  At the beginning of work on Ambar, we used a public docker repository, but with the growth of the project and the emergence of the enterprise version, we thought about creating our own private repository.  In this article, we will share our experience in deploying a self-hosted repository: we will describe the whole process step by step, try to bypass all the pitfalls. </p><a name="habracut"></a><br><h2 id="lokalnyy-docker-repozitoriy">  Local docker repository </h2><br><p>  So, the simplest Docker repository can be raised with a single command. </p><br><pre> <code class="hljs pgsql">docker run -d -p <span class="hljs-number"><span class="hljs-number">5000</span></span>:<span class="hljs-number"><span class="hljs-number">5000</span></span> <span class="hljs-comment"><span class="hljs-comment">--restart=always --name registry registry:2</span></span></code> </pre> <br><p>  To check the repository, fill in the image of ubuntu. </p><br><ol><li>  First, download the image from the official repository and add the <code>localhost:5000/ubuntu</code> tag to it. </li><li>  Launch the image in our new repository: <code>docker push localhost:5000/ubuntu</code> . </li></ol><br><p>  Well, now we can work with a local docker repository.  In order not to remember the repository launch command every time, let's create a <code>docker-compose.yml</code> file: </p><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">registry:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">restart:</span></span> always <span class="hljs-symbol"><span class="hljs-symbol">image:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">registry:</span></span><span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-symbol"><span class="hljs-symbol">ports:</span></span> - <span class="hljs-number"><span class="hljs-number">5000</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">5000</span></span> <span class="hljs-symbol"><span class="hljs-symbol">volumes:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/path/data</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/var/lib/registry</span></span> /*         *<span class="hljs-regexp"><span class="hljs-regexp">/</span></span></code> </pre> <br><p>  To start the repository, simply enter the command <code>docker-compose up -d</code> in the directory with the <code>docker-compose</code> file.  With a local repository figured out, move on to configuring SSL. </p><br><h2 id="nastroyka-ssl">  SSL setup </h2><br><p>  Why do I need SSL?  The Docker repository that is accessible from the Internet should work only through a secure https connection.  It is possible to circumvent this limitation, use self-signed certificates, but as practice shows it works once and easier to configure everything correctly once, good for those who do not have an SSL certificate, I will tell you how to use <a href="https://letsencrypt.org/getting-started/">Letsencrypt</a> .  It is worth mentioning that SSL is a prerequisite for authentication in the repository. </p><br><p>  If you have an SSL certificate - specify the path to it in the docker-compose file, see the listing below. </p><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">registry:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">restart:</span></span> always <span class="hljs-symbol"><span class="hljs-symbol">image:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">registry:</span></span><span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-symbol"><span class="hljs-symbol">ports:</span></span> - <span class="hljs-number"><span class="hljs-number">5000</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">5000</span></span> <span class="hljs-symbol"><span class="hljs-symbol">environment:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">REGISTRY_HTTP_TLS_CERTIFICATE:</span></span> /certs/domain.crt <span class="hljs-symbol"><span class="hljs-symbol">REGISTRY_HTTP_TLS_KEY:</span></span> /certs/domain.key <span class="hljs-symbol"><span class="hljs-symbol">volumes:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/path/data</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/var/lib/registry</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/path/certs</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/certs</span></span> /*   c  *<span class="hljs-regexp"><span class="hljs-regexp">/</span></span></code> </pre> <br><p>  If there is no SSL certificate, the best way to use Letsencrypt.  In the latest docker versions, it works out of the box without first creating certificates, although I haven‚Äôt found a working example anywhere, so I‚Äôll give it here. </p><br><pre> <code class="hljs sql">registry: restart: always image: registry:2 ports: - 443:5000 <span class="hljs-comment"><span class="hljs-comment">/*      443,  letsencrypt    */</span></span> environment: REGISTRY_HTTP_TLS_LETSENCRYPT_CACHEFILE: /cache.letsencrypt <span class="hljs-comment"><span class="hljs-comment">/*       letsencrypt*/</span></span> REGISTRY_HTTP_TLS_LETSENCRYPT_EMAIL: hello@rdseventeen.com <span class="hljs-comment"><span class="hljs-comment">/* email,         letsencrypt */</span></span> volumes: - /<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>:/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/registry</code> </pre> <br><p>  It is worth paying attention to the fact that for the correct operation of Letsencrypt it is necessary to change the port from 5000 to 443. The location of the Letsencrypt cache can be anything. <br>  To test our repository, run the following commands: </p><br><pre> <code class="hljs perl">docker pull ubuntu docker tag ubuntu myregistrydomain.com:<span class="hljs-number"><span class="hljs-number">443</span></span>/ubuntu docker <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> myregistrydomain.com:<span class="hljs-number"><span class="hljs-number">443</span></span>/ubuntu docker pull myregistrydomain.com:<span class="hljs-number"><span class="hljs-number">443</span></span>/ubuntu</code> </pre> <br><h2 id="nastraivaem-autentifikaciyu">  Configuring Authentication </h2><br><p>  Protect our repository with a password.  To do this, create a file with passwords and specify its docker repository.  The following command will create a user <code>testuser</code> with the password <code>testpassword</code> , put them in a file and save it in path / auth / htpasswd. </p><br><pre> <code class="hljs pgsql"> docker run <span class="hljs-comment"><span class="hljs-comment">--entrypoint htpasswd registry:2 -Bbn testuser testpassword &gt; path/auth/htpasswd</span></span></code> </pre> <br><p>  In docker-compose, specify the path to the file with passwords and use basic authentication. </p><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">registry:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">restart:</span></span> always <span class="hljs-symbol"><span class="hljs-symbol">image:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">registry:</span></span><span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-symbol"><span class="hljs-symbol">ports:</span></span> - <span class="hljs-number"><span class="hljs-number">443</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">5000</span></span> <span class="hljs-symbol"><span class="hljs-symbol">environment:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">REGISTRY_HTTP_TLS_LETSENCRYPT_CACHEFILE:</span></span> /cache.letsencrypt <span class="hljs-symbol"><span class="hljs-symbol">REGISTRY_HTTP_TLS_LETSENCRYPT_EMAIL:</span></span> hello@rdseventeen.com <span class="hljs-symbol"><span class="hljs-symbol">REGISTRY_AUTH:</span></span> htpasswd <span class="hljs-symbol"><span class="hljs-symbol">REGISTRY_AUTH_HTPASSWD_PATH:</span></span> /auth/htpasswd <span class="hljs-symbol"><span class="hljs-symbol">REGISTRY_AUTH_HTPASSWD_REALM:</span></span> Registry Realm <span class="hljs-symbol"><span class="hljs-symbol">volumes:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/path/data</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/var/lib/registry</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/path/auth</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/auth</span></span></code> </pre> <br><p>  In order for the changes to take effect, you must restart the docker repository.  Use the <code>docker-compose restart</code> .  Login to the created repository using the <code>docker login myregistrydomain.com:443</code> .  After that, our repository will be available for downloading images stored in it. </p><br><h2 id="itog">  Total </h2><br><p>  In the article we looked at the creation of a private docker repository.  For a deep study of the topic I recommend to familiarize yourself with the <a href="https://docs.docker.com/registry/deploying/">official manual</a> and the <a href="https://docs.docker.com/registry/configuration/">list of repository settings</a> . </p><br><p>  Thanks for attention! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/320884/">https://habr.com/ru/post/320884/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320872/index.html">Docker implementation for a small project in Production, part 3</a></li>
<li><a href="../320874/index.html">Visualization of data in the browser using D3.js</a></li>
<li><a href="../320878/index.html">Master-master replication and scaling of applications between all IoT devices and the cloud</a></li>
<li><a href="../320880/index.html">VPS hosting and cloud hosting: what to choose and what is the difference?</a></li>
<li><a href="../320882/index.html">Off splinters from the brain. 15 stereotypes about CRM-systems</a></li>
<li><a href="../320886/index.html">FlexPod - from theory to practice: the word to engineers (webinar)</a></li>
<li><a href="../320888/index.html">Cloudless mobile app - life without Google Play</a></li>
<li><a href="../320890/index.html">NooLite: kill two birds of ergonomics at the same time (installation, opinion, development)</a></li>
<li><a href="../320892/index.html">Testing untestable JS with Babel and snarejs</a></li>
<li><a href="../320894/index.html">Experience using Samsung Pay</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>