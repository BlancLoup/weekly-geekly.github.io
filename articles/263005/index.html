<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How can Python and Jinja make life easier for a FPGA developer?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 It so happens that the programming languages ‚Äã‚Äãused impose a restriction on what we want to do, delivering an inconvenience during developme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How can Python and Jinja make life easier for a FPGA developer?</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  It so happens that the programming languages ‚Äã‚Äãused impose a restriction on what we want to do, delivering an inconvenience during development.  What do the developers do about it?  Either they reconcile or somehow try to get out of the situation. <br><br>  One option is to use code autogeneration. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article I will tell: <br><ul><li>  how to get around one of the limitations of the Verilog language used in the development of ASIC / FPGA, using code auto-generation using <b>Python</b> and the <b>Jinja</b> library. </li><li>  how to accelerate the development of IP-cores by generating a module of control status registers from their description. </li></ul><br><br>  If interested, welcome under the cat! <br><a name="habracut"></a><br><br><h3>  Parameterization of modules </h3><br>  We presume that you are developing in the <b>Verilog-2001</b> language and you need to make a simple multiplexer: <br><br><pre><code class="vhdl hljs">module simple_mux #( <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> D_WIDTH = <span class="hljs-number"><span class="hljs-number">8</span></span> ) ( input [D_WIDTH-<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] data_0_i, input [D_WIDTH-<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] data_1_i, input sel_i, output [D_WIDTH-<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] data_o ); assign data_o = ( sel_i ) ? ( data_1_i ): ( data_0_i ); endmodule</code> </pre> <br><br>  Nothing complicated here. <br><br>  However, if you develop any switch for 24/48 ports, then at some point you will need a module where packet switching will occur (this will require multiport multiplexers). <br><br>  To do manually: <br><pre> <code class="vhdl hljs">input [D_WIDTH-<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] data_0_i, input [D_WIDTH-<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] data_1_i, ... input [D_WIDTH-<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] data_47_i,</code> </pre><br><br>  not very correct.  In real life, a multiplexer needs not just data, but specialized interfaces, where there will be not only one signal, but several for each of the data streams (read ports). <br><br>  The soul asks to write something like this: <br><br><pre> <code class="vhdl hljs">module simple_mux #( <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> D_WIDTH = <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> PORT_CNT = <span class="hljs-number"><span class="hljs-number">48</span></span>, // internal param <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> SEL_WIDTH = $clog2( PORT_CNT ) ) ( input [D_WIDTH-<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] data_i [PORT_CNT-<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>], input [SEL_WIDTH-<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] sel_i, output [D_WIDTH-<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] data_o ); assign data_o = data_i[ sel_i ]; endmodule</code> </pre><br><br>  However, the use of arrays in the ports of the module is <b>not permitted by</b> the IEEE 1364-2001 standard (where Verilog-2001 is described). <br><br>  For example, <b>Quartus</b> will give the following error: <br> <code>Error (10773): Verilog HDL error: declaring module ports or function arguments with unpacked array types requires SystemVerilog extensions <br></code> <br><br>  What to do? <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">  Use SystemVerilog. <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">  :) <br></div></div><br></div></div><br><br>  One possible workaround is discussed on <a href="http://stackoverflow.com/questions/16369698/how-to-pass-array-structure-between-two-verilog-modules">StackOverflow</a> .  The idea is working, but the article is not about that :) <br><br>  Of course, you can give up and make the necessary wires with handles, but it's better that the machine does it for us: <br>  use the <b>Template</b> class from the <b>Jinja2</b> template engine <br><br><pre> <code class="python hljs"> t = Template(<span class="hljs-string"><span class="hljs-string">u""" module {{name}} #( parameter D_WIDTH = 8 ) ( {%- for p in ports %} input [D_WIDTH-1:0] data_{{p}}_i, {%- endfor %} input [{{sel_width-1}}:0] sel_i, output [D_WIDTH-1:0] data_o ); always @(*) begin case( sel_i ) {% for p in ports %} {{sel_width}}'d{{p}}: begin data_o = data_{{p}}_i; end {% endfor %} endcase end endmodule """</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> t.render( n = <span class="hljs-number"><span class="hljs-number">4</span></span>, sel_width = <span class="hljs-number"><span class="hljs-number">2</span></span>, name = <span class="hljs-string"><span class="hljs-string">"simple_mux_4habr"</span></span>, ports = range( <span class="hljs-number"><span class="hljs-number">4</span></span> ) )</code> </pre><br><br>  We made a module template, where using <b>for</b> described what we need to duplicate, and then pulled the <b>render</b> , passing the necessary parameters (number of ports, module name, etc.).  These parameters using <b>{{}}</b> can be used in the template, ensuring the insertion of variables in the required place. <br><br>  The output is such a wonderful module: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="vhdl hljs">module simple_mux_4habr #( <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> D_WIDTH = <span class="hljs-number"><span class="hljs-number">8</span></span> ) ( input [D_WIDTH-<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] data_0_i, input [D_WIDTH-<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] data_1_i, input [D_WIDTH-<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] data_2_i, input [D_WIDTH-<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] data_3_i, input [<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] sel_i, output [D_WIDTH-<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] data_o ); always @(*) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span>( sel_i ) <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-symbol"><span class="hljs-symbol">'d0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> data_o = data_0_i; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-symbol"><span class="hljs-symbol">'d1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> data_o = data_1_i; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-symbol"><span class="hljs-symbol">'d2</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> data_o = data_2_i; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-symbol"><span class="hljs-symbol">'d3</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> data_o = data_3_i; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> endcase <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> endmodule</code> </pre><br></div></div><br><br>  The beauty lies in the fact that as variables you can pass not just numbers or strings, but also Python types (sheets, dictionaries, objects of your classes), and then apply in the template in the same way as in Python code.  For example, a reference to the dictionary element would look like this: <br><pre> <code class="python hljs">{{ foo[<span class="hljs-string"><span class="hljs-string">'bar'</span></span>] }}</code> </pre><br><br>  Of course, this is a simple example, and, most likely, it could be done using perl / sed / awk, etc. <br><br>  When I read about Jinja and played with a simple example, I wondered if it could be used for more serious things.  I remembered one task that arises in FPGA development, which seems to be well automated.  In order to smoothly lead you to this task, I will tell you a little about what the development is. <br><br><h3>  IP cores </h3><br>  It is believed that the basis of rapid development for ASIC / FPGA is the use of ready-made code, designed as IP-core.  Without going into details, we can assume that the IP core is a library. <br><br>  The idea is that the entire firmware is broken down into IP cores that are written by themselves or bought, <s>stolen</s> / <s>hacked</s> , and then connected using standard interfaces (such as AXI or Avalon).  Connection can occur both with pens and with the help of GUI applications, where you can click and connect the necessary cores with a mouse.  For example, <b>Qsys</b> , which comes as part of <b>Quartus</b> . <br><br>  The advantages of this approach are obvious: <br><ul><li>  ready code reuse </li><li>  separate core testing </li><li>  standardization of data exchange between modules </li></ul><br><br>  One of the downsides is that there is an overhead on the connection through standard interfaces: this can take up more code or more resources (cells). <br><br>  Each core has a set of control status registers <b>CSR</b> . <br><br>  Most often they are grouped by words (for example, 32-bit ones), where they are internally divided into fields that may have different modes of operation: <br><ul><li>  <b>RW</b> - read and write: you can write and read.  They are used to configure the kernel (for example, the inclusion of a particular mode of operation, the setting of some parameters, etc.). </li><li>  <b>RW / SC</b> - read write self clear: if you write a unit, it will reset itself to zero (it may be convenient for resetting the kernel or kernel module: you put the unit, and it will reset itself to zero). </li><li>  <b>RO</b> - read only: read only (for example, for statistics or for kernel status).  Also, some registers are made RO for storing constant values ‚Äã‚Äã(for example, the kernel version, or its capabilities). </li><li>  <b>RO / LL</b> and <b>RO / LH</b> - read only latch low / latch high: another tricky register - can be used to track accidents, for example, an overflow occurred (the <b>full</b> signal became equal to one), if you simply put it on the RO register, then The CPU that reads these registers can skip this event, since  this can happen just a few bars.  But if you make an LH, then as soon as the unit becomes there, it will snap and wait for the next reading.  If this register has been read, the register values ‚Äã‚Äãwill automatically be reset to zero. </li></ul><br><br>  Within one register there may be several fields, and their modes of operation may be different. <br><br>  CSR also has different chips, ranging from simple I2C expanders, ending with transceivers, and even network cards. <br><br>  How does it look from the top level programmers? <br>  Consider the Triplete <b>Ethernet</b> MAC controller from Altera.  If we open the <a href="https://www.altera.com/en_US/pdfs/literature/ug/ug_ethernet.pdf">documentation</a> and move on to the chapter <b>Configuration Register Space</b> , we will see lists of all registers through which you can both manage the kernel and receive information about its state (for example, counters of received / sent packets). <br><br>  I will give the part of the table where the registers are described: <br><img src="https://habrastorage.org/getpro/habr/post_images/912/ee5/32a/912ee532add3b0e78546d28ffc62f716.png" alt="image"><br><br>  By the way, it is possible that the packages through which you read these lines passed through this IP core. <br><br>  For example, the registers 0x03 and 0x04 in this core are responsible for setting the MAC address.  For any kernel (from Xilinx or from Intel) it may be other registers. <br><br>  Here is the change of the MAC address in the <a href="">driver</a> : <br><br><pre> <code class="hljs rust"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> void tse_update_mac_addr(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">altera_tse_private</span></span></span></span> *<span class="hljs-keyword"><span class="hljs-keyword">priv</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">u8</span></span> *addr) { <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span> msb; <span class="hljs-built_in"><span class="hljs-built_in">u32</span></span> lsb; msb = (addr[<span class="hljs-number"><span class="hljs-number">3</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">24</span></span>) | (addr[<span class="hljs-number"><span class="hljs-number">2</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">16</span></span>) | (addr[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | addr[<span class="hljs-number"><span class="hljs-number">0</span></span>]; lsb = ((addr[<span class="hljs-number"><span class="hljs-number">5</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | addr[<span class="hljs-number"><span class="hljs-number">4</span></span>]) &amp; <span class="hljs-number"><span class="hljs-number">0xffff</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Set primary MAC address */</span></span> csrwr32(msb, <span class="hljs-keyword"><span class="hljs-keyword">priv</span></span>-&gt;mac_dev, tse_csroffs(mac_addr_0)); csrwr32(lsb, <span class="hljs-keyword"><span class="hljs-keyword">priv</span></span>-&gt;mac_dev, tse_csroffs(mac_addr_1)); }</code> </pre><br><br>  <b>mac_addr_0</b> and <b>mac_addr_1</b> are just our 0x03 and 0x04, which are very tricky (in my subjective opinion, although I admit that this is normal in the drivers) are defined in the next <a href="">header file</a> . <br><br>  The developers of the IP core provide a document where all the CSRs are described, as well as what, how and in what order it is necessary to configure.  This documentation is passed to high-level programmers, they in turn write functions similar to <b>tse_update_mac_addr</b> and make it all work :) <br><br><h3>  Multiple-core systems </h3><br>  Often, the task cannot be solved with one core - there are several of them in the system. <br>  The control interfaces can be hung on one bus by allocating to each of the cores its own address space: <br><ul><li>  IP core A: 0x0000 - 0x00FF </li><li>  IP Core B: 0x0100 - 0x01FF </li><li>  IP Core C: 0x0200 - 0x02FF </li></ul><br>  If the top level needs to write the register of core B to 0x03, then it must conduct the transaction at address 0x0103.  (For simplicity, we assume that addresses are not byte, but by words. In real life, it may turn out to be written by byte addresses, and then our request for a 32-bit register will be a transaction at 0x010C). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6b6/fad/a2b/6b6fada2b2cea0613ff13e4c42c6c843.png" alt="image"><br><br>  A master (it can be a CPU (ARM / x86) or an MCU, or some other IP core in general) performs a read or write transaction through the management interface.  Very often, IP core management interfaces are made according to one of the standards (AXI or Avalon). <br><br>  If there are several slaves, then an interconnect module arises (multiplexer or bus arbiter).  His task is to accept requests from the master and look where it is necessary to transfer this request, he can also hold the bus while the slave is responding, etc.  So, before this module, the request address was 0x0103, and after that - 0x0003, since  The IP core does not know (and should not) what address space is assigned to it. <br><br><h3>  Parse a specific IP core (denote the problem) </h3><br>  Inside the IP core there must be a module that contains all these registers and converts them into a set of signals to control the modules that are inside the IP core but hidden from the outside world. <br><br>  In order not to speak on the fingers, consider a very simple abstract IP-core generator of Ethernet packets, which can be used, for example, in the <a href="http://metrotek.spb.ru/b100.html">measuring</a> <a href="http://metrotek.spb.ru/b3etx.html">equipment</a> . <br><br>  Let this kernel have such registers: <br><pre> <code class="hljs css">0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x0</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[7:0]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IP_CORE_VERSION</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[RO]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">IP-</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[15:8]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Reserved</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[16]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">GEN_EN</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[RW]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>   <span class="hljs-selector-attr"><span class="hljs-selector-attr">[17]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">GEN_ERROR</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ROLH]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>     <span class="hljs-selector-attr"><span class="hljs-selector-attr">[30:18]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Reserved</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[31]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">GEN_RESET</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[RWSC]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>   0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[31:0]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IP_DST</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[RW]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IP-</span></span>   0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x2</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[15:0]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">FRM_SIZE</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[RW]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>   <span class="hljs-selector-attr"><span class="hljs-selector-attr">[31:16]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Reserved</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x3</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[31:0]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">FRM_CNT</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[RO]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>   </code> </pre><br><br>  The IP core itself will look something like this: <br><img src="https://habrastorage.org/files/751/7ce/811/7517ce8116cc45cc8957a56967210e7b.png" alt="image"><br><br>  The <b>csr_map</b> module serves to ‚Äútranslate‚Äù the standard interface into a set of control signals for the <b>traffic_generator</b> module, which performs the core function of the kernel.  Of course, rarely an IP core consists of only two modules: most likely, control signals will be distributed to several modules inside the IP core. <br><br>  I hope you guessed what I'm getting at: <br>  <i>Is it <b>possible to</b> generate this <b>csr_map</b> automatically from some description of these registers</i> ? <br><br>  In real life, registers can be under a hundred, and if it is automated, then: <br><ul><li>  You can avoid mistakes and uninteresting work. </li><li>  if they pay for lines of code, then get a bonus from the manual (the auto-burnt code often takes many lines). </li><li>  save time spent on reading a habr (well, or giktams, because the hub FPGA moved there&gt; _ &lt;) or playing kicker. </li></ul><br><br><h3>  Solve the problem </h3><br>  We make two primitive classes for storing information on registers and on bits (fields). <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reg</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">( )</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( self, num, name )</span></span></span><span class="hljs-function">:</span></span> self.num = <span class="hljs-string"><span class="hljs-string">'{:X}'</span></span>.format( num ) self.name = name self.name_lowcase = self.name.lower() self.bits = [] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_bits</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( self, reg_bits )</span></span></span><span class="hljs-function">:</span></span> self.bits.append( reg_bits ) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegBits</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">( )</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( self, bit_msb, bit_lsb, name, mode = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"RW"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, init_value = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span><span class="hljs-function">:</span></span> self.bit_msb = bit_msb self.bit_lsb = bit_lsb self.width = bit_msb - bit_lsb + <span class="hljs-number"><span class="hljs-number">1</span></span> self.name = name self.name_lowcase = self.name.lower() self.mode = mode self.init_value = <span class="hljs-string"><span class="hljs-string">'{:X}'</span></span>.format( init_value ) <span class="hljs-comment"><span class="hljs-comment"># bit modes: # RO - read only # RO_CONST - read only, constant value # RO_LH - read only, latch high # RO_LL - read only, latch low # RW - read and write # RW_SC - read and write, self clear assert self.mode in ["RO", "RO_CONST", "RO_LH", "RO_LL", "RW", "RW_SC" ], "Unknown bit mode" if self.mode in ["RO_LH", "RO_LL", "RW_SC"]: assert self.width == 1, "Wrong width for this bit mod" self.port_signal_input = self.mode in ["RO", "RO_LH", "RO_LL"] self.port_signal_output = self.mode in ["RW", "RW_SC"] self.need_port_signal = self.port_signal_input or self.port_signal_output</span></span></code> </pre><br><br>  Using these classes, create a CSR description: <br><pre> <code class="python hljs"> MODULE_NAME = <span class="hljs-string"><span class="hljs-string">"trafgen_map_4habr"</span></span> r0 = Reg( <span class="hljs-number"><span class="hljs-number">0x0</span></span>, <span class="hljs-string"><span class="hljs-string">"MAIN"</span></span>) r0.add_bits( RegBits( <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"IP_CORE_VERSION"</span></span>, <span class="hljs-string"><span class="hljs-string">"RO_CONST"</span></span>, <span class="hljs-number"><span class="hljs-number">0x7</span></span> ) ) r0.add_bits( RegBits( <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-string"><span class="hljs-string">"GEN_EN"</span></span> , <span class="hljs-string"><span class="hljs-string">"RW"</span></span> ) ) r0.add_bits( RegBits( <span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-string"><span class="hljs-string">"GEN_ERROR"</span></span>, <span class="hljs-string"><span class="hljs-string">"RO_LH"</span></span> ) ) r0.add_bits( RegBits( <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-string"><span class="hljs-string">"GEN_RESET"</span></span>, <span class="hljs-string"><span class="hljs-string">"RW_SC"</span></span> ) ) r1 = Reg( <span class="hljs-number"><span class="hljs-number">0x1</span></span>, <span class="hljs-string"><span class="hljs-string">"IP_DST"</span></span> ) <span class="hljs-comment"><span class="hljs-comment"># let ip destination in reset will be 178.248.233.33 ( habrahabr.ru ) r1.add_bits( RegBits( 31, 0, "IP_DST", "RW", 0xB2F8E921 ) ) r2 = Reg( 0x2, "FRM_SIZE" ) r2.add_bits( RegBits( 15, 0, "FRM_SIZE", "RW", 64 ) ) r3 = Reg( 0x3, "FRM_CNT" ) r3.add_bits( RegBits( 31, 0, "FRM_CNT", "RO" ) ) reg_l = [r0, r1, r2, r3]</span></span></code> </pre><br><br>  The template itself looks like this: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="python hljs">csr_map_template = Template(<span class="hljs-string"><span class="hljs-string">u""" {%- macro reg_name( r ) -%} reg_{{r.num}}_{{r.name_lowcase}} {%- endmacro %} {%- macro reg_name_bits( r, b ) -%} reg_{{r.num}}_{{r.name_lowcase}}___{{b.name_lowcase}} {%- endmacro %} {%- macro bit_init_value( b ) -%} {{b.width}}'h{{b.init_value}} {%- endmacro %} {%- macro signal( width ) -%} [{{width-1}}:0] {%- endmacro %} {%- macro print_port_signal( dir, width, name, eol="," ) -%} {{ " %-12s %-10s %-10s" | format( dir, signal( width ), name+eol ) }} {%- endmacro %} {%- macro get_port_name( b ) -%} {%- if b.port_signal_input -%} {{b.name_lowcase}}_i {%- else -%} {{b.name_lowcase}}_o {%- endif -%} {%- endmacro -%} // Generated using CSR map generator // https://github.com/johan92/csr-map-generator module {{module_name}}( {%- for p in data %} // Register {{p.name}} signals {%- for b in p.bits %} {%- if b.port_signal_input %} {{print_port_signal( "input", b.width, get_port_name( b ) )}} {%- elif b.port_signal_output %} {{print_port_signal( "output", b.width, get_port_name( b ) )}} {%- endif %} {%- endfor %} {% endfor %} // CSR interface {{print_port_signal( "input", 1, "reg_clk_i" ) }} {{print_port_signal( "input", 1, "reg_rst_i" ) }} {{print_port_signal( "input", reg_d_w, "reg_wr_data_i" ) }} {{print_port_signal( "input", 1, "reg_wr_en_i" ) }} {{print_port_signal( "input", 1, "reg_rd_en_i" ) }} {{print_port_signal( "input", reg_a_w, "reg_addr_i" ) }} {{print_port_signal( "output", reg_d_w, "reg_rd_data_o", "" ) }} ); {%- for p in data %} // ****************************************** // Register {{p.name}} // ****************************************** logic [{{reg_d_w-1}}:0] {{reg_name( p )}}_read; {%- for b in p.bits %} {%- if b.mode != "RO" %} logic [{{b.width-1}}:0] {{reg_name_bits( p, b )}} = {{bit_init_value( b )}}; {%- endif %} {%- endfor %} {% for b in p.bits %} {%- if b.port_signal_output %} always_ff @( posedge reg_clk_i or posedge reg_rst_i ) if( reg_rst_i ) {{reg_name_bits( p, b )}} &lt;= {{bit_init_value( b )}}; else if( reg_wr_en_i &amp;&amp; ( reg_addr_i == {{reg_a_w}}'h{{p.num}} ) ) {{reg_name_bits( p, b )}} &lt;= reg_wr_data_i[{{b.bit_msb}}:{{b.bit_lsb}}]; {%-if b.mode == "RW_SC" %} else {{reg_name_bits( p, b )}} &lt;= {{bit_init_value( b )}}; {% endif %} {%- endif %} {%- if b.mode == "RO_LH" or b.mode == "RO_LL" %} always_ff @( posedge reg_clk_i or posedge reg_rst_i ) if( reg_rst_i ) {{reg_name_bits( p, b )}} &lt;= {{bit_init_value( b )}}; else begin if( reg_rd_en_i &amp;&amp; ( reg_addr_i == {{reg_a_w}}'h{{p.num}} ) ) {{reg_name_bits( p, b )}} &lt;= {{bit_init_value( b )}}; {% if b.mode == "RO_LL" %} if( {{get_port_name( b )}} == 1'b0 ) {{reg_name_bits( p, b )}} &lt;= 1'b0; {%- elif b.mode == "RO_LH" %} if( {{get_port_name( b )}} == 1'b1 ) {{reg_name_bits( p, b )}} &lt;= 1'b1; {%- endif %} end {% endif %} {% endfor %} // assigning to output {%- for b in p.bits %} {%- if b.port_signal_output %} assign {{get_port_name( b )}} = {{reg_name_bits( p, b )}}; {%- endif %} {%- endfor %} {%- macro print_in_always_comb( r, b, _right_value ) -%} {%- if b == "" -%} {{ " %s%-7s = %s;" | format( reg_name( r ) + "_read", "", _right_value ) }} {%- else -%} {{ " %s%-7s = %s;" | format( reg_name( r ) + "_read", "["+b.bit_msb|string+":"+b.bit_lsb|string+"]" , _right_value ) }} {%- endif -%} {%- endmacro %} // assigning to read data always_comb begin {{print_in_always_comb( p, "", reg_d_w|string+"'h0" ) }} {%- for b in p.bits %} {%- if b.mode == "RO" %} {{print_in_always_comb( p, b, get_port_name( b ) )}} {%- else %} {{print_in_always_comb( p, b, reg_name_bits( p, b ) )}} {%- endif %} {%- endfor %} end {%- endfor %} // ****************************************** // Reading stuff // ****************************************** logic [{{reg_d_w-1}}:0] reg_rd_data = {{reg_d_w}}'h0; always_ff @( posedge reg_clk_i or posedge reg_rst_i ) if( reg_rst_i ) reg_rd_data &lt;= {{reg_d_w}}'h0; else if( reg_rd_en_i ) begin case( reg_addr_i ) {% for p in data %} {{reg_a_w}}'h{{p.num}}: begin reg_rd_data &lt;= {{reg_name( p )}}_read; end {% endfor %} default: begin reg_rd_data &lt;= {{reg_d_w}}'h0; end endcase end assign reg_rd_data_o = reg_rd_data; endmodule """</span></span>)</code> </pre><br></div></div><br><br>  Dragging template generation: <br><pre> <code class="hljs haskell"> res = csr_map_template.render( module_name = <span class="hljs-type"><span class="hljs-type">MODULE_NAME</span></span>, reg_d_w = <span class="hljs-number"><span class="hljs-number">32</span></span>, reg_a_w = <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> = reg_l )</span></span></code> </pre><br><br>  We got this module: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="vhdl hljs">// Generated using CSR <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> generator // https://github.com/johan92/csr-<span class="hljs-keyword"><span class="hljs-keyword">map</span></span>-generator module trafgen_map_4habr( // <span class="hljs-keyword"><span class="hljs-keyword">Register</span></span> MAIN signals output [<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] gen_en_o, input [<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] gen_error_i, output [<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] gen_reset_o, // <span class="hljs-keyword"><span class="hljs-keyword">Register</span></span> IP_DST signals output [<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] ip_dst_o, // <span class="hljs-keyword"><span class="hljs-keyword">Register</span></span> FRM_SIZE signals output [<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] frm_size_o, // <span class="hljs-keyword"><span class="hljs-keyword">Register</span></span> FRM_CNT signals input [<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] frm_cnt_i, // CSR interface input [<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] reg_clk_i, input [<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] reg_rst_i, input [<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] reg_wr_data_i, input [<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] reg_wr_en_i, input [<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] reg_rd_en_i, input [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] reg_addr_i, output [<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] reg_rd_data_o ); // ****************************************** // <span class="hljs-keyword"><span class="hljs-keyword">Register</span></span> MAIN // ****************************************** logic [<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] reg_0_main_read; logic [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] reg_0_main___ip_core_version = <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h7</span></span>; logic [<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] reg_0_main___gen_en = <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span>; logic [<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] reg_0_main___gen_error = <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span>; logic [<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] reg_0_main___gen_reset = <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span>; always_ff @( posedge reg_clk_i <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> posedge reg_rst_i ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( reg_rst_i ) reg_0_main___gen_en &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( reg_wr_en_i &amp;&amp; ( reg_addr_i == <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span> ) ) reg_0_main___gen_en &lt;= reg_wr_data_i[<span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>]; always_ff @( posedge reg_clk_i <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> posedge reg_rst_i ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( reg_rst_i ) reg_0_main___gen_error &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( reg_rd_en_i &amp;&amp; ( reg_addr_i == <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span> ) ) reg_0_main___gen_error &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( gen_error_i == <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1</span></span> ) reg_0_main___gen_error &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> always_ff @( posedge reg_clk_i <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> posedge reg_rst_i ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( reg_rst_i ) reg_0_main___gen_reset &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( reg_wr_en_i &amp;&amp; ( reg_addr_i == <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span> ) ) reg_0_main___gen_reset &lt;= reg_wr_data_i[<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">31</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> reg_0_main___gen_reset &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span>; // assigning <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> output assign gen_en_o = reg_0_main___gen_en; assign gen_reset_o = reg_0_main___gen_reset; // assigning <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> read data always_comb <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> reg_0_main_read = <span class="hljs-number"><span class="hljs-number">32</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span>; reg_0_main_read[<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] = reg_0_main___ip_core_version; reg_0_main_read[<span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>] = reg_0_main___gen_en; reg_0_main_read[<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>] = reg_0_main___gen_error; reg_0_main_read[<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">31</span></span>] = reg_0_main___gen_reset; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> // ****************************************** // <span class="hljs-keyword"><span class="hljs-keyword">Register</span></span> IP_DST // ****************************************** logic [<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] reg_1_ip_dst_read; logic [<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] reg_1_ip_dst___ip_dst = <span class="hljs-number"><span class="hljs-number">32</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hB2F8E921</span></span>; always_ff @( posedge reg_clk_i <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> posedge reg_rst_i ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( reg_rst_i ) reg_1_ip_dst___ip_dst &lt;= <span class="hljs-number"><span class="hljs-number">32</span></span><span class="hljs-symbol"><span class="hljs-symbol">'hB2F8E921</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( reg_wr_en_i &amp;&amp; ( reg_addr_i == <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h1</span></span> ) ) reg_1_ip_dst___ip_dst &lt;= reg_wr_data_i[<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]; // assigning <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> output assign ip_dst_o = reg_1_ip_dst___ip_dst; // assigning <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> read data always_comb <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> reg_1_ip_dst_read = <span class="hljs-number"><span class="hljs-number">32</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span>; reg_1_ip_dst_read[<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] = reg_1_ip_dst___ip_dst; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> // ****************************************** // <span class="hljs-keyword"><span class="hljs-keyword">Register</span></span> FRM_SIZE // ****************************************** logic [<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] reg_2_frm_size_read; logic [<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] reg_2_frm_size___frm_size = <span class="hljs-number"><span class="hljs-number">16</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h40</span></span>; always_ff @( posedge reg_clk_i <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> posedge reg_rst_i ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( reg_rst_i ) reg_2_frm_size___frm_size &lt;= <span class="hljs-number"><span class="hljs-number">16</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h40</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( reg_wr_en_i &amp;&amp; ( reg_addr_i == <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h2</span></span> ) ) reg_2_frm_size___frm_size &lt;= reg_wr_data_i[<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>]; // assigning <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> output assign frm_size_o = reg_2_frm_size___frm_size; // assigning <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> read data always_comb <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> reg_2_frm_size_read = <span class="hljs-number"><span class="hljs-number">32</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span>; reg_2_frm_size_read[<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] = reg_2_frm_size___frm_size; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> // ****************************************** // <span class="hljs-keyword"><span class="hljs-keyword">Register</span></span> FRM_CNT // ****************************************** logic [<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] reg_3_frm_cnt_read; // assigning <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> output // assigning <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> read data always_comb <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> reg_3_frm_cnt_read = <span class="hljs-number"><span class="hljs-number">32</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span>; reg_3_frm_cnt_read[<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] = frm_cnt_i; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> // ****************************************** // Reading stuff // ****************************************** logic [<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] reg_rd_data = <span class="hljs-number"><span class="hljs-number">32</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span>; always_ff @( posedge reg_clk_i <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> posedge reg_rst_i ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( reg_rst_i ) reg_rd_data &lt;= <span class="hljs-number"><span class="hljs-number">32</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( reg_rd_en_i ) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span>( reg_addr_i ) <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> reg_rd_data &lt;= reg_0_main_read; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> reg_rd_data &lt;= reg_1_ip_dst_read; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h2</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> reg_rd_data &lt;= reg_2_frm_size_read; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h3</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> reg_rd_data &lt;= reg_3_frm_cnt_read; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> reg_rd_data &lt;= <span class="hljs-number"><span class="hljs-number">32</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> endcase <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> assign reg_rd_data_o = reg_rd_data; endmodule</code> </pre><br></div></div><br><br>  As you can see, the idea worked: a full-fledged module appeared from a simple text description that you don‚Äôt need to finish with your hands - you can immediately take it into production) <br><br>  <b>Avalon-MM</b> similarity was used as the management interface. <br><br><h3>  Summarizing </h3><br>  I got acquainted with <b>Jinja2</b> just a couple of days ago, when I looked at the githabe <a href="https://github.com/alexforencich/verilog-ethernet">implementation of</a> 1G and 10G MAC cores along with the UDP / IP stack.  By the way, it is written well, but I looked quite superficially and in the simulation, and even more so on the hardware did not try. <br><br>  The author uses Jinja2 to generate various modules, for example, the <a href="https://github.com/alexforencich/verilog-ethernet/blob/master/lib/axis/rtl/axis_mux_64.py">AXI4-Stream N-port multiplexer</a> .  This multiplexer is much more cunning than the one I wrote at the beginning of the article. <br><br>  I <b>put a</b> script to generate <b>csr_map</b> in haste to feel the possibilities of Jinja2 (I am sure, I appreciated a small part of it), but I can recommend to all my colleagues who are developing FPGA to play with this library, you may be able to speed up your development by autogenerating code. <br><br>  Of course, this script is raw, and <a href="http://habrahabr.ru/company/metrotek/">we</a> have not yet used it in development (and I don‚Äôt even know whether we will use it or not, because for various reasons the beautiful architecture of IP cores sometimes remains just beautiful architecture). <br><br>  Laid out the entire source <a href="https://github.com/johan92/csr-map-generator">on githab</a> .  If this template is useful to someone, I will be glad: I am ready to improve it by requests, or to accept someone's pull-requests) <br><br>  Thanks for attention!  If you have questions, ask without a doubt. <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">  It is a pity, of course, that the FPGA hub was <a href="http://habrahabr.ru/company/tm/blog/139898/">transferred</a> to the Hycktimes. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/263005/">https://habr.com/ru/post/263005/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262991/index.html">Using morph.io for web parsing</a></li>
<li><a href="../262993/index.html">The digest of interesting materials for the mobile # 112 developer (on July 13-19)</a></li>
<li><a href="../262995/index.html">Pussies: Refactoring</a></li>
<li><a href="../262997/index.html">Google Chrome has introduced additional security features for Flash Player.</a></li>
<li><a href="../263001/index.html">Overview of Docker Engine from 1.0 to 1.7. Introduction to Docker Compose</a></li>
<li><a href="../263007/index.html">The digest of interesting materials from the world of web development and IT for the last two weeks ‚Ññ168 (July 5 - 19, 2015)</a></li>
<li><a href="../263009/index.html">Parsing formats: 3d models from the inside</a></li>
<li><a href="../263011/index.html">Some potential buyers need to know about Bitrix</a></li>
<li><a href="../263015/index.html">Wolfram Language (Mathematica) is just a toy</a></li>
<li><a href="../263017/index.html">Conference C ++ Siberia in Novosibirsk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>