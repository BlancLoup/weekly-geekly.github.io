<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Setting up centralized logging with LogAnalyzer and Rsyslog</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most recently, I needed to create a central log server with a web interface, and in this article I would like to share my experience, maybe someone wi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Setting up centralized logging with LogAnalyzer and Rsyslog</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/6f4/303/af9/6f4303af983a2b76340767122fc7f610.png"><br><br>  Most recently, I needed to create a central log server with a web interface, and in this article I would like to share my experience, maybe someone will find it useful.  I will describe the installation and configuration of the LogAnalyzer web log viewer, the Rsyslog client, which will send all the logs to the remote Rysyslog server, and the latter, in turn, will write them to the MySQL database. <br><br>  I chose Ubuntu 12.04 as the OS. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      WebNote Test Addresses: <br>  <b>192.168.1.51</b> (loganalyzer-mysql.ip) - Rsyslog server, LogAnalyzer will also be installed on this host <br>  <b>192.168.1.50</b> (loganalyzer-mongo.ip) - Rsyslog client, which will send logs to the server loganalyzer-mysql.ip <br><br>  Configuring the server part, for which we will add the <a href="http//www.rsyslog.com/ubuntu-repository/">repository from the Rsyslog developer</a> : <br><br><pre><code class="bash hljs">... <span class="hljs-comment"><span class="hljs-comment"># Adiscon stable repository deb http://ubuntu.adiscon.com/v7-stable precise/ deb-src http://ubuntu.adiscon.com/v7-stable precise/ ...</span></span></code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt-key adv --recv-keys --keyserver keyserver.ubuntu.com AEF0CF8E # gpg --export --armor AEF0CF8E | sudo apt-key add -</span></span></code> </pre> <a name="habracut"></a><br>  Of course, you can use the version of Rsyslog that is available in standard repositories, but I had a <a href="https://bugs.launchpad.net/ubuntu/%2Bsource/rsyslog/%2Bbug/789174">problem opening 514 TCP ports on behalf of the syslog user</a> . <br><br>  We update packages and install Rsyslog with additional packages that will be needed in the future: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt-get update # apt-get install rsyslog rsyslog-mysql mysql-server mysql-client</span></span></code> </pre> <br>  As I said above, we will configure logging to the local MySQL database.  You will also need to answer some questions during the installation process.  During configuration, the rsyslog-mysql package will ask for the creation of a user and a database for storing future logs: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/209/e03/07b/209e0307b71d71149dcb99a8d99ca83d.png"><br><br>  You must first specify a password for the root user of the database.  With its help, the rsyslog database structure will be flooded: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/194/334/5da/1943345dad2c07d440b229331dbbd768.png"><br><br>  Specify a password for an individual database rsyslog user: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/de7/6a1/e3c/de76a1e3cf2d47626c4779be46a4659e.png"><br><br>  If the MySQL server did not exist on the host, the installer will install it and also offer to create a password for the root user. <br><br>  The final config for integrating Rsyslog and MySQL is as follows: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vim /etc/rsyslog.d/mysql.conf ### Configuration file for rsyslog-mysql ### Changes are preserved $ModLoad ommysql *.* :ommysql:localhost,Syslog,rsyslog,p@ssw0rD</span></span></code> </pre> <br>  <b>*. *</b> - write all logs to database <br>  <b>ommysql</b> - the module with which rsyslog will write to MySQL <br>  <b>Syslog</b> - the name of the database <br>  <b>rsyslog</b> - user who has access to write to the syslog database <br>  <b>p @ ssw0rD</b> - <b>rsyslog</b> password <br><br>  Reboot rsyslog and check the database: <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>; +<span class="hljs-comment"><span class="hljs-comment">--------------------+ | Database | +--------------------+ | information_schema | | Syslog | | mysql | | performance_schema | | test | +--------------------+ mysql&gt; use Syslog; mysql&gt; show tables; +------------------------+ | Tables_in_Syslog | +------------------------+ | SystemEvents | | SystemEventsProperties | +------------------------+ mysql&gt; select * from SystemEvents limit 2 \G *************************** 1. row *************************** ID: 1 CustomerID: NULL ReceivedAt: 2014-02-11 04:22:52 DeviceReportedTime: 2014-02-11 04:22:52 Facility: 5 Priority: 6 FromHost: loganalyzer Message: [origin software="rsyslogd" swVersion="8.1.5" x-pid="11992" x-info="http://www.rsyslog.com"] start ... InfoUnitID: 1 SysLogTag: rsyslogd: EventLogType: NULL GenericFileName: NULL SystemID: NULL *************************** 2. row *************************** ID: 2 CustomerID: NULL ReceivedAt: 2014-02-11 04:22:52 DeviceReportedTime: 2014-02-11 04:22:52 Facility: 5 Priority: 6 FromHost: loganalyzer Message: rsyslogd's groupid changed to 103 ... InfoUnitID: 1 SysLogTag: rsyslogd: EventLogType: NULL GenericFileName: NULL SystemID: NULL 2 rows in set (0.00 sec) mysql&gt;</span></span></code> </pre> <br>  It seems that the logs are written, as expected. <br>  Now we set up receiving logs from the remote host.  To do this, edit the configuration file on the Rsyslog server, i.e.  check whether the lines are commented out: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vim /etc/rsyslog.conf ... $ModLoad imudp $UDPServerRun 514 # provides TCP syslog reception $ModLoad imtcp $InputTCPServerRun 514 ...</span></span></code> </pre> <br>  Reboot the rsyslog service.  Thus, the 514th UDP and TCP ports will be open for receiving logs. <br><br>  Moving on to setting up the Loganalyzer.  It will be installed on the node with IP 192.168.1.51, that is, on the node with the Rsyslog server.  We use Apache as a web server, so we will install it and the packages necessary for LogAnalyzer to work: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># aptitude install apache2 libapache2-mod-php5 php5-mysql php5-gd</span></span></code> </pre> <br>  Download the latest Loganalyzer, unpack it, set the necessary rights for the configuration scripts: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mkdir /tmp/loganalyzer # cd /tmp/loganalyzer # wget http://download.adiscon.com/loganalyzer/loganalyzer-3.6.5.tar.gz # tar zxvf loganalyzer-3.6.5.tar.gz # mkdir /var/www/loganalyzer # mv loganalyzer-3.6.5/src/* /var/www/loganalyzer # mv loganalyzer-3.6.5/contrib/* /var/www/loganalyzer # chmod +x /var/www/loganalyzer/configure.sh /var/www/loganalyzer/secure.sh # ./configure.sh &amp;&amp; ./secure.sh # chown -R www-data:www-data /var/www/loganalyzer</span></span></code> </pre> <br>  At the time of publication of this article, the latest version of the Loganalyzer log viewer is 3.6.5. <br>  Create a virtual host in which you should not forget, at least, to change the ServerName and DocumentRoot parameters: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cd /etc/apache2/sites-available # cp default loganalyzer.conf # vim loganalyzer.conf</span></span></code> </pre> <br><pre> <code class="apache hljs"><span class="hljs-section"><span class="hljs-section">&lt;VirtualHost *:80&gt;</span></span> <span class="hljs-attribute"><span class="hljs-attribute">ServerAdmin</span></span> webmaster@localhost ServerName loganalyzer-mysql.ip #&lt;&lt;---insert your domainname here DocumentRoot /var/www/loganalyzer #&lt;&lt;---insert root directory of unpacked Loganalyzer &lt;Directory /&gt; Options FollowSymLinks AllowOverride None &lt;/Directory&gt; &lt;Directory /var/www/&gt; Options Indexes FollowSymLinks MultiViews AllowOverride None Order allow,deny allow from <span class="hljs-literal"><span class="hljs-literal">all</span></span> &lt;/Directory&gt; ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/ &lt;Directory <span class="hljs-string"><span class="hljs-string">"/usr/lib/cgi-bin"</span></span>&gt; AllowOverride None Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch Order allow,deny Allow from <span class="hljs-literal"><span class="hljs-literal">all</span></span> &lt;/Directory&gt; ErrorLog <span class="hljs-variable"><span class="hljs-variable">${APACHE_LOG_DIR}</span></span>/error.log # Possible values include: debug, info, notice, warn, error, crit, # alert, emerg. LogLevel warn CustomLog <span class="hljs-variable"><span class="hljs-variable">${APACHE_LOG_DIR}</span></span>/access.log combined Alias /doc/ <span class="hljs-string"><span class="hljs-string">"/usr/share/doc/"</span></span> &lt;Directory <span class="hljs-string"><span class="hljs-string">"/usr/share/doc/"</span></span>&gt; Options Indexes MultiViews FollowSymLinks AllowOverride None Order deny,allow Deny from <span class="hljs-literal"><span class="hljs-literal">all</span></span> Allow from 127.0.0.0/255.0.0.0 ::1/128 &lt;/Directory&gt; &lt;/VirtualHost&gt;</code> </pre> <br>  We activate the virtual host, check the configuration files and restart the Apache: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># a2ensite loganalyzer.conf # a2dissite 000-default # apachectl configtest # service apache2 restart</span></span></code> </pre> <br>  Open the links <a href="http://loganalyzer-mysql.ip/install.php">loganalyzer-mysql.ip / install.php</a> (in my case, loganalyzer-mysql.ip through / etc / hosts is bound to the IP address 192.168.1.51).  We answer the questions posed: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/aa5/899/003/aa5899003247854ce8e6f2dfb15e6658.png"><br><br>  Check permissions to directories: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/08c/0bd/462/08c0bd462a477336072f0ab9b06aafdb.png"><br><br>  User configuration for the database and some additional options.  Enter the values ‚Äã‚Äãfrom the configuration file /etc/rsyslog.d/mysql.conf about which I wrote above.  Only the MySQL database can be used for this. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e09/312/0ee/e093120eed81cbb7e11c0ae184066fd3.png"><br><br>  Check access to the database using the provided login / password and fill the structure of tables with which LogAnalyzer will work. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3ae/973/808/3ae973808f437bfd988331255c692f90.png"><br><br>  Creating an administrator for the LogAnalyzer web-interface. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e90/861/e55/e90861e5551abfcc49dde8a4ba0f1481.png"><br><br>  Add the source of the logs to display.  LogAnalyzer can show records from a text file, a MongoDB database or MySQL.  We describe the database access options (we write everything exactly as shown in the screenshot below, the register is also important): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/212/ba1/4c0/212ba14c016b3ffff5f1a82d4a3d95d4.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a79/bde/dba/a79bdedba68878d9323f23b1e983761d.png"><br><br>  All is ready!  Login using login / password. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/898/617/bb7/898617bb71d9e405a3022eb482c8ab01.png"><br><br>  The LogAnalyzer interface looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fd8/c0a/ecf/fd8c0aecfea8a82d6a7de6ae3cf9abcd.png"><br><br>  He can also draw some graphs: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/638/806/008/638806008801258fb8d6d95794f02498.png"><br><br>  I‚Äôll advise users of the Chrome browser to uncheck the "Use Popup to display the full message details" checkbox, otherwise there will be noticeable graphical bugs: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5e1/8b3/6d1/5e18b36d194ab93a120dfa735e1a0e84.png"><br><br>  Now LogAnalyzer reflects logs from only one host, that is, the ones that rsyslog collects.  Therefore, we configure sending logs from a remote server, for which we edit the rsyslog config on the host 192.168.1.50 and add the option: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vim /etc/rsyslog.conf ... *.* @@192.168.1.51 ...</span></span></code> </pre> <br>  <b>*. *</b> - a description of all the logs in importance and the programs that write them. <br>  <b>@@</b> - send TCP logs <br>  <b>@</b> - send logs via UDP <br>  <b>192.168.1.51</b> - server to which logs will be sent. <br><br>  Sometimes there is a desire to send logs of services that do not know how to write in syslog.  Therefore, a <a href="http//serverfault.com/questions/396136/how-to-forward-specific-log-file-outside-of-var-log-with-rsyslog-to-remote-serv">similar configuration</a> might be useful: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vim /etc/rsyslog.d/mongo.conf $ModLoad imfile $InputFileName /var/log/mongodb/mongodb.log $InputFileTag mongodb: $InputFileStateFile stat-mongo-error $InputFileSeverity error $InputFileFacility daemon $InputRunFileMonitor error.* @@192.168.1.51</span></span></code> </pre> <br>  Everything in the /etc/rsyslog.d/ directory and with the end of conf is included in the main config /etc/rsyslog.conf.  In this case, logs from the text file /var/log/mongodb/mongodb.log will be sent and flagged as errors.  All that in the /var/log/mongodb/mongodb.log file will be sent to a common syslog and look like this: <br><br><pre> <code class="bash hljs">Feb 17 17:27:05 loganalyzer - mongo mongodb : Sun Feb 16 7:26:13 [ clientcursormon ] mem (MB ) res : 15 virt : 624 mapped : 0</code> </pre> <br>  And here‚Äôs the resulting LogAnalyzer view: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9f7/b77/388/9f7b773885db491cd394445d74b0e990.png"><br><br>  Other options can be used as a log storage base.  The non-relational MongoDB database can be an ideal choice, because both LogAnalyzer and Rsyslog support it. <br><br>  <b>Links:</b> <br>  <a href="http://www.k-max.name/linux/rsyslog-na-debian-nastrojka-servera/">www.k-max.name/linux/rsyslog-na-debian-nastrojka-servera</a> <br>  <a href="http://rtfm.co.ua/debian-log-syslog-mysql-loganalyzer/">rtfm.co.ua/debian-log-syslog-mysql-loganalyzer</a> <br>  <a href="http://www.unixmen.com/install-and-configure-rsyslog-in-centos-6-4-rhel-6-4/">www.unixmen.com/install-and-configure-rsyslog-in-centos-6-4-rhel-6-4</a> <br>  <a href="http://terraltech.com/syslog-server-with-rsyslog-and-loganalyzer/">terraltech.com/syslog-server-with-rsyslog-and-loganalyzer</a> <br>  <a href="http://rogovts.ru/opensource/rsysloganalyzer.html">rogovts.ru/opensource/rsysloganalyzer.html</a> <br>  <a href="http://lists.adiscon.net/pipermail/rsyslog/2013-March/031884.html">lists.adiscon.net/pipermail/rsyslog/2013-March/031884.html</a> <br>  <a href="http://loganalyzer.adiscon.com/articles/using-mongodb-with-rsyslog-and-loganalyzer/">loganalyzer.adiscon.com/articles/using-mongodb-with-rsyslog-and-loganalyzer</a> <br>  <a href="http://www.rsyslog.com/sending-messages-to-a-remote-syslog-server/">www.rsyslog.com/sending-messages-to-a-remote-syslog-server</a> </div><p>Source: <a href="https://habr.com/ru/post/213519/">https://habr.com/ru/post/213519/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../213503/index.html">We teach recruiters to hire programmers</a></li>
<li><a href="../213507/index.html">Olympiad web development. Volgograd and 60 more cities</a></li>
<li><a href="../213513/index.html">We connect to the PSP gamepad from Xbox 360 using Raspberry Pi</a></li>
<li><a href="../213515/index.html">Cooking IndexedDB</a></li>
<li><a href="../213517/index.html">Neovim: a modern clone of the Vim text editor</a></li>
<li><a href="../213521/index.html">The increase in budgetary places in IT specialties in universities of the Russian Federation in the 2015-2016 academic year</a></li>
<li><a href="../213523/index.html">DdTypograph 2.0b snippet on EMT lib 3.2 (MODX Evo)</a></li>
<li><a href="../213525/index.html">Adam Langley explained the reasons for the bug in iOS: an extra line of code broke all security</a></li>
<li><a href="../213527/index.html">The history of game consoles in advertising. Part 1: From Magnavox Odyssey to Super Nintendo</a></li>
<li><a href="../213529/index.html">Challenge for $ 500. Part two, about money</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>