<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Parsing BEncode in javascript. View torrent files in Firefox</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I. Why 
 There are several ways to view torrent files: in the torrent client, in the BEncode Editor , in file managers with plug-ins, perhaps in netwo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Parsing BEncode in javascript. View torrent files in Firefox</h1><div class="post__text post__text-html js-mediator-article"><h4>  I. Why </h4><br>  There are several ways to view torrent files: in the torrent client, in the <a href="http://forum.utorrent.com/viewtopic.php%3Fid%3D31306">BEncode Editor</a> , in file managers with plug-ins, perhaps in network services (but this is a bit dumb). <br><br>  But it is not always convenient to call an external program from the browser.  Not always this program gives full information.  Not always in a convenient way.  Not always searchable.  Therefore, I would like to have in the browser an easy way to view the torrent file, for example: <br><br>  - find out the contents of the distribution; <br>  - find out the number of files in the distribution; <br>  - find out information about files (some trackers are very lenient to the incompleteness of descriptions, and more information about files appears in torrent files - for example, resolution, video and audio codecs, duration of movies, etc.); <br>  - find out information about the torrent file itself (creation time, trackers, privacy flag, etc.); <br>  - be able to text search all the information. <br><a name="habracut"></a><br><h4>  Ii.  Strategy </h4><br>  For our task, you can write an extension to the browser, but this is fraught with a number of additional difficulties.  Therefore, we use the simplified method. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Extension <a href="https://addons.mozilla.org/ru/firefox/addon/custom-buttons/">Custom Buttons</a> allows you to create buttons with arbitrary code.  Even better, this code runs in the context of the browser, has access to the same components and interfaces as extensions, and can even create GUI elements of arbitrary complexity.  Therefore, we simply create a new button and fill it with code (for all we need two hundred lines) All the following code needs to be inserted into the initialization tab of the newly created button so that it runs every time the browser is started, once and for the entire session defining the desired behavior of the button.  Or you can not insert it: the extension adds the custombutton: // protocol to the browser, and at the end of the article I‚Äôll give you a link just by clicking on which you can create a ready-made button with code (you just have to move it from the tool palette to a convenient place). <br><br><h4>  Iii.  Tactics </h4><br><h5>  1. User Interface </h5><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> btn = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> imgMain = <span class="hljs-string"><span class="hljs-string">"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAdVBMVEX////////////////////////////////XzeWjisHx7vaKaq5nNpV8VqSDYaqtmMiTdbS2pM/MwN6YfLjBstd7VqRuQZnk3u7y7/eKa6+SdbR1S56CX6jXzuabgLv49/uhh7+JaK39/P3e1ury7vbLv97g2es6Rn8YAAAAB3RSTlMAYMAg0PDzqTbVzAAAAAFiS0dEAIgFHUgAAAAJcEhZcwAAAEgAAABIAEbJaz4AAACcSURBVBjTXY/bAoIgEEQRsWERUykDMu1m/f8ntqC+dJ6WYfYyQjCFBCMLsVIqaGI0VJnflaltpjZVUpRp7EZjFPcj/R/bLntQCKm56IE2e7QUIGsJ7tSeaUhVEi5wgw/OR2uvWegQvR9zy+ogWDi7CzyUMO4CD+W1EdQj7mvTYT7cJkx0nO9qPf2B8JxdwOtQbuHeC5bPdwv3F/8HCk4KcI8+awQAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTItMDYtMjZUMjE6MDk6MDQrMDQ6MDD1mOHZAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDEyLTA2LTI2VDIxOjA5OjA0KzA0OjAwhMVZZQAAAABJRU5ErkJggg=="</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> imgThrobber = <span class="hljs-string"><span class="hljs-string">"data:image/gif;base64,R0lGODlhEAAQAOMIAAAAABoaGjMzM0xMTGZmZoCAgJmZmbKysv///////////////////////////////yH/C05FVFNDQVBFMi4wAwEAAAAh+QQBCgAIACwAAAAAEAAQAAAESBDJiQCgmFqbZwjVhhwH9n3hSJbeSa1sm5GUIHSTYSC2jeu63q0D3PlwCB1lMMgUChgmk/J8LqUIAgFRhV6z2q0VF94iJ9pOBAAh+QQBCgAPACwAAAAAEAAQAAAESPDJ+UKgmFqbpxDV9gAA9n3hSJbeSa1sm5HUMHTTcTy2jeu63q0D3PlwDx2FQMgYDBgmk/J8LqWPQuFRhV6z2q0VF94iJ9pOBAAh+QQBCgAPACwAAAAAEAAQAAAESPDJ+YSgmFqb5xjV9gQB9n3hSJbeSa1sm5EUQXQTADy2jeu63q0D3PlwDx2lUMgcDhgmk/J8LqUPg+FRhV6z2q0VF94iJ9pOBAAh+QQBCgAPACwAAAAAEAAQAAAESPDJ+cagmFqbJyHV9ggC9n3hSJbeSa1sm5FUUXRTEDy2jeu63q0D3PlwDx3FYMgAABgmk/J8LqWPw+FRhV6z2q0VF94iJ9pOBAAh+QQBCgAPACwAAAAAEAAQAAAESPDJ+QihmFqbZynV9gwD9n3hSJbeSa1sm5GUYXSTIDy2jeu63q0D3PlwDx3lcMgEAhgmk/J8LqUPAOBRhV6z2q0VF94iJ9pOBAAh+QQBCgAPACwAAAAAEAAQAAAESPDJ+UqhmFqbpzHV9hAE9n3hSJbeSa1sm5HUcXTTMDy2jeu63q0D3PlwDx0FAMgIBBgmk/J8LqWPQOBRhV6z2q0VF94iJ9pOBAAh+QQBCgAPACwAAAAAEAAQAAAESPDJ+YyhmFqb5znV9hQF9n3hSJbeSa1sm5EUAHQTQTy2jeu63q0D3PlwDx0lEMgMBhgmk/J8LqUPgeBRhV6z2q0VF94iJ9pOBAAh+QQBCgAPACwAAAAAEAAQAAAESPDJ+c6hmFqbJwDV9hgG9n3hSJbeSa1sm5FUEHRTUTy2jeu63q0D3PlwDx1FIMgQCBgmk/J8LqWPweBRhV6z2q0VF94iJ9pOBAA7"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clickBtn</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event.button == <span class="hljs-number"><span class="hljs-number">0</span></span>) { event.preventDefault(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tFileURL = prompt(<span class="hljs-string"><span class="hljs-string">"Torrent File URL:"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tFileURL) { getTFile(tFileURL); } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkDrag</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event.dataTransfer.types.contains(<span class="hljs-string"><span class="hljs-string">"text/uri-list"</span></span>)) { event.preventDefault(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDrop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tFileURL = event.dataTransfer.getData(<span class="hljs-string"><span class="hljs-string">"URL"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tFileURL) { getTFile(tFileURL); } event.preventDefault(); } btn.addEventListener(<span class="hljs-string"><span class="hljs-string">"click"</span></span>, clickBtn, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); btn.addEventListener(<span class="hljs-string"><span class="hljs-string">"dragenter"</span></span>, checkDrag, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); btn.addEventListener(<span class="hljs-string"><span class="hljs-string">"dragover"</span></span>, checkDrag, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); btn.addEventListener(<span class="hljs-string"><span class="hljs-string">"drop"</span></span>, onDrop, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); btn.onDestroy = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ btn.removeEventListener(<span class="hljs-string"><span class="hljs-string">"click"</span></span>, clickBtn, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); btn.removeEventListener(<span class="hljs-string"><span class="hljs-string">"dragenter"</span></span>, checkDrag, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); btn.removeEventListener(<span class="hljs-string"><span class="hljs-string">"dragover"</span></span>, checkDrag, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); btn.removeEventListener(<span class="hljs-string"><span class="hljs-string">"drop"</span></span>, onDrop, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre> <br><br>  In this piece we get the button object, set two images (one is the main thing, the other is the standard file loading indicator, they will alternate), define event handlers and attach them to the button. <br><br>  We get two ways to give the program the address of the torrent file: if there is a link, we simply drag it to the button ( <a href="https://developer.mozilla.org/en/DragDrop/Drag_and_Drop">description of the mechanisms</a> ).  If there is a line with the address in the buffer, we click on the button and paste the address into the appearing field. <br><br>  At the end, we set the destructors for the attached handlers.  In Custom Buttons, there is an unpleasant bug: if you do not explicitly specify a decoupling, handlers will overlap with each other with each opening and closing of the tool palette (even if you tune something else with its help). <br><br><h5>  2. Getting a torrent file </h5><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tFileURL</span></span></span><span class="hljs-function">) </span></span>{ btn.image = imgThrobber; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.mozBackgroundRequest = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sendData; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tFileURL.indexOf(<span class="hljs-string"><span class="hljs-string">"http://dl.rutracker.org/forum/dl.php"</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) { xhr.open(<span class="hljs-string"><span class="hljs-string">"POST"</span></span>, tFileURL, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); sendData = tFileURL.replace(<span class="hljs-regexp"><span class="hljs-regexp">/^.+\b(t=\d+).*$/</span></span>, <span class="hljs-string"><span class="hljs-string">"$1"</span></span>); xhr.setRequestHeader(<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/x-www-form-urlencoded"</span></span>); xhr.setRequestHeader(<span class="hljs-string"><span class="hljs-string">"Referer"</span></span>, <span class="hljs-string"><span class="hljs-string">"http://rutracker.org/forum/viewtopic.php?t="</span></span> + tFileURL.replace(<span class="hljs-regexp"><span class="hljs-regexp">/^.+\bt=(\d+).*$/</span></span>, <span class="hljs-string"><span class="hljs-string">"$1"</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { xhr.open(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, tFileURL, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); sendData = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } xhr.timeout = <span class="hljs-number"><span class="hljs-number">10000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-regexp"><span class="hljs-regexp">/^file:/</span></span>.test(tFileURL)) { xhr.channel.loadFlags |= Components.interfaces.nsIRequest.LOAD_BYPASS_CACHE; xhr.channel.QueryInterface(Components.interfaces.nsIHttpChannelInternal) .forceAllowThirdPartyCookie = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } xhr.responseType = <span class="hljs-string"><span class="hljs-string">"arraybuffer"</span></span>; xhr.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ btn.image = imgMain; processTFile(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.response); } xhr.ontimeout = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ btn.image = imgMain; alert(<span class="hljs-string"><span class="hljs-string">"Timeout"</span></span>); } xhr.onerror = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ btn.image = imgMain; alert(<span class="hljs-string"><span class="hljs-string">"HTTP error"</span></span>); } xhr.send(sendData); }</code> </pre><br><br>  Note, for a start, that torrent files are written in BEncode ( <a href="http://wiki.theory.org/BitTorrentSpecification">language description</a> and <a href="http://wiki.theory.org/BitTorrentSpecification">torrent file format</a> ).  It is a bit like JSON in its capabilities.  But there is one quotation in it: tags, numbers and strings in it are encoded, as a rule, on UTF-8, but some strings contain binary data (a simple sequence of bytes not obeying the UTF-8 rules).  Therefore, it is impossible to simply process the entire string as UTF-8, the decoder will start and give an error message about the wrong UTF-8.  When parsing a file you need to keep this precaution in mind. <br><br>  Now a few notes about the request itself and getting the file. <br><br>  We run the Pulsator image and set the background request flag to make the browser easier to use.  Then we check the address and reassure the protection of the most well-known domestic torrent tracker, prohibiting downloading torrent files from non-site pages (this method, which allows extensions to work with torrent tracker files, was once described by the site developers themselves when protection was introduced). <br><br>  To force Firefox to send cookies with XHR, even when the user has prohibited cookies from third-party sites, set the flag to force sending (without this, cookies are not accepted or sent).  Of course, the flags of forced sending of cookies and cache traversal are needed only for network protocols, so in the case of the protocol of local files we do not install them. <br><br>  Previously, in order to get a binary file from XMLHttpRequest, you had <a href="https://developer.mozilla.org/en/DOM/XMLHttpRequest/Sending_and_Receiving_Binary_Data">to resort to some kind of witchcraft</a> .  With the introduction of new types of response in XHR, <a href="https://developer.mozilla.org/en/DOM/XMLHttpRequest/Sending_and_Receiving_Binary_Data">everything is simplified</a> .  Therefore, we will use the type of <code>arraybuffer</code> and work in the future with <a href="https://developer.mozilla.org/en/JavaScript_typed_arrays">typed arrays</a> . <br><br>  In the end, we set the handlers for different outcomes of our request (each time not forgetting to change the pulsator to a regular picture).  If successful, we proceed to parse the resulting file. <br><br><h5>  3. Processing and output of the torrent file </h5><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processTFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tFile</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> byteArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(tFile); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> torrentObject = bdecode(byteArray); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (torrentObject) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (torrentObject[<span class="hljs-string"><span class="hljs-string">'creation date'</span></span>]) { torrentObject[<span class="hljs-string"><span class="hljs-string">'creation date'</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>(torrentObject[<span class="hljs-string"><span class="hljs-string">'creation date'</span></span>]*<span class="hljs-number"><span class="hljs-number">1000</span></span>)).toLocaleString(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (torrentObject.info) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> files = torrentObject.info.files; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (files &amp;&amp; files <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>, file; file = files[i]; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file.length) { file.length = <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>((file.length / <span class="hljs-number"><span class="hljs-number">1024</span></span>).toFixed(<span class="hljs-number"><span class="hljs-number">2</span></span>)).toLocaleString() + <span class="hljs-string"><span class="hljs-string">" KB"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file[<span class="hljs-string"><span class="hljs-string">'path.utf-8'</span></span>]) { file[<span class="hljs-string"><span class="hljs-string">'path.utf-8'</span></span>] = file[<span class="hljs-string"><span class="hljs-string">'path.utf-8'</span></span>].join(<span class="hljs-string"><span class="hljs-string">"/"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file.path) { file.path = file.path.join(<span class="hljs-string"><span class="hljs-string">"/"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (files[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'path.utf-8'</span></span>]) { files = files.sort( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">o1, o2</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o1[<span class="hljs-string"><span class="hljs-string">'path.utf-8'</span></span>] &gt; o2[<span class="hljs-string"><span class="hljs-string">'path.utf-8'</span></span>]) {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o1[<span class="hljs-string"><span class="hljs-string">'path.utf-8'</span></span>] &lt; o2[<span class="hljs-string"><span class="hljs-string">'path.utf-8'</span></span>]) {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;} } ); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (files[<span class="hljs-number"><span class="hljs-number">0</span></span>].path) { files = files.sort( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">o1, o2</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o1[<span class="hljs-string"><span class="hljs-string">'path'</span></span>] &gt; o2[<span class="hljs-string"><span class="hljs-string">'path'</span></span>]) {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o1[<span class="hljs-string"><span class="hljs-string">'path'</span></span>] &lt; o2[<span class="hljs-string"><span class="hljs-string">'path'</span></span>]) {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;} } ); } files.unshift(files.length); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (torrentObject.info.length) { torrentObject.info.length = <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>((torrentObject.info.length / <span class="hljs-number"><span class="hljs-number">1024</span></span>).toFixed(<span class="hljs-number"><span class="hljs-number">2</span></span>)).toLocaleString() + <span class="hljs-string"><span class="hljs-string">" KB"</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gBrowser.selectedBrowser.currentURI.spec == <span class="hljs-string"><span class="hljs-string">"about:blank"</span></span> &amp;&amp; !gBrowser.selectedBrowser.webProgress.isLoadingDocument) { gBrowser.selectedBrowser.loadURI( <span class="hljs-string"><span class="hljs-string">"data:application/json;charset=utf-8,"</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">encodeURIComponent</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(torrentObject, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">'\t'</span></span>)) ); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { gBrowser.selectedTab = gBrowser.addTab( <span class="hljs-string"><span class="hljs-string">"data:application/json;charset=utf-8,"</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">encodeURIComponent</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(torrentObject, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">'\t'</span></span>)) ); } torrentObject = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { alert(<span class="hljs-string"><span class="hljs-string">"Parsing error"</span></span>); } }</code> </pre><br><br>  Having created an array of bytes, we pass it to the BEncode decoder (about it a little later) and receive from it a regular object (associated array, hash), which copies the structure of the torrent file (and if we don‚Äôt receive it, we give the parsing error message).  Then we present some data in a more readable form (creation date, file sizes and paths to it), sort the file objects by the path property and insert the total number of files at the beginning of the file list.  After that, we check if we have a blank page in the current tab and if something is loaded into it.  If it is open and does not load, we will display it in the current tab, if not, open a new one and display it in it. <br><br>  The output will be implemented in JSON for simplicity and versatility.  The output is slightly formatted.  But it is best to install some extension that highlights JSON and allows you to treat it as a tree structure, folding and <a href="https://addons.mozilla.org/ru/firefox/addon/jsonview/">expanding</a> nodes (for example, <a href="https://addons.mozilla.org/ru/firefox/addon/jsonview/">JSONView</a> ).  After the withdrawal, just in case, we reset a huge object (if it is not paranoia). <br><br><h5>  4. BEncode parser </h5><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bdecode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">byteArray, byteIndex, isRawBytes</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (byteIndex === <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>) { byteIndex = [<span class="hljs-number"><span class="hljs-number">0</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> item = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(byteArray[byteIndex[<span class="hljs-number"><span class="hljs-number">0</span></span>]++]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(item == <span class="hljs-string"><span class="hljs-string">'d'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dic = {}; item = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(byteArray[byteIndex[<span class="hljs-number"><span class="hljs-number">0</span></span>]++]); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(item != <span class="hljs-string"><span class="hljs-string">'e'</span></span>) { byteIndex[<span class="hljs-number"><span class="hljs-number">0</span></span>]--; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> key = bdecode(byteArray, byteIndex); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (key == <span class="hljs-string"><span class="hljs-string">"pieces"</span></span>) { dic[key] = bdecode(byteArray, byteIndex, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { dic[key] = bdecode(byteArray, byteIndex); } item = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(byteArray[byteIndex[<span class="hljs-number"><span class="hljs-number">0</span></span>]++]); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dic; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(item == <span class="hljs-string"><span class="hljs-string">'l'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> list = []; item = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(byteArray[byteIndex[<span class="hljs-number"><span class="hljs-number">0</span></span>]++]); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(item != <span class="hljs-string"><span class="hljs-string">'e'</span></span>) { byteIndex[<span class="hljs-number"><span class="hljs-number">0</span></span>]--; list.push(bdecode(byteArray, byteIndex)); item = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(byteArray[byteIndex[<span class="hljs-number"><span class="hljs-number">0</span></span>]++]); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> list; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(item == <span class="hljs-string"><span class="hljs-string">'i'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> num = <span class="hljs-string"><span class="hljs-string">''</span></span>; item = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(byteArray[byteIndex[<span class="hljs-number"><span class="hljs-number">0</span></span>]++]); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(item != <span class="hljs-string"><span class="hljs-string">'e'</span></span>) { num += item; item = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(byteArray[byteIndex[<span class="hljs-number"><span class="hljs-number">0</span></span>]++]); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>(num); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-regexp"><span class="hljs-regexp">/\d/</span></span>.test(item)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> num = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-regexp"><span class="hljs-regexp">/\d/</span></span>.test(item)) { num += item; item = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(byteArray[byteIndex[<span class="hljs-number"><span class="hljs-number">0</span></span>]++]); } num = <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>(num); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> line = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isRawBytes) { byteIndex[<span class="hljs-number"><span class="hljs-number">0</span></span>] += num; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"["</span></span> + num + <span class="hljs-string"><span class="hljs-string">"]"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(num--) { line += <span class="hljs-built_in"><span class="hljs-built_in">escape</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(byteArray[byteIndex[<span class="hljs-number"><span class="hljs-number">0</span></span>]++])); } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decodeURIComponent</span></span>(line); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">unescape</span></span>(line) + <span class="hljs-string"><span class="hljs-string">" (?!)"</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre><br><br>  I took <a href="">Perl's parser as a</a> basis, tempted by its brevity and simplicity.  At first I tried to turn the typed array into a regular byte array so that it was possible to work with <code>shift</code> , but this implementation worked very slowly (probably, due to the constant reworking of a large array).  Therefore, we had to introduce an ever-increasing access index, wrapping it into an array (so that it could be passed by reference to recursion). <br><br>  The main difference from the original sample is in the block parsing lines.  First, we remove from the output a huge string with bytes containing segment hashes (it has a clear location, therefore, having reached the necessary key in parsing the associated array, we temporarily set the flag to disable encoding in a call to parse the value of this key).  Secondly, we perform some manipulations on the conversion of bytes into UTF-8 for the remaining rows.  There are dangers lurking here: sometimes the lines are not UTF-8 (for example, the popular tracker tracker.0day.kiev.ua for some reason inserts the word ‚ÄúTracker‚Äù in the ‚Äúsource‚Äù key in Windows-1251 encoding) and the decodeURIComponent crashes with an error .  Therefore, for such cases, we return the string raw view, marking it slightly.  It would be possible to delete such lines altogether, but sometimes only a piece of them causes the problem, but the main part is quite readable due to the coincidence of ASCII and the onset of UTF-8. <br><br><h4>  Iv.  Perspectives </h4><br>  On the basis of parsing and obtaining the described information, you can implement more complex tasks.  For example: <br><br>  - track the update of the torrent file to the identical address (checking the content or creation time) and notify about the reloading;  examples of such checks (regarding web pages, but everything can be easily altered) can be found <a href="http://habrahabr.ru/post/146594/">here</a> ; <br><br>  - if the file is updated, it can be automatically saved from the browser to a folder on the disk, from where it will be picked up by the torrent client (here we may be interested in the interfaces <a href="https://developer.mozilla.org/en/XPCOM_Interface_Reference/nsIFile">nsIFile</a> , <a href="https://developer.mozilla.org/en/XPCOM_Interface_Reference/nsILocalFile">nsILocalFile</a> , <a href="https://developer.mozilla.org/en/nsIFilePicker">nsIFilePicker</a> , <a href="https://developer.mozilla.org/en/nsIFileOutputStream">nsIFileOutputStream</a> , <a href="https://developer.mozilla.org/en/XPCOM_Interface_Reference/nsIBinaryOutputStream">nsIBinaryOutputStream</a> and <a href="https://developer.mozilla.org/index.php%3Ftitle%3DEn/Firefox_addons_developer_guide/Using_XPCOM%25E2%2580%2594Implementing_advanced_processes">sample code</a> ). <br><br>  - Since the latest XHR implementations support the file: // protocol, you can also view local torrent files and even client databases (like settings.dat or resume.dat) using the button, however, in the latter case there will be a lot of binary strings with crochets.  To do this, open the folder with the files in the browser and drag them to the button. <br><br><hr><br>  Promised link to install the button (if someone does not want to copy the code in parts to the initialization tab): since habraprser rewrites the link using the http protocol, you need to go <a href="http://vsemozhetbyt.ru/varia/custom_buttons.html">to this page</a> and click on the link ‚ÄúView torrent files‚Äù (of course, after installing Custom Buttons). <br><br>  I apologize if I upset someone with the incompetence of handicrafts or incorrect formulations.  I hope someone from this experience will come in handy. </div><p>Source: <a href="https://habr.com/ru/post/147630/">https://habr.com/ru/post/147630/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147622/index.html">Google spoke out against law No. 89417-6</a></li>
<li><a href="../147623/index.html">German operator opposes paid roaming</a></li>
<li><a href="../147625/index.html">New law threatens free internet</a></li>
<li><a href="../147626/index.html">Internet giants against the law on the site registry</a></li>
<li><a href="../147629/index.html">About Security Measures Taken at Blizzard, or Hello, Tree</a></li>
<li><a href="../147631/index.html">Inventarium.mobi - Do not make your users angry</a></li>
<li><a href="../147633/index.html">Animations, smooth transitions, transforms, and CSS3 gradients will be unrefined in Firefox 16</a></li>
<li><a href="../147634/index.html">Mysterious case in the New York subway</a></li>
<li><a href="../147635/index.html">Interview with the owner of the botnet</a></li>
<li><a href="../147636/index.html">Social Engineering at PHDays 2012</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>