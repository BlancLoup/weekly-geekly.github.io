<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Layer caching over Linq to SQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Over the past year we have transferred an impressive part of the DirectCRM settings to the database. Many elements of promotional campaigns, which we ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Layer caching over Linq to SQL</h1><div class="post__text post__text-html js-mediator-article">  Over the past year we have transferred an impressive part of the DirectCRM settings to the database.  Many elements of promotional campaigns, which we have previously described exclusively with the code, are now created and configured by the manager through the admin area.  This turned out to be a very complex database structure, numbering dozens of tables. <br><br>  However, I had to pay for transferring the settings to the database.  About the architecture, allowing to cache rarely changing Linq to SQL entities, look under the cat. <br><img src="https://habrastorage.org/files/bae/0fe/7a6/bae0fe7a612e4fbc91652ba4c60b9dcd.png" alt="image"><br><a name="habracut"></a><br><br>  The main unit of the system settings is a promotional campaign.  The promotional campaign includes many elements: trigger mailings, prizes and operations that a consumer can perform on the site.  Each element has a lot of settings that refer to other entities in the database.  The result is a tree with great nesting.  To pull out this tree, you need to make dozens of queries to the database, which adversely affect performance. <br>  Initially, it was clear that campaign caching would have to be attributed, but we strictly followed the first optimization rule ‚Äî not optimize until the system performance satisfies us.  But, of course, as a result, the moment came when it was impossible to live without caching. <br>  There were no questions at what point the cache should be reset - it needs to be updated whenever there is a change in the campaign or its element (since the campaign is an aggregate, there are no difficulties in implementing this logic).  But I had to think a little about the question of where to store this cache and how to reset it.  The following options were considered: <br><ul><li>  store cache in redis and clear when editing campaigns </li><li>  store the cache in Redis and, before each use, make a request to the database to check if the date of the campaign has changed </li><li>  keep the cache in the memory of the process and, before each use, make a request to the database to check if the date of the campaign has changed </li></ul><br>  The option of using Redis is attractive because it allows you to keep only one copy of the cache for all WEB servers, and not load it for each server, but in fact it saves on matches: campaigns after the end of the configuration rarely change and it doesn't matter if the cache loaded four times a day or sixteen.  Since there are no distributed transactions between Redis and the database, it is difficult to guarantee that when a campaign changes, the cache will be reset, so the first option is no longer possible. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The third option has the following advantages over the second: <br><ul><li>  To get the cache, you need to perform one request over the network instead of two. </li><li>  no need to mess around with serialization (even if all you need to do is to put DataMemberAttribute on the required fields) </li></ul><br>  In general, the problem and the general approach to the solution are clear.  Further technical details will follow. <br><br><h1>  Version 1.0 </h1><br>  In order to fully use the entities within the current DataContext that are loaded in another DataContext, they need to be cloned and tagged.  When attaching an entity is added to the IdentityMap of the current DataContext.  You cannot attach the same entity to two different DataContext (therefore, each clone can be used only in one DataContext, that is, in one business transaction).  MemberwiseClone cannot be used for cloning, since in this case there will be links to entities cloned to the DataContext in which the entity was loaded, and not to the current DataContext. <br><br>  As a result, in order to be able to use entities from the static cache, the following code was written in the base class of the repository, using Linq MetaModel and a little Reflection: <br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre><code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">public</span></span> <span class="hljs-type"><span class="hljs-type">TEntity</span></span> <span class="hljs-type"><span class="hljs-type">CloneAndAttach</span></span>(<span class="hljs-type"><span class="hljs-type">TEntity</span></span> sourceEntity) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sourceEntity == null) throw new <span class="hljs-type"><span class="hljs-type">ArgumentNullException</span></span>(<span class="hljs-string"><span class="hljs-string">"sourceEntity"</span></span>); var entityType = sourceEntity.<span class="hljs-type"><span class="hljs-type">GetType</span></span>(); var entityMetaType = <span class="hljs-type"><span class="hljs-type">GetClonningMetaType</span></span>(entityType); var entityKey = entityMetaType.<span class="hljs-type"><span class="hljs-type">GetKey</span></span>(sourceEntity); // ,           . //       . <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (attachedEntities.<span class="hljs-type"><span class="hljs-type">ContainsKey</span></span>(entityKey)) { return attachedEntities[entityKey]; } var clonedObject = <span class="hljs-type"><span class="hljs-type">Activator</span></span>.<span class="hljs-type"><span class="hljs-type">CreateInstance</span></span>(entityType); var clonedEntity = (<span class="hljs-type"><span class="hljs-type">TEntity</span></span>)clonedObject; attachedEntities.<span class="hljs-type"><span class="hljs-type">Add</span></span>(entityKey, clonedEntity); //   foreach (var dataMember <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> entityMetaType.<span class="hljs-type"><span class="hljs-type">Fields</span></span>) { var value = dataMember.<span class="hljs-type"><span class="hljs-type">StorageAccessor</span></span>.<span class="hljs-type"><span class="hljs-type">GetBoxedValue</span></span>(sourceEntity); dataMember.<span class="hljs-type"><span class="hljs-type">StorageAccessor</span></span>.<span class="hljs-type"><span class="hljs-type">SetBoxedValue</span></span>(ref clonedObject, value); } //  <span class="hljs-type"><span class="hljs-type">EntityRef'</span></span> foreach (var dataMember <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> entityMetaType.<span class="hljs-type"><span class="hljs-type">EntityRefs</span></span>) { var thisKeyValues = dataMember.<span class="hljs-type"><span class="hljs-type">Association</span></span>.<span class="hljs-type"><span class="hljs-type">ThisKey</span></span> .<span class="hljs-type"><span class="hljs-type">Select</span></span>(keyDataMember =&gt; keyDataMember.<span class="hljs-type"><span class="hljs-type">StorageAccessor</span></span>.<span class="hljs-type"><span class="hljs-type">GetBoxedValue</span></span>(sourceEntity)) .<span class="hljs-type"><span class="hljs-type">ToArray</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (thisKeyValues.<span class="hljs-type"><span class="hljs-type">All</span></span>(keyValue =&gt; keyValue == null)) { continue; } var repository = <span class="hljs-type"><span class="hljs-type">Repositories</span></span>.<span class="hljs-type"><span class="hljs-type">GetRepositoryCheckingBaseTypeFor</span></span>(dataMember.<span class="hljs-type"><span class="hljs-type">Type</span></span>); var value = repository.<span class="hljs-type"><span class="hljs-type">CloneAndAttach</span></span>(dataMember.<span class="hljs-type"><span class="hljs-type">MemberAccessor</span></span>.<span class="hljs-type"><span class="hljs-type">GetBoxedValue</span></span>(sourceEntity)); dataMember.<span class="hljs-type"><span class="hljs-type">MemberAccessor</span></span>.<span class="hljs-type"><span class="hljs-type">SetBoxedValue</span></span>(ref clonedObject, value); } //  <span class="hljs-type"><span class="hljs-type">EntitySet'</span></span> foreach (var dataMember <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> entityMetaType.<span class="hljs-type"><span class="hljs-type">EntitySets</span></span>) { var repository = <span class="hljs-type"><span class="hljs-type">Repositories</span></span> .<span class="hljs-type"><span class="hljs-type">GetRepositoryCheckingBaseTypeFor</span></span>(dataMember.<span class="hljs-type"><span class="hljs-type">Type</span></span>.<span class="hljs-type"><span class="hljs-type">GenericTypeArguments</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]); var sourceEntitySet = (<span class="hljs-type"><span class="hljs-type">IList</span></span>)dataMember.<span class="hljs-type"><span class="hljs-type">MemberAccessor</span></span>.<span class="hljs-type"><span class="hljs-type">GetBoxedValue</span></span>(sourceEntity); var clonedEntitySet = (<span class="hljs-type"><span class="hljs-type">IList</span></span>)<span class="hljs-type"><span class="hljs-type">Activator</span></span>.<span class="hljs-type"><span class="hljs-type">CreateInstance</span></span>(dataMember.<span class="hljs-type"><span class="hljs-type">Type</span></span>); foreach (var sourceItem <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sourceEntitySet) { var clonedItem = repository.<span class="hljs-type"><span class="hljs-type">CloneAndAttach</span></span>(sourceItem); clonedEntitySet.<span class="hljs-type"><span class="hljs-type">Add</span></span>(clonedItem); } dataMember.<span class="hljs-type"><span class="hljs-type">MemberAccessor</span></span>.<span class="hljs-type"><span class="hljs-type">SetBoxedValue</span></span>(ref clonedObject, clonedEntitySet); } table.<span class="hljs-type"><span class="hljs-type">Attach</span></span>(clonedEntity); return clonedEntity; } private <span class="hljs-type"><span class="hljs-type">ClonningMetaType</span></span> <span class="hljs-type"><span class="hljs-type">GetClonningMetaType</span></span>(<span class="hljs-type"><span class="hljs-type">Type</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ClonningMetaType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">; //        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ConcurrentDictionary</span></span></span><span class="hljs-class">,    </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Reflection</span></span></span><span class="hljs-class">   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clonningMetaTypes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TryGetValue</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">out</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">)) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">clonningMetaTypes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetOrAdd</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">key</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ClonningMetaType</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MetaModel</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetMetaType(key)</span></span></span><span class="hljs-class">)); } return result; } private class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ClonningMetaType</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">readonly</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MetaType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">metaType</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">readonly</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IReadOnlyCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MetaDataMember</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">keys</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ClonningMetaType</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MetaType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">metaType</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">metaType</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">metaType</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">keys</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">metaType</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataMembers</span></span></span><span class="hljs-class"> .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Where</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsPrimaryKey</span></span></span><span class="hljs-class">) .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ToArray</span></span></span><span class="hljs-class">(); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Fields</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">metaType</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataMembers</span></span></span><span class="hljs-class"> .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Where</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsPersistent</span></span></span><span class="hljs-class">) .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Where</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class"> =&gt; !</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsAssociation</span></span></span><span class="hljs-class">) .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ToArray</span></span></span><span class="hljs-class">(); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EntityRefs</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">metaType</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataMembers</span></span></span><span class="hljs-class"> .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Where</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsPersistent</span></span></span><span class="hljs-class">) .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Where</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsAssociation</span></span></span><span class="hljs-class">) .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Where</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class"> =&gt; !</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Association</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsMany</span></span></span><span class="hljs-class">) .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Where</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Member</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HasCustomAttribute</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CacheableAssociationAttribute</span></span></span><span class="hljs-class">&gt;()) .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ToArray</span></span></span><span class="hljs-class">(); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EntitySets</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">metaType</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DataMembers</span></span></span><span class="hljs-class"> .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Where</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsPersistent</span></span></span><span class="hljs-class">) .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Where</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsAssociation</span></span></span><span class="hljs-class">) .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Where</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Association</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsMany</span></span></span><span class="hljs-class">) .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Where</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Member</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HasCustomAttribute</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CacheableAssociationAttribute</span></span></span><span class="hljs-class">&gt;()) .</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ToArray</span></span></span><span class="hljs-class">(); } public </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IReadOnlyCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MetaDataMember</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Fields</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">set</span></span></span><span class="hljs-class">; } public </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IReadOnlyCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MetaDataMember</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EntityRefs</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">set</span></span></span><span class="hljs-class">; } public </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IReadOnlyCollection</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MetaDataMember</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EntitySets</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">set</span></span></span><span class="hljs-class">; } public </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ItcEntityKey</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetKey</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">entity</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ItcEntityKey</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">metaType</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">keys</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Select</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dataMember</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">StorageAccessor</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetBoxedValue(entity)</span></span></span><span class="hljs-class">).</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ToArray</span></span></span><span class="hljs-class">()); } }</span></span></code> </pre> </div></div><br>  So that when cloning, when going through the EntityRef and EntitySet, do not unload half of the database, only those that are marked with the special attribute CacheableAssociationAttribute are cloned. <br><br>  Since the cache is loaded in a separate DataContext, and cloning occurs after its Dispose, we had to write a method that loads all cached associations for the loaded entity: <br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> LoadEntityForClone(TEntity entity) { // ,      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (loadedEntities.Contains(entity)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } loadedEntities.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(entity); var entityType = entity.GetType(); var entityMetaType = GetClonningMetaType(entityType); //   EntityRef<span class="hljs-string"><span class="hljs-string">' foreach (var dataMember in entityMetaType.EntityRefs) { var repository = Repositories.GetRepositoryCheckingBaseTypeFor(dataMember.Type); var value = dataMember.MemberAccessor.GetBoxedValue(entity); if (value != null) { repository.LoadEntityForClone(value); } } //   EntitySet'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (var dataMember <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> entityMetaType.EntitySets) { var repository = Repositories .GetRepositoryCheckingBaseTypeFor(dataMember.<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>.GenericTypeArguments[<span class="hljs-number"><span class="hljs-number">0</span></span>]); var entitySet = (IList)dataMember.MemberAccessor.GetBoxedValue(entity); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (var item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> entitySet) { repository.LoadEntityForClone(item); } } }</code> </pre></div></div><br>  Of course, if you use DataLoadOptions, you will need fewer requests to load the EntityRef.  But we didn‚Äôt even think about building DataLoadOptions dynamically, because Linq to SQL has a bug that, when using DataLoadOptions to load EntitySet, the entity type incorrectly loads (the type discriminator ignores the parent type instead of the child type). <br><br>  Since we access the records in the database via the repositories, I also accessed the cache references there.  When you try to get a campaign or campaign element, the following happens: <br><ol><li>  Checks if the campaign has already been added to the current DataContext from the cache.  If so, then return an object that has already been cloned and zatattachen. </li><li>  If the campaign is not in the cache, we load it into the cache.  Otherwise, we compare the date of the last change of the campaign in the database with the date of the last change of the campaign stored in the cache, and if they are different, restart the campaign. </li><li>  We clone and attach a campaign and all its elements to the current DataContext. </li></ol><br>  With this approach, we only attach campaigns that we need and check the relevance of the cache (the date the campaign was changed) only once per transaction (once during the lifetime of the DataContext).  Since there are many methods in the repositories for retrieving campaign elements (by Id, by campaign, by unique string identifier), the cache data structure is complicated, but you can live with it. <br><br>  The new caching architecture passed all integration tests and was successfully laid out on the Production of one of the projects.  Everything worked steadily and nothing foreshadowed trouble. <br><br><h1>  Something went wrong </h1><br>  After laying out the cache for the next project, the following errors en masse fell: ‚ÄúDuplicateKeyException: cannot be an anonymous client‚Äù when the campaign attaches to the current DataContext.  The first thought: ‚ÄúWe made a mistake somewhere in our recursive cloning code and attach the same entity twice.‚Äù Turned out to be wrong.  The mistake was more conceptual. <br><br><h1>  Who is guilty </h1><br>  The code was to blame for the final project, which accessed the campaign without using the cache before attaching the same campaign from the cache.  As I wrote above, when attaching an entity is added to IdentityMap, but if before that the entity has already been loaded from the database, then it already exists in IdentiyMap and an attempt to add an entity with the same key causes an error.  Linq to SQL does not allow you to check whether an entity is in the IdentityMap before attaching.  And if you catch and ignore errors during attachments, the caching would turn out to be incomplete. <br>  There was an idea to remove from the repositories working with the cache, the ability to access the database bypassing the cache.  Besides the fact that this is far from an easy task, it would not solve the problem completely, since many non-cacheable entities have EntityRef for cached entities, and when accessing the EntityRef, the request goes past the repository. <br><br><h1>  What to do </h1><br>  There are two options for solving this problem: <br><ol><li>  Remove from cached repositories the ability to access the database bypassing the cache and remove all cached references from all non-cached entities. </li><li>  Attach the cache when creating a DataContext before any other database queries are executed. </li></ol><br><br>  The first option would require rewriting half the code.  At the same time, the resulting code would be more cumbersome, since everywhere where there was an appeal to the EntityRef, you would have to use the methods of the repositories.  So I had to stop at the second version. <br><br>  Since we attach entities when creating a DataContext, and not when accessing specific entities, we will have to explicitly specify at the beginning of the transaction which entities from the cache we need (loading the entire cache every time would be clearly redundant).  That is, the approach chosen is not universal caching;  it only allows you to fine-tune the use of the cache for individual transactions. <br><br><h1>  New architecture </h1><br>  In some of our repositories, the results of queries on Id to entities were cached for the duration of the transaction in the Dictionary.  In fact, this transaction cache can be considered our IdentityMap used on top of Linq to SQL IdentityMap.  We needed only to transfer the transaction cache to the base repository and add access methods to it not only by Id, but also in other ways.  As a result, we got a transaction cache class, when accessed by any method, each entity is loaded no more than once.  If we, for example, request an entity first by Id, and then by a unique string identifier, the second query will not be executed and the access method will return the entity from the cache. <br><br>  Since we now have a transaction cache in any repository, to support static caching, it is enough to fill in the transaction cache from the static cache while creating a DataContext, while not forgetting to clone and attach each entity.  It all looks like this: <br><img src="https://habrastorage.org/files/f80/52a/4ce/f8052a4ce6974c6090e6dc6067099eaf.png" alt="image"><br><br>  If we talk specifically about campaign caching, then loading a static cache works like this: <br><ol><li>  In the factory that creates the DataContext along with all the repositories, IQueryable is transferred from the campaigns, describing which campaigns we need. </li><li>  With one request, the Id and the date of the last change of campaigns from the transmitted IQueryable are pulled out. </li><li>  For each campaign, the pulled out date is checked against the date of this campaign in the cache and, if different, the campaign, along with all its elements, is reloaded. </li><li>  All entities pulled from the static cache are attacked and loaded into the transaction caches of the corresponding repositories. </li></ol><br><br><h1>  What's next </h1><br>  Then you can customize caching for other transactions as needed.  In addition to the static cache for campaigns, general classes were created for static caching of dictionaries, which change only when the application is displayed.  Those.  caching any entities for which you do not need to check the relevance of the cache is very easy to enable.  In the future, I want to expand this functionality by adding the ability to reset the cache after a certain time, or by simple queries in the database.  It may be possible to remake the caching of campaigns to use the standard static cache classes with the necessary settings. <br><br>  Although the resulting architecture looks slim and allows you to uniformly implement different types of caching, the need to clearly indicate what entities we need at the beginning of a transaction is not encouraging.  In addition, in order to load all entities needed in a transaction and not attach a lot of unnecessary objects to the context, you need to know the transaction structure in detail. <br><br>  There is another cache implementation that, unfortunately, cannot be implemented in Linq to SQL ‚Äî replacing the standard IdentityMap with its implementation, which, before adding an entity, tries to get it from the cache.  With this approach, a cached entity loaded in any way will be replaced with its copy from the cache, which already has all EntityRef and EntitySet loaded.  Thus, you will not need to do any subqueries to get them.  If you add an entity search in IdentityMap to the most frequently used repository methods before querying the database, the number of database queries will be drastically reduced.  At the same time, you can search for any entities in the IdentityMap, not just those for which static caching is used.  Since after receiving any entity from the database, it is replaced with its copy from IdentityMap (if it is already there), during the DataContext lifetime one cannot get two different copies of one entity, even if it was changed in another transaction (the first loaded entity will always be returned ).  Therefore, there is no point twice in requesting an entity per transaction, for example, by key, and any requests by key during the transaction can be cached by checking the IdentityMap before the request. <br><img src="https://habrastorage.org/files/bae/0fe/7a6/bae0fe7a612e4fbc91652ba4c60b9dcd.png" alt="image"><br><br>  We will try to implement this architecture after we go to the Entity Framework.  EF allows you to get entities from IdentityMap, so that at least partially the architecture can be improved. </div><p>Source: <a href="https://habr.com/ru/post/255231/">https://habr.com/ru/post/255231/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255219/index.html">"The work of engineers - to make a complaint" - Interview with Sergey Kuksenko from the Java Performance Team</a></li>
<li><a href="../255221/index.html">IO Ninja - programmable terminal emulator / sniffer (part 2)</a></li>
<li><a href="../255223/index.html">Responsive sprite animation with ImageMagick and GreenSock</a></li>
<li><a href="../255225/index.html">Interview with skype-cheater</a></li>
<li><a href="../255229/index.html">MWC-2015: applicants for the role of 5G and a number of interesting innovations</a></li>
<li><a href="../255233/index.html">14 tips on how to make tabs on the site more convenient</a></li>
<li><a href="../255235/index.html">Available fresh update ReSharper Ultimate</a></li>
<li><a href="../255237/index.html">Details about objects and classes in PHP</a></li>
<li><a href="../255239/index.html">Frame object in Python. What can and cannot be done with it (in production and in another decent place)</a></li>
<li><a href="../255241/index.html">Informer Vkontakte extension for Opera, Chrome and other browsers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>