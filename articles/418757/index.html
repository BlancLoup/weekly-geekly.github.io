<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Thinning timeframes (cryptocurrency, forex, stock exchange)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago, I was tasked to write a procedure that performs thinning out of the Forex market quotes (more precisely, timeframe data). 

 Task state...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Thinning timeframes (cryptocurrency, forex, stock exchange)</h1><div class="post__text post__text-html js-mediator-article">  Some time ago, I was tasked to write a procedure that performs thinning out of the Forex market quotes (more precisely, timeframe data). <br><br>  Task statement: data is sent to the input at 1 second intervals in this format: <br><br><ul><li>  Instrument name (USDEUR pair code, etc.), </li><li>  Date and time in unix time format, </li><li>  Open value (price of the first trade in the interval), </li><li>  High value (maximum price) </li><li>  Low value (minimum price) </li><li>  Close value (last transaction price), </li><li>  Volume (volume, or volume of the transaction). </li></ul><br>  It is necessary to provide recalculation and synchronization of data in the tables: 5 s, 15 s, 1 min, 5 min, 15 min, etc. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The described data storage format is called OHLC, or OHLCV (Open, High, Low, Close, Volume).  It is often used, and it is immediately possible to construct the ‚ÄúJapanese Candles‚Äù graph. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/by/ws/8u/byws8uaklvxydw8d2wqkqhpb1ni.png" alt="image"></div><br>  Under the cut, I described all the options that I could think of, how to thin out (enlarge) the data, for analyzing, for example, the winter jump in Bitcoin prices, and based on the data, you immediately build the ‚ÄúJapanese Candles‚Äù chart (in MS Excel, too) ).  In the picture above, this graph is built for the 1 month timeframe, for the ‚ÄúbitstampUSD‚Äù tool.  The white body of the candle means an increase in price in the interval, black - a decrease in price, the upper and lower wicks mean the maximum and minimum prices that were achieved in the interval.  Background - the volume of transactions.  It is clearly seen that in December 2017, the price came close to the 20K mark. <br><br>  The solution will be given for the two database engines, for Oracle and MS SQL, which, in some way, will make it possible to compare them on this particular task (we will not generalize the comparison to other tasks). <br><a name="habracut"></a><br>  Then I solved the problem in a trivial way: calculating the correct thinning into a temporary table and synchronizing with the target table - deleting rows that exist in the target table but do not exist in the temporary table and adding rows that exist in the temporary table but do not exist in the target table.  At that time, the Customer was satisfied with the decision, and I closed the task. <br><br>  But now I decided to consider all the options, because the above solution contains one feature - it is difficult to optimize it for two cases at once: <br><br><ul><li>  when the target table is empty and you need to add a lot of data, </li><li>  and when the target table is large and you need to add data in small chunks. </li></ul><br>  This is due to the fact that the procedure will have to connect the target table and the temporary table, and you need to join to the larger one, and not vice versa.  In the above two cases, the larger / smaller are swapped.  The optimizer will decide on the join order based on statistics, and the statistics may be outdated, and the decision may be made wrong, leading to significant performance degradation. <br><br>  In this article I will describe the methods of one-time thinning, which can be useful for readers to analyze, for example, the winter jump in the price of Bitcoin. <br><br>  Procedures for online thinning can be downloaded from github at the link at the bottom of the article. <br><br>  To the point ... My task concerned thinning from the ‚Äú1 sec‚Äù timeframe to the following, but here I consider thinning from the transaction level (in the source table, the fields STOCK_NAME, UT, ID, APRICE, AVOLUME).  Because such data gives the site bitcoincharts.com. <br>  Actually, thinning from the transaction level to the ‚Äú1 second‚Äù level is performed by such a command (the operator is easily translated into thinning from the ‚Äú1 second‚Äù level to the upper levels): <br><br>  <b>On Oracle:</b> <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID , STOCK_NAME , TRUNC_UT (UT, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, TRUNC_UT (UT, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  The <i>avg () keep (dense_rank first order by UT, ID)</i> function works like this: since the query is grouped by GROUP BY, each group is calculated independently of the others.  Within each group, the rows are sorted by UT and ID, numbered by the function <i>dense_rank</i> .  Since next is the function first, then the line is selected where <i>dense_rank</i> returned 1 (in other words, the minimum is chosen) - the first transaction is selected within the interval.  For this minimum UT, ID, if there were several lines, it would be considered an average.  But in our case there will be guaranteed one line (due to the uniqueness of the ID), so the resulting value is immediately returned as AOPEN.  It is easy to see that the <i>first</i> function replaces the two aggregate. <br><br>  <b>On MS SQL</b> <br><br>  There are no <i>first / last</i> functions (there is <i>first_value / last_value</i> , but this is not the case).  Therefore, you have to connect the table with itself. <br><br>  I will not give the request separately, but it can be viewed below in the <i>dbo.THINNING_HABR_CALC</i> procedure.  Of course, without <i>first / last,</i> it is not so elegant, but it will work. <br><br>  How can this problem be solved by one operator?  (Here, the term "one operator" means not that the operator will be one, but that there will be no cycles that "pull" the data one line at a time.) <br><br>  I will list all the options for solving this problem known to me: <br><br><ol><li>  SIMP (simple, simple, Cartesian product), </li><li>  CALC (calculate, iterative thinning of the upper levels), </li><li>  CHIN (china way, cumbersome request for all levels at once), </li><li>  UDAF (user-defined aggregate function), </li><li>  PPTF (pipelined and parallel table function, procedural solution, but with only two cursors, in fact, two SQL statements), </li><li>  MODE (model, MODEL phrase), </li><li>  and IDEA (ideal, the ideal solution that cannot work now). </li></ol><br>  Looking ahead to say that this is the rare case when the procedural solution PPTF is the most effective on Oracle. <br><br>  Download transaction files from <a href="http://api.bitcoincharts.com/v1/csv">http://api.bitcoincharts.com/v1/csv</a> <br>  I recommend choosing kraken files *.  The localbtc * files are very noisy - they contain distracting lines with unrealistic prices.  All kraken * contain about 31M transactions, I recommend to exclude krakenEUR from there, then the transaction becomes 11M.  This is the most convenient volume for testing. <br><br>  Run the script in Powershell to generate control files for SQLLDR for Oracle and to generate an import request for MSSQL. <br><br><pre> <code class="hljs mel"> # MODIFY PARAMETERS THERE $OracleConnectString = <span class="hljs-string"><span class="hljs-string">"THINNING/aaa@P-ORA11/ORCL"</span></span> # For Oracle $PathToCSV = <span class="hljs-string"><span class="hljs-string">"Z:\10"</span></span> # without trailing slash $filenames = Get-ChildItem -name *.csv Remove-Item *.ctl -ErrorAction SilentlyContinue Remove-Item *.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> -ErrorAction SilentlyContinue Remove-Item *.bad -ErrorAction SilentlyContinue Remove-Item *.dsc -ErrorAction SilentlyContinue Remove-Item LoadData-Oracle.bat -ErrorAction SilentlyContinue Remove-Item LoadData-MSSQL.sql -ErrorAction SilentlyContinue ForEach ($FilenameExt <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $Filenames) { Write-Host <span class="hljs-string"><span class="hljs-string">"Processing file: "</span></span>$FilenameExt $StockName = $FilenameExt.<span class="hljs-keyword"><span class="hljs-keyword">substring</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>, $FilenameExt.Length<span class="hljs-number"><span class="hljs-number">-5</span></span>) $FilenameCtl = <span class="hljs-string"><span class="hljs-string">'.'</span></span>+$Stockname+<span class="hljs-string"><span class="hljs-string">'.ctl'</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"OPTIONS (DIRECT=TRUE, PARALLEL=FALSE, ROWS=1000000, SKIP_INDEX_MAINTENANCE=Y)"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"UNRECOVERABLE"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"LOAD DATA"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"INFILE '.$StockName.csv'"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"BADFILE '.$StockName.bad'"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"DISCARDFILE '.$StockName.dsc'"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"INTO TABLE TRANSACTIONS_RAW"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"APPEND"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"FIELDS TERMINATED BY ','"</span></span> Add-Content -Path $FilenameCtl -Value <span class="hljs-string"><span class="hljs-string">"(ID SEQUENCE (0), STOCK_NAME constant '$StockName', UT, APRICE, AVOLUME)"</span></span> Add-Content -Path LoadData-Oracle.bat -Value <span class="hljs-string"><span class="hljs-string">"sqlldr $OracleConnectString control=$FilenameCtl"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">"insert into TRANSACTIONS_RAW (STOCK_NAME, UT, APRICE, AVOLUME)"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">"select '$StockName' as STOCK_NAME, UT, APRICE, AVOLUME"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">"from openrowset (bulk '$PathToCSV\$FilenameExt', formatfile = '$PathToCSV\format_mssql.bcp') as T1;"</span></span> Add-Content -Path LoadData-MSSQL.sql -Value <span class="hljs-string"><span class="hljs-string">""</span></span> }</code> </pre><br>  Create a transaction table on Oracle. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> TRANSACTIONS_RAW ( <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME varchar2 (<span class="hljs-number"><span class="hljs-number">32</span></span>) , UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , APRICE <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>) pctfree <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parallel</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> nologging;</code> </pre><br>  On Oracle, launch the <i>LoadData-Oracle.bat file</i> , having previously corrected the connection parameters at the beginning of the Powershell script. <br><br>  I work in a virtual machine.  Downloading all 11M transaction files in 8 kraken * files (I missed the EUR file) took about 1 minute. <br><br>  And create functions that will truncate dates to the boundaries of intervals: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> TRUNC_UT (p_UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, p_StripeTypeId <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">deterministic</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> p_StripeTypeId <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">10</span></span>) * <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">60</span></span>) * <span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">600</span></span>) * <span class="hljs-number"><span class="hljs-number">600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / <span class="hljs-number"><span class="hljs-number">3600</span></span>) * <span class="hljs-number"><span class="hljs-number">3600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / ( <span class="hljs-number"><span class="hljs-number">4</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>)) * ( <span class="hljs-number"><span class="hljs-number">4</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc (p_UT / (<span class="hljs-number"><span class="hljs-number">24</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>)) * (<span class="hljs-number"><span class="hljs-number">24</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc ((trunc (<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span> + p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span>, <span class="hljs-string"><span class="hljs-string">'Month'</span></span>) - <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span>) * <span class="hljs-number"><span class="hljs-number">86400</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> trunc ((trunc (<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span> + p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span>, <span class="hljs-string"><span class="hljs-string">'year'</span></span>) - <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span>) * <span class="hljs-number"><span class="hljs-number">86400</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> UT2DATESTR (p_UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> varchar2 <span class="hljs-keyword"><span class="hljs-keyword">deterministic</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> to_char (<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span> + p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span>, <span class="hljs-string"><span class="hljs-string">'YYYY.MM.DD HH24:MI:SS'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  Consider the options.  First, the code for all the options, then the scripts to run and test.  First, the task is described for Oracle, then for MS SQL <br><br><h4>  Option 1 - SIMP (Trivial) </h4><br>  The whole set of transactions is multiplied by a Cartesian product into a set of 10 lines with numbers from 1 to 10. This is needed to get 10 lines with dates truncated to the boundaries of 10 intervals from a single transaction line. <br><br>  After that, the lines are grouped by interval number and truncated date, and the above query is executed. <br><br>  Create a VIEW: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_SIMP_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW , (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rownum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dual <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> &lt;= <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID);</code> </pre><br><h4>  Option 2 - CALC (calculated iteratively) </h4><br>  In this case, we iteratively thin out from transactions to level 1, from level 1 to level 2, and so on. <br><br>  Create a table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> QUOTES_CALC ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME varchar2 (<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ALOW <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) <span class="hljs-comment"><span class="hljs-comment">/*partition by list (STRIPE_ID) ( partition P01 values (1) , partition P02 values (2) , partition P03 values (3) , partition P04 values (4) , partition P05 values (5) , partition P06 values (6) , partition P07 values (7) , partition P08 values (8) , partition P09 values (9) , partition P10 values (10) )*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parallel</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> pctfree <span class="hljs-number"><span class="hljs-number">0</span></span> nologging;</code> </pre><br>  You can create an index on the STRIPE_ID field, but it has been experimentally established that in the 11M transaction volume without an index it turns out to be more profitable.  For larger quantities, the situation may change.  And you can partition a table by uncommenting a block in a query. <br><br>  Create a procedure: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> THINNING_HABR_CALC_T <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rollback</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">immediate</span></span> <span class="hljs-string"><span class="hljs-string">'truncate table QUOTES_CALC'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-comment"><span class="hljs-comment">--+ append into QUOTES_CALC select 1 as STRIPE_ID , STOCK_NAME , UT , avg (APRICE) keep (dense_rank first order by ID) , max (APRICE) , min (APRICE) , avg (APRICE) keep (dense_rank last order by ID) , sum (AVOLUME) , sum (APRICE * AVOLUME) , count (*) from TRANSACTIONS_RAW a group by STOCK_NAME, UT; commit; for i in 1..9 loop insert --+ append into QUOTES_CALC select --+ parallel(4) STRIPE_ID + 1 , STOCK_NAME , TRUNC_UT (UT, i + 1) , avg (AOPEN) keep (dense_rank first order by UT) , max (AHIGH) , min (ALOW) , avg (ACLOSE) keep (dense_rank last order by UT) , sum (AVOLUME) , sum (AAMOUNT) , sum (ACOUNT) from QUOTES_CALC a where STRIPE_ID = i group by STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, i + 1); commit; end loop; end; /</span></span></code> </pre><br>  For symmetry, create a simple VIEW: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_CALC_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> QUOTES_CALC;</code> </pre><br><h4>  Option 3 - CHIN (Chinese code) </h4><br>  The method is brutal straightforward approach, and is to abandon the principle of "Do not repeat yourself."  In this case, the rejection of cycles. <br><br>  A variant is given here only for completeness. <br><br>  Looking ahead I will say that in terms of performance on this particular task, it ranks second. <br><br><div class="spoiler">  <b class="spoiler_title">Big request</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_CHIN_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T01 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, UT) , T02 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T01 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T03 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T02 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T04 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T03 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T05 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T04 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T06 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T05 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T07 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T06 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T08 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T07 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T09 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T08 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) , T10 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> UT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T09 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T01 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T02 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T03 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T04 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T05 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T06 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T07 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T08 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T09 <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T10;</code> </pre><br></div></div><br><h4>  Option 4 - UDAF </h4><br>  The variant with the User Defined Aggregated Function will not be given here, but it can be viewed on github. <br><br><h4>  Option 5 - PPTF (Pipelined and Parallel table function) </h4><br>  Create a function (in the package): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> THINNING_PPTF_P <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> TRANSACTION_RECORD_T <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-built_in"><span class="hljs-built_in">record</span></span> (STOCK_NAME varchar2(<span class="hljs-number"><span class="hljs-number">128</span></span>), UT <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, SEQ_NUM <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, APRICE <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>); type CUR_RECORD_T is ref cursor return TRANSACTION_RECORD_T; type QUOTE_T is record (STRIPE_ID number, STOCK_NAME varchar2(128), UT number , AOPEN number, AHIGH number, ALOW number, ACLOSE number, AVOLUME number , AAMOUNT number, ACOUNT number); type QUOTE_LIST_T is table of QUOTE_T; function F (p_cursor CUR_RECORD_T) return QUOTE_LIST_T pipelined order p_cursor by (STOCK_NAME, UT, SEQ_NUM) parallel_enable (partition p_cursor by hash (STOCK_NAME)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; / <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> <span class="hljs-keyword"><span class="hljs-keyword">body</span></span> THINNING_PPTF_P <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> F (p_cursor CUR_RECORD_T) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> QUOTE_LIST_T <span class="hljs-keyword"><span class="hljs-keyword">pipelined</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> p_cursor <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> (STOCK_NAME, UT, SEQ_NUM) <span class="hljs-keyword"><span class="hljs-keyword">parallel_enable</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> p_cursor <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">hash</span></span> (STOCK_NAME)) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> QuoteTail QUOTE_LIST_T := QUOTE_LIST_T() ; rec TRANSACTION_RECORD_T; rec_prev TRANSACTION_RECORD_T; type ut_T is table of number index by pls_integer; ut number; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> QuoteTail.extend(<span class="hljs-number"><span class="hljs-number">10</span></span>); loop fetch p_cursor into rec; exit when p_cursor%notfound; if rec_prev.STOCK_NAME = rec.STOCK_NAME then if (rec.STOCK_NAME = rec_prev.STOCK_NAME and rec.UT &lt; rec_prev.UT) or (rec.STOCK_NAME = rec_prev.STOCK_NAME and rec.UT = rec_prev.UT and rec.SEQ_NUM &lt; rec_prev.SEQ_NUM) then raise_application_error (-20010, 'Rowset must be ordered, ('||rec_prev.STOCK_NAME||','||rec_prev.UT||','||rec_prev.SEQ_NUM||') &gt; ('||rec.STOCK_NAME||','||rec.UT||','||rec.SEQ_NUM||')'); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if rec.STOCK_NAME &lt;&gt; rec_prev.STOCK_NAME or rec_prev.STOCK_NAME is null then for j in 1 .. 10 loop if QuoteTail(j).UT is not null then pipe row (QuoteTail(j)); QuoteTail(j) := null; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; for i in reverse 1..10 loop ut := TRUNC_UT (rec.UT, i); if QuoteTail(i).UT &lt;&gt; ut then for j in 1..i loop pipe row (QuoteTail(j)); QuoteTail(j) := null; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if QuoteTail(i).UT is null then QuoteTail(i).STRIPE_ID := i; QuoteTail(i).STOCK_NAME := rec.STOCK_NAME; QuoteTail(i).UT := ut; QuoteTail(i).AOPEN := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if rec.APRICE &lt; QuoteTail(i).ALOW or QuoteTail(i).ALOW is null then QuoteTail(i).ALOW := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if rec.APRICE &gt; QuoteTail(i).AHIGH or QuoteTail(i).AHIGH is null then QuoteTail(i).AHIGH := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; QuoteTail(i).AVOLUME := nvl (QuoteTail(i).AVOLUME, 0) + rec.AVOLUME; QuoteTail(i).AAMOUNT := nvl (QuoteTail(i).AAMOUNT, 0) + rec.AVOLUME * rec.APRICE; QuoteTail(i).ACOUNT := nvl (QuoteTail(i).ACOUNT, 0) + 1; QuoteTail(i).ACLOSE := rec.APRICE; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; rec_prev := rec; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; for j in 1 .. 10 loop if QuoteTail(j).UT is not null then pipe row (QuoteTail(j)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; exception when no_data_needed then null; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; /</code> </pre><br>  Create a VIEW: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> THINNING_HABR_PPTF_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> (THINNING_PPTF_P.F (<span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, APRICE, AVOLUME <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW)));</code> </pre><br><h4>  Option 6 - MODE (model clause) </h4><br>  The variant iteratively calculates thinning for all 10 levels by using the <i>MODEL</i> clause clause with the phrase <i>ITERATE</i> . <br><br>  The option is also impractical because it turns out to be slow.  In my environment, 1000 transactions on 8 instruments are calculated for 1 minute.  Most of the time is spent on calculating the phrase <i>MODEL</i> . <br><br>  Here I give this option only for completeness and as confirmation of the fact that almost all complex calculations on Oracle can be performed in one query, without using PL / SQL. <br><br>  One of the reasons for the poor performance of the <i>MODEL</i> phrase in this query is that the search by the criteria on the right is made for <i>each</i> rule, of which we have 6. The first two rules are calculated quite quickly, because there is direct explicit addressing, without jokers.  In the other four rules there is the word <i>any</i> - there calculations are made more slowly. <br><br>  The second difficulty is that the reference model has to be calculated.  It is necessary because the dimension list must be known <b>before</b> calculating the <i>MODEL</i> phrase; we cannot calculate new dimensions within this phrase.  Perhaps this can be circumvented with the help of two MODEL phrases, but I did not do this because of the poor performance of a large number of rules. <br><br>  I <i>‚Äôll</i> add that you could not count <i>UT_OPEN</i> and <i>UT_CLOSE</i> in the reference model, but use the same <i>avg () keep (dense_rank first / last order by)</i> functions directly in the <i>MODEL</i> phrase.  But it would have been even slower. <br>  Due to performance limitations, I will not include this option in the testing procedure. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-comment"><span class="hljs-comment">--       SOURCETRANS (STRIPE_ID, STOCK_NAME, PARENT_UT, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) as (select 1, STOCK_NAME, TRUNC_UT (UT, 2), UT , avg (APRICE) keep (dense_rank first order by ID) , max (APRICE) , min (APRICE) , avg (APRICE) keep (dense_rank last order by ID) , sum (AVOLUME) , sum (AVOLUME * APRICE) , count (*) from TRANSACTIONS_RAW where ID &lt;= 1000 --       group by STOCK_NAME, UT) --   PARENT_UT, UT  2...10    UT_OPEN, UT_CLOSE --    , REFMOD (STRIPE_ID, STOCK_NAME, PARENT_UT, UT, UT_OPEN, UT_CLOSE) as (select b.STRIPE_ID , a.STOCK_NAME , TRUNC_UT (UT, b.STRIPE_ID + 1) , TRUNC_UT (UT, b.STRIPE_ID) , min (TRUNC_UT (UT, b.STRIPE_ID - 1)) , max (TRUNC_UT (UT, b.STRIPE_ID - 1)) from SOURCETRANS a , (select rownum + 1 as STRIPE_ID from dual connect by level &lt;= 9) b group by b.STRIPE_ID , a.STOCK_NAME , TRUNC_UT (UT, b.STRIPE_ID + 1) , TRUNC_UT (UT, b.STRIPE_ID)) --        , MAINTAB as ( select STRIPE_ID, STOCK_NAME, PARENT_UT, UT, AOPEN , AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT, null, null from SOURCETRANS union all select STRIPE_ID, STOCK_NAME, PARENT_UT, UT, null , null, null, null, null, null, null, UT_OPEN, UT_CLOSE from REFMOD) select STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT from MAINTAB model return all rows --      2...10 reference RM on (select * from REFMOD) dimension by (STRIPE_ID, STOCK_NAME, UT) measures (UT_OPEN, UT_CLOSE) main MM partition by (STOCK_NAME) dimension by (STRIPE_ID, PARENT_UT, UT) measures (AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) rules iterate (9) ( AOPEN [iteration_number + 2, any, any] = AOPEN [cv (STRIPE_ID) - 1, cv (UT) , rm.UT_OPEN [cv (STRIPE_ID), cv (STOCK_NAME), cv (UT)]] , ACLOSE [iteration_number + 2, any, any] = ACLOSE [cv (STRIPE_ID) - 1, cv (UT) , rm.UT_CLOSE[cv (STRIPE_ID), cv (STOCK_NAME), cv (UT)]] , AHIGH [iteration_number + 2, any, any] = max (AHIGH)[cv (STRIPE_ID) - 1, cv (UT), any] , ALOW [iteration_number + 2, any, any] = min (ALOW)[cv (STRIPE_ID) - 1, cv (UT), any] , AVOLUME [iteration_number + 2, any, any] = sum (AVOLUME)[cv (STRIPE_ID) - 1, cv (UT), any] , AAMOUNT [iteration_number + 2, any, any] = sum (AAMOUNT)[cv (STRIPE_ID) - 1, cv (UT), any] , ACOUNT [iteration_number + 2, any, any] = sum (ACOUNT)[cv (STRIPE_ID) - 1, cv (UT), any] ) order by 1, 2, 3, 4;</span></span></code> </pre><br><h4>  Option 6 - IDEA (ideal, ideal, but inoperative) </h4><br>  The query described below would potentially be the most efficient and consume a quantity of resources equal to the theoretical minimum. <br><br>  But neither Oracle nor MS SQL allow you to write a query in this form.  I guess this is dictated by the standard. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> QUOTES_S1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID , STOCK_NAME , TRUNC_UT (UT, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">keep</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">dense_rank</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-comment"><span class="hljs-comment">-- where rownum &lt;= 100 group by STOCK_NAME, TRUNC_UT (UT, 1)) , T1 (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) as (select 1, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT from QUOTES_S1 union all select STRIPE_ID + 1 , STOCK_NAME , TRUNC_UT (UT, STRIPE_ID + 1) , avg (AOPEN) keep (dense_rank first order by UT) , max (AHIGH) , min (ALOW) , avg (ACLOSE) keep (dense_rank last order by UT) , sum (AVOLUME) , sum (AAMOUNT) , sum (ACOUNT) from T1 where STRIPE_ID &lt; 10 group by STRIPE_ID + 1, STOCK_NAME, TRUNC_UT (UT, STRIPE_ID + 1) ) select * from T1</span></span></code> </pre><br>  This query corresponds to the following part of the Oracle documentation: <br><br>  <i>If a subquery_factoring_clause refers to the query_name in the subquery that is, then it is said to be recursive.</i>  <i>A recursive subquery_factoring_clause must contain two query blocks.</i>  <i>The anchor member must appear before the reference.</i>  <i>UNION ALL, UNION, INTERSECT or MINUS.</i>  <i>You must follow the reference link query_name exactly once.</i>  <i>You must combine the recursive member with the anchor member using the UNION ALL set operator.</i> <br><br>  But contrary to the following paragraph of the documentation: <br><br>  <i>Cant keep the following elements:</i> <i><br></i>  <i>The DISTINCT keyword or a GROUP BY clause</i> <i><br></i>  <i>An aggregate function.</i>  <i>However, analytic functions are permitted in the select list.</i> <br><br>  Thus, in a recursive member, aggregates and grouping are not allowed. <br><br><h3>  Testing </h3><br><br>  Let's spend at first for <b>Oracle</b> . <br><br>  Perform the calculation procedure for the CALC method and write down the execution time: <br><br><pre> <code class="sql hljs">exec THINNING_HABR_CALC_T</code> </pre> <br>  The calculation results for the four methods are in four views: <br><br><ul><li>  THINNING_HABR_SIMP_V (will perform the calculation, causing a complex SELECT, so it will take a long time), </li><li>  THINNING_HABR_CALC_V (will display data from the QUOTES_CALC table, so it will execute quickly) </li><li>  THINNING_HABR_CHIN_V (will also perform the calculation, causing a complex SELECT, so it will take a long time), </li><li>  THINNING_HABR_PPTF_V (will perform the function THINNING_HABR_PPTF). </li></ul><br>  The execution time for all methods has already been measured by me and is shown in the table at the end of the article. <br><br>  For the rest of VIEW, we will execute queries and record the execution time: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_STRIPE_ID, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AOPEN, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ALOW , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_XXXX_V</code> </pre><br>  where XXXX is SIMP, CHIN, PPTF. <br><br>  These VIEW count set digest.  To calculate the digest, you need to fetch all the strings, and using the digest you can compare the sets with each other. <br><br>  You can also compare sets using the dbms_sqlhash package, but this is much slower, because the initial set is required to be sorted, and the calculation of the hash is not fast. <br>  Also in 12c there is a DBMS_COMPARISON package. <br><br>  You can simultaneously check the correctness of all algorithms.  We calculate the digests with such a request (with 11M records on a virtual machine, it will be relatively long, about 15 minutes): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'SIMP'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALG_NAME, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_SIMP_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'CALC'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_CALC_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'CHIN'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_CHIN_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'PPTF'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_PPTF_V a) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ALG_NAME , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_STRIPE_ID, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AOPEN, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ALOW , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> ALG_NAME;</code> </pre><br>  We see that the digests are the same, so all the algorithms gave the same results. <br><br>  Now let's reproduce all the same in <b>MS SQL</b> .  I tested on version 2016. <br><br>  Pre-create the DBTEST database, then create a transaction table in it: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> TRANSACTIONS_RAW ( STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span> (<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , APRICE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">identity</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> );</code> </pre><br>  Download the downloaded data. <br><br>  In MSSQL, create a file format_mssql.bcp: <br><br><pre> <code class="sql hljs">12.0 3 1 SQLCHAR 0 0 "," 3 UT "" 2 SQLCHAR 0 0 "," 4 APRICE "" 3 SQLCHAR 0 0 "\n" 5 AVOLUME ""</code> </pre><br>  And run the LoadData-MSSQL.sql script in SSMS (this script was generated by a single powershell script given in the section of this article for Oracle). <br><br>  Create two functions: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> TRUNC_UT (@p_UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>, @p_StripeTypeId <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> @p_StripeTypeId <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">600</span></span> * <span class="hljs-number"><span class="hljs-number">600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">3600</span></span> * <span class="hljs-number"><span class="hljs-number">3600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">14400</span></span> * <span class="hljs-number"><span class="hljs-number">14400</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> @p_UT / <span class="hljs-number"><span class="hljs-number">86400</span></span> * <span class="hljs-number"><span class="hljs-number">86400</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime), <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(m, <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (m, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, @p_UT, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime))), <span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime), <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(yy, <span class="hljs-keyword"><span class="hljs-keyword">datediff</span></span> (yy, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">second</span></span>, @p_UT, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime))), <span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; go <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> UT2DATESTR (@p_UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(s, @p_UT, <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (<span class="hljs-string"><span class="hljs-string">'1970-01-01 00:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> datetime)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; go</code> </pre><br>    : <br><br><h4>  1 ‚Äî SIMP </h4><br> : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> dbo.THINNING_HABR_SIMP_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> STRIPE_ID &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) , T2 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STRIPE_ID , STOCK_NAME , dbo.TRUNC_UT (UT, STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (<span class="hljs-number"><span class="hljs-number">1000000</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (UT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN_UT , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (<span class="hljs-number"><span class="hljs-number">1000000</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (UT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW, T1 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STRIPE_ID, STOCK_NAME, dbo.TRUNC_UT (UT, STRIPE_ID)) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.STRIPE_ID, t.STOCK_NAME, t.UT, t_op.APRICE <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN, t.AHIGH , t.ALOW, t_cl.APRICE <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE, t.AVOLUME, t.AAMOUNT, t.ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T2 t <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_op <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_op.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_UT / <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_op.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_UT % <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_op.ID) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_cl <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_cl.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_UT / <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_cl.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_UT % <span class="hljs-number"><span class="hljs-number">1000000</span></span> = t_cl.ID);</code> </pre><br>   <i>first/last</i>    . <br><br><h4>  2 ‚Äî CALC </h4><br>  ,   view: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> dbo.QUOTES_CALC ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ALOW <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> ); go <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> dbo.THINNING_HABR_CALC <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> nocount <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">truncate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> QUOTES_CALC; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @StripeId <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME , UT , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN_ID , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (APRICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE_ID , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (APRICE * AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, UT) <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> QUOTES_CALC (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>, t.STOCK_NAME, t.UT, t_op.APRICE, t.AHIGH, t.ALOW, t_cl.APRICE, t.AVOLUME, t.AAMOUNT, t.ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 t <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_op <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_op.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.UT = t_op.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_ID = t_op.ID) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> TRANSACTIONS_RAW t_cl <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_cl.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.UT = t_cl.UT <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_ID = t_cl.ID); <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @StripeId = <span class="hljs-number"><span class="hljs-number">1</span></span>; while (@StripeId &lt;= 9) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME , dbo.TRUNC_UT (UT, @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN_UT , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH , <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW , <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> QUOTES_CALC <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> STRIPE_ID = @StripeId <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, dbo.TRUNC_UT (UT, @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> QUOTES_CALC (STRIPE_ID, STOCK_NAME, UT, AOPEN, AHIGH, ALOW, ACLOSE, AVOLUME, AAMOUNT, ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>, t.STOCK_NAME, t.UT, t_op.AOPEN, t.AHIGH, t.ALOW, t_cl.ACLOSE, t.AVOLUME, t.AAMOUNT, t.ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 t <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> QUOTES_CALC t_op <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_op.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.AOPEN_UT = t_op.UT) <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> QUOTES_CALC t_cl <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (t.STOCK_NAME = t_cl.STOCK_NAME <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t.ACLOSE_UT = t_cl.UT) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> t_op.STRIPE_ID = @StripeId <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> t_cl.STRIPE_ID = @StripeId; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @StripeId = @StripeId + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; go <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> dbo.THINNING_HABR_CALC_V <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dbo.QUOTES_CALC; go</code> </pre><br>  3 (CHIN)  4 (UDAF)     MS SQL. <br><br><h4>  5 ‚Äî PPTF </h4><br>     view.     ,   parallel pipelined table function,        Oracle: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> dbo.THINNING_HABR_PPTF () <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> @rettab <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ALOW <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @i tinyint; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @tut <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_UT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_ID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_APRICE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_UT <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_ID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_APRICE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @trans_prev_AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @QuoteTail <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ( STRIPE_ID <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> clustered , STOCK_NAME <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , UT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AOPEN <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AHIGH <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) , ALOW <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) , ACLOSE <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">22</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) , AVOLUME <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , AAMOUNT <span class="hljs-built_in"><span class="hljs-built_in">numeric</span></span> (<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> , ACOUNT <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> fast_forward <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>, APRICE, AVOLUME <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> TRANSACTIONS_RAW <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>; <span class="hljs-comment"><span class="hljs-comment">-- THIS ORDERING (STOCK_NAME, UT, ID) IS MANDATORY open c; fetch next from c into @trans_STOCK_NAME, @trans_UT, @trans_ID, @trans_APRICE, @trans_AVOLUME; while @@fetch_status = 0 begin if @trans_STOCK_NAME &lt;&gt; @trans_prev_STOCK_NAME or @trans_prev_STOCK_NAME is null begin insert into @rettab select * from @QuoteTail; delete @QuoteTail; end; set @i = 10; while @i &gt;= 1 begin set @tut = dbo.TRUNC_UT (@trans_UT, @i); if @tut &lt;&gt; (select UT from @QuoteTail where STRIPE_ID = @i) begin insert into @rettab select * from @QuoteTail where STRIPE_ID &lt;= @i; delete @QuoteTail where STRIPE_ID &lt;= @i; end; if (select count (*) from @QuoteTail where STRIPE_ID = @i) = 0 begin insert into @QuoteTail (STRIPE_ID, STOCK_NAME, UT, AOPEN, AVOLUME, AAMOUNT, ACOUNT) values (@i, @trans_STOCK_NAME, @tut, @trans_APRICE, 0, 0, 0); end; update @QuoteTail set AHIGH = case when AHIGH &lt; @trans_APRICE or AHIGH is null then @trans_APRICE else AHIGH end , ALOW = case when ALOW &gt; @trans_APRICE or ALOW is null then @trans_APRICE else ALOW end , ACLOSE = @trans_APRICE, AVOLUME = AVOLUME + @trans_AVOLUME , AAMOUNT = AAMOUNT + @trans_APRICE * @trans_AVOLUME , ACOUNT = ACOUNT + 1 where STRIPE_ID = @i; set @i = @i - 1; end; set @trans_prev_STOCK_NAME = @trans_STOCK_NAME; set @trans_prev_UT = @trans_UT; set @trans_prev_ID = @trans_ID; set @trans_prev_APRICE = @trans_APRICE; set @trans_prev_AVOLUME = @trans_AVOLUME; fetch next from c into @trans_STOCK_NAME, @trans_UT, @trans_ID, @trans_APRICE, @trans_AVOLUME; end; close c; deallocate c; insert into @rettab select * from @QuoteTail; return; end go create or alter view dbo.THINNING_HABR_PPTF_V as select * from dbo.THINNING_HABR_PPTF ();</span></span></code> </pre><br>    QUOTES_CALC   CALC    : <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> exec dbo.THINNING_HABR_CALC</code> </pre><br>         view: <br><br><ul><li> THINNING_HABR_SIMP_V (  ,   SELECT,    ), </li><li> THINNING_HABR_CALC_V (    QUOTES_CALC,   ) </li><li> THINNING_HABR_PPTF_V (   THINNING_HABR_PPTF). </li></ul><br>   VIEW      : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (STRIPE_ID) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_STRIPE_ID, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (UT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_UT , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AOPEN, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ALOW , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> S_ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_XXXX_V</code> </pre> <br>  XXXX ‚Äî SIMP, PPTF. <br><br>          MS SQL.     . : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DBTEST <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'SIMP'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALG_NAME, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_SIMP_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'CALC'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_CALC_V a <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'PPTF'</span></span>, a.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> THINNING_HABR_PPTF_V a) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ALG_NAME , <span class="hljs-keyword"><span class="hljs-keyword">count</span></span> (*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (STRIPE_ID <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> STRIPE_ID , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (UT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AOPEN) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AOPEN , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AHIGH) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AHIGH, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ALOW) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ALOW, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (ACLOSE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACLOSE, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AVOLUME) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AVOLUME , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (AAMOUNT) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AAMOUNT, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span> (ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ACOUNT <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> T1 <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> ALG_NAME;</code> </pre><br>        ‚Äî      . <br><br>         , ,      MS SQL . <br><br>      MS SQL,      ,      :   : <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> clustered <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> TRANSACTIONS_RAW_I1 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> TRANSACTIONS_RAW (STOCK_NAME, UT, <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> clustered <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> QUOTES_CALC_I1 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> QUOTES_CALC (STRIPE_ID, STOCK_NAME, UT);</code> </pre><br>       , : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ss/4s/7x/ss4s7xhwteedzj1qgsjmb20hvvw.png" alt="image"></div><br>     <a href="https://github.com/yaroslavbat/thinning_habr">github</a> : Oracle,  THINNING ‚Äî   ,  THINNING_LIVE ‚Äî <i>-</i>    bitcoincharts.com  <i>-</i> (    -      5 ),    MS SQL    . <br><br> <b>:</b> <br><br>      Oracle,   MS SQL.         . <br><br>  Oracle     PPTF.     ,   .       ‚Äî     367     ( PPTF     ). <br><br>  MS SQL       (CALC). <br><br>    PPTF  Oracle  ? -    -  ‚Äî ,    parallel pipelined table function,     : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/za/ss/nl/zassnleqabvacrdkxnumjhd5mky.png" alt="image"></div></div><p>Source: <a href="https://habr.com/ru/post/418757/">https://habr.com/ru/post/418757/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../418743/index.html">The history of first place on the ML Boot Camp VI</a></li>
<li><a href="../418747/index.html">Problem Solving: how to effectively solve problems in a team?</a></li>
<li><a href="../418751/index.html">Dexp brazen chinese spy</a></li>
<li><a href="../418753/index.html">vSAN in VMware based cloud</a></li>
<li><a href="../418755/index.html">How e-commerce survive major promotions. Getting ready for peak loads on the web [Part 1]</a></li>
<li><a href="../418759/index.html">How much does it cost for a student to release a microcircuit?</a></li>
<li><a href="../418761/index.html">The book "Pure Python. Subtleties programming for pros</a></li>
<li><a href="../418763/index.html">Middle / senior: how to escape from the swamp?</a></li>
<li><a href="../418765/index.html">Tips "Dadata" help fill out any form of input. Now live</a></li>
<li><a href="../418767/index.html">A huge game heritage of Adobe Flash and my attempts to save it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>