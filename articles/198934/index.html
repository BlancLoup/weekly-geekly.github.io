<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ÄúPerfect‚Äù www cluster. Part 1. Frontend: NGINX + Keepalived (vrrp) on CentOS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this series of articles on the ‚ÄúIdeal www cluster‚Äù, I want to convey the basic basics of building a highly available and high-performance www solut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>‚ÄúPerfect‚Äù www cluster. Part 1. Frontend: NGINX + Keepalived (vrrp) on CentOS</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/6b0/bc3/b5c/6b0bc3b5c0da200f1c293792e8b0f263.jpg"><br><br>  In this series of articles on the ‚ÄúIdeal www cluster‚Äù, I want to convey the basic basics of building a highly available and high-performance www solution for web-loaded projects for an unprepared administrator. <br>  The article will contain step-by-step instructions and will suit any person who has mastered the power of copy-paste. <br>  Errors found by you will help me and those who will read this article later on!  So any improvements and edits are welcome! <br><br>  <b>I want to note that this instruction was born in the process of migration of <a href="http://habrahabr.ru/company/acronis/">Acronis</a> web-systems to a high-available cluster.</b>  <b>I hope my notes will be useful for you !.</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the process of examination and the research I conducted, she proved her right to life and safely serves us faithfully day by day. <br><br><h4>  On the frontend, we will use a bundle of two services: </h4><br><br><blockquote>  <b>keepalived</b> - implementations of VRRP (Virtual Router Redundancy Protocol) for Linux.  The keepalived daemon monitors the operability of machines and, in the event of a failure detection, eliminates the failed server from the list of active servers, delegating its addresses to another server. <br><br>  In other words, we have 2 servers on which one public address is registered.  If any of these servers falls, then the address of the fallen is picked up by the second. <br>  The keepalived daemons communicate via VRRP protocol, sending each other messages to the address 224.0.0.18. <br>  If the neighbor has not sent his message, then after the expiration of the period he is considered dead and both addresses are serviced by the remaining node.  As soon as the fallen server starts sending its messages to the network, everything returns to its place. </blockquote><br><br><blockquote>  <b>nginx</b> [engine x] is an HTTP server and reverse proxy server, as well as a mail proxy server, written by Igor Sysoev.  For a long time, it has served the servers of many high-loaded Russian sites, such as Yandex, Mail.Ru, VKontakte and Rambler.  According to Netcraft statistics, nginx served or proxied 15.08% of the most loaded sites in October 2013. <br><br>  <b>Basic HTTP server functionality</b> <br><br><ul><li>  Maintenance of static queries, index files, automatic creation of a list of files, open file descriptor cache; </li><li>  Accelerated reverse proxying with caching, simple load balancing and fault tolerance; </li><li>  Accelerated support for FastCGI, uwsgi, SCGI and memcached servers with caching, simple load balancing and fault tolerance; </li><li>  Modularity, filters, including compression (gzip), byte-ranges (resume), chunked answers, XSLT-filter, SSI-filter, image conversion;  multiple subqueries on the same page, processed in the SSI filter through a proxy or FastCGI, are executed in parallel; </li><li>  SSL support and TLS SNI extensions. </li></ul><br><br>  <b>Other HTTP Server Features</b> <br><br><ul><li>  Virtual servers, defined by IP-address and name; </li><li>  Support for keep-alive and pipelined connections; </li><li>  Configuration flexibility; </li><li>  Changing the settings and updating the executable file without interrupting customer service; </li><li>  Setting log formats, buffered logging, fast log rotation; </li><li>  Special pages for 3xx-5xx errors; </li><li>  rewrite module: changing URI using regular expressions; </li><li>  Perform different functions depending on the client‚Äôs address; </li><li>  Access restriction depending on the client's address, password (HTTP Basic authentication) and the result of the subquery; </li><li>  HTTP referer check; </li><li>  Methods PUT, DELETE, MKCOL, COPY and MOVE; </li><li>  FLV and MP4 streaming; </li><li>  Limit the speed of response; </li><li>  Limiting the number of simultaneous connections and requests from one address; </li><li>  Embedded Perl. </li></ul><br></blockquote><br><a name="habracut"></a><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ddd/e09/706/ddde097064300e85825003790560ad7f.png"><br><br>  <b>Important!</b>  For the solution below, we should have 2 network interfaces on each of the keepalived nodes <br>  we have to accurately indicate our mask and understand where broadcast is in our network, if we don‚Äôt do this, we will try for a very long time to understand why things are not working as we want! <br><br>  <b># My private network</b> <b><br></b>  <b>[root @ nginx-frontend-01 ~] #</b> <br><br><pre><code class="bash hljs">nano /etc/sysconfig/network-scripts/ifcfg-eth2</code> </pre> <br><br><pre> <code class="bash hljs">DEVICE=eth2 BOOTPROTO=static ONBOOT=yes IPADDR=10.100.100.56 NETWORK=10.100.100.0 NETMASK=255.255.255.0 BROADCAST=10.100.100.255</code> </pre><br><br>  <b># Public network</b> <b><br></b>  <b>[root @ nginx-frontend-01 ~] #</b> <br><br><pre> <code class="bash hljs"> nano /etc/sysconfig/network-scripts/ifcfg-eth3</code> </pre> <br><br><pre> <code class="bash hljs">DEVICE=eth3 BOOTPROTO=static ONBOOT=yes IPADDR=72.xx1 NETMASK=255.255.255.248 BROADCAST=72.xx55 GATEWAY=72.xx49</code> </pre><br><br>  <b>That is, in my public network, mask / 29 and it means my broadcast xxx55, if there was a network / 24, then you could specify xxx255</b> <b><br></b>  <b>If you mix it up, then you get a bunch of problems</b> <br><br>  <b># Set keepalived</b> <br><pre> <code class="bash hljs">yum install keepalived -y</code> </pre> <br><br>  <b># This is very bad, this is not necessary!</b>  <b>only for testing purposes and at your own risk, I warned.</b>  <b>Turn off selinux</b> <br><pre> <code class="bash hljs">sed -i <span class="hljs-string"><span class="hljs-string">'s/SELINUX=enforcing/SELINUX=disabled/g'</span></span> /etc/sysconfig/selinux</code> </pre> <br><br>  <b># We set up keepalived on the first nginx-frontend-01 node, it is very important, the comment sign "!"</b>  <b>but not "#"</b> <br><br><pre> <code class="bash hljs">mv /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.old &amp;&amp; nano /etc/keepalived/keepalived.conf</code> </pre> <br><br>  <b>[root @ nginx-frontend-01 ~] #</b> <br><br><pre> <code class="bash hljs"> nano /etc/keepalived/keepalived.conf</code> </pre> <br><br><pre> <code class="bash hljs">! Configuration File <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> keepalived global_defs { notification_email { root@localhost } notification_email_from root@localhost smtp_server localhost smtp_connect_timeout 30 !     router_id nginx-frontend-01 } vrrp_instance nginx2 { !     ,      state BACKUP !    interface eth3 ! ,   vrrp_instance     virtual_router_id 102 !      ,  BACKUP        MASTER priority 100 advert_int 1 dont_track_primary !        broadcast mcast_src_ip xxx55 !    ,     authentication { auth_type PASS auth_pass b65495f9 } !     ,  MASTER    virtual_ipaddress { xxx2/29 dev eth3 } } vrrp_instance nginx1 { !   - ,          ,    state MASTER !    interface eth3 ! ,   vrrp_instance     virtual_router_id 101 !         backup priority 200 advert_int 1 dont_track_primary !        broadcast mcast_src_ip xxx55 !    ,     authentication { auth_type PASS auth_pass b65495f8 } virtual_ipaddress { !     ,    ,     xxx1/29 dev eth3 } !     gateway virtual_routes { default via xxx49 dev eth3 metric 2 } }</code> </pre><br><br>  <b># Configuring keepalived on the second nginx-frontend-02 node is very important, the comment sign "!"</b>  <b>but not "#"</b> <br><br><pre> <code class="bash hljs">mv /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.old &amp;&amp; nano /etc/keepalived/keepalived.conf</code> </pre> <br><br>  <b>[root @ nginx-frontend-02 ~] #</b> <br><br><pre> <code class="bash hljs">nano /etc/keepalived/keepalived.conf</code> </pre> <br><br><pre> <code class="bash hljs">! Configuration File <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> keepalived global_defs { notification_email { root@localhost } notification_email_from root@localhost smtp_server localhost smtp_connect_timeout 30 !     router_id nginx-frontend-02 } vrrp_instance nginx1 { !     ,      state BACKUP !    interface eth3 ! ,   vrrp_instance     virtual_router_id 101 !      ,  BACKUP        MASTER priority 100 advert_int 1 dont_track_primary !        broadcast mcast_src_ip xxx55 !    ,     authentication { auth_type PASS auth_pass b65495f9 } !     ,  MASTER    virtual_ipaddress { xxx1/29 dev eth3 } } vrrp_instance nginx2 { !   - ,          ,    state MASTER !    interface eth3 ! ,   vrrp_instance     virtual_router_id 102 !         backup priority 200 advert_int 1 dont_track_primary !        broadcast mcast_src_ip xxx55 !    ,     authentication { auth_type PASS auth_pass b65495f9 } !     ,    ,     virtual_ipaddress { xxx2/29 dev eth3 } virtual_routes { !     gateway default via xxx49 dev eth3 metric 2 } }</code> </pre><br><br>  <b># Add to startup and run</b> <br><br><pre> <code class="bash hljs"> chkconfig keepalived on &amp;&amp; service keepalived restart</code> </pre> <br><br>  <b># Add permissions to the firewall, more than half of the problems, due to the fact that we forget about the firewall!</b> <br><br><pre> <code class="bash hljs">iptables -A INPUT -i eth3 -p vrrp -j ACCEPT iptables -A OUTPUT -o eth3 -p vrrp -j ACCEPT iptables -A INPUT -d 224.0.0.0/8 -i eth3 -j ACCEPT iptables-save &gt; /etc/sysconfig/iptables</code> </pre> <br><br>  <b># This is a very important step.</b> <b><br></b>  <b>Setting this variable allows individual local processes to act on behalf of an external (foreign) IP address.</b> <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"net.ipv4.ip_nonlocal_bind=1"</span></span> &gt;&gt; /etc/sysctl.conf &amp;&amp; sysctl -p</code> </pre> <br><br>  <b># Check</b> <br><br><pre> <code class="bash hljs">/etc/init.d/keepalived restart &amp;&amp; tail -f -n 100 /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/messages</code> </pre> <br><br>  <b># Check how our keepalived nodes communicate with each other</b> <pre> <code class="bash hljs"> tcpdump -vvv -n -i eth3 host 224.0.0.18</code> </pre> <br><br>  <b># We need to see it</b> <br><br><pre> <code class="bash hljs">xxx55 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 102, prio 200, authtype simple, intvl 1s, length 20, addrs: xxx2 auth <span class="hljs-string"><span class="hljs-string">"b65495f9"</span></span> 07:50:50.019548 IP (tos 0xc0, ttl 255, id 5069, offset 0, flags [none], proto VRRP (112), length 40) xxx55 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 101, prio 200, authtype simple, intvl 1s, length 20, addrs: xxx1 auth <span class="hljs-string"><span class="hljs-string">"b65495f9"</span></span></code> </pre><br><br>  <b>Now you can turn off the servers alternately, lower interfaces, pull wires, etc.</b> <b><br></b>  <b>We will always have both of these addresses on the network and our nginx will respond to them.</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1e2/a62/af4/1e2a62af4e7b9eb0480ef57d0224ef18.png"><br><br>  <b># We are connecting the official nginx repository for CentOS 6</b> <br><pre> <code class="bash hljs">rpm -Uhv http://nginx.org/packages/rhel/6/noarch/RPMS/nginx-release-rhel-6-0.el6.ngx.noarch.rpm</code> </pre> <br><br>  <b># Update the system and install nginx</b> <br><br><pre> <code class="bash hljs">yum update -y yum install nginx</code> </pre> <br><br>  <b># Remove hosts by default, by default there is a standard nginx greeting</b> <br><br><pre> <code class="bash hljs">rm -f /etc/nginx/conf.d/default.conf rm -f /etc/nginx/conf.d/virtual.conf rm -f /etc/nginx/conf.d/ssl.conf</code> </pre> <br><br>  <b># We bring the main config to a similar look</b> <br><br><pre> <code class="bash hljs"> mv /etc/nginx/nginx.conf /etc/nginx/nginx.conf.old nano /etc/nginx/nginx.conf</code> </pre> <br><br><pre> <code class="bash hljs">user nginx; <span class="hljs-comment"><span class="hljs-comment">#     worker_processes 10; pid /var/run/nginx.pid; events { #      worker_connections 1024; # epoll ‚Äî  ,   Linux 2.6+ http://nginx.org/ru/docs/events.html use epoll; #            multi_accept on; } error_log /var/log/nginx/error.log warn; http { include /etc/nginx/mime.types; default_type application/octet-stream; log_format main '$remote_addr - $remote_user [$time_local] "$request" ' '$status $body_bytes_sent "$http_referer" ' '"$http_user_agent" "$http_x_forwarded_for"'; access_log /var/log/nginx/access.log main; connection_pool_size 256; client_header_buffer_size 4k; client_max_body_size 100m; large_client_header_buffers 8 8k; request_pool_size 4k; output_buffers 1 32k; postpone_output 1460; #     gzip gzip on; gzip_min_length 1024; gzip_proxied any; gzip_proxied expired no-cache no-store private auth; gzip_types text/plain text/xml application/xml application/x-javascript text/javascript text/css text/json; gzip_comp_level 5; gzip_disable "MSIE [1-6]\.(?!.*SV1)"; sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 75 20; server_names_hash_max_size 8192; ignore_invalid_headers on; server_name_in_redirect off; proxy_buffer_size 8k; proxy_buffers 8 64k; proxy_connect_timeout 1000; proxy_read_timeout 12000; proxy_send_timeout 12000; #      ,        proxy_cache_path /var/cache/nginx levels=2 keys_zone=pagecache:5m inactive=10m max_size=50m; #  backend     mod_rpaf real_ip_header X-Real-IP; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; allow all; include /etc/nginx/conf.d/*.conf; }</span></span></code> </pre><br><br>  <b># Now we put in order our universal vhost</b> <br><br><pre> <code class="bash hljs">nano /etc/nginx/conf.d/all.conf</code> </pre> <br><br><pre> <code class="bash hljs">upstream web { <span class="hljs-comment"><span class="hljs-comment">#   backend   nginx   ,   fail   backend    # back01 server 10.211.77.131 weight=10 max_fails=60 fail_timeout=2s; # back02 server 10.211.77.136 weight=10 max_fails=60 fail_timeout=2s; } server { listen 80; location / { proxy_pass http://web; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; } }</span></span></code> </pre><br><br>  <b># And our config for SSL site operation, for each site there must be a config file with its certificate</b> <br><br><pre> <code class="bash hljs"> nano /etc/nginx/conf.d/ssl.conf</code> </pre> <br><br><pre> <code class="bash hljs">upstream ssl { <span class="hljs-comment"><span class="hljs-comment"># back01 # server 10.211.77.131 weight=10 max_fails=60 fail_timeout=2s; # back02 server 10.100.100.63 weight=10 max_fails=60 fail_timeout=2s; } server { listen 443; ssl on; ssl_certificate /etc/nginx/ssl/GeoTrustCA.crt; ssl_certificate_key /etc/nginx/ssl/GeoTrustCA.key; #    SSL  ssl_ciphers RC4:HIGH:!aNULL:!MD5:!kEDH; ssl_session_cache shared:SSL:10m; ssl_prefer_server_ciphers on; ssl_protocols SSLv3 TLSv1; location / { proxy_pass http://ssl; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; } }</span></span></code> </pre> <br><br>  <b># Run nginx and add it to autoload!</b> <br><br><pre> <code class="bash hljs"> /etc/init.d/nginx start &amp;&amp; chkconfig nginx on</code> </pre> <br><br><h4>  To be continued, thank you for your attention! </h4></div><p>Source: <a href="https://habr.com/ru/post/198934/">https://habr.com/ru/post/198934/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../198920/index.html">DARPA begins developing computer security systems capable of independently finding and fixing vulnerabilities</a></li>
<li><a href="../198924/index.html">LinkMeUp. Release 8. IB - Best Practices and Pentesting Laboratories</a></li>
<li><a href="../198928/index.html">How to get an American diploma from higher education</a></li>
<li><a href="../198930/index.html">Pivotal Tracker as a tool in Waterfall development</a></li>
<li><a href="../198932/index.html">About startups based on personal experience</a></li>
<li><a href="../198936/index.html">12 basic principles of NUI design</a></li>
<li><a href="../198938/index.html">FindBugs vs CDK</a></li>
<li><a href="../198942/index.html">Several interesting and useful things for a web developer (release 6)</a></li>
<li><a href="../198954/index.html">Creating a Live Account widget using PHP Web Sockets</a></li>
<li><a href="../198956/index.html">New product Linkedin Intro: convenience or surveillance of users?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>