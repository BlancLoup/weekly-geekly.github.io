<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Free CRC error monitoring</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Often, unpleasant things such as an increase in the number of errors on ports and an increase in signal attenuation on sfp modules occur on storage ne...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Free CRC error monitoring</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/355/8bc/2fe/3558bc2fe77143b38878e5ad3dbfaa97.png" alt="image"><br><br>  Often, unpleasant things such as an increase in the number of errors on ports and an increase in signal attenuation on sfp modules occur on storage networks.  Taking into account the high level of reliability of the SAN infrastructure consisting of two or more factories, the likelihood of an emergency is not so great, but the overlap of negative factors can lead to data loss or performance degradation.  For example, imagine a situation: FOS is updated at one of the factories, everything works through a second factory, and between the switchboard to which the disk array is connected and the switchboard to which the servers are connected, the CRC error at one of the trunk ports starts to grow rapidly.  Or even worse, the link disappears due to a decrease in the signal level caused by an increase in the temperature of the SFP module, which in turn has increased due to the increased utilization of this channel.  In such cases, they usually say: "Well, who knew" or "100% reliable systems do not exist" and so on. <br><a name="habracut"></a><br><h4>  Literate architecture + proper monitoring = fault tolerance </h4><br>  So the problem is indicated, it is necessary to develop a set of measures to improve the resiliency of the storage network, it can be divided into two stages: <br><br><ul><li>  Bringing the storage network architecture to ‚ÄúSAN best practices‚Äù </li><li>  monitoring system deployment </li></ul><br>  If there is a lot of literature and training courses about the SAN best practices, and you can invite tough experts from the integrator to conduct an examination, then choosing the right way to create a good SAN monitoring system is not so easy.  This can be explained by a tight binding: software developer - manufacturer of switches.  Of course, I don‚Äôt want to say that Cisco Fabric Manager or Brocade Network Advisor are bad, but they don‚Äôt allow me to do everything that is necessary in my opinion to increase the resiliency of the SAN network. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  What to do </h4><br>  And so, the task has been set, it is necessary to find a solution, often it can be complicated by the lack of money in the budget for this year, or the integrator‚Äôs lack of information about the existence of suitable software, but this is not a problem because  All the necessary components are freely available and all that is required is to make it all work. <br>  Let us analyze the implementation of CRC error monitoring on brocade switch SAN ports, most of the other parameters can be monitored in the same way. <br><br><h5>  Step one, data collection protocol </h5><br>  Information about the number of CRC errors can be obtained from the switches in different ways (snmp, https, telnet and ssh). My choice fell on the latter.  telnet is not secure and it is better to disable it, https is difficult to extract specific values, and the snmp tree can change significantly both on different switches and when switching to the new FOS. <br><br><h5>  Step two, data collection method </h5><br>  To work with ssh, linux is best adapted in conjunction with bash + expect; this method can be used to connect via ssh with interactive command entry. <br><br><h5>  Step three, where to store </h5><br>  There is no big difference, you can store it even in text files, but we will look at an example with mysql.  All monitoring is implemented in two scripts: <br><br>  porterrshow.sh - collecting information and searching for the increment of CRC error values <br>  expect.tcl - ssh connection <br><br>  and three txt files: <br>  temp.txt - data buffer <br>  switches.txt - a list of san switches in the format login name password on each line <br>  crc.txt - report on CRC errors found <br><br>  The Select query looks for an increment in the growth of CRC errors compared to the data received one hour ago, respectively, the script must be run once per hour, and the script must begin and finish its work at the same hour.  This limitation can be easily circumvented by entering the sequence number field of the script launch, or losing performance and setting a more complicated condition for sampling time values.  The expect, mysql and ssh client packages must be installed on the server.  The dbname database must contain a user user with read and write permissions to the table tablename.  In the table tablename we get data similar to the output of the porterrshow command on the switch + date and time. <br><br>  porterrshow.sh <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash rm /var/scripts/temp.txt #   temp.txt while read line #    switches.txt do read sw user pass &lt;&lt;&lt; $line #    n=0 #  while read line; #    expect.tcl do array[n]="$line"; n=$[n+1]; #     expect.tcl done &lt; &lt;(/var/scripts/expect.tcl $sw $user $pass porterrshow) #    if echo ${array[4]} | grep -q '='; #        then k=5; else k=4; fi; for i in `seq $k $[n-1]`; #     do read a1 a2 a3 a4 a5 a6 a7 a8 a9 a10 a11 a12 a13 a14 a15 a16 a17 a18 a19 &lt;&lt;&lt; ${array[i]}; #    (echo $sw,${a1%:},`date +%F`,`date +%T`,$a2,$a3,$a4,$a5,$a6,$a7,$a8,$a9,$a10,$a11,$a12,$a13,$a14,$a15,$a16,$a17) &gt;&gt; temp.txt #   done; done &lt; /var/scripts/switches.txt #     mysql -uuser -ppass dbname &lt;&lt; EOF; LOAD DATA LOCAL INFILE "temp.txt" INTO TABLE tablename FIELDS TERMINATED BY ','; EOF #    (mysql -uuser -ppass dbname &lt;&lt; EOF select new.switch, new.port, new.crcerr-old.crcerr from tablename new, tablename old where new.switch=old.switch and new.port=old.port and new.date=old.date and new.crcerr!=old.crcerr and new.crcerr!=0 and new.date=curdate() and hour(new.time)=hour(now()) and hour(old.time)=hour(now())-1; EOF ) &gt; /var/scripts/crc.txt #  CRC        if grep -q 'switch' /var/scripts/crc.txt then cat /var/scripts/crc.txt | mailx -r SAN_Switch_CRC_Tester -s "CRC errors is increased" sanadmin1@mywork.com fi #  </span></span></code> </pre> <br>  expect.tcl <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/expect #   10  set timeout 10 #     if {$argc != 4} { puts "Usage $argv0 host user pass command" exit 1} #   set host [lindex $argv 0] set user [lindex $argv 1] set pass [lindex $argv 2] set command [lindex $argv 3] #   SSH spawn ssh -oStrictHostKeyChecking=no -oCheckHostIP=no $user@$host $command expect *assword: send "$pass\r" expect eof</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/281432/">https://habr.com/ru/post/281432/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../281420/index.html">Y. Gagarin and Web Audio API from Yandex</a></li>
<li><a href="../281422/index.html">Social inequality and salaries of officials</a></li>
<li><a href="../281424/index.html">Intel RealSense Technology in Ombre Fabula Gesture Management</a></li>
<li><a href="../281428/index.html">Unity3d WebGL - Twelve Issues When Building a Project</a></li>
<li><a href="../281430/index.html">Software for testing and adjusting devices and networks based on MODBUS</a></li>
<li><a href="../281434/index.html">Deploying Red Hat in Microsoft Azure Cloud</a></li>
<li><a href="../281436/index.html">Developers from Google offered a consortium of WWW draft WebUSB - protocol for USB devices with web pages</a></li>
<li><a href="../281438/index.html">Payment EMV card. Payment security mechanisms</a></li>
<li><a href="../281439/index.html">New contests for PHDays VI: we break hydroelectric power station and smart home</a></li>
<li><a href="../281441/index.html">Vostok-1 spacecraft in 3D - render in Blender</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>