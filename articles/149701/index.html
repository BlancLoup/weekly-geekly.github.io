<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multi-threaded file uploader on JS (jQuery)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, colleagues. In this article I will describe the experience of creating a multi-threaded file loader (with limited server load) on JS (jQuery...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multi-threaded file uploader on JS (jQuery)</h1><div class="post__text post__text-html js-mediator-article">  Good day, colleagues.  In this article I will describe the experience of creating a multi-threaded file loader (with limited server load) on JS (jQuery). <br><br>  Most recently, I had a task (the solution to which I want to share with you): to do, in the admin area, the ability to select and download more than one file at a time.  The task seems to be trivial and not difficult, but in the end my solution seemed rather interesting to me, since no analogues were found. <br><a name="habracut"></a><br><h5>  Decision number 1 </h5><br>  Since the task was simple, and, naturally, there are plenty of solutions already written, I turned to Google for help.  But, the search for positive results did not work - most of the proposed solutions use Flash (which, due to some specifics, did not allow me to use such solutions) or the written libraries on JS were very huge and, most regrettably, non-working.  I had to collect the bike. <br><br><h5>  Decision number 2 </h5><br>  The task was urgent, so an urgent solution was needed.  Not for a long time, I think I screwed the <i>multiple</i> attribute to the field (available with HTML5). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'FilesupLoadForm'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'file'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'fileinput'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'files'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiple</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"multiple"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'upload'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  This was followed by small changes in the handler to receive not one file, but an array of files - and the problem is solved!  (naivety (inexperience) of mine was not chapel). <br>  How many people, with a laugh, have already thought that five hundred thirds answered the first, normal, batch of nginx files.  We had to think further. <br><br><h5>  Decision number 3 </h5><br>  Since the past decision was made beautifully and conveniently for admins, it was decided to build on it.  It was necessary to solve the problem of error number 503, which was returned by nginx due to lengthy file processing. <br>  Half a minute of thinking and a new solution appears: we will send ajax not all the files at once, but one at a time. <br><br>  The solution, approximately, was as follows: <br><br><pre> <code class="javascript hljs">jQuery.each($(<span class="hljs-string"><span class="hljs-string">'#fileinput'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].files, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i, f</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> file = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FormData(); file.append(<span class="hljs-string"><span class="hljs-string">'file'</span></span>, f); $.ajax({ <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">'uploader.php'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: file, <span class="hljs-attr"><span class="hljs-attr">async</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">contentType</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">processData</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">dataType</span></span>: <span class="hljs-string"><span class="hljs-string">"JSON"</span></span>, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-attr"><span class="hljs-attr">beforeSend</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{}, <span class="hljs-attr"><span class="hljs-attr">complete</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event, request, settings</span></span></span><span class="hljs-function">) </span></span>{}, <span class="hljs-attr"><span class="hljs-attr">success</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">)</span></span>{ } }); });</code> </pre><br><br>  It's simple: we iterate over the array of files (which is in the right input), create an instance of the class for working with files (more on that later) and send the request to the server as ajax.  It is worth paying attention to the " <i>async: false</i> " parameter - here we set the synchronous execution of the ajax request, since the asynchronous will create us a lot of requests to the server, which we can easily set it with. <br>  The solution works, there is no error, but here‚Äôs one problem ‚Äî it works slowly.  And then I came up with the idea of ‚Äã‚Äãanother solution to the problem. <br><br><h5>  Decision number 4 </h5><br>  To speed up the upload of files to the server, you can increase the number of requests in which files will be transferred.  Such a decision to rest on the solution of two problems: <br>  1). With a large number of requests I quickly go to hell with my server. <br>  2) A large amount of simultaneously uploaded files will score us the whole channel. <br>  Judging by the problems, our bootloader should count the number of running requests and the amount of data transferred and, under certain conditions, expect the end of some requests to start others. <br>  Proceed to the code: <br><br><pre> <code class="javascript hljs"> FilesUploader = { <span class="hljs-attr"><span class="hljs-attr">dataArr</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(), <span class="hljs-attr"><span class="hljs-attr">fStek</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(), <span class="hljs-attr"><span class="hljs-attr">vStek</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">deley</span></span> : <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-attr"><span class="hljs-attr">debug</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">maxFilesSize</span></span> : <span class="hljs-number"><span class="hljs-number">1024</span></span>*<span class="hljs-number"><span class="hljs-number">1024</span></span>*<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">maxThreads</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>,</code> </pre><br><br>  Legend: <br>  <i>dataArr</i> - an array of data to send. <br>  <i>fStek</i> - write timeout identifiers here to further stop recursion and clear memory of incomplete functions. <br>  <i>vStek</i> - the number of threads <i>invoked</i> . <br>  <i>deley</i> - recursion delay of the function that checks threads and volumes. <br>  <i>debug</i> - debaby mode.  It is necessary for debugging, but in this example I deleted all its signs. <br>  <i>maxFilesSize</i> - the maximum amount of downloaded files <br>  <i>maxThreads</i> - the maximum number of threads. <br><br>  Full clarity in the variables (especially <i>fStek</i> and <i>deley</i> ) will be introduced by the second considered function <i>FilesUploader.controller ()</i> .  For now, let's move on to class initialization: <br><br><pre> <code class="javascript hljs"> run : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ jQuery.each($(<span class="hljs-string"><span class="hljs-string">'#fileinput'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].files, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i, f</span></span></span><span class="hljs-function">) </span></span>{ FilesUploader.dataArr.push(f); }); FilesUploader.controller(); },</code> </pre><br><br>  This is the function that handles the event of a click of a button in the form.  The work of the function is simple: we run through the files ( <i>jQuery.each</i> ) entered in the input and add ( <i>FilesUploader.dataArr.push (f)</i> ) record about each to the array.  Next, call the controller, which is the most important and most complex part of the system: <br><br><pre> <code class="javascript hljs"> controller : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ FilesUploader.fStek.push(setTimeout(FilesUploader.controller, FilesUploader.deley)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(FilesUploader.vStek&gt;=<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.maxThreads) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } item = FilesUploader.dataArr.pop(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(item) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(FilesUploader.maxFilesSize-item.size &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { FilesUploader.dataArr.push(item); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } FilesUploader.maxFilesSize-=item.size; FilesUploader.vStek++; FilesUploader.worker(item); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> clearTimeout(FilesUploader.fStek.pop()); },</code> </pre><br><br>  In the first line of the function, we asynchronously call (after a certain period of time) the same function (ie, create recursion), and put the identifier of the called function into a variable to be able to interrupt its execution. <br>  Next comes the condition for checking threads. <br>  After getting the file from the array ( <i>FilesUploader.dataArr.pop ()</i> ), we check it for the presence. <br>  1. If there is no file, then we ‚Äúkill‚Äù the called functions by their identifier ( <i>clearTimeout (FilesUploader.fStek.pop ())</i> ); <br>  2. If the file exists, we do a check for the size of the loaded files, and if it is exceeded, we return the file back to the stack and exit the function, otherwise, if it is not exceeded: we take the volume, increase the counter of the started threads and call the following function ( <i>FilesUploader.worker ( item)</i> ). <br><br><pre> <code class="javascript hljs">worker : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> file = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FormData(); file.append(<span class="hljs-string"><span class="hljs-string">'file'</span></span>, item); $.ajax({ <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">'uploader.php'</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: file, <span class="hljs-attr"><span class="hljs-attr">contentType</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">processData</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">dataType</span></span>: <span class="hljs-string"><span class="hljs-string">"JSON"</span></span>, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-attr"><span class="hljs-attr">beforeSend</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{}, <span class="hljs-attr"><span class="hljs-attr">complete</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event, request, settings</span></span></span><span class="hljs-function">) </span></span>{ FilesUploader.maxFilesSize+=<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fileData.size; FilesUploader.vStek--; }, <span class="hljs-attr"><span class="hljs-attr">success</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">)</span></span>{ } }); },</code> </pre><br><br>  To send a file to the server using ajax, you need to put data about the file (file.append ()) into an instance of the FormData class. <br>  Next, we call the <i>$ .ajax</i> function, which will transfer our file to the loader on the server.  Upon completion of each request (the complete () function), you need to increase the allowable volume and reduce the number of executable threads (which is done in the ‚Äú <i>FilesUploader.maxFilesSize + = this.fileData.size</i> ‚Äù and ‚Äú <i>FilesUploader.vStek‚Äî</i> ‚Äù <i>lines</i> ). <br><br>  And the final touch is the console output function and closing bracket: <br><br><pre> <code class="javascript hljs"> out : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.debug) <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(message); } }</code> </pre><br><br>  That's all - the class for multi-threaded file upload to the server is ready.  Next, you should set, depending on the server configuration, the permissible number of threads and the amount of simultaneously uploaded files - and you can work. </div><p>Source: <a href="https://habr.com/ru/post/149701/">https://habr.com/ru/post/149701/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../149694/index.html">RabbitMQ tutorial 1 - Hello World</a></li>
<li><a href="../149695/index.html">Monitoring PHP Code Performance with Pinba</a></li>
<li><a href="../149696/index.html">CERN - what is the organization for $ 900 million</a></li>
<li><a href="../149698/index.html">Radio 60-1700 MHz on RTL2832 for 20 bucks or SDR for beginners</a></li>
<li><a href="../149699/index.html">Ya.Subbotnik: BEM in the development of interfaces</a></li>
<li><a href="../149702/index.html">USB TV tuners on rtl2832 - or how to hear everything on the radio for 600 rubles</a></li>
<li><a href="../149704/index.html">Cach√© + Java + Flex, or as we did the curriculum management system</a></li>
<li><a href="../149708/index.html">ABBYY FineScanner: iPhone instead of scanner</a></li>
<li><a href="../149709/index.html">Julian Assange received political asylum in Ecuador</a></li>
<li><a href="../149710/index.html">Silent revolution: flash memory in data centers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>