<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Manage Vscale Servers via Ansible</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Vscale project was launched just six months ago, and now it is being actively developed. Intensive development is largely made possible by the com...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Manage Vscale Servers via Ansible</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/9b5/317/de0/9b5317de0acf4325ae46f8291f377987.png"><br><br>  The <a href="https://vscale.io/%3Futm_campaign%3Dru_ru_habrahabr.ru%26utm_medium%3Darticle%26utm_source%3Dhabrahabr.ru%26utm_term%3Dansible">Vscale</a> project was launched just six months ago, and now it is being actively developed.  Intensive development is largely made possible by the community: a huge contribution to the development of the service is made by users who create libraries for working with <a href="http://habrahabr.ru/company/selectel/blog/266655/">API</a> and share them with a wide audience on GitHub.  Interesting developments include clients for <a href="https://github.com/evrone/vscale_api">Go</a> , <a href="https://github.com/Smolget/vscale-api">Ruby</a> , <a href="https://github.com/germanosin/vscale-java-api">Java</a> , as well as a plugin for the <a href="https://github.com/evrone/docker-machine-vscale">Docker Machine</a> . <br><br>  For our part, we would like to offer the community another useful tool: the <a href="https://github.com/vscale/ansible-vscale-modules">module</a> for the <a href="https://habrahabr.ru/company/selectel/blog/196620/">Ansible</a> configuration management system, with which you can deploy a virtual infrastructure based on <a href="https://vscale.io/%3Futm_campaign%3Dru_ru_habrahabr.ru%26utm_medium%3Darticle%26utm_source%3Dhabrahabr.ru%26utm_term%3Dansible">Vscale</a> . <br><a name="habracut"></a><br><h4>  Module features </h4><br>  By installing our module, you can write a script for automatic deployment of a virtual infrastructure based on <a href="https://vscale.io/%3Futm_campaign%3Dru_ru_habrahabr.ru%26utm_medium%3Darticle%26utm_source%3Dhabrahabr.ru%26utm_term%3Dansible">Vscale</a> .  With it, you can perform the following operations: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  create and delete servers; </li><li>  reinstall the operating system on the server; </li><li>  configuration upgrade; </li><li>  powering on, shutting down and restarting servers. </li></ul><br>  In this article we will look at several examples of its use.  All its capabilities are described in detail in the documentation for the <a href="https://github.com/vscale/ansible-vscale-modules">module</a> . <br><br><h4>  Download and initial setup </h4><br>  Before you start working with the module, you need to perform several preparatory operations.  First, we will generate a token <a href="https://vscale.io/panel/settings/tokens/">in the control panel</a> to access the API. <br>  Then we add the <code>VS_API_KEY</code> environment <code>VS_API_KEY</code> and specify the resulting token as its value: <br><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> VS_API_KEY=5c22a088f3b37c933e7480399f1e09258d6977bcd1eb2401de29e8001c9bedc36</code> </pre><br>  Create directories for SSH keys and libraries: <br><br><pre> <code class="bash hljs">$ mkdir -p vscale-ansible/{credentials,group_vars}</code> </pre><br>  After that, we will generate an SSH key to access the servers.  If you need to add an existing SSH key, simply enter the path to it in the configuration file (see below): <br><br><pre> <code class="bash hljs">$ ssh-keygen -f ./vscale-ansible/credentials/ansible</code> </pre><br>  Open the configuration file vscale-ansible / ansible.cfg and write the following settings: <br><br><pre> <code class="xml hljs">sudo_user = root remote_user = root host_key_checking = False private_key_file = ./credentials/ansible [ssh_connection] control_path = %(directory)s/%%h-%%r</code> </pre><br>  Let's also create a vscale-ansible / inventory file in which the names of Ansible hosts will be specified: <br><br><pre> <code class="xml hljs">[fe-servers] fe-[01:02] [local] localhost</code> </pre><br>  After that you can load the module: <br><br><pre> <code class="bash hljs">$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/vscale/ansible-vscale-modules.git ./library</code> </pre><br>  For the convenience of further work, we define several variables in the file vscale-ansible / group_vars / all.yml: <br><br><pre> <code class="xml hljs">--- vscale_token: "{{ lookup('env', 'VS_API_KEY')}}" key: "{{ lookup('file', 'credentials/ansible.pub') }}"</code> </pre><br><br><h4>  Test script: server creation </h4><br>  Let's try to write a script that will create a new server in <a href="https://vscale.io/%3Futm_campaign%3Dru_ru_habrahabr.ru%26utm_medium%3Darticle%26utm_source%3Dhabrahabr.ru%26utm_term%3Dansible">Vscale</a> with the characteristics we need.  Create a file createserver.yml in a text editor and add the following lines: <br><br><pre> <code class="xml hljs">--- - name: Add SSH key connection: local gather_facts: no hosts: fe-servers tasks: - name: Add SSH key to Vscale account run_once: true vscale_ssh: token: "{{ vscale_token }}" name: "Ansible" public_key: "{{ key }}" state: present</code> </pre><br>  In this snippet, we described the procedure for adding an SSH key using two previously defined variables ( <code>token</code> and <code>public_key</code> ). <br>  Next, we describe the parameters of the server you want to create: <br><br><pre> <code class="xml hljs">- name: Create scalet for inventory hosts vscale_scalets: token: "{{ vscale_token }}" name: "{{ inventory_hostname }}" plan: small location: spb0 image: ubuntu_14.04_64_002_master key_name: "Ansible" collect_facts: "yes" power_state: "started" state: present register: server - set_fact: ansible_ssh_host: "{{ server['scalet']['public_address']['address'] }}"</code> </pre><br>  Next, install Nginx on our server: <br><br><pre> <code class="xml hljs">- name: Install NGINX and fill disk remote_user: root hosts: - fe-servers tasks: - name: Install NGINX apt: pkg: nginx update_cache: yes state: latest - name: Filling disk command: dd if=/dev/zero of=/large.file bs=100M count=150 creates=/large.file</code> </pre><br>  In this snippet, we not only described the standard procedure for installing Nginx, but also filled the disk.  We did this on purpose so that you could test the following part of our script: <br><br><pre> <code class="xml hljs">- name: Check free disk space remote_user: root hosts: - fe-servers tasks: - name: Gather facts setup: - name: Upgrade server if disk has than 3Gb left hosts: - fe-servers connection: local tasks: - name: Upgrade vscale_scalets: token: "{{ vscale_token }}" name: "{{ inventory_hostname }}" plan: medium upgrade: yes state: present when: "{{ (ansible_mounts[0].size_available)/2**30 <span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span><span class="hljs-tag">*(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span><span class="hljs-tag">**</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">30</span></span></span><span class="hljs-tag">) }}"</span></span></code> </pre><br>  In it, we run a check for free disk space.  If the free disk space is less than 3 Gb, the server configuration will be automatically updated to a more productive one. <br><br>  That's all.  Save the changes and execute the command: <br><br><pre> <code class="bash hljs">$ ansible-playbook -i inventory createserver.yml</code> </pre><br>  You can find the described script for testing in <a href="https://github.com/vscale/ansible-playbooks/tree/master/vscale-example-playbook">our repository</a> . <br><br><h4>  Software installation on servers </h4><br>  We just looked at an example script that simply creates a new server.  Now let's try to automate the installation process. <br><br>  This can be done using ready-made scripts and roles - take and use: <br><br><ul><li>  <a href="https://github.com/vscale/ansible-playbooks/tree/master/vscale-ajenti-playbook">Ajenti installation</a> ; </li><li>  <a href="https://github.com/vscale/ansible-playbooks/tree/master/vscale-django-playbook">Installing Django</a> ; </li><li>  <a href="https://github.com/vscale/ansible-playbooks/tree/master/vscale-wordpress-playbook">Install WordPress</a> . </li></ul><br>  If you have not yet installed the module using the instructions above, you can simply clone the repository with scripts, and then connect our module using the git submodule command: <br><br><pre> <code class="bash hljs">$ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/vscale/ansible-playbooks.git $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ansible-playbooks $ git submodule init $ git submodule update</code> </pre><br>  This method has certain advantages: if we connect some repository in the form of a submodule, it always remains in a working, consistent state.  Even if we update the repository in the main branch and something ‚Äúbreaks‚Äù in it, your submodule will not be changed after the update. <br><br>  Do not forget to generate the SSH-key and add the path to it in the configuration file :) <br><br>  The structure and syntax of scripts are quite simple, and you can certainly write something of your own - API documentation to help you. <br><br><h4>  Conclusion </h4><br>  We invite everyone to try our Ansible module and hope that it will be useful for you.  We welcome any comments and suggestions for its further improvement. <br>  We also urge all those who write client libraries for Vscale, not to stew in their own juice, but to acquaint the community with the results of their work.  We will definitely write about the most interesting developments, and reward the most active and talented. <br></div><p>Source: <a href="https://habr.com/ru/post/274207/">https://habr.com/ru/post/274207/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274193/index.html">Draw together. Portrait of user IE 8 full face</a></li>
<li><a href="../274195/index.html">Direct disk access from python</a></li>
<li><a href="../274197/index.html">Computational chemistry is a modern way to obtain the necessary chemical compounds from IBM</a></li>
<li><a href="../274203/index.html">The quickest start with Angular 2 (beta) and Dart</a></li>
<li><a href="../274205/index.html">Data Festival at the Moscow Museum, as it were</a></li>
<li><a href="../274209/index.html">Domain sharding: Ruby on Rails implementation and results</a></li>
<li><a href="../274211/index.html">Security Week 52-53: Juniper backdoor with a thick layer of cryptography, vintage Java, gopo-bug bounty</a></li>
<li><a href="../274213/index.html">HIVE: the future of cloud PBX or where are we going next year</a></li>
<li><a href="../274215/index.html">VKontakte not only does not pay users for the found vulnerabilities, but also does not consider them</a></li>
<li><a href="../274219/index.html">Why Habrahabr turned into a tape of corporate blog posts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>