<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Samba4, Radius and PPTP using MS-CHAP v2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="... Wow, it happened. Everything turned out to be quite simple, although I had to spend a lot of time, mainly on searching for information on the Inte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Samba4, Radius and PPTP using MS-CHAP v2</h1><div class="post__text post__text-html js-mediator-article">  ... Wow, it happened.  Everything turned out to be quite simple, although I had to spend a lot of time, mainly on searching for information on the Internet (useful, of course) - the cat wept ... And how it (this information) is scattered!  Therefore, I decided to write this guide based on my own implementation experience.  The main thing is that everything will be collected in one place (except, perhaps, the bind9 settings, but more on that later). <br><br>  So, the task.  There is a server with Ubuntu 12.04.  It should be: <br><br><ul><li>  PDC Windows domain with Active Directory. </li><li>  VPN server (let it be, for example, PPTP, but with mandatory support for MS-CHAP v2 and MPPE-128) with authorization on the Radius server (for definiteness - freeradius). </li><li>  Respectively - Freeradius-server. </li><li>  A terminal server on which AD users transparently log in. </li></ul><br>  Getting started. <br><a name="habracut"></a><br><h5>  We put Samba4 </h5><br>  Carefully read the <a href="http://wiki.samba.org/index.php/Samba4/HOWTO">Samba4 / HOWTO</a> .  At the time of the start of the installation, the next version of Samba4-4.0.0rc2 was available.  Now, as far as I know, 4.0.0rc3.  I worked with RC2 and I will describe it. <br>  We do everything according to the instructions of the HOWTO, but do not forget about a few nuances: <br><ol><li>  We want to authenticate our AD users on a Linux computer?  Then do not forget to install the <i>libpam0g-dev</i> package into the system (like this: <i>sudo apt-get install libpam0g-dev</i> ).  Without these libraries, pam support in samba4 will not be implemented (in the built project there will be no directory <i>/ usr / local / samba / lib / security /</i> with the very necessary library <i>pam_winbind.so</i> ). </li><li>  I would recommend (strongly!) Instead of <i>./configure to</i> use <i>./configure.developer</i> . </li></ol><br>  Next, do as described in the <a href="http://wiki.samba.org/index.php/Samba4/HOWTO">WiKi Samba4 HOWTO</a> .  The built samba4 will be located in the <i>/ usr / local / samba</i> / directory.  Once again, I‚Äôll note that all samba4 binaries are located in the <i>/ usr / local / samba / bin / directory</i> , services are in the <i>/ usr / local / samba / sbin /</i> directory, so you need to access them now using absolute paths, or correct them the PATH variable, or - as I did, because I put samba4 on a machine without samba3 - make symbolic links of all the files from the <i>/ usr / local / samba / bin /</i> directory to the <i>/ usr / bin / directory</i> , and from the <i>/ usr / local /</i> directory <i>samba / sbin /</i> - to the <i>/ usr / sbin /</i> directory. <br>  Now do the ‚Äúprovisioning‚Äù of samba4 as described in the HOWTO.  Among other things, this procedure will create in the <i>/ usr / local / samba / etc /</i> directory the main samba configuration file - <i>smb.conf</i> , which can be supplemented with the necessary options and "balls" and ... run samba!  Here‚Äôs what my <i>/usr/local/samba/etc/smb.conf</i> looks like: <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Global parameters [global] dos charset = CP860 workgroup = &lt;DOMAIN&gt; # NetBIOS    realm = &lt;domain.-&gt; #  netbios name = &lt;NetBIOS_Name&gt; # NetBIOS    server role = active directory domain controller dns forwarder = 127.0.0.1 #     dns-. template shell = /bin/bash #       ,    ‚Äì   ‚Ä¶ winbind use default domain = Yes winbind enum users = Yes winbind enum groups = Yes [netlogon] path = /usr/local/samba/var/locks/sysvol/uchteno.local/scripts read only = No [sysvol] path = /usr/local/samba/var/locks/sysvol read only = No #[profiles] # path = /var/lib/samba/profiles # read only = no # browseable = No #   ¬´¬ª,   .</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To run samba4 in the <i>/ etc / init /</i> directory, create a <i>samba4.conf</i> file of approximately the following content: <br><br><pre> <code class="bash hljs">description <span class="hljs-string"><span class="hljs-string">"SMB/CIFS File and Active Directory Server"</span></span> author <span class="hljs-string"><span class="hljs-string">"Jelmer Vernooij &lt;jelmer@ubuntu.com&gt;"</span></span> start on (<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>-filesystems and net-device-up) stop on runlevel [!2345] expect fork normal <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> 0 pre-start script [ -r /etc/default/samba4 ] &amp;&amp; . /etc/default/samba4 install -o root -g root -m 755 -d /var/run/samba install -o root -g root -m 755 -d /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/samba end script <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/samba/sbin/samba ‚ÄìD</code> </pre><br>  Starting / stopping the service will be done as follows: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># service samba4 start # service samba4 stop # service samba4 restart</span></span></code> </pre><br>  A separate song is worth setting dns, because  on this server, bind9 was already spinning with its zones, and samba4, having its own built-in dns server, did not want to ‚Äúmake friends‚Äù with the already configured bind9, so ... let's, for now, restrict ourselves to HOWTO instructions, and if it is interesting, then I will describe a bunch of samba4- bind9. <br>  All the rest is strictly according to the HOWTO mentioned above with a few remarks. <br><ul><li>  The Windows Remote Administration Tools package installed on Windows 7 has two unpleasant features (so far, I noticed two): <br>  - first, in the ADUC snap-in for user properties, the ‚ÄúDial-in‚Äù tab is completely absent (or how is it in Russian?), And it means that you will have to configure the remote access capability for users in other ways; <br>  - secondly, group policy management is possible only under the Administrator account, despite the fact that a specially created user was included in all possible groups ... </li><li>  Honestly, until I understood in detail the possibility of group policies under samba4 ... </li></ul><br>  So, samba4 is installed and running.  Now is the turn of AD user authentication in Linux <br><br><h5>  Winbind setup </h5><br>  Go to the <a href="http://wiki.samba.org/index.php/Samba4/Winbind">Samba4 / Winbind Wiki</a> documentation and do EVERYTHING-EVERYTHING written there.  Do not forget to restart the system after making changes to /etc/nsswitch.conf, because ... In general, you need to reboot.  Be careful with the files in /etc/pam.d/, because if you make the mistake, your server will turn into a ‚Äúblack box‚Äù, because  you cannot log into it either via ssh or from the console ... If you have done everything without errors - voila, you can now log in to the Linux server using Active Directory user accounts! <br>  However, let me list the necessary actions once again and give all my (working!) Configuration files so that everything is in one place. <br>  So. <br>  Make the <i>libnss_winbind.so</i> library <i>available</i> : <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ln -s /usr/local/samba/lib/libnss_winbind.so.2 /lib/libnss_winbind.so # ln -s /lib/libnss_winbind.so /lib/libnss_winbind.so.2</span></span></code> </pre><br>  Rule <i>/etc/nsswitch.conf</i> : <br>  # /etc/nsswitch.conf <br><pre> <code class="bash hljs">passwd: compat winbind group: compat winbind shadow: compat hosts: files dns networks: files protocols: db files services: db files ethers: db files rpc: db files netgroup: nis</code> </pre><br>  After this edit, reboot immediately! <br>  Test winbind.  Yes, do not be embarrassed that there is no such process in the system - the samba daemon now performs all functions. <br>  Winbind availability: <br><pre> <code class="bash hljs">$ /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/samba/bin/wbinfo -p Ping to winbindd succeeded</code> </pre><br>  Winbind returns a list of domain users: <br><pre> <code class="bash hljs">$ /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/samba/bin/wbinfo -u ... &lt;_&gt;\Administrator ...</code> </pre><br>  getent passwd gives a list of ALL users ‚Äî both Linux and domain: <br><pre> <code class="bash hljs">$ getent passwd root:x:0:0‚Ä¶ ... &lt;_&gt;\Administrator:x:0:100::/home/MATWS/Administrator:/bin/<span class="hljs-literal"><span class="hljs-literal">false</span></span> ...</code> </pre><br>  The id command returns information about domain users: <br><pre> <code class="bash hljs">$ id Administrator uid=0(root) gid=100(users) groupes=0(root),100(users),3000004(Group Policy Creator Owners),3000008(Domain Admins)</code> </pre><br>  Please note that the domain user Administrator created at the ‚Äúprocurement‚Äù stage of samba4 has uid = 0 with all the ensuing consequences! <br><h5>  Pam setup </h5><br>  First of all, we are making the <i>pam_winbind.so</i> library <i>available</i> : <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ln -s /usr/local/samba/lib/security/pam_winbind.so /lib/security</span></span></code> </pre><br>  Configure the following files in the <i>/etc/pam.d/</i> directory: <br>  <i>/etc/pam.d/common-auth</i> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # /etc/pam.d/common-auth - authentication settings common to all services # # This file is included from other service-specific PAM config files, # and should contain a list of the authentication modules that define # the central authentication scheme for use on the system # (eg, /etc/shadow, LDAP, Kerberos, etc.). The default is to use the # traditional Unix authentication mechanisms. # # As of pam 1.0.1-6, this file is managed by pam-auth-update by default. # To take advantage of this, it is recommended that you configure any # local modules either before or after the default block, and use # pam-auth-update to manage selection of other modules. See # pam-auth-update(8) for details. # here are the per-package modules (the "Primary" block) auth sufficient pam_winbind.so auth [success=1 default=ignore] pam_unix.so nullok_secure use_first_pass # here's the fallback if no module succeeds auth requisite pam_deny.so # prime the stack with a positive return value if there isn't one already; # this avoids us returning an error just because nothing sets a success code # since the modules above will each just jump around auth required pam_permit.so # and here are more per-package modules (the "Additional" block) # end of pam-auth-update config</span></span></code> </pre><br><br>  <i>/etc/pam.d/common-account</i> : <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # /etc/pam.d/common-account - authorization settings common to all services # # This file is included from other service-specific PAM config files, # and should contain a list of the authorization modules that define # the central access policy for use on the system. The default is to # only deny service to users whose accounts are expired in /etc/shadow. # # As of pam 1.0.1-6, this file is managed by pam-auth-update by default. # To take advantage of this, it is recommended that you configure any # local modules either before or after the default block, and use # pam-auth-update to manage selection of other modules. See # pam-auth-update(8) for details. # # here are the per-package modules (the "Primary" block) account sufficient pam_winbind.so account [success=1 new_authtok_reqd=done default=ignore] pam_unix.so # here's the fallback if no module succeeds account requisite pam_deny.so # prime the stack with a positive return value if there isn't one already; # this avoids us returning an error just because nothing sets a success code # since the modules above will each just jump around account required pam_permit.so # and here are more per-package modules (the "Additional" block) # end of pam-auth-update config</span></span></code> </pre><br><br>  <i>/etc/pam.d/common-session</i> : <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # /etc/pam.d/common-session - session-related modules common to all services # # This file is included from other service-specific PAM config files, # and should contain a list of modules that define tasks to be performed # at the start and end of sessions of *any* kind (both interactive and # non-interactive). # # As of pam 1.0.1-6, this file is managed by pam-auth-update by default. # To take advantage of this, it is recommended that you configure any # local modules either before or after the default block, and use # pam-auth-update to manage selection of other modules. See # pam-auth-update(8) for details. # here are the per-package modules (the "Primary" block) session [default=1] pam_permit.so # here's the fallback if no module succeeds session requisite pam_deny.so # prime the stack with a positive return value if there isn't one already; # this avoids us returning an error just because nothing sets a success code # since the modules above will each just jump around session required pam_permit.so # The pam_umask module will set the umask according to the system default in # /etc/login.defs and user settings, solving the problem of different # umask settings with different shells, display managers, remote sessions etc. # See "man pam_umask". session required pam_mkhomedir.so session required pam_winbind.so session optional pam_umask.so # and here are more per-package modules (the "Additional" block) session required pam_unix.so session optional pam_ck_connector.so nox11 # end of pam-auth-update config</span></span></code> </pre><br><br>  Now you have the opportunity to login on a Linux-computer under a domain user! <br><br><h5>  Freeradius </h5><br>  The next step is to install and configure a freeradius server, configure pptpd to work in conjunction with freeradius using Active Directory data and MS-CHAP v2 and MPPE-128 protocols.  And do not believe that to implement MS-CHAP v2, you need to use samba3 or, which is even better, smash samba4 and the radius server on different machines! <br>  So, we‚Äôll use <a href="http://wiki.samba.org/index.php/Samba4/HOWTO/Virtual_Private_Network">WiKi Samba4 / HOWTO / Virtual_Private_Network</a> again as a starting point.  But not literally.  Getting started. <br>  Install freeradius: <br><pre> <code class="bash hljs">sudo apt-get install freeradius freeradius-common freeradius-krb5 freeradius-ldap freeradius-utils radiusclient1</code> </pre><br>  Please note that in comparison with the mentioned article on WiKi, installation of the radiusclient1 package has been added here, which will be necessary for pptpd to work with radius plugins. <br>  Configuring freeradius.  I have this <i>/etc/freeradius/radiusd.conf</i> : <br><pre> <code class="bash hljs">prefix = /usr exec_prefix = /usr sysconfdir = /etc localstatedir = /var sbindir = <span class="hljs-variable"><span class="hljs-variable">${exec_prefix}</span></span>/sbin logdir = /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/freeradius raddbdir = /etc/freeradius radacctdir = <span class="hljs-variable"><span class="hljs-variable">${logdir}</span></span>/radacct confdir = <span class="hljs-variable"><span class="hljs-variable">${raddbdir}</span></span> run_dir = <span class="hljs-variable"><span class="hljs-variable">${localstatedir}</span></span>/run/freeradius db_dir = <span class="hljs-variable"><span class="hljs-variable">${raddbdir}</span></span> libdir = /usr/lib/freeradius pidfile = <span class="hljs-variable"><span class="hljs-variable">${run_dir}</span></span>/freeradius.pid max_request_time = 30 cleanup_delay = 5 max_requests = 1024 listen { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = auth ipaddr = &lt;ip_address_&gt; <span class="hljs-comment"><span class="hljs-comment">#    port = 0 interface = eth0 } listen { type = auth ipaddr = 127.0.0.1 port = 0 interface = lo } listen { type = acct ipaddr = &lt;ip_address_&gt; port = 0 interface = eth0 } listen { type = acct ipaddr = 127.0.0.1 port = 0 interface = lo } #   ,   ,     #listen { type = auth ‚Ä¶}  listen {type = acct ‚Ä¶} hostname_lookups = no allow_core_dumps = no regular_expressions = yes extended_expressions = yes log { destination = files file = ${logdir}/radius.log syslog_facility = daemon stripped_names = no auth = no auth_badpass = no auth_goodpass = no } checkrad = ${sbindir}/checkrad security { max_attributes = 200 reject_delay = 1 status_server = yes } proxy_requests = no $INCLUDE clients.conf thread pool { start_servers = 5 max_servers = 32 min_spare_servers = 3 max_spare_servers = 10 max_requests_per_server = 0 } modules { $INCLUDE ${confdir}/modules/ } instantiate { exec expr expiration logintime } $INCLUDE policy.conf $INCLUDE sites-enabled/</span></span></code> </pre><br><br>  Next, in <i>/etc/freeradius/clients.conf,</i> we write: <br><pre> <code class="bash hljs">client localhost { ipaddr = 127.0.0.1 netmask = 32 secret = samba4 <span class="hljs-comment"><span class="hljs-comment">#   ¬´¬ª      shortname = localhost }</span></span></code> </pre><br>  Remove the possibility of working inner-tunnel, which requires EAP-TTLS and PEAP: <br><pre> <code class="bash hljs">sudo rm -rf /etc/freeradius/sites-enabled/inner-tunnel</code> </pre><br>  Now, the <i>default</i> directory remains in the <i>/ etc / freeradius / sites-enabled /</i> directory, which we edit: <br><pre> <code class="bash hljs">authorize { preprocess auth_log chap mschap <span class="hljs-comment"><span class="hljs-comment">#suffix #     , ..      ldap expiration logintime pap } authenticate { Auth-Type PAP { pap } Auth-Type CHAP { chap } Auth-Type MS-CHAP { mschap } Auth-Type LDAP { ldap } } preacct { preprocess acct_unique suffix files } accounting { detail radutmp attr_filter.accounting_response } session { radutmp } post-auth { exec Post-Auth-Type REJECT { attr_filter.access_reject } } pre-proxy { } post-proxy { }</span></span></code> </pre><br><br>  Go to the directory <i>/ etc / freeradius / modules /</i> and edit the necessary modules. <br>  File <i>/ etc / freeradius / modules / ldap</i> (replacing all cn and dc with yours): <br><pre> <code class="bash hljs">ldap { server = <span class="hljs-string"><span class="hljs-string">"localhost"</span></span> identity = <span class="hljs-string"><span class="hljs-string">"cn=VPN,cn=users,dc=example,dc=com"</span></span> <span class="hljs-comment"><span class="hljs-comment">#   ldap #      password = &lt;__&gt; basedn = "dc=example,dc=com" filter = "(sAMAccountName=%{Stripped-User-Name:-%{User-Name}})" ldap_connections_number = 5 timeout = 4 timelimit = 3 net_timeout = 1 tls { start_tls = no } access_attr = "msNPAllowDialin" dictionary_mapping = ${confdir}/ldap.attrmap edir_account_policy_check = no #        WiKi ,  #      Active Directory   ! chase-referrals = yes rebind = yes }</span></span></code> </pre><br><br>  Edit <i>/ etc / freeradius / modules / mschap</i> : <br><pre> <code class="bash hljs">mschap { use_mppe = yes (  mppe-128) require_encryption = yes require_strong = yes with_ntdomain_hack = no <span class="hljs-comment"><span class="hljs-comment">#   - ‚Äì   !!! ntlm_auth = "/usr/local/samba/bin/ntlm_auth3 --request-nt-key \ --username=%{Stripped-User-Name:-%{User-Name:-None}} \ --challenge=%{mschap:Challenge:-00} \ --nt-response=%{mschap:NT-Response:-00}" }</span></span></code> </pre><br>  I once again draw your attention to the parameter ntlm_auth = "/ usr / local / samba / bin / ntlm_auth3 ..." Samba4 is "friendly" with samba3 and besides the ntlm_auth binary, which does not support MS-CHAP v2, there is a ntlm_auth3 binary, which all this means "! <br><br><h5>  PPTPD </h5><br>  And finally - pptpd.  It is understood that you have already installed and configured pptpd itself (the <i>/etc/pptpd.conf</i> file is not necessary to edit!) <br>  We rule <i>/ etc / ppp / pptpd-options</i> : <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">############################################################################### # $Id: pptpd-options 4643 2006-11-06 18:42:43Z rene $ # # Sample Poptop PPP options file /etc/ppp/pptpd-options # Options used by PPP when a connection arrives from a client. # This file is pointed to by /etc/pptpd.conf option keyword. # Changes are effective on the next connection. See "man pppd". # # You are expected to change this file to suit your system. As # packaged, it requires PPP 2.4.2 and the kernel MPPE module. ############################################################################### # Authentication # Name of the local system for authentication purposes # (must match the second field in /etc/ppp/chap-secrets entries) name pptpd # Optional: domain name to use for authentication # # Strip the domain prefix from the username before authentication. # (applies if you use pppd with chapms-strip-domain patch) #chapms-strip-domain # Encryption # Debian: on systems with a kernel built with the package # kernel-patch-mppe &gt;= 2.4.2 and using ppp &gt;= 2.4.2, ... refuse-pap refuse-chap refuse-mschap # Require the peer to authenticate itself using MS-CHAPv2 [Microsoft # Challenge Handshake Authentication Protocol, Version 2] authentication. require-mschap-v2 # Require MPPE 128-bit encryption # (note that MPPE requires the use of MSCHAP-V2 during authentication) require-mppe-128 # Network and Routing # If pppd is acting as a server for Microsoft Windows clients, this # option allows pppd to supply one or two DNS (Domain Name Server) # addresses to the clients. The first instance of this option # specifies the primary DNS address; the second instance (if given) # specifies the secondary DNS address. # Attention! This information may not be taken into account by a Windows # client. See KB311218 in Microsoft's knowledge base for more information. ms-dns &lt;ip_dns&gt; #    ‚Äì  127.0.0.1 # If pppd is acting as a server for Microsoft Windows or "Samba" # clients, this option allows pppd to supply one or two WINS (Windows # Internet Name Services) server addresses to the clients. The first # instance of this option specifies the primary WINS address; the # second instance (if given) specifies the secondary WINS address. ms-wins &lt;ip_wins&gt; #    ‚Äì 127.0.0.1 # Add an entry to this system's ARP [Address Resolution Protocol] # table with the IP address of the peer and the Ethernet address of this # system. This will have the effect of making the peer appear to other # systems to be on the local ethernet. # (you do not need this if your PPTP server is responsible for routing # packets to the clients -- James Cameron) proxyarp # Debian: do not replace the default route nodefaultroute # Logging # Enable connection debugging facilities. # (see your syslog configuration for where pppd sends to) debug # Print out all the option values which have been set. # (often requested by mailing list to verify options) #dump # Miscellaneous # Create a UUCP-style lock file for the pseudo-tty to ensure exclusive # access. lock # Disable BSD-Compress compression nobsdcomp auth logfile /var/log/pptpd.log #    radius     plugin radius.so plugin radattr.so</span></span></code> </pre><br><br>  The file <i>/etc/radiusclien/radiusclient.conf</i> (in my opinion, I did not touch it, except that I corrected authserver and acctserver): <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># General settings # specify which authentication comes first respectively which # authentication is used. possible values are: "radius" and "local". # if you specify "radius,local" then the RADIUS server is asked # first then the local one. if only one keyword is specified only # this server is asked. auth_order radius,local # maximum login tries a user has login_tries 4 # timeout for all login tries # if this time is exceeded the user is kicked out login_timeout 60 # name of the nologin file which when it exists disables logins. # it may be extended by the ttyname which will result in # a terminal specific lock (eg /etc/nologin.ttyS2 will disable # logins on /dev/ttyS2) nologin /etc/nologin # name of the issue file. it's only display when no username is passed # on the radlogin command line issue /etc/radiusclient/issue # RADIUS settings # RADIUS server to use for authentication requests. this config # item can appear more then one time. if multiple servers are # defined they are tried in a round robin fashion if one # server is not answering. # optionally you can specify a the port number on which is remote # RADIUS listens separated by a colon from the hostname. if # no port is specified /etc/services is consulted of the radius # service. if this fails also a compiled in default is used. authserver localhost # RADIUS server to use for accouting requests. All that I # said for authserver applies, too. # acctserver localhost # file holding shared secrets used for the communication # between the RADIUS client and server servers /etc/radiusclient/servers # dictionary of allowed attributes and values # just like in the normal RADIUS distributions dictionary /etc/radiusclient/dictionary # program to call for a RADIUS authenticated login login_radius /usr/sbin/login.radius # file which holds sequence number for communication with the # RADIUS server seqfile /var/run/radius.seq # file which specifies mapping between ttyname and NAS-Port attribute mapfile /etc/radiusclient/port-id-map # default authentication realm to append to all usernames if no # realm was explicitly specified by the user # the radiusd directly form Livingston doesnt use any realms, so leave # it blank then default_realm # time to wait for a reply from the RADIUS server radius_timeout 10 # resend request this many times before trying the next server radius_retries 3 # LOCAL settings # program to execute for local login # it must support the -f flag for preauthenticated login login_local /bin/login</span></span></code> </pre><br><br>  File <i>/ etc / radiusclien / server</i> : <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Make sure that this file is mode 600 (readable only to owner)! # #Server Name or Client/Server pair Key #---------------- --------------- 127.0.0.1 samba4 #   ¬´¬ª,     freeradius?</span></span></code> </pre><br><br>  A very important point - create the file <i>/etc/radiusclient/dictionary.microsoft</i> .  I will not give his text, because  You can get it entirely <a href="">here</a> ) <br><br>  And at the end of the file <i>/ etc / radiusclient / dictionary append a</i> line <br>  INCLUDE /etc/radiusclient/dictionary.microsoft to get the following: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Updated 97/06/13 to livingston-radius-2.01 miquels@cistron.nl # # This file contains dictionary translations for parsing # requests and generating responses. All transactions are # composed of Attribute/Value Pairs. The value of each attribute # is specified as one of 4 data types. Valid data types are: # # string - 0-253 octets # ipaddr - 4 octets in network byte order # integer - 32 bit value in big endian order (high byte first) # date - 32 bit value in big endian order - seconds since # 00:00:00 GMT, Jan. 1, 1970 # # Enumerated values are stored in the user file with dictionary # VALUE translations for easy administration. # # Example: # # ATTRIBUTE VALUE # --------------- ----- # Framed-Protocol = PPP # 7 = 1 (integer encoding) # # # Following are the proper new names. Use these. # #     # !!!!      !!!!! INCLUDE /etc/radiusclient/dictionary.microsoft</span></span></code> </pre><br><br>  It seems everything.  Samba4 is already running, you need to restart the freeradius server and the pptpd daemon. <br><br><h5>  Solving the problem with the absence of the ‚ÄúDial-in‚Äù tab in the ADUC snap-in </h5><br>  Oh yes.  About how to enable / disable access to VPN to certain users.  You did install the Windows Remote Administration Tools package?  So, you will not see that picture of the ADUC snap-in that is shown on the WiKi pages under Windows 7 with the ‚ÄúDial-in‚Äù tab.  And you will see something similar: <br><img src="https://habrastorage.org/storage2/02f/5cf/45e/02f5cf45e89291f9c666b9e53ef826c8.png"><br><br>  And where is the ‚ÄúDial-in‚Äù tab or its Russian analogue ‚ÄúIncoming Calls‚Äù?  How can I manage user permissions?  Nothing wrong.  We are not afraid of difficulties?  We remember (I think you didn‚Äôt forget!) That the domain controller is, among other things, an LDAP server, so we put any tools for managing such a server (for example, <a href="http://www.ldapadmin.org/download/index.html">LdapAdmin</a> ) and we steer them. <br>  To begin with, we set up a connection with our samba4 server: register the server address, push the ‚ÄúFetch DNs‚Äù button, select the top-level database, radio-box ‚ÄúGSS-API‚Äù, connect the user‚Äôs password as the administrator, the password.  We see our entire directory, which is when deploying a domain.  Select the desired user and go into edit mode.  Find the msNPAllowDialin attribute and enter TRUE or FALSE (required - in capital letters!): <br><img src="https://habrastorage.org/storage2/ffa/aa8/691/ffaaa86917ce74a4161a35f5739d7242.png"><br><br>  We save.  This user is allowed (or denied) to log in via VPN. <br><br><h5>  Results </h5><br>  In my opinion, all the tasks set at the beginning of the post are solved.  The time spent on their solution (about two and a half weeks) was primarily spent on studying the documentation on the Internet, the experience of such decisions, comparing the information received with the realities that I saw with my own eyes on our server, compiling and recompiling samba4, and editing, editing and editing configs again ... But I was pleased with the result: the result was an almost complete replacement of Windows Server 2008 R2 with Active Directory, network policy and access service and remote desktop service (under wine, of course, but this isn‚Äôt  ova did not write). </div><p>Source: <a href="https://habr.com/ru/post/157019/">https://habr.com/ru/post/157019/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../157007/index.html">Earned a black list of sites Roskomnadzor</a></li>
<li><a href="../157009/index.html">TFS in the Cloud: 5 users for free!</a></li>
<li><a href="../157011/index.html">Version 1.0.0 of cross-browser framework for creating Kango extensions released</a></li>
<li><a href="../157013/index.html">New star</a></li>
<li><a href="../157017/index.html">Read only</a></li>
<li><a href="../157021/index.html">Universal interface for image / video synchronization across devices.</a></li>
<li><a href="../157023/index.html">Puppet under load</a></li>
<li><a href="../157025/index.html">Book web programmer. Secrets of professional website development</a></li>
<li><a href="../157029/index.html">GlusterFS, the experience of the new version</a></li>
<li><a href="../157031/index.html">Bitcoin received official recognition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>