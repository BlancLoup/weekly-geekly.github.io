<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Preparing ASP.NET5, issue number 4 - details about routing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue our column on the topic ASP.NET5 with a publication from Stanislav Boyarintsev ( masterL ) - a developer of corporate web systems from ItW...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Preparing ASP.NET5, issue number 4 - details about routing</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  <i>We continue our column on the topic ASP.NET5 with a publication from Stanislav Boyarintsev ( <a href="https://habrahabr.ru/users/masterl/" class="user_link">masterL</a> ) - a developer of corporate web systems from ItWebNet.</i>  <i>In this article, Stanislav talks in great detail about the routing mechanism in ASP.NET5.</i>  <i>Previous articles from the column can always be read on the link <a href="http://habrahabr.ru/search/%3Fq%3D%255B%2523aspnetcolumn%255D%26target_type%3Dposts">#aspnetcolumn</a> - Vladimir Yunev</i> </blockquote><br><div style="text-align:center;"><img width="800" src="https://habrastorage.org/files/ce4/108/a51/ce4108a51607450498021c57e06fc515.png"></div><br><h3>  How was the routing system organized to ASP.NET 5 </h3><br>  Routing to ASP.NET 5 was performed using the ASP.NET module <a href="https://msdn.microsoft.com/en-us/library/system.web.routing.urlroutingmodule(v%3Dvs.100).aspx">UrlRoutingModule</a> .  The module passed through a <a href="https://msdn.microsoft.com/en-us/library/system.web.routing.routecollection(v%3Dvs.100).aspx">collection of</a> routes (usually objects of the <a href="https://msdn.microsoft.com/en-us/library/system.web.routing.route(v%3Dvs.110).aspx">Route</a> class) stored in the Routes static property of the <a href="https://msdn.microsoft.com/en-us/library/system.web.routing.routetable(v%3Dvs.110).aspx">RouteTable</a> class, selected a route that matched the current request and called the route handler that was stored in the RouteHandler property of the Route class - each registered route could have its own handler.  In the MVC application, this handler was <a href="https://msdn.microsoft.com/en-us/library/system.web.mvc.mvcroutehandler(v%3Dvs.118).aspx">MvcRouteHandler</a> , which took on further work with the request. <br><a name="habracut"></a><br>  Routes to the RouteTable.Routes collection were added during the application setup process. <br><br>  Typical routing configuration code in an MVC application: <br><br><pre><code class="cs hljs">RouteTable.Routes.MapRoute( name: <span class="hljs-string"><span class="hljs-string">"Default"</span></span>, url: <span class="hljs-string"><span class="hljs-string">"{controller}/{action}/{id}"</span></span>, defaults: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { controller = <span class="hljs-string"><span class="hljs-string">"Home"</span></span>, action = <span class="hljs-string"><span class="hljs-string">"Index"</span></span>, id = UrlParameter.Optional } );</code> </pre> <br>  Where <a href="https://msdn.microsoft.com/ru-ru/library/Dd470521(v%3DVS.118).aspx">MapRoute</a> is an extension-method declared in the System.Web.Mvc namespace, which added a new route to the Routes property in the Routes property using MvcRouteHandler as a handler. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We could do it on our own: <br><br><pre> <code class="cs hljs">RouteTable.Routes.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Route( url: <span class="hljs-string"><span class="hljs-string">"{controller}/{action}/{id}"</span></span>, defaults: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RouteValueDictionary(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { controller = <span class="hljs-string"><span class="hljs-string">"Home"</span></span>, action = <span class="hljs-string"><span class="hljs-string">"Index"</span></span>, id = UrlParameter.Optional }), routeHandler: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MvcRouteHandler()) );</code> </pre><br><h3>  How is the routing system in ASP.NET 5 organized: Short version </h3><br>  ASP.NET 5 no longer uses modules; for processing requests, the ‚Äúmiddleware‚Äù entered as part of the transition to <a href="http://docs.asp.net/en/latest/fundamentals/owin.html">OWIN</a> (Open Web Interface) allows you to run ASP.NET 5 applications not only on the IIS server. <br><br>  Therefore, routing is now performed using <a href="">RouterMiddleware</a> .  The entire project implementing routing <a href="https://github.com/aspnet/Routing">can be downloaded from github</a> .  Within this concept, the request is transferred from one middleware to another, in the order in which they are registered at the start of the application.  When the request reaches the RouterMiddleware, it compares whether the requested Url address is appropriate for any registered route, and if it does, calls the handler of this route. <br><br><h3>  How is the routing system in ASP.NET 5 organized? Long option </h3><br>  In order to understand how the routing system works, let's connect it to an empty ASP.NET 5 project. <br><br><ol><li>  Create an empty ASP.NET 5 project (by choosing Empty Template) and name it ‚ÄúAspNet5Routing‚Äù. </li><li>  Add dependencies ("dependencies") of the project in the project.json file "Microsoft.AspNet.Routing": <br><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"dependencies"</span></span>: { <span class="hljs-string"><span class="hljs-string">"Microsoft.AspNet.Server.IIS"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.0-beta5"</span></span>, <span class="hljs-string"><span class="hljs-string">"Microsoft.AspNet.Server.WebListener"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.0-beta5"</span></span>, <span class="hljs-string"><span class="hljs-string">"Microsoft.AspNet.Routing"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.0-beta5"</span></span> },</code> </pre><br></li><li>  In the Startup.cs file, add the use of the Microsoft.AspNet.Routing namespace: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNet.Routing;</code> </pre><br></li><li>  Add the necessary services (services that the routing system uses in its work) in the ConfigureServices method () of the Startup.cs file: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { services.AddRouting(); }</code> </pre><br></li><li>  Finally, we configure the routing system in the Configure () method of the Startup.cs file: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IApplicationBuilder app</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> routeBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RouteBuilder(); routeBuilder.DefaultHandler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ASPNET5RoutingHandler(); routeBuilder.ServiceProvider = app.ApplicationServices; routeBuilder.MapRoute(<span class="hljs-string"><span class="hljs-string">"default"</span></span>, <span class="hljs-string"><span class="hljs-string">"{controller}/{action}/{id}"</span></span>); app.UseRouter(routeBuilder.Build()); }</code> </pre></li></ol><br>  It is taken from an <a href="">example in the project of routing</a> . <br><br>  Let's analyze the last step in more detail: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> routeBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RouteBuilder(); routeBuilder.DefaultHandler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ASPNET5RoutingHandler(); routeBuilder.ServiceProvider = app.ApplicationServices;</code> </pre><br>  Create an instance of RouteBuilder and fill its properties.  The interest is caused by the DefaultHandler property with the <a href="">IRouter</a> type - judging by the name, it should contain a request handler.  I put an instance of ASPNET5RoutingHandler into it - a query processor that I invented, let's create it: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNet.Routing; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNet.Http; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">AspNet5Routing</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ASPNET5RoutingHandler</span></span> : <span class="hljs-title"><span class="hljs-title">IRouter</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> VirtualPathData </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetVirtualPath</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">VirtualPathContext context</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RouteAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RouteContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> context.HttpContext.Response.WriteAsync(<span class="hljs-string"><span class="hljs-string">"ASPNET5RoutingHandler work"</span></span>); context.IsHandled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } }</code> </pre><br>  The IRouter interface requires us only two methods, GetVirtualPath and RouteAsync. <br><br>  The GetVirtualPath method ‚Äî we are familiar with from previous versions of ASP.NET ‚Äî it was in the interface of the <a href="https://msdn.microsoft.com/en-us/library/system.web.routing.routebase(v%3Dvs.110).aspx">RouteBase</a> class from which the <a href="https://msdn.microsoft.com/en-us/library/system.web.routing.route(v%3Dvs.110).aspx">Route</a> class that represents the route inherited.  This method was responsible for building Url (for example, when we called the ActionLink method: <a href="https://habrahabr.ru/users/html/" class="user_link">Html</a> .ActionLink (‚Äúlink‚Äù, ‚ÄúIndex‚Äù)). <br><br>  And in the RouteAsync method, we process the request and write the result of the processing in Response. <br><br>  The following line is the Configure method: <br><br><pre> <code class="cs hljs">routeBuilder.MapRoute(<span class="hljs-string"><span class="hljs-string">"default"</span></span>, <span class="hljs-string"><span class="hljs-string">"{controller}/{action}/{id}"</span></span>);</code> </pre><br>  Like two drops of water, similar to the use of the MapRoute method in MVC 5, its parameters are the name of the added route and the pattern with which the requested Url will be matched. <br><br>  The MapRoute () itself, like in MVC 5, is an <a href="">extension-method</a> , and its call ultimately boils down to Creating an instance of the <a href="">TemplateRoute</a> class and adding it to the Routes collection of our RouteBuilder object: <br><br><pre> <code class="cs hljs">routeBuilder.Routes.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TemplateRoute(routeCollectionBuilder.DefaultHandler, name, <span class="hljs-comment"><span class="hljs-comment">//     "default" template, //     "{controller}/{action}/{id}" ObjectToDictionary(defaults), ObjectToDictionary(constraints), ObjectToDictionary(dataTokens), inlineConstraintResolver));</span></span></code> </pre><br>  What is interesting about the Routes property is the IRouter collection, that is, the TemplateRoute also implements the IRouter interface, just like the ASPNET5RoutingHandler we created, by the way, it is passed to the TemplateRoute constructor. <br><br>  And finally the last line: <br><br><pre> <code class="cs hljs">app.UseRouter(routeBuilder.Build());</code> </pre><br>  Call routeBuilder.Build () - creates an instance of the <a href="">RouteCollection</a> class and adds to it all the elements from the Route property of the RouteBuilder class. <br><br>  And the app.UseRouter () method <a href="">turns out to be an</a> extension-method, which actually connects <a href="">RouterMiddleware</a> to the request processing pipeline, passing to it the RouteCollection object created and populated in the Build () method. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IApplicationBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UseRouter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[NotNull] </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IApplicationBuilder builder, [NotNull] IRouter router</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> builder.UseMiddleware&lt;RouterMiddleware&gt;(router); }</code> </pre><br>  And judging by the constructor RouterMiddleware: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RouterMiddleware</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> RequestDelegate next, ILoggerFactory loggerFactory, IRouter router</span></span></span><span class="hljs-function">)</span></span></code> </pre><br>  The RouteCollection object also implements the IRouter interface, as well as ASPNET5RoutingHandler with TemplateRoute. <br><br>  So we got the following matryoshka: <br><br>  Our <i>ASPNET5RoutingHandler</i> request handler is packaged in <i>TemplateRoute</i> , the TemplateRoute itself or several TemplateRoute instances (if we called the MapRoute () method several times) are packaged in a <i>RouteCollection</i> , and <i>RouteCollection is</i> passed to the <i>RouterMiddleware</i> designer and stored in it. <br><br>  This completes the process of setting up the routing system, you can start the project, go to: "/ Home / Index / 1" and see the result: "ASPNET5RoutingHandler work". <br><br>  Well, briefly go over what happens with the routing system during the incoming request: <br><br>  When the queue reaches <i>RouterMiddleware</i> , in the list of running middleware, it calls the <i>RouteAsync ()</i> method on the saved IRouter instance - this is an object of the <i>RouteCollection</i> class. <br><br>  <i>RouteCollection,</i> in turn, passes through the <i>IRouter</i> instances stored in it - in our case it will be <i>TemplateRoute</i> and call the <i>RouteAsync ()</i> method in them. <br><br>  <i>TemplateRoute</i> checks whether the requested Url matches its template (passed in the TemplateRoute constructor: "{controller} / {action} / {id}") and if it matches, calls the instance of <i>IRouter</i> stored in it - which is our <i>ASPNET5RoutingHandler</i> . <br><br><h3>  We connect the routing system to the MVC application </h3><br>  Now let's see how the MVC Framework communicates with the routing system. <br><br>  Create an empty ASP.NET 5 project again using the Empty template. <br><br><ol><li>  Add dependencies ("dependencies") of the project in the project.json file "Microsoft.AspNet.Mvc": <br><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"dependencies"</span></span>: { <span class="hljs-string"><span class="hljs-string">"Microsoft.AspNet.Server.IIS"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.0-beta5"</span></span>, <span class="hljs-string"><span class="hljs-string">"Microsoft.AspNet.Server.WebListener"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.0-beta5"</span></span>, <span class="hljs-string"><span class="hljs-string">"Microsoft.AspNet.Mvc"</span></span>: <span class="hljs-string"><span class="hljs-string">"6.0.0-beta5"</span></span> },</code> </pre><br></li><li>  In the <i>Startup.cs</i> file <i>,</i> add the use of the <i>Microsoft.AspNet.Builder</i> namespace: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNet.Builder;</code> </pre></li></ol><br>  The extensions methods we need for the MVC connection are in it. <br><br><ol><li>  Add the services that the MVC Framework uses in its work: in the ConfigureServices () method of the Startup.cs file: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { services.AddMvc(); }</code> </pre><br></li><li>  Configure the MVC application in the Configure () method of the Startup.cs file: </li></ol><br>  Three different methods are available to us: <br><br>  one. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IApplicationBuilder app</span></span></span><span class="hljs-function">)</span></span> { app.UseMvc() }</code> </pre><br>  2 <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IApplicationBuilder app</span></span></span><span class="hljs-function">)</span></span> { app.UseMvcWithDefaultRoute() }</code> </pre><br>  3 <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IApplicationBuilder app</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> app.UseMvc(routes =&gt; { routes.MapRoute( name: <span class="hljs-string"><span class="hljs-string">"default"</span></span>, template: <span class="hljs-string"><span class="hljs-string">"{controller=Home}/{action=Index}/{id?}"</span></span>); }); }</code> </pre><br>  Let's immediately see the <a href="">implementation of these methods</a> : <br><br>  First method: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IApplicationBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UseMvc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IApplicationBuilder app</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> app.UseMvc(routes =&gt; { }); }</code> </pre><br>  Calls the third method, passing the delegate to Action &lt;IRouteBuilder&gt;, which does nothing. <br><br>  The second method: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IApplicationBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UseMvcWithDefaultRoute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IApplicationBuilder app</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> app.UseMvc(routes =&gt; { routes.MapRoute( name: <span class="hljs-string"><span class="hljs-string">"default"</span></span>, template: <span class="hljs-string"><span class="hljs-string">"{controller=Home}/{action=Index}/{id?}"</span></span>); }); }</code> </pre><br>  Also calls the third method, only the delegate Action &lt;IRouteBuilder&gt; adds the default route. <br><br>  The third method: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IApplicationBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UseMvc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IApplicationBuilder app, Action&lt;IRouteBuilder&gt; configureRoutes</span></span></span><span class="hljs-function">)</span></span> { MvcServicesHelper.ThrowIfMvcNotRegistered(app.ApplicationServices); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> routes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RouteBuilder { DefaultHandler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MvcRouteHandler(), ServiceProvider = app.ApplicationServices }; configureRoutes(routes); <span class="hljs-comment"><span class="hljs-comment">// Adding the attribute route comes after running the user-code because // we want to respect any changes to the DefaultHandler. routes.Routes.Insert(0, AttributeRouting.CreateAttributeMegaRoute( routes.DefaultHandler, app.ApplicationServices)); return app.UseRouter(routes.Build()); }</span></span></code> </pre><br>  It does the same thing as we did in the previous section when registering a route for your handler, only sets the <i>MvcRouteHandler</i> instance as the final handler and makes a call to the <i>CreateAttributeMegaRoute</i> method - which is responsible for adding the attributes set by the controllers' attributes and action methods (Attribute-Based Routing ). <br><br>  Thus, all three methods will include Attribute-Based routing in our application, but in addition, the call to the second method will add the default route, and the third method allows you to specify any routes we need by passing them using a delegate (Convention-Based Routing). <br><br><h3>  Convention Based Routing </h3><br>  As I wrote above, it is configured by calling the <i>MapRoute ()</i> method - and the process of using this method has not changed since MVC 5 ‚Äî we can transfer the name of the route, its pattern, default values ‚Äã‚Äãand restrictions to the <i>MapRoute ()</i> method. <br><br><pre> <code class="cs hljs">routeBuilder.MapRoute(<span class="hljs-string"><span class="hljs-string">"regexStringRoute"</span></span>, <span class="hljs-comment"><span class="hljs-comment">//name "api/rconstraint/{controller}", //template new { foo = "Bar" }, //defaults new { controller = new RegexRouteConstraint("^(my.*)$") }); //constraints</span></span></code> </pre><br><h3>  Attribute-Based Routing </h3><br>  Unlike MVC 5, where the routing using attributes, it was necessary to specifically include, in MVC 6, it is enabled by default. <br><br>  It should also be remembered that routes defined using attributes take precedence when searching for matches and choosing the right route (as compared to convention-based routes). <br><br>  To set the route, you need to use the <i>Route</i> attribute both on the action methods and on the controller (in MVC 5, the <i>RoutePrefix</i> attribute was used to set the route on the controller). <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Route(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"appointments"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Appointments</span></span> : <span class="hljs-title"><span class="hljs-title">ApplicationBaseController</span></span> { [Route(<span class="hljs-string"><span class="hljs-string">"check"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ContentResult { Content = <span class="hljs-string"><span class="hljs-string">"2 appointments available."</span></span> }; } }</code> </pre><br>  As a result, this method of action will be available at: "/ appointments / check". <br><br><h3>  Configure the routing system </h3><br>  In ASP.NET 5, a new service configuration engine called <i>Options</i> - <a href="https://github.com/aspnet/Options">GitHub project has appeared</a> .  It allows you to make some settings of the routing system. <br><br>  The meaning of his work is that when setting up an application in the <i>Startup.cs</i> file <i>,</i> we transfer a certain object to the dependency registration system, with properties defined in a certain way, and when the application is running, the object gets and, depending on the values ‚Äã‚Äãof the properties set, work <br><br>  The <a href="">RouteOptions</a> class is used to configure the routing system. <br><br>  For convenience, the <i>ConfigureRouting</i> extension method is available to us: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { services.ConfigureRouting( routeOptions =&gt; { routeOptions.LowercaseUrls = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  url    routeOptions.AppendTrailingSlash = true; //     url }); }</span></span></code> </pre><br>  ‚ÄúBehind the scenes,‚Äù it simply makes a call to the <i>Configure</i> method by passing the delegate <i>Action &lt;RouteOptions&gt; to it</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureRouting</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IServiceCollection services, Action&lt;RouteOptions&gt; setupAction</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (setupAction == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(setupAction)); } services.Configure(setupAction); }</code> </pre><br><h3>  Route pattern </h3><br>  The principles of working with the route pattern are the same as in MVC 5: <br><br><ul><li>  Address segments are separated by a slash: <i>firstSegment / secondSegment</i> . </li><li>  The constant part of a segment is considered if it is not bordered by curly brackets, the correspondence of such a route to the requested Url occurs only if the same values ‚Äã‚Äãare present in the address: <i>firstSegment / secondSegment</i> - this route corresponds only to the address of the form: <i>siteDomain / firstSegment / secondSegment</i> . </li><li>  Variable parts of a segment are taken in curly brackets: <i>firstSegment / {secondSegment}</i> - the pattern will correspond to any two segment addresses, where the first segment is ‚ÄúfirstSegment‚Äù and the second segment can be any character set (except slash - since this will mark the beginning of the third segment ): <br><br>  "/ firstSegment / index" <br><br>  "/ firstSegment / index-2" <br><br></li><li>  Restrictions for the variable part of the segment, as the name implies, limit the allowable values ‚Äã‚Äãof the variable segment and are set after the ":" character.  Several variables can be imposed on one variable part, parameters are passed using parentheses: <i>firstSegment / {secondSegment: minlength (1): maxlength (3)}</i> .  String designation of restrictions can be found in the <a href="">GetDefaultConstraintMap () method of the RouteOptions class</a> . </li><li>  In order to make the last segment ‚Äúgreedy‚Äù, so that it will absorb the rest of the address line, you need to use the * symbol: <i>{controller} / {action} / {* allRest}</i> - will correspond to the address: "/ home / index / 2 ", and the address:" / home / index / 2/4/5 ". </li></ul><br>  But in ASP.NET 5, the route pattern got some additional features: <br><br><ol><li>  The ability to set right in it the default values ‚Äã‚Äãfor variable parts of the route: <i>{controller = Home} / {action = Index}</i> . </li><li>  Set the optional part of the segment using the symbol?: <i>{Controller = Home} / {action = Index} / {id?}</i> . </li></ol><br>  Also, when using the route pattern in the attributes, changes occurred: <br><br>  When setting up routing through attributes, the parameters designating the controller and the action method should now be addressed by taking them in square brackets and using the words "controller" and "action": "[controller] / [action]" - and you can only use them in such View - neither default values, nor restrictions, nor options, nor greed are allowed. <br><br>  That is, it is allowed: <br><br><pre> <code class="cs hljs">Route(<span class="hljs-string"><span class="hljs-string">"[controller]/[action]/{id?}"</span></span>) Route(<span class="hljs-string"><span class="hljs-string">"[controller]/[action]"</span></span>)</code> </pre><br>  You can use them separately: <br><br><pre> <code class="cs hljs">Route(<span class="hljs-string"><span class="hljs-string">"[controller]"</span></span>) Route(<span class="hljs-string"><span class="hljs-string">"[action]"</span></span>)</code> </pre><br>  Not allowed: <br><br><pre> <code class="cs hljs">Route(<span class="hljs-string"><span class="hljs-string">"{controller}/{action}"</span></span>) Route(<span class="hljs-string"><span class="hljs-string">"[controller=Home]/[action]"</span></span>) Route(<span class="hljs-string"><span class="hljs-string">"[controller?]/[action]"</span></span>) Route(<span class="hljs-string"><span class="hljs-string">"[controller]/[*action]"</span></span>)</code> </pre><br>  The general scheme of the route pattern is as follows: <br><br><pre> <code class="cs hljs">constantPart-{variablePart}/{paramName:constraint1:constraint2=DefaultValue?}/{*lastGreedySegment}</code> </pre><br><h3>  Conclusion </h3><br>  In this article, we went over the ASP.NET 5 routing system, looked at how it was organized, and connected it to an empty ASP.NET 5 project using our route handler.  Dismantled ways to connect it to the MVC application and configuration using the Options mechanism.  We stopped at the changes that have occurred in the use of Attribute-Based routing and route pattern. <br><br><h3>  To authors </h3><br>  Friends, if you are interested in supporting the column with your own material, please write to me at <a href="">vyunev@microsoft.com</a> to discuss all the details.  We are looking for authors who can interestingly tell about ASP.NET and other topics. <br><br><img align="right" width="250" src="https://habrastorage.org/files/c61/df1/f91/c61df1f916b04d7999203c2af32bc1c4.png"><h3>  about the author </h3><br>  <b>Boyarintsev Stanislav Aleksandrovich</b> <br>  Lead .NET Programmer at ItWebNet, Kirov <br>  <a href="https://habrahabr.ru/users/masterl/" class="user_link">masterL</a> <br><br>  .NET programmer with 4 years of experience.  Engaged in the development of corporate web systems.  Professional interests: ASP.NET MVC. <br>  Blog: <a href="http://boyarincev.net/">boyarincev.net</a> </div><p>Source: <a href="https://habr.com/ru/post/268037/">https://habr.com/ru/post/268037/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268025/index.html">How-to: The process of creating the layout of html-letters</a></li>
<li><a href="../268029/index.html">Security vulnerability detected in WinRAR software</a></li>
<li><a href="../268031/index.html">Apiway - a new way of client-server data transport</a></li>
<li><a href="../268033/index.html">We balance the mechanics in games</a></li>
<li><a href="../268035/index.html">Bad "Spring" or as the reasons for the delays were looking for</a></li>
<li><a href="../268039/index.html">Predicting Titanic Passenger Survival with Azure Machine Learning</a></li>
<li><a href="../268047/index.html">Asterisk. This time, as a background music broadcasting system with the possibility of emergency notification</a></li>
<li><a href="../268055/index.html">Support for geolocation and corrected sketches of the express panel in the assembly Vivaldi 1.0.288.3</a></li>
<li><a href="../268057/index.html">CUSTIS Open Seminars: Graduation Season</a></li>
<li><a href="../268061/index.html">Democracy and Program Committee</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>