<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>BK-0010 emulator on FPGA</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most amateur projects FPGA, published on Habr√©, made on the equipment of the company Altera (now Intel). Let's take a look at what can be done on the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>BK-0010 emulator on FPGA</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/a36/f50/0e9/a36f500e94974df38078f91fe5cee6c6.jpg"><br><br>  Most amateur projects FPGA, published on Habr√©, made on the equipment of the company Altera (now Intel).  Let's take a look at what can be done on the products of its main competitor - Xilinx.  We will take and make a fairly large and complex project, in the process of implementation of which we will need: <br><br><ul><li>  Select Development board and necessary PMOD to it. </li><li>  Decide on the design of the project, select the clock domains and the transition rules between them. <br></li><li>  Master the basic functions of Xilinx Vivado - creating a project, working with block schemes, compilation, simulation, debugging </li><li>  Make multiple IPs with AXI4 interface </li><li>  Work with external devices </li><li>  Make your own processor from scratch with a bus controller and interrupt handling </li><li>  Write a module for verification </li><li>  Finally, put everything together and get the FPGA implementation of the legendary (at least for those who then lived) computer of the mid-80s - BK-0010 </li></ul><br>  A series of articles is planned, in which all of this will be described in detail, today the first of them.  The project is written on System Verilog with small inserts Verilog and VHDL where it is needed.  The reader is required to understand the basic principles of Verilog / VHDL languages ‚Äã‚Äãat the <a href="https://habrahabr.ru/post/306982/">Harris &amp; Harris</a> book level. <br><a name="habracut"></a><br><h3>  A few words about the BK-0010 </h3><br>  The BK-0010 appeared in 1986 and was a single-board computer based on the KR1801BM1 processor (DEC PDP-11 command system).  As the story goes, we‚Äôll have to consider some of its architectural features, but for the time being we‚Äôll confine ourselves to those characteristics of a computer that will be important for us to choose a card and other equipment: <br><table><tbody><tr><th>  Characteristic </th><th>  Value </th></tr><tr><td>  CPU </td><td>  3 MHz, the number of transistors is about 18000 (n-MOS) </td></tr><tr><td>  Ram </td><td>  32 KB </td></tr><tr><td>  ROM </td><td>  8-32 KB </td></tr></tbody></table><br>  Output devices 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Home TV, 512x256 in black and white or 256x256 in color (each point could have 4 colors independently of the others) </li><li>  Sound tweeter (output 1 bit), combined with the output to a tape recorder </li></ul><br>  Input Devices <br><br><ul><li>  Keyboard with the location of the keys JCUKEN </li></ul><br><img src="https://habrastorage.org/files/1a2/ec5/1ef/1a2ec51efecf4ae39e1d5d5e2177ea0f.jpg"><br><br><h3>  Board selection </h3><br>  What fee and on which crystal to take for the project?  In the case of a crystal, our requirements can be selected from Artix-7 and Zynq-7000, in both cases the smallest crystal will suffice.  Boards for development - something Xilinx does itself, these are boards with a very rich filling, but with a four-digit price tag.  There is a European company Trenz Electronic GmbH, but I would say that their products are more focused on the creation of ready-made devices.  In my opinion, the most suitable boards with Xilinx chips for amateur use are made by Digilent.  On Artix-7, this is Basys-3, Nexus 4 DDR and Nexus Video, on Zynq-7000, this is Zybo and ZedBoard. <br><br>  For myself, I stopped at the Zybo.  This board is one of the cheapest ($ 189, and if you convince Digilent that you meet the requirements of the Academic Discount Program, then $ 125), it has both VGA and HDMI outputs, many PMOD ports, 512MB RAM.  Yes, this board is based on SoC, and I do not plan to use the capabilities of the processor core in this project.  But no one bothers to use this board just as FPGA.  The board does not have seven-segment debug indicators and no PS2 or USB keyboard can be connected to the FPGA part (unlike the more expensive Nexus 4 DDR), but the price difference between the two boards is much more than the cost of PMOD modules, on which this functionality can receive. <br><br>  So, in the dry residue, for the project we need the following equipment: <br><br>  <b>Zybo</b> <br><div style="text-align:center;"><img src="http://cdn6.bigcommerce.com/s-7gavg/products/98/images/4462/Zybo-obl4-academic-600__71953.1491605756.1280.1280.png" alt="Zybo"></div><br>  <b>PMOD-SSD</b> - two seven-segment indicators for debugging <br><div style="text-align:center;"><img src="http://cdn6.bigcommerce.com/s-7gavg/products/212/images/3880/Pmod_SSD__99365.1456867364.1280.1280.png" alt="PMOD-SSD"></div><br>  <b>PMOD-PS2</b> - for connecting a PS / 2 keyboard.  I am so ready to buy, I forgot, so I had to make it myself.  At the same time I put DC-DC converter 3.3-&gt; 5V there because the keyboard I have from 3.3V did not work. <br><div style="text-align:center;"><img src="http://cdn6.bigcommerce.com/s-7gavg/products/202/images/3870/Pmod_PS2__63402.1456867133.1280.1280.png" alt="PMOD-PS2"></div><br><div class="spoiler">  <b class="spoiler_title">I do not want to use an outdated PS / 2, but I want to connect a keyboard via USB.</b> <div class="spoiler_text">  It is possible and so, but there are some difficulties. <br>  There is a USB Host on the Zybo, but it is connected to the PS part.  If a PL project is planned, then you will need to connect a separate USB host to the board. <br>  The full specification of the USB protocol (with support for HOST and all types of devices) is very difficult to implement on FPGA, and the USB interface is quite high-frequency.  A reasonable compromise is to connect an external physical layer converter, for example, via the ULPI interface; to work with the ULPI, you can find a complete IP module on Verilog / VHDL.  You can also choose another motherboard that already has a USB host for working with keyboards and mice (in Digilent this is, for example, Nexus 4 DDR). </div></div><br><h3>  Getting started with Xilinx Vivado </h3><br>  Projects for Xilinx (in this case, talking about the 7th series of chips) are created in Xilinx Vivado.  Since we are not planning to use High-end chips (UltraSCALE / UltraSCALE +), the free <a href="https://www.xilinx.com/products/design-tools/vivado/vivado-webpack.html">Xilinx Vivado WebPACK edition is</a> suitable for our purposes.  We register on xilinx.com, download it and install it. <br><br><div class="spoiler">  <b class="spoiler_title">System requirements</b> <div class="spoiler_text">  This is mainly RAM.  For Zybo it is difficult, but 8GB is enough, for more powerful chips you need more. <br></div></div><br>  To work with Zybo, we will need to download and add to Vivado the Vivado Board Files package containing the description of the interfaces available on the board, the frequency characteristics of the chip, and the like.  Download it from the site Digilent (or rather from <a href="https://github.com/Digilent/vivado-library">GitHub</a> ) and add it to Vivado. <br><br>  You will also need a resource file, which describes the correspondence of the contacts of the chip to the pin numbers of the connectors of the board.  We find our board, in this case Zybo on <a href="https://github.com/Digilent">GitHub / Digilent</a> and download. <br><br>  And finally, we will do the first project on Verilog.  We will need this project in the future to create the keyboard controller BK-0010. <br><br>  I have such a rare Mitsumi keyboard with PS / 2 interface: <br><br><img src="https://habrastorage.org/files/cce/fed/6b5/ccefed6b5355464cb98f26c749fb53ae.jpg"><br><br>  <a href="https://habrahabr.ru/users/ishevchuk/" class="user_link">ishevchuk</a> in his project used <a href="http://www.eecg.toronto.edu/~jayar/ece241_08F/AudioVideoCores/ps2/ps2.html">this controller</a> to work with a PS / 2 keyboard. <br><br>  Take it and we slightly redo it.  The controller is all good except that the clock frequency of 50 MHz is rigidly sewn into it.  Such frequency in our project BK-0010 will not be, moreover, hardcoded such things is not good.  Create a new project in Vivado, download the controller files and set the clock frequency as a parameter: <br><br><div class="spoiler">  <b class="spoiler_title">Formula header with formulas</b> <div class="spoiler_text"><pre><code class="hljs vhdl">module Altera_UP_PS2_Command_Out # ( <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> CLOCK = <span class="hljs-number"><span class="hljs-number">100</span></span>, // Timing info <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> initiating Host-<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>-Device communication // <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> using a <span class="hljs-number"><span class="hljs-number">50</span></span>MHz system clock <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> CLOCK_CYCLES_FOR_101US = (CLOCK * <span class="hljs-number"><span class="hljs-number">101</span></span>), // <span class="hljs-number"><span class="hljs-number">5050</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> NUMBER_OF_BITS_FOR_101US = $clog2(CLOCK_CYCLES_FOR_101US), <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> COUNTER_INCREMENT_FOR_101US = <span class="hljs-number"><span class="hljs-number">1</span></span>, // Timing info <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> start <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> transmission <span class="hljs-literal"><span class="hljs-literal">error</span></span> // <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> using a <span class="hljs-number"><span class="hljs-number">50</span></span>MHz system clock <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> CLOCK_CYCLES_FOR_15MS = (CLOCK * <span class="hljs-number"><span class="hljs-number">15000</span></span>), // <span class="hljs-number"><span class="hljs-number">750000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> NUMBER_OF_BITS_FOR_15MS = $clog2(CLOCK_CYCLES_FOR_15MS), <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> COUNTER_INCREMENT_FOR_15MS = <span class="hljs-number"><span class="hljs-number">1</span></span>, // Timing info <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> sending data <span class="hljs-literal"><span class="hljs-literal">error</span></span> // <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> using a <span class="hljs-number"><span class="hljs-number">50</span></span>MHz system clock <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> CLOCK_CYCLES_FOR_2MS = (CLOCK * <span class="hljs-number"><span class="hljs-number">2000</span></span>), // <span class="hljs-number"><span class="hljs-number">100000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> NUMBER_OF_BITS_FOR_2MS = $clog2(CLOCK_CYCLES_FOR_2MS), <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> COUNTER_INCREMENT_FOR_2MS = <span class="hljs-number"><span class="hljs-number">1</span></span> )</code> </pre> <br></div></div><br>  Some of the modules in the project in their name have the word Altera.  On Xilinx, this does not prevent them from working, out of respect for the developer, I did not rename them. <br><br>  In addition, we change the polarity of the RESET signal; for standard IP Xilinx, a reset occurs when 0 is applied to the RESET input. <br><br>  For convenience, let's design the project in the form of IP.  In Vivado there is a built-in tool that does this, it is called via Tools-&gt; Create and Package new IP.  The inputs and outputs of the project head file will become the inputs and outputs of our new IP.  Vivado tries to determine the type of ports by analyzing their name.  In this case, we will have to intervene in this process and exclude the PS2_CLK port from the Clock and Reset Signals to reduce the number of Warnings during the further assembly of the project.  PS2_CLK cannot be called a full-fledged clock signal, since its frequency is only a few tens of kilohertz. <br><br>  The tool is very flexible, we can not only set the type of ports, but also manage various parameters, set the conditional compilation options, change the appearance of IP depending on the parameters.  In this project, we have two parameters - Initialize Mouse (device selection - keyboard or mouse) and Clock (clock frequency in megahertz).  We will consider the issues of conditional compilation later when we write a module for working with the MPI bus. <br><br><img src="https://habrastorage.org/files/241/e8c/d58/241e8cd581d844ef9a3942207fedf713.png"><br><br><h3>  Connect Git to Vivado </h3><br>  Finally (and in general, of course, this should be done immediately after the creation of a new project) to Vivado Git.  Verilog / VHDL source texts, constraints, component descriptions, IP module interface descriptions, the project itself and so on are text files, everything is simple with them.  But there is one difficulty - in the project file (it is in XML format) there are absolute paths to the source code, this can cause some problems when transferring the project between machines.  One of the solutions is to use a ready-made tool (written by Xilinx engineers), this tool based on the Vivado project creates a portable tcl script that, when launched on the target machine, creates a project there that is identical to the original one.  A wrapper has been added to this tool, automating the creation of a tcl script, filling in the .gitignore file, handling input errors and the like.  After installing <a href="https://github.com/skyroger2/vivado-git">this wrapper</a> , it is possible to work with Git directly from the Vivado tcl console. <br><br><h3>  Fill the project in iron </h3><br>  Let's check now how it all works.  Close the project of the PS2 controller and create a test project that receives scan codes from the keyboard and issues them to the seven-segment indicator.  In this project, we will not write a single line of Verilog-code, but we will assemble a scheme from ready-made IP modules. <br><br>  In IP Integrator we create a new block design, add an IP into it and connect them until such a scheme is obtained: <br><br><img src="https://habrastorage.org/files/1ce/7bb/b96/1ce7bbb9628047cca31aea2ac791ed09.png"><br><br>  The following IPs were used here: <br><br>  <b>Clocking wizard Sync</b> signal creation module.  Designed to create sync signals (up to 6 pieces) with different frequency and duty cycle (in this case, one meander 100MHz).  The system clock (125 MHz) is fed to the input.  Uses the PLL resource, the output sync signals are distributed through the corresponding crystal resources.  Standard Xilinx module. <br><br>  <b>Binary Counter.</b>  Custom divider, in this case 8-bit.  Standard Xilinx module. <br><br>  <b>Slice.</b>  The bus divider, in this case, pulls out the high-order bit from the Binary Counter, thus forming a divisor by 256. The standard Xilinx module. <br><br>  <i>In general, such things cannot be done with the clock signal, you need to take another exit from the Clocking Wizard and correctly configure Clock Domain Crossing.</i>  <i>But in this case, for the operation of SSD_pmod, any frequency from hundreds of hertz to hundreds of kilohertz, which is not synchronized with anything at all, is suitable.</i> <br><br>  <b>SSD_pmod.</b>  A module that displays a byte in hexadecimal form on a two-digit seven-segment indicator Digilent PMOD-SSD.  Byte is fed to the input of the module.  The source code module is posted on GitHub. <br><br>  <b>PMOD_GPIO.</b>  A module that describes how to work with signals in the PMOD connectors.  Depending on the type of module connected to the connector, different protocols are used - GPIO, SPI, I2C, UART.  I took the module written by Digilent to support my PMOD, and slightly changed it.  The source code module is posted on GitHub. <br><br>  <b>Constant</b> module <b>.</b>  This is just a constant of 0 or 1. In this case, we don‚Äôt use the transfer in the direction of the keyboard, so the send_command and the_command inputs are 0, and the reset input is 1 (in the final project we will have a full reset circuit). <br><br>  Finally <b>PS2_controller, the</b> module we created in the previous step.  Do not forget to specify the path to it in the project properties so that it can be added. <br><br>  We use the following external connections: <br><br>  <b>sys_clock A clock</b> signal <b>125MHz</b> from an external oscillator on the board (pin L16).  Used to run PLL. <br>  <b>PMOD_C</b> A keyboard is connected to port C, bits JC2 (W15) and JC4 (T10) are used <br>  <b>PMOD_D</b> A seven-segment indicator is connected to port D, all 8 bits are used. <br><br>  We save the block design, generate a Verilog wrapper (Generate HDL Wrapper ...), compile the project (Generate Bitstream), upload it via JTAG to the board (Open Hardware Manager, Open Target, Program Device).  Now when you press the buttons on the keyboard, their scan codes will be displayed on a seven-segment display: <br><br><img src="https://habrastorage.org/files/3f4/9dc/af9/3f49dcaf964e4416b024a87a3e896356.jpg"><br>  8'h4E is '-' <br><br><h3>  Links </h3><br>  For those who want to try all this on hardware, all the sources are posted on Github: <br><br>  ‚Üí <a href="https://github.com/skyroger2/vivado-git">Wrapper to work with Git from Vivado</a> <br><br>  In addition, you will need to install: <br><br>  ‚Üí <a href="https://github.com/Digilent/vivado-library">Description of interfaces and boards of Digilent, including Zybo</a> <br>  ‚Üí <a href="https://github.com/skyroger2/PMOD_GPIO">Once</a> and <a href="https://github.com/skyroger2/SSD_PMOD">twice</a> - auxiliary modules for outputting hexadecimal numbers to a seven-segment indicator <br>  ‚Üí <a href="https://github.com/skyroger2/PS2">PS2 keyboard controller</a> <br>  ‚Üí <a href="https://github.com/skyroger2/PS2_keyboard_test">The module in which it all connects together</a> <br><br>  To install the module, you need to download it from Github and run the .tcl file in the root from under Vivado </div><p>Source: <a href="https://habr.com/ru/post/327996/">https://habr.com/ru/post/327996/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327984/index.html">Mikrotik guarding temperature</a></li>
<li><a href="../327986/index.html">We broadcast a video stream from a web page via WebRTC to Facebook and YouTube at the same time</a></li>
<li><a href="../327988/index.html">Free from all shackles: Emercoin version 6.2 has become completely decentralized</a></li>
<li><a href="../327990/index.html">Pentestit Security Conference 2017: reports</a></li>
<li><a href="../327994/index.html">We check the code of the dynamic analyzer Valgrind using a static analyzer</a></li>
<li><a href="../327998/index.html">Conference Outsource-People 2017, Krakow (day two)</a></li>
<li><a href="../328000/index.html">Segmentation of text lines of documents into characters using convolutional and recurrent neural networks</a></li>
<li><a href="../328002/index.html">SimplePage: a simple, declarative framework for rapid prototyping</a></li>
<li><a href="../328004/index.html">Part 3. Where to store data for decentralized applications on the blockchain?</a></li>
<li><a href="../328006/index.html">‚ÄúThe incident with Gitlab is a very good and revealing story‚Äù, - Alexey Lesovsky about PostgreSQL administration</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>