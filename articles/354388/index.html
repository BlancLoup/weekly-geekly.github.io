<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Backend optimization when switching to api-based architecture</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr. 

 At a recent mitup at the Tutu office, I talked about how we, as part of superjob.ru's redesign , made the transition from a monolithic ap...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Backend optimization when switching to api-based architecture</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/sh/bu/qx/shbuqxk-z7l6owzzdbe23tlmh94.png"><br><br>  Hi, Habr. <br><br>  At a recent <a href="https://habrahabr.ru/company/tuturu/blog/351746/">mitup at the Tutu office,</a> I talked about how we, as part of <a href="http://www.superjob.ru/">superjob.ru's</a> redesign <a href="http://www.superjob.ru/">,</a> made the transition from a monolithic application to an api-based architecture with beautiful single page applications on ReactJS on the front and a smart PHP application on the backend.  In this article, I would like to tell you more about how we optimized our backend application so that it really becomes smart. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Interested - I ask under the cat. <br><a name="habracut"></a><br><h3>  Initial setup </h3><br>  We had a monolithic application on Yii1.  Some symfony components have been added to Yii: for example, DI, Doctrine, EventDispatcher, and other magic.  All this stuff spun under PHP 7.1. <br>  As part of the site redesign, we decided to divide the monolith into two applications: one was responsible for the business logic and API, and the other - exclusively for rendering.  Since the volume of the Superjob codebase inspires respect for experienced fighters, and fear for inexperienced ones, seditious thoughts of rewriting everything from scratch to go / again from scratch have been rejected.  As the custodian of business logic and API provider, it was decided to use part of the monolith on Yii, and for rendering, the new application had to be responsible for ReactJS.  Communicate with each other applications should have been through the <a href="http://jsonapi.org/">JSON API</a> .  So we wanted to get the following setup: <br><br><img src="https://habrastorage.org/webt/3b/db/ch/3bdbchny8oo77hvjudrrlptnzx0.png"><br><br>  To teach the application on Yii to talk on the JSON API, after long deliberation, we implemented our solution with the original name Mapper, which was already an <a href="https://habrahabr.ru/company/superjob/blog/335910/">article on Habr√©</a> . <br><br>  Mapper allowed us to describe model conversions in the essence of the JSON API using yaml-configs, which were then compiled into php-code.  It looked like this: <br><br><img src="https://habrastorage.org/webt/7l/bn/g8/7lbng8kjglzp6wgh3s4gypxswdm.png"><br><br>  This allowed us to write significantly less code with our hands, and also guaranteed uniformity of entities of a certain type in the API. <br><br>  In addition, the Mapper took over the automation of many things, including: <br><br><ul><li>  work with JSON API transport layer, </li><li>  interaction with the database (ActiveRecord, Doctrine), </li><li>  communication with services and DI, </li><li>  access check, </li><li>  validation of models </li><li>  documentation generation </li><li>  anything else that is very lazy to do with your hands. </li></ul><br>  Thanks to Mapper, we were able to implement as quickly as possible new endpoints, which were immediately picked up by the front-end application, the development of which proceeded in parallel. <br><br><h3>  Optimization </h3><br>  After analyzing the first results of the front-end application, we found that it generates an average of <b>about 10 requests to the API per page</b> , which means we should seriously think about optimizing the backend: the slower the API runs, the more the UX application suffers, requests consistently. <br><br><h4>  Mapper optimization </h4><br>  We decided to start from the most obvious - from the core of our API. <br><br>  First of all, we made sure that Mapper did not perform the same work several times.  Often in the API response the same entity may be mentioned several times (for example, several vacancies with a link to one company, several resumes belonging to one person, and so on), but we absolutely need to process the same thing several times.  Therefore, we taught the Mapper to quickly understand with which models he was already working with in the framework of the current request, and to eliminate doubles.  It would seem that there is difficult?  If we know that models of a certain type that have a unique value in a certain property / getter can be transferred to us, the problem is solved trivially.  But in a more general case, when neither the type nor the unique attribute is guaranteed to us, and the structure transferred to us can be a tree, everything becomes much more complicated.  In the case of Mapper, we solved the duplicate search problem using the <a href="http://php.net/spl_object_hash">spl_object_hash</a> combination and additional checks specific to our models.  However, I want to warn the young Padawans who wish to repeat our path: do not underestimate the <s>enemy</s> warning in the documentation for spl_object_hash.  The probability that the hash of the destroyed object will be reused in the same request is too high, so relying on the values ‚Äã‚Äãreturned by this function is only when you are sure that none of the objects will be destroyed before you finish calculate hashes. <br><br>  To eliminate duplicates, we took another step: since the JSON API allows the client to request hierarchical relationships of entities, for example, the following query of connections will be legitimate: <b>user.resume.user.resume.user.resume</b> .  Handling such links is a real pain, so we taught the Mapper how to handle such cases.  Links that refer to each other were marked in the config with a special attribute, and when parsing the request, Mappper normalized the list of links, removing duplicates. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cw/-q/vk/cw-qvk_qnikdl3vlrbz9psy3qry.png"></div><br><br>  During the work on Mapper, we came up with two types of services that allowed us to influence the final API response: these are access rules and modifiers.  The former allowed or denied access to a particular entity, and the latter could perform various transformations on the attributes and relationships of entities.  Transmitting each entity into such services separately was a rather expensive pleasure, so we taught the Mapper to combine entities that require additional processing into collections, which were then transferred to the services.  At its core, the mechanism for forming such collections was similar to transactions in the database: when we walked through the model tree, we rendered simple entities at once, and complex entities were sent to collections, where we waited for the tree to crawl.  Then came the moment of commit ‚Äî and the entities processed by the services took their places in the response tree. <br><br>  Since Mapper uses compilation of entity configs into php code for its work (and at the moment in our API there are <b>over 220 entities</b> ), we made sure that the compiled code was as compact as possible: <br><br><ul><li>  we take repeated pieces of code into common functions and traits; </li><li>  we postpone the instantiation of objects, and if the objects are already instantiated, then we try to reuse them; </li><li>  at the compilation stage, we try to perform all checks that are not dependent on runtime in order to reduce the number of actions in processing requests. </li></ul><br><h4>  Bootstrap optimization </h4><br>  After optimizing Mapper, we started optimizing the bootstrap of our application. <br><br>  To determine what is done with each request, we created an empty endpoint that did absolutely no useful work, and set a profiler on it (we use a bunch of <a href="https://tideways.io/">tideways</a> + <a href="https://blackfire.io/">blackfire</a> ). <br><br>  One of the problems of our bootstrap was too many services that were instantiated when the application was started, and, as a result, a large number of include files.  That should be fixed. <br><br>  We analyzed the services that the bootstrap itself instantiated, and abandoned some of them.  We began to instantiate a part of the services depending on the current context: for example, we did not instantiate the service responsible for authorizing the user if the request did not include an authorization header.  For services whose instantiation took significant time, we began to use the extension for Symfony DI - <a href="https://symfony.com/doc/current/service_container/lazy_services.html">Lazy Services</a> .  This extension replaces the service instance with a lightweight dummy, and the service itself is not instantiated until the first access to it. <br><br>  Then we decided to optimize the EventDispatcher.  The fact is that by default EventDispatcher instantiates all its listeners, and this creates a tangible overhead, if there are many such listeners.  To solve this problem, we wrote our CompilerPass for DI, which, based on the features of our application, either did not instantiate listeners at all, or instantiated some of them. <br><br>  Finally, in order to further reduce the number of connected files, we performed a small optimization of the DI itself.  By default, DI adds the reflection cache of a single class into several keys (in our case, files), which leads to a significant increase in read and deserialization operations.  We rewrote the class responsible for collecting and caching reflection so that the cache for one class is kept in one key.  This, despite the slightly increased cache size, gave us a gain in time by reducing the number of read operations. <br><br>  In the end, all of our optimizations allowed us to reduce cpu consumption by 40% and save some memory. <br><br><img src="https://habrastorage.org/webt/b7/zj/3j/b7zj3j1dk51xvdbgpm9-moa6zlo.png"><br><br><h4>  Endpoint Optimization </h4><br>  Finally, the final step in optimizing the backend was optimizing specific endpoints. <br><br>  Since the only source of information for the front-end application was our API, we had a number of endpoints with reference books, dictionaries, configs, and other rarely changed data.  Especially for such endpoints, we added support for server caching: the vocabulary endpoint using the combination of the <b>Cache-Control</b> and <b>Expires</b> headers could ask nginx to cache the response body for a certain amount of time. <br><br>  For the rest of endpoints, we armed with special tools.  We integrated our API with the debug-panel: with each API response, a link to the panel came in which we could go and see what was happening inside the endpoint: <br><br><img src="https://habrastorage.org/webt/0w/h8/eg/0wh8egaqjokv6va3wqwzmjtwui4.png"><br><br>  The data from the panel fell into a pivot table, from which it was possible to obtain information about the working hours of endpoints, as well as a look at the profiling in blackfire. <br><br>  Thanks to this set of tools, problem endpoints were literally visible to the naked eye, but we still armed with scripts that analyzed the table and looked for anomalies there.  The latter were divided, as a rule, into two types: either the endpoint started to slow down with a certain combination of filters, or - with large amounts of requested data.  For each problematic case, we conducted an investigation and made corrections. <br><br><h3>  Results </h3><br>  Compared to the old site, the speed of the initial page load in the redesign, despite the increased load on the backend, remained almost unchanged, and all subsequent transitions became noticeably faster thanks to the architecture of the front-end application, which does not require a complete redrawing of the page during each transition. <br>  In addition to winning in speed, we got a cleaner code both on the back and on the front: the back does not think about the mapping, and the front does not keep business logic. <br>  The division of the monolith into separate applications also influenced the speed of development and delivery of features to end users.  Automating the routine in the backend application allowed us to implement endpoints for new features faster, and a clear specification made it possible for our colleagues from the front team to develop in parallel, using moki instead of endpoints. <br><br>  We hope that our experience has been useful to someone, and is always happy to answer your questions in the comments. </div><p>Source: <a href="https://habr.com/ru/post/354388/">https://habr.com/ru/post/354388/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354376/index.html">Who should NOT move to the cloud and why</a></li>
<li><a href="../354378/index.html">Why and how to conduct backlog grooming in grocery teams?</a></li>
<li><a href="../354380/index.html">Books on design systems</a></li>
<li><a href="../354384/index.html">Made an attack on MyEtherWallet, through the interception of Amazon DNS service using BGP</a></li>
<li><a href="../354386/index.html">GDPR as a weapon of mass destruction</a></li>
<li><a href="../354390/index.html">Ubuntu 18.04 LTS: what's new?</a></li>
<li><a href="../354392/index.html">Solar JSOC Forensics: mining case on 32 non-existent hypervisors</a></li>
<li><a href="../354394/index.html">How to improve performance using serverless architecture</a></li>
<li><a href="../354396/index.html">Open source and mentoring: writing code that saves lives</a></li>
<li><a href="../354398/index.html">rholang - programming language for distributed systems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>