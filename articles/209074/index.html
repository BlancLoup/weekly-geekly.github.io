<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Raising the Thunderbolt Ethernet Adapter on XenServer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear Habro community, I got a hand to write a post about how I made the Thunderbolt Ethernet Adapter from Apple work under XenServer 6...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Raising the Thunderbolt Ethernet Adapter on XenServer</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/c9f/b1a/ff2/c9fb1aff2bbfdd0196a8b479b40cdcfa.jpg" align="left">  Good afternoon, dear Habro community, I got a hand to write a post about how I made the Thunderbolt Ethernet Adapter from Apple work under XenServer 6.2, under the cut a manual that will help you save time if you decide to do the same. <br><br>  As it turned out in the course of the play, installing something on Citrix XenServer is quite troublesome, and if you really need to assemble a driver from the list, which is exactly what we need, then this is not even an achievable task.  My assumption that this was done not by chance, but for reasons of security and performance of the host system, because each extra package in the system requires overhead and reduces the security of the system as a whole. <br><br><a name="habracut"></a><br><h3>  Background (Who is not interested, go to the <a href="https://habr.com/ru/post/209074/">next section</a> ) </h3><br>  In 2010, already far away, I had the task of raising a server with several virtual machines at home that would carry out their non-complex task around the clock, and most importantly would not interfere with the peace of people near this piece of iron.  After a long selection ( <s>thanks to the successfully found ad on Avito</s> ), the choice fell on a Mac Mini Server with C2D 2.5Ghz, 8GB Ram, 2x500Gb HDD characteristics, looking ahead to say that this car is still on duty on duty, in fact, it is said - done, and now he is adorning on the table, all such aluminum with a white top, in general, candy.  The search for the hypervisor began, first of all due to my own stupidity and oversupply of money, Parallels Server for Mac 4.0 Mac mini edition was chosen, which cost me about 9k wood, and was able to simultaneously run as many as two (!) Virtual machines, for the initial purposes of this enough and everything was fine. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But over time, as usual, this began to be missed, it took more VM, it was said - done, some more Mac Mini with an already more impressive config, i7 2.0 (4 cores 8 streams) were added, packed in 16Gb Ram and everything would be fine However, it became sad to launch only 2 VMs on one machine, which you need - then 1 core and 1GB Ram it was decided to study the Internet to search for another more interesting hypervisor, which allowed it to run ... well, at least not two VMs. <br><br>  During the survey, HyperV and ProxMox were tested, but the choice was on Xen, or rather on the Xen Cloud Platform, which, to my great regret, did not last long and somehow I saw a message one day that XCP was closed and XenServer now free, nothing to do, go to XenServer.  Further - more, a pack of servers, I want High Available, for these cases a separate Xeon e3-1240v2 server with 16GB Ram was purchased on board, in the Hot Swap baskets of which a WD Red 3TB HDD bundle, Nas4Free on a USB flash drive was mounted, iSCSI target was raised moon, assembled Xen cluster, which is able to HA migration on the move and other nice buns, but over time I began to notice that for n VMs a 1Gb / s throughput channel is not enough, and it ran like the VM images themselves NAS'a server and data stored on the same NAS'e.  It was decided to put a reasonable switch, which is able to 802.3ad, and then on NAS'e to grow the number of ethernet channels up to 6x1GB / s, and on servers up to 2x1GB / s, but as soon as the Apple Thunderbolt Ethernet Adapter fell into the hands, it began in the farm morning, which resulted in this article on Habr√© ... <br><br><a name="Example1"></a><br><h3>  Let's get started </h3><br>  And so we have: <ul><li>  Apple Thunderbolt Ethernet Adapter (MD463ZM), which is a 10/100 / 1000BASE-T PCIe network card from Broadcom, model NetXtreme BCM57762 </li><li>  Motherboard with a Thunderbolt connector (the interface is nothing more than PCIe, only as a wire) </li><li>  Windows-based computer to use XenCenter </li></ul><br>  In our case, the experimental was Mini Mac Server mid 2011 with XenServer 6.2 installed on it and updated to SP1. <br><br>  1. We connect the adapter to the connector, insert the network cable and reboot the server (it cannot be determined without rebooting), check whether the adapter is determined: <br><pre><code class="bash hljs">[root@xNode1 ~]<span class="hljs-comment"><span class="hljs-comment"># lspci ... 0a:00.0 PCI bridge: Intel Corporation DSL3510 Thunderbolt Controller [Cactus Ridge] 0b:00.0 PCI bridge: Intel Corporation DSL3510 Thunderbolt Controller [Cactus Ridge] 0c:00.0 Ethernet controller: Broadcom Corporation NetXtreme BCM57762 Gigabit Ethernet PCIe</span></span></code> </pre> <br>  It remains a mystery to me why Broadcom did not include support for this adapter in the standard driver, but the fact remains that they did not do this, most likely due to some unknown agreement with Apple. <br><br><br>  2. As mentioned earlier, installing something on the host system is quite problematic, for the reason that all unnecessary packages and even ‚Äúmake‚Äù are cut out from there, and the default repo is set to Citrix, there is no way you can block the Citrix repo and go through baserepo, but this is not our case, we will assume that we support the policy of the manufacturer and do not want to litter / harm our system. <br><br>  In Citrix, they are not fools, and at the level that they have cleaned the system of "extras", they created an image of the system with the same kernel and the entire set of packages we need to build driver images, which can then be easily installed on the host system.  This beast is called Driver Development Kit (DDK), you can download it here: <a href="http://support.citrix.com/article/CTX139817">http://support.citrix.com/article/CTX139817</a> (as of this writing, the current version is 6.2 SP1).  This iso-Schnick is nothing more than an image of a virtual machine. However, in order to import it to our Xen server, you first need to mount it in your operating system, then in the Xen Center right click on our server and select import.  To import, you must select the ova.xml file located in the ddk folder on the mounted image.  (Do not forget to add an ethernet interface when importing) <br><br><br>  3. After the image was imported, we assigned the root password, you need to get the driver source itself, it is located here: <a href="http://www.broadcom.com/support/ethernet_nic/netxtreme_desktop.php">http://www.broadcom.com/support/ethernet_nic/netxtreme_desktop.php</a> at the very bottom, called Linux (tg3) , for the convenience of habro-residents, I posted the already edited source: <a href="">http://my-files.ru/Download/wqet0i/tg3-drv.zip</a> . <br><br>  Fill the file on the DDK server, and then unpack it: <br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># wget http://my-files.ru/Download/wqet0i/tg3-drv.zip ... 2014-01-14 01:48:13 (776 KB/s) - `tg3-drv.zip` saved [349509/349509] [root@localhost ~]# unzip tg3-drv.zip</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">If you are using the original driver from the Broadcom site</b> <div class="spoiler_text">  You need to edit the file tg3.c, located in the archive tg3-3.133d.tar.gz.  Find in the file line: <br><pre> <code class="bash hljs">... {PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, TG3PCI_DEVICE_TIGON3_57761)}, {PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, TG3PCI_DEVICE_TIGON3_57765)}, ...</code> </pre><br>  and add the identifier of our device 57762, in the end should be: <br><pre> <code class="bash hljs">... {PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, TG3PCI_DEVICE_TIGON3_57761)}, {PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, TG3PCI_DEVICE_TIGON3_57762)}, {PCI_DEVICE(PCI_VENDOR_ID_BROADCOM, TG3PCI_DEVICE_TIGON3_57765)}, ...</code> </pre></div></div><br>  Before the assembly, we need a script that will build the driver image for us.  The version of the script I have corrected can be taken <a href="">http://my-files.ru/Download/ntqvvd/tg3-proj.zip</a> , the original <a href="http://discussions.citrix.com/topic/301614-bcm5754-tg3-and-vlan-tagging-do-not-work-in-xs6/">http://discussions.citrix.com/topic/301614-bcm5754-tg3-and-vlan-tagging -do-not-work-in-xs6 /</a> , post 16 (registration is required). <br><br>  Download the file, and then unpack it: <br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># wget http://my-files.ru/Download/ntqvvd/tg3-proj.zip ... 2014-01-14 02:29:38 (72.6 MB/s) - `tg3-proj.zip` saved [1738/1738] [root@localhost ~]# unzip tg3-proj.zip</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">If you use the original Script</b> <div class="spoiler_text">  You need to edit the Makefile. <br><pre> <code class="bash hljs">... RPM_VERSION := 3.110g //     ... build-iso: build-rpms ... <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> $(PACKAGE) &amp;&amp; /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/build-supplemental-pack.sh --output=$(dir $(ISO)) ... //     ... build-tarball: build-rpms ... <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> $(PACKAGE) &amp;&amp; /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/build-supplemental-pack.sh --output=$(dir $(ISO)) ... //      ...</code> </pre><br>  It should work: <br><pre> <code class="bash hljs">... RPM_VERSION := 3.133d //     ... build-iso: build-rpms ... <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> $(PACKAGE) &amp;&amp; build-supplemental-pack.sh --output=$(dir $(ISO)) ... //     ... build-tarball: build-rpms ... <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> $(PACKAGE) &amp;&amp; build-supplemental-pack.sh --output=$(dir $(ISO)) ... //      ...</code> </pre><br>  It is also necessary to edit the tg3.spec file. <br><pre> <code class="bash hljs">... Version: %{?version}%{!?version:3.110g} //     ...</code> </pre><br>  It should work: <br><pre> <code class="bash hljs">... Version: %{?version}%{!?version:3.133d} ...</code> </pre></div></div><br><br>  4. We proceed to build the driver image: <br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># cd tg3-drv/ [root@localhost tg3-drv]# make tg3_flags.h [root@localhost tg3-drv]# cd .. [root@localhost ~]# mv tg3-drv tg3-3.133d [root@localhost ~]# tar czvpf tg3-3.133d.tar.gz tg3-3.133d/ [root@localhost ~]# cp tg3-3.133d.tar.gz /usr/src/redhat/SOURCES/</span></span></code> </pre><br>  Translated by the above steps, we prepared the source for the build script, now it remains only to run the script, but before running the script set the current time in the image, otherwise the script will end with a warning: <br><pre> <code class="bash hljs">[root@localhost ~]<span class="hljs-comment"><span class="hljs-comment"># cd tg3-proj/ [root@localhost tg3-proj]# date 011311282014.30 //(,  , , , 4  , ) Mon Jan 13 11:28:30 EST 2014 [root@localhost tg3-proj]# make ... Total translation table size: 0 Total rockridge attributes bytes: 780 Total directory bytes: 0 Path table size(bytes): 10 Max brk space used 21000 283 extents written (0 MB)</span></span></code> </pre><br>  The tg3.iso, tg3.iso.md5, tg3.metadata.md5 files appeared in the folder, etc., we are only interested in tg3.iso, it should be sent to the host server, this is done with the help of the scp command, which uses ssh to download files: <br><pre> <code class="bash hljs">[root@localhost tg3-proj]<span class="hljs-comment"><span class="hljs-comment"># scp tg3.iso root@192.168.0.2:/root/tg3.iso</span></span></code> </pre><br><br>  5. The most difficult thing is already behind, only the driver installation on the host server is left; for this we log in to the server, you can through the console in the Xen Center and perform the following actions: <br><pre> <code class="bash hljs">mkdir -p /mnt/tmp mount /root/tg3.iso /mnt/tmp -o loop,ro <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /mnt/tmp/ ./install.sh <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /root/ umount /mnt/tmp shutdown -r now</code> </pre><br>  And so, the final touch after a reboot, the adapter will not appear in the available devices, in order for it to appear, you need to go to the server console, call the manager through the ‚Äúxsconsole‚Äù command and there in the item ‚ÄúNetwork and Management Interface‚Äù select the item ‚ÄúEmergency‚Äù Network Reset ‚Äù, after resetting your adapter and rebooting the Thunderbolt Ethernet Adapter will be available for use. <br><br>  PS For the lazy, the image that I have already collected and verified: <a href="http://yadi.sk/d/V3TPXLlTG6PGR">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/209074/">https://habr.com/ru/post/209074/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../209062/index.html">IT Tree with Hackspace</a></li>
<li><a href="../209066/index.html">The programmer remembers his mistakes</a></li>
<li><a href="../209068/index.html">Programmer gets investment: our experience</a></li>
<li><a href="../209070/index.html">Chinese moon rover sent new photos</a></li>
<li><a href="../209072/index.html">Containerization on Linux in detail - LXC and OpenVZ. Part 1</a></li>
<li><a href="../209076/index.html">Tasks for the developer Yandex.Music for iOS</a></li>
<li><a href="../209078/index.html">What is Teradata?</a></li>
<li><a href="../209080/index.html">Black Friday. How did it all really</a></li>
<li><a href="../209084/index.html">Containerization on Linux in detail - LXC and OpenVZ Part 2</a></li>
<li><a href="../209092/index.html">Microsoft and Adobe released a set of updates, January 2014</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>