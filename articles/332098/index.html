<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to protect corporate storage from encryption viruses with snapshots</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Encryption viruses have been shaking the IT market for years with the consequences of their clandestine work. Hiding behind the link in the email or i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to protect corporate storage from encryption viruses with snapshots</h1><div class="post__text post__text-html js-mediator-article">  Encryption viruses have been shaking the IT market for years with the consequences of their clandestine work.  Hiding behind the link in the email or in the JavaScript code on the page of the website, they silently install on the working computers or servers and begin to silently encrypt all the information.  After the end of encryption, some simply delete the encryption key, others require a ransom, but not all users who pay it receive an encryption key.  How can you deal with them?  The most important means of struggle is to be prepared for the worst. <br><br>  Trying to protect yourself from viruses and other hacker attacks only by means of antivirus and firewalls, it's like hanging locks on the door, put an alarm / video surveillance and count on the fact that there is no one who can bypass it.  As practice shows, even the most complex locks, the most intelligent protection systems can be circumvented.  You need to have a ‚ÄúPlan B‚Äù and be prepared for the worst.  The only solution is to be able to quickly and securely recover data.  Using the NetApp solutions as an example, consider these possibilities. <br><br><img src="https://habrastorage.org/web/b6b/f01/737/b6bf01737591417abcbb7a94d85972e8.png"><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  NetApp FAS / ONTAP Storage Systems </h4><br>  They not only have multiple integrations with a variety of backup software, antivirus systems, and other infrastructure systems, but also provide high availability for NAS (NFS, CIFS / SMB) and SAN (iSCSI, FC, FCoE).  Unified storage allows for transparent data migration between the nodes of the cluster, which can consist of 24 nodes, and also allows you to use all the nodes at the same time to service the NAS and SAN to improve performance.  Thus, you can completely abandon the vulnerable Windows Server vulnerabilities - not to buy licenses and not build clusters for high availability, because all the functionality is already available in NetApp ONTAP, including integration with AD, file and folder security settings, Access Based Enumeration, and all the usual MMC Management Console <br><br><h4>  Backup </h4><br>  Both in the largest organizations and in small firms, working files are placed on a shared file storage so that everyone can use them.  The centralization of storage provides the convenience for several people to work together on the same files, but it also imposes the responsibility to protect such information.  Naturally, in order to combat encryption viruses, it is necessary to perform regular backups using the 3-2-1 scheme.  Backups are important to keep separate from the main system. <br><br>  NetApp FAS / ONTAP storage systems have in their arsenal snapshots that do not affect performance and replication based on these snapshots, which allow you to integrate <a href="https://habrahabr.ru/post/244923/">NetApp storage systems with NASA</a> and SAN <a href="https://habrahabr.ru/post/244923/">technologies</a> with a <a href="https://habrahabr.ru/post/244923/">wide range of backup systems</a> : <br><br><ul><li>  <a href="https://habrahabr.ru/post/279891/">Veeam Backup &amp; Replication</a> </li><li>  CommVault Simpana </li><li>  NetApp SnapManager / SnapCenter. </li><li>  NetApp SnapCreator (free framework) </li><li>  Veritas netbackup </li><li>  Veritas BackupExec </li><li>  Syncsort </li><li>  Acronis </li><li>  IBM Spectrum Protect (Tivoli) </li><li>  EMC Networker </li><li>  HP Data Protector </li><li>  <a href="https://www.cleondris.com/en/snapguard.xhtml">Cleondris DM</a> </li><li>  <a href="https://catalogicsoftware.com/solutions/copy-data-management-netapp-storage/">Catalog ECX / DPX</a> </li><li>  <a href="https://arcserve.com/data-protection-resources/arcserve-udp-build-netapp-hardware-snapshot-copies/">Arcserve UDP</a> </li><li>  Other </li></ul><br>  Let's take a closer look at one of these backup systems, Veeam Backup &amp; Replication, which has gained trust and respect due to the ease and simplicity of the management interface.  But these are not all the advantages of this product, which not only knows how to manage snapshots and replicas between NetApp FAS, ONTAP Select, ONTAP Cloud and AltaVault.  It also allows data storage systems to clone data on one of the sites for testing performance and recoverability from such backups.  Cloning as well as snapshots on the NetApp FAS / ONTAP system is a very convenient technology that also does not affect performance and at the initial moment of taking a snapshot does not take up any storage space.  In addition, creation takes less than a second, regardless of the size of the data being cloned. <br><br><h4>  Snapshots for salvation </h4><br>  But a full recovery, firstly, can be quite long, and secondly, backups can be performed not every 15 minutes, thus increasing the RPO.  And here it becomes clear how important a part of backups are snapshots, which can be performed much more often than backups from NAS or SAN storage and, accordingly, restore such data much faster from snapshots, thus significantly reducing the RPO value.  And here it becomes clear how important it is that such snapshots function like a clock, do not inhibit the operation of the entire repository, do not have architectural problems for deletion and consolidation.  At the same time, snapshots are not a replacement for backup, but an important addition to a complete backup strategy.  So the procedure for creating snapshots can be done often enough to capture the most recent changes to your information. <br><br>  Snapshots are not a complete copy of the data, only the difference of new data at the block level, a kind of reverse incremental backup that more efficiently uses storage space, rather than a full backup.  But still this space is used, the more changes, the more information gets into the snapshot.  A customized schedule for auto-deleting old snapshots will allow more efficient use of storage resources and not eat up all the available space on expensive NAS storage.  A backup, will store a much longer time copy of older versions of information. <br><div style="text-align:center;"><img src="https://habrastorage.org/web/b62/a29/e6a/b62a29e6ab624d568229bb53829b3e00.png"></div><br><br><h4>  SAN Wednesday </h4><br>  NetApp ONTAP snapshots are equally effective in both NAS and SAN environments, are equally architecturally designed, have the same interface, configuration, removal and recovery speed, which allows you to more quickly roll back in case of data corruption. <br><br><h4>  Snapshots and NetApp FabricPool Technology </h4><br>  Separately, it is worth noting the technology <a href="https://habrahabr.ru/post/330526/">FabricPool</a> , which allows to transparently shift snapshots and cold data from SSD drives to slow disks in the object storage, which will make it possible to actively and often use such an important technology of snapshoting on expensive storage media. <br><br>  There is a separate <a href="http://www.netapp.com/us/media/tr-4572.pdf">document on how to deal with encryption viruses using NetApp TR4572 systems</a> . <br><br><h4>  How snapshots should not work </h4><br>  Many have already come across various implementations of snapshots and already know in practice how snapshots should not work: <br><br><ul><li>  they should not increase the load on the disk subsystem simply from having a snapshot; </li><li>  they should not increase the load simply from a larger number of snapshots; </li><li>  they should not be slowly created and deleted and this process should not affect the performance of the disk subsystem; </li><li>  they should not be deleted so as to damage the master data; </li><li>  it shouldn‚Äôt be any difference to how much data, everything should work quickly, instantly and without the slightest possibility to damage information due to the deletion or consolidation of the snapshot. </li></ul><br>  ONTAP snapshots <a href="https://habrahabr.ru/post/244923/">for NetApp storage do not work this way</a> .  They were first implemented in the ONTAP operating system, as part of the WAFL file system in 1993, as we see, these technologies have been tested by time.  By the way, the word Snapshot itself is a registered trademark of NetApp, and the snapshot technology is patented.  To study the question of how WAFL snapshots work, you can download for free the test period a virtual machine with an ONTAP repository image, which can be requested from the Distributor or the Integrator. <br><br>  <a href="http://mysupport.netapp.com/NOW/cgi-bin/software/%3Fproduct%3DONTAP%2BSelect%26platform%3DDeploy%2BInstall">mysupport.netapp.com/NOW/cgi-bin/software/?product=ONTAP+Select&amp;platform=Deploy+Install</a> <br><br><h4>  Recovery Automation </h4><br>  Integration of storage snapshots with operating systems will allow you to remove the routine from the storage administrator to recover individual files.  So that users themselves can restore their files from snapshots directly from their Windows computer using standard OS tools. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/0da/8b5/2ed/0da8b52eddd6442880de8e296b2e102b.png"></div><br><h4>  Snapshot Replication </h4><br>  Simply deleting old snapshots that are already in the repository and configured in a well-established backup strategy is a significant waste of resources.  After all, snapshots can be used to replicate them on the second, third, etc.  storage systems.  Firstly, there are already snapshots, why not to use them, secondly, it is much more profitable to transfer the delta than the entire data set each time; in the third, snapshots work like reverse incremental backups.  Those.  do not require time for ‚Äúgluing into full backup‚Äù, in the fourth, ONTAP snapshots are like reverse incremental backups, but they do not require gluing or consolidation either before recovery, during replication, or during recovery, as is the case with traditional incremental backup or reverse incremental backup.  But there is no magic, snapshots when replicating data are still read out from the target system changes to be sent to the remote system, this generates additional read operations during the replica, but it is much better compared to a full backup, which every time re-reads everything data entirely. <br><br><h4>  Worm </h4><br>  The Write Once Read Man or WORM technology, also known by other commercial names, for example, NetApp SnapLock, built on the basis of snapshots, allows you to block data for a long time from changes, including from users of the storage system with elevated privileges.  So you can store firmware, configuration from a variety of devices, such as switches, routers, and more.  Files of this kind are rarely changed at all during the life of the device, and WORM-supported storage is a safe place to put important infrastructure settings files that are not exactly infected, they cannot be changed, but they can be read.  This property can be used to load configurations and firmware for key components of your infrastructure. <br><br><h4>  NAS Antivirus Protection </h4><br>  And of course, the ability to check files <a href="https://habrahabr.ru/post/280666/">on the storage side will not be superfluous either</a> .  NetApp FAS / ONTAP systems integrate with a wide list of anti-virus systems that will perform corporate data checking on NAS storage.  The most well-known anti-virus scanning systems are supported: <br><br><ul><li>  Symantec </li><li>  Trend micro </li><li>  Computer associates </li><li>  Mcafee </li><li>  Sophos </li><li>  Kaspersky </li></ul><br><h4>  Snapshots as an indicator of infection RansomWare </h4><br>  As it was said earlier, snapshots store a block delta in themselves - the difference between their previous state and the current one, that is, relevant.  And the more changes are made to the actual data, the more it takes snapshot.  In addition, it is worth mentioning about the technology of compression and data deduplication, which allow you to compress the original data, saving storage space.  So some data is not compressed.  For example, a photo, video or audio data, and what data is not pressed yet?  Correctly, encrypted files.  So imagine you set up a snapshot schedule, you have deduplication and compression.  Snapshots are removed, and older ones are deleted, data is compressed, space consumption is quite measured and stable.  And suddenly the snapshots start to take up much, much more space than before, and deduplication and compression are no longer effective.  These are indicators of silent and malicious work of the ciphering virus: your data, firstly, changes dramatically (snapshots grow in size compared to how they were before), secondly, dedup and compression stopped producing results (it means that incompressible information, for example, the originals of the files are replaced by encrypted versions).  These two indirect indicators lead to irrational consumption of storage space, and you can notice this on the graph of space consumption in the monitoring interface of NetApp, which suddenly began to grow geometrically upwards. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/be0/709/13c/be070913cea245759cd74fd4dae0e91e.png"></div><br><h4>  File Screening Fpolicy </h4><br>  Fpolicy and ONTAP directory-security API are mechanisms that allow you to analyze a file, and depending on the configured policies, allow or not allow, write it, or work with it for the SMB / CIFS protocol.  File analysis can be performed on the basis of a file extension (Fpolicy built-in ONTAP functionality) or by content, then you need specialized software using these two mechanisms. <br><br><h5>  Free Cleondis SnapGuard Light Edition </h5><br>  The free product <a href="https://www.cleondris.com/wannacry/">Cleondis SnapGuard Light Edition (SGLE) is designed not only to detect on the CIFS / SMB ball, but also to recover from encryption viruses using snapshots on the NetApp ONTAP platform</a> .  SGLE is able to recognize patterns of malicious encryption viruses that begin to encrypt your files and stop clients who are infected from further harm and are fully compatible with existing anti-virus systems. <br><br><h5>  Free Prolion DataAnalyzer-light </h5><br>  <a href="http://www.prolion.at/en/dataanalyzer">Prolion DataAnalyzer-light</a> free product <a href="http://www.prolion.at/en/dataanalyzer">provides the ability to detect encryption viruses on the NetApp ONTAP platform with SMB / CIFS ball</a> . <br><br><h5>  Varonis </h5><br>  <a href="https://info.varonis.com/hubfs/docs/datasheets/en/Varonis_NetApp_Solutions.pdf">Varonis is a</a> very powerful industrial solution that not only can track encryption, disconnect infected users from the NAS (CIFS / SMB), but also find and recover those files that were encrypted. <br><br><h4>  SMB1 and WannaCry / Petya </h4><br>  The WannaCry / Petya viruses exploit a vulnerability in the SMB1 protocol on Windows machines, this vulnerability is not found in NetApp ONTAP systems.  But once on Windows, the virus can encrypt files located on the NAS storage, so it is recommended to configure snapshots on a schedule.  NetApp recommends disabling SMB1 and upgrading to newer versions of SMB v2 or v3 protocols on client-side Windows workstation to avoid infection. <br><br>  Newer versions of the virus can disable VSS shadowing on Windows hosts, but since the snapshot schedule on the NAS NetApp storage is configured, turned on and off on the storage itself, turned off VSS will not affect the operation of snapshots. <br><br><div class="spoiler">  <b class="spoiler_title">Turn off SMB1 and SMB2</b> <div class="spoiler_text">  Open Powershall as administrator and insert the following lines. <br><pre><code class="plaintext hljs">Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" SMB1 -Type DWORD -Value 0 -Force Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" SMB2 -Type DWORD -Value 0 -Force netsh advfirewall firewall add rule dir=in action=block protocol=TCP localport=445 name="Block_TCP-445" netsh advfirewall firewall add rule dir=in action=block protocol=TCP localport=135 name="Block_TCP-135" netsh advfirewall firewall add rule dir=in action=block protocol=TCP localport=139 name="Block_TCP-139"</code> </pre> <br></div></div><br>  <b>Ps.</b>  Also note the document describing <a href="http://www.netapp.com/us/media/tr-4569.pdf">ONTAP security settings to enhance security (Security Hardening Guide for NetApp ONTAP 9)</a> . <br><br>  In connection with the mass infection of data by viruses such as RansomWare, <i>Megatrade, the official distributor of NetApp in Ukraine</i> launches a campaign for its existing and future customers on: <br><br><ul><li>  configuring ONTAP snapshots for NAS, SnapRestore, Virtual Storage Console </li><li>  installing free RansomWare infection monitoring software for ONTAP (CIFS / SMB) </li><li>  setting up ONTAP integration with antivirus systems for CIFS / SMB </li><li>  learning how to use ONTAP snapshots with SAN access </li></ul><br><h4>  Conclusion </h4><br>  In conclusion, it is worth noting that snapshots are not a replacement, but an important part of a backup strategy, which allows you to more quickly, more often back up data and restore it faster.  WAFL snapshots are the basis for cloning, SnapLock and data replication to a backup storage system, do not slow down the system, do not require consolidation and bonding, and are an effective means of backing up data.  Enterprise-class storage systems NetApp FAS / ONTAP have multiple technologies and integration that allow you to be prepared for the worst.  Well, in the context of the latest events, the technologies discussed above also become very relevant for protecting your information from various malware threats. <br><br>  Translation to English: <br>  <b><a href="https://wp.me/p9LTcx-23">How to protect your corporate storage system against ransomware</a></b> <br><br>  I ask to send messages on errors in the text to the <abbr title="Private message">LAN</abbr> .  Comments, additions and questions on the article on the contrary, please in the comments. </div><p>Source: <a href="https://habr.com/ru/post/332098/">https://habr.com/ru/post/332098/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332086/index.html">Automatic application deployment with Maven and Wildfly</a></li>
<li><a href="../332088/index.html">Tasks with interviews. Three adequate tasks to "think"</a></li>
<li><a href="../332090/index.html">ReactJS - my understanding of testing</a></li>
<li><a href="../332092/index.html">Nelder-Mead optimization method. Python implementation example</a></li>
<li><a href="../332094/index.html">Creating a blog engine with Phoenix and Elixir / Part 9. Channels</a></li>
<li><a href="../332100/index.html">Tips for using FactoryGirl without ORM</a></li>
<li><a href="../332106/index.html">Quantum computer: a big boost game. Lecture in Yandex</a></li>
<li><a href="../332108/index.html">Kubernetes & production - to be or not to be?</a></li>
<li><a href="../332110/index.html">The digest of interesting materials for the mobile developer # 210 (June 26 - July 2)</a></li>
<li><a href="../332112/index.html">Access ClickHouse with JDBC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>