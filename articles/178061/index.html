<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Themes design. Blackjack and WeakReference</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once I faced the task of making theme support in an Android application. What I wanted to get: 



1. The ability to switch design - change some color...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Themes design. Blackjack and WeakReference</h1><div class="post__text post__text-html js-mediator-article">  Once I faced the task of making theme support in an Android application.  What I wanted to get: <br><br><ol><li>  The ability to switch design - change some colors and graphics </li><li>  The change should take place ‚Äúon the fly‚Äù, only the design should change for the user, everything else (the content of the input fields, the position of the elements in the list, etc.) should not change </li><li>  In the future, I would like the topic to be changed without the participation of the user, for example, by the time of day </li><li>  I wouldn‚Äôt like to greatly modify the existing code or markup.  Ideally, I would just like to somehow mark the elements in the markup </li><li>  It would be great to be able to upload new themes without updating the application. </li></ol><br><br>  About what was achieved and how it was implemented - under the cut. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/dd6/663/a2c/dd6663a2cbb9b8e49f5c6b3bae311d76.png"><br><br><a name="habracut"></a>  The most obvious way that Stack Overflow and Android‚Äôs documentation offer us is Context.setTheme.  One snag is to install the theme before creating all our View.  Immediately it is clear that ‚Äúon the fly‚Äù it is impossible to switch the topic, the user will definitely notice the complete re-creation of the entire contents of the Activity.  Yes, and with the code of each Activity one way or another will have to tinker.  I did not find any other recommendations on the Internet (if someone has information, I will be grateful for the link). <br><br>  Well, we will write the implementation.  Blackjack and WeakReference. <br><br>  Let's start from point 4. I consider myself to be developers who prefer not to write code.  I do not like to write code so much that I am ready to write a lot of code, just not to write it in the future.  I can‚Äôt do anything with myself: I don‚Äôt want to think about the logic of interaction when a new window appears in order to take into account the susceptibility to a dynamic design change.  I just want to indicate in the markup next to the element that, for example, its color will be equal to the background color. <br><br>  This will help us tag property.  If somewhere else in the application tags are used, for example, as Holder'ov for optimizing adapters in ListView, it is not scary.  In the code, you can use setTag / getTag with the id parameter.  If there are many such places, the search and replacement will help us. <br><br>  Now let's think of some simple format for tags.  First, we separate the wheat from the chaff and make the simplest test that this tag is really an indication of the use of our themes: our tag will always begin with the ‚Äú!‚Äù Symbol.  Next comes the name of the resource, for example ‚Äúbackground‚Äù.  Then some separator, something like ‚Äú|‚Äù, and the type of resource ‚Äî text color, background picture or background color, etc.  For example, the background for the chat window using tiling: ‚Äú! Chat | tiled_bg‚Äù.  Maybe not too aesthetic, but quickly parse.  In order to make a minimum of mistakes when writing such tags, it is better to put them into string resources and reuse - in our application, the resource! Primary | text_fg is used 77 times. <br><br>  The most difficult thing is over, it remains only to somehow process these tags ... Elements with such tags must be processed immediately upon ‚Äúinflating‚Äù (inflate) View, and then each time the topic is changed.  ‚ÄúInflating‚Äù actually occurs in two ways - setContentView in the Activity and using the LayoutInflater.  Let's start with setContentView. <br><br>  In our application, all Activities are inherited from a small number of basic Activities.  It is enough to override the setContentView method: <br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setContentView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.setContentView(id); HotTheme.manage(mActivity.getWindow().getDecorView()); }</code> </pre> <br>  The getDecorView method returns the ‚Äúroot‚Äù of the View hierarchy. <br>  To do the same when creating a View using a LayoutInflater, wrap it: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotLayoutInflater</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LayoutInflater inflater; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HotLayoutInflater</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LayoutInflater inflater)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.inflater = inflater; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> View </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inflate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> resource, ViewGroup root, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> attachToRoot)</span></span></span><span class="hljs-function"> </span></span>{ View v = inflater.inflate(resource, root, attachToRoot); HotTheme.manage(v); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> View </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inflate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> resource, ViewGroup root)</span></span></span><span class="hljs-function"> </span></span>{ View v = inflater.inflate(resource, root); HotTheme.manage(v); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> HotLayoutInflater </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LayoutInflater layoutInflater)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HotLayoutInflater(layoutInflater); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> HotLayoutInflater </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">from</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HotLayoutInflater(LayoutInflater.from(context)); } }</code> </pre><br>  Now - analysis of hierarchy View: <br><br>  HotTheme.java: <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">manage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View... views)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (View v : views) { simpleManage(v); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> ViewGroup) { ViewGroup vg = (ViewGroup) v; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; vg.getChildCount(); i++) { manage(vg.getChildAt(i)); } } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">simpleManage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View view)</span></span></span><span class="hljs-function"> </span></span>{ Object t = view.getTag(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> String) { String tag = (String) t; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tag.startsWith(<span class="hljs-string"><span class="hljs-string">"!"</span></span>)) { tag = tag.substring(<span class="hljs-number"><span class="hljs-number">1</span></span>); String[] elements = tag.split(<span class="hljs-string"><span class="hljs-string">"\\|"</span></span>); String base = elements[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = elements.length - <span class="hljs-number"><span class="hljs-number">1</span></span>; i &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>; i--) { ThemedView tv = createThemedView(view, base, elements[i]); tv.notifyChange(); HotTheme.sViews.add(tv); } } } }</code> </pre><br>  As you can see, the View that our tag contains is pulled out of the hierarchy.  Just in case, we consider that there can be several ‚Äú|‚Äù delimiters - then the resource will be applied to each type (this can be useful). <br><br>  Further, these elements are wrapped in a certain ThemedView, which is responsible for all the magic.  The notifyChange method will apply the current theme to this View.  Well, save ThemedView for the future to notify about the change of topics - nothing complicated. <br>  The ThemedView class itself is a simple wrapper around View that prevents context leakage: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ThemedView</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> WeakReference&lt;View&gt; view; ThemedView(View v) { view = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WeakReference&lt;View&gt;(v); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ View v = view.get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } onChange(v); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v)</span></span></span></span>; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">equals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object o)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == o) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || getClass() != o.getClass()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } ThemedView view1 = (ThemedView) o; View v1 = view.get(); View v2 = view1.view.get(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (v1 != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? v1.equals(v2) : v2 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hashCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (view == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } View v = view.get(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? v.hashCode() : <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre><br>  Now, when changing the topic, to apply it to all interested View it is enough to call: <br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Iterator&lt;ThemedView&gt; it = views.iterator(); it.hasNext(); ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!it.next().notifyChange()) { it.remove(); } }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Small lyrical digression</b> <div class="spoiler_text"><blockquote>  I love java.  Yes, Java is a bit slower C. Yes, it is less flexible than Python.  But she (yes, for me Java - ‚Äúshe‚Äù) can do amazing things: <br><ol><li>  Do for me.  Seriously, I'm just telling her what I want.  If I want a beer, she goes for a bottle, opens it and kindly waits while I enjoy a wonderful drink, after which she throws the bottle away.  Thank you, GC! </li><li>  Think for me.  I do not need to keep in mind the data types, as in languages ‚Äã‚Äãwith weak typing.  I don't need to think about whether memory is allocated on the stack or on the heap.  When you have Java, you rarely have to think at all - it is often enough to explain to her what you want. </li><li>  Write the code for me.  Javaassist, CGLib, java.lang.reflect.Proxy, JSR-269, annotations, reflections ... Metaprogramming with Java is great! </li><li>  Cast for me.  And safe!  Almost.  At a minimum, until you yell at it with @SuppressWarning (‚Äúunchecked, rawtypes‚Äù).  Thanks, Generics! </li><li>  Java is not proud.  She can do Unsafe, despite the fact that it is contrary to her nature. </li></ol><br>  Yes, she has flaws.  She likes to chat - I haven‚Äôt met a much more verbose Java (Pascal doesn‚Äôt count for the language, of course).  But usually IDE allows you to overcome this with the help of various auto-permutations and templates. <br><br>  Android uses Java.  Yes, that's just none of its merits in it left.  He looks more like a drunken unshaven peasant than a beautiful and submissive woman.  I tell him - I want a beer, and he told me - get a constant, create an Intent, serialize the data, open the Activity, get the result ... If everything is fine, deserialize it and bring it to the type of "Beer".  And yes, bear in mind that at any moment your operation to get a beer can be interrupted.  Even if you already paid for it.  Especially happy when you are in the context of a single physical process. <br><br><img src="https://habrastorage.org/storage2/a5d/d66/4e1/a5dd664e17b9b8d4ee030baf3f54768f.png"><br><br>  I constantly have to keep in mind what type of Message.obj will be based on Message.what.  And make a huge switch.  Very comfortably. <br><br>  Code generation on Android is something else.  You can almost forget about Javaassit / CGLib (there are some realizations of something similar, but the speed of their work leaves much to be desired).  With the rest (Proxy, JSR-269, annotations and reflections) I periodically sin, but I have to make a lot of gestures in order to make it work at a more or less acceptable speed. <br><br>  Android is proud.  He can Unsafe.  And this is not contrary to its nature (including NDK, RenderScript, etc.).  Yes, only it is available exclusively through reflections, which destroys most of the advantages of Unsafe. <br><br>  So, what is it for me?  Due to the obedience of Java, such a tool as WeakReference is used quite rarely, only in the wildest erotic fantasies (for example, data consistency support in various ORMs).  With Android instead of romance, WeakReference has to be used for domination in the BDSM style.  We have to put up with the fact that objects live their lives, obeying the unknown life-cycle.  You have to ‚Äúcling‚Äù to them with the help of WeakReference, so as not to cause context leaks (Context).  Perhaps it would be worthwhile to ‚Äúbend‚Äù under Android, and in each activation, upon exit, ‚Äúunregister‚Äù the View hierarchy, but the trouble is, it can change, and some of the View will not be there (especially typical for ListView, whose elements can constantly appear / disappear) from the screen).  That's why I use the WeakReference almost always when some of the application modules affect the visual part - all the View are stored only on the WeakReference, which, of course, greatly complicates the logic of work. <br></blockquote></div></div><br>  Let's return to our ThemedView, in which in its onChange method we define what happens to the View: <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ThemedView </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createThemedView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String base, String element)</span></span></span><span class="hljs-function"> </span></span>{ ThemeType type = types.get(element); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> TILED_BG: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThemedView(v) { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v)</span></span></span><span class="hljs-function"> </span></span>{ Bitmap bmp = decodeBitmap(base + <span class="hljs-string"><span class="hljs-string">"_bg"</span></span>); BitmapDrawable bd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapDrawable(app().getResources(), bmp); bd.setTileModeXY(Shader.TileMode.REPEAT, Shader.TileMode.REPEAT); v.setBackgroundDrawable(bd); } }; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> VIEW_COLOR_BG: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThemedView(v) { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> color = getColor(base + <span class="hljs-string"><span class="hljs-string">"_bg"</span></span>); v.setBackgroundColor(color); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (v <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> ListView) { <span class="hljs-comment"><span class="hljs-comment">// There is an android bug in setCacheColorHint // That caused the IndexOutOfBoundsException // look here: // http://code.google.com/p/android/issues/detail?id=12840 // // Moreover, that bug doesn't allow us to setDrawableCacheColor // for recycled views. That's why we need to perform cleaning up // via reflections // // Fixed in android 4.1.1_r1 try { ((ListView) v).setCacheColorHint(color); } catch (IndexOutOfBoundsException ex) { try { Field mRecycler = AbsListView.class.getDeclaredField("mRecycler"); mRecycler.setAccessible(true); Object recycler = mRecycler.get(v); Method m = recycler.getClass().getDeclaredMethod("clear"); m.setAccessible(true); m.invoke(recycler); } catch (Throwable t) { // No need to report this } } } } }; case VIEW_IMAGE_BG: return new ThemedView(v) { @Override public void onChange(View v) { v.setBackgroundDrawable(decodeDrawable(base + "_bg")); } }; case IMAGE_FG: return new ThemedView(v) { @Override public void onChange(View v) { ((ImageView) v).setImageDrawable(decodeDrawable(base + "_bg")); } }; case TEXT_COLOR: return new ThemedView(v) { @Override public void onChange(View v) { final int color = getColor(base + "_fg"); if (v instanceof TextView) { ((TextView) v).setTextColor(color); } } }; case TEXT_HINT: return new ThemedView(v) { @Override public void onChange(View v) { final int color = getColor(base + "_hint_fg"); if (v instanceof TextView) { ((TextView) v).setHintTextColor(color); } } }; case PAGER: return new ThemedView(v) { @Override public void onChange(View v) { int active = getColor(base + "_active_fg"); int inactive = getColor(base + "_inactive_fg"); int footer = getColor(base + "_footer_bg"); TitlePageIndicator pager = (TitlePageIndicator) v; pager.setSelectedColor(active); pager.setTextColor(inactive); pager.setFooterColor(footer); } }; case DIVIDER: return new ThemedView(v) { @Override public void onChange(View v) { int color = getColor(base + "_divider"); ListView lv = (ListView) v; int h = lv.getDividerHeight(); lv.setDivider(new ColorDrawable(color)); lv.setDividerHeight(h); } }; case TABBUTTON_BG: return new ThemedView(v) { @Override void onChange(View v) { StateListDrawable stateDrawable = new StateListDrawable(); Drawable selectedBd = decodeDrawable(base + "_selected"); stateDrawable.addState(new int[]{android.R.attr.state_selected}, selectedBd); stateDrawable.addState(new int[]{android.R.attr.state_pressed}, selectedBd); stateDrawable.addState(new int[]{}, decodeDrawable(base + "_unselected")); v.setBackgroundDrawable(stateDrawable); } }; case EDITTEXT_COLOR: return new ThemedView(v) { @Override void onChange(View v) { int color = getColor(base + "_fg"); EditText edit = (EditText) v; edit.setTextColor(color); int hintColor = getColor(base + "_disabled_fg"); edit.setHintTextColor(hintColor); } }; case GROUP_TINT: return new ThemedView(v) { @Override void onChange(View v) { int tintColor = getColor(base + "_fg"); ImageView imageView = (ImageView) v; imageView.setColorFilter(tintColor, PorterDuff.Mode.SRC_ATOP); } }; default: throw new IllegalArgumentException("Error in layout: no such type \"" + element + "\" (" + base + ")"); } }</span></span></code> </pre><br>  The types.get (element) code simply returns enum on a lowercase string. <br><br>  Of the interesting are the methods decodeBitmap, decodeDrawable and getColor: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ResourceInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findResource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String base, ResourceType type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sCurrentProvider.findResource(base, type); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Drawable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decodeDrawable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String base)</span></span></span><span class="hljs-function"> </span></span>{ ResourceInfo info = findResource(base, ResourceType.Drawable); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.getResources().getDrawable(info.getResId()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decodeBitmap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String base)</span></span></span><span class="hljs-function"> </span></span>{ ResourceInfo info = findResource(base, ResourceType.Drawable); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BitmapFactory.decodeResource(info.getResources(), info.getResId(), Util.newPurgeableBitmapOptions()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getColor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String base)</span></span></span><span class="hljs-function"> </span></span>{ ResourceInfo info = findResource(base, ResourceType.Color); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.getResources().getColor(info.getResId()); }</code> </pre><br>  The sCurrentProvider is an object of the ThemeProvider class, whose only task is to obtain resource information by its name and type. <br>  The simplest implementation will add some theme ID as a prefix to the resource name: <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ResourceInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findResource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name, ResourceType type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id = IdUtils.getResId(app().getResources(), mPrefix + <span class="hljs-string"><span class="hljs-string">"_"</span></span> + name, type.getType(), PACKAGE_NAME); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (id == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; mNext != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mNext.findResource(name, type); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ResourceInfo(app().getResources(), id); }</code> </pre><br>  The getResId method is a small wrapper around the Resources.getIdentifier method. <br>  The mNext field is also a ThemeProvider object.  It is needed in order to search the chain, if the resource was not found (eventually the default will be taken). <br><br>  As a result, in order to make another topic, you just need to add a set of necessary resources, adding some prefix.  For example, resource names for the chat window background: <br>  def_chat_bg <br>  night_chat_bg <br>  pink_chat_bg <br>  wood_chat_bg <br><br>  <b>Total</b> <br><br>  As it was said at the beginning, it would be great to be able to load resources not only from the application itself, but also from the outside.  The source may be, for example, another application.  In this case, everything will work the same, except for the package name and the Resources object.  This, in turn, can be obtained through PackageManager.getResourcesForApplication. <br><br>  Remember again what we wanted to achieve: <br><ol><li>  Ability to switch design - done </li><li>  The change should take place ‚Äúon the fly‚Äù - ready </li><li>  In the future, I would like the topic to change without the participation of the user - the prospect is peeped out, there are no obstacles </li><li>  I would not like to substantially change the already existing code or markup - the code has actually changed quite a lot, but mostly with the help of search and replace, so here you can also put a plus </li><li>  Upload new themes without updating the application - ready, resources can be loaded from any apk </li></ol><br><br>  Looks like it worked out.  Thanks to everyone who mastered the article to the end.  I hope someone will use the described technique in order to give your application the ability to adapt to the mood of the users - believe me, they will thank you! <br><br>  PS: well, and, as expected, a minute of advertising - Agent's application with the topics <a href="https://play.google.com/store/apps/details%3Fid%3Dru.mail">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/178061/">https://habr.com/ru/post/178061/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../178049/index.html">Serious design serious sites. Part 2. Visualization</a></li>
<li><a href="../178053/index.html">Facebook bought Parse backend for third-party mobile apps</a></li>
<li><a href="../178055/index.html">Viber vulnerability allows to bypass Android-smartphone lock</a></li>
<li><a href="../178057/index.html">The 8th Forum for IT directors "I would go to heaven"</a></li>
<li><a href="../178059/index.html">The technology maturity cycle for 2013 according to Gartner</a></li>
<li><a href="../178063/index.html">Another Epson Moverio BT-100 review</a></li>
<li><a href="../178067/index.html">Git FTP example on Windows</a></li>
<li><a href="../178069/index.html">Changing the coding of the git repository</a></li>
<li><a href="../178071/index.html">Designing your own computer. Part 1</a></li>
<li><a href="../178073/index.html">Two-factor SMS authorization in Redmine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>