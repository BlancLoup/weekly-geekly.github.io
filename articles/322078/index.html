<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Telegram bot, webhook and 50 lines of code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How again? Another tutorial chewing on official Telegram documentation, did you think? Yes, but no! This is more a discussion on how to build a functi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Telegram bot, webhook and 50 lines of code</h1><div class="post__text post__text-html js-mediator-article">  How again?  Another tutorial chewing on official Telegram documentation, did you think?  Yes, but no!  This is more a discussion on how to build a functional bot service using <i>Python3.5 +</i> , <i>asyncio</i> and <i>aiohttp</i> .  The more interesting that the title is actually disingenuous ... <br><a name="habracut"></a><br>  So what is the sly headline?  Firstly, the code is not 50 lines, but only 39, and secondly, the bot is not so complicated, just an echo-bot.  But it seems to me that this is enough to believe that making your own bot service is not as difficult as it may seem. <br><br><div class="spoiler">  <b class="spoiler_title">Telegram-bot in 39 lines of code</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> asyncio <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> aiohttp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> aiohttp <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> web <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json TOKEN = <span class="hljs-string"><span class="hljs-string">'111111111:AAHKeYAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'</span></span> API_URL = <span class="hljs-string"><span class="hljs-string">'https://api.telegram.org/bot%s/sendMessage'</span></span> % TOKEN <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> data = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> request.json() headers = { <span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span> } message = { <span class="hljs-string"><span class="hljs-string">'chat_id'</span></span>: data[<span class="hljs-string"><span class="hljs-string">'message'</span></span>][<span class="hljs-string"><span class="hljs-string">'chat'</span></span>][<span class="hljs-string"><span class="hljs-string">'id'</span></span>], <span class="hljs-string"><span class="hljs-string">'text'</span></span>: data[<span class="hljs-string"><span class="hljs-string">'message'</span></span>][<span class="hljs-string"><span class="hljs-string">'text'</span></span>] } <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> aiohttp.ClientSession(loop=loop) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> session: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> session.post(API_URL, data=json.dumps(message), headers=headers) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> resp: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> resp.status == <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> web.Response(status=<span class="hljs-number"><span class="hljs-number">500</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> web.Response(status=<span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init_app</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop)</span></span></span><span class="hljs-function">:</span></span> app = web.Application(loop=loop, middlewares=[]) app.router.add_post(<span class="hljs-string"><span class="hljs-string">'/api/v1'</span></span>, handler) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: loop = asyncio.get_event_loop() <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: app = loop.run_until_complete(init_app(loop)) web.run_app(app, host=<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>, port=<span class="hljs-number"><span class="hljs-number">23456</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: print(<span class="hljs-string"><span class="hljs-string">'Error create server: %r'</span></span> % e) <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> loop.close()</code> </pre> <br></div></div><br>  Further, in a few words, what for and how to make the best of what is already there. <br><a name="content"></a><br><h2>  Content: </h2><br><ol><li>  <a href="https://habr.com/ru/post/322078/">What we use</a> </li><li>  <a href="https://habr.com/ru/post/322078/">How to use</a> </li><li>  <a href="https://habr.com/ru/post/322078/">What can be improved</a> </li><li>  <a href="https://habr.com/ru/post/322078/">Real world</a> </li></ol><a name="content1"></a><br><h2>  1. What we use </h2><br><ul><li>  First, <b>Python 3.5+</b> .  Why exactly 3.5+, because asyncio <a href="https://habr.com/ru/post/322078/">[2]</a> and because sugar <i>async</i> , <i>await</i> etc; </li><li>  secondly, <b>aiohttp</b> .  Since the service is on webbugs, it is both an HTTP server and an HTTP client at the same time, and what to use for this, if not aiohttp <a href="https://habr.com/ru/post/322078/">[3]</a> ; </li><li>  thirdly, why <i>webhook</i> , but not <i>long polling</i> ?  If bot-sender was not originally planned, then interactivity is its main function.  I will express my opinion that for this task, the bot as an HTTP server is better suited than as a client.  Yes, and give up some of the work (message delivery) to Telegram services. </li></ul><br>  And yet, you must have a domain name under control, a valid or self-signed certificate.  Access to the server to which the domain name points to configure the reverse proxy to the address of the service. <br><br>  <a href="https://habr.com/ru/post/322078/">To the content</a> <br><a name="content2"></a><br><h2>  2. How to use </h2><br><h3>  Server </h3><br>  The state of the <i>aiohttp</i> library at the moment is such that with its use you can build a full-fledged web server in Django-style <a href="https://habr.com/ru/post/322078/">[4]</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For <i>standalone</i> service, all power is not useful, so server creation is limited to a few lines. <br><br>  We initialize the web application: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init_app</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop)</span></span></span><span class="hljs-function">:</span></span> app = web.Application(loop=loop, middlewares=[]) app.router.add_post(<span class="hljs-string"><span class="hljs-string">'/api/v1'</span></span>, handler) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> app</code> </pre><br>  <b>NB</b> Please note that here we define the routing and set the handler of incoming messages. <br><br>  And start the web server: <br><br><pre> <code class="python hljs">app = loop.run_until_complete(init_app(loop)) web.run_app(app, host=<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>, port=<span class="hljs-number"><span class="hljs-number">23456</span></span>)</code> </pre> <br><h3>  Customer </h3><br>  To send a message, we use the <i>sendMessage</i> method from the Telegram API, for this you need to send a properly prepared URL POST request with parameters as a JSON object.  And we do this using aiohttp: <br><br><pre> <code class="python hljs">TOKEN = <span class="hljs-string"><span class="hljs-string">'111111111:AAHKeYAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'</span></span> API_URL = <span class="hljs-string"><span class="hljs-string">'https://api.telegram.org/bot%s/sendMessage'</span></span> % TOKEN ... <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> data = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> request.json() headers = { <span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span> } message = { <span class="hljs-string"><span class="hljs-string">'chat_id'</span></span>: data[<span class="hljs-string"><span class="hljs-string">'message'</span></span>][<span class="hljs-string"><span class="hljs-string">'chat'</span></span>][<span class="hljs-string"><span class="hljs-string">'id'</span></span>], <span class="hljs-string"><span class="hljs-string">'text'</span></span>: data[<span class="hljs-string"><span class="hljs-string">'message'</span></span>][<span class="hljs-string"><span class="hljs-string">'text'</span></span>] } <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> aiohttp.ClientSession(loop=loop) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> session: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> session.post(API_URL, data=json.dumps(message), headers=headers) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> resp: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> resp.status == <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> web.Response(status=<span class="hljs-number"><span class="hljs-number">500</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> web.Response(status=<span class="hljs-number"><span class="hljs-number">200</span></span>)</code> </pre><br>  <b>NB</b> Please note that in case of successful processing of an incoming message and successful sending of an ‚Äúecho‚Äù, the handler returns an empty response with the HTTP status 200. If this is not done, Telegram services will continue to ‚Äúpull‚Äù hook requests for some time or will receive 200 in response, or until the time specified for the message has expired. <br><br>  <a href="https://habr.com/ru/post/322078/">To the content</a> <br><a name="content3"></a><br><h2>  3. What can be improved? </h2><br>  There is no limit to perfection, a couple of ideas on how to make service more functional. <br><br><h3>  We use middleware </h3><br>  Suppose there was a need to filter incoming messages.  Preprocessing messages can be done on special web handlers; in terms of <i>aiohtttp</i> , these are <i>middlewares</i> <a href="https://habr.com/ru/post/322078/">[5]</a> . <br><br>  Example, define middleware to ignore messages from users from the blacklist: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">middleware_factory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(app, handler)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">middleware_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> data = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> request.json() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> data[<span class="hljs-string"><span class="hljs-string">'message'</span></span>][<span class="hljs-string"><span class="hljs-string">'from'</span></span>][<span class="hljs-string"><span class="hljs-string">'id'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> black_list: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> web.Response(status=<span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> handler(request) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> middleware_handler</code> </pre><br>  And we add the handler during web application initialization: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init_app</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(loop)</span></span></span><span class="hljs-function">:</span></span> app = web.Application(loop=loop, middlewares=[]) app.router.add_post(<span class="hljs-string"><span class="hljs-string">'/api/v1'</span></span>, handler) app.middlewares.append(middleware_factory) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> app</code> </pre><br><h3>  Thoughts on the processing of incoming messages </h3><br>  If the bot is more complicated than the parrot repeater, then we can suggest the following hierarchy of <i>Api</i> ‚Üí <i>Conversation</i> ‚Üí <i>CustomConversation objects</i> . <br><br>  Pseudocode: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Api</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> URL = <span class="hljs-string"><span class="hljs-string">'https://api.telegram.org/bot%s/%s'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, token, loop)</span></span></span><span class="hljs-function">:</span></span> self._token = token self._loop = loop <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, method, message)</span></span></span><span class="hljs-function">:</span></span> headers = { <span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> aiohttp.ClientSession(loop=self._loop) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> session: <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> session.post(self.URL % (self._token, method), data=json.dumps(message), headers=headers) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> resp: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> resp.status == <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, chatId, text)</span></span></span><span class="hljs-function">:</span></span> message = { <span class="hljs-string"><span class="hljs-string">'chat_id'</span></span>: chatId, <span class="hljs-string"><span class="hljs-string">'text'</span></span>: text } <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self._request(<span class="hljs-string"><span class="hljs-string">'sendMessage'</span></span>, message) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Conversation</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Api)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, token, loop)</span></span></span><span class="hljs-function">:</span></span> super().__init__(token, loop) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, message)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, request)</span></span></span><span class="hljs-function">:</span></span> message = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> request.json() asyncio.ensure_future(self._handler(message[<span class="hljs-string"><span class="hljs-string">'message'</span></span>])) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> aiohttp.web.Response(status=<span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EchoConversation</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Conversation)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, token, loop)</span></span></span><span class="hljs-function">:</span></span> super().__init__(token, loop) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, message)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.sendMessage(message[<span class="hljs-string"><span class="hljs-string">'chat'</span></span>][<span class="hljs-string"><span class="hljs-string">'id'</span></span>], message[<span class="hljs-string"><span class="hljs-string">'text'</span></span>])</code> </pre> <br>  Inheriting from <i>Conversation</i> and redefining <i>_handler</i> we get custom handlers, depending on the bot's functionality - weather, financial, etc. <br><br>  And our service turns into a farm: <br><br><pre> <code class="python hljs">echobot = EchoConversation(TOKEN1, loop) weatherbot = WeatherConversation(TOKEN2, loop) finbot = FinanceConversation(TOKEN3, loop) ... app.router.add_post(<span class="hljs-string"><span class="hljs-string">'/api/v1/echo'</span></span>, echobot.handler) app.router.add_post(<span class="hljs-string"><span class="hljs-string">'/api/v1/weather'</span></span>, weatherbot.handler) app.router.add_post(<span class="hljs-string"><span class="hljs-string">'/api/v1/finance'</span></span>, finbot.handler)</code> </pre><br>  <a href="https://habr.com/ru/post/322078/">To the content</a> <br><a name="content4"></a><br><h2>  4. The real world </h2><br><h3>  Register webhook </h3><br>  Create <i>data.json</i> : <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://bots.domain.tld/api/v1/echo"</span></span> }</code> </pre><br>  And we call the corresponding API method in any available way, for example: <br><br><pre> <code class="bash hljs">curl -X POST -d @data.json -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> <span class="hljs-string"><span class="hljs-string">"https://api.telegram.org/botYOURBOTTOKEN/setWebhook"</span></span></code> </pre><br>  <b>NB</b> Your domain, the hook on which you set, must be resolved, otherwise the setWebhook method will not work. <br><br><h3>  We use a proxy server </h3><br>  As the documentation says: <i>ports currently supported for Webhooks: 443, 80, 88, 8443.</i> <br><br>  How to be in the case of self-hosted, when the necessary ports are probably already occupied by the web server, and we did not configure the connection via HTTPS? <br><br>  The answer is simple, starting the service on any available local interface and using reverse proxies, and <i>nginx</i> is better to find something else here, let it take on the task of organizing an HTTPS connection and forwarding requests to our service. <br><br>  <a href="https://habr.com/ru/post/322078/">To the content</a> <br><br><h2>  Conclusion </h2><br>  I hope that working with the bot via web-brows did not seem much more difficult than long polling, as for me it is even easier, more flexible and more transparent.  Additional costs for the organization of the server should not frighten the real bosses. <br><br>  Let your ideas find a worthy tool for implementation. <br><a name="source"></a><br><h2>  Useful: </h2><br><ol><li>  <a href="https://core.telegram.org/bots/api">Telegram Bot API</a> </li><li>  <a href="https://docs.python.org/3/library/asyncio.html">18.5.</a>  <a href="https://docs.python.org/3/library/asyncio.html">asyncio - Asynchronous I / O, event loop, coroutines and tasks</a> </li><li>  <a href="http.readthedocs.io/en/stable/">aiohttp: Asynchronous HTTP Client / Server</a> </li><li>  <a href="http.readthedocs.io/en/stable/tutorial.html">aiohttp: Server Tutorial</a> </li><li>  <a href="&amp;xid=17259,1500008,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhh_kiUKXPMFHVJBxHmFqZfGujwXtw#aio">aiohttp: Server Usage - Middlewares</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/322078/">https://habr.com/ru/post/322078/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../322066/index.html">R in enterprise tasks. Tricks and Tricks</a></li>
<li><a href="../322068/index.html">How I learned to code, created a web application and launched it on Product Hunt in 2 months</a></li>
<li><a href="../322070/index.html">How to write your keyboard for Android</a></li>
<li><a href="../322072/index.html">How computers were advertised in the 1990s</a></li>
<li><a href="../322076/index.html">Basic principles of machine learning on the example of linear regression</a></li>
<li><a href="../322080/index.html">Indoor Air Quality Monitor</a></li>
<li><a href="../322082/index.html">Transition from Google Analytics to Firebase</a></li>
<li><a href="../322084/index.html">How slyamzit Habr in a quick way</a></li>
<li><a href="../322088/index.html">Benefits of Enterprise Mobility Management with Citrix XenMobile</a></li>
<li><a href="../322092/index.html">‚ÄúProgramming as a way of creative implementation‚Äù or Corona SDK for those who want</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>