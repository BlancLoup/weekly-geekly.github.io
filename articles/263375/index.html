<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Why is it not easy to show all colors in a one-dimensional space, and how many times it can be done</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Yandex is able to suggest colors by their name and find ones close to them. Some time ago, this hint (inside we call such things ‚Äúsorcerer‚Äù) had to be...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Why is it not easy to show all colors in a one-dimensional space, and how many times it can be done</h1><div class="post__text post__text-html js-mediator-article">  Yandex is able to suggest colors by their name and find ones close to them.  Some time ago, this hint (inside we call such things ‚Äúsorcerer‚Äù) had to be redone to fit the type of search results after their redesign.  And we took advantage of this opportunity to work on it seriously, as it turned out that arranging colors linearly is a very nontrivial task. <br><br> <a href="http://habrahabr.ru/company/yandex/blog/263375/"><img src="https://habrastorage.org/files/40e/7c7/e99/40e7c7e997d3430f87d75e5c71306b26.png"><br><img src="https://habrastorage.org/files/9d7/c09/18c/9d7c0918c45641a593b09203b33ab6cc.png"><img src="https://habrastorage.org/files/192/c9c/75d/192c9c75d9994aa8a64c20897d076a70.png"><br><img src="https://habrastorage.org/files/6d4/047/607/6d40476070c34015a6c49039b8f8362f.png"><br><img src="https://habrastorage.org/files/98e/a36/0bd/98ea360bd7214d489fffcc73eb2080d1.png"><br></a> <br><br>  In this post, I want to tell you what an interesting algorithmic problem that demanded immersion <a href="http://habrahabr.ru/company/yandex/blog/262735/">in color theory</a> , we had to solve almost all of Yandex to make the new sorcerer the way the team conceived it. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/f5b/6dd/251/f5b6dd251c324dbaa7da61b62e1249bb.png"><br><br>  The color maker appeared in Yandex search results in 2008.  When he was conceived, we wanted him to become not only a toy that would reveal the color of a frightened nymph‚Äôs hip to a person, but also help him learn the color by the formula, learn the color notation, translate the code from one color space to another.  The old version of the witcher consisted of a drum, a color picker, an input and 234 named colors. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bb5/59b/519/bb559b5195e4e7f578244bcfa15473ab.gif" alt="old colors"></div><br><br>  At first it seemed that it could be revived on a renewed issue in a couple of weeks.  The first part of this task was to bring the appearance of the witcher to a new style of the search results page. <br><br>  It quickly became clear that it would not be possible to assemble it on standard elements.  In addition, a witcher drawn for the old search results page would not fit into the new version, and to make a three-dimensional drum, according to our designers, is no longer fashionable.  Thus was born a flat design.  The main thing that I wanted to support in the new version and what was not there before was the viewing of custom colors that had no name.  In the old version, the sorcerer answered all requests with the nearest named flowers and could mislead people.  Now, any color can be seen in the environment of the nearest named neighbors or in another brightness. <br><br><img src="https://habrastorage.org/files/207/c97/369/207c97369cde42ba80e01ec26bdbc0a2.png" width="970"><br><br>  The chief search designer, <a href="http://habrahabr.ru/users/kovchiy/" class="user_link">kovchiy,</a> presented the team with a file with thousands of named colors from a personal archive.  As a result, we had 1010 colors, the names and coordinates of which were partially fixed in standard color lists (such as HTML Color Names, X11 Color Names), and partly invented on their own.  And when they began to think how to put them into a sorcerer, the most difficult things began.  The team that worked on it decided to even arrange a competition for the best sorting of flowers in the internal social network of Yandex.  It was there that I learned about the task and offered my solution, which eventually ended up in production.  But first things first. <br><br>  So, the task was to arrange a set of colors on the drum (on the line or ring) so that: <br><ul><li>  transitions between adjacent colors were smooth, and perhaps less contrasted, so that the adjacent colors were similar; </li><li>  similar colors are grouped so that similar colors stand side by side. </li></ul><br><img src="https://habrastorage.org/files/c36/4fd/68f/c364fd68f6af49b98a642b97fcf22889.png" width="1032" height="128"><br>  <i>It looked like the original set of colors without a given order</i> <br><br>  But already these two criteria are: <br><ul><li>  <b>redundant</b> - a grouping of similar colors increases the contrast, and a decrease in contrast separates the groups; </li><li>  <b>insufficient</b> - they allow many different solutions, with the equality of which, according to these criteria, some stand out among other less specific qualities, such as better visible meaningfulness of the location as a whole; </li><li>  <b>vague</b> - they indicate what the desired solution should look like, but they do not allow us to distinguish which of the good solutions is better. </li></ul><br>  As a result, both judges and participants relied more on taste than on matching criteria when comparing decisions. <br><br>  Manually, without the help of algorithms, it will not be possible not only to find a beautiful order of even a smaller number of colors, but also to improve someone found.  If it seems that some color is the place in another part of the drum, then rearranging, you find a sharp contrast: the color perception depends on the background, and the new neighbors of the displaced color, which look so similar to the background of nearby colors, suddenly find a <a href="http://scanline.ca/ciecam02/">very different shade</a> after moving . <br><br>  If you select the arrangement of colors algorithmically, it is natural to see the optimization problem in the problem and the first step to solving it is to choose the optimization goal - a function that tells you how good or bad this or that alignment of colors is. <br><br>  To construct this function, an auxiliary one, called <a href="https://en.wikipedia.org/wiki/Color_difference">ŒîE</a> , is needed, which specifies the number of difference or degree of similarity between two colors.  That is, if and only if the difference of one pair of close colors is equal to the difference of the other pair, it should appear to the observer that the colors in each of the pairs are equally distant from each other.  ŒîE is one of the fundamental problems of the science of color, but within certain limits it is well solved.  Fortunately, the function of the difference between colors has long been studied in the science of color, and now, where necessary, the formula published by the international lighting committee together with the <a href="https://en.wikipedia.org/wiki/Lab_color_space">CIE L * a * b *</a> (LAB) color space in 1976 (in which the difference between colors are simply Euclidean distance between them) called CIE ŒîE and refined in 1994 and 2000.  Contestants who did not know about CIE ŒîE, usually defined ŒîE themselves as Euclidean distance in RGB and HSV. <br><br>  Using ŒîE, we can construct a function of assessing the quality of the arrangement of colors on the drum as the sum of the squares of the differences between adjacent colors on the drum.  The decision between the participants begins to differ with the choice of the function of the quality of the decision.  All good solutions used CIE ŒîE;  among themselves they differ in the choice of the function of the quality of the solution and the algorithm for its optimization. <br><br>  Why is CIE ŒîE somewhat different, how do they differ in meaning?  The CIE LAB color space was created so that the colors are evenly spaced.  It separates the brightness from the other two coordinates of the color, which it chooses so that a change in color by several units of brightness is perceived as the difference when changing other coordinates by the same units.  But the mathematical simplicity of functions expressing the transformation of physical space ( <a href="https://en.wikipedia.org/wiki/CIE_1931_color_space">CIE XYZ</a> ) into LAB, apparently, was of significant importance.  Subsequent experiments showed that the perceived color difference is not quite, although very close, consistent with the LAB.  That is, LAB is not completely homogeneous.  But the found corrections to CIE ŒîE 1976 cannot be included in the new color space - that is, the space in which the corrected CIE ŒîE would be the Euclidean distance, like the old CIE ŒîE in CIE LAB, is impossible.  Therefore, CIE LAB 1967 is still used. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3a1/643/bd0/3a1643bd002f8db270308297516723b4.png" alt="CIELAB"></div><br><br>  After we have chosen the color space, we can continue to choose the most natural, simplest solution quality function - this is the sum of squares between adjacent arrangement colors.  Optimization of this function leads to the smoothest transitions between neighboring colors (if you use CIE ŒîE), and this solution is now used in the updated color charts.  However, it does not specifically take into account that it may be better to arrange a group of neighboring colors in a row than to use its part, smoothly switch to other shades and return to the first one more time.  In addition, it may be desirable to switch from color to color ‚Äúin one direction‚Äù: so that after dark red, after a slightly lighter red, there is an even lighter, not darker shade.  To take these wishes into account, participants added to the simple quality function a sum of squares of differences to more distant neighbors, or to the average color of all the nearest neighbors.  This improved the appearance of the arrangement as a whole, but unfortunately, it often overly degraded the close view ‚Äî the five-color set that the charmer shows at a time. <br><br>  After selecting the quality function, you need to decide how to optimize it.  If this function looks like the sum of squared differences between the colors next to it, the optimization task is almost equivalent to the optimization of <a href="https://en.wikipedia.org/wiki/Travelling_salesman_problem">the traveling salesman‚Äôs (TSP) path</a> visiting all the sites once and trying to minimize the total path.  TSP is an NP-complex, but well-studied problem, for which a public access to an approximate solution has several excellent solvers, primarily <a href="http://www.akira.ruc.dk/~keld/research/LKH/">LKH</a> and <a href="http://www.math.uwaterloo.ca/tsp/concorde.html">Concorde</a> .  Using a specialized solver allows you to get a solution closer to the optimal and faster than is possible with the use of universal optimization methods. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4ce/91d/de6/4ce91dde6d039b74a2c6d4b3d279eb5e.png" alt="Tsp"></div><br><br>  Such universal methods are required if a more complex distribution quality function is chosen, taking into account the difference not only between the nearest neighbors. <br><br><img src="https://habrastorage.org/files/cc0/efb/a49/cc0efba49d9b4adf837c5785cb64b5b5.png"><br>  <i>Sorting option using TSP by Metric <a href="https://en.wikipedia.org/wiki/Color_difference">CIE94</a> by <a href="http://habrahabr.ru/users/zubchick/" class="user_link">Zubchick</a></i> <br><br>  Two participants used the annealing method.  This method is a consistent solution optimization.  First, we take some arbitrary decision and then try to gradually improve it.  At each step, we choose some simple transformation of the previous solution.  For example, rearrange a pair of random colors or neighboring colors, or flip a segment of flowers, or put it in another place.  After such a permutation, the quality of the previous and next solutions is compared in terms of the quality of the decisions. <br><br><img src="https://habrastorage.org/files/192/c9c/75d/192c9c75d9994aa8a64c20897d076a70.png"><br><br><img src="https://habrastorage.org/files/40e/7c7/e99/40e7c7e997d3430f87d75e5c71306b26.png"><br><br><img src="https://habrastorage.org/files/9d7/c09/18c/9d7c0918c45641a593b09203b33ab6cc.png"><br>  <i>Several options for sorting by annealing method from <a href="http://habrahabr.ru/users/aorazaev/" class="user_link">AOrazaev</a></i> <br><br>  If this were not an annealing method, but a gradient descent method, he would always move from a solution with a lower quality to a solution with a better quality.  But such a method leads to local optima when it is impossible to improve the solution by some simple transformation, but if everything is radically changed, one can come to a better result.  Therefore, the annealing method sometimes worsens the solution.  Due to this, it is possible to get rid of local optima in the search for a global optimum.  The solutions were not bad, but not good enough near. <br><br>  Two of our other colleagues used genetic algorithms and either did not get a good result or used an unsuccessful quality function.  Apart from the <a href="http://habrahabr.ru/users/xtremalraven/" class="user_link">XtremAlRaven</a> version, where the independently received TSP solution was taken as a starting point, but which could not be significantly improved. <br><br><img src="https://habrastorage.org/files/6d4/047/607/6d40476070c34015a6c49039b8f8362f.png"><br>  <i>An attempt to improve the modified TSP in the CIE1994 metric from <a href="http://habrahabr.ru/users/xtremalraven/" class="user_link">XtremAlRaven with a</a> genetic algorithm</i> <br><br>  So far, I have said that the result can only be obtained algorithmically, but in addition to choosing a specific algorithm, some manual intervention was possible.  First, some participants tried to group the colors around several selected points (say, around black, red, green) and optimize all zones separately, and then glue them together. <br><br>  I tried to place the colors by hand-selected groups (so that similar saturated colors do not mix with each other), find the boundary colors so that they smoothly merge into each other, and sort each group between the boundary colors.  This method allows you to find a solution that looks better from afar, because it turns out less than the same color spots in different places, but in the witcher, when only 5 colors are shown, it looks a little worse. <br><br>  In fact, the task seemed difficult, because before the competition was announced, the sorcerer‚Äôs developers had a question of how well to arrange the colors for a month and a half.  In the end, they themselves found a good solution, comparable in quality to those who later participated in the competition.  In addition, if you do not know in advance some elements of color theory, it is difficult to understand how to solve this problem well.  My decision was ready on the third day of the competition, most others in the first week. <br><br><img src="https://habrastorage.org/files/98e/a36/0bd/98ea360bd7214d489fffcc73eb2080d1.png"><br>  <i>Total sort</i> <br><br>  Here the difficulty arose in the team that dealt with the sorcerer - they had to choose one of almost forty. </div><p>Source: <a href="https://habr.com/ru/post/263375/">https://habr.com/ru/post/263375/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263365/index.html">Porting Unity Editor to Linux: Things You Should Wanna Do in advance</a></li>
<li><a href="../263367/index.html">Cryptocurrency - how to create it?</a></li>
<li><a href="../263369/index.html">Integration of PVS-Studio with the IncrediBuild distributed assembly system</a></li>
<li><a href="../263371/index.html">Refactoring: highlight the method when it makes sense</a></li>
<li><a href="../263373/index.html">Build your tab on the ribbon (Ribbon) AutoCad means. Net (C #)</a></li>
<li><a href="../263377/index.html">How software and hardware are used on computers in Russian companies</a></li>
<li><a href="../263379/index.html">Snipper - a little programmer assistant</a></li>
<li><a href="../263381/index.html">Registration for MBLTdev 15 - international conference of mobile developers has begun</a></li>
<li><a href="../263387/index.html">Research interstitial ads on Google+ with advertisements</a></li>
<li><a href="../263391/index.html">Automate it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>