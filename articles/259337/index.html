<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>XMPP sucks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We had a social application without a chat, 2 weeks to develop it, and absolutely no knowledge of existing protocols for implementing IM. Not that it ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>XMPP sucks</h1><div class="post__text post__text-html js-mediator-article">  We had a social application without a chat, 2 weeks to develop it, and absolutely no knowledge of existing protocols for implementing IM.  Not that it was the necessary set to shoot himself in the foot, but in the process, it happened.  Repeatedly. <br><br>  - Pasha, we need to make a chat. <br>  - Yes, everything is simple, my friends here used XMPP to chat in their application. <br><br>  What were our requirements?  Nothing special, simple messaging between users, without group conversations.  Platforms: web (with support for working via web sockets), Android, iOS.  Creating users should automatically be done only by our server application.  Of course, it would be nice to have marks on whether the message was read or not (it is assumed that the application can be used from different devices), and to be able to view the chat log.  In general, the standard functionality for instant messaging in 2015.  Bonus points are awarded if the server can scale horizontally. <br><a name="habracut"></a><br>  Hmmm sounds tempting.  We google comparison with other standards, we open the <a href="http://en.wikipedia.org/wiki/Comparison_of_instant_messaging_protocols">link to article in Wikipedia</a> .  First thought: Wow, cool, there is everything we need. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Why did we choose XMPP? <br><ul><li>  XMPP is an open protocol developed by the XSF (XMPP Standards Foundation), an independent non-profit organization.  These guys must be pretty smart and have foreseen everything the messaging protocol needs (yeah, of course). </li><li>  Since the open protocol must have quite a few server implementations, and at least one of them will be good enough to use it. </li><li>  For the same reason, for each of the programming languages ‚Äã‚Äãthere will certainly be 1-2 libraries. </li><li>  The first letter X in the abbreviation means extensible, extensible.  Even if we do not like something in the protocol, we can always expand with our own methods. </li></ul><br><br><h2>  Protocol </h2><br>  The guys who developed the protocol really provided a lot.  For example, take a look at the <a href="http://xmpp.org/extensions/xep-0136.html">message archiving design</a> .  Individual archiving settings for sessions.  Description of what to do if one of the users wants his messages not to be stored on the server, and the second wants it.  At the same time, there is no normal mechanism for receiving archive of messages by pages.  By normal, I mean offset and limit.  Here you can set only the max parameter, which will set the maximum number of messages and the start parameter, which means the time from which you will receive messages. <br><br>  Or, for example: the protocol does not define what should be done with offline messages (messages sent to the user off-line).  Therefore, most servers simply send them to the user at the next login.  Remember the requirement that the user can use the application from multiple devices?  So, if you run the application on your smartphone, and then enter the web application, all offline messages will come to your smartphone and ... everything.  That is, you can‚Äôt find out about it in a web application.  It is worth noting that some servers behave differently, that is, they implement <a href="http://www.xmpp.org/extensions/xep-0013.html">XEP-0013</a> . <br><br>  Oh yeah, the protocol for IM (instant messaging) in 2015 does not have a specification that would allow you to get a list of unread messages and mark some of them as read.  Totally. <br><br><h2>  Implementations </h2><br>  At the very beginning, I did not know what problems from the previous paragraph I would have to face, and therefore MongooseIM was chosen as the server implementation.  Scalable, can prohibit permission to register only from certain ip, supports web sockets.  For the front-end web, the JSJaC library was chosen because it provided a more convenient API compared to strophe.js.  A simple page from the examples of JSJaC connected to the server from a half-kick, and my joy knew no bounds.  It would seem that the work is finished.  Almost. <br><br>  And then I ran into the last voiced problem from the previous paragraph.  Since the protocol does not imply the possibility to receive unread messages, and in general it doesn‚Äôt mean that the messages are read / unread, this part of the functionality will have to be added.  Being not strong at erlang programming, I began to look for other suitable server implementations.  I was looking for Java or JavaScript implementations. <br><br>  Openfire is one of the most popular implementations of XMPP in Java.  The advantages include ease of setup: everything happens through the web interface.  Further only minuses: requirements to resources, lack of a plug-in for work through web sockets. <br><br>  The only thing worth mentioning from JavaScript projects was <a href="https://github.com/xmpp-ftw/xmpp-ftw">xmpp-ftw</a> .  The project implements many extensions from XMPP.  However, its use had to be abandoned, since we would not be able to use existing client libraries.  Maybe it would not be so good with him. <br><br>  Tigase at first seemed a salvation.  Fast, scalable server in Java, with the ability to write a plugin and quite simple to connect it.  And the lack of documentation.  Instead, it was recommended to read the source code.  But this is nothing, I already do that more often.  I wrote a plugin that flagged new messages unread.  In order to register users, we had to write them directly to the database, because the administration API could not be properly used.  Fortunately, Tigase has a driver for connecting to Mongodb.  Receiving unread messages was done by a separate application API method (the crutch could have been done by the plug-in inside Tigase, but it would take much more time, because a rather low-level API is used to communicate with the DBMS inside Tigase).  By connecting everything I checked - until the message is marked read (by the way, messages do not have an id in xmpp, so it was decided to mark the read all the correspondence with a specific user) it is returned in the unread list.  Everything is working.  It remains to check only the case with offline message.  Yes, it was not marked unread, because the plugin that processes offline messages is triggered earlier than archiving.  On the Tigase forum, the developer responded that the behavior I needed was implemented in the commercial project Tigase Unified Archive.  Googling by its name did not lead to anything, the developer on the forum said that the project is still unstable and there is no release version.  Having rummaged in source codes of the server found that it is possible to receive the necessary behavior having exposed to all messages the chat type. <br><br>  Now let's go through the client implementations.  Let's start with JavaScript implementations.  We tried only JSJaC, which was eventually changed to strophe.js.  The first has a more pleasant API, but it has only basic functionality, not supporting work with extensions, for example, with the archive.  At the same time, strophe instead offers a rather convenient xml builder.  Well, to abstract from interiors XMPP did not work.  By the way, the web socket connector in JSJaC works only in Webkit. <br><br>  From Java clients only Smack is currently tried.  If an invalid packet is sent, NoResponseException will most likely be thrown, and that‚Äôs all you will know. <br><br><h2>  Conclusion </h2><br>  Maybe my problem is that I hoped that someone solved some of my problems for me and did it well.  If I knew all this first, I would suggest to write my own chat server.  Seriously.  The point is not that the protocol is bad or not suitable for use in implementing IM with modern requirements, although I still think so.  Simply, I would prefer to have my own code and lay the necessary opportunities for expansion, rather than shovel so many other people's code and specifications.  XMPP is quite successfully used to solve a huge range of tasks for which, it seems, it is well suited.  Although most solutions use only basic functionality. </div><p>Source: <a href="https://habr.com/ru/post/259337/">https://habr.com/ru/post/259337/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259327/index.html">A new bug from Apple, a game from Zynga and a report from App Annie in the news of the week for a mobile developer</a></li>
<li><a href="../259329/index.html">App Store style customizable download button</a></li>
<li><a href="../259331/index.html">Secure computer inside Micro SD card</a></li>
<li><a href="../259333/index.html">Simplicity design: How to make effective plain-text letters</a></li>
<li><a href="../259335/index.html">New 2GIS under Windows Phone: architecture and technology stack</a></li>
<li><a href="../259339/index.html">Integration of OTRS v4 with Active Directory. Configure Single Sign On Authentication</a></li>
<li><a href="../259341/index.html">Microsoft will force users to update Windows 10</a></li>
<li><a href="../259343/index.html">DDA for cat</a></li>
<li><a href="../259345/index.html">Kerio Operator 2.4 saves costs and increases employee productivity</a></li>
<li><a href="../259347/index.html">Adaptive multi-level menu of the site with self-registered items based on the AngularJS directive</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>