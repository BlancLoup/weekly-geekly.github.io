<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JavaScript loading and initialization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="With the advent of the mobile web, our Internet has become bad again, and the devices are slow. 3G, 4G, Wi-Fi ... - of course, they are somewhere, but...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JavaScript loading and initialization</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/85b/358/567/85b3585671ac99a37a7988943b46fa0c.jpg" align="left"><br>  With the advent of the mobile web, our Internet has become bad again, and the devices are slow.  3G, 4G, Wi-Fi ... - of course, they are somewhere, but when they really need it, the speed usually drops to near-modem and it turns out that our mobile devices of the ‚ÄúStone Age‚Äù fall into the conditions of a modern amount of information.  Even in the city center (albeit on the 15th floor), the icon of the mobile Internet can show the magic letter E, hinting that it is better not to waste your nerves and suffer.  It is better to use the native version of a web service than to wait each time to download a megabyte to send a short message.  <i>Native version of the web service ...</i> Marketing business, application race, of <i>course</i> .  However, users choose native web applications that run faster, do not download a lot of resources, although they have to update it periodically. <br><br>  This article is about how you can optimize the loading and initialization of JavaScript. <br><a name="habracut"></a><br><br><h4>  Not all code is used. </h4><br>  I did a little research to identify the amount of code that is used when a user visits the first page of various mobile versions of popular sites.  For this, I used the Chrome + <a href="http://code.google.com/p/script-cover/">script-cover</a> plugin. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On average, about 40 percent of the code in the hospital is used.  There are websites that use 80% of downloadable resources, but there are also those that use only 20%.  You will be right if you say that ‚Äúthe rest of the code will be used from the cache on other pages‚Äù - we, as developers, know why so much is loaded, and a simple user waits every time that this entire volume is loaded, although he only needs to send a message to my friends. <br><br><h4>  Cache </h4><br>  Suppose that a user once downloaded all our resources, they got into the cache and the next time he will not download them (Expires: +300 years FTW). <br><br>  Now the cache size of the desktop web browser is 40-80MB.  This amount can be spent for an hour and a half of active web surfing, because almost every site wants to crawl into the cache with its Expires: +300 years on pictures and other dubious resources and force out your useful scripts.  It turns out a kind of king of the mountains or an Indian electric train.  Even having installed a 400 MB disk cache, you can download the same scripts and styles every day. <br><br>  Everything is worse with mobile phones - iOS Safari does not have a disk cache (only in memory), for Android it is limited to 20MB. <br><br><h4>  Optimization application </h4><br> <a href="http://azproduction.github.com/loader-test/"><img src="https://habrastorage.org/storage2/33c/8fc/add/33c8fcaddcb015f8dd891bb901cbe81c.png"></a> <br>  I created one simple application - it is a chat prototype.  We will try to speed up its loading in very harsh conditions - at the speed of the Internet at 7Kb / s.  All its versions can be viewed here <a href="http://azproduction.github.com/loader-test/">azproduction.github.com/loader-test</a> <br><br><h4>  Sequential loading and execution </h4><br>  When you start the application code that loads our scripts, it looks like this: <br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js/b-roster.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js/b-dialog.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js/b-talk.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js/index.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Our scripts are loaded and run sequentially (in fact, in modern browsers this is a bit wrong), 4 requests.  Of course, this is the worst of all the options.  His profile looks like this: <br><img src="https://habrastorage.org/storage2/de4/885/16c/de488516c5f7dcd882e130be87265584.jpg"><br>  18 seconds ... do not wait so much ... <br><br><h4>  Parallel loading and execution </h4><br>  We will slightly change our code by adding the <b>async</b> attribute so that our scripts load and start in parallel.  For many applications, this method of loading will not work.  scripts may have dependencies on previous code. <br><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js/b-roster.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js/b-dialog.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js/b-talk.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js/index.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Let's see what we get <br><img src="https://habrastorage.org/storage2/84e/ee4/7ed/84eee47edc1c13ea1ccd31d04647a1da.jpg"><br>  Nothing has changed ... only the DOM ready event is triggered a bit earlier, but this will not help us because  we need all the code for the application to work. <br><br><h4>  Parallel download sequential run </h4><br>  Let us try to apply another ‚Äúoptimization‚Äù in parallel, we will load, but run sequentially.  To do this, use the <a href="http://labjs.com/">LAB.js</a> library: <br><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vendors/LAB.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> $LAB .script(</span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">"js/b-roster.js"</span></span></span><span class="actionscript">) .script(</span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">"js/b-dialog.js"</span></span></span><span class="actionscript">) .script(</span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">"js/b-talk.js"</span></span></span><span class="actionscript">) .wait() .script(</span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">"js/index.js"</span></span></span><span class="actionscript">); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  But it only got worse: <br><img src="https://habrastorage.org/storage2/3f5/fb7/39b/3f5fb739bb10e4a146dc242ea9c01bc9.jpg"><br>  It would seem to load in parallel - it means that the loading of resources should not be blocking, and everything should be a little, but faster. <br>  In fact, all modern browsers load all the scripts on the page in parallel, but run them sequentially in the order of the declaration in the document.  If a script arrives earlier than necessary, then its launch is blocked.  In the case of LAB.js, we actually do the work of the browser, even though the LAB.js script blocks the loading of all other scripts, and it also takes up some volume. <br><br><h4>  We collect and pack </h4><br>  Let's apply another rather obvious optimization - we will collect all the scripts in 1 file and compress this code with some minifiers. <br><pre> <code class="bash hljs">$ cat **/*.js &gt; main.js $ java -jar yuicompressor.jar main.js -o main.min.js</code> </pre><br>  I think, for many of these lines are familiar, I use the <a href="http://tinyurl.com/yui-compressor">YUI Compressor</a> , but I would advise using the <a href="https://github.com/mishoo/UglifyJS">UglifyJs</a> or <a href="http://code.google.com/p/closure-compiler/">Closure Compiler</a> <br><img src="https://habrastorage.org/storage2/da6/229/5b5/da62295b50b1ebac337e804bd478c788.jpg"><br>  The result of this optimization is very obvious.  In principle, it is possible to further not optimize :) But!  9c ... - so many users will not wait every time. <br><br><h4>  AppCache - offline storage </h4><br><img src="https://habrastorage.org/storage2/a81/36f/f50/a8136ff50c0cabbee3e53cc1391e589e.jpg" align="left">  Unlike the shared cache, this one is personal to each application, and other applications will not be able to replace its resources.  The only thing that can happen is that the total quota for AppCache will end or the user will clear it.  AppCache is <a href="http://caniuse.com/">supported by many browsers</a> .  Although it is called offline storage - but we can use its resources for online work. <br><br>  Connecting it is very simple: <br><br>  It is enough to register the manifest attribute with a link to the appcache file <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">manifest</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"example.appcache"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Create this file listing all the resources that should be cached (this is the simplest version of the file) <br><pre> <code class="bash hljs">CACHE MANIFEST <span class="hljs-comment"><span class="hljs-comment"># v1 - 2011-08-13 http://example.com/index.html http://example.com/main.js</span></span></code> </pre><br>  And in the settings of your web server, register several lines so that the file is given with the correct MIME type and is not cached <br><pre> <code class="bash hljs">AddType text/cache-manifest .appcache ExpiresByType text/cache-manifest <span class="hljs-string"><span class="hljs-string">"access plus 0 seconds"</span></span></code> </pre><br>  Using AppCache, you can promptly (without extra crutches) inform the user that his application is out of date and ask to reload the page, or ask for a resolution to reload.  The browser takes over all network activity and cache checking on itself ‚Äî all you have to do is subscribe to the updateready event and check out the cache stutus. <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.applicationCache) { applicationCache.addEventListener(<span class="hljs-string"><span class="hljs-string">'updateready'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (confirm(<span class="hljs-string"><span class="hljs-string">'An update is available. Reload now?'</span></span>)) { <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location.reload(); } }); <span class="hljs-comment"><span class="hljs-comment">//       if(window.applicationCache.status === window.applicationCache.UPDATEREADY) { if (confirm('An update is available. Reload now?')) { window.location.reload(); } } }</span></span></code> </pre><br>  <b>Pros of AppCache</b> <br>  1. Reliable caching <br>  2. Work offline <br>  3. Simple version control <br>  4. Timely update <br><br>  <b>Cons Appache</b> <br>  1. Disk quota may end <br>  2. The user may not allow your site to use the cache (in the case of Firefox) <br>  3. Online resources will not be available on the cached page unless <code>NETWORK:\n*</code> <br>  4. If you suddenly put Expires +300 years on your .appcache file - your user will forever get stuck on the old version <br>  5. Redirects to other domains are perceived as Failure. <br>  A few more minuses AppCache <a href="http://www.alistapart.com/articles/application-cache-is-a-douchebag/">www.alistapart.com/articles/application-cache-is-a-douchebag</a> <br><br>  Let me insert a few comments from <a href="https://habrahabr.ru/users/vitazheltyakov/" class="user_link">VitaZheltyakov</a> , thanks to him: <br><blockquote>  - Update files in Application Cache when configured standard caching in FF.  - files will not be updated. <br>  - Add specific links (not patterns) to NETWORK and FALLBACK sections - all unspecified files will not be loaded at all. <br>  - In the frame, open the page with Application Cache caching the first - the application will hang, cycling the pages. <br>  - Try to work with an offline copy of the main page where the manifest is declared - it will load from the cache as a working one. </blockquote><br><br>  I think it is obvious what kind of results we will get when reloading the application from the cache - 0 requests, 0 bytes.  (1 request can go to download the .appcache file) <br><br>  <b>Learn more about AppCache</b> <br>  Article on AppCache on MDN <a href="http://tinyurl.com/mdn-appcache">tinyurl.com/mdn-appcache</a> <br>  AppCache FAQ <a href="http://appcachefacts.info/">appcachefacts.info</a> <br>  AppCache for newbies <a href="http://www.html5rocks.com/en/tutorials/appcache/beginner/">www.html5rocks.com/en/tutorials/appcache/beginner</a> <br><br><h4>  Selective download </h4><br>  Although we now have good caching, but loading our application is far from optimal.  We are still loading extra resources that the user may not need right now.  Let's apply optimization with lazy loading of scripts.  We can use <a href="https://github.com/amdjs/amdjs-api/wiki/AMD">AMD</a> ‚Äôs ‚Äúpattern‚Äù - Asynchronous Module Definition and the <a href="http://requirejs.org/">RequireJS</a> library that implements this API. <br><br>  1. Ship the main parts <br>  2. The rest is necessary <br>  3. Auto-dependencies <br>  four.‚Ä¶ <br>  5. PROFIT <br><br>  We can divide our application into 2 parts - this is a roster with a list of contacts and a dialogue.  The roster should always be shown, and the dialogue opens less frequently, so we will load it by necessity. <br><br>  Our html became such <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-main</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js/amd/index"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vendors/require.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Each module we wrapped in the necessary wrapper for require.js.  In the case of index.js, it will be like this: <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>([<span class="hljs-string"><span class="hljs-string">"b-roster"</span></span>], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Roster</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Roster($(<span class="hljs-string"><span class="hljs-string">'body'</span></span>)); });</code> </pre><br>  And we will wrap each loadable module in a different wrapper: <br><pre> <code class="javascript hljs">define(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  -   return ModuleName; });</span></span></code> </pre><br>  At startup, we load only index.js and roster.js, and by clicking on the roster element we load the rest of the files: <br><pre> <code class="javascript hljs">querySelector(<span class="hljs-string"><span class="hljs-string">'.b-roster'</span></span>).addEventListener(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>([<span class="hljs-string"><span class="hljs-string">"b-dialog"</span></span>], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Dialog</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dialog(element); }); }, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);</code> </pre><br>  The idea and implementation is simple, let's see what we got in the end: <br><img src="https://habrastorage.org/storage2/23d/fc9/5c5/23dfc95c5867da7a9c39f6295bd0a5a4.jpg"><br>  Compared to the previous result, we began to do 2 more requests, but the initial volume of scripts decreased by 16.5Kb, time by 2.1s <br><br>  This approach, of course, has one significant drawback - the user has to wait 4 seconds to click on the roster element (for the rest of the scripts to load), which, of course, is not very good. <br><br><h4>  Lazy loading and initialization </h4><br>  7.4 seconds at the start is, of course, not 18, but not 3-5 seconds, which the user can suffer. <br><br>  With an increase in the volume of scripts, the start time of the application grows - Startup Latency.  The fact is that when starting our browser has to interpret and initialize all the functions, objects, constructors that were listed in this file, even if we are absolutely not needed at the moment.  And the initialization time of 1 MB of javascript can be up to 3 seconds depending on the browser and the load on the device resources.  For desktop browsers, this figure is, of course, much lower (100-300ms). <br><br>  When building our application, we can transform our scripts into strings, and then, if necessary, replay them and get the code.  Yes, eval is slower than the usual launch, but this initialization does not occur during the start, but during the application, which allows our application to run faster. <br><br><h4>  LMD </h4><br>  Based on this idea, I created the principle <a href="https://github.com/azproduction/lmd">LMD</a> - Lazy Module Declaration and made another ‚Äúloader‚Äù with the same name.  In addition to lazy initialization, LMD has a number of other advantages compared to others: <br><br><h5>  2. Node.js-like modules </h5><br>  AMD requires us to write define () each time, although we can do without define and write code for the browser 1 in 1 as for Node.js without any wrappers and magic with exports. <br><br>  This is what the index.js code looks like under LMD: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> $ = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>().$, <span class="hljs-comment"><span class="hljs-comment">// require("undefined") Roster = require("b-roster"); new Roster($('body'));</span></span></code> </pre> <br>  When assembling an LMD package, LMD already wraps the given code in the necessary wrapper for it. <br><br><h5>  3. Built-in collector and packer </h5><br>  The script collector and packer are already built into LMD.  You just need to declare all your scripts that should be included in the package: <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"path"</span></span>: <span class="hljs-string"><span class="hljs-string">"./modules/"</span></span>, <span class="hljs-string"><span class="hljs-string">"modules"</span></span>: { <span class="hljs-string"><span class="hljs-string">"main"</span></span>: <span class="hljs-string"><span class="hljs-string">"index.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"b-roster"</span></span>: <span class="hljs-string"><span class="hljs-string">"b-roster.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>: <span class="hljs-string"><span class="hljs-string">"utils.js"</span></span>, <span class="hljs-comment"><span class="hljs-comment">//     * "*": "*.js" } }</span></span></code> </pre><br>  LMD will compress and pack them, but compression and packaging are optional - you can manage them for the entire file or for each module separately. <br><br><h5>  4. Flexible Library Size </h5><br>  Unlike Require.js-AMD, the entire LMD code is included in your script package already at the time of assembly, without any unnecessary gestures.  You can flexibly turn on or off all sorts of optimizations and "plugins."  For example, if your code will work only in modern mobile devices, then why do you need all these hacks for IE6 ?!  In the LMD, this ‚Äúoptimization‚Äù can be easily disabled in the config.  Or you don't want to load CSS dynamically - why do you need to drag extra code ?!  - disable the option and the code becomes smaller.  The minimum amount of LMD.js is only 288 bytes. <br><br><h5>  5. Hot build project </h5><br>  There are such web applications that need to be rebuilt each time to check what happened.  LMD also suffers from this, but it does not force you to do <code>make</code> every time or set up a tricky build on the server.  You just need to run LMD in watch mode and each time you change any file included in the assembly, LMD rebuilds the whole project. <br><br><pre> <code class="bash hljs">$ lmd watch config.lmd.json output.js</code> </pre><br><h5>  6. Smart collector </h5><br>  I try to make an intelligent collector from LMD.js that can point out possible errors during the build - ParseError, missing / extra flag in the config, direct use of globals in lazy-modules and other optimizations. <br><br>  So many advantages, but in fact: <br><img src="https://habrastorage.org/storage2/35e/8d7/4c3/35e8d74c333214e31ba607ca1f5423aa.jpg"><br>  Compared to AMD, we have reduced the volume by another 13.5 Kb of the start time by 2.1 s, and the number of requests by 2. <br><br>  If we compare with the very first case, then we get amazing results: <br><img src="https://habrastorage.org/storage2/b35/ca2/6d8/b35ca26d8e7a11089d4edc447edcee34.jpg"><br><br><h4>  Conclusion </h4><br>  <b>1. Use AppCache, but with care</b> <br>  AppCache is a fairly simple optimization that allows you to add a good cache to your web application without changing the project code.  AppCache carries a number of problems that you can read about here. <a href="http://www.alistapart.com/articles/application-cache-is-a-douchebag/">Application Cache is a Douchebag</a> .  If you are too lazy to compile a list of your resources or write some scripts, you can use the Confess <a href="http://tinyurl.com/confessjs">tinyurl.com/confessjs</a> tool that does all this for you and will profile your CSS selectors in addition. <br><br>  <b>2. Build scripts</b> <br>  This is the most cost-effective optimization, if you are not compressing the scripts yet - stop reading and finally write the make file :) <br><br>  <b>3. Start using LMD or AMD</b> <br>  Existing applications are quite difficult to translate to LMD or AMD, but if you start writing, then it is easy and profitable for both your users and developers.  In addition to lazy loading, you also get completely isolated modules, which is very beneficial in teamwork. <br><br><img src="https://habrastorage.org/storage2/252/1bf/b85/2521bfb85016ae3a914322e9a3084223.jpg"><br><br><h4>  Any links </h4><br>  The application we optimized <a href="http://azproduction.github.com/loader-test/">azproduction.github.com/loader-test</a> <br><br>  <i>Tulsa and scripts</i> <br>  LMD <a href="https://github.com/azproduction/lmd">github.com/azproduction/lmd</a> <br>  Confess <a href="http://tinyurl.com/confessjs">tinyurl.com/confessjs</a> <br>  Require.js <a href="http://requirejs.org/">requirejs.org</a> <br>  YUI compressor <a href="http://tinyurl.com/yui-compressor">tinyurl.com/yui-compressor</a> <br>  Can I Use <a href="http://caniuse.com/">caniuse.com</a> <br>  script-cover <a href="http://code.google.com/p/script-cover/">code.google.com/p/script-cover</a> <br>  UglifyJS <a href="https://github.com/mishoo/UglifyJS">github.com/mishoo/UglifyJS</a> <br>   half <a href="http://code.google.com/p/closure-compiler/">ompiler code.google.com/p/closure-compiler</a> <br><br>  <i>By appcache</i> <br>  Article on AppCache on MDN <a href="http://tinyurl.com/mdn-appcache">tinyurl.com/mdn-appcache</a> <br>  AppCache FAQ <a href="http://appcachefacts.info/">appcachefacts.info</a> <br>  AppCache for newbies <a href="http://www.html5rocks.com/en/tutorials/appcache/beginner/">www.html5rocks.com/en/tutorials/appcache/beginner</a> <br>  Article about AppCache issues <a href="http://www.alistapart.com/articles/application-cache-is-a-douchebag/">www.alistapart.com/articles/application-cache-is-a-douchebag</a> <br><br>  PS This is an updated version of my report at DUMP 2012 <br><br>  UPD Added AppCache problems, thanks <a href="https://habrahabr.ru/users/yeremeiev/" class="user_link">yeremeiev</a> and <a href="https://habrahabr.ru/users/vitazheltyakov/" class="user_link">VitaZheltyakov</a> for useful links and tips. </div><p>Source: <a href="https://habr.com/ru/post/145269/">https://habr.com/ru/post/145269/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145264/index.html">Steam for Linux. Soon</a></li>
<li><a href="../145265/index.html">Previewing ‚Äúrubber‚Äù layouts in Firefox Nightly</a></li>
<li><a href="../145266/index.html">Yaware service for accounting of working time has been updated and released a version for Linux</a></li>
<li><a href="../145267/index.html">Logrotate. Postrotate script and file name</a></li>
<li><a href="../145268/index.html">What type of programming language syntax is more convenient?</a></li>
<li><a href="../145274/index.html">Bring Your Own Device - First Results of Corporate Strategies</a></li>
<li><a href="../145276/index.html">Toshiba introduced the ultrabook with a screen 21: 9</a></li>
<li><a href="../145277/index.html">Top-10 quests "century". (poll + results)</a></li>
<li><a href="../145278/index.html">Model Institute, created in Minecraft, printed on a 3D-printer</a></li>
<li><a href="../145279/index.html">Computex 2012, or Ultrashow in Taiwan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>