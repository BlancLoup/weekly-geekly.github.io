<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Substitution (embedding) of spam links to the site pages with browser plugins, cpatext, Content-Security-Policy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the end of January in the logs of our internal system for analyzing user clicks on the site kidsreview.ru there were hundreds of clicks on strange ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Substitution (embedding) of spam links to the site pages with browser plugins, cpatext, Content-Security-Policy</h1><div class="post__text post__text-html js-mediator-article">  At the end of January in the logs of our internal system for analyzing user clicks on the site <a href="http://www.kidsreview.ru/msk/events">kidsreview.ru</a> there were hundreds of clicks on strange links like: <br><br>  <a href="http://compareiseries.in/goto.php%3Furl%3DaHR0cDovL24uYWN0aW9ucGF5LnJ1L2NsaWNrLzUyZDhmODY2ZmQzZjViMjYxYTAwNDFjNS82OTIzMy81MDI1OS9zdWJhY2NvdW50">compareiseries.in/goto.php?url=aHR0cDovL24uYWN0aW9ucGF5LnJ1L2NsaWNrLzUyZDhmODY2ZmQzZjViMjYxYTAwNDFjNS82OTIzMy81MDI1OS9DJJ</a> <br><a name="habracut"></a><br>  A short investigation revealed that the site compareiseries.in is an interlayer, the script issues a js-redirect to the link that was transmitted in the address.  In this case, base64 hid the real address: <br>  <a href="http://n.actionpay.ru/click/52d8f866fd3f5b261a0041c5/69233/50259/subaccount">n.actionpay.ru/click/52d8f866fd3f5b261a0041c5/69233/50259/subaccount</a> <br><br>  As it is not difficult to guess, the site turned out to be a pay-per-click traffic exchange (with the parameters of someone‚Äôs particular account in the URL).  That is, someone cheated clicks, earned money - and everything on our site and, the most offensive, without our permission. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Problem </h4><br>  Problem: when browsing a website in browsers of a large number of visitors, there are spam links to many disparate advertising resources. <br>  Question: at what level they appear? <br>  Variations that come to mind (in a subjectively estimated order of decreasing probability): <br><br>  1. Into the user's browser, as a result of a virus on a computer / a virus plug-in to the browser / other viruses in all their diversity, malicious javascript is injected into the visited sites; <br><br>  2. Our servers, as a result of hacking and subsequent embedding of a site code or a web server or a network card driver, themselves give spam scripts / links to visitors; <br><br>  3. Some of the js that we load from external resources, as a result of hacking, began simultaneously to distribute advertising spam content <br>  (rambler top100, vk / fb, twitter, google, yandex metrika, ... there are about a dozen of them); <br><br>  A careful search of any traces on our servers did not give anything, point 3 is the shoals as the most unlikely.  In parallel with this, we made changes to our system for analyzing transitions - so that the content of the pages on which clicks on the ‚Äúleft‚Äù URLs were made was logged. <br><br>  The very first working hours of our improvised ‚Äútrap‚Äù caught a few dozen pages, and with them, the injected js of the form: <br>  <a href="">api.cpatext.ru/js/cpatext.js?r5</a> <br>  <a href="">ayrqejixqe.ru/js/start_ad.js?u=7_05032014</a> <br>  <a href="http://yhcwxeqhzg.ru/%3Fd%3Dkidsreview.ru%26t%3DKidsReview.ru%2520%257C">yhcwxeqhzg.ru/?d=kidsreview.ru&amp;t=KidsReview.ru%20%7C</a> <br>  <a href="http://www.superfish.com/ws/sf_main.jsp%3Fdlsource%3Dpcom%26userId%3D4826451239324129823%26CTID%3Dp1272">www.superfish.com/ws/sf_main.jsp?dlsource=pcom&amp;userId=4826451239324129823&amp;CTID=p1272</a> <br><br>  Or, for example, like this: <br>  "Data: text / javascript; base64, KGZ1bmN0aW9uKHdpbmRvdykgew0KICAgIHZhciBkb21haW5fbGlzdCA9ICcsMS5hemFydG55ZS1pZ3J5LXBva2VyLnJ1LDEWPHPHP2GHZ2ZS1pZ3J5LXBva2VyLnJ1LBWHPHGTZHPGHZ2ZS1pZ3J5BXbcB2bFbGbzbc2121W5fbGlzdCA964 <br><br>  etc. <br><br>  Got it!  - we decided and opened cpatext.ru, and in fact, what we saw - "We automatically replace links, and you earn more!". <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ff1/88a/8d9/ff188a8d901e3431544dd3e8f12ead69.png" alt="image"><br><br>  The guys offer to replace the links in various ways, in particular through browser plugins.  We built a whole system for this and, naturally, they are far from the only ones. <br><br><h4>  What to do? </h4><br>  One of the most useful options for dealing with the consequences is the Content-Security-Policy header (http://en.wikipedia.org/wiki/Content_Security_Policy), which allows the site to declare restrictions on the operation of site pages with external content.  In particular, it allows transmitting instructions to modern browsers on the site from which external domains the site allows to load external JS. <br><br>  This method is especially good if all js are hosted within a single domain (for example, CDN), but in general, when there may be a bunch of third-party js on the site (for example, widgets like ours) there are several problems: <br><br>  1. You need to make a complete whitelist by analyzing all loadable external js <br><br>  2. It is necessary in the course of development to maintain whitelist up to date <br><br>  3. Changes in the intricacies of hosting legitimate external scripts: for example, changing the Facebook CDN domain or the appearance of a new third-party legitimate domain - leads to an error. <br><br>  4. Among other things, a lot of scripts are blocked from advertising toolbars and potentially legitimate browser extensions. <br><br>  Within the team, we agreed that extensions that climb into the content of the page and allow themselves to change the content ‚Äúgo to the forest‚Äù, but is this true in 100% of cases? <br><br>  After enabling the blocking using Content-Security-Policy, the ‚Äúleft‚Äù clicks are orders of magnitude smaller (only clicks from ancient versions of browsers that do not support CSP remain), but a few questions remain: <br><br>  1. Are there any progress on the part of browser developers in terms of restrictions <br>  extensions on js injections in site pages? <br><br>  2. What are the best practices when dealing with similar issues with infected users on large sites? <br>  No decent information was found. <br><br>  3. And most importantly, why do sites in the spirit live quietly: <a href="http://metabar.ru/">metabar.ru</a> , <a href="https://cpatext.ru/">cpatext.ru</a> ? </div><p>Source: <a href="https://habr.com/ru/post/224797/">https://habr.com/ru/post/224797/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../224785/index.html">Lessons from space accidents: the hard road to soft landing of the E-6 program</a></li>
<li><a href="../224789/index.html">Ballad of Selling Letters</a></li>
<li><a href="../224791/index.html">Version 1.0 of the Socket.IO library released</a></li>
<li><a href="../224793/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ111 (May 25 - 31, 2014)</a></li>
<li><a href="../224795/index.html">Making a visual web-editor of documents based on LibreOffice, jodconverter and TinyMCE</a></li>
<li><a href="../224799/index.html">RegEx Crossword</a></li>
<li><a href="../224803/index.html">Security analysis of network Unity3D games on VKontakte</a></li>
<li><a href="../224805/index.html">Git: Beyond the Possible</a></li>
<li><a href="../224807/index.html">Co-founder of The Pirate Bay Peter Sunde was arrested in Sweden</a></li>
<li><a href="../224813/index.html">The right to be forgotten by Google</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>