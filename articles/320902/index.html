<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we prepared the redis cluster</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the world of open source there are a huge number of technologies, approaches, patterns, tools and tools that are used by so many companies. How to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we prepared the redis cluster</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/183/f4a/05f/183f4a05f2964aadb4333ea9141312d6.jpg"><br><br>  In the world of open source there are a huge number of technologies, approaches, patterns, tools and tools that are used by so many companies.  How to turn used software or technology into a competitive advantage?  I propose to consider the example of Redis Cluster - how we paved our way. <br><a name="habracut"></a><br><h2>  Start </h2><br>  It is worth starting with the fact that Redis is, in fact, a <b>very handy thing</b> .  In a nutshell, Redis is a persistent key-value storage in memory, with its blackjack and courtesans.  Most often it is compared with the outdated Memcached, which can do almost nothing of what Redis can do. <br><br>  Redis benefits: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  very very fast data access speed.  This is a memo. </li><li>  mixed data types, hashes.  One key (event), we can put a lot of information (user ID, type of event, time, token, session).  These can be bytes, kilobytes, megabytes of data. </li><li>  generic TTL.  We do not need to delete what we put in Redis.  The internal mechanism itself will remove the key, the TTL of which has come.  It is incredibly convenient. </li><li>  unary operations, increments, decrements - all this works out not instantly, but simply incredibly instantly.  Accordingly, in Redis it is convenient and easy to implement complex progress bars, events, put custom data that changes from different places of the system. </li><li>  persistence and bin-log.  It is possible to periodically flush all the data on the disk, ensuring high availability of data, and almost eliminating their loss. </li></ul><br>  It turns out that Redis is such a ‚Äúsilver bullet‚Äù, absolutely for all cases, approaches and practices?  Well, it is.  More likely no than yes. <br><br>  For example, problems that very much interfere with living: <br><br><ul><li>  <u>stendelon</u> .  In fact, at the moment, the default installation of Redis is a stendelon.  This means that if we have a Single point of Failure, then we have an incredibly bad architecture, because  in case of Redis crash, the whole system will stop working. </li><li>  <u>flush to disk</u> .  This is a very expensive operation, with a high load on the IO, on the memory card.  And it‚Äôs okay even on hardware - but our service is incredibly dull, because Redis has to fix everything he has there, and make a big Flush from fast memory to a slow disk.  At this point, the latency on all services increases to seconds. </li></ul><br>  The conclusion is obvious - Redis speeds up the product, speeds up development, and it definitely needs to be used, but ... <b>there are problems</b> . <br><br><h2>  Redis cluster </h2><br>  There is also a Redis Cluster!  You say, but I would ask not to hurry.  In fact, Redis has 2 types of clustering: <br><br><ol><li>  <u>Redis Sentinel</u> - for older versions </li><li>  <u>Redis Cluster</u> - for new versions </li></ol><br>  Redis Sentinel is a <b>very primitive thing</b> that builds a tree structure of your radish stitches, and calls it a cluster.  No sharding, balancing, nothing.  And even more so, it works for older versions of Redis, if I'm not mistaken, below 3.0. <br><br>  Redis Cluster is more fun, there is already sharding, replication, fault tolerance, master slaves, various cool stuff and all that.  This is definitely similar to a normal cluster, but still it‚Äôs not what it is - it will not work. <br><br><img src="https://habrastorage.org/files/e31/717/275/e317172753cf49289373b593d6925977.png"><br><h2>  Why it doesn't work </h2><br>  In order to understand why this does not work, you need to understand how it works inside. <br><br>  First of all, the very process of creating Redis Cluster from stritelon nodes is wildness and humiliation, as it is now.  In our 2017, everybody got used to discovery, provisioning and reporting like ‚ÄúI did everything, there is already a cluster, everything is OK!‚Äù - but the reality is that Redis has a script written in rubies that does what it takes as arguments radish instances, and then joins them into a cluster.  Do you trust such things?  I think yes, they trusted, about 100,500 years ago. <br><br>  Okay, we have a cluster.  Now a bit of theory: there are such things as <b>hash slots</b> inside the cluster.  In essence, a slot is a number that implies a set of data for which a particular cluster node is responsible.  In total there are 16384 slots, which are evenly divided between all the masters. <br><br>  By the way, about the masters.  By default, Redis Cluster can consist of <b>at least three nodes</b> , and all these will be wizards.  Accordingly, they will divide the slots among themselves. <br><br>  The second nuance of using a cluster is incredible fragility.  For example, one node fell off from a cluster with 3 nodes.  The logical solution would be to continue working - we also have 66.6% of the data, but this is not at all encouraging.  In the default configuration, the response will be 'CLUSTER IS DOWN' at the request of any, even a live key. <br><br>  If we consider a larger cluster, for example, from 6 nodes (3 masters and 3 slaves) - the situation repeats.  While there is an automatic promotion of the slave to the master after the fall, the answer is similar - 'CLUSTER IS DOWN'.  And this is seconds, although this delay depends on the amount of data in the cluster. <br><br>  The third problem is customers.  More precisely, the connectors are in aplications.  If we take the previous case, when we are promoting the cluster, all clients will fall off with socket error, or connection timeout, or something similar, because they keep connection to all masters in the cluster.  This also needs to be completed. <br><br>  The fourth, and one of the most unpleasant, nuance is a change in the set of commands.  Standard teams that work on wildcards do not work, and this is not surprising.  It needs to be redone throughout the project, to teach the appli- cation how to work with standtelon and with the cluster.  In fact, this is the longest and most expensive part of the implementation of the Redis Cluster. <br><br><h2>  How to make it work </h2><br>  We are unable to fix the first nuance with provisioning, except to do LWRP for Chef, and it is somehow more normal to do it.  In fact, something like this we did. <br><br>  But the second and third - this is our competence! <br><br>  Fixing 'CLUSTER IS DOWN' in the absence of some slots is very easy and simple - just add the configuration parameter: <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">cluster</span></span>-require-<span class="hljs-keyword"><span class="hljs-keyword">full</span></span>-coverage <span class="hljs-keyword"><span class="hljs-keyword">no</span></span></code> </pre> <br>  The problem with customers who fall off can be solved by spending a little time.  Our project uses 2 languages ‚Äã‚Äã- PHP and Java, so we had to do the same work two times.  The general algorithm is as follows: <br><br><ol><li>  We receive on the client of 'CLUSTER IS DOWN' - during reassembly of a cluster </li><li>  Ketchim this error, save the existing non-working slotmap. </li><li>  Retraim connection, a certain number of times, and we are waiting for a new slotmap. </li><li>  When the slotmap has changed - we read our value and rejoice. </li></ol><br>  Changing the slotmaps will mean that the cluster has moved to a working state, and our data will already be praised by a slave, and it is ready to work with them. <br><br>  It will be no secret for anyone if I say that in a cluster with 6+ nodes, there is no point in flashing the data to disk.  Accordingly, if you disable the persistence - everything will work very, very quickly. <br><br><h2>  Result </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3b5/468/e21/3b5468e210854a7e84d1cb6eb57f0930.jpg"></div><br>  What was the result? <br><br><ul><li>  We have achieved excellent TTFB performance (as we are no longer afraid to store sessions in Redis). </li><li>  We succeeded, probably the best progress loader in the world - there is the most up-to-date information (there is nowhere more relevant!) </li><li>  We are not afraid for the data that we put in the Redis Cluster and sleep well. </li><li>  SLA and User Experience are much improved due to the rapid responsiveness of many parts of the application. </li></ul><br>  Here we have such an interesting way. <br><br>  How do you use publicly available tools? <br><br><blockquote>  PS If the information was useful to you, and you want to develop in this direction - subscribe to my personal telegram channel: <a href="https://t.me/devopsengineer">https://goo.gl/1MnG9v</a> <br>  You can always unsubscribe.  What if you like it? </blockquote></div><p>Source: <a href="https://habr.com/ru/post/320902/">https://habr.com/ru/post/320902/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320890/index.html">NooLite: kill two birds of ergonomics at the same time (installation, opinion, development)</a></li>
<li><a href="../320892/index.html">Testing untestable JS with Babel and snarejs</a></li>
<li><a href="../320894/index.html">Experience using Samsung Pay</a></li>
<li><a href="../320898/index.html">Immersion in Robolectric</a></li>
<li><a href="../320900/index.html">Configuring the DNS server for North Korean security standards</a></li>
<li><a href="../320904/index.html">Petersburg IT exports underestimated by a large amount</a></li>
<li><a href="../320906/index.html">Yii 2.0.11</a></li>
<li><a href="../320908/index.html">Trends 2016 and 2017 in the Japanese mobile industry</a></li>
<li><a href="../320916/index.html">How to write curve queries with a non-optimal plan and make the DBMS think</a></li>
<li><a href="../320918/index.html">Configure Let's Encrypt on Microsoft Azure</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>