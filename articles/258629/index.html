<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Refactoring database schemas</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to talk about refactoring database schemas MS SQL Server. 

 Refactoring is a change in the internal structure of the software, aimed at facili...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Refactoring database schemas</h1><div class="post__text post__text-html js-mediator-article">  I want to talk about refactoring database schemas MS SQL Server. <br><br><blockquote>  Refactoring is a change in the internal structure of the software, aimed at facilitating the understanding of its work and simplifying the modification without affecting the observed behavior. </blockquote>  <i>- Martin Fowler</i> <br><br>  About refactoring of a code speak for a long time.  At the moment, a lot of literature has been written, a lot of tools have been created that help to perform code refactoring. <br>  But about the refactoring of database schemas is not so much information.  I decided to fill this gap a bit and share my experience. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  How to understand that it is time to refactor? </h2><br><blockquote>  By doing something for the first time, you just do it.  Doing something similar the second time, you frown at the need to repeat, but still repeat the same thing.  By doing something similar for the third time, you start refactoring. <br></blockquote>  <i>- Don Roberts</i> <br><br>  <a href="https://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B0%25D1%2583%25D0%25BB%25D0%25B5%25D1%2580,_%25D0%259C%25D0%25B0%25D1%2580%25D1%2582%25D0%25B8%25D0%25BD">Martin Fowler</a> introduced the concept of ‚ÄúCode with a ghost‚Äù, denoting the code that needs to be refactored. <br>  With a nice smell is the code in which: <br><ul><li>  duplication occurs </li><li>  there are big methods </li><li>  there are methods with a large number of parameters </li><li>  there is a <i>switch statement</i> </li></ul><br>  By analogy with this, one can single out the general shortcomings of the database schema, which indicate the need for the application of refactoring.  These disadvantages include the following. <br><ul><li>  <i>Multipurpose columns (or useless columns).</i>  Suppose we have a table containing information on orders.  There is an optional <i>InvoiceId</i> field of type <i>int</i> in the table.  Imagine that the sales process in a company is built in such a way that this field is never filled.  Starting from the new year, managers have become necessary to put a customer assessment on orders (from 1 to 10 on the results of telephone calls).  There is no such field in the table and the managers start typing this data into the InvoiceId field (for example, because the IT people told them that it would take a month to add a new field).  This will cause problems when the InvoiceId field is used for its intended purpose. <br></li><li>  <i>Multipurpose tables.</i>  An example would be the Customer table in which information about individuals and legal entities is stored.  In such a case, columns with <i>NULL</i> values ‚Äã‚Äãinevitably appear. </li><li>  <i>Redundant data.</i>  For example, the presence of the <i>Customer Address</i> field in the order table may lead to the case when several orders of the same customer have different addresses. </li><li>  <i>Tables with a large number of columns.</i>  The presence of a large number of columns can mean that the table stores the attributes of more than one entity.  In this case, you probably need to apply the "Split the table" refactoring. </li><li>  <i>Multivalued columns.</i>  Multi-valued columns are those in which several different pieces of information are represented in different positions.  For example, in the order table there is an <i>OrderNumber</i> field containing data of the form XXX20150908000125.  Where XXX is the product code, 20150908 is the order date, 000125 is the order number.  In practice, it is often found necessary to break the field into parts so that it is easier to process these fields as separate elements. </li></ul><br><br><h2>  Some useful tips for applying refactoring </h2><br><ol><li>  <b>Rate the scale of the disaster</b> . <br>  Before changing anything, make sure that you do not break external applications that use your database.  If you had to maintain a database that was inherited, most likely you do not know who (what) and how it is used.  Make a list of applications that use your database.  If possible, ask colleagues developing these applications to give you a list of the objects they use.  After that, agree with them your changes, agree on joint testing. <br>  Pay special attention to the database tables for which rights are issued.  This is a potential source of problems. <br>  Discuss with colleagues so that instead of spreadsheets they switch to using views (procedures). <br>  When all references to the database will be implemented by means of procedures / views / functions, it will be much easier for you to refactor. <br></li><li>  <b>Do not make many changes at once</b> . <br>  The smaller the change, the easier it will be to find an error in the event of a failure. </li><li>  <b>Check changes with tests</b> . <br>  After each change, run tests to make sure nothing is broken. </li><li>  <b>Use sandboxes</b> . <br>  There is no need to refactor production, even if the change is negligible.  Use for refactoring test sites.  Then do a full regression test.  And only after that, make the change in the productive database. </li></ol><br><br><h2>  Practical examples </h2><br>  I will show the application of some methods of refactoring using the example of the Northwind database ( <a href="https://northwinddatabase.codeplex.com/downloads/get/269239">download link</a> ). <br>  As a tool, I will use SQL Server Management Studio (SSMS) with the <a href="http://sqlrefactorstudio.com/">SQL Refactor Studio</a> plugin installed.  This plugin adds refactoring functions to SSMS. <br><br><h3>  Source diagram </h3><br><img src="https://habrastorage.org/files/eb2/42c/878/eb242c8788e240a8a51dfe3d8bc78626.png"><br><br><h3>  Testing </h3><br>  After each change, we will run a test to make sure everything is still working. <br>  For example, I created the <i>dbo.RunTests</i> procedure, which selects data from all representations in the database (of course, this does not provide us with full test coverage). <br>  If there were no errors during the procedure, the procedure returns OK, otherwise Failed. <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> dbo.RunTests <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @Script <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) = <span class="hljs-string"><span class="hljs-string">''</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Failed</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bit</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> crs <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'IF OBJECT_ID(''tempdb..#tmp'') IS NOT NULL DROP TABLE #tmp SELECT * INTO #tmp FROM ['</span></span> + object_schema_name(o.object_id) + <span class="hljs-string"><span class="hljs-string">'].['</span></span> + o.name + <span class="hljs-string"><span class="hljs-string">']'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.objects o <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> o.type = <span class="hljs-string"><span class="hljs-string">'V'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPEN</span></span> crs <span class="hljs-keyword"><span class="hljs-keyword">FETCH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> crs <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @Script <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> @@fetch_status = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY EXEC sp_executesql @Script <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">Failed</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'Failed'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Status</span></span>, ERROR_MESSAGE() <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> Details, @Script <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Script] <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">FETCH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> crs <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @Script <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLOSE</span></span> crs <span class="hljs-keyword"><span class="hljs-keyword">DEALLOCATE</span></span> crs <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">Failed</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">'OK'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Status</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">/* EXEC dbo.RunTests */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br><br><h3>  Refactoring "Rename Object" </h3><br>  Of course, I don‚Äôt know about you, but when I create the table I give it a singular name (dbo.Entry and not dbo.Entrie <u>s</u> ). <br>  So let's try to rename the <i>dbo.Customer <u>s</u></i> table to <i>dbo.Customer</i> .  There is one unpleasant (and very routine) process.  It is necessary to rename the table so that the code using it does not break.  To do this, you need to find and make a correction to it.  Taking advantage of the standard <i>View Dependencies,</i> we see that the table is used in one view and there are two tables referencing <i>dbo.Customers</i> . <br><img src="https://habrastorage.org/files/de1/7da/910/de17da9100f9485680639fc70ef4c810.png"><br>  In principle, making a correction to one view after renaming a table is a trifling matter. <br>  Well, in battle!  Rename the table and run the test (the <i>dbo.Customer and Suppliers by City view</i> should break). <br>  However, instead of the expected one line test gave me as many as five. <br><br><img src="https://habrastorage.org/files/d2e/6d7/231/d2e6d7231889466199f91d942a55d22e.PNG"><br><br>  Then I decided to check the dependencies of the table using the advanced <i><a href="http://sqlrefactorstudio.com/Features/Details/ViewDependencies">View Dependencies</a></i> included in the package of SQL Refactor Studio.  He already counted five views (the test showed that it was five representations that broke) and found one procedure (not covered by tests). <br><img src="https://habrastorage.org/files/3f6/748/02d/3f674802d22d40d1b391348e04a6c314.png"><br>  Six objects - this is more serious.  And imagine that you need to fix the code in 50+ objects.  Do you still want to rename the table?  :) Handles will be hard, so let's use automation. <br>  We use the <i>Rename</i> function included in the SQL package Refactor Studio.  We select a table in the Object Explorer (hereinafter OE), from the context menu, select the <i>SQL Refactor Studio -&gt; Rename</i> item.  Enter a new name (Customer) and press the button <i>Genarate rename script</i> .  There is also an opportunity to see the dependencies and uncheck the objects in which you do not need to rename. <br><img src="https://habrastorage.org/files/1de/467/205/1de467205e794b70872fa2d9dc56b672.png"><br>  As a result, a new tab has opened with the generated script. <br><div class="spoiler">  <b class="spoiler_title">Generated script</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> northwind <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span> <span class="hljs-keyword"><span class="hljs-keyword">isolation</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> <span class="hljs-keyword"><span class="hljs-keyword">serializable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> xact_abort <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> object_id(<span class="hljs-string"><span class="hljs-string">'tempdb..#err'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-comment"><span class="hljs-comment">#err go create table #err(flag bit) go begin transaction go exec sp_rename 'dbo.Customers', 'Customer', 'OBJECT' go if (@@error &lt;&gt; 0) and (@@trancount &gt; 0) rollback transaction go if (@@trancount = 0) begin insert into #err(flag) select cast(1 as bit) begin transaction end go ALTER view dbo.[Orders Qry] AS SELECT Orders.OrderID, Orders.CustomerID, Orders.EmployeeID, Orders.OrderDate, Orders.RequiredDate, Orders.ShippedDate, Orders.ShipVia, Orders.Freight, Orders.ShipName, Orders.ShipAddress, Orders.ShipCity, Orders.ShipRegion, Orders.ShipPostalCode, Orders.ShipCountry, Customer.CompanyName, Customer.Address, Customer.City, Customer.Region, Customer.PostalCode, Customer.Country FROM Customer INNER JOIN Orders ON Customer.CustomerID = Orders.CustomerID go raiserror('update view &lt;dbo.Orders Qry&gt;...', 0, 1) with nowait go if (@@error &lt;&gt; 0) and (@@trancount &gt; 0) rollback transaction go if (@@trancount = 0) begin insert into #err(flag) select cast(1 as bit) begin transaction end go ALTER view dbo.[Quarterly Orders] AS SELECT DISTINCT Customer.CustomerID, Customer.CompanyName, Customer.City, Customer.Country FROM Customer RIGHT JOIN Orders ON Customer.CustomerID = Orders.CustomerID WHERE Orders.OrderDate BETWEEN '19970101' And '19971231' go raiserror('update view &lt;dbo.Quarterly Orders&gt;...', 0, 1) with nowait go if (@@error &lt;&gt; 0) and (@@trancount &gt; 0) rollback transaction go if (@@trancount = 0) begin insert into #err(flag) select cast(1 as bit) begin transaction end go ALTER view dbo.Invoices AS SELECT Orders.ShipName, Orders.ShipAddress, Orders.ShipCity, Orders.ShipRegion, Orders.ShipPostalCode, Orders.ShipCountry, Orders.CustomerID, Customer.CompanyName AS CustomerName, Customer.Address, Customer.City, Customer.Region, Customer.PostalCode, Customer.Country, (FirstName + ' ' + LastName) AS Salesperson, Orders.OrderID, Orders.OrderDate, Orders.RequiredDate, Orders.ShippedDate, Shippers.CompanyName As ShipperName, "Order Details".ProductID, Products.ProductName, "Order Details".UnitPrice, "Order Details".Quantity, "Order Details".Discount, (CONVERT(money,("Order Details".UnitPrice*Quantity*(1-Discount)/100))*100) AS ExtendedPrice, Orders.Freight FROM Shippers INNER JOIN (Products INNER JOIN ( (Employees INNER JOIN (Customer INNER JOIN Orders ON Customer.CustomerID = Orders.CustomerID) ON Employees.EmployeeID = Orders.EmployeeID) INNER JOIN "Order Details" ON Orders.OrderID = "Order Details".OrderID) ON Products.ProductID = "Order Details".ProductID) ON Shippers.ShipperID = Orders.ShipVia go raiserror('update view &lt;dbo.Invoices&gt;...', 0, 1) with nowait go if (@@error &lt;&gt; 0) and (@@trancount &gt; 0) rollback transaction go if (@@trancount = 0) begin insert into #err(flag) select cast(1 as bit) begin transaction end go ALTER PROCEDURE dbo.CustOrderHist @CustomerID nchar(5) AS SELECT ProductName, Total=SUM(Quantity) FROM Products P, [Order Details] OD, Orders O, Customer C WHERE C.CustomerID = @CustomerID AND C.CustomerID = O.CustomerID AND O.OrderID = OD.OrderID AND OD.ProductID = P.ProductID GROUP BY ProductName go raiserror('update storedprocedure &lt;dbo.CustOrderHist&gt;...', 0, 1) with nowait go if (@@error &lt;&gt; 0) and (@@trancount &gt; 0) rollback transaction go if (@@trancount = 0) begin insert into #err(flag) select cast(1 as bit) begin transaction end go ALTER view dbo.[Customer and Suppliers by City] AS SELECT City, CompanyName, ContactName, 'Customers' AS Relationship FROM Customer UNION SELECT City, CompanyName, ContactName, 'Suppliers' FROM Suppliers --ORDER BY City, CompanyName go raiserror('update view &lt;dbo.Customer and Suppliers by City&gt;...', 0, 1) with nowait go if (@@error &lt;&gt; 0) and (@@trancount &gt; 0) rollback transaction go if (@@trancount = 0) begin insert into #err(flag) select cast(1 as bit) begin transaction end go ALTER view dbo.[Sales Totals by Amount] AS SELECT "Order Subtotals".Subtotal AS SaleAmount, Orders.OrderID, Customer.CompanyName, Orders.ShippedDate FROM Customer INNER JOIN (Orders INNER JOIN "Order Subtotals" ON Orders.OrderID = "Order Subtotals".OrderID) ON Customer.CustomerID = Orders.CustomerID WHERE ("Order Subtotals".Subtotal &gt;2500) AND (Orders.ShippedDate BETWEEN '19970101' And '19971231') go raiserror('update view &lt;dbo.Sales Totals by Amount&gt;...', 0, 1) with nowait go if (@@error &lt;&gt; 0) and (@@trancount &gt; 0) rollback transaction go if (@@trancount = 0) begin insert into #err(flag) select cast(1 as bit) begin transaction end go if exists (select * from #err) begin print 'the database &lt;northwind&gt; update failed' rollback transaction end else begin print 'the database &lt;northwind&gt; update succeeded' commit transaction end go</span></span></code> </pre><br></div></div><br>  Run the script for execution. <br>  Run the test. <br>  Voila!  We renamed the table and did not break the existing code. <br>  We will also deal with all tables whose names end with <i>s</i> .  It's so easy, isn't it? <br><br><h3>  Refactoring "Adding a lookup table" </h3><br>  This operation allows you to create a lookup table for an existing column. <br>  The need for this operation may be due to the following reasons: <br><ul><li>  Introduction of referential integrity to ensure data quality; </li><li>  Provide detailed descriptions.  For example, you may need to add a new attribute to the description of an entity.  If an entity is not allocated to this table in this case, it will be necessary to add this attribute to the necessary tables, which will lead to the denormalization of the schema. </li></ul><br><br>  Let's look again at our <i>dbo.Customer</i> table.  You are not confused by the presence of the fields City, Region and Country in one place?  These are attributes of one entity. <br><img src="https://habrastorage.org/files/d99/61e/0f6/d9961e0f679a4b25a7d92e95691bfcfe.PNG"><br><br>  In the <i>dbo.Employees</i> table the same trouble.  Seemingly clear violation of the 3rd normal form. <br><br>  Let's start rectifying the case as follows: <br>  1. Create a directory dbo.City (CityId, CityName) <br>  2. In the <i>dbo.Customer</i> table <i>,</i> add the CityId field. <br>  3. Create a foreign key. <br><br>  Again, to save time, use the <a href="http://sqlrefactorstudio.com/Features/Details/AddLookupTable">Add Lookup Table</a> function.  In OE, select the <i>City</i> field of the <i>dbo.Customer</i> table and in the context menu call the <i>SQL Refactor Studio -&gt; Add Lookup Table option</i> . <br><img src="https://habrastorage.org/files/c4e/52e/1ae/c4e52e1aeefe4dfa9174e187075bed3f.png"><br>  In the window that appears fill in the field.  Click <i>Next</i> , then <i>Finish</i> and a script is formed in a new window. <br>  The script creates the dbo.City table, fills it with data, creates the <i>CityId</i> field in the <i>dbo.Customer</i> table, creates a foreign key. <br><div class="spoiler">  <b class="spoiler_title">Generated script</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> northwind <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-comment"><span class="hljs-comment">-- Step 1. Create lookup table. CREATE TABLE dbo.City ( CityId INT NOT NULL identity(1, 1) ,CityName NVARCHAR(15) NULL ,CONSTRAINT PK_City PRIMARY KEY CLUSTERED (CityId) ,CONSTRAINT City_ixCityName UNIQUE (CityName) ) GO -- Step 2. Fill lookup table. INSERT dbo.City (CityName) SELECT DISTINCT City FROM dbo.Customer GO -- Step 3. Add column. ALTER TABLE dbo.Customer ADD CityId INT NULL GO -- Step 4. Update table dbo.Customer. UPDATE s SET s.CityId = t.CityId FROM dbo.Customer s INNER JOIN dbo.City t ON s.City = t.CityName GO -- Step 5. Create foreign key constraint. ALTER TABLE dbo.Customer ADD CONSTRAINT FK_Customer_City FOREIGN KEY (CityId) REFERENCES dbo.City (CityId) GO</span></span></code> </pre><br></div></div><br>  We run the script and tests (although we didn‚Äôt seem to break anything here). <br>  All is ready.  We go further. <br><br><br><h3>  Refactoring "Moving Fields" </h3><br>  So, we dealt with the <i>City</i> field.  It remains to deal with the fields Region and Country.  These fields are attributes of the <i>City</i> entity.  So let's move them from the <i>dbo.Customer</i> table to <i>dbo.City</i> . <br>  Again, SQL Refactor Studio provides the <a href="http://sqlrefactorstudio.com/Features/Details/MoveColumns">Move Columns</a> function.  We will use it! <br>  We select <i>dbo.Customer</i> table in OE, in the context menu, select the item <i>‚ÄúSQL Refactor Studio -&gt; Move columns‚Äù</i> .  In the dialog that appears, in the drop-down list, select the <i>dbo.City</i> table.  We transfer the <i>Region</i> and <i>Country</i> fields to <i>dbo.City</i> . <br>  If you move a field, you will receive a message stating that the field on which the index is built cannot be moved - temporarily remove this index. <br><img src="https://habrastorage.org/files/f83/75d/6c8/f8375d6c889b46d7b7c3bd76712c45fa.png"><br><br>  Click <i>Next</i> , then <i>Finish</i> .  Get the script in a new window. <br>  The script creates the <i>Region</i> and <i>Country</i> fields in the <i>dbo.City</i> table and fills them with data. <br>  The script also has a commented code that removes fields and lists the objects in which you need to make changes. <br>  Let's not delete the fields now, let's do it in the next step. <br><div class="spoiler">  <b class="spoiler_title">Generated script</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> northwind <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-comment"><span class="hljs-comment">-- STEP 1. Add new column(s) -- IF NOT EXISTS ( SELECT * FROM syscolumns s WHERE s.NAME = 'Region' AND s.id = object_id(N'dbo.City') ) BEGIN ALTER TABLE dbo.City ADD Region NVARCHAR(15) NULL END GO IF NOT EXISTS ( SELECT * FROM syscolumns s WHERE s.NAME = 'Country' AND s.id = object_id(N'dbo.City') ) BEGIN ALTER TABLE dbo.City ADD Country NVARCHAR(15) NULL END GO GO -- STEP 2. Copy data -- -- (You can modify this query if needed) SET IDENTITY_INSERT dbo.City ON INSERT INTO dbo.City WITH (TABLOCKX) (CityId) SELECT CityId FROM dbo.Customer src WHERE NOT EXISTS ( SELECT * FROM dbo.City dest WHERE src.CityId = dest.CityId ) SET IDENTITY_INSERT dbo.City OFF UPDATE dest WITH (TABLOCKX) SET dest.Region = src.Region ,dest.Country = src.Country FROM dbo.City dest INNER JOIN dbo.Customer src ON (src.CityId = dest.CityId) GO -- STEP 3. Check and modify this dependent objects -- /* northwind.dbo.[Orders Qry] /*View*/ northwind.dbo.[Quarterly Orders] /*View*/ northwind.dbo.Invoices /*View*/ northwind.dbo.CustOrderHist /*StoredProcedure*/ northwind.dbo.[Customer and Suppliers by City] /*View*/ northwind.dbo.[Sales Totals by Amount] /*View*/ */ -- STEP 4. Drop column(s) -- -- (Uncomment or run separately this query) /* alter table dbo.Customer drop column Region alter table dbo.Customer drop column Country */ GO</span></span></code> </pre><br></div></div><br>  We execute a script and tests. <br>  Go to the next step. <br><br><br><h3>  Refactoring "Delete Object" </h3><br>  Performing the previous refactorings, we left some garbage (the <i>City, Region, Country</i> fields in the <i>dbo.Customer</i> table). <br>  Let's make a clean!  But if we just remove the fields, everything will break again. <br>  You can use the <a href="http://databaserefactoring.com/EncapsulateTableWithView.html">Encapsulate Table With View</a> refactoring. <br>  Create a <i>dbo.CustomerV view</i> and replace the use of the table with its representation in the entire database. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> dbo.CustomerV <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> c.CustomerID, c.CompanyName, c.ContactName, c.ContactTitle, c.Address, ct.CityName City, ct.Region, c.PostalCode, ct.Country, c.Phone, c.Fax, c.CityId <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.Customer <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> dbo.City <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ct <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> c.CityId = ct.CityId</code> </pre><br><br>  Next, using View Dependencies, we look at the dependencies for the <i>dbo.Customer</i> table: <br><img src="https://habrastorage.org/files/1c2/ce8/d78/1c2ce8d7880e4d28b78a14b459d86ff5.png"><br><br>  View each object.  If in any object our fields are used, we script the object (the <i>Script object</i> button on the toolbar) and make changes. <br>  As a result, I got this script: <br><br><div class="spoiler">  <b class="spoiler_title">Encapsulate Table With View</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> dbo.[Sales Totals <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> Amount] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> st.Subtotal <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SaleAmount, o.OrderID, c.CompanyName, o.ShippedDate <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.CustomerV c <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( dbo.Orders o <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">"Order Subtotals"</span></span> st <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> o.OrderID = st.OrderID ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> c.CustomerID = o.CustomerID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (st.Subtotal &gt;<span class="hljs-number"><span class="hljs-number">2500</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (o.ShippedDate <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> <span class="hljs-string"><span class="hljs-string">'19970101'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">And</span></span> <span class="hljs-string"><span class="hljs-string">'19971231'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> dbo.[Quarterly Orders] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> c.CustomerID, c.CompanyName, c.City, c.Country <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.CustomerV c <span class="hljs-keyword"><span class="hljs-keyword">RIGHT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> dbo.Orders o <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> c.CustomerID = o.CustomerID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> o.OrderDate <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> <span class="hljs-string"><span class="hljs-string">'19970101'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">And</span></span> <span class="hljs-string"><span class="hljs-string">'19971231'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> dbo.[Orders Qry] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> o.OrderID, o.CustomerID, o.EmployeeID, o.OrderDate, o.RequiredDate, o.ShippedDate, o.ShipVia, o.Freight, o.ShipName, o.ShipAddress, o.ShipCity, o.ShipRegion, o.ShipPostalCode, o.ShipCountry, c.CompanyName, c.Address, c.City, c.Region, c.PostalCode, c.Country <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.CustomerV c <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> dbo.Orders o <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> c.CustomerID = o.CustomerID <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> dbo.Invoices <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> Orders.ShipName, Orders.ShipAddress, Orders.ShipCity, Orders.ShipRegion, Orders.ShipPostalCode, Orders.ShipCountry, Orders.CustomerID, Customer.CompanyName <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> CustomerName, Customer.Address, Customer.City, Customer.Region, Customer.PostalCode, Customer.Country, (FirstName + <span class="hljs-string"><span class="hljs-string">' '</span></span> + LastName) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> Salesperson, Orders.OrderID, Orders.OrderDate, Orders.RequiredDate, Orders.ShippedDate, Shippers.CompanyName <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> ShipperName, <span class="hljs-string"><span class="hljs-string">"Order Details"</span></span>.ProductID, Products.ProductName, <span class="hljs-string"><span class="hljs-string">"Order Details"</span></span>.UnitPrice, <span class="hljs-string"><span class="hljs-string">"Order Details"</span></span>.Quantity, <span class="hljs-string"><span class="hljs-string">"Order Details"</span></span>.Discount, (<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(money,(<span class="hljs-string"><span class="hljs-string">"Order Details"</span></span>.UnitPrice * Quantity*(<span class="hljs-number"><span class="hljs-number">1</span></span>-Discount)/<span class="hljs-number"><span class="hljs-number">100</span></span>))*<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ExtendedPrice, Orders.Freight <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Shippers <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> (Products <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( (Employees <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> (dbo.CustomerV Customer <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> Orders <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> Customer.CustomerID = Orders.CustomerID) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> Employees.EmployeeID = Orders.EmployeeID) <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">"Order Details"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> Orders.OrderID = <span class="hljs-string"><span class="hljs-string">"Order Details"</span></span>.OrderID) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> Products.ProductID = <span class="hljs-string"><span class="hljs-string">"Order Details"</span></span>.ProductID) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> Shippers.ShipperID = Orders.ShipVia <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> dbo.[Customer <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> Suppliers <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> City] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> City, CompanyName, ContactName, <span class="hljs-string"><span class="hljs-string">'Customers'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> Relationship <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.CustomerV <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> City, CompanyName, ContactName, <span class="hljs-string"><span class="hljs-string">'Suppliers'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Suppliers <span class="hljs-comment"><span class="hljs-comment">--ORDER BY City, CompanyName GO</span></span></code> </pre><br></div></div><br>  Run the script, then delete the fields and run the tests. <br>  If everything is OK - you are well done, all neatly done. <br><br><br><h3>  Refactoring ‚ÄúAdding CRUD Methods‚Äù </h3><br>  This refactoring involves the creation of stored procedures that provide access (SELECT, INSERT, UPDATE, DELETE) to database tables. <br>  There are several reasons for using this refactoring: <br><ul><li>  Hide from external applications database structure.  External applications will access the database only through stored procedures.  This allows you to easily change the database structure without changing external applications. <br></li><li>  Implementation in the procedures of additional checks (business logic, access rights, etc.); </li><li>  Saving information about who requested the data and when; </li><li>  Performance issues are more efficiently addressed when SQL is in the database. </li></ul><br><br>  So, let's create access methods for our <i>dbo.Customer</i> table.  Let's use the <a href="http://sqlrefactorstudio.com/Features/Details/CRUD">Add CRUD Methods</a> method from the SQL Refactor Studio package.  We select a table in OE, then in the context menu we select the <i>SQL Refactor Studio -&gt; Add CRUD Methods</i> item. <br><img src="https://habrastorage.org/files/985/81d/49b/98581d49bf4e4b1f9d9bf96f2d39332b.png"><br>  In the dialog that appears, choose which methods we need to create.  If necessary, change the names of the methods.  Click <i>Next</i> .  If you wish, you can configure the rights to the procedures, for this you need to note the necessary roles.  Click <i>Finish</i> and get the script with stored procedures.  Execute the script. <br><br><div class="spoiler">  <b class="spoiler_title">Generated script</b> <div class="spoiler_text"><pre> <code class="sql hljs">IF (object_id(N'dbo.Customer_Create') IS NULL) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> EXEC (<span class="hljs-string"><span class="hljs-string">'create procedure dbo.Customer_Create as return 0'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-comment"><span class="hljs-comment">-- ============================================= -- -- dbo.Customer_Create -- -- Create method. -- -- Date: 07.09.2015, @HabraUser -- -- ============================================= ALTER PROCEDURE dbo.Customer_Create @CustomerID NCHAR(5) ,@CompanyName NVARCHAR(40) ,@ContactName NVARCHAR(30) = NULL ,@ContactTitle NVARCHAR(30) = NULL ,@Address NVARCHAR(60) = NULL ,@PostalCode NVARCHAR(10) = NULL ,@Phone NVARCHAR(24) = NULL ,@Fax NVARCHAR(24) = NULL ,@CityId INT = NULL AS BEGIN SET NOCOUNT ON INSERT INTO dbo.Customer ( CustomerID ,CompanyName ,ContactName ,ContactTitle ,Address ,PostalCode ,Phone ,Fax ,CityId ) VALUES ( @CustomerID ,@CompanyName ,@ContactName ,@ContactTitle ,@Address ,@PostalCode ,@Phone ,@Fax ,@CityId ) RETURN 0 END /* declare @CustomerID NChar(5), @CompanyName NVarChar(40), @ContactName NVarChar(30), @ContactTitle NVarChar(30), @Address NVarChar(60), @PostalCode NVarChar(10), @Phone NVarChar(24), @Fax NVarChar(24), @CityId Int select @CustomerID = 'CustomerID', @CompanyName = 'CompanyName', @ContactName = 'ContactName', @ContactTitle = 'ContactTitle', @Address = 'Address', @PostalCode = 'PostalCode', @Phone = 'Phone', @Fax = 'Fax', @CityId = null exec dbo.Customer_Create @CustomerID = @CustomerID, @CompanyName = @CompanyName, @ContactName = @ContactName, @ContactTitle = @ContactTitle, @Address = @Address, @PostalCode = @PostalCode, @Phone = @Phone, @Fax = @Fax, @CityId = @CityId */ GO IF (object_id(N'dbo.Customer_Get') IS NULL) BEGIN EXEC ('create procedure dbo.Customer_Get as return 0') END GO -- ============================================= -- -- dbo.Customer_Get -- -- Read method. -- -- Date: 07.09.2015, @HabraUser -- -- ============================================= ALTER PROCEDURE dbo.Customer_Get @CustomerID NCHAR(5) AS BEGIN SET NOCOUNT ON SELECT CustomerID ,CompanyName ,ContactName ,ContactTitle ,Address ,PostalCode ,Phone ,Fax ,CityId FROM dbo.Customer WHERE CustomerID = @CustomerID RETURN 0 END /* declare @CustomerID NChar(5) select @CustomerID = ? exec dbo.Customer_Get @CustomerID = @CustomerID */ GO IF (object_id(N'dbo.Customer_Save') IS NULL) BEGIN EXEC ('create procedure dbo.Customer_Save as return 0') END GO -- ============================================= -- -- dbo.Customer_Save -- -- Update method. -- -- Date: 07.09.2015, @HabraUser -- -- ============================================= ALTER PROCEDURE dbo.Customer_Save @CustomerID NCHAR(5) ,@CompanyName NVARCHAR(40) ,@ContactName NVARCHAR(30) = NULL ,@ContactTitle NVARCHAR(30) = NULL ,@Address NVARCHAR(60) = NULL ,@PostalCode NVARCHAR(10) = NULL ,@Phone NVARCHAR(24) = NULL ,@Fax NVARCHAR(24) = NULL ,@CityId INT = NULL AS BEGIN SET NOCOUNT ON UPDATE t SET t.CompanyName = @CompanyName ,t.ContactName = @ContactName ,t.ContactTitle = @ContactTitle ,t.Address = @Address ,t.PostalCode = @PostalCode ,t.Phone = @Phone ,t.Fax = @Fax ,t.CityId = @CityId FROM dbo.Customer AS t WHERE t.CustomerID = @CustomerID RETURN 0 END /* set nocount on set quoted_identifier, ansi_nulls, ansi_warnings, arithabort, concat_null_yields_null, ansi_padding on set numeric_roundabort off set transaction isolation level read uncommitted declare @CustomerID NChar(5), @CompanyName NVarChar(40), @ContactName NVarChar(30), @ContactTitle NVarChar(30), @Address NVarChar(60), @PostalCode NVarChar(10), @Phone NVarChar(24), @Fax NVarChar(24), @CityId Int select @CustomerID = 'CustomerID', @CompanyName = 'CompanyName', @ContactName = 'ContactName', @ContactTitle = 'ContactTitle', @Address = 'Address', @PostalCode = 'PostalCode', @Phone = 'Phone', @Fax = 'Fax', @CityId = null begin try begin tran exec dbo.Customer_Save @CustomerID = @CustomerID, @CompanyName = @CompanyName, @ContactName = @ContactName, @ContactTitle = @ContactTitle, @Address = @Address, @PostalCode = @PostalCode, @Phone = @Phone, @Fax = @Fax, @CityId = @CityId select t.* from dbo.Customer as t where t.CustomerID = @CustomerID if @@trancount &gt; 0 rollback tran end try begin catch if @@trancount &gt; 0 rollback tran declare @err nvarchar(2000) set @err = 'login: ' + suser_sname() + char(10) + 'ErrorNumber: ' + cast(isnull(error_number(), 0) as varchar) + char(10) + 'ErrorProcedure: ' + isnull(error_procedure(), '') + char(10) + 'ErrorLine: ' + cast(isnull(error_line(), 0) as varchar) + char(10) + 'ErrorMessage: ' + isnull(error_message(), '') + char(10) + 'Date: ' + cast(getdate() as varchar) + char(10) print @err raiserror(@err, 16, 1) end catch */ GO IF (object_id(N'dbo.Customer_Del') IS NULL) BEGIN EXEC ('create procedure dbo.Customer_Del as return 0') END GO -- ============================================= -- -- dbo.Customer_Del -- -- Delete method. -- -- Date: 07.09.2015, @HabraUser -- -- ============================================= ALTER PROCEDURE dbo.Customer_Del @CustomerID NCHAR(5) AS BEGIN SET NOCOUNT ON BEGIN TRY BEGIN TRAN /* uncomment if needed delete from dbo.CustomerCustomerDemo where CustomerID = ? delete from dbo.Orders where CustomerID = ? */ DELETE FROM dbo.Customer WHERE CustomerID = @CustomerID COMMIT TRAN END TRY BEGIN CATCH IF @@trancount &gt; 0 ROLLBACK TRAN -- catch exception (add you code here) DECLARE @err NVARCHAR(2000) SET @err = ERROR_MESSAGE() RAISERROR (@err, 16, 1) END CATCH RETURN 0 END /* declare @CustomerID NChar(5) select @CustomerID = ? exec dbo.Customer_Del @CustomerID = @CustomerID */ GO IF (object_id(N'dbo.Customer_List') IS NULL) BEGIN EXEC ('create procedure dbo.Customer_List as return 0') END GO -- ============================================= -- -- dbo.Customer_List -- -- List method. -- -- Date: 07.09.2015, @HabraUser -- -- ============================================= ALTER PROCEDURE dbo.Customer_List AS BEGIN SET NOCOUNT ON SELECT CustomerID ,CompanyName ,ContactName ,ContactTitle ,Address ,PostalCode ,Phone ,Fax ,CityId FROM dbo.Customer /* uncomment if needed left join dbo.City as t1 on t1.CityId = t.CityId */ RETURN 0 END /* exec dbo.Customer_List */ GO</span></span></code> </pre><br></div></div><br><br>  If you need to correct the body of the generated procedures, go to the settings. <br><br><img src="https://habrastorage.org/files/65e/40a/f1d/65e40af1dbd544d78c01228d1bd7707e.png"><br><br>  Each procedure is a template T4.  About T4 can be read <a href="http://www.olegsych.com/2009/09/t4-preprocessed-text-templates/">here</a> and <a href="http://www.olegsych.com/2008/09/t4-tutorial-creating-reusable-code-generation-templates/">here</a> . <br><br><br><h3>  Refactoring "Introducing a trigger for accumulating historical data" </h3><br>  This operation allows you to enter a new trigger, designed to accumulate information about changes in the data in order to study the history of changes or audit. <br>  The need to apply the operation ‚ÄúIntroducing a trigger for the accumulation of historical data‚Äù is mainly due to the requirement to transfer the data tracking functions to the database itself.  This approach ensures that if important data is modified in any external application, this change can be tracked and audited. <br>  The only drawback, in my opinion, is the fact that the presence of a trigger will increase the execution time of a DML operation. <br>  As an alternative to this method, you can consider <a href="https://technet.microsoft.com/ru-ru/library/Bb522489(v%3DSQL.105).aspx">Change Data Capture</a> (it works asynchronously, thus it does not increase the operation time, but it has several features). <br><br>  Let's apply this refactoring for the <i>dbo.Customer</i> table. <br>  Select a table in OE, select the <i>SQL Refactor Studio - Introduce Trigger for History</i> item in the context menu.  Select table fields to track changes. <br><img src="https://habrastorage.org/files/c2b/7f2/751/c2b7f275113e4a62b50e8e9d067367f0.png"><br>  Click <i>Next</i> .  If necessary, we change the name of the table being created and the trigger. <br><img src="https://habrastorage.org/files/732/72f/d30/73272fd30b06463db4a11a1e323030ae.png"><br><br>  Click <i>Finish</i> and get the script.  The script creates a trigger and a table to store the change history. <br><br><div class="spoiler">  <b class="spoiler_title">Generated script</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [dbo].[CustomerHistory] ( [<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,[action_type] [<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>](<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ,[modified_date] [datetime] <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_CustomerHistory_modified_date] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>() ,[modified_login] [sysname] <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_CustomerHistory_modified_login] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> suser_sname() ,[host_name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_CustomerHistory_host_name] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> host_name() ,[program_name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_CustomerHistory_program_name] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> program_name() ,[CompanyName_old] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">40</span></span>) ,[CompanyName_new] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">40</span></span>) ,[ContactName_old] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">30</span></span>) ,[ContactName_new] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">30</span></span>) ,[ContactTitle_old] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">30</span></span>) ,[ContactTitle_new] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">30</span></span>) ,[Address_old] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">60</span></span>) ,[Address_new] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">60</span></span>) ,[PostalCode_old] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">10</span></span>) ,[PostalCode_new] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">10</span></span>) ,[Phone_old] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">24</span></span>) ,[Phone_new] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">24</span></span>) ,[Fax_old] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">24</span></span>) ,[Fax_new] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">24</span></span>) ,[CityId_old] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] ,[CityId_new] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] ,[CustomerID_old] [<span class="hljs-keyword"><span class="hljs-keyword">nchar</span></span>](<span class="hljs-number"><span class="hljs-number">5</span></span>) ,[CustomerID_new] [<span class="hljs-keyword"><span class="hljs-keyword">nchar</span></span>](<span class="hljs-number"><span class="hljs-number">5</span></span>) ,<span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [PK_CustomerHistory] PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> ([<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>]) ) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> [dbo].[trg_CustomerHistory] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[Customer] <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @action_type <span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> inserted) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> deleted) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @action_type = <span class="hljs-string"><span class="hljs-string">'U'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> inserted) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> deleted) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @action_type = <span class="hljs-string"><span class="hljs-string">'I'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> inserted) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> deleted) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @action_type = <span class="hljs-string"><span class="hljs-string">'D'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.CustomerHistory ( action_type ,CompanyName_old ,CompanyName_new ,ContactName_old ,ContactName_new ,ContactTitle_old ,ContactTitle_new ,Address_old ,Address_new ,PostalCode_old ,PostalCode_new ,Phone_old ,Phone_new ,Fax_old ,Fax_new ,CityId_old ,CityId_new ,CustomerID_old ,CustomerID_new ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @action_type ,d.CompanyName ,i.CompanyName ,d.ContactName ,i.ContactName ,d.ContactTitle ,i.ContactTitle ,d.Address ,i.Address ,d.PostalCode ,i.PostalCode ,d.Phone ,i.Phone ,d.Fax ,i.Fax ,d.CityId ,i.CityId ,d.CustomerID ,i.CustomerID <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> inserted i <span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> deleted d <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (i.CustomerID = d.CustomerID) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br></div></div><br><br>  That's all for now.  I hope the information will be useful to you and in your databases there will always be a complete order. <br>  Good luck! <br><br><br><h2>  Useful resources </h2><br><ul><li>  <a href="http://databaserefactoring.com/">http://databaserefactoring.com</a> </li><li>  Scott Ambler, Pramodkumar J. Sadaladzh <a href="http://www.ozon.ru/context/detail/id/3261793/">Refactoring databases.</a>  <a href="http://www.ozon.ru/context/detail/id/3261793/">Evolutionary design</a> </li><li>  Martin Fowler <a href="http://www.ozon.ru/context/detail/id/1308678/">Refactoring. Improving Existing Code</a> </li><li>  Plugin for SSMS <a href="http://sqlrefactorstudio.com/">SQL Refactor Studio</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/258629/">https://habr.com/ru/post/258629/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258615/index.html">Pulse sensor device Part 2 - Sensors</a></li>
<li><a href="../258619/index.html">Homemade control unit for diesel engine</a></li>
<li><a href="../258621/index.html">DICOM Viewer from the inside. Functionality</a></li>
<li><a href="../258625/index.html">Top 10 non-cash countries of the world</a></li>
<li><a href="../258627/index.html">The digest of interesting materials for the mobile developer # 104 (on May 18-24)</a></li>
<li><a href="../258635/index.html">ISO 9241-210. Planning and Implementing Human-Centered Design</a></li>
<li><a href="../258641/index.html">JDK 7 code statistics</a></li>
<li><a href="../258643/index.html">Equinix uses Bloom Energy fuel cells to power a Silicon Valley data center</a></li>
<li><a href="../258653/index.html">New Blogger Operators</a></li>
<li><a href="../258655/index.html">Let's play debug this Sunday night?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>