<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Write on C as a gentleman</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚ÄúCode Monkey like Fritos 
 Code Monkey like Tab and Mountain Dew 
 Code Monkey very simple man 
 With big warm fuzzy secret heart: 
 Code Monkey like ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Write on C as a gentleman</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/264/877/15e/26487715e69445adb1c631dc801830d5.jpg"></div><br><blockquote>  ‚ÄúCode Monkey like Fritos <br>  Code Monkey like Tab and Mountain Dew <br>  Code Monkey very simple man <br>  With big warm fuzzy secret heart: <br>  Code Monkey like you <br>  Code Monkey like you ¬ª <br></blockquote><br>  - Jonathan Coulton - Code Monkey <br><br>  I think that Jonathan Coulton's gorgeous song is familiar to many, and this is a life situation when ‚ÄúRob say Code Monkey very diligent‚Äù, but ‚Äúhis output stink‚Äù and ‚Äúhis code not 'functional' or 'elegant'‚Äù. <br><br>  The C language, which gave us so much useful software, was slowly squeezed out of the desktop and enterprise by such high-level giants as Java and C # and occupied the niche of system programming.  And everything is good, but the system analysts are very <s>repulsed</s> peculiar guys.  Tasks that sometimes arise before them, even with their formulation, are able to drive into horror mere mortals.  In fact, just like some solutions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Today we will talk about some useful practices that I learned from the depths of C system programming.  Go. <br><a name="habracut"></a><br>  Items will range from the most fundamental and obvious (targeted at novices in the C language) to the most specific, but useful.  If you feel that you know it - scroll further. <br><br><h2>  Practice I: Observe the uniform Code Style and the fundamental principles of "good form" </h2><br>  The function accepts the INPUT variable as an argument, parses it into the IncomingValues ‚Äã‚Äãarray, and returns result_to_return?  Stop bydlokod! <br><br>  The first thing that a beginner gives out is the failure to follow a single style of writing code within a particular application.  Next comes the disregard for the rules of "good tone". <br><br>  Here are some of the most common recommendations for C code design: <br><br><ul><li>  <b>The names of macros and macrofunctions are written in caps, the words in the names are separated from each other by underscores.</b> <br><br><pre><code class="cpp">#define MAX_ARRAY_SIZE    32
#define INCORRECT_VALUE   -1
#define IPC_FIND_NODE(x)  ipc_find_node(config.x)
</code></pre><br>
</li>
<li><b>     ,       </b><br>
<br>
<pre><code class="cpp">int my_int_variable = 0;
char *hello_str = "hello_habrahabr";
pid_t current_pid = fork();</code></pre><br>
,   .    ,        camelCase  PascalCase .<br>
<br>
<b>UPD:   <a href="https://habrahabr.ru/users/fogree/">fogree</a>  ,       PascalCase  camelCase.</b><br>
<br>
</li>
<li><b>       ,  ,       ‚Äî    .</b><br>
<br>
,       ,       .      . <br>
<br>
       ‚Äî  a, b, c ‚Äî       (   ).   ‚Äî   .<br>
<br>
</li>
<li><b>  (      -  )   ,    ,    .</b><br>
<br>
 ,      : PascalCase  under_score,     .<br>
<br>
<pre><code class="cpp">/*     */
static void dgtprint(char *str) {
     int i;
     for (i = 0; i &lt; strlen(str); i++) {
         if (isdigit(str[i]))
             printf("%c", str[i]);
         else
             print("_");
     }
}

/*        */
/* PascalCase */
void EnableAllVlans(struct vlan_cfg *vp) {
    int i;
    for (i = 0; i &lt; VLAN_COUNT; i++) {
        EnableVlanByProto(vp.vlan[i]);
    }
}

/* under_score */
void enable_all_vlans(struct vlan_cfg *vp) {
    int i;
    for (i = 0; i &lt; VLAN_COUNT; i++) {
        enable_vlan_by_proto(vp.vlan[i]);
    }
}</code></pre><br>
</li>
<li><b>i, j, k ‚Äî     </b><br>
<br>
<pre><code class="cpp">int array[MAX_ARRAY_SIZE] = arrinit();
register int i, j, k;
for (i = 0; i &lt; MAX_ARRAY_SIZE; i++) 
    for (j = 0; j &lt; MAX_ARRAY_SIZE; j++)
        for (k = MAX_ARRAY_SIZE; k &gt;= 0; k--)
            dosmthng(i, j, k, array[i]);</code></pre><br>
</li>
<li><b>   </b><br>
<br>
<pre><code class="cpp">if (condition) { dosmthng(); } else
{
    dont_do_something();
} /*    */

if (condition) {
    dosmthng(); 
} else {
    dont_do_something();
} /*        ,   */

if (condition) 
{
    dosmthng(); 
} 
else
{
    dont_do_something();
} /*    */

/* ,   ,      */
if (condition) { dosmthng(); } else { dont_do_something(); } </code></pre><br>
</li>
<li><b>    .</b>    ,    .<br>
<br>
     .    ,  ‚Äî NULL:<br>
<br>
<pre><code class="cpp">int counter = 0, start_position = 0, unknown_position = 0;
struct dhcp_header * dhcp = NULL, * dhcp_temp = NULL;
char input_string[32] = { 0 };</code></pre><br>
    ,  ?<br>
<br>
 .    ( )   (   gdb),    .      (,   ¬´  ¬ª).     .<br>
<br>
</li>
<li><b>   .</b><br>
<br>
      ‚Äî     ,       . <br>
<br>
  ‚Äî   ,          .   ‚Äî   ,     -  ,    . <br>
<br>
  ,          ‚Äî   ,     ,  ,  ,      ,   .<br>
<br>
<pre><code class="cpp">/*  1,  ,    
 *  ,  0,  . 
 */
static int CheckModemConnection()
{
  int i = 0;
  /*    -    */
  if (CHECK_CFG_STR(Network.LanIpAddress) || CHECK_CFG_STR(Network.LanNetmask))
    return 1;

  for(i = 0; i &lt; MAX_MODEM_IDX; i++)
  {
    if (CHECK_CFG_INT(Modems.Modem[i].Proto) || CHECK_CFG_INT(Modems.Modem[i].MTU) ||
      CHECK_CFG_STR(Modems.Modem[i].Username) || CHECK_CFG_STR(Modems.Modem[i].Password) ||
      CHECK_CFG_STR(Modems.Modem[i].Number) || CHECK_CFG_STR(Modems.Modem[i].AdditionalParams) ||
      CHECK_CFG_STR(Modems.Modem[i].PIN) || CHECK_CFG_STR(Modems.Modem[i].MRU) || 
      CHECK_CFG_STR(Modems.Modem[i].PppoeIdle) || CHECK_CFG_STR(Modems.Modem[i].USBPort) ||
      CHECK_CFG_STR(Reservation.Prefer) || CHECK_CFG_STR(Modems.Modem[i].PppoeConnectType) || 
      CHECK_CFG_INT(Modems.Mode) || CHECK_CFG_INT(Aggregation.usb1) || CHECK_CFG_INT(Aggregation.usb2))
      return 1;
  }
  return 0;
}</code></pre><br>
      ( <a href="https://ru.wikipedia.org/wiki/Redmine">RedMine</a>),          ,       .   -      - ¬´   ?¬ª,     .       ,    ,     .<br>
<blockquote>/* Muraviyov: #66770 */</blockquote></li>
</ul><br>
<hr><br>
<i>P.S.      :     ,    ,  ,   Code Style,    .          -    .</i><br>
<br>
<h2>  II:     </h2><br>
       ‚Äî       .<br>
  , ,   ,   ,     :<br>
<br>
<ol>
<li><b>  ,    ,     .</b><br>
<br>
    file1.c, mySUPER_COOL_header.h  .. <br>
main.c ‚Äî     , graph_const.h ‚Äî         .<br>
<br>
</li>
<li><b>    include.</b><br>
<br>
 :<br>
<br>
<ul>
<li>project/<br>
 <ul>
<li>common.c</li>
<li>common.h</li>
<li>main.c</li>
<li>network.h</li>
<li>networking.c</li>
<li>networking_v6.c</li>
<li>packet.c</li>
<li>packet.h</li>
<li>Makefile</li>
</ul><br>
 </li>
</ul> ,   .     ,     9 , , , 39. -    . ,   ‚Äî  ,       GUI, ,   ,     Github/Gitlab/Bitbucket?<br>
<br>
    ,    ?    ,   :<br>
<br>
<ul>
<li>project/<br>
 <ul>
<li>include/<br>
 <ul>
<li>common.h</li>
<li>network.h</li>
<li>packet.h</li>
</ul><br>
 </li>
<li>common.c</li>
<li>main.c</li>
<li>networking.c</li>
<li>networking_v6.c</li>
<li>packet.c</li>
<li>Makefile</li>
</ul></li>
</ul><br>
 ,     include     .     Makefile (include    ,   Makefile):<br>
<br>
<pre><code>@$(CC) $(OBJS) -o networkd -L$(ROMFS)/lib -linteraction -Wall -lpthread -I ./include</code></pre><br>
</li>
<li><b>  .c   . </b><br>
<br>
   ,    ,   // ‚Äî      . ,    ‚Äî    . <br>
<br>
</li>
<li>    ‚Äî <b>         </b>,          .    Makefile       :<br>
<br>
<pre><code>.PHONY clean build
build:
    cd sound/ &amp;&amp; make clean &amp;&amp; make 
    cd graphics/ &amp;&amp; make clean &amp;&amp; make
    cd engine/ &amp;&amp; make clean &amp;&amp; make
sound:
    cd sound/ &amp;&amp; make clean &amp;&amp; make
graphics:
    cd graphics/ &amp;&amp; make clean &amp;&amp; make
engine:
    cd engine/ &amp;&amp; make clean &amp;&amp; make
clean:
    cd sound/ &amp;&amp; make clean
    cd engine/ &amp;&amp; make clean
    cd greaphics/ &amp;&amp; make clean</code></pre></li>
</ol> <br>
<h2>  III:  -     </h2><br>
- (-)           .  ,      ,      ,    errno     .<br>
<br>
     (      ‚Äî   ),    ,  ¬´¬ª  . -,    ,  ,      .<br>
<br>
        ‚Äî   .    ,   (+ )     .<br>
<br>
   .    ‚Äî    :<br>
<br>
<pre><code class="cpp">int sock_one = 0, sock_two = 0, sock_three = 0;
/*     ,   , 
 *     
 */
if ((socket_one = socket(AF_INET , SOCK_STREAM , 0)) &lt;= 0) { 
    perror("socket one");
    exit(EXIT_ERROR_CODE);
}
if ((socket_two = socket(AF_INET , SOCK_DGRAM , 0)) &lt;= 0) { 
    perror("socket two");
    exit(EXIT_ERROR_CODE);
}
if ((socket_three = socket(PF_INET , SOCK_RAW , 0)) &lt;= 0) { 
    perror("socket three");
    exit(EXIT_ERROR_CODE);
} </code></pre><br>
,  ,   ?    .<br>
<br>
<pre><code class="cpp">/* -  ... */
int Socket(int domain, int type, int proto) {
    int desk = socket(domain, type, proto);
    if (desk &lt;= 0) {
        perror("socket");
        exit(EXIT_ERROR_CODE);
    }
    return desk;
}
/* ......... n   -    ......... */
int socket_one = 0, socket_two = 0, soket_three = 0;
socket_one = Socket(AF_INET , SOCK_STREAM , 0);
socket_two = Socket(AF_INET , SOCK_DGRAM , 0);
socket_three = Socket(PF_INET , SOCK_RAW , 0);</code></pre><br>
 ,  -  (  ¬´¬ª ),       .<br>
<br>
     ,    .    ,   .<br>
<br>
     , ,  ,   .      ‚Äî     :)<br>
<br>
<h2>  IV:  keywords   </h2><br>
  keywords    . ,       ,  .       ,    ‚Äî   ,     . <br>
<br>
  ,        ,           . ,      ,   .    :<br>
<br>
<ul>
<li><i>register</i> ‚Äî          ,     .   register   -             . <br>
<br>
<pre><code class="cpp">register byte i = 0;
for (i; i &lt; 256; i++)
    check_value(i);</code></pre><br>
</li>
<li><i>restrict</i> ‚Äî       (,  , ),          ,     .     ,     ,    -      .          ‚Äî ,   .<br>
<br>
<pre><code class="cpp">void updatePtrs(size_t *restrict ptrA, size_t *restrict ptrB, size_t *restrict val);
</code></pre><br>
</li>
<li><i>volatile</i> ‚Äî  ,         .     ,    ,  dead code (,     ),    ,       . <br>
<br>
<pre><code class="cpp">int var = 1;
if (!var)             /*  2     */
    dosmthng();   

volatile int var = 1;
if (!var)            /*     -  */
    dosmthng();  </code></pre></li>
</ul><br>
    .      ‚Äî <a href="http://en.cppreference.com/w/c/keyword"></a>. <br>
<br>
<h2>  V:   .  valgrind. </h2><br>
        ,     ,   ,      .<br>
<br>
<a href="https://ru.wikipedia.org/wiki/Valgrind">Valgrind</a> ‚Äî ,    ,         .     ,  ,         ,       , ,   ,        .    . <br>
+       .<br>
<br>
      <a href="https://www.opennet.ru/base/dev/valgrind_memory.txt.html"></a>.<br>
<br>
<h2>  VI:  ,      </h2><br>
     busybox 1.21.     ,   busybox,   <a href="https://ru.wikipedia.org/wiki/BusyBox"> -</a>.<br>
<br>
<b>UPD:</b>      ¬´¬ª   busybox.   <a href="https://habrahabr.ru/users/themiron/">themiron</a>  ,  ,        ‚Äî     ,    .      ¬´¬ª  busybox,     .<br>
<br>
,     busybox.<br>
<br>
 busybox  ,     . ,          ‚Äî    <a href="https://git.busybox.net/busybox/tree/networking/udhcp%3Fh%3D1_26_stable"></a>.<br>
<br>
        busybox.     udhcpc ‚Äî  <a href="https://ru.wikipedia.org/wiki/DHCP">DHCP</a> :<br>
<br>
<ul>
<li><b> ,    .</b><br>
<br>
 DHCP     RFC,      dhcp-. ,   ,        .   ‚Äî ,    ,    (DHCP- &lt;-&gt; DHCP-).<br>
<br>
<i>( networking/udhcp/common.h)</i><br>
<br>
<pre><code class="cpp">struct dhcp_packet {
	uint8_t op;      /* BOOTREQUEST or BOOTREPLY */
	uint8_t htype;   /* hardware address type. 1 = 10mb ethernet */
	uint8_t hlen;    /* hardware address length */
	uint8_t hops;    /* used by relay agents only */
	uint32_t xid;    /* unique id */
	uint16_t secs;   /* elapsed since client began acquisition/renewal */
	uint16_t flags;  /* only one flag so far: */
#define BROADCAST_FLAG 0x8000 /* "I need broadcast replies" */
	uint32_t ciaddr; /* client IP (if client is in BOUND, RENEW or REBINDING state) */
	uint32_t yiaddr; /* 'your' (client) IP address */
	/* IP address of next server to use in bootstrap, returned in DHCPOFFER, DHCPACK by server */
	uint32_t siaddr_nip;
	uint32_t gateway_nip; /* relay agent IP address */
	uint8_t chaddr[16];   /* link-layer client hardware address (MAC) */
	uint8_t sname[64];    /* server host name (ASCIZ) */
	uint8_t file[128];    /* boot file name (ASCIZ) */
	uint32_t cookie;      /* fixed first four option bytes (99,130,83,99 dec) */
	uint8_t options[DHCP_OPTIONS_BUFSIZE + CONFIG_UDHCPC_SLACK_FOR_BUGGY_SERVERS];
} PACKED;
</code></pre><br>
 </li>
<li><b>        .</b><br>
<br>
    , ..     . <br>
<br>
:      ,    . <br>
<br>
<i>( networking/udhcp/common.h)</i><br>
<br>
<pre><code class="cpp">struct dhcp_packet {
	uint8_t op;      /* BOOTREQUEST or BOOTREPLY */
	uint8_t htype;   /* hardware address type. 1 = 10mb ethernet */
	uint8_t hlen;    /* hardware address length */
	uint8_t hops;    /* used by relay agents only */
	uint32_t xid;    /* unique id */
	uint16_t secs;   /* elapsed since client began acquisition/renewal */
	uint16_t flags;  /* only one flag so far: */
#define BROADCAST_FLAG 0x8000 /* "I need broadcast replies" */
	uint32_t ciaddr; /* client IP (if client is in BOUND, RENEW or REBINDING state) */
	uint32_t yiaddr; /* 'your' (client) IP address */
	/* IP address of next server to use in bootstrap, returned in DHCPOFFER, DHCPACK by server */
	uint32_t siaddr_nip;
	uint32_t gateway_nip; /* relay agent IP address */
	uint8_t chaddr[16];   /* link-layer client hardware address (MAC) */
	uint8_t sname[64];    /* server host name (ASCIZ) */
	uint8_t file[128];    /* boot file name (ASCIZ) */
	uint32_t cookie;      /* fixed first four option bytes (99,130,83,99 dec) */
	uint8_t options[DHCP_OPTIONS_BUFSIZE + CONFIG_UDHCPC_SLACK_FOR_BUGGY_SERVERS];
} PACKED;
#define DHCP_PKT_SNAME_LEN      64
#define DHCP_PKT_FILE_LEN      128
#define DHCP_PKT_SNAME_LEN_STR "64"
#define DHCP_PKT_FILE_LEN_STR "128"

struct ip_udp_dhcp_packet {
	struct iphdr ip;
	struct udphdr udp;
	struct dhcp_packet data;
} PACKED;

struct udp_dhcp_packet {
	struct udphdr udp;
	struct dhcp_packet data;
} PACKED;

enum {
	IP_UDP_DHCP_SIZE = sizeof(struct ip_udp_dhcp_packet) - CONFIG_UDHCPC_SLACK_FOR_BUGGY_SERVERS,
	UDP_DHCP_SIZE    = sizeof(struct udp_dhcp_packet) - CONFIG_UDHCPC_SLACK_FOR_BUGGY_SERVERS,
	DHCP_SIZE        = sizeof(struct dhcp_packet) - CONFIG_UDHCPC_SLACK_FOR_BUGGY_SERVERS,
};</code></pre><br>
        ,  ,            : <br>
<br>
<i>( networking/udhcp/common.h)</i><br>
<br>
<pre><code class="cpp">unsigned FAST_FUNC udhcp_option_idx(const char *name);

uint8_t *udhcp_get_option(struct dhcp_packet *packet, int code) FAST_FUNC;
int udhcp_end_option(uint8_t *optionptr) FAST_FUNC;
void udhcp_add_binary_option(struct dhcp_packet *packet, uint8_t *addopt) FAST_FUNC;
void udhcp_add_simple_option(struct dhcp_packet *packet, uint8_t code, uint32_t data) FAST_FUNC;
#if ENABLE_FEATURE_UDHCP_RFC3397
char *dname_dec(const uint8_t *cstr, int clen, const char *pre) FAST_FUNC;
uint8_t *dname_enc(const uint8_t *cstr, int clen, const char *src, int *retlen) FAST_FUNC;
#endif
struct option_set *udhcp_find_option(struct option_set *opt_list, uint8_t code) FAST_FUNC;</code></pre><br>
</li>
<li><b>      </b><br>
<br>
 udhcpc    ,     .    ,    . <br>
<br>
     ‚Äî     ,      . ,    ¬´    ?¬ª     .    .<br>
<br>
  ‚Äî     ,     ,      . <br>
<br>
<i>( networking/udhcp/common.h)</i><br>
<br>
<pre><code class="cpp">#define DHCP_PADDING            0x00
#define DHCP_SUBNET             0x01
//#define DHCP_TIME_OFFSET      0x02 /* (localtime - UTC_time) in seconds. signed */
//#define DHCP_ROUTER           0x03
//#define DHCP_TIME_SERVER      0x04 /* RFC 868 time server (32-bit, 0 = 1.1.1900) */
//#define DHCP_NAME_SERVER      0x05 /* IEN 116 _really_ ancient kind of NS */
//#define DHCP_DNS_SERVER       0x06
//#define DHCP_LOG_SERVER       0x07 /* port 704 UDP log (not syslog)
//#define DHCP_COOKIE_SERVER    0x08 /* "quote of the day" server */
//#define DHCP_LPR_SERVER       0x09
#define DHCP_HOST_NAME          0x0c /* either client informs server or server gives name to client */
//#define DHCP_BOOT_SIZE        0x0d
//#define DHCP_DOMAIN_NAME      0x0f /* server gives domain suffix */
//#define DHCP_SWAP_SERVER      0x10
//#define DHCP_ROOT_PATH        0x11
//#define DHCP_IP_TTL           0x17
//#define DHCP_MTU              0x1a
//#define DHCP_BROADCAST        0x1c
//#define DHCP_ROUTES           0x21
//#define DHCP_NIS_DOMAIN       0x28
//#define DHCP_NIS_SERVER       0x29
//#define DHCP_NTP_SERVER       0x2a
//#define DHCP_WINS_SERVER      0x2c
#define DHCP_REQUESTED_IP       0x32 /* sent by client if specific IP is wanted */
#define DHCP_LEASE_TIME         0x33
#define DHCP_OPTION_OVERLOAD    0x34
#define DHCP_MESSAGE_TYPE       0x35
#define DHCP_SERVER_ID          0x36 /* by default server's IP */
#define DHCP_PARAM_REQ          0x37 /* list of options client wants */
//#define DHCP_ERR_MESSAGE      0x38 /* error message when sending NAK etc */
#define DHCP_MAX_SIZE           0x39
#define DHCP_VENDOR             0x3c /* client's vendor (a string) */
#define DHCP_CLIENT_ID          0x3d /* by default client's MAC addr, but may be arbitrarily long */
//#define DHCP_TFTP_SERVER_NAME 0x42 /* same as 'sname' field */
//#define DHCP_BOOT_FILE        0x43 /* same as 'file' field */
//#define DHCP_USER_CLASS       0x4d /* RFC 3004. set of LASCII strings. "I am a printer" etc */
#define DHCP_FQDN               0x51 /* client asks to update DNS to map its FQDN to its new IP */
//#define DHCP_DOMAIN_SEARCH    0x77 /* RFC 3397. set of ASCIZ string, DNS-style compressed */
//#define DHCP_SIP_SERVERS      0x78 /* RFC 3361. flag byte, then: 0: domain names, 1: IP addrs */
//#define DHCP_STATIC_ROUTES    0x79 /* RFC 3442. (mask,ip,router) tuples */
#define DHCP_VLAN_ID            0x84 /* 802.1P VLAN ID */
#define DHCP_VLAN_PRIORITY      0x85 /* 802.1Q VLAN priority */
//#define DHCP_MS_STATIC_ROUTES 0xf9 /* Microsoft's pre-RFC 3442 code for 0x79? */
//#define DHCP_WPAD             0xfc /* MSIE's Web Proxy Autodiscovery Protocol */
#define DHCP_END                0xff</code></pre><br>
</li>
<li><b>      .</b><br>
<br>
    ,  .   :     ,      n    ( n ‚Äî  ),       ,        ,     ,     . .    ,       :<br>
<br>
<i>( networking/udhcp/packet.c)</i><br>
<br>
<pre><code class="cpp">/* Construct a ip/udp header for a packet, send packet */
int FAST_FUNC udhcp_send_raw_packet(struct dhcp_packet *dhcp_pkt,
		uint32_t source_nip, int source_port,
		uint32_t dest_nip, int dest_port, const uint8_t *dest_arp,
		int ifindex)
{
	struct sockaddr_ll dest_sll;
	struct ip_udp_dhcp_packet packet;
	unsigned padding;
	int fd;
	int result = -1;
	const char *msg;

	fd = socket(PF_PACKET, SOCK_DGRAM, htons(ETH_P_IP));
	if (fd &lt; 0) {
		msg = "socket(%s)";
		goto ret_msg;
	}

	memset(&amp;dest_sll, 0, sizeof(dest_sll));
	memset(&amp;packet, 0, offsetof(struct ip_udp_dhcp_packet, data));
	packet.data = *dhcp_pkt; /* struct copy */

	dest_sll.sll_family = AF_PACKET;
	dest_sll.sll_protocol = htons(ETH_P_IP);
	dest_sll.sll_ifindex = ifindex;
	dest_sll.sll_halen = 6;
	memcpy(dest_sll.sll_addr, dest_arp, 6);

	if (bind(fd, (struct sockaddr *)&amp;dest_sll, sizeof(dest_sll)) &lt; 0) {
		msg = "bind(%s)";
		goto ret_close;
	}

	/* We were sending full-sized DHCP packets (zero padded),
	 * but some badly configured servers were seen dropping them.
	 * Apparently they drop all DHCP packets &gt;576 *ethernet* octets big,
	 * whereas they may only drop packets &gt;576 *IP* octets big
	 * (which for typical Ethernet II means 590 octets: 6+6+2 + 576).
	 *
	 * In order to work with those buggy servers,
	 * we truncate packets after end option byte.
	 */
	padding = DHCP_OPTIONS_BUFSIZE - 1 - udhcp_end_option(packet.data.options);

	packet.ip.protocol = IPPROTO_UDP;
	packet.ip.saddr = source_nip;
	packet.ip.daddr = dest_nip;
	packet.udp.source = htons(source_port);
	packet.udp.dest = htons(dest_port);
	/* size, excluding IP header: */
	packet.udp.len = htons(UDP_DHCP_SIZE - padding);
	/* for UDP checksumming, ip.len is set to UDP packet len */
	packet.ip.tot_len = packet.udp.len;
	packet.udp.check = inet_cksum((uint16_t *)&amp;packet,
			IP_UDP_DHCP_SIZE - padding);
	/* but for sending, it is set to IP packet len */
	packet.ip.tot_len = htons(IP_UDP_DHCP_SIZE - padding);
	packet.ip.ihl = sizeof(packet.ip) &gt;&gt; 2;
	packet.ip.version = IPVERSION;
	packet.ip.ttl = IPDEFTTL;
	packet.ip.check = inet_cksum((uint16_t *)&amp;packet.ip, sizeof(packet.ip));

	udhcp_dump_packet(dhcp_pkt);
	result = sendto(fd, &amp;packet, IP_UDP_DHCP_SIZE - padding, /*flags:*/ 0,
			(struct sockaddr *) &amp;dest_sll, sizeof(dest_sll));
	msg = "sendto";
 ret_close:
	close(fd);
	if (result &lt; 0) {
 ret_msg:
		bb_perror_msg(msg, "PACKET");
	}
	return result;
}
</code></pre><br>
 dhcp         IP .     (BROADCAST) . <br>
<br>
    ‚Äî      ,   broadcast. ,  ,    ,     ,      ,    .   :<br>
<br>
<i>( networking/udhcp/dhcpc.c)</i><br>
<br>
<pre><code class="cpp">static int raw_bcast_from_client_config_ifindex(struct dhcp_packet *packet)
{
	return udhcp_send_raw_packet(packet,
		/*src*/ INADDR_ANY, CLIENT_PORT,
		/*dst*/ INADDR_BROADCAST, SERVER_PORT, MAC_BCAST_ADDR,
		client_config.ifindex);
}
</code></pre> <br>
   ,  ,      ,     ,   .      udhcp_send_raw_packet,        .<br>
</li>
</ul><br>
<h2></h2><br>
<hr><br>
  ,  ,      ,   .       .<br>
<br>
  ,   .   ,       .    .      . <br>
<br>
<b><i>    .</i></b><br>
<br>
, !</div><p>Source: <a href="https://habr.com/ru/post/325678/">https://habr.com/ru/post/325678/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325664/index.html">How I learned to create my mobile apps</a></li>
<li><a href="../325666/index.html">Import Substitution in I2P: Signature in accordance with GOST R 34.10-2012</a></li>
<li><a href="../325668/index.html">Connect to FireBird from Python and monitor the fact of writing to the database</a></li>
<li><a href="../325672/index.html">‚ÄúApache Ignite is a high-tech product‚Äù: GridGain Systems about in-memory computing, open source, the Russian market and not only</a></li>
<li><a href="../325676/index.html">Huawei USG 6300. Basic firewall configuration out of the box</a></li>
<li><a href="../325682/index.html">The fraudster pulled out of two companies $ 100 million with the help of social engineering</a></li>
<li><a href="../325684/index.html">"Do not think about support down": how to realize the hidden features of your support service</a></li>
<li><a href="../325686/index.html">Orange pi one</a></li>
<li><a href="../325688/index.html">Introduction to React Loadable</a></li>
<li><a href="../325690/index.html">Why I abandoned multiple monitors</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>