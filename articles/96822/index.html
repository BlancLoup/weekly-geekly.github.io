<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hyper-V Architecture</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article we will talk about what Hyper-V is ‚Äúfrom the inside,‚Äù and how it differs from VMware ESX in terms of architecture, not marketing leafl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hyper-V Architecture</h1><div class="post__text post__text-html js-mediator-article">  In this article we will talk about what Hyper-V is ‚Äúfrom the inside,‚Äù and how it differs from VMware ESX in terms of architecture, not marketing leaflets.  The article will be divided into three parts.  In the first part I will talk about the hypervisor architecture itself, in the other two about how Hyper-V works with storage devices and with the network. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage/habraeffect/22/d5/22d5cde9cea109f2c8fdb52ad8a84b27.png"></div><br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, as we already know, Hyper-V is a server virtualization platform from Microsoft that replaces Virtual Server.  Unlike the latter, Hyper-V is not a standalone product, but only a component of the Windows Server 2008 OS. So, let's see what happens with Windows Server 2008 after installing the Hyper-V role: <br><br><img src="https://habrastorage.org/storage/habraeffect/ef/73/ef736d092a05aee81038deb0d93182d1.png" alt="image"><br>  As we can see, after installing the Hyper-V role, the system architecture changes dramatically: if before the OS was working with memory, processor and hardware directly, then after installing the memory and processor time distribution is controlled by the hypervisor.  Also, there are some new components, which will be discussed below.  After installing Hyper-V, the system creates isolated environments in which guest OSs run, so-called partitions.  Not to be confused with hard disk partitions.  The host OS itself, in turn, since the installation of Hyper-V, works in the same way in an isolated partition called the parent partition.  Partitions in which guest OS are started are referred to as child.  The difference between the parent partition and the child part is that only the parent partition can directly access the server hardware.  All other partitions are completely isolated both from each other and from the server hardware itself.  All interaction with iron comes through drivers running inside the host OS, that is, through the parent partition.  Each virtual machine has a set of virtual devices (network adapter, video adapter, disk controller, etc.) that interact with the parent partition through the so-called virtual device bus (VMBus).  And already in the parent partition, all calls to the virtual devices are transmitted to the hardware drivers.  This is the fundamental difference between Hyper-V and VMware ESX: in ESX, device drivers are built into the hypervisor itself.  Good or bad - definitely impossible to say.  On the one hand, this is certainly good: the ESX hypervisor can work on its own, without the need for a host OS, and therefore has much lower memory and disk space requirements.  On the other hand, the list of supported hardware is very limited, and it is impossible to install new drivers in ESX.  Therefore, it may be a situation that when using VMware ESX when, for example, a new driver appears that supports some special hardware functions, you will have to wait for the new version of the hypervisor.  The opposite situation is also possible: when replacing iron with a new one, it may be necessary to switch to a new hypervisor.  In Hyper-V, it will be enough just to install the appropriate drivers in the host OS. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage/habraeffect/a7/7e/a77e7041c3b723e63740de7b51c2fae5.png" alt="image"></div><br><br>  Now consider the Hyper-V environment, in which, in addition to the host OS, three more virtual machines are running.  On one of them, Windows is installed and integration components are installed (Windows 7 and Windows Server 2008 R2 OS include integration components), another OS is installed that does not support integration components (or they are simply not installed), and the third OS is installed Linux, for which integration components exist (currently only SLES and RHEL are supported). <br>  So, in the parent partition, in user space, there are: <br><ul><li>  <b>WMI providers</b> allow you to manage virtual machines both locally and remotely. </li><li>  <b>Virtual Machine Management Service (VMMS)</b> - in fact, manages virtual machines. </li><li>  <b>Virtual Machine Workflows (VMWPs)</b> are processes in which all actions of virtual machines are performed ‚Äî accessing virtual processors, devices, etc. </li></ul><br>  In the kernel space of the parent partition, the following are performed: <br><ul><li>  <b>Virtual Infrastructure Driver (VID)</b> - manages partitions, as well as processors and memory of virtual machines. </li><li>  <b>Virtualization Service Provider (VSP)</b> - provides specific functions of virtual devices (the so-called "synthetic devices) through VMBus and in the presence of integration components on the guest OS side. </li><li>  <b>Virtual device bus (VMBus)</b> - exchanges information between virtual devices within child partitions and the parent partition. </li><li>  <b>Device drivers</b> - as mentioned above, only the parent partition has direct access to hardware devices, and therefore all drivers work inside it. </li><li>  <b>Windows Kernel</b> - the actual host OS kernel. </li></ul><br>  Now consider the virtual machines themselves.  As already mentioned, each virtual machine operates in its own isolated environment, called the partition.  Inside each virtual machine there is a virtualization service client (VSC), which provides the guest OS with the interface of virtual devices and interacts with the parent partition through the VMBus.  If integration components are installed inside the guest OS (all versions of Windows, starting with XP and Server 2003, as well as some versions of Linux - SLES and RHEL), then so-called synthetic devices can be used, that is, virtual devices that have specific Hyper-specific -V functionality  For example, VMQ support with a virtual network adapter, or a virtual SCSI controller.  All of these specific functions are provided by a virtualization service provider (VSP) operating in the parent partition.  It also converts requests from virtual machines, going through VMBus, and redirects them to drivers of physical devices.  If the integration components are not supported by the guest OS, or they have not been installed - emulated devices are used (Legacy Network Adapter, Virtual IDE Controller, etc.).  In this case, VMBus is not used, and the guest OS handles the hypervisor directly through the drivers of the emulated devices.  The hypervisor redirects these requests to device drivers in the parent partition through a virtual machine workflow (VMWP), which is executed not in kernel space, but in user space.  This greatly affects the performance, and therefore it is highly recommended not to use emulated devices.  They can only be used if the guest OS does not support the installation of integration components.  If such OSes (* BSD, unsupported versions of Linux, etc.) are actively used in your organization, you should think about other virtualization platforms, for example, about the same VMware ESX. <br>  There is no other way for virtual machines to interact with each other, with the host OS or with hardware.  This was done for security reasons: virtual machines can interact with the host OS or with each other only via network interfaces, there is no ‚Äúforwarding‚Äù of devices, either USB or PCI.  This is again a double-edged sword: on the one hand, it increases security, but on the other hand, it does not allow the guest OS to use specific devices, such as HASP keys or modems.  Therefore, if you need to use such devices in the guest OS (for example, software from 1C is installed there, requiring the presence of a hardware HASP key to start), you have to use tricks like USB passthrough via a TCP / IP network.  This is done, as a rule, with the help of third-party software. <br>  Memory allocation and processor time is handled by the hypervisor itself.  Unlike VMware ESX, the Hyper-V hypervisor does not contain third-party device drivers and components.  This allows you to reduce the size of the hypervisor itself, and increase its reliability and security.  Guest OS, as already mentioned, do not have direct access to physical processors and interrupts.  It is the hypervisor that acts as a scheduler, allocating the processor time of each partition (including the parent) in accordance with the settings, it is the hypervisor that receives requests for interruptions from partitions and transmits them to physical processors, and the hypervisor allocates memory areas to virtual machines from partitions to physical addresses.  Partitions are managed by the host OS through a so-called hypercall interface.  The user interface for managing the hypervisor is provided by WMI providers through a virtual infrastructure driver (VID). <br><br>  <i>On this, perhaps, the first part I finish.</i>  <i>In the next article, I will discuss how Hyper-V works with storage devices (hard drives, external storage systems, etc.).</i> </div><p>Source: <a href="https://habr.com/ru/post/96822/">https://habr.com/ru/post/96822/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../96815/index.html">Forismatic. Android application</a></li>
<li><a href="../96817/index.html">On the illegitimacy of copyright</a></li>
<li><a href="../96818/index.html">Cardapio is a great replacement for the Ubuntu main menu.</a></li>
<li><a href="../96820/index.html">Rating of domain zones according to Verisign</a></li>
<li><a href="../96821/index.html">Updated free fonts for Linux Libertine, Linux Biolinum, as well as some of the Arkandis Digital Foundry fonts</a></li>
<li><a href="../96823/index.html">First call of Beltelecom</a></li>
<li><a href="../96825/index.html">On the experience of translating the asp.net mvc project to .net 4 (mvc 2)</a></li>
<li><a href="../96826/index.html">Microsoft BizSpark a year and a half after the start - reviews from</a></li>
<li><a href="../96827/index.html">Configure client certificate authentication in IIS using OpenSSL</a></li>
<li><a href="../96828/index.html">CSS3 in IE 6-8 at any cost</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>