<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Adaptation programs for the ZX Spectrum to TR-DOS with modern tools. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In contrast to modern computers, on the spectra of the concept of the file system was not as such. This means that loading from each type of media req...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Adaptation programs for the ZX Spectrum to TR-DOS with modern tools. Part 1</h1><div class="post__text post__text-html js-mediator-article"><p>  In contrast to modern computers, on the spectra of the concept of the file system was not as such.  This means that loading from each type of media required a separate implementation and in most cases the program could not be simply copied from tape to diskette.  In cases where the program loader was written in BASIC, it could be adapted to TR-DOS with a fairly simple refinement.  However, the situation was complicated by the fact that in many games (both branded and hacked), the loaders were written in machine codes and sometimes contained copy protection. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/d31/cb0/62d/d31cb062dbd020dbb43d9379fc640042.jpg" alt="5.25 &quot;Floppy"></p><br><p>  Despite the presence of a ‚Äúmagic button‚Äù that simply made a complete dump of the computer‚Äôs memory and made it possible to at least save the program to a floppy disk, it was considered by experts to create disk versions of games while preserving the original boot image and other attributes. </p><br><p>  In this article I will tell you how to perform such an adaptation on the example of the game <a href="http://www.worldofspectrum.org/infoseekid.cgi%3Fid%3D0003581">Pac-Man</a> , namely, the original image of <a href="">Pac-Man.tzx</a> . </p><a name="habracut"></a><br><h2 id="instrumenty">  Instruments </h2><br><p>  Despite the fact that in the old days all such work was done directly on the ZX Spectrum (for the lack of other options), I will adapt the game using the emulator and command line utilities.  The main reason is that, especially at first, the adaptation process consists of a large amount of trial and error, and it is much less painful if it is automated.  All the same can be done directly on the Spectrum. </p><br><p>  In the first part we will use the following tools: </p><br><ol><li>  Emulator <a href="https://sourceforge.net/projects/fuse-emulator/">Fuse</a> for debugging and testing. </li><li>  <a href="http://skoolkit.ca/">SkoolKit</a> to disassemble. </li></ol><br><h2 id="otklyuchenie-avtozapuska-v-zagruzchike">  Disable autorun in bootloader </h2><br><p>  Since the image and data file is loaded without a header block (17 bytes with the name and file type), this means that the loader is written in machine code.  It is necessary to find where these codes are located and from which address they are launched. </p><br><p>  There are several ways to look at the bootloader code: </p><br><ol><li><p> The easiest way is to start downloading the program, wait until the loader starts up, and stop it by pressing the <code>Space</code> key.  In many cases it works, but in the case of Pacman, as in many others, it causes a reset. </p><br></li><li><p>  The next way is to load a program using <code>MERGE ""</code> instead of <code>LOAD ""</code> .  Unlike <code>LOAD</code> , <code>MERGE</code> ignores program autorun.  In the case of Pac-Man, downloading via <code>MERGE</code> causes the computer to freeze with a characteristic screen shift to the left.  This is due to the fact that instead of running the program line by line, <code>MERGE</code> tries to parse it entirely and merge it with the already loaded program.  However, if the program has a block with machine codes that violates the syntax of the program, this leads to a failure. </p><br></li><li><p>  If you do not want to puzzle, you can convert the tape image from TZX to TAP and use the <code>listbasic</code> utility that comes with Fuse: </p><br><pre> <code class="plaintext hljs">$ tzx2tap Pac-Man.tzx $ listbasic Pac-Man.tap 1 RANDOMIZE USR (PEEK 23635+256*PEEK 23636+91)</code> </pre> <br><p>  Address <code>23635</code> ( <code>$5C53</code> ) corresponds to the system variable <a href="https://skoolkid.github.io/rom/asm/5C53.html"><code>PROG</code></a> , which contains the starting address of the BASIC area.  Thus, the entry point into the bootloader is shifted by 91 bytes relative to the BASIC area. </p><br></li><li><p>  Another way to look at the bootloader is described in the article <a href="http://cantinhotk90x.blogspot.com/2012/06/desativando-autoexecucao-de-um-programa.html">Desativando a autoexecu√ß√£o de um programa BASIC</a> .  In <a href="http://manpages.ubuntu.com/manpages/bionic/man1/fuse.1.html">the Fuse debugger,</a> you need to set the breakpoint <code>br 2053</code> , load the program, and when the download is finished and the code is interrupted, write <code>set 23619 128</code> .  This will prevent the autorun of the program and allow you to go to BASIC. </p><br></li></ol><br><h2 id="dizassemblirovanie-zagruzchika">  Bootloader disassembly </h2><br><p>  Knowing the offset of the entry point relative to the area of ‚Äã‚ÄãBASIC, you can calculate its absolute address.  In the case of the ZX Spectrum 48K without a loaded TR-DOS, the BASIC area starts at address <code>23755</code> ( <code>$5CCB</code> ).  Therefore, the bootloader will start at address <code>23755 + 91 = 23846</code> ( <code>$5D26</code> ). </p><br><p>  To get started, just put a breakpoint at the starting address and look at the machine codes.  In Fuse, you can make <code>br 23846</code> and start downloading the program.  As soon as the bootloader starts executing, the emulator will stop: </p><br><p><img src="https://habrastorage.org/webt/g7/8k/ih/g78kihkxufy7bakgg9qey9a0d7c.png" alt="Debugger"></p><br><p>  In the case when the bootloader is quite simple, just look at the disassembled code in the middle panel and understand what is being loaded to.  Usually, the code for downloading a headless file looks like this: </p><br><pre> <code class="plaintext hljs">LD IX, $8000 ;    LD DE, $4000 ;    LD A, $FF ;    CALL $0556 ;  LD-BYTES JP $8000 ;   </code> </pre> <br><p>  In a more complicated case with the execution of the code, you need to understand the steps and make notes.  The <a href="http://skoolkit.ca/">SkoolKit toolkit is</a> well suited for this.  If you set a goal, with its help, the game can be disassembled to the last screw (message, sprite, sound).  How this is done is described in detail in the <a href="https://skoolkit.readthedocs.io/en/v7.1/diy.html">documentation</a> . </p><br><p>  In short, do the following: </p><br><ol><li>  Make snapshot of <code>Pac-Man.z80</code> computer memory using <code>tap2sna.py</code> or emulator features. </li><li>  Create a control file <code>Pac-Man.ctl</code> with an initial set of instructions for disassembling: <br><pre> <code class="plaintext hljs">i 16384 Ignore for now c $5D26 Loader</code> </pre> </li><li>  Start disassembling: <code>sna2skool.py -H -c Pac-Man.ctl Pac-Man.z80 &gt; Pac-Man.skool</code> . </li><li>  During the study of the code, add new instructions and comments to the control file. </li><li>  Repeat until complete enlightenment. </li></ol><br><p>  As a result, after the first pass we get the following (my comments, addresses are omitted): </p><br><pre> <code class="plaintext hljs">ORG $5D26 ;   23846,   ;   DI IM 1 ;   LD D, IYh ; LD E, IYl ; LD B, $25 ;    EX DE, HL ; LD DE, $0019 ; ADD HL, DE ;    HL  $5C53 (  PROG) LD E, (HL) ;   PROG  DE  IX INC HL ; LD D, (HL) ; LD IXh, D ; LD IXl, E ; LD A, (IX+$7F) ;      (  $7F-  ;  PROG) LD HL, $0035 ;    ($35   PROG) ADD HL, DE ; PUSH HL ;      XOR (HL) ;    LD (HL), A ; INC HL ; DJNZ $5D43 ;   AND (HL) ; RET NZ ;           ;    DEFB $77</code> </pre> <br><h2 id="rasshifrovka-zagruzchika">  Bootloader decryption </h2><br><p>  All that really matters is that the decrypted bootloader is located at <code>PROG + $35</code> .  This means that if we set the breakpoint <code>br 23808</code> , then by that time the decryption is already done, we will see the decrypted bootloader: </p><br><p><img src="https://habrastorage.org/webt/to/qq/4b/toqq4bfw1kqi5vzbmbvzmlno0e8.png" alt="Loader"></p><br><p>  This program is much more similar to the typical case mentioned above.  The registers <code>IX</code> and <code>DE</code> load the value <code>$4000</code> ( <code>16384</code> ), do something else and transfer control to the ROM subroutine at <code>$055A</code> (this is a few bytes lower than the standard entry point in <a href="https://skoolkid.github.io/rom/asm/0556.html"><code>LD-BYTES</code></a> ).  It seems that this approach implements some kind of copy protection, because  The standard procedure does not load this file and some copiers do not understand it. </p><br><h2 id="tochka-vhoda-v-programmu">  Entry Point </h2><br><p>  It remains to figure out how the program is called after the download.  Instead of the usual <code>CALL LD-BYTES</code> and <code>JP</code> , <code>LD SP, XXXX</code> and <code>JP LD-BYTES</code> are used here.  The first (usual) version works as follows: </p><br><ol><li>  <code>CALL</code> pushes the current value of the software counter ( <code>PC</code> ) on the stack. </li><li>  Control is transferred to the called subroutine. </li><li>  When returning from a subroutine ( <code>RET</code> ), the value is removed from the stack and the transition to the calling program occurs. </li></ol><br><p>  Why is it done differently?  The fact is that Pac-Man is compatible with the ZX Spectrum 16K and occupies absolutely all RAM (see file size above).  Thus, while loading, the program erases both the loader and the stack, wherever they are.  If we wanted to go from the ROM to the bootloader using the stack and then call the loaded program via <code>JP</code> , at the time of the download completion, there would no longer be an address for the <code>JP</code> or the instruction itself in memory. </p><br><p>  Instead, the stack pointer moves to the memory area where after loading the address of the program entry point will appear, and the processor, not noticing the substitution, removes it from the stack using the new pointer and proceeds to the specified address. </p><br><p>  The complete <a href="https://github.com/morozov/pacman/tree/master/skool">disassembly result</a> can be viewed in <a href="https://github.com/morozov/pacman">the project repository</a> on the github. </p><br><h2 id="itogo">  Total </h2><br><p>  As a result of studying the bootloader, we found the following: </p><br><ol><li>  A headless file with a length of 16384 bytes is loaded at 16384 (into the screen area, which is obvious in the boot process). </li><li>  After the download is complete, the stack pointer is located at <code>$5D7C</code> , where control is transferred. </li></ol><br><p>  In the following sections, I‚Äôll tell you how to prepare files for writing to disk and write a monoblock file loader in assembler. </p><br><h3 id="ssylki-po-teme">  Related Links: </h3><br><ol><li>  <a href="https://zxrainbow.wordpress.com/">Proflutey "TRU Spectrumist</a> . <a href="https://zxrainbow.wordpress.com/">"</a> </li><li>  <a href="https://mrcook.uk/reverse-engineering-zx-spectrum-games">Reverse engineering ZX Spectrum (Z80) games</a> . </li><li>  <a href="http://cantinhotk90x.blogspot.com/2012/07/adaptacao-de-jogos-de-fita-para-beta-48.html">Adapta√ß√£o de jogos de fita para Beta 48</a> . </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/451174/">https://habr.com/ru/post/451174/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../451150/index.html">Catch Me If You Can. Manager Version</a></li>
<li><a href="../451160/index.html">Apache Kafka and Stream Processing with Spark Streaming</a></li>
<li><a href="../451162/index.html">Correction of errors - physical constants in the present and new versions of the International System of Units (SI)</a></li>
<li><a href="../451166/index.html">What will the new storages for AI and MO systems offer?</a></li>
<li><a href="../451170/index.html">Jeff Bezos announced plans to conquer the moon</a></li>
<li><a href="../451176/index.html">News from the world of OpenStreetMap ‚Ññ458 (04/23/2019-29.04.2019)</a></li>
<li><a href="../451178/index.html">Accident when testing the Crew Dragon parachute landing system</a></li>
<li><a href="../451186/index.html">LINSTOR repository and its integration with OpenNebula</a></li>
<li><a href="../451196/index.html">Separation of customer profiles and freelancer</a></li>
<li><a href="../4512/index.html">Google is interested in weddings</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>