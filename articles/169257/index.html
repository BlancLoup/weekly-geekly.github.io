<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a virtual wave</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As everyone knows, 71% of the Earth‚Äôs surface is water. Unfortunately or fortunately, units are able to correctly depict the ocean. Ivan Aivazovsky en...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a virtual wave</h1><div class="post__text post__text-html js-mediator-article"><img title="7" src="https://habrastorage.org/storage2/e9b/ad8/af5/e9bad8af56d5b4796991868ce25d9e70.jpg" width="730" height="388"><br><br>  As everyone knows, 71% of the Earth‚Äôs surface is water.  Unfortunately or fortunately, units are able to correctly depict the ocean.  Ivan Aivazovsky entered painting books thanks to seascapes alone.  In computer games it is still more difficult.  Once upon a time, the sea in them was designated as a cluster of blue pixels painted with white squares of foam.  Over time, the virtual seas have become more like pictures of the holidays, learned to swing a wave and become covered in ripples, which sometimes even reflected the outlines of sailing ships.  But they remained an independent element: bumping into the shore, the wave turned into plain angular polygons.  This surf logically interacts with the beach, moisturizes the sand and rolls back with a rustling sound.  This likelihood was achieved only in modern games.  Including in our Skyforge.  And although the main events will unfold on land, players will get to tropical islands and noisy ports.  Water will be constantly near.  Her ‚Äúright‚Äù look will play a big role.  And the re-creation of the sea element is a serious mathematical task.  I'll tell you about the stages of its implementation. <a name="habracut"></a><br><br>  <strong>Engine features</strong> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The graphics engine [a module of a game or other graphics software that is responsible for rendering] Skyforge uses deferred shading technology (see Figure 1): this means that the scene is rendered in two stages.  First, there is an intermediate recording in the so-called G-buffer: the specular emission (a) and albedo (b) components of the material of the object are recorded in separate textures, the depth buffer [buffer, in which instead of color the depth value for each point of the scene is recorded] (c) and normals (g).  Then, for each light source, the illumination of the final scene is calculated using information from G-buffer (e). <br><br><img title="2" src="https://habrastorage.org/storage2/ddf/f17/652/ddff17652cd4c911022db6038ae7915e.jpg" width="730" height="322"><br><br><img title="3" src="https://habrastorage.org/storage2/a73/be8/b63/a73be8b6367525f78f5ed157b9b69ad6.jpg" width="730" height="322"><br><br>  <em>Picture 1.</em> <br><br>  Deferred shading allows you to illuminate the scene with a much larger number of light sources than with traditional visualization in one pass.  However, the approach has limitations: for example, it does not allow to correctly visualize a semi-transparent geometry.  In such cases, usually all non-transparent objects are visualized in the first pass using deferred shading (aka deferred pass), and the rest in the second pass using the standard lighting algorithm (aka forward pass). <br><br>  In Skyforge, water is visualized between deferred and forward pass (d).  On the one hand, this allows you to get the necessary information about the depth and light, necessary, for example, to calculate the refraction and reflection from water.  On the other hand, effects that require the correct value in the depth buffer (for example, soft particles) interact correctly with water. <br><br>  <strong>A little about the geometry of the water and lighting models</strong> <br><br>  As a geometric model, we use a polygonal mesh [a method of representing three-dimensional objects, in which a surface consisting of polygons (triangles) is used to approximate a surface] with non-uniform detail.  Figure 2 shows a polygonal grid of water (a) and the corresponding visualization result (b).  The grid detail increases inversely with the distance from the water point to the camera.  Waves (deep and surf) are modeled by the displacement of the grid vertices along the vertical axis. <br><br><img title="four" src="https://habrastorage.org/storage2/300/034/75d/30003475d3e2228df1ba83ac28494e50.jpg" width="730" height="607">  <em>Figure 2.</em> <br><br>  After calculating the surface of the water is its lighting.  We use the lighting model, which takes into account the following factors (Fig. 3): <br>  ‚Ä¢ reflection of light from the water surface (a); <br>  ‚Ä¢ a glare from an analytical light source (b); <br>  ‚Ä¢ foam (in); <br>  ‚Ä¢ subsurface scattering of light (g); <br>  ‚Ä¢ light absorption by depth (d); <br>  ‚Ä¢ refraction of light in the water column (e); <br>  ‚Ä¢ caustics [light spots formed on one surface due to refraction or reflection from another surface] from the light source at the bottom (g). <br><br><img title="five" src="https://habrastorage.org/storage2/9e5/48b/251/9e548b251f641363dbe5c5649204459d.jpg" width="730" height="347"><br><br><img title="6" src="https://habrastorage.org/storage2/5f6/ded/b90/5f6dedb900c953a98b929125a0a927ab.jpg" width="730" height="388"><br><br><br><img title="7" src="https://habrastorage.org/storage2/e9b/ad8/af5/e9bad8af56d5b4796991868ce25d9e70.jpg" width="730" height="388"><br><br>  <em>Figure 3</em> . <br><br>  <strong>Surf simulation</strong> <br><br>  Simplistically, the surf is the waves rolling on the shore.  In order to create waves moving in a certain direction, we used the equation of a traveling wave: <br><br><img title="eight" src="https://habrastorage.org/storage2/1b4/e4a/3ee/1b4e4a3eec1907988ca5b9f93e7a1e2d.png" width="416" height="63"><br><br>  where A (z, t) is the wave amplitude, k is the wavenumber, œÜ is the phase, z is the coordinate along which the wave runs.  An example of such a wave (with a constant amplitude) is shown in Figure 4. With time and phase, everything is more or less clear, but how to make these waves run to the coast at each point? <br><br><img title="9" src="https://habrastorage.org/storage2/6ae/9a8/365/6ae9a8365883cb533a4f62e143f82c24.gif" width="576" height="432"><br><br>  <em>Figure 4.</em> <br><br>  To do this, we set the z value from the distance field.  The distance field is a scalar field whose value at each point is equal to the distance to a given ‚Äúobstacle‚Äù.  In our case, the ‚Äúobstacle‚Äù is a landscape that is above sea level.  We calculate the distance field in advance and load the map into the texture when loading the map. <br><br>  If we try our method in action, the result will be completely different from reality (Fig. 5a).  The problem is that the waves everywhere go in the same continuous front: the parameter z changes only from the coast, therefore on the isolines of the distance field the wave height h (z, t) will be the same.  We solved this problem by creating a mask (5b), which is multiplied by the amplitude of the waves: <br><br><img title="ten" src="https://habrastorage.org/storage2/7ec/930/6d8/7ec9306d8c21845c61ef3bb91ce2e8a5.png" width="519" height="63"><br><br>  where x, y are the coordinates, Œº is a coefficient determining the length of the wave segments, œë is the rate of appearance / disappearance of waves in a given front. <br><br>  This mask smoothly changes in time so that the distribution of the waves is uniform.  A second wave front is also generated, differing from the first only by the choice of phase œÜ '.  In addition, the waves smoothly appear at depth and smoothly disappear, reaching the coast - this is achieved by choosing the function A (z, t). <br><br>  Thus, we have obtained a formula by which at any point of the ocean we can find out the amplitude of the wave incident on the shore (5c).  This allows you to perform the entire calculation of the surf wave geometry in the vertex shader [program running on the graphics accelerator for each vertex of the polygon mesh of the object] GPU. <br><br><img title="eleven" src="https://habrastorage.org/storage2/2d2/9db/36d/2d29db36d9cf60aa8ebb7bbb26c6a1c1.jpg" width="730" height="388"><br><br>  <em>Figure 5</em> . <br><br>  <strong>Waveform</strong> <br><br>  Real waves are not sinusoidal.  When approaching the coast, the waves become more and more asymmetrical: a lamb gathers in front, and a gentle train pulls up behind.  Finally, the upper part of the wave begins to hang over the lower, the wave breaks and splashes out onto the shore. <br><br>  We achieve the effect of asymmetry and overhanging of the upper part above the lower one by displacing the wave tops towards the coast in a horizontal plane: the higher the top above the water surface, the more it shifts.  You can find the direction vector to the coast by taking the gradient from the distance field.  In Figure 6, the dotted line shows such a transformation applied to a sine wave. <br><br><img title="12" src="https://habrastorage.org/storage2/213/bbf/aef/213bbfaef1189e2f31ebb8c8d8dd39a5.jpg" width="730" height="143"><br><br>  <em>Figure 6</em> . <br><br>  Gradients are computed in advance and are written to the distance field texture to reduce the number of samples from the texture in the vertex shader. <br>  <strong>Foam</strong> <br><br>  Another integral part of the surf is foam.  It appears on the crest of the waves and when the waves roll onto the shore.  After the wave broke on the shore, the foam rolls back to meet the next wave. <br><br>  To create these effects, we had to use different techniques.  Imitations of movement to the coast and from it are simulated by scrolling texture coordinates [position in the texture, from where you need to take the value for a given vertex / pixel] along the vector of the gradient of the distance field (and, respectively, in the opposite direction).  However, if at each point the texture coordinates are constantly shifted, texture pulls are formed due to the unevenness of such shifts.  We solve this problem in the following way: two antiphase textures are scrolled, with each sample interpolation occurs.  As soon as one of the texture shifts more than a period, it is reset - while its interpolation coefficient is 0, so it goes unnoticed. <br><br>  Foam on the wave is also distributed asymmetrically.  There is no foam in front of the wave, it is very bright on the crest of the wave, and behind it there is a smoothly fading plume behind.  To do this, we use the following formula for foam intensity (remember to bring the argument to the correct range): <br><br><img title="f" src="https://habrastorage.org/storage2/a1a/c46/fec/a1ac46fecbb2ff8015818e018d021eba.jpg" width="269" height="35"><br><br>  All parameters, except the phase, coincide with the parameters of the wave.  Phase can be slightly shifted to achieve the desired effect. <br><br>  Behind the oncoming wave the foam runs forward.  In our case, it is rather difficult to simulate the geometric wave rollback: the traveling wave equation and the grid topology will be violated.  We simulate this effect by imposing near the shore in front of the oncoming wave a foam scrolling towards the wave. <br>  Wet surfaces <br><br>  Without the effect of wet sand on the shore, the water looks unnatural, separate from the landscape.  When wet the sand darkens and begins to shine. <br><br>  Solution to the forehead: manually tint the coastal zones with darker sand.  However, this solution has drawbacks: there will be no glare on this sand, the resolution of the painting will be low, additional work of level designers will be required. <br><br><img title="13" src="https://habrastorage.org/storage2/36c/943/c64/36c943c64f77362cca69b50bbc114632.jpg" width="730" height="257"><br><br><br><br><br><br>  <em>Figure 7</em> . <br><br>  We implement this as follows.  Near the shore, the surface of the water rises slightly above the level of the landscape, as if creating a ‚Äúthin film‚Äù above (see Fig. 7).  Then, when calculating the refraction, the actual color of the landscape is slightly shaded, and a highlight is superimposed on top.  Figure 8 shows the effect of the wet sand effect on the final picture. <br><br><img title="14" src="https://habrastorage.org/storage2/f64/771/d3a/f64771d3a27661c4aea5a8b8f3b371a0.jpg" width="730" height="458"><br><br>  <em>Figure 8</em> . <br><br>  Thank you for attention.  I spoke about the intricacies of creating the water element only in general terms.  In fact, there are a thousand details and trivia.  Together they create an excellent water element.  I can say honestly, I am proud of our surf.  It is easy to check.  Peer at the screenshot. <br><br><img title="15" src="https://habrastorage.org/storage2/998/f9e/468/998f9e468c27a3119f6303365e77ff3d.jpg" width="730" height="387"><br>  <strong>Sea of ‚Äã‚Äãsolutions</strong> <br><br>  1. How do circles from a floating person diverge?  Does foam happen?  To understand this, we need references - examples from life.  We watched for hours on YouTube videos in which children are splashing at the shore or some guys climb on each other‚Äôs shoulders and jump into the water with a bomb.  Every month we were asked to send us on an expedition to the sea - of course, only to gather facts!  The authorities laughed, but ignored the requests. <br><br>  2. We wanted the waves to flow naturally on the shore.  But the shore can be of any shape.  In the north of the huge island, the waves will come from the north, to the south - from the south ... How to take all this into account?  We calculated for each point of the ocean a distance field - the distance and vector to the nearest point of the coast.  A wave runs along it. <br><br>  3. Foam - an integral part of the surf.  It appears on the crest of the waves and when the waves roll onto the shore.  After the wave broke on the shore, the foam rolls back to meet the next wave.  To create a convincing foam, I had to suffer a lot - using techniques like scrolling texture coordinates along the gradient field vector of distances, solving the problem of texture pulling and creating other black magic. <br><br>  4. When wet, the sand darkens and begins to shine.  Without this effect, the surf looks unnatural.  At first we wanted to tint the coastal areas manually with darker sand, but, firstly, it complicated the work of designers, and secondly, there is no glare on this sand.  They came to an elegant solution: on the shore, the water creates a thin film, shading the real color of the landscape, and a sunshine is superimposed on top. <br><br>  <strong>Literature</strong> <br><br>  [1] E. Darles, B. Crespin, D. Ghazanfarpour, JC Gonzato.  A Survey of Ocean Simulation and Rendering Techniques in Computer Graphics.  <a href="http://arxiv.org/PS_cache/arxiv/pdf/1109/1109.6494v1.pdf">Link</a> <br><br>  [2] Tiago Sousa.  Crysis Next Gen Effects.  GDC 2008. <a href="http://www.crytek.com/download/GDC08_SousaT_CrysisEffects.ppt">Link</a> <br><br>  [3] Carlos Gonzalez-Ochoa.  Water Technology of Uncharted.  GDC 2012. <br><br>  [4] Brano Kemen.  Ocean Rendering in Outerra.  <a href="http://outerra.blogspot.com/2011/02/ocean-rendering.html">Link</a> <br><br>  [5] Mike Seymour.  Assassin's Creed III: The ech behind (or beneath) the action.  <a href="http://www.fxguide.com/featured/assassins-creed-iii-the-tech-behind-or-beneath-the-action/">Link</a> <br><br>  <strong>Thanks</strong> <br>  I would like to thank the Skyforge team, without which this article would not exist, and, in particular, Alexey Kuleshov, Vladimir Egorov, Sergey Makeev, Victor Surkov and Sergey Nazarov. <br><br>  <em>Peter Sikachev,</em> <br><br>  <em>Skyforge graphic programmer.</em> <br><br>  <em>You can find the original article and other useful information on the <a href="http://skyforge.ru/">Skyforge</a> developers website.</em> </div><p>Source: <a href="https://habr.com/ru/post/169257/">https://habr.com/ru/post/169257/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../169245/index.html">How I decide tickets</a></li>
<li><a href="../169249/index.html">A mini-game with head position tracking or how I met headtrackr.js</a></li>
<li><a href="../169251/index.html">Diskless booting using PXE and iSCSI using Ubuntu as an example</a></li>
<li><a href="../169253/index.html">Moving from Flash to Edge - comparing the two platforms for creating animation</a></li>
<li><a href="../169255/index.html">Listick.ru - online notes service</a></li>
<li><a href="../169259/index.html">Small, aluminum and touch. Acer Aspire S7 11 inch review</a></li>
<li><a href="../169261/index.html">Simple helpdesk</a></li>
<li><a href="../169263/index.html">How to promote a new site?</a></li>
<li><a href="../169265/index.html">jQuery: A tree-like memory menu, the ability to add sublevels</a></li>
<li><a href="../169267/index.html">What is RTB: new technologies of online advertising</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>