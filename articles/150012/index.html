<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using Dynamic Data with Entity Framework 5</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! 

 As you know, the release version of .NET Framework 4.5 has already been released, and the final version of Visual Studio 2012 has also be...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using Dynamic Data with Entity Framework 5</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/f8c/0d1/c52/f8c0d1c52dccac96ecf475012ee0c9e5.jpg"><br><br>  Good day! <br><br>  As you know, the release version of <a href="http://www.microsoft.com/net">.NET Framework 4.5</a> has already been released, and the final version of <a href="http://www.microsoft.com/visualstudio/11/en-us">Visual Studio 2012</a> has also become available for download. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I managed to get acquainted with the new Visual Studio from the beta version, and after the release I started using Visual Studio and .NET Framework 4.5 rtm release in real work. <br>  The new version of the .NET Framework also includes a new version of the Entity Framework.  Already the fifth.  More precisely, it does not quite go in there ‚Äî when I create a project, the files are loaded from the NuGet repository.  But in any case, the new project uses exactly version 5 of the library. <br><br>  Before continuing, I want to briefly tell you what's new in EF5 and why I decided to start using this version. <br><a name="habracut"></a><br><h4>  What's new in Entity Framework 5.0 </h4><br><ul><li>  Significant increase in productivity - up to 67%. </li><li>  Support for properties of type enum, which is available for use in all approaches: Model, Database and Code First. </li><li>  Support spatial data types using DbGeography and DbGeometry types.  They are also available in the Model, Database and Code First approaches. </li><li>  When generating code, Visual Studio Editor will now use the default DbContext as the base class for new models.  This means that any new models created with the EF constructor will create default classes derived from DbContext and POCO.  With this, it remains possible to return to generating code based on an ObjectContext if necessary.  Existing models will not automatically change in generation DbContext code. </li><li>  Functions can now return user tables when using the Database First approach. </li></ul><br>  This is not a complete list, but these opportunities have interested me quite strongly. <br>  More details about innovations can be found <a href="http://blogs.msdn.com/b/adonet/archive/2012/08/15/ef5-released.aspx">here</a> . <br><br><h4>  The essence of the task </h4><br>  In many of my projects for data management, I use a solution based on ASP.NET Dynamic Data (how exactly this solution can be applied, and in general, tools that implement scaffolding technology ‚Äî <a href="http://habrahabr.ru/post/141207/">I wrote earlier</a> ).  As already mentioned, the new version of the Entity Framework, even when using Database First mode, now generates a context based on the <a href="http://msdn.microsoft.com/en-us/library/system.data.entity.dbcontext.aspx">DbContext</a> class, rather than the <a href="http://msdn.microsoft.com/en-us/library/system.data.objects.objectcontext.aspx">ObjectContext</a> , as it was before.  Dynamic Data assumes that ObjectContext is used as the base context class. <br><br>  In this regard, for the correct operation of Dynamic Data, it was necessary to slightly change the context initialization and the work of some controls.  I found a very good article on this subject in the <a href="http://blogs.msdn.com/b/webdev/archive/2012/08/15/using-dynamic-data-with-entity-framework-dbcontext.aspx">blog Pranava Rastogi</a> , <br><br>  I think that this information is useful to those who use Dynamic Data and plans to switch to a new version of the Entity Framework. <br><br><h4>  Configuring ASP.NET Dynamic Data to interact with a DbContext based context </h4><br>  In order for Dynamic Data to work correctly with the new format, you need to take three simple steps. <br><br><h5>  1. Change the Global.asax code in the project root </h5><br><pre><code class="cs hljs">DefaultModel.RegisterContext(() =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((IObjectContextAdapter)<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> YourContextType()).ObjectContext; }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ContextConfiguration() { ScaffoldAllTables = <span class="hljs-literal"><span class="hljs-literal">true</span></span> });</code> </pre> <br><br><h5>  2. Change the ManyToMany.ascx.cs control code in the Dynamicdata \ Fieldtemplates directory </h5><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnDataBinding</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnDataBinding(e); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> entity; ICustomTypeDescriptor rowDescriptor = Row <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ICustomTypeDescriptor; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowDescriptor != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Get the real entity from the wrapper entity = rowDescriptor.GetPropertyOwner(null); } else { entity = Row; } // Get the collection and make sure it's loaded var entityCollection = Column.EntityTypeProperty.GetValue(entity, null); var realEntityCollection = entityCollection as RelatedEnd; if (realEntityCollection != null &amp;&amp; !realEntityCollection.IsLoaded) { realEntityCollection.Load(); } // Bind the repeater to the list of children entities Repeater1.DataSource = entityCollection; Repeater1.DataBind(); } public override Control DataControl { get { return Repeater1; } }</span></span></code> </pre><br><br><h5>  3. Change the ManyToMany_Edit.ascx.cs control code in the Dynamicdata \ Fieldtemplates directory </h5><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ObjectContext ObjectContext { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Page_Load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Register for the DataSource's updating event EntityDataSource ds = (EntityDataSource)this.FindDataSourceControl(); ds.ContextCreated += (_, ctxCreatedEnventArgs) =&gt; ObjectContext = ctxCreatedEnventArgs.Context; // This field template is used both for Editing and Inserting ds.Updating += DataSource_UpdatingOrInserting; ds.Inserting += DataSource_UpdatingOrInserting; } void DataSource_UpdatingOrInserting(object sender, EntityDataSourceChangingEventArgs e) { MetaTable childTable = ChildrenColumn.ChildTable; // Comments assume employee/territory for illustration, but the code is generic if (Mode == DataBoundControlMode.Edit) { ObjectContext.LoadProperty(e.Entity, Column.Name); } // Get the collection and make sure it's loaded dynamic entityCollection = Column.EntityTypeProperty.GetValue(e.Entity, null); // Go through all the territories (not just those for this employee) foreach (dynamic childEntity in childTable.GetQuery(e.Context)) { // Check if the employee currently has this territory var isCurrentlyInList = ListContainsEntity(childTable, entityCollection, childEntity); // Find the checkbox for this territory, which gives us the new state string pkString = childTable.GetPrimaryKeyString(childEntity); ListItem listItem = CheckBoxList1.Items.FindByValue(pkString); if (listItem == null) continue; // If the states differs, make the appropriate add/remove change if (listItem.Selected) { if (!isCurrentlyInList) entityCollection.Add(childEntity); } else { if (isCurrentlyInList) entityCollection.Remove(childEntity); } } } private static bool ListContainsEntity(MetaTable table, IEnumerable&lt;object&gt; list, object entity) { return list.Any(e =&gt; AreEntitiesEqual(table, e, entity)); } private static bool AreEntitiesEqual(MetaTable table, object entity1, object entity2) { return Enumerable.SequenceEqual( table.GetPrimaryKeyValues(entity1), table.GetPrimaryKeyValues(entity2)); } protected void CheckBoxList1_DataBound(object sender, EventArgs e) { MetaTable childTable = ChildrenColumn.ChildTable; // Comments assume employee/territory for illustration, but the code is generic IEnumerable&lt;object&gt; entityCollection = null; if (Mode == DataBoundControlMode.Edit) { object entity; ICustomTypeDescriptor rowDescriptor = Row as ICustomTypeDescriptor; if (rowDescriptor != null) { // Get the real entity from the wrapper entity = rowDescriptor.GetPropertyOwner(null); } else { entity = Row; } // Get the collection of territories for this employee and make sure it's loaded entityCollection = (IEnumerable&lt;object&gt;)Column.EntityTypeProperty.GetValue(entity, null); var realEntityCollection = entityCollection as RelatedEnd; if (realEntityCollection != null &amp;&amp; !realEntityCollection.IsLoaded) { realEntityCollection.Load(); } } // Go through all the territories (not just those for this employee) foreach (object childEntity in childTable.GetQuery(ObjectContext)) { // Create a checkbox for it ListItem listItem = new ListItem( childTable.GetDisplayString(childEntity), childTable.GetPrimaryKeyString(childEntity)); // Make it selected if the current employee has that territory if (Mode == DataBoundControlMode.Edit) { listItem.Selected = ListContainsEntity(childTable, entityCollection, childEntity); } CheckBoxList1.Items.Add(listItem); } } public override Control DataControl { get { return CheckBoxList1; } }</span></span></code> </pre><br><br>  After the changes you have made, Dynamic Data will continue to work as if nothing has happened and you can continue to enjoy the development process. <br><br><hr><br><h4>  Sources </h4><br>  Below is a list of links on the topic of the article.  I hope they will be useful. <br><br><ul><li>  <a href="http://blogs.msdn.com/b/webdev/archive/2012/08/15/using-dynamic-data-with-entity-framework-dbcontext.aspx">blogs.msdn.com/b/webdev/archive/2012/08/15/using-dynamic-data-with-entity-framework-dbcontext.aspx</a> </li><li>  <a href="http://msdn.microsoft.com/ru-RU/data/ef">msdn.microsoft.com/en-RU/data/ef</a> </li><li>  <a href="http://blogs.msdn.com/b/adonet/archive/2012/08/15/ef5-released.aspx">blogs.msdn.com/b/adonet/archive/2012/08/15/ef5-released.aspx</a> </li><li>  <a href="http://andrey.moveax.ru/news/2012-05-17/entity-framework-5-0-release-candidate/">andrey.moveax.ru/news/2012-05-17/entity-framework-5-0-release-candidate</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/150012/">https://habr.com/ru/post/150012/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150006/index.html">How does UniSender antispam work?</a></li>
<li><a href="../150007/index.html">How do you feel about anime?</a></li>
<li><a href="../150008/index.html">Apple has patented a device for hiding (ignoring) advertising</a></li>
<li><a href="../150009/index.html">Purchases within applications depend on the number of applications and games.</a></li>
<li><a href="../150011/index.html">IT Compote # 19 Programming and Technology Podcast</a></li>
<li><a href="../150014/index.html">Using performance counters in a Windows Azure application</a></li>
<li><a href="../150015/index.html">Geo-module for PHP applications</a></li>
<li><a href="../150019/index.html">Runetology (161): Matthew Lannegrand, General Director of Sapato.ru</a></li>
<li><a href="../150020/index.html">5 facts about the Chinese gaming market</a></li>
<li><a href="../150021/index.html">Practical metametamodeling</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>