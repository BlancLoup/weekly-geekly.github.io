<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automation of measurement of generator harmonic ratio using a digital oscilloscope and MATLAB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In practice, sometimes there is the problem of measuring the harmonic coefficient (Kg) of the signal generator. Such a generator can be both analog an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automation of measurement of generator harmonic ratio using a digital oscilloscope and MATLAB</h1><div class="post__text post__text-html js-mediator-article">  In practice, sometimes there is the problem of measuring the harmonic coefficient (Kg) of the signal generator.  Such a generator can be both analog and digital.  For example, a generator on an operational amplifier, integrated timer (NE555), microcontroller (MK) or programmable logic integrated circuit (FPGA), or digital signal processor (DSP), with output in the form of pulse-width modulation (PWM) or a digital-to-analog signal Converter (DAC).  If it is necessary to form a harmonic signal, a low-pass filter (LPF) is installed at the output of the PWM or DAC, which smoothes the stepped waveform and reduces the Kg.  In general, measurement of Kg allows you to control the operation of both software algorithms and hardware nodes. <br><a name="habracut"></a><br>  Measurement of Kg is possible with the help of various instruments, for example, in the article <a href="http://www.prist.ru/info/articles/kni.htm">‚ÄúMeasurement of the voltage harmonic coefficient of a signal specified in the time domain‚Äù</a> , several options are given for measuring this parameter both with traditional measuring instruments and prospective ones.  But I want to note that these devices are more specialized than, for example, a digital oscilloscope or a multimeter.  Therefore, not every engineer or radio amateur will dare to purchase such a device. <br>  In order to understand how to measure Kg with the help of improvised tools, one should look at its formula.  For example, in the article <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D1%258D%25D1%2584%25D1%2584%25D0%25B8%25D1%2586%25D0%25B8%25D0%25B5%25D0%25BD%25D1%2582_%25D0%25BD%25D0%25B5%25D0%25BB%25D0%25B8%25D0%25BD%25D0%25B5%25D0%25B9%25D0%25BD%25D1%258B%25D1%2585_%25D0%25B8%25D1%2581%25D0%25BA%25D0%25B0%25D0%25B6%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B9">‚ÄúNonlinear distortion coefficient‚Äù</a> , the physical meaning of this parameter is described in detail.  A simple formula that uses only the amplitudes of the signal harmonics.  Thus, if we measure the amplitudes of the harmonics of the signal at the generator output, then the solution of the problem of measuring Kg will be reduced to one formula. <br><br>  Digital oscilloscopes may contain the Fast Fourier Transform (FFT) option.  In this case, the oscilloscope switches to FFT measurement mode, and then with the help of markers, the harmonic amplitudes are measured and recorded on a piece of paper. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/34c/8aa/8db/34c8aa8db92041959abe9b736d90f1ae.png" alt="image"></div><br>  It usually happens, but first of all it is a long time.  measurements are made manually.  And, secondly, the duration of the signal sampling, and therefore the FFT frequency resolution, as a rule, is significantly limited.  It‚Äôs another matter if you capture a signal of the desired length using an oscilloscope, for later calculating the spectrum already on your computer. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Most digital oscilloscopes with a remote interface, such as USB or Ethernet, can handle capturing a time sample of the signal and transmitting it to a computer.  And to calculate the Kg on the spectrum, you can choose Matlab.  Moreover, with the Instrument Control Toolbox, remote signal acquisition is performed directly from Matlab. <br><br><pre><code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[osc_data,fs]</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">osc_capture_ds2202</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ds2000</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visa</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">('ni','USB0::0x1AB1::0x04B0::DS2A142900939::INSTR')</span></span></span><span class="hljs-function">; % </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VISA</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">object</span></span></span><span class="hljs-function">. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ds2000</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InputBufferSize</span></span></span><span class="hljs-function"> = 2</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e6</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fopen</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ds2000)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fprintf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ds2000,':CHAN1:BWLimit 20M')</span></span></span><span class="hljs-function">; % </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Set</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BandWidth</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Limit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to</span></span></span><span class="hljs-function"> 20</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MHz</span></span></span><span class="hljs-function">. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fprintf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ds2000,':ACQ:MDEPth 140000')</span></span></span><span class="hljs-function">; % </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Set</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Memory</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Depth</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">from</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">several</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">typical</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">values</span></span></span><span class="hljs-function">. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fs</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">str2double</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(query(ds2000,':ACQ:SRATe?')</span></span></span><span class="hljs-function">); % </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sample</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Rate</span></span></span><span class="hljs-function">. %% </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Setup</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Waveform</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fprintf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ds2000,':STOP')</span></span></span><span class="hljs-function">; % </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Stop</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">oscilloscope</span></span></span><span class="hljs-function">. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fprintf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ds2000,':WAV:SOURce CHAN1')</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fprintf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ds2000,':WAV:MODE RAW')</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fprintf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ds2000,':WAVeform:FORMat ASCII')</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fprintf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ds2000,':WAV:POINts 131072')</span></span></span><span class="hljs-function">; % </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Number</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">of</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">points</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">that</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">must</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">less</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">than</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MDEPth</span></span></span><span class="hljs-function">. </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fprintf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ds2000,':WAV:RESet')</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fprintf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ds2000,':WAV:BEGin')</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pause</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(5)</span></span></span><span class="hljs-function">; % </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Wait</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">the</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">of</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">the</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">acquisition</span></span></span><span class="hljs-function">. %% </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Waveform</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">while</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">status</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">query</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ds2000,':WAV:STATus?')</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pause</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1)</span></span></span><span class="hljs-function">; % </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Not</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">neccesary</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">but</span></span></span><span class="hljs-function">... </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[state,rem]</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strtok</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status,',')</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">len</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strtok</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sscanf(rem,'%s')</span></span></span><span class="hljs-function">,','); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eq</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(len,'0')</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">break</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eq</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(state(1)</span></span></span><span class="hljs-function">,'</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">I</span></span></span><span class="hljs-function">') </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">osc_data</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cell2mat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(textscan(query(ds2000,':WAV:DATA?')</span></span></span><span class="hljs-function">,'%</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-function">','</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delimiter</span></span></span><span class="hljs-function">',',')); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">break</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">else</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">osc_data</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cell2mat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(textscan(query(ds2000,':WAV:DATA?')</span></span></span><span class="hljs-function">,'%</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-function">','</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delimiter</span></span></span><span class="hljs-function">',',')); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fprintf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ds2000,':WAV:END')</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fprintf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ds2000,':RUN')</span></span></span><span class="hljs-function">; % </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">the</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">oscilloscope</span></span></span><span class="hljs-function">. %% </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Delete</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instrument</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fclose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ds2000)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ds2000)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clear</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ds2000</span></span></span><span class="hljs-function">;</span></span></code> </pre> <br>  But before using the method of calculating Kg across the spectrum, one would need to make sure that the oscilloscope is suitable.  According to the study, which can be found in the article <a href="http://www.researchgate.net/publication/260672713_Analytic_Method_for_the_Computation_of_the_Total_Harmonic_Distortion_by_the_Cauchy_Method_of_Residues">‚ÄúAnalytic Method for the Compatibility of the Total Harmonic Distribution‚Äù</a> , Kg of the meander, as well as signals obtained after filtering the meander with filters of various orders, have certain values ‚Äã‚Äãthat case may be standards.  To check you need a generator of rectangular pulses, which must be connected to the oscilloscope. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/610/053/d97/610053d978154f78885933aa0f7e9556.jpg" alt="image"></div><br>  As well as the corresponding filters that can be implemented programmatically using the Signal Processing Toolbox. <br><br><pre> <code class="matlab hljs">clear all clc <span class="hljs-comment"><span class="hljs-comment">%% Signal Acquisition [s,fs] = osc_capture_ds2202(); % s - signal, fs - sample frequency. %% Setup parameters number_of_harmonics = 11; % Number of harmonics (including the fundamenal)... % to use in the THD calculation. L = length(s); % Length of the signal for FFT computing. It is used only for plot. T = 1/fs; t = (0:L-1)*T; s_ac = s-mean(s); % Remove DC level. It is not neccesary for thd function. s_ac = s_ac/max(abs(s_ac)); % Normalize signal. As above for thd. %% Estimate the THD of the signal [thd_dBc,harmpow,harmfreq] = thd(s_ac,fs,number_of_harmonics); thd_perc = 10^(thd_dBc/20)*100 % Convert dB to Percents and display result. figure(2); thd(s_ac,fs); % Plot the Spectrum of the signal. %% Apply Butterworth filter to signal and estimate THD for filtered signal [lpFilter_b_II, lpFilter_a_II] = butter(2,2*harmfreq(1)/fs,'low'); % Design B-II filter. filtII_s_ac = filter(lpFilter_b_II, lpFilter_a_II, s_ac); % Apply B-II filter to signal. thd_perc_BII = 10^(thd(filtII_s_ac,fs,number_of_harmonics)/20)*100 % Convert dB to Percents and display result. figure(3); thd(filtII_s_ac,fs); % Plot the Spectrum of the B-II filter. [lpFilter_b_IV, lpFilter_a_IV] = butter(4,2*harmfreq(1)/fs,'low'); % Design B-IV filter. filtIV_s_ac = filter(lpFilter_b_IV, lpFilter_a_IV, s_ac); % Apply B-IV filter to signal. thd_perc_BIV = 10^(thd(filtIV_s_ac,fs,number_of_harmonics)/20)*100 % Convert dB to Percents and display result. figure(4); thd(filtIV_s_ac,fs); % Plot the Spectrum of the B-IV filter.</span></span></code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c0d/c90/d3e/c0dc90d3e38e4e6aa55a044bcf423f16.png" alt="image"></div><br><br>  The spectrum of the output signal of the generator of rectangular pulses.  Kg = 43.98% <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/796/ff5/03f/796ff503f61a47db9c8548dee6c54bed.png"></div><br><br>  Spectrum at the output of the second-order Butterworth filter.  Kg = 5.36% <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7b3/977/e66/7b3977e669ef4f38a858bbab0431aed0.png"></div><br><br>  Spectrum at the output of the fourth order Butterworth filter.  Kg = 0.59% <br><br>  A little explanation to the graphs: the logarithmic values ‚Äã‚Äãof THD in the caps correspond only to the 5 first harmonics, therefore these values ‚Äã‚Äãdiffer from the similar ones for which a greater number of harmonics are provided. <br><br>  It should be noted that Kg at the output of the filters completely coincide with the calculated ones.  But Kg for a rectangular signal is less than the calculated one, since  the spectrum of a rectangular signal attenuates slowly, and it may take several tens of harmonics to achieve the calculated value - there's nothing to be done. <br><br>  To automate the measurement of Kg, in addition to the previous script, you may need to support the commands of the tested generator using the Instrument Control Toolbox, but this is only if the device has a remote interface.  For example, if commands are implemented as the Command-line Interface (CLI), then everything should be simple. <br><br><pre> <code class="matlab hljs">[qty,b5_comport_list,~,b5] = b5_open_test; <span class="hljs-comment"><span class="hljs-comment">% Search connected devices. if qty b5.Port = b5_comport_list{1}; % Assign port to first device. fopen(b5); disp(b5_command(b5,'versions',.1)); % Display Versions of MCU and FPGA. disp(b5_command(b5,'sn',.1)); % Display Serial Number. b5_command(b5,'outrfreq 101050',.1); % Set output frequency. b5_command(b5,'outrlvl 0',.1); % Set output level. b5_command(b5,'outimp 600',.1); % Set output impedance. b5_command(b5,'outpath output',.1); % Connect generator to output connector. fclose(b5); % Close port. delete(b5); % Clear buffer. clear b5 % Remove var from memory. else disp('b5-vf is not connected'); delete(b5); % Clear buffer. clear b5 % Remove var from memory. end</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/20c/877/c6b/20c877c6b2a541898045558b01715d4c.jpg"></div><br>  Actually, this way was measured Kg generator, which was developed on the basis of FPGA, in a module designed to test analog transmission systems.  As an example, below are graphs of the spectra and values ‚Äã‚Äãof Kg directly at the output of the D / A converter (ADC in the figure) and after the link of the type K filter, as well as the necessary script for plotting graphs. <br><br><pre> <code class="matlab hljs"><span class="hljs-comment"><span class="hljs-comment">%% Window win = tukeywin(length(s_ac),1); % Generate window. % win = 1; % Disable window. s_ac_win = s_ac.*win; % Apply the window. %% FFT nfft = 2^nextpow2(L); %% FFT length fft_s_ac_win = fft(s_ac_win,nfft)/L; f = fs/2*linspace(0,1,nfft/2+1); win_scale = 1/mean(win); %% Normalization the result fft_s_ac_win_lin = 2*win_scale*abs(fft_s_ac_win(1:nfft/2+1)); fft_s_ac_win_log = 20*log10(fft_s_ac_win_lin); %% Fig 1 figure(1); subplot(2,1,1), plot(t,s_ac), axis([0 max(t) -max(abs(s_ac)) max(abs(s_ac))]), grid on; title('\itADC','fontsize',10); xlabel('Time, \its','fontsize',10), ylabel('Amplitude, \itV','fontsize',10); subplot(2,1,2), plot(f,fft_s_ac_win_log), axis([0 fs/2 -110 10]), grid on; title('\itFast Fourier Transform (FFT) Plot','fontsize',10); xlabel('Frequency, \itHz','fontsize',10), ylabel('Amplitude, \itdB','fontsize',10);</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/eb9/b8e/f93/eb9b8ef935944329b68d561d2ddaddca.png"></div><br>  The signal and its spectrum at the output of the DAC, Kg = 28.3% <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ea1/f9d/0de/ea1f9d0de2224a9194bd42cd49ef0aa4.png"></div><br>  The signal and its spectrum at the output of a type of filter link, Kg = 2.5% <br><br>  It should be noted that all this work was carried out only for the sake of estimating the worst Kg value of the maximum generator frequency.  In the working frequency range from 200 Hz to 62 kHz, Kg did not exceed 0.34%.  For these frequencies, the graphics of the signals and spectra are no longer so interesting. <br><br>  Thus, using the example of a generator built on a FPGA with a connected DAC and additional filtering of the signal using a low-pass filter of type k, it is shown that measuring Kg at various points in the circuit can be performed using a digital oscilloscope connected to a computer and Matlab.  Such a mechanism can significantly reduce the time to assess the quality of the functioning of the device and relieves the engineer from the routine of computing. </div><p>Source: <a href="https://habr.com/ru/post/310582/">https://habr.com/ru/post/310582/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310572/index.html">We add numbers on Rust</a></li>
<li><a href="../310574/index.html">Programming with the eyes (and hands) of the humanities. Personal experience. A little philosophy</a></li>
<li><a href="../310576/index.html">FSB plans to decrypt all Internet traffic of Russians in real time</a></li>
<li><a href="../310578/index.html">ISPsystem company: we carry out hakaton</a></li>
<li><a href="../310580/index.html">September 24, we invite you to the conference MIXAR 2016 - non-classical conference on the latest technologies</a></li>
<li><a href="../310584/index.html">Mission is feasible: how to develop DevOps in a company with many projects</a></li>
<li><a href="../310586/index.html">Use the ‚ÄúGame of Thrones‚Äù lessons when developing strategies for your startup.</a></li>
<li><a href="../310588/index.html">Alan Kay: The future of "reading" depends on the future of "learning difficult to understand things"</a></li>
<li><a href="../310590/index.html">The art of writing simple and short functions</a></li>
<li><a href="../310592/index.html">A series of interface updates "Habrahabra" and Geektimes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>