<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>One quarter from the life of SOC. Three uncounted incidents</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For me, as an analyst, the most useful and interesting reports and articles are those that highlight the practical aspects of information security and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>One quarter from the life of SOC. Three uncounted incidents</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/web/29a/838/31a/29a83831aeba4748b5eb8fa993f9f6cd.jpg">  For me, as an analyst, the most useful and interesting reports and articles are those that highlight the practical aspects of information security and give concrete examples of incidents and methods for their detection and investigation.  Therefore, today's article is devoted to several interesting cases that we have recently encountered in Solar JSOC. <a name="habracut"></a><br><br><h3>  Such necessary torrents ... </h3><br>  In one of our clients, all network activity of various applications is subject to strict profiling and control.  Outgoing network activity of applications is monitored at the proxy level, and detection of network activity from a new user-agent is considered an information security event.  In this case, the Solar JSOC 24-hour first monitoring line can either escalate it to the analyst responsible for the customer, or independently alert the customer on the route established for this type of incidents.  The choice depends on the type of network activity, its suspicion and other related information. <br><br>  <i>It is worth noting here that tracking the user-agent is not a highly relevant scenario, since changing the agent being reported is not difficult.</i>  <i>But lately, complex solutions like ngfw on indirect grounds, such as the composition of the package, header features, frequency, end servers, responses for outgoing requests, etc., are able to determine not the translated agent, but the real application.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As part of the investigation, the first line organizes the collection of the maximum amount of data on the incident: information about the car, all users authenticated in the last 24 hours, traffic volumes within the network session of this software, its duration.  In the presence of local logs, information is collected on processes launched on the host. <br><br>  On April 17, 2017, at about 3 am, a successful external connection of one of the remote administration tools was recorded from a working laptop of a technical support employee.  The technical support department is the only one who is allowed to use this type of user agent, but in this case, instead of the standard tool, the utility TightVNC was used.  The laptop was not connected to Solar JSOC, so first-line analysts could not collect local machine logs and escalated the incident to the second-line duty analyst, while simultaneously preparing an alert to the customer via email. <br><br>  The following is a chronology of events: <br>  03:08:02.  Incident. <br>  03:26:00.  Alert by a first-line specialist on-call analyst by phone. <br>  03:29:00.  Coordination with the customer to connect the machine at the level of the local OS logs. <br>  03:32:48.  Notification from the 1st line in the direction of the Customer. <br>  03:48:00  Connecting the machine to the SIEM system. <br><br>  Thanks to the pre-configured advanced audit on all workstations (including mobile) and the customer‚Äôs servers, it became clear that the activity occurred as a result of downloading and running the tnvserver.exe process.  Extended logging helped us identify the parent process, which we customize with customers on a mandatory basis.  They are a torrent client that the antivirus did not consider malware. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/35f/cec/26b/35fcec26b3194e7b9901cd369d793131.png"></div><br>  The general chronology of events is as follows: <br><div style="text-align:center;"><img src="https://habrastorage.org/web/9aa/ed7/9cd/9aaed79cdf08484d846066c5bd971760.png"></div><br>  The situation with the so-called pseudo-useful software is very difficult, as proving its ‚Äúmalware‚Äù is quite problematic, although most of these utilities collect statistics on the user's work on the host, and some are able to run additional components and execute remote commands.  However, at the same time, pseudo-useful software can simultaneously execute its main purpose, for which it was downloaded, and the ‚Äúmalicious‚Äù functions can be in a state of hibernation for a while or be added in subsequent versions when updating. <br><br>  To identify such programs every year more and more difficult.  If earlier markers were obtrusive advertising, a huge number of banners, user complaints and a curve code, then today any free product developed by ‚Äúenthusiasts‚Äù can have these ‚Äúfeatures‚Äù.  Typically, such programs offer to say music or movies, speed up your computer, clean the registry, download torrents, and more. <br><br>  Part of antivirus solutions can detect such products as not-a-virus, that is, software that is potentially dangerous for the user, but performs useful functions.  Another part of the antivirus does not respond to them. <br><br>  The danger of pseudo-useful software is that on the overwhelming majority of workstations and on home computers it behaves completely normal, performing its basic functions and sending telemetry to developers.  But when such software enters an infrastructure that is interesting for intruders, for example, a large company, its malicious functions are activated or components that allow remote execution of commands or organization of a remote administration session are downloaded.  Further, such a host is put up for sale on the darknet as a point of entry into the company's infrastructure. <br><br>  Further schemes of work of malefactors are various, but come down to theft of money and / or valuable information. <br><br>  Instead of morality in the finale of this story I would like to give a few recommendations: <br><br><ol><li>  Limit the possibility of direct connections through firewalls for users, use proxy servers.  They have a categorization that allows, based on traffic or addresses, to identify the use of remote administration tools. </li><li>  Use antivirus software that can detect not-a-virus. </li><li>  Hold comprehensive security awareness training among users. </li><li>  Limit user privileges on workstations.  In this case, it would help prevent the installation of both the main software and additional packages. </li><li>  If possible, adjust the software installed on the hosts, including the restriction of user rights (prohibiting a local administrator). </li><li>  Aggregation of reputation databases and their integration into the SIEM system will allow detection of undetectable malware samples in the infrastructure, the use of TOR, remote administration tools, etc. </li></ol><br><h3>  Service Account Control </h3><br>  The second case concerns the use of legitimate tools in the work of IT and information security as a tool for penetrating critical infrastructure. <br><br>  Solar JSOC employees received a request for assistance in investigating an incident involving an attempted theft of money through the payment system.  The company was not our client, but knew about our services. <br><br>  At the first stage of the investigation, the source of information for analyzing the incident was the servers where the electronic details of the payment system were stored.  We connected these servers at the level of local logs of Windows OS (the maximum storage depth was 2 months for the System Event Log, Security - a week) <br><br>  As a result of the authentication analysis, successful sessions from a server located on the perimeter were identified.  From this server, connections to the studied hosts under the service account (techuser) were periodically established.  Typically, this account was used for IT monitoring tasks in a company infrastructure. <br><br>  At this stage, we have connected additional sources: <br><ul><li>  retrospective logs from border and intersegment ITU (aggregated using syslog server) </li><li>  local server logs ***** (hereinafter - SRV) </li></ul><br>  It turned out that it is impossible to analyze the local host server logs due to their cleaning, but when analyzing the image of this host in the restored and decoded wtmp file (records data in the input and output from the system), authentication records were found under the root account for several weeks before the incident. <br><br>  Also on the SRV were found traces of software used by attackers to penetrate the infrastructure - software packages nmap (system scanning and vulnerability detection) and medusa (intelligent password recovery system). <br><br>  When analyzing logs of inter-segment firewalls, from the first authentication on the SRV host using the root root to the time of the incident, multiple attempts were made to establish connections from the server to various company resources using the smb protocol.  Most likely, the goal was password or other information relevant to penetration. <br><br>  This can be visualized with HPE ArcSight internal tools: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/936/20a/cd4/93620acd49484a809712131d43c7883a.png"></div><br>  Then significant (over 10 MB) sessions were recorded using the smb protocol from the SRV host to the compromised servers.  They were performed at the same time as authentication events from local logs.  Most likely, the password for the techuser account was compromised by the successful exploitation of the smb protocol vulnerability on the host.  The vulnerability allowed pass-through authentication in the system under the Windows service account and compromise account passwords through the lsass.exe process. <br><br>  Next, under the techuser account, a system service was installed that performs the functions of remoteshell. <br><br>  The main features of this software are: <br><ul><li>  The installation and assembly process uses only the internal powershell tools, which significantly complicates the possibility of its detection. </li><li>  A new instance of the svchost.exe system process is launched with dynamic code assembly in the process memory, thereby complicating the possibility of its determination both manually and with the help of automated software. </li><li>  For communication with the management server, port 9887 is used (on the server, an allow rule was previously added on the local firewall). </li><li>  The software does not leave any traces on the file system, it functions entirely in RAM and is deleted upon completion of the session / </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/web/ab4/fef/fbd/ab4feffbd2ff4aa8985a6e1eadc04c7e.png"></div><br>  For two weeks, the attackers used this software to remotely manage compromised machines and steal key information, including payment system details. <br><br>  After we restored the chronology of events and investigated the malware detected, it‚Äôs time to assess the scale of the disaster: <br><ul><li>  How many accounts are compromised. </li><li>  Are there any backup channels for getting into the company's infrastructure? </li><li>  What other systems have been affected. <br></li></ul><br>  The companies were given recommendations to minimize risks and, in particular, to work out the issues of closing the following channels of an attacker‚Äôs access to infrastructure. <br><ul><li>  Remote access to the company's network: <br><ul><li>  Analyze all the facts of remote access to the company's network for two months (we provided the upload), and verify user activities. </li><li>  Inventory all accounts with remote access rights, revoke redundant rights. </li><li>  Update passwords for all remote access users. </li></ul><br></li><li>  Using remote administration tools or access to the control center via a proxy server: <br><br><ul><li>  Analyze all the facts of access to suspicious resources / using non-standard protocols through a proxy server (here we provided unloading and prioritized suspicious activities). </li><li>  A restriction has been placed on direct access to the Internet on the company's network in order to guarantee redirection of all Internet traffic through a proxy server. </li></ul><br></li><li>  Audit of all company hosts regarding the use of software used by hacker groups for password compromise (Mimikatz, procdump). </li></ul><br><h3>  Like an apt ... or no? </h3><br>  The next case, identified in the framework of the pilot project Solar JSOC, looks very unusual, since by all indications it should be about the APT - spoiler alert!  - but not really.  So, given: <br><ul><li>  Several malware: keylogger, RAT and even a bunch of others. </li><li>  Compromised machine Assistant General Manager. </li><li>  Attackers who have used this host for several months. </li></ul><br>  At the start of the pilot project, when connecting infrastructure sources, a significant part of the incident detection scenarios starts working immediately, without any additional efforts.  These scenarios, among other things, include calls to potentially dangerous hosts on the version of various reputation databases aggregated in Solar JSOC. <br><br>  <i>The script works according to the following principle: There are several active sheets - a sheet with ip-addresses, a sheet with domains of 2-4 levels, a sheet with full links to malicious objects.</i>  <i>The special script normalizes various reputation bases, leading them to a single mind.</i>  <i>Then, each rule works with different fields either, checking for occurrences of events recorded on firewalls with activelist strings by the target address fields, either the request url host (target host name), or the request url.</i> <br><br>  When connecting the border firewall, calls were made to known potentially dangerous resources (IP addresses of C &amp; C servers), which could indicate that the company's internal resources were infected with malware. <br><br>  For each drawdown, a detailed analysis of the situations was carried out.  We collected local operating system logs from hosts and identified the processes that initiated connections to external addresses. <br><br>  One of the potentially infected hosts turned out to be the workstation of the assistant general manager of the company.  As a result of investigating the machine, traces of malware were found on it, including spyware Mipko Personal Monitor (MPK). <br><br>  Spyware MPK was installed on AWS from under the AWS \ Serv account.  In this case, the first entry of this account to the workstation was made several months before the installation itself. <br><br>  Mipko Personal Monitor collected from the workstation information about the processes launched, desktop snapshots, as well as data from the keyboard, from the clipboard and active browser windows. <br><br>  Control and collection of information was carried out in respect of two accounts: AWS \ serv and helper account. <br><br>  Intercepted data every 8 hours sent to external resources: <br><ul><li>  *** nks.biz via FTP </li><li>  ******@gmail.com </li></ul><br>  Transmission facts were confirmed by events from the border firewall. <br><br>  From the moment of the first login under the AWS \ serv account to the time of the investigation, the host recorded multiple incoming remote RDP sessions from various external addresses (an average of 10,000 connections per day). <br><br>  The screenshots collected by MPK spyware showed quite curious activity from the AWS \ Serv account: <br><ul><li>  Attempts to embed PHP-script in many sites. </li><li>  Registration of mobile numbers, multiple registration of various mailboxes. </li><li>  Entering data on various credit cards on sites. </li><li>  Transfer small amounts of money to various accounts / e-wallets and mobile numbers. </li><li>  Shopping at various trading platforms. </li></ul><br>  Also, as a result of analyzing the MPK logs, a file was found that contained more than 500 different external IP addresses that are accessible from outside via RDP, along with the connection credentials (login password). <br><br>  Apparently, the AWS assistant was used as an intermediate machine for attacks on websites, theft of bank card data / credentials of users of these sites and transfer of funds from compromised cards and accounts, as well as cash through purchases.  Apparently, the infected workstation was one of the network of compromised machines used by the attackers for their own purposes. <br><br>  And now a little technology. <br><br>  As a result of the study, the following illegitimate utilities were discovered (illegitimacy confirmed, including by the owner of the AWP). <br><div style="text-align:center;"><img src="https://habrastorage.org/web/04d/dac/68a/04ddac68aff24cd5b51284f24106a9cc.png"></div><br>  During the localization activities of MPK, we received additional information: <br><br><ul><li>  A hidden MPK directory was found, located along the path: C: \ ProgramData.  The content of this directory was a PE-objects necessary for the functioning of the "MPK", as well as configuration and log files. <br>  <i>As a result of scanning this directory, multiple objects with a JFIF signature (JPEG File Interchange Format) were detected, which indicates the presence of images in it.</i> <br><br></li><li>  Detected active processes that are directly related to the functioning of the "MPK": <br>  <i>mpk.exe (NT AUTHORITY)</i> <br>  <i>mpkl64.exe (NT AUTHORITY)</i> <br>  <i>lsynchost.exe (NT AUTHORITY)</i> <br><br></li><li>  Successful attempts were made to insert PE objects (MPK64.dll and MPK.dll), which are components of MPK, into the address space of active processes. <br>  <i>As a result of tracing active processes, the fact of interception of data entered into application windows and transmitted via the clipboard was detected.</i>  <i>The interception functionality is implemented in PE objects: MPK64.dll and MPK.dll.</i> <br></li></ul><br>  In order to establish the functionality of this MPK assembly and determine what information could have been collected and transferred to third parties as a result of the operation of the malware, we received the following data from the assistant's automated workplace: <br><ul><li>  File system: <i>% SYSTEMROOT% \ ProgramData \ MPK \ *</i> <i><br></i>  <i>% SYSTEMROOT% \ SysWoW64 \ Mpk \ *</i> <i><br></i>  <i>% SYSTEMROOT% \ Prefetch \ *</i> <i><br></i>  <i>% SYSTEMROOT% \ inf \ *</i> <i><br></i>  <i>% SYSTEMROOT% \ System32 \ Logs \ *</i> <i><br></i>  <i>% USERPROFILE% \ AppData \ Local \ Temporary Internet Files \ *</i> <i><br></i>  <i>% USERPROFILE% \ Temp \ *</i> <i><br></i> </li><li>  Registry export: <i>HKEY_CURRENT_USER</i> <i><br></i>  <i>HKEY_LOCAL_MACHINE</i> <i><br></i>  <i>HKEY_USERS</i> <i><br></i> </li><li>  Active snapshot of RAM. </li></ul><br>  In the ‚ÄúC: \ Windows \ MPK‚Äù directory, log files were found that contained information about the software installation and configuration parameters: mpk_em_log.txt and * .dat.  As a result of the analysis, the details of the installation and operation of MPK were obtained: <br><br><ul><li>  The installer was a PE object - mpk_emni_mpk.exe.  The main components required for installation were located in the C: \ Users \ Serv \ Desktop \ 1 \ 6 \ * directory. <br><br></li><li>  In the case of the internal Windows firewall, special rules were created for it: <br><br><img src="https://habrastorage.org/web/0f1/d1d/bec/0f1d1dbec07f404ea59d792f74b6dc7a.png"><br><br></li><li>  Assistant accounts and AWS \ Serv have been assigned directories with the names "1" and "2".  These hidden directories located in C: \ ProgramData contained captured data. </li></ul><br>  Following the investigation, the customer was issued the following recommendations: <br><br><ol><li>  Perezalit operating system on the workstation. </li><li>  Change passwords from all accounts used on this workstation. </li><li>  In case the Service-Desk service connected to this workstation and entered its credentials there, it was recommended to change the passwords from them. </li><li>  Deny the white IP address and direct Internet access for this workstation.  If the presence of a white IP address is a production necessity, then use increased security requirements for any remote connections to it: <br><br><ul><li>  Passwords increased resistance; </li><li>  Frequent change of passwords; </li><li>  Hard limitation of IP addresses from which any incoming connections are possible; </li><li>  Monitoring the status of antiviral drugs; </li><li>  Isolation of a workstation in a separate segment without access to the company's internal resources or with strict restriction of such access to specific resources. </li></ul></li><li>  Check the entire infrastructure of the company for the presence of such spyware, remote administration tools, other unauthorized software. </li><li>  Monitor critical workstations and servers in the following areas: <br><br><ul><li>  network activity to known dangerous and harmful resources (in real time); </li><li>  privileged account activity; </li><li>  running processes; </li><li>  changes to system directories and critical registry branches; </li><li>  use of remote control systems; </li><li>  viral activity; </li><li>  malicious mailings to users; </li><li>  anomalies in connection profiles to critical servers and workstations; </li><li>  misuse of service accounts. </li></ul></li></ol><br>  As you can see, there are not always cases of compromise of the machine and long-term presence of malware on it lead to hacking of the client's infrastructure.  Sometimes intruders have their down-to-earth targets, and infected hosts are used only as a means to achieve them.  But potentially everything could have ended much worse - the amount of ‚Äúsensitive‚Äù information among the employees of such a link is usually large, and its leakage can cause serious damage. <br><br>  In this article I covered only three of the many cases that we see in the JSOC.  Incidents happen daily, mostly routine, but there are also interesting specimens.  Considering their number, I think the second series of interesting cases from the life of Solar JSOC will be released soon. </div><p>Source: <a href="https://habr.com/ru/post/333816/">https://habr.com/ru/post/333816/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../333806/index.html">Wi-Fi adapter via OTG</a></li>
<li><a href="../333808/index.html">Getsploit: search and download exploits on an aggregated database</a></li>
<li><a href="../333810/index.html">Report of the Information Security Monitoring Center for the II quarter of 2017</a></li>
<li><a href="../333812/index.html">About design in mobile applications (with the eyes, mind and heart of the developer)</a></li>
<li><a href="../333814/index.html">Science Slam Digital report July 7</a></li>
<li><a href="../333818/index.html">Design for fingers, touches and people.</a></li>
<li><a href="../333822/index.html">Tales from Lab'a</a></li>
<li><a href="../333824/index.html">Microsoft Bot Framework on Linux under Node.JS</a></li>
<li><a href="../333828/index.html">Black Lambda of corporal Volkov: a new direction and grants for summer school</a></li>
<li><a href="../333830/index.html">Firstborn MEGA Accelerator: the year of free flight</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>