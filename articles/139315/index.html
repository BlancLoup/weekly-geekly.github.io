<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Load balancing between two channels in dynamic EIGRP routing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I am glad to welcome all habrazhiteli. 
 In accordance with the new requirements, redundant communication channels began to be created at work, during...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Load balancing between two channels in dynamic EIGRP routing</h1><div class="post__text post__text-html js-mediator-article"> I am glad to welcome all habrazhiteli. <br>  In accordance with the new requirements, redundant communication channels began to be created at work, during the initial setup of which, balancing traffic in EIGRP did not work, I had to deal with this interesting issue. <br><br>  Network layout <img src="http://testarea.16mb.com/user_images/schema.PNG" alt="image"><br><br>  Given: <br>  We have a network 172.18.230.224/27, let's call it ‚Äúour network‚Äù, from it very important data is transferred to two other networks ID and IE, respectively.  Transmission should be carried out via redundant communication channels, that is, we have primary and backup channels.  Two interesting nuances: <br>  1) Static routing is configured in the ID network and, sla-monitors and ip load-sharing per-packet, balancing is working properly; <br>  2) In the IE network, the dynamic routing protocol EIGRP works and during the initial configuration the balancing did not work, and why, let's look further. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, let's see what is happening in steps: <br><br>  <i>1) Let's look at the topology of EIGRP from the second to the router on the IE network with the command:</i> <b>sh ip eigrp topology 192.168.10.0</b> <br><br> <code>2811-2# <b>sh ip eigrp topology 192.168.10.0</b> <br> IP-EIGRP (AS 1): Topology entry for 192.168.10.0/24 <br> State is Passive, Query origin flag is 1, 1 Successor(s), FD is 40512000 <br> Routing Descriptor Blocks: <br> 192.168.199.205 (Serial0/0/0:1), from 192.168.199.205, Send flag is 0x0 <br> <b>Composite metric is (40514560/28160), Route is External</b> <br> <b>Minimum bandwidth is 64 Kbit</b> <br> <b>Total delay is 20100 microseconds</b> <br> { } <br> 192.168.198.98 (FastEthernet0/1), from 192.168.198.98, Send flag is 0x0 <br> <b>Composite metric is (40517120/40514560), Route is External</b> <br> <b>Minimum bandwidth is 64 Kbit</b> <br> <b>Total delay is 20200 microseconds</b> <br> { } <br></code> <br><br>  <i>2) Let's look at the topology of EIGRP from the first one in the router to the IE network with the command:</i> <b>sh ip eigrp topology 192.168.10.0</b> <b><br></b> <br><br><br> <code>2811-1# <b>sh ip eigrp topology 192.168.10.0/24</b> <br> IP-EIGRP (AS 1): Topology entry for 192.168.10.0/24 <br> State is Passive, Query origin flag is 1, 1 Successor(s), FD is 40514560 <br> Routing Descriptor Blocks: <br> 192.168.199.201 (Serial0/0/0:1), from 192.168.199.201, Send flag is 0x0 <br> <b>Composite metric is (40514560/28160), Route is External</b> <br> Vector metric: <br> <b>Minimum bandwidth is 64 Kbit</b> <br> <b>Total delay is 20100 microseconds</b> <br> { } <br> 192.168.198.99 (FastEthernet0/1), from 192.168.198.99, Send flag is 0x0 <br> <b>Composite metric is (40517120/40514560), Route is External</b> <br> Vector metric: <br> <b>Minimum bandwidth is 64 Kbit</b> <br> <b>Total delay is 20200 microseconds</b> <br> { } <br></code> <br><br>  <i>Here we see bandwith (bandwidth) and delay (delay) for the local interface S0 / 0/0: 1 and the interface Fa0 / 1, through which the second route to the IE network is advertised.</i>  <i>The metric is calculated based on the above factors K1-K5, as well as bandwith (throughput) and delay (delay).</i>  <i>We see that the first direct route has a metric of <b>40514560</b> , the second has an internal interface and the second router has a metric of <b>40517120</b> , therefore it can be assumed why balancing does not work: the first router uses only the first route, since it has the best metric, and the second route is a backup, and it will only work if the main channel ‚Äúfalls‚Äù.</i> <i><br></i>  <i>Check our hunch</i> <br><br> <code>2811-1# <b>sh ip route 192.168.10.0</b> <br> Routing entry for 192.168.10.0/24 <br> <b>Known via "eigrp 1", distance 170, metric 40514560, type external</b> <br> Redistributing via eigrp 1 <br> Last update from 192.168.199.209 on Serial0/0/0:1, 3d06h ago <br> Routing Descriptor Blocks: <br> * 192.168.199.209, from 192.168.199.209, 3d06h ago, via <b>Serial0/0/0:1</b> <br> Route metric is 40514560, traffic share count is 1 <br> Total delay is 20100 microseconds, minimum bandwidth is 64 Kbit <br> Reliability 255/255, minimum MTU 1500 bytes <br> Loading 7/255, Hops 1 <br></code> <br><br>  <i>We were right: in the routing table of the first router there is only one route through the main channel.</i> <br><br>  <i><b>Decision:</b></i> <br><br>  <i>Of course, there may be several solutions to this problem, but I have already hinted that the metric is calculated on the basis of such parameters as K1-K5 coefficients, throughput and latency.</i>  <i>Maybe our solution will not be the most elegant, but we will try to pick up such a delay on the S0 / 0/0: 1 interface of the second router so that the metrics of the two routes of the first router match.</i> <br><br>  <i><b>Brief theoretical reference:</b></i> <br><br>  <i>The total metric is calculated using bandwidth and delay values.</i>  <i>Bandwidth is calculated by the formula:</i> <i><br></i>  <i>bandwidth = (10,000,000 / bandwidth (m)) * 256</i> <i><br></i>  <i>where bandwidth (m) is the minimum bandwidth on the entire route to the destination network.</i> <i><br></i>  <i>Delay:</i> <i><br></i>  <i>delay = delay (s) * 256 (in tens of microseconds)</i> <i><br></i>  <i>where delay (s) is the total delay on all routers en route to the destination network.</i> <i><br></i>  <i>These values ‚Äã‚Äãare used by the EIGRP protocol to calculate the metric:</i> <i><br></i>  <i>Metric = [K1 * bandwidth + (K2 * bandwidth) / (256-load) + K3 * delay] * [K5 / (reliability + K4)]</i> <i><br></i>  <i>If the coefficients have not changed, the formula takes the form:</i> <i><br></i>  <i>Metric = K1 * bandwidth + K3 * delay</i> <i><br></i>  <i>The number of transitions in the EIGRP protocol is 224, which is more than enough for modern networks.</i> <br><br>  <i><b>Payment:</b></i> <br><br>  <i>To determine the values ‚Äã‚Äãof the coefficients used to calculate the metrics in EIGRP, we use the command:</i> <b>sh ip protocols</b> <br> <code>2811-1# <b>sh ip protocols</b> <br> { } <br> <b>EIGRP metric weight K1=1, K2=0, K3=1, K4=0, K5=0</b> <br> { }</code> <br> <br>  <i>We see that the coefficients KE = 1, K2 = 0, K3 = 1, K4 = 0, K5 = 0</i> <br><br>  <i>Since K2 = K4 = K5 = 0 =&gt; Metric = K1 * bandwidth + K3 * delay, where Bandwidth = 10 ^ 7 / Slowest (B) (in Kbps), Slowest (B) is the smallest bandwidth on the route;</i>  <i>Delay = Summa (D) / 10, Summa (D) - the sum of all delays on the way.</i> <i><br><br></i>  <i>(10 ^ 7/64 + 20100/10) * 256 = (10 ^ 7/64 + (200 + D2) / 10) * 256</i> <i><br></i>  <i>(we divide both sides by 256 and mutually destroy 10 ^ 7/64)</i> <i><br></i>  <i>20100 = 200 + D2</i> <i><br></i>  <i>D2 = 19900 this number must be divided by 10 to get the necessary delay for S0 / 0/0: 1</i> <i><br></i>  <i>D2 = 1990</i> <i><br><br></i>  <i>Note: D = D1 + D2, where D1 is the sum of the delays on the two Fa0 / 1 interfaces that interconnect the routers and D1 = 100 + 100 = 200.</i>  <i>The delay on the interface was watched by the <b>show int fa0 / 1 command.</b></i> <i><br><br></i>  <i>There are very few.</i>  <i>We go to the second router in the global configuration mode and type the commands:</i> <i><br></i>  <i><b>int S0 / 0/0: 1</b></i> <i><br></i>  <i><b>delay 1990</b></i> <i><br><br></i> <br><br>  <i><b>Result:</b></i> <br><br>  At 2811-1, a new route appeared through the FastEthernet0 / 1 interface and the <u>metrics of the two routes coincide</u> -----&gt; <u>balancing works:</u> <br> <code>2811-1# <b>sh ip route 192.168.10.0</b> <br> { } <br> Routing Descriptor Blocks: <br> <b>* 192.168.199.201, from 192.168.199.201, 00:14:09 ago, via Serial0/0/0:1</b> <br> Route <b>metric is 40514560</b> , traffic share count is 1 <br> Total delay is 20100 microseconds, minimum bandwidth is 64 Kbit <br> Reliability 255/255, minimum MTU 1500 bytes <br> Loading 39/255, Hops 1 <br> <b>192.168.198.99, from 192.168.198.99, 00:14:09 ago, via FastEthernet0/1</b> <br> Route <b>metric is 40514560</b> , traffic share count is 1 <br> Total delay is 20100 microseconds, minimum bandwidth is 64 Kbit <br> Reliability 255/255, minimum MTU 1500 bytes <br> Loading 35/255, Hops 2 <br></code> <br><br>  <b><i>Load main channel:</i></b> <br><img src="http://testarea.16mb.com/user_images/1.png" alt="image"><br><br>  <b><i>Backup Channel Load:</i></b> <br><img src="http://testarea.16mb.com/user_images/2.png" alt="image"><br><br>  <i><b>Afterword:</b></i> <br>  <i>This decision may not seem quite logical and considerably complicates further troubleshooting, I fully agree with this thesis.</i>  <i>For people who do not have much experience with CISCO, I think my article will be useful.</i>  <i>I would be happy for comments and suggestions.</i> </div><p>Source: <a href="https://habr.com/ru/post/139315/">https://habr.com/ru/post/139315/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139304/index.html">Android + Arduino + 4 wheels. Part 2</a></li>
<li><a href="../139307/index.html">Azure - first acquaintance</a></li>
<li><a href="../139311/index.html">New method of replacing text with a picture, or getting rid of -9999px</a></li>
<li><a href="../139312/index.html">How to reach Google Support</a></li>
<li><a href="../139314/index.html">Hacked servers at Linode, stolen about 50K BTC ($ 250K)</a></li>
<li><a href="../139316/index.html">Web development with the ChicagoBoss framework</a></li>
<li><a href="../139319/index.html">AutoTranslate via Skype</a></li>
<li><a href="../139320/index.html">We overclock the sysadmin's portfolio with free certificates</a></li>
<li><a href="../139322/index.html">AlertDialog setMultiChoiceItems, bug or non-obvious feature</a></li>
<li><a href="../139324/index.html">Cross-compiling Qt-4.8.0 under mingw32 (x86) in Gentoo (x86_64)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>