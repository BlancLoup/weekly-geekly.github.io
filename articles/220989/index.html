<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a robot balancer on arduino</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For a long time, I was haunted by the desire to calculate some rather complicated mechanism and implement his life. 
 The choice fell on the reverse p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a robot balancer on arduino</h1><div class="post__text post__text-html js-mediator-article">  For a long time, I was haunted by the desire to calculate some rather complicated mechanism and implement his life. <br>  The choice fell on the reverse pendulum problem.  The result on the video: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/m5duyke8FDE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><a name="habracut"></a><br><h4>  Mathematical model </h4><br>  I will not give the derivation of the equations of motion, after all, this is the third year of the institute.  For those who are interested in the conclusion, at the end of the article there is a link where it is described in more detail. <br>  We will present the system as follows: <br><img src="https://habrastorage.org/getpro/habr/post_images/6a4/a3f/b6b/6a4a3fb6bafd82908ad62633580151c6.png"><br><br>  A pendulum is a mass m <sub>p</sub> attached at the end of a weightless rod of length l.  At the other end of the rod, an engine is attached that develops the maximum moment M <sub>k</sub> and transmits it to a wheel of mass m <sub>w</sub> and radius r. <br>  The control task is to stabilize the pendulum in a vertical position and return the wheel to the initial position. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The equations of motion describing the inverse pendulum can be represented as follows: <br><img src="https://habrastorage.org/getpro/habr/post_images/17f/7af/d49/17f7afd49f9ffbe5980007145fad2be9.gif"><br><br>  They seem rather unpleasant, but the robot itself knows nothing about them, and the control uses a linearized model, that is, this: <br><img src="https://habrastorage.org/getpro/habr/post_images/450/1b2/f01/4501b2f0160de88ea3788b03ee70a44b.gif"><br><br><h4>  Control synthesis </h4><br>  I envy people who have a PID controller.  I spent several hours adjusting its coefficients, but failed to achieve a worthwhile result.  The supervisor advised to use a linear-quadratic regulator ( <a href="http://ru.wikipedia.org/wiki/%25D0%259B%25D0%25B8%25D0%25BD%25D0%25B5%25D0%25B9%25D0%25BD%25D0%25BE-%25D0%25BA%25D0%25B2%25D0%25B0%25D0%25B4%25D1%2580%25D0%25B0%25D1%2582%25D0%25B8%25D1%2587%25D0%25BD%25D1%258B%25D0%25B9_%25D1%2580%25D0%25B5%25D0%25B3%25D1%2583%25D0%25BB%25D1%258F%25D1%2582%25D0%25BE%25D1%2580">wiki</a> ).  This regulator, unlike the PID controller, is simply the product of its coefficients and errors for each coordinate.  No discrete analogs of the derivative and the integral.  However, to calculate it, one needs a system model and the ability to solve the Riccati equation, or Matlab. <br><br>  In the matlab, the regulator's calculation is such a set of commands: <br><pre><code class="matlab hljs">A=[<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">-140</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1.0</span></span>;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>] B=[<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-number"><span class="hljs-number">212.85</span></span>;<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-number"><span class="hljs-number">-19.15</span></span>] Q=[<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>] R=<span class="hljs-number"><span class="hljs-number">1500</span></span> [K,S,e]=lqr(A,B,Q,R)</code> </pre> <br>  Here the matrices A and B are the corresponding matrices from the linearized model with the substituted values ‚Äã‚Äãof the real robot. <br>  The Q matrix determines how much you need to penalize the system for deviating from the origin, note, in our case, the coordinates include speeds. <br>  The matrix R determines how much it is necessary to penalize the system for waste of energy by control. <br><br>  The variable K will be the coefficients of the regulator. <br><br><h4>  Simulation </h4><br>  In Matlab simulink, you can easily emulate a system if someone needs a link to a repository with a mathematical model at the end of the article.  Here I will only bring graphics. <br>  The angle of deflection of the pendulum: <br><img src="https://habrastorage.org/getpro/habr/post_images/cb4/d5e/f43/cb4d5ef438f960f1d4f0869a2fc0eb32.png"><br>  Wheel deflection: <br><img src="https://habrastorage.org/getpro/habr/post_images/4a7/fd6/43a/4a7fd643a564b0c1880bd470a28e9e79.png"><br>  Engine torque: <br><img src="https://habrastorage.org/getpro/habr/post_images/76f/9b1/7f1/76f9b17f1a29fbbab8248603fdaa874a.png"><br><br><h4>  Implementation in the gland </h4><br>  The frame of the robot itself is aluminum profiles 12mm and 14mm, they come into each other.  Riveted.  Electronics is attached to a piece of fiberglass in the shape of the letter T. Motors are also attached through a glass-fiber laminate adapter. <br><img src="https://habrastorage.org/getpro/habr/post_images/123/abf/c60/123abfc606d73c2c9ab4adcd3c88d03c.jpg"><br><br>  Initially, I tried to use these motors: <br><img src="https://habrastorage.org/getpro/habr/post_images/cc1/af0/346/cc1af03460bd0cdfa926516c921edca0.jpg"><br>  Their torque is 2.2 kg * cm or 0.2 Nm.  Based on the simulation, we need much more, so other motors were chosen: <br><img src="https://habrastorage.org/getpro/habr/post_images/de5/e0e/507/de5e0e5072b68c36a79c22552e26eb62.jpg"><br>  <a href="http://www.pololu.com/product/1445">reference to the manufacturer</a> <br>  Maximum torque 14kg * cm or 1.4Nm.  They consume up to 5A of current, so the popular L293D among arduinschikov here will not work. <br><br>  To determine the angle and angular velocity is used IMU - gyro and accelerometer.  I had a board with a L3G gyroscope and an accelerometer with an LSM303 magnetometer.  There are a lot of similar boards and I will not give a code for obtaining sensor values.  However, the sensor readings need to be filtered, as the gyroscope constantly goes away, and the accelerometer is noisy and strongly lying, if the robot starts moving without changing the angle. <br>  Different filters are used, but the Kalman filter and the RC filter (complementary filter) are most popular.  I use this code: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> lastCompTime=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> filterAngle=<span class="hljs-number"><span class="hljs-number">1.50</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> dt=<span class="hljs-number"><span class="hljs-number">0.005</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">comp_filter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newAngle, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newRate)</span></span></span><span class="hljs-function"> </span></span>{ dt=(millis()-lastCompTime)/<span class="hljs-number"><span class="hljs-number">1000.0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> filterTerm0; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> filterTerm1; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> filterTerm2; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> timeConstant; timeConstant=<span class="hljs-number"><span class="hljs-number">0.5</span></span>; filterTerm0 = (newAngle - filterAngle) * timeConstant * timeConstant; filterTerm2 += filterTerm0 * dt; filterTerm1 = filterTerm2 + ((newAngle - filterAngle) * <span class="hljs-number"><span class="hljs-number">2</span></span> * timeConstant) + newRate; filterAngle = (filterTerm1 * dt) + filterAngle; lastCompTime=millis(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> filterAngle; }</code> </pre><br>  Works not perfect, but good enough for this task. <br><br>  The next sensor is a quadrature encoder on a motor.  It generates rectangular pulses on 2 of its findings: <br><img src="https://habrastorage.org/getpro/habr/post_images/7d7/420/2d4/7d74202d4c728ac742c98aa2e9e790b7.jpg"><br>  You can read them either by interrupts or by reading values ‚Äã‚Äãin a loop.  On arduino playground there is a wonderful <a href="http://playground.arduino.cc/Main/RotaryEncoders">article</a> with code examples. <br><br>  It remains to obtain the angular velocity of the wheel.  Here comes the school formula for the distance traveled / elapsed time. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ToPhiRad(x) ((x)*0.00280357142) timer_old = timer; timer=millis(); G_Dt = (timer-timer_old)/1000.0; dPhi=(ToPhiRad(encoder0Pos)-lastPhi)/G_Dt;</span></span></code> </pre><br>  ToPhiRad translates the number of encoder ticks into a wheel angle, my encoder gives out about 2240 ticks per rotation.  To get the angle you need to multiply the ticks by 2 Pi and divide them by the number at full turn of the wheel. <br><br>  Sensor readings go to the LQR controller: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> K1=<span class="hljs-number"><span class="hljs-number">0.1</span></span>,K2=<span class="hljs-number"><span class="hljs-number">0.29</span></span>,K3=<span class="hljs-number"><span class="hljs-number">6.5</span></span>,K4=<span class="hljs-number"><span class="hljs-number">1.12</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLQRSpeed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> phi,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dphi,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> angle,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dangle)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> constrain((phi*K1+dphi*K2+K3*angle+dangle*K4)*<span class="hljs-number"><span class="hljs-number">285</span></span>,<span class="hljs-number"><span class="hljs-number">-400</span></span>,<span class="hljs-number"><span class="hljs-number">400</span></span>); }</code> </pre><br>  The coefficients are taken from Matlab, although for better stability I corrected the first 2 coefficients. <br>  My driver, or rather his library, takes values ‚Äã‚Äãfrom -400 to 400. I assumed that at 400 he gives 12V to the motor, i.e.  the motor develops the maximum torque (1.4 Nm).  Dividing 400 by 1.4, we get the conversion factor from Nm, which LQR produces, to values ‚Äã‚Äãthat the driver understands. <br><br>  Just stabilizing the robot at one point is not very interesting, so the BT-module HC-05 was added to it.  The module connects to the serial port of the microcontroller.  It works at 3.3V, and arduino at 5V, so you need to connect the receiving input module through a voltage divider.  Here is the connection diagram: <br><img src="https://habrastorage.org/getpro/habr/post_images/bfb/00b/570/bfb00b570fe8fb3472ba904b9064d2bb.jpg"><br>  During the cycle, the microcontroller polls the module for symbols: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> phiDif=<span class="hljs-number"><span class="hljs-number">0.f</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> factorDif=<span class="hljs-number"><span class="hljs-number">0.f</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPhiAdding</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dif)</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       - if(dif&lt;200 &amp;&amp; dif&gt;-200){return 0.f;} float ret = dif*0.08; return ret; } float getFactorAdding(float dif){//      if(dif&lt;200 &amp;&amp; dif&gt;-200){return 0.f;} float ret = dif/500*20; return ret; } //======== if (Serial.available()){ BluetoothData=Serial.read(); if(BluetoothData=='w'){ phiDif=200; } else if(BluetoothData=='s'){ phiDif=-200; } else if(BluetoothData=='a'){ factorDif=200; } else if(BluetoothData=='d'){ factorDif=-200; } else if(BluetoothData=='c'){ factorDif=0; phiDif=0; } }</span></span></code> </pre><br>  In the end, the readings of the sensors go to the regulator, and its control and user action go to the motors: <br><pre> <code class="cpp hljs"> encoder0Pos+=getPhiAdding(phiDif); lastPhi=ToPhiRad(encoder0Pos); spd=getLQRSpeed(ToPhiRad(encoder0Pos),dPhi,balanceAt-angle,gyroRate[coordY]); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> factorL=getFactorAdding(factorDif); md.setSpeeds(spd-factorL,spd+factorL);</code> </pre><br>  Once every 50 milliseconds, the telemetry angle of the robot is sent: <br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(millis()%<span class="hljs-number"><span class="hljs-number">50</span></span>==<span class="hljs-number"><span class="hljs-number">0</span></span>){ Serial.println(angle); }</code> </pre><br><br><h4>  Add radio control </h4><br>  We will manage from the phone under android. <br><img src="https://habrastorage.org/getpro/habr/post_images/d5a/798/51a/d5a79851a9b4c197ec5ce99bf071912d.png"><br>  When launching the application, we ask the user to choose who to connect to, the bt-module should already be paired with the phone (standard code 1234). <br><pre> <code class="java hljs">BluetoothAdapter bluetooth; String []boundedItems; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> RECIEVE_MESSAGE = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... bluetooth = BluetoothAdapter.getDefaultAdapter(); if(bluetooth != null){ if (!bluetooth.isEnabled()) { bluetooth.enable(); } } Set&lt;BluetoothDevice&gt; bounded=bluetooth.getBondedDevices(); boundedItems=new String[bounded.size()]; int i=0; for (BluetoothDevice bluetoothDevice : bounded) { boundedItems[i++]=bluetoothDevice.getName(); } showListDialog(); //... } public void showListDialog(){ AlertDialog.Builder builder = new AlertDialog.Builder(this); builder.setTitle("Pick a device"); builder.setItems(boundedItems, new DialogInterface.OnClickListener() { public void onClick(DialogInterface dialog, int item) { connectTo(item); } }); AlertDialog alert = builder.create(); alert.show(); }</span></span></code> </pre><br>  After selecting the device, connect to it: <br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> UUID MY_UUID = UUID.fromString(<span class="hljs-string"><span class="hljs-string">"00001101-0000-1000-8000-00805F9B34FB"</span></span>); BluetoothSocket btSocket; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connectTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id)</span></span></span></span>{ Set&lt;BluetoothDevice&gt; bounded=bluetooth.getBondedDevices(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (BluetoothDevice bluetoothDevice : bounded) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(bluetoothDevice.getName().equalsIgnoreCase(boundedItems[id])){ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { btSocket=bluetoothDevice.createRfcommSocketToServiceRecord(MY_UUID); btSocket.connect(); ct=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConnectionThread(btSocket); ct.start(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { btSocket.close(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e1) { e1.printStackTrace(); } showListDialog(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } } }</code> </pre><br>  After connection, a stream starts, which communicates between the application and the robot: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConnectionThread</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Thread</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> InputStream mmInStream; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BufferedReader br; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> OutputStream mmOutStream; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConnectionThread</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BluetoothSocket socket)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ mmInStream = socket.getInputStream(); br=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferedReader(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InputStreamReader(mmInStream)); mmOutStream = socket.getOutputStream(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { String line=br.readLine(); h.obtainMessage(RECIEVE_MESSAGE, line).sendToTarget(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendCmd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cmd)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{ mmOutStream.write(cmd); }<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } } }</code> </pre><br>  A thread sends a message to the main application thread via a Handler, which is defined like this: <br><pre> <code class="java hljs">h = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Handler() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(android.os.Message msg)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (msg.what) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> RECIEVE_MESSAGE: String line=(String)msg.obj; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> a=Float.parseFloat(line.trim()); balancerView.setAngle((<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) (a-Math.PI/<span class="hljs-number"><span class="hljs-number">2</span></span>.f)); }<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }; };</code> </pre><br><br>  balancerView is a descendant of the SurfaceView class, it deals with displaying the current position of the robot. <br>  Here is his redrawing method: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">draw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Canvas canvas)</span></span></span><span class="hljs-function"> </span></span>{ Paint paint=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Paint(); paint.setStrokeWidth(<span class="hljs-number"><span class="hljs-number">3</span></span>); canvas.save(); canvas.rotate((<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) (angle*<span class="hljs-number"><span class="hljs-number">180</span></span>.f/Math.PI), cx, cy); paint.setColor(Color.BLACK); canvas.drawRect(cx-<span class="hljs-number"><span class="hljs-number">15</span></span>, cy-<span class="hljs-number"><span class="hljs-number">150</span></span>, cx+<span class="hljs-number"><span class="hljs-number">15</span></span>, cy, paint); paint.setColor(Color.WHITE); canvas.drawRect(cx-<span class="hljs-number"><span class="hljs-number">12</span></span>, cy-<span class="hljs-number"><span class="hljs-number">147</span></span>, cx+<span class="hljs-number"><span class="hljs-number">12</span></span>, cy-<span class="hljs-number"><span class="hljs-number">3</span></span>, paint); paint.setColor(Color.BLACK); canvas.drawCircle(cx, cy, <span class="hljs-number"><span class="hljs-number">30</span></span>, paint); paint.setColor(Color.WHITE); canvas.drawCircle(cx, cy, <span class="hljs-number"><span class="hljs-number">25</span></span>, paint); canvas.restore(); }</code> </pre><br>  Commands are sent to the robot when onTouch events appear, so that you can control the robot while holding the button. <br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTouch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v, MotionEvent me)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(me.getAction()==MotionEvent.ACTION_UP){ ct.sendCmd(<span class="hljs-string"><span class="hljs-string">'c'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v==wB){ ct.sendCmd(<span class="hljs-string"><span class="hljs-string">'w'</span></span>); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v==aB){ ct.sendCmd(<span class="hljs-string"><span class="hljs-string">'a'</span></span>); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v==sB){ ct.sendCmd(<span class="hljs-string"><span class="hljs-string">'s'</span></span>); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v==dB){ ct.sendCmd(<span class="hljs-string"><span class="hljs-string">'d'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre><br><br><h4>  Conclusion </h4><br>  The most pleasant thing about the whole building is that the mathematical model converges with the physical implementation.  The construction of the piece of iron does not present itself in itself, but the selection of the correct motors, the height of the robot, the mass of the load from above and the synthesizing of the control is a rather interesting task. <br><br>  As promised, the derivation of the equations of motion of the inverted pendulum on the wheel: <a href="http://spin7ion.ru/ru/blog/balancerBuildSteps">The derivation of equations and a little about the construction</a> <br>  <a href="https://github.com/spin7ion/Wheelee">repository on github</a> </div><p>Source: <a href="https://habr.com/ru/post/220989/">https://habr.com/ru/post/220989/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../220979/index.html">Programming and striptease</a></li>
<li><a href="../220981/index.html">LED heart on Atmega16 microcontroller, or AVR programming in Pascal</a></li>
<li><a href="../220983/index.html">DIY readability</a></li>
<li><a href="../220985/index.html">Creating a media platform using Drupal. Tasks and overview of relevant modules and libraries</a></li>
<li><a href="../220987/index.html">Announcement of the first meeting of the Java User Group EKB</a></li>
<li><a href="../220995/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 106 (April 20 - 26, 2014)</a></li>
<li><a href="../220999/index.html">DDoS any website using Facebook notes</a></li>
<li><a href="../221007/index.html">Crowdfunding as a tool for returning the ISEE-3 space probe to life</a></li>
<li><a href="../221011/index.html">J can be readable</a></li>
<li><a href="../221013/index.html">Joint translation of the TED Canadian astronaut</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>