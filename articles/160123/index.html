<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tornado WebSocket Chat for your Django project</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I launched the site backgrounddating.com and wrote about it here on Habrahabr. Of course, I already spoke about some of the technical detail...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tornado WebSocket Chat for your Django project</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/af3/4b4/0a5/af34b40a5d32825e460d6c52441101a5.jpg" alt="Tornado" align="right" title="Tornado logo">  Recently, I launched the site <a href="http://backgrounddating.com/">backgrounddating.com</a> and <a href="http://habrahabr.ru/post/159693/">wrote</a> about it here on Habrahabr.  Of course, I already spoke about some of the technical details of the implementation of this project, but I would like to write about one of the site‚Äôs capabilities separately, especially since the documentation (both in Russian and in English) on this topic on the Internet is still quite small. .  So, it‚Äôs about real-time chat between two users.  The task is to allow any user to send messages to other users, and if the recipient of the message has a chat with these users, he immediately saw the incoming messages (otherwise, he could read the messages later: that is, when the chat opens, history of recent posts). <br><br>  If you need to allow users to communicate not only together, but in groups of any number of people, then this can be done almost elementarily: the described implementation, in fact, is designed for such an extension of functionality. <br><br>  Immediately clarify that this is not the only way to implement this.  You can use another asynchronous web server (for example, node.js), you can use another message queue (or <a href="https://github.com/facebook/tornado/blob/master/demos/chat/chatdemo.py">not to use</a> it at all if you like the features of this option: the same web server worker must communicate with users of the same channel).  I do not even claim that this option is the best (but in this case it came up better than anyone).  In the end, here we will not consider crutches at all (long polling, Flash) for old browsers (and these are almost all versions of IE, for example) that do not support web sockets, and we will not even consider connecting from those browsers that already support the WebSocket protocol, but not the standardized version ( <a href="http://tools.ietf.org/html/rfc6455">RFC 6455</a> ), but one of the obsolete ones.  For information on how to enable support for the outdated version of ‚Äúdraft 76‚Äù (aka ‚Äúhixie-76‚Äù), see the Tornado <a href="http://www.tornadoweb.org/documentation/websocket.html">documentation</a> . <br><a name="habracut"></a><br>  However, what can be said for sure - this method works well, and not in one project, but in many (the described implementation method has been used for a long time, even though there is not very much information about it yet).  For example, the server running Background Dating is currently the youngest VPS from Linode (512 MiB of memory), but the load on the processor did not rise by more than 20-40 percent, and the use of RAM is about 30%.  And the resources are mainly used by gunicorn (the web server on which Django runs) and PostgreSQL.  But there is absolutely nothing surprising, since it is not a secret for anyone that Tornado is easy enough not only to work quickly, but even to cope with the <a href="http://en.wikipedia.org/wiki/C10k_problem">C10k</a> (which was already in the Habrahabr). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, we will use <a href="https://djangoproject.com/">Django</a> 1.4.2, <a href="http://tornadoweb.org/">Tornado</a> 2.4, <a href="http://redis.io/">Redis</a> 2.6.5 and <a href="http://postgresql.org/">PostgreSQL</a> 9.2.1 (in fact, you can use another relational DBMS - Django has many different backends).  The standard <a href="https://github.com/andymccurdy/redis-py">Redis-py</a> client for Python will be used to connect to Redis, as well as the <a href="https://github.com/evilkost/brukva">br√ºkva</a> (asynchronous Redis client for use with Tornado).  In order to deploy all this on the server, we will use <a href="http://haproxy.1wt.eu/">haproxy</a> and <a href="http://nginx.org/">nginx</a> , we will use the <a href="http://haproxy.1wt.eu/">gunicorn</a> web server to run the Django project in production, and <a href="http://supervisord.org/">Supervisor</a> will manage the launch of the web servers for Django and Tornado. <br><br>  If you feel that you lack theoretical knowledge (for example, you do not quite understand what an asynchronous non-blocking web server is, a message queue, and so on), I recommend first reading the relevant documentation, and if you have questions, write to comments (or me by <a href="">mail</a> ).  I also recommend to pay attention to several discussions on the topic ( <a href="http://softwaremaniacs.org/forum/django/32804/">1</a> , <a href="http://softwaremaniacs.org/forum/django/35701/">2</a> , <a href="http://softwaremaniacs.org/forum/django/19643/">3</a> , <a href="http://softwaremaniacs.org/forum/python/22061/">4</a> , <a href="http://softwaremaniacs.org/forum/django/36629/">5</a> , <a href="http://softwaremaniacs.org/forum/python/22160/">6</a> , <a href="http://softwaremaniacs.org/forum/python/39706/">7</a> ) on the excellent <a href="http://softwaremaniacs.org/forum/">forum of</a> Python-guru Ivan Sagalayev, as well as on the <a href="http://kmike.ru/files/django-realtime.pdf">slides of the</a> report ‚ÄúWe connect the synchronous framework with asynchronous (for example django)‚Äù , which is another Python-guru, Mikhail Korobov, read at <a href="http://2011.devconf.ru/programm/python_perl">DevConf 2011</a> . <br><br>  The source code of the considered solution is present both in this article <a href="https://github.com/aruseni/chat">and on GitHub</a> . <br><br><h3>  Django setup </h3><br>  Create a Django project and go to the directory that appears: <br><br><pre> django-admin.py startproject myproject
 cd myproject /
</pre><br>  Now edit the file myproject / settings.py. <br><br>  First of all, it would be a very good idea to immediately switch to using the Redis backend to store information about user sessions.  This should be done in all projects (except for those where for some reason you cannot use Redis, as well as those where many users are simply not planned).  To do this, install <a href="https://github.com/martinrusev/django-redis-sessions">django-redis-sessions</a> (pip install django-redis-sessions) and just add in the settings: <br><br><pre><code class="python hljs">SESSION_ENGINE = <span class="hljs-string"><span class="hljs-string">'redis_sessions.session'</span></span></code> </pre> <br>  Congratulations, you have just done so that the number of queries to the database when sending requests to the site is reduced by 1 (Redis responds to requests almost instantly).  :) <br><br>  By the way, these settings are best saved in a separate file that you add to gitignore - usually local_settings.py. <br><br>  There you can transfer the project secret key, for example (SECRET_KEY), as well as database settings.  The point here is that firstly, you can save server-specific settings in local_settings.py (database, caching backend, session backend, debug mode settings), and secondly Git (or another version control system) will not store information about keys and passwords. <br><br>  Accordingly, in order to add such settings to local_settings.py, you simply need to add the following at the end of settings.py: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> local_settings <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ImportError: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre><br>  Next, do not forget to set up the database (DATABASES), specify the template directory, static files directory and API key (Tornado will receive a request to Django asynchronously and Django will save this message in the database), as well as who need to send requests. <br><br>  To ensure that when a site is deployed on another server (or when a project is placed elsewhere in the file system), the path to the directories of templates and static files does not need to be changed, it is best to determine the location of the project at launch by adding the following in the settings: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os PROJECT_ROOT = os.path.abspath(os.path.dirname(__file__))</code> </pre><br>  And then, respectively, to receive other paths based on PROJECT_ROOT. <br><br>  Static files: <br><br><pre> <code class="python hljs">STATICFILES_DIRS = ( os.path.join(PROJECT_ROOT, <span class="hljs-string"><span class="hljs-string">"static"</span></span>), )</code> </pre><br>  Templates: <br><br><pre> <code class="python hljs">TEMPLATE_DIRS = ( os.path.join(PROJECT_ROOT, <span class="hljs-string"><span class="hljs-string">"templates"</span></span>), )</code> </pre><br>  API key and address: <br><br><pre> <code class="python hljs">API_KEY = <span class="hljs-string"><span class="hljs-string">'$0m3-U/\/1qu3-K3Y'</span></span> SEND_MESSAGE_API_URL = <span class="hljs-string"><span class="hljs-string">'http://127.0.0.1:8000/messages/send_message_api'</span></span></code> </pre><br>  In order to generate a key, you can use such a simple line in the console (by the way, the emoticon is looking at you from there): <br><br><pre> &lt;/ dev / urandom tr -dc _A-Zaz-0-9 |  head -c $ {1: -32}; echo;
</pre><br>  It now remains to create the static and templates directories in the myproject directory (where settings.py and local_settings.py are located) and start writing a chat application. <br><br><h3>  Chat (Django) </h3><br>  Add a new application: <br><br><pre> python manage.py startapp privatemessages
</pre><br>  And write the model (privatemessages / models.py): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.db <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> models <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.db.models.signals <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> post_save <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.contrib.auth.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> User <span class="hljs-comment"><span class="hljs-comment"># Create your models here. class Thread(models.Model): participants = models.ManyToManyField(User) last_message = models.DateTimeField(null=True, blank=True, db_index=True) class Message(models.Model): text = models.TextField() sender = models.ForeignKey(User) thread = models.ForeignKey(Thread) datetime = models.DateTimeField(auto_now_add=True, db_index=True) def update_last_message_datetime(sender, instance, created, **kwargs): """ Update Thread's last_message field when a new message is sent. """ if not created: return Thread.objects.filter(id=instance.thread.id).update( last_message=instance.datetime ) post_save.connect(update_last_message_datetime, sender=Message)</span></span></code> </pre><br>  There is nothing complicated here - there are messages and threads (threads).  For every two users will create their own thread, and all their messages will relate to this thread.  When a new message is created, the date and time of the last message for the corresponding thread is updated. <br><br>  Now it's time to add the application to INSTALLED_APPS in settings.py and synchronize the models with the database: <br><br><pre> python manage.py syncdb
</pre><br>  Let's open privatemessages / views.py and write 4 views: <br><ul><li>  <em>send_message_view</em> - to send a message via Django (for example, if this is the first message between two people) </li><li>  <em>send_message_api_view</em> - to send messages through Tornado </li><li>  <em>messages_view</em> - to view the list of interlocutors (sorted by descending date and time of the last message) </li><li>  <em>chat_view</em> - for chat (Django will simply return the page with those messages that already exist in the database, and then the browser will connect to the Tornado server via WS and receive / send new messages in real time, without reloading the page and without additional HTTP- requests) </li></ul><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># Create your views here. import json import redis from django.shortcuts import render_to_response, get_object_or_404 from django.http import HttpResponse, HttpResponseRedirect from django.template import RequestContext from django.core.urlresolvers import reverse from django.utils import timezone from django.views.decorators.csrf import csrf_exempt from django.conf import settings from django.contrib.auth.models import User from privatemessages.models import Thread, Message from privatemessages.utils import json_response, send_message def send_message_view(request): if not request.method == "POST": return HttpResponse("Please use POST.") if not request.user.is_authenticated(): return HttpResponse("Please sign in.") message_text = request.POST.get("message") if not message_text: return HttpResponse("No message found.") if len(message_text) &gt; 10000: return HttpResponse("The message is too long.") recipient_name = request.POST.get("recipient_name") try: recipient = User.objects.get(username=recipient_name) except User.DoesNotExist: return HttpResponse("No such user.") if recipient == request.user: return HttpResponse("You cannot send messages to yourself.") thread_queryset = Thread.objects.filter( participants=recipient ).filter( participants=request.user ) if thread_queryset.exists(): thread = thread_queryset[0] else: thread = Thread.objects.create() thread.participants.add(request.user, recipient) send_message( thread.id, request.user.id, message_text, request.user.username ) return HttpResponseRedirect( reverse('privatemessages.views.messages_view') ) @csrf_exempt def send_message_api_view(request, thread_id): if not request.method == "POST": return json_response({"error": "Please use POST."}) api_key = request.POST.get("api_key") if api_key != settings.API_KEY: return json_response({"error": "Please pass a correct API key."}) try: thread = Thread.objects.get(id=thread_id) except Thread.DoesNotExist: return json_response({"error": "No such thread."}) try: sender = User.objects.get(id=request.POST.get("sender_id")) except User.DoesNotExist: return json_response({"error": "No such user."}) message_text = request.POST.get("message") if not message_text: return json_response({"error": "No message found."}) if len(message_text) &gt; 10000: return json_response({"error": "The message is too long."}) send_message( thread.id, sender.id, message_text ) return json_response({"status": "ok"}) def messages_view(request): if not request.user.is_authenticated(): return HttpResponse("Please sign in.") threads = Thread.objects.filter( participants=request.user ).order_by("-last_message") if not threads: return render_to_response('private_messages.html', {}, context_instance=RequestContext(request)) r = redis.StrictRedis() user_id = str(request.user.id) for thread in threads: thread.partner = thread.participants.exclude(id=request.user.id)[0] thread.total_messages = r.hget( "".join(["thread_", str(thread.id), "_messages"]), "total_messages" ) return render_to_response('private_messages.html', { "threads": threads, }, context_instance=RequestContext(request)) def chat_view(request, thread_id): if not request.user.is_authenticated(): return HttpResponse("Please sign in.") thread = get_object_or_404( Thread, id=thread_id, participants__id=request.user.id ) messages = thread.message_set.order_by("-datetime")[:100] user_id = str(request.user.id) r = redis.StrictRedis() messages_total = r.hget( "".join(["thread_", thread_id, "_messages"]), "total_messages" ) messages_sent = r.hget( "".join(["thread_", thread_id, "_messages"]), "".join(["from_", user_id]) ) if messages_total: messages_total = int(messages_total) else: messages_total = 0 if messages_sent: messages_sent = int(messages_sent) else: messages_sent = 0 messages_received = messages_total-messages_sent partner = thread.participants.exclude(id=request.user.id)[0] tz = request.COOKIES.get("timezone") if tz: timezone.activate(tz) return render_to_response('chat.html', { "thread_id": thread_id, "thread_messages": messages, "messages_total": messages_total, "messages_sent": messages_sent, "messages_received": messages_received, "partner": partner, }, context_instance=RequestContext(request))</span></span></code> </pre><br>  And here is privatemessages / utils.py: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> redis <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.utils <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> dateformat <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> privatemessages.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Message <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">json_response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(obj)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" This function takes a Python object (a dictionary or a list) as an argument and returns an HttpResponse object containing the data from the object exported into the JSON format. """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HttpResponse(json.dumps(obj), content_type=<span class="hljs-string"><span class="hljs-string">"application/json"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(thread_id, sender_id, message_text, sender_name=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" This function takes Thread object id (first argument), sender id (second argument), message text (third argument) and can also take sender's name. It creates a new Message object and increases the values stored in Redis that represent the total number of messages for the thread and the number of this thread's messages sent from this specific user. If a sender's name is passed, it also publishes the message in the thread's channel in Redis (otherwise it is assumed that the message was already published in the channel). """</span></span> message = Message() message.text = message_text message.thread_id = thread_id message.sender_id = sender_id message.save() thread_id = str(thread_id) sender_id = str(sender_id) r = redis.StrictRedis() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> sender_name: r.publish(<span class="hljs-string"><span class="hljs-string">""</span></span>.join([<span class="hljs-string"><span class="hljs-string">"thread_"</span></span>, thread_id, <span class="hljs-string"><span class="hljs-string">"_messages"</span></span>]), json.dumps({ <span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>: dateformat.format(message.datetime, <span class="hljs-string"><span class="hljs-string">'U'</span></span>), <span class="hljs-string"><span class="hljs-string">"sender"</span></span>: sender_name, <span class="hljs-string"><span class="hljs-string">"text"</span></span>: message_text, })) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">"total_messages"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>.join([<span class="hljs-string"><span class="hljs-string">"from_"</span></span>, sender_id])): r.hincrby( <span class="hljs-string"><span class="hljs-string">""</span></span>.join([<span class="hljs-string"><span class="hljs-string">"thread_"</span></span>, thread_id, <span class="hljs-string"><span class="hljs-string">"_messages"</span></span>]), key, <span class="hljs-number"><span class="hljs-number">1</span></span> )</code> </pre><br>  You can read about tz.activate () in the Django <a href="https://docs.djangoproject.com/en/dev/topics/i18n/timezones/">documentation</a> for working with time zones.  Since browsers do not provide information about the time zone (for example, unlike language information), we need to create a cookie on the client‚Äôs side with the name timezone ‚Äî this way Django can display the date and time of each message in the time zone in which moment is the user. <br><br>  In order to calculate the time zone on the client side, we will use the <a href="http://www.pageloom.com/automatic-timezone-detection-with-javascript">jstz</a> library (do not forget to place <a href="https://bitbucket.org/pellepim/jstimezonedetect/downloads">jstz.min.js</a> in the directory myproject / static).  There are other solutions to determine the user's time zone: for example, you can take the most likely time zone based on GeoIP or even compare the local time on the user's computer with the local time on the server (since we know that the time is correct on the server) - this solution allows you to find out the user's actual time zone in the event that a completely different time zone is selected on his system, but the time has been manually transferred to correspond to the time zone. <br><br>  But in this case, let's assume that if the user has a wrong time zone, then most likely the inaccuracy of time suits him (otherwise, it will be an additional reminder to change the settings). <br><br>  Also note that you will need to install <a href="http://pytz.sourceforge.net/">pytz</a> (pip install pytz) - this is needed in order to get the time zone from a string in the Olson format ( <a href="http://www.iana.org/time-zones">IANA time zone database</a> ). <br><br>  When the send_messages function adds a new message to the database, it also updates the hash with the number of messages for the thread in Redis.  In this hash two keys are incremented - one of them represents the total number of messages in the thread, and the other represents the number of messages from this user.  These keys are used when displaying the total number of messages, as well as the number of received and sent messages (the number of received is just the total number minus the number of sent). <br><br>  When a user opens a chat and his browser opens a WS connection to the Tornado server, the Tornado server subscribes to the thread channel in Redis, and when new messages appear, it immediately sends them to the user. <br><br>  If you are not familiar with the Redis Pub / Sub implementation (SUBSCRIBE, UNSUBSCRIBE, and PUBLISH), then you can read about it in the Redis <a href="http://redis.io/topics/pubsub">documentation</a> . <br><br>  When the send_messages function calls send_message_view and sends, in particular, the name of the sender, the function publishes a message on the channel of this thread to Redis.  In the case of send_message_api_view, the sender's name is not transmitted, and it is assumed that the message has already been sent to the channel of this thread, even before the send_message_api_view call (this is done so that messages are transmitted as quickly as possible between chatting users - saving to the database asynchronously , after the publication on the channel). <br><br>  Now we will create a privatemessages / urls.py file and set the urlpatterns for the Django methods: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.conf.urls <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> patterns, url urlpatterns = patterns(<span class="hljs-string"><span class="hljs-string">'privatemessages.views'</span></span>, url(<span class="hljs-string"><span class="hljs-string">r'^send_message/$'</span></span>, <span class="hljs-string"><span class="hljs-string">'send_message_view'</span></span>), url(<span class="hljs-string"><span class="hljs-string">r'^send_message_api/(?P&lt;thread_id&gt;\d+)/$'</span></span>, <span class="hljs-string"><span class="hljs-string">'send_message_api_view'</span></span>), url(<span class="hljs-string"><span class="hljs-string">r'^chat/(?P&lt;thread_id&gt;\d+)/$'</span></span>, <span class="hljs-string"><span class="hljs-string">'chat_view'</span></span>), url(<span class="hljs-string"><span class="hljs-string">r'^$'</span></span>, <span class="hljs-string"><span class="hljs-string">'messages_view'</span></span>), )</code> </pre><br>  And, of course, include them in <a href="http/urls/">root URLconf</a> (myproject / urls.py): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.conf.urls <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> patterns, include, url <span class="hljs-comment"><span class="hljs-comment"># something else urlpatterns = patterns('', # something else url(r'^messages/', include('privatemessages.urls')), # something else )</span></span></code> </pre><br>  In the template directory you need to place chat.html and private_messages.html.  Also add the base template base.html. <br><br>  base.html <br><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/static/privatemessages.css"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://yandex.st/jquery/1.8.3/jquery.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/static/jstz.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/static/privatemessages.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> {% block head %}{% endblock %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http-equiv</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Content-Type"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/html; charset=utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>{% block title %} {% endblock title %}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> {% block content %}{% endblock content %} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  chat.html <br><br><pre> <code class="html hljs xml">{% extends "base.html" %} {% block title %}{{ partner.username }}{% endblock %} {% block head %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> $(</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">).ready(</span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ activate_chat({{ thread_id }}, </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"{{ user.username }}"</span></span></span><span class="javascript">, { </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"total"</span></span></span><span class="javascript">: {{ messages_total }}, </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"sent"</span></span></span><span class="javascript">: {{ messages_sent }}, </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"received"</span></span></span><span class="javascript">: {{ messages_received }} }); }); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> {% endblock %} {% block content %} {% load pluralize %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chat"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"partner"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"name"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ partner.username }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"messages"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"total"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ messages_total }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> {{ messages_total|rupluralize:",," }} (<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"received"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ messages_received }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> , <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sent"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ messages_sent }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> )<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"conversation"</span></span></span><span class="hljs-tag">&gt;</span></span> {% for message in thread_messages reversed %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message"</span></span></span><span class="hljs-tag">&gt;</span></span> {% if message.sender == user %}<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"author we"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"datetime"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ message.datetime|date:"dmY H:i:s" }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> {{ user.username }}:<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>{% else %}<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"author partner"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"datetime"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ message.datetime|date:"dmY H:i:s" }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> {{ partner.username }}:<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>{% endif %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ message.text|linebreaksbr }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> {% endfor %} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message_form"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"compose"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rows</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cols</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"30"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message_textarea"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"send"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>        Ctrl + Enter.<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> {% endblock content %}</code> </pre><br>  private_messages.html <br><br><pre> <code class="html hljs xml">{% extends "base.html" %} {% block content %} {% load pluralize %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"private_messages"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"partners"</span></span></span><span class="hljs-tag">&gt;</span></span> {% for thread in threads %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{% url privatemessages.views.chat_view thread.id %}"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ thread.partner.username }} ({{ thread.total_messages|default_if_none:"0" }} {{ thread.total_messages|rupluralize:",," }})<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> {% empty %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>   .<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> {% endfor %} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{% url privatemessages.views.send_message_view %}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"post"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"new_message"</span></span></span><span class="hljs-tag">&gt;</span></span> {% csrf_token %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"name"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"recipient_name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">placeholder</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" "</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">placeholder</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> {% endblock content %}</code> </pre><br>  And create a privatemessages / templatetags directory with __init__.py and pluralize.py files. <br><br>  privatemessages / templatetags / pluralize.py ( <a href="http://vas3k.ru/dev/django_ru_pluralize/">filter</a> author - V @ s3K): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> template register = template.Library() @register.filter <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rupluralize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(value, arg)</span></span></span><span class="hljs-function">:</span></span> args = arg.split(<span class="hljs-string"><span class="hljs-string">","</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: number = abs(int(value)) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> TypeError: number = <span class="hljs-number"><span class="hljs-number">0</span></span> a = number % <span class="hljs-number"><span class="hljs-number">10</span></span> b = number % <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a == <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (b != <span class="hljs-number"><span class="hljs-number">11</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> args[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> (a &gt;= <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (a &lt;= <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ((b &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (b &gt;= <span class="hljs-number"><span class="hljs-number">20</span></span>)): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> args[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> args[<span class="hljs-number"><span class="hljs-number">2</span></span>]</code> </pre><br>  Add styles (myproject / static / privatemessages.css): <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">html</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">body</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">100%</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">margin</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">body</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">font-family</span></span>: Geneva, Arial, Helvetica, sans-serif; <span class="hljs-attribute"><span class="hljs-attribute">font-size</span></span>: <span class="hljs-number"><span class="hljs-number">14px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: <span class="hljs-number"><span class="hljs-number">#000</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">background</span></span>: <span class="hljs-number"><span class="hljs-number">#fff</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">textarea</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">form</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">p</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.name</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">input</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">border</span></span>: <span class="hljs-number"><span class="hljs-number">1px</span></span> <span class="hljs-number"><span class="hljs-number">#d4d4d4</span></span> solid; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">form</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.new_message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">p</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin</span></span>: <span class="hljs-number"><span class="hljs-number">4px</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">form</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.new_message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">p</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.name</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">input</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">form</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.new_message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">textarea</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">300px</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">form</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.new_message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">textarea</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">100px</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">textarea</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:focus</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">input</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.name</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:focus</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">border-color</span></span>: <span class="hljs-number"><span class="hljs-number">#cacaca</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">-webkit-box-shadow</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1px</span></span> <span class="hljs-number"><span class="hljs-number">1px</span></span> <span class="hljs-built_in"><span class="hljs-built_in">rgba</span></span>(0, 0, 0, 0.075) inset, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">3px</span></span> <span class="hljs-built_in"><span class="hljs-built_in">rgba</span></span>(150, 150, 150, 0.5); <span class="hljs-attribute"><span class="hljs-attribute">-moz-box-shadow</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1px</span></span> <span class="hljs-number"><span class="hljs-number">1px</span></span> <span class="hljs-built_in"><span class="hljs-built_in">rgba</span></span>(0, 0, 0, 0.075) inset, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">3px</span></span> <span class="hljs-built_in"><span class="hljs-built_in">rgba</span></span>(150, 150, 150, 0.5); <span class="hljs-attribute"><span class="hljs-attribute">box-shadow</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1px</span></span> <span class="hljs-number"><span class="hljs-number">1px</span></span> <span class="hljs-built_in"><span class="hljs-built_in">rgba</span></span>(0, 0, 0, 0.075) inset, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">3px</span></span> <span class="hljs-built_in"><span class="hljs-built_in">rgba</span></span>(150, 150, 150, 0.5); } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.private_messages</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">10px</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.private_messages</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">h1</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin-top</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.private_messages</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.partners</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin-bottom</span></span>: <span class="hljs-number"><span class="hljs-number">30px</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chat</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">100%</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">min-height</span></span>: <span class="hljs-number"><span class="hljs-number">400px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">min-width</span></span>: <span class="hljs-number"><span class="hljs-number">600px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">position</span></span>: relative; <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#e0e0e0</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.partner</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">50px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">5px</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.partner</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">p</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.partner</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">p</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.name</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">font-weight</span></span>: bold; <span class="hljs-attribute"><span class="hljs-attribute">margin-bottom</span></span>: <span class="hljs-number"><span class="hljs-number">3px</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.conversation</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">position</span></span>: absolute; <span class="hljs-attribute"><span class="hljs-attribute">top</span></span>: <span class="hljs-number"><span class="hljs-number">50px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">left</span></span>: <span class="hljs-number"><span class="hljs-number">5px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">right</span></span>: <span class="hljs-number"><span class="hljs-number">5px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">bottom</span></span>: <span class="hljs-number"><span class="hljs-number">140px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">overflow</span></span>: auto; <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">5px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-style</span></span>: solid; <span class="hljs-attribute"><span class="hljs-attribute">border-color</span></span>: <span class="hljs-number"><span class="hljs-number">#eee</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-width</span></span>: <span class="hljs-number"><span class="hljs-number">10px</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">background-color</span></span>: <span class="hljs-number"><span class="hljs-number">#fff</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">-webkit-border-radius</span></span>: <span class="hljs-number"><span class="hljs-number">7px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">-moz-border-radius</span></span>: <span class="hljs-number"><span class="hljs-number">7px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-radius</span></span>: <span class="hljs-number"><span class="hljs-number">7px</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.conversation</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.message</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">5px</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.conversation</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">p</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.conversation</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">p</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.author</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.partner</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: <span class="hljs-number"><span class="hljs-number">#002c64</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.conversation</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">p</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.author</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.we</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: <span class="hljs-number"><span class="hljs-number">#216300</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.conversation</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.message</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">p</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.author</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">span</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.datetime</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">font-size</span></span>: <span class="hljs-number"><span class="hljs-number">12px</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">form</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.message_form</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">position</span></span>: absolute; <span class="hljs-attribute"><span class="hljs-attribute">margin</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">left</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">right</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">bottom</span></span>: <span class="hljs-number"><span class="hljs-number">5px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">130px</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">form</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.message_form</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.outdated_browser_message</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin</span></span>: <span class="hljs-number"><span class="hljs-number">10px</span></span> <span class="hljs-number"><span class="hljs-number">5px</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">form</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.message_form</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.compose</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">float</span></span>: left; <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">100%</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">80%</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">5px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">-webkit-box-sizing</span></span>: border-box; <span class="hljs-attribute"><span class="hljs-attribute">-moz-box-sizing</span></span>: border-box; <span class="hljs-attribute"><span class="hljs-attribute">box-sizing</span></span>: border-box; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">form</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.message_form</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.compose</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">textarea</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">100%</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">100%</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">margin</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">-webkit-box-sizing</span></span>: border-box; <span class="hljs-attribute"><span class="hljs-attribute">-moz-box-sizing</span></span>: border-box; <span class="hljs-attribute"><span class="hljs-attribute">box-sizing</span></span>: border-box; <span class="hljs-attribute"><span class="hljs-attribute">resize</span></span>: none; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">form</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.message_form</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.send</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">float</span></span>: left; <span class="hljs-attribute"><span class="hljs-attribute">height</span></span>: <span class="hljs-number"><span class="hljs-number">100%</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">20%</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">min-width</span></span>: <span class="hljs-number"><span class="hljs-number">100px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding-right</span></span>: <span class="hljs-number"><span class="hljs-number">5px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">-webkit-box-sizing</span></span>: border-box; <span class="hljs-attribute"><span class="hljs-attribute">-moz-box-sizing</span></span>: border-box; <span class="hljs-attribute"><span class="hljs-attribute">box-sizing</span></span>: border-box; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">form</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.message_form</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.send</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">p</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin-top</span></span>: <span class="hljs-number"><span class="hljs-number">5px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>: <span class="hljs-number"><span class="hljs-number">#333</span></span>; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.chat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">form</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.message_form</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">div</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.send</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">button</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">100%</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">-webkit-box-sizing</span></span>: border-box; <span class="hljs-attribute"><span class="hljs-attribute">-moz-box-sizing</span></span>: border-box; <span class="hljs-attribute"><span class="hljs-attribute">box-sizing</span></span>: border-box; }</code> </pre><br>  And JavaScript (myproject / static / privatemessages.js): <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCookie</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cookieValue = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.cookie &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.cookie != <span class="hljs-string"><span class="hljs-string">''</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cookies = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.cookie.split(<span class="hljs-string"><span class="hljs-string">';'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; cookies.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cookie = jQuery.trim(cookies[i]); <span class="hljs-comment"><span class="hljs-comment">// Does this cookie string begin with the name we want? if (cookie.substring(0, name.length + 1) == (name + '=')) { cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break; } } } return cookieValue; } function setCookie(key, value) { document.cookie = escape(key) + '=' + escape(value); } function getNumEnding(iNumber, aEndings) { var sEnding, i; iNumber = iNumber % 100; if (iNumber&gt;=11 &amp;&amp; iNumber&lt;=19) { sEnding=aEndings[2]; } else { i = iNumber % 10; switch (i) { case (1): sEnding = aEndings[0]; break; case (2): case (3): case (4): sEnding = aEndings[1]; break; default: sEnding = aEndings[2]; } } return sEnding; } var timezone = getCookie('timezone'); if (timezone == null) { setCookie("timezone", jstz.determine().name()); } function activate_chat(thread_id, user_name, number_of_messages) { $("div.chat form.message_form div.compose textarea").focus(); function scroll_chat_window() { $("div.chat div.conversation").scrollTop($("div.chat div.conversation")[0].scrollHeight); } scroll_chat_window(); var ws; function start_chat_ws() { ws = new WebSocket("ws://127.0.0.1:8888/" + thread_id + "/"); ws.onmessage = function(event) { var message_data = JSON.parse(event.data); var date = new Date(message_data.timestamp*1000); var time = $.map([date.getHours(), date.getMinutes(), date.getSeconds()], function(val, i) { return (val &lt; 10) ? '0' + val : val; }); $("div.chat div.conversation").append('&lt;div class="message"&gt;&lt;p class="author ' + ((message_data.sender == user_name) ? 'we' : 'partner') + '"&gt;&lt;span class="datetime"&gt;' + time[0] + ':' + time[1] + ':' + time[2] + '&lt;/span&gt; ' + message_data.sender + ':&lt;/p&gt;&lt;p class="message"&gt;' + message_data.text.replace(/&amp;/g,'&amp;amp;').replace(/&lt;/g,'&amp;lt;').replace(/&gt;/g,'&amp;gt;').replace(/\n/g, '&lt;br /&gt;') + '&lt;/p&gt;&lt;/div&gt;'); scroll_chat_window(); number_of_messages["total"]++; if (message_data.sender == user_name) { number_of_messages["sent"]++; } else { number_of_messages["received"]++; } $("div.chat p.messages").html('&lt;span class="total"&gt;' + number_of_messages["total"] + '&lt;/span&gt; ' + getNumEnding(number_of_messages["total"], ["", "", ""]) + ' (&lt;span class="received"&gt;' + number_of_messages["received"] + '&lt;/span&gt; , &lt;span class="sent"&gt;' + number_of_messages["sent"] + '&lt;/span&gt; )'); } ws.onclose = function(){ // Try to reconnect in 5 seconds setTimeout(function() {start_chat_ws()}, 5000); }; } if ("WebSocket" in window) { start_chat_ws(); } else { $("form.message_form").html('&lt;div class="outdated_browser_message"&gt;&lt;p&gt;&lt;em&gt;!&lt;/em&gt;    . ,    :&lt;/p&gt;&lt;ul&gt;&lt;li&gt; &lt;em&gt;Android&lt;/em&gt;: &lt;a href="http://www.mozilla.org/ru/mobile/"&gt;Firefox&lt;/a&gt;, &lt;a href="http://www.google.com/intl/en/chrome/browser/mobile/android.html"&gt;Google Chrome&lt;/a&gt;, &lt;a href="https://play.google.com/store/apps/details?id=com.opera.browser"&gt;Opera Mobile&lt;/a&gt;&lt;/li&gt;&lt;li&gt; &lt;em&gt;Linux&lt;/em&gt;, &lt;em&gt;Mac OS X&lt;/em&gt;  &lt;em&gt;Windows&lt;/em&gt;: &lt;a href="http://www.mozilla.org/ru/firefox/fx/"&gt;Firefox&lt;/a&gt;, &lt;a href="https://www.google.com/intl/ru/chrome/browser/"&gt;Google Chrome&lt;/a&gt;, &lt;a href="http://ru.opera.com/browser/download/"&gt;Opera&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;'); return false; } function send_message() { var textarea = $("textarea#message_textarea"); if (textarea.val() == "") { return false; } if (ws.readyState != WebSocket.OPEN) { return false; } ws.send(textarea.val()); textarea.val(""); } $("form.message_form div.send button").click(send_message); $("textarea#message_textarea").keydown(function (e) { // Ctrl + Enter if (e.ctrlKey &amp;&amp; e.keyCode == 13) { send_message(); } }); }</span></span></code> </pre><br>  When deploying to the server, do not forget to specify the address at which the Tornado server will be available (or even make it into a separate variable). <br><br><h3>  Chat (Tornado) </h3><br>  Write a new Tornado application and save it in privatemessages / tornadoapp.py: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urllib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> brukva <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tornado.web <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tornado.websocket <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tornado.ioloop <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tornado.httpclient <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.conf <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> settings <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.utils.importlib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> import_module session_engine = import_module(settings.SESSION_ENGINE) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.contrib.auth.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> User <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> privatemessages.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Thread c = brukva.Client() c.connect() <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainHandler</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(tornado.web.RequestHandler)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.set_header(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/plain'</span></span>) self.write(<span class="hljs-string"><span class="hljs-string">'Hello. :)'</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessagesHandler</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(tornado.websocket.WebSocketHandler)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> super(MessagesHandler, self).__init__(*args, **kwargs) self.client = brukva.Client() self.client.connect() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">open</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, thread_id)</span></span></span><span class="hljs-function">:</span></span> session_key = self.get_cookie(settings.SESSION_COOKIE_NAME) session = session_engine.SessionStore(session_key) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: self.user_id = session[<span class="hljs-string"><span class="hljs-string">"_auth_user_id"</span></span>] self.sender_name = User.objects.get(id=self.user_id).username <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> (KeyError, User.DoesNotExist): self.close() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> Thread.objects.filter( id=thread_id, participants__id=self.user_id ).exists(): self.close() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.channel = <span class="hljs-string"><span class="hljs-string">""</span></span>.join([<span class="hljs-string"><span class="hljs-string">'thread_'</span></span>, thread_id,<span class="hljs-string"><span class="hljs-string">'_messages'</span></span>]) self.client.subscribe(self.channel) self.thread_id = thread_id self.client.listen(self.show_new_message) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle_request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, response)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, message)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> message: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(message) &gt; <span class="hljs-number"><span class="hljs-number">10000</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c.publish(self.channel, json.dumps({ <span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>: int(time.time()), <span class="hljs-string"><span class="hljs-string">"sender"</span></span>: self.sender_name, <span class="hljs-string"><span class="hljs-string">"text"</span></span>: message, })) http_client = tornado.httpclient.AsyncHTTPClient() request = tornado.httpclient.HTTPRequest( <span class="hljs-string"><span class="hljs-string">""</span></span>.join([ settings.SEND_MESSAGE_API_URL, <span class="hljs-string"><span class="hljs-string">"/"</span></span>, self.thread_id, <span class="hljs-string"><span class="hljs-string">"/"</span></span> ]), method=<span class="hljs-string"><span class="hljs-string">"POST"</span></span>, body=urllib.urlencode({ <span class="hljs-string"><span class="hljs-string">"message"</span></span>: message.encode(<span class="hljs-string"><span class="hljs-string">"utf-8"</span></span>), <span class="hljs-string"><span class="hljs-string">"api_key"</span></span>: settings.API_KEY, <span class="hljs-string"><span class="hljs-string">"sender_id"</span></span>: self.user_id, }) ) http_client.fetch(request, self.handle_request) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">show_new_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, result)</span></span></span><span class="hljs-function">:</span></span> self.write_message(str(result.body)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: self.client.unsubscribe(self.channel) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> AttributeError: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.client.connection.in_progress: tornado.ioloop.IOLoop.instance().add_timeout( datetime.timedelta(<span class="hljs-number"><span class="hljs-number">0.00001</span></span>), check ) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.client.disconnect() tornado.ioloop.IOLoop.instance().add_timeout( datetime.timedelta(<span class="hljs-number"><span class="hljs-number">0.00001</span></span>), check ) application = tornado.web.Application([ (<span class="hljs-string"><span class="hljs-string">r"/"</span></span>, MainHandler), (<span class="hljs-string"><span class="hljs-string">r'/(?P&lt;thread_id&gt;\d+)/'</span></span>, MessagesHandler), ])</code> </pre><br>  Almost everything in this application is executed asynchronously, using tornado.ioloop.  The exception is the authorization of the user by session identifier (and getting his name from the database).  This is a blocking operation, that is, at this moment other users connected to this Tornado server will be waiting.  If you need to, it is easy to change, but, firstly, not the fact that it is required, and secondly, think about whether this is the right decision.  On this occasion, the guys from Friendfeed (the Tornado developers) spoke out more than once.  For example, here‚Äôs a quote from Ben Darnell‚Äôs post: <br><br><blockquote>  Friendfeed uses mysql, with the standard synchronous MySQLdb module (http://bret.appspot.com/entry/how-friendfeed-uses-mysql).  If you‚Äôre not thinking about what you need, it‚Äôs not worth it. managing callbacks.  If you want to make it, it‚Äôs possible to keep the amount of time (long polling).  It is not clear that it makes it possible to use it. <br></blockquote><br>  That is, roughly speaking, if your database is slow, it means that the server in any case cannot cope with the load, and asynchronous start will not do much for it. , ,            ‚Äî       ,    ,    . <br><br>  Tornado-    management-.       <a href="http://stackoverflow.com/questions/2180415/using-django-database-layer-outside-of-django">   Django</a>    ORM   . <br><br>   management-  .    privatemessages  management,     commands. <br><br>    privatemessages/management   privatemessages/management/commands   __init__.py ( -   ,   ,    <a href="http://docs.python.org/2/tutorial/modules.html"></a> ). <br><br>    privatemessages/management/commands/starttornadoapp.py: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> signal <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tornado.httpserver <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tornado.ioloop <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.core.management.base <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> BaseCommand, CommandError <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> privatemessages.tornadoapp <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> application <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Command</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BaseCommand)</span></span></span><span class="hljs-class">:</span></span> args = <span class="hljs-string"><span class="hljs-string">'[port_number]'</span></span> help = <span class="hljs-string"><span class="hljs-string">'Starts the Tornado application for message handling.'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sig_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, sig, frame)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Catch signal and init callback"""</span></span> tornado.ioloop.IOLoop.instance().add_callback(self.shutdown) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shutdown</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""Stop server and add callback to stop i/o loop"""</span></span> self.http_server.stop() io_loop = tornado.ioloop.IOLoop.instance() io_loop.add_timeout(time.time() + <span class="hljs-number"><span class="hljs-number">2</span></span>, io_loop.stop) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, **options)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(args) == <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: port = int(args[<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ValueError: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> CommandError(<span class="hljs-string"><span class="hljs-string">'Invalid port number specified'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: port = <span class="hljs-number"><span class="hljs-number">8888</span></span> self.http_server = tornado.httpserver.HTTPServer(application) self.http_server.listen(port, address=<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Init signals handler signal.signal(signal.SIGTERM, self.sig_handler) # This will also catch KeyboardInterrupt exception signal.signal(signal.SIGINT, self.sig_handler) tornado.ioloop.IOLoop.instance().start()</span></span></code> </pre><br>   ,       (,   SIGINT,       Ctrl + C)  - ,      .         <a href="http://codemehanika.org/blog/2011-10-28-graceful-stop-tornado.html"></a> . <br><br><h3>  </h3><br>       (    myproject  privatemessages,    manage.py)   development- Django   Tornado. <br><br><pre>python manage.py runserver<font></font>
python manage.py starttornadoapp<font></font>
</pre><br>          ,     <a href="http://www.opennet.ru/base/sys/screen_intro.txt.html">screen</a> (, ,      SSH       SSH-). <br><br>    8000      Django,    8888   Tornado. <br><br>        : <br><br> <a href="http://127.0.0.1:8000/messages/">http://127.0.0.1:8000/messages/</a> <br><br>             (     ). <br><br>   ,        Django-.  ,   ,   <a href="https://docs.djangoproject.com/en/dev/topics/auth/"></a> .    ‚Äî  <a href="https://docs.djangoproject.com/en/dev/ref/contrib/admin/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enable the administrative interface</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and log in through it.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Deployment </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In order to run your application on the server, we can use the following software: </font></font><br><br><ul><li> <a href="http://haproxy.1wt.eu/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">haproxy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - load balancer, will work on port 80</font></font></li><li> <a href="http://nginx.org/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nginx</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - distribution of static files + reverse proxy for gunicorn, will work on port 8100</font></font></li><li> <a href="http://supervisord.org/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Supervisor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - starting the Tornado server on ports 8000‚Äì8003 (4 processes) and the Django server (gunicorn can be used) on port 8150</font></font></li></ul><br>    Supervisor.   (  Supervisor   Ubuntu)   /etc/supervisor/conf.d  django.conf  tornadoapp.conf. ,  Supervisor     (       include   files = /etc/supervisor/conf.d/*.conf). <br><br> django.conf <br><br><pre>[program:django]<font></font>
command=gunicorn_django --workers 4 -b 127.0.0.1:8150<font></font>
directory=/home/yourusername/myproject<font></font>
user=yourusername<font></font>
autostart=true<font></font>
autorestart=true<font></font>
</pre><br> tornadoapp.conf <br><br><pre>process_name = tornado-%(process_num)s<font></font>
user = yourusername<font></font>
directory = /home/yourusername/myproject<font></font>
command = python manage.py starttornadoapp %(process_num)s<font></font>
# Increase numprocs to run multiple processes on different ports.<font></font>
# Note that the chat demo won't actually work in that configuration<font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
# because it assumes all listeners are in one process.</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
numprocs = 4</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
numprocs_start = 8000</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
autostart = true</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
autorestart = true</font></font><font></font>
</pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now run supervisor and see the supervisorctl status command output. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Make sure that all 5 processes (gunicorn will be displayed as one process) show the RUNNING state and the uptime is the same as how much time has passed since Supervisor was started. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I also recommend making sure that both Django servers and Tornado servers work. </font><font style="vertical-align: inherit;">To do this, we can open the SSH tunnel to the server and simply try to open your site in the browser, while accessing the selected port on the local address. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, for example:</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ssh -L 8000: localhost: 8150 someverycoolserver.com
</font></font></pre><br>       127.0.0.1:8000 (SSH-     127.0.0.1:8150    ‚Äî   -,    ). <br><br>      Tornado-.     8000‚Äî8003. <br><br>   Django  Tornado ,      nginx  haproxy. <br><br>     nginx: <br><br><pre>server {<font></font>
    listen 127.0.0.1:8100;<font></font>
    server_name someverycoolserver.com;<font></font>
<font></font>
    # no security problem here, since / is always passed to upstream<font></font>
    root /home/yourusername/myproject/myproject/static/;<font></font>
<font></font>
    ## Compression<font></font>
    # src: http://www.ruby-forum.com/topic/141251<font></font>
    # src: http://wiki.brightbox.co.uk/docs:nginx<font></font>
<font></font>
    gzip on;<font></font>
    gzip_http_version 1.0;<font></font>
    gzip_comp_level 2;<font></font>
    gzip_proxied any;<font></font>
    gzip_min_length 1100;<font></font>
    gzip_buffers 16 8k;<font></font>
    gzip_types text/plain text/html text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript;<font></font>
    <font></font>
    # Some version of IE 6 don't handle compression well on some mime-types, so just disable for them<font></font>
    gzip_disable "MSIE [1-6].(?!.*SV1)";<font></font>
    <font></font>
    # Set a vary header so downstream proxies don't send cached gzipped content to IE6<font></font>
    gzip_vary on;<font></font>
    ## /Compression<font></font>
<font></font>
    location /static/admin/ {<font></font>
        # this changes depending on your python version<font></font>
        root /usr/local/lib/python2.7/dist-packages/django/contrib/admin/;<font></font>
     }<font></font>
<font></font>
    location /robots.txt {<font></font>
        alias /home/yourusername/myproject/myproject/robots.txt;<font></font>
     }<font></font>
<font></font>
    location /favicon.ico {<font></font>
        alias /home/yourusername/myproject/myproject/img/favicon.ico;<font></font>
        expires 3d;<font></font>
     }<font></font>
<font></font>
    location /static/ {<font></font>
        root /home/yourusername/myproject/myproject/;<font></font>
        expires 3d;<font></font>
     }<font></font>
<font></font>
    location / {<font></font>
        proxy_pass_header Server;<font></font>
        proxy_set_header Host $http_host;<font></font>
        proxy_redirect off;<font></font>
        proxy_set_header X-Real-IP $remote_addr;<font></font>
        proxy_set_header X-Scheme $scheme;<font></font>
        proxy_connect_timeout 10;<font></font>
        proxy_read_timeout 10;<font></font>
        proxy_pass http://localhost:8150/;<font></font>
     }
 }
</pre><br>  ,          .       ,    ,       (   - ),            static files versioning (  ,          query string,    ,     ,  query string ).  ,   ,        () CSS  JS ‚Äî , <a href="https://github.com/miracle2k/django-assets">django-assets</a> . <br><br>    haproxy: <br><br><pre>global<font></font>
    maxconn 10000 # Total Max Connections. This is dependent on ulimit<font></font>
    nbproc 2<font></font>
<font></font>
defaults<font></font>
    mode http<font></font>
    option redispatch<font></font>
    maxconn 2000<font></font>
    contimeout 5000<font></font>
    clitimeout 50000<font></font>
    srvtimeout 50000<font></font>
    option httpclose<font></font>
<font></font>
frontend all 0.0.0.0:80<font></font>
    timeout client 86400000<font></font>
<font></font>
    acl is_chat hdr_beg(host) -i chat<font></font>
    use_backend socket_backend if is_chat<font></font>
<font></font>
    default_backend www_backend<font></font>
<font></font>
backend www_backend<font></font>
    option forwardfor # This sets X-Forwarded-For<font></font>
    timeout server 30000<font></font>
    timeout connect 4000<font></font>
    server server1 localhost:8100<font></font>
<font></font>
backend socket_backend<font></font>
    balance roundrobin<font></font>
    option forwardfor # This sets X-Forwarded-For<font></font>
    no option httpclose # To match the `Connection` header for the websocket protocol rev.  76<font></font>
    option http-server-close<font></font>
    option http-pretend-keepalive<font></font>
    timeout queue 5000<font></font>
    timeout server 86400000<font></font>
    timeout connect 86400000<font></font>
    server server1 localhost:8000 weight 1 maxconn 5000 check<font></font>
    server server2 localhost:8001 weight 1 maxconn 5000 check<font></font>
    server server2 localhost:8002 weight 1 maxconn 5000 check<font></font>
    server server2 localhost:8003 weight 1 maxconn 5000 check<font></font>
</pre><br>   ,     , Host     chat,   localhost:8000, localhost:8001, localhost:8002  localhost:8003,       localhost:8100. <br><br>   haproxy    80-     IPv4-.     IPv6 (   ,     /),     frontend   bind   IPv6-  80-   . <br><br>   ,      IPv6-   (, ,   AAAA-  DNS),     .     ,        .   ‚Äî    IPv6,    <a href="http://en.wikipedia.org/wiki/IPv6_brokenness_and_DNS_whitelisting">DNS whitelisting</a> .  <a href="http://events.yandex.ru/talks/325/"></a> , ,  ‚Äî           IPv6,           1‚Äî2   (    ). <br><br> , Tornado-    ,         ‚Äî        ,         ( 80   443). <br><br>     haproxy  ,    backend    Host,  <a href="https://gist.github.com/3767467">   Upgrade</a> ‚Äî  ,     Django,  Tornado        (  ),  WS-   Tornado-,    ‚Äî  Django-. <br><br>  ,     .     ,   ,       ,    (   Django  Tornado         ), ,      .      !     . <br></div><p>Source: <a href="https://habr.com/ru/post/160123/">https://habr.com/ru/post/160123/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160111/index.html">The appearance of dust on the matrix D600 in slow motion by a Canadian photographer</a></li>
<li><a href="../160113/index.html">The Manifesto of the Master / The Fixer's Manifesto</a></li>
<li><a href="../160115/index.html">Progress in the development of neural networks for machine learning</a></li>
<li><a href="../160117/index.html">Web API using the Django REST framework</a></li>
<li><a href="../160121/index.html">Logic - a compact selection of the latest gaming and IT-industry news number 2</a></li>
<li><a href="../160125/index.html">Filter for comments Habrahabr as userscript</a></li>
<li><a href="../160127/index.html">Web server abroad + statics in Russia = speeding up page loading speed</a></li>
<li><a href="../160129/index.html">Everything you need to know about Do Not Track: Microsoft vs. Google and Mozilla</a></li>
<li><a href="../160131/index.html">Study: the closure of Megaupload could have a negative impact on the box office of many films</a></li>
<li><a href="../160133/index.html">RIM Shares Show Record Growth</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>