<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fast pool for php + websocket without node node jua based on lua + nginx</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Briefly: nginx does not know how to pull websockets, and php works per request. We need an interlayer that will keep the websites open and, when the d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fast pool for php + websocket without node node jua based on lua + nginx</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/a77/c68/c23/a77c68c23f3c4eddaab2c77a372d96d0.png" alt="nginx + lua" title="picture stole from some post"><br><br>  Briefly: nginx does not know how to pull websockets, and php works per request.  We need an interlayer that will keep the websites open and, when the data arrives, connect to php (via the same fastcgi) and send back the answer. <br><br>  update: This is not a php solution, as compared to even with nodejs, they are much slower. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The topic, as it turned out, is not new, the source code is already drawn from 2014, but, nevertheless, there is very little information about the trick, which will be discussed here.  You can google " <a href="https://www.google.com/search%3Fdcr%3D0%26q%3Dwebsockets%2Bphp%2Bnginx%26spell%3D1%26sa%3DX%26ved%3D0ahUKEwjXxp6SyL7WAhVMGZoKHZi9CnIQvwUIIygA%26biw%3D1715%26bih%3D925">websockets php</a> ".  The topic is further aggravated by the fact that the examples of implementation found (two, more precisely) do not work, including the one in the documentation :) <br><a name="habracut"></a><br>  Here somewhere inside felt, knew that is.  I so long wanted to have this Middleware inside Nginx, in order not to use different rather slow php libraries ( <a href="https://habrahabr.ru/post/331462/">one</a> and <a href="https://habrahabr.ru/post/331462/">two</a> <a href="https://habrahabr.ru/post/331462/">times</a> ) and skip the single-thread nodejs.  And I want a lot of websockets (and as much as possible), and that the extra costs for the interlayer are smaller.  So, in order not to produce a bunch of machines with nodejs (in the future, under high loads, this is what they usually do), we will use the fact that Nginx provides with some extensions in the form of lua + resty.  Nginx + lua can be installed from the <i>nginx-extras</i> package, or you can build it yourself.  From Resty, we only need <a href="https://github.com/openresty/lua-resty-websocket">websockets</a> .  We download and upload the contents of the lib directory somewhere on the way (I have this <i>/ home / username / lib / lua / lib</i> , and in a good way it would be necessary in <i>/ usr / local / share / lua</i> ). <br><br>  Standard nginx + websockets works like this: <br><br><ol><li>  Client connects to nginx </li><li>  Nginx proxies to upstream / opens a proxy stream with another server (Middle Server based on nodejs + sockets.io for example) serving websockets. </li><li>  The middle server throws the socket connection to some epoll event listener and waits for data. </li><li>  When receiving data, the Middle Server server, in turn, opens a Fastcgi connection with php, waits and picks up the response.  Sends it to the socket.  Returns socket again waiting for data. </li><li>  And so on in a circle, until a special websocket closing frame comes. </li></ol><br>  Everything is simple, except for the overhead of resources and single-threaded this solution. <br><br>  In the proposed scheme, MiddleServer turns into middleware inside nginx.  In addition, there is no waiting for Fastcgi, all the work is done by the same epoll, to which nginx trusts an open socket, and in the meantime the nginx stream can do other things.  The scheme allows you to simultaneously work with a bunch of websockets scattered in streams. <br><br>  Here I will give only a simplified code that relates to the task without the rest of the hosting settings.  I did not try to make all the headers correct as superfluous. <br><br><pre><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">lua_package_path</span></span> <span class="hljs-string"><span class="hljs-string">"/home/username/lib/lua/lib/?.lua;;"</span></span>; <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-comment"><span class="hljs-comment"># ,     ,     nginx location ~ ^/ws/?(.*)$ { default_type 'plain/text'; #        -   ,     content_by_lua_file /home/username/www/wsexample.local/ws.lua; } #   ,     php #    POST ,    json payload location ~ ^/lua_fastcgi_connection(/?.*)$ { internal; #     nginx fastcgi_pass_request_body on; fastcgi_pass_request_headers off; # never never use it for lua handler #include snippets/fastcgi-php.conf; fastcgi_param QUERY_STRING $query_string; fastcgi_param REQUEST_METHOD "POST"; # $request_method; fastcgi_param CONTENT_TYPE "application/x-www-form-urlencoded"; # $content_type; fastcgi_param CONTENT_LENGTH $content_length; fastcgi_param DOCUMENT_URI "$1"; #  $document_uri fastcgi_param DOCUMENT_ROOT $document_root; fastcgi_param SERVER_PROTOCOL $server_protocol; fastcgi_param REQUEST_SCHEME $scheme; fastcgi_param HTTPS $https if_not_empty; fastcgi_param GATEWAY_INTERFACE CGI/1.1; fastcgi_param SERVER_SOFTWARE nginx/$nginx_version; fastcgi_param REMOTE_ADDR $remote_addr; fastcgi_param REMOTE_PORT $remote_port; fastcgi_param SERVER_ADDR $server_addr; fastcgi_param SERVER_PORT $server_port; fastcgi_param SERVER_NAME $server_name; fastcgi_param SCRIPT_FILENAME "$document_root/mywebsockethandler.php"; fastcgi_param SCRIPT_NAME "/mywebsockethandler.php"; fastcgi_param REQUEST_URI "$1"; #      .      lua   -   php . fastcgi_pass unix:/var/run/php/php7.1-fpm.sock; fastcgi_keep_conn on; }</span></span></code> </pre> <br>  And the ws.lua code: <br><br><pre> <code class="lua hljs"> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> server = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> <span class="hljs-string"><span class="hljs-string">"resty.websocket.server"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> wb, err = server:new{ <span class="hljs-comment"><span class="hljs-comment">-- timeout = 5000, -- in milliseconds --     max_payload_len = 65535, } if not wb then ngx.log(ngx.ERR, "failed to new websocket: ", err) return ngx.exit(444) end while true do local data, typ, err = wb:recv_frame() if wb.fatal then return elseif not data then ngx.log(ngx.DEBUG, "Sending Websocket ping") wb:send_ping() elseif typ == "close" then -- send a close frame back: local bytes, err = wb:send_close(1000, "enough, enough!") if not bytes then ngx.log(ngx.ERR, "failed to send the close frame: ", err) return end local code = err ngx.log(ngx.INFO, "closing with status code ", code, " and message ", data) break; elseif typ == "ping" then -- send a pong frame back: local bytes, err = wb:send_pong(data) if not bytes then ngx.log(ngx.ERR, "failed to send frame: ", err) return end elseif typ == "pong" then -- just discard the incoming pong frame elseif data then --      uri,  json payload   body local res = ngx.location.capture("/lua_fastcgi_connection"..ngx.var.request_uri,{method=ngx.HTTP_POST,body=data}) if wb == nil then ngx.log(ngx.ERR, "WebSocket instaince is NIL"); return ngx.exit(444) end wb:send_text(res.body) else ngx.log(ngx.INFO, "received a frame of type ", typ, " and payload ", data) end end</span></span></code> </pre><br>  What else can you do about it?  Measure the speed and compare with nodejs :) And inside lua you can make requests in Redis, MySQL, Postgres ... check cookies and other authorization tokens, <a href="https://habrahabr.ru/post/270463/">process sessions</a> , cache answers in memcached and then quickly and quickly give to other clients with the same requests inside the websocket. <br><br>  Known to me flaws: the maximum data packet size on the web socket is 65Kb.  If desired, you can add a breakdown into frames.  The protocol is not complicated. <br><br>  Test html (ws.html): <br><br><div class="spoiler">  <b class="spoiler_title">HTML is here</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="hljs-meta"><span class="javascript"><span class="hljs-meta"> "use strict"</span></span></span><span class="javascript">; </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">let</span></span></span><span class="javascript"> socket; </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="javascript"><span class="hljs-function"><span class="hljs-title">tryWebSocket</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ socket = </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">new</span></span></span><span class="javascript"> WebSocket(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"ws://try6.local/ws/"</span></span></span><span class="javascript">); socket.onopen = </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">console</span></span></span><span class="javascript">.log(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">" ."</span></span></span><span class="javascript">); }; socket.onclose = </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">event</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">if</span></span></span><span class="javascript"> (event.wasClean) { </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">console</span></span></span><span class="javascript">.log(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'  '</span></span></span><span class="javascript">); } </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">else</span></span></span><span class="javascript"> { </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">console</span></span></span><span class="javascript">.log(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">' '</span></span></span><span class="javascript">); </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">// , ""   } console.log(': ' + event.code + ' : ' + event.reason); }; socket.onmessage = function(event) { console.log("  " + event.data); }; socket.onerror = function(error) { console.log(" " + error.message); }; } function tryWSSend(event) { let msg = document.getElementById('msg'); socket.send(msg.value); event.stopPropagation(); event.preventDefault(); return false; } function closeWebSocket(event) { socket.close(); } </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onLoad</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tryWebSocket(event);return false;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onsubmit</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tryWSSend(event); return false;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tryWebSocket(event); return false;"</span></span></span><span class="hljs-tag">&gt;</span></span>Try WebSocket<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fieldset</span></span></span><span class="hljs-tag">&gt;</span></span> Message: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Test message 4444"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">size</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"msg"</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fieldset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fieldset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"closeWebSocket(event); return false;"</span></span></span><span class="hljs-tag">&gt;</span></span>Close Websocket<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fieldset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  Test php (mywebsockethandler.php): <br><br><div class="spoiler">  <b class="spoiler_title">PHP is here</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> header(<span class="hljs-string"><span class="hljs-string">"Content-Type: application/json; charset=utf-8"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> json_encode([<span class="hljs-string"><span class="hljs-string">"status"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"ok"</span></span>,<span class="hljs-string"><span class="hljs-string">"response"</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">"php websocket json @ "</span></span>.time(), <span class="hljs-string"><span class="hljs-string">"payload"</span></span>=&gt;[$_REQUEST,$_SERVER]]); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>;</code> </pre><br></div></div><br>  To use FastCGI for Lua, install <a href="https://github.com/benagricola/lua-resty-fastcgi">another</a> Resty extension. </div><p>Source: <a href="https://habr.com/ru/post/338614/">https://habr.com/ru/post/338614/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338602/index.html">Digest KolibriOS # 13</a></li>
<li><a href="../338604/index.html">Is it difficult to make an elephant out of a fly?</a></li>
<li><a href="../338606/index.html">Apache¬Æ Ignite ‚Ñ¢ + Persistent Data Store - In-Memory penetrates discs. Part I - Durable Memory</a></li>
<li><a href="../338610/index.html">Russian Post: Is it scary to live after Strashnov?</a></li>
<li><a href="../338612/index.html">Deploying ES2015 + code in production today</a></li>
<li><a href="../338616/index.html">IBM quantum computer taught to model complex chemical elements</a></li>
<li><a href="../338618/index.html">Supercomputer Cray XC40 will build a map of neurons</a></li>
<li><a href="../338620/index.html">Cisco unveiled features of the 400-gigabit NPU</a></li>
<li><a href="../338622/index.html">Marea 160-terabit trans-Atlantic cable finished</a></li>
<li><a href="../338624/index.html">Weekend reading: 17 independent blogs on math, algorithms, and programming languages</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>