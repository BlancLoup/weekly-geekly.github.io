<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Flask Mega-Tutorial, Chapter 8: Subscribers, Contacts and Friends (Edition 2018)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="blog.miguelgrinberg.com 
 Miguel grinberg 



 <<< previous next >>> 


 This article is a translation of the eighth part of the new edition of Miguel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Flask Mega-Tutorial, Chapter 8: Subscribers, Contacts and Friends (Edition 2018)</h1><div class="post__text post__text-html js-mediator-article"><p>  <a href="http://blog.miguelgrinberg.com/" title="blog.miguelgrinberg.com">blog.miguelgrinberg.com</a> </p><br><h3 id="miguel-grinberg">  <em>Miguel grinberg</em> </h3><br><hr><br><p>  <a href="https://habrahabr.ru/post/346880/">&lt;&lt;&lt; previous</a> <a href="https://habrahabr.ru/post/347926/">next &gt;&gt;&gt;</a> </p><br><p>  This article is a translation of the eighth part of the new edition of Miguel Greenberg‚Äôs textbook, the issue of which the author plans to complete in May 2018. <a href="https://habrahabr.ru/post/193242/" title="Previous translation">The previous translation</a> has long since lost its relevance. </p><br><hr><br><p>  This is the eighth part of the Flask Mega-Tutorial series, in which I will tell you how to implement the "subscribers" function, similar to the functions of Twitter and other social networks. </p><a name="habracut"></a><br><p>  For reference, below is a list of articles in this series. </p><br><div class="spoiler">  <b class="spoiler_title">Table of contents</b> <div class="spoiler_text"><ul><li>  <a href="https://habrahabr.ru/post/346306/"><strong>Chapter 1: Hello world!</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346340/"><strong>Chapter 2: Templates</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346342/"><strong>Chapter 3: Web Forms</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346344/"><strong>Chapter 4: Database</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346346/"><strong>Chapter 5: User Logins</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346348/"><strong>Chapter 6: Profile Page and Avatars</strong></a> </li><li>  <a href="https://habrahabr.ru/post/346880/"><strong>Chapter 7: Error Handling</strong></a> </li><li>  <a href="https://habrahabr.ru/post/347450/"><strong>Chapter 8: Subscribers, Contacts, and Friends</strong></a> (This article) </li><li>  <a href="https://habrahabr.ru/post/347926/"><strong>Chapter 9: Pagination</strong></a> </li><li>  <a href="https://habrahabr.ru/post/348566/"><strong>Chapter 10: Email Support</strong></a> </li><li>  <a href="https://habrahabr.ru/post/349060/"><strong>Chapter 11: Reconstruction</strong></a> </li><li>  <a href="https://habrahabr.ru/post/349604/"><strong>Chapter 12: Date and Time</strong></a> </li><li>  <a href="https://habrahabr.ru/post/350148/"><strong>Chapter 13: I18n and L10n</strong></a> </li><li>  <a href="https://habrahabr.ru/post/350626/"><strong>Chapter 14: Ajax</strong></a> </li><li>  <a href="https://habrahabr.ru/post/351218/"><strong>Chapter 15: Improving Application Structure</strong></a> </li><li>  <a href="https://habrahabr.ru/post/351900/"><strong>Chapter 16: Full Text Search</strong></a> </li><li>  <a href="https://habrahabr.ru/post/352266/"><strong>Chapter 17: Deploying to Linux</strong></a> </li><li>  <a href="https://habrahabr.ru/post/352830/"><strong>Chapter 18: Deploying to Heroku</strong></a> </li><li>  <a href="https://habrahabr.ru/post/353234/"><strong>Chapter 19: Deploying to Docker Containers</strong></a> </li><li>  <a href="https://habrahabr.ru/post/353804/"><strong>Chapter 20: JavaScript Magic</strong></a> </li><li>  <a href="https://habrahabr.ru/post/354322/"><strong>Chapter 21: User Notifications</strong></a> </li><li>  <a href="https://habrahabr.ru/post/354752/"><strong>Chapter 22: Background Tasks</strong></a> </li><li>  <a href="https://habrahabr.ru/post/358152/"><strong>Chapter 23: Application Programming Interfaces (APIs)</strong></a> </li></ul></div></div><br><p>  <em>Note 1: If you are looking for old versions of this course, this is <a href="https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world-legacy" title="here">here</a> .</em> </p><br><p>  <em>Note 2: If suddenly you would like to speak in support of my (Miguel) work on this blog, or simply do not have the patience to wait for a week of the article, I (Miguel Greenberg) offer a full version of this guide a packed e-book or video.</em>  <em>For more information, visit <a href="http://learn.miguelgrinberg.com/" title="learn.miguelgrinberg.com">learn.miguelgrinberg.com</a> .</em> </p><br><p>  In this chapter, I will work a little more on the structure of the database.  I want users of the application to easily organize a subscription to their content.  Therefore, I am going to make changes to the database so that it can keep track of who is tracking whom, which is somewhat more complicated than you think. </p><br><p>  <em>GitHub links for this chapter:</em> <a href="">Browse</a> , <a href="">Zip</a> , <a href="">Diff</a> . </p><br><h2 id="snova-svyazi-bazy-dannyh">  Again database links </h2><br><p> As I said above, I want to maintain a list of users "followed" and "followers" <em>("followed" and "follower")</em> for each user.  Unfortunately, the relational database does not have a <code>list</code> type, which I can use for these very lists, all that is - these are tables with records and relationships between these records. </p><br><p>  There is a table in the database representing users <code>users</code> , so it remains to come up with the right type of relationship that the <em>followed / follower</em> link can model.  Let's review the basic types of relationships in the database: </p><br><h3 id="odin-ko-mnogim--one-to-many-">  One to many (One-to-Many) </h3><br><p>  I have already used <em>one-to-many</em> relationships in <a href="https://habrahabr.ru/post/346344/"><strong>chapter 4</strong></a> .  Here is a diagram for this link: </p><br><p><img src="https://habrastorage.org/webt/sr/2u/1c/sr2u1cy4uzvxvxn5nyairks7qns.png"></p><br><p>  The two objects associated with this relationship are users and messages.  We see that the user has <em>many</em> messages, and the message has <em>one</em> user (or author).  The link is represented in the database using the <em>foreign key</em> on the multi side.  In the above link, the foreign key is the <code>user_id</code> field added to the posts table. <br>  This field links each message to its author‚Äôs entry in the user table. </p><br><p>  Obviously, the <code>user_id</code> field provides direct access to the author of this message, but what about the reverse direction?  For the connection to be useful, I must be able to get a list of messages written by this user. <br>  The <code>user_id</code> field in the <code>posts</code> table is also sufficient to answer this question, because the databases have indexes that allow you to create effective queries, so we "retrieve (retrieve) all messages that have user_id from X". </p><br><h3 id="mnogie-ko-mnogim--many-to-many-">  Many-to-many </h3><br><p>  The many-to-many relationship is somewhat more complicated.  As an example, consider a database in which there are <code>students</code> and teachers <code>teachers</code> .  I can say that a student has many teachers, and a teacher has many students.  It looks like two interconnected one-to-many relationships from both ends. <br>  For relationships of this type, I must be able to query the database and get a list of the teachers who teach the student and the list of students in the classroom.  This is not trivial to view in a relational database, since it cannot be done by adding foreign keys to existing tables. </p><br><p>  The <code>many-to-many</code> representation of a multi-valued representation requires the use of an auxiliary table, called the <em>association table</em> .  Here is an example of organizing a search for students and teachers in the database: </p><br><p><img src="https://habrastorage.org/webt/5a/s8/0v/5as80vr1zyjj5lsm3ckpubokbpo.png"></p><br><p>  Perhaps to someone it may seem obscure, the table of associations with two foreign keys effectively responds to all requests for relationships. </p><br><h3 id="mnogo-k-odnomu-i-odin-k-odnomu--many-to-one-and-one-to-one-">  Many-to-one and one-to-one (Many-to-One and One-to-One) </h3><br><p>  Many-to-one looks like a one-to-many relationship.  The difference is that this connection is viewed by the ‚ÄúMany‚Äù. </p><br><p>  One-to-one is a one-to-many special case.  The view is similar, but a restriction is added to the database to prevent the ‚ÄúMany‚Äù side from forbidding to have more than one link. <br>  Although there are cases when this type of relationship is useful, but it is not as common as other types. </p><br><h2 id="predstavlenie-podpischikov">  Submission Subscribers </h2><br><p>  Based on the sum of the analysis of all the types of relationships presented above, it is easy to determine that the correct data model for tracking <em>followers followers</em> is a many-to-many relationship, since the tracker follows <em>many</em> users and the user has <em>many</em> subscribers (followers).  But there is a setup.  In the example of students and teachers, I had two objects that were interconnected by many-to-many relationships.  But in the case of followers, I have users who follow other users, so there are only users.  So what is the second structure of many-to-many relationships? </p><br><p>  The second relationship object is also the user. <br>  A relationship in which class instances are associated with other instances of the same class is called a self-referential relationship, and this is what I have here. </p><br><p>  Here is a diagram of many-to-many self-referencing follower followers: </p><br><p><img src="https://habrastorage.org/webt/rm/7y/9v/rm7y9viomscnk0u2uq1nwbscjra.png"></p><br><p>  The <code>followers</code> table is a relationship association table or relative relationship table.  Foreign keys in this table point to entries in the user table because they associate users with users.  Each entry in this table represents one relationship between the follower user subscriber and the subscribed user followed user.  As an example of students and teachers, a setting like this allows the database to answer all the questions about subscribed and followers that I will ever need.  Pretty neat. </p><br><h2 id="predstavlenie-modeli-bazy-dannyh">  Database Model Representation </h2><br><p>  Let's add followers to the database first.  Here is the subscriber association table: </p><br><pre> <code class="hljs pgsql">followers = db.<span class="hljs-keyword"><span class="hljs-keyword">Table</span></span>(<span class="hljs-string"><span class="hljs-string">'followers'</span></span>, db.<span class="hljs-keyword"><span class="hljs-keyword">Column</span></span>(<span class="hljs-string"><span class="hljs-string">'follower_id'</span></span>, db.Integer, db.ForeignKey(<span class="hljs-string"><span class="hljs-string">'user.id'</span></span>)), db.<span class="hljs-keyword"><span class="hljs-keyword">Column</span></span>(<span class="hljs-string"><span class="hljs-string">'followed_id'</span></span>, db.Integer, db.ForeignKey(<span class="hljs-string"><span class="hljs-string">'user.id'</span></span>)) )</code> </pre> <br><p>  This is a live translation of the table of associations from my diagram above.  Please note that I do not declare this table as a model, as I did for user tables and messages.  Since this is an auxiliary table that does not have data other than foreign keys, I created it without a corresponding model class. </p><br><p>  Now I can declare a many-to-many relationship in the users table: </p><br><pre> <code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">UserMixin</span></span></span></span><span class="hljs-class"><span class="hljs-params">, db.</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Model</span></span></span></span></span><span class="hljs-class">)</span></span>: # ... followed = db.relationship( <span class="hljs-symbol"><span class="hljs-symbol">'Use</span></span>r', secondary=followers, primaryjoin=(followers.c.follower_id == id), secondaryjoin=(followers.c.followed_id == id), backref=db.backref(<span class="hljs-symbol"><span class="hljs-symbol">'follower</span></span>s', <span class="hljs-keyword"><span class="hljs-keyword">lazy</span></span>=<span class="hljs-symbol"><span class="hljs-symbol">'dynami</span></span>c'), <span class="hljs-keyword"><span class="hljs-keyword">lazy</span></span>=<span class="hljs-symbol"><span class="hljs-symbol">'dynami</span></span>c')</code> </pre> <br><blockquote>  <em>Note</em>  followers <em>translator</em> .  <strong>c</strong> .follower_id "c" is an attribute of SQLAlchemy tables that are not defined as models.  For these tables, the table columns are displayed as sub-attributes of this ‚Äúc‚Äù attribute. </blockquote><p>  Setting the relationship is nontrivial.  As with the one-to-many <code>posts</code> relationship, I use the <code>db.relationship</code> function to define relationships in the model class.  This relationship binds <code>User</code> instances to other <code>User</code> instances, since the agreement allows us to say that for a couple of users connected by this relationship, the left side user follows the user of the right side.  I define a connection, as seen from the left side with the name <code>followed</code> , because when I request this link on the left side, I will get a list of subsequent users (ie, those on the right side).  Let's look at all the arguments to <code>db.relationship()</code> one by one: </p><br><ul><li>  <code>'User'</code> is the right side of the connection (the left side is the parent class).  Since this is a self-referential relationship, I must use the same class on both sides. </li><li>  <code>secondary</code> configures the table of associations that is used for this connection, which I defined directly above this class. </li><li>  <code>primaryjoin</code> specifies a condition that associates a left-side object (follower user) with an association table.  The join condition for the left side of the link is the user ID corresponding to the <code>follower_id</code> field of the association table.  The <code>followers.c.follower_id</code> expression references the <code>follower_id</code> column of the association table. </li><li>  <code>secondaryjoin</code> defines a condition that associates the right-side object (followed user) with the association table.  This condition is similar to <code>primaryjoin</code> , with the only difference that I now use <code>followed_id</code> , which is another foreign key in the association table. </li><li>  <code>backref</code> determines how this link will be accessible from the right side of the object.  On the left side of the relationship, users are called <code>followed</code> , so on the right side I will use the <code>followers</code> name to represent all the users on the left side who are associated with the target user on the right side.  An optional <code>lazy</code> argument specifies the execution mode of this query.  The <code>dynamic</code> tuning mode of the query does not allow starting until a specific query is executed, which is also related to how the one-to-many relationship is established. <br>  - <code>lazy</code> is similar to the parameter with the same name in the <code>backref</code> , but this refers to the left, not the right side. </li></ul><br><p>  Do not worry if it is difficult to understand.  I will show you how to work with these requests and then in an instant everything will become clearer. </p><br><p>  Changes in the database must be recorded in the new database migration: </p><br><pre> <code class="hljs vhdl">(venv) $ flask db migrate -m <span class="hljs-string"><span class="hljs-string">"followers"</span></span> INFO [alembic.runtime.migration] <span class="hljs-keyword"><span class="hljs-keyword">Context</span></span> impl SQLiteImpl. INFO [alembic.runtime.migration] Will <span class="hljs-keyword"><span class="hljs-keyword">assume</span></span> non-transactional DDL. INFO [alembic.autogenerate.compare] Detected added table <span class="hljs-symbol"><span class="hljs-symbol">'followers</span></span>' Generating /home/miguel/microblog/migrations/versions/ae346256b650_followers.py ... done (venv) $ flask db upgrade INFO [alembic.runtime.migration] <span class="hljs-keyword"><span class="hljs-keyword">Context</span></span> impl SQLiteImpl. INFO [alembic.runtime.migration] Will <span class="hljs-keyword"><span class="hljs-keyword">assume</span></span> non-transactional DDL. INFO [alembic.runtime.migration] Running upgrade <span class="hljs-number"><span class="hljs-number">37</span></span>f06a334dbf -&gt; ae346256b650, followers</code> </pre> <br><h2 id="dobavlenie-i-udalenie-follows-podpischika">  Adding and deleting "follows" (subscriber) </h2><br><p>  Thanks to the SQLAlchemy ORM, a user who subscribes to another user‚Äôs tracking can be written to the database as <code>followed</code> if it were a list.  For example, if I had two users that are stored in the variables <code>user1</code> and <code>user2</code> , I can make the first <code>user1</code> follow the second <code>user2</code> with this simple statement: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">user1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.followed</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.append</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">user2</span></span>)</code> </pre> <br><p>  In order for <code>user1</code> to abandon tracking <code>user2</code> , you need to do this: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">user1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.followed</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.remove</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">user2</span></span>)</code> </pre> <br><p>  Although adding and removing subscribers is fairly easy, I want to simplify reuse in my code, so I‚Äôm not going to ‚Äúadd‚Äù (appends) and ‚Äúdelete‚Äù (removes) through code.  Instead, I'm going to implement the "follow" and "unfollow" functionality as methods in the <code>User</code> model.  It is always better to move the application logic away from the view functions to the model or to other auxiliary classes or modules, because, as you will see later in this chapter, this makes unit testing much easier. </p><br><p>  Below are the changes in the custom model for adding and removing links: </p><br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UserMixin</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Model</span></span></span><span class="hljs-class">): #... def follow(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">): if not self.is_following(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">): self.followed.append(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">) def unfollow(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">): if self.is_following(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">): self.followed.remove(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">) def is_following(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">): return self.followed.filter( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">followers</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">c</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">followed_id</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">).count() &gt; 0</span></span></code> </pre> <br><p>  The <code>follow()</code> and <code>unfollow()</code> methods use the object's <code>append()</code> and <code>remove()</code> methods, as shown above, but before they are applied, they use the <code>is_following()</code> check method to make sure that the requested action has meaning.  For example, if I ask <em>user1</em> to follow <em>user2</em> , but it turns out that such a task already exists in the database, then why create a duplicate.  The same logic can be applied to <code>unfollowing</code> . </p><br><p>  The <code>is_following()</code> method <code>is_following()</code> whether the relationship exists between two users.  I used to use the SQLAlchemy query <code>filter_by()</code> method, for example, to find a user by their <em>username</em> .  The <code>filter()</code> method that I use here is similar, but lower level, because it can include arbitrary filtering conditions, unlike <code>filter_by()</code> , which can only check equality for a constant value.  The condition I use in <code>is_following()</code> looks for entries in the association table that have the left side foreign key set for the user <code>self</code> , and the right side for the <code>user</code> argument.  The request is terminated by the <code>count()</code> method, which returns the number of records.  The result of this query will be <code>0</code> or <code>1</code> , so checking that the counter is 1 or greater than 0 is actually equivalent.  The other query terminators you've seen in the past are <code>all()</code> and <code>first()</code> . </p><br><h2 id="poluchenie-soobscheniy-ot-followed-users">  Receiving Messages from Followed Users </h2><br><p>  Subscriber support in the database is almost complete, but in fact I‚Äôm missing one important feature.  On the <em>index</em> page of the application, I am going to show blog entries written by all people followed by a registered user, so I need to create a database query that will return these messages. </p><br><p>  The most obvious solution is to run a query that returns a list of followed users, which, as you already know, will be <code>user.followed.all()</code> .  Then for each of these users, I can run a request to receive their messages.  When I have all the messages, I can combine them into one list and sort them by date.  It sounds good?  Well, not quite. </p><br><p>  This approach has several problems.  What happens if a user‚Äôs subscription has thousands of people?  I need to perform thousands of database queries to collect all the messages.  And then I will need to combine and sort the thousands of lists in memory.  As a secondary problem, consider that the application's home page will eventually be <em>broken down</em> by page, so it will not display all the available messages, but only the first few, with a link to get more if needed.  If I am going to display messages sorted by date, how can I find out which messages are the last of all users followed, unless I receive all the messages and sort them first?  This is a really creepy solution that doesn‚Äôt scale well. </p><br><p>  There is no way to avoid this merging and sorting blog posts, but doing <em>THIS</em> in the application leads to a very inefficient process.  This kind of work is what makes relational databases different.  The database has indexes that allow it to perform queries and sorting in a much more efficient way.  So I really want to create a single database query that defines the information I want to get, and then let the database know how to extract this information in the most efficient way. </p><br><p>  Here is the query: </p><br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">db</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Model</span></span></span><span class="hljs-class">): #... def followed_posts(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">): return </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Post</span></span></span><span class="hljs-class">.query.join( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">followers</span></span></span><span class="hljs-class">, (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">followers</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">c</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">followed_id</span></span></span><span class="hljs-class"> == </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Post</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_id</span></span></span><span class="hljs-class">)).filter( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">followers</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">c</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">follower_id</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">).order_by( </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Post</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timestamp</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">desc</span></span></span><span class="hljs-class">())</span></span></code> </pre> <br><p>  This is perhaps the most complex query that I used in this application.  I will try to decrypt this request at once.  If you look at the structure of this query, you will notice that there are three main sections developed by the <code>join()</code> , <code>filter()</code> and <code>order_by()</code> methods of the SQLAlchemy query object: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Post</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.query</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.join</span></span>(...)<span class="hljs-selector-class"><span class="hljs-selector-class">.filter</span></span>(...)<span class="hljs-selector-class"><span class="hljs-selector-class">.order_by</span></span>(...)</code> </pre> <br><h3 id="operacii-obedineniya---joins">  join operations - Joins </h3><br><p>  To understand what the join operation does, let's look at an example.  Suppose I have a User table with the following contents: </p><br><p><img src="https://habrastorage.org/webt/8q/qj/oj/8qqjoja7fzaij0ukyghjenay2ck.png"></p><br><p>  For simplicity, I do not show all the fields in the user model, but only those that are important for this query. </p><br><p>  Suppose that the <code>followers</code> association table says that the user <code>john</code> following the users <code>susan</code> and <code>david</code> , the user <code>susan</code> watching <code>mary</code> , and the user <code>mary</code> watching the <code>david</code> .  The data that are above are: </p><br><p><img src="https://habrastorage.org/webt/dw/1z/fk/dw1zfkmrzwtdv0owu6ywbui6atw.png"></p><br><p>  As a result, the <code>posts</code> table returns one message from each user: </p><br><p>  Here is the <code>join()</code> call that I defined for this query again: </p><br><p> <code>Post.query.join(followers, (followers.c.followed_id == Post.user_id))</code> </p> <br><p>  I invoke the <em>join</em> operation on the <em>posts</em> table.  The first argument is the subscriber association table, and the second argument is the join condition.  What I form with this challenge is that I want the database to create a temporary table that combines data from posts and subscribers tables.  The data will be merged according to the condition I gave as an argument. </p><br><p>  The condition I used says that the <code>followed_id</code> field of the follower table must be equal to the <code>user_id</code> the <em>posts</em> table.  To perform this merge, the database takes each record from the message table (left side of the connection) and adds any records from the <code>followers</code> table (right side of the connection) that match the condition.  If several <code>followers</code> matched, then the record will be repeated for each.  If there are no matches for this message in followers, then this entry is not part of join. </p><br><p>  The result of the merge operation: </p><br><p><img src="https://habrastorage.org/webt/gn/fe/e7/gnfee7xrm0kofw9nnqbz4qdfa6o.png"></p><br><p>  Note that in all cases the <code>user_id</code> and <code>followed_id</code> columns are equal, since this is a join condition.  The message from john is not displayed in the joined table, because there are no records in subscriptions that have john as an interesting user, or in other words, no one is tracking john messages.  But records about david appear twice, because two different users follow this user. </p><br><p>  It is not immediately immediately clear what I will receive by executing this request, but I continue, since this is just one part of a larger request. </p><br><h2 id="filtry">  filters </h2><br><p>  The join operation gave me a list of all the messages that a particular user is following, and this is more than the amount of data that I really want.  I am only interested in a subset of this list, messages that are monitored by only one user, so I need to truncate all the entries I don‚Äôt need and I can do this by calling <code>filter()</code> . </p><br><p>  Here is part of the query filter: </p><br><pre> <code class="hljs swift"><span class="hljs-built_in"><span class="hljs-built_in">filter</span></span>(followers.<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>.follower_id == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.id)</code> </pre> <br><p>  Since this query is in the method of the <code>User</code> class, the expression <code>self.id</code> refers to the user id of the user of interest.  The <code>filter()</code> call selects items in the joined table for which the <code>follower_id</code> column points to this user, which, in other words, means that I only save records in which this user is a subscriber. </p><br><p>  Suppose that I am interested in the user <code>john</code> , whose <code>id</code> field is set to <code>1</code> .  Here is the result of the query after filtering: </p><br><p><img src="https://habrastorage.org/webt/_y/fu/az/_yfuaza6yfzgy26mokohm23jt1e.png"></p><br><p>  And these are exactly the posts that I wanted to see! </p><br><p>  Remember that the query was sent to the Post class, so despite the fact that I received a temporary table created by the database as part of this query, the result will be the records included in this temporary table, without additional columns added by the join operation. </p><br><h3 id="sortirovka">  Sorting </h3><br><p>  The final step is to sort the results.  The part of the request that says: </p><br><pre> <code class="hljs lisp">order_by(<span class="hljs-name"><span class="hljs-name">Post</span></span>.timestamp.desc())</code> </pre> <br><p>  Here I say I want the results to be sorted by timestamp messages in descending order.  Under this condition, the first result will be the most recent blog post. </p><br><h2 id="obedinenie-sobstvennyh-soobscheniy-i-soobscheniy-na-kotorye-podpisan">  Merge your own messages and subscribed messages </h2><br><p>  The query I demonstrated in the <code>followed_posts ()</code> function is extremely useful, but it has one limitation.  People expect to see their own messages in their chronology with the signed ones, but it was not there.  The request does not have this feature. </p><br><p>       ,    .    ‚Äî   ,   ,  ,      .      ,  ,   ,           .     ,       .      ,     ,      .     ‚Äî   ,     ,     union,      . </p><br><p>   ,     .      <code>follow_posts()</code>  ,    ,      : </p><br><pre> <code class="hljs swift">def followed_posts(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>): followed = <span class="hljs-type"><span class="hljs-type">Post</span></span>.query.<span class="hljs-built_in"><span class="hljs-built_in">join</span></span>( followers, (followers.<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>.followed_id == <span class="hljs-type"><span class="hljs-type">Post</span></span>.user_id)).<span class="hljs-built_in"><span class="hljs-built_in">filter</span></span>( followers.<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>.follower_id == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.id) own = <span class="hljs-type"><span class="hljs-type">Post</span></span>.query.filter_by(user_id=<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.id) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> followed.union(own).order_by(<span class="hljs-type"><span class="hljs-type">Post</span></span>.timestamp.desc())</code> </pre> <br><p>  ,  <code>followed</code>  <code></code>    ,  . </p><br><h2 id="unittest-dlya-user-model"> UnitTest  User Model </h2><br><p>      ,   ¬´¬ª ,  ,     .  ,     ,   ,       ,        .   ,  ,    ,    , ‚Äî     ,       ,    . </p><br><p> Python     <code>unittest</code> ,       .           <code>User</code>   <em>tests.py</em> : </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime, timedelta <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> unittest <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> app, db <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>, Post <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> UserModelCase(unittest.TestCase): def setUp(self): app.config[<span class="hljs-string"><span class="hljs-string">'SQLALCHEMY_DATABASE_URI'</span></span>] = <span class="hljs-string"><span class="hljs-string">'sqlite://'</span></span> db.create_all() def tearDown(self): db.<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.remove() db.drop_all() def test_password_hashing(self): u = <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>(username=<span class="hljs-string"><span class="hljs-string">'susan'</span></span>) u.set_password(<span class="hljs-string"><span class="hljs-string">'cat'</span></span>) self.assertFalse(u.check_password(<span class="hljs-string"><span class="hljs-string">'dog'</span></span>)) self.assertTrue(u.check_password(<span class="hljs-string"><span class="hljs-string">'cat'</span></span>)) def test_avatar(self): u = <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>(username=<span class="hljs-string"><span class="hljs-string">'john'</span></span>, email=<span class="hljs-string"><span class="hljs-string">'john@example.com'</span></span>) self.assertEqual(u.avatar(<span class="hljs-number"><span class="hljs-number">128</span></span>), (<span class="hljs-string"><span class="hljs-string">'https://www.gravatar.com/avatar/'</span></span> <span class="hljs-string"><span class="hljs-string">'d4c74594d841139328695756648b6bd6'</span></span> <span class="hljs-string"><span class="hljs-string">'?d=identicon&amp;s=128'</span></span>)) def test_follow(self): u1 = <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>(username=<span class="hljs-string"><span class="hljs-string">'john'</span></span>, email=<span class="hljs-string"><span class="hljs-string">'john@example.com'</span></span>) u2 = <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>(username=<span class="hljs-string"><span class="hljs-string">'susan'</span></span>, email=<span class="hljs-string"><span class="hljs-string">'susan@example.com'</span></span>) db.<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(u1) db.<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(u2) db.<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>() self.assertEqual(u1.followed.<span class="hljs-keyword"><span class="hljs-keyword">all</span></span>(), []) self.assertEqual(u1.followers.<span class="hljs-keyword"><span class="hljs-keyword">all</span></span>(), []) u1.follow(u2) db.<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>() self.assertTrue(u1.is_following(u2)) self.assertEqual(u1.followed.count(), <span class="hljs-number"><span class="hljs-number">1</span></span>) self.assertEqual(u1.followed.first().username, <span class="hljs-string"><span class="hljs-string">'susan'</span></span>) self.assertEqual(u2.followers.count(), <span class="hljs-number"><span class="hljs-number">1</span></span>) self.assertEqual(u2.followers.first().username, <span class="hljs-string"><span class="hljs-string">'john'</span></span>) u1.unfollow(u2) db.<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>() self.assertFalse(u1.is_following(u2)) self.assertEqual(u1.followed.count(), <span class="hljs-number"><span class="hljs-number">0</span></span>) self.assertEqual(u2.followers.count(), <span class="hljs-number"><span class="hljs-number">0</span></span>) def test_follow_posts(self): # <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> four users u1 = <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>(username=<span class="hljs-string"><span class="hljs-string">'john'</span></span>, email=<span class="hljs-string"><span class="hljs-string">'john@example.com'</span></span>) u2 = <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>(username=<span class="hljs-string"><span class="hljs-string">'susan'</span></span>, email=<span class="hljs-string"><span class="hljs-string">'susan@example.com'</span></span>) u3 = <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>(username=<span class="hljs-string"><span class="hljs-string">'mary'</span></span>, email=<span class="hljs-string"><span class="hljs-string">'mary@example.com'</span></span>) u4 = <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>(username=<span class="hljs-string"><span class="hljs-string">'david'</span></span>, email=<span class="hljs-string"><span class="hljs-string">'david@example.com'</span></span>) db.<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.add_all([u1, u2, u3, u4]) # <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> four posts now = datetime.utcnow() p1 = Post(body="post from john", author=u1, <span class="hljs-type"><span class="hljs-type">timestamp</span></span>=now + timedelta(seconds=<span class="hljs-number"><span class="hljs-number">1</span></span>)) p2 = Post(body="post from susan", author=u2, <span class="hljs-type"><span class="hljs-type">timestamp</span></span>=now + timedelta(seconds=<span class="hljs-number"><span class="hljs-number">4</span></span>)) p3 = Post(body="post from mary", author=u3, <span class="hljs-type"><span class="hljs-type">timestamp</span></span>=now + timedelta(seconds=<span class="hljs-number"><span class="hljs-number">3</span></span>)) p4 = Post(body="post from david", author=u4, <span class="hljs-type"><span class="hljs-type">timestamp</span></span>=now + timedelta(seconds=<span class="hljs-number"><span class="hljs-number">2</span></span>)) db.<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.add_all([p1, p2, p3, p4]) db.<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>() # setup the followers u1.follow(u2) # john follows susan u1.follow(u4) # john follows david u2.follow(u3) # susan follows mary u3.follow(u4) # mary follows david db.<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>() # <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> the followed posts <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> f1 = u1.followed_posts().<span class="hljs-keyword"><span class="hljs-keyword">all</span></span>() f2 = u2.followed_posts().<span class="hljs-keyword"><span class="hljs-keyword">all</span></span>() f3 = u3.followed_posts().<span class="hljs-keyword"><span class="hljs-keyword">all</span></span>() f4 = u4.followed_posts().<span class="hljs-keyword"><span class="hljs-keyword">all</span></span>() self.assertEqual(f1, [p2, p4, p1]) self.assertEqual(f2, [p2, p3]) self.assertEqual(f3, [p3, p4]) self.assertEqual(f4, [p4]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: unittest.main(verbosity=<span class="hljs-number"><span class="hljs-number">2</span></span>)</code> </pre> <br><p>    ,    ,        .  <code>setUp()</code>  <code>tearDown()</code> ‚Äî   ,           .      <code>setUp()</code> ,         ,     .     <code>sqlite://</code>   SQLAlchemy     SQLite     .  <code>db.create_all()</code>     .        ,    .        ,         . </p><br><p>          : </p><br><pre> <code class="hljs erlang-repl">(venv) $ python tests.py test_avatar (__main__.UserModelCase) ... ok test_follow (__main__.UserModelCase) ... ok test_follow_posts (__main__.UserModelCase) ... ok test_password_hashing (__main__.UserModelCase) ... ok ---------------------------------------------------------------------- Ran <span class="hljs-number"><span class="hljs-number">4</span></span> tests in <span class="hljs-number"><span class="hljs-number">0.494</span></span>s OK</code> </pre> <br><p>     ,     ,     ,  ,      .  ,  ,       ,     . </p><br><h2 id="integraciya-podpischikov-s-pomoschyu-prilozheniya">      </h2><br><p>        ,         ,   ,      .  ,      ,      ,    . </p><br><p>       ,       : </p><br><pre> <code class="hljs pgsql">@app.route(<span class="hljs-string"><span class="hljs-string">'/follow/&lt;username&gt;'</span></span>) @login_required def follow(username): <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>.query.filter_by(username=username).first() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: flash(<span class="hljs-string"><span class="hljs-string">'User {} not found.'</span></span>.format(username)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> redirect(url_for(<span class="hljs-string"><span class="hljs-string">'index'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> == <span class="hljs-built_in"><span class="hljs-built_in">current_user</span></span>: flash(<span class="hljs-string"><span class="hljs-string">'You cannot follow yourself!'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> redirect(url_for(<span class="hljs-string"><span class="hljs-string">'user'</span></span>, username=username)) <span class="hljs-built_in"><span class="hljs-built_in">current_user</span></span>.follow(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) db.<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>() flash(<span class="hljs-string"><span class="hljs-string">'You are following {}!'</span></span>.format(username)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> redirect(url_for(<span class="hljs-string"><span class="hljs-string">'user'</span></span>, username=username)) @app.route(<span class="hljs-string"><span class="hljs-string">'/unfollow/&lt;username&gt;'</span></span>) @login_required def unfollow(username): <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>.query.filter_by(username=username).first() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: flash(<span class="hljs-string"><span class="hljs-string">'User {} not found.'</span></span>.format(username)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> redirect(url_for(<span class="hljs-string"><span class="hljs-string">'index'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> == <span class="hljs-built_in"><span class="hljs-built_in">current_user</span></span>: flash(<span class="hljs-string"><span class="hljs-string">'You cannot unfollow yourself!'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> redirect(url_for(<span class="hljs-string"><span class="hljs-string">'user'</span></span>, username=username)) <span class="hljs-built_in"><span class="hljs-built_in">current_user</span></span>.unfollow(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>) db.<span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>() flash(<span class="hljs-string"><span class="hljs-string">'You are not following {}.'</span></span>.format(username)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> redirect(url_for(<span class="hljs-string"><span class="hljs-string">'user'</span></span>, username=username))</code> </pre> <br><p>    ,       ,   ,           ,   . </p><br><p> ,   View   ,       .              : </p><br><pre> <code class="hljs django"><span class="xml"><span class="xml"> ... </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">User: </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ user.username }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">if</span></span></span></span></span><span class="hljs-template-tag"> user.about_me %}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ user.about_me }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endif</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">if</span></span></span></span></span><span class="hljs-template-tag"> user.last_seen %}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Last seen on: </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ user.last_seen }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endif</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ user.followers.count() }}</span></span><span class="xml"><span class="xml"> followers, </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ user.followed.count() }}</span></span><span class="xml"><span class="xml"> following.</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">if</span></span></span></span></span><span class="hljs-template-tag"> user == current_user %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url_for('edit_profile') }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Edit your profile</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">elif</span></span></span></span></span><span class="hljs-template-tag"> not current_user.is_following(user) %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url_for('follow', username=user.username) }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Follow</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">else</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url_for('unfollow', username=user.username) }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Unfollow</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endif</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> ...</span></span></code> </pre> <br><p> ,     ,       ,     .  ,    "" (Edit),              : </p><br><ul><li>     ,  "Edit" ,  . </li></ul><br><p><img src="https://habrastorage.org/webt/6w/dd/ys/6wddyssufd_9m6la_59t2zomxjm.png"></p><br><ul><li>    ,       ,  "Follow". </li></ul><br><p><img src="https://habrastorage.org/webt/sw/fh/jy/swfhjysyo0twjtaqpizdaaiofb0.png"></p><br><ul><li>    ,       ,  "Unfollow". </li></ul><br><p><img src="https://habrastorage.org/webt/z8/2p/aq/z82paqnsxc7x0uwzs8pt9c13m-o.png"></p><br><p>       ,            . ,    ,   URL   ,          ,          . ,          <code>susan</code> ,     <a href="http://localhost:5000/user/susan">http://localhost:5000/user/susan</a>    ,         . ,      ,   ,         . </p><br><p>     c    index  ,       ,   ,          .         ,         . </p><br><p>  <a href="https://habrahabr.ru/post/346880/">&lt;&lt;&lt; previous</a> <a href="https://habrahabr.ru/post/347926/">next &gt;&gt;&gt;</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/347450/">https://habr.com/ru/post/347450/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347440/index.html">Salaries of IT Professionals at the End of 2017: My Circle Salary Service Report</a></li>
<li><a href="../347442/index.html">Designing a fire pumping station</a></li>
<li><a href="../347444/index.html">Gestalt principles in user interface design</a></li>
<li><a href="../347446/index.html">Mission Impossible or get a certificate</a></li>
<li><a href="../347448/index.html">‚ÄúCourse on hyperscale‚Äù: there are almost 400 hyper-scalable data centers in the world</a></li>
<li><a href="../347452/index.html">IT solutions architecture. Part 2. Architects</a></li>
<li><a href="../347454/index.html">Familiar faces: algorithms for creating a "typical" portrait</a></li>
<li><a href="../347456/index.html">Layer 7 DoS: Web Application Denial of Service Attacks</a></li>
<li><a href="../347458/index.html">Frequent difficulties in working with React.js</a></li>
<li><a href="../347460/index.html">Google Pay Integration</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>