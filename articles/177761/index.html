<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MongoDB: Too many fields to index? Use a common index</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The essence of the problem 
 There are situations when documents have many different fields and you need to have effective queries on them. For exampl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MongoDB: Too many fields to index? Use a common index</h1><div class="post__text post__text-html js-mediator-article"><h4>  The essence of the problem </h4><br>  There are situations when documents have many different fields and you need to have effective queries on them.  For example, there is a document describing a person: <br><br><pre><code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-attr"><span class="hljs-attr">firstName</span></span>: <span class="hljs-string"><span class="hljs-string">"John"</span></span>, <span class="hljs-attr"><span class="hljs-attr">lastName</span></span>: <span class="hljs-string"><span class="hljs-string">"Smith"</span></span>, <span class="hljs-attr"><span class="hljs-attr">age</span></span>: <span class="hljs-number"><span class="hljs-number">25</span></span>, <span class="hljs-attr"><span class="hljs-attr">height</span></span>: <span class="hljs-number"><span class="hljs-number">6.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">dob</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>, <span class="hljs-attr"><span class="hljs-attr">eyes</span></span>: <span class="hljs-string"><span class="hljs-string">"blue"</span></span>, <span class="hljs-attr"><span class="hljs-attr">sign</span></span>: <span class="hljs-string"><span class="hljs-string">"Capricorn"</span></span>, ... }</code> </pre> <br><br>  According to such documents, you can make a selection of people by eye color, a certain height, name, and other characteristics.  And what if for example a document consists of dozens of fields, or are not known in advance, or does each document have its own set of fields?  How to quickly solve this problem with the help of indexes, but at the same time not to build them for each field, because it is too expensive a solution. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Solution # 1: Composite index by field names and values </h4><br>  We will design the document schema using the opportunity to store the document fields as a list of objects: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">_id</span></span>: <span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-attr"><span class="hljs-attr">props</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">n</span></span>: <span class="hljs-string"><span class="hljs-string">"firstName"</span></span>, <span class="hljs-attr"><span class="hljs-attr">v</span></span>: <span class="hljs-string"><span class="hljs-string">"John"</span></span>}, { <span class="hljs-attr"><span class="hljs-attr">n</span></span>: <span class="hljs-string"><span class="hljs-string">"lastName"</span></span>, <span class="hljs-attr"><span class="hljs-attr">v</span></span>: <span class="hljs-string"><span class="hljs-string">"Smith"</span></span>}, { <span class="hljs-attr"><span class="hljs-attr">n</span></span>: <span class="hljs-string"><span class="hljs-string">"age"</span></span>, <span class="hljs-attr"><span class="hljs-attr">v</span></span>: <span class="hljs-number"><span class="hljs-number">25</span></span>}, ... ] }</code> </pre><br><br>  To solve the problem, a composite index is created by the name and value of the objects inside the list.  For clarity, let's create 5 million documents consisting of dummy properties from <code>prop0</code> to <code>prop9</code> that have a random value from <code>0</code> to <code>1000</code> . <br><br><pre> <code class="javascript hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">5000000</span></span>; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arr = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; ++j) { arr.push({<span class="hljs-attr"><span class="hljs-attr">n</span></span>: <span class="hljs-string"><span class="hljs-string">"prop"</span></span> + j, <span class="hljs-attr"><span class="hljs-attr">v</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * <span class="hljs-number"><span class="hljs-number">1000</span></span>) }) }; db.generic.insert({<span class="hljs-attr"><span class="hljs-attr">props</span></span>: arr}) } &gt; db.generic.findOne() { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: ObjectId(<span class="hljs-string"><span class="hljs-string">"515dd3b4f0bd676b816aa9b0"</span></span>), <span class="hljs-string"><span class="hljs-string">"props"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"n"</span></span>: <span class="hljs-string"><span class="hljs-string">"prop0"</span></span>, <span class="hljs-string"><span class="hljs-string">"v"</span></span>: <span class="hljs-number"><span class="hljs-number">40</span></span> }, { <span class="hljs-string"><span class="hljs-string">"n"</span></span>: <span class="hljs-string"><span class="hljs-string">"prop1"</span></span>, <span class="hljs-string"><span class="hljs-string">"v"</span></span>: <span class="hljs-number"><span class="hljs-number">198</span></span> }, ... { <span class="hljs-string"><span class="hljs-string">"n"</span></span>: <span class="hljs-string"><span class="hljs-string">"prop9"</span></span>, <span class="hljs-string"><span class="hljs-string">"v"</span></span>: <span class="hljs-number"><span class="hljs-number">652</span></span> } ] } &gt; db.generic.ensureIndex({<span class="hljs-string"><span class="hljs-string">"props.n"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"props.v"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}) &gt; db.generic.stats() { <span class="hljs-string"><span class="hljs-string">"ns"</span></span>: <span class="hljs-string"><span class="hljs-string">"test.generic"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span>: <span class="hljs-number"><span class="hljs-number">5020473</span></span>, <span class="hljs-string"><span class="hljs-string">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">1847534064</span></span>, <span class="hljs-string"><span class="hljs-string">"avgObjSize"</span></span>: <span class="hljs-number"><span class="hljs-number">368</span></span>, <span class="hljs-string"><span class="hljs-string">"storageSize"</span></span>: <span class="hljs-number"><span class="hljs-number">2600636416</span></span>, <span class="hljs-string"><span class="hljs-string">"numExtents"</span></span>: <span class="hljs-number"><span class="hljs-number">19</span></span>, <span class="hljs-string"><span class="hljs-string">"nindexes"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"lastExtentSize"</span></span>: <span class="hljs-number"><span class="hljs-number">680280064</span></span>, <span class="hljs-string"><span class="hljs-string">"paddingFactor"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"systemFlags"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"userFlags"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"totalIndexSize"</span></span>: <span class="hljs-number"><span class="hljs-number">1785352240</span></span>, <span class="hljs-string"><span class="hljs-string">"indexSizes"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_id_"</span></span>: <span class="hljs-number"><span class="hljs-number">162898624</span></span>, <span class="hljs-string"><span class="hljs-string">"props.n_1_props.v_1"</span></span>: <span class="hljs-number"><span class="hljs-number">1622453616</span></span> }, <span class="hljs-string"><span class="hljs-string">"ok"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre><br><br>  In this case, the size of the index is 1.6 GB because the index stores both the name of the property and its value.  Now let's try to find documents in which <code>prop1</code> is <code>0</code> : <br><br><pre> <code class="javascript hljs">&gt; db.generic.findOne({<span class="hljs-string"><span class="hljs-string">"props.n"</span></span>: <span class="hljs-string"><span class="hljs-string">"prop1"</span></span>, <span class="hljs-string"><span class="hljs-string">"props.v"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>}) { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: ObjectId(<span class="hljs-string"><span class="hljs-string">"515dd4298bff7c34610f6ae8"</span></span>), <span class="hljs-string"><span class="hljs-string">"props"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"n"</span></span>: <span class="hljs-string"><span class="hljs-string">"prop0"</span></span>, <span class="hljs-string"><span class="hljs-string">"v"</span></span>: <span class="hljs-number"><span class="hljs-number">788</span></span> }, { <span class="hljs-string"><span class="hljs-string">"n"</span></span>: <span class="hljs-string"><span class="hljs-string">"prop1"</span></span>, <span class="hljs-string"><span class="hljs-string">"v"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> }, ... { <span class="hljs-string"><span class="hljs-string">"n"</span></span>: <span class="hljs-string"><span class="hljs-string">"prop9"</span></span>, <span class="hljs-string"><span class="hljs-string">"v"</span></span>: <span class="hljs-number"><span class="hljs-number">788</span></span> } ] } &gt; db.generic.find({<span class="hljs-string"><span class="hljs-string">"props.n"</span></span>: <span class="hljs-string"><span class="hljs-string">"prop1"</span></span>, <span class="hljs-string"><span class="hljs-string">"props.v"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>}).explain() { <span class="hljs-string"><span class="hljs-string">"cursor"</span></span>: <span class="hljs-string"><span class="hljs-string">"BtreeCursor props.n_1_props.v_1"</span></span>, <span class="hljs-string"><span class="hljs-string">"isMultiKey"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"n"</span></span>: <span class="hljs-number"><span class="hljs-number">49822</span></span>, <span class="hljs-string"><span class="hljs-string">"nscannedObjects"</span></span>: <span class="hljs-number"><span class="hljs-number">5020473</span></span>, <span class="hljs-string"><span class="hljs-string">"nscanned"</span></span>: <span class="hljs-number"><span class="hljs-number">5020473</span></span>, <span class="hljs-string"><span class="hljs-string">"nscannedObjectsAllPlans"</span></span>: <span class="hljs-number"><span class="hljs-number">5020473</span></span>, <span class="hljs-string"><span class="hljs-string">"nscannedAllPlans"</span></span>: <span class="hljs-number"><span class="hljs-number">5020473</span></span>, <span class="hljs-string"><span class="hljs-string">"scanAndOrder"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"indexOnly"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"nYields"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"nChunkSkips"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"millis"</span></span>: <span class="hljs-number"><span class="hljs-number">252028</span></span>, <span class="hljs-string"><span class="hljs-string">"indexBounds"</span></span>: { <span class="hljs-string"><span class="hljs-string">"props.n"</span></span>: [ [ <span class="hljs-string"><span class="hljs-string">"prop1"</span></span>, <span class="hljs-string"><span class="hljs-string">"prop1"</span></span> ] ], <span class="hljs-string"><span class="hljs-string">"props.v"</span></span>: [ [ { <span class="hljs-string"><span class="hljs-string">"$minElement"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { <span class="hljs-string"><span class="hljs-string">"$maxElement"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> } ] ] }, <span class="hljs-string"><span class="hljs-string">"server"</span></span>: <span class="hljs-string"><span class="hljs-string">"agmac.local:27017"</span></span> }</code> </pre><br><br>  This solution did not produce the expected result: ~ 50,000 documents were found in 252 seconds.  This happens because each query <code>n=prop1</code> and <code>v=0</code> does not require the fulfillment of both conditions simultaneously for attached documents, therefore the final result includes documents satisfying both the requirement <code>n=prop1</code> and <code>v=0</code> separately, and this is not at all what was expected.  You can refine your request using <code>$elemMatch</code> : <br><br><pre> <code class="javascript hljs">&gt; db.generic.findOne({<span class="hljs-string"><span class="hljs-string">"props"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">$elemMatch</span></span>: {<span class="hljs-attr"><span class="hljs-attr">n</span></span>: <span class="hljs-string"><span class="hljs-string">"prop1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">v</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>} }})</code> </pre><br><br>  Now let's check how the index is used and how long the query is executed in MongoDB v2.2: <br><br><pre> <code class="javascript hljs">&gt; db.generic.find({<span class="hljs-string"><span class="hljs-string">"props"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">$elemMatch</span></span>: {<span class="hljs-attr"><span class="hljs-attr">n</span></span>: <span class="hljs-string"><span class="hljs-string">"prop1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">v</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>} }}).explain() { <span class="hljs-string"><span class="hljs-string">"cursor"</span></span>: <span class="hljs-string"><span class="hljs-string">"BtreeCursor props.n_1_props.v_1"</span></span>, <span class="hljs-string"><span class="hljs-string">"isMultiKey"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"n"</span></span>: <span class="hljs-number"><span class="hljs-number">5024</span></span>, <span class="hljs-string"><span class="hljs-string">"nscannedObjects"</span></span>: <span class="hljs-number"><span class="hljs-number">5020473</span></span>, <span class="hljs-string"><span class="hljs-string">"nscanned"</span></span>: <span class="hljs-number"><span class="hljs-number">5020473</span></span>, <span class="hljs-string"><span class="hljs-string">"nscannedObjectsAllPlans"</span></span>: <span class="hljs-number"><span class="hljs-number">5020473</span></span>, <span class="hljs-string"><span class="hljs-string">"nscannedAllPlans"</span></span>: <span class="hljs-number"><span class="hljs-number">5020473</span></span>, <span class="hljs-string"><span class="hljs-string">"scanAndOrder"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"indexOnly"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"nYields"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"nChunkSkips"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"millis"</span></span>: <span class="hljs-number"><span class="hljs-number">278784</span></span>, <span class="hljs-string"><span class="hljs-string">"indexBounds"</span></span>: { <span class="hljs-string"><span class="hljs-string">"props.n"</span></span>: [ [ <span class="hljs-string"><span class="hljs-string">"prop1"</span></span>, <span class="hljs-string"><span class="hljs-string">"prop1"</span></span> ] ], <span class="hljs-string"><span class="hljs-string">"props.v"</span></span>: [ [ { <span class="hljs-string"><span class="hljs-string">"$minElement"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { <span class="hljs-string"><span class="hljs-string">"$maxElement"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> } ] ] }, <span class="hljs-string"><span class="hljs-string">"server"</span></span>: <span class="hljs-string"><span class="hljs-string">"agmac.local:27017"</span></span> }</code> </pre><br><br>  The request was executed correctly and returned 5024 documents, but still slow!  From the information of the <code>explain</code> command, you can see that the reason is that the range is still used for the <code>v</code> field.  In order to understand why this is happening, let's look at an example in more detail.  If you do not use <code>$elemMatch</code> then all combinations of fields that satisfy at least one of the query conditions separately can fall into the final sample.  In this case, it would be impossible to use to maintain the index, because it would lead to a huge number of possible combinations.  Therefore, when requested, MongoDB made a choice in favor of building a B-Tree from the values ‚Äã‚Äãof attached documents and ignoring possible combinations (the main behavior for <code>$elemMatch</code> ).  But why is the query with <code>$elemMatch</code> running so slowly?  This was due to a bug that was fixed by <a href="https://jira.mongodb.org/browse/SERVER-3104">SERVER-3104</a> in MongoDB v2.4.  Let's check the same request in the corrected version: <br><br><pre> <code class="javascript hljs">&gt; db.generic.find({<span class="hljs-string"><span class="hljs-string">"props"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">$elemMatch</span></span>: {<span class="hljs-attr"><span class="hljs-attr">n</span></span>: <span class="hljs-string"><span class="hljs-string">"prop1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">v</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>} }}).explain() { <span class="hljs-string"><span class="hljs-string">"cursor"</span></span>: <span class="hljs-string"><span class="hljs-string">"BtreeCursor props.n_1_props.v_1"</span></span>, <span class="hljs-string"><span class="hljs-string">"isMultiKey"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"n"</span></span>: <span class="hljs-number"><span class="hljs-number">5024</span></span>, <span class="hljs-string"><span class="hljs-string">"nscannedObjects"</span></span>: <span class="hljs-number"><span class="hljs-number">5024</span></span>, <span class="hljs-string"><span class="hljs-string">"nscanned"</span></span>: <span class="hljs-number"><span class="hljs-number">5024</span></span>, <span class="hljs-string"><span class="hljs-string">"nscannedObjectsAllPlans"</span></span>: <span class="hljs-number"><span class="hljs-number">5024</span></span>, <span class="hljs-string"><span class="hljs-string">"nscannedAllPlans"</span></span>: <span class="hljs-number"><span class="hljs-number">5024</span></span>, <span class="hljs-string"><span class="hljs-string">"scanAndOrder"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"indexOnly"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"nYields"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"nChunkSkips"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"millis"</span></span>: <span class="hljs-number"><span class="hljs-number">21</span></span>, <span class="hljs-string"><span class="hljs-string">"indexBounds"</span></span>: { <span class="hljs-string"><span class="hljs-string">"props.n"</span></span>: [ [ <span class="hljs-string"><span class="hljs-string">"prop1"</span></span>, <span class="hljs-string"><span class="hljs-string">"prop1"</span></span> ] ], <span class="hljs-string"><span class="hljs-string">"props.v"</span></span>: [ [ <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ] ] }, <span class="hljs-string"><span class="hljs-string">"server"</span></span>: <span class="hljs-string"><span class="hljs-string">"agmac.local:27017"</span></span> }</code> </pre><br><br>  Request executed in 21 milliseconds! <br><br><h4>  Solution # 2: One Common Index </h4><br>  Another way to solve the problem is to store the fields in the list as <code>property: value</code> objects.  This solution works in MongoDB version v2.2 and v2.4.  Create documents of the form: <br><br><pre> <code class="javascript hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">5000000</span></span>; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arr = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; ++j) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> doc = {}; doc[<span class="hljs-string"><span class="hljs-string">"prop"</span></span> + j] = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * <span class="hljs-number"><span class="hljs-number">1000</span></span>); arr.push(doc) }) }; db.generic2.insert({<span class="hljs-attr"><span class="hljs-attr">props</span></span>: arr}) } &gt; db.generic2.findOne() { <span class="hljs-string"><span class="hljs-string">"_id"</span></span>: ObjectId(<span class="hljs-string"><span class="hljs-string">"515e5e6a71b0722678929760"</span></span>), <span class="hljs-string"><span class="hljs-string">"props"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"prop0"</span></span>: <span class="hljs-number"><span class="hljs-number">881</span></span> }, { <span class="hljs-string"><span class="hljs-string">"prop1"</span></span>: <span class="hljs-number"><span class="hljs-number">47</span></span> }, ... { <span class="hljs-string"><span class="hljs-string">"prop9"</span></span>: <span class="hljs-number"><span class="hljs-number">717</span></span> } ] }</code> </pre><br><br>  Build the index: <br><br><pre> <code class="javascript hljs">&gt; db.generic2.ensureIndex({<span class="hljs-attr"><span class="hljs-attr">props</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}) &gt; db.generic2.stats() { <span class="hljs-string"><span class="hljs-string">"ns"</span></span>: <span class="hljs-string"><span class="hljs-string">"test.generic2"</span></span>, <span class="hljs-string"><span class="hljs-string">"count"</span></span>: <span class="hljs-number"><span class="hljs-number">5000000</span></span>, <span class="hljs-string"><span class="hljs-string">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">1360000032</span></span>, <span class="hljs-string"><span class="hljs-string">"avgObjSize"</span></span>: <span class="hljs-number"><span class="hljs-number">272.0000064</span></span>, <span class="hljs-string"><span class="hljs-string">"storageSize"</span></span>: <span class="hljs-number"><span class="hljs-number">1499676672</span></span>, <span class="hljs-string"><span class="hljs-string">"numExtents"</span></span>: <span class="hljs-number"><span class="hljs-number">19</span></span>, <span class="hljs-string"><span class="hljs-string">"nindexes"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"lastExtentSize"</span></span>: <span class="hljs-number"><span class="hljs-number">393670656</span></span>, <span class="hljs-string"><span class="hljs-string">"paddingFactor"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"systemFlags"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"userFlags"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"totalIndexSize"</span></span>: <span class="hljs-number"><span class="hljs-number">2384023488</span></span>, <span class="hljs-string"><span class="hljs-string">"indexSizes"</span></span>: { <span class="hljs-string"><span class="hljs-string">"_id_"</span></span>: <span class="hljs-number"><span class="hljs-number">162269072</span></span>, <span class="hljs-string"><span class="hljs-string">"props_1"</span></span>: <span class="hljs-number"><span class="hljs-number">2221754416</span></span> }, <span class="hljs-string"><span class="hljs-string">"ok"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre><br><br>  The size of the index turned out to be ~ 2.2 GB in size, which is 40% more than in solution # 1 because BSON of the attached documents stores itself in the index as BLOBs.  Now run the query: <br><br><pre> <code class="javascript hljs">&gt; db.generic2.find({<span class="hljs-string"><span class="hljs-string">"props"</span></span>: {<span class="hljs-string"><span class="hljs-string">"prop1"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>} }).explain() { <span class="hljs-string"><span class="hljs-string">"cursor"</span></span>: <span class="hljs-string"><span class="hljs-string">"BtreeCursor props_1"</span></span>, <span class="hljs-string"><span class="hljs-string">"isMultiKey"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"n"</span></span>: <span class="hljs-number"><span class="hljs-number">4958</span></span>, <span class="hljs-string"><span class="hljs-string">"nscannedObjects"</span></span>: <span class="hljs-number"><span class="hljs-number">4958</span></span>, <span class="hljs-string"><span class="hljs-string">"nscanned"</span></span>: <span class="hljs-number"><span class="hljs-number">4958</span></span>, <span class="hljs-string"><span class="hljs-string">"nscannedObjectsAllPlans"</span></span>: <span class="hljs-number"><span class="hljs-number">4958</span></span>, <span class="hljs-string"><span class="hljs-string">"nscannedAllPlans"</span></span>: <span class="hljs-number"><span class="hljs-number">4958</span></span>, <span class="hljs-string"><span class="hljs-string">"scanAndOrder"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"indexOnly"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"nYields"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"nChunkSkips"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"millis"</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-string"><span class="hljs-string">"indexBounds"</span></span>: { <span class="hljs-string"><span class="hljs-string">"props"</span></span>: [ [ { <span class="hljs-string"><span class="hljs-string">"prop1"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> }, { <span class="hljs-string"><span class="hljs-string">"prop1"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> } ] ] }, <span class="hljs-string"><span class="hljs-string">"server"</span></span>: <span class="hljs-string"><span class="hljs-string">"agmac.local:27017"</span></span> }</code> </pre><br><br>  The request was completed in 15 ms, which is faster than the first solution!  But there is one condition, when making a request, it is necessary to describe the entire subdocument object.  In order to perform a sample of documents that meet the query where <code>prop1</code> can be equal to from <code>0</code> to <code>9</code> , you need to run the query: <br><br><pre> <code class="javascript hljs">&gt; db.generic2.find({<span class="hljs-string"><span class="hljs-string">"props"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">$gte</span></span>: {<span class="hljs-string"><span class="hljs-string">"prop1"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>}, <span class="hljs-attr"><span class="hljs-attr">$lte</span></span>: {<span class="hljs-string"><span class="hljs-string">"prop1"</span></span>: <span class="hljs-number"><span class="hljs-number">9</span></span>} })</code> </pre><br><br>  It is a little inconvenient, as well as if there are other fields in the attached document, they should be involved in the preparation of the request (as the attached documents are stored as BLOBs). <br>  There is also another limitation: it is impossible to index separately only the field values, whereas in solution # 1 you can build an index <code>props.v</code> for searching for example all documents having the value <code>10</code> .  Solution # 2 does not allow this. <br><br><h4>  Conclusion </h4><br>  You can see that MongoDB v2.4 now offers a simple and effective solution for building common indexes for documents with a large number of fields that you can use for your ‚ÄúBig Data‚Äù projects. </div><p>Source: <a href="https://habr.com/ru/post/177761/">https://habr.com/ru/post/177761/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../177747/index.html">The first phones on Firefox OS dispersed in a few hours</a></li>
<li><a href="../177749/index.html">Google bought a news startup Wavii for more than $ 30 million</a></li>
<li><a href="../177753/index.html">Are we not heroes? Mission for the company</a></li>
<li><a href="../177755/index.html">Easy way to manage remote devices</a></li>
<li><a href="../177759/index.html">tFormer.js - bike for form validation</a></li>
<li><a href="../177763/index.html">About cloud and not only technologies of Yandex in Kiev this Saturday</a></li>
<li><a href="../177767/index.html">Balancing 2 or more channels on FreeBSD using PF + Squid</a></li>
<li><a href="../177769/index.html">Online editor for Bootstrap ‚Äî LayoutIt</a></li>
<li><a href="../177775/index.html">Package Manager for Xcode</a></li>
<li><a href="../177779/index.html">Apple reported on the results of the previous quarter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>