<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Programming language and database Q: syntax does not matter in the enterprise</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There was a need to choose a new tariff plan for the cellular. It became clear for 30 minutes to carry with excel and google-docs that nothing sensibl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Programming language and database Q: syntax does not matter in the enterprise</h1><div class="post__text post__text-html js-mediator-article">  There was a need to choose a new tariff plan for the cellular.  It became clear for 30 minutes to carry with excel and google-docs that nothing sensible could come of it and db could not do here. <br><br>  A little thought the hand itself scored "q", since it was the only available on the computer here and now.  What I knew about him: that he first and last time launched a year ago, about 30 minutes, for a simple <a href="http://nponeccop.livejournal.com/225261.html">task</a> of parsing and searching through a file. <br><br>  Next, there will be a lot of q, namely, ascii, a follower of a subset of the languages ‚Äã‚Äãof APL and Scheme, namely, <a href="http://en.wikipedia.org/wiki/K_(programming_language)">k</a> and its k-sql extensions, which were reborn into a product named <a href="http://en.wikipedia.org/wiki/Q_(programming_language_from_Kx_Systems)">Q</a> - a close link of the language and the database built into it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs tex">C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Users</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">unknown</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Dropbox</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">j</span></span></span></span>&gt;q KDB+ 3.0 2013.02.06 Copyright (C) 1993-2013 Kx Systems w32/ 2()core 2972MB unknown win-d2om7les24v 192.168.1.2 PLAY 2013.05.07</code> </pre> <br><br><a name="habracut"></a><br>  Some lyrics: I download the report from the operator's site in csv and slightly correct the title: <br><pre> <code class="hljs css">; ;<span class="hljs-selector-tag"><span class="hljs-selector-tag">tel</span></span>;<span class="hljs-selector-tag"><span class="hljs-selector-tag">time</span></span>;<span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>; ;<span class="hljs-selector-tag"><span class="hljs-selector-tag">money</span></span>; ;    ;22<span class="hljs-selector-class"><span class="hljs-selector-class">.02</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2013</span></span> 20<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:38</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:14</span></span>;79064014328;00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:13</span></span>;0;114,9175;0,0000;114,9175;  ;22<span class="hljs-selector-class"><span class="hljs-selector-class">.02</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2013</span></span> 20<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:03</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:49</span></span>;79094445182;00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:12</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:05</span></span>;0;114,9175;0,0000;114,9175;    ;22<span class="hljs-selector-class"><span class="hljs-selector-class">.02</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2013</span></span> 17<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:04</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:39</span></span>;79064014328;00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:01</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:15</span></span>;0;115,8175;<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span>,9000;114,9175;    ;22<span class="hljs-selector-class"><span class="hljs-selector-class">.02</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2013</span></span> 13<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:18</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:22</span></span>;79064014328;00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:01</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:36</span></span>;0;116,7175;<span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span>,9000;115,8175;    ;22<span class="hljs-selector-class"><span class="hljs-selector-class">.02</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2013</span></span> 01<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:35</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span>;;00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span>;0;119,3675;<span class="hljs-selector-tag"><span class="hljs-selector-tag">-2</span></span>,6500;116,7175;  ;21<span class="hljs-selector-class"><span class="hljs-selector-class">.02</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2013</span></span> 23<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:40</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:42</span></span>;*102;00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:01</span></span>;0;119,3675;0,0000;119,3675;</code> </pre> <br><br>  Then we read the manual, reading the text file <i>0:</i> parallelly, you can divide the file into fields by specifying the format of columns and the separator in the left part, if the separator is a list, then the table columns will be named from the first line.  We select only the required fields, two times and the table is ready. <br><br>  Who is bored to read about podgovku data - you can jump immediately to the <a href="https://habr.com/ru/post/198912/">data analysis</a> . <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">q</span></span>)<span class="hljs-selector-tag"><span class="hljs-selector-tag">clog</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:select</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tel</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">time</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">money</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span> ("<span class="hljs-selector-tag"><span class="hljs-selector-tag">SSSTSSSS</span></span>";<span class="hljs-selector-tag"><span class="hljs-selector-tag">enlist</span></span> ";") 0: `<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:tel.txt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">q</span></span>)<span class="hljs-selector-tag"><span class="hljs-selector-tag">clog</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tel</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">time</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">money</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">---------------------------------</span></span> 79064014328 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:31.000</span></span> 0,0000 79263883922 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:02</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:06.000</span></span> 0,0000 79064014328 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:01</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:15.000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span>,9000 79064014328 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:01</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:36.000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span>,9000 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00.000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-2</span></span>,6500 *102 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:01.000</span></span> 0,0000 ..</code> </pre> <br>  Since q is a vector database, in fact, clog is a dictionary, the column name is a list of values. <br><br><pre> <code class="hljs markdown">q)clog.money <span class="hljs-code"><span class="hljs-code">`0,0000`</span></span>0,0000<span class="hljs-code"><span class="hljs-code">`-0,9000`</span></span>-0,9000<span class="hljs-code"><span class="hljs-code">`-2,6500`</span></span>0,0000<span class="hljs-code"><span class="hljs-code">`0,0000`</span></span>0,0000<span class="hljs-code"><span class="hljs-code">`0,0000`</span></span>0,0000`-0,..</code> </pre><br>  Just prepare the data.  It can be seen that money is not in a numeric format, it would be necessary to convert it to a number: ssr is an oracle replace.  The term $ (cast) deals with various type conversions and type conversions, in this case it reads a number from a string: <br><br>  each is a map <br><br><pre> <code class="hljs pgsql">{"F"$ssr[string x;",";"."]} <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> clog.money</code> </pre><br>  Well, write it all in the table using update.  There is a small feature.  If you use the clog table name, then the result of the update function is a new table with updated values.  but you can specify the table name as `clog, then the changes will be saved.  We will also make the phone as a string, initially ‚ÄúS‚Äù is not a string but a character type. <br><br><pre> <code class="hljs pgsql">q)<span class="hljs-keyword"><span class="hljs-keyword">update</span></span> string tel, {"F"$ssr[string x;",";"."]} <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-type"><span class="hljs-type">money</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> `clog `clog</code> </pre><br>  Almost all words in a given q-sql are normal functions with a small portion of syntactic sugar.  They can be used separately, for example, where simply converts the bit string to a list of indices. <br><br>  comparison works with lists.  the result is a bit string from where where it retrieves the indices, and select by these indices extracts the corresponding list elements from the table. <br><pre> <code class="hljs swift">q)<span class="hljs-number"><span class="hljs-number">15</span></span>&lt;<span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> 1011b q)<span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>&lt;<span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre><br>  In the file there are both outgoing and incoming calls and payments for different services, I select the lines where the money was written off and there is a phone number and assign it the old name: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">q</span></span>)<span class="hljs-selector-tag"><span class="hljs-selector-tag">clog</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:select</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">clog</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">where</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">money</span></span>&lt;0,<span class="hljs-selector-tag"><span class="hljs-selector-tag">not</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tel</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">like</span></span> "" <span class="hljs-selector-tag"><span class="hljs-selector-tag">q</span></span>)<span class="hljs-selector-tag"><span class="hljs-selector-tag">clog</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tel</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">time</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">money</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--------------------------------</span></span> "79064014328" 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:01</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:15.000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.9</span></span> "79064014328" 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:01</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:36.000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.9</span></span> "79064014328" 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:01</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:33.000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.9</span></span> "79104652109" 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:01</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:23.000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-11</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.9</span></span> "79265996349" 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:12.000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.95</span></span> ..</code> </pre><br>  We determine the codes that are used to subsequently classify by operators: <br><br>  Already a little later, I realized that it was necessary to extract the extraction of code into a function. <br><br><pre> <code class="hljs pgsql">q)gcode:<span class="hljs-number"><span class="hljs-number">1</span></span>_ <span class="hljs-number"><span class="hljs-number">4</span></span># / <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> code <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tel q)gcode <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> clog.tel "906" "906" "906" "910" "926" ..</code> </pre><br><pre> <code class="hljs pgsql">q)<span class="hljs-keyword"><span class="hljs-keyword">distinct</span></span> gcode <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> clog.tel "906" "910" "926" ..</code> </pre><br>  there is more sql-like entry with exec.  exec is the same select, but which does not return the dictionary of the table, but returns the values ‚Äã‚Äãor the value of the result of the query or table. <br><br><pre> <code class="hljs pgsql">q)codes:exec <span class="hljs-keyword"><span class="hljs-keyword">distinct</span></span> gcode <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> tel <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> clog q)codes "906" "910" "926" ..</code> </pre><br>  Next, go to the dictionaries, they are described simply &lt;keys&gt;!  &lt;values&gt;.  I create a dictionary code &lt;&gt; operator. <br><br><pre> <code class="hljs erlang-repl">q)ops:codes ! `beeline`mts`megafon`beeline`mts`beeline`beeline`mts`moscow q)ops <span class="hljs-string"><span class="hljs-string">"906"</span></span>| beeline <span class="hljs-string"><span class="hljs-string">"910"</span></span>| mts <span class="hljs-string"><span class="hljs-string">"926"</span></span>| megafon <span class="hljs-string"><span class="hljs-string">"909"</span></span>| beeline <span class="hljs-string"><span class="hljs-string">"495"</span></span>| moscow ..</code> </pre><br>  Many tariffs round up the minute to full, I enter a field for convenience, which will be just a whole number of minutes.  I do not save it to the table, I just get the result, because later we will create a view with this field.  Time in milliseconds, so I divide by 1000. <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">q</span></span>)<span class="hljs-selector-tag"><span class="hljs-selector-tag">update</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ctime</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:ceiling</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">time</span></span>%1000)%60 <span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">clog</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tel</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">time</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">money</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ctime</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--------------------------------------</span></span> "79064014328" 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:01</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:15.000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.9</span></span> 2 "79064014328" 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:01</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:36.000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.9</span></span> 2 "79064014328" 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:01</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:33.000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.9</span></span> 2 "79104652109" 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:01</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:23.000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-11</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.9</span></span> 2 "79265996349" 00<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:00</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:12.000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.95</span></span> 1 ..</code> </pre><br>  I create a view with an operator and whole minutes if I wrote t: then I would create a table t.  I remind you that update preserves the original columns. <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">q</span></span>)t::update op:ops@gcode <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> tel, ctime:ceiling (<span class="hljs-keyword"><span class="hljs-keyword">time</span></span>%1000)%60 from clog <span class="hljs-keyword"><span class="hljs-keyword">q</span></span>)t tel <span class="hljs-keyword"><span class="hljs-keyword">time</span></span> money op ctime ---------------------------------------------- <span class="hljs-string"><span class="hljs-string">"79064014328"</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">15.000</span></span> -<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">9</span></span> beeline <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-string"><span class="hljs-string">"79064014328"</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">36.000</span></span> -<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">9</span></span> beeline <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-string"><span class="hljs-string">"79064014328"</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">33.000</span></span> -<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">9</span></span> beeline <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-string"><span class="hljs-string">"79104652109"</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">23.000</span></span> -<span class="hljs-number"><span class="hljs-number">11.9</span></span> mts <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-string"><span class="hljs-string">"79265996349"</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">12.000</span></span> -<span class="hljs-number"><span class="hljs-number">5.95</span></span> megafon <span class="hljs-number"><span class="hljs-number">1</span></span> ..</code> </pre><br>  I typed everything I needed, save the result t to a file just in case, of course it would be more correct to save the clog and view `t description, but laziness: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">q</span></span>)<span class="hljs-selector-tag"><span class="hljs-selector-tag">save</span></span> `<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:t</span></span> `<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:t</span></span></code> </pre><br><br>  All that is higher - just preparing the data, now a little more interesting: analysis. <br><br><a name="qsql"></a><br><br>  Let's see who called the most, here begins grouping.  Grouping is a parameter of the select function, which creates lists for each key occurrence: <br><br><pre> <code class="hljs cs">q)<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ctime <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> tel <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> t tel | ctime .. -------------| --------------------------------------------------------------.. <span class="hljs-string"><span class="hljs-string">"74956471602"</span></span>| ,<span class="hljs-number"><span class="hljs-number">1</span></span> .. <span class="hljs-string"><span class="hljs-string">"79031398210"</span></span>| <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> .. <span class="hljs-string"><span class="hljs-string">"7903X"</span></span> | ,<span class="hljs-number"><span class="hljs-number">2</span></span> .. <span class="hljs-string"><span class="hljs-string">"79064014328"</span></span>| <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> .. ..</code> </pre><br>  then we execute the functions with the parameter in the form of this list, desc is the inverse sort function, it sorts both the normal list and the table, it is sorted by default in the last column. <br><br><pre> <code class="hljs cs">q)desc <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> sum ctime <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> tel <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> t tel | ctime -------------| ----- <span class="hljs-string"><span class="hljs-string">"79064014328"</span></span>| <span class="hljs-number"><span class="hljs-number">126</span></span> <span class="hljs-string"><span class="hljs-string">"79094445182"</span></span>| <span class="hljs-number"><span class="hljs-number">36</span></span> <span class="hljs-string"><span class="hljs-string">"79652650530"</span></span>| <span class="hljs-number"><span class="hljs-number">30</span></span> ..</code> </pre><br>  Noticing that there are a lot of calls to one number, I added the column ‚Äúfavorite number‚Äù, a little later I decided to just indicate this in the operator field, I assigned the old view a new name, and ‚Äút‚Äù now is a new view based on the old one: <br><br><pre> <code class="hljs pgsql">q)t2::<span class="hljs-keyword"><span class="hljs-keyword">update</span></span> op:ops@gcode <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> tel, ctime:ceiling (<span class="hljs-type"><span class="hljs-type">time</span></span>%<span class="hljs-number"><span class="hljs-number">1000</span></span>)%<span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> clog q)t::<span class="hljs-keyword"><span class="hljs-keyword">update</span></span> op:`lub <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> t2 <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> tel <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> "79064014328" q)t tel <span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-type"><span class="hljs-type">money</span></span> op ctime <span class="hljs-comment"><span class="hljs-comment">---------------------------------------------- "79064014328" 00:01:15.000 -0.9 lub 2 "79064014328" 00:01:36.000 -0.9 lub 2 "79064014328" 00:01:33.000 -0.9 lub 2 "79104652109" 00:01:23.000 -11.9 mts 2 "79265996349" 00:00:12.000 -5.95 megafon 1 ..</span></span></code> </pre><br>  Now it's time to think about money, specifically about the tariffs of the megaphone. <br><br>  Some kind of 3 kopecks, to describe the function is simple: <br><br><pre> <code class="hljs axapta">q)meg3:{<span class="hljs-number"><span class="hljs-number">0.03</span></span>*<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> x}</code> </pre><br>  Let's see what is there with the money for each operator: <br><pre> <code class="hljs pgsql">q)<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> meg3 <span class="hljs-type"><span class="hljs-type">time</span></span>%<span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> op <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> t op | <span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-comment"><span class="hljs-comment">-------| ------ beeline| 111.93 lub | 148.05 megafon| 29.1 moscow | 0.93 mts | 24.45</span></span></code> </pre><br>  It is necessary to enter tariff options, if the number is `lub, then divide the price by two and add 30p. <br><pre> <code class="hljs apache"><span class="hljs-attribute"><span class="hljs-attribute">q</span></span>)lub:{$[x=`lub;30+y<span class="hljs-number"><span class="hljs-number">%2</span></span>;y]} /<span class="hljs-meta"><span class="hljs-meta"> [op;time]</span></span></code> </pre><br><br>  Actually everything, the function for counting will be the following, here for lub it uses currying: <br><pre> <code class="hljs">q){lub[x] meg3[y]}</code> </pre><br><br>  Unfortunately, I did not find how to pass the key and the value of the ‚Äúby‚Äù result to a function, so I am making this up as a subquery.  Since op and time are not two values ‚Äã‚Äãof some line from a table as in a normal db, entire lists will be passed to the function (in this case, the list and the list of lists), but the function described by me above expects only two parameters: operator and a list of times, so it‚Äôs traversed to use eachboth function, which is denoted as' (quotation mark) in essence, this is <a href="http://zvon.org/other/haskell/Outputprelude/zipWith_f.html">zipWith</a> , but without limiting the number of lists.  The request, unlike the usual db, at the same time is complicated only by ': <br><br><pre> <code class="hljs pgsql">q)<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-type"><span class="hljs-type">money</span></span>:{lub[x] meg3[y]}<span class="hljs-string"><span class="hljs-string">'[op;time] from select time%1000 by op from t money ------ 259.98 29.1 0.93 24.45</span></span></code> </pre><br>  I summarize, here you can write both exec sum and sum exec - the result of exec is summed up or exec will sum up the result - it does not matter: <br><br><pre> <code class="hljs matlab">q)exec sum {lub[x] meg3[y]}'[op;time] from select time<span class="hljs-comment"><span class="hljs-comment">%1000 by op from t 314.46</span></span></code> </pre><br>  It is clear how much I would spend by going to this tariff.  Now we‚Äôll calculate another, where the minute is rounded up, and farther by seconds.  It is necessary to count for each specified time, which I do using each: <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">q</span></span>)mego:sum {<span class="hljs-number"><span class="hljs-number">1.20</span></span>+$[<span class="hljs-keyword"><span class="hljs-keyword">x</span></span>&lt;=<span class="hljs-number"><span class="hljs-number">60</span></span>;<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-number"><span class="hljs-number">1.20</span></span>*(<span class="hljs-keyword"><span class="hljs-keyword">x</span></span>-<span class="hljs-number"><span class="hljs-number">60</span></span>)%60]} <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">q</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> sum {lub[<span class="hljs-keyword"><span class="hljs-keyword">x</span></span>] mego[<span class="hljs-keyword"><span class="hljs-keyword">y</span></span>]}<span class="hljs-string"><span class="hljs-string">'[op;time] from select time%1000 by op from t 258.06</span></span></code> </pre><br>  Full code: <br><br><pre> <code class="hljs pgsql">clog:<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> tel,<span class="hljs-type"><span class="hljs-type">time</span></span>,<span class="hljs-type"><span class="hljs-type">money</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ("SSSTSSSS";enlist ";") <span class="hljs-number"><span class="hljs-number">0</span></span>: `:tel.txt {"F"$ssr[string x;",";"."]} <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> clog.money <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> string tel, {"F"$ssr[string x;",";"."]} <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-type"><span class="hljs-type">money</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> `clog clog:<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> clog <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">money</span></span>&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> tel <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> "" gcode:<span class="hljs-number"><span class="hljs-number">1</span></span>_ <span class="hljs-number"><span class="hljs-number">4</span></span># codes:exec <span class="hljs-keyword"><span class="hljs-keyword">distinct</span></span> gcode <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> tel <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> clog ops:codes ! `beeline`mts`megafon`beeline`mts`beeline`beeline`mts`moscow t2::<span class="hljs-keyword"><span class="hljs-keyword">update</span></span> op:ops@gcode <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> tel, ctime:ceiling (<span class="hljs-type"><span class="hljs-type">time</span></span>%<span class="hljs-number"><span class="hljs-number">1000</span></span>)%<span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> clog t::<span class="hljs-keyword"><span class="hljs-keyword">update</span></span> op:`lub <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> t2 <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> tel <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> "79064014328" meg3:{<span class="hljs-number"><span class="hljs-number">0.03</span></span>*sum x} mego:sum {<span class="hljs-number"><span class="hljs-number">1.20</span></span>+$[x&lt;=<span class="hljs-number"><span class="hljs-number">60</span></span>;<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-number"><span class="hljs-number">1.20</span></span>*(x<span class="hljs-number"><span class="hljs-number">-60</span></span>)%<span class="hljs-number"><span class="hljs-number">60</span></span>]} <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> lub:{$[x=`lub;<span class="hljs-number"><span class="hljs-number">30</span></span>+y%<span class="hljs-number"><span class="hljs-number">2</span></span>;y]} exec sum {lub[x] meg3[y]}<span class="hljs-string"><span class="hljs-string">'[op;time] from select time%1000 by op from t exec sum {lub[x] mego[y]}'</span></span>[op;<span class="hljs-type"><span class="hljs-type">time</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span>%<span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> op <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> t</code> </pre><br>  Making this text was much more difficult than writing these 14 lines.  It is clear that there are no very heavy things for any other base, but it was the ease of use and the obviousness of writing some constructions that made me write it.  In the beginning it was a little difficult to switch from normal sql, but after understanding that the table here stores data in lists, and the functions, as a rule, work with almost any built-in data types, it became much clearer.  It is the idiomatic simplicity and ease of implementation of this db, and in fact it is a mixture of scheme and APL, which makes it possible to use this tool effectively.  Impressions of this are APL and functional functionality shifted towards sql and databases. <br><br>  The entire database consists of a single q.exe file, ~ 400kb in size.  Skeptics will smile after this, but then look at the list of customers for this product <a href="http://kx.com/end-user-customers.php">http://kx.com/end-user-customers.php</a> . <br>  Play with this can be downloaded here <a href="http://kx.com/software-download.php">http://kx.com/software-download.php</a> </div><p>Source: <a href="https://habr.com/ru/post/198912/">https://habr.com/ru/post/198912/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../198900/index.html">Robotics for children. Request for comments</a></li>
<li><a href="../198902/index.html">Repetitive types of people in startups on enthusiasm</a></li>
<li><a href="../198904/index.html">Part 2. We divide our "pod" into modules. Use someone else's "pod" to develop your</a></li>
<li><a href="../198906/index.html">Network Render in a Blender</a></li>
<li><a href="../198910/index.html">Jug to every city</a></li>
<li><a href="../198914/index.html">Epilogue of the Opera</a></li>
<li><a href="../198916/index.html">We write numpy-module to accelerate math functions using SIMD instructions</a></li>
<li><a href="../198918/index.html">linch.me - add annotations to the image</a></li>
<li><a href="../198920/index.html">DARPA begins developing computer security systems capable of independently finding and fixing vulnerabilities</a></li>
<li><a href="../198924/index.html">LinkMeUp. Release 8. IB - Best Practices and Pentesting Laboratories</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>