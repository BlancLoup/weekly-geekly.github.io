<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Anti-rootkit for Userland-RootKit Azazel "on the knee"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Here's some awesome news from ValdikSS user - New Userland-RootKit Azazel . Let me quote the first paragraph: 

 You may have heard about Jynx and Jyn...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Anti-rootkit for Userland-RootKit Azazel "on the knee"</h1><div class="post__text post__text-html js-mediator-article">  Here's some awesome news from <a href="https://habrahabr.ru/users/valdikss/" class="user_link">ValdikSS</a> user - <a href="http://habrahabr.ru/post/212769/">New Userland-RootKit Azazel</a> .  Let me quote the first paragraph: <br><br><blockquote>  You may have heard about Jynx and Jynx2 rootkits.  These are the so-called userland rootkits; they use the LD_PRELOAD variable feature, which allows you to load any libraries before the program is launched.  They are already relatively old, but still work well. <br>  2 days ago, Github-user Chokepoint posted a rootkit Azazel.  It is based on the Jynx source code and has many new features: <br><br>  Anti-debugging mechanisms <br>  Hiding from unhide, lsof, ps, ldd <br>  Hiding files and directories <br>  Hiding remote connections <br>  Hiding processes <br>  Hiding logins <br>  Hiding from local traffic sniffing via PCAP <br>  2 backdoors with full shell (with PTY): <br>  - Crypthook accept () - backdoor <br>  - Normal accept () - backdoor <br>  PAM backdoor for authentication by any user <br>  Clearing utmp / wtmp logs for PTY <br>  Obfuscating compiled library lines with xor. </blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Thus, the rootkit uses the regular ability to load any library via <code>LD_PRELOAD</code> .  The question is, is it possible to somehow control it? <br><br><a name="habracut"></a><br><br>  In order not to be verbose, I will immediately present a simple solution for the Linux kernel, which, intercepting the <code>execve</code> function (or rather <a href="">sys_execve</a> ), scans the parameters of the list of environment variables (known as <code>envp</code> ) for the presence of a specific string in them, namely the very <code>LD_PRELOAD</code> . <br><br>  So, the solution is designed as a kernel module.  The function interception is based on the methods described earlier in the articles: <br><br><ul><li>  <a href="http://habrahabr.ru/post/196952/">Managed by PageFault in the Linux kernel</a> </li><li>  <a href="http://habrahabr.ru/post/206778/">Interception of Linux kernel functions using exceptions (do-it-yourself kprobes)</a> </li></ul><br><br>  To intercept the sys_execve function, use the <a href="">following</a> code: <br><br><pre> <code class="cpp hljs">DECLARE_KHOOK(sys_execve); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">khook_sys_execve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __user * file, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __user * </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __user * argv, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __user * </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __user * envp )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> result; KHOOK_USAGE_INC(sys_execve); scan_env_for((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)file, (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)envp, env_token); result = KHOOK_ORIGIN(sys_execve, file, argv, envp); KHOOK_USAGE_DEC(sys_execve); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br><br>  Immediately before making the original call of the intercepted function <code>sys_execve</code> , a search is made for matching environmental variables with the specified string <code>env_token</code> .  This makes the simple <a href="">scan_env_for</a> function: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scan_env_for</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * file, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * envp[], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * token)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * string_ptr; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!envp || !token) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> = kmalloc(MAX_ARG_STRLEN + <span class="hljs-number"><span class="hljs-number">1</span></span>, GFP_KERNEL); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>) { debug(<span class="hljs-string"><span class="hljs-string">"Can't get memory for the environ string\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; MAX_ARG_STRINGS; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (get_user(string_ptr, envp + i)) { debug(<span class="hljs-string"><span class="hljs-string">"Can't get user pointer value\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> out_kfree; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (string_ptr == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> out_kfree; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strncpy_from_user(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, string_ptr, MAX_ARG_STRLEN) == -EFAULT) { debug(<span class="hljs-string"><span class="hljs-string">"Can't get user string\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> out_kfree; } <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>[MAX_ARG_STRLEN] = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, token, <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(token)) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * filename; filename = kmalloc(PATH_MAX + <span class="hljs-number"><span class="hljs-number">1</span></span>, GFP_KERNEL); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (filename) { strncpy_from_user(filename, file, PATH_MAX + <span class="hljs-number"><span class="hljs-number">1</span></span>); filename[PATH_MAX] = <span class="hljs-number"><span class="hljs-number">0</span></span>; } debug(<span class="hljs-string"><span class="hljs-string">"Attention, task \"%s\" trying to execute \"%s\" with \"%s\"\n"</span></span>, \ current-&gt;comm, filename ? filename : <span class="hljs-string"><span class="hljs-string">"(unknown)"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>); kfree(filename); <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> out_kfree; } } out_kfree: kfree(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>); }</code> </pre><br><br>  As you can see, when it is launched, memory is allocated and all possible string elements of environment variables are scanned.  At the end of the scan, the memory is accordingly freed.  In case the required string was found in the kernel log, a warning will be displayed. <br><br>  To verify that the module is working, after its assembly, you can do the following: <br><br><pre> <code class="bash hljs">$ sudo insmod envscan.ko env_token=\<span class="hljs-string"><span class="hljs-string">"LD_PRELOAD=\" $ dmesg | grep envscan [37713.809903] [envscan] Symbol "</span></span>module_free<span class="hljs-string"><span class="hljs-string">" found @ ffffffff810bdcd0 [37713.810190] [envscan] Symbol "</span></span>module_alloc<span class="hljs-string"><span class="hljs-string">" found @ ffffffff810407e0 [37713.810523] [envscan] Symbol "</span></span>sort_extable<span class="hljs-string"><span class="hljs-string">" found @ ffffffff81048a90 [37713.810524] [envscan] Hunting for "</span></span>LD_PRELOAD=<span class="hljs-string"><span class="hljs-string">" [37713.811798] [envscan] Symbol "</span></span>sys_execve<span class="hljs-string"><span class="hljs-string">" found @ ffffffff8119ba30 $ LD_PRELOAD=/lib/ld-linux.so.2 ls [37743.786499] [envscan] Attention, task "</span></span>bash<span class="hljs-string"><span class="hljs-string">" trying to execute "</span></span>/bin/ls<span class="hljs-string"><span class="hljs-string">" with "</span></span>LD_PRELOAD=/lib/ld-linux.so.2<span class="hljs-string"><span class="hljs-string">"</span></span></code> </pre><br><br>  Thus, we can say that for paranoid users <a href="https://github.com/milabs/kmod_hooking/tree/hook-execve">there is a</a> solution that allows, if desired, to protect against the troubles associated with the capabilities of <code>LD_PRELOAD</code> . <br><br>  For those who are less panicked, this material can serve as a source of information on how to work with the kernel, namely, intercept its functions and modify the behavior of the system. <br><br>  Module code is available on <a href="https://github.com/milabs/kmod_hooking/tree/hook-execve">github</a> . </div><p>Source: <a href="https://habr.com/ru/post/212825/">https://habr.com/ru/post/212825/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../212813/index.html">FreeBSD 10.0 RELEASE and problems with ip forwarding</a></li>
<li><a href="../212815/index.html">Web interface for listening to call recordings Asterisk</a></li>
<li><a href="../212817/index.html">Definer.js - simple modular system</a></li>
<li><a href="../212821/index.html">Adaptive letters? You are welcome!</a></li>
<li><a href="../212823/index.html">Rusty brains - go over the bridge. The Bridge by Ty Tailor</a></li>
<li><a href="../212831/index.html"># 3dprintexpo: Russia's first exhibition of three-dimensional printing</a></li>
<li><a href="../212833/index.html">Lshell instead of chroot ssh</a></li>
<li><a href="../212835/index.html">Tame ZoG (Part 3: Football of the Kumsk Valley)</a></li>
<li><a href="../212837/index.html">The basics of creating a 2D character in Godot. Part 2: compiling templates, a little about GDScript, movement and animation of the hero</a></li>
<li><a href="../212839/index.html">SIP Security Essay</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>