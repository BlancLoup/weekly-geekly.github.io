<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ansible and Rails - flexible replacement for Capistrano while maintaining familiar comfort</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Capistrano is a favorite tool for many rails developers that can quickly and easily automate the deployment of your application. Capistrano is the de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ansible and Rails - flexible replacement for Capistrano while maintaining familiar comfort</h1><div class="post__text post__text-html js-mediator-article">  Capistrano is a favorite tool for many rails developers that can quickly and easily automate the deployment of your application.  <a href="https://github.com/capistrano/capistrano">Capistrano</a> is the de facto standard for the RoR deployment system, the must-know technology for any self-respecting rubist, the tool that python and PHP developers envied at one time. <br>  Despite the comfort that I don‚Äôt want to give up, the more complex tasks I had to solve, the more often Capistrano showed himself not adapted to them. <br><br>  I noted the following disadvantages: <br><ul><li>  Known problems with speed.  Due to its versatility, Capistrano deploit slowly, performing extra checks and challenges that you can not always control. </li><li>  Consistent warm.  The short deployment time must be multiplied by the number of target servers (however, you can configure the parallelization of commands explicitly). </li><li>  Strong connectedness with rails.  Capistrano configs and dependencies are intertwined with the application, becoming part of it.  You cannot create a new deployment environment (for example, a server for early functional rollout) without creating a new rails environment.  In difficult situations, Capistrano makes it necessary to keep away from good practice to keep only the development, test and production environment. </li><li>  Plugins are double-edged.  Giving the opportunity to quickly ‚Äúscrew up‚Äù the deployment of an application dependency, plug-ins deprive you of control of the situation, force you to act as the plug-in developer acts.  I have written above about the influence of extra ‚Äúgestures‚Äù of plug-ins on the deployment rate. </li><li>  Complicated warm heterogeneous applications.  The trend of recent years in the rails was the selection of the most difficult (background or network) tasks into separate services, not necessarily written in ruby.  In such a situation, capistrano makes you produce a zoo from different deployment systems for different languages ‚Äã‚Äãand technologies. </li></ul><br>  Many ruby ‚Äã‚Äãdevelopers have switched to <a href="https://github.com/mina-deploy/mina">Mina</a> or solve their problems using even more complex configuration management systems like <a href="https://www.chef.io/chef/">Chef</a> and <a href="https://puppetlabs.com/">Puppet</a> .  All of them have their own characteristics and disadvantages and solve the problems described above to varying degrees.  I managed to solve them with <a href="http://www.ansible.com/home">Ansible</a> , without losing the advantages of Capistrano, to which I was used. <br><br>  Ansible is a tool for managing configurations and its tasks include not only the execution of remote commands described on this article on servers to deploy and manage an individual application, but also the automation of server administration through stored server configurations (Ansible language roles).  So, Ansible (as well as Chef and Puppet) allows much more than Capistrano and, ultimately, they all do not go with him in any comparison.  However, the goal of this article is to give rails developers a starting point for migration and explain, with this example, the basics of Ansible.  At the end of this article, the <em>cap production deploy</em> magic command will turn into <em>ansible-playbook deploy.yml -i inventory / production</em> <br>  Who cares how - I ask under the cat. <br><a name="habracut"></a><br><h2>  Installation </h2><br>  Ansible written in python.  Not every rubist will like it, but I will dispel fears right away - you will not have to write a single line in the ‚Äúenemy language‚Äù.  The drawback of Ansible is that all deployment scripts are configuration files in the well-known yml format with a simple and powerful descriptive syntax. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Installation ansible is also simple and fast.  Install ansible only on the local machine: <br><pre><code class="bash hljs">sudo easy_isntall pip sudo pip install -U ansible</code> </pre> <br>  At this, the interaction with the python utilities ends and now the <em>ansible-playbook</em> command is available to us, with the help of which the application is implemented.  The team has only one required argument - a relative path to the playbook file. <br><br><h2>  Ansible-playbook </h2><br>  <a href="http://docs.ansible.com/ansible/playbooks.html">A playbook file</a> is a list of running tasks or other playbooks.  Thanks to nesting, we can effectively isolate tasks by layers and achieve the ability to run only what we need at the moment. <br>  As an example for deployment, let's take <em>myawesomestartup</em> - this is some kind of rails-application with a bunch of passenger 5 standalone and nginx as a web server and <a href="https://github.com/mperham/sidekiq">sidekiq</a> for background tasks.  The physical infrastructure in the example is two production servers: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">prima</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.myawesomestartup</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">secunda</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.myawesomestartup</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span></code> </pre><br>  And one staging: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">plebius</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.myawesomestartup</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span></code> </pre><br>  In the ansible folder, define the master playbook <em>deploy.yml</em> , containing all the other playbooks, <br><pre> <code class="hljs actionscript">--- - hosts: hosts - <span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta">: release.yml #    - </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta">: app.yml #   - - </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta">: sidekiq.yml #   sidekiq</span></span></code> </pre><br>  <em>Using the</em> command <em>ansible-playbook deploy.yml</em> , run the entire deployment.  However, you can run the playbooks separately, if we need to restart the application without rolling out a new release. <br>  Note the <em>hosts</em> variable in it contains information about the servers on which the deployment will be performed.  This variable can be defined in the global configuration ansible, but we will proceed differently using the inventory files. <br><br><h2>  Inventory files and application configuration </h2><br>  To store groups of hosts, their hierarchies and settings, <a href="http://docs.ansible.com/ansible/intro_inventory.html">inventory files are</a> provided in ansible.  These are ini-files with a very simple syntax. <br><br>  We can describe a group of hosts: <br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">hosts:children</span></span>] prima secunda</code> </pre><br>  In the group we will announce the hosts themselves: <br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[prima]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">prima</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.myawesomestartup</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[secunda]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">secunda</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.myawesomestartup</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span></code> </pre><br>  We declare the variables specific to each specific host: <br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">prima:vars</span></span>] ansible_env_name=production rails_env_name=production database_name={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'PRIMA_DB_NAME'</span></span>) }} database_username={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'PRIMA_DB_LOGIN'</span></span>) }} database_password={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'PRIMA_DB_PASSWORD'</span></span>) }} database_host={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'PRIMA_DB_HOST'</span></span>) }} database_port={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'PRIMA_DB_PORT'</span></span>) }}</code> </pre><br>  Notice the curly braces - in ansible all the files are <a href="http://jinja.pocoo.org/docs/dev/">Jinja2</a> templates.  In this example, the environment variables from the machine from which the deployment is performed are interpolated from the template and the <a href="http://docs.ansible.com/ansible/playbooks_lookups.html">lookup</a> command.  This is useful in order not to store in the version control system any sensitive information, such as secret keys or database connection strings. <br><br>  For the example to work, you need to declare the following variables in your <em>~ / .bashrc</em> or <em>~ / .zshrc</em> or (which is safer and less convenient) to export them each time before each deployment: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PRIMA_DB_NAME=myawesomestartup_production <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PRIMA_DB_LOGIN=myawesomestartup <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PRIMA_DB_PASSWORD=secret <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PRIMA_DB_HOST=db.myawesomestartup.com <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> PRIMA_DB_PORT=3306</code> </pre><br>  Below are the entire <em>inventory / production</em> and <em>inventory / staging</em> files: <br><div class="spoiler">  <b class="spoiler_title">inventory / production</b> <div class="spoiler_text"><pre> <code class="hljs mel">; production [prima] prima.myawesomestartup.com [prima:vars] ansible_env_name=production rails_env_name=production database_name={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'PRIMA_DB_NAME'</span></span>) }} database_username={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'PRIMA_DB_LOGIN'</span></span>) }} database_password={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'PRIMA_DB_PASSWORD'</span></span>) }} database_host{{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'PRIMA_DB_HOST'</span></span>) }} database_port={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'PRIMA_DB_PORT'</span></span>) }} git_branch=master app_path=/srv/www/prima.myawesomestartup.com custom_server_options=--no-friendly-<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>-pages sidekiq_process_number=<span class="hljs-number"><span class="hljs-number">4</span></span> [secunda] secunda.myawesomestartup.com [secunda:vars] ansible_env_name=production rails_env_name=production database_name={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'SECUNDA_DB_NAME'</span></span>) }} database_username={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'SECUNDA_DB_LOGIN'</span></span>) }} database_password={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'SECUNDA_DB_PASSWORD'</span></span>) }} database_host={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'SECUNDA_DB_HOST'</span></span>) }} database_port={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'SECUNDA_DB_PORT'</span></span>) }} git_branch=master app_path=/srv/www/secunda.myawesomestartup.com custom_server_options=--no-friendly-<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>-pages sidekiq_process_number=<span class="hljs-number"><span class="hljs-number">4</span></span> [hosts:children] prima secunda</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">inventory / staging</b> <div class="spoiler_text"><pre> <code class="hljs lua">; staging [plebius] plebius.myawesomestartup.com [plebius:vars] ansible_env_name=staging rails_env_name=production database_name={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'PLEBIUS_DB_NAME'</span></span>) }} database_username={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'PLEBIUS_DB_LOGIN'</span></span>) }} database_password={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'PLEBIUS_DB_PASSWORD'</span></span>) }} database_host={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'PLEBIUS_DB_HOST'</span></span>) }} database_port={{ lookup(<span class="hljs-string"><span class="hljs-string">'env'</span></span>, <span class="hljs-string"><span class="hljs-string">'PLEBIUS_DB_PORT'</span></span>) }} git_branch=develop app_path=/srv/www/plebius.myawesomestartup.com custom_server_options=<span class="hljs-comment"><span class="hljs-comment">--friendly-error-pages sidekiq_process_number=4 [hosts:children] plebius</span></span></code> </pre><br></div></div><br>  Config templates put in the folder ansible / configs: <br><div class="spoiler">  <b class="spoiler_title">configs / database.yml</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml"># configs/database.yml </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{rails_env_name}}</span></span><span class="xml"><span class="xml">: adapter: mysql2 database: </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{database_name}}</span></span><span class="xml"><span class="xml"> username: </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{database_username}}</span></span><span class="xml"><span class="xml"> password: </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{database_password}}</span></span><span class="xml"><span class="xml"> host: </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{database_host}}</span></span><span class="xml"><span class="xml"> port: </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{database_port}}</span></span><span class="xml"><span class="xml"> secure_auth: false</span></span></code> </pre><br></div></div><br>  For those settings that can be safely stored in the control system, the version I prefer is <a href="https://github.com/bkeepers/dotenv">dotenv</a> . <br>  Create the following file structure in the ansible / environments folder: <br><pre> <code class="hljs mel">production/ prima.<span class="hljs-keyword"><span class="hljs-keyword">env</span></span> secunda.<span class="hljs-keyword"><span class="hljs-keyword">env</span></span> staging/ plebius.<span class="hljs-keyword"><span class="hljs-keyword">env</span></span></code> </pre><br><br><h2>  Releases like in capistrano </h2><br>  Capistrano by default offers a fairly thoughtful file structure on the server. <br><pre> <code class="hljs pgsql">releases/ <span class="hljs-number"><span class="hljs-number">20150631130156</span></span>/ <span class="hljs-number"><span class="hljs-number">20150631130233</span></span>/ <span class="hljs-number"><span class="hljs-number">20150631172431</span></span>/ <span class="hljs-number"><span class="hljs-number">20150704162516</span></span>/ <span class="hljs-number"><span class="hljs-number">20150712165952</span></span>/ <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> - -&gt; /www/<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>/releases/<span class="hljs-number"><span class="hljs-number">20150712165952</span></span>/ shared/</code> </pre><br>  The <em>releases</em> folder contains the last five recent releases in folders with the names of the type <em>20150812165952</em> , which contain the timestamp of the deployment time of this release.  Inside each release is a <em>REVISION</em> file containing the hash of the commit from which the release was made. <br>  Simlink <em>current</em> refers to the latest release in the <em>releases</em> folder. <br>  The <em>shared</em> folder contains files common to all releases (for example <em>.pid</em> and <em>.sock</em> ) and those files that are excluded from the version control system (for example, <em>database.yml</em> ).  All this allows you to safely roll back the application in case of a failure of the deployment or rolling out the code with unexpected bugs. <br>  Repeat this with Ansible: <br><div class="spoiler">  <b class="spoiler_title">ansible / release.yml</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml"># ansible/release.yml --- - hosts: hosts #    inventory-    tasks: #     app_path  shared_path    .    - include: tasks/_set_vars.yml tags=always #        - set_fact: timestamp="</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ lookup('pipe', 'date +%Y%m%d%H%M%S') }}</span></span><span class="xml"><span class="xml">" - set_fact: release_path="</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ app_path }}</span></span><span class="xml"><span class="xml">/releases/</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ timestamp }}</span></span><span class="xml"><span class="xml">" #    .    ansible   - name: Ensure shared directory exists file: path=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ shared_path }}</span></span><span class="xml"><span class="xml"> state=directory - name: Ensure shared/assets directory exists file: path=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ shared_path }}</span></span><span class="xml"><span class="xml">/assets state=directory - name: Ensure tmp directory exists file: path=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ shared_path }}</span></span><span class="xml"><span class="xml">/tmp state=directory - name: Ensure log directory exists file: path=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ shared_path }}</span></span><span class="xml"><span class="xml">/log state=directory - name: Ensure bundle directory exists file: path=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ shared_path }}</span></span><span class="xml"><span class="xml">/bundle state=directory #       - name: Leave only last releases shell: "cd </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ app_path }}</span></span><span class="xml"><span class="xml">/releases &amp;&amp; find ./ -maxdepth 1 | grep -G .............. | sort -r | tail -n +</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ keep_releases }}</span></span><span class="xml"><span class="xml"> | xargs rm -rf" - name: Create release directory file: path=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ release_path }}</span></span><span class="xml"><span class="xml"> state=directory #       - name: Checkout git repo into release directory git: repo=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ git_repo }}</span></span><span class="xml"><span class="xml"> dest=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ release_path }}</span></span><span class="xml"><span class="xml"> version=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ git_branch }}</span></span><span class="xml"><span class="xml"> accept_hostkey=yes #       REVISION    - name: Get git branch head hash shell: "cd </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ release_path }}</span></span><span class="xml"><span class="xml"> &amp;&amp; git rev-parse --short HEAD" register: git_head_hash - name: Create REVISION file in the release path copy: content="</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ git_head_hash.stdout }}</span></span><span class="xml"><span class="xml">" dest=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ release_path }}</span></span><span class="xml"><span class="xml">/REVISION #     rails  - name: Set assets link file: src=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ shared_path }}</span></span><span class="xml"><span class="xml">/assets path=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ release_path }}</span></span><span class="xml"><span class="xml">/public/assets state=link - name: Set tmp link file: src=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ shared_path }}</span></span><span class="xml"><span class="xml">/tmp path=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ release_path }}</span></span><span class="xml"><span class="xml">/tmp state=link - name: Set log link file: src=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ shared_path }}</span></span><span class="xml"><span class="xml">/log path=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ release_path }}</span></span><span class="xml"><span class="xml">/log state=link #   .env  database.yml   .          . - name: Copy .env file template: src=environments/</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ansible_env_name}}</span></span><span class="xml"><span class="xml">/</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ansible_hostname}}</span></span><span class="xml"><span class="xml">.env dest=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ release_path }}</span></span><span class="xml"><span class="xml">/.env - name: Copy database.yml template: src=configs/database.yml dest=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ release_path }}</span></span><span class="xml"><span class="xml">/config - set_fact: rvm_wrapper_command="cd </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ release_path }}</span></span><span class="xml"><span class="xml"> &amp;&amp; RAILS_ENV=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ rails_env_name }}</span></span><span class="xml"><span class="xml"> rvm ruby-</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ ruby_version }}</span></span><span class="xml"><span class="xml">@</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ full_gemset_name }}</span></span><span class="xml"><span class="xml"> --create do" # Bundle, ,  ... - name: Run bundle install shell: "</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ rvm_wrapper_command }}</span></span><span class="xml"><span class="xml"> bundle install --path </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ shared_path }}</span></span><span class="xml"><span class="xml">/bundle --deployment --without development test" - name: Run db:migrate shell: "</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ rvm_wrapper_command }}</span></span><span class="xml"><span class="xml"> rake db:migrate" - name: Precompile assets shell: "</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ rvm_wrapper_command }}</span></span><span class="xml"><span class="xml"> rake assets:precompile" #      current - name: Update app version file: src=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ release_path }}</span></span><span class="xml"><span class="xml"> path=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ app_path }}</span></span><span class="xml"><span class="xml">/current state=link</span></span></code> </pre><br></div></div><br>  Setting some variables was moved to a separate mixin task, since these variables are identical for all playbooks and servers: <br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta"># ansible/tasks/_set_vars.yml --- - set_fact: app_name=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"myawesomestartup"</span></span></span><span class="hljs-meta"> - set_fact: ruby_version=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"2.2.2"</span></span></span><span class="hljs-meta"> - set_fact: ruby_gemset=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"myawesomestartup"</span></span></span><span class="hljs-meta"> - set_fact: git_repo=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ilpagency/rails-sidekiq-ansible-sample"</span></span></span><span class="hljs-meta"> - set_fact: keep_releases=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"5"</span></span></span><span class="hljs-meta"> - set_fact: full_app_name=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"{{ app_name }}-{{ ansible_env_name }}"</span></span></span><span class="hljs-meta"> - set_fact: full_gemset_name=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"{{ ruby_gemset }}-{{ ansible_env_name }}"</span></span></span><span class="hljs-meta"> - set_fact: current_path=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"{{ app_path }}/current"</span></span></span><span class="hljs-meta"> - set_fact: shared_path=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"{{ app_path }}/shared"</span></span></span></span></code> </pre><br><br><h2>  Run passenger and sidekiq - tags and cycles Ansible </h2><br>  Create another playbook to manage the state of the application <em>ansible / app.yml</em> , with which the application can be started, stopped or restarted.  Like other playbooks, it can be launched separately or as part of a master playbook. <br>  For more flexibility, add the <em>app_stop</em> and <em>app_start tags</em> .  Tags allow you to perform only those parts of tasks that are explicitly indicated during the deployment.  If you do not specify the tags during the delay - the playbook will be made entirely. <br><br>  Here is how it looks in practice: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  : ansible-playbook app.yml -i inventory/production #  : ansible-playbook app.yml -i inventory/production -t "app_stop" #  : ansible-playbook app.yml -i inventory/production -t "app_start" #   : ansible-playbook app.yml -i inventory/production -t "app_stop,app_start"</span></span></code> </pre><br>  But the implementation: <br><div class="spoiler">  <b class="spoiler_title">ansible / app.yml</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml"># ansible/app.yml --- - hosts: hosts #    inventory-    tasks: - include: tasks/_set_vars.yml tags=always # always   ,      ,       - set_fact: socks_path=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ shared_path }}</span></span><span class="xml"><span class="xml">/tmp/socks tags: always - name: Ensure sockets directory exists file: path=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ socks_path }}</span></span><span class="xml"><span class="xml"> state=directory tags: always - set_fact: app_sock=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ socks_path }}</span></span><span class="xml"><span class="xml">/app.sock tags: always - set_fact: pids_path=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ shared_path }}</span></span><span class="xml"><span class="xml">/tmp/pids tags: always - name: Ensure pids directory exists file: path=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ pids_path }}</span></span><span class="xml"><span class="xml"> state=directory tags: always - set_fact: app_pid=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ pids_path }}</span></span><span class="xml"><span class="xml">/passenger.pid tags: always - set_fact: rvm_wrapper_command="cd </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ current_path }}</span></span><span class="xml"><span class="xml"> &amp;&amp; RAILS_ENV=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ rails_env_name }}</span></span><span class="xml"><span class="xml"> rvm ruby-</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ ruby_version }}</span></span><span class="xml"><span class="xml">@</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ full_gemset_name }}</span></span><span class="xml"><span class="xml"> --create do" tags: always - include: tasks/app_stop.yml tags=app_stop #             app_start - include: tasks/app_start.yml tags=app_start #   ,   - app_stop</span></span></code> </pre><br></div></div><br>  The tasks of starting and stopping the application are highlighted separately in the files <em>ansible / tasks / app_start.yml</em> and <em>ansible / tasks / app_stop.yml</em> : <br><div class="spoiler">  <b class="spoiler_title">ansible / tasks / app_start.yml</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml"># ansible/tasks/app_start.yml --- - name: start passenger shell: "</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ rvm_wrapper_command }}</span></span><span class="xml"><span class="xml"> bundle exec passenger start -d -S </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ app_sock }}</span></span><span class="xml"><span class="xml"> --environment </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ rails_env_name }}</span></span><span class="xml"><span class="xml"> --pid-file </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ app_pid }}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ custom_server_options }}</span></span><span class="xml"><span class="xml">"</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">ansible / tasks / app_stop.yml</b> <div class="spoiler_text"><pre> <code class="hljs 1c"><span class="hljs-meta"><span class="hljs-meta"># ansible/tasks/app_stop.yml --- - name: stop passenger shell: "{{ rvm_wrapper_command }} bundle exec passenger stop --pid-file {{ app_pid }}" ignore_errors: yes # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">   </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta"> ...  .  -   .</span></span></code> </pre><br></div></div><br>  With sidekiq, the situation is similar.  For it, we implement a separate playbook, <em>ansible / sidekiq.yml, which</em> supports the corresponding <em>sidekiq_stop</em> and <em>sidekiq_start tags</em> : <br><div class="spoiler">  <b class="spoiler_title">ansible / app.yml</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml"># ansible/sidekiq.yml --- - hosts: hosts tasks: - include: tasks/_set_vars.yml tags=always - set_fact: pids_path=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ shared_path }}</span></span><span class="xml"><span class="xml">/tmp/pids tags: always - name: Ensure pids directory exists file: path=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ pids_path }}</span></span><span class="xml"><span class="xml"> state=directory tags: always - set_fact: rvm_wrapper_command="cd </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ current_path }}</span></span><span class="xml"><span class="xml"> &amp;&amp; RAILS_ENV=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ rails_env_name }}</span></span><span class="xml"><span class="xml"> rvm ruby-</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ ruby_version }}</span></span><span class="xml"><span class="xml">@</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ full_gemset_name }}</span></span><span class="xml"><span class="xml"> --create do" tags: always - include: tasks/sidekiq_stop.yml tags=sidekiq_stop - include: tasks/sidekiq_start.yml tags=sidekiq_start</span></span></code> </pre><br></div></div><br>  The start and stop tasks are also separately allocated to the files <em>ansible / tasks / sidekiq_start.yml</em> and <em>ansible / tasks / sidekiq_stop.yml</em> .  In addition to actually starting and stopping sidekiq, these tasks demonstrate how to <a href="http://docs.ansible.com/ansible/playbooks_loops.html">work with cycles</a> in Ansible and solve the problem of starting / stopping several processes at once: <br><div class="spoiler">  <b class="spoiler_title">ansible / tasks / sidekiq_start.yml</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml"># ansible/tasks/sidekiq_start.yml --- - name: start sidekiq shell: "</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ rvm_wrapper_command }}</span></span><span class="xml"><span class="xml"> bundle exec sidekiq --index </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ item }}</span></span><span class="xml"><span class="xml"> --pidfile </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ pids_path }}</span></span><span class="xml"><span class="xml">/sidekiq-</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ item }}</span></span><span class="xml"><span class="xml">.pid --environment </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ rails_env_name }}</span></span><span class="xml"><span class="xml"> --logfile </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ shared_path }}</span></span><span class="xml"><span class="xml">/log/sidekiq.log --daemon" #  item -  i  .   with_sequence  4,  item  1,2,3,4 with_sequence: count=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ sidekiq_process_number }}</span></span><span class="xml"><span class="xml"> #   sidekiq          </span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">ansible / tasks / sidekiq_stop.yml</b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml"># ansible/tasks/sidekiq_stop.yml --- - name: stop sidekiq shell: "</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ rvm_wrapper_command }}</span></span><span class="xml"><span class="xml"> bundle exec sidekiqctl stop </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ pids_path }}</span></span><span class="xml"><span class="xml">/sidekiq-</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ item }}</span></span><span class="xml"><span class="xml">.pid 20" ignore_errors: yes #  ,     ,   ,    . with_sequence: count=</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ sidekiq_process_number }}</span></span><span class="xml"></span><span class="xml"></span></code> </pre><br></div></div><br><br><h2>  Conclusion </h2><br>  Now we can use Ansible to deploy rails applications: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> myawesomestartup/ansible <span class="hljs-comment"><span class="hljs-comment"># : ansible-playbook deploy.yml -i inventory/production #  : ansible-playbook app.yml -i inventory/production #  sidekiq: ansible-playbook sidekiq.yml -i inventory/production #      : ansible-playbook deploy.yml -i inventory/staging -e git_branch="hotfix/14082015-777-production_bug"</span></span></code> </pre><br>  Since this article gives only an example (albeit a working one), I will point out the ways in which you can go further: <br><ol><li>  Implement <a href="https://www.phusionpassenger.com/library/admin/standalone/restart_app.html">graceful restart</a> for passenger. </li><li>  Use <a href="http://docs.ansible.com/ansible/playbooks_roles.html">the</a> Ansible <a href="http://docs.ansible.com/ansible/playbooks_roles.html">role mechanism</a> instead of nested playbooks. </li><li>  Implement rollback to roll back to previous releases. </li><li>  In general, to bring this example more in line with the <a href="http://docs.ansible.com/ansible/playbooks_best_practices.html">recommendations of the developers</a> . </li></ol><br>  And the most important thing.  Ansible can do much more than roll out application releases and restart servers.  After all, I repeat, ansible is not just a deployment tool, but a complete configuration management tool.  For example, with the help of roles, you can configure application deployment from scratch, directly to bare server hardware.  And the simplicity of the yml-notation makes it easy to modify the solutions found to fit your needs. <br><br>  All source codes from the article <a href="https://github.com/ilpagency/rails-sidekiq-ansible-sample">are available on GitHub</a> .  Thanks for attention. <br></div><p>Source: <a href="https://habr.com/ru/post/266353/">https://habr.com/ru/post/266353/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266343/index.html">Handling cloud traffic. Who needs network function virtualization (NFV)?</a></li>
<li><a href="../266345/index.html">A practical guide to hacking (and protecting) games on Unity</a></li>
<li><a href="../266347/index.html">Overview of segmentation algorithms</a></li>
<li><a href="../266349/index.html">Practical training in pentest laboratories. Part 1</a></li>
<li><a href="../266351/index.html">Battered banality. As a schoolboy bot wrote</a></li>
<li><a href="../266355/index.html">Firebase queue: steroids for firebase</a></li>
<li><a href="../266357/index.html">100 out of 100 in Google PageSpeed ‚Äã‚ÄãInsights (Bug or feature)?</a></li>
<li><a href="../266359/index.html">In the guests' sitting "Grasshopper"</a></li>
<li><a href="../266361/index.html">1–°: Programmers Club - Teacher‚Äôs View</a></li>
<li><a href="../266363/index.html">We draw on electronic map tiles in MSSQL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>