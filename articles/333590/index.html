<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring the Apache CloudStack Failover Management Server using MariaDB Galera Replication</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After my first and second articles on Apache CloudStack, a user approached me with a question about how to organize a highly available ACS control ser...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring the Apache CloudStack Failover Management Server using MariaDB Galera Replication</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/984/438/bb4/984438bb4a2a4c3eb173bc797f041ae9.png"><br>  After my <a href="https://habrahabr.ru/post/332168/">first</a> and <a href="https://habrahabr.ru/post/332528/">second</a> articles on Apache CloudStack, a user approached me with a question about how to organize a highly available ACS control server using Galera.  Previously, I did not use such a deployment topology, but on this occasion I decided to try this configuration. </p><br><p>  This article describes the method for deploying a fault-tolerant configuration of Apache CloudStack control servers in conjunction with the MariaDB multimaster cluster (Galera). <a name="habracut"></a>  When developing this manual, the following versions of software products were used: </p><br><ol><li>  Apache CloudStack 4.9.2 </li><li>  CentOS 7 </li><li>  MariaDB 5.5.52 (default on CentOS 7) </li><li>  Ansible 2.3.1 (default on CentOS 7) </li></ol><br><blockquote>  <strong>UPD: after the initial publication of the article, the architect ShapeBlue drew my attention to some of the limitations of ACS, which do not allow full use of the original version, so the article was amended to take into account the identified shortcomings.</strong> </blockquote><p>  The target deployment model is shown in the following figure. </p><br><p><img src="https://habrastorage.org/web/289/716/fe2/289716fe27164207ae4aee0d5dee84ad.png"></p><br><p>  Within this model, each ACS server is associated with some selected MariaDB server as a master, and the remaining servers are assigned as slaves.  Some English-language manuals suggest using the HAProxy intermediate component to organize an additional layer of connections to MariaDB in such a way that each ACS server can transparently switch between DBMS servers upon failure, however, in my opinion, external traffic switching between ACS servers is enough, which can be configured using nginx. </p><br><h2 id="obschaya-shema-razvertyvaniya">  General deployment pattern </h2><br><p>  Consider the general scheme of the deployment process of the entire system and the initial assumptions. </p><br><h3 id="mariadb">  MariaDB </h3><br><p>  To deploy the MariaDB configuration, the Ansible Playbook will be used, available on <br>  <a href="https://github.com/bwsw/mariadb-ansible-galera-cluster">Github</a>  This approach allows the article to focus on exactly how to install ACS, but not setting up a Galera cluster.  Since the above playbook is designed for use with CentOS 7, the operating system is appropriately selected.  In the event that the reader plans to perform a similar setup on another operating system compatible with ACS 4.9.2, the general scheme remains the same. </p><br><blockquote>  Playboy is not mine.  In the repository you can see where the fork is made.  Regarding the original, it is slightly corrected in order to support the network on eth0. </blockquote><br><h3 id="apache-cloudstack">  Apache cloudstack </h3><br><p>  Strange as it may sound, you cannot install ACS 4.9.2 on a working Galera cluster.  This limitation arises due to the fact that the management server during installation creates a database for version 4.0, which is converted into a database of version 4.9.2 by a chain of migrations.  Since the database engines (used in earlier versions of ACS), which are not supported by the cluster version of Galera, are used during the initial installation and migrations, the process does not complete successfully. </p><br><p>  To overcome this problem, we will perform the installation in several stages: </p><br><ol><li>  Installing ACS 4.9.2 on a regular MySQL server, dumping databases. </li><li>  Import databases into the Galera cluster. </li><li>  Connecting management servers to the Galera cluster. </li></ol><br><p>  The output will be obtained working topology displayed in the first figure. </p><br><h2 id="ispytatelnyy-stend">  Test stand </h2><br><p>  We will deploy on 4 hosts: </p><br><ol><li>  <strong>ac</strong> - CentOS 7 host with ansible installed, from which we will configure the remaining hosts, and where we will perform the initial deployment of ACS 4.9.2 without using Galera; </li><li>  <strong>h1</strong> , <strong>h2</strong> , <strong>h3</strong> - CentOS 7 hosts on which ACS 4.9.2 and Galera cluster version will be installed. </li></ol><br><p> The Galera Cluster Deployment Playbook assumes that the hosts are on a secure network (simplified firewall setup) accessible through an eth0 network card.  The playbook assumes that the <code>firewalld</code> service is being used. </p><br><h2 id="bazovaya-ustanovka-bez-ha">  Basic installation (without HA) </h2><br><p>  Install the base components on the ac host: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># yum install epel-release # yum install net-tools git mariadb mariadb-server ansible</span></span></code> </pre> <br><p>  Launch MariaDB: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># systemctl start mariadb</span></span></code> </pre> <br><p>  Check that MariaDB works: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mysql -uroot Welcome to the MariaDB monitor. Commands end with ; or \g. Your MariaDB connection id is 2 Server version: 5.5.52-MariaDB MariaDB Server Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others. Type 'help;' or '\h' for help. Type '\c' to clear the current input statement. MariaDB [(none)]&gt;</span></span></code> </pre> <br><p>  Enter the recommended ACS options in the [mysql] section of the MariaDB server settings (/etc/my.cnf.d/server.cnf): </p><br><pre> <code class="hljs pgsql">[mysql] innodb_rollback_on_timeout=<span class="hljs-number"><span class="hljs-number">1</span></span> innodb_lock_wait_timeout=<span class="hljs-number"><span class="hljs-number">600</span></span> max_connections=<span class="hljs-number"><span class="hljs-number">350</span></span> <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>-bin=mysql-bin binlog-<span class="hljs-keyword"><span class="hljs-keyword">format</span></span> = <span class="hljs-string"><span class="hljs-string">'ROW'</span></span></code> </pre> <br><p>  Restart MariaDB: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># systemctl restart mariadb</span></span></code> </pre> <br><p>  Create a Yum repository file for Apache CloudStack <code>/etc/yum.repos.d/cloudstack.repo</code> with the following contents: </p><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">cloudstack</span></span>] name=cloudstack baseurl=http:<span class="hljs-comment"><span class="hljs-comment">//cloudstack.apt-get.eu/centos/7/4.9/ enabled=1 gpgcheck=0</span></span></code> </pre> <br><p>  Install the ACS management server package: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># yum install cloudstack-management</span></span></code> </pre> <br><p>  Editing the Java security file: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># grep -l '/dev/random' /usr/lib/jvm/java-*/jre/lib/security/java.security /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.131-3.b12.el7_3.x86_64/jre/lib/security/java.security</span></span></code> </pre> <br><p>  where we replace the random number generator (required for the encryption library used in ACS): </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># sed -i 's#securerandom.source=file:/dev/random#securerandom.source=file:/dev/urandom#' /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.131-3.b12.el7_3.x86_64/jre/lib/security/java.security</span></span></code> </pre> <br><p>  Change the SELinux policy to permissive in the file: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># sed -i 's#SELINUX=enforcing#SELINUX=permissive#' /etc/selinux/config</span></span></code> </pre> <br><p>  Run the installation of the ACS database (with access to MariaDB cloud / secret) from the root user (a local database access password is not required): </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cloudstack-setup-databases cloud:secret@localhost --deploy-as=root Mysql user name:cloud [ OK ] Mysql user password:****** [ OK ] Mysql server ip:localhost [ OK ] Mysql server port:3306 [ OK ] Mysql root user name:root [ OK ] Mysql root user password:****** [ OK ] Checking Cloud database files ... [ OK ] Checking local machine hostname ... [ OK ] Checking SELinux setup ... [ OK ] Detected local IP address as 176.120.25.66, will use as cluster management server node IP[ OK ] Preparing /etc/cloudstack/management/db.properties [ OK ] Applying /usr/share/cloudstack-management/setup/create-database.sql [ OK ] Applying /usr/share/cloudstack-management/setup/create-schema.sql [ OK ] Applying /usr/share/cloudstack-management/setup/create-database-premium.sql [ OK ] Applying /usr/share/cloudstack-management/setup/create-schema-premium.sql [ OK ] Applying /usr/share/cloudstack-management/setup/server-setup.sql [ OK ] Applying /usr/share/cloudstack-management/setup/templates.sql [ OK ] Processing encryption ... [ OK ] Finalizing setup ... [ OK ] CloudStack has successfully initialized database, you can check your database configuration in /etc/cloudstack/management/db.properties</span></span></code> </pre> <br><p>  Run the installation of the management server: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cloudstack-setup-management --tomcat7 Starting to configure CloudStack Management Server: Configure Firewall ... [OK] Configure CloudStack Management Server ...[OK] CloudStack Management Server setup is Done!</span></span></code> </pre> <br><p>  We check server availability in a few seconds ( <a href="http://ac:8080/client">http: // ac: 8080 / client</a> ): </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># LANG=C wget -O /dev/null http://ac:8080/client 2&gt;&amp;1 | grep '200 OK' HTTP request sent, awaiting response... 200 OK</span></span></code> </pre> <br><p>  I recommend using the browser to the URL and make sure that the server is working and allows you to authenticate using the admin / password pair.  If everything works out, then the installation of the management server was successfully completed. </p><br><p>  Now save the database dumps for further import to the Galera cluster: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mysqldump -uroot cloud &gt;cloud.sql # mysqldump -uroot cloud_usage &gt;cloud_usage.sql</span></span></code> </pre> <br><p>  Ensure that all tables have the InnoDB format: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># grep ENGINE *.sql | grep -v InnoDB | grep -v -c '*/' 0</span></span></code> </pre> <br><h2 id="nastroyka-repliciruemoy-sredy-galera">  Configuring Galera Replicated Environment </h2><br><p>  We will deploy the Galera cluster using Ansible.  Ansible works using the SSH protocol, so it is necessary to put the public part of the SSH keys on the h1, h2, h3 hosts, for the ac host. </p><br><p>  Generate an SSH key on the ac host: </p><br><pre> <code class="hljs vbscript"># ssh-keygen Generating <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> rsa key pair. Enter file <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> which <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> save the key (/root/.ssh/id_rsa): Enter passphrase (<span class="hljs-literal"><span class="hljs-literal">empty</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> no passphrase): Enter same passphrase again: Your identification has been saved <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /root/.ssh/id_rsa. Your <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> key has been saved <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /root/.ssh/id_rsa.pub. The key fingerprint <span class="hljs-keyword"><span class="hljs-keyword">is</span></span>: <span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">81</span></span>:f7:<span class="hljs-number"><span class="hljs-number">90</span></span>:f0:<span class="hljs-number"><span class="hljs-number">4</span></span>f:e0:d4:<span class="hljs-number"><span class="hljs-number">8</span></span>a:<span class="hljs-number"><span class="hljs-number">74</span></span>:ca:<span class="hljs-number"><span class="hljs-number">40</span></span>:ba:d9:c7:<span class="hljs-number"><span class="hljs-number">8</span></span>e root@ac The key<span class="hljs-comment"><span class="hljs-comment">'s randomart image is: +--[ RSA 2048]----+ | .. .o+o | | .. o+=o. | |. + ==+. | | + .+ .=. | |o . o S | | + | | E . | | | | | +-----------------+</span></span></code> </pre> <br><p>  Spread the key to all hosts: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ssh-copy-id h1 The authenticity of host 'h1 (XYZC)' can\'t be established. ECDSA key fingerprint is 27:f7:34:23:ea:b4:d2:61:8c:ec:d8:13:c2:9f:8a:ef. Are you sure you want to continue connecting (yes/no)? yes /usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed /usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys root@h1\'s password: Number of key(s) added: 1 Now try logging into the machine, with: "ssh 'h1'" and check to make sure that only the key(s) you wanted were added.</span></span></code> </pre> <br><p>  Similar actions will be done for the h2 and h3 hosts. </p><br><p>  Now you need to clone the Git repository with the Ansible playbook: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># git clone https://github.com/bwsw/mariadb-ansible-galera-cluster.git Cloning into 'mariadb-ansible-galera-cluster'... remote: Counting objects: 194, done. remote: Compressing objects: 100% (5/5), done. remote: Total 194 (delta 0), reused 2 (delta 0), pack-reused 188 Receiving objects: 100% (194/194), 29.91 KiB | 0 bytes/s, done. Resolving deltas: 100% (68/68), done.</span></span></code> </pre> <br><p>  Change the directory to <code>mariadb-ansible-galera-cluster</code> : </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cd mariadb-ansible-galera-cluster # pwd /root/mariadb-ansible-galera-cluster</span></span></code> </pre> <br><p>  Edit the file <code>galera.hosts</code> , where we will point our servers h1, h2, h3: </p><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">galera_cluster</span></span>] h[<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>] ansible_user=root</code> </pre> <br><p>  Check the correctness of the configuration: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ansible -i galera.hosts all -m ping h3 | SUCCESS =&gt; { "changed": false, "ping": "pong" } h2 | SUCCESS =&gt; { "changed": false, "ping": "pong" } h1 | SUCCESS =&gt; { "changed": false, "ping": "pong" }</span></span></code> </pre> <br><p>  Install the necessary dependencies: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ansible -i galera.hosts all -m raw -s -a "yum install -y epel-release firewalld ntpd"</span></span></code> </pre> <br><p>  Update system time: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ansible -i galera.hosts all -m raw -s -a "chkconfig ntpd on &amp;&amp; service ntpd stop &amp;&amp; ntpdate 165.193.126.229 0.ru.pool.ntp.org 1.ru.pool.ntp.org 2.ru.pool.ntp.org 3.ru.pool.ntp.org &amp;&amp; service ntpd start"</span></span></code> </pre> <br><p>  Make the necessary changes to the configuration file ansible (/etc/ansible/ansible.cfg), as described in <br>  <a href="">README.md</a> to the playbook: </p><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">defaults</span></span>] gathering = smart fact_caching = jsonfile fact_caching_connection = ~/.ansible/cache</code> </pre> <br><p>  Let's start installing the Galera cluster according to the playbook README.md: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ansible-playbook -i galera.hosts galera.yml --tags setup</span></span></code> </pre> <br><p>  It will take several minutes. Following the execution we will get the installed MariaDB servers on the h1, h2, h3 hosts without cluster assembly.  The next step is to run the remaining steps of the playbook: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ansible-playbook -i galera.hosts galera.yml --skip-tags setup</span></span></code> </pre> <br><p>  The last step is to start the cluster: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ansible-playbook -i galera.hosts galera_bootstrap.yml</span></span></code> </pre> <br><p>  Check the status of the cluster.  To do this, go to the h1, h2, h3 hosts and execute the mysql console: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mysql -uroot Welcome to the MariaDB monitor. Commands end with ; or \g. Your MariaDB connection id is 6 Server version: 10.1.25-MariaDB MariaDB Server Copyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others. Type 'help;' or '\h' for help. Type '\c' to clear the current input statement. MariaDB [(none)]&gt; SHOW GLOBAL STATUS LIKE 'wsrep_%'; +------------------------------+------------------------------------------------------------+ | Variable_name | Value | +------------------------------+------------------------------------------------------------+ | wsrep_apply_oooe | 0.000000 | | wsrep_apply_oool | 0.000000 | | wsrep_apply_window | 0.000000 | | wsrep_causal_reads | 0 | | wsrep_cert_deps_distance | 0.000000 | | wsrep_cert_index_size | 0 | | wsrep_cert_interval | 0.000000 | | wsrep_cluster_conf_id | 3 | | wsrep_cluster_size | 3 | | wsrep_cluster_state_uuid | 230ed410-6b9b-11e7-8aa5-4b041fceb486 | | wsrep_cluster_status | Primary | | wsrep_commit_oooe | 0.000000 | | wsrep_commit_oool | 0.000000 | | wsrep_commit_window | 0.000000 | | wsrep_connected | ON | | wsrep_desync_count | 0 | | wsrep_evs_delayed | | | wsrep_evs_evict_list | | | wsrep_evs_repl_latency | 0/0/0/0/0 | | wsrep_evs_state | OPERATIONAL | | wsrep_flow_control_paused | 0.000000 | | wsrep_flow_control_paused_ns | 0 | | wsrep_flow_control_recv | 0 | | wsrep_flow_control_sent | 0 | | wsrep_gcomm_uuid | 230d9f4f-6b9b-11e7-ba99-fab39514a7e8 | | wsrep_incoming_addresses | 111.120.25.96:3306,111.120.25.229:3306,111.120.25.152:3306 | | wsrep_last_committed | 0 | | wsrep_local_bf_aborts | 0 | | wsrep_local_cached_downto | 18446744073709551615 | | wsrep_local_cert_failures | 0 | | wsrep_local_commits | 0 | | wsrep_local_index | 0 | | wsrep_local_recv_queue | 0 | | wsrep_local_recv_queue_avg | 0.000000 | | wsrep_local_recv_queue_max | 1 | | wsrep_local_recv_queue_min | 0 | | wsrep_local_replays | 0 | | wsrep_local_send_queue | 0 | | wsrep_local_send_queue_avg | 0.000000 | | wsrep_local_send_queue_max | 1 | | wsrep_local_send_queue_min | 0 | | wsrep_local_state | 4 | | wsrep_local_state_comment | Synced | | wsrep_local_state_uuid | 230ed410-6b9b-11e7-8aa5-4b041fceb486 | | wsrep_protocol_version | 7 | | wsrep_provider_name | Galera | | wsrep_provider_vendor | Codership Oy &lt;info@codership.com&gt; | | wsrep_provider_version | 25.3.20(r3703) | | wsrep_ready | ON | | wsrep_received | 10 | | wsrep_received_bytes | 769 | | wsrep_repl_data_bytes | 0 | | wsrep_repl_keys | 0 | | wsrep_repl_keys_bytes | 0 | | wsrep_repl_other_bytes | 0 | | wsrep_replicated | 0 | | wsrep_replicated_bytes | 0 | | wsrep_thread_count | 2 | +------------------------------+------------------------------------------------------------+ 58 rows in set (0.01 sec) MariaDB [(none)]&gt;</span></span></code> </pre> <br><p>  Pay attention to the <code>wsrep_incoming_addresses</code> field, there should be the IP addresses of our three servers h1, h2, h3. </p><br><h2 id="ustanovka-serverov-upravleniya-dlya-repliciruemoy-sredy-galera">  Installing Management Servers for the Galera Replicated Environment </h2><br><p>  The next step is to import the <code>cloud.sql</code> and <code>cloud_usage.sql</code> into the cluster. </p><br><p>  Copy the dumps: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># scp ../*.sql h1: cloud.sql 100% 1020KB 1.0MB/s 00:00 cloud_usage.sql 100% 33KB 32.7KB/s 00:00</span></span></code> </pre> <br><p>  Open an SSH connection to host h1, where we will perform all operations for importing databases: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ssh h1</span></span></code> </pre> <br><p>  Create databases, issue privileges to the user, and import the dumps: </p><br><pre> <code class="bash hljs">[root@h1 ~]<span class="hljs-comment"><span class="hljs-comment"># echo "CREATE DATABASE cloud;" | mysql -uroot [root@h1 ~]# echo "CREATE DATABASE cloud_usage;" | mysql -uroot [root@h1 ~]# echo "GRANT ALL PRIVILEGES ON cloud.* TO cloud@'localhost' identified by 'secret'" | mysql -uroot [root@h1 ~]# echo "GRANT ALL PRIVILEGES ON cloud_usage.* TO cloud@'localhost' identified by 'secret'" | mysql -uroot [root@h1 ~]# echo "GRANT ALL PRIVILEGES ON cloud.* TO cloud@'h1' identified by 'secret'" | mysql -uroot [root@h1 ~]# echo "GRANT ALL PRIVILEGES ON cloud_usage.* TO cloud@'h1' identified by 'secret'" | mysql -uroot [root@h1 ~]# echo "GRANT ALL PRIVILEGES ON cloud.* TO cloud@'h2' identified by 'secret'" | mysql -uroot [root@h1 ~]# echo "GRANT ALL PRIVILEGES ON cloud_usage.* TO cloud@'h2' identified by 'secret'" | mysql -uroot [root@h1 ~]# echo "GRANT ALL PRIVILEGES ON cloud.* TO cloud@'h3' identified by 'secret'" | mysql -uroot [root@h1 ~]# echo "GRANT ALL PRIVILEGES ON cloud_usage.* TO cloud@'h3' identified by 'secret'" | mysql -uroot [root@h1 ~]# cat cloud.sql | mysql -uroot cloud [root@h1 ~]# cat cloud_usage.sql | mysql -uroot cloud_usage</span></span></code> </pre> <br><blockquote>  It is worth making sure that our cloud, cloud_usage databases are replicated to h2 and h3 servers. </blockquote><p>  Now we will install the ACS control servers.  First, from the <strong>ac</strong> host, copy the ACS repository settings: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ansible -i galera.hosts all -m copy -a "src=/etc/yum.repos.d/cloudstack.repo dest=/etc/yum.repos.d/cloudstack.repo"</span></span></code> </pre> <br><p>  Then install the Apache CloudStack management server packages: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ansible -i galera.hosts all -m raw -s -a "yum install -y cloudstack-management"</span></span></code> </pre> <br><p>  Change the Java security setting we already know: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ansible -i galera.hosts all -m raw -s -a "sed -i 's#securerandom.source=file:/dev/random#securerandom.source=file:/dev/urandom#' /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.131-3.b12.el7_3.x86_64/jre/lib/security/java.security"</span></span></code> </pre> <br><p>  Perform the configuration of connecting the control server ACS to the DBMS on the <strong>h1</strong> host: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ansible -i galera.hosts all -m raw -s -a "cloudstack-setup-databases cloud:secret@h1"</span></span></code> </pre> <br><p>  Now all servers will use host h1 as the main database server.  Next, we will perform additional configuration of auxiliary servers. </p><br><p>  Install the Apache CloudStack high-availability connection package to MySQL (for some unknown reason, CentOS 7 is missing): </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ansible -i galera.hosts all -m raw -s -a "rpm -i http://packages.shapeblue.com.s3-eu-west-1.amazonaws.com/cloudstack/upstream/centos7/4.9/cloudstack-mysql-ha-4.9.2.0-shapeblue0.el7.centos.x86_64.rpm"</span></span></code> </pre> <br><p>  We start the control servers: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ansible -i galera.hosts all -m raw -s -a "cloudstack-setup-management --tomcat7"</span></span></code> </pre> <br><p>  Make sure everything is up and running: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ansible -i galera.hosts all -m raw -s -a "ps xa | grep java"</span></span></code> </pre> <br><p>  Now, at the addresses <a href="http://h1:8080/client">http: // h1: 8080 / client</a> , <a href="http://h2:8080/client">http: // h2: 8080 / client</a> , <a href="http://h3:8080/client">http: // h3: 8080 / client</a> , fault tolerant control servers are running that can be ‚Äúclosed‚Äù by nginx to ensure high availability.  At the same time in the log <code>/var/log/cloudstack/management/management-server.log</code> you can see the records that the servers know about each other: </p><br><pre> <code class="hljs pgsql"># cat /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/cloudstack/management/management-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> | grep <span class="hljs-string"><span class="hljs-string">'management node'</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-07</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>,<span class="hljs-number"><span class="hljs-number">209</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEBUG</span></span> [cccClusterManagerImpl] (<span class="hljs-keyword"><span class="hljs-keyword">Cluster</span></span>-Heartbeat<span class="hljs-number"><span class="hljs-number">-1</span></span>:ctx-b1d64593) (logid:<span class="hljs-number"><span class="hljs-number">18</span></span>f29c84) Detected management node joined, id:<span class="hljs-number"><span class="hljs-number">7</span></span>, nodeIP:<span class="hljs-number"><span class="hljs-number">111.120</span></span><span class="hljs-number"><span class="hljs-number">.25</span></span><span class="hljs-number"><span class="hljs-number">.96</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-07</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>,<span class="hljs-number"><span class="hljs-number">231</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEBUG</span></span> [cccClusterManagerImpl] (<span class="hljs-keyword"><span class="hljs-keyword">Cluster</span></span>-Heartbeat<span class="hljs-number"><span class="hljs-number">-1</span></span>:ctx-b1d64593) (logid:<span class="hljs-number"><span class="hljs-number">18</span></span>f29c84) Detected management node joined, id:<span class="hljs-number"><span class="hljs-number">12</span></span>, nodeIP:<span class="hljs-number"><span class="hljs-number">111.120</span></span><span class="hljs-number"><span class="hljs-number">.25</span></span><span class="hljs-number"><span class="hljs-number">.152</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-07</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>,<span class="hljs-number"><span class="hljs-number">231</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEBUG</span></span> [cccClusterManagerImpl] (<span class="hljs-keyword"><span class="hljs-keyword">Cluster</span></span>-Heartbeat<span class="hljs-number"><span class="hljs-number">-1</span></span>:ctx-b1d64593) (logid:<span class="hljs-number"><span class="hljs-number">18</span></span>f29c84) Detected management node joined, id:<span class="hljs-number"><span class="hljs-number">17</span></span>, nodeIP:<span class="hljs-number"><span class="hljs-number">111.120</span></span><span class="hljs-number"><span class="hljs-number">.25</span></span><span class="hljs-number"><span class="hljs-number">.229</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-07</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span>,<span class="hljs-number"><span class="hljs-number">195</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEBUG</span></span> [cccClusterManagerImpl] (<span class="hljs-keyword"><span class="hljs-keyword">Cluster</span></span>-Heartbeat<span class="hljs-number"><span class="hljs-number">-1</span></span>:ctx<span class="hljs-number"><span class="hljs-number">-76484</span></span>aea) (logid:b7416e7b) Detected management node left <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rejoined quickly, id:<span class="hljs-number"><span class="hljs-number">7</span></span>, nodeIP:<span class="hljs-number"><span class="hljs-number">111.120</span></span><span class="hljs-number"><span class="hljs-number">.25</span></span><span class="hljs-number"><span class="hljs-number">.96</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-07</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>,<span class="hljs-number"><span class="hljs-number">582</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span> [cccClusterManagerImpl] (localhost-startStop<span class="hljs-number"><span class="hljs-number">-1</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) (logid:) Detected that another management node <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the same IP <span class="hljs-number"><span class="hljs-number">111.120</span></span><span class="hljs-number"><span class="hljs-number">.25</span></span><span class="hljs-number"><span class="hljs-number">.229</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> considered <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> running <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> DB, however it <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> pingable, we will <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cluster</span></span> initialization <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> this management <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> node <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-07</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span>,<span class="hljs-number"><span class="hljs-number">292</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEBUG</span></span> [cccClusterManagerImpl] (<span class="hljs-keyword"><span class="hljs-keyword">Cluster</span></span>-Heartbeat<span class="hljs-number"><span class="hljs-number">-1</span></span>:ctx<span class="hljs-number"><span class="hljs-number">-8880</span></span>f35d) (logid:<span class="hljs-number"><span class="hljs-number">037</span></span>a1c4d) Detected management node joined, id:<span class="hljs-number"><span class="hljs-number">7</span></span>, nodeIP:<span class="hljs-number"><span class="hljs-number">111.120</span></span><span class="hljs-number"><span class="hljs-number">.25</span></span><span class="hljs-number"><span class="hljs-number">.96</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-07</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span>,<span class="hljs-number"><span class="hljs-number">312</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEBUG</span></span> [cccClusterManagerImpl] (<span class="hljs-keyword"><span class="hljs-keyword">Cluster</span></span>-Heartbeat<span class="hljs-number"><span class="hljs-number">-1</span></span>:ctx<span class="hljs-number"><span class="hljs-number">-8880</span></span>f35d) (logid:<span class="hljs-number"><span class="hljs-number">037</span></span>a1c4d) Detected management node joined, id:<span class="hljs-number"><span class="hljs-number">12</span></span>, nodeIP:<span class="hljs-number"><span class="hljs-number">111.120</span></span><span class="hljs-number"><span class="hljs-number">.25</span></span><span class="hljs-number"><span class="hljs-number">.152</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-07</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span>,<span class="hljs-number"><span class="hljs-number">312</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEBUG</span></span> [cccClusterManagerImpl] (<span class="hljs-keyword"><span class="hljs-keyword">Cluster</span></span>-Heartbeat<span class="hljs-number"><span class="hljs-number">-1</span></span>:ctx<span class="hljs-number"><span class="hljs-number">-8880</span></span>f35d) (logid:<span class="hljs-number"><span class="hljs-number">037</span></span>a1c4d) Detected management node joined, id:<span class="hljs-number"><span class="hljs-number">17</span></span>, nodeIP:<span class="hljs-number"><span class="hljs-number">111.120</span></span><span class="hljs-number"><span class="hljs-number">.25</span></span><span class="hljs-number"><span class="hljs-number">.229</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-07</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>,<span class="hljs-number"><span class="hljs-number">927</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEBUG</span></span> [cccClusterManagerImpl] (<span class="hljs-keyword"><span class="hljs-keyword">Cluster</span></span>-Heartbeat<span class="hljs-number"><span class="hljs-number">-1</span></span>:ctx<span class="hljs-number"><span class="hljs-number">-7e3</span></span>e2d82) (logid:e63ffa72) Detected management node joined, id:<span class="hljs-number"><span class="hljs-number">7</span></span>, nodeIP:<span class="hljs-number"><span class="hljs-number">111.120</span></span><span class="hljs-number"><span class="hljs-number">.25</span></span><span class="hljs-number"><span class="hljs-number">.96</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-07</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>,<span class="hljs-number"><span class="hljs-number">935</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEBUG</span></span> [cccClusterManagerImpl] (<span class="hljs-keyword"><span class="hljs-keyword">Cluster</span></span>-Heartbeat<span class="hljs-number"><span class="hljs-number">-1</span></span>:ctx<span class="hljs-number"><span class="hljs-number">-7e3</span></span>e2d82) (logid:e63ffa72) Detected management node joined, id:<span class="hljs-number"><span class="hljs-number">12</span></span>, nodeIP:<span class="hljs-number"><span class="hljs-number">111.120</span></span><span class="hljs-number"><span class="hljs-number">.25</span></span><span class="hljs-number"><span class="hljs-number">.152</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-07</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span>,<span class="hljs-number"><span class="hljs-number">935</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEBUG</span></span> [cccClusterManagerImpl] (<span class="hljs-keyword"><span class="hljs-keyword">Cluster</span></span>-Heartbeat<span class="hljs-number"><span class="hljs-number">-1</span></span>:ctx<span class="hljs-number"><span class="hljs-number">-7e3</span></span>e2d82) (logid:e63ffa72) Detected management node joined, id:<span class="hljs-number"><span class="hljs-number">17</span></span>, nodeIP:<span class="hljs-number"><span class="hljs-number">111.120</span></span><span class="hljs-number"><span class="hljs-number">.25</span></span><span class="hljs-number"><span class="hljs-number">.229</span></span></code> </pre> <br><p>  At the end of the configuration, configure the ACS control servers to use additional Galera servers (h2, h3) as slave servers and restart the ACS control servers. </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ansible -i galera.hosts all -m raw -s -a "service cloudstack-management stop" # ansible -i galera.hosts all -m raw -s -a "sed -i 's#db.ha.enabled=false#db.ha.enabled=true#' /etc/cloudstack/management/db.properties" # ansible -i galera.hosts all -m raw -s -a "sed -i 's#db.cloud.slaves=.*#db.cloud.slaves=h2,h3#' /etc/cloudstack/management/db.properties" # ansible -i galera.hosts all -m raw -s -a "sed -i 's#db.usage.slaves=.*#db.usage.slaves=h2,h3#' /etc/cloudstack/management/db.properties" # ansible -i galera.hosts all -m raw -s -a "service cloudstack-management start"</span></span></code> </pre> <br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  Setup is quite simple and should not cause any difficulties.  It is somewhat frustrating that it is impossible to perform installation on a Galera cluster right away, without performing a transfer procedure from a non-replicating environment to a replicable one after installation. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/333590/">https://habr.com/ru/post/333590/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../333580/index.html">npm link on steroids</a></li>
<li><a href="../333582/index.html">Search InterSystems documentation using iKnow and iFind technologies</a></li>
<li><a href="../333584/index.html">A collection of developer tools</a></li>
<li><a href="../333586/index.html">Bot for Telegram for 48 hours on Perl or how to buy cat food without leaving the chat</a></li>
<li><a href="../333588/index.html">Debugging the Android application using a browser</a></li>
<li><a href="../333592/index.html">Application of the principle of poka-yoke in programming using the example of PHP</a></li>
<li><a href="../333594/index.html">The system of rewinding time in the style of Prince of Persia</a></li>
<li><a href="../333596/index.html">I am the cause of the emergence of the Hungarian notation in Android</a></li>
<li><a href="../333598/index.html">Cold calls for web studio. Lead for 159 rubles a reality or fantasy?</a></li>
<li><a href="../333600/index.html">Competitive Intelligence at PHDays: Spying on the Internet of Things</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>