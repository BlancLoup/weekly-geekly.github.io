<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Introducing CockroachDB and creating a failover cluster with it on Ubuntu 16.04</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Preface from the translator: CockroachDB is a fairly young open-source relational database (Apache 2.0 license), originally created to be distributed ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Introducing CockroachDB and creating a failover cluster with it on Ubuntu 16.04</h1><div class="post__text post__text-html js-mediator-article">  <i>Preface from the translator: <a href="https://github.com/cockroachdb/cockroach/">CockroachDB</a> is a fairly young open-source <b>relational database</b> (Apache 2.0 license), originally created to be <b>distributed</b> (with horizontal scaling out of the box) and <b>fault tolerant</b> .</i>  <i>Its authors from Cockroach Labs, created in 2015, set themselves the goal of ‚Äúcombining the richness of SQL functionality with the horizontal availability common to NoSQL solutions‚Äù.</i>  <i>This manual was written by one of the employees of the company-developer and published on the website of the cloud provider DigitalOcean in order to acquaint IT specialists with this DBMS and demonstrate its use.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f4a/743/913/f4a74391339145c5b06c3c7a2ac3b67c.png"></div><br><h2>  Introduction </h2><br>  CockroachDB is an open source distributed database management system (SQL) that provides data consistency, scalability and survival. <br><br>  Setting up CockroachDB is simple: install it on multiple servers ( <i>nodes</i> ) and combine them into a single unit for collaboration ( <i>cluster</i> ).  All cluster nodes operate "symmetrically" and offer access to the same data.  If the storage for data needs to be increased, then with the architecture used, it is enough to create new nodes and attach to the cluster. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Details on how this works are described in the official documentation on <a href="https://www.cockroachlabs.com/docs/automated-scaling-and-repair.html">the CockroachDB scalability model</a> .  <i>(Approx. Translation: when one of the nodes reaches a limit on the amount of stored data, CockroachDB will try to redistribute data to other nodes where free space is still available. Replication factor is determined by the <a href="https://www.cockroachlabs.com/docs/configure-replication-zones.html">replication zones</a> settings.)</i> <br><br><blockquote>  <b>Please note</b> that at the time of creation of this manual <i>[and its translation - approx.</i>  <i>trans.]</i> CockroachDB was in beta status, so it is recommended that you use this document as a way of becoming familiar with the technology, and not for deploying the product for use in critical software. <br><br>  The manual does not provide secure access to the cluster administrative interface;  anyone can access it, knowing the correct URL.  If you are going to use this configuration in production, do not forget to close access to port 8080 by the firewall rules. </blockquote><br>  Since this guide describes an insecure installation without using encryption with SSL, it is not recommended for use in production.  <i>For more details on a secure installation, you can refer to a more complete article that describes how to <a href="https://www.cockroachlabs.com/docs/deploy-cockroachdb-on-digital-ocean.html">create certificates</a> , and then add a directory with them as a parameter when you start each of the nodes.</i> <br><br><h2>  Training </h2><br>  Before you begin, you will need: <br><br><ul><li>  Three servers with Ubuntu 16.04 with 2+ GB of RAM and the option included <b>Private Networking</b> [for DigitalOcean].  All of them must be in the same region.  The following names will be used as their names in the article: <code>cockroach-01</code> , <code>cockroach-02</code> , <code>cockroach-03</code> . </li><li>  Each server must have an admin user added (not root, but with sudo privileges). </li><li>  All servers must have TCP traffic on two ports.  If UFW is configured as a firewall, you need to configure it accordingly: <br><ul><li>  26257 - for interaction between nodes and with the application ( <code>sudo ufw allow 26257/tcp</code> ); </li><li>  8080 - for the Admin UI administrative interface ( <code>sudo ufw allow 8080/tcp</code> ). </li></ul></li><li>  Optional: install and configure NTP on each server.  (If you deploy a DBMS for short testing, this is not necessary.) </li></ul><br>  Find out the internal and external IP addresses of each server.  Further in the manual for them will be used the notation of the type <code>cockroach_01_public_ip</code> and <code>cockroach_01_private_ip</code> .  To find out the internal IP in DigitalOcean, go to the control panel and look at the <b>Private IP</b> field in the upper block of information. <br><br><h2>  1. Installing CockroachDB </h2><br>  Each cluster node must have an executable <code>cockroach</code> file.  The following describes the installation of CockroachDB on the first server ( <code>cockroach-01</code> ), by analogy with which it is necessary to perform operations on the other nodes. <br><br>  We connect via SSH to the server, then download and install the latest version of the <code>cockroach</code> binary in the user's home directory: <br><br><pre> <code class="bash hljs">$ ssh sammy@cockroach_01_public_ip $ wget https://binaries.cockroachdb.com/cockroach-latest.linux-amd64.tgz?s=<span class="hljs-keyword"><span class="hljs-keyword">do</span></span> $ tar -xf cockroach-latest.linux-amd64.tgz?s=<span class="hljs-keyword"><span class="hljs-keyword">do</span></span> --strip=1 cockroach-latest.linux-amd64/cockroach $ sudo mv cockroach /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin</code> </pre><br>  Check that the executable DBMS file is available by learning its version: <br><br><pre> <code class="bash hljs">$ cockroach version Build Tag: v1.0-rc.1-dirty Build Time: 2017/05/01 18:33:34 Distribution: CCL Platform: linux amd64 Go Version: go1.8.1 C Compiler: gcc 6.3.0 Build SHA-1: 2d4d1ab5c42efb5accf73c9876e6ffd934fdc9e6 Build Type: release</code> </pre><br>  If after these steps the system does not find the <code>cockroach</code> command, make sure that the file was actually downloaded, unpacked and moved. <br><br>  Repeat these operations on two other servers that will become cluster nodes ( <code>cockroach-02</code> and <code>cockroach-03</code> ).  After that, you can configure the cluster itself. <br><br><h2>  2. Configure the first node </h2><br>  The first CockroachDB node, <code>cockroach-01</code> , will launch a cluster.  But there is nothing special about its configuration: it simply runs as one DBMS server, to which the others join. <br><br>  To start the cluster, execute the following command on <code>cockroach-01</code> : <br><br><pre> <code class="bash hljs">cockroach start --insecure --background --advertise-host=cockroach_01_private_ip</code> </pre> <br>  It will start the node without SSL encryption ( <code>--insecure</code> ), return the command line for further work ( <code>--background</code> ) and raise the node to communicate with other nodes via the internal IP ( <code>--advertise-host</code> ).  The above <code>cockroach_01_private_ip</code> must be replaced with the real internal IP of the first server. <br><br><blockquote>  <b>Please note</b> that when the node starts, you can set it with a number of additional flags that change the behavior of the server (for example, the directory in which data is stored).  All these flags are described in the <a href="https://www.cockroachlabs.com/docs/start-a-node.html">official documentation</a> (in English). </blockquote><br>  Now that the node (and the cluster) has started working, you can view information about it through the Admin UI admin interface control panel built into CockroachDB for information about the cluster.  Visit <code>http://cockroach_01_public_ip:8080</code> (now public IP is used). <br><br>  The fact that the node has been successfully launched can be seen in the interface: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/128/4e4/aae/1284e4aaea0b484194d82b229da5f99e.png"></div><br>  A notification exclamation mark (!) In the <b>NODE</b> block when you hover the mouse cursor will give an explanation: the cluster has a low level of replication ( <b>Low Replication</b> ), because you do not have enough nodes.  With one node that is running now, the data will not be restored in the event of a fall <i>(see how many nodes are required for stable operation, see below, in clause 5)</i> . <br><br>  The situation will be corrected in the next stage, when we add two additional servers as two cluster nodes.  Having three nodes, CockroachDB guarantees the availability of three copies of all data, ensuring their recovery in the event of a drop in one of the nodes. <br><br><h2>  3. Adding the second and third nodes to the cluster </h2><br>  Run the <code>cockroach-02</code> command on the server <code>cockroach-02</code> in the same way as it was done for the first node in the previous step, but with the only difference.  In the parameters of the DBMS, we indicate that it is necessary to join the first node through the internal IP address.  In the command below, replace both variables with IP ( <code>cockroach_02_private_ip</code> and <code>cockroach_01_private_ip</code> ): <br><br><pre> <code class="bash hljs">$ cockroach start --insecure --background \ --advertise-host=cockroach_02_private_ip \ --join=cockroach_01_private_ip:26257</code> </pre><br>  Run the same command on the third server ( <code>cockroach-03</code> ), specifying its internal IP there.  Attach it to the first node too: <br><br><pre> <code class="bash hljs">$ cockroach start --insecure --background \ --advertise-host=cockroach_03_private_ip \ --join=cockroach_01_private_ip:26257</code> </pre><br>  Log into the administrative interface (Admin UI) of any node (for example, <code>http://cockroach_03_public_ip:8080</code> ) and make sure that the cluster now consists of 3 nodes: <br><br><img src="https://habrastorage.org/files/668/e4a/eb8/668e4aeb88904f5bb7970aca396090c7.png"><br><br>  All nodes are interconnected and have access to the same data. <br><br><h2>  4 (optional).  Demonstration of data transfer between nodes </h2><br>  Any data record in any node means their presence in all other nodes of the cluster.  The easiest way to demonstrate this is to use test data generation from CockroachDB and view the result using the embedded SQL client. <br><br>  On the first <code>cockroach-01</code> node, generate the data: <br><br><pre> <code class="bash hljs">$ cockroach gen example-data | cockroach sql</code> </pre> <br>  A database for <code>startrek</code> experiments will <code>startrek</code> .  Now you can run the SQL client and see the list of databases in the cluster: <br><br><pre> <code class="bash hljs">$ cockroach sql</code> </pre> <br><pre> <code class="sql hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">SHOW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASES</span></span>; +<span class="hljs-comment"><span class="hljs-comment">--------------------+ | Database | +--------------------+ | information_schema | | pg_catalog | | startrek | | system | +--------------------+</span></span></code> </pre><br><blockquote>  <b>Please note</b> that CockroachDB works with its own SQL dialect, which has SQL standard extensions that differ from those offered by other DBMSs. </blockquote><br>  On the second node <code>cockroach-02</code> you can run the same commands: <br><br><pre> <code class="bash hljs">$ cockroach sql</code> </pre> <br><pre> <code class="sql hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">SHOW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASES</span></span>;</code> </pre> <br>  It is easy to see that the data created on one node (the <code>startrek</code> database) is available on other nodes.  You can view the list of existing databases in the cluster on the Admin UI tab <b>DATABASES</b> tab on any of the nodes (for example, <code>http://cockroach_01_public_ip:8080/#/databases/</code> ). <br><br><h2>  5 (optional).  Removing a node from a cluster </h2><br>  CockroachDB guarantees data availability and integrity in the event of server failure.  The DBMS remains stable in the event of a failure of <code>(n-1)/2</code> nodes, where <code>n</code> is the total number of nodes in the cluster.  Thus, in our example with three nodes, it is possible for a single node to fall (without losing any data). <br><br>  To demonstrate this, remove one node from the cluster and see if the data is still available.  Then <i>(in clause 6), we</i> will rejoin the node to the cluster and make sure that it receives all the changes that occurred during its failure. <br><br>  On the second node of <code>cockroach-02</code> launch the SQL client and count the number of rows in the <code>quotes</code> table: <br><br><pre> <code class="bash hljs">$ cockroach sql</code> </pre> <br><pre> <code class="sql hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> startrek.quotes;</code> </pre> <br>  The answer will be <b>200</b> lines.  You can exit the SQL client by pressing &lt;Ctrl&gt; + &lt;c&gt;. <br><br>  Now remove this node from the cluster and make sure that the data remains on the other nodes.  To do this, on the <code>cockroach-02</code> node, complete the CockroachDB process with the command: <br><br><pre> <code class="bash hljs">$ cockroach quit</code> </pre> <br>  Go to another node (for example, <code>cockroach-03</code> ), run the SQL client and check the number of rows in the same table: <br><br><pre> <code class="bash hljs">$ cockroach sql</code> </pre> <br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> startrek.quotes;</code> </pre> <br>  The same <b>200</b> lines are available after disconnecting one of the nodes. <br><br><h2>  6 (optional).  Reattach node to cluster </h2><br>  Now we‚Äôll demonstrate the correct CockroachDB response to node availability.  To do this, we first delete part of the data, then return the disconnected node to the cluster, and then check that the data on it will be relevant. <br><br>  On one of the working nodes (for example, <code>cockroach-03</code> ) delete part of the data from the <code>quotes</code> table: <br><br><pre> <code class="sql hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> startrek.quotes <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> episode &gt; <span class="hljs-number"><span class="hljs-number">50</span></span>; &gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> startrek.quotes;</code> </pre><br>  <b>133</b> lines left.  Return to the node excluded from the cluster ( <code>cockroach-02</code> ), and run it again: <br><br><pre> <code class="bash hljs">$ cockroach start --insecure --background \ --advertise-host=cockroach_02_private_ip \ --join=cockroach_01_private_ip:26257</code> </pre><br>  Start the SQL client here and check the number of rows in the <code>quotes</code> table. <br><br><pre> <code class="bash hljs">$ cockroach sql &gt; SELECT COUNT(*) FROM startrek.quotes;</code> </pre><br>  The output should again show <b>133</b> .  Thus, the offline node received changes upon returning to the cluster. <br><br>  To remove all previously generated data, run in <code>cockroach sql</code> : <br><br><pre> <code class="sql hljs">&gt; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> quotes; &gt; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> episodes; &gt; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> startrek;</code> </pre><br><h2>  7 (optional).  Application connection </h2><br>  To use CockroachDB from within the application, you need: <br><br><ol><li>  driver supported by the application (CockroachDB works with drivers for PostgreSQL); </li><li>  connection string. </li></ol><br>  The following is a general example - your application may need other data. <br><br>  Select and install a driver from the PostgreSQL compliant client list for your application. <br><blockquote>  <b>Please note</b> that although CockroachDB supports the PostgreSQL protocol, the syntax of its SQL language is different and therefore this DBMS is not a ready-made replacement for PostgreSQL. </blockquote><br>  The connection string must point to port 26257 and the IP address of any of the nodes in the cluster.  Note that the firewall must allow connections to this port. <br><br>  For example, a connection in PHP / PDO for the <code>sammy</code> user to the <code>bank</code> database on the local machine ( <code>localhost</code> ) would look like this: <br><br><pre> <code class="php hljs">PDO(<span class="hljs-string"><span class="hljs-string">'pgsql:host=localhost;port=26257;dbname=bank;sslmode=disable'</span></span>, <span class="hljs-string"><span class="hljs-string">'sammy'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( PDO::ATTR_ERRMODE =&gt; PDO::ERRMODE_EXCEPTION, PDO::ATTR_EMULATE_PREPARES =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, ));</code> </pre><br>  Numerous examples of using PostgreSQL client drivers for different programming languages ‚Äã‚Äãare available in the <a href="https://www.cockroachlabs.com/docs/build-an-app-with-cockroachdb.html">CockroachDB documentation</a> . <br><br><h2>  Conclusion </h2><br>  The created cluster of three nodes helped to demonstrate the basic functions of the CockroachDB DBMS and the ability to connect an application to it. <br><br>  Since CockroachDB is actively developing, one day in your control panel you will see a message about the availability of a new version of the product ( <b>There is a newer version of CockroachDB available</b> ).  By the <b>Update</b> button, a link to the updated binary file will be available, download and installation of which currently requires manual intervention. <br><br>  For horizontal scaling of the DBMS installation, i.e.  adding new nodes, you need to repeat the steps that were performed for the second and third nodes: it is enough to install the <code>cockroach</code> executable file and run it with connection to the cluster. <br><br>  Before running CockroachDB in production, please <a href="https://www.cockroachlabs.com/docs/recommended-production-settings.html">review the recommended settings</a> .  The main link to the official product documentation (in English) is <a href="https://www.cockroachlabs.com/docs/">www.cockroachlabs.com/docs</a> . <br><br>  <i><b>Updated (May 11): The</b> final release of CockroachDB 1.0 has already taken <a href="https://www.nixp.ru/news/14024.html">place</a> .</i>  <i>In its <a href="https://www.cockroachlabs.com/blog/cockroachdb-1-0-release/">official announcement it is</a> stated that the DBMS is used in production by Baidu and Heroic Labs.</i> </div><p>Source: <a href="https://habr.com/ru/post/327640/">https://habr.com/ru/post/327640/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327624/index.html">MeteorJS, Nginx, mongodb, iptables ... production</a></li>
<li><a href="../327628/index.html">Automated generation of circuit components from PDF files for Altium Designer</a></li>
<li><a href="../327630/index.html">Tmux Cheat Sheet (Terminal Multiplexer)</a></li>
<li><a href="../327636/index.html">Introduction to cryptography and encryption, part two. Lecture in Yandex</a></li>
<li><a href="../327638/index.html">Nodejs MVC framework or regular bike</a></li>
<li><a href="../327642/index.html">How laser roulette works: reverse engineering</a></li>
<li><a href="../327644/index.html">SVG support and CompactOverlay mode in UWP applications</a></li>
<li><a href="../327646/index.html">First time (sketches from one workshop)</a></li>
<li><a href="../327648/index.html">How Do I Apply?</a></li>
<li><a href="../327656/index.html">The digest of interesting materials for the mobile developer # 201 (April 24 - 30)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>