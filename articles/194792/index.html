<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As I site on powershell parsil</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 First of all I want to note, I am not a programmer. I'm admin bye. Of course, I would like to be called an architect, but in the foreseeabl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As I site on powershell parsil</h1><div class="post__text post__text-html js-mediator-article"><h4>  Foreword </h4><br>  First of all I want to note, I am not a programmer.  I'm admin bye.  Of course, I would like to be called an architect, but in the foreseeable space there are suitable vacancies, with adequate requirements and, most importantly, no salaries for these requirements.  It's a pity. <br>  As a matter of fact, within the framework of this note I want to tell about the useful pluses of the new Powershell version.  In particular, about the possibility of quickly and confidently parsing web pages and doing it ‚Äúin parallel‚Äù. <br><a name="habracut"></a><br><h4>  Task </h4><br>  So, the task that stood before me was pretty simple.  There is a certain site, if you go through the initial form, on which you need to select the starting and ending date, we get on this page: <br><br><img src="https://habrastorage.org/storage3/fad/e01/295/fade0129560bb50eb7187c5ad637e81c.png" alt="image"><br><br>  The number of such pages can be large within one period of dates.  But no more than 999. That is, if for example, you need to select data for 5 years, then they will not fit into 999 pages.  This page is a directory, I was only interested in the data to which it leads by the link in the Permit NO column: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage3/057/9dc/95c/0579dc95cd36be2a569e8a20f6a89afb.png" alt="image"><br><br>  In general, since I am not a programmer, my knowledge was not enough to take advantage of the possibilities of C # or something like that.  In general, my favorite tool - powershell helped here. <br><br><h4>  Decision </h4><br>  I decided to go in two stages.  First, unload and parse the directory with links, and then go through the directory to select the documents to which it refers.  Primitive task for the programmer.  It took me around 16 hours.  True, given the fact that I did this using new commands for me, not only with the goal of solving the problem, but also with the goal of learning new commands and powershell 3 chips for me, which at that moment had just been released. <br>  I was lucky that the site took the parameters directly in the URL bar, like this: <br><br><pre>  http: // [skip] / [skip]? allcount = $ allcount &amp; allstartdate_month = $ allstartdate_month [skip] </pre><br>  because how to work with HTML forms, I can not.  So I decided to just request the necessary pages, changing the parameters of the request.  For this, I used the Invoke-WebRequest cmdlet.  It allows you to send a request in the simplest form and get the result without using the .NET classes directly or using the COM objects of IE.  The result is a parsed HTML document that can be further parsed. <br>  In addition, a feature of this page was the fact that it was returned not only with the HTML code of the table, but also with such parsed contents of this table itself. <br><br><img src="https://habrastorage.org/storage3/535/a40/716/535a40716ebb32a544b42fa05e21f1c4.png" alt="image"><br><br><h6>  First half parsing </h6><br>  In this part, I chose just a directory.  The main problem at this stage is to go through all the pages that were returned by the system and determine the last one.  For this, I decided to check whether there is a Next button on the page, or it does not exist. <br>  In addition, at the output of this part, I wanted to get a flat csv file containing the actual directory.  And at the end pass this file to the next stage.  For this was born the code below.  It simply selects all root labels for the date range, parses the contents of the page with regular expressions, using the above feature, and returns an object that contains all of the specified information. <br><br><pre><code class="cs hljs">function Get-AppList { [CmdletBinding()] param( [datetime] $startDate = <span class="hljs-string"><span class="hljs-string">'01.01.2012'</span></span>, [datetime] $endDate = <span class="hljs-string"><span class="hljs-string">'01.01.2012'</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>] $allpermittype = <span class="hljs-string"><span class="hljs-string">"SG"</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>] $allcount = <span class="hljs-string"><span class="hljs-string">"0000"</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>] $requestid= <span class="hljs-string"><span class="hljs-string">"1"</span></span> ) begin{ [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>] $allstartdate_month = <span class="hljs-string"><span class="hljs-string">"{0:d2}"</span></span> -f $startDate.Month [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>] $allstartdate_day= <span class="hljs-string"><span class="hljs-string">"{0:d2}"</span></span> -f $startDate.Day [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>] $allstartdate_year= $startDate.Year [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>] $allenddate_month = <span class="hljs-string"><span class="hljs-string">"{0:d2}"</span></span> -f $endDate.Month [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>] $allenddate_day = <span class="hljs-string"><span class="hljs-string">"{0:d2}"</span></span> -f $endDate.Day [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>] $allenddate_year = $endDate.Year $fields = @{Regex=<span class="hljs-string"><span class="hljs-string">"\[0:PtAppFirstName\]\{(?&lt;PtAppFirstName&gt;.+)\}"</span></span>;Column=<span class="hljs-string"><span class="hljs-string">"PtAppFirstName"</span></span>}, @{Regex=<span class="hljs-string"><span class="hljs-string">"\[1:PtAppLastName\]\{(?&lt;PtAppLastName&gt;.+)\}"</span></span>;Column=<span class="hljs-string"><span class="hljs-string">"PtAppLastName"</span></span>}, @{Regex=<span class="hljs-string"><span class="hljs-string">"\[2:PtAppMI\]\{(?&lt;PtAppMI&gt;.+)\}"</span></span>;Column=<span class="hljs-string"><span class="hljs-string">"PtAppMI"</span></span>}, @{Regex=<span class="hljs-string"><span class="hljs-string">"\[3:PtJobNum\]\{(?&lt;PtJobNum&gt;.+)\}"</span></span>;Column=<span class="hljs-string"><span class="hljs-string">"PtJobNum"</span></span>}, @{Regex=<span class="hljs-string"><span class="hljs-string">"\[4:PtJobDocNum\]\{(?&lt;PtJobDocNum&gt;.+)\}"</span></span>;Column=<span class="hljs-string"><span class="hljs-string">"PtJobDocNum"</span></span>}, @{Regex=<span class="hljs-string"><span class="hljs-string">"\[5:PtJobType\]\{(?&lt;PtJobType&gt;.+)\}"</span></span>;Column=<span class="hljs-string"><span class="hljs-string">"PtJobType"</span></span>}, @{Regex=<span class="hljs-string"><span class="hljs-string">"\[6:PtPermitType\]\{(?&lt;PtPermitType&gt;.+)\}"</span></span>;Column=<span class="hljs-string"><span class="hljs-string">"PtPermitType"</span></span>}, @{Regex=<span class="hljs-string"><span class="hljs-string">"\[7:PtPermitSubtype\]\{(?&lt;PtPermitSubtype&gt;.+)\}"</span></span>;Column=<span class="hljs-string"><span class="hljs-string">"PtPermitSubtype"</span></span>}, @{Regex=<span class="hljs-string"><span class="hljs-string">"\[8:PtPermitSeqNum\]\{(?&lt;PtPermitSeqNum&gt;.+)\}"</span></span>;Column=<span class="hljs-string"><span class="hljs-string">"PtPermitSeqNum"</span></span>}, @{Regex=<span class="hljs-string"><span class="hljs-string">"\[9:PtIssuanceDate\]\{(?&lt;PtIssuanceDate&gt;.+)\}"</span></span>;Column=<span class="hljs-string"><span class="hljs-string">"PtIssuanceDate"</span></span>}, @{Regex=<span class="hljs-string"><span class="hljs-string">"\[10:PtFilingDate\]\{(?&lt;PtFilingDate&gt;.+)\}"</span></span>;Column=<span class="hljs-string"><span class="hljs-string">"PtFilingDate"</span></span>}, @{Regex=<span class="hljs-string"><span class="hljs-string">"\[11:PtExpirationDate\]\{(?&lt;PtExpirationDate&gt;.+)\}"</span></span>;Column=<span class="hljs-string"><span class="hljs-string">"PtExpirationDate"</span></span>}, @{Regex=<span class="hljs-string"><span class="hljs-string">"\[12:PtBin\]\{(?&lt;PtBin&gt;.+)\}"</span></span>;Column=<span class="hljs-string"><span class="hljs-string">"PtBin"</span></span>}, @{Regex=<span class="hljs-string"><span class="hljs-string">"\[13:JHouseNumber\]\{(?&lt;JHouseNumber&gt;.+)\}"</span></span>;Column=<span class="hljs-string"><span class="hljs-string">"JHouseNumber"</span></span>}, @{Regex=<span class="hljs-string"><span class="hljs-string">"\[14:JStreetName\]\{(?&lt;JStreetName&gt;.+)\}"</span></span>;Column=<span class="hljs-string"><span class="hljs-string">"JStreetName"</span></span>}, @{Regex=<span class="hljs-string"><span class="hljs-string">"\[15:PermitIsn\]\{(?&lt;PermitIsn&gt;.+)\}"</span></span>;Column=<span class="hljs-string"><span class="hljs-string">"PermitIsn"</span></span>} $uri = <span class="hljs-string"><span class="hljs-string">"http://[skip]/bisweb/[skip]?allcount=$allcount&amp;allstartdate_month=$allstartdate_month&amp;allstartdate_day=$allstartdate_day&amp;allstartdate_year=$allstartdate_year&amp;allenddate_month=$allenddate_month&amp;allenddate_day=$allenddate_day&amp;allenddate_year=$allenddate_year&amp;allpermittype=$allpermittype&amp;go13=+GO+&amp;requestid=0&amp;navflag=T&amp;requestid=$requestid"</span></span> } process{ <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-meta"><span class="hljs-meta">#   .   $a = Invoke-WebRequest -Uri $uri -SessionVariable sv $s = $a.ParsedHtml.childNodes| % data $s2 = ($s[3] -split "\[\d+\]") $obj = @{} $s2 | % { $item = $_ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($item) { $fields | % { $res = $item -match $_.regex </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($res) { $obj[$_.Column] = $matches[$_.Column] } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { $obj[$_.Column]= $null } } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (($obj.PtPermitType -ne $null) -and ($obj.PtPermitType -ne " ")) { new-object psobject -Property $obj } } } # ,    .     $form = $a.Forms | where id -EQ "frmnext" </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($form) { $allstartdate_month=$form.Fields["allstartdate_month"] $allstartdate_day=$form.Fields["allstartdate_day"] $allstartdate_year=$form.Fields["allstartdate_year"] $allenddate_month = $form.Fields["allenddate_month"] $allenddate_day = $form.Fields["allenddate_day"] $allenddate_year = $form.Fields["allenddate_year"] $allpermittype = $form.Fields["allpermittype"] $allcount = $form.Fields["allcount"] $requestid = $form.Fields["requestid"] $uri = "http://[skip]/skip?allcount=$allcount&amp;allstartdate_month=$allstartdate_month&amp;allstartdate_day=$allstartdate_day&amp;allstartdate_year=$allstartdate_year&amp;allenddate_month=$allenddate_month&amp;allenddate_day=$allenddate_day&amp;allenddate_year=$allenddate_year&amp;allpermittype=$allpermittype&amp;go13=+GO+&amp;requestid=0&amp;navflag=T&amp;requestid=$requestid" } } while ($form) } }</span></span></code> </pre> <br><h6>  Parsing second half </h6><br>  In the second part, another problem arose.  The number of pages that had to be requested became a little larger.  Once in 30. Because, the search of the results of the first stage and the selection of pages one by one took a lot of time.  That's why I decided to use another powershell v3 chip - powershell workflow.  Well, rather, to say the <b>foreach ‚Äìparallel</b> operator.  In fact, workflows are designed for something completely different, but in this case it‚Äôs already gone.  I‚Äôll say right away that this is not a tool for paralleling tasks in order to increase productivity, so you shouldn‚Äôt expect this from it.  So, in this case, the idea was to take advantage of this opportunity to run queries for each line of the directory "in parallel".  In fact, this command starts a separate process, and their number is limited.  I did not ask myself whether it is possible to change their maximum number.  This mechanism allows you to simply simplify the code to get "parallelism".  In quotes, not because they are not parallel.  They are parallel, just run not in light streams but in heavy processes within the .NET Workflow and are forced to transfer results across process boundaries.  Therefore, it is not too productive, but, ‚Äúas our favorite chef says, cheap is convenient and practical,‚Äù and the most important thing for the admin is just 2 lines of code.  Losing a few seconds in a separate task does not play a role relative to the task as a whole.  In general, a good thing. <br>  The code came out like this. <br><br><pre> <code class="cs hljs">workflow Get-AppDetails2 ($list) { $webList = @() <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> -parallel ($i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $list){ $PermitIsn = $i.PermitIsn $queryUri = <span class="hljs-string"><span class="hljs-string">"http://[skip]/bisweb/[skip]?allisn=$PermitIsn&amp;allbin=&amp;requestid=1"</span></span> Invoke-WebRequest -Uri $queryUri } }</code> </pre><br><h4>  findings </h4><br>  In general, all this proves that powershell is a powerful and useful thing, suitable for all important and useful things. </div><p>Source: <a href="https://habr.com/ru/post/194792/">https://habr.com/ru/post/194792/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../194778/index.html">How changes in US Internet law can make life difficult for Russian game developers and game platform operators</a></li>
<li><a href="../194782/index.html">Making a simple cursor in a window of Warcraft 3</a></li>
<li><a href="../194784/index.html">We generate custom markers for Google Maps v3</a></li>
<li><a href="../194786/index.html">The rules of a "good" IT company</a></li>
<li><a href="../194790/index.html">Economic globalization or how IT is made today</a></li>
<li><a href="../194794/index.html">Student Magazine</a></li>
<li><a href="../194798/index.html">Taxonomy of creative expression</a></li>
<li><a href="../194800/index.html">Uploading data to Sharepoint lists</a></li>
<li><a href="../194802/index.html">How to speed up the development of your project with COLT?</a></li>
<li><a href="../194804/index.html">City Electronic Libraries</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>