<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Extend ReSharper - Context Actions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the comments to one of the previous posts, I promised to tell you how to write extensions to Resharper. I want to tell because I myself periodicall...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Extend ReSharper - Context Actions</h1><div class="post__text post__text-html js-mediator-article"><img src="http://visualstudiogallery.msdn.microsoft.com/it-it/EA4AC039-1B5C-4D11-804E-9BEDE2E63ECF/image/file/5347" align="right">  In the comments to one of the previous posts, I promised to tell you how to write extensions to Resharper.  I want to tell because I myself periodically write extensions that simplify the work in my particular area.  Here I will briefly show my approach to writing extensions of the context action type. <br><br><a name="habracut"></a><br>  So, context action is the menu that appears on the left with the arrow, which allows for ‚Äúquick correction‚Äù in the code.  If you want to prevent opening this menu, by the way, the command is called <code>ReSharper.QuickFix</code> .  I am writing additional options for this menu.  Why?  Because it sometimes saves time.  Let's take a look at how to write context action for Resharper. <br><br><img src="http://nesteruk.org/pix/17/hd0.jpg" alt="Creating plug-in &amp; rsquo; a and debugging" width="329" height="18"><br>  Resharper extensions are the usual class libraries (DLLs) that are placed in the <code>Plugins</code> folder in the resharper <code>bin</code> folder.  For debugging, there is no need to copy them there - you can simply specify the name and the path to the plugin as the arguments of the studio itself ( <code>devenv.exe</code> ).  The syntax is something like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote>  devenv.exe /ReSharper.Plugin c: \ path \ to \ your.dll <br></blockquote><br>  If you do not write anything, but start debugging on F5, your plug-in will already appear in the list of resolver plugins.  Of course it is better to add some content than we do now. <br><br><img src="http://nesteruk.org/pix/17/hd1.jpg" alt="We start to do context action" width="262" height="17"><br>  The first thing to do is to add links to the resharper builds that we need.  I stupidly add links to <em>all</em> assemblies in which the name <code>ReSharper</code> appears, because  I have no idea what might be needed. <br><br>  Context actions are made by inheriting from <code>CSharpContextActionBase</code> (in the case of C #), as well as implementing several other interfaces.  Fortunately, part of the "plumbing" implemented the developers of other plug-ins.  For context <code>ContextActionBase</code> , I add the <code>ContextActionBase</code> class to my project, which was written by the authors of the <a href="http://code.google.com/p/agentjohnsonplugin/">Agent Johnson</a> plugin.  Actually the file itself can be found <a href="">here</a> . <br><br>  Now, to create a CA, you need to do two things: <br><br><ul><li>  Inherit your CA from <code>ContextActionBase</code> <br></li><li>  Decorate the resulting class attribute ContextActionAttribute <br></li></ul><br><br><img src="http://nesteruk.org/pix/17/hd2.jpg" alt="Interface of our SA" width="174" height="18"><br>  To make it work, you need to add only 4 methods to the resulting class: <br><br><ul><li>  The default constructor.  There is basically nothing to do here. <br></li><li>  <code>GetText()</code> method.  This method returns in the string what will be written for your command in the CA drop-down menu. <br></li><li>  The <code>IsAvailable(IElement)</code> method.  Determines whether your CA is applicable at a given code point or not.  <code>IElement</code> is your link to the code point where the cursor is.  From this point of the code, you can bypass even the entire tree of the file. <br></li><li>  <code>Execute(IElement)</code> method.  If the user has clicked on your SA, then you can apply it.  We again have a link to <code>IElement</code> , i.e.  we can walk along the code and choose what to change and where. <br></li></ul><br><img src="http://nesteruk.org/pix/0/4ec0afd1-11a0-42bf-aa50-e53873527c4c.jpg" align="right">  Let's take a simple example.  Imagine that you need to implement a functional that quickly <code>Math.Pow()</code> calls with integer values.  This is necessary because <br><br><ul><li>  <code>Math.Pow(x, 2.0)</code> ‚Üê it is bad and slow <br></li><li>  <code>x*x</code> ‚Üê much faster <br></li></ul><br>  So, let's try to make the implementation of this mini-refactoring step by step. <br><br><img src="http://nesteruk.org/pix/17/hd3.jpg" alt="Frame" width="58" height="18"><br>  To begin with, we make our SA class, decorate it with a small set of metadata.  The <code>text</code> field has been added so that we can directly prompt the user in the CA menu what will happen to his code after refactoring. <br><br><br><br> <code><img src="http://nesteruk.org/pix/17/ff101.jpg" align="right"> <font color="black">[ContextAction(Group = <font color="#570000">"C#"</font> , Name = <font color="#570000">"Inline a power function"</font> , <br> Description = <font color="#570000">"Inlines a power statement; eg, changes Math.Pow(x, 3) to x*x*x."</font> , <br> Priority = 15)] <br> <font color="#0000FF">internal</font> <font color="#0000FF">class</font> InlinePowerAction : ContextActionBase <br> { <br> <font color="#0000FF">private</font> <font color="#0000FF">string</font> text; <br> <font color="#0000FF">public</font> InlinePowerAction(ICSharpContextActionDataProvider provider) : <font color="#0000FF">base</font> (provider) <br> { <br> <font color="#006400">//  </font> <br> } <br> ‚ãÆ <br> } <br></font></code> <br>  The frame is ready.  Now we need to learn to determine whether our CA is applicable. <br><br><img src="http://nesteruk.org/pix/17/hd4.jpg" alt="IsAvailable ()" width="106" height="19"><br>  Our SA is applicable only if we are sitting in the body of <code>Math.Pow()</code> and this body has an integer degree - for example, 3.0.  How to do it?  First we find the place where the user has the cursor.  Then, we get those nodes of the syntax tree, which stand in the same place as the cursor, and try to bring them to the expected types.  Since <code>Math.Pow()</code> is a function call, we expect to see a <code>IInvocationExpression</code> with <code>IInvocationExpression</code> in its body.  And so on, in a chain, and we always use the <code>as</code> operator in case that the expression is not what we expect. <br><br>  At the end of the whole chain, we find and check the value of the exponent.  If it is integer and between 1 and 10 - SA is applicable, return <code>true</code> .  In all other cases, return <code>false</code> . <br><br>  An example code is shown below.  It is better not to read it and walk on it debugger.  This refers to working with ReSharper entirely - the best way to learn more about the structure of the syntax tree is through the debugger. <br><br><br><br> <code><img src="http://nesteruk.org/pix/17/ff102.jpg" align="right"> <font color="black"><font color="#0000FF">protected</font> <font color="#0000FF">override</font> <font color="#0000FF">bool</font> IsAvailable(JetBrains.ReSharper.Psi.Tree.IElement element) <br> { <br> <font color="#0000FF">using</font> (ReadLockCookie.Create()) <br> { <br> IInvocationExpression invEx = GetSelectedElement&lt;IInvocationExpression&gt;( <font color="#0000FF">false</font> ); <br> <font color="#0000FF">if</font> (invEx != <font color="#0000FF">null</font> &amp;&amp; invEx.InvokedExpression.GetText() == <font color="#570000">"Math.Pow"</font> ) <br> { <br> IArgumentListNode node = invEx.ToTreeNode().ArgumentList; <br> <font color="#0000FF">if</font> (node != <font color="#0000FF">null</font> &amp;&amp; node.Arguments.Count == 2) <br> { <br> ILiteralExpression <font color="#0000FF">value</font> = node.Arguments[1].Value <font color="#0000FF">as</font> ILiteralExpression; <br> <font color="#0000FF">if</font> ( <font color="#0000FF">value</font> != <font color="#0000FF">null</font> ) <br> { <br> <font color="#0000FF">float</font> n; <br> <font color="#0000FF">if</font> ( <font color="#0000FF">float</font> .TryParse( <font color="#0000FF">value</font> .GetText().Replace( <font color="#570000">"f"</font> , <font color="#0000FF">string</font> .Empty), <font color="#0000FF">out</font> n) &amp;&amp; <br> (n - Math.Floor(n) == 0 &amp;&amp; n &gt;= 1 &amp;&amp; n &lt;= 10)) <br> { <br> text = <font color="#570000">"Replace with "</font> + (n-1) + <font color="#570000">" multiplications"</font> ; <br> <font color="#0000FF">return</font> <font color="#0000FF">true</font> ; <br> } <br> } <br> } <br> } <br> } <br> <font color="#0000FF">return</font> <font color="#0000FF">false</font> ; <br> } <br></font></code> <br>  See how I set the value of the <code>text</code> variable before returning <code>true</code> ?  This is to make the CA better read by the user.  Yes, and as for <code>ReadLockCookie</code> in which the code is wrapped - this is an element of Resharper's internal semantics.  I have no idea what he is doing - just copying him from the examples so, just in case.  After all, there is no detailed, updated documentation on writing plugins for Resharper. <br><br><img src="http://nesteruk.org/pix/17/hd5.jpg" alt="GetText ()" width="77" height="19"><br>  If we return <code>true</code> from <code>IsAvailable()</code> , Resharper will want to know which text to draw in the menu.  In this case, we already know what to return - the content of the <code>text</code> variable. <br><br> <code><img src="http://nesteruk.org/pix/17/ff103.jpg" align="right"> <font color="black"><font color="#0000FF">protected</font> <font color="#0000FF">override</font> <font color="#0000FF">string</font> GetText() <br> { <br> <font color="#0000FF">return</font> text; <br> } <br></font></code> <br>  Oh, if everything was so simple ... <br><br><img src="http://nesteruk.org/pix/17/hd6.jpg" alt="Execute ()" width="77" height="19"><br>  The user has the opportunity to use the CA for its intended purpose.  If he clicked on it in the menu, the <code>Execute()</code> method is called.  And here our replacement algorithm is just starting to work.  Remember - we want to change, say, <code>Math.Pow(x, 3.0)</code> to <code>x*x*x</code> .  How to do it? <br><br>  We again need a tree node that contains <code>Math.Pow()</code> .  We pull out both parameters (in the example above, <code>x</code> and 3), gently converting the values ‚Äã‚Äãeven if it is written, for example, not 3.0 but 3.0f.  Next, we determine how long the expression is to the left - because if we raise to the power of <code>x</code> , then we can write <code>x*x*x</code> , but if <code>x+y</code> we will have to write with brackets <code>(x+y)*(x+y)*(x+y)</code>  To do this, we interrupt the type, and if it is <code>ILiteralExpression</code> or <code>IReferenceExpression</code> then hooray is the expression ‚Äúshort‚Äù. <br><br>  After receiving the expression and the integer power, we use <code>StringBuilder</code> to make a string for replacement.  But then interesting things happen. <br><br>  First, we create an object of type <code>ICSharpExpression</code> , which allows us to create a node from our string that can replace the <code>Math.Pow</code> node.  The following expression does just that - with <code>LowLevelModificationUtil</code> we replace one node with another. <br><br> <code><img src="http://nesteruk.org/pix/17/ff104.jpg" align="right"> <font color="black"><font color="#0000FF">protected</font> <font color="#0000FF">override</font> <font color="#0000FF">void</font> Execute(JetBrains.ReSharper.Psi.Tree.IElement element) <br> { <br> IInvocationExpression expression = GetSelectedElement&lt;IInvocationExpression&gt;( <font color="#0000FF">false</font> ); <br> <font color="#0000FF">if</font> (expression != <font color="#0000FF">null</font> ) <br> { <br> IInvocationExpressionNode node = expression.ToTreeNode(); <br> <font color="#0000FF">if</font> (node != <font color="#0000FF">null</font> ) <br> { <br> IArgumentListNode args = node.ArgumentList; <br> <font color="#0000FF">int</font> count = ( <font color="#0000FF">int</font> ) <font color="#0000FF">double</font> .Parse(args.Arguments[1].Value.GetText().Replace( <font color="#570000">"f"</font> , <font color="#0000FF">string</font> .Empty)); <br> <font color="#0000FF">bool</font> isShort = node.Arguments[0].Value <font color="#0000FF">is</font> ILiteralExpression || <br> node.Arguments[0].Value <font color="#0000FF">is</font> IReferenceExpression; <br> <font color="#0000FF">var</font> sb = <font color="#0000FF">new</font> StringBuilder(); <br> sb.Append( <font color="#570000">"("</font> ); <br> <font color="#0000FF">for</font> ( <font color="#0000FF">int</font> i = 0; i &lt; count; ++i) <br> { <br> <font color="#0000FF">if</font> (!isShort) sb.Append( <font color="#570000">"("</font> ); <br> sb.Append(args.Arguments[0].GetText()); <br> <font color="#0000FF">if</font> (!isShort) sb.Append( <font color="#570000">")"</font> ); <br> <font color="#0000FF">if</font> (i + 1 != count) <br> sb.Append( <font color="#570000">"*"</font> ); <br> } <br> sb.Append( <font color="#570000">")"</font> ); <br> <font color="#006400">// now replace everything</font> <br> ICSharpExpression newExp = Provider.ElementFactory.CreateExpression( <br> sb.ToString(), <font color="#0000FF">new</font> <font color="#0000FF">object</font> [] { }); <br> <font color="#0000FF">if</font> (newExp != <font color="#0000FF">null</font> ) <br> { <br> LowLevelModificationUtil.ReplaceChildRange( <br> expression.ToTreeNode(), <br> expression.ToTreeNode(), <br> <font color="#0000FF">new</font> [] { newExp.ToTreeNode() }); <br> } <br> } <br> } <br> } <br></font></code> <br>  That's all.  Everything is working.  Full SA can be downloaded <a href="http://pastebin.com/f4171b51d">here</a> .  I remind you that the base class <code>ContextActionBase</code> is <a href="">here</a> .  This example was tested on version 4.5 of Resharper, I don‚Äôt know anything about version 5 :) <br><br><img src="http://nesteruk.org/pix/17/hd7.jpg" alt="Conclusion" width="102" height="15"><br>  I know that the example is complicated.  Traversing the syntax tree is not an easy task.  I suffer <em>with almost every</em> SA that I write.  Debagger in this regard helps a lot, of course, but if you write complex actions, I advise you to jot down a simple DSL on the same F #, for example, because searching the tree in C # looks untidy, with all these type conversions, <code>null</code> checks and so on.  Good luck!  ‚ñ† <img src="http://nesteruk.org/projects/vc/default.aspx"></div><p>Source: <a href="https://habr.com/ru/post/74026/">https://habr.com/ru/post/74026/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../74018/index.html">Version 1.1 beta</a></li>
<li><a href="../74021/index.html">DJing at Ableton Live. Part 2. Deratization</a></li>
<li><a href="../74022/index.html">4 days left before the start of the new MacHeist</a></li>
<li><a href="../74023/index.html">Users and data compression</a></li>
<li><a href="../74025/index.html">Cooking plugin for qutIM at home</a></li>
<li><a href="../74027/index.html">How I built my data center - part one, preparatory</a></li>
<li><a href="../74028/index.html">Linkchka open!</a></li>
<li><a href="../74029/index.html">Experience upgrade XP to Windows7</a></li>
<li><a href="../74030/index.html">Wefi - Wi-Fi hotspots around the world</a></li>
<li><a href="../74031/index.html">SilverX - convert flash to silverlight projects</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>