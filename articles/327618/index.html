<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recovering files after a Trojan cryptographer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the end of the working day, the accountant of one of the enterprises received an e-mail from the counterparty, which was constantly in business cor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recovering files after a Trojan cryptographer</h1><div class="post__text post__text-html js-mediator-article">  At the end of the working day, the accountant of one of the enterprises received an e-mail from the counterparty, which was constantly in business correspondence, a letter containing an attached file, referred to as ‚ÄúAct of reconciliation.xls‚Äù.  When trying to open visually nothing happened from the point of view of an accountant.  Repeating the opening attempt several times, the accountant made sure that excel is not going to open the file sent.  Having unsubscribed to the counterparty about the impossibility to open the file received by her, the accountant, pressed the <abbr title="Personal Computer">PC</abbr> shutdown button, and, without waiting for the PC to finish working, left the workplace.  Coming in the morning, I found that the computer had not turned off.  Without giving it much importance, I tried to start a new working day, habitually clicking on the 1C Account label, but after selecting the base I expected an unpleasant surprise. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/734/e4b/331/734e4b3311fb492b8b705be6843a305a.jpg"></div><br>  rice  one <br><br>  Subsequent attempts to start a working environment 1C also failed.  The accountant contacted the company servicing the computing equipment of their organization and requested technical support.  Specialists of the service organization found out that the problems are much more extensive, since, apart from the fact that the 1C Accounting 7.7 database files were encrypted and had the extension ‚ÄúBLOCKED‚Äù, the files with the doc, docx, xls, xlsx, zip, rar, 1cd and others.  A text file was also found on the user's desktop, which reported that the files were encrypted using the RSA 2048 algorithm, and that it was necessary to pay for the ransomware services to get the decoder.  Backup 1C databases was carried out daily to another hard disk installed in the same PC in the form of creating a zip archive with a folder of 1C databases, and a copy of the archive was placed on a network drive ( <abbr title="Network attached storage">NAS</abbr> ).  Since there were no restrictions on access to backups, the malicious software had access to them. <br><a name="habracut"></a><br>  Having assessed the scale of the problem, the service organization specialists copied only the encrypted files to a separate drive and reinstalled the operating system.  Also, emails containing malware have been removed from the accountant‚Äôs mailbox.  Attempts to decrypt using popular anti-virus company decoders at that time did not produce a result.  At this service organization the company has completed its work. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Prospects to start with the input of primary documents in the new 1C database, accountants are not very pleased.  Therefore, further possibilities of recovering encrypted files were considered. <br><br>  Unfortunately, the original malware body and the message of the extortioner were not saved, which did not allow disassembling the body and establishing the algorithm of its operation through analysis in the debugger.  It was also not possible to check whether he met various antivirus companies. <br><br>  Therefore, immediately proceed to the analysis of files whose structures are well known.  In this case, it is convenient to use for analyzing DBF files from the 1C database, since their structure is very predictable.  Take the file 1SENTRY.DBF.BLOCKED (journal of accounting entries), the size of this file is 53,044,658 bytes <br><br><img src="https://habrastorage.org/files/a8c/7de/059/a8c7de0595b240aeaafe99da29e1727d.png"><br>  rice  2 <br><br>  Considering the encrypted DBF file, we draw attention to the fact that the first 0x35 bytes are not encrypted, since there is a header specific to this type of files, and we observe part of the description of the first field of the record.  Let's calculate the file size.  To do this, take: WORD at offset 0x08, the content of which is 0x04C1 (it contains the size of the DBF file header), WORD at offset 0x0A, the content of which is 0x0130 (it contains the size of one record in the database), DWORD at offset 0x04, the contents of which is 0x0002A995 (the number of records), and 0x01 is the size of the final marker.  Let's solve an example: 0x0130 * 0x0002A995 + 0x04C1 + 1 = 0x0032965B2 (53 044 658) bytes.  The file size, according to the file system record, corresponds to the calculated one based on the information in the DBF file header.  Perform similar checks for several DBF files and make sure that the file size has not been changed by malware. <br><br>  Analyzing the contents of DBF shows that small files starting at offset 0x35 are encrypted in their entirety, but large files are not. <br><br><img src="https://habrastorage.org/files/950/f48/4a8/950f484a828e48ad81a0d1885bdea7a2.png"><br>  rice  3 <br><br>  <i>Account numbers, dates and amounts are changed so as not to violate confidentiality agreements, including in the encrypted area.</i> <br><br>  Starting at offset 0x00132CB5, we detect the absence of signs of encryption to the end of the file, by performing checks in other large files, we confirm the assumption that only files less than 0x00132CB5 (1,256,629) bytes are completely encrypted.  Many malware authors perform partial file encryption to reduce the time it takes to distort user data.  They are probably guided by the fact that their malicious code in the shortest time causes the greatest possible damage to the user. <br><br>  Let's start analyzing the encryption algorithm <br><br><img src="https://habrastorage.org/files/504/039/8cd/5040398cdfb2467ca15de2f88ebc7095.png"><br>  rice  four <br><br>  In fig.  4 in place of the DBF file header field there are almost identical sequences of 16 bytes (offset 0x50, 0x70, 0x90), we also see partial repetition of sequences of 16 bytes (offset 0x40.0x60.0x80), in which there are differences only in bytes, where register the field name and field type. <br><br>  Based on this observation, having a small understanding of the algorithms for the operation of cryptographic algorithms like <abbr title="Advanced Encryption Standard">AES</abbr> , <abbr title="Rivest, Shamir and Adleman">RSA</abbr> , one can make an unequivocal conclusion that the data is not encrypted using these algorithms.  That is, information about the encryption algorithm submitted by the customer is unreliable.  Inaccurate, it may be due to some erroneous conclusions of the customer, or be the result of the malware fraud by the author.  We cannot verify this, since only encrypted files are available to us. <br><br>  Based on the structure of the DBF file headers and changes in bytes in the sequences, it can be assumed that encryption was performed using XOR operations on data with a certain pattern.  You can also make an assumption, based on the length of the repeating sequences, that the pattern length is 16 bytes (128 bits).  The base header is 0x04C1 bytes, the size of the description of one field in the header is 0x20 (32) bytes.  From this it follows that the header of this DBF file contains (0x4C1-0x21) / 0x20 = 0x25 (37) field descriptions.  In fig.  4 underlined in red fragments of records of two fields starting at offset 0x10, which in case of 1C usually have zero values, except for 0x10 itself (since the offset indicates the size of the field), based on this, we can assume that we already have 15 of 16 bytes of the key encryption 0x97 0x99 0xE6 0xBF 0x4B 0x6C 0x77 0x76 0x3A 0x80 0x0B <b>0xXX</b> 0xAF 0x45 0x6A 0xB7. <br><br>  To find the last byte in the key, take another fragment of the same DBF file. <br><br><img src="https://habrastorage.org/files/efc/6cf/842/efc6cf842e224e659b1c2612c86673f4.png"><br>  rice  five <br><br>  In Figure 5, we draw attention to the zero column, more precisely to its unencrypted part, and we see that the value 0x20 prevails there (space code according to the ASCII table).  Accordingly, some identical value will prevail in the encrypted part of the column.  It is easy to notice that this is 0xFA.  To obtain the original value of the missing key byte, you must perform 0xFA xor 0x20 = 0xDA. <br><br>  Substituting the obtained value on the missing position, we get the full key 0x97 0x99 0xE6 0xBF 0x4B 0x6C 0x77 0x76 0x3A 0x80 0x0B 0xDA 0xAF 0x45 0x6A 0xB7. <br><br>  After performing the xor procedure, operations with the received key on encrypted sections received the original contents of the file. <br><br><img src="https://habrastorage.org/files/208/6f0/4e4/2086f04e48f448658abda56c241c4e90.png"><br>  rice  6 <br><br>  For the final control, we will perform a zip archive decryption operation, then unpack the archive.  If all files were extracted and there was no <abbr title="Cyclic Redundancy Check">CRC</abbr> error for any file, then you can finally confirm the correctness of the key.  And the final step will be unpacking the rest of the files according to the technical specifications. <br><br>  This example suggests that probably not all the statements of the authors of malicious software are true.  And it is often possible to solve the problem of recovering user data by analyzing the changed data. <br><br>  Along with such simple cases, there are crypto-Trojans who will actually use modern cryptographic algorithms and, in the event of their attack, such a simple solution is in principle impossible.  Therefore, be extremely careful when opening any files received by e-mail, even from trusted sources.  Update your antivirus software regularly and back it up so that your data in all copies is not accessible to anyone at a time. <br><br>  <a href="https://habrahabr.ru/post/328134/">Next post: Recovering Data from a Damaged RAID Array to a Linux NAS</a> <br>  <a href="https://habrahabr.ru/post/327414/">Previous publication: Restoring 1C Enterprise (DBF) database after formatting</a> </div><p>Source: <a href="https://habr.com/ru/post/327618/">https://habr.com/ru/post/327618/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327608/index.html">Video recording of the webinar "Julia - A Fresh Approach to Numerical Computing and Data Science"</a></li>
<li><a href="../327610/index.html">Seven Reasons You Can't Drop Clash Royale</a></li>
<li><a href="../327612/index.html">In 5 minutes, make Single Page Application available for Google and Facebook.</a></li>
<li><a href="../327614/index.html">Explanation of Neural Turing Machines</a></li>
<li><a href="../327616/index.html">Extrasensory ability in design, which I have lost</a></li>
<li><a href="../327620/index.html">What awaits us in ReactOS version 0.4.5?</a></li>
<li><a href="../327622/index.html">Retail Sales Model</a></li>
<li><a href="../327624/index.html">MeteorJS, Nginx, mongodb, iptables ... production</a></li>
<li><a href="../327628/index.html">Automated generation of circuit components from PDF files for Altium Designer</a></li>
<li><a href="../327630/index.html">Tmux Cheat Sheet (Terminal Multiplexer)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>