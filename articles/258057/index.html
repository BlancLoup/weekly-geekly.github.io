<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Event model building projects and solutions of Visual Studio for developers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This short article will help: 



- To get acquainted with the event model of building projects and solutions of MS Visual Studio; 
- Understand how t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Event model building projects and solutions of Visual Studio for developers</h1><div class="post__text post__text-html js-mediator-article">  This short article will help: <br><br><ul><li>  To get acquainted with the event model of building projects and solutions of MS Visual Studio; </li><li>  Understand how to get Command-Line support for devenv.exe for VSPackage (where it was not originally provided); </li><li>  Understand how to emulate a similar event model from MSBuild Tools and broadcast to the main plugin; </li><li>  Learn how to work on priority subscription; </li><li>  Find out how to get the build context when handling Visual Studio / MSBuild Tools events; </li><li>  Learn about MSBuild Property &amp; MSBuild Property Functions; </li><li>  Get general information about intermodular interaction on the layer of abstraction for heterogeneous components of the system. </li></ul><br><h4>  Synopsis </h4><br>  I quite often have to engage in the automation of various processes, so it‚Äôs not surprising that some of the solutions sooner or later touched Visual Studio. <br><br>  In fact, this article, or even a note, is the result of a working and long-written plug-in, which only 2 years ago was just a by-product when working on a single C ++ project.  However, my debut on Habrahabr will, perhaps, from this. <br><a name="habracut"></a><br>  Recently I was approached with similar needs (the ones that the plug-in was originally intended to solve) a DevDiv guy.  In an attempt to solve his problem of highly custom automation, it became clear that it was still extremely necessary to highlight some aspects of the solution and the interaction between VS &amp; MSBuild.  After all, this material was not originally there, and it seems to be still not publicly available. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  A warning </h4><br>  Before you begin, please note that the material is not for Visual Studio users, but for developers (suggesting an extension of Visual Studio itself).  And it is intended primarily to highlight some aspects of solutions and interactions for these components, if someone is faced with similar tasks for their own development.  This is not a step by step guide, but it is meant to help you understand the minimum principles and patterns of work.  For example, interaction with devenv.exe, msbuild.exe, work with priority subscription, and all that is indicated in the list above. <br><br><h4>  About problems </h4><br>  The initial need, for both of us, was and is to work with the Solution-Context as part of an event-driven studio model. <br>  Those who worked with Visual Studio, of course, need to know about Pre / Post-build project-level events.  However, they do not fully satisfy the needs of project management for the entire solution, especially when there are several dozen of these projects, etc., which is typical primarily for C ++ projects. <br><br>  There are <a href="http://stackoverflow.com/q/2295454">several ways</a> to solve this problem.  For example, the above mentioned, is now making the transition from the decision, when the Solution has a project on which all others depend. <br><br><h5>  So why MS still does not allocate a similar context for its IDE? </h5><br>  In fact, everything is the same as with the <b>.sln</b> format, which still represents hunter‚Äôs notes, rather than a valid xml document with project files, or something more flexible and elegant. <br>  Compatibility?  Probably, however, it was necessary to break it with the advent of major changes in VS2010. <br><br>  So with the solution-context.  Just to raise events to the upper level will not work, because  you need to solve the problem of managing msbuild data and much more for one single context, and no one is in a hurry to add it to your downloaded timeline. <br><br><h4>  Event handling of projects and solutions of MS Visual Studio (VS2010, VS2012, VS2013, VS2015) </h4><br>  To begin, let's look at the EnvDTE version.  For our task, the gaze is primarily focused on <a href="https://msdn.microsoft.com/en-us/library/envdte.buildevents.aspx">BuildEvents</a> , which provides an affordable subscription to basic events, such as <i>OnBuildBegin</i> , <i>OnBuildProjConfigBegin,</i> and the like.  That is, they are implemented in the form of public events. <br><br>  <u>However, no</u> , in our case they will work too late when the alert to all of their DTE listeners goes.  We need to get control over the situation as soon as possible in our package. <br><br>  Fortunately, in VS there is a priority layer for processing such things, they will be executed first of all with all such things. <br><br>  In general, this is the same classic observer, implemented through Advise methods for specific services.  But first things first. <br><br>  First of all, we need to pay attention to <a href="https://msdn.microsoft.com/en-us/library/Microsoft.VisualStudio.Shell.Interop.aspx">Microsoft.VisualStudio.Shell.Interop</a> .  He will help to work with the basic "build-events" VS and other level of the solution, namely <b>IVsUpdateSolutionEvents</b> : <br><ul><li>  <a href="https://msdn.microsoft.com/en-us/library/microsoft.visualstudio.shell.interop.ivsupdatesolutionevents.aspx">IVsUpdateSolutionEvents</a> </li><li>  <a href="https://msdn.microsoft.com/en-us/library/microsoft.visualstudio.shell.interop.ivsupdatesolutionevents2.aspx">IVsUpdateSolutionEvents2</a> </li><li>  <a href="https://msdn.microsoft.com/en-us/library/microsoft.visualstudio.shell.interop.ivsupdatesolutionevents3.aspx">IVsUpdateSolutionEvents3</a> </li><li>  <a href="https://msdn.microsoft.com/en-us/library/microsoft.visualstudio.shell.interop.ivsupdatesolutionevents4.aspx">IVsUpdateSolutionEvents4</a> </li></ul><br>  To work with the above-mentioned needs, it suffices to consider only the basic <b>IVsUpdateSolutionEvents2</b> , which is available up to VS2010.  <b>IVsUpdateSolutionEvents4</b> is actually desirable for working with the build context, however it is available only for VS2012 and later. <br><br>  <i><b>Note</b> : IVsSolutionEvents are also likely to be required for full-fledged work, but this point is not covered in this article.</i>  <i>If you still need someone, I can show basic techniques for maintaining this layer.</i> <br><br>  <b>So</b> , we need to implement the following basic things of the IVsUpdateSolutionEvents2 interface: <br><br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//         build-action //       int UpdateSolution_Begin(ref int pfCancelUpdate);</span></span></code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//      .. Cancel / Abort -     int UpdateSolution_Cancel();</span></span></code> </pre><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//      . //  ,        ,    Cancel/Abort, ..: // * Begin -&gt; Done // * Begin -&gt; Cancel -&gt; Done int UpdateSolution_Done(int fSucceeded, int fModified, int fCancelCommand);</span></span></code> </pre><br>  All these methods are primarily suitable for the implementation of the solution-context level. <br>  For projects we have provided: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateProjectCfg_Begin</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IVsHierarchy pHierProj, IVsCfg pCfgProj, IVsCfg pCfgSln, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwAction, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pfCancel</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateProjectCfg_Done</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IVsHierarchy pHierProj, IVsCfg pCfgProj, IVsCfg pCfgSln, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwAction, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fSuccess, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fCancel</span></span></span><span class="hljs-function">)</span></span>;</code> </pre><br>  Which will be called for each, the configuration of which should go to build.  Note the <b>pHierProj</b> argument; this is a flexible way to refer to wherever the control came from. <br><br>  Basic implementation of your package does not mean that VS will be ready to work with <b>IVsUpdateSolutionEvents</b> .  As mentioned above, we need to register our listener (who implements this interface): <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">vsSolutionBuildEventPackage</span></span>: <span class="hljs-title"><span class="hljs-title">Package</span></span>, <span class="hljs-title"><span class="hljs-title">IVsSolutionEvents</span></span>, <span class="hljs-title"><span class="hljs-title">IVsUpdateSolutionEvents2</span></span> { ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateSolution_Begin</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pfCancelUpdate</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> VSConstants.S_OK; } ... }</code> </pre><br>  This must be done with the Advise methods, so for IVsUpdateSolutionEvents2 is provided - <a href="https://msdn.microsoft.com/en-us/library/bb141335.aspx">AdviseUpdateSolutionEvents</a> . <br><br>  Registration example: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> http://msdn.microsoft.com/en-us/library/microsoft.visualstudio.shell.interop.ivssolutionbuildmanager2.aspx private IVsSolutionBuildManager2 sbm; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> IVsSolutionBuildManager2 / IVsSolutionBuildManager </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> http://msdn.microsoft.com/en-us/library/bb141335.aspx private uint _sbmCookie; ... sbm = (IVsSolutionBuildManager2)ServiceProvider.GlobalProvider.GetService(typeof(SVsSolutionBuildManager)); sbm.AdviseUpdateSolutionEvents(this, out _sbmCookie);</span></span></code> </pre><br>  It should be noted that access to the <a href="https://msdn.microsoft.com/en-us/library/microsoft.visualstudio.shell.interop.svssolutionbuildmanager.aspx">SVsSolutionBuildManager</a> service <a href="https://msdn.microsoft.com/en-us/library/microsoft.visualstudio.shell.interop.svssolutionbuildmanager.aspx">is</a> possible in other ways.  Use what is convenient. <br><br>  The sbm, in the example above, should be part of the class to be protected from the GC. <br><br>  Now we are ready to listen in the forefront.  It is also important to understand that we are not the very first, but we don‚Äôt need it. <br><br><h4>  Support Command-Line mode </h4><br>  No wonder that someone has a need to work with devenv.exe (or rather devenv.com, since it is he who processes in the console mode) with our plugin.  However, <a href="https://msdn.microsoft.com/en-us/library/bb166424.aspx">VSPackages</a> does not have the ability to work somehow in this mode!  Accordingly, the plugin will simply remain inactive if we try to build a solution in the console as <pre> <code class="bash hljs">devenv <span class="hljs-string"><span class="hljs-string">"D:\App1\App1.sln"</span></span> /Rebuild Debug</code> </pre> <br>  I first asked this question in the Q / A gallery and, to be honest, I didn‚Äôt have such needs or even desires before (since you can work with msbuild.exe and, besides, automation servers will still provide limited environment without all that). <br><br>  However, as we see, the needs of each of us are different, especially if this is a part of VS, then there is a disorder, we must support it. <br><br>  Later, as part of supporting CI servers, I took up a similar issue with a successful <a href="https://bitbucket.org/3F/vssolutionbuildevent/issue/25/">solution</a> .  That is, <b>we can process the</b> entire event model of projects and solutions <b>in VSPackage</b> !  Who would not say: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"C:\Program Files (x86)\Microsoft Visual Studio 12.0\Common7\IDE\devenv"</span></span> <span class="hljs-string"><span class="hljs-string">"D:\App1.sln"</span></span> /Rebuild Debug <span class="hljs-string"><span class="hljs-string">"C:\Program Files (x86)\Microsoft Visual Studio 12.0\Common7\IDE\devenv"</span></span> <span class="hljs-string"><span class="hljs-string">"D:\App1.sln"</span></span> verbosity:diagnostic /Build Release</code> </pre>  <a href="https://bitbucket.org/3F/vssolutionbuildevent/wiki/CI/Devenv%2520Command-Line">[?]</a> <br>  But‚Ä¶ <br><ul><li>  The solution involves using <a href="https://msdn.microsoft.com/en-us/library/ms228754.aspx">Add-Ins</a> wrappers to broadcast events; </li><li>  It is the Add-Ins that provide the command-line mode, or rather, VS is ready to work with it in this mode; </li><li>  They also have exactly the same model, so we have nothing easier to simply implement the good old IVsUpdateSolutionEvents2 and register as for VSPackage at the point: </li></ul><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnConnection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> application, ext_ConnectMode connectMode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> addInInst, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Array custom</span></span></span><span class="hljs-function">)</span></span>;</code> </pre><br>  And redirect to the main library, that is, for example: <br><br><pre> <code class="cs hljs">... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateSolution_Begin</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pfCancelUpdate</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> library.Event.onPre(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> pfCancelUpdate); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateProjectCfg_Begin</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IVsHierarchy pHierProj, IVsCfg pCfgProj, IVsCfg pCfgSln, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwAction, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pfCancel</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> library.Event.onProjectPre(pHierProj, pCfgProj, pCfgSln, dwAction, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> pfCancel); } ...</code> </pre><br>  But, as everyone has long known, <i>the Add-ins are deprecated in Visual Studio 2013</i> .  That is, such a trick will work for VS2010, VS2012 and VS2013.  For the planned VS2015 such games will not work. <br><br>  I already wrote about this on MS Connect <a href="https://connect.microsoft.com/VisualStudio/Feedback/Details/1075033">Issue # 1075033</a> , but you can say goodbye to those who <a href="https://connect.microsoft.com/VisualStudio/Feedback/Details/1075033">thought</a> it was important.  VS2015 is already in RC, and the problem simply closed. <br><br>  Go ahead. <br><br><h4>  Emulation of a similar event model from MSBuild tools </h4><br>  Let's start with the fact that MSBuild tools is definitely a more powerful tool and no one should know the above mentioned problems.  We can safely handle $ (Configuration) &amp; $ (Platform) level solution, we can work with targets, etc. However, the solution should be the same and we should not notice the difference in work between VS IDE and CI / Special Build Servers builds.  Therefore, we consider the possibility of working with the above events within the msbuild tools. <br><br>  Neither DTE2-context, nor event registration services are available to us, nothing that can communicate with VS, <i>but what else are you waiting for</i> ?  Yes, of course, we can get, for example, the same DTE2-context c <a href="https://msdn.microsoft.com/en-us/library/system.runtime.interopservices.marshal.getactiveobject%2528v%3Dvs.110%2529.aspx">GetActiveObject</a> , which in turn uses: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">HRESULT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetActiveObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( _In_ REFCLSID rclsid, _Reserved_ </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pvReserved, _Out_ IUnknown **ppunk )</span></span></span></span>;</code> </pre><br>  <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms221467%2528v%3Dvs.85%2529.aspx">[?]</a> <br>  Those.  like this: <br><br><pre> <code class="cs hljs">(EnvDTE80.DTE2)System.Runtime.InteropServices.Marshal.GetActiveObject(<span class="hljs-string"><span class="hljs-string">"VisualStudio.DTE.10.0"</span></span>);</code> </pre><br>  But all this will only work if there is a running instance of an IDE studio, which is not possible for limited environments, for example, for CI. <br><br>  Therefore, I suggest getting control of msbuild.exe by registering the developed translator as a logger.  To do this, we need to work with <a href="https://msdn.microsoft.com/en-us/library/Microsoft.Build.Framework%2528v%3Dvs.121%2529.aspx">Microsoft.Build.Framework</a> . <br><br>  Indeed, basic <a href="https://msdn.microsoft.com/en-us/library/microsoft.build.framework.ieventsource%2528v%3Dvs.121%2529.aspx">IEventSource</a> is able to provide all of our basic needs: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EventManager</span></span>: <span class="hljs-title"><span class="hljs-title">Logger</span></span> { ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Initialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IEventSource evt</span></span></span><span class="hljs-function">)</span></span> { ... } }</code> </pre><br>  However, there are a number of features that you need to know. <br><ul><li>  <a href="https://msdn.microsoft.com/en-us/library/microsoft.build.framework.ieventsource.buildstarted%2528v%3Dvs.121%2529.aspx">IEventSource.BuildStarted</a> will not work (see note below), because  it works too early, more precisely, in order to get the data of the project that needs to be processed, we will have to wait.  In VS, the input context is processed with IVsSolutionEvents; </li><li>  Therefore, for PRE events, it is possible to use <a href="https://msdn.microsoft.com/en-us/library/microsoft.build.framework.ieventsource.projectstarted%2528v%3Dvs.121%2529.aspx">IEventSource.ProjectStarted</a> , and it, in turn, should be used for project-level events. </li></ul><br>  The fact is that the handler - ProjectStartedEventHandler also sends <b>ProjectStartedEventArgs</b> as an argument and an <b>.sln</b> file for working with it, we can track, for example, like this: <br><br><pre> <code class="cs hljs">evt.ProjectStarted += (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, ProjectStartedEventArgs e) { e.ProjectFile; <span class="hljs-comment"><span class="hljs-comment">// should be .sln ! ... };</span></span></code> </pre><br>  The option can be with waiting until we get .sln for processing, and it in turn must be before passing the project files. <br><br>  The torment on this is just beginning, because  For full-fledged work, you will most likely need .sln data, including loading projects to get access to the msbuild engine anywhere else, for example, evaluating new St.-in msbuild, interrupting assembly, etc. <br><br>  To work with .sln files, alas, you will not see anything normal, or rather choose your own taste: <br><ul><li>  Either use outdated ie.  It is marked as <b>obsolete</b> <a href="http://msdn.microsoft.com/en-us/library/microsoft.build.buildengine.project%2528v%3Dvs.100%2529.aspx">Microsoft.Build.BuildEngine.Project</a> .  In this case, take into account that if you do not use Microsoft.Build.BuildEngine, then this is add.  unnecessary reference for your project. </li><li>  Or use reflection on internal methods - Microsoft.Build.  <b>BuildEngine.Shared</b> , for example: <br>  -&gt; void ParseProject (string firstLine) <br>  -&gt; void ParseFirstProjectLine (string firstLine, ProjectInSolution proj) <br>  -&gt; crackProjectLine -&gt; PROJECTNAME + RELATIVEPATH </li><li>  Or write your own small parser following the example of the same ParseProject. </li></ul><br>  The choice is not rich, however .sln in an incomprehensible form for a long time ... <br><br>  <b>Note:</b> <br><br>  The phrase above ‚ÄúIEventSource.BuildStarted will not work‚Äù is not entirely true ... It does work too early to get the necessary data, but it‚Äôs a double-edged sword.  <a href="http://www.codeproject.com/Articles/1092265/MSBuild-Plugin-The-Managing-of-Most-Processes-at-R">Here</a> , I described a problem that can be encountered with a similar implementation.  So for a multithreaded assembly <b>/ m: 2+</b> (2 or more concurrent processes to use) this can cause quite unpleasant consequences, and a special case of <a href="http://help.appveyor.com/discussions/problems/2783-csc-error-cs2001-for-prev-successful-build">CSC error (CS2001)</a> , when all the goals were defined by the msbuild collector before processing our first events, and The corresponding modifications at runtime could not affect the new ones in any way.  Although this coverage is only part of the tasks involved in the construction process, etc. <br><br>  Therefore, I recommend the most flexible way to use IEventSource.BuildStarted with the preliminary preparation of all the necessary data.  How to do this, I described in <a href="http://www.codeproject.com/Articles/1092265/MSBuild-Plugin-The-Managing-of-Most-Processes-at-R">this material</a> , there you can also find a simple sln parser under MIT or see the parser in the main library. <br><br>  <i>Go ahead.</i> <br>  The project may need to evaluate the properties and functions of msbuild (MSBuild Property Functions), etc., <i>but what about without them ...</i> <br><br>  If you need this, in order to work with this, you need to prepare the msbuild engine, and you must first initiate it.  Since we are working with an isolated environment, it is also necessary to transfer the properties with which it was initiated from msbuild.exe. <br><br>  If you are using .NET 4.0, you will have to do it manually, i.e.  you need to define a Configuration, Platform, SolutionDir, etc.  for the handler.  But for the .NET 4.5 platform <a href="http://msdn.microsoft.com/en-us/library/microsoft.build.framework.projectstartedeventargs.globalproperties%2528v%3Dvs.110%2529.aspx">ProjectStartedEventArgs.GlobalProperties</a> is available. <br><br>  After the isolated environment is fully initialized, we can finally handle project events.  However, we work with msbuild and we work with targets.  So you need to subscribe to <a href="https://msdn.microsoft.com/en-us/library/microsoft.build.framework.ieventsource.targetstarted%2528v%3Dvs.121%2529.aspx">TargetStarted</a> . <br><br>  For the broadcast, we will be given PreBuildEvent and PostBuildEvent from the received TargetName, for example: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTargetStarted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, TargetStartedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(e.TargetName) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"PreBuildEvent"</span></span>: { ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } } }</code> </pre><br>  But here, not everything goes smoothly.  The fact is that we cannot refer to a project that is being processed with TargetStartedEventArgs, however we can get a <b>BuildEventContext</b> , from which we can get <b>ProjectInstanceId</b> , and it in turn exists for ProjectStarted, i.e.  we can simply remember the ProjectId and then refer to it wherever a BuildEventContext is available, for example, simply: <br><br><pre> <code class="cs hljs">projects[e.ProjectId] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Project() { Name = properties[<span class="hljs-string"><span class="hljs-string">"ProjectName"</span></span>], File = e.ProjectFile, Properties = properties };</code> </pre><br>  Actually, now you can fully translate the event model in VSPackage with an isolated environment and work as it is: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"C:\Program Files (x86)\MSBuild\12.0\bin\msbuild.exe"</span></span> <span class="hljs-string"><span class="hljs-string">"app.sln"</span></span> /l:<span class="hljs-string"><span class="hljs-string">"&lt;&gt;.dll"</span></span> /m:12 /t:Rebuild /p:Configuration=&lt;cfg&gt; /p:Platform=&lt;platform&gt;</code> </pre><br><h4>  Get build context </h4><br>  <i>In fact, there are a number of problems or features that I also wanted to highlight.</i>  <i>But in general, this is too specific for our project, and for your case you may not need anything like that at all, so you can skip it</i> . <br><br>  Since our plugin works with build events, it‚Äôs not hard to guess what might be required to get the build type with which it all started.  But for VS this is <a href="http://stackoverflow.com/q/27018762">not so simple</a> . <br><br>  You already know and understand that we are working on a priority subscription, and we will not be able to use something like: <br><br><pre> <code class="cs hljs">_buildEvents.OnBuildBegin += (vsBuildScope Scope, vsBuildAction Action) =&gt; { buildType = (BuildType)Action; };</code> </pre><br>  Because it is too late. <br><br>  You can try to work with <a href="https://msdn.microsoft.com/en-us/library/microsoft.visualstudio.shell.interop.ivsupdatesolutionevents4_methods.aspx">IVsUpdateSolutionEvents4</a> , however, as I wrote in the question and answer, only if you do not plan to be compatible with older versions. <br><br>  At that time, the choice was to intercept commands from VS IDE, for example: <br><br><pre> <code class="cs hljs">_cmdEvents.BeforeExecute += (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> guid, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> customIn, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> customOut, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> cancelDefault) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(GuidList.VSStd97CmdID == guid || GuidList.VSStd2KCmdID == guid) { _c.updateContext((BuildType)id); } };</code> </pre><br>  Not really like it, it's better to use <b>IVsUpdateSolutionEvents4</b> , but the only working version is for compatibility of versions and preservation of priority processing, which I could guess at that moment.  And no one is in a hurry to please with other solutions. <br><br><h4>  Intermodular interaction </h4><br>  Well, in fact there will not be anything remarkable, everything is ordinary, however, there is a short description in the article. <br><br>  As you have already noticed, the components are versatile and even different in their model of event handling.  Using my plugin as an example, it looks like this: <br><br><img src="https://habrastorage.org/files/b83/75f/e41/b8375fe413634b1ca40a8a52355051d7.png" alt="image"><br>  A sheet of what is shown can be found <a href="https://bitbucket.org/3F/vssolutionbuildevent/wiki/scheme">here</a> . <br><br>  Highlights for your work: <br><ul><li>  We select a common public interface at the project level, so that all the necessary components can provide an implementation on it.  So does Shell.Interop, so does EnvDTE, etc .; </li><li>  We determine where the main core of the program will be located.  The one who will be responsible for the uniform data processing; </li><li>  We define somewhere library loader.  This may also be the case with our external Provider, etc .; </li><li>  Each of the components, respectively, independently determines how it should connect to where it will be used, and in general, it should deal only with sending and transmitting, if necessary, the processed data.  (I suppose you don‚Äôt need to give an example of how to work with external libs; you can find either in my source code or anywhere else, this is beyond the scope of the article). </li></ul><br>  There is an important remark.  Our plugin was not originally intended to be used in this volume, so the core of the system is located in the VSPackage. <br><br>  Yes, it is convenient not to divide into separate components, but why is it bad?  The fact is that my VSPackage in the diagram above, you have to pull heavy dependencies on EnvDTE &amp; EnvDTE80 (which, in turn, have even more exotic connections).  All this can, and most likely will be absent on servers of continuous integration, since  first comes standard msbuild tools, and more.  That is, do not forget about light self-sufficient components and transparent interfaces.  <i>I'm not in a hurry with the separation, because</i>  <i>all this time, and it‚Äôs not worth it yet, because it was originally a VSPackage solution, something like that.</i> <br><br><h4>  Access and rating MSBuild Properties &amp; MSBuild Property Functions </h4><br>  The last point I want to consider is the evaluation of properties.  In general, access to properties can occur in several ways, for example: <br><ul><li>  With <a href="http://msdn.microsoft.com/en-us/library/Microsoft.Build.BuildEngine">Microsoft.Build.BuildEngine</a> </li><li>  Either with <a href="https://msdn.microsoft.com/en-us/library/microsoft.build.evaluation">Microsoft.Build.Evaluation</a> </li></ul><br>  And also others. <br><br>  The most flexible option is to use Microsoft.Build.Evaluation, since  here is the easiest way to get an estimate using the msbuild engine and work with projects, for example: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evaluate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> unevaluated, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> projectName = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { ... <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span>(_lock) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ... project.SetProperty(container, Scripts.Tokens.characters(_wrapProperty(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> unevaluated))); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> project.GetProperty(container).EvaluatedValue; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { project.RemoveProperty(project.GetProperty(container)); } } }</code> </pre><br>  However, as it was already possible to understand, for a solution-context you will have to decide how to work with data from projects.  I personally implemented the <a href="https://bitbucket.org/3F/vssolutionbuildevent/wiki/Scripts_%26_Commands/MSBuild">add.</a>  <a href="https://bitbucket.org/3F/vssolutionbuildevent/wiki/Scripts_%26_Commands/MSBuild">syntax extension</a> . <br><br>  <i>That is, you still have to pre-parse with your analyzer, and then send the prepared data that the original msbuild engine can already handle</i> . <br><br><h4>  Conclusion </h4><br>  Actually, this is the first article on Habrahabr.  I hope not the last -_-. <br><br>  The material covers <b>key points</b> to understand what needs to be done, what solutions there are, and what problems and peculiarities you will have to deal with working with the event model of constructions in VS, as well as its related components devenv &amp; MSBuild tools, using the example of a real working solution . <br><br>  Implementation details can be found in the source, as well as get extra.  information in the comments later if you have questions. <br><br>  Write about errors and inaccuracies, correct, if they will ... <i>it was very inconvenient without a markdown</i> . <br><br><h4>  upd. </h4><br>  In my attempts to convey to commentators that: <br>  <b>The material describes</b> - how to work with these elements, as well as solving problems when using them in the described circumstances.  In order for the VS developer to be able to familiarize himself with the existing solutions, and to apply the knowledge gained during development - anything and for anything of his own ... <i>alas, they were not crowned with success</i> . <br><br>  <b>We discuss exclusively</b> - ways to solve problems with the help of these developments for the end user, <i>and also generally try to solve abstract problems that were not presented or described in detail - we decide to solve it without knowing the subject area.</i> <br><br>  In view of the exclusivity of the formed audience, to continue to comment in this article, I will not present it appropriate. <br>  <b>However</b> , for those who still need help on the topic, I can probably consult as much as I have free time.  Contacts in G +. <br><br><h4>  upd2.  Targets &amp; Map of projects. </h4><br>  A small bonus, while I support the material, for those who want, but can not use IVsUpdateSolutionEvents2 / IVsUpdateSolutionEvents due to various circumstances. <br><br>  Discussing the problem of the 'solution level' events (for simplicity, we continue to refer to this wording) with the person who contacted me, I also considered the possibility of working with targets instead of implementing the specified interfaces, since  it was clearly an extra link for him to get rid of.  Well, we are trying to achieve some equivalent. <br><br>  Besides, if you just like something like that - <a href="http://sedodream.com/2010/10/22/MSBuildExtendingTheSolutionBuild.aspx">MSBuild: Extending the solution build</a> , (but this option can only work when building from msbuild.exe and not from VS IDE ...) <br><ul><li>  VS IDE does not consider the .sln file at all when building it.  It forms final targets from its loaded environment with EnvDTE, etc. </li><li>  The .sln file is considered only msbuild.exe - i.e.  Before building, it automatically generates .metaproj (in memory, by default), which contains what and when it will be built, including common targets for all projects if it exists.  For example: </li></ul><br><pre> <code class="xml hljs">... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Import</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Project</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\SolutionFile\ImportAfter\*"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(ImportByWildcardBeforeSolution)' != 'false' and exists('$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\SolutionFile\ImportAfter')"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Import</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Project</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"D:\tmp\p\after.Sample.sln.targets"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"exists('D:\tmp\p\after.Sample.sln.targets')"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Build"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Rebuild"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Clean"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Publish"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br><ul><li>  At the same time. Metaproj is not considered VS IDE, since  he has his own formed goals. </li><li>  And also we don‚Äôt know what is happening and when.  projects are built all separately with pre-defined goals VS. </li></ul><br>  those.  to work with common targets for build operations from VS IDE, we can only use project files (meaning without modification / VS extension) with some restrictions. <br><br>  We consider, respectively, the situation of a general solution, or when we may not know at all about the projects that the end user will have in solution. <br><br>  As a limitation, you can consider a project map (there are at least 2 options, but only this one showed itself to be more or less stable, therefore the bonus is only about it): <br><br><ul><li>  <a href="https://gist.github.com/3F/a77129e3978841241927">gist.github.com/3F/a77129e3978841241927</a> </li></ul><br><pre> <code class="xml hljs">... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_Build"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BeforeTargets</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Build"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DependsOnTargets</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ProjectsMap"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CallTarget</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Targets</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_BuildPRE"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ScopeDetectFirst)"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CallTarget</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Targets</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_BuildPOST"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ScopeDetectLast)"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_BuildPRE"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ... --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_BuildPOST"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ... --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span> ...</code> </pre><br>  In general, when forming a similar map, we now know what and when it should be <i>(formed with ProjectsMap, the detector with ScopeDetectFirst and ScopeDetectLast respectively)</i> , ie: <br><ul><li>  Just automatically add (for example with <a href="https://docs.nuget.org/create/creating-and-publishing-a-package">NuGet events</a> , etc.) your common .targets file to all projects, for example: <pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Import</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Project</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"..\&lt;SolutionFile&gt;.targets"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> </li><li>  Further, with the restriction in the form of a project map, we can now achieve the following implementation <i>(for Clean, Build, Rebuild, etc. goals)</i> : </li><li><ul><li>  ‚ÄúBefore the start of the first project‚Äù </li><li>  "After the end of the last project" </li></ul></li></ul><br>  It is safe for all or most cases (changing the build order or deleting some projects from the solution, everything should work fine).  But!  This option has a number of inconveniences in the form of import service at the initialization stage, as well as when adding new projects.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is inconvenient, but an option for IVsUpdateSolutionEvents. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition, I noted a potential problem with Unload projects (when the IDE allows the user to temporarily unload the project from the solution) in the </font></font><a href="https://gist.github.com/3F/a77129e3978841241927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">title</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - however, in most cases this will be a valid option, since </font><font style="vertical-align: inherit;">this unload is temporary, and the error is valid in some form, so it can be allowed (besides, the problem can still be solved if desired). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Regarding convenience, a controversial point ... in your VSPackage products can also be an extra link, and as an option you can consider something like that ... </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , with regard to reliability, I would still choose IVsUpdateSolutionEvents with VSPackage!</font></font> because<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Such a minimum is standardized, and accordingly predictable on different versions. </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> upd3. </font></font></h4><br><br><ul><li>    msbuild ,          ,   <a href="http://help.appveyor.com/discussions/problems/2783-csc-error-cs2001-for-prev-successful-build">CSC error (CS2001)</a> .   </li><li> <b></b> .      MSBuild Plugin,  .    ,    .   CodeProject <a href="http://www.codeproject.com/Articles/1092265/MSBuild-Plugin-The-managing-of-most-processes-at-r"></a> .  You will learn: <br><ul><li>      ,          +  . </li><li>       MSBuild Tool       ,         .. </li></ul></li><li> ,     EnvDTE.CommandEvents    , .       SO <a href="http://stackoverflow.com/a/18311007"></a> . </li></ul><br><br><h4>  Related Links </h4><br><ul><li> VSPackage    ‚Äî <a href="https://visualstudiogallery.msdn.microsoft.com/0d1dbfd7-ed8a-40af-ae39-281bfeca2334/">visualstudiogallery.msdn.microsoft.com/0d1dbfd7-ed8a-40af-ae39-281bfeca2334</a> </li><li>   Github: <a href="https://github.com/3F/vsSolutionBuildEvent/">github.com/3F/vsSolutionBuildEvent</a> </li><li> Visual Studio: Solution-wide pre-build event? ‚Äî <a href="http://stackoverflow.com/q/2295454">stackoverflow.com/q/2295454</a> </li><li> Map of projects ‚Äî <a href="https://gist.github.com/3F/a77129e3978841241927">gist.github.com/3F/a77129e3978841241927</a> </li><li> Current type of the build action from Visual Studio ‚Äî Microsoft.VisualStudio.Shell.Interop ‚Äî <a href="http://stackoverflow.com/a/27081247">stackoverflow.com/a/27081247</a> </li><li> IVsUpdateSolutionEvents2 ‚Äî <a href="https://msdn.microsoft.com/en-us/library/microsoft.visualstudio.shell.interop.ivsupdatesolutionevents2.aspx">msdn.microsoft.com/en-us/library/microsoft.visualstudio.shell.interop.ivsupdatesolutionevents2.aspx</a> </li><li> IVsUpdateSolutionEvents4 ‚Äî <a href="https://msdn.microsoft.com/en-us/library/microsoft.visualstudio.shell.interop.ivsupdatesolutionevents4.aspx">msdn.microsoft.com/en-us/library/microsoft.visualstudio.shell.interop.ivsupdatesolutionevents4.aspx</a> </li><li> Microsoft.VisualStudio.Shell.Interop ‚Äî <a href="https://msdn.microsoft.com/en-us/library/Microsoft.VisualStudio.Shell.Interop.aspx">msdn.microsoft.com/en-us/library/Microsoft.VisualStudio.Shell.Interop.aspx</a> </li><li> Microsoft.Build.Evaluation <a href="https://msdn.microsoft.com/en-us/library/microsoft.build.evaluation">msdn.microsoft.com/en-us/library/microsoft.build.evaluation</a> </li><li> EnvDTE <a href="https://msdn.microsoft.com/en-us/library/envdte.aspx">msdn.microsoft.com/en-us/library/envdte.aspx</a> </li><li> MSBuild: Extending the solution build ‚Äî <a href="http://sedodream.com/2010/10/22/MSBuildExtendingTheSolutionBuild.aspx">sedodream.com/2010/10/22/MSBuildExtendingTheSolutionBuild.aspx</a> </li><li> VSPackages ‚Äî <a href="https://msdn.microsoft.com/en-us/library/bb166424.aspx">msdn.microsoft.com/en-us/library/bb166424.aspx</a> </li><li> MS Connect Issue #1075033 ‚Äî <a href="https://connect.microsoft.com/VisualStudio/Feedback/Details/1075033">connect.microsoft.com/VisualStudio/Feedback/Details/1075033</a> </li><li> MSBuild Plugin: <a href="http://www.codeproject.com/Articles/1092265/MSBuild-Plugin-The-managing-of-most-processes-at-r">www.codeproject.com/Articles/1092265/MSBuild-Plugin-The-managing-of-most-processes-at-r</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/258057/">https://habr.com/ru/post/258057/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258045/index.html">Lectures of the Technosphere. Semester 2 Methods for distributed processing of large amounts of data in Hadoop</a></li>
<li><a href="../258047/index.html">io.js integrates with NodeJS</a></li>
<li><a href="../258051/index.html">Designing and embedding .vsix extensions in Visual Studio on C # for dummies</a></li>
<li><a href="../258053/index.html">Sublime Text 3 - custom syntax highlighting</a></li>
<li><a href="../258055/index.html">The study of someone else's cheat for FarCry 4</a></li>
<li><a href="../258059/index.html">VMware Virtual SAN (VSAN): why do you need it and how to prepare it</a></li>
<li><a href="../258061/index.html">Some interesting and useful things for web developer # 43</a></li>
<li><a href="../258063/index.html">Windows 10 on Raspberry Pi 2, first impressions</a></li>
<li><a href="../258065/index.html">As I passed the first hack quest CTF Ratazana</a></li>
<li><a href="../258069/index.html">Rust 1.0 Preview</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>