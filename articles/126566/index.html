<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The most expensive single-byte error</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I bring to your attention a translation of a recent post in the electronic journal Queue, by Poul-Henning Kamp. 

 Did Ken, Dennis, and Bryan make a m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The most expensive single-byte error</h1><div class="post__text post__text-html js-mediator-article">  <i>I bring to your attention a translation of a recent post in the electronic journal <a href="http://queue.acm.org/">Queue, by</a> Poul-Henning Kamp.</i> <br><br>  Did Ken, Dennis, and Bryan make a mistake when choosing to use NUL-terminated text strings? <br><br>  IT stimulates and implements the modern Western economy.  Accordingly, we often see headlines about overwhelmingly large sums of money associated with errors in IT.  What kind of solution related to IT or CN [computer science] is the most expensive? <br><a name="habracut"></a><br>  Recently, a sufficient number of experts shrugged at the mention of the financial implications for Sony of the problems associated with their PlayStation Network, but this event is insignificant in this context.  When I was in school, I had the opportunity to talk with the inspector from the Guinness Book of Records, who explained that something could not just happen to be a real record, there should be a causal relationship that begins with human intent (for example, we drove 26 high school students into Volkswagen Beetle our music teacher and closed the door). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Sony (probably) did not want to find out what kind of confusion will happen if you pay little attention to safety, so this and other examples of false savings do not pass the selection.  Another choice could be IBM‚Äôs choice of Bill Gates, rather than Gary Kildall, as the supplier of the operating system for their personal computer.  The damage from this solution is still accumulating at breakneck speed: Stuxnet [approx.  per.  network worm] and the distortion of the ISO standardization process OOXML vividly demonstrate how far and wide the damage can spread.  But this was not a decision related to IT or CN.  As is currently known, this was a business decision based on Kildal‚Äôs refusal to accept IBM's non-disclosure requirements. <br><br>  A more suitable example would be a solution to invent your own directory / file name separator for MS-DOS: a backslash (\) was chosen, rather than a forward slash (/) that was used in Unix or a dot that used DEC in its operating systems .  Although the actual damage is relatively moderate, this solution is also not suitable as a good example, since it was not a real solution, it was a true preference.  IBM chose to use slashes for command flags, ignoring Unix, and the dot was used as a separator for the file name and extension, which made it impossible to follow the DEC example. <br><br>  The history of space exploration offers a whole set of untwisted and expensive mistakes, but, interestingly, I could not find any suitable candidate.  Fortran syntax errors and sync errors of the onboard computer of the shuttle are not suitable due to lack of intent.  Maintaining part of the project in the imperial units of measurement, and the other part in metric is a ‚Äúrandom act of control‚Äù and does not relate to CN or IT in any way. <br><br>  The best example I could find is the use of NUL-terminated text lines in C / Unix / Posix.  It was a very simple choice: should C represent strings as a tuple address + length or just as an address and some magic character (NUL) marking the end of the string?  It was this decision that Dynamic Trio Ken Thompson, Dennis Ritchie, and Brian Kernighan took in the early 1970s, and they were free to choose any method.  I could not find a single record of the decision, which I recognize as a weak candidate: I have no evidence that this decision was deliberate. <br><br>  However, as far as I can determine from my research, the address + length format was preferred for most programming languages ‚Äã‚Äãof that time, while the address + magic marker was used mainly in programs written in assembler.  Since language C grew out of assembler, like a more portable and high-level language, it's hard for me to believe that Ken, Dennis and Brian didn't even think about it. <br><br>  Using the address + length format would cost a single byte over the address + magic marker, and their PDP computer would have limited basic memory.  In other words, this example could be an ideally typical and rational decision related to IT or CN, like so many similar decisions we make every day.  But it is precisely this decision that has atypical economic consequences. <br><br><h1>  Hardware development costs </h1><br><br>  Initially, Unix had little influence on the development of hardware and a set of commands [approx.  per.  processor].  Processors that provide string manipulation instructions, such as the Z-80 and DEC VAX, implemented this using the much more common address + offset model.  As soon as Unix and C received support, NUL-terminated strings became the target for optimizations.  CPU developers have begun to add instructions for working with them.  An example is the Logical String Assist instructions added by IBM in 1992 to processors based on ES / 9000 520. <br><br>  Adding instructions to the CPU is not cheap and occurs only when there are tangible and quantifiable monetary reasons. <br><br><h1>  Performance costs </h1><br><br>  IBM added instructions for working with NUL-terminated strings because its customers spent expensive CPU cycles on processing such strings.  However, this does not tell us that it would take less CPU cycles if the address + length format were used. <br><br>  Our question is omitted if we think about virtual memory systems.  Optimizing the movement of a string of bytes of known length favorably uses the entire width of the memory bus and cache lines, without affecting memory areas that are not part of the source or destination string. <br><br>  One example is the libc library in FreeBSD, where the bcopy (3) / memcpy (3) implementation moves as much information as possible into fragments over an ‚Äúunsigned integer‚Äù: usually 32 or 64 bits, and then ‚Äúclears any trailing bytes‚Äù using byte-by-copy, like described in the comments. <br><br>  When using a NUL-terminated string, attempting to work with parts of it that are larger than one byte may result in characters being accessed by the NUL character.  If the NUL character is the last byte of the virtual memory page and the next page is not defined, it may crash the process with an error ‚Äúpage not found‚Äù [‚Äúpage not present‚Äù]. <br><br>  Of course, you can write code that identifies possible pitfalls before executing the optimized code, but this adds a relatively high fixed cost to all operations of moving lines - an unfavorable exchange in any case. <br><br>  If we know the length of the string in advance, everything is different. <br><br><h1>  Compiler development costs </h1><br><br>  Often the compiler knows one thing about strings - their length, especially when strings are constant.  This allows the compiler to make a call to a faster memcpy (3) even if the programmer used strcpy (3) in the source code. <br><br>  A deeper code inspection allows the compiler to perform more advanced optimizations, some of which are very skillful, but only if someone has implemented this in the compiler.  Developing optimizing compilers has never been easy or cheap, but it‚Äôs obvious that Apple hopes this will change using LLVM (Low-level Virtual Machine), where optimizers are in bulk. <br><br>  The down side of deep compiler optimizations are optimizations that provide a holistic review of the source code and reorder it in large volumes.  They require the programmer to carefully ensure that the source code accurately describes what is needed.  The programmer who worked with the compiler for supercomputers of the Convex C3800 series, designated it as ‚Äúit is necessary to program as if the compiler is your ex-wife‚Äù. <br><br><h1>  Security costs </h1><br><br>  Even if your compiler has no hostile intent, the source code must be written in such a way that it can withstand attacks and the NUL-terminated string has a dismal file in this regard.  A complete disaster, from the point of view of security, is gets (3), which ‚Äúbelieves that the buffer will be large enough‚Äù and this problem is ‚Äúrelatively under our control‚Äù. <br><br>  Taking control, however, means that the compiler will additionally complain if gets (3) is called somewhere.  Despite 15 years of attention, overflow and underload [under-running] of string buffers are the preferred attack vector for intruders and too often it pays off. <br><br>  These risks have been reduced at all levels.  Long-missing bits that prohibit execution have been added to CPU memory management hardware;  operating systems and compilers added address space randomization, often at the expense of performance;  Static and dynamic analysis of programs has absorbed countless hours in an attempt to find out whether insidious diagnostics are an error or clever programming. <br><br>  Still, no one would be surprised if it turned out that Sony‚Äôs problems began with a buffer overflow or misinterpretation of the end of the line. <br><br><h1>  Preventing Slashdot Sensation </h1><br><br>  We learn from our mistakes and do not come up with ‚Äúyellow‚Äù headlines for this article.  Ken, Dennis and Bryan could not have foreseen all the consequences of their choice, made 30 years ago, and then they did not guarantee anything.  As far as I know, it took 15 years to realize that this subtle solution is a bad idea.  Probably none of my decisions lasted as long. <br><br>  In other words, Ken, Dennis and Brian did everything right. <br><br><h1>  But this does not solve the problem. </h1><br><br>  For many people, C is dead, and $ {lang} is the language of the future, for the ever-changing short term value of $ {lang}.  In reality, all other languages ‚Äã‚Äãdirectly or indirectly sit on top of the Posix API and NUL-terminated strings of C. <br><br>  When your Java, Python, Ruby, or Haskell program opens a file, the runtime passes the file name as a NUL-terminated string to open (3);  or when it converts queue.acm.org to an IP address, it transmits the host name as a NUL-terminated string to getaddrinfo (3).  As long as you continue to do so, you will retain all the benefits of running your program on the PDP / 11, and all the disadvantages when running on something else. <br><br>  You can write here your API proposal against an imaginary adversary, suggest a way to define functions, operations and error handling strategies, but I‚Äôm sure it will be a complete waste of a wonderful evening.  Experience shows that such sentences go nowhere, since backward compatibility with the PDP / 11 and the final number of programs written are much more important than the potential to write an infinite number of programs in the future in a more efficient and safe way. <br><br>  Thus, the costs of Ken, Dennis, and Bryan‚Äôs decisions will continue to pile up like the dust that almost buried Ancient Rome for centuries. <br><br><h1>  Links </h1><br>  1. Computer Business Review.  1992. Partitioning and Escon enhancements for ES / 9000s;  <a href="http://www.cbronline.com/news/ibm_announcements_71">http://www.cbronline.com/news/ibm_announcements_71</a> . <br>  2. ViewVC.  2007. Contents of /head/lib/libc/string/bcopy.c;  <a href="">http://svnweb.freebsd.org/base/head/lib/libc/string/bcopy.c?view=markup</a> . <br>  3. Wikipedia.  2011. Lifeboat sketch;  <a href="http://en.wikipedia.org/wiki/Lifeboat_sketch">http://en.wikipedia.org/wiki/Lifeboat_sketch</a> . </div><p>Source: <a href="https://habr.com/ru/post/126566/">https://habr.com/ru/post/126566/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126556/index.html">JodaTime - learn materiel, or the importance of nouns</a></li>
<li><a href="../126557/index.html">Infographics: Linux before and now</a></li>
<li><a href="../126559/index.html">30 years sales history of audio recordings</a></li>
<li><a href="../12656/index.html">Google news on your pillow</a></li>
<li><a href="../126560/index.html">Advanced IT companies need experts on dead languages</a></li>
<li><a href="../12657/index.html">Bring me back to my 80's!</a></li>
<li><a href="../126570/index.html">RememberTheMilk everywhere: web, desktop, android and all this for free</a></li>
<li><a href="../126571/index.html">Why you should use XMLHttpRequest asynchronously</a></li>
<li><a href="../126572/index.html">Freelance job</a></li>
<li><a href="../126574/index.html">Started shipping Symbian Anna</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>