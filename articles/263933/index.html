<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The mini-detective is NOT a system administrator</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 I'm Ilya. I‚Äôm more a programmer and an eternal-in-the-try entrepreneur than a system administrator. But, as you know, in startups you are a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The mini-detective is NOT a system administrator</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  I'm Ilya.  I‚Äôm more a programmer and an eternal-in-the-try entrepreneur than a system administrator.  But, as you know, in startups you are a mower, a reaper, and a igrets on a dude.  So today I had to play all the roles.  The article will be able to help the same administrators as beginners, who by the will of fate / service have to deal with the server. <br><a name="habracut"></a><br>  <i>I am writing from the heat, from the heat, some of the teams wrote from memory.</i>  <i>I would welcome any adjustments.</i> <br><br>  So, this morning at 11:35 Minsk time, one of the managers wrote that the websites stopped working.  Specifically, dump MySQL errors 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since  The initial setting up of the server was carried out by the hosting company specialists, I immediately wrote a request to them.  But I got a turn from the gate: <br><br><img src="https://habrastorage.org/files/032/2e2/29d/0322e229d39a4ad1b2bfe062e7223111.png"><br><br>  Well, maybe this is not customer-oriented, but right.  Not every client can help with MySQL.  I did not want to use the paid service.  We will be. <br><br>  Indeed, when entering the site appeared unpleasant: <br><br><pre><code class="bash hljs">SQLSTATE[HY000]: General error: 1 Can<span class="hljs-string"><span class="hljs-string">'t create/write to file '</span></span>/tmp/<span class="hljs-comment"><span class="hljs-comment">#sql_b80_0.MYI' (Errcode: 28 - No space left on device),</span></span></code> </pre> <br><br>  At first glance, everything seemed very simple - there is not enough space on the disk where MySQL is located.  But on the other hand, it is surprising - only yesterday there was 40 GB of free space on that disk. <br><br>  Connect via SSH, look: <br><br><pre> <code class="bash hljs">bakharevich@server:/<span class="hljs-comment"><span class="hljs-comment"># df -h Filesystem Size Used Avail Use% Mounted on rootfs 60G 17G 40G 30% / /dev/xvda1 60G 17G 40G 30% / /dev/xvda3 79G 57G 19G 76% /home/site2.by /dev/xvda5 69G 36G 30G 55% /home/site3.by</span></span></code> </pre><br>  Strange.  On the disk with the database, 40GB is really free, but MySQL surely does not want to run - there is no space. <br><br>  A quick search on the Internet gave the result - <b>in addition to disk space, there are also inodes, of which we have just 0.</b> <br><pre> <code class="bash hljs">bakharevich@server:/<span class="hljs-comment"><span class="hljs-comment"># df -i Filesystem Inodes IUsed IFree IUse% Mounted on rootfs 3932160 3932160 0 100% / /dev/xvda1 3932160 3932160 0 100% / /dev/xvda3 5242880 1122900 4119980 22% /home/site2.by /dev/xvda5 4587520 801087 3786433 18% /home/site3.by</span></span></code> </pre><br><br>  Those.  each file, directory and even a symlink is occupied by an inode.  Somewhere in the subconscious, I certainly understood that this is the place to be.  But the lack of experience in the affairs of the admin / zhelezyachnyh did not let me immediately think about it.  Well, we will know!  :-) In the meantime, you need to release part of the inode in order to launch sites as soon as possible. <br><br>  The first thing I decided to remove is sessions from PHP.  Yes, people will log in authorization, but it's not so bad, because  sites do not work.  Our sessions are stored on disk.  Therefore: <br><br><pre> <code class="bash hljs">rm -rf /var/lib/php5/*</code> </pre><br><br>  And also reconfigure their saving to another disk in <b>php.ini</b> : <br><br><pre> <code class="bash hljs">session.save_path = <span class="hljs-string"><span class="hljs-string">"/path/to/new/dir/"</span></span></code> </pre><br><br>  We look, how many released inode: <br><br><pre> <code class="bash hljs">bakharevich@server:/home<span class="hljs-comment"><span class="hljs-comment"># df -i Filesystem Inodes IUsed IFree IUse% Mounted on rootfs 3932160 32928660 3500 100% / /dev/xvda1 3932160 3932160 0 100% / /dev/xvda3 5242880 1122900 4119980 22% /home/site2.by /dev/xvda5 4587520 801087 3786433 18% /home/site3.by</span></span></code> </pre><br><br>  Only <b>3500</b> :-( But this may be enough to start MySQL, and therefore temporarily restore the work sites. <br><br>  Try restarting MySQL: <br><br><pre> <code class="bash hljs">bakharevich@server:~$ sudo service mysql start [ ok ] Starting MySQL (Percona Server) database server: mysqld . . ..</code> </pre><br><br>  Great, the sites have earned!  But the number of inods continues to decrease.  After about 10 minutes they will become 0 again. <br><br>  We continue to delete files.  Instinctively, I started with <b>/ var / log /</b> i <b>/ var / cache /</b> : <br><br><pre> <code class="bash hljs">du --max-depth=1 /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/ | sort -n -r du --max-depth=1 /var/cache/ | sort -n -r</code> </pre><br><br>  Removed excess.  It became about another 3.000 inode, but of course this is still very little.  And in general, who could create such a number of files to use about 1.5 million inode? <br><br><img src="https://habrastorage.org/files/839/267/0de/8392670dee844c4082eefb7b590dc2a8.png"><br><br>  With further search, I saw the folder <b>/ var / spool / exim4 / input</b> .  <b>Exim4</b> is the mail server, which, as I understand it, comes with Debian.  I tried to count the number of files in the directory, but the result was not shown for a long time.  So there really are a lot of files there: <br><br><pre> <code class="bash hljs">ls -l /var/spool/exim4/input | wc -l</code> </pre><br><br>  A quick search on the Internet showed that this directory is for letters in the queue.  Um ... This is interesting because none of our sites use a local mail server.  Everything is translated into Yandex.Mail for the Domain and Google.  Okay, back to this later.  For now you need to free the inodes! <br><br>  Just do not want to delete files in the directory.  We are looking for the correct removal and find something like this: <br><br><pre> <code class="bash hljs">exim -bp | exiqgrep -i -f <span class="hljs-variable"><span class="hljs-variable">$user</span></span> | xargs exim -Mrm</code> </pre><br><br>  I run.  I wait for some time and understand that the inodes are not exempt.  I quickly think that this is most likely due to the first <b>Exim -bp command</b> , which first lists the letters in the queue.  Once there are more than 1 million letters, then it will take a long time. <br><br>  Moreover, by this time the free inodes had already ended.  Sites stopped again.  Managers begin to write, they come one by one SMS about the inoperability of sites, the phone rings ... The situation is heating up.  Okay!  We'll have to act tough.  Delete directly: <br><br><pre> <code class="bash hljs">rm -rf /var/spook/exim4/input/*</code> </pre><br><br>  But it was not there.  Anodes are not released.  Whether files are deleted too I cannot look - the volume more than one million does not allow them to be counted quickly.  Most likely, rm * also first reads the entire directory, and then starts deleting. <br><br>  All right, we try more rigid option: <br><br><pre> <code class="bash hljs">rm -r /var/spool/exim4/input/</code> </pre><br><br>  ... and finally the Ainods are freed by the thousands.  I feel that I won a small battle, but the enemy went into the forest for regrouping and another attack in about a month :-) We must step on. <br><br>  Already more calm and prudent, I started watching <b>exim</b> logs.  First, nothing interesting ... as if something like this: <br><br><pre> <code class="bash hljs">2015-07-31 13:58:41 1ZIwuU-0007a9-Rm ** joan_galloway@site.by R=dnslookup T=remote_smtp: retry time not reached <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> any host after a long failure period 2015-07-31 13:58:41 1ZIwuU-0007a9-Rm joan_galloway@site.by: error ignored 2015-07-31 13:58:41 1ZIwuU-0007a9-Rm Completed</code> </pre><br><br>  Interesting!  As I already wrote, we do not use the local mail server.  Moreover, <b>site.by</b> is not ours.  We just temporarily host it on our server.  What he does no one knows. <br><br>  I look at the structure of the site: <br><br><img src="https://habrastorage.org/files/39a/363/f4e/39a363f4eb7a4f6e8d42a1fd0e9cde0d.png"><br><br>  Something familiar.  Let's look at <b>index.php</b> : <br><br><img src="https://habrastorage.org/files/783/3ab/976/7833ab976060467989c0da6bf1ce4216.png"><br><br>  Yeah, Joomla!  And from 2013.  Probably took advantage of the vulnerability of the old versions. <br><br>  With the great hope that the site is not very popular, I open webserver logs to find something suspicious.  Immediately I do a search by email <b>"joan_galloway"</b> , which was found in the Exim logs.  But there is nothing ... Looking further.  Requests for pictures, stylesheets ... And suddenly: <br><br><pre> <code class="bash hljs">50.62.177.108 - - [31/Jul/2015:14:37:41 +0300] <span class="hljs-string"><span class="hljs-string">"POST /components/com_weblinks/views/categories/system.php HTTP/1.1"</span></span> 404 2056 <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-string"><span class="hljs-string">"Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.7.6)"</span></span></code> </pre><br><br>  Very interesting!  Some file <b>system.php</b> .  There was a POST request, so the request parameters are not visible in the address.  The name is very suspicious.  Once in my childhood I also had such a directory on my home computer :-) <br><br>  See the file itself: <br><br><img src="https://habrastorage.org/files/d7e/6b4/a5b/d7e6b4a5b15842c69889a8adfaf18d91.png"><br><br>  Clear!  Enemy found.  We change the name of the file and silence comes again in the Exim logs.  Finally, you can touch the food, which the future wife put about 10 minutes ago :-) <br><br>  Next will be the interrogation of the prisoner: <br><br>  - how did you get to the server? <br>  - Are there any accomplices on other sites / directories? <br><br>  And also you need to understand on our territory: <br><br>  - check permissions to folders <br>  - except for automatic check of free space, set up a free inode check. <br>  - configure Exim (for example, block SMTP). <br><br>  Probably something else is needed.  I will be glad to comments / corrections / stories from your practice. <br><br>  I hope someone will find this article useful. <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/263933/">https://habr.com/ru/post/263933/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263919/index.html">Gadgets as a source of constant distractions</a></li>
<li><a href="../263925/index.html">"Mindless" use of fonts</a></li>
<li><a href="../263927/index.html">Xamarin courses in Ciklum Interactive, Dnepropetrovsk</a></li>
<li><a href="../263929/index.html">Digest: VR and AR</a></li>
<li><a href="../263931/index.html">Sampling schemes</a></li>
<li><a href="../263935/index.html">Familiarity with the internal structure of the .NET Framework. Let's see how the CLR creates objects.</a></li>
<li><a href="../263939/index.html">How we spent a couple of days working on Perl acceleration</a></li>
<li><a href="../263943/index.html">Channel Status Protocols and Single-Zone OSPF (Part 1)</a></li>
<li><a href="../263945/index.html">The story of one clone</a></li>
<li><a href="../263947/index.html">Visualization of static and dynamic networks on R, part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>