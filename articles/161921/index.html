<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The story of one Crash, and NSLog who treated him</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I treat Crash'and NSLog'ami. Inexpensive. Years of experience. 100% guaranteed. 

 Approximately this title could describe what happened three and a h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The story of one Crash, and NSLog who treated him</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  <i>I treat Crash'and NSLog'ami.</i>  <i>Inexpensive.</i>  <i>Years of experience.</i>  <i>100% guaranteed.</i> <br></blockquote><br>  Approximately this title could describe what happened three and a half months ago in one of my projects.  Or rather, it was not even my project, but I had to deal with the problem of crash. <br><br>  It all started with the fact that on one of the relatively large projects, an exception began to fall out steadily when a user is authorized.  "So what's wrong with that?"  Everybody has it.  A check for <i>nil</i> forgot to put or somewhere nakosyachili.  ‚ÄúAlso, me, a big event - crash on the project‚Äú, - most programmers will think <i>about it</i> .  In principle, I absolutely agree.  Crash is not such a rare occurrence in iPhone programming, and you come across it ten times a day.  But this one was special.  He was already beginning to smell magic, when I was told about some of his parameters and features: <br><br><ul><li>  <b>Reproducibility on the simulator</b> : 100% </li><li>  <b>Reproducibility on device</b> : 0% </li><li>  Crash path (after crash localization): ~ 40 seconds </li><li>  Optimization settings when compiling (-O1, -O2 ...) do not affect the reproducibility </li><li>  XIBs in the project are not used. </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Yes, he looked pretty harmless: <br><br><pre><code class="hljs pgsql">// Code UITextView * textView = [ [UITextView alloc] initWithFrame:CGRectMake(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">150</span></span>, _width, _height)]; // <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> *** Terminating app due <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> uncaught <span class="hljs-keyword"><span class="hljs-keyword">exception</span></span> <span class="hljs-string"><span class="hljs-string">'CALayerInvalidGeometry'</span></span>, reason: <span class="hljs-string"><span class="hljs-string">'CALayer bounds contains NaN: [0 0; nan 200]'</span></span></code> </pre> <br><br>  "Well, right there and the no-brainer is that <b>width</b> is after calculation ‚Äî NaN!", I thought. After a quick glance at where and how the width of the view is calculated, and not finding anything particularly dangerous, I, to assert my guess, put the <i>NSLog</i> before creating And in addition, and a breakpoint on the line with the creation of the element. <br><pre> <code class="hljs vhdl">// Source: NSLog(@<span class="hljs-string"><span class="hljs-string">"width = %f"</span></span>, _width); //Output: <span class="hljs-literal"><span class="hljs-literal">width</span></span> = <span class="hljs-number"><span class="hljs-number">200</span></span></code> </pre><br><br>  ‚ÄúUm,‚Äù I thought to myself, and continued the program after the breakpoint.  And crash did not happen ... <br><br><a name="habracut"></a><br><br><h4>  Test project that reproduces this Crash </h4><br>  For those people who are interested in looking at this beast themselves - I have a test project. <br>  Reproduced exclusively on iOS Simulator, SDK Version 5.1 (SDK 6+ does not play, but if there are good people who can play, write in a personal post) <br><br>  If you still think that something trivial is here, then calmly read on.  When we get to the interesting places, I‚Äôll stop and make a warning about spoilers. <br><br><h4>  What have I done? </h4><br>  If you think logically, then everything becomes clear.  Once crash disappeared, it was because I changed something (because before that the reproducibility was 100%).  The question remained only what <i>exactly had</i> changed. <br><br><ol><li>  I added some code before creating the view. </li><li>  I added NSLog </li><li>  I suspended the flow </li><li>  I accessed the _width class variable before passing it as a parameter </li><li>  .... </li></ol><br><blockquote>  If you still have ideas that I could change - you can write.  Then check if the guesses were correct.  But, most likely - hardly;) </blockquote><br><br>  All items are fairly easy to check.  I removed all the changes and started experimenting. <br><br><h6>  I suspended the flow </h6><br>  The idea here is quite simple.  Most likely - the error occurs due to multithreading. <br>  This was the easiest thing to check, I put a breakpoint without <i>NSLog</i> 'a.  The code continued to crash, with the same 100%. <br><br><h6>  I accessed the _width class variable or I added some code before creating the view </h6><br>  The idea of ‚Äã‚Äãthese points is in the "features" of code generation, which, miraculously, could lead to unintended consequences. <br>  No dances with a tambourine and additional, randomly generated, lines of code with access to the variable <b>_width</b> gave no result.  The application has fallen steadily. <br><br><h6>  I added NSLog </h6><br>  ‚ÄúNo, well, you're not serious, right?‚Äù <br>  It turned out seriously.  <i>NSLog</i> continued to "cure" crash.  Stable.  Regardless of the parameters passed to him.  Revealed more remarkable features.  The application continued to fall, even if you do not use <b>_width</b> , <b>_height</b> as parameters.  Without <i>NSLog,</i> any value passed to <i>- (id) initWithFrame:</i> caused the application to crash with the same error.  Among other things, it turned out that it is not at all necessary to put <i>NSLog</i> right before creating a view.  It can be put at the very beginning of the method where the view was created ... or in the method that caused this method ... or even in the method that caused the method that caused ... well, you understood, in general.  The main thing - to create. <br><br><h4>  Success! </h4><br>  That's it all over.  The problem was solved".  The blocker is eliminated, and nothing prevents you from quietly testing the application on the simulator.  And also, there was a lot of work that needed to be done, and I had to switch to it. <br><br><h4>  Is the problem solved? </h4><br>  This question gave me no rest for several evenings while I was finishing the main project.  Has the problem been resolved, or is the ‚Äúleech‚Äù with <i>NSLog</i> 'om simply removed the symptoms of some larger problem that lurked and waited for the project to go into release?  And then, when everyone forgets about it, and for its fixing, it will be necessary to wait a week for a submission in the AppStore, it will manifest itself and begin to break and crush everything, just not on the simulator anymore? <br><br><h4>  Magic? </h4><br>  On the one hand, I understood that the problem was in my code.  And, most likely, this is not a <i>UIKit</i> library <i>error</i> .  Familiar programmers, and said - look for the problem in your code.  And I agreed with them.  But how to find her?  The project is rather big, attempts to localize the problem in a few lines fail.  I wanted to quit, say "magic" and score.  And live with a sense of magic in the project.  But then, because if you know how magic works, all interest is lost, everything becomes ordinary, according to the documentation. <br><br>  Nevertheless, interest in the cause of the problem pereosilil, and I began to dig.  By this time, my ideas were spinning around the desire to understand: so what does <i>NSLog</i> do so interesting, and how does it ‚Äúcure‚Äù the fall of the program?  There were a lot of options both for me and in the local chat of developers.  In the end, it was agreed that the most likely cause of a <i>crash</i> is <i>stack</i> problems.  This position did not explain the reason for the stable operation of the devices, but it was necessary to start somewhere.  But before I began to look in the direction of the stack, I tried to understand where this <i>NaN</i> still occurs <i>?</i>  .  Just at that time, a <a href="https://habrahabr.ru/users/darkproger/" class="user_link">darkproger</a> friend <a href="https://habrahabr.ru/users/darkproger/" class="user_link">was</a> actively telling right and left how cool a <a href="http://dtrace.org/blogs/">dtrace</a> thing <a href="http://dtrace.org/blogs/">was</a> .  And after a few hours, with the help of this tool, I managed to slightly reduce the search for the cause of the fall. <br><br><h4>  Dtrace magic </h4><br>  At that time, all I had was <i>stacktrace</i> to the point of the fall.  The problem was somewhere inside it, well, or something led to the fact that all of this safely fell. <br><pre> <code class="hljs css"><span class="hljs-selector-id"><span class="hljs-selector-id">#4</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x01d8b04a</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">in</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[CALayer setBounds:]</span></span> () &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">----</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">NaN</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">lives</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">here</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#5</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x02d1d714</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">in</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">WebCore</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::TileGrid</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::updateHostLayerSize()</span></span> () <span class="hljs-selector-id"><span class="hljs-selector-id">#6</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x02d1af26</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">in</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">WebCore</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::TileCache</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">::TileCache(WAKWindow</span></span>*) () <span class="hljs-selector-id"><span class="hljs-selector-id">#7</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x02d52507</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">in</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[WAKWindow initWithLayer:]</span></span> () <span class="hljs-selector-id"><span class="hljs-selector-id">#8</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x002ee5e9</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">in</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[UIWebTiledView initWithFrame:]</span></span> () <span class="hljs-selector-id"><span class="hljs-selector-id">#9</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x001af9b5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">in</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[UIWebDocumentView initWithWebView:frame:]</span></span> () <span class="hljs-selector-id"><span class="hljs-selector-id">#10</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x001af89e</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">in</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[UIWebDocumentView initSimpleHTMLDocumentWithStyle:frame:preferences:groupName:]</span></span> () <span class="hljs-selector-id"><span class="hljs-selector-id">#11</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x0012cb6a</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">in</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[UITextView commonInitWithWebDocumentView:isDecoding:]</span></span> () <span class="hljs-selector-id"><span class="hljs-selector-id">#12</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x0012bf0e</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">in</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[UITextView initWithFrame:]</span></span> ()</code> </pre><br><br>  Using a relatively simple <a href="http://pastie.org/5500029">script for dtrace, we</a> managed to find out where the unfortunate <i>NaN</i> appears.  It turned out that the parameters are ‚Äúlost‚Äù right under the very end: <br><br><pre> <code class="hljs objectivec">QuartzCore`-[<span class="hljs-built_in"><span class="hljs-built_in">CALayer</span></span> setBounds :] &lt;------ (<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, NaN, height) WebCore`WebCore::TileGrid::updateHostLayerSize()+<span class="hljs-number"><span class="hljs-number">0x140</span></span> WebCore`WebCore::TileCache::TileCache(WAKWindow*)+<span class="hljs-number"><span class="hljs-number">0x1c6</span></span> WebCore`-[WAKWindow initWithLayer:]+<span class="hljs-number"><span class="hljs-number">0xd7</span></span> <span class="hljs-built_in"><span class="hljs-built_in">UIKit</span></span>`-[<span class="hljs-built_in"><span class="hljs-built_in">UIWebTiledView</span></span> initWithFrame:]+<span class="hljs-number"><span class="hljs-number">0xec</span></span> <span class="hljs-string"><span class="hljs-string">" &lt;------ (0, 0, width, height)"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">UIKit</span></span>`-[<span class="hljs-built_in"><span class="hljs-built_in">UIWebDocumentView</span></span> initWithWebView:frame:]+<span class="hljs-number"><span class="hljs-number">0xb5</span></span> <span class="hljs-built_in"><span class="hljs-built_in">UIKit</span></span>`-[<span class="hljs-built_in"><span class="hljs-built_in">UIWebDocumentView</span></span> initSimpleHTMLDocumentWithStyle:frame:preferences:groupName:]+<span class="hljs-number"><span class="hljs-number">0xfe</span></span> <span class="hljs-built_in"><span class="hljs-built_in">UIKit</span></span>`-[<span class="hljs-built_in"><span class="hljs-built_in">UITextView</span></span> commonInitWithWebDocumentView:isDecoding:]+<span class="hljs-number"><span class="hljs-number">0x198</span></span> <span class="hljs-built_in"><span class="hljs-built_in">UIKit</span></span>`-[<span class="hljs-built_in"><span class="hljs-built_in">UITextView</span></span> initWithFrame:]+<span class="hljs-number"><span class="hljs-number">0x70</span></span> <span class="hljs-string"><span class="hljs-string">" &lt;------ (0, 0, width, height)"</span></span></code> </pre><br><br>  What to do?  Apparently the problem is not in our code!  With a heightened sense of self-importance, I'm already preparing to send a bug report to Apple.  And still climb to watch how the <i>stack</i> is doing there. <br><br><h4>  Spoiler alert! </h4>  If you are still going to solve this problem yourself, then it's time to stop reading this article;) <br>  For those who are going to sort it out themselves, and thinks that the problems lie in working with the stack, or vice versa, they think that the problems are not related to the stack at all, a small spoiler <div class="spoiler">  <b class="spoiler_title">Do not read me!</b> <div class="spoiler_text">  The problem is not related to the stack * </div></div><br><br><h4>  Stack troubles? </h4><br>  How in Xcode to see what is currently going on in the stack?  What parameters are passed to the function?  How are they transmitted and by what rules?  And through the stack? <br>  This is just a small part of the questions to which at that time I had no answers, but <a href="https://habrahabr.ru/users/darkproger/" class="user_link">darkproger</a> helped <a href="https://habrahabr.ru/users/darkproger/" class="user_link">again</a> (in general, Vova listened very diligently and patiently, or pretended to listen, all my delusional and not very good ideas of cause and effect;) , poking my nose in a very, very useful <a href="http://developer.apple.com/library/mac/">documentation</a> .  To be more specific, <a href="http://developer.apple.com/library/mac/">to a specific part of it</a> .  After a cursory reading of technouts, I was able to display the contents of the stack. <br><div style="text-align:center;"><img src="http://habrastorage.org/storage2/585/713/50f/58571350fa4aaf29627a9912a16452dd.png"></div><br>  However, these data did not help my understanding of what was happening.  The fact is that the stack was identical in both cases.  No difference.  All values ‚Äã‚Äãin the memory were exactly the same and the stack registers referenced the same memory addresses.  I checked several times, restarted the application, checked memory addresses ¬±.  It all matched. <br><br><h4>  What's next? </h4><br>  As I said, all the values ‚Äã‚Äãin the memory addresses match.  But something was still different.  Something was different.  True, the search for this "something" temporarily faded into the background - I found the unfortunate <i>NaN</i> . <br><br><img src="http://habrastorage.org/storage2/ba0/3f6/c39/ba03f6c3973cd375f9c698c11d4e9f4b.png"><br><br>  It was placed in one of the <b>st</b> registers of the FPU processor.  Since I did not know what the registers were, I had to get into the <a href="http://download.intel.com/products/processor/manual/325462.pdf">documentation from Intel</a> .  According to the documentation, the group of registers <b>st0-st7</b> is a cyclic stack for the FPU, through which the processor instructions are responsible for the operations with floating point.  Everything has become clear.  Someone puts the <i>NaN</i> value in the FPU stack, and then removes it as a result of the operation.  It remains to find only who does it. <br><br>  About an hour, I killed on a suddenly appeared piece of magic, which was explained by a simple "read the documentation carefully."  This magic manifested itself as follows.  ‚ÄúWrong‚Äù the <b>fstp</b> instruction worked (page 190).  The team should perform the following operations: Take the current value from the top of the FPU stack of <b>st0</b> , write it to the specified address (in my case, in <b>$ ebp-0x64</b> ), and push the value out of the FP stack. <br>  That's only after the execution of this instruction, at the address <b>$ ebp + 0x64 it</b> turned out to be 0, instead of the value 320 I need. <br><br>  Before executing the <b>fstp</b> command <br><div style="text-align:center;"><img src="http://habrastorage.org/storage2/bc4/dd7/ced/bc4dd7cedbf6a10057974fd3430ff3e4.png"></div><br><br>  After executing the <b>fstp</b> command <br><div style="text-align:center;"><img src="http://habrastorage.org/storage2/84a/555/18d/84a55518d8f51b658d09dc76cf6c7571.png"></div><br><br>  Attentive experts probably already see the problem.  Those who want to verify this behavior themselves - you can download a test project and put a breakpoint on the <i>WebCore :: TileGrid :: updateHostLayerSize ()</i> function.  Inside it is easy enough to find the desired piece.  Who is just interested in the reason for my provtyk - feel free to open the spoiler. <br><div class="spoiler">  <b class="spoiler_title">And $ ebp-0x64, they say, is not real!</b> <div class="spoiler_text">  The reason is data types.  The <b>fstp</b> command writes a 40-bit floating point chilso into memory, which is commonly referred to in the common people as <b>long double</b> .  In this example, in the debugger, I look at the correct address, only I‚Äôm showing not <b>40</b> bits, but <b>32</b> bits.  Everything fell into place when I indicated the correct data type.  An error that cost me an hour and a half of search might not have occurred if I had read the documentation more carefully.  Moral: read the documentation.  It is useful and saves time. <br></div></div><br><br><h4>  Stack overflow? </h4><br>  After I figured out with <b>fstp</b> , and <b>fld</b> .  I began to look for differences again.  And since I already knew that the reason was not related to the stack, I concentrated on the values ‚Äã‚Äãof the processor registers.  And here there were differences.  And it even became clear where <i>NaN</i> comes from.  At first I looked at the <b>$ ftag register</b> , the value of which immediately told me about the presence of something bad in the FPU stack registers (page 182). <br><div style="text-align:center;"><img src="http://habrastorage.org/storage2/937/907/24f/93790724f9ddcfde2e5b315c79ddb3eb.png"></div><br><br>  This could, of course, be observed just by looking at <b>$ st0- $ st7</b> , but <b>$ ftag</b> lets you know what state the registers are at the moment - which are used, which are busy, and which are empty.  In the example you can see that all the registers are occupied (valid), and only one of them has something special. <br><br>  But finally, all the questions about magic disappeared when I saw the values ‚Äã‚Äãof the <b>$ fstat</b> register (x87 FPU Status Register, page 178). <br><br><img src="http://habrastorage.org/storage2/5ee/e8a/30c/5eee8a30c1d108ac7704b761e3834faf.png"><br><br><h4>  Stack overflow </h4><br>  Stack overflow in FPU processor registers.  In fact, the stack overflow itself does not cause any exceptions, and only puts a flag in the control word that an exception has occurred. <br><blockquote>  If it is not valid, it is not necessary to know whether it was a funeral or a rule.  This is the override instruction. </blockquote><br>  But, if we use the value of the register with the invalid state, we get <i>NaN</i> , which, once in memory, comes as a parameter when creating <i>CALayer</i> 'a. <br><br>  So, I descended to the lowest level of the problem.  I knew exactly where the magic <i>NaNs</i> appear in the program, and about stack overflow in FPU stack registers.  That's just the answer, where and when it happens, I did not have.  The idea was born again in my head that this fits <i>UIKit</i> , but you can‚Äôt make a claim without proof.  On the other hand, I had no idea how the code could trigger FPU Stack Overflow (the existence of which I learned that day). <br><br><h4>  Culprit </h4><br>  For a relatively short time, the function that was responsible for everything that happened was localized.  Here it is, the culprit of all that is happening! <br><pre> <code class="hljs smalltalk">// <span class="hljs-type"><span class="hljs-type">ACLabel</span></span> : <span class="hljs-type"><span class="hljs-type">UILabel</span></span> - (<span class="hljs-type"><span class="hljs-type">CGFloat</span></span>)resizeToContents { <span class="hljs-type"><span class="hljs-type">CGSize</span></span> size = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.text sizeWithFont:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.font forWidth:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.frame.size.width lineBreakMode:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.lineBreakMode]; <span class="hljs-type"><span class="hljs-type">CGRect</span></span> oldFrame = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.frame; oldFrame.size.height = size.height; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.frame = oldFrame; return size.height; }</code> </pre><br><br>  Trying to find something scary?  Try.  I tried too.  Long and tedious.  Rewrote a method, rename, make a category.  And all in vain.  It was this method that left trash in the FPU Stack.  Moreover, magic has acquired a new form.  The same method left the garbage in the stack through time.  That is, the ‚Äúsometimes‚Äù method normally ‚Äúremoved‚Äù the value from the top of the stack, and sometimes it completely forgot about it, and ignored it, thereby bringing the crash closer.  So what's wrong with this code? <br><br><blockquote>  It is a concept that it will be on the air.  In the case of the returning of the corrected state, it should be noted. </blockquote><br><br>  ‚ÄúHow can I feel better about this!‚Äù (Sarcasm).  Now the vector of guilt has shifted smoothly from <i>UIKit</i> 'to the compiler again.  After all, he must remove the value from the FPU stack!  Should, but does not.  Rather makes ... but not always.  So when? <br><br><h4>  One step to win </h4><br>  And I will answer you this question.  But first, I have a small question: ‚ÄúAre the lines given in the example identical?‚Äù <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/     /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  ‚Ññ1 [obj someMethod]; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  ‚Ññ2 [obj perfromSelector:@selector(someMethod)];</span></span></code> </pre><br>  A simple question like that.  He is even asked during interviews.  And you can't even say right away that they can work in different ways.  After all, in fact, this is the same thing, just a side view.  However, the example is greatly simplified due to the absence of the fact that these methods are returned.  It is understood that they return <i>void</i> .  And if methods returned <i>id</i> , or <i>int</i> or <i>float</i> .  Would anything change? <br>  While you are thinking about the answer to the question, I will give a short extract from the documentation: <br><blockquote>  The method is equivalent to the receiver.  For example, all the same thing: </blockquote><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">id</span></span> myClone = [anObject <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> myClone = [anObject performSelector:<span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>)]; <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> myClone = [anObject performSelector:sel_getUid(<span class="hljs-string"><span class="hljs-string">"copy"</span></span>)];</code> </pre><br><blockquote>  .  For methods that return anything other than an object, use NSInvocation. </blockquote><br><br>  When the hook is in bold, then, of course, it is noticed.  The documentation quite clearly hints that if a method should suddenly return something other than <i>id</i> , we need to use <i>NSInvocation</i> .  But I will say that even if you return a non-object, then everything works.  It worked, anyway.  Until that ill-fated day. <br><br><h4>  Profit </h4><br>  Perhaps many have already guessed what is happening here.  Everything is quite simple (especially after reading the article, well, or two and a half days of games with dtrace, debugger, digging into the documentation, and so on). <br><br><ol><li>  The compiler sees the method that the <b>float</b> should return, and regularly generates code that, after calling the method, removes the returned value from the FPU stack. <br></li><li>  In the case of using the <i>performSelector</i> method, the compiler does not know what the method returns, so it hopes that the programmer is conscientious - he believes that the method will return <i>id</i> . <br></li><li>  If the code uses <i>performSelector</i> for the method that should return a <b>float</b> (even if you do not use the returned result), then the compiler does not know that you need to remove the returned value from the FPU stack.  So, with each call to the <i>return-float method</i> via the <i>performSelector</i> , one of the registers of the FPU stack is ‚Äúclogged‚Äù. <br></li><li>  After eight such calls (8 st-registers), the processor will set a flag stating that the stack is full, and some normal floating-point operations begin to return <i>NaN</i> as a result.  This, in turn, leads to anything.  To the extent that a dinosaur can run behind your back. <br></li></ol><br><br>  <b>Moral</b> : Read the documentation carefully.  If something works contrary to the documentation - do not really find that it does not entail major problems. <br><br><h4>  NSLog </h4><br>  ‚ÄúHey, hey, so what about NSLog?  Why does NSLog ‚Äúcure‚Äù this problem? ‚Äù <br>  <i>NSLog</i> uses floating point operations for its work.  Moreover, by typing, it was established that for his work two registers are needed in the FPU stack.  And the FPU stack, in the case of full filling, sets the appropriate overflow flag.  And during an operation that removes the value from the stack, it marks one of the registers of the stack as ‚Äúfree to use‚Äù. <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/ Tag word (state of st0 - st7 registers) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 00 - Used /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 10 - Invalid /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 11 - Unused /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ before NSLog st0 st1 st2 st3 st4 st5 st6 st7 10 00 00 00 00 00 00 00 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ After NSLog st0 st1 st2 st3 st4 st5 st6 st7 11 11 00 00 00 00 00 00</span></span></code> </pre><br><br>  In this way, the state Invalid disappears from the <b>st0</b> register, because of this, no one gets <i>NaN</i> when trying to take a value from it, and does not pass it on as a parameter to the <i>UITextView</i> . <br><br>  So, <i>NSLog</i> does not cure the problem.  He gives her to live a little longer, postponing the death of the application until the time codenamed "Suddenly." <br><br>  Here is such a "magic".  Now you can safely write in your resume line <br><blockquote>  I treat Crash'and NSLog'ami.  Inexpensive.  Years of experience.  100% guaranteed. </blockquote><br><br>  I hope it was not only interesting, but also in some places - informative. <br><br>  PS Thanks again <a href="https://habrahabr.ru/users/darkproger/" class="user_link">darkproger</a> and <a href="https://habrahabr.ru/users/vixentael/" class="user_link">vixentael</a> for helping and listening to my stream of thoughts. </div><p>Source: <a href="https://habr.com/ru/post/161921/">https://habr.com/ru/post/161921/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../161901/index.html">The greatness of the universe in numbers, and a little in pictures</a></li>
<li><a href="../161903/index.html">Courses of information technology from the company Yandex. Season 3 video</a></li>
<li><a href="../161907/index.html">Guido van Rossum transferred from Google to Dropbox</a></li>
<li><a href="../161909/index.html">Smartphones and business</a></li>
<li><a href="../161911/index.html">What language do you think is preferable for developing web applications?</a></li>
<li><a href="../161923/index.html">Adaptive speakers</a></li>
<li><a href="../161931/index.html">We are friends of Python 3 with MS Visual C ++. Build bridge in Boost.Python with automatic transcoding</a></li>
<li><a href="../161935/index.html">About censorship and methods of dealing with the Forbidden Registry</a></li>
<li><a href="../161939/index.html">Course lectures "Startup". Peter Thiel. Stanford 2012. Session 9</a></li>
<li><a href="../161941/index.html">Techniques and tools parallax</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>