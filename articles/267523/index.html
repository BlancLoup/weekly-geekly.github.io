<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Setting up sending email notifications in Zabbix on CentOS 7</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It seems to be not the newest task. And articles in Google cart and a small cart. But for some reason, it took me almost a week for all the experiment...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Setting up sending email notifications in Zabbix on CentOS 7</h1><div class="post__text post__text-html js-mediator-article">  It seems to be not the newest task.  And articles in Google cart and a small cart.  But for some reason, it took me almost a week for all the experiments and trampling on every possible rake. <br><br>  So, the task: CentOS 7 server, LEMP package installed, Zabbix 2.4.6 server installed.  It is necessary to configure sending notifications to admins by mail. <br><br>  Disclaimer - CentOS was put on the method of "sex and again sex" - minimal installations.  In view of this, some ‚Äúdue out of the box‚Äù packages do not work, because no one has delivered them yet. <br><a name="habracut"></a><br>  After smoking a number of manuals, it became clear that in order to send mail, we need, at a minimum, a mail strip that can use SMTP with authorization and a script for Zabbix. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As an e-mail client, we use ssmtp. <br><br><pre><code class="bash hljs">yum install ssmtp</code> </pre> <br>  Then in /etc/ssmtp/ssmtp.conf <br><br><pre> <code class="bash hljs">root=mailbox@mail.server <span class="hljs-comment"><span class="hljs-comment">#  zabbixa mailhub=smtp.mail.server #  TLS,     ":465" rewriteDomain=mail.server AuthUser=mail_username AuthPass=mail_password FromLineOverride=YES #UseTLS=YES #  TLS   </span></span></code> </pre><br>  Then there was an attempt to set ssmtp as a substitute for sendmail and use the mail command (mailx package) to send mail, but the letters, although they came, were not readable (the text did not come in the text field, but as a binary attachment). <br><br>  As a result, had to put mutt, as a replacement for mail. <br><br><pre> <code class="bash hljs">yum install mutt</code> </pre><br>  See where we have the zabbix user's home directory: <br><br><pre> <code class="bash hljs">getent passwd zabbix zabbix:x:997:996:Zabbix Monitoring System:/var/lib/zabbix:/bin/bash</code> </pre><br>  Then we create the mutt settings file in the zabbix home directory. <br><br><pre> <code class="bash hljs">touch /var/lib/zabbix/.muttrc <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> from=<span class="hljs-string"><span class="hljs-string">"mailbox@mail.server"</span></span> &gt;&gt; /var/lib/zabbix/.muttrc <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> realname =<span class="hljs-string"><span class="hljs-string">"My Zabbix Monitoring"</span></span> &gt;&gt; /var/lib/zabbix/.muttrc <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> sendmail=<span class="hljs-string"><span class="hljs-string">"/usr/sbin/ssmtp"</span></span> &gt;&gt; /var/lib/zabbix/.muttrc <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> charset=<span class="hljs-string"><span class="hljs-string">"utf-8"</span></span> &gt;&gt; /var/lib/zabbix/.muttrc <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> copy=no &gt;&gt; /var/lib/zabbix/.muttrc chown zabbix:zabbix /var/lib/zabbix/.muttrc</code> </pre><br>  Now you need to write a script to send mail and put it in / usr / lib / zabbix / alertscripts.  Let the script name be: send_mail.sh: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash to=$1 subject=$2 body=$3 echo `date`" mail sended to:" $to &gt;&gt; /var/log/zabmail.log #      echo `date`" mail subj:" $subject &gt;&gt; /var/log/zabmail.log #      echo `date`" mail text:" $body &gt;&gt; /var/log/zabmail.log #      echo $body | mutt -s "$subject" "$to"</span></span></code> </pre><br>  Now setting up the zabbix itself.  In the Web interface: Administration - Alert Methods - Email <br><br><blockquote>  Type: Script <br>  Script name: send_mail.sh <br>  Activated: Yes (cheked) </blockquote><br><br>  Checking the zabbix config (/etc/zabbix/zabbix_server.conf) <br><br><pre> <code class="bash hljs">AlertScriptsPath=/usr/lib/zabbix/alertscripts</code> </pre><br>  Restart zabbix server: <br><br><pre> <code class="bash hljs">service zabbix-server restart</code> </pre><br>  And so, if we, in violation of all the guidelines, have disabled SELinux, everything works and alerts go. <br><br>  However, <b>with SELinux enabled, there were no letters and no</b> .  We proceed to the training of SELinux.  To speed up further configuration, it is convenient to start some kind of trigger, to which we can easily and often change the state (I didn‚Äôt bother and used the server reboot from zabbix, because I haven‚Äôt had any other loads on this virtual machine yet).  To perform the SELinux setup, you will need only 4 steps, but they will have to be repeated as many times as required in your system (it took me 5 or 6 iterations). <br><br>  For personal "convenience", I collected the allowing rules not into one file of the SELinux module, but into a separate file for each iteration, so that you could take a closer look at their contents.  Therefore, the module name was used according to the ZabSeModuleN scheme, where N at the end of the file name is the iteration number, the result is a group of files ZabSeModule1.te, ZabSeModule1.mod, ZabSeModule1.pp, ZabSeModule2.te, ZabSeModule2.mod, ZabSeModule2.pp, etc. . <br><br>  ‚Ä¢ ausearch -m avc -ts today <br>  If the output is different from - perform the steps below. <br>  ‚Ä¢ cat /var/log/audit/audit.log |  audit2allow -m ZabSeModuleN&gt; ZabSeModuleN.te <br>  ‚Ä¢ checkmodule -M -m -o ZabSeModuleN.mod ZabSeModuleN.te <br>  ‚Ä¢ semodule_package -o ZabSeModuleN.pp -m ZabSeModuleN.mod <br>  ‚Ä¢ semodule -i ZabSeModuleN.pp <br>  ‚Ä¢ rm /var/log/audit/audit.log <br>  ‚Ä¢ reboot <br><br>  Reboot only method to trigger the trigger "Zabbix server restarted" <br><br>  For lovers of the order - after receiving a complete list of SELinux rules, they can be assembled into one .te file, and, removing previous modules from the system, create and install one new one. <br><br>  Based on the result of alerts from Zabbix, they walk regularly and with pleasure. <br><br>  In the process of setting up, articles were honestly used: <br>  <a href="http://www.lissyara.su/%3Fid%3D2202">Lissyar - 'Problem Solving' or 'Linux Tinkering - 2' (c) Fomalhaut</a> <br>  <a href="http://www.denvo.ru/pub/admin/selinux-security-editing.html">Denis Volkov - Setting SELinux Security Policies</a> <br>  <a href="http://skill-admin.blogspot.ru/2012/12/zabbix-4-email-2-zabbix-gmail.html">NetSkills - Zabbix.</a>  <a href="http://skill-admin.blogspot.ru/2012/12/zabbix-4-email-2-zabbix-gmail.html">Video lesson number 4.</a>  <a href="http://skill-admin.blogspot.ru/2012/12/zabbix-4-email-2-zabbix-gmail.html">Set up email alerts.</a>  <a href="http://skill-admin.blogspot.ru/2012/12/zabbix-4-email-2-zabbix-gmail.html">Part 2 (zabbix gmail)</a> <br></div><p>Source: <a href="https://habr.com/ru/post/267523/">https://habr.com/ru/post/267523/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../267511/index.html">Yandeks.Blogi - we will think for you</a></li>
<li><a href="../267513/index.html">Matreshka.js 2: events</a></li>
<li><a href="../267515/index.html">C # attributes and types</a></li>
<li><a href="../267517/index.html">JetBrains have published updates to the new licensing and pricing policy.</a></li>
<li><a href="../267519/index.html">Adaptive video as a background site caps</a></li>
<li><a href="../267525/index.html">From Euroset to game design or 5 beginner's mistakes</a></li>
<li><a href="../267527/index.html">Revolution on the threshold or another niche for "people in the subject"?</a></li>
<li><a href="../267533/index.html">Brotli - Google's new web data compression algorithm</a></li>
<li><a href="../267535/index.html">Make all the symbols of the Linux kernel available. Part 1</a></li>
<li><a href="../267537/index.html">Registration for the SQLSaturday conference on October 17 is open</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>