<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Modification of stock firmware for Android. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello Habr! 

 After writing the first part , throughout the week I was pondering whether to write about what I promised or at the request of some rea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Modification of stock firmware for Android. Part 2</h1><div class="post__text post__text-html js-mediator-article">  Hello Habr! <br><br>  After writing the <a href="http://habrahabr.ru/post/181826/">first part</a> , throughout the week I was pondering whether to write about what I promised or at the request of some readers to give explanations and explanations about some, in my opinion basic, things. <br>  I would not want to, but some of you will have to be upset.  I don‚Äôt like to write copy-paste the most, and I‚Äôll make a lot of links to different resources from the article. <br><br>  For example, describing how Android downloads in this article would be inappropriate.  If you know the principle of initializing the hardware of your computer in the BIOS, and then loading it through the kernel of the system, then Android is no different in this regard.  The only difference is in processor architecture.  File system structure?  Well, gentlemen, this is a clean UNIX system, and writing where and how is stored is absurd!  Edit build.prop is system tuning.  Yes, this is a modification, but most of these parameters can be made third-party applications, and more convenient to use, such as <a href="https://play.google.com/store/apps/details%3Fid%3Dccc71.pmw%26hl%3Dru">System Tuner</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It took me a couple of months to understand the very principles of the Android system, it will take as much time and write articles to cover all the basic things.  So let's better write about specific examples of how to parse the Dalvik code and create ‚Äúuse‚Äù conveniences on the phone. <br><br>  And so, let's go!  Today I will tell you how I implemented the functionality of automatic recording of telephone conversations by native means. <br><a name="habracut"></a><br><h4>  Preamble </h4><br>  The legislation of some countries prohibits the recording of telephone conversations by technical means.  For example, in the United States it is prohibited to record personal telephone conversations without prior consent of the parties.  And in our post-Soviet space it is allowed to record a conversation in which you are one of the parties, without warning the other participants in the conversation.  In the same China, a record is simply simply welcomed and ‚Äúknocking‚Äù on a neighbor is an ideological principle.  And this applies not only to records of conversations.  The use of the Internet, sending SMS messages, the use of social networks, encryption algorithms, phones with two SIM cards and much more are also individually regulated by the legislation of different countries.  Now imagine that you are a business owner and export your IT products around the world.  Of course, you will ‚Äúwrite‚Äù your software in one branch, not several, but the configurations will differ from region to region.  For the CIS countries one thing, for Europe - another.  Also phone manufacturers are coming.  The Android operating system is being finalized by only one group of programmers and into the main branch, and for each region, specific configuration files are used to compile the final releases.  I say this with confidence, since I worked at one time with one of the vendors. <br><br>  As proof of this, there is a good <a href="http://forum.xda-developers.com/showthread.php%3Ft%3D1222746">guide on</a> how to port the firmware to someone else's device. <br><br><h4>  Go! </h4><br>  Reading the disassembled Java code Phone.apk, I accidentally stumbled upon an entertaining flag.  There is actually a lot of interesting, but hidden functionality from us.  Literally today I discovered that on my phone there are parameters for the Japanese operator <a href="http://ru.wikipedia.org/wiki/KDDI">KDDI</a> .  A specially crafted SMS message from the provider can cause my phone to sound heart-rending and vibrating for several minutes in the event of an earthquake or tsunami.  But back to our flag. <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> IS_INCALL_RECORDING_ENABLE = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;</code> </pre> <br>  Interesting, I thought.  If there is such a flag, then it is used somewhere.  But where - not clear.  However, I suggested that the call recording button should appear during a call.  Things are easy!  I changed FALSE to TRUE, re-recorded the patched Phone.apk, called my home phone, picked up the phone and saw the ‚ÄúStart Recording‚Äù button.  But before it was not !!! <br> <a href=""><img src="https://habrastorage.org/cropped2/e4c/01d/092/e4c01d0921f73029935a914ec212de61.png"></a> <br><br>  Once again I will tell you how to do such things for the assimilation of the material: <br><br><ol><li>  Create a hotel folder and put there the Phone.apk file and to it <a href="https://code.google.com/p/smali/downloads/detail%3Fname%3Dsmali">smali</a> and <a href="https://code.google.com/p/smali/downloads/detail%3Fname%3Dbaksmali">backsmali</a> </li><li>  Rattle the file to parse the Dalvik code with the <code><code><code>java -Xmx512m -jar baksmali.jar -a -d -o Phone -x Phone.apk <br> <br> ‚Äî  API   Android.  JB ‚Äî  16 <br> ‚Äî ,     . <br>     ,     Phone\com\android\phone\util\VoiceRecorderHelper.smali <br> </code></code></code> command <code><code><code>java -Xmx512m -jar baksmali.jar -a -d -o Phone -x Phone.apk <br> <br> ‚Äî  API   Android.  JB ‚Äî  16 <br> ‚Äî ,     . <br>     ,     Phone\com\android\phone\util\VoiceRecorderHelper.smali <br> </code></code></code> <code><code><code>java -Xmx512m -jar baksmali.jar -a -d -o Phone -x Phone.apk <br> <br> ‚Äî  API   Android.  JB ‚Äî  16 <br> ‚Äî ,     .</code> <br>     ,     Phone\com\android\phone\util\VoiceRecorderHelper.smali <br> </code></code> <pre> <code class="java hljs">.field <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> IS_INCALL_RECORDING_ENABLE:Z = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span></code> </pre>  on <pre> <code class="java hljs">.field <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> IS_INCALL_RECORDING_ENABLE:Z = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> </pre><br>  Putting our file back: <code>java -Xmx512m -jar smali.jar -a 16 Phone -o classes.dex</code> <br>  Replace the received classes.dex in the original file with any archiver <br>  Overwrite Phone.apk in phone <br><br>  Having tested the recording of several calls, I found that the phone records conversations with a standard built-in voice recorder and is in very, very good quality.  The file name is generated automatically and contains the number or name of the interlocutor, as well as the date and duration of the call.  The file saving format can also be configured in the native application.  And why do you ask me do I need these call records? <br><br>  Well, firstly, it is very convenient.  I called my spouse and told a list of products to buy, but there is nowhere to record it, then a voice recorder will help. <br>  Secondly, on the phone I have to talk with customers and customers, and sometimes the necessary and important information can slip away or be not heard.  Or, for example, an important conversation took place, which needs to be heard and analyzed, and timely decisions made or actions taken together with a business partner or someone else. <br>  Thirdly, a very convenient evidence base in work and life. <br><br>  You can also ask, why not use third-party applications, of which there are many open and free access? <br><ul><li>  I do not trust third-party and not proven applications.  Often, because of them the battery sits down, as each such application hangs constantly in the phone‚Äôs memory and eats processor time. </li><li>  The quality of the recording does not always match the promise. </li><li>  I'm picky about the interface.  The application may be rich in functionality, but if the GUI is not convenient for me, I will not use it.  This is a limp of many domestic developments, unfortunately. </li></ul><br><h4>  How does this even work? </h4><br>  All Android developers know that the system is full of various standard broadcast messages.  Whatever happens in the system, any application can receive it, if you implement "your" recipient of such a message.  You can make your own broadcast messages, only the recipient of this message will be the application itself or the entire application that you have made yourself, and they somehow process this message.  I saw this in practice in GoDialer and GoSMSPro. <br><br>  Third-party call recording applications work in the same way.  As soon as the message has passed that the call has been established, the recording starts.  As soon as the call has stopped, the recording stops and the buffer is written to the file. <br><br>  My task was to find the place where this message is formed or processed and <u>force</u> recording of the call without any extra movements.  After all, it often happens that either you forget to turn on or simply do not have time.  How to find the right place in the ton of the firmware code in general is the topic of the next article, but for now let's move on to ‚Äúour place‚Äù. <br><br>  The processor, or rather two, were in the file \ com \ android \ phone \ CallNotifier.java <br><br>  The decompiled code (only part of the code is shown here) from Dalvik to Java was as follows: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCallConnected</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AsyncResult paramAsyncResult)</span></span></span><span class="hljs-function"> </span></span>{ Connection localConnection = (Connection)paramAsyncResult.result; String str = ((IfConnection)localConnection).getDialString(); VLog.d(<span class="hljs-string"><span class="hljs-string">"onCallConnected() dialed number:"</span></span> + str); removeMessages(<span class="hljs-number"><span class="hljs-number">120000</span></span>); removeMessages(<span class="hljs-number"><span class="hljs-number">120001</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mIsEccNeedRetry = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mEccIsSwitchingForRetrying = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    }</span></span></code> </pre>  and <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDisconnect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AsyncResult paramAsyncResult)</span></span></span><span class="hljs-function"> </span></span>{ Phone.State localState = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mCM.getState(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (CallNotifier.VDBG) <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.log(<span class="hljs-string"><span class="hljs-string">"onDisconnect()... CallManager state: "</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.mCM.getState()); VLog.d(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"onDisconnect()"</span></span>); removeMessages(<span class="hljs-number"><span class="hljs-number">120000</span></span>); removeMessages(<span class="hljs-number"><span class="hljs-number">120001</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    }</span></span></code> </pre><br>  The task is complicated compared to the previous article.  If last time we had to fix a simple function, then here we will not be able to fix it, since we do not have the source code to rewrite it.  Here we need to implant our code. <br><br><h4>  What is Dalvik? </h4><br>  This is briefly written <a href="http://ru.wikipedia.org/wiki/Dalvik_virtual_machine">here</a> and <a href="http://android-shark.ru/virtualnaya-mashina-dalvik/">here</a> .  Speaking in an even simpler language - the byte code of the virtual machine is based on registers (allocated memory for operating variables) and a set of instructions and operators.  The meaning and principle of operation is quite simple: you write down some value in the register and then perform operations on it, returning the result of the operation to where you applied for action.  More details about all operators and instructions can be found here: <a href="http://s.android.com/tech/dalvik/dalvik-bytecode.html">Bytecode for the Dalvik VM</a> . <br><br><h4>  We implant our code </h4><br>  In order to enter something, we need to know what to write there.  You can lick the code from the "Start Write" button handler. <br>  Find where the handler is stored, even for novice programmers for Android, it is not difficult.  We will later return to what and how to look for in future articles.  The essence of the first articles to explain the principles. <br><br>  When the button is pressed, the following code is triggered: <br><pre> <code class="java hljs"> VoiceRecorderHelper localVoiceRecorderHelper = VoiceRecorderHelper.getInstance(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!localVoiceRecorderHelper.isRecording()) { localVoiceRecorderHelper.start(); }</code> </pre>  That is, to automate the recording of all calls, you need to add this code to the onCallConnected handler. <br><br>  Dalvik code for this entry looks like <br><br><pre> <code class="java hljs"> invoke-<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> {}, Lcom/android/phone/util/VoiceRecorderHelper;-&gt;getInstance()Lcom/android/phone/util/VoiceRecorderHelper; move-result-object v1 invoke-virtual/range {v1 .. v1}, Lcom/android/phone/util/VoiceRecorderHelper;-&gt;isRecording()Z move-result v2 <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>/<span class="hljs-number"><span class="hljs-number">4</span></span> v3, <span class="hljs-number"><span class="hljs-number">0x0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-ne v3, v2, :cond_a9 invoke-virtual/range {v1 .. v1}, Lcom/android/phone/util/VoiceRecorderHelper;-&gt;start()Z :cond_a9</code> </pre><br>  Let's sort the code line by line: <br><ol><li>  invoke-static invokes an instance of the VoiceRecorderHelper class </li><li>  save the instance in the register v1 </li><li>  call a method of this class called isRecording, which returns true or false </li><li>  The result is written to the register v2. </li><li>  Write to the register v3 value 0 </li><li>  Make a comparison between the two registers v2 and v3.  Logic: v2! = V3.  If isRecording returns TRUE, then v2 will have the value 1 and if FALSE, then vice versa.  If the condition does NOT work, then jump to the cond_a9 marker.  If not, then </li><li>  The start method of the class instance is called, which is stored in v1 </li><li>  Our conversation began to be recorded. </li></ol><br><br>  Go back to our onCallConnected.  Its dalvik code looks like this: <br><pre> <code class="java hljs">.<span class="hljs-function"><span class="hljs-function">method </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCallConnected</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Landroid/os/AsyncResult;)</span></span></span><span class="hljs-function">V .registers 8 .parameter "r" .prologue .line 2302 iget-object v0, p1, Landroid/os/AsyncResult</span></span>;-&gt;result:Ljava/lang/Object; check-cast v0, Lcom/android/internal/telephony/Connection; .local v0, c:Lcom/android/internal/telephony/Connection; move-object v2, v0</code> </pre><br>  Let us also analyze this code so that it is clear what is related to <br><br><ul><li>  <code>.registers 8</code> - the number of memory registers needed and used for this function </li><li>  <code>parameter "r"</code> is the name of the parameter that was used in the source code.  It rarely interests us. </li><li>  <code>prologue</code> - the beginning of the function algorithm </li><li>  <code>.line 2302</code> - line number in the source code.  This is for debugging only. </li><li> <code>iget-object v0, p1, Landroid/os/AsyncResult;-&gt;result:Ljava/lang/Object;</code>  the next line matches <code>(Connection)paramAsyncResult.result;</code> </li><li> <code>check-cast v0, Lcom/android/internal/telephony/Connection;</code>  corresponds to <code>Connection</code> </li><li> <code>.local v0, c:Lcom/android/internal/telephony/Connection;</code>  matches <code>localConnection</code> </li><li>  <code>move-object v2, v0</code> - cloning a local variable v0 into the register v2 </li><li>  etc. </li></ul><br>  Parse the code is not so difficult if you refer to the description and compare with Java code. <br><br>  It would seem that we only need to copy the code from the button click handler and paste it into the beginning of our call handler and that‚Äôs it.  It was not there.  Sometimes it works, but mostly not.  The fact is that the registers where we write the data can be used in the further program code and if at the beginning we take the wrong register and write something into it, then during the execution of the program errors can get out and the entire algorithm breaks.  Our case is simple in that we enter functions at the beginning and can use any registers that are not initialized at the beginning, because they will be overwritten later.  But often the code has to be implanted somewhere in the middle of the program and you need to be careful with registers.  About this, too, in future articles. <br><br><h5>  Modification of registers </h5><br>  Our first two lines of implantable code have the following: <br><br><pre> <code class="java hljs"> invoke-<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> {}, Lcom/android/phone/util/VoiceRecorderHelper;-&gt;getInstance()Lcom/android/phone/util/VoiceRecorderHelper; move-result-object v1</code> </pre>  The easiest way to search for suitable register numbers is to search in the method itself which kinds of data are written into the necessary register numbers.  If we look in the code, we find that the move-result-object is recorded in v2 and v 3 as well. <br>  Accordingly, all of our v1 in the implanted code will be replaced by v2 or v3 <br><br>  Having done all the operations for replacing register numbers in the implanted code, we get the following picture: <br><br><pre> <code class="java hljs"> invoke-<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> {}, Lcom/android/phone/util/VoiceRecorderHelper;-&gt;getInstance()Lcom/android/phone/util/VoiceRecorderHelper; move-result-object v3 invoke-virtual/range {v3 .. v3}, Lcom/android/phone/util/VoiceRecorderHelper;-&gt;isRecording()Z move-result v4 <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>/<span class="hljs-number"><span class="hljs-number">4</span></span> v5, <span class="hljs-number"><span class="hljs-number">0x0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-ne v5, v4, :cond_27 invoke-virtual/range {v3 .. v3}, Lcom/android/phone/util/VoiceRecorderHelper;-&gt;start()Z :cond_27</code> </pre>  It should be noted that we changed the marker cond_a9 to cond_27.  The fact is that the cond_a9 marker already existed in the file where we implanted the code and the second time such a marker cannot be used.  Marker number is a hexadecimal code and can be any, the main thing is unique. <br><br>  Now in the source file, replace the line <code>.line 2302</code> with our implantable code and get <br><pre> <code class="java hljs">.<span class="hljs-function"><span class="hljs-function">method </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCallConnected</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Landroid/os/AsyncResult;)</span></span></span><span class="hljs-function">V .registers 8 .parameter "r" .prologue invoke-</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span></span>{}, Lcom/android/phone/util/VoiceRecorderHelper;-&gt;getInstance()Lcom/android/phone/util/VoiceRecorderHelper; move-result-object v3 invoke-virtual/range {v3 .. v3}, Lcom/android/phone/util/VoiceRecorderHelper;-&gt;isRecording()Z move-result v4 <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>/<span class="hljs-number"><span class="hljs-number">4</span></span> v5, <span class="hljs-number"><span class="hljs-number">0x0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-ne v5, v4, :cond_27 invoke-virtual/range {v3 .. v3}, Lcom/android/phone/util/VoiceRecorderHelper;-&gt;start()Z :cond_27 .line <span class="hljs-number"><span class="hljs-number">2302</span></span> iget-object v0, p1, Landroid/os/AsyncResult;-&gt;result:Ljava/lang/Object; check-cast v0, Lcom/android/internal/telephony/Connection; .local v0, c:Lcom/android/internal/telephony/Connection; move-object v2, v0</code> </pre><br><br>  It now remains to compile our code using the <code>java -Xmx512m -jar smali.jar -a 16 Phone -o classes.dex</code> , replace it in Phone.apk and test it. <br><br>  In the Java version, our work began to look like this: <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCallConnected</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AsyncResult paramAsyncResult)</span></span></span><span class="hljs-function"> </span></span>{ VoiceRecorderHelper localVoiceRecorderHelper = VoiceRecorderHelper.getInstance(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!localVoiceRecorderHelper.isRecording()) { localVoiceRecorderHelper.start(); } Connection localConnection = (Connection)paramAsyncResult.result; String str = ((IfConnection)localConnection).getDialString(); VLog.d(<span class="hljs-string"><span class="hljs-string">"onCallConnected() dialed number:"</span></span> + str); removeMessages(<span class="hljs-number"><span class="hljs-number">120000</span></span>); removeMessages(<span class="hljs-number"><span class="hljs-number">120001</span></span>);</code> </pre><br><br>  Everything is good, everything works, but the only problem, after the end of the conversation, call recording continues indefinitely. <br>  To do this, we need to prescribe a similar code at the beginning of the onDisconnect function (method), only with inverse logic. <br><br><pre> <code class="java hljs"> VoiceRecorderHelper localVoiceRecorderHelper = VoiceRecorderHelper.getInstance(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (localVoiceRecorderHelper.isRecording()) { localVoiceRecorderHelper.stop(); }</code> </pre><br><br>  By analogy with the beginning of the record, we write a small procedure, replacing the numbers of registers <br><br><pre> <code class="java hljs">.<span class="hljs-function"><span class="hljs-function">method </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDisconnect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Landroid/os/AsyncResult;)</span></span></span><span class="hljs-function">V .registers 41 .parameter "r" .prologue invoke-</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span></span>{}, Lcom/android/phone/util/VoiceRecorderHelper;-&gt;getInstance()Lcom/android/phone/util/VoiceRecorderHelper; move-result-object v34 invoke-virtual/range {v34 .. v34}, Lcom/android/phone/util/VoiceRecorderHelper;-&gt;isRecording()Z move-result v4 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>-eqz v4, :cond_33 invoke-virtual/range {v34 .. v34}, Lcom/android/phone/util/VoiceRecorderHelper;-&gt;stop()Z .line <span class="hljs-number"><span class="hljs-number">2487</span></span> :cond_33</code> </pre><br>  We collect our changes, replace them in the phone and voila - everything works as it should. <br><br><h4>  Epilogue </h4><br>  I am sure that this material was several times more complicated and confusing than the previous article.  Some kind of registers, operators, modifiers ... It looks like nonsense.  I myself for the first time when I saw Dalvik - I was horrified, closed the page and did not open it for half a year.  When pressed against the wall, within two weeks I quickly figured out what was happening and how to put it into practice.  What pleases, for all the practice I have never received a brick. <br><br>  Not for advertising sake, I want to advise two resources where you can gather a lot of information: <br><br>  <a href="http://4pda.ru/forum/index.php%3Fshowforum%3D281">Russian-speaking</a> and <a href="http://forum.xda-developers.com/index.php">English-speaking</a> <br>  On both resources I am present with the same nickname. <br><br>  In the meantime, until the next article, I hope in a week. </li></ol></div><p>Source: <a href="https://habr.com/ru/post/182640/">https://habr.com/ru/post/182640/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../182628/index.html">Node.js: JavaScript Are you it?</a></li>
<li><a href="../182630/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ60 (June 1 - 8, 2013)</a></li>
<li><a href="../182632/index.html">Configuring via scripts instead of XML and JSON using the example of a realtime multiplayer game</a></li>
<li><a href="../182634/index.html">The Hand prosthesis - almost complete replacement of the arm</a></li>
<li><a href="../182638/index.html">Creation of QR codes in C / C ++</a></li>
<li><a href="../182646/index.html">Facebook suffered from cloud in Oregon data center</a></li>
<li><a href="../182648/index.html">The Guardian published another slide from a secret presentation about PRISM</a></li>
<li><a href="../182650/index.html">DevConf :: Python 2013 - will be held on June 14 in Moscow, the author of the book ‚ÄúPorting to Python 3‚Äù Lennart Regebro arrives</a></li>
<li><a href="../182652/index.html">Hyperboria: How it all works</a></li>
<li><a href="../182654/index.html">Translucency, video editing and working with mosaics in PaintCAD 4Windows 1.2.1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>