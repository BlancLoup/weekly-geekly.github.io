<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Publishing logs in Elasticsearch - life without regular expressions and without logstash</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When using the approach of this solution, file parsing will not be necessary. When changing the format of logging or the appearance of new messages, i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Publishing logs in Elasticsearch - life without regular expressions and without logstash</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/97e/b05/08a/97eb0508a20b426794605137cc004d51.png"><br>  When using the approach of this solution, file parsing will not be necessary.  When changing the format of logging or the appearance of new messages, it is not necessary to support a large set of regulators.  We will intercept calls to the error, warn, info, debug, trace tracers and send the data immediately to elasticsearch.  With this, aspect-oriented programming will help us! <br><a name="habracut"></a><br>  You can see the screencast at the end of the article. <br><br>  I hope that you will be interested to learn how using aspects written in the form of a script and configuration, you can work with the elasticsearch client, gson serializer and parameters of the intercepted method in jvm. <br><br>  The experimental program remains the SonarQube, as in the articles about <a href="http://habrahabr.ru/post/264415/">hawt.io/h2</a> , <a href="http://habrahabr.ru/post/266781/">jdbc</a> and <a href="http://habrahabr.ru/post/265741/">CRaSH-ssh</a> <a href="http://habrahabr.ru/post/266781/">logging</a> .  You can read more about the installation and configuration of sonar and virtual machine agent in the <a href="http://habrahabr.ru/post/264415/">hawt.io/h2</a> publication. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This time we‚Äôll use the jvm sonar launch options: <br>  sonar.web.javaAdditionalOpts = -javaagent: <b>aspectj-scripting-1.0-agent.jar</b> -Dorg.aspectj.weaver.loadtime.configuration = config: file: <b>es.xml</b> <br>  And for the example to work, you need to download the jvm agent <a href="">aspectj-scripting</a> and the es.xml configuration file: <br><pre><code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">aspects</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>com.github.igorsuhorukov.Loging<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span>AROUND<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pointcut</span></span></span><span class="hljs-tag">&gt;</span></span>call(* org.slf4j.Logger.error(..)) || call(* org.slf4j.Logger.warn(..)) || call(* org.slf4j.Logger.info(..)) || call(* org.slf4j.Logger.debug(..)) || call(* org.slf4j.Logger.trace(..))<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pointcut</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">process</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">expression</span></span></span><span class="hljs-tag">&gt;</span></span> res = joinPoint.proceed(); log = new java.util.HashMap(); log.put("level", joinPoint.getSignature().getName()); log.put("srcf", joinPoint.getSourceLocation().getFileName().substring(0, joinPoint.getSourceLocation().getFileName().length()-5)); log.put("srcl", joinPoint.getSourceLocation().getLine()); if(joinPoint.getArgs()!=null &amp;&amp; joinPoint.getArgs().?length&gt;0){ log.put("message", joinPoint.getArgs()[0].?toString()); if(joinPoint.getArgs().length &gt; 1){ params = new java.util.HashMap(); for(i=1; i <span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">joinPoint.getArgs</span></span></span><span class="hljs-tag">()</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.length</span></span></span><span class="hljs-tag">;</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span><span class="hljs-tag">++){ </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">joinPoint.getArgs</span></span></span><span class="hljs-tag">()[</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span><span class="hljs-tag">]!=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">null){</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">joinPoint.getArgs</span></span></span><span class="hljs-tag">()[</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span><span class="hljs-tag">]</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.class.getName</span></span></span><span class="hljs-tag">()</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.equals</span></span></span><span class="hljs-tag">("[</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Ljava.lang.Object</span></span></span><span class="hljs-tag">;")){ </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span><span class="hljs-tag"> &lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">joinPoint.getArgs</span></span></span><span class="hljs-tag">()[</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span><span class="hljs-tag">]</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.length</span></span></span><span class="hljs-tag">;</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span><span class="hljs-tag">++){ </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag">( (</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">joinPoint.getArgs</span></span></span><span class="hljs-tag">()[</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span><span class="hljs-tag">])[</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span><span class="hljs-tag">] !=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">null){</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">params.put</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span><span class="hljs-tag">+"</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span><span class="hljs-tag">"+</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span><span class="hljs-tag">,(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">joinPoint.getArgs</span></span></span><span class="hljs-tag">()[</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span><span class="hljs-tag">])[</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">j</span></span></span><span class="hljs-tag">]</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.toString</span></span></span><span class="hljs-tag">()); } } } </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">else</span></span></span><span class="hljs-tag"> { </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">params.put</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span><span class="hljs-tag">,</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">joinPoint.getArgs</span></span></span><span class="hljs-tag">()[</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span><span class="hljs-tag">]</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.toString</span></span></span><span class="hljs-tag">()); } } } </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">log.put</span></span></span><span class="hljs-tag">("</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">params</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">params</span></span></span><span class="hljs-tag">); } } </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">log.put</span></span></span><span class="hljs-tag">("</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">host</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">reportHost</span></span></span><span class="hljs-tag">); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">log.put</span></span></span><span class="hljs-tag">("</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pid</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pid</span></span></span><span class="hljs-tag">); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">log.put</span></span></span><span class="hljs-tag">("@</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span><span class="hljs-tag">); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">localDate</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">new</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">java.util.Date</span></span></span><span class="hljs-tag">(); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lock.lock</span></span></span><span class="hljs-tag">(); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">log.put</span></span></span><span class="hljs-tag">("@</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">timestamp</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dateFormat.format</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">localDate</span></span></span><span class="hljs-tag">)); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">index</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"logstash-"</span></span></span><span class="hljs-tag"> + </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">logstashFormat.format</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">localDate</span></span></span><span class="hljs-tag">); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lock.unlock</span></span></span><span class="hljs-tag">(); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">logSource</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">gson.toJson(log);</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">client.index</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">client.prepareIndex</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">index</span></span></span><span class="hljs-tag">, "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">logs</span></span></span><span class="hljs-tag">")</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.setSource</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">logSource</span></span></span><span class="hljs-tag">)</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.request</span></span></span><span class="hljs-tag">()); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">res</span></span></span><span class="hljs-tag">; &lt;/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">expression</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">process</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">aspects</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">globalContext</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifacts</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifact</span></span></span><span class="hljs-tag">&gt;</span></span>com.google.code.gson:gson:2.3.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifact</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span>GsonBuilder<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span>com.google.gson.GsonBuilder<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifacts</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifacts</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifact</span></span></span><span class="hljs-tag">&gt;</span></span>org.elasticsearch:elasticsearch:1.1.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifact</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span>NodeBuilder<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">variable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span>org.elasticsearch.node.NodeBuilder<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">className</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">classRefs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifacts</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">init</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">expression</span></span></span><span class="hljs-tag">&gt;</span></span> import java.text.SimpleDateFormat; import java.util.TimeZone; import java.util.concurrent.locks.ReentrantLock; reportHost = java.net.InetAddress.getLocalHost().getHostName(); pid = java.lang.management.ManagementFactory.getRuntimeMXBean().getName().split("@")[0]; gson = new GsonBuilder().create(); dateFormat = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"); dateFormat.setTimeZone(TimeZone.getTimeZone("UTC")); logstashFormat = new SimpleDateFormat("yyyy.MM.dd"); logstashFormat.setTimeZone(TimeZone.getTimeZone("UTC")); lock = new ReentrantLock(); client = NodeBuilder.nodeBuilder().clusterName("distributed_app").data(false).client(true).build().client(); <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">expression</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">init</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">globalContext</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  For all call points from the program of the error, warn, info, debug, org.slf4j.Logger interface trace, an aspect is called in which we create a HashMap log and fill in the call context parameters: the <b>srcf</b> class file and <b>the srcl</b> lines in it , specify the logging <b>level ‚Äúlevel‚Äù</b> , host name <b>‚Äúhost‚Äù</b> , process identifier <b>‚Äúpid‚Äù</b> , time for calling the logger <b>"@timestamp"</b> , as well as the message text template and save its parameters separately in the Map <b>"params"</b> .  All this synchronously with the call is serialized in json and sent to the index with the name <b>"logstash-"</b> + the date of the call.  Classes for formatting dates and times, as well as the client for elasticsearch, are created when the application starts in the global initialization block of aspects of globalContext. <br>  The elasticsearch classes are loaded from the maven repository at the coordinates of <b>org.elasticsearch: elasticsearch: 1.1.1</b> , and the json serializer at the coordinates <b>com.google.code.gson: gson: 2.3.1</b> . <br>  The client from the aspect at the start of the multicast protocol is trying to find an elasticsearch cluster with the name <b>"distributed_app"</b> <br><br>  Before launching our client, we will definitely launch a server elasticsearch cluster consisting of one process: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> org.github.suhorukov; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.elasticsearch.common.settings.ImmutableSettings; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.elasticsearch.node.Node; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.elasticsearch.node.NodeBuilder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.InputStream; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.net.URL; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.concurrent.TimeUnit; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ElasticsearchServer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception</span></span>{ String template; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>(InputStream templateStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(<span class="hljs-string"><span class="hljs-string">"https://raw.githubusercontent.com/logstash-plugins/logstash-output-elasticsearch/master/lib/logstash/outputs/elasticsearch/elasticsearch-template.json"</span></span>).openStream()){ template = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String(sun.misc.IOUtils.readFully(templateStream, -<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); } Node elasticsearchServer = NodeBuilder.nodeBuilder().settings(ImmutableSettings.settingsBuilder().put(<span class="hljs-string"><span class="hljs-string">"http.cors.enabled"</span></span>,<span class="hljs-string"><span class="hljs-string">"true"</span></span>)).clusterName(<span class="hljs-string"><span class="hljs-string">"distributed_app"</span></span>).data(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>).build(); Node node = elasticsearchServer.start(); node.client().admin().indices().preparePutTemplate(<span class="hljs-string"><span class="hljs-string">"logstash"</span></span>).setSource(template).get(); Thread.sleep(TimeUnit.HOURS.toMillis(<span class="hljs-number"><span class="hljs-number">5</span></span>)); } }</code> </pre><br>  To compile and work this class, a dependency is required: <br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.elasticsearch<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>elasticsearch<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.1.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  To view the logs, download the old <a href="">kibana 3.1.3</a> build, which can work without a web server.  Edit the config.js file <pre> <code class="hljs objectivec">elasticsearch: <span class="hljs-string"><span class="hljs-string">"http://127.0.0.1:9200"</span></span></code> </pre>  so that kibana can connect to the elasticsearch server (for this we specified <b>‚Äúhttp.cors.enabled‚Äù = true</b> ) <br><br>  Start the sonar <br><pre> <code class="bash hljs">./bin/linux-x86-64/sonar.sh start</code> </pre> <br>  and observe in the browser how the events of this system are displayed during the operation of SonarQube in kibana <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/c0Ko09niHB0%3Ffeature%3Doembed&amp;xid=25657,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjCAFN42B4Ya5VYksDoV_nr1qJ_bA" frameborder="0" allowfullscreen=""></iframe><br><br>  What kind of examples with the use of aspects would you be interested to read?  Offer! </div><p>Source: <a href="https://habr.com/ru/post/267009/">https://habr.com/ru/post/267009/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266997/index.html">The digest of interesting materials from the world of Drupal # 13</a></li>
<li><a href="../266999/index.html">Encapsulation of interfaces. We make API in C ++ convenient and understandable.</a></li>
<li><a href="../267001/index.html">Adaptive design alone is not enough: we need adaptive performance.</a></li>
<li><a href="../267003/index.html">Reinforced.Typings - more details</a></li>
<li><a href="../267007/index.html">How I ran a poster for Jewish events</a></li>
<li><a href="../267011/index.html">RailsClub 2015: Interview with Ivan Nemytchenko</a></li>
<li><a href="../267013/index.html">Secure WiFi in Yandex Browser. About protection for those who have not had time to HTTPS</a></li>
<li><a href="../267015/index.html">Scheme Introduction</a></li>
<li><a href="../267017/index.html">Modern methods of hacking corporate networks and systems at the conference "Secure IT World 2015"</a></li>
<li><a href="../267019/index.html">Joint action with ISPsystem: ISPmanager 5 Lite license free of charge to all cloud-based VPS, incident report dated August 31, 2015</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>