<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Porting MIPSfpga to other cards and integrating peripherals into the system. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="MIPSfpga is an educationally designed microprocessor MIPS32 microAptiv of Imagination, which has a cache memory and a memory management unit. The Veri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Porting MIPSfpga to other cards and integrating peripherals into the system. Part 1</h1><div class="post__text post__text-html js-mediator-article">  MIPSfpga is an educationally designed microprocessor MIPS32 microAptiv of Imagination, which has a cache memory and a memory management unit.  The Verilog processor code is available to the user and can be used to simulate and implement a processor on an FPGA board. <br><br>  This article will describe, using the example of Digilent cmodA7, how to port the MIPSfpga-plus processor to other cards. <br><br><img src="https://habrastorage.org/web/2e8/3b4/cc1/2e83b4cc177149f6ba7f5afc2640e63f.JPG">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To date, MIPSFPGA has been ported to popular boards from companies such as ALTERA and Xilinx, among them Basys 3, Nexys4 ddr, and others (the full list is on <a href="https://github.com/MIPSfpga/mipsfpga-plus">github</a> ).  Such boards are most popular among developers on FPGA.  The price of such boards is not quite small, and the programs are loaded into the MIPSfpga core using the EJTAG interface and the Bus Blaster adapter at the cost of about $ 50.  The Bus Blaster adapter receives commands via a high-speed USB 2.0 cable and converts them to the serial protocol EJTAG, which allows you to load programs into the MIPSfpga core and control the debugging of the programs that run on it.  The problem with relatively expensive Bus Blaster was solved by introducing a number of improvements to the MIPSfpga system.  An improved version of the MIPSfpga system, called MIPSfpga-plus, includes such new features: <br><br>  - Ability to download software using a USB-to-UART connector priced at $ 5 FTDI instead of $ 50 Bus Blaster, which sometimes is not so easy to get. <br><br>  - The ability to change the clock frequency on the fly from 50 or 25 MHz to 1 Hz (one cycle per second) to monitor the processor in real time, including misses in the cache memory and redirection of the conveyor. <br><br>  - An example of the integration of the light sensor with the SPI protocol. <br><br>  - A small software initialization sequence that fits into 1 KB instead of 32 KB of memory, which allows MIPSfpga to be transferred to a wider choice of FPGA cards without using external memory.  UART implementation is described in the article: <a href="https://habrahabr.ru/post/325168/">MIPSfpga and UART</a> . <br><a name="habracut"></a><br><h3>  Creating a project in Xilinx Vivado 2016.4 (64 bit) with MIPSfpga-plus </h3><br>  Before adding various peripherals to MIPSfpga +, you need to load and run the system on the FPGA.  Some steps of this manual can be skipped if you have a fee from the list below: <br><div class="spoiler">  <b class="spoiler_title">Port fees</b> <div class="spoiler_text">  basys3 <br>  de0 <br>  de0_cv <br>  de0_nano <br>  de1 <br>  de10_lite <br>  de2_115nexys4 <br>  nexys4_ddr <br></div></div><br>  MIPSfpga-plus has already been ported to these boards and you can download it at the link: <br><br>  <a href="https://github.com/MIPSfpga/mipsfpga-plus/tree/master/boards">github.com/MIPSfpga/mipsfpga-plus/tree/master/boards</a> <br><br>  In another case, if you have a different motherboard from the FPGA listed in the list, it will not be too difficult to port the processor to it.  To do this, the following instruction is written, which is shown on the example of my cmodA7 board. <br><br>  1. First you need to get a package with the MIPSFPGA system.  Detailed instructions on how to do this: <br><br>  ‚Üí <a href="http://www.silicon-russia.com/2015/12/11/mipsfpga-download-instruction/">mipsfpga-download-instruction</a> <br><br>  You will also need to download the current version of the MIPSfpga-plus extension: <br><br>  ‚Üí <a href="https://github.com/zhelnio/mipsfpga-plus">Mipsfpga-plus</a> <br><br>  2. For Xilinx boards, Vivado software is used, the current version can be downloaded at the link: <br><br>  ‚Üí <a href="https://www.xilinx.com/support/download.html">Download Vivado</a> <br><br>  3. Now let's create a new project in Vivado: <br><br><img src="https://habrastorage.org/web/d22/b17/34f/d22b1734fdc8428b8d040ae955fb8fd5.png"><br><br>  Choose where the created project will be stored: <br><br><img src="https://habrastorage.org/web/111/fe7/060/111fe70609144ea186d5102dbfff5dbc.png"><br><br>  Click next: <br><br><img src="https://habrastorage.org/web/8ed/3f9/330/8ed3f9330c214536aa20a7265e3f81eb.png"><br><br>  Select the RTL project and click on: <br><br><img src="https://habrastorage.org/web/74c/86d/881/74c86d881d02468c80634234482a550d.png"><br><br>  Now add the files of the original MIPSfpga system: <br><br><img src="https://habrastorage.org/web/f49/860/dde/f49860ddedc8444c9c94313eab08a3bb.png"><br><br><img src="https://habrastorage.org/web/d35/a44/5b3/d35a445b39a04551befe186ada813ac4.png"><br><br>  As well as MIPSfpga-plus which are in the archive downloaded from <a href="https://github.com/zhelnio/mipsfpga-plus">mipsfpga-plus</a> : <br><br><img src="https://habrastorage.org/web/04b/e96/2c9/04be962c9db74aec97d2cee53cb76d72.png"><br><br>  Add to the project the uart module that was previously discussed: <br><br><img src="https://habrastorage.org/web/663/c57/2e4/663c572e410c40f79adc0d9084529c3e.png"><br><br>  Skipping the creation of IP and construction files will create them later: <br><br><img src="https://habrastorage.org/web/e4f/f4c/107/e4ff4c1072744a8f9daadd0a1fc4b2b9.png"><br><br><img src="https://habrastorage.org/web/77c/ae9/4d6/77cae94d6b1943268efb3fb18c302776.png"><br><br>  Next you need to either choose a chip or add your board. <br><br>  The Digilent <a href="http://store.digilentinc.com/cmod-a7-breadboardable-artix-7-fpga-module/">cmod A7 board</a> was chosen due to its <a href="http://store.digilentinc.com/cmod-a7-breadboardable-artix-7-fpga-module/">low</a> price and the presence of the ADC we use later.  To select the FPGA scheme, you need to read the documentation on your board, on cmodA7 the xc7a35tcpg236-1 chip is placed: <br><br><img src="https://habrastorage.org/web/8a8/cf0/09c/8a8cf009cfa94e52ba5e19b8b70576e1.png"><br><br>  Another way is to add your board file to the Vivado library, this method is better because, firstly, it is more convenient to remember the name of the board than the chip, and secondly, if you want to use the block designer in Vivado in the future, then you will have additional tools for convenient work with board interfaces, IP cores, etc.  You can download them on <a href="https://github.com/Digilent/vivado-boards">GitHub</a> , you need to save these files in ~ \ Vivado \ 2015.1 \ data \ boards \ (relevant for Vivado 2015.1 and newer). <br><br><img src="https://habrastorage.org/web/c32/796/5ed/c327965ed685422f826a15023aa7e3af.png"><br><br><img src="https://habrastorage.org/web/de6/72c/422/de672c42288c4a01ba59cc6754d2f8f9.png"><br><br>  So we created a project with MIPSfpga-plus. <br><br><h3>  Porting Instructions on the example of the Artix-7 based Digilent CmodA7 board </h3><br>  In short, the Artix-7 chip is on board the cmodA7 board, it has 20800 LUT, 41600 FF, 225 KB block memory, 48 pins, 2 of which are ADC outputs, also a usb-uart converter, Quad-SPI Flash, and JTAG, 2 clock buttons, as well as 5 LEDs 3 of which are RGB ( <a href="https://reference.digilentinc.com/_media/cmod_a7/cmod_a7_rm.pdf">datashit</a> ). <br><br>  To transfer the MIPSfpga system to the cmodA7 board, you should: <br><br>  Step 1. Write a shell module that establishes the correspondence between the I / Os of the MIPSfpga and the I / Os of the cmodA7 board. <br>  Step 2. Reduce the memory capacity of the MIPSfpga system to match the cmodA7 board. <br>  Step 3. Add a constraint file that establishes the correspondence between the board I / Os and the FPGA chassis. <br><br><h4>  Step 1. Add a new shell file cmoda7.v </h4><br><img src="https://habrastorage.org/web/0a1/997/da2/0a1997da2f834f58bbe2305b35d213f8.png"><br><br><img src="https://habrastorage.org/web/768/7ee/233/7687ee233e5643a5b7dabb53c1810b94.png"><br><br><img src="https://habrastorage.org/web/b97/39a/1a3/b9739a1a31214f229bfc1c7423a771eb.png"><br><br><img src="https://habrastorage.org/web/55c/7e6/8f5/55c7e68f5b5c4dbf9fc36a57a9ec19ea.png"><br><br><img src="https://habrastorage.org/web/793/dfd/fa5/793dfdfa51b94b4ab1d9f4437237c69d.png"><br><br><img src="https://habrastorage.org/web/140/1db/0bf/1401db0bf4a641b1bd7f0465d28ce8f8.png"><br><br><img src="https://habrastorage.org/web/458/c06/f62/458c06f623c04c4f8e0d0effa904c2fa.png"><br><br>  Install cmoda7.v as the top module in the system hierarchy. <br><br><img src="https://habrastorage.org/web/30c/e94/d37/30ce94d37f2443b29155bf867c7b7f35.png"><br><br>  Since there are no switches on the cmoda7 board that could be used to lower the processor frequency (this modification appeared in MIPSfpga-plus), this module was simply not included in the shell module.  You can also exclude the EJTAG output to which the BUS Blaster is connected. <br><br>  First you need to add the header file for the AHB_lite bus configuration. <br><br><pre><code class="hljs pgsql">`<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "mfp_ahb_lite_matrix_config.vh"</code> </pre> <br>  The Advanced High-Performance Bus (AHB) is an open interface that is used in many microprocessor-based systems, especially embedded ones.  AHB bus facilitates the organization of the connection of multiple devices.  AHB-Lite is a simplified version of AHB with one master device. <br><br><img src="https://habrastorage.org/web/427/597/ecd/427597ecd9bc468f93c061592f3dbeb1.png"><br><br>  This configuration has one master device, a MIPSfpga processor, and three slaves: RAM0, RAM1, and GPIO, which are (respectively) two blocks of RAM and a module for accessing board I / O devices.  We will just work with the GPIO block and write modules for interaction with peripherals. <br><br>  Let's write the main input-output ports: <br><br><pre> <code class="hljs lua">module cmoda7 ( <span class="hljs-built_in"><span class="hljs-built_in">input</span></span> i_clk, <span class="hljs-built_in"><span class="hljs-built_in">input</span></span> i_btn0, <span class="hljs-built_in"><span class="hljs-built_in">input</span></span> i_btn1, <span class="hljs-built_in"><span class="hljs-built_in">input</span></span> RsRx, <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> [ <span class="hljs-number"><span class="hljs-number">6</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] seg, <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> dp, <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> [ <span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] an, <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> led0_r, <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> led0_g, <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> led0_b, inout [ <span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] JA );</code> </pre> <br>  i_clk is the signal of the clock generator of the board frequency (for cmodA7 12 MHz). <br>  i_btn0 - the button is used to reset the processor. <br>  i_btn1 - n / c. <br>  RsRx - receive signal by uart. <br>  seg, dp, an, - contacts for connecting a seven-segment 4-digit indicator. <br>  led_r, led_g, led_b, - the conclusions of the RGB Led placed on the board. <br>  JA - Pmod interface. <br><br>  The main signals are the clock signal and reset (i_btn0) others for connecting peripherals. <br><br><img src="https://habrastorage.org/web/5f6/41c/b73/5f641cb730674e60832399772f7cb0b7.png"><br><br>  The main purpose of the cmoda7.v module is to create an instance of the MIPSfpga-plus system (mipsfpga_sys) and its connection to the I / O of the board. <br><br><pre> <code class="hljs mel"><span class="hljs-keyword"><span class="hljs-keyword">wire</span></span> clock; <span class="hljs-keyword"><span class="hljs-keyword">wire</span></span> reset = i_btn0; <span class="hljs-keyword"><span class="hljs-keyword">wire</span></span> display_clock; <span class="hljs-keyword"><span class="hljs-keyword">wire</span></span> [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] anodes; <span class="hljs-keyword"><span class="hljs-keyword">wire</span></span> [<span class="hljs-string"><span class="hljs-string">`MFP_N_BUTTONS - 1:0] IO_Buttons; wire [`</span></span>MFP_7_SEGMENT_HEX_WIDTH - <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] IO_7_SegmentHEX; assign IO_Buttons = { { <span class="hljs-string"><span class="hljs-string">`MFP_N_BUTTONS - 2 { 1'b0 } } , i_btn0, i_btn1 }; mfp_system mfp_system ( .SI_ClkIn ( clock ), .SI_Reset ( reset ), .HADDR ( ), .HRDATA ( ), .HWDATA ( ), .HWRITE ( ), .EJ_TRST_N_probe ( ), .EJ_TDI ( ), .EJ_TDO ( ), .EJ_TMS ( ), .EJ_TCK ( ), .SI_ColdReset ( ), .EJ_DINT ( 1'b0 ), .IO_Switches ( ), .IO_Buttons ( IO_Buttons ), .IO_RedLEDs ( ), .IO_GreenLEDs ( ), .IO_7_SegmentHEX ( IO_7_SegmentHEX ), `</span></span>ifdef MFP_DEMO_LIGHT_SENSOR .SPI_CS ( JA [<span class="hljs-number"><span class="hljs-number">0</span></span>] ), .SPI_SCK ( JA [<span class="hljs-number"><span class="hljs-number">3</span></span>] ), .SPI_SDO ( JA [<span class="hljs-number"><span class="hljs-number">2</span></span>] ), <span class="hljs-string"><span class="hljs-string">`endif .UART_RX ( RsRx ), .UART_TX ( ) ); `</span></span>ifdef MFP_DEMO_LIGHT_SENSOR assign JA [<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">'b0; `endif</span></span></code> </pre> <br>  MFP_DEMO_LIGHT_SENSOR will be used when testing a ported system.  As you can see, at the output of the mfp_system system there will be a 32-bit IO_7_SegmentHEX bus which we output to the 4-digit 7 segment indicator decoder module, we will wrap the module of the instance ‚Äúmfp_multi_digit_display‚Äù: <br><br><pre> <code class="hljs lisp">mfp_multi_digit_display multi_digit_display ( .clock ( <span class="hljs-name"><span class="hljs-name">display_clock</span></span> ), .resetn ( ~ reset ), .number ( <span class="hljs-name"><span class="hljs-name">IO_7_SegmentHEX</span></span> ), .seven_segments ( <span class="hljs-name"><span class="hljs-name">seg</span></span> ), .dot ( <span class="hljs-name"><span class="hljs-name">dp</span></span> ), .anodes ( <span class="hljs-name"><span class="hljs-name">an</span></span> ) )<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  When creating a decoder, it is worth knowing whether the indicator is with a common anode or cathode. <br>  The code of the seven-segment indicator decoder with a common anode has the following form: <br><br><pre> <code class="hljs ruby"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mfp_single_digit_seven_segment_display</span></span></span><span class="hljs-class"> ( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">input</span></span></span><span class="hljs-class"> [3:0] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">digit</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">output</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">reg</span></span></span><span class="hljs-class"> [6:0] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">seven_segments</span></span></span><span class="hljs-class"> );</span></span> always @* <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (digit) <span class="hljs-string"><span class="hljs-string">'h0: seven_segments = '</span></span>b100000<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> abcdefg <span class="hljs-string"><span class="hljs-string">'h1: seven_segments = '</span></span>b1111001; <span class="hljs-string"><span class="hljs-string">'h2: seven_segments = '</span></span>b010010<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> --a-- <span class="hljs-string"><span class="hljs-string">'h3: seven_segments = '</span></span>b011000<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-string"><span class="hljs-string">'h4: seven_segments = '</span></span>b0011001; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> fb <span class="hljs-string"><span class="hljs-string">'h5: seven_segments = '</span></span>b001001<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-string"><span class="hljs-string">'h6: seven_segments = '</span></span>b000001<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> --g-- <span class="hljs-string"><span class="hljs-string">'h7: seven_segments = '</span></span>b111100<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-string"><span class="hljs-string">'h8: seven_segments = '</span></span>b000000<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ec <span class="hljs-string"><span class="hljs-string">'h9: seven_segments = '</span></span>b001100<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-string"><span class="hljs-string">'ha: seven_segments = '</span></span>b000100<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> --d-- <span class="hljs-string"><span class="hljs-string">'hb: seven_segments = '</span></span>b0000011; <span class="hljs-string"><span class="hljs-string">'hc: seven_segments = '</span></span>b100011<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-string"><span class="hljs-string">'hd: seven_segments = '</span></span>b0100001; <span class="hljs-string"><span class="hljs-string">'he: seven_segments = '</span></span>b000011<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-string"><span class="hljs-string">'hf: seven_segments = '</span></span>b000111<span class="hljs-number"><span class="hljs-number">0</span></span>; endcase endmodule /<span class="hljs-regexp"><span class="hljs-regexp">/-------------------------------------------------------------------- module mfp_multi_digit_display ( input clock, input resetn, input [31:0] number, output reg [ 6:0] seven_segments, output reg dot, output reg [ 7:0] anodes ); function [6:0] bcd_to_seg (input [3:0] bcd); case (bcd) 'h0: bcd_to_seg = 'b1000000; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ abcdefg 'h1: bcd_to_seg = 'b1111001; 'h2: bcd_to_seg = 'b0100100; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ --a-- 'h3: bcd_to_seg = 'b0110000; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | | 'h4: bcd_to_seg = 'b0011001; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ fb 'h5: bcd_to_seg = 'b0010010; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | | 'h6: bcd_to_seg = 'b0000010; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ --g-- 'h7: bcd_to_seg = 'b1111000; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | | 'h8: bcd_to_seg = 'b0000000; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ec 'h9: bcd_to_seg = 'b0010000; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | | 'ha: bcd_to_seg = 'b0001000; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ --d-- 'hb: bcd_to_seg = 'b0000011; 'hc: bcd_to_seg = 'b1000110; 'hd: bcd_to_seg = 'b0100001; 'he: bcd_to_seg = 'b0000110; 'hf: bcd_to_seg = 'b0001110; endcase endfunction reg [2:0] i; always @ (posedge clock or negedge resetn) begin if (! resetn) begin seven_segments &lt;= bcd_to_seg (0); dot &lt;= 0; anodes &lt;= 8'b00000001; i &lt;= 0; end else begin seven_segments &lt;= bcd_to_seg (number [i * 4 +: 4]); dot &lt;= 0; anodes &lt;= (1 &lt;&lt; i); i &lt;= i + 1; end end endmodule</span></span></code> </pre><br>  As you can see on each leading edge of the clock in seven_segments, the corresponding signal bcd_to_seg is output, and switching between the indicator bits is performed by switching the active signal on the corresponding anodes (or cathodes). <br><br>  As the processor input receives a signal at 50 MHz which we will create later, if we change the values ‚Äã‚Äãon the indicator with such a frequency, our eye will not notice these changes (for a normal display of values ‚Äã‚Äãon the 7th segment indicator, a frequency of approximately 763 Hz is needed) .  To do this, connect an instance of the frequency divider: <br><br><pre> <code class="hljs lisp"> mfp_clock_divider_50_MHz_to_763_Hz mfp_clock_divider_50_MHz_to_763_Hz (<span class="hljs-name"><span class="hljs-name">clock</span></span>, display_clock)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  In the source files, a frequency divider with 50 MHz at 763 Hz is not.  Therefore, we will add it to the mfp_clock_dividers.v file: <br><br><img src="https://habrastorage.org/web/47a/1f7/047/47a1f70475464466a378db304aecbc0e.png"><br><br><pre> <code class="hljs lua">module mfp_clock_divider_50_MHz_to_763_Hz ( <span class="hljs-built_in"><span class="hljs-built_in">input</span></span> clki, <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> clko ); mfp_clock_divider # (.DIV_POW_SLOWEST (<span class="hljs-number"><span class="hljs-number">16</span></span>)) mfp_clock_divider ( .clki ( clki ), .sel_lo ( <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">'b1 ), .sel_mid ( 1'</span></span>b0 ), .clko ( clko ) ); endmodule</code> </pre><br>  The system receives the signals reset and clock, RsRx, IO_Buttons.  But we have an i_clk signal at the input of the top module, not a clock.  The fact is that there is a clock generator at 12 MHz on the board, and the processor in the FPGA can operate at frequencies of 50 MHz and above, and what to do if you have another board with a different clock frequency (for example, Nexys 4 DDR has a clock frequency of 100 MHz).  The problem is solved by creating the IP kernel Clocking Wizard (PLL), for this we open the IP directory: <br><br><img src="https://habrastorage.org/web/6a0/ad4/96a/6a0ad496a26642bfb5d12f0ef33a5ce6.png"><br><br>  Open the Clocking Wizard: <br><br><img src="https://habrastorage.org/web/8fb/b63/9cd/8fbb639cdc0947d6b446e9c6e0bd21c1.png"><br><br>  The board tab is left as it is, or we set up the required inputs and go to the clocking options tab, you can choose either MMCM has a wider input frequency range 10 ... 800 MHz than PLL 19 ... 800 MHz, since on cmoda7 only 12 MHz we choose MMCM, but for other boards you can choose other parameters: <br><br><img src="https://habrastorage.org/web/535/344/de4/535344de4828450fa83155aa686882e7.png"><br><br>  In the output clocks tab, we set the frequency to 50 MHz (you can and should experiment with the frequency, so there may be other characteristics on other FPGAs): <br><br><img src="https://habrastorage.org/web/535/05b/454/53505b4547034a14bf669703eb2dea4c.png"><br><br>  Also remove reset and locked: <br><br><img src="https://habrastorage.org/web/134/950/2bd/1349502bda0a43499a2e0aa667eb00f7.png"><br><br>  Port renaming, MMCM setting and Summary we look and leave as is, click OK, OK, in the next window choose generate: <br><br><img src="https://habrastorage.org/web/8f9/df2/541/8f9df2541c87486aa2dd66e0662f9d46.png" alt="image"><br><br>  We‚Äôll make the last assignment for RGB Led as the final touch, because as you can see from the circuit, they will glow dimly in the floating state, and we want them to be turned off: <br><br><img src="https://habrastorage.org/web/510/221/04c/51022104c240462a9af3a251eda355d9.png" alt="image"><br><br><pre> <code class="hljs scala">assign led0_r = <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1</span></span>; assign led0_g = <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1</span></span>; assign led0_b = <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1</span></span>;</code> </pre> <br>  At the end write: <br><br><pre> <code class="hljs">endmodule</code> </pre> <br>  The module shell is created, we proceed to change the size of the memory. <br><br><h4>  Step 2. Reduce the memory capacity of the MIPSfpga system to match the cmoda7 board </h4><br>  The cmoda7 board has 225 KB of block memory.  Thus, two blocks of memory (128 Kbytes of RAM of the reset and 256 Kbytes of RAM of the programs) do not fit on the cmoda7 board.  Since, the boot code can fit in 32 Kbytes, and you can limit the needs of programs of 64 Kbytes.  Thus, the total required memory (32 Kbytes + 64 Kbytes = 96 Kbytes) corresponds to the memory capacity of the cmoda7 board.  The remaining 225-96 = 129 Kbytes of memory can be used for other needs of the MIPSfpga system, for example, as a cache memory. <br><br>  You can reduce the amount of memory by changing the size of the memory stated in the Verilog header file that we connected to the ‚Äúmfp_ahb_lite_matrix_config.vh‚Äù shell.  Open the file mipsfpga_ahb_const.vh.  Reset RAM addresses (or boot RAM) consist of 13 bits.  Thus, the amount of reset RAM is 213 32-bit words = 215 bytes = 32 Kbytes. <br><br><img src="https://habrastorage.org/web/f03/111/8af/f031118af812419fab60f53e1c0e5ce9.png"><br><br><pre> <code class="hljs">`define H_RAM_RESET_ADDR_WIDTH 13</code> </pre> <br>  Program RAM addresses are 14 bits.  Thus, the amount of program RAM is 214 32-bit words = 216 bytes = 64 Kbytes. <br><br><pre> <code class="hljs">`define H_RAM_ADDR_WIDTH 14</code> </pre> <br><h4>  Step 3. Create the cmoda7 restriction file </h4><br>  Now create a ‚Äúcmoda7.xdc‚Äù which establishes the correspondence between the external signals of the shell module and the cPa7 FPGA case pins ( <a href="">xdc file with a complete list of pins for cmoda7</a> ): <br><br><img src="https://habrastorage.org/web/f34/9be/af3/f349beaf300140809f3dd3546f998a34.png"><br><br><img src="https://habrastorage.org/web/51a/045/60b/51a04560b71d4252a00d0711efd0c357.png"><br><br><pre> <code class="hljs sql"><span class="hljs-comment"><span class="hljs-comment">## Clock signal 12 MHz set_property -dict {PACKAGE_PIN L17 IOSTANDARD LVCMOS33} [get_ports i_clk] create_clock -period 83.330 -name sys_clk_pin -waveform {0.000 41.660} -add [get_ports i_clk] ## Buttons set_property -dict {PACKAGE_PIN A18 IOSTANDARD LVCMOS33} [get_ports i_btn0] set_property -dict {PACKAGE_PIN B18 IOSTANDARD LVCMOS33} [get_ports i_btn1] ## LEDs set_property -dict {PACKAGE_PIN B17 IOSTANDARD LVCMOS33} [get_ports led0_b] set_property -dict {PACKAGE_PIN B16 IOSTANDARD LVCMOS33} [get_ports led0_g] set_property -dict {PACKAGE_PIN C17 IOSTANDARD LVCMOS33} [get_ports led0_r] ## Pmod Header JA set_property -dict {PACKAGE_PIN G17 IOSTANDARD LVCMOS33} [get_ports {JA[0]}] set_property -dict {PACKAGE_PIN G19 IOSTANDARD LVCMOS33} [get_ports {JA[1]}] set_property -dict {PACKAGE_PIN N18 IOSTANDARD LVCMOS33} [get_ports {JA[2]}] set_property -dict {PACKAGE_PIN L18 IOSTANDARD LVCMOS33} [get_ports {JA[3]}] set_property -dict {PACKAGE_PIN H17 IOSTANDARD LVCMOS33} [get_ports {JA[4]}] set_property -dict {PACKAGE_PIN H19 IOSTANDARD LVCMOS33} [get_ports {JA[5]}] set_property -dict {PACKAGE_PIN J19 IOSTANDARD LVCMOS33} [get_ports {JA[6]}] set_property -dict {PACKAGE_PIN K18 IOSTANDARD LVCMOS33} [get_ports {JA[7]}] ## GPIO Pins 1 - 6 7_segment_ind set_property -dict {PACKAGE_PIN M3 IOSTANDARD LVCMOS33} [get_ports {seg[1]}] set_property -dict {PACKAGE_PIN L3 IOSTANDARD LVCMOS33} [get_ports {an[1]} ] set_property -dict {PACKAGE_PIN A16 IOSTANDARD LVCMOS33}[get_ports {an[2]} ] set_property -dict {PACKAGE_PIN K3 IOSTANDARD LVCMOS33} [get_ports {seg[5]}] set_property -dict {PACKAGE_PIN C15 IOSTANDARD LVCMOS33}[get_ports {seg[0]}] set_property -dict {PACKAGE_PIN H1 IOSTANDARD LVCMOS33} [get_ports {an[3]} ] ## GPIO Pins 43 - 48 7_segment_ind set_property -dict {PACKAGE_PIN U3 IOSTANDARD LVCMOS33} [get_ports {seg[3]}] set_property -dict {PACKAGE_PIN W6 IOSTANDARD LVCMOS33} [get_ports {seg[4]}] set_property -dict {PACKAGE_PIN U7 IOSTANDARD LVCMOS33} [get_ports dp ] set_property -dict {PACKAGE_PIN W7 IOSTANDARD LVCMOS33} [get_ports {seg[2]}] set_property -dict {PACKAGE_PIN U8 IOSTANDARD LVCMOS33} [get_ports {seg[6]}] set_property -dict {PACKAGE_PIN V8 IOSTANDARD LVCMOS33} [get_ports {an[0]} ] ## UART #set_property -dict { PACKAGE_PIN J18 IOSTANDARD LVCMOS33 } [get_ports { uart_rxd_out }]; #IO_L7N_T1_D10_14 Sch=uart_rxd_out set_property -dict {PACKAGE_PIN J17 IOSTANDARD LVCMOS33} [get_ports RsRx]</span></span></code> </pre><br>  For example, the following line establishes the correspondence between the i_clk input and the output of the FPGA L17 chassis, which receives a 12 MHz clock signal from the cmoda7 board. <br><br><pre> <code class="hljs pgsql">set_property -dict {PACKAGE_PIN L17 IOSTANDARD LVCMOS33} [get_ports i_clk] create_clock -period <span class="hljs-number"><span class="hljs-number">83.330</span></span> -<span class="hljs-type"><span class="hljs-type">name</span></span> sys_clk_pin -waveform {<span class="hljs-number"><span class="hljs-number">0.000</span></span> <span class="hljs-number"><span class="hljs-number">41.660</span></span>} -<span class="hljs-keyword"><span class="hljs-keyword">add</span></span> [get_ports i_clk]</code> </pre> <br>  Also in the file of restrictions you need to add the following output time limits for signals: <br><br><pre> <code class="hljs lua"># I/O virtual <span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> create_clock -period <span class="hljs-number"><span class="hljs-number">83.330</span></span> -name <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> # tsu/th constraints set_input_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">min</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">0.000</span></span> [get_ports i_btn0] set_input_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">max</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">10.000</span></span> [get_ports i_btn0] set_input_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">min</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">0.000</span></span> [get_ports i_btn1] set_input_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">max</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">10.000</span></span> [get_ports i_btn1] set_input_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">min</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">0.000</span></span> [get_ports led0_b] set_input_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">max</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">10.000</span></span> [get_ports led0_b] set_input_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">min</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">0.000</span></span> [get_ports led0_g] set_input_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">max</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">10.000</span></span> [get_ports led0_g] set_input_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">min</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">0.000</span></span> [get_ports led0_r] set_input_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">max</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">10.000</span></span> [get_ports led0_r] ## PMOD ALS set_output_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">min</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">0.000</span></span> [get_ports {JA[<span class="hljs-number"><span class="hljs-number">0</span></span>]}] set_output_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">max</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">10.000</span></span> [get_ports {JA[<span class="hljs-number"><span class="hljs-number">0</span></span>]}] set_output_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">min</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">0.000</span></span> [get_ports {JA[<span class="hljs-number"><span class="hljs-number">1</span></span>]}] set_output_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">max</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">10.000</span></span> [get_ports {JA[<span class="hljs-number"><span class="hljs-number">1</span></span>]}] set_input_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">min</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">0.000</span></span> [get_ports {JA[<span class="hljs-number"><span class="hljs-number">2</span></span>]}] set_input_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">max</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">10.000</span></span> [get_ports {JA[<span class="hljs-number"><span class="hljs-number">2</span></span>]}] set_output_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">min</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">0.000</span></span> [get_ports {JA[<span class="hljs-number"><span class="hljs-number">3</span></span>]}] set_output_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">max</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">10.000</span></span> [get_ports {JA[<span class="hljs-number"><span class="hljs-number">3</span></span>]}] set_input_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">min</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">0.000</span></span> [get_ports {seg[*]}] set_input_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">max</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">10.000</span></span> [get_ports {seg[*]}] set_input_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">min</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">0.000</span></span> [get_ports {an[*]}] set_input_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">max</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">10.000</span></span> [get_ports {an[*]}] set_input_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">min</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">0.000</span></span> [get_ports dp] set_input_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">max</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">10.000</span></span> [get_ports dp] set_output_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">min</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">0.000</span></span> [get_ports RsRx] set_output_delay -<span class="hljs-built_in"><span class="hljs-built_in">clock</span></span> <span class="hljs-string"><span class="hljs-string">"clk_virt"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">max</span></span> -add_delay <span class="hljs-number"><span class="hljs-number">10.000</span></span> [get_ports RsRx]</code> </pre> <br><h3>  MIPSfpga test </h3><br>  We can test the processor ported to our board, for this you need to go to the configuration file "mfp_ahb_lite_matrix_config.vh" and uncomment the line: <br><br><pre> <code class="hljs">`define MFP_DEMO_LIGHT_SENSOR</code> </pre> <br><img src="https://habrastorage.org/web/776/24b/52a/77624b52aa6c45d0b44fa51ef392234d.png"><br><br>  Thus, we connected the SPI interface module written on Verilog to the AHB Lite bus for connecting to the <a href="https://reference.digilentinc.com/_media/reference/pmod/pmodals/pmodals_rm.pdf">PmodALS</a> light <a href="https://reference.digilentinc.com/_media/reference/pmod/pmodals/pmodals_rm.pdf">sensor</a> from Digilent. <br><br><div class="spoiler">  <b class="spoiler_title">SPI module</b> <div class="spoiler_text"><pre> <code class="hljs vhdl">module mfp_pmod_als_spi_receiver ( input clock, input reset_n, output cs, output sck, input sdo, output reg [<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] value ); reg [<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] cnt; reg [<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] shift; always @ (posedge clock <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> negedge reset_n) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (! reset_n) cnt &lt;= <span class="hljs-number"><span class="hljs-number">22</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> cnt &lt;= cnt + <span class="hljs-number"><span class="hljs-number">22</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> assign sck = ~ cnt [<span class="hljs-number"><span class="hljs-number">3</span></span>]; assign cs = cnt [<span class="hljs-number"><span class="hljs-number">8</span></span>]; wire sample_bit = ( cs == <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0</span></span> &amp;&amp; cnt [<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b1111</span></span> ); wire value_done = ( cnt [<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-number"><span class="hljs-number">22</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0</span></span> ); always @ (posedge clock <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> negedge reset_n) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (! reset_n) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> shift &lt;= <span class="hljs-number"><span class="hljs-number">16</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000</span></span>; value &lt;= <span class="hljs-number"><span class="hljs-number">16</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h0000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sample_bit) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> shift &lt;= (shift &lt;&lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) | sdo; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value_done) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> value &lt;= shift; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> endmodule</code> </pre><br></div></div><br><img src="https://habrastorage.org/web/b48/d4e/8e1/b48d4e8e1dfb409faa4272d6b989694a.png"><br><br>  Connection diagram is shown in the picture: <br><br><img src="https://habrastorage.org/web/b32/b6d/6b9/b32b6d6b929d4e0080872802d725b32c.png"><br><br>  The sensor is connected to the Pmod port, the outputs of which are described in ‚Äúcmoda7.xdc‚Äù are registered as JA [7..0]. <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta">## Pmod Header JA set_property -dict {PACKAGE_PIN G17 IOSTANDARD LVCMOS33} [get_ports {JA[0]}] ... set_property -dict {PACKAGE_PIN K18 IOSTANDARD LVCMOS33} [get_ports {JA[7]}]</span></span></code> </pre> <br>  The RTL scheme can be explored in the RTL Analisys ‚Üí Schematic tab, where the SPI interface module "mfp_pmod_als_spi_receiver" is located in the "mfp_system": <br><br><img src="https://habrastorage.org/web/661/a01/6fe/661a016fe8fa47649b9ab8dcf1f07772.png"><br><br>  To upload the created project to FPGA, you need to generate a bitstream file ‚Äúcmoda7.bit‚Äù, for this, in the tab Program and Debug ‚Üí Generate Bitstream and wait for the operation to complete: <br><br><img src="https://habrastorage.org/web/0a1/69b/586/0a169b5866da4cb895f6545350f270b7.png"><br><br>  After creating the bitstream file, you need to load it into the board, for this, in the Program and Debug tab ‚Üí open the Open Hardware Manager ‚Üí Open Target ‚Üí Auto Connect ‚Üí Program Device and load the system: <br><br><img src="https://habrastorage.org/web/ac4/a44/7e3/ac4a447e38244b2b810968eb0fd8f875.png"><br><br><h4>  Download programs for working with the sensor </h4><br>  In order for the processor to exchange data with the sensor, you need to write a program and load it into a RAM1 block that is also connected to the AHB Lite bus. <br><br>  The MIPSfpga processor is programmed using Imagination‚Äôs <a href="https://community.imgtec.com/developers/mips/tools/codescape-mips-sdk/download-codescape-mips-sdk-essentials/">Codescape</a> development tools.  Install Codescape SDK and OpenOCD.  Codescape supports both C and assembly language programming. <br><br>  To download the code to the system, go to the folder downloaded mipsfpga plus ‚Üí github ‚Üí mipsfpga-plus ‚Üí programs ‚Üí 01_light_sensor open ‚Äúmfp_memory_mapped_registers.h‚Äù. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MFP_LIGHT_SENSOR_ADDR 0xBF800014  #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MFP_LIGHT_SENSOR (* (volatile unsigned *) MFP_LIGHT_SENSOR_ADDR )</span></span></code> </pre><br>  next, open main.c and write a couple of lines: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"mfp_memory_mapped_registers.h"</span></span></span><span class="hljs-meta"> int main () { int n = 0; for (;;) { MFP_7_SEGMENT_HEX = MFP_LIGHT_SENSOR; } return 0; }</span></span></code> </pre><br>  After in the folder we find the script that compiles the code: <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">02</span></span>_compile_and_link</code> </pre> <br>  Generate the motorola_s_record file: <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">08</span></span>_generate_motorola_s_record_file</code> </pre> <br>  Check to which COM port the USB UART converter is connected: <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">11</span></span>_check_which_com_port_is_used</code> </pre> <br>  Modify the 12_upload_to_the_board_using_uart file: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> a=<span class="hljs-number"><span class="hljs-number">7</span></span> mode com%a% baud=<span class="hljs-number"><span class="hljs-number">115200</span></span> parity=n data=<span class="hljs-number"><span class="hljs-number">8</span></span> stop=<span class="hljs-number"><span class="hljs-number">1</span></span> to=off xon=off odsr=off octs=off dtr=off rts=off idsr=off type program.rec &gt;\.\COM%a%</code> </pre> <br>  where a is the number of the COM port to which the USB UART converter is connected.  And load the program: <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">12</span></span>_upload_to_the_board_using_uart</code> </pre> <br>  The result of the system porting can be viewed on the video: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/k3K7kR8y6ks" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  To understand the processor, and the possibility of writing new modules in the hardware description language (Verilog, VHDL), as well as circuit design, computer architecture, micro-architecture (organization of the processor pipeline) and programming in assembler, and many other things that will help you start learning It is recommended to read a book of everything related to electronics that is written in the article: <a href="https://habrahabr.ru/post/259505/">Free textbook on electronics, computer architecture and low-level programming in Russian</a> . <br><br>  The next part will describe how to connect various peripherals to the MIPSfpga system using the example of the <a href="http://store.digilentinc.com/pmod-kypd-16-button-keypad/">Digilent Pmod KYPD keyboard</a> , the built-in ADC, and the LCD display from Nokia. <br><br>  <a href="https://habrahabr.ru/post/329852/">Porting MIPSfpga to other cards and integrating peripherals into the system.</a>  <a href="https://habrahabr.ru/post/329852/">Part 2</a> </div><p>Source: <a href="https://habr.com/ru/post/329808/">https://habr.com/ru/post/329808/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329794/index.html">Once again about storing logs in Zabbix</a></li>
<li><a href="../329796/index.html">Many pointless conversations</a></li>
<li><a href="../329798/index.html">Constructor</a></li>
<li><a href="../329804/index.html">Git: many useful and different hooks</a></li>
<li><a href="../329806/index.html">Co-marketing as a way to monetize mobile applications</a></li>
<li><a href="../329810/index.html">Organization of events - a niche for IT solutions</a></li>
<li><a href="../329812/index.html">Comparison of contextual advertising automation services (part 2)</a></li>
<li><a href="../329814/index.html">SQL101: Why restoring from a backup is slower than creating it</a></li>
<li><a href="../329816/index.html">Job prospects for Java programmers</a></li>
<li><a href="../329820/index.html">11 things I learned while reading the flexbox specification</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>