<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing "Hello, World" Telegram bot on C</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone, I do not know why this is necessary, but who can come in handy ... 

 Disclaimer: I am by no means a professional C programmer. 

 Wha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing "Hello, World" Telegram bot on C</h1><div class="post__text post__text-html js-mediator-article">  Hello everyone, I do not know why this is necessary, but who can come in handy ... <br><br>  <b>Disclaimer:</b> I am by no means a professional C programmer. <br><br>  What we need: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>1.</b> Any computer on Linux, Ubuntu, Centos, MacOS ... with access to port 443 or 8443 from the Internet. <br>  <b>2.</b> Any C compiler <br>  <b>3.</b> Libraries openssl, libssl-dev ("apt-get install openssl libssl-dev" in the terminal, for Ubuntu) <br><a name="habracut"></a><br>  So let's get started ... <br><br>  <b>The first</b> thing to do is to create a bot for the father of all @BotFather bots, omit all the details and assume that everyone coped with this task and received a token, something like: <br>  373288854: AAHHT77v5_ZNEMus4bfn6dxiMeeEwgwJ <br><br>  Next, create an ssl certificate to install WebHook.  The command looks like this: <br><br><pre><code class="hljs cs">openssl req -newkey rsa:<span class="hljs-number"><span class="hljs-number">2048</span></span> -sha256 -nodes -keyout <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>.key -x509 -days <span class="hljs-number"><span class="hljs-number">365</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>.pem</code> </pre> <br>  We pack the key and public certificate in one file: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">cat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">private</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.key</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pem</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">cert</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pem</span></span></code> </pre> <br>  Install WebHook: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">curl</span></span> -F<span class="hljs-string"><span class="hljs-string">"url=https://_IP:( 443,  8443)/_URI(   ,    )/"</span></span> -F<span class="hljs-string"><span class="hljs-string">"certificate=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">@public</span></span></span><span class="hljs-string">.pem"</span></span> https://api.telegram.org/bot/setWebhook/</code> </pre> <br>  A JSON response must come from something of the type success: true ... if not, then check everything and try again. <br><br>  Getting to the most interesting: <br><br>  Create a file main.c and open it in any editor.  We include the necessary libraries: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;openssl/bio.h&gt; #include &lt;openssl/ssl.h&gt; #include &lt;unistd.h&gt; #include &lt;openssl/err.h&gt; #include &lt;netinet/in.h&gt; #include &lt;sys/socket.h&gt; #include &lt;sys/types.h&gt; #include &lt;resolv.h&gt; #include &lt;netdb.h&gt;</span></span></span></span></code> </pre><br>  Socket initialization function: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitializeSocket</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> port)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sd &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sockaddr_in</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s_addr</span></span></span><span class="hljs-class">;</span></span> s_addr.sin_family = AF_INET; s_addr.sin_addr.s_addr = INADDR_ANY; s_addr.sin_port = htons(port); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bind(sd, (struct sockaddr *)&amp;s_addr, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(s_addr)) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"Binding Error!\n"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">-3</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sd; }</code> </pre><br>  Enable SSL / TLS: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">SSL_CTX * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitializeSSL</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] certificate)</span></span></span><span class="hljs-function"> </span></span>{ OpenSSL_add_all_algorithms(); SSL_load_error_strings(); SSL_library_init(); SSL_CTX * sslctx = SSL_CTX_new(TLSv1_2_server_method()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SSL_CTX_use_certificate_file(sslctx, certificate , SSL_FILETYPE_PEM) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">-2</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SSL_CTX_use_PrivateKey_file(sslctx, certificate, SSL_FILETYPE_PEM) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">-2</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!SSL_CTX_check_private_key(sslctx)) { <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">-2</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sslctx; }</code> </pre><br>  Actually main () itself: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ SSL_CTX * sslctx = InitializeSSL(<span class="hljs-string"><span class="hljs-string">"cert.pem"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//         int sd = InitializeSocket(8443); //      WebHook listen(sd, 5); //     while (1) { //   int client = accept(sd, NULL, NULL) // accept   ,     ,    sockaddr,           ,         NULL,    . SSL * ssl = SSL_new(sslctx); //C ssl  SSL_set_fd(ssl, client); //     if (SSL_accept(ssl) &lt;= 0) { //  ,           SSL_clear(ssl); close(newsd); continue; } //     fork()      ,         int pid = fork(); if (pid != 0) { //  ,         SSL_clear(ssl); close(newsd); continue; } //       //     .... exit(0); //   } }</span></span></code> </pre><br>  Since Telegram uses the HTTP protocol, I will clarify some points: <br><br>  Any HTTP request consists of headers separated by "\ r \ n", and the body separated from the headers "\ r \ n \ r \ n" may be empty, but the separator "\ r \ n \ r \ n" is always present .  Requests from Telegram will come by the POST method, the body will be in JSON format. <br><br>  An example of a request similar to Telegram: <br><br><pre> <code class="hljs tex">POST /(URI    WebHook) HTTP/1.1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> ....     Content-Type: application/json<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> (   ) Content-Length: 256<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> (   ,  ) ..../r/n/r/n Json </code> </pre><br>  Each time a person sends a bot message, the telegraph server will send similar requests to our server.  In general, it is not necessary to answer them, but in the case of a Telegram, it is necessary, otherwise it will send the same request cyclically. <br><br>  To do this, we will prepare a short HTTP response: <br><br><pre> <code class="hljs tex">HTTP/1.1 200 OK<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span> Connection: close<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">r</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span></code> </pre><br>  These two fields are enough to tell the Telegram server that everything is normal, the answer is 200 and you can close the connection <br><br>  We continue to write the program.  Inside the loop after creating a child process ... <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[] response = <span class="hljs-string"><span class="hljs-string">"HTTP/1.1 200 OK\r\nConnection: close\r\n\r\n"</span></span>; <span class="hljs-comment"><span class="hljs-comment">// HTTP response char header[1024]; bzero(header,1024); //               . int s = 0; int n = 0; while (strcmp(header + s - strlen("\r\n\r\n"), "\r\n\r\n") != 0) { //strcmp         0,      strlen("\r\n\r\n")   "\r\n\r\n",      n = SSL_read(ssl,header+s,1); //      header + s, s -  -   s += n; //n - -     } //,  ,     , uri, content-type   content-length . if (strstr(header,"POST /(URI    WebHook) HTTP/1.1\r\n") == NULL) { //   POST ....  header,      NULL,    ,       SSL_clear(ssl); close(client); exit(0); } //   ,   application/json; if (strstr(header, "Content-Type: application/json") == NULL) { SSL_clear(ssl); close(client); exit(0); } //  ,     int len = atoi(strstr(header, "Content-Length: ") + strlen("Content-Length: ")); //strstr       ,    "Content-Length: ",  -      ,     "Content-Length: "      int  atoi(char *); char body[len+2]; bzero(body, len+2); //   ,          ,    ,           -  n = 0; s = 0; while (len - s &gt; 0) { //                - n = SSL_read(ssl, request + s, len - s); //      ,      ,      ,   SSL_read  -   s += n; } //    ,   http response    SSL_write(ssl, response, (int)strlen(response)); SSL_clear(ssl); SSL_free(ssl); close(client); //    "Hello, World"          "Hello, World!",                chat_id int chat_id = atoi(strstr("\"chat_id\":") + strlen("\"chat_id\":")); //      Content-Length //   ,       SendMessage char msg[] = "Hello, World!"; SendMessage(chat_id, msg); //  </span></span></code> </pre><br>  To send requests, we almost need to initialize the socket and ssl, but unlike receiving requests, we will not wait for the connection, we will just send the data immediately: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> chat_id, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] msg)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> port = <span class="hljs-number"><span class="hljs-number">443</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> host[] = <span class="hljs-string"><span class="hljs-string">"api.telegram.org"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//     //  HTTP    ,     char header[] = "POST /bot352115436:AAEAIEPeKdR2-SS7p9jGeksQljkNa9_Smo0/sendMessage HTTP/1.1\r\nHost: files.ctrl.uz\r\nContent-Type: application/json\r\nContent-Length: %d\r\nConnection: close\r\n\r\n%s"; //     char tpl[] = "{\"chat_id\":%d,\"text\":\"%s\"}"; char body[strlen(tpl)+strlen(msg)+16]; bzero(body, strlen(tpl)+strlen(msg)+16); sprintf(body,tpl,chat_id,msg); // printf,    char[] char request[strlen(header)+strlen(body)+4]; bzero(request,strlen(header)+strlen(body)+4); sprintf(request, header, strlen(body), body); //  ,    struct hostent *server; struct sockaddr_in serv_addr; int sd; sd = socket(AF_INET, SOCK_STREAM, 0); if (sd &lt; 0) exit(-5); server = gethostbyname(host); //   ip      url if (server == NULL) exit(-6); bzero(&amp;serv_addr, sizeof(serv_addr)); serv_addr.sin_family = AF_INET; serv_addr.sin_port = htons(portno); memcpy(&amp;serv_addr.sin_addr.s_addr,server-&gt;h_addr,server-&gt;h_length); if (connect(sd,(struct sockaddr *)&amp;serv_addr,sizeof(serv_addr)) &lt; 0) { exit(-6);} SSL_CTX * sslctx = SSL_CTX_new(TLSv1_client_method()); SSL * cSSL = SSL_new(sslctx); SSL_set_fd(cSSL, sfd); SSL_connect(cSSL); SSL_write(cSSL,request,(int)strlen(request)); //  ,           ,      -   char str[1024]; SSL_read(cSSL, str, 1024); //     SSL_clear(cSSL); SSL_CTX_free(sslctx); close(sd); }</span></span></code> </pre><br>  On this, in principle, everything.  Save the file in the same folder with the certificate, compile it with any compiler and run: <br><br><pre> <code class="hljs swift">clang main.<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> -o bot -lcrypto -lssl ./bot</code> </pre> <br>  <b>The end!</b> <br><br>  I hope the article will be useful to someone. </div><p>Source: <a href="https://habr.com/ru/post/325846/">https://habr.com/ru/post/325846/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325836/index.html">Kotlin + Rx2: A reactive and functional approach to the development of mobile applications</a></li>
<li><a href="../325838/index.html">Organization of adaptive layout in BEM with SCSS</a></li>
<li><a href="../325840/index.html">Ways of de-anonymization of community leaders and Vkontakte applications</a></li>
<li><a href="../325842/index.html">Analysis of level schemes for improving multiplayer shooters</a></li>
<li><a href="../325844/index.html">The updated Mirai botnet is back, becoming even more powerful.</a></li>
<li><a href="../325848/index.html">Development and testing of chef dolls with Sparrowdo v2 tool</a></li>
<li><a href="../325850/index.html">Examples of real patches in PostgreSQL: part 3 of N</a></li>
<li><a href="../325852/index.html">Enough design in the sketch. Do design in the browser</a></li>
<li><a href="../325856/index.html">Facebook API: fixing a broken Like button on a site</a></li>
<li><a href="../325858/index.html">The world of payment mediation: a workshop in magic</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>