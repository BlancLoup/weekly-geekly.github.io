<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ordering server optimization from a hoster - keep your ears peeled</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A couple of days ago, a man asked me with a rather routine request: to tweak the VPS settings to speed it up - lately there was a sharp increase in at...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ordering server optimization from a hoster - keep your ears peeled</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/554/583/642/5545836424f090534f8609ed8c6f5a99.png" alt="image" align="right">  A couple of days ago, a man asked me with a rather routine request: to tweak the VPS settings to speed it up - lately there was a sharp increase in attendance on the site, and the server began to bend at peak times. <br><br>  It would be an ordinary and dismal article about nginx and opcode-caching if the server had not been "optimized" by the technical support of the hoster before :-) <br><br>  About what I discovered in the process of optimization, I am writing this small note in order to protect others from similar tricks of hosters.  :-) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a>  Since a quick solution was required (for 1 hour of work), I went along the standard path: nginx / PHP / expires accelerator for static / disabling access logs.  nginx was already, and the rest was done by the 3rd number.  Out of the corner of his eye he noted that PHP is working in CGI mode, and not mod_php (I didn‚Äôt touch it right away - you always have to figure out if something was tied to the user from which PHP was working).  Of course, there was an improvement in performance (see the graph on the right), but very far from what I expected (only 50% of the CPU is available on the graph, so where the graph is 50%, everything becomes very bad).  In addition, when I woke up in the morning, I saw a letter stating that some of the pages had stopped working (and as luck would have it, the pages that I watched after changing the settings worked). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/989/8f8/6a4/9898f86a478bb8bc0af65042059d0e4c.png" alt="image" align="right">  Went to look more in detail the second time, starting with CGI.  I have never seen anything like this, mod_php is everywhere for a long time and by default, and in all respects faster than CGI (I don‚Äôt say anything about FCGI here).  And as we know, when working in the CGI mode, the opcode cache APC is not fumbled between PHP processes, and accordingly no performance gain comes out of it. <br><br>  Non-working pages turned out to be due to the conflict between APC and Zend Optimizer (I didn‚Äôt expect to see it here) - it shouldn‚Äôt work at all, but some of the pages miraculously worked. <br><br>  Having talked with the customer, I find out that this is how the server has configured technical support for the optimization request.  Let's take a closer look at what they set up for them: <br><br><h4>  What has been configured hoster compared with the default configuration: </h4><br>  1) nginx: 8 processes, 65k connections (despite the fact that the server is dying already from 100, and nginx is preparing to process 650'000).  expires statics is not configured (not to mention the return of statics directly without Apache2).  Access logs are written in both Apache and nginx. <br>  2) PHP in CGI mode.  This eliminates the use of popular PHP accelerators.  Zend Optimizer practically does not help.  The slowest mode of PHP, worse is hard to come up with something. <br>  3) Apache for nginx is zealously trying to run up to 150 processes of itself and up to 150 PHP processes.  Obviously, the memory is very vigorously surviving.  Hoster recommends switching to a thicker tariff, and the customer actually transfers, however, a thicker tariff is not enough for a long time. <br>  4) MySQL with a config for 50MB of used memory (with available gigabytes). <br><br><h4>  What was configured by me / had to be configured from the very beginning: </h4><br>  1) nginx, 1 process (the ordinary server and 10,000 connections are ‚Äúnot in a standing‚Äù state, the rest is extra memory consumption).  Return expires headers for statics. <br>  2) PHP in the default mode, mod_php.  Any PHP opcode cache (for example, APC). <br>  3) apache2 is limited to 8-16 processes = fixed memory consumption. <br>  4) MySQL - config for half the available memory. <br><br>  The result is visible on the 4th.  The load is dramatically reduced, the memory consumption is now stable, and allows you to switch to the tariff twice cheaper (however, they did not do this, because attendance is growing rapidly). <br><br><h4>  Summary </h4><br>  In this case, there was either a low administrator qualification (which I sincerely want to believe) performing the server optimization ticker, or <b>direct sabotage</b> (that's what it is called) in order to hook the client on the fatter tariff, and in the future - on a dedicated server.  Host name leave a secret, so that no one thought that this can not happen to him.  Only mentally send a ray of diarrhea. <img src="https://habrastorage.org/getpro/habr/comment_images/589/4ca/0c9/5894ca0c9e7ef627bfd7178b08017a4b.gif">  (of course I informed the management of the company about the problem) <br><br>  Obviously, there is a clear conflict of interest: it is NOT profitable for a hoster to have your site run quickly after optimization, and consume little memory - after all, then it will lose a lot of money in the coming long years. <br><br>  So make sure that the hoster is setting you up there and keep an eye on the munin charts. <img src="https://habrastorage.org/getpro/habr/comment_images/589/4ca/0c9/5894ca0c9e7ef627bfd7178b08017a4b.gif"></div><p>Source: <a href="https://habr.com/ru/post/98525/">https://habr.com/ru/post/98525/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../98517/index.html">How are you going with the pension to solve the question% username%?</a></li>
<li><a href="../98519/index.html">LVEE-2010 conference ended</a></li>
<li><a href="../98520/index.html">Convenient search for ATMs on the map of Ukraine</a></li>
<li><a href="../98521/index.html">HTC Incredible (Verizon)</a></li>
<li><a href="../98524/index.html">Twitter is becoming the fastest growing search engine</a></li>
<li><a href="../98526/index.html">31 startups from Y Combinator</a></li>
<li><a href="../98527/index.html">The battle for the national operating system has begun</a></li>
<li><a href="../98528/index.html">On the intelligence of search engines</a></li>
<li><a href="../98530/index.html">What, where, where: an overview of travel blogging services</a></li>
<li><a href="../98533/index.html">Optional enhancement of entry criteria</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>