<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SSH Layer 3 Tunnel Organization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this section I will describe how to use the OpenSSH features to create a Layer 3 tunnel, as applied to the OS Debian GNU / Linux (it will probably ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SSH Layer 3 Tunnel Organization</h1><div class="post__text post__text-html js-mediator-article">  In this section I will describe how to use the OpenSSH features to create a Layer 3 tunnel, as applied to the OS Debian GNU / Linux (it will probably work in Ubuntu without any particular problems). <br><a name="habracut"></a><br>  It looks like this scheme that we build: <br><br><pre>  ---------- / \ _ / - \ / \ / - \ -----------------
 |  Client | ~~~~~~~ / Internet / ~~~~~~~ |  Server |
 ---------- \ _ / - \ / \ _ / \ / / -----------------
 || \ \ || \
 ||  {tun0} {vlan8} ||  {tun1}
 ||  ||
 \ - ================= tunnel ============== - /

     * vlan8 - 212.90.160.1/27
     * tun0 - 10.254.254.2/30
     * tun1 - 10.254.254.1/30 </pre><br><br>  Preparatory work on the client side. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In our scheme, we will use key authentication, for this we first generate the key itself (rsa key type, 4KB size) and copy it to the root account on the server (on the server, while having to open it in time for login root) - PermitRootLogin yes): <br><br><pre>  # sudo ssh-keygen -t rsa -b 4096
 # ssh-copy-id -i .ssh / id_rsa.pub root@212.90.160.1 </pre><br><br>  At this stage, we will already have the saved ssh key in .ssh / known_hosts, giving the answer ‚Äúyes‚Äù to something like this: <br><br><pre>  The authenticity of host '212.90.160.1 (212.90.160.1)' can't be established.
 RSA key fingerprint is aa: fe: a0: 38: 7d: 11: 78: 60: 01: b0: 80: 78: 90: ab: 6a: d2.
 Are you sure you want to continue connecting (yes / no)?  yes
 Warning: Permanently added '212.90.160.1' (RSA) to the list of known hosts. </pre><br><br>  and the client authorization key already copied into .ssh / authorized_keys on the server side. <br><br>  Next, we write on the client side the interface itself in / etc / network / interfaces: <br><br><pre>  auto tun0
 iface tun0 inet static
 pre-up ssh -S / var / run / ssh-myvpn-tunnel-control -M -f -w 0: 1 212.90.160.1 true
 pre-up sleep 5
 post-up ip ls tun0 mtu 1300
 address 10.254.254.2
 netmask 255.255.255.252
 pointopoint 10.254.254.1
 post-down ssh -S / var / run / ssh-myvpn-tunnel-control -O exit 212.90.160.1 </pre><br><br>  At this stage, stop working with the client and proceed to the server. <br><br>  Preparatory work on the server side. <br><br>  On the server side, first of all, we make the following changes to / etc / ssh / sshd_config: <br><br><pre>  PermitTunnel point-to-point
 PermitRootLogin forced-commands-only </pre><br><br>  Now edit /root/.ssh/authorized_keys, adding to it a command to organize the tunnel: <br><br><pre>  tunnel = "1", command = "/ sbin / ifdown tun1; / sbin / ifup tun1" ssh-rsa AAAA ...... X9vc = root @ ipclub </pre><br><br>  After that, edit / etc / network / interfaces: <br><br><pre>  auto vlan8
 iface vlan8 inet static
 address 212.90.160.1
 netmask 255.255.255.224
 network 212.90.160.0
 broadcast 212.90.160.31
 gateway 212.90.160.30
 vlan_raw_device eth0
 mtu 1400

 iface tun1 inet static
 address 10.254.254.1
 netmask 255.255.255.252
 pointopoint 10.254.254.2
 post-up ip ls tun0 mtu 1300 </pre><br><br>  Do not forget to define in /etc/sysctl.conf the status of net.ipv4.conf.default.forwarding: <br>  Code <br><br><pre>  net.ipv4.conf.default.forwarding = 1 </pre><br><br>  well, or before using the tunnel: <br><br><pre>  $ sudo sysctl net.ipv4.conf.default.forwarding = 1 </pre><br><br>  Important!  If you do not set net.ipv4.conf.default.forwarding to 1, then the tunnels will not rise! <br><br>  Actually at this stage all the preparatory work is completed.  We try to lift our tunnel from the client: <br><br><pre>  $ sudo ifup tun0
 $ ip al dev tun0
 9: tun0: mtu 1300 qdisc pfifo_fast qlen 500
 link / [65534]
 inet 10.254.254.2 peer 10.254.254.1/30 scope global tun0
 $ ping -c2 10.254.254.1
 PING 10.254.254.1 (10.254.254.1): 56 data bytes
 64 bytes from 10.254.254.1: icmp_seq = 0 ttl = 64 time = 15.116 ms
 64 bytes from 10.254.254.1: icmp_seq = 1 ttl = 64 time = 16.454 ms
 --- 10.254.254.1 ping statistics ---
 2 packets transmitted, 2 packets received, 0% packet loss
 round-trip min / avg / max / stddev = 15.116 / 15.785 / 16.454 / 0.669 ms </pre><br><br>  And watch icmp traffic on the server side: <br><br><pre>  $ sudo tshark -tad -pni tun1
 Running as user "root" and group "root".  This could be dangerous.
 Capturing on tun1
 2009-03-10 11: 25: 53.927598 10.254.254.2 -&gt; 10.254.254.1 ICMP Echo (ping) request
 2009-03-10 11: 25: 53.927649 10.254.254.1 -&gt; 10.254.254.2 ICMP Echo (ping) reply
 2009-03-10 11: 25: 54.567857 10.254.254.2 -&gt; 10.254.254.1 ICMP Echo (ping) request
 2009-03-10 11: 25: 54.567910 10.254.254.1 -&gt; 10.254.254.2 ICMP Echo (ping) reply </pre><br><br>  Further you can work with these interfaces as with usual eth, vlan, gre, etc.  Route traffic through them, configure filtering rules, etc.  etc.  The flight of thought is limited only by fantasy;) However, we do not forget that the tunnel is still built on the third level, therefore marking QoS packets will hardly give the result that we would like to expect. <br><br>  Actually, this could have been finished, but I want to draw attention to one ‚Äúslippery‚Äù moment, for those who want to raise several SSH Layer 3 tunnels. <br>  Client: pre-up ssh -S / var / run / ssh-myvpn-tunnel-control -M -f -w 0: 1 212.90.160.1 true <br>  Server: tunnel = "1", command = "/ sbin / ifdown tun1; / sbin / ifup tun1" ssh-rsa AAAA ...... X9vc = root @ ipclub <br>  0 is the client side tunnel number <br>  1 is the server side tunnel number <br><br>  Here, I almost forgot. <br>  There is another unpleasant moment.  Connection, periodically can "fall off".  Therefore, it would be nice to take care of where the nodud in the cron will execute something like this on the client side: <br><br><pre>  $ cat /etc/cron.d/tun0
 PATH = / usr / local / sbin: / usr / local / bin: / sbin: / bin: / usr / sbin: / usr / bin
 * / 5 * * * * root fping -c4 10.254.254.1 ||  (/ sbin / ifdown tun0; sleep 5; / sbin / ifup tun0)
 $ sudo /etc/init.d/cron restart </pre></div><p>Source: <a href="https://habr.com/ru/post/81638/">https://habr.com/ru/post/81638/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../81630/index.html">Free sending SMS notifications in Zabbix</a></li>
<li><a href="../81632/index.html">Working with forms in Django</a></li>
<li><a href="../81633/index.html">We draw volumetric images in Inkscape</a></li>
<li><a href="../81635/index.html">Nontraditional animals in the house</a></li>
<li><a href="../81637/index.html">Otrivin Sea</a></li>
<li><a href="../81639/index.html">Tenders and fingertips</a></li>
<li><a href="../81645/index.html">No official Python certification</a></li>
<li><a href="../81646/index.html">Google improves search</a></li>
<li><a href="../81654/index.html">Automating the use of Javascript API Vkontakte</a></li>
<li><a href="../81655/index.html">Briefly about this GF1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>