<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Budget SMS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings to all the farmers! 

 Of course, the licked topic about sending SMS messages, but as they say: "a lot - not a little." Somehow it happened ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Budget SMS</h1><div class="post__text post__text-html js-mediator-article">  <b>Greetings to all the farmers!</b> <br><br>  Of course, the licked topic about sending SMS messages, but as they say: "a lot - not a little."  Somehow it happened that it was she who constantly persecutes me: then some other kind people will be asked to take part (by advice, for example) in the implementation of the budget distribution of messages.  And therefore, in order not to dissolve the accumulated good, I will leave it here, but what if someone comes in handy ... <br><habracut><br>  So, with ... We omit all the options for implementation on the basis of the usual computer and the axis of the NT family.  And we proceed immediately to the "autonomous" systems. <br><br>  What boasts arduino in this direction?  I will answer right away, IT works, but there are nuances about which I will write below.  In general, we have the Chinese version of the arduino 2560 (almost the entire line has been tried) and two additional modules - the W5100 network (the most stable version) and GSM SIM 900. It looks like this whole thing somehow. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/2c8/ead/201/2c8ead2011b102984e5b8d84ba22f682.png" alt="image"><br><br>  The task was as follows: <br>  - the device must be able to communicate on http <br>  - send message <br>  - output the result in json format <br><br>  Google shares all the necessary information, and at the output we get the following code: <br><br><div class="spoiler">  <b class="spoiler_title">Sketch</b> <div class="spoiler_text"><a name="habracut"></a><pre><code class="hljs lua">#include &lt;SPI.h&gt; #include &lt;Ethernet.h&gt; #include &lt;String.h&gt; #include <span class="hljs-string"><span class="hljs-string">"SIM900.h"</span></span> #include &lt;SoftwareSerial.h&gt; #include <span class="hljs-string"><span class="hljs-string">"sms.h"</span></span> #include &lt;LiquidCrystal_I2C.h&gt; #include &lt;Wire.h&gt; <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> mac[] = { <span class="hljs-number"><span class="hljs-number">0x90</span></span>, <span class="hljs-number"><span class="hljs-number">0xA2</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span> }; IPAddress ip(<span class="hljs-number"><span class="hljs-number">192</span></span>,<span class="hljs-number"><span class="hljs-number">168</span></span>,<span class="hljs-number"><span class="hljs-number">34</span></span>,<span class="hljs-number"><span class="hljs-number">139</span></span>); EthernetServer server(<span class="hljs-number"><span class="hljs-number">80</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> char_in = <span class="hljs-number"><span class="hljs-number">0</span></span>; String HTTP_req; SMSGSM sms; boolean started=<span class="hljs-literal"><span class="hljs-literal">false</span></span>; bool power = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; LiquidCrystal_I2C lcd(<span class="hljs-number"><span class="hljs-number">0x27</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, POSITIVE); void setup() { Serial.begin(<span class="hljs-number"><span class="hljs-number">9600</span></span>); lcd.begin(<span class="hljs-number"><span class="hljs-number">16</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>); lcd.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"INIT GSM..."</span></span>); lcd.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>); lcd.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"WAIT!!!"</span></span>); //powerUp(); gsm.forceON(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gsm.begin(<span class="hljs-number"><span class="hljs-number">4800</span></span>)) { Serial.println(<span class="hljs-string"><span class="hljs-string">"\nstatus=READY"</span></span>); lcd.clear(); lcd.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"READY"</span></span>); started=<span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Serial.println(<span class="hljs-string"><span class="hljs-string">"\nstatus=IDLE"</span></span>); lcd.clear(); lcd.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"IDLE"</span></span>); } Ethernet.begin(mac, ip); server.begin(); } void software_reset() { asm volatile (<span class="hljs-string"><span class="hljs-string">" jmp 0"</span></span>); } void loop() { EthernetClient client = server.available(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (client.connected()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.available()) { char_in = client.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>(); // HTTP_req += char_in; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (char_in == <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) { Serial.println(HTTP_req); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(HTTP_req.indexOf(<span class="hljs-string"><span class="hljs-string">"GET /res"</span></span>) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { reset_processing(&amp;HTTP_req, &amp;client); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(HTTP_req.indexOf(<span class="hljs-string"><span class="hljs-string">"GET /sms"</span></span>) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { sms_processing(&amp;HTTP_req, &amp;client); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(HTTP_req.indexOf(<span class="hljs-string"><span class="hljs-string">"GET /test"</span></span>) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { test_processing(&amp;HTTP_req, &amp;client); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { client_header(&amp;client); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } } HTTP_req = <span class="hljs-string"><span class="hljs-string">""</span></span>; client.stop(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(power) { delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); software_reset(); } } <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* string2char(String command) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(command.length()!=<span class="hljs-number"><span class="hljs-number">0</span></span>){ <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *p = const_cast&lt;<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>*&gt;(command.c_str()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p; } } void parse_data(String *data) { data-&gt;replace(<span class="hljs-string"><span class="hljs-string">"GET /sms/"</span></span>,<span class="hljs-string"><span class="hljs-string">""</span></span>); data-&gt;replace(<span class="hljs-string"><span class="hljs-string">"GET /test/"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); int lastPost = data-&gt;indexOf(<span class="hljs-string"><span class="hljs-string">"\r"</span></span>); *data = data-&gt;substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, lastPost); data-&gt;replace(<span class="hljs-string"><span class="hljs-string">" HTTP/1.1"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); data-&gt;replace(<span class="hljs-string"><span class="hljs-string">" HTTP/1.0"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); data-&gt;trim(); } // explode String request_value(String *data, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> separator, int index) { int found = <span class="hljs-number"><span class="hljs-number">0</span></span>; int strIndex[] = {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>}; int maxIndex = data-&gt;length()<span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(int i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;=maxIndex &amp;&amp; found&lt;=index; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(data-&gt;charAt(i)==separator || i==maxIndex) { found++; strIndex[<span class="hljs-number"><span class="hljs-number">0</span></span>] = strIndex[<span class="hljs-number"><span class="hljs-number">1</span></span>]+<span class="hljs-number"><span class="hljs-number">1</span></span>; strIndex[<span class="hljs-number"><span class="hljs-number">1</span></span>] = (i == maxIndex) ? i+<span class="hljs-number"><span class="hljs-number">1</span></span> : i; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> found&gt;index ? data-&gt;substring(strIndex[<span class="hljs-number"><span class="hljs-number">0</span></span>], strIndex[<span class="hljs-number"><span class="hljs-number">1</span></span>]) : <span class="hljs-string"><span class="hljs-string">""</span></span>; } bool gsm_status() { bool result = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; switch(gsm.CheckRegistration()) { case <span class="hljs-number"><span class="hljs-number">1</span></span>: result = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; default: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } bool gsm_send(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *number_str, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *message_str) { bool result = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; switch(sms.SendSMS(number_str, message_str)) { case <span class="hljs-number"><span class="hljs-number">1</span></span>: result = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; default: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } void reset_processing(String *data, EthernetClient *cl) { client_header(cl); cl-&gt;println(<span class="hljs-string"><span class="hljs-string">"\{\"error\": 0, \"message\": \"restarting...\"\}"</span></span>); power = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } void test_processing(String *data, EthernetClient *cl) { parse_data(data); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(started) { client_header(cl); cl-&gt;println(<span class="hljs-string"><span class="hljs-string">"\{\"id\":"</span></span> + request_value(data, <span class="hljs-string"><span class="hljs-string">'/'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>) + <span class="hljs-string"><span class="hljs-string">",\"error\":0"</span></span> + <span class="hljs-string"><span class="hljs-string">",\"message\":\"test success\"\}"</span></span>); } } void sms_processing(String *data, EthernetClient *cl) { parse_data(data); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(started) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gsm_send(string2char(request_value(data, <span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)), string2char(request_value(data, <span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>)))) { client_header(cl); cl-&gt;println(<span class="hljs-string"><span class="hljs-string">"\{\"id\":"</span></span> + request_value(data, <span class="hljs-string"><span class="hljs-string">'/'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>) + <span class="hljs-string"><span class="hljs-string">",\"error\":0"</span></span> + <span class="hljs-string"><span class="hljs-string">",\"message\":\"success\"\}"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!gsm_status()) { client_header(cl); cl-&gt;println(<span class="hljs-string"><span class="hljs-string">"\{\"id\":"</span></span> + request_value(data, <span class="hljs-string"><span class="hljs-string">'/'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>) + <span class="hljs-string"><span class="hljs-string">",\"error\":2"</span></span> + <span class="hljs-string"><span class="hljs-string">",\"message\":\"gsm not registered\"\}"</span></span>); power = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { client_header(cl); cl-&gt;println(<span class="hljs-string"><span class="hljs-string">"\{\"id\":"</span></span> + request_value(data, <span class="hljs-string"><span class="hljs-string">'/'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>) + <span class="hljs-string"><span class="hljs-string">",\"error\":1"</span></span> + <span class="hljs-string"><span class="hljs-string">",\"message\":\"fail\"\}"</span></span>); } } } } void client_header(EthernetClient *cl) { cl-&gt;println(<span class="hljs-string"><span class="hljs-string">"HTTP/1.1 200 OK"</span></span>); cl-&gt;println(<span class="hljs-string"><span class="hljs-string">"Content-Type: text/plain"</span></span>); cl-&gt;println(<span class="hljs-string"><span class="hljs-string">"Connection: close"</span></span>); cl-&gt;println(); }</code> </pre> <br></div></div><br><br>  Fill, packaged in a box.  It seems to be beautiful, we give to good people. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/db4/c7b/f30/db4c7bf3018aa18445f5d8f46f7b8885.png" alt="image"><br><br>  What happened in the code: <br>  - raised a simple http <br>  - we process simple GET <br>  - we send the received data via SERIAL to SIM 900 <br>  - we answer with the help of ‚ÄúJSON‚Äù <br><br>  And here there is one big nuance; smart people have a task to implement some service in order to learn how to send a packet of messages through this device right away, but this is not my problem.  In production, the device behaved satisfactorily. <br><br>  We are increasing capacity ... The task is completely analogous: repetition is the mother of learning.  Smart people have already created a cool service to work with the previous device: turn, history and other usefulness. <br><br>  So, we have a raspberry pi on hand, the same SIM 900 module (it was taken only for experiments, because Linux works fine with 3g-modems via USB) and the 3g-modem huawei e-line itself <br><br><img src="https://habrastorage.org/getpro/habr/post_images/abe/439/99d/abe43999db553041d1ada411cc3edf09.jpg" alt="image"><br><br>  Again we ask Google the right questions, read the results, determine the implementation language - python - quickly, simply, reliably ... <br><br><div class="spoiler">  <b class="spoiler_title">script</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> serial, time <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> RPi.GPIO <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> GPIO app = Flask(__name__) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sim900_on</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> gsm = serial.Serial(<span class="hljs-string"><span class="hljs-string">'/dev/ttyAMA0'</span></span>, <span class="hljs-number"><span class="hljs-number">115200</span></span>, timeout=<span class="hljs-number"><span class="hljs-number">1</span></span>) gsm.write(<span class="hljs-string"><span class="hljs-string">'ATZ\r'</span></span>) time.sleep(<span class="hljs-number"><span class="hljs-number">0.05</span></span>) abort_after = <span class="hljs-number"><span class="hljs-number">5</span></span> start = time.time() output = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: output = output + gsm.readline() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'OK'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> output: gsm.close() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> delta = time.time() - start <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> delta &gt;= abort_after: gsm.close() <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-comment"><span class="hljs-comment">#GPIO.setwarnings(False) GPIO.setmode(GPIO.BOARD) GPIO.setup(11, GPIO.OUT) GPIO.output(11, True) time.sleep(1.2) GPIO.output(11, False) return False def gsm_send(id, port, phone, msg): delay = False if 'AMA' in port: delay = True msg = msg.replace('\\n', '\n') msg = msg.replace('\s', ' ') gsm = serial.Serial('/dev/tty%s' % port, 115200, timeout=1) gsm.write('ATZ\r') if delay: time.sleep(0.05) gsm.write('AT+CMGF=1\r\n') if delay: time.sleep(0.05) gsm.write('AT+CMGS="%s"\r\n' % phone) if delay: time.sleep(0.05) gsm.write(msg + '\r\n') if delay: time.sleep(0.05) gsm.write(chr(26)) if delay: time.sleep(0.05) abort_after = 15 start = time.time() output = "" while True: output = output + gsm.readline() #print output if '+CMGS:' in output: print output gsm.close() return '{"id":%s,"error":0,"message":"success", "raw":"%s"}' % (id, output) if 'ERROR' in output: print output gsm.close() return '{"id":%s,"error":0,"message":"fail", "raw":"%s"}' % (id, output) delta = time.time() - start if delta &gt;= abort_after: gsm.close() return '{"id":%s,"error":1,"message":"timeout", "raw":"%s"}' % (id, output) @app.route('/sms/&lt;id&gt;/&lt;port&gt;/&lt;phone&gt;/&lt;msg&gt;',methods=['GET']) def get_data(id, port, phone, msg): return gsm_send(id, port, phone, msg) @app.route('/',methods=['GET']) def index(): return "Hello World" if __name__ == "__main__": sim900_on() app.run(host="0.0.0.0", port=8080, threaded=True)</span></span></code> </pre> <br></div></div><br><br>  We feed the python, launch it using the start-stop-daemon, give it a friendly look, give it to kind people ... <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8d5/45b/678/8d545b678a834c8d7b672338ef4b501c.png" alt="image"><br><br>  It turned out almost one to one, only due to the USB bus system can be expanded.  There were no complaints at all in the production process - everyone was VERY pleased. <br><br>  The device turned out so successful that there was a desire to use this business in "personal" interests, namely to introduce this device into the monitoring system.  But it was necessary to get rid of the main nuance - the lack of a message queue.  I took the principle of implementation from one well-known vendor (he proposed a software and hardware complex, part of which raised an smtp server for processing notifications and sending it to a gsm device).  Such a scheme is embedded in any monitoring system. <br><br>  So, the necessary knowledge has long been obtained, proceed to implement. <br><br><div class="spoiler">  <b class="spoiler_title">SMTP daemon</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python2.7 # -*- coding: utf-8 -*- import smtpd import asyncore import email import MySQLdb import subprocess def InsertNewMessage(phone, msg): conn = MySQLdb.connect(host="localhost", # your host, usually localhost user="sms", # your username passwd="sms", # your password db="sms") # name of the data base c = conn.cursor() c.execute('insert into message_queue (phone, message) values ("%s", "%s")' % (phone, msg)) conn.commit() conn.close() class CustomSMTPServer(smtpd.SMTPServer): def process_message(self, peer, mailfrom, rcpttos, data): msg = email.message_from_string(data) phone = rcpttos[0].split('@',1)[0] addr = mailfrom for part in msg.walk(): if part.get_content_type() == "text/plain": # ignore attachments/html body = part.get_payload(decode=True) InsertNewMessage(phone, str(body)) subprocess.Popen("/home/pi/daemons/sms/pygsmd.py", shell=True) server = CustomSMTPServer(('0.0.0.0', 25), None) asyncore.loop()</span></span></code> </pre> <br></div></div><br><br>  Demonization occurs, as I wrote above, with the help of ‚Äústart-stop-daemon‚Äù, and the smtp script itself starts a subprocess for working with the message base. <br><br><div class="spoiler">  <b class="spoiler_title">gsm script</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python2.7 # -*- coding: utf-8 -*- import serial import time import MySQLdb import commands def gsm_send(port, phone, msg): print 'Sending message: %s to: %s' % (msg, phone) gsm = serial.Serial('/dev/tty%s' % port, 460800, timeout=5, xonxoff = False, rtscts = False, bytesize = serial.EIGHTBITS, parity = serial.PARITY_NONE, stopbits = serial.STOPBITS_ONE ) gsm.write('ATZ\r\n') time.sleep(0.05) gsm.write('AT+CMGF=1\r\n') time.sleep(0.05) gsm.write('''AT+CMGS="''' + phone + '''"\r''') time.sleep(0.05) gsm.write(msg + '\r\n') time.sleep(0.05) gsm.write(chr(26)) time.sleep(0.05) abort_after = 15 start = time.time() output = "" while True: output = output + gsm.readline() #print output if '+CMGS:' in output: #print output gsm.close() return 0 if 'ERROR' in output: #print output gsm.close() return 1 delta = time.time() - start if delta &gt;= abort_after: gsm.close() return 1 def msg_delete(list): conn = MySQLdb.connect(host="localhost", user="sms", passwd="sms", db="sms") c = conn.cursor() c.execute("delete from message_queue where id in %s;" % list) conn.commit() conn.close() def msg_hadle(): list = tuple() conn = MySQLdb.connect(host="localhost", user="sms", passwd="sms", db="sms") c = conn.cursor() c.execute("select * from message_queue") numrows = int(c.rowcount) if numrows &gt; 0: for row in c.fetchall(): result = gsm_send('USB0', ('+' + row[1]), row[2]) if result == 0: list +=(str(row[0]),) conn.close() if len(list) == 1: qlist = str(list).replace(',','') if len(list) &gt; 1: qlist = str(list) if len(list) &gt; 0: msg_delete(qlist) del list while True: try: msg_hadle() except: print "mysql error" time.sleep(10)</span></span></code> </pre> <br></div></div><br><br>  In conjunction with my monitoring system, the device behaves adequately, although it works not so long ago.  I hope the material will be useful to someone. </habracut></div><p>Source: <a href="https://habr.com/ru/post/261387/">https://habr.com/ru/post/261387/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261375/index.html">Analyzing unusual firmware: analysis of the contest Best Reverser</a></li>
<li><a href="../261379/index.html">How not to ruin the architecture right away? Video from the lecture of Evgeny Krivosheev</a></li>
<li><a href="../261381/index.html">Combinatorial testing: generation of test data and not only</a></li>
<li><a href="../261383/index.html">Do I need to participate in conferences?</a></li>
<li><a href="../261385/index.html">Environment for Dell VDI Virtual Machines</a></li>
<li><a href="../261389/index.html">ES6 Browser Development</a></li>
<li><a href="../261391/index.html">As Asterisk opened barriers for me</a></li>
<li><a href="../261395/index.html">Free webinar "Choosing a Transportation Management Systems class information system"</a></li>
<li><a href="../261397/index.html">10 fatal mistakes of the usability of online stores and something else</a></li>
<li><a href="../261403/index.html">How to treat a malfunctioning cloud provider</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>