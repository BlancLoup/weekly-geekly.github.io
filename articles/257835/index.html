<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analysis of CPL malware, part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The fact that in most cases URLs are stored as plain text, or the decryption key is located in the decryption function itself, allows us to extract th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analysis of CPL malware, part 2</h1><div class="post__text post__text-html js-mediator-article">  The fact that in most cases URLs are stored as plain text, or the decryption key is located in the decryption function itself, allows us to extract these URLs automatically from many samples of CPL malware using a special script.  In the case of a sample that stores lines in clear text, the line with the address can be extracted directly from the CPL file.  Otherwise, that is, in the case when the string with the address is encrypted, the script analyzes the decryption function in which the key is stored.  The exceptions were some samples of malware for which the script could not decrypt the encrypted strings.  In such samples, the decryption key was not available in the function, but was located in the resources of the CPL file.  To extract the key from there, the malicious code uses standard APIs for working with resources: <i>FindResource</i> , <i>LoadResource</i> , <i>SizeofResource</i> and <i>LockResource</i> .  The resource itself, in which the decryption key is located, is encrypted. <br><a name="habracut"></a><br><img src="https://habrastorage.org/files/537/2df/68c/5372df68c15c423eb390f335443aa3ad.png"><br>  Fig.  Sample CPL malware with a key to decrypt strings in resources. <br><br>  As we mentioned above, the entry point to the <i>DllMain</i> library <i>is</i> executed before the exported <i>CPlApplet</i> function and does not contain any malicious code in most samples.  However, in some samples, we discovered a special Anti-VM code that allowed a malicious program to detect the virtual machine environment.  The screenshot below shows a fragment of such a code from <i>DllMain</i> . <br><br><img src="https://habrastorage.org/files/94a/963/51f/94a96351f5224abd81d9f9de49d4ea83.png"><br>  Fig.  The code snippet of the CPL malware, which checks the OS environment for a virtual machine. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The above code is responsible for checking the environment of three different environments: Wine, VMware, Virtual PC.  If any of them is present, the <i>save_str</i> function is <i>called</i> .  This function stores in memory a string describing the type of environment.  Further, the <i>CPlApplet</i> function code <i>will</i> check the contents of this line on its first call.  The presence of an identifier for one environment or another signals the <i>CPlApplet</i> function <i>code</i> to complete its execution without executing a block of code that processes the main CPL_DBLCLK message. <br><br>  The figure below shows the code for checking the Wine environment.  To do this, call the function <i>GetProcAddress</i> to get the addresses of the functions <i>ntdll! Wine_get_version</i> and <i>ntdll! Wine_nt_to_unix_file_name</i> .  Obviously, such exports are absent in the conventional system. <br><br><img src="https://habrastorage.org/files/919/844/768/919844768e5f4875952c3e04ef51a797.png"><br>  Fig.  The code for checking the Wine environment. <br><br>  The following screenshot shows the CPL malware code from <i>DllMain</i> , which is responsible for verifying the VMware environment.  It uses a well-known mechanism for obtaining VMware versions using I / O ports.  This check is possible because the virtual machine code takes control of the <i>in</i> instruction of the processor.  The instruction is used for the interaction of the virtual machine and VMware software running on the user's system (host).  The screenshot shows the arguments of this instruction, which lead to the fact that the value ‚ÄúVMXh‚Äù is returned to the calling code in the <i>ebx</i> register. <br><br><img src="https://habrastorage.org/files/b0b/ef4/5f8/b0bef45f827047168adfb7201f8b2aa3.png"><br>  Fig.  VMware environment verification code. <br><br>  For Virtual PC, the check is presented below, while it can be seen that it is performed by executing a special instruction of the <i>vpcext</i> processor.  In a normal OS environment that does not run in a virtual machine, the execution of this instruction will generate an exception. <br><br><img src="https://habrastorage.org/files/9f3/334/bfa/9f3334bfafb8413c9231ca885b648519.png"><br>  Fig.  The verification code for the Virtual PC environment. <br><br>  We mentioned that CPL malware is used as bootloaders or downloaders to download other malware into the system.  In our case, the downloadable malware is a banking Trojan, although any other type of malware can be used instead. <br><br>  We observed several samples of banking Trojans that are loaded with CPL malware.  They all had similar characteristics.  One of the samples of the banker studied by us has the following SHA-1: 3C73CA6A3914A6DF29F01A895C4495B19E71A234.  This executable file is not packaged and the lines found there directly indicate the functions it performs, they are listed below in the list. <br><br><ul><li>  Track events and movements of the mouse cursor, keystrokes, and keyboard layouts.  For example, ‚Äú[enter]‚Äù, ‚Äú[esp]‚Äù, (spacebar), ‚Äú[cima]‚Äù (up arrow), ‚Äú[baixo]‚Äù, (down). </li><li>  The functions of processing sockets and working with them. </li><li>  Functions of interaction with a remote server using an encrypted SSL connection. </li><li>  Handling messages in Portuguese related to online banking operations.  "Utilize o teclado virtual." </li><li>  Support for various network protocols, for example, "ftpTransfer", "mailto:", ": //", "HTTP / 1.0 200 OK". </li><li>  Data collection accounts online services. </li><li>  Some strings are encrypted using the algorithm that was used in the CPL malware samples.  The screenshot below shows these lines. </li></ul><br><img src="https://habrastorage.org/files/4d0/b91/892/4d0b91892cde490f99775724bb72b0e8.png"><br>  Fig.  Encrypted bank malware strings. <br><br>  We managed to decipher these lines, and we received additional information about what functions the banking Trojan performs and what services it focuses on.  The lines contain the following information. <br><br><ul><li>  The names of Brazilian financial institutions and banks: Sicredi, Banco Ita√∫, Santander, Bradesco, bb.com.br (Banco do Brasil), Caixa. </li><li>  Support for compromising the following browsers: Chrome, Opera, Firefox, IE, Safari. </li><li>  URLs: "hxxp: //www.sonucilaclama.com.tr/plugins/editors-xtd/pagebreak/oi/html/h/lg.php", "hxxp: //www.cvicak-polanka.cz/b /notify.php "," hxxp: //64.31.51.19/oi.txt " </li><li>  Track keystrokes such as ‚Äú[Backspace]‚Äù, ‚Äú[Page Up]‚Äù, ‚Äú[Page Down]‚Äù. </li><li>  Data files and temporary files. </li><li>  Lines of various user agents. </li><li>  Commands like "cmd / c taskkill / f / im dwm.exe / t". </li></ul><br>  Thus, the analyzed bankers included the following possibilities: the introduction of malicious code into certain processes, the introduction of legitimate web pages of fake forms and text entry fields, capture of characters typed by the user on the keyboard and tracking the mouse cursor, the mechanism of encrypted interaction with a remote C &amp; C server . <br><br>  The diagram below shows the dynamics of the prevalence of malicious CPL files, according to the data of the virus laboratory of our Latin American office. <br><img src="https://habrastorage.org/files/587/f6a/2b3/587f6a2b321f415782bce382a6cd9696.png"><br>  Fig.  Statistics of malicious CPL files in comparison with other DLL and EXE files. <br><br>  The graph above shows the dynamics and the relationship between the types of executable files in the interval between 2009 and the first months of 2015.  From mid-2011, the growth of CPL malware files entering our virus lab began.  Then this growth stabilized, but from mid-2013 resumed its trend. <br><br>  The chart below shows the statistics on the distribution of malicious samples of CPL malware by year.  It is seen that only for 2013 and 2014.  the number of such samples accounted for 90% of the total flow of such malware. <br><br><img src="https://habrastorage.org/files/d07/e6f/fdc/d07e6ffdc15b410892880240205525ba.png"><br>  Fig.  Distribution of CPL file detection by year. <br><br>  Of the more than 1.5 thousand CPL malware samples that we observed, 82% of detections were in the <b>Win32 / TrojanDownloader.Banload bootloader</b> .  This family of malware has prevailed in Brazil for many years.  Our ESET LiveGrid telemetry system also points to Brazil as the country that has suffered the most from the actions of this malicious program (the largest number of infections). <br><br><img src="https://habrastorage.org/files/4de/934/366/4de93436694147ab9048c6c20e97db28.png"><br>  Fig.  Geography of distribution <b>Win32 / TrojanDownloader.Banload</b> . <br><br>  In the diagram below you can see the percentage of <b>Win32 / TrojanDownloader.Banload infections</b> in different countries of the total.  It can be seen that Brazil accounts for 76% of all detections in 2014. This fact once again confirms the targeting of intruders precisely in this region.  The second place is occupied by Spain, which accounts for 11 times fewer infections than Brazil. <br><br><img src="https://habrastorage.org/files/2fd/d09/6c3/2fdd096c38e341589cb68d570542b779.png"><br>  Fig.  <b>Win32 / TrojanDownloader.Banload</b> detection <b>statistics</b> in the world. <br><br>  This malware also ranks first in terms of prevalence in Brazil among other malware.  Below is the threat rating for this country for March 2015. <br><br><img src="https://habrastorage.org/files/22b/f13/04f/22bf1304f8f343a8b5856dd6deb20160.png"><br>  Fig.  The most common threats in Brazil. <br><br>  Over the course of several malicious campaigns used by cybercriminals to spread banking Trojans, we discovered 419 URLs that used about 300 different domains.  All of these addresses pointed to malware files. <br><br>  Of the 298 such domains that we observed between 2013 and 2015, 76 belonged to the compromised domains of Brazil.  Some of the malicious links were shortened using a bit.ly type service.  Based on the information that was collected by these services, we were able to obtain statistics on user referrals for these links and, thus, obtain the potential number of victims of a malicious campaign. <br><br>  The attackers themselves used short link services to conceal the real URLs from the user's eyes, which could betray the intentions of the attackers.  The chart below shows the statistics on the transition to shortened links for the period from the beginning of March 2014 to February 2015. <br><br><img src="https://habrastorage.org/files/ef5/7c0/fa1/ef57c0fa13e046f988fe6897bfd0c11b.png"><br>  Fig.  The number of clicks on shortened malicious links. <br><br>  The table below shows the conversion statistics for multiple shortened links, as well as the malware that spread through them. <br><br><img src="https://habrastorage.org/files/5b4/3bf/dc2/5b43bfdc28fa499ba6f2cd4a9155de15.png"><br><br>  Another feature that we want to highlight for this malicious campaign and this type of malware as CPL malware is the statistics of packers and protectors used by attackers to complicate the detection of malware samples by antivirus solutions.  As you can see, the most common packer is UPX - 27%. <br><br><img src="https://habrastorage.org/files/eec/37a/aad/eec37aaad32c472ba57f0ff9a002047a.png"><br>  Fig.  Types of packers and protectors that are used in CPL malware. <br><br>  <b>Conclusion</b> <br><br>  We reviewed the mechanisms of this type of malware like CPL malware, as well as some banking malware that is downloaded to the user's computer by this type of malware.  To spread CPL malware, attackers use the usual methods of delivering malware, which are no different from other instances of malicious campaigns. <br><br>  Attackers supply this type of malware with special checks to detect the virtual machine environment.  In addition, they use packers and protectors to complicate the detection of CPL malware by AV products. </div><p>Source: <a href="https://habr.com/ru/post/257835/">https://habr.com/ru/post/257835/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257823/index.html">Useful extension for SQL Server Management Studio</a></li>
<li><a href="../257825/index.html">What kind of javascript framework are you using? Survey among JS-developers</a></li>
<li><a href="../257827/index.html">(Translation) Introduction to C ++ Development in UE4 Part 2</a></li>
<li><a href="../257829/index.html">Choosing a corporate Internet gateway</a></li>
<li><a href="../257831/index.html">Scientists have tested brain activity to find cybersecurity threat</a></li>
<li><a href="../257837/index.html">How to use Twitter at technical conferences?</a></li>
<li><a href="../257839/index.html">The eleventh issue of TsODY.RF magazine</a></li>
<li><a href="../257841/index.html">Intel RealSense Hands-On Lab Workshop. St. Petersburg, May 30</a></li>
<li><a href="../257843/index.html">As we thought out the designer for children's robotics. # 2</a></li>
<li><a href="../257851/index.html">Secrets of formatting letters in helpdesk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>