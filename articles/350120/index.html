<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Object classification in real time</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Author: Igor Panteleev, Software Developer, DataArt 

 Image recognition is very widely used in machine learning. There are many different solutions i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Object classification in real time</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/c1/uf/ij/c1ufij5psnk_azhuqdxwhgihy5a.jpeg"><br><br>  <i>Author: Igor Panteleev, Software Developer, DataArt</i> <br><br>  Image recognition is very widely used in machine learning.  There are many different solutions in this area, but neither of them has met the needs of our project.  We needed a completely local solution that can work on a tiny computer and transfer recognition results to a cloud service.  This article describes our approach to creating an image recognition solution using TensorFlow. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Yolo </h3><br>  <a href="https://pjreddie.com/darknet/yolo/">YOLO</a> is an advanced real-time object detection system.  On the official website, you can find SSD300, SSD500, YOLOv2 and Tiny YOLO, which have been trained with two different data sets: VOC 2007 + 2012 and COCO.  You can find more options for machine learning configurations and data sets on the Internet (for example, YOLO9k).  Thanks to the wide range of options available, you can choose the version that best suits your needs.  For example, Tiny YOLO is the most ‚Äúcompact‚Äù version, which can work quickly even on smartphones or Raspberry Pi.  We liked the last option, and we used it in our project. <br><br><h3>  DarkNet and TensorFlow </h3><br>  The Yolo model was developed for <a href="https://pjreddie.com/darknet/">DarkNet-</a> based neural network, for us some features of this solution are not suitable.  DarkNet stores trained coefficients (weights) in a format that can be recognized using various methods on different platforms.  This problem can be a stumbling block, because you may need to train a model on heavy-duty equipment, and then use it on other equipment.  DarkNet is written in C and has no other software interface, so if the requirements of the platform or your own preferences force you to turn to another programming language, you will have to work further on integrating it.  It is also distributed only in source code format, and the compilation process on some platforms can be quite problematic. <br><br>  On the other hand, we have TensorFlow, a convenient and flexible computing system that can be used on most platforms.  TensorFlow provides APIs for Python, C ++, Java, Go, and <a href="https://www.tensorflow.org/api_docs/">other</a> community-supported programming <a href="https://www.tensorflow.org/api_docs/">languages</a> .  The default configuration framework can be installed with one click of the mouse, but if you want more (for example, support for specific processor instructions), you can easily compile from a source with automatic detection of hardware.  Running TensorFlow on a GPU is also quite simple.  All you need is NVIDIA CUDA and tenorflow-gpu, a special package with support for the graphics processor.  A huge advantage of TensorFlow is its scalability.  It can use multiple GPUs to improve performance as well as clustering for distributed data processing. <br><br>  We decided to take the best of both worlds and adapt the YOLO model for TensorFlow. <br><br><h3>  Adaptive Yolo for TensorFlow </h3><br>  So, our task was to transfer the YOLO model to TensorFlow.  We wanted to avoid any third-party dependencies and use YOLO directly with TensorFlow.  First, we needed to transfer the model structure, the only way to do this is to repeat the model layer by layer.  Fortunately for us, there are many open source converters that can do this.  For our purposes, <a href="https://github.com/thtrieu/darkflow">DarkFlow</a> turned out to be the most suitable solution.  We have added a simple function to DarkFlow, which allows us to save TensorFlow control points to metadata, its code can be viewed <a href="https://gist.github.com/igor-panteleev/00f9dd3403a2d5b1a8afeb064c6d74d7">here</a> .  You can do it manually, but if you want to try different models, it is easier to automate this process. <br><br>  The YOLO model we have chosen has a strict array of input data of 608x608 pixels.  We needed some kind of interface that can take any image, normalize it and feed it to the neural network.  And we have <a href="https://github.com/devicehive/devicehive-video-analysis/blob/master/models/yolo.py">developed</a> this interface.  For normalization, it uses TensorFlow, which works much faster than other solutions we tested (native Python, numpy, openCV). <br><br>  The last layer of the YOLO model returns functions that need to be converted into data of a certain form that people can read.  We added some operations after the last layer to get the coordinates of the detection zone. <br><br>  As a result, we developed a Python module that can restore the model from a file, normalize the input data, and then process the functions from the model to get the bounding fields for the predicted classes. <br><br><h3>  Model training </h3><br>  For our purposes, we decided to use a pre-trained model.  Trained coefficients are available on the <a href="https://pjreddie.com/darknet/yolo/">official YOLO website</a> .  The next task was to import DarkNet weights into TensorFlow, this was done as follows: <br><br><ul><li>  Reading the layer data in the DarkNet configuration file; </li><li>  Reading the trained coefficients from the DarkNet scale file in accordance with the layer structure; </li><li>  Preparing the TensorFlow layer based on the data from the DarkNet layer; </li><li>  Add links in a new layer; </li><li>  Repeat for each layer. </li></ul><br>  For this we used DarkFlow. <br><br><h3>  Model Architecture and Data Flow </h3><br><img src="https://habrastorage.org/webt/ls/w6/ku/lsw6kuevc4tfztap6yhbmrkghbi.gif"><br><br>  Usually with each iteration, the classifier makes an assumption as to what type of object is in the window.  It performs thousands of predictions for each image.  This slows down the process, as a result of which recognition work is rather slow. <br><br>  The biggest advantage of the model YOLO, in fact, is reflected in the title - You Only Look Once.  This model imposes a grid on the image, dividing it into cells.  Each cell tries to predict the coordinates of the detection zone with an estimate of the confidence for these fields and the probability of the classes.  Then, the confidence score for each detection zone is multiplied by the class probability to get the final score. <br><br><img src="https://habrastorage.org/webt/hj/ym/yr/hjymyrsnmlrfoj2k7o6-ecbe-zk.png"><br>  <i>Illustration from <a href="https://pjreddie.com/darknet/yolo/">YOLO</a> website.</i> <br><br><h3>  Implementation </h3><br>  <a href="https://github.com/devicehive/devicehive-video-analysis">In our GitHub repository,</a> you can find a demo project, which is a pre-trained TensorFlow YOLO2 model.  This model can recognize 80 classes.  To start it, you need to install additional dependencies required for demonstration purposes (for the model interface, only TensorFlow is required).  After installation, just run <i>python eval.py</i> , and it will capture the video stream from your webcam, evaluate it and display the results in a simple window with your predictions.  The evaluation process is frame-by-frame and may take some time depending on the equipment on which it is running.  On the Raspberry Pi, it may take several seconds to evaluate a single frame. <br><br>  You can specify a video file for this script by passing an argument <i>--video</i> like this: <i>python eval.py --video = "/ path_to_video_file /"</i> .  The URL of the video can also be transmitted (tested on YouTube): <i>python eval.py --video = ‚Äù <a href="https://www.youtube.com/watch%3Fv%3DhfeNyZV6Dsk">https://www.youtube.com/watch?v=hfeNyZV6Dsk</a> ‚Äù</i> . <br><br>  The script will skip frames from the camera during the evaluation and take the next available frame when the previous evaluation phase is completed.  For recorded video, it does not miss any frames.  For most tasks, it is possible to skip some frames in order to ensure that the process works in real time. <br><br><h3>  Integration with IoT </h3><br>  Of course, it would be nice to integrate the IoT service into this project, as well as configure the delivery of the recognition results to where other services can access them. <br>  There is another demo script - python daemon.py, which will launch a simple server that displays a video stream from a webcam with forecasts for <pre>  http://127.0.0.1:8000/events/ </pre>  . <br><br><img src="https://habrastorage.org/webt/77/oc/8h/77oc8hlsx94g-y_2tr67166mn2y.jpeg"><br><br>  It also starts the DeviceHive client.  Configuration available on <pre>  http://127.0.0.1:8000/ </pre>  . <br><br><img src="https://habrastorage.org/webt/zv/4p/ft/zv4pftyrgoe0wz1zvnwtykpqa9k.png"><br><br>  This allows you to send all the predicted information to DeviceHive in the form of notifications. <br><br><img src="https://habrastorage.org/webt/ie/n5/k7/ien5k7irtzdk9-af1remvspocdc.gif"><br><br><h3>  Conclusion </h3><br>  As you can see, there are many ready-made open source projects for almost any occasion; you just need to be able to use them correctly.  Certainly, certain changes are necessary, but it is much easier to implement them than to create a new model from scratch.  A huge advantage of such tools is their cross-platform.  We can develop a solution on a desktop PC, and then use the same code on embedded systems with the Linux operating system and ARM architecture.  We really hope that our project will help you in creating your own elegant solution. <br><br>  <b>PS</b> During the development of the project and the preparation of the article for printing, OpenCV has gained <a href="https://github.com/pjreddie/darknet/issues/242">support for YOLO within itself</a> .  Perhaps in some cases this solution will be more preferable. </div><p>Source: <a href="https://habr.com/ru/post/350120/">https://habr.com/ru/post/350120/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350106/index.html">Custom animations in the mobile application</a></li>
<li><a href="../350108/index.html">Monitoring system as an entry point to enterprise computers</a></li>
<li><a href="../350114/index.html">Android data migration tools and improved application support</a></li>
<li><a href="../350116/index.html">Open lesson on "Introduction to JSON Schema"</a></li>
<li><a href="../350118/index.html">Features of the national hunting for bugs or Bug Bounty in Slavic</a></li>
<li><a href="../350124/index.html">Online shooter on Unreal Engine 4 for 90 hours (video creation + source)</a></li>
<li><a href="../350126/index.html">Compiler bug? Linker? No, Windows kernel bug</a></li>
<li><a href="../350128/index.html">Instruction: what to do if you do not have time to deadline</a></li>
<li><a href="../350130/index.html">Open Data Day in Moscow 2018</a></li>
<li><a href="../350132/index.html">GObject: Inheritance and Interfaces</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>