<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Big migration</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 


 Hi% username%! This year brought a lot of interesting new products and good news. The long-awaited release of Spring 5 has come out , wit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Big migration</h1><div class="post__text post__text-html js-mediator-article"><p> <a href="https://habrahabr.ru/company/alfa/blog/340942/"><img src="https://habrastorage.org/webt/59/f0/86/59f086932211d775363146.png"></a> </p><br><h1 id="predislovie">  Foreword </h1><br><p>  Hi% username%!  This year brought a lot of interesting new products and good news.  The long-awaited release of Spring 5 has <a href="https://twitter.com/snicoll/status/924928995375878144">come out</a> , with a reactive core and <a href="https://spring.io/blog/2017/01/04/introducing-kotlin-support-in-spring-framework-5-0">integrated Kotlin support</a> , for which there <a href="https://twitter.com/snicoll/status/924928995375878144">will</a> still <a href="https://twitter.com/snicoll/status/924928995375878144">be a</a> lot of interesting things.  S√©bastien <a href="https://spring.io/blog/2017/08/01/spring-framework-5-kotlin-apis-the-functional-way">presented a</a> new functional approach to the Spring configuration at Kotlin.  Outdated <a href="http://junit.org/junit5/">JUnit 5</a> .  The release of Kotlin 1.2 with improved support for multi-platform applications is coming.  And this year there was a significant <a href="https://twitter.com/intelliyole/status/910531634843316225">event</a> !  Now Kotlin has moved from assembly to Groovy Dsl in Gradle to build with Kotlin Dsl. </p><br><p> As a rule, it is easier to start immediately with a new stack, but there are always questions about how to implement the old approaches.  Therefore, consider the example of an application written in Java, Spring Boot 1.5 (Spring 4+) using Lombok and Groovy Dsl in Gradle, gradually switch to Spring boot 2 (Spring 5), JUnit 5, Kotlin, and try to implement the project in a functional style on <code>spring-webflux</code> without <code>spring-boot</code> .  And also how to switch from Groovy Dsl to Kotlin Dsl.  The post will focus on the transition, so it would be nice if you are already familiar with Spring, Spring Boot and Gradle. </p><br><p>  For those who are too lazy to read, you can see a sample code on <a href="https://github.com/evgzakharov/big_migration">github</a> , for all the others, I ask for the cat: </p><a name="habracut"></a><br><h1 id="1-nachnem-s-bazovogo-prilozheniya">  1. Let's start with the basic application. </h1><br><p>  As an example, take a simple user management application based on Spring Boot 1.5.8 and Spring 4.3.12 </p><br><p>  For an example of reading the configuration, create a file in <code>src/main/resources/application.ym</code> , in which we specify the application launch port, and the <code>db</code> section, which we will use in the application. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">server</span></span>: port: <span class="hljs-number"><span class="hljs-number">8080</span></span> db: url: localhost:<span class="hljs-number"><span class="hljs-number">8080</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: vasia <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: vasiaPasswordSecret</code> </pre> <br><p>  Connect Lombok: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">compileOnly</span></span>("<span class="hljs-selector-tag"><span class="hljs-selector-tag">org</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.projectlombok</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:lombok</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1.16.18")</span></span></code> </pre> <br><p>  The section from the configuration file will be read using the DBConfiguration class with annotations <code>@ConfigurationProperties</code> and <code>@Configuration</code> .  In the same configuration file, we will create <code>DbConfig</code> bean with the settings for connecting to the database. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@ConfigurationProperties</span></span> <span class="hljs-meta"><span class="hljs-meta">@Getter</span></span> <span class="hljs-meta"><span class="hljs-meta">@Setter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DBConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DbConfig db; <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DbConfig </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configureDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbConfig(db.getUrl(), db.getUser(), unSecure(db.getPassword())); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unSecure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String password)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> secretIndex = password.indexOf(<span class="hljs-string"><span class="hljs-string">"Secret"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> password.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, secretIndex); } <span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@NoArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DbConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String url; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String user; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String password; } }</code> </pre> <br><p>  In order not to complicate, users will be stored in memory.  To do this, add the <code>UserRepository</code> repository.  And to check that we have created a <code>Bean</code> with the connection settings, we will <code>DbConfig</code> to the console. </p><br><div class="spoiler">  <b class="spoiler_title">Userrepository</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Repository</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DBConfiguration.DbConfig dbConfig; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserRepository</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DBConfiguration.DbConfig dbConfig)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dbConfig = dbConfig; System.out.println(dbConfig); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long index = <span class="hljs-number"><span class="hljs-number">3L</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;User&gt; users = Arrays.asList( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-string"><span class="hljs-string">"Oleg"</span></span>, <span class="hljs-string"><span class="hljs-string">"BigMan"</span></span>, <span class="hljs-number"><span class="hljs-number">21</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-number"><span class="hljs-number">2L</span></span>, <span class="hljs-string"><span class="hljs-string">"Lesia"</span></span>, <span class="hljs-string"><span class="hljs-string">"Listova"</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-number"><span class="hljs-number">3L</span></span>, <span class="hljs-string"><span class="hljs-string">"Bin"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bigbanovich"</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) ); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;User&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findAllUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(users); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> Optional&lt;Long&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(User newUser)</span></span></span><span class="hljs-function"> </span></span>{ Long newIndex = nextIndex(); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> addStatus = users.add(newUser.copy(newIndex)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (addStatus) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Optional.of(newIndex); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Optional.empty(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Optional&lt;User&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> users.stream() .filter(user -&gt; user.getId().equals(id)) .findFirst(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long id)</span></span></span><span class="hljs-function"> </span></span>{ Optional&lt;User&gt; findUser = users.stream() .filter(user -&gt; user.getId().equals(id)) .findFirst(); Boolean status = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (findUser.isPresent()) { users.remove(findUser.get()); status = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> status; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Long </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextIndex</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> index++; } }</code> </pre> </div></div><br><p>  Add a few controllers: </p><br><ul><li>  StatsController, with one method that will produce statistics on users received from the service. </li></ul><br><div class="spoiler">  <b class="spoiler_title">StatsController</b> <div class="spoiler_text"><pre> <code class="java hljs">RestController(<span class="hljs-string"><span class="hljs-string">"stats"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StatsController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> StatsService statsService; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StatsController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StatsService statsService)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.statsService = statsService; } <span class="hljs-meta"><span class="hljs-meta">@GetMapping</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> StatsResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stats</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Stats stats = statsService.getStats(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StatsResponse(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">"user stats"</span></span>, stats); } }</code> </pre> </div></div><br><ul><li>  UserController, with simple methods for managing a list of users. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Usercontroller</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RestController</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UserRepository userRepository; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UserController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserRepository userRepository)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userRepository = userRepository; } <span class="hljs-meta"><span class="hljs-meta">@GetMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"users"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> UserResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">users</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ List&lt;User&gt; users = userRepository.findAllUsers(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserResponse(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">"return users"</span></span>, users); } <span class="hljs-meta"><span class="hljs-meta">@GetMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"user/{id}"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> UserResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">users</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@PathVariable(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"id"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Long userId) </span></span>{ Optional&lt;User&gt; user = userRepository.findUser(userId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> user .map(findUser -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserResponse(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">"find user with requested id"</span></span>, Collections.singletonList(findUser))) .orElseGet(() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserResponse(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-string"><span class="hljs-string">"user not found"</span></span>, Collections.emptyList())); } <span class="hljs-meta"><span class="hljs-meta">@PutMapping</span></span>(value = <span class="hljs-string"><span class="hljs-string">"user"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Response </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@RequestBody User user)</span></span></span><span class="hljs-function"> </span></span>{ Optional&lt;Long&gt; addIndex = userRepository.addUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> addIndex .map(index -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserAddResponse(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">"user add successfully"</span></span>, index)) .orElseGet(() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserAddResponse(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-string"><span class="hljs-string">"user not added"</span></span>, -<span class="hljs-number"><span class="hljs-number">1L</span></span>)); } <span class="hljs-meta"><span class="hljs-meta">@DeleteMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"user/{id}"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Response </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@PathVariable(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"id"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Long id) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> status = userRepository.deleteUser(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">"user has been deleted"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-string"><span class="hljs-string">"user not been deleted"</span></span>); } } }</code> </pre> </div></div><br><p>  And we will add a small service for the statistics controller with ‚Äúbusiness logic‚Äù, which will prepare the data for statistics: </p><br><div class="spoiler">  <b class="spoiler_title">StatsService</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StatsService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UserRepository userRepository; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StatsService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserRepository userRepository)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userRepository = userRepository; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Stats </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getStats</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ List&lt;User&gt; allUsers = userRepository.findAllUsers(); User oldestUser = allUsers.stream() .max(Comparator.comparingInt(User::getAge)) .get(); User youngestUser = allUsers.stream() .min(Comparator.comparingInt(User::getAge)) .get(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stats( allUsers.size(), oldestUser, youngestUser ); } }</code> </pre> </div></div><br><p>  To test the application, we <code>@SpringRunner</code> add a test for each controller that is run using <code>@SpringRunner</code> .  It will bring up the entire Spring context with running the application on a random port.  Below is the test code for the <code>StatsControllerTest</code> controller.  In it, as an instance of the service, we will create a <code>mock</code> using @MockBean.  We will send requests to the controller using TestRestTemplate, which is out of the box along with <code>spring-boot-starter-test</code> . </p><br><div class="spoiler">  <b class="spoiler_title">StatsControllerTest</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span>(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StatsControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TestRestTemplate restTemplate; <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> StatsService statsServiceMock; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statsControllerShouldReturnValidResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Stats expectedStats = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stats( <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-string"><span class="hljs-string">"name1"</span></span>, <span class="hljs-string"><span class="hljs-string">"surname1"</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-number"><span class="hljs-number">2L</span></span>, <span class="hljs-string"><span class="hljs-string">"name2"</span></span>, <span class="hljs-string"><span class="hljs-string">"surname2"</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) ); when(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.statsServiceMock.getStats()).thenReturn(expectedStats); StatsResponse expectedResponse = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StatsResponse(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">"user stats"</span></span>, expectedStats); StatsResponse actualResponse = restTemplate.getForObject(<span class="hljs-string"><span class="hljs-string">"/stats"</span></span>, StatsResponse.class); assertEquals(<span class="hljs-string"><span class="hljs-string">"invalid stats response"</span></span>, expectedResponse, actualResponse); } }</code> </pre> </div></div><br><p>  Also add a simple mockito based test for <code>StatsService</code> : </p><br><div class="spoiler">  <b class="spoiler_title">StatsServiceTest</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StatsServiceTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statsServiceShouldReturnRightData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ UserRepository userRepositoryMock = mock(UserRepository.class); User youngestUser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-string"><span class="hljs-string">"UserName1"</span></span>, <span class="hljs-string"><span class="hljs-string">"Sr1"</span></span>, <span class="hljs-number"><span class="hljs-number">21</span></span>); User someOtherUser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-number"><span class="hljs-number">2L</span></span>, <span class="hljs-string"><span class="hljs-string">"UserName2"</span></span>, <span class="hljs-string"><span class="hljs-string">"Sr2"</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>); User oldestUser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(<span class="hljs-number"><span class="hljs-number">3L</span></span>, <span class="hljs-string"><span class="hljs-string">"UserName3"</span></span>, <span class="hljs-string"><span class="hljs-string">"Sr3"</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>); when(userRepositoryMock.findAllUsers()).thenReturn(Arrays.asList( youngestUser, someOtherUser, oldestUser )); StatsService statsService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StatsService(userRepositoryMock); Stats actualStats = statsService.getStats(); Stats expectedStats = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stats( <span class="hljs-number"><span class="hljs-number">3</span></span>, oldestUser, youngestUser ); Assert.assertEquals(<span class="hljs-string"><span class="hljs-string">"invalid stats"</span></span>, expectedStats, actualStats); } }</code> </pre> </div></div><br><p>  The final build script will look like this: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-string"><span class="hljs-string">'evgzakharov'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-string"><span class="hljs-string">'1.0-SNAPSHOT'</span></span> buildscript { ext { springBootVersion = <span class="hljs-string"><span class="hljs-string">'1.5.8.RELEASE'</span></span> } repositories { jcenter() } dependencies { classpath("org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}") } } apply plugin: "java" apply plugin: "org.springframework.boot" sourceCompatibility = <span class="hljs-number"><span class="hljs-number">1.8</span></span> dependencies { compile("org.springframework.boot:spring-boot-starter-web") compileOnly("org.projectlombok:lombok:1.16.18") testCompile("org.springframework.boot:spring-boot-starter-test") }</code> </pre> <br><p>  As you can see, here we do not use anything exotic.  Everything is as usual. <br>  The rest of the classes and the full code sample can be found <a href="https://github.com/evgzakharov/big_migration/tree/master/step1_start_project">here</a> . <br>  Run and check that everything works. </p><br><pre> <code class="hljs pgsql">cd step1_start_project gradle build &amp;&amp; gradle build &amp;&amp; java -jar build/libs/step1_start_project<span class="hljs-number"><span class="hljs-number">-1.0</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">SNAPSHOT</span></span>.jar</code> </pre> <br><p>  After that, the application should start on port 8080. We check that the endpoint‚Äôs ‚Äú/ stats‚Äù returns the correct answer.  To do this, in the terminal run the command: </p><br><pre> <code class="hljs pgsql">curl -XGET "http://localhost:8080/stats" <span class="hljs-comment"><span class="hljs-comment">--silent | jq</span></span></code> </pre> <br><p>  The answer should be as follows: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"success"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"user stats"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"stats"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"userCount"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"oldestUser"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Bin"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"surname"</span></span>: <span class="hljs-string"><span class="hljs-string">"Bigbanovich"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"age"</span></span>: <span class="hljs-number"><span class="hljs-number">30</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"youngestUser"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Oleg"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"surname"</span></span>: <span class="hljs-string"><span class="hljs-string">"BigMan"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"age"</span></span>: <span class="hljs-number"><span class="hljs-number">21</span></span> } } }</code> </pre> <br><p>  The working application is ready.  Now we are going to update and rewrite the code. </p><br><h1 id="2-perehodim-na-spring-boot-2-spring-5-i-junit-5">  2. Go to Spring Boot 2 (Spring 5) and JUnit 5 </h1><br><p>  Let's start with the easiest transition.  First, we‚Äôll update Spring Boot version to 2.0.0.M5.  Unfortunately, at the time of writing the post, the release version has not yet been released, so we are adding the following repository to the build script: </p><br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">maven</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">url</span></span> = <span class="hljs-string"><span class="hljs-string">"http://repo.spring.io/milestone"</span></span> }</code> </pre> <br><p>  We are trying to update the project in the studio and catch the mistakes that we now have no <code>spring-starter-*</code> dependencies.  This is due to the fact that now the automatic configuration of dependency versions has <a href="https://spring.io/blog/2017/04/05/spring-boot-s-new-gradle-plugin">moved to another plugin</a> .  Add it to the build script: </p><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">apply</span></span> plugin: <span class="hljs-string"><span class="hljs-string">"io.spring.dependency-management"</span></span></code> </pre> <br><p>  We update the application and now we have everything.  For such a simple project, this is all you need to do to upgrade to the new version of <code>spring-boot</code> , but in real projects, of course, other difficulties may arise. </p><br><p>  We now turn to the transition to JUnit 5. </p><br><p>  In the new version of the framework, a lot of interesting things have appeared, it is enough to at least look at the new <a href="http://junit.org/junit5/docs/current/user-guide/">documentation</a> . <br>  JUnit 5 now consists of three main subprojects: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">JUnit</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> = JUnit Platform + JUnit Jupiter + JUnit Vintage</code> </pre> <br><p>  Where, <br>  <code>JUnit Platform</code> - the basis for running tests on the JVM.  It also provides the <code>TestEngine API</code> for running test frameworks. <br>  <code>JUnit Jupiter</code> - consists of combining a new software model and an extension model for writing tests and extensions for JUnit 5. Also contains a subproject containing <code>TestEngine</code> for running tests written on the Jupiter platform. <br>  <code>JUnit Vintage</code> - provides <code>TestEngine</code> for running tests written in JUnit 3 and JUnit 4. </p><br><p>  To run new tests from gradle we need to connect their new plugin: </p><br><pre> <code class="hljs objectivec">buildscript { ... dependencies { ‚Ä¶. classpath(<span class="hljs-string"><span class="hljs-string">"org.junit.platform:junit-platform-gradle-plugin:1.0.1"</span></span>) } } apply plugin: <span class="hljs-string"><span class="hljs-string">"org.junit.platform.gradle.plugin"</span></span></code> </pre> <br><p>  It allows you to run any tests that are supported by the current version of <code>TestEngine</code> .  In addition, given that we are completely switching to new tests, we add the following dependencies: </p><br><pre> <code class="hljs lisp">testCompile(<span class="hljs-string"><span class="hljs-string">"org.junit.jupiter:junit-jupiter-api:$junitVersion"</span></span>) testRuntime(<span class="hljs-string"><span class="hljs-string">"org.junit.jupiter:junit-jupiter-engine:$junitVersion"</span></span>)</code> </pre> <br><p>  Now everything is ready to launch new tests, it remains only to rewrite the old ones.  Although it would be more correct to change a little.  The transition to JUnit 5 is fairly painless.  The main thing you need to do is to change the import annotation JUnit: </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//old import org.junit.Test; //new import org.junit.jupiter.api.Test;</span></span></code> </pre> <br><p>  And then we can add new functionality, such as, for example, the new ability to specify the name of the test using the annotation <code>@DisplayName</code> .  Previously, as a rule, we had to fill in the name of the method with a complete description of what we are testing.  Now, you can make a description in the abstract and leave the name of the method short. </p><br><p>  So, now the updated test <code>StatsServiceTest</code> will look like: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@DisplayName</span></span>(<span class="hljs-string"><span class="hljs-string">"Service test with mockito"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StatsServiceTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-meta"><span class="hljs-meta">@DisplayName</span></span>(<span class="hljs-string"><span class="hljs-string">"stats service should return right data"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... } }</span></span></code> </pre> <br><p>  Intellij Idea already supports JUnit 5, so we can run the test right in it: </p><br><img src="https://habrastorage.org/webt/59/f0/86/59f086d98ce1b913019329.png"><br><p>  But even if you use another studio that does not yet support JUnit5, you can use the features from JUnit 4 to run the tests by adding the annotation <code>@RunWith(JUnitPlatform.class)</code> to the class. </p><br><p>  In Spring, also since version 5, support for Jupiter tests has appeared.  For this, the <code>SpringExtension</code> class has been added, which is now used instead of <code>SpringRunner</code> .  <code>StatsControllerTest</code> will now look like this: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@ExtendWith</span></span>(SpringExtension.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span>(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT) <span class="hljs-meta"><span class="hljs-meta">@DisplayName</span></span>(<span class="hljs-string"><span class="hljs-string">"StatsController test"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StatsControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// .. @Test @DisplayName("stats controller should return valid result") public void test() { // ... } }</span></span></code> </pre><br><p>  Run the test and check that everything works: </p><br><img src="https://habrastorage.org/webt/59/f0/86/59f086ea8f314295396900.png"><br><p>  These are all the changes that needed to be made.  We collect and check that everything works: </p><br><pre> <code class="hljs pgsql">cd step2_migration_to_spring5_junit5 gradle build &amp;&amp; gradle build &amp;&amp; java -jar build/libs/step2_migration_to_spring5_junit5<span class="hljs-number"><span class="hljs-number">-1.0</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">SNAPSHOT</span></span>.jar</code> </pre> <br><p>  Before launching the application, there will be an updated test information display format: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Test</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">run</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">finished</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">after</span></span> 3535 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ms</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ 4 containers found ]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ 0 containers skipped ]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ 4 containers started ]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ 0 containers aborted ]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ 4 containers successful ]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ 0 containers failed ]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ 6 tests found ]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ 0 tests skipped ]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ 6 tests started ]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ 0 tests aborted ]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ 6 tests successful ]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ 0 tests failed ]</span></span></code> </pre> <br><p>  We are waiting for the launch of the application and also, as in section 1, with the help of <code>curl</code> we are convinced that everything works.  At this transition to JUnit 5 and Spring 5 can be considered complete. </p><br><h1 id="3--perehodim-na-kotlin">  3. Go to Kotlin </h1><br><p>  I would not like to touch on the question of why it is on Kotlin (this is still a rather holivar topic).  But briefly, my subjective opinion is that at the moment it is the only statically typed language that allows you to write beautiful concise code without going far from the JVM, while possessing, which is very important, fairly smooth and seamless integration with existing Java libraries, especially considering that Kotlin does not bring its collections but uses standard ones from Java.  In addition, I have high hopes for writing multi-platform applications entirely on Kotlin. </p><br><p>  Connect Kotlin.  To do this, in the build script, add the <code>kotlin</code> plugin and remove the <code>java</code> plugin. </p><br><pre> <code class="hljs perl">buildscript { ext { ... kotlinVersion = <span class="hljs-string"><span class="hljs-string">"1.1.51"</span></span> } dependencies { ‚Ä¶ classpath(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion"</span></span>) } } ... apply plugin: <span class="hljs-string"><span class="hljs-string">'kotlin'</span></span></code> </pre> <br><p>  And we also need to add a small <code>kolin-stdlib</code> , which would be enough for Spring 4, but Spring 5 still needs to be connected with <code>kotlin-reflect</code> , thanks to the fact that it has built-in support for Kotlin and uses its reflection in places. </p><br><pre> <code class="hljs lisp">compile(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin:kotlin-stdlib-jre8:$kotlinVersion"</span></span>) compile(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin:kotlin-reflect:$kotlinVersion"</span></span>)</code> </pre> <br><p>  Let's start converting Java code.  Here, at the first stage, the studio Intellij Idea will help us.  Open any Java file and press 2 times shift, where in the search field we write: ‚Äúconvert java file to kotlin‚Äù.  Similarly, we repeat the action for all other * .java files. </p><br><img src="https://habrastorage.org/webt/59/f0/87/59f0870365cff109571748.png"><br><p>  The built-in converter is quite good, but after it you need to tweak the code a little with your hands.  This mainly concerns the definition of which types can be <code>nullable</code> and which <code>not-nullable</code> .  And in many ways, conversion is one-to-one.  In other words, the output is, in fact, the same Java code, only written in Kotlin (but without a significant part of the template code) </p><br><p>  Let's look at the conversion using the example of <code>DBConfiguration</code> .  After the conversion by the studio, the code will look like this: </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@ConfigurationProperties</span></span> <span class="hljs-meta"><span class="hljs-meta">@Getter</span></span> <span class="hljs-meta"><span class="hljs-meta">@Setter</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DBConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db: DbConfig? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(db) { field = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.db } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configureDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: DbConfig { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DbConfig(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.db!!.url, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.db!!.user, unSecure(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.db!!.password)) } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unSecure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(password: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span>: String { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> secretIndex = password!!.indexOf(<span class="hljs-string"><span class="hljs-string">"Secret"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> password.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, secretIndex) } <span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@NoArgsConstructor</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DbConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(url) { field = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.url } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(user) { field = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.user } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> password: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(password) { field = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.password } } }</code> </pre> <br><p>  While not very beautiful, so we do the following: </p><br><ul><li>  remove Lombok.  We don‚Äôt need it anymore, due to the fact that the functionality of Kotlin fully covers all its features. </li><li>  remove all <code>set</code> properties.  There is no need for them here either, since the <code>@ConfigurationProperties</code> annotation <code>@ConfigurationProperties</code> required only for a <code>field</code> with public <code>getter</code> and <code>setter</code> .  And go to the non-nullable types, in which, as the default value, we specify empty lines.  Although here you can leave the <code>nullable</code> types, but then you will have to put up with the code further (and as practice has shown, it is better to do non-nullable values ‚Äã‚Äãfor the data from the configuration).  For the <code>DbConfig</code> class, you can add a <code>data</code> modifier here, although for all its properties you have to specify a default value so that the class has a constructor without arguments that is required to initialize the value from the configuration in the spring. </li><li>  Add <code>open</code> for the <code>DBConfiguration</code> class.  This is necessary in order for the class redefinition mechanism built into Spring to work properly.  There is another option not to add open, but to plug in the <code>gradle</code> <code>kotlin-spring</code> plugin in <code>kotlin-spring</code> , which itself at the compilation stage will open for redefining the necessary classes (and methods), but I prefer the explicit approach. </li><li>  Similarly to the previous paragraph, we add the open modifier for the <code>configureDb</code> method with the <code>@Bean</code> annotation, all for the same reason, since the default methods are <code>final</code> . </li><li>  simplifying the <code>unSecure</code> method using the <code>substringBefore</code> <code>extension</code> method </li></ul><br><p>  After improvements we get the following: </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@ConfigurationProperties</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DBConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db: DbConfig = DbConfig() <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configureDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: DbConfig { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DbConfig(db.url, db.user, unSecure(db.password)) } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unSecure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(password: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: String { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> password.substringBefore(<span class="hljs-string"><span class="hljs-string">"Secret"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DbConfig</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url: String = <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user: String = <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> password: String = <span class="hljs-string"><span class="hljs-string">""</span></span> ) }</code> </pre> <br><p>  Similarly, we convert and simplify the <code>StatsService</code> service.  We get the following: </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StatsService</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userRepository: UserRepository) { <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getStats</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Stats { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> allUsers = userRepository.findAllUsers() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (allUsers.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"not find any user"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> oldestUser = allUsers.maxBy { it.age } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> youngestUser = allUsers.minBy { it.age } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Stats( allUsers.size, oldestUser!!, youngestUser!! ) } }</code> </pre> <br><p>  In Java, for each variant of the controller's response, we had to create a separate file for each class.  As a result, there were 4 classes and each in a separate file: </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//src/main/java/migration/simple/responses/Response.java @AllArgsConstructor @NoArgsConstructor @Getter @Setter @EqualsAndHashCode public class Response { private Boolean success; private String description; } //src/main/java/migration/simple/responses/StatsResponse.java @Getter @Setter @NoArgsConstructor @EqualsAndHashCode(callSuper = true) public class StatsResponse extends Response { private Stats stats; public StatsResponse(Boolean success, String description, Stats stats) { super(success, description); this.stats = stats; } } //src/main/java/migration/simple/responses/UserAddResponse.java @Getter @Setter @NoArgsConstructor @EqualsAndHashCode(callSuper = true) public class UserAddResponse extends Response { private Long userId; public UserAddResponse(Boolean success, String description, Long userId) { super(success, description); this.userId = userId; } } //src/main/java/migration/simple/responses/UserResponse.java @Getter @Setter @NoArgsConstructor @EqualsAndHashCode(callSuper = true) public class UserResponse extends Response { private List&lt;User&gt; users; public UserResponse(Boolean success, String description, List&lt;User&gt; users) { super(success, description); this.users = users; } }</span></span></code> </pre> <br><p>  With the advent of Kotlin, you can now fit everything in one file with a fairly concise record: </p><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Response</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> success: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> description: String } <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeleteResponse</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> success: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> description: String ) : Response <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StatsResponse</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> success: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> description: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> stats: Stats ) : Response <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserAddResponse</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> success: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> description: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userId: <span class="hljs-built_in"><span class="hljs-built_in">Long</span></span> ) : Response <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserResponse</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> success: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> description: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> users: List&lt;User&gt; ) : Response</code> </pre> <br><p>  We rule in a similar way all the other classes and proceed to the tests.  Here we are actively using mockito, for which to work in Kotlin you need to connect an additional library: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">testCompile</span></span>("<span class="hljs-selector-tag"><span class="hljs-selector-tag">com</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.nhaarman</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:mockito-kotlin-kt1.1</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:1.5.0")</span></span></code> </pre> <br><p>  And in all tests, you need to remove the imports for the old mockito and change them for imports from com.nhaarman.mockito_kotlin: </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//old import static org.mockito.Mockito.mock; import static org.mockito.Mockito.when; //new import com.nhaarman.mockito_kotlin.mock import com.nhaarman.mockito_kotlin.whenever</span></span></code> </pre> <br><p>  <code>when</code> in Kotlin is a keyword, and in the tests not to leave <code>`when`</code> instead of it, <code>whenever</code> use <code>whenever</code> from the library.  And now we can create mocks using a simple <code>mock&lt;T&gt;()</code> construct, and the type can be optional if known at the time of the announcement. </p><br><p>  It is also worth paying attention to the declared <code>field</code> , the values ‚Äã‚Äãof which were initialized by the test framework at the start of the test.  Kotlin for all declarations requires that the value be immediately initialized, so we can only specify either the <code>nullable</code> type for such <code>nullable</code> and specify null as the initialization value or use <code>lateinit</code> (which is preferable in this case).  <code>lateinit</code> in Kotin works as follows: it is allowed not to initialize the value of a variable when declaring, but when you try to get a value, it is checked that it is initialized, and if it is not, then an exception is thrown.  Therefore it is worth using this opportunity with caution.  Such an opportunity in essence appeared for convenient interaction with existing Java frameworks. </p><br><p>  An example of a transition from Java to Kotlin for a <code>field</code> that is not initialized at the time of the declaration: </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//Java @Autowired private TestRestTemplate restTemplate;</span></span></code> </pre> <br><pre> <code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">//Kotlin @Autowired private lateinit var restTemplate: TestRestTemplate</span></span></code> </pre> <br><p>  A pleasant addition with the arrival of Kotlin is that we no longer need the <code>@DisplayName</code> annotation.  We can rewrite long method names with spaces.  And even the studio itself offers assistance in this: </p><br><img src="https://habrastorage.org/webt/59/f0/87/59f087b5dbfe7966633607.png"><br><p>  One of the key advantages of Kotlin is embedding nullablity in the type system, and to unleash this advantage to the full, we can add the compilation flag ‚Äú-Xjsr305 = strict‚Äù.  To do this, add to the build script: </p><br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">compileKotlin</span></span> { <span class="hljs-section"><span class="hljs-section">kotlinOptions</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">jvmTarget</span></span> = <span class="hljs-string"><span class="hljs-string">"1.8"</span></span> freeCompilerArgs = [<span class="hljs-string"><span class="hljs-string">"-Xjsr305=strict"</span></span>] } }</code> </pre> <br><p>  With this option, Kotlin will take annotations in Spring 5 into account for the nullability of types, and the probability of getting NPE is significantly reduced. </p><br><p>  We also specify that target jvm 8 (if we want Kotlin to compile to jvm 8 bytecode, but so far there is a possibility to compile to jvm 6 bytecode). </p><br><p>  At this conversion can be completed.  Build and run the application: </p><br><pre> <code class="hljs pgsql">cd step3_migration_to_kotlin gradle build &amp;&amp; java -jar build/libs/step3_migration_to_kotlin<span class="hljs-number"><span class="hljs-number">-1.0</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">SNAPSHOT</span></span>.jar</code> </pre> <br><p>  And we are convinced that we have not broken anything and that everything works.  If so, then go ahead. </p><br><h1 id="4-perehodim-na-spring-webflux-i-funkcionalnyy-kotlin">  4. Go to spring-webflux and functional Kotlin </h1><br><p>  I was inspired for this transition by seeing <a href="https://spring.io/blog/2017/08/01/spring-framework-5-kotlin-apis-the-functional-way">the</a> Spring blog post.  In it, S√©bastien Deleuze shows an example of initializing a Spring application in a functional approach based on spring-webflux and without a spring-boot. </p><br><p>  With the advent of Spring 5, there was an opportunity for a variety of application initialization on various web servers and various approaches: </p><br><img src="https://habrastorage.org/webt/59/f0/87/59f087c6e6ac4503373049.png"><br><p><br>  In his example, S√©bastien runs the application on Netty, an example can be found <a href="https://github.com/sdeleuze/spring-kotlin-functional">here</a> .  For a change, run the application on Undertow. </p><br><p>  Let's start by running Spring without spring-boot.  To do this, we need to configure <code>GenericApplicationContext</code> , which is bound to the web server to be launched using adapters. ,     <code>GenericApplicationContext</code>     <code>WebHttpHandlerBuilder</code> ,     <code>HttpHandler</code> , ,   ,    web-     . <br>  <a href="https://docs.spring.io/spring-framework/docs/5.0.0.BUILD-SNAPSHOT/spring-framework-reference/html/web-reactive.html"></a>  Spring     : </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// Tomcat and Jetty (also see notes below) HttpServlet servlet = new ServletHttpHandlerAdapter(handler); ... // Reactor Netty ReactorHttpHandlerAdapter adapter = new ReactorHttpHandlerAdapter(handler); HttpServer.create(host, port).newHandler(adapter).block(); // RxNetty RxNettyHttpHandlerAdapter adapter = new RxNettyHttpHandlerAdapter(handler); HttpServer server = HttpServer.newServer(new InetSocketAddress(host, port)); server.startAndAwait(adapter); // Undertow UndertowHttpHandlerAdapter adapter = new UndertowHttpHandlerAdapter(handler); Undertow server = Undertow.builder().addHttpListener(port, host).setHandler(adapter).build(); server.start();</span></span></code> </pre> <br><p>        ,     .      : </p><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span></span>(port: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span>? = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, beanConfig: BeanDefinitionDsl = beansConfiguration()) { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> server: Undertow <span class="hljs-keyword"><span class="hljs-keyword">init</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> context = GenericApplicationContext().apply { beanConfig.initialize(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) loadConfig() refresh() } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> build = WebHttpHandlerBuilder.applicationContext(context).build() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> adapter = build .run { UndertowHttpHandlerAdapter(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> startupPort = port ?: context.environment.getProperty(<span class="hljs-string"><span class="hljs-string">"server.port"</span></span>)?.toInt() ?: DEFAULT_PORT server = Undertow.builder() .addHttpListener(startupPort, <span class="hljs-string"><span class="hljs-string">"localhost"</span></span>) .setHandler(adapter) .build() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { server.start() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { server.stop() } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> GenericApplicationContext.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> resource = ClassPathResource(<span class="hljs-string"><span class="hljs-string">"/application.yml"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sourceLoader = YamlPropertySourceLoader() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> properties = sourceLoader.load(<span class="hljs-string"><span class="hljs-string">"main config"</span></span>, resource, <span class="hljs-literal"><span class="hljs-literal">null</span></span>) environment.propertySources.addFirst(properties) } <span class="hljs-keyword"><span class="hljs-keyword">companion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> DEFAULT_PORT = <span class="hljs-number"><span class="hljs-number">8080</span></span> } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(args: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Array</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span> { Application().start() }</code> </pre> <br><p> ,      <code>spring-boot</code>       .               application.yml,   <code>@ConfigurationProperties</code>     <code>spring-boot</code> ,    yml (  snakeyaml)   <code>spring-boot-starter</code> .      <code>spring-boot-starter</code>   ,       <code>spring-boot</code> . </p><br><p> <code>beansConfiguration</code>   ,    .       ,      ,   ,  ,          .       : </p><br><pre> <code class="hljs xml">fun beansConfiguration(beanConfig: BeanDefinitionDsl.() -&gt; Unit = {}): BeanDefinitionDsl = beans { bean<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DBConfiguration</span></span></span><span class="hljs-tag">&gt;</span></span>() //controllers bean<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StatsController</span></span></span><span class="hljs-tag">&gt;</span></span>() bean<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">UserController</span></span></span><span class="hljs-tag">&gt;</span></span>() //repository bean<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">UserRepository</span></span></span><span class="hljs-tag">&gt;</span></span>() //services bean<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StatsService</span></span></span><span class="hljs-tag">&gt;</span></span>() //routes bean<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Routes</span></span></span><span class="hljs-tag">&gt;</span></span>() bean("webHandler") { RouterFunctions.toWebHandler(ref<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Routes</span></span></span><span class="hljs-tag">&gt;</span></span>().router(), HandlerStrategies.builder().viewResolver(ref()).build()) } //view resolver bean { val prefix = "classpath:/templates/" val suffix = ".mustache" val loader = MustacheResourceTemplateLoader(prefix, suffix) MustacheViewResolver(Mustache.compiler().withLoader(loader)).apply { setPrefix(prefix) setSuffix(suffix) } } //processors bean<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CommonAnnotationBeanPostProcessor</span></span></span><span class="hljs-tag">&gt;</span></span>() bean<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ConfigurationClassPostProcessor</span></span></span><span class="hljs-tag">&gt;</span></span>() bean<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ConfigurationPropertiesBindingPostProcessor</span></span></span><span class="hljs-tag">&gt;</span></span>() beanConfig() }</code> </pre> <br><p>       <code>beans</code> ,    Spring 5      <code>spring-context</code> .         Kotlin      .       <code>bean</code> ,      .    ,  ,       ,  ,  <code>ViewResolver</code> . </p><br><p>      Spring ,   <code>@Bean</code> , <code>@Configuration</code> , <code>@ConfigurationProperties</code> , <code>@PostConstruct</code> ,  ,   ,   <code>BeanPostProcessor</code> . </p><br><p>        ,    ,       . </p><br><p>  <code>Routes</code>    .    ‚ÄúwebHandler‚Äù         <code>RouterFunctions.toWebHandler(ref&lt;Routes&gt;().router(), ‚Ä¶)</code> . </p><br><p>     <code>ref&lt;Routes&gt;()</code> ,    <code>spring-context</code> ,      : </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-type"><span class="hljs-keyword">reified</span></span></span></span><span class="hljs-function"><span class="hljs-type"> T : Any&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ref</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">? = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> : T = <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (name) { <span class="hljs-literal"><span class="hljs-literal">null</span></span> -&gt; context.getBean(T::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">else</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">context</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">getBean</span></span></span></span>(name, T::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) }</span></span></code> </pre> <br><p>   ,    <code>Routes</code> : </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Routes</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userController: UserController, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> statsController: StatsController ) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">router</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> = router { accept(APPLICATION_JSON).nest(userController.nest()) accept(APPLICATION_JSON).nest(statsController.nest()) GET(<span class="hljs-string"><span class="hljs-string">"/"</span></span>) { ok().render(<span class="hljs-string"><span class="hljs-string">"index"</span></span>) } } }</code> </pre> <br><p>  ,  ,       ,     <code>router</code>  <code>spring-context</code> . S√©bastien        : </p><br><pre> <code class="hljs erlang"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TEXT_HTML)</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nest</span></span></span><span class="hljs-function"> { GET</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"/"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ok</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"index"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> } GET</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"/sse"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ok</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"sse"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> } GET</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"/users"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, userHandler::findAllView)</span></span></span><span class="hljs-function"> } "/</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">api</span></span></span><span class="hljs-function">".</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nest</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(APPLICATION_JSON)</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nest</span></span></span><span class="hljs-function"> { GET</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"/users"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, userHandler::findAll)</span></span></span><span class="hljs-function"> } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TEXT_EVENT_STREAM)</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nest</span></span></span><span class="hljs-function"> { GET</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"/users"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, userHandler::stream)</span></span></span><span class="hljs-function"> } }</span></span></code> </pre><br><p>          ,     .  ,         ,      . </p><br><p>    ,       <code>nest</code> .          : </p><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: RouterFunctionDsl.() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Unit</span></span> }</code> </pre> <br><p> <code>StatsController</code>    : </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StatsController</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> statsService: StatsService) : Controller { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: RouterFunctionDsl.() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Unit</span></span> = { GET(<span class="hljs-string"><span class="hljs-string">"/stats"</span></span>) { ok().body(stats()) } } <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stats</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Mono&lt;StatsResponse&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> stats = statsService.getStats() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mono.just(StatsResponse(<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"user stats"</span></span>, stats)) } }</code> </pre> <br><p>            ‚Äú/stats‚Äù,  GET        <code>stats</code> .        <code>Flux</code>  <code>Mono</code> ,    <code>spring-webflux</code> .     <code>UserController</code> : </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserController</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userRepository: UserRepository) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: RouterFunctionDsl.() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Unit</span></span> = { GET(<span class="hljs-string"><span class="hljs-string">"/users"</span></span>) { ok().body(users()) } GET(<span class="hljs-string"><span class="hljs-string">"/user/{id}"</span></span>) { ok().body(user(it.pathVariable(<span class="hljs-string"><span class="hljs-string">"id"</span></span>).toLong())) } PUT(<span class="hljs-string"><span class="hljs-string">"/user"</span></span>) { ok().body(addUser(it.bodyToMono(User::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">))) } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DELETE</span></span></span></span>(<span class="hljs-string"><span class="hljs-string">"/user/{id}"</span></span>) { ok().body(deleteUser(it.pathVariable(<span class="hljs-string"><span class="hljs-string">"id"</span></span>).toLong())) } } <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">users</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Mono&lt;UserResponse&gt; { <span class="hljs-comment"><span class="hljs-comment">// ‚Ä¶. } open fun user(userId: Long): Mono&lt;UserResponse&gt; { // ‚Ä¶. } open fun addUser(user: Mono&lt;User&gt;): Mono&lt;UserAddResponse&gt; = user.map { // ‚Ä¶. } open fun deleteUser(id: Long): Mono&lt;DeleteResponse&gt; { // ‚Ä¶. } }</span></span></code> </pre> <br><p>          ,     .  ,   ,   ,             ,  . </p><br><p>      .   <code>StatsServiceTest</code>   ,     . ,    <code>StatsControllerTest</code> : </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@DisplayName(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"StatsController test"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StatsControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> statsServiceMock = mock&lt;StatsService&gt;() <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> port = <span class="hljs-number"><span class="hljs-number">8181</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> configuration = beansConfiguration { bean { statsServiceMock } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> application = Application(port, configuration) <span class="hljs-meta"><span class="hljs-meta">@BeforeEach</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">before</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { reset(statsServiceMock) application.start() } <span class="hljs-meta"><span class="hljs-meta">@AfterEach</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">after</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { application.stop() } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> `stats controller should return valid result`</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> expectedStats = Stats( <span class="hljs-number"><span class="hljs-number">2</span></span>, User(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-string"><span class="hljs-string">"name1"</span></span>, <span class="hljs-string"><span class="hljs-string">"surname1"</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>), User(<span class="hljs-number"><span class="hljs-number">2L</span></span>, <span class="hljs-string"><span class="hljs-string">"name2"</span></span>, <span class="hljs-string"><span class="hljs-string">"surname2"</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) ) whenever(statsServiceMock.getStats()).thenReturn(expectedStats) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> expectedResponse = StatsResponse(<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"user stats"</span></span>, expectedStats) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> response: StatsResponse = <span class="hljs-string"><span class="hljs-string">"http://localhost:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$port</span></span></span><span class="hljs-string">/stats"</span></span>.GET() assertEquals(expectedResponse, response, <span class="hljs-string"><span class="hljs-string">"invalid response"</span></span>) } }</code> </pre> <br><p>           .        Spring,    .                .         . </p><br><p>           restTemplate.      : <code>"http://localhost:$port/stats".GET()</code> .  GET   ,      .      OkHttp3: </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = OkHttpClient() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> JSON = MediaType.parse(<span class="hljs-string"><span class="hljs-string">"application/json; charset=utf-8"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mapper: ObjectMapper = ObjectMapper() .registerKotlinModule() <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-type"><span class="hljs-keyword">reified</span></span></span></span><span class="hljs-function"><span class="hljs-type"> T&gt;</span></span></span><span class="hljs-function"> String.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GET</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: T { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> request = Request.Builder() .url(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) .build() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.newCall(request).executeAndGet(T::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fun</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">reified T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PUT</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: Any): T { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> body = RequestBody.create(JSON, mapper.writeValueAsString(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> request = Request.Builder() .url(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) .put(body) .build() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.newCall(request).executeAndGet(T::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fun</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">reified T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">POST</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: Any): T { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> body = RequestBody.create(JSON, mapper.writeValueAsString(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> request = Request.Builder() .url(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) .post(body) .build() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.newCall(request).executeAndGet(T::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inline</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fun</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">reified T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DELETE</span></span></span></span>(): T { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> request = Request.Builder() .url(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) .delete() .build() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.newCall(request).executeAndGet(T::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fun</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Call</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">executeAndGet</span></span></span></span>(clazz: Class&lt;T&gt;): T { execute().use { response -&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mapper.readValue(response.body()!!.string(), clazz) } }</code> </pre> <br><p>        <code>UserControllerTest</code> . </p><br><div class="spoiler"> <b class="spoiler_title">UserControllerTest</b> <div class="spoiler_text"><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@DisplayName(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"UserController test"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> port = <span class="hljs-number"><span class="hljs-number">8181</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> userRepositoryMock: UserRepository <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: BeanDefinitionDsl <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> application: Application <span class="hljs-meta"><span class="hljs-meta">@BeforeEach</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">before</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { userRepositoryMock = mock() configuration = beansConfiguration { bean { userRepositoryMock } } application = Application(port, configuration) application.start() } <span class="hljs-meta"><span class="hljs-meta">@AfterEach</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">after</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { application.stop() } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> `all users should be return correctly`</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> users = listOf( User(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-string"><span class="hljs-string">"name1"</span></span>, <span class="hljs-string"><span class="hljs-string">"surname1"</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>), User(<span class="hljs-number"><span class="hljs-number">2L</span></span>, <span class="hljs-string"><span class="hljs-string">"name2"</span></span>, <span class="hljs-string"><span class="hljs-string">"surname2"</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) ) whenever(userRepositoryMock.findAllUsers()).thenReturn(users) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> expectedResponse = UserResponse(<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"return users"</span></span>, users) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> response: UserResponse = <span class="hljs-string"><span class="hljs-string">"http://localhost:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$port</span></span></span><span class="hljs-string">/users"</span></span>.GET() assertEquals(expectedResponse, response, <span class="hljs-string"><span class="hljs-string">"invalid response"</span></span>) } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> `user should be return correctly`</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> user = User(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-string"><span class="hljs-string">"name1"</span></span>, <span class="hljs-string"><span class="hljs-string">"surname1"</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>) whenever(userRepositoryMock.findUser(<span class="hljs-number"><span class="hljs-number">1L</span></span>)).thenReturn(user) whenever(userRepositoryMock.findUser(<span class="hljs-number"><span class="hljs-number">2L</span></span>)).thenReturn(<span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> expectedResponse = UserResponse(<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"find user with requested id"</span></span>, listOf(user)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> response: UserResponse = <span class="hljs-string"><span class="hljs-string">"http://localhost:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$port</span></span></span><span class="hljs-string">/user/1"</span></span>.GET() assertEquals(expectedResponse, response, <span class="hljs-string"><span class="hljs-string">"not find exists user"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> expectedMissedResponse = UserResponse(<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"user not found"</span></span>, emptyList()) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> missingResponse: UserResponse = <span class="hljs-string"><span class="hljs-string">"http://localhost:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$port</span></span></span><span class="hljs-string">/user/2"</span></span>.GET() assertEquals(expectedMissedResponse, missingResponse, <span class="hljs-string"><span class="hljs-string">"invalid user response"</span></span>) } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> `user should be added correctly`</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> newUser1 = User(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>, <span class="hljs-string"><span class="hljs-string">"surname"</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> newUser2 = User(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"name2"</span></span>, <span class="hljs-string"><span class="hljs-string">"surname2"</span></span>, <span class="hljs-number"><span class="hljs-number">18</span></span>) whenever(userRepositoryMock.addUser(newUser1)).thenReturn(<span class="hljs-number"><span class="hljs-number">15L</span></span>) whenever(userRepositoryMock.addUser(newUser2)).thenReturn(<span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> expectedResponse = UserAddResponse(<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"user add successfully"</span></span>, <span class="hljs-number"><span class="hljs-number">15L</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> response: UserAddResponse = <span class="hljs-string"><span class="hljs-string">"http://localhost:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$port</span></span></span><span class="hljs-string">/user"</span></span>.PUT(newUser1) assertEquals(expectedResponse, response, <span class="hljs-string"><span class="hljs-string">"invalid add response"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> expectedErrorResponse = UserAddResponse(<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"user not added"</span></span>, -<span class="hljs-number"><span class="hljs-number">1L</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> errorResponse: UserAddResponse = <span class="hljs-string"><span class="hljs-string">"http://localhost:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$port</span></span></span><span class="hljs-string">/user"</span></span>.PUT(newUser2) assertEquals(expectedErrorResponse, errorResponse, <span class="hljs-string"><span class="hljs-string">"invalid add response"</span></span>) } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> `user should be deleted correctly`</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { whenever(userRepositoryMock.deleteUser(<span class="hljs-number"><span class="hljs-number">1L</span></span>)).thenReturn(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) whenever(userRepositoryMock.deleteUser(<span class="hljs-number"><span class="hljs-number">2L</span></span>)).thenReturn(<span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> expectedResponse = DeleteResponse(<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"user has been deleted"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> response: DeleteResponse = <span class="hljs-string"><span class="hljs-string">"http://localhost:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$port</span></span></span><span class="hljs-string">/user/1"</span></span>.DELETE() assertEquals(expectedResponse, response, <span class="hljs-string"><span class="hljs-string">"invalid response"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> expectedErrorResponse = DeleteResponse(<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"user not been deleted"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> errorResponse: DeleteResponse = <span class="hljs-string"><span class="hljs-string">"http://localhost:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$port</span></span></span><span class="hljs-string">/user/2"</span></span>.DELETE() assertEquals(expectedErrorResponse, errorResponse, <span class="hljs-string"><span class="hljs-string">"invalid response"</span></span>) } }</code> </pre> </div></div><br><p>       : </p><br><pre> <code class="hljs perl">group <span class="hljs-string"><span class="hljs-string">'evgzakharov'</span></span> version <span class="hljs-string"><span class="hljs-string">'1.0-SNAPSHOT'</span></span> buildscript { ext { springBootVersion = <span class="hljs-string"><span class="hljs-string">"2.0.0.M5"</span></span> junitVersion = <span class="hljs-string"><span class="hljs-string">"5.0.1"</span></span> kotlinVersion = <span class="hljs-string"><span class="hljs-string">"1.1.51"</span></span> } repositories { jcenter() maven { url = <span class="hljs-string"><span class="hljs-string">"http://repo.spring.io/milestone"</span></span> } } dependencies { classpath(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-gradle-plugin:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${springBootVersion}</span></span></span><span class="hljs-string">"</span></span>) classpath(<span class="hljs-string"><span class="hljs-string">"org.junit.platform:junit-platform-gradle-plugin:1.0.1"</span></span>) classpath(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion"</span></span>) } } apply plugin: <span class="hljs-string"><span class="hljs-string">"org.springframework.boot"</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">"org.junit.platform.gradle.plugin"</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'kotlin'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">"io.spring.dependency-management"</span></span> sourceCompatibility = <span class="hljs-number"><span class="hljs-number">1.8</span></span> repositories { jcenter() maven { url = <span class="hljs-string"><span class="hljs-string">"http://repo.spring.io/milestone"</span></span> } } dependencies { compile(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin:kotlin-stdlib-jre8:$kotlinVersion"</span></span>) compile(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin:kotlin-reflect:$kotlinVersion"</span></span>) compile(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter"</span></span>) compile(<span class="hljs-string"><span class="hljs-string">"org.springframework:spring-webflux"</span></span>) compile(<span class="hljs-string"><span class="hljs-string">"io.undertow:undertow-core"</span></span>) compile(<span class="hljs-string"><span class="hljs-string">"com.samskivert:jmustache"</span></span>) compile(<span class="hljs-string"><span class="hljs-string">"com.fasterxml.jackson.module:jackson-module-kotlin"</span></span>) testCompile(<span class="hljs-string"><span class="hljs-string">"com.nhaarman:mockito-kotlin-kt1.1:1.5.0"</span></span>) testCompile(<span class="hljs-string"><span class="hljs-string">"com.squareup.okhttp3:okhttp:3.9.0"</span></span>) testCompile(<span class="hljs-string"><span class="hljs-string">"org.junit.jupiter:junit-jupiter-api:$junitVersion"</span></span>) testRuntime(<span class="hljs-string"><span class="hljs-string">"org.junit.jupiter:junit-jupiter-engine:$junitVersion"</span></span>) } compileKotlin { kotlinOptions { jvmTarget = <span class="hljs-string"><span class="hljs-string">"1.8"</span></span> freeCompilerArgs = [<span class="hljs-string"><span class="hljs-string">"-Xjsr305=strict"</span></span>] } } compileTestKotlin { kotlinOptions { jvmTarget = <span class="hljs-string"><span class="hljs-string">"1.8"</span></span> freeCompilerArgs = [<span class="hljs-string"><span class="hljs-string">"-Xjsr305=strict"</span></span>] } }</code> </pre> <br><p>      ,     . </p><br><pre> <code class="hljs pgsql">cd step4_migration_to_webflux gradle build &amp;&amp; java -jar build/libs/step4_migration_to_webflux<span class="hljs-number"><span class="hljs-number">-1.0</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">SNAPSHOT</span></span>.jar</code> </pre> <br><p>        <code>curl</code>      </p><br><h1 id="5-perehodim-na-kotlin-dsl-v-skriptah-sborki"> 5.   Kotlin Dsl    </h1><br><p>         Kotlin Dsl (     <a href="https://github.com/gradle/kotlin-dsl/releases/">0.12.1</a> ),        . </p><br><p>  ,    Groovy Dsl,     IDE,               .    Gradle Kotlin Dsl       3.0 (   4.2.1),   Intellij Idea     ‚Äú ‚Äù Kotlin. </p><br><p>    . ,        .  ,    ,             .        : </p><br><ul><li>  <a href="https://github.com/gradle/kotlin-dsl/tree/master/samples"></a>        ,    </li><li>      ,    ,   Kotlin Dsl    ,     Groovy Dsl,     Groovy   Closure  Kotlin         . ,  ,     artifactory: </li></ul><br><pre> <code class="hljs cmake">artifactory { setContextUrl(<span class="hljs-string"><span class="hljs-string">"${project.findProperty("</span></span>artifactory_contextUrl<span class="hljs-string"><span class="hljs-string">")}"</span></span>) publish(delegateClosureOf&lt;PublisherConfig&gt; { repository(delegateClosureOf&lt;GroovyObject&gt; { setProperty(<span class="hljs-string"><span class="hljs-string">"repoKey"</span></span>, <span class="hljs-string"><span class="hljs-string">"ecomm"</span></span>) setProperty(<span class="hljs-string"><span class="hljs-string">"username"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">project</span></span>.findProperty(<span class="hljs-string"><span class="hljs-string">"artifactory_user"</span></span>)) setProperty(<span class="hljs-string"><span class="hljs-string">"password"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">project</span></span>.findProperty(<span class="hljs-string"><span class="hljs-string">"artifactory_password"</span></span>)) setProperty(<span class="hljs-string"><span class="hljs-string">"mavenCompatible"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) defaults(delegateClosureOf&lt;GroovyObject&gt; { invokeMethod(<span class="hljs-string"><span class="hljs-string">"publishConfigs"</span></span>, <span class="hljs-string"><span class="hljs-string">"wgReports"</span></span>) }) }) }) }</code> </pre> <br><p>    Groovy   : </p><br><pre> <code class="hljs kotlin">artifactory { contextUrl = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${artifactory_contextUrl}</span></span></span><span class="hljs-string">"</span></span> publish { repository { repoKey = <span class="hljs-string"><span class="hljs-string">'ecomm'</span></span> username = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${artifactory_user}</span></span></span><span class="hljs-string">"</span></span> password = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${artifactory_password}</span></span></span><span class="hljs-string">"</span></span> mavenCompatible = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } defaults { publishConfigs(<span class="hljs-string"><span class="hljs-string">'wgReports'</span></span>) } } }</code> </pre> <br><p>        ,  Gradle       API,           Closure,              Kotlin Dsl. </p><br><p>   .     ‚Äú.kts‚Äù   build.gradle     : </p><br><ul><li>  <code>compile</code>   <code>dependencies</code>  ,       Kotlin       Gradle: <br><pre> <code class="hljs objectivec">plugins { <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin.jvm"</span></span>) version <span class="hljs-string"><span class="hljs-string">"1.1.51"</span></span> }</code> </pre> </li><li>  Groovy  <code>group 'evgzakharov'</code> ,  ,   Kotlin      .      <code>group = "evgzakharov"</code> </li><li>   buildscript     .     . ,  <code>ext.springBootVersion = "2.0.0.M5"</code>     : <code>extra[‚ÄúspringBootVersion‚Äù] = "2.0.0.M5"</code> ,        <code>buildscript</code>     <code>val springBootVersion by extra { "2.0.0.M5" }</code> </li><li>   <code>dependencies</code>   ,      : <br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> springBootVersion: String <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> project.extra <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> junitVersion: String <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> project.extra <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> kotlinVersion: String <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> project.extra</code> </pre> <br><p>    ,   Kotlin,           . </p><br>  ,   ,    <code>compileKotlin</code> .             : <br><pre> <code class="hljs objectivec">tasks.withType&lt;KotlinCompile&gt; { kotlinOptions { jvmTarget = <span class="hljs-string"><span class="hljs-string">"1.8"</span></span> freeCompilerArgs = listOf(<span class="hljs-string"><span class="hljs-string">"-Xjsr305=strict"</span></span>) } }</code> </pre> <br><p>        Kotlin Dsl: </p><br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.jetbrains.kotlin.gradle.tasks.KotlinCompile group = <span class="hljs-string"><span class="hljs-string">"evgzakharov"</span></span> version = <span class="hljs-string"><span class="hljs-string">"1.0-SNAPSHOT"</span></span> buildscript { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> springBootVersion <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> extra { <span class="hljs-string"><span class="hljs-string">"2.0.0.M5"</span></span> } extra[<span class="hljs-string"><span class="hljs-string">"junitVersion"</span></span>] = <span class="hljs-string"><span class="hljs-string">"5.0.1"</span></span> extra[<span class="hljs-string"><span class="hljs-string">"kotlinVersion"</span></span>] = <span class="hljs-string"><span class="hljs-string">"1.1.51"</span></span> repositories { jcenter() maven { setUrl(<span class="hljs-string"><span class="hljs-string">"http://repo.spring.io/milestone"</span></span>) } } dependencies { classpath(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-gradle-plugin:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$springBootVersion</span></span></span><span class="hljs-string">"</span></span>) classpath(<span class="hljs-string"><span class="hljs-string">"org.junit.platform:junit-platform-gradle-plugin:1.0.1"</span></span>) classpath(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin:kotlin-gradle-plugin:1.1.51"</span></span>) } } plugins { id(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin.jvm"</span></span>) version <span class="hljs-string"><span class="hljs-string">"1.1.51"</span></span> } apply { plugin(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot"</span></span>) plugin(<span class="hljs-string"><span class="hljs-string">"org.junit.platform.gradle.plugin"</span></span>) plugin(<span class="hljs-string"><span class="hljs-string">"io.spring.dependency-management"</span></span>) } repositories { jcenter() maven { setUrl(<span class="hljs-string"><span class="hljs-string">"http://repo.spring.io/milestone"</span></span>) } } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> junitVersion: String <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> project.extra <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> kotlinVersion: String <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> project.extra dependencies { compile(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin:kotlin-stdlib-jre8:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$kotlinVersion</span></span></span><span class="hljs-string">"</span></span>) compile(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin:kotlin-reflect:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$kotlinVersion</span></span></span><span class="hljs-string">"</span></span>) compile(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter"</span></span>) compile(<span class="hljs-string"><span class="hljs-string">"org.springframework:spring-webflux"</span></span>) compile(<span class="hljs-string"><span class="hljs-string">"io.undertow:undertow-core"</span></span>) compile(<span class="hljs-string"><span class="hljs-string">"com.samskivert:jmustache"</span></span>) compile(<span class="hljs-string"><span class="hljs-string">"com.fasterxml.jackson.module:jackson-module-kotlin"</span></span>) testCompile(<span class="hljs-string"><span class="hljs-string">"com.nhaarman:mockito-kotlin-kt1.1:1.5.0"</span></span>) testCompile(<span class="hljs-string"><span class="hljs-string">"com.squareup.okhttp3:okhttp:3.9.0"</span></span>) testCompile(<span class="hljs-string"><span class="hljs-string">"org.junit.jupiter:junit-jupiter-api:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$junitVersion</span></span></span><span class="hljs-string">"</span></span>) testRuntime(<span class="hljs-string"><span class="hljs-string">"org.junit.jupiter:junit-jupiter-engine:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$junitVersion</span></span></span><span class="hljs-string">"</span></span>) } tasks.withType&lt;KotlinCompile&gt; { kotlinOptions { jvmTarget = <span class="hljs-string"><span class="hljs-string">"1.8"</span></span> freeCompilerArgs = listOf(<span class="hljs-string"><span class="hljs-string">"-Xjsr305=strict"</span></span>) } }</code> </pre> <br><p>      : </p><br><pre> <code class="hljs pgsql">cd step5_migration_kotlin_dsl gradle build &amp;&amp; java -jar build/libs/step5_migration_kotlin_dsl<span class="hljs-number"><span class="hljs-number">-1.0</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">SNAPSHOT</span></span>.jar</code> </pre> <br><p>      :) </p><br><h1 id="itogi">  Results </h1><br><p>      .       Kotlin,   Spring  JUnit,      Kotlin Dsl,    Spring  Spring-Boot () </p><br><p>   ,     ,       spring-webflux.   , ,    .        ,       Spring     .    ,   ,  ,    ,  Spring  .          . </p><br><p>   Spring Boot 2  JUnit 5   ,         .     ? , , . </p><br><p>      ‚Ä¶  Kotlin!       ‚Äî  .           .    stackoverflow     ,  ,    Mockito,        ,    .       ,  ,   ,    ,   Java      Kotlin (       ) </p><br><p>     <a href="https://github.com/evgzakharov/big_migration">github</a> </p><br><p>      !  :) </p></li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/340942/">https://habr.com/ru/post/340942/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340932/index.html">REST in the real world and the practice of hypermedia</a></li>
<li><a href="../340934/index.html">Autumn changes on Habr√© and Geektimes</a></li>
<li><a href="../340936/index.html">Agile in Russia - 82.9% of companies report that they use at least something from Agile. First poll results</a></li>
<li><a href="../340938/index.html">New virus Reaper infected 2 million IoT devices</a></li>
<li><a href="../340940/index.html">Windows Defender removes the bootloader from DiskCryptor</a></li>
<li><a href="../340944/index.html">Bad Rabbit ransomware Trojan: Bad, Bad Rabbit</a></li>
<li><a href="../340946/index.html">Jaeger Opentracing and Microservices in a real PHP and Golang project</a></li>
<li><a href="../340950/index.html">Why does one NGINX process take care of all the work?</a></li>
<li><a href="../340952/index.html">13 surprises by a non-company</a></li>
<li><a href="../340954/index.html">Cisco Sales Associate Program</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>