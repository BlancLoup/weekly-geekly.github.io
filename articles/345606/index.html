<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Updatable smart contracts on the Ethereum network</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Motivation 


 Ethereum network contracts are immutable - once uploaded to the network (blockchain), they cannot be changed. Specificity of a business...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Updatable smart contracts on the Ethereum network</h1><div class="post__text post__text-html js-mediator-article"><h3>  Motivation </h3><br><p>  Ethereum network contracts are immutable - once uploaded to the network (blockchain), they cannot be changed.  Specificity of a business or development may require updating the code, but with the traditional approach this becomes a problem. </p><br><p>  <b>Popular reasons for updating</b> </p><br><ul><li>  Errors in the code </li><li>  Changing business requirements </li><li>  Acceptance of community proposals to change contract performance </li></ul><br><h3>  Description of the technical solution </h3><br><p>  The implementation of the required functionality - updating the code, is planned through the separation of the code into its components: </p><br><ol><li>  <b>Data</b> - smart contracts without logic and providing only data storage space; </li><li>  <b>Business logic</b> - smart contracts describing the logic of extracting data from the repository and their changes; </li><li>  <b>Entry points</b> ‚Äî Immuniable contracts keep track of business logic updates and provide the end user with a link to the current business logic contract. </li></ol><a name="habracut"></a><br><h3>  Renewable smart counter contract </h3><br><p>  Imagine an abstract example cut off from reality - a counter with updated logic of magnification. </p><br><ul><li>  Stage 1. With each call, the counter increases by 1 </li><li>  Stage 2. With each call, the counter increases by 10 </li></ul><br><p>  With the traditional approach and the initial knowledge of all stages, it would be necessary to make a field in the counter clearly indicating the current stage, for example: uint public currentState.  Each time the counter increment method was called, the current stage would be checked and the code associated with it would be executed: </p><br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increaseCounter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">uint</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentState == <span class="hljs-number"><span class="hljs-number">0</span></span>) { value = value + <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentState == <span class="hljs-number"><span class="hljs-number">1</span></span>) { value = value + <span class="hljs-number"><span class="hljs-number">10</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value; }</code> </pre> <br><p>  In order to demonstrate the possibilities of renewable contracts, we agree that we will have a third stage, which we do not know yet, and we will describe its conditions at the end of the article. </p><br><h2 id="hranilische">  Storage </h2><br><p>  To implement the data layer storing the current value of the counter and separated from the business logic, create a contract - <code>~/contracts/base/UIntStorage.sol</code> : </p><br><p>  <a href="">Source url</a> </p><br><pre> <code class="hljs cs">pragma solidity ^<span class="hljs-number"><span class="hljs-number">0.4</span></span><span class="hljs-number"><span class="hljs-number">.18</span></span>; contract UIntStorage { <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _value</span></span></span><span class="hljs-function">) external </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = _value; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) external view </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } }</code> </pre> <br><p>  As the name implies and the implementation of the contract - the repository knows nothing about how it will be used and performs the task of encapsulating the <code>uint private value</code> field </p><br><h2 id="biznes-logika">  Business logic </h2><br><p>  We agree that the interaction with our business logic will be implemented through two methods: <code>increaseCounter</code> and <code>getCounter</code> to increase the counter and get the current value, respectively, which we will explicitly describe in the interface - <code>~/contracts/examples/counter/ICounter.sol</code> : </p><br><p>  <a href="">Source url</a> </p><br><pre> <code class="hljs actionscript">pragma solidity ^<span class="hljs-number"><span class="hljs-number">0.4</span></span><span class="hljs-number"><span class="hljs-number">.18</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ICounter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increaseCounter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCounter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint)</span></span></span></span>; }</code> </pre> <br><p>  Next, we describe a smart contract of business logic from the first stage that implements the <code>ICounter</code> interface and uses the previously described storage - <code>~/contracts/examples/counter/IncrementCounter.sol</code> : </p><br><p>  <a href="">Source url</a> </p><br><pre> <code class="hljs actionscript">pragma solidity ^<span class="hljs-number"><span class="hljs-number">0.4</span></span><span class="hljs-number"><span class="hljs-number">.18</span></span>; <span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> "./ICounter.sol";</span></span> <span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> "../../base/UIntStorage.sol";</span></span> contract IncrementCounter <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> ICounter { UIntStorage <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> counter; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IncrementCounter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address _storage)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span></span>{ counter = UIntStorage(_storage); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increaseCounter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> counter.setValue(getCounter() + <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCounter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> counter.getValue(); } }</code> </pre> <br><p>  <strong>It is important to note</strong> that <code>IncrementCounter</code> has no internal state (does not store data), except for the link to the repository. </p><br><p>  <em>If you agree to pass the link to the vault with the first argument to the <code>increaseCounter</code> and <code>getCounter</code> methods, you can implement the state-lesss business logic</em> </p><br><p>  Making changes to <code>~/contracts/examples/counter/ICounter.sol</code> : </p><br><p>  <a href="">Source url</a> </p><br><pre> <code class="hljs actionscript">pragma solidity ^<span class="hljs-number"><span class="hljs-number">0.4</span></span><span class="hljs-number"><span class="hljs-number">.18</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ICounter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increaseCounter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address _storage)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCounter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address _storage)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validateStorage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address _storage)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bool)</span></span></span></span>; }</code> </pre> <br><p>  Now the business logic methods wait for the first argument with a reference to the repository, as well as implement the repository verification method for validity: <code>validateStorage(address _storage)</code> </p><br><p>  Let's make changes to the implementation of the first stage - <code>~/contracts/examples/counter/IncrementCounter.sol</code> : <br>  <a href="">Source url</a> </p><br><pre> <code class="hljs javascript">pragma solidity ^<span class="hljs-number"><span class="hljs-number">0.4</span></span><span class="hljs-number"><span class="hljs-number">.18</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"./ICounter.sol"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"../../base/UIntStorage.sol"</span></span>; contract IncrementCounter is ICounter { modifier validStorage(address _storage) { <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(validateStorage(_storage)); _; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increaseCounter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">address _storage</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_storage</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">uint</span></span></span><span class="hljs-function">) </span></span>{ UIntStorage counter = UIntStorage(_storage); <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(counter.isUIntStorage()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> counter.setValue(counter.getValue() + <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCounter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">address _storage</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_storage</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">uint</span></span></span><span class="hljs-function">) </span></span>{ UIntStorage counter = UIntStorage(_storage); <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(counter.isUIntStorage()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> counter.getValue(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validateStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">address _storage</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bool</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UIntStorage(_storage).isUIntStorage(); } }</code> </pre> <br><p>  Before moving on to implementing the next stage and updating the business logic contract, we will write a couple of tests and make sure that the business logic works as planned. </p><br><h2 id="testirovanie">  Testing </h2><br><p>  This repository is a project of the <em>Truffle</em> framework and provides convenient functionality for testing: <code>truffle test</code> . </p><br><p>  <strong>I will not describe in detail the process of writing tests</strong> , but if you are interested in this topic, write to me at @alerdenisov telegrams and I will prepare an article with best-practice testing of contracts. </p><br><p>  <code>~/test/IncrementCounter.test.js</code> : </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> expectThrow <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./utils/expectThrow'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> IncrementCounter = artifacts.require(<span class="hljs-string"><span class="hljs-string">'./IncrementCounter.sol'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> UIntStorage = artifacts.require(<span class="hljs-string"><span class="hljs-string">'./UIntStorage.sol'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> BoolStorage = artifacts.require(<span class="hljs-string"><span class="hljs-string">'./BoolStorage.sol'</span></span>) contract(<span class="hljs-string"><span class="hljs-string">'IncrementCounter'</span></span>, ([owner, user]) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> counter, storage, fakeStorage before(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { storage = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> UIntStorage.new() fakeStorage = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> BoolStorage.new() counter = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> IncrementCounter.new() }) it(<span class="hljs-string"><span class="hljs-string">'Should receive 0 at begin'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> currentValue = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> counter.getCounter(storage.address) assert(currentValue.eq(<span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-string"><span class="hljs-string">`Uxpected counter value: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${currentValue.toString(</span></span><span class="hljs-number"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-number">10</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">`</span></span>) }) it(<span class="hljs-string"><span class="hljs-string">'Should increase value on 1'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> counter.increaseCounter(storage.address) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> newValue = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> counter.getCounter(storage.address) assert(newValue.eq(<span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-string"><span class="hljs-string">`Unxpected counter value: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${newValue.toString(</span></span><span class="hljs-number"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-number">10</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">`</span></span>) }) it(<span class="hljs-string"><span class="hljs-string">'Should store 1 after increment'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> storedValue = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> storage.getValue() assert(storedValue.eq(<span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-string"><span class="hljs-string">`Unxpected stored value: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${storedValue.toString(</span></span><span class="hljs-number"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-number">10</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">`</span></span>) }) it(<span class="hljs-string"><span class="hljs-string">'Should validate storage'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> counter.validateStorage(storage.address) }) it(<span class="hljs-string"><span class="hljs-string">'Should unvalidate fake storage'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> expectThrow(counter.validateStorage(fakeStorage.address)) }) })</code> </pre> <br><p>  Running tests will show that everything is "fine": </p><br><pre> <code class="hljs sql"> Contract: IncrementCounter ‚úì Should receive 0 at <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ‚úì Should increase <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-number"><span class="hljs-number">63</span></span>ms) ‚úì Should <span class="hljs-keyword"><span class="hljs-keyword">store</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">increment</span></span> ‚úì Should <span class="hljs-keyword"><span class="hljs-keyword">validate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span> ‚úì Should unvalidate fake <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">passing</span></span> (<span class="hljs-number"><span class="hljs-number">301</span></span> ms)</code> </pre> <br><p>  But actually it is not.  Let's add an intermediate test of "unauthorized" interaction with the repository: </p><br><pre> <code class="hljs lisp"> it('Should prevent non-authenticated write', async () =&gt; { await expectThrow(<span class="hljs-name"><span class="hljs-name">storage</span></span>.setValue(<span class="hljs-number"><span class="hljs-number">100</span></span>)) })</code> </pre> <br><pre> <code class="hljs sql"> Contract: IncrementCounter ‚úì Should receive 0 at <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ‚úì Should increase <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-number"><span class="hljs-number">58</span></span>ms) <span class="hljs-number"><span class="hljs-number">1</span></span>) Should prevent non-<span class="hljs-keyword"><span class="hljs-keyword">authenticated</span></span> write <span class="hljs-number"><span class="hljs-number">2</span></span>) Should <span class="hljs-keyword"><span class="hljs-keyword">store</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">increment</span></span> ‚úì Should <span class="hljs-keyword"><span class="hljs-keyword">validate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span> ‚úì Should unvalidate fake <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">passing</span></span> (<span class="hljs-number"><span class="hljs-number">330</span></span>ms) <span class="hljs-number"><span class="hljs-number">2</span></span> failing</code> </pre> <br><p>  <a href="">Source url</a> </p><br><h2 id="vladenie-hranilischem">  Storage Ownership </h2><br><p>  The problem with the current solution is that the repository does not restrict the recording in any way and the attacker can change the data in the repository and ignore the business logic of the counter contract. </p><br><p>  The main advantage of smart contracts is that they guarantee participants of the exchange that the data (state) will not be changed in any other way but declares the smart contract.  <strong>But now the changes are not limited.</strong> </p><br><p>  <strong>The task is</strong> to make it so that only the current business logic contract can change the storage. </p><br><p>  To explicitly limit the interaction with the repository, <code>Ownable</code> 's use the <code>Ownable</code> pattern from the <code>zeppelin-solidity</code> (for more information on the pattern, see the framework documentation). </p><br><p>  Inherit the storage from the <code>Ownable</code> contract and add the <code>onlyOwner</code> modifier to the <code>setValue()</code> method: </p><br><p>  <a href="">Source url</a> </p><br><pre> <code class="hljs pgsql">pragma solidity ^<span class="hljs-number"><span class="hljs-number">0.4</span></span><span class="hljs-number"><span class="hljs-number">.18</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "zeppelin-solidity/contracts/ownership/Ownable.sol"; contract UIntStorage <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Ownable { uint private <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> setValue(uint _value) onlyOwner <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> (uint) { <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = _value; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> getValue() <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> (uint) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> isUIntStorage() <span class="hljs-keyword"><span class="hljs-keyword">external</span></span> pure <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> (<span class="hljs-type"><span class="hljs-type">bool</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } }</code> </pre> <br><p>  Congratulations, now only an associated storage owner can write to our storage!  Now already 3 out of 6 tests fail!  Let's give the business management of the storage in the ‚Äúmanual‚Äù tests: </p><br><p>  <a href="">Source url</a> </p><br><pre> <code class="hljs lisp"> before(<span class="hljs-name"><span class="hljs-name">async</span></span> () =&gt; { storage = await UIntStorage.new() fakeStorage = await BoolStorage.new() counter = await IncrementCounter.new() await storage.transferOwnership(<span class="hljs-name"><span class="hljs-name">counter</span></span>.address) })</code> </pre> <br><p>  Now all the tests pass, but the second question arises: "How to manage the ownership of the repository when updating business logic" </p><br><h2 id="obschiy-kontroller">  Shared controller </h2><br><p>  Before implementing the common controller, we will make another counter contract, but already the second stage - <code>~/contracts/examples/counter/IncrementCounterPhaseTwo.sol</code> : </p><br><p>  <a href="">Source url</a> </p><br><pre> <code class="hljs actionscript">pragma solidity ^<span class="hljs-number"><span class="hljs-number">0.4</span></span><span class="hljs-number"><span class="hljs-number">.18</span></span>; <span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> "./IncrementCounter.sol";</span></span> contract IncrementCounterPhaseTwo <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> IncrementCounter { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increaseCounter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address _storage)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validStorage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_storage)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint)</span></span></span><span class="hljs-function"> </span></span>{ UIntStorage counter = UIntStorage(_storage); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> counter.setValue(counter.getValue() + <span class="hljs-number"><span class="hljs-number">10</span></span>); } }</code> </pre> <br><p>  Now, when we have two implementations of the counter and <code>Ownable</code> storage, it becomes clear that it is necessary to somehow "ask" one implementation to give the other control to the storage.  Add the <code>transferStorage(address _storage, address _counter)</code> method <code>transferStorage(address _storage, address _counter)</code> to the counter interface - <code>~/contracts/examples/counter/ICounter.sol</code> : </p><br><p>  <a href="">Source url</a> </p><br><pre> <code class="hljs actionscript">pragma solidity ^<span class="hljs-number"><span class="hljs-number">0.4</span></span><span class="hljs-number"><span class="hljs-number">.18</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ICounter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increaseCounter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address _storage)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCounter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address _storage)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validateStorage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address _storage)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bool)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transferStorage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address _storage, address _counter)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bool)</span></span></span></span>; }</code> </pre> <br><p>  <code>ICounter</code> agree that the final implementation of the <code>ICounter</code> should, after calling the <code>transferStorage</code> method, give control of the storage to the address passed to the <code>_counter</code> parameter: </p><br><p>  <a href="">Source url</a> </p><br><pre> <code class="hljs matlab"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transferStorage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address _storage, address _counter)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validStorage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_storage)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bool)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UIntStorage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_storage)</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transferOwnership</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_counter)</span></span></span><span class="hljs-function">; }</span></span></code> </pre> <br><p>  Let's finish the transfer tests with the new logic and check the result of the <code>increaseCounter</code> method after changing the logic: </p><br><pre> <code class="hljs javascript"> it(<span class="hljs-string"><span class="hljs-string">'Should transfer ownership'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> counter.transferStorage(storage.address, secondCounter.address); }) it(<span class="hljs-string"><span class="hljs-string">'Should reject increase from outdated counter'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> expectThrow(counter.increaseCounter(storage.address)); }) it(<span class="hljs-string"><span class="hljs-string">'Should increase counter with new logic'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> secondCounter.increaseCounter(storage.address) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> newValue = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> secondCounter.getCounter(storage.address) assert(newValue.eq(<span class="hljs-number"><span class="hljs-number">11</span></span>), <span class="hljs-string"><span class="hljs-string">`Unxpected counter value: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${newValue.toString(</span></span><span class="hljs-number"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-number">10</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">`</span></span>) })</code> </pre> <br><p>  Running tests can give a false sense that everything works: </p><br><pre> <code class="hljs sql"> Contract: IncrementCounter ‚úì Should receive 0 at <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ‚úì Should increase <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-number"><span class="hljs-number">75</span></span>ms) ‚úì Should prevent non-<span class="hljs-keyword"><span class="hljs-keyword">authenticated</span></span> write ‚úì Should <span class="hljs-keyword"><span class="hljs-keyword">store</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">increment</span></span> ‚úì Should <span class="hljs-keyword"><span class="hljs-keyword">validate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span> ‚úì Should unvalidate fake <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span> ‚úì Should transfer ownership ‚úì Should <span class="hljs-keyword"><span class="hljs-keyword">reject</span></span> increase <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> outdated counter ‚úì Should increase counter <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> logic (<span class="hljs-number"><span class="hljs-number">47</span></span>ms) <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">passing</span></span> (<span class="hljs-number"><span class="hljs-number">500</span></span>ms)</code> </pre> <br><p>  But I hasten to disappoint you, these changes again opened the green light to the attackers: </p><br><pre> <code class="hljs lisp"> it('Should reject non-authenticated transfer storage', async () =&gt; { await expectThrow(<span class="hljs-name"><span class="hljs-name">secondCounter</span></span>.transferStorage(<span class="hljs-name"><span class="hljs-name">storage</span></span>.address, user, { from: user })) }) it('Should reject increase from user fron previous test', async () =&gt; { await expectThrow(<span class="hljs-name"><span class="hljs-name">storage</span></span>.setValue(<span class="hljs-number"><span class="hljs-number">100500</span></span>, { from: user })) }) it('Should store <span class="hljs-number"><span class="hljs-number">11</span></span> as before', async () =&gt; { const storedValue = await storage.getValue() assert(<span class="hljs-name"><span class="hljs-name">storedValue</span></span>.eq(<span class="hljs-number"><span class="hljs-number">11</span></span>), `Unxpected stored value: ${storedValue.toString(<span class="hljs-number"><span class="hljs-number">10</span></span>)}`) })</code> </pre> <br><pre> <code class="hljs sql"> Contract: IncrementCounter ‚úì Should receive 0 at <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> (<span class="hljs-number"><span class="hljs-number">46</span></span>ms) ‚úì Should increase <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-number"><span class="hljs-number">55</span></span>ms) ‚úì Should prevent non-<span class="hljs-keyword"><span class="hljs-keyword">authenticated</span></span> write ‚úì Should <span class="hljs-keyword"><span class="hljs-keyword">store</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">increment</span></span> ‚úì Should <span class="hljs-keyword"><span class="hljs-keyword">validate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span> ‚úì Should unvalidate fake <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span> ‚úì Should transfer ownership ‚úì Should <span class="hljs-keyword"><span class="hljs-keyword">reject</span></span> increase <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> outdated counter ‚úì Should increase counter <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> logic (<span class="hljs-number"><span class="hljs-number">46</span></span>ms) <span class="hljs-number"><span class="hljs-number">1</span></span>) Should <span class="hljs-keyword"><span class="hljs-keyword">reject</span></span> non-<span class="hljs-keyword"><span class="hljs-keyword">authenticated</span></span> transfer <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) Should <span class="hljs-keyword"><span class="hljs-keyword">reject</span></span> increase <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> fron previous <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>) Should <span class="hljs-keyword"><span class="hljs-keyword">store</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">before</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">passing</span></span> (<span class="hljs-number"><span class="hljs-number">611</span></span>ms) <span class="hljs-number"><span class="hljs-number">3</span></span> failing</code> </pre> <br><p>  <strong>The main task of the</strong> common controller will control the transfer of rights and prevent anyone from this process.  First, change the <code>IncrementCounter</code> by analogy with <code>UIntStorage</code> so that it also <code>Ownable</code> logic and limits interaction with the repository: </p><br><p>  <a href="">Source url</a> </p><br><pre> <code class="hljs javascript">pragma solidity ^<span class="hljs-number"><span class="hljs-number">0.4</span></span><span class="hljs-number"><span class="hljs-number">.18</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"./ICounter.sol"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"../../base/UIntStorage.sol"</span></span>; contract IncrementCounter is ICounter, Ownable { modifier validStorage(address _storage) { <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(validateStorage(_storage)); _; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increaseCounter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">address _storage</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onlyOwner</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_storage</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">uint</span></span></span><span class="hljs-function">) </span></span>{ UIntStorage counter = UIntStorage(_storage); <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(counter.isUIntStorage()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> counter.setValue(counter.getValue() + <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCounter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">address _storage</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_storage</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">uint</span></span></span><span class="hljs-function">) </span></span>{ UIntStorage counter = UIntStorage(_storage); <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(counter.isUIntStorage()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> counter.getValue(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validateStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">address _storage</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bool</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UIntStorage(_storage).isUIntStorage(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transferStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">address _storage, address _counter</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onlyOwner</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_storage</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bool</span></span></span><span class="hljs-function">) </span></span>{ UIntStorage(_storage).transferOwnership(_counter); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre> <br><p>  We proceed to the implementation of the controller.  Basic requirements for the controller: <br>  1) Accounting for the current implementation of the counter <br>  2) Update counter sales <br>  2) Moving rights to the repository when updating the implementation <br>  3) Rejection of unauthorized update implementation attempts </p><br><p>  <code>~/contracts/examples/counter/CounterContrller.sol</code> : </p><br><p>  <a href="">Source url</a> </p><br><pre> <code class="hljs actionscript">pragma solidity ^<span class="hljs-number"><span class="hljs-number">0.4</span></span><span class="hljs-number"><span class="hljs-number">.18</span></span>; <span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> "zeppelin-solidity/contracts/ownership/Ownable.sol";</span></span> <span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> "./ICounter.sol";</span></span> <span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> "../../base/UIntStorage.sol";</span></span> contract CounterController <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Ownable { UIntStorage <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> store = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UIntStorage(); ICounter <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> counter; event CounterUpdate(address previousCounter, address nextCounter); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateCounter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(address _counter)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onlyOwner</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bool)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (address(counter) != <span class="hljs-number"><span class="hljs-number">0x0</span></span>) { counter.transferStorage(store, _counter); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { store.transferOwnership(_counter); } CounterUpdate(counter, _counter); counter = ICounter(_counter); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increaseCounter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> counter.increaseCounter(store); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCounter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> counter.getCounter(store); } }</code> </pre> <br><p>  <code>increaseCounter</code> and <code>getCounter</code> nothing more than just external methods of interaction with those similar to the current <code>ICounter</code> implementation.  All controller logic is in a small method: <code>updateCounter(address _counter)</code> . </p><br><p>  <code>updateCounter</code> method accept the address for the counter implementation and before installing it as the address of the new counter implementation?  gives him rights to the repository (from himself or from the previous one depending on the state) </p><br><p>  <em>Remember the third stage?</em>  I will omit the code for its implementation, especially since it differs from the second only in one line.  I‚Äôll just say that in the third stage the counter will increase the value by multiplying by itself: <code>value = value * value</code> . </p><br><p>  Let's write some tests and make sure that the controller works and performs the tasks assigned to it: </p><br><pre> <code class="hljs cs">import expectThrow <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./utils/expectThrow'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> IncrementCounter = artifacts.require(<span class="hljs-string"><span class="hljs-string">'./IncrementCounter.sol'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> IncrementCounterPhaseTwo = artifacts.require(<span class="hljs-string"><span class="hljs-string">'./IncrementCounterPhaseTwo.sol'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MultiplyCounterPhaseThree = artifacts.require(<span class="hljs-string"><span class="hljs-string">'./MultiplyCounterPhaseThree.sol'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CounterController = artifacts.require(<span class="hljs-string"><span class="hljs-string">'./CounterController.sol'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> UIntStorage = artifacts.require(<span class="hljs-string"><span class="hljs-string">'./UIntStorage.sol'</span></span>) contract(<span class="hljs-string"><span class="hljs-string">'CounterController'</span></span>, ([owner, user]) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> controller, counterOne, counterTwo, counterThree, <span class="hljs-function"><span class="hljs-function">storage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">before</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">async</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (</span></span></span><span class="hljs-function">)</span></span> =&gt; { controller = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> CounterController.new() storage = UIntStorage.at(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> controller.store()) counterOne = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> IncrementCounter.new() counterTwo = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> IncrementCounterPhaseTwo.new() counterThree = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> MultiplyCounterPhaseThree.new() <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> counterOne.transferOwnership(controller.address) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> counterTwo.transferOwnership(controller.address) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> counterThree.transferOwnership(controller.address) }) it(<span class="hljs-string"><span class="hljs-string">'Shoult create storage'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { assert(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> storage.isUIntStorage(), <span class="hljs-string"><span class="hljs-string">'Controller doesn\'t create proper storage'</span></span>) }) it(<span class="hljs-string"><span class="hljs-string">'Should change counter implementation'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> controller.updateCounter(counterOne.address) assert(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> controller.counter() === counterOne.address, `<span class="hljs-function"><span class="hljs-function">Unxpected counter </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">controller</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">${</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">await</span></span></span></span><span class="hljs-function"><span class="hljs-params"> controller.counter(</span></span></span><span class="hljs-function">)} but expect $</span></span>{counterOne.address})`) }) it(<span class="hljs-string"><span class="hljs-string">'Should increase counter on 1'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> controller.increaseCounter() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> controller.getCounter() assert(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.eq(<span class="hljs-number"><span class="hljs-number">1</span></span>), `Unxpected counter <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: ${<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.toString(<span class="hljs-number"><span class="hljs-number">10</span></span>)}`) }) it(<span class="hljs-string"><span class="hljs-string">'Should update counter'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> controller.updateCounter(counterTwo.address) assert(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> controller.counter() === counterTwo.address, `<span class="hljs-function"><span class="hljs-function">Unxpected counter </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">controller</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">${</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">await</span></span></span></span><span class="hljs-function"><span class="hljs-params"> controller.counter(</span></span></span><span class="hljs-function">)} but expect $</span></span>{counterTwo.address})`) }) it(<span class="hljs-string"><span class="hljs-string">'Should increase counter on 10 after update'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> controller.increaseCounter() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> controller.getCounter() assert(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.eq(<span class="hljs-number"><span class="hljs-number">11</span></span>), `Unxpected counter <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: ${<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.toString(<span class="hljs-number"><span class="hljs-number">10</span></span>)}`) }) it(<span class="hljs-string"><span class="hljs-string">'Should reject non-authenticated update'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> expectThrow(controller.updateCounter(counterTwo.address, { <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: user })) }) it(<span class="hljs-string"><span class="hljs-string">'Should update on phase three and increase counter to 11*11 after execution'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> controller.updateCounter(counterThree.address) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> controller.increaseCounter() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> controller.getCounter() assert(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.eq(<span class="hljs-number"><span class="hljs-number">121</span></span>), `Unxpected counter <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: ${<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.toString(<span class="hljs-number"><span class="hljs-number">10</span></span>)}`) }) })</code> </pre><br><pre> <code class="hljs sql"> Contract: CounterController ‚úì Shoult <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span> ‚úì Should <span class="hljs-keyword"><span class="hljs-keyword">change</span></span> counter implementation (<span class="hljs-number"><span class="hljs-number">53</span></span>ms) ‚úì Should increase counter <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-number"><span class="hljs-number">52</span></span>ms) ‚úì Should <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> counter (<span class="hljs-number"><span class="hljs-number">55</span></span>ms) ‚úì Should increase counter <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> (<span class="hljs-number"><span class="hljs-number">56</span></span>ms) ‚úì Should <span class="hljs-keyword"><span class="hljs-keyword">reject</span></span> non-<span class="hljs-keyword"><span class="hljs-keyword">authenticated</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> ‚úì Should <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> phase three <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> increase counter <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>*<span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> execution (<span class="hljs-number"><span class="hljs-number">89</span></span>ms) <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">passing</span></span> (<span class="hljs-number"><span class="hljs-number">684</span></span>ms)</code> </pre> <br><p>  As you can see the controller performs its task, and the code of our counter has become updated. </p><br><h1 id="rezyume">  Summary </h1><br><p>  Despite the abstract (and absurdity) of the example, the approach can be applied in real contracts.  For example, to ensure the upgradeability of game logic in the Evogame project, I use this approach in contracts that implement monster cards, battle logic, etc. </p><br><p>  But this approach has a number of significant flaws and comments: </p><br><ul><li>  <strong>The cost of transactions increases</strong> (the volume of gas consumed), but not significantly.  If you want to make calculations, I will be grateful or expect me in the near future. </li><li>  <strong>The role of the administrator appears</strong> , but is solved by transferring the rights to the controller to the smart contract of decentralized voting for adopting updates. </li><li>  <strong>The complexity of designing</strong> , writing code in one monolithic context is many times simpler and requires less attention to data and message flows.  Implementing a state-less requires even more attention from the developer.  Solved by calling the implementation via <code>delegatecall</code> .  Write me if you need to write a continuation with the transfer of state via <code>delegatecall</code> </li></ul><br><p>  UPD: <br>  <strong>@dzentota</strong> in the telegram discussion noted a flaw: an extra call to <code>isUIntStorage()</code> in the <code>IncrementCounter</code> methods.  (Correction) [ <a href="">https://github.com/alerdenisov/upgradable-contracts/blob/master/contracts/examples/counter/IncrementCounter.sol</a> ] </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/345606/">https://habr.com/ru/post/345606/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345596/index.html">The next ethical hacking contest ‚ÄúDefense in Defense 2017‚Äù</a></li>
<li><a href="../345598/index.html">Russian AI Cup 2017 - History 11 places</a></li>
<li><a href="../345600/index.html">ONLYOFFICE 2017: Results</a></li>
<li><a href="../345602/index.html">As we reached idyll, working without managers. Part 2. Secret Room</a></li>
<li><a href="../345604/index.html">Will the blockchain help optimize IAM solutions?</a></li>
<li><a href="../345608/index.html">Down with the signs! How to learn English times</a></li>
<li><a href="../345610/index.html">Security Week 51: the old rake with a new force, "stretching" against vulnerable sites, another hacktivist</a></li>
<li><a href="../345612/index.html">The introduction of a transaction audit system on American exchanges was postponed due to fear of hacker attacks.</a></li>
<li><a href="../345618/index.html">Pre-project analysis</a></li>
<li><a href="../345620/index.html">"On the mistakes of others": what you need to know for the successful implementation of the Service Desk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>