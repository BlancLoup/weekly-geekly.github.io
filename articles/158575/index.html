<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Comprehensive automation of Firebird / InterBase database backup on Windows servers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The following material may be useful to novice database administrators who have realized the importance of creating a backup system, but have not yet ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Comprehensive automation of Firebird / InterBase database backup on Windows servers</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/493/01e/546/49301e546e3b00631a04e4f61ad1796e.png" alt="image"><br>  The following material may be useful to novice database administrators who have realized the importance of creating a backup system, but have not yet acquired their own scripts or utilities.  Below I will give the script as a command bat file used in our organization to automate the removal of backups from Firebird databases, analyze its key fragments and give examples of use.  It is also suitable for Interbase or Yaffil databases, but I believe that with minimal rework of the call to the utility, it can be adapted for almost any DBMS. <br><a name="habracut"></a><br>  First of all, I give a couple of links where you can and should read the theory of the question: <br>  <a href="http://www.firebirdsql.org/file/documentation/reference_manuals/user_manuals/html/gbak.html">firebirdsql.org: Firebird's gbak Backup and Restore tool (eng.)</a> <br>  <a href="http://ibase.ru/devinfo/gbak.htm">ibase.ru: GBAK, Firebird and InterBase Utility</a> <br><br>  A little about terms: <br><ul><li>  <a href="http://ibase.ru/devinfo/gbak.htm">Backup</a> ( <acronym>b</acronym> ) - the process of removing a backup copy from the database.  At the output we have a file of a special format, which is not a database, but which can be deployed to a new database.  Usually it is much easier than the source database file due to the lack of index bodies, not using space reservations on data pages, the absence of junk entries and other factors that play a role in compaction. </li><li>  <a href="http://ibase.ru/devinfo/gbak.htm">Restore, or restore</a> ( <acronym>r</acronym> ) - the process of creating a new database from a backup file.  The resulting database will be equivalent to the original at the time of the start of the backup.  During the recovery phase, you can additionally change the owner of the database, change the size of the database page, set a new cache size.  In the scripts, the restaurant often plays a supporting role - checking that the backup file has received a valid and usable database. </li><li>  <acronym>b / r</acronym> - a set of backup and recovery processes, as a result of which we get a fresh, non-aspiring database, with dropped transaction counters, and occupying minimal disk space.  If someone did not know: Firebird / InterBase DBs can only grow in size, but never return ‚Äúextra‚Äù pages to the file system.  Therefore, b / r - the only way to "lose weight" for the database, if it bothers you.  Also, b / r is an extremely desirable option when transferring databases between servers, especially if we are talking about different operating systems, and even more so about different hardware architectures. </li></ul><br>  So, what activities make up the database backup process, if you approach the issue in a comprehensive way, and not limited to just running gbak.exe with the necessary keys?  I would single out the following main ones: <br><ol><li>  Check that the destination directory exists and, if necessary, create it (not all utilities will create a directory structure, if it turns out that the output file needs to be placed in a non-existent directory). </li><li>  Making a backup copy of the database using standard tools supplied with the server. </li><li>  Optional test restore backup (alas, but occasionally there are times when the server has created a backup file, but because of errors in the metadata <a href="http://ibase.ru/devinfo/db_repair.htm">could not restore it to a new database</a> ). </li><li>  Optional compression of the backup file by the archiver. </li><li>  Optional control of stored backups by the number of files and / or the space they occupy. </li><li>  Notify the administrator of any kind of failures that occurred in the previous steps, by e-mail, NET SEND transport or other means.  It is also desirable to maintain a cumulative log failures. </li></ol><br>  Our script, of course, can do all of the above, but it can also do something else: <br><ul><li>  Work with any database: local or remote;  with a fully specified path or via alias;  with optional port indication if nonstandard is used. </li><li>  In the case of a local database, <a href="http://ibase.ru/devinfo/gbak.htm">backup through services is used</a> , which allows to significantly reduce the operation time.  A test restore is always performed on the local machine, and happens through services. </li><li>  By default, garbage collection in the source database is disabled at the backup stage (there is an option to enable it), which reduces the operation time. </li><li>  RAR is used as a backup archiver, and the compression level (and therefore the operation speed) is set from 1 (low compression, better speed) to 5 (best compression, long time).  Compression value 0 means "do not archive, save the backup file as it is."  You can easily replace rar calls with another archiver, for example, free 7zip.  But rar is noticeably faster in our tests. </li><li>  The script can be transferred an indefinite number of files (possibly through a mask), which should be added to the final archive.  We take this opportunity to ensure that with each backup of the database there is an executable file of the application program that serves this database.  A useful thing when you have to raise an archive 6-12 months ago: right at hand is the actual for the old database program that can work with that version of metadata. </li><li>  There is an option to add b / r logs inside the backup archive.  In case of "debriefing" after the fact. </li><li>  The number of stored backups, if not redefined, is 30 pcs.  When the specified number of copies in the destination folder is reached, the oldest backups will be deleted, freeing up space for new ones.  By setting the parameter value to 0, you can disable the control of the number of backups. </li><li>  The amount of stored backups is not controlled by default, but can be specified in bytes, Kb, MB or GB. </li><li>  b / r is executed by default on behalf of the built-in superuser sysdba.  The local server's SYSDBA password is stored in source code.  And to perform backup over the network, the script can be passed a parameter with the remote server's SYSDBA password.  In particularly paranoid cases, the SYSDBA password of the local server can be erased from the source and also passed as a parameter when calling. </li><li>  The well-known <a href="http://sourceforge.net/projects/blat/">Blat</a> utility among system administrators is used as a mailer. </li><li>  The output file (archive or regular backup file, if compression is disabled) contains a date and time stamp of its creation, which allows visual orientation in the backup directory. </li></ul><br>  Entry dragged on;  Under the spoiler I bring the full source of the script. <br><div class="spoiler">  <b class="spoiler_title">source fb_backup.bat</b> <div class="spoiler_text"><pre><code class="dos hljs">@<span class="hljs-built_in"><span class="hljs-built_in">CLS</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> OFF <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> #=============================================================================# <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # Firebird/InterBase database backup, test <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span>, zip and rotate script # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # <span class="hljs-built_in"><span class="hljs-built_in">Ver</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">8</span></span> (<span class="hljs-number"><span class="hljs-number">26</span></span>.<span class="hljs-number"><span class="hljs-number">01</span></span>.<span class="hljs-number"><span class="hljs-number">2013</span></span>) # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # Author: arni (email:arnisoft <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> rambler dot ru) # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # <span class="hljs-built_in"><span class="hljs-built_in">Format</span></span>: # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # FB_BACKUP [host[/port]:][<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>]db_file_or_alias result_dir # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # [/count:backup_count] [/space:backup_space_limit] [/gc] # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # [/<span class="hljs-built_in"><span class="hljs-built_in">restore</span></span>] [/compress:level] [/password:SYSDBA_password] # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # [other_files_to_compress [...]] # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # Input params: # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # [host[/port]:][<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>] : local or network, full-specified <span class="hljs-built_in"><span class="hljs-built_in">path</span></span> or alias # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # db_file_or_alias to the source database # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # result_dir : result backup collecting directory # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # /count:backup_count : backup file number to keep (<span class="hljs-number"><span class="hljs-number">30</span></span> by default) # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # /space:backup_space_limit : total backup size <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> bytes (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> use by default) # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # you can use suffixes K, M or G. # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # /gc : need to collect garbage <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> DB (OFF by default) # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # /<span class="hljs-built_in"><span class="hljs-built_in">restore</span></span> : need to <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> test <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span> (OFF by default) # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # /compress:level : compress ratio <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> RAR (<span class="hljs-number"><span class="hljs-number">2</span></span> by default): # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> compress, <span class="hljs-number"><span class="hljs-number">1</span></span>: fastest, <span class="hljs-number"><span class="hljs-number">2</span></span>: fast, # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # <span class="hljs-number"><span class="hljs-number">3</span></span>: normal, <span class="hljs-number"><span class="hljs-number">4</span></span>: good, <span class="hljs-number"><span class="hljs-number">5</span></span>: best # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # /password:SYSDBA_password : optional SYSDBA password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> remote server # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # (by default uses one from the source code) # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # other_files_to_compress : list of files that must be add to archive # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> #=============================================================================# <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Server ==================================================================== <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> gbak="C:\Programs\FB25\bin\gbak.exe" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> ISC_USER=SYSDBA <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> ISC_PASSWORD_LOCAL=masterkey <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> ISC_PASSWORD_REMOTE= <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Backup/<span class="hljs-built_in"><span class="hljs-built_in">restore</span></span> preferences ================================================ <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> temp_backup_dir=<span class="hljs-variable"><span class="hljs-variable">%TEMP%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> temp_restore_dir=<span class="hljs-variable"><span class="hljs-variable">%TEMP%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> backup_count=<span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> backup_space_limit=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> backup_ext=fbk <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> garbage_collection=-g <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== RAR ======================================================================= <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> rar="C:\Program Files\WinRAR\rar.exe" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> rar_options=a -y -ep -idcd <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> rar_password= <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> rar_compress_ratio=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Mailer (see "Blat" <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> http://sourceforge.<span class="hljs-built_in"><span class="hljs-built_in">net</span></span>/projects/blat) =============== <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> blat="C:\Programs\Blat307\blat.exe" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> smtp_server=smtp.mailserver.ru <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> mail_sender=foo@mailserver.ru <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> mail_login=foo <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> mail_password=<span class="hljs-number"><span class="hljs-number">1234</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> mail_receiver= <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> mail_subject=Fail while database b/r <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Other preferences ========================================================= <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> include_logs_to_archive=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> net_send_receiver= <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> error_log= <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Define database location ================================================== <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> full_db_specification=%~<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> full_db_specification = <span class="hljs-variable"><span class="hljs-variable">%full_db_specification%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> Devide DB spec to network and local parts <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> /f "DELIMS=: TOKENS=<span class="hljs-number"><span class="hljs-number">1</span></span>*" <span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ("<span class="hljs-variable"><span class="hljs-variable">%full_db_specification%</span></span>") <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> network=<span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> local=<span class="hljs-variable"><span class="hljs-variable">%%j</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> spec. is alias with no network part <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%local%</span></span>" == "" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> network= <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> local=<span class="hljs-variable"><span class="hljs-variable">%full_db_specification%</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> spec. is full specified file with no network part <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> /f "DELIMS=\ TOKENS=*" <span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ("<span class="hljs-variable"><span class="hljs-variable">%local%</span></span>") <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%local%</span></span>" == "\<span class="hljs-variable"><span class="hljs-variable">%%i</span></span>" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> network= <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> local=<span class="hljs-variable"><span class="hljs-variable">%full_db_specification%</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> network_specification = <span class="hljs-variable"><span class="hljs-variable">%network%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%network%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" ( <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> Extract port from network spec (<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> exists) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> /f "DELIMS=/ TOKENS=<span class="hljs-number"><span class="hljs-number">1</span></span>*" <span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ("<span class="hljs-variable"><span class="hljs-variable">%network%</span></span>") <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> host=<span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> port=<span class="hljs-variable"><span class="hljs-variable">%%j</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%%j</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> network_host = <span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> network_port = <span class="hljs-variable"><span class="hljs-variable">%%j</span></span> ) ) ) <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> DB is local or remote <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> service_mgr_host=localhost <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> is_local_db=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%network%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%host%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">NEQ</span></span> "<span class="hljs-number"><span class="hljs-number">127</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> /i "<span class="hljs-variable"><span class="hljs-variable">%host%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">NEQ</span></span> "localhost" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> is_local_db=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%is_local_db%</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%network%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> service_mgr_host=<span class="hljs-variable"><span class="hljs-variable">%network%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> local_db_specification = <span class="hljs-variable"><span class="hljs-variable">%local%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%local%</span></span>" == "" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> fail=Param #<span class="hljs-number"><span class="hljs-number">1</span></span> {DB specification} missing! <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> finish ) <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> Extract file (or alias) from local part of spec. <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> /f <span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ("<span class="hljs-variable"><span class="hljs-variable">%local%</span></span>") <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> local_path=<span class="hljs-variable"><span class="hljs-variable">%%~</span></span>dpi <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> local_file_or_alias=<span class="hljs-variable"><span class="hljs-variable">%%~</span></span>nxi ) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%local%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">NEQ</span></span> "<span class="hljs-variable"><span class="hljs-variable">%local_file_or_alias%</span></span>" ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> local_path = <span class="hljs-variable"><span class="hljs-variable">%local_path%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> Check DB file exists <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> local, <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> aliased specification <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%is_local_db%</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXIST</span></span> "<span class="hljs-variable"><span class="hljs-variable">%local%</span></span>" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> fail=Local DB file <span class="hljs-variable"><span class="hljs-variable">%local%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> found! <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> finish ) ) <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> local_db_file_or_alias = <span class="hljs-variable"><span class="hljs-variable">%local_file_or_alias%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Define result directory =================================================== <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> result_dir=%~<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> result_dir = <span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span>" == "" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> fail=Param #<span class="hljs-number"><span class="hljs-number">2</span></span> {backup collecting directory} missing! <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> finish ) <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> Cut the result <span class="hljs-built_in"><span class="hljs-built_in">dir</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> it is <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>-style (ends with separator) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%result_dir:~-1%</span></span>" == "\" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> result_dir=<span class="hljs-variable"><span class="hljs-variable">%result_dir:~0,-1%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> Try to create the result directory <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> it is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> exists yet <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXIST</span></span> "<span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span>" ( <span class="hljs-built_in"><span class="hljs-built_in">MD</span></span> "<span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXIST</span></span> "<span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span>" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> fail=Cannot create backup collecting directory! <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> finish ) ) <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> Test <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> it is local or remote directory (elementary, may get wrong answer) <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> is_local_result_dir=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%result_dir:~0,2%</span></span>" == "\\" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> is_local_result_dir=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Use other command line options ============================================ :loop_options <span class="hljs-built_in"><span class="hljs-built_in">SHIFT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> next_param=%~<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%next_param%</span></span>" == "" <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> print_options <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> prefix=<span class="hljs-variable"><span class="hljs-variable">%next_param:~0,1%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%prefix%</span></span>" == "/" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> next_param=<span class="hljs-variable"><span class="hljs-variable">%next_param:~1%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%prefix%</span></span>" == "-" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> next_param=<span class="hljs-variable"><span class="hljs-variable">%next_param:~1%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%next_param%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" ( <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> /f "DELIMS=: TOKENS=<span class="hljs-number"><span class="hljs-number">1</span></span>*" <span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ("<span class="hljs-variable"><span class="hljs-variable">%next_param%</span></span>") <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> value=<span class="hljs-variable"><span class="hljs-variable">%%j</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> /i "<span class="hljs-variable"><span class="hljs-variable">%%i</span></span>" == "count" <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%%j</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> count <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> /i "<span class="hljs-variable"><span class="hljs-variable">%%i</span></span>" == "space" <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%%j</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> space <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> /i "<span class="hljs-variable"><span class="hljs-variable">%%i</span></span>" == "gc" <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> gc <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> /i "<span class="hljs-variable"><span class="hljs-variable">%%i</span></span>" == "<span class="hljs-built_in"><span class="hljs-built_in">restore</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> /i "<span class="hljs-variable"><span class="hljs-variable">%%i</span></span>" == "compress" <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%%j</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> compress <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> /i "<span class="hljs-variable"><span class="hljs-variable">%%i</span></span>" == "password" <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%%j</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> password <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXIST</span></span> "<span class="hljs-variable"><span class="hljs-variable">%next_param%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> add_file_to_compress <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%prefix%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "/" <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> add_file_to_compress <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> unknown param found: <span class="hljs-variable"><span class="hljs-variable">%next_param%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> loop_options ) ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> empty param found! <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> loop_options ) <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Define file count <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the result <span class="hljs-built_in"><span class="hljs-built_in">dir</span></span> ======================================= :count <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> /a backup_count=<span class="hljs-number"><span class="hljs-number">0</span></span>+<span class="hljs-variable"><span class="hljs-variable">%value%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> loop_options <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Define allowed backup space limit ========================================= :space <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> suffix=<span class="hljs-variable"><span class="hljs-variable">%value:~-1%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%suffix%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "<span class="hljs-number"><span class="hljs-number">9</span></span>" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> value=<span class="hljs-variable"><span class="hljs-variable">%value:~0,-1%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> /i "<span class="hljs-variable"><span class="hljs-variable">%suffix%</span></span>" == "K" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> file_size_shift=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> /a value*=<span class="hljs-number"><span class="hljs-number">1000</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> /i "<span class="hljs-variable"><span class="hljs-variable">%suffix%</span></span>" == "M" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> file_size_shift=<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> /a value*=<span class="hljs-number"><span class="hljs-number">1000</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> /i "<span class="hljs-variable"><span class="hljs-variable">%suffix%</span></span>" == "G" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> file_size_shift=<span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> /a value*=<span class="hljs-number"><span class="hljs-number">1000</span></span> ) ) <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> /a backup_space_limit=<span class="hljs-number"><span class="hljs-number">0</span></span>+<span class="hljs-variable"><span class="hljs-variable">%value%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> loop_options <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Define need of garbage collection ========================================= :gc <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> garbage_collection= <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%value%</span></span>" == "<span class="hljs-number"><span class="hljs-number">0</span></span>" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> garbage_collection=-g <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> /i "<span class="hljs-variable"><span class="hljs-variable">%value%</span></span>" == "N" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> garbage_collection=-g <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> /i "<span class="hljs-variable"><span class="hljs-variable">%value%</span></span>" == "NO" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> garbage_collection=-g <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> /i "<span class="hljs-variable"><span class="hljs-variable">%value%</span></span>" == "OFF" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> garbage_collection=-g <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> loop_options <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Define need of test <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span> =============================================== :<span class="hljs-built_in"><span class="hljs-built_in">restore</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%value%</span></span>" == "<span class="hljs-number"><span class="hljs-number">0</span></span>" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> /i "<span class="hljs-variable"><span class="hljs-variable">%value%</span></span>" == "N" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> /i "<span class="hljs-variable"><span class="hljs-variable">%value%</span></span>" == "NO" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> /i "<span class="hljs-variable"><span class="hljs-variable">%value%</span></span>" == "OFF" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> loop_options <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Define need of backup compression and compress ratio ====================== :compress <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%value%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GEQ</span></span> "<span class="hljs-number"><span class="hljs-number">0</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%value%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">LEQ</span></span> "<span class="hljs-number"><span class="hljs-number">5</span></span>" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> rar_compress_ratio=<span class="hljs-variable"><span class="hljs-variable">%value%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> loop_options <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Define SYSDBA password (<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> addition or <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">replace</span></span> source code given) ===== :password <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> "<span class="hljs-variable"><span class="hljs-variable">%ISC_PASSWORD_LOCAL%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> "<span class="hljs-variable"><span class="hljs-variable">%ISC_PASSWORD_REMOTE%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> ISC_PASSWORD_LOCAL=<span class="hljs-variable"><span class="hljs-variable">%value%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> ISC_PASSWORD_REMOTE=<span class="hljs-variable"><span class="hljs-variable">%value%</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> "<span class="hljs-variable"><span class="hljs-variable">%ISC_PASSWORD_LOCAL%</span></span>" == "" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> ISC_PASSWORD_LOCAL=<span class="hljs-variable"><span class="hljs-variable">%value%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> "<span class="hljs-variable"><span class="hljs-variable">%ISC_PASSWORD_REMOTE%</span></span>" == "" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> ISC_PASSWORD_REMOTE=<span class="hljs-variable"><span class="hljs-variable">%value%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> loop_options <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Define file list to compress (<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> addition to backup and maybe logs) ======= :add_file_to_compress <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%backup_files%</span></span>" == "" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> backup_files="<span class="hljs-variable"><span class="hljs-variable">%next_param%</span></span>" ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> backup_files=<span class="hljs-variable"><span class="hljs-variable">%backup_files%</span></span> "<span class="hljs-variable"><span class="hljs-variable">%next_param%</span></span>" ) <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> loop_options <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== <span class="hljs-built_in"><span class="hljs-built_in">Print</span></span> predefined or recognized <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> command line options ==================== :print_options <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%backup_count%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> backup_count = <span class="hljs-variable"><span class="hljs-variable">%backup_count%</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> backup_count = OFF ) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%file_size_shift%</span></span>" == "" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> file_size_shift=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%backup_space_limit%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%file_size_shift%</span></span> == <span class="hljs-number"><span class="hljs-number">6</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> backup_space_limit = <span class="hljs-variable"><span class="hljs-variable">%backup_space_limit%</span></span> Mb ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%file_size_shift%</span></span> == <span class="hljs-number"><span class="hljs-number">3</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> backup_space_limit = <span class="hljs-variable"><span class="hljs-variable">%backup_space_limit%</span></span> Kb ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> backup_space_limit = <span class="hljs-variable"><span class="hljs-variable">%backup_space_limit%</span></span> bytes ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> backup_space_limit = OFF ) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%garbage_collection%</span></span>" == "-g" ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> garbage_collection_flag = OFF ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> garbage_collection_flag = ON ) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%restore%</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> test_restore_flag = OFF ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> test_restore_flag = ON ) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%rar_compress_ratio%</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> backup_compressing = OFF ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> backup_compressing = ON, RAR-ratio=<span class="hljs-variable"><span class="hljs-variable">%rar_compress_ratio%</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Define backup file and backup log ========================================= <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> datetime=<span class="hljs-variable"><span class="hljs-variable">%date:~-2%</span></span><span class="hljs-variable"><span class="hljs-variable">%date:~3,2%</span></span><span class="hljs-variable"><span class="hljs-variable">%date:~0,2%</span></span>_<span class="hljs-variable"><span class="hljs-variable">%time:~0,2%</span></span><span class="hljs-variable"><span class="hljs-variable">%time:~3,2%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> finish_file=<span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%local_file_or_alias%</span></span>.%datetime: =<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-variable"><span class="hljs-variable">%.%</span></span>backup_ext% <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> direct_backup=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%rar_compress_ratio%</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%is_local_result_dir%</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> direct_backup=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%restore%</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> direct_backup=<span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%direct_backup%</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> backup_file=<span class="hljs-variable"><span class="hljs-variable">%finish_file%</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> backup_file=<span class="hljs-variable"><span class="hljs-variable">%temp_backup_dir%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%local_file_or_alias%</span></span>.<span class="hljs-variable"><span class="hljs-variable">%backup_ext%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXIST</span></span> "<span class="hljs-variable"><span class="hljs-variable">%temp_backup_dir%</span></span>" ( <span class="hljs-built_in"><span class="hljs-built_in">MD</span></span> "<span class="hljs-variable"><span class="hljs-variable">%temp_backup_dir%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXIST</span></span> "<span class="hljs-variable"><span class="hljs-variable">%temp_backup_dir%</span></span>" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> fail=Cannot create backup directory! <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> finish ) ) ) <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> backup_file = <span class="hljs-variable"><span class="hljs-variable">%backup_file%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> backup_log=<span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%local_file_or_alias%</span></span>.backup.log <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> backup_log = <span class="hljs-variable"><span class="hljs-variable">%backup_log%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Define <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span> file and <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span> log ======================================= <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> restore_file=<span class="hljs-variable"><span class="hljs-variable">%temp_restore_dir%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%local_file_or_alias%</span></span>.testrest <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%restore%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXIST</span></span> "<span class="hljs-variable"><span class="hljs-variable">%temp_restore_dir%</span></span>" ( <span class="hljs-built_in"><span class="hljs-built_in">MD</span></span> "<span class="hljs-variable"><span class="hljs-variable">%temp_restore_dir%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXIST</span></span> "<span class="hljs-variable"><span class="hljs-variable">%temp_restore_dir%</span></span>" ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> temp_restore_dir = <span class="hljs-variable"><span class="hljs-variable">%temp_restore_dir%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> fail=Cannot create <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span> directory! <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> finish ) ) <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> restore_file = <span class="hljs-variable"><span class="hljs-variable">%restore_file%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> restore_log=<span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%local_file_or_alias%</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">restore</span></span>.log ) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%restore_log%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> restore_log = <span class="hljs-variable"><span class="hljs-variable">%restore_log%</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> restore_log=just_a_stub ) <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Define compresed file ===================================================== <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> compressed_file=<span class="hljs-variable"><span class="hljs-variable">%finish_file%</span></span>.rar <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%rar_compress_ratio%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> compressed_file = <span class="hljs-variable"><span class="hljs-variable">%compressed_file%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> finish_file=<span class="hljs-variable"><span class="hljs-variable">%compressed_file%</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Delete <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> actual files (over <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> count) ============================== <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> /a over=<span class="hljs-variable"><span class="hljs-variable">%backup_count%</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%backup_count%</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> deleting_old_files = <span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%local_file_or_alias%</span></span>.*.<span class="hljs-variable"><span class="hljs-variable">%backup_ext%</span></span>* <span class="hljs-built_in"><span class="hljs-built_in">DEL</span></span> "<span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%local_file_or_alias%</span></span>.*.<span class="hljs-variable"><span class="hljs-variable">%backup_ext%</span></span>*" /q ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%backup_count%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> /f "SKIP=<span class="hljs-variable"><span class="hljs-variable">%over%</span></span>" <span class="hljs-variable"><span class="hljs-variable">%%f</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ('<span class="hljs-built_in"><span class="hljs-built_in">DIR</span></span> "<span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%local_file_or_alias%</span></span>.*.<span class="hljs-variable"><span class="hljs-variable">%backup_ext%</span></span>*" /a:-D /b /o:-N <span class="hljs-number"><span class="hljs-number">2</span></span>^&gt;<span class="hljs-built_in"><span class="hljs-built_in">NUL</span></span>') <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXIST</span></span> "<span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%%f</span></span>" ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> deleting_old_file = <span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%%f</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DEL</span></span> "<span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%%f</span></span>" /q ) ) ) <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Perform backup ============================================================ <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXIST</span></span> "<span class="hljs-variable"><span class="hljs-variable">%backup_log%</span></span>" <span class="hljs-built_in"><span class="hljs-built_in">DEL</span></span> "<span class="hljs-variable"><span class="hljs-variable">%backup_log%</span></span>" /q <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> backup_start = <span class="hljs-variable"><span class="hljs-variable">%date%</span></span> <span class="hljs-variable"><span class="hljs-variable">%time:~0,8%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> is_local_backup=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%is_local_db%</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%is_local_result_dir%</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> is_local_backup=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%direct_backup%</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> is_local_backup=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> ISC_PASSWORD=<span class="hljs-variable"><span class="hljs-variable">%ISC_PASSWORD_LOCAL%</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> ISC_PASSWORD=<span class="hljs-variable"><span class="hljs-variable">%ISC_PASSWORD_REMOTE%</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%rar_password%</span></span>" == "" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> rar_password=<span class="hljs-variable"><span class="hljs-variable">%ISC_PASSWORD%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%is_local_backup%</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> <span class="hljs-variable"><span class="hljs-variable">%gbak%</span></span> -b <span class="hljs-variable"><span class="hljs-variable">%garbage_collection%</span></span> -se <span class="hljs-variable"><span class="hljs-variable">%service_mgr_host%</span></span>:service_mgr <span class="hljs-variable"><span class="hljs-variable">%local%</span></span> "<span class="hljs-variable"><span class="hljs-variable">%backup_file%</span></span>" -v -y "<span class="hljs-variable"><span class="hljs-variable">%backup_log%</span></span>" <span class="hljs-variable"><span class="hljs-variable">%gbak%</span></span> -b <span class="hljs-variable"><span class="hljs-variable">%garbage_collection%</span></span> -se <span class="hljs-variable"><span class="hljs-variable">%service_mgr_host%</span></span>:service_mgr <span class="hljs-variable"><span class="hljs-variable">%local%</span></span> "<span class="hljs-variable"><span class="hljs-variable">%backup_file%</span></span>" -v &gt;"<span class="hljs-variable"><span class="hljs-variable">%backup_log%</span></span>" <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> <span class="hljs-variable"><span class="hljs-variable">%gbak%</span></span> -b <span class="hljs-variable"><span class="hljs-variable">%garbage_collection%</span></span> "<span class="hljs-variable"><span class="hljs-variable">%full_db_specification%</span></span>" "<span class="hljs-variable"><span class="hljs-variable">%backup_file%</span></span>" -v -y "<span class="hljs-variable"><span class="hljs-variable">%backup_log%</span></span>" <span class="hljs-variable"><span class="hljs-variable">%gbak%</span></span> -b <span class="hljs-variable"><span class="hljs-variable">%garbage_collection%</span></span> "<span class="hljs-variable"><span class="hljs-variable">%full_db_specification%</span></span>" "<span class="hljs-variable"><span class="hljs-variable">%backup_file%</span></span>" -v &gt;"<span class="hljs-variable"><span class="hljs-variable">%backup_log%</span></span>" <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%ERRORLEVEL%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXIST</span></span> "<span class="hljs-variable"><span class="hljs-variable">%backup_log%</span></span>" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> fail=Backup fail! See <span class="hljs-variable"><span class="hljs-variable">%backup_log%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> fail=Backup fail! ) <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> finish ) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXIST</span></span> "<span class="hljs-variable"><span class="hljs-variable">%backup_log%</span></span>" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> fail=Backup fail! <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> finish ) <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Perform test <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span> ====================================================== <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%restore%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXIST</span></span> "<span class="hljs-variable"><span class="hljs-variable">%restore_log%</span></span>" <span class="hljs-built_in"><span class="hljs-built_in">DEL</span></span> "<span class="hljs-variable"><span class="hljs-variable">%restore_log%</span></span>" /q <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%ISC_PASSWORD_LOCAL%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> ISC_PASSWORD=<span class="hljs-variable"><span class="hljs-variable">%ISC_PASSWORD_LOCAL%</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> ISC_PASSWORD=<span class="hljs-variable"><span class="hljs-variable">%ISC_PASSWORD_REMOTE%</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> restore_start = <span class="hljs-variable"><span class="hljs-variable">%date%</span></span> <span class="hljs-variable"><span class="hljs-variable">%time:~0,8%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> <span class="hljs-variable"><span class="hljs-variable">%gbak%</span></span> -rep -se <span class="hljs-variable"><span class="hljs-variable">%service_mgr_host%</span></span>:service_mgr "<span class="hljs-variable"><span class="hljs-variable">%backup_file%</span></span>" "<span class="hljs-variable"><span class="hljs-variable">%restore_file%</span></span>" -v -y "<span class="hljs-variable"><span class="hljs-variable">%restore_log%</span></span>" <span class="hljs-variable"><span class="hljs-variable">%gbak%</span></span> -rep -se <span class="hljs-variable"><span class="hljs-variable">%service_mgr_host%</span></span>:service_mgr "<span class="hljs-variable"><span class="hljs-variable">%backup_file%</span></span>" "<span class="hljs-variable"><span class="hljs-variable">%restore_file%</span></span>" -v &gt;"<span class="hljs-variable"><span class="hljs-variable">%restore_log%</span></span>" <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%ERRORLEVEL%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXIST</span></span> "<span class="hljs-variable"><span class="hljs-variable">%restore_log%</span></span>" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> fail=Test <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span> fail! See <span class="hljs-variable"><span class="hljs-variable">%restore_log%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> fail=Test <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span> fail! ) <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> finish ) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXIST</span></span> "<span class="hljs-variable"><span class="hljs-variable">%restore_log%</span></span>" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> fail=Test <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span> fail! <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> finish ) ) <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Perform RAR-compression or <span class="hljs-built_in"><span class="hljs-built_in">copy</span></span> backup into destination <span class="hljs-built_in"><span class="hljs-built_in">dir</span></span> =============== <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%rar_password%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> rar_password=-p<span class="hljs-variable"><span class="hljs-variable">%rar_password%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> rar_options=<span class="hljs-variable"><span class="hljs-variable">%rar_options%</span></span> -m<span class="hljs-variable"><span class="hljs-variable">%rar_compress_ratio%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> backup_files="<span class="hljs-variable"><span class="hljs-variable">%backup_file%</span></span>" <span class="hljs-variable"><span class="hljs-variable">%backup_files%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%include_logs_to_archive%</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%restore%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> backup_files=<span class="hljs-variable"><span class="hljs-variable">%backup_files%</span></span> "<span class="hljs-variable"><span class="hljs-variable">%backup_log%</span></span>" "<span class="hljs-variable"><span class="hljs-variable">%restore_log%</span></span>" ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> backup_files=<span class="hljs-variable"><span class="hljs-variable">%backup_files%</span></span> "<span class="hljs-variable"><span class="hljs-variable">%backup_log%</span></span>" ) ) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%rar_compress_ratio%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> compressing_start = <span class="hljs-variable"><span class="hljs-variable">%date%</span></span> <span class="hljs-variable"><span class="hljs-variable">%time:~0,8%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> <span class="hljs-variable"><span class="hljs-variable">%rar%</span></span> <span class="hljs-variable"><span class="hljs-variable">%rar_options%</span></span> "<span class="hljs-variable"><span class="hljs-variable">%compressed_file%</span></span>" <span class="hljs-variable"><span class="hljs-variable">%backup_files%</span></span> <span class="hljs-variable"><span class="hljs-variable">%rar%</span></span> <span class="hljs-variable"><span class="hljs-variable">%rar_options%</span></span> <span class="hljs-variable"><span class="hljs-variable">%rar_password%</span></span> "<span class="hljs-variable"><span class="hljs-variable">%compressed_file%</span></span>" <span class="hljs-variable"><span class="hljs-variable">%backup_files%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%ERRORLEVEL%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> fail=Compression fail! <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> finish ) ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%direct_backup%</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> copying_start = <span class="hljs-variable"><span class="hljs-variable">%date%</span></span> <span class="hljs-variable"><span class="hljs-variable">%time:~0,8%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> <span class="hljs-built_in"><span class="hljs-built_in">COPY</span></span> "<span class="hljs-variable"><span class="hljs-variable">%backup_file%</span></span>" "<span class="hljs-variable"><span class="hljs-variable">%finish_file%</span></span>" <span class="hljs-built_in"><span class="hljs-built_in">COPY</span></span> "<span class="hljs-variable"><span class="hljs-variable">%backup_file%</span></span>" "<span class="hljs-variable"><span class="hljs-variable">%finish_file%</span></span>" ) <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Delete <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> actual files (over <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> space) ============================== <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%backup_space_limit%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">SETLOCAL</span></span> EnableDelayedExpansion <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%ERRORLEVEL%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> You must enable var delayed expansion by <span class="hljs-built_in"><span class="hljs-built_in">CMD</span></span>.EXE /V:ON or <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> registry key <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> Software\Microsoft\Command Processor\DelayedExpansion: HKLM or HKCU <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> finish ) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> /f <span class="hljs-variable"><span class="hljs-variable">%%f</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ('<span class="hljs-built_in"><span class="hljs-built_in">DIR</span></span> "<span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%local_file_or_alias%</span></span>.*.<span class="hljs-variable"><span class="hljs-variable">%backup_ext%</span></span>*" /a:-D /b /o:-N') <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-variable"><span class="hljs-variable">%%i</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ("<span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%%f</span></span>") <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> size=<span class="hljs-variable"><span class="hljs-variable">%%~</span></span>zi <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%file_size_shift%</span></span> == <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> size=<span class="hljs-variable"><span class="hljs-variable">!size:~0,-3!</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">%file_size_shift%</span></span> == <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> size=<span class="hljs-variable"><span class="hljs-variable">!size:~0,-6!</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">!size!</span></span>" == "" <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> size=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">!total_space!</span></span>" == "" ( <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> /a total_space=<span class="hljs-variable"><span class="hljs-variable">!size!</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">!total_space!</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEQ</span></span> <span class="hljs-variable"><span class="hljs-variable">%backup_space_limit%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> /a total_space+=<span class="hljs-variable"><span class="hljs-variable">!size!</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-variable"><span class="hljs-variable">!total_space!</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> <span class="hljs-variable"><span class="hljs-variable">%backup_space_limit%</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> deleting_overquota_file = <span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%%f</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DEL</span></span> "<span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span>\<span class="hljs-variable"><span class="hljs-variable">%%f</span></span>" /q ) ) ) ) ) <span class="hljs-built_in"><span class="hljs-built_in">REM</span></span> ==== Report when fail or <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> ================================================== :finish <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%fail%</span></span>" == "" ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> Finish = <span class="hljs-variable"><span class="hljs-variable">%date%</span></span> <span class="hljs-variable"><span class="hljs-variable">%time:~0,8%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GOTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> #=============================================================================# <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # <span class="hljs-variable"><span class="hljs-variable">%fail%</span></span> <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> #=============================================================================# <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> fail=<span class="hljs-variable"><span class="hljs-variable">%fail%</span></span>, DB: <span class="hljs-variable"><span class="hljs-variable">%full_db_specification%</span></span>, Dest: <span class="hljs-variable"><span class="hljs-variable">%result_dir%</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%net_send_receiver%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NET</span></span> SEND <span class="hljs-variable"><span class="hljs-variable">%net_send_receiver%</span></span> "<span class="hljs-variable"><span class="hljs-variable">%fail%</span></span>" <span class="hljs-built_in"><span class="hljs-built_in">NET</span></span> SEND <span class="hljs-variable"><span class="hljs-variable">%net_send_receiver%</span></span> "<span class="hljs-variable"><span class="hljs-variable">%fail%</span></span>" ) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%blat%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%smtp_server%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%mail_sender%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%mail_login%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%mail_receiver%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> <span class="hljs-variable"><span class="hljs-variable">%blat%</span></span> -to "<span class="hljs-variable"><span class="hljs-variable">%mail_receiver%</span></span>" -subject "<span class="hljs-variable"><span class="hljs-variable">%mail_subject%</span></span>" -body "<span class="hljs-variable"><span class="hljs-variable">%fail%</span></span>" -server <span class="hljs-variable"><span class="hljs-variable">%smtp_server%</span></span> -f "<span class="hljs-variable"><span class="hljs-variable">%mail_sender%</span></span>" -u "<span class="hljs-variable"><span class="hljs-variable">%mail_login%</span></span>" -pw "*******" <span class="hljs-variable"><span class="hljs-variable">%blat%</span></span> -to "<span class="hljs-variable"><span class="hljs-variable">%mail_receiver%</span></span>" -subject "<span class="hljs-variable"><span class="hljs-variable">%mail_subject%</span></span>" -body "<span class="hljs-variable"><span class="hljs-variable">%fail%</span></span>" -server <span class="hljs-variable"><span class="hljs-variable">%smtp_server%</span></span> -f "<span class="hljs-variable"><span class="hljs-variable">%mail_sender%</span></span>" -u "<span class="hljs-variable"><span class="hljs-variable">%mail_login%</span></span>" -pw "<span class="hljs-variable"><span class="hljs-variable">%mail_password%</span></span>" ) <span class="hljs-built_in"><span class="hljs-built_in">SET</span></span> time_ex=%<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>: =<span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> "<span class="hljs-variable"><span class="hljs-variable">%error_log%</span></span>" <span class="hljs-keyword"><span class="hljs-keyword">GTR</span></span> "" ( <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> <span class="hljs-variable"><span class="hljs-variable">%date%</span></span> <span class="hljs-variable"><span class="hljs-variable">%time_ex:~0,8%</span></span> <span class="hljs-variable"><span class="hljs-variable">%fail%</span></span> &gt;&gt; "<span class="hljs-variable"><span class="hljs-variable">%error_log%</span></span>" ) <span class="hljs-keyword"><span class="hljs-keyword">EXIT</span></span> /b <span class="hljs-number"><span class="hljs-number">1</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span></code> </pre> </div></div><br>  I will also give a log generated by running the script in the simplest form: no additional keys, all parameters by default, only the database address and the destination directory are transferred <br><div class="spoiler">  <b class="spoiler_title">fb_backup.bat localhost: p: \ MSO \ DB \ MS_ORDERS.FDB \\ 192.168.1.1 \ disk_a1 \ exchange&gt; fb_backup.log</b> <div class="spoiler_text"><pre> <code class="hljs tex">#=============================================================================# # # # Firebird/InterBase database backup, test restore, zip and rotate script # # Ver 3.2.7 (11.11.2012) # # # # Author: arni (email:arnisoft at rambler dot ru) # # # # Format: # # FB_BACKUP [host[/port]:][path]db_file_or_alias result_dir # # [/count:backup_count] [/space:backup_space_limit] [/gc] # # [/restore] [/compress:level] [/password:SYSDBA_password] # # [other_files_to_compress [...]] # # # # Input params: # # [host[/port]:][path] : local or network, full-specified path or alias # # db_file_or_alias to the source database # # result_dir : result backup collecting directory # # /count:backup_count : backup file number to keep (30 by default) # # /space:backup_space_limit : total backup size in bytes (not use by default) # # you can use suffixes K, M or G. # # /gc : need to collect garbage in DB (OFF by default) # # /restore : need to do test restore (OFF by default) # # /compress:level : compress ratio for RAR (2 by default): # # 0: not compress, 1: fastest, 2: fast, # # 3: normal, 4: good, 5: best # # /password:SYSDBA_password : optional SYSDBA password for remote server # # (by default uses one from the source code) # # other_files_to_compress : list of files that must be add to archive # # # #=============================================================================# full_db_specification = localhost:p:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MSO</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DB</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MS</span></span></span></span>_ORDERS.FDB network_specification = localhost local_db_specification = p:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MSO</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DB</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MS</span></span></span></span>_ORDERS.FDB local_path = p:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MSO</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DB</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>local_db_file_or_alias = MS_ORDERS.FDB result_dir = <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>192.168.1.1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">disk</span></span></span></span>_a1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span></span> backup_count = 30 backup_space_limit = OFF garbage_collection_flag = OFF test_restore_flag = OFF backup_compressing = ON, RAR-ratio=2 backup_file = C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WINDOWS</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TEMP</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MS</span></span></span></span>_ORDERS.FDB.fbk backup_log = <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>192.168.1.1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">disk</span></span></span></span>_a1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MS</span></span></span></span>_ORDERS.FDB.backup.log compressed_file = <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>192.168.1.1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">disk</span></span></span></span>_a1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MS</span></span></span></span>_ORDERS.FDB.121111_1621.fbk.rar backup_start = 11.11.2012 16:21:48 "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Programs</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FB</span></span></span></span>25<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bin</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">gbak</span></span></span></span>.exe" -b -g -se localhost:service_mgr p:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MSO</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DB</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MS</span></span></span></span>_ORDERS.FDB "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WINDOWS</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TEMP</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MS</span></span></span></span>_ORDERS.FDB.fbk" -v -y "<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>192.168.1.1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">disk</span></span></span></span>_a1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MS</span></span></span></span>_ORDERS.FDB.backup.log" compressing_start = 11.11.2012 16:21:51 "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Program</span></span></span></span> Files<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WinRAR</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rar</span></span></span></span>.exe" a -y -ep -idcd -m2 "<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>192.168.1.1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">disk</span></span></span></span>_a1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MS</span></span></span></span>_ORDERS.FDB.121111_1621.fbk.rar" "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WINDOWS</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TEMP</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MS</span></span></span></span>_ORDERS.FDB.fbk" "<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>192.168.1.1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">disk</span></span></span></span>_a1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MS</span></span></span></span>_ORDERS.FDB.backup.log"   <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>192.168.1.1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">disk</span></span></span></span>_a1<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"></span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MS</span></span></span></span>_ORDERS.FDB.121111_1621.fbk.rar  C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WINDOWS</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TEMP</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MS</span></span></span></span>_ORDERS.FDB.fbk 6<span class="hljs-comment"><span class="hljs-comment">% 12% 18% 24% 30% 36% 42% 48% 54% 60% 66% 72% 78% 84% 86% OK  \\192.168.1.1\disk_a1\\MS_ORDERS.FDB.backup.log 92% 98%100% OK Finish = 11.11.2012 16:21:51</span></span></code> </pre> </div></div><br>  Let's analyze the script fragments: <br><div class="spoiler">  <b class="spoiler_title">header part</b> <div class="spoiler_text">  The header contains a link to the authorship, the current version, but the main thing is the description of the call format: which parameters are basic, which are optional, which default values ‚Äã‚Äãare optional parameters. <br>  Optional parameters can be in any order, and they should be preceded by standard characters of the command line key: a forward slash [/] or a dash [-]. <pre> <code class="dos hljs">@<span class="hljs-built_in"><span class="hljs-built_in">CLS</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> OFF <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> #=============================================================================# <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # Firebird/InterBase database backup, test <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span>, zip and rotate script # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # <span class="hljs-built_in"><span class="hljs-built_in">Ver</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">8</span></span> (<span class="hljs-number"><span class="hljs-number">26</span></span>.<span class="hljs-number"><span class="hljs-number">01</span></span>.<span class="hljs-number"><span class="hljs-number">2013</span></span>) # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # Author: arni (email:arnisoft <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> rambler dot ru) # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # <span class="hljs-built_in"><span class="hljs-built_in">Format</span></span>: # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # FB_BACKUP [host[/port]:][<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>]db_file_or_alias result_dir # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # [/count:backup_count] [/space:backup_space_limit] [/gc] # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # [/<span class="hljs-built_in"><span class="hljs-built_in">restore</span></span>] [/compress:level] [/password:SYSDBA_password] # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # [other_files_to_compress [...]] # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # Input params: # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # [host[/port]:][<span class="hljs-built_in"><span class="hljs-built_in">path</span></span>] : local or network, full-specified <span class="hljs-built_in"><span class="hljs-built_in">path</span></span> or alias # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # db_file_or_alias to the source database # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # result_dir : result backup collecting directory # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # /count:backup_count : backup file number to keep (<span class="hljs-number"><span class="hljs-number">30</span></span> by default) # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # /space:backup_space_limit : total backup size <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> bytes (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> use by default) # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # you can use suffixes K, M or G. # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # /gc : need to collect garbage <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> DB (OFF by default) # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # /<span class="hljs-built_in"><span class="hljs-built_in">restore</span></span> : need to <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> test <span class="hljs-built_in"><span class="hljs-built_in">restore</span></span> (OFF by default) # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # /compress:level : compress ratio <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> RAR (<span class="hljs-number"><span class="hljs-number">2</span></span> by default): # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> compress, <span class="hljs-number"><span class="hljs-number">1</span></span>: fastest, <span class="hljs-number"><span class="hljs-number">2</span></span>: fast, # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # <span class="hljs-number"><span class="hljs-number">3</span></span>: normal, <span class="hljs-number"><span class="hljs-number">4</span></span>: good, <span class="hljs-number"><span class="hljs-number">5</span></span>: best # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # /password:SYSDBA_password : optional SYSDBA password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> remote server # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # (by default uses one from the source code) # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # other_files_to_compress : list of files that must be add to archive # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> # # <span class="hljs-built_in"><span class="hljs-built_in">ECHO</span></span> #=============================================================================#</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">defining default parameters</b> <div class="spoiler_text">  here we see 5 blocks responsible for the sections: <br><ul><li>  server settings; </li><li>  b / r parameters; </li><li>  archiver parameters; </li><li>  mailer parameters; </li><li>  other parameters; </li></ul><pre> <code class="dos hljs"><span class="hljs-comment"><span class="hljs-comment">REM ==== Server ==================================================================== SET gbak="C:\Programs\FB25\bin\gbak.exe" SET ISC_USER=SYSDBA SET ISC_PASSWORD_LOCAL=masterkey SET ISC_PASSWORD_REMOTE= REM ==== Backup/restore preferences ================================================ SET temp_backup_dir=%TEMP% SET temp_restore_dir=%TEMP% SET backup_count=30 SET backup_space_limit=0 SET backup_ext=fbk SET garbage_collection=-g SET restore=0 REM ==== RAR ======================================================================= SET rar="C:\Program Files\WinRAR\rar.exe" SET rar_options=a -y -ep -idcd SET rar_password= SET rar_compress_ratio=2 REM ==== Mailer (see "Blat" at http://sourceforge.net/projects/blat) =============== SET blat="C:\Programs\Blat307\blat.exe" SET smtp_server=smtp.mailserver.ru SET mail_sender=foo@mailserver.ru SET mail_login=foo SET mail_password=1234 SET mail_receiver= SET mail_subject=Fail while database b/r REM ==== Other preferences ========================================================= SET include_logs_to_archive=1 SET net_send_receiver= SET error_log=</span></span></code> </pre>  Where: <br><ul><li>  gbak - the path to the utility utility from the server bundle; </li><li>  ISC_USER - the user on whose behalf b / r will occur; </li><li>  ISC_PASSWORD_LOCAL - password of the selected user on the local machine; </li><li>  ISC_PASSWORD_REMOTE - the password of the selected user on the remote machine (it is better to send with the / password parameter: xxxxxxxx); </li><li>  temp_backup_dir - temporary directory where backup will be made before archiving it into the destination directory;  it is better to choose a physical disk that does not coincide with where the source database is located; </li><li>  temp_restore_dir - directory where the test restore will be made;  it is better to choose a physical disk that does not coincide with the location of the original database, and does not coincide with the location of the backup file; </li><li>  backup_ext - default file extension with backup; </li><li>  garbage_collection is the gbak.exe key, which is responsible for the default behavior regarding garbage collection during backup (it is better to control the / gc parameter); </li><li>  restore - default behavior flag regarding the need to perform a test restore (it is better to manage the / restore parameter); </li><li>  rar_options - default RAR archiver keys: ‚Äúa‚Äù - compress;  "-y" - do not ask questions;  "-ep" - exclude paths;  "-idcd" - do not litter the output of copyright and a mark of readiness; </li><li>  rar_password - password for the archive (if not set, the archiver uses the password of the Firebird user); </li><li>  rar_compress_ratio - default compression ratio (it is better to control the / compress: level parameter) </li><li>  blat - path to mailer blat.exe; </li><li>  smtp_server - SMTP server, through which the distribution will be made; </li><li>  mail_sender - the mailing address of the sender; </li><li>  mail_login - the sender's login on the server; </li><li>  mail_password - sender password on the server; </li><li>  mail_receiver - mailing address of the recipient; </li><li>  mail_subject - mailing header; </li><li>  include_logs_to_archive - flag to put b / r logs inside the archive; </li><li>  net_send_receiver is the network name of the host to which NET SEND transport alerts will be sent; </li><li>  error_log - file of the drive log of failures that occurred; </li></ul></div></div><br><div class="spoiler">  <b class="spoiler_title">source definition</b> <div class="spoiler_text">  Here we see: <br><ul><li>  Reading the specification of the source database from the first passed parameter; </li><li>  The separation of the specification into the host name, port, local path and name of the database file or its alias; </li><li>  Printing parts of the specification to the console; </li><li>  Finding out whether this database is local or remote (it will be important later when choosing between a classic backup or backup via services); </li></ul><pre> <code class="dos hljs"><span class="hljs-comment"><span class="hljs-comment">REM ==== Define database location ================================================== SET full_db_specification=%~1 ECHO full_db_specification = %full_db_specification% REM Devide DB spec to network and local parts FOR /f "DELIMS=: TOKENS=1*" %%i IN ("%full_db_specification%") DO ( SET network=%%i SET local=%%j ) REM Test if spec. is alias with no network part IF "%local%" == "" ( SET network= SET local=%full_db_specification% ) REM Test if spec. is full specified file with no network part FOR /f "DELIMS=\ TOKENS=*" %%i IN ("%local%") DO IF "%local%" == "\%%i" ( SET network= SET local=%full_db_specification% ) ECHO network_specification = %network% IF "%network%" GTR "" ( REM Extract port from network spec (if exists) FOR /f "DELIMS=/ TOKENS=1*" %%i IN ("%network%") DO ( SET host=%%i SET port=%%j IF "%%j" GTR "" ( ECHO network_host = %%i ECHO network_port = %%j ) ) ) REM Test if DB is local or remote SET service_mgr_host=localhost SET is_local_db=1 IF "%network%" GTR "" IF "%host%" NEQ "127.0.0.1" IF /i "%host%" NEQ "localhost" SET is_local_db=0 IF %is_local_db% == 1 IF "%network%" GTR "" SET service_mgr_host=%network% ECHO local_db_specification = %local% IF "%local%" == "" ( SET fail=Param #1 {DB specification} missing! GOTO finish ) REM Extract file (or alias) from local part of spec. FOR /f %%i IN ("%local%") DO ( SET local_path=%%~dpi SET local_file_or_alias=%%~nxi ) IF "%local%" NEQ "%local_file_or_alias%" ( ECHO local_path = %local_path% REM Check DB file exists for local, not aliased specification IF %is_local_db% == 1 IF NOT EXIST "%local%" ( SET fail=Local DB file %local% not found! GOTO finish ) ) ECHO local_db_file_or_alias = %local_file_or_alias%</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">definition of the resulting directory (where backups are added)</b> <div class="spoiler_text">  Here we see: <br><ul><li>  Reading the resulting directory from the second parameter passed to the script; </li><li>  If the resulting directory is missing, it is created; </li><li>  Determining the location of the directory: local or remote (network) - will be needed below to select the optimal backup strategy; </li></ul><pre> <code class="dos hljs"><span class="hljs-comment"><span class="hljs-comment">REM ==== Define result directory =================================================== SET result_dir=%~2 ECHO result_dir = %result_dir% IF "%result_dir%" == "" ( SET fail=Param #2 {backup collecting directory} missing! GOTO finish ) REM Cut the result dir if it is in path-style (ends with separator) IF "%result_dir:~-1%" == "\" SET result_dir=%result_dir:~0,-1% REM Try to create the result directory if it is not exists yet IF NOT EXIST "%result_dir%" ( MD "%result_dir%" IF NOT EXIST "%result_dir%" ( SET fail=Cannot create backup collecting directory! GOTO finish ) ) REM Test if it is local or remote directory (elementary, may get wrong answer) SET is_local_result_dir=1 IF "%result_dir:~0,2%" == "\\" SET is_local_result_dir=0</span></span></code> </pre>  This block has an error handling code, in the event of which, the essence of the failure is written to the variable, after which control is transferred to the end of the script - to the feedback block with the admin.  Such handlers are found in all subsequent blocks, and I will not specifically mention them further. </div></div><br><div class="spoiler">  <b class="spoiler_title">read remaining passed parameters</b> <div class="spoiler_text">  Here we see the blocks: <br><ul><li>  reading the next parameter; </li><li>  separation of a key into name and value; </li><li>  recognition of the key, the transition to its processing; </li><li>  setting the number of stored copies; </li><li>  setting the total volume of copies; </li><li>  control of the garbage collection flag in the database; </li><li>  control of test recovery flag; </li><li>  determination of the compression ratio by the archiver; </li><li>  Saving the SYSDBA password for the remote server; </li><li>  reading a list of additional files for archiving; </li></ul><pre> <code class="dos hljs"><span class="hljs-comment"><span class="hljs-comment">REM ==== Use other command line options ============================================ :loop_options SHIFT SET next_param=%~2 IF "%next_param%" == "" GOTO print_options SET prefix=%next_param:~0,1% IF "%prefix%" == "/" SET next_param=%next_param:~1% IF "%prefix%" == "-" SET next_param=%next_param:~1% IF "%next_param%" GTR "" ( FOR /f "DELIMS=: TOKENS=1*" %%i IN ("%next_param%") DO ( SET value=%%j IF /i "%%i" == "count" IF "%%j" GTR "" GOTO count IF /i "%%i" == "space" IF "%%j" GTR "" GOTO space IF /i "%%i" == "gc" GOTO gc IF /i "%%i" == "restore" GOTO restore IF /i "%%i" == "compress" IF "%%j" GTR "" GOTO compress IF /i "%%i" == "password" IF "%%j" GTR "" GOTO password IF EXIST "%next_param%" GOTO add_file_to_compress IF "%prefix%" GTR "/" GOTO add_file_to_compress ECHO unknown param found: %next_param% GOTO loop_options ) ) ELSE ( ECHO empty param found! GOTO loop_options ) REM ==== Define file count in the result dir ======================================= :count SET /a backup_count=0+%value% GOTO loop_options REM ==== Define allowed backup space limit ========================================= :space SET suffix=%value:~-1% IF "%suffix%" GTR "9" ( SET value=%value:~0,-1% IF /i "%suffix%" == "K" ( SET file_size_shift=0 SET /a value*=1000 ) IF /i "%suffix%" == "M" ( SET file_size_shift=3 SET /a value*=1000 ) IF /i "%suffix%" == "G" ( SET file_size_shift=6 SET /a value*=1000 ) ) SET /a backup_space_limit=0+%value% GOTO loop_options REM ==== Define need of garbage collection ========================================= :gc SET garbage_collection= IF "%value%" == "0" SET garbage_collection=-g IF /i "%value%" == "N" SET garbage_collection=-g IF /i "%value%" == "NO" SET garbage_collection=-g IF /i "%value%" == "OFF" SET garbage_collection=-g GOTO loop_options REM ==== Define need of test restore =============================================== :restore SET restore=1 IF "%value%" == "0" SET restore=0 IF /i "%value%" == "N" SET restore=0 IF /i "%value%" == "NO" SET restore=0 IF /i "%value%" == "OFF" SET restore=0 GOTO loop_options REM ==== Define need of backup compression and compress ratio ====================== :compress IF "%value%" GEQ "0" IF "%value%" LEQ "5" SET rar_compress_ratio=%value% GOTO loop_options REM ==== Define SYSDBA password (in addition or for replace source code given) ===== :password if "%ISC_PASSWORD_LOCAL%" GTR "" if "%ISC_PASSWORD_REMOTE%" GTR "" ( SET ISC_PASSWORD_LOCAL=%value% SET ISC_PASSWORD_REMOTE=%value% ) if "%ISC_PASSWORD_LOCAL%" == "" SET ISC_PASSWORD_LOCAL=%value% if "%ISC_PASSWORD_REMOTE%" == "" SET ISC_PASSWORD_REMOTE=%value% GOTO loop_options REM ==== Define file list to compress (in addition to backup and maybe logs) ======= :add_file_to_compress IF "%backup_files%" == "" ( SET backup_files="%next_param%" ) ELSE ( SET backup_files=%backup_files% "%next_param%" ) GOTO loop_options</span></span></code> </pre>  Note: <br><ul><li>  Boolean flags for restaurants or garbage collection take the following values: False = 0, N, NO, OFF;  True = 1, Y, YES, ON. </li><li>  The cumulative amount of stored data is transmitted in bytes.  But since  numbers in the command processor are limited to a 32-bit integer, then it is better to transfer values ‚Äã‚Äãabove 1 GB, indicating the suffix of kilobyte (K), megabyte (M) or gigabyte (G).  For example: / space: 1200K, / space: 280M, / space: 12G.  In this block, you can also observe code that truncates the scale of storage units, allowing you to further operate with volumes, in excess of 32-bit command-processor arithmetic. </li><li>  The transmitted password is interpreted as follows: if the values ‚Äã‚Äãof both the ISC_PASSWORD_LOCAL variable (local) and the ISC_PASSWORD_REMOTE variable (remote) are defined in the source code, the transferred value overrides both of these variables.  In other cases (if at least one variable is not defined), the transferred value is written only to an empty variable, and the filled value retains its predefined value. </li><li>  Additional files for compression (or file masks) are transmitted in their natural form, without the key symbol [/]. </li></ul></div></div><br><div class="spoiler">  <b class="spoiler_title">print run script summary settings</b> <div class="spoiler_text">  Here we see: <br><ul><li>  output the number of stored copies; </li><li>  output cumulative copy storage space; </li><li>  displaying the garbage collection flag; </li><li>  output of the test recovery flag; </li><li>  displaying the archive feature and compression ratio used; </li></ul><pre> <code class="dos hljs"><span class="hljs-comment"><span class="hljs-comment">REM ==== Print predefined or recognized in command line options ==================== :print_options IF %backup_count% GTR 0 ( ECHO backup_count = %backup_count% ) ELSE ( ECHO backup_count = OFF ) IF "%file_size_shift%" == "" SET file_size_shift=0 IF %backup_space_limit% GTR 0 ( IF %file_size_shift% == 6 ( ECHO backup_space_limit = %backup_space_limit% Mb ) ELSE IF %file_size_shift% == 3 ( ECHO backup_space_limit = %backup_space_limit% Kb ) ELSE ECHO backup_space_limit = %backup_space_limit% bytes ) ELSE ( ECHO backup_space_limit = OFF ) IF "%garbage_collection%" == "-g" ( ECHO garbage_collection_flag = OFF ) ELSE ( ECHO garbage_collection_flag = ON ) IF %restore% == 0 ( ECHO test_restore_flag = OFF ) ELSE ( ECHO test_restore_flag = ON ) IF %rar_compress_ratio% == 0 ( ECHO backup_compressing = OFF ) ELSE ( ECHO backup_compressing = ON, RAR-ratio=%rar_compress_ratio% )</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">job definition</b> <div class="spoiler_text">  Here we see: <br><ul><li>  removing the timestamp to use it in the backup file name; </li><li>  determining whether we will backup directly to the destination directory, or first to temporary storage for subsequent recovery, compression, etc .; </li><li>  definition of the full specification of the backup file; </li><li>  definition of the full specification of the backup log; </li><li>  printout of calculated parameters; </li><li>  definition and printing of the file specification for the restaurant and the restaurant log, if the restaurant flag is raised; </li><li>  definition and printing of an archive file, if compression is requested; </li></ul><pre> <code class="dos hljs"><span class="hljs-comment"><span class="hljs-comment">REM ==== Define backup file and backup log ========================================= SET datetime=%date:~-2%%date:~3,2%%date:~0,2%_%time:~0,2%%time:~3,2% SET finish_file=%result_dir%\%local_file_or_alias%.%datetime: =0%.%backup_ext% SET direct_backup=0 IF %rar_compress_ratio% == 0 ( IF %is_local_result_dir% == 1 SET direct_backup=1 IF %restore% == 0 SET direct_backup=1 ) IF %direct_backup% == 1 ( SET backup_file=%finish_file% ) ELSE ( SET backup_file=%temp_backup_dir%\%local_file_or_alias%.%backup_ext% IF NOT EXIST "%temp_backup_dir%" ( MD "%temp_backup_dir%" IF NOT EXIST "%temp_backup_dir%" ( SET fail=Cannot create backup directory! GOTO finish ) ) ) ECHO backup_file = %backup_file% SET backup_log=%result_dir%\%local_file_or_alias%.backup.log ECHO backup_log = %backup_log% REM ==== Define restore file and restore log ======================================= SET restore_file=%temp_restore_dir%\%local_file_or_alias%.testrest IF %restore% GTR 0 ( IF NOT EXIST "%temp_restore_dir%" ( MD "%temp_restore_dir%" IF NOT EXIST "%temp_restore_dir%" ( ECHO temp_restore_dir = %temp_restore_dir% SET fail=Cannot create restore directory! GOTO finish ) ) ECHO restore_file = %restore_file% SET restore_log=%result_dir%\%local_file_or_alias%.restore.log ) IF "%restore_log%" GTR "" ( ECHO restore_log = %restore_log% ) else ( SET restore_log=just_a_stub ) REM ==== Define compresed file ===================================================== SET compressed_file=%finish_file%.rar IF %rar_compress_ratio% GTR 0 ( ECHO compressed_file = %compressed_file% SET finish_file=%compressed_file% )</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">remove unnecessary copies from the destination directory</b> <div class="spoiler_text"><pre> <code class="dos hljs"><span class="hljs-comment"><span class="hljs-comment">REM ==== Delete not actual files (over defined count) ============================== SET /a over=%backup_count%-1 IF %backup_count% == 1 ( ECHO deleting_old_files = %result_dir%\%local_file_or_alias%.*.%backup_ext%* DEL "%result_dir%\%local_file_or_alias%.*.%backup_ext%*" /q ) ELSE IF %backup_count% GTR 1 ( FOR /f "SKIP=%over%" %%f IN ('DIR "%result_dir%\%local_file_or_alias%.*.%backup_ext%*" /a:-D /b /o:-N 2^&gt;NUL') DO ( IF EXIST "%result_dir%\%%f" ( ECHO deleting_old_file = %result_dir%\%%f DEL "%result_dir%\%%f" /q ) ) )</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">run backup</b> <div class="spoiler_text">  Here we see: <br><ul><li>  delete the previous backup log (gbak.exe will return an error if it bumps into the old log); </li><li>  depending on whether the database is recognized as local or remote, a password is selected; </li><li>  depending on the location of the database and the location of the catalog for backup, we determine the ability to use the fastest possible strategy - backup through services, or classic backup otherwise; </li></ul><pre> <code class="dos hljs"><span class="hljs-comment"><span class="hljs-comment">REM ==== Perform backup ============================================================ IF EXIST "%backup_log%" DEL "%backup_log%" /q ECHO backup_start = %date% %time:~0,8% SET is_local_backup=0 IF %is_local_db% == 1 ( IF %is_local_result_dir% == 1 SET is_local_backup=1 IF %direct_backup% == 0 SET is_local_backup=1 SET ISC_PASSWORD=%ISC_PASSWORD_LOCAL% ) ELSE ( SET ISC_PASSWORD=%ISC_PASSWORD_REMOTE% ) IF "%rar_password%" == "" SET rar_password=%ISC_PASSWORD% IF %is_local_backup% == 1 ( ECHO %gbak% -b %garbage_collection% -se %service_mgr_host%:service_mgr %local% "%backup_file%" -v -y "%backup_log%" %gbak% -b %garbage_collection% -se %service_mgr_host%:service_mgr %local% "%backup_file%" -v &gt;"%backup_log%" 2&gt;&amp;1 ) ELSE ( ECHO %gbak% -b %garbage_collection% "%full_db_specification%" "%backup_file%" -v -y "%backup_log%" %gbak% -b %garbage_collection% "%full_db_specification%" "%backup_file%" -v &gt;"%backup_log%" 2&gt;&amp;1 ) IF %ERRORLEVEL% GTR 0 ( IF EXIST "%backup_log%" ( SET fail=Backup fail! See %backup_log% for details. ) ELSE ( SET fail=Backup fail! ) GOTO finish ) IF NOT EXIST "%backup_log%" ( SET fail=Backup fail! GOTO finish )</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">performing test recovery</b> <div class="spoiler_text">  Here we see: <br><ul><li>  delete the previous restaurant log (gbak.exe will return an error if it stumbles upon the old log); </li><li>  performing recovery (always via services, since both the backup file and the test database are local in this branch of the script); </li></ul><pre> <code class="dos hljs"><span class="hljs-comment"><span class="hljs-comment">REM ==== Perform test restore ====================================================== IF %restore% GTR 0 ( IF EXIST "%restore_log%" DEL "%restore_log%" /q IF "%ISC_PASSWORD_LOCAL%" GTR "" ( SET ISC_PASSWORD=%ISC_PASSWORD_LOCAL% ) ELSE ( SET ISC_PASSWORD=%ISC_PASSWORD_REMOTE% ) ECHO restore_start = %date% %time:~0,8% ECHO %gbak% -rep -se %service_mgr_host%:service_mgr "%backup_file%" "%restore_file%" -v -y "%restore_log%" %gbak% -rep -se %service_mgr_host%:service_mgr "%backup_file%" "%restore_file%" -v &gt;"%restore_log%" 2&gt;&amp;1 IF %ERRORLEVEL% GTR 0 ( IF EXIST "%restore_log%" ( SET fail=Test restore fail! See %restore_log% for details. ) ELSE ( SET fail=Test restore fail! ) GOTO finish ) IF NOT EXIST "%restore_log%" ( SET fail=Test restore fail! GOTO finish ) )</span></span></code> </pre>  Note: <br>  If you have InterBase, Yaffil or Firebird earlier than version 2.0, the recovery flag -rep should be replaced with -r </div></div><br><div class="spoiler">  <b class="spoiler_title">archive compression</b> <div class="spoiler_text">  Here we see: <br><ul><li>  collection of all parameters and rar keys, including archive password and compression ratio; </li><li>  collection of all files for compression, including backup, logs (if specified by the policy) and other files (if transferred); </li><li>  if compression is set, we compress; </li><li>  if compression is disabled, then simply copy the backup file to the destination directory (only if the script of the script did not create it initially there); </li></ul><pre> <code class="dos hljs"><span class="hljs-comment"><span class="hljs-comment">REM ==== Perform RAR-compression or copy backup into destination dir =============== IF "%rar_password%" GTR "" SET rar_password=-p%rar_password% SET rar_options=%rar_options% -m%rar_compress_ratio% SET backup_files="%backup_file%" %backup_files% IF %include_logs_to_archive% == 1 ( IF %restore% GTR 0 ( SET backup_files=%backup_files% "%backup_log%" "%restore_log%" ) ELSE ( SET backup_files=%backup_files% "%backup_log%" ) ) IF %rar_compress_ratio% GTR 0 ( ECHO compressing_start = %date% %time:~0,8% ECHO %rar% %rar_options% "%compressed_file%" %backup_files% %rar% %rar_options% %rar_password% "%compressed_file%" %backup_files% IF %ERRORLEVEL% GTR 0 ( SET fail=Compression fail! GOTO finish ) ) ELSE IF %direct_backup% == 0 ( ECHO copying_start = %date% %time:~0,8% ECHO COPY "%backup_file%" "%finish_file%" COPY "%backup_file%" "%finish_file%" )</span></span></code> </pre>  Note: <br>  In a number of discussions, there are examples when, in order to speed up the compression of a backup copy, gbak.exe and rar.exe are launched together, when the output of the first is fed directly to the input of the second.  Unfortunately, this method has a significant drawback that does not allow recommending it for use: if gbak.exe fails, then in the end a zero (successful) return code is returned, because  rar.exe honestly and accurately saved those crumbs that gbak.exe managed to transfer to it before it collapsed.  Those.  you will never know that the backup-making process fails until you try to restore a broken backup, or you do not accidentally pay attention to the size of the final archive. </div></div><br><div class="spoiler">  <b class="spoiler_title">deleting files beyond the specified disk quota</b> <div class="spoiler_text">  Here we see: <br><ul><li>  An attempt to activate the delayed expansion of variables in the command processor (in case of failure, we inform the user and exit the block), which is necessary for calculating the total volume of files; </li><li>  Enumerate accumulated backups from the freshest to the most ancient, and counting their total volume.    ,    .     ,     32-          (   ),         . </li></ul><pre> <code class="dos hljs"><span class="hljs-comment"><span class="hljs-comment">REM ==== Delete not actual files (over defined space) ============================== IF %backup_space_limit% GTR 0 ( SETLOCAL EnableDelayedExpansion IF %ERRORLEVEL% GTR 0 ( ECHO You must enable var delayed expansion by CMD.EXE /V:ON or at registry key ECHO Software\Microsoft\Command Processor\DelayedExpansion: HKLM or HKCU GOTO finish ) FOR /f %%f IN ('DIR "%result_dir%\%local_file_or_alias%.*.%backup_ext%*" /a:-D /b /o:-N') DO ( FOR %%i in ("%result_dir%\%%f") DO ( SET size=%%~zi IF %file_size_shift% == 3 SET size=!size:~0,-3! IF %file_size_shift% == 6 SET size=!size:~0,-6! IF "!size!" == "" SET size=0 IF "!total_space!" == "" ( SET /a total_space=!size! ) ELSE ( IF !total_space! LEQ %backup_space_limit% SET /a total_space+=!size! IF !total_space! GTR %backup_space_limit% ( ECHO deleting_overquota_file = %result_dir%\%%f DEL "%result_dir%\%%f" /q ) ) ) ) )</span></span></code> </pre> </div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">final part</font></font></b> <div class="spoiler_text">   : <br><ul><li>         ,   :  ,  ,  ; </li><li>      NET SEND,      ; </li><li>      (, , , ),       ; </li><li>   - ,       ; </li><li>      ‚Äî      ,      (  ‚Äî  ),    ; </li></ul><pre> <code class="dos hljs"><span class="hljs-comment"><span class="hljs-comment">REM ==== Report when fail or exit ================================================== :finish IF "%fail%" == "" ( ECHO Finish = %date% %time:~0,8% GOTO exit ) ECHO #=============================================================================# ECHO # %fail% ECHO #=============================================================================# SET fail=%fail%, DB: %full_db_specification%, Dest: %result_dir% IF "%net_send_receiver%" GTR "" ( ECHO NET SEND %net_send_receiver% "%fail%" NET SEND %net_send_receiver% "%fail%" ) IF "%blat%" GTR "" IF "%smtp_server%" GTR "" IF "%mail_sender%" GTR "" IF "%mail_login%" GTR "" IF "%mail_receiver%" GTR "" ( ECHO %blat% -to "%mail_receiver%" -subject "%mail_subject%" -body "%fail%" -server %smtp_server% -f "%mail_sender%" -u "%mail_login%" -pw "*******" %blat% -to "%mail_receiver%" -subject "%mail_subject%" -body "%fail%" -server %smtp_server% -f "%mail_sender%" -u "%mail_login%" -pw "%mail_password%" ) SET time_ex=%time: =0% IF "%error_log%" GTR "" ( ECHO %date% %time_ex:~0,8% %fail% &gt;&gt; "%error_log%" ) EXIT /b 1 :exit</span></span></code> </pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let me give a couple of scenarios that describe the use of the script in our daily practice. </font><font style="vertical-align: inherit;">Conditionally call them "night backup" and "day backup." </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At night, no one works with the base, or almost no one. </font><font style="vertical-align: inherit;">Server resources are idle, and therefore it is appropriate to make a full b / r cycle, namely: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- backup with garbage collection; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- test recovery; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- compression of the backup and the current version of the application, and the compression is the best; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here is an example of running a ‚Äúnight backup‚Äù:</font></font><br><pre> <code class="dos hljs">fb_backup.bat localhost:Orma4 d:\Bak /count:<span class="hljs-number"><span class="hljs-number">99</span></span> /space:<span class="hljs-number"><span class="hljs-number">500</span></span>G /compress:<span class="hljs-number"><span class="hljs-number">5</span></span> /<span class="hljs-built_in"><span class="hljs-built_in">restore</span></span> /gc d:\Orma.exe &gt;C:\Orma4.log <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the contrary, the launch of the ‚Äúdaily backup‚Äù should work as quickly as possible, straining the server as little as possible, and hence the users connected to the database. </font><font style="vertical-align: inherit;">Therefore, we exclude garbage collection and test recovery, compress the fastest method, and only the backup file:</font></font><br><pre> <code class="dos hljs">fb_backup.bat localhost:Orma4 d:\Bak /count:<span class="hljs-number"><span class="hljs-number">99</span></span> /space:<span class="hljs-number"><span class="hljs-number">500</span></span>G /compress:<span class="hljs-number"><span class="hljs-number">1</span></span> &gt;C:\Orma4.log <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is another option for recording backup to a remote server (for security reasons, according to the principle ‚Äúdo not store all eggs in one basket‚Äù). </font><font style="vertical-align: inherit;">It combines an intermediate set of keys: you need to press the most tightly, because </font><font style="vertical-align: inherit;">The archiver usually manages to re-grind faster than the network copes with downloading the file, and other operations (garbage collection, test restoration, saving the application program, etc.) should be eliminated if possible, because </font><font style="vertical-align: inherit;">they have already been executed by a ‚Äúnight backup‚Äù to the local server:</font></font><br><pre> <code class="dos hljs">fb_backup.bat localhost:Orma4 \\ifs\E$\backup\FirebirdDB /count:<span class="hljs-number"><span class="hljs-number">99</span></span> /space:<span class="hljs-number"><span class="hljs-number">300</span></span>G /compress:<span class="hljs-number"><span class="hljs-number">5</span></span> &gt;C:\Orma4.log <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> For those who do not know, ending the command means redirecting the output of the script (stdout) to a file, and outputting the error (stderr) to the same file. </font></font><pre> <code class="dos hljs"> &gt;C:\Orma4.log <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A little about the limitations of the script. </font></font><br><ul><li>          Windows,          ,   Linux. ,                 UNIX-.      ,  , ,   .   ,  -       . </li><li>    ,   SYSDBA     ,         .           <a href="http://firebird.svn.sourceforge.net/viewvc/firebird/firebird/trunk/doc/README.trusted_authentication%3Fview%3Dmarkup">Windows Trusted Authentication</a> ,    b/r         ,    . </li><li>      ,   , ..    ,      ,       .           ,           (,      FB2.5.1,      FB2.5.2   2.5.3,    ), ..    b/r     . </li><li> b/r      SYSDBA (  ,       ).        .  ,         (  ),   . </li><li>        ,      . ,   ‚Äî    ,    ¬´¬ª,      ,    ‚Äî    .             :     ,       . </li><li>     ,     (  ,      ).        :   /  ¬´¬ª    1251,           ,       866. .. FAR         ,      .        UTF8. </li><li>         ,   (     ),       ,   , , ,      /    ,  ,    .   ,         . </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/158575/">https://habr.com/ru/post/158575/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../158561/index.html">WPF: Custom Window</a></li>
<li><a href="../158565/index.html">Opportunity - forgotten record</a></li>
<li><a href="../158567/index.html">We sign the installer Developer ID certificate</a></li>
<li><a href="../158569/index.html">Use backbone.js under node.js</a></li>
<li><a href="../158573/index.html">[Translation] Microcontrollers out of date?</a></li>
<li><a href="../158577/index.html">jQuery snippets and plugins for iPad</a></li>
<li><a href="../158579/index.html">Less and less and less ... Micro servers - a solution for macro tasks</a></li>
<li><a href="../158583/index.html">Vuzix Smart Glasses M100, a competitor to Google Glass, will go on sale in early 2013</a></li>
<li><a href="../158585/index.html">7 bub iOS game developer</a></li>
<li><a href="../158587/index.html">Screw Umbraco CMS as a source of content</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>