<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>IPv6 Practice - Home Network</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Abstract: A story about some of the features of IPv6 on the example of the configuration of a complex home IPv6 network. Includes multicast descriptio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>IPv6 Practice - Home Network</h1><div class="post__text post__text-html js-mediator-article">  Abstract: A story about some of the features of IPv6 on the example of the configuration of a complex home IPv6 network.  Includes multicast descriptions, configuration details and debugging of router advertisement, stateless DHCP, etc.  Described for linux system.  In addition to the configuration itself, we will carefully discuss some IPv6 concepts in theoretical terms, as well as some techniques when working with IPv6. <br><br><h1>  Why IPv6? </h1><br>  This is a clear question: why do I wear IPv6 now, when there is almost no benefit from it now? <br><br>  Now you can mess around with IPv6 completely safely, without any negative consequences.  You can peacefully understand the rakes and features, have it idle for months and <em>nobody cares</em> .  In my senior years I do not plan on becoming a blinded conservative kobolist who has written kobol all his life and nothing more, and all the novelties for him are ‚Äúnonsense and nonsense‚Äù.  But my honorable imaginary competitor, when IPv6 becomes a product reality, will either not be my competitor, or painfully and in a state of distress, deal with DAD, RA, temporary dynamic addresses and other strange things to which 30+ RFCs are dedicated.  And that IPv6 will become the main protocol even during my lifetime - this is obvious, since there are no alternatives (even if they were, their implementation is more effort than the completion of IPv6 implementation, that is, any alternative will always lag behind).  And that the addresses do end up in sight, by the way the process of managing them went into the second stage - the stage of the secondary market.  When the free reserves of speculation and hamsters of addresses are finished, the stage of severe consolidation will begin - that is, the removal of everything unimportant from the addresses, the transfer of all ‚Äúto one address‚Äù, etc.  Around this time, IPv6 will begin to be used for real work. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      However, the story is not about the future of IPv6, but about the practice of working with it.  In St. Petersburg, there is such a provider - <a href="http://tiera.ru/">Tier</a> .  And I am their home user.  This is one of the few providers, or perhaps the only one in the city, who provides IPv6 to home users.  The user is allocated one IPv6 address (for a router or a computer), plus a / 64 grid for everything else (that is, four billion times more addresses than all the IPv4 addresses can be - all in one hand).  I will try not only to describe ‚Äúhow to configure IPv6‚Äù, but to understand the basic concepts of the protocol using practical examples with theoretical inserts. <br><br>  Network structure: <br><img src="https://habrastorage.org/getpro/habr/post_images/f5e/296/1ba/f5e2961ba0ac03cab9766cf9827f6e5d.png"><br>  (Original pictures: <a href="https://github.com/amarao/dia_schemes">github.com/amarao/dia_schemes</a> ) <br><ul><li>  1, 2, 3 - devices in the local network, working over WiFi </li><li>  4 - WiFi router, forced to work in the access point (bridge) role, that is, a switch between WiFi and LAN </li><li>  5 - eth3 network interface that distributes the Internet on the local network </li><li>  6 - my home computer (main computer) - <a href="http://desunote.ru/">desunote.ru</a> , which deals with Internet distribution, that is, it works as a router </li><li>  7 - eth2, Tiera network connection interface </li></ul><br><a name="habracut"></a><br>  I‚Äôll skip the whole IPv4 part (nothing interesting - plain nat) and concentrate on IPv6. <br><br>  The settings I received from Tiera for IPv6: <br><ol><li>  Address 2a00: 11d8: 1201: 0: 962b: 18: e716: fb97 / 128 I have been issued for a computer / gateway </li><li>  Network 2a00: 11d8: 1201: 32b0 :: / 64 issued to me for home devices </li></ol><br><br>  At the provider, the network 2a00: 11d8: 1201: 32b0 :: / 64 is routed through 2a00: 11d8: 1201: 0: 962b: 18: e716: fb97 (that is, through my computer).  Note, that's all I got.  No gateways, etc.  - here begins the magic of IPv6, and the most interesting.  "It works by itself." <br><br>  Let's start with a simple one: setting 2a00: 11d8: 1201: 0: 962b: 18: e716: fb97 on eth2 for a computer.  For readability, I‚Äôll leave all configs and file names to the last section. <br><br>  We register the ipv6 address on the interface eth2 ... And a miracle, it starts to work.  Why?  How did the computer know where to send the packages next?  And why / 128 is a valid network for ipv6?  After all, / 128 means a network of 1 ip address and no more.  There can be no gateway! <br><br>  In order to understand what is happening, we need to look at the configuration of the network (I will cut out all unnecessary, so as not to be frightened by the conclusion): <br><br>  # <code>ip address show eth2</code> (usually abbreviate to <code>ip as eth2</code> ) <br><pre> eth2: &lt;BROADCAST, MULTICAST, UP, LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000
     (skip)
     inet6 2a00: 11d8: 1201: 0: 962b: 18: e716: fb97 / 128 scope global 
        valid_lft forever preferred_lft forever
     inet6 fe80 :: 218: e7ff: fe16: fb97 / 64 scope link 
        valid_lft forever preferred_lft forever
</pre><br><br>  Oops.  Why do we have two addresses on the interface?  We prescribed one?  Our address is called 'scope global', but there is also a 'scope link' ... <br><br><h1>  Part One: scope </h1><br>  Here we are met by the first feature of IPv6 - it defines the concept of 'scope' for an address. <br>  There are the following types of scope: <br><ul><li>  <b>global</b> - ‚Äúnormal‚Äù address visible to the entire Internet </li><li>  <b>local</b> or <b>link-local</b> is an address visible only within the network segment.  The closest analogue of this is the configless IPv4 from the range of 169.254.0.0/16, on which any windows fall down, which is told to get the address automatically, and there is no DHCP server around.  These addresses can not be routed (that is, the traffic from them is not passed on to their network).  Learn more about <a href="https://en.wikipedia.org/wiki/Link-local_address">link-local address</a> (wiki). </li><li>  <b>host</b> , he <b>interface</b> - visibility within the host.  Approximate analog - loopback addresses for IPv4 (127.0.0.0/8) </li><li>  <b>admin-local</b> - I have not seen it live, but some kind of intermediary stage </li><li>  <b>site-local</b> - visibility within the office.  Analogue of gray 192.168.0.0/16, that is, addresses that should not go beyond the local network </li><li>  <b>organization-local</b> - addresses that do not go beyond the organization. </li></ul><br><br>  In the process of designing IPv6, the issue of 'scope' was much and thoroughly discussed, because the original IPv4 division, even with subsequent additions, clearly did not meet the needs of real configurations.  For example, if you combine two organizations, each of which uses a network of 10.0.0.0/8, then you will find a lot of "pleasant" surprises.  In IPv6, it was decided from the outset to make a lot of gradations of visibility, which would allow more comfortable to carry out further manipulations. <br><br>  From all this in practice, I have seen using only host / interface, link / local and global.  In the light of / 64 and let no one leave offended, only paranoid will mess around with site-local addresses. <br><br>  The second important feature of IPv6 is the official (at all levels of specifications) recognition that an interface can have multiple IP addresses.  This question in IPv4 was extremely confusing and often led to terrible consequences (for example, a request was received on one interface, and answered to it through another, but with the address of the first interface). <br><br>  Since, unlike IPv4, IPv6 can have several addresses on an integrate, the computer does not need to choose ‚Äúwhich address to take‚Äù.  He can take multiple addresses.  In the case of IPv4, the linking to the link-local address occurred in the ‚Äúlast hope‚Äù mode, that is, by a long timeout. <br><br>  And in IPv6 we can easily and simply from the very first moment, when the interface has risen, make it link local (and already after that think about what kind of global addresses there are). <br><br>  Moreover, IPv6 has a special technology for automatically generating a link-local address, which guarantees the absence of duplicates.  It uses the MAC address of the computer to generate the second (lower) half of the address.  Since MAC addresses are unique at least within a segment (otherwise L2 is broken and everything else does not automatically work), using a MAC address gives us a 100% certainty that our IPv6 address is unique. <br><br>  In our case, this is <code>inet6 fe80::218:e7ff:fe16:fb97/64 scope link</code> .  Pay attention to the prefix - fe80 - this is the link-local address. <br><br>  How is it done? <br><br>  The principle is quite simple: <br><br>  The eth2 MAC address is 00: 18: e7: 16: fb: 97, and the local ipv6 address is F80: <b>00</b> 02 <b>18: e7</b> ff: fe <b>16: fb97</b> .  Yes, exactly as bold.  Why was it in the middle of ff: fe - I do not know.  The algorithm itself is called <a href="https://en.wikipedia.org/wiki/IPv6_address">modified EUI-64</a> .  This algorithm itself is very motivated and full of details.  From the position of the system administrator - do not care.  The address is and is.  An inverse algorithm can probably be interesting - learn MAC from the link-local and no more. <br><br>  So, we have two addresses on the interface.  We even know how both of them appeared (one automatically when lifting the interface, the second we registered).  We even know how the system realized that the address is global - it is from the ‚Äúglobal‚Äù range. <br><br>  But how did the system find out who its default gateway is?  And how can he even live / 128? <br><br><h1>  Part two, intermediate: multicast multicast multicast multicast </h1><br>  Let's look at the routing table: <br><br>  <code>ip -6 route show</code> (usually abbreviate to <code>ip -6 rs</code> , or even <code>ip -6 r</code> ): <br><pre> 2a00: 11d8: 1201: 0: 962b: 18: e716: fb97 dev eth2 proto kernel metric 256 
 fe80 :: / 64 dev eth2 proto kernel metric 256 
 default via fe80 :: 768e: f8ff: fe93: 21f0 dev eth2 proto ra metric 1024 expires 1779sec
</pre><br><br>  What do we see here?  The first is telling us that our IPv6 address is the address of our eth2 interface.  The second says that we have a link-local segment in eth2.  For both, the source is kernel. <br><br>  But the third is intrigue.  This is the default gateway, which says that all traffic should be sent to fe80 :: 768e: f8ff: fe93: 21f0 on the eth2 interface, and the source of information about it is a certain ‚Äúra‚Äù, and it is also said that it goes rotten in 1779 seconds. <br><br>  What?  Where?  Where?  Who!  For what?  Why?  What for?  Who is guilty? <br><br>  But before answering these questions we will have to get acquainted with another important thing - multicast.  In IPv4, muticast was a sort of ‚Äúout of this world‚Äù technology.  Yes, but rarely used in strictly limited cases.  In IPv6, this technology is the central part of everything.  IPv6 will not work without multicast.  And without understanding this, many things in IPv6 will seem strange or break in unexpected places. <br><br>  Briefly about the types of traffic, maybe someone missed this information when he studied IPv4: <br><br><ul><li>  unicast - the packet is addressed to a specific recipient.  Normal traffic is unicast. </li><li>  broadcast - the package is addressed to everyone who hears it.  For example, in IPv4, a request for a mac-address is sent to this IP address. </li><li>  multicast - the packet is addressed to a set of nodes that listen to a special multicast address.  And if they receive a message, they react to it. </li><li>  anycast - the packet is addressed to the address common to the heap of nodes.  Who is closer to the requester (and is ready to answer) - he answers </li></ul><br><br>  So, in IPv6 <b>NO BROADKASTOV</b> .  At all.  Instead, there is a multicast.  And some of the multicast addresses are key for IPv6 operation. <br><br>  Here are examples of such addresses (they are all link-local, that is, they make sense only in the context of a specific interface): <br><ul><li>  FF02 :: 1 - all network nodes.  Consider the old channel level Broadcast. </li><li>  FF02 :: 2 - all network routers </li></ul><br>  A complete list of addresses, along with the nuances of link-local, site-local, etc, can be found here: <a href="http://www.iana.org/assignments/ipv6-multicast-addresses/ipv6-multicast-addresses.xhtml">www.iana.org/assignments/ipv6-multicast-addresses/ipv6-multicast-addresses.xhtml</a> <br><br>  In practical terms, this means that we can send Broadcast ping to all nodes, or to all routers.  True, we will have to specify the name of the interface in relation to which we are interested in neighbors. <br><br> <code>ping6 -I eth2 FF02::2</code> <br> <pre> 64 bytes from fe80 :: 218: e7ff: fe16: fb97: icmp_seq = 1 ttl = 64 time = 0.039 ms
 64 bytes from fe80 :: 768e: f8ff: fe93: 21f0: icmp_seq = 1 ttl = 64 time = 0.239 ms (DUP!)
 64 bytes from fe80 :: 211: 2fff: fe23: 5763: icmp_seq = 1 ttl = 64 time = 1.38 ms (DUP!)
 64 bytes from fe80 :: 5a6d: 8fff: fef5: 6235: icmp_seq = 1 ttl = 64 time = 5.68 ms (DUP!)
 64 bytes from fe80 :: cad7: 19ff: fed5: 25b8: icmp_seq = 1 ttl = 64 time = 7.20 ms (DUP!)
 64 bytes from fe80 :: 22aa: 4bff: fe1e: 9e88: icmp_seq = 1 ttl = 64 time = 8.19 ms (DUP!)
 64 bytes from fe80 :: 5a6d: 8fff: fe4a: c643: icmp_seq = 1 ttl = 64 time = 8.69 ms (DUP!)
 64 bytes from fe80 :: 205: 9aff: fe3c: 7800: icmp_seq = 1 ttl = 64 time = 11.1 ms (DUP!)
 64 bytes from fe80 :: 20c: 42ff: fef9: 807a: icmp_seq = 1 ttl = 64 time = 16.0 ms (DUP!)
</pre><br><br>  How many routers are around me ... My computer was the first to respond.  This is because he is also a router.  But the question of routing, we will look at later.  So far it is important that we see all routers and only routers (and, for example, <code>ping6 -I eth2 FF002::1</code> shows about 60 neighbors). <br><br>  There are a lot of multicast groups (the group refers to all nodes that listen to this multicast address).  Among them is a special group FF02 :: 6A called "All-Snoopers".  It is to this group that routing advertisements are sent.  When we want to receive them - we enter the appropriate group.  More precisely not we, and our computer. <br><br><h1>  Part Three: Routing Advertisements </h1><br>  In IPv6, they came up with such a wonderful thing - when the router sends out information to all those who wish that it is a router.  It sends out periodically. <br><br>  Regarding this issue, there is a whole (only one, which is surprising) RFC: <a href="http://tools.ietf.org/html/rfc4286">tools.ietf.org/html/rfc4286</a> , but we are interested in all this simple thing: the router sends information that it is a router.  And maybe a little more information about what is happening on the network. <br><br>  This is where our computer learned the route.  A certain router told him "I am a router".  And we believed him.  Why we chose it among all the surrounding roush devices (see the answer to pinging on FF02 :: 2 above), we will discuss a little further.  For now, let's say that this ‚Äúreal‚Äù router announced itself correctly. <br><br>  Thus, the following thing happens: <br><br>  We have the address 2a00: 11d8: 1201: 0: 962b: 18: e716: fb97 / 128, and there is also a link-local.  We hear the multicast from the router, believe it, and add the address we need as default to the routing table.  From this moment we know for sure that the address is in the network.  Thus, sending traffic to the Internet is no longer a problem.  We generate a packet with src = 2a00: 11d8: 1201: 0: 962b: 18: e716: fb97 and send it to the default gateway, which in our case is fe80 :: 768e: f8ff: fe93: 21f0.  In other words, we send traffic not to our ‚Äúgateway‚Äù on the network, but to a completely different node along a completely different route.  It is quite a normal thing for both IPv6 and IPv4, although for IPv4 it is a kind of super cool configuration, and for IPv6 it is part of everyday life. <br><br>  But how does traffic come back?  Very simple.  When a provider router receives a packet addressed to 2a00: 11d8: 1201: 0: 962b: 18: e716: fb97, then it says on one of the interfaces that it is there 2a00: 11d8: 1201 :: / 64 via (I don‚Äôt know what is the name of the interface there, but let) GE1 / 44/12.  The router asks all neighbors (neighbor discovery) about their addresses, and suddenly sees that the address is such and such on the network.  What could be simpler - the poppy is, the address is, send to the interface.  Hooray, our computer sees traffic.  Two-way communication is established. <br><br>  A diligent reader may ask a few questions: what does it mean ‚Äúwritten on the interface‚Äù?  And what does ‚Äúneighbor discovery‚Äù mean? <br><br>  The questions are fair.  First, let's try to figure out which nodes we have on the network from the 2a00 subnet: 11d8: 1201 :: / 64 <br><br>  In order to see the router advertisement on the interface, the radvdump program from the radvd package will be added to us.  It allows you to print announcements, passing on the interfaces, in human form.  Note that the radvd package itself is still useful to us (since its daemon - radvd allows you to set up an announcement with its interfaces). <br><br>  So, let's see what Tiera ankosiruet us: <br><br>  <code>radvdump eth2</code> (and wait decently, for announcements are not sent very often) <br><pre> #
 # radvd configuration generated by radvdump 1.9.1
 # based on Router Advertisement from fe80 :: 768e: f8ff: fe93: 21f0
 # received by interface eth2
 #
 interface eth2
 {
	 AdvSendAdvert on;
	 # Note: {Min, Max} RtrAdvInterval cannot be obtained with radvdump
	 AdvManagedFlag on;
	 AdvOtherConfigFlag on;
	 AdvReachableTime 0;
	 AdvRetransTimer 0;
	 AdvCurHopLimit 64;
	 AdvDefaultLifetime 1800;
	 AdvHomeAgentFlag off;
	 AdvDefaultPreference medium;
	 AdvSourceLLAddress on;
	 AdvLinkMTU 9216;<font></font>
<font></font>
	 prefix 2a00: 11d8: 1201 :: / 64
	 {
		 AdvValidLifetime 2592000;
		 AdvPreferredLifetime 604800;
		 AdvOnLink on;
		 AdvAutonomous on;
		 AdvRouterAddr off;
	 };  # End of prefix definition<font></font>
<font></font>
 };  # End of interface definition
</pre><br><br>  Of all this, the important thing is: <br><ul><li>  The address from which the announcement was received (in our case fe80 :: 768e: f8ff: fe93: 21f0) is the gateway address. </li><li>  A reference to a network segment in which you can autoconfigure addresses for yourself. </li><li>  Flag AdvAutonomous on, indicating that this announcement makes sense.  If the flag were off, then it could be safely ignored. </li></ul><br><br>  Thus, everything is simple - we specified the address, the router sent us ‚Äúitself‚Äù, the kernel updated the route.  Voila, we have IPv6 on the computer earned. <br><br><h1>  White IPv6 address for everyone on the home network </h1><br>  Get an IPv6 address for the computer - this is not enough.  It would be desirable so that each mobile device sat not behind shameful NAT, but a bare ass with a white address on the Internet.  It is also desirable so that the evil NSA / google could not by the tail of my address (in which the MAC is coded) track my movements between different IPv6 networks (although under the conditions set by the play services this paranoia looks naive and defenseless). <br><br>  But, in any case, our task is to distribute the Internet further. <br><br>  Tiera, giving me ipv6, set up a route: <code>2a00:11d8:1201:32b0::/64 via 2a00:11d8:1201:0:962b:18:e716:fb97</code> . <br><br>  Since fb97 is already the address of my computer, setting up routing is a fun thing: <br><br><pre> sysctl net.ipv6.conf.all.forwarding = 1
</pre><br><br>  ... and we have a half-hour completely IPv6 falls off on the computer?  Why?  Who is guilty? <br><br>  It turns out that Linux does not listen to routing advertisement if it is itself a router.  That, in general, is correct, because if two routers declare themselves routers and listen to each other's routes, then we quickly get the simplest loop of two iron doodles looped around each other. <br><br>  However, in our case, we still want to listen to RA.  To do this, we need to enable RA by force. <br><br>  This is done like this: <br><pre> sysctl net.ipv6.conf.eth2.accept_ra = 2
</pre><br><br>  Note, it is important that we listen to RA not everywhere, but only on one interface, from which we expect announcements. <br><br>  Now the routing works, the route is obtained automatically, and you can manually register an IPv6 address on each mobile device and manually specify an IPv6 gateway, and manually register an IPv6 DNS, and manually ... er ... too much manually. <br><br>  If they gave me the settings automatically, then I also want to distribute them further automatically.  Fortunately, dhcpd copes with a similar task for IPv4. <br><br>  The beauty of IPv6 is that we can solve this problem (distribution of network settings) without any special services in the so-called stateless mode.  The main feature of the stateless regime is that no one should strain and save something, remember, etc.  Problems with DHCP in IPv4 were most often caused by the fact that the same address was issued to two different devices.  And this was due to the fact that the evil admin was erasing / forgetting the database of already issued leases.  And also, if there is a lot of pieces of iron and they forget to ‚Äúgive rent‚Äù, then the addresses end.  In other words, stateful are additional requirements and problems. <br><br>  To solve the trivial problem "distribute addresses" in IPv6, a stateless mode was invented, which is based on routing advertisement.  We have already seen the client part, now it remains to implement the server part in order to feed the IPv6 tablet. <br><br><h1>  Configure routing announcements (radvd) </h1><br>  To set up announcements, a special daemon program is used - radvd.  We got acquainted with the utility from its kit (radvdump) just above.  The beauty of the utility is that it displays not just the received data, but the ready-made radvd config for sending similar announcements. <br><br>  So, configure the radvd: <br><pre> interface eth3
 {
    AdvSendAdvert on;
    AdvHomeAgentFlag off;
    MinRtrAdvInterval 30;
    MaxRtrAdvInterval 100;
    prefix 2a00: 11d8: 1201: 32b0 :: / 64
    {
       AdvOnLink on;
           AdvAutonomous on;
           AdvRouterAddr on;
    };
 };
</pre><br>  The main thing here is the prefix and an indication of AdvAutonomous. <br><br>  We start the demon, we take the nearest laptop (usual household ubunta with usual household network-manager'om), rrrraz, and we get ... <br><pre> ip a show wlan0
 3: wlan0: &lt;BROADCAST, MULTICAST, UP, LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000
     link / ether 10: 0b: a9: bd: 26: a8 brd ff: ff: ff: ff: ff: ff
     inet 10.13.77.167/24 brd 10.13.77.255 scope global wlan0
        valid_lft forever preferred_lft forever
     inet6 2a00: 11d8: 1201: 32b0: 69b9: 8925: 13d9: a879 / 64 scope global temporary dynamic 
        valid_lft 86339sec preferred_lft 14339sec
     inet6 2a00: 11d8: 1201: 32b0: 120b: a9ff: febd: 26a8 / 64 scope global dynamic 
        valid_lft 86339sec preferred_lft 14339sec
     inet6 fe80 :: 120b: a9ff: febd: 26a8 / 64 scope link 
        valid_lft forever preferred_lft forever
</pre><br>  From where we have <em>so much</em> ipv6, we‚Äôll talk in the next section, but for now we‚Äôll note that the addresses have been configured automatically.  And the routes we have are: <br><br><pre> ip -6 r
 2a00: 11d8: 1201: 32b0 :: / 64 dev wlan0 proto kernel metric 256 expires 86215sec
 fe80 :: / 64 dev wlan0 proto kernel metric 256 
 default via fe80 :: 5ed9: 98ff: fef5: 68bf dev wlan0 proto ra metric 1024 expires 115sec
</pre><br>  I hope the reader already fully understands what is happening.  However ... Something is missing.  We do not have a dns-resolver.  More precisely, there is, but issued dhcpd for IPv4.  And we have a five-minute love for IPv6, so the resolver also needs IPv6. <br><br>  <s>Difficult uncovering aptitude, we put dhcpv6 and set the nameserver options.</s> Not so! <br><br>  Fortunately, IPv6 has been thought over and improved for a very long time.  So we can solve the problem without a DHCP server.  To do this, we need to add another indication to the addresses of the DNS servers to the route announcement. <br><br><h1>  RDNSS in RA </h1><br>  This whole wisdom is described in <a href="http://tools.ietf.org/html/rfc6106">RFC 6106</a> .  In fact - we have the opportunity to specify the address of the recursive DNS server (that is, the "normal resolver") in the announcement distributed by the router. <br><br>  By and large this is all we want from DHCP, so DHCP is not needed there.  Computers themselves make addresses to themselves in a consistent way (that is, to avoid collisions), they know the addresses of DNS servers.  Internet can use. <br><br>  To do this, we add the appropriate option to the radvd config: <br><br><pre>    RDNSS 2001: 4860: 4860 :: 8888 2001: 4860: 4860 :: 8844
    {
    };
</pre><br>  (full config - see the end of the article). <br><br>  We try to connect again - and, hurray, everything works. <br><br><pre> ping6 google.com
 PING google.com (lb-in-x66.1e100.net) 56 data bytes
 64 bytes from lb-in-x66.1e100.net: icmp_seq = 1 ttl = 54 time = 25.3 ms
 ^ C
 --- google.com ping statistics ---
 1 packets transmitted, 1 received, 0% packet loss, time 0ms
 rtt min / avg / max / mdev = 25.312 / 25.312 / 25.312 / 0.000 ms
</pre><br><br>  google.com was not chosen by chance.  Google services (youtube to no small degree) are almost the main source of IPv6 traffic at the moment.  The second source is torrents, where you can see as many as 5-10% of peers in the IPv6 version. <br><br>  This story could have been completed if it were not for another important detail - what is the third IPv6 address on the laptop interface?  And what is this temporary dynamic? <br><br><h1>  Privacy extension </h1><br>  As I mentioned above, automatic configuration of an IPv6 address based on the MAC address of a network adapter is good for everyone, except for creating an almost perfect tool for tracking users on the network.  You can take any browsers and operating systems, use any providers (using IPv6, so this is all written for the future) - but you will have the same MAC address, and any Google, NSA or just a spammer will be able to track you by the lower bits of your IPv6 address.  The older ones will change depending on the provider, and the younger ones will remain as is. <br><br>          IPv6,  privacy extensions ( <a href="http://tools.ietf.org/html/rfc4941">RFC 4941</a> ).   RFC,   ‚Äî    ,             md5    . <br><br>  How it works? <br><br> ,        ,    IPv6    .       , ,       (,   ,  md5      ‚Äî  ,       ,   md5         ), , , ,      .      DAD ( ).   ,       ,         .              . <br><br>             IPv6- (      ?.. <em></em> ).   ,          , -     ‚Äî  ,    . <br><br><h1> Duplicate Address Detection </h1><br>     IPv6 ‚Äî  DAD.   IPv4   ¬´  ,  ,   ,  -   ¬ª  ¬´         ¬ª. <br><br>            ,    .  ,     IPv4   dmesg, Windows ‚Äî  syslog‚Ä¶ Event‚Ä¶ , .       -   , , -. ,      ,    ,        ARP     (  :          ,   ,    , ,  ,     ). <br><br>  DHCP- (, ),     ¬´ ¬ª   . <br><br>         ¬´   ,    ¬ª. <br><br>  IPv6     .   IPv6     RFC  (   ,    premium grade enterprise ready cost saving proprietary solution  - ).    Optimistic DAD ( <a href="http://tools.ietf.org/html/rfc4429">RFC 4429</a> ),      :   ,   .   IPv6 . <br><br>  DAD  ,      ,    - .  ()      <code>ip -6 address add</code> ,  ip  ,   DAD.             ,       ¬´  ¬ª ‚Äî          ,    ,    . <br><br><h1>  </h1><br>      , ,    ‚Äî  ,   . <br><br> /etc/network/interfaces: <br><br><pre>auto lo eth2 eth3
 iface lo inet loopback<font></font>
<font></font>
allow-hotplug eth2 eth3<font></font>
<font></font>
iface eth2 inet static<font></font>
	address 95.161.2.76<font></font>
	 netmask 255.255.255.0<font></font>
	gateway 95.161.2.1<font></font>
	dns-nameservers 127.0.0.1 #      bind'<font></font>
<font></font>
iface eth2 inet6 static<font></font>
	address 2a00:11d8:1201:0:962b:18:e716:fb97/128<font></font>
	dns-nameservers ::1<font></font>
<font></font>
iface eth3 inet static<font></font>
	address 10.13.77.1<font></font>
	 netmask 255.255.255.0<font></font>
<font></font>
iface eth3 inet6 static<font></font>
	address 2a00:11d8:1201:32b0::1/64<font></font>
</pre><br> /etc/sysctl.d/ra2.conf <br><pre>net.ipv6.conf.eth2.accept_ra=2
</pre><br> /etc/sysctl.d/ip_forwarding.conf <br><pre>net.ipv4.conf.all.forwarding = 1<font></font>
net.ipv6.conf.all.forwarding = 1<font></font>
</pre><br> /etc/radvd.conf <br><pre>interface eth3
 {<font></font>
   AdvSendAdvert on;<font></font>
   AdvHomeAgentFlag off;<font></font>
   MinRtrAdvInterval 30;<font></font>
   MaxRtrAdvInterval 100;<font></font>
   prefix 2a00:11d8:1201:32b0::/64<font></font>
    {<font></font>
	  AdvOnLink on;<font></font>
          AdvAutonomous on;<font></font>
          AdvRouterAddr on;<font></font>
    };<font></font>
   RDNSS 2001:4860:4860::8888 2001:4860:4860::8844<font></font>
    {
    };
 };
</pre><br> /etc/dhcp/dhcpd.conf <br><pre>ddns-update-style none;<font></font>
<font></font>
option domain-name "example.org";<font></font>
option domain-name-servers ns1.example.org, ns2.example.org;<font></font>
<font></font>
default-lease-time 600;<font></font>
max-lease-time 7200;<font></font>
<font></font>
log-facility local7;<font></font>
<font></font>
subnet 10.13.77.0 netmask 255.255.255.0 {<font></font>
	range 10.13.77.160 10.13.77.199;<font></font>
	option routers 10.13.77.1;<font></font>
	option domain-name-servers 10.13.77.1;<font></font>
 }
</pre><br><h1>   IPv6? </h1><br>     . - raid, LVM XFS, BTRFS, LUCKS,    -, dns-  ..        IPv6. <br><br>       .    : <br><pre>iptables -t filter -A INPUT<font></font>
ip6tables -t filter -A INPUT<font></font>
(  - iptables -L -v,  ip6tables -L -v)<font></font>
</pre><br><br>     : <br><img src="https://habrastorage.org/getpro/habr/post_images/498/291/49e/49829149e32062f522c9da0490f5b97d.png"><br><ul><li> 4.5% (2.7 ) IPv6 </li><li> 95.5% (59 ) ‚Äî  , ,  IP </li></ul><br>  , IPv6        (      ,   ?). <br><br>  ,     IPv6 (   ‚Äî     )        .    IPv6  ,      ‚Äî     teredo (   IPv6,   ). <br><br>   ,           (  ),   IPv6 -    . <br><br><h1>     </h1><br>  , , IPv6   . <br>  (4+)    .       ,      IPv6 (   IPv4)  deep sleep . <br>   , IOS' IPv6   . </div><p>Source: <a href="https://habr.com/ru/post/192164/">https://habr.com/ru/post/192164/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../192146/index.html">Copy works in the public domain? National Indian hut to help you</a></li>
<li><a href="../192150/index.html">Installation Guide and Guide for Web Deploy in Windows Server 2008 R2</a></li>
<li><a href="../192152/index.html">The digest of news from the world of mobile development for the last week ‚Ññ22 (August 26 - September 1, 2013)</a></li>
<li><a href="../192160/index.html">NNM-Club is under the threat of blocking and preparing for it, and the Rutor and Opensharing are illegally detained in the Registry</a></li>
<li><a href="../192162/index.html">Record-breakers. Continuation</a></li>
<li><a href="../192166/index.html">On Friday, September 6, NASA launches the LADEE probe to the moon to study the rarefied atmosphere and study dust particles.</a></li>
<li><a href="../192168/index.html">Enclosed ecosystem in Russian</a></li>
<li><a href="../192170/index.html">Nokia Lumia 1020: Visual Advantage in Jing Zhang's Vision</a></li>
<li><a href="../192172/index.html">In an attempt to look beyond your university, or another reflection on the educational process</a></li>
<li><a href="../192174/index.html">ThL W11 Monkey King - Monkey King</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>