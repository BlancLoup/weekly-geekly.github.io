<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Million lines per second from Postgres using Python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="asyncpg is a new Python open-source library for working with PostgreSQL. It was written using asyncio and Python 3.5. asyncpg is the fastest PostgreSQ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Million lines per second from Postgres using Python</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/f51/662/b01/f51662b01a4313510d947a29294f5147.jpg" alt="image"><br><br>  <a href="https://github.com/magicstack/asyncpg">asyncpg</a> is a new Python open-source library for working with PostgreSQL.  It was written using asyncio and Python 3.5.  asyncpg is the fastest PostgreSQL driver among similar implementations in Python, NodeJS and Go. <br><br><h3>  Why asyncpg? </h3><br>  We are creating <a href="https://edgedb.com/">EdgeDB</a> - a new generation database, with PostgreSQL on the backend.  We need high performance, low access latency and additional features of PostgreSQL itself. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The most obvious option is to use psycopg2 - the most popular Python driver for working with PostgreSQL.  He has a great community, he is stable and time-tested.  There is also aiopg, which implements an asynchronous interface, on top of psycopg2.  Then the question is obvious - why write your bike?  The short answer is PostgreSQL performance and support.  Below we will look at this in more detail. <br><a name="habracut"></a><br><h3>  Special features </h3><br><h4>  Data Type Support </h4><br>  Our main discontent with psycopg2 was mediocre processing of various types of data, incl.  arrays and compound types.  Many different data types are one of the distinguishing features of PostgreSQL.  And yet, out of the box psycopg2 only supports simple data types - integers, strings, time and dates.  It makes writing your types for something else. <br><br>  The main reason for this lies in the fact that psycopg2 communicates with the database server data in text format, which is why a lot of data have to be parsed, this is especially true for composite data types. <br><br>  Unlike psycopg2, asyncpg uses PostgreSQL binary I / O protocol, which, in addition to performance advantages, also has native support for container data types (arrays, range and composite types). <br><br><h4>  Prepare requests </h4><br>  Asyncpg also uses prepared PostgreSQL statements.  This is a great opportunity for optimization, as it allows you to avoid re-parsing, analyzing and building a query plan.  In addition, asyncpg caches I / O data for each prepared operator. <br><br>  Prepared statements in asyncpg can be created and used directly.  They provide an API for retrieving and analyzing query results.  Most query methods create a connection directly, and asyncpg creates and caches prepared queries. <br><br><h4>  Ease of deployment </h4><br>  Another important feature of asyncpg is the absence of dependencies.  Directly implementing the PostgreSQL protocol means that you do not need to install libpq.  Just run <code>pip install asyncpg</code> .  In addition, we also provide a package for manual build on Linux and macOS (Windows is planned for the future). <br><br><h3>  Performance </h3><br>  It soon became clear to us that by implementing the PostgreSQL protocol directly, we can achieve a significant increase in speed.  Our <a href="https://magic.io/blog/uvloop-blazing-fast-python-networking/">past experience</a> with uvloop has shown that you can create efficient and productive libraries with Cython.  asyncpg is completely written in Cython with memory management and high optimization.  As a result, asyncpg was on average 3 times faster than psycopg2 (or aiopg). <br><br><h3>  Testing </h3><br>  As for <a href="https://github.com/magicstack/uvloop">uvloop</a> , we have created a separate utility for testing <a href="https://github.com/magicstack/pgbench">pgbench</a> and creating reports for asyncpg and other implementations of the PostgreSQL driver.  We measured the speed of the query (lines per second) and the delay.  The main purpose of these tests is to find out the overhead for this driver. <br><br>  To be honest, all the tests were run in one thread (GOMAXPROCS = 1 in the case of Golang) in asynchronous mode.  Python drivers were run using uvloop. <br><br>  This test took place on a clean server with this configuration: <br><br><ul><li>  CPU: Intel Xeon E5-1620 v2 @ 3.70GHz, 64GiB DDR3 </li><li>  Gentoo Linux, GCC 4.9.3 </li><li>  Go 1.6.3, Python 3.5.2, NodeJS 6.3.0 </li><li>  PostgreSQL 9.5.2 </li></ul><br>  Used drivers: <br><br><ul><li>  Python: asyncpg-0.5.2, psycopg2-2.6.2, aiopg-0.10.0, uvloop-0.5.0.  aiopg is a tiny wrapper over psycopg2, for asynchronous operation </li><li>  NodeJS: pg-6.0.0, pg-native-1.10.0 </li><li>  Golang: github.com/lib/pg@4dd446efc1, github.com/jackc/pgx@b3eed3cce0 </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/bd8/bb8/a42/bd8bb8a423fd0e164f43d639bea1ab62.png" alt="image"><br><img src="https://habrastorage.org/getpro/habr/post_images/e65/7e8/a0c/e657e8a0c6a84fbd8fc5306276aebaad.png" alt="image"><br>  The graphs show the average values ‚Äã‚Äãof the results obtained by running 4 different types of queries: <br><br>  - Direct query on the selection of all rows from the pg_type table (about 350 rows).  It is quite close to the total number of application requests.  In this test, asyncpg shows the header performance of 1 million lines per second.  <a href="https://magic.io/blog/asyncpg-1m-rows-from-postgres-to-python/report.html">More details.</a> <br><br>  - The query generates 1000 lines consisting of a single integer.  This test is designed to view performance when creating records and getting results.  <a href="https://magic.io/blog/asyncpg-1m-rows-from-postgres-to-python/report.html">More details.</a> <br><br>  - The query returns 100 rows, each of which contains 1 KB of binary data (blob).  This is a stressful I / O test.  <a href="https://magic.io/blog/asyncpg-1m-rows-from-postgres-to-python/report.html">More details.</a> <br><br>  - The query returns 100 lines, each of which contains an array of 100 integers.  This test is designed to test the decoding speed of arrays.  Here, asyncpg turned out to be slower than a faster implementation on golang.  This is related to the cost of creating and deleting tuples in Python.  <a href="https://magic.io/blog/asyncpg-1m-rows-from-postgres-to-python/report.html">More details.</a> <br><br><h3>  Conclusion </h3><br>  We are sure that using Python it is possible to create high-performance and scalable systems.  To do this, we need to make efforts to create fast, high-quality drivers, event cycles, and frameworks. <br><br>  asyncpg is one of the steps in this direction.  This is the result of meaningful design, powered by our experience in creating uvloop, as well as the effective use of Cython and asyncio. <br><br>  Translation of article <a href="https://magic.io/blog/asyncpg-1m-rows-from-postgres-to-python/">1M rows / s from Postgres to Python</a> <habracut></habracut></div><p>Source: <a href="https://habr.com/ru/post/317394/">https://habr.com/ru/post/317394/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317384/index.html">PDUG Meetup: disassembling WAFs on cogs, climbing into binaries with bare hands, assembling the development environment infrastructure</a></li>
<li><a href="../317386/index.html">C ++ Russia 2017</a></li>
<li><a href="../317388/index.html">From good to great</a></li>
<li><a href="../317390/index.html">How to centrally and remotely install software on PCs and mobile devices in a company</a></li>
<li><a href="../317392/index.html">Help Desk system Okdesk. How we develop our startup: the balance between long-term strategy and customer wishes</a></li>
<li><a href="../317396/index.html">How to write your sandbox? Analysis of the simplest "sandbox"</a></li>
<li><a href="../317398/index.html">Marketing games and what they eat</a></li>
<li><a href="../317400/index.html">Speed ‚Äã‚Äãreading How to read eight times faster if demons are chasing you</a></li>
<li><a href="../317402/index.html">Marionette.js 5 years old</a></li>
<li><a href="../317404/index.html">Remote work - how much% net? (stays in pocket)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>