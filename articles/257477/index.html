<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Jet Messenger, or CQRS and ES with Akka and Scala</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, we often hear about reactive programming and see various basvords: message-driven architecture, event-sourcing, CQRS. Unfortunately, on Habr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Jet Messenger, or CQRS and ES with Akka and Scala</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/a9a/e33/f74/a9ae33f74e48115db1befc5d1185f328.jpg" align="right">  Recently, we often hear about reactive programming and see various basvords: message-driven architecture, event-sourcing, CQRS.  Unfortunately, on Habr√© they write quite a bit about it, so I decided to correct the situation and share my knowledge with everyone. <br><br>  In this article we will learn about the main features of reactive applications, consider how the CQRS and EventSourcing patterns will help us in their creation, and in order not to be bored, we will step by step create your messenger with a websocket and actors that matches all canons of reactive programming.  To implement all this stuff, we will use the wonderful Scala language along with the equally excellent Akk library that implements the model of actors.  Also, we will use the Play Framework to write the web part of our application.  So let's get started. <br><br>  The article is intended for those who are already familiar with Scala and heard about the model of actors.  All others are also invited to read, the principles of reactive programming can be applied regardless of the language and framework. <br><a name="habracut"></a><br><h2>  What is reactive programming </h2><br>  The idea of ‚Äã‚Äãreactive programming is described in the reactive manifest <a href="http://www.reactivemanifesto.org/">www.reactivemanifesto.org</a> .  Translation of its <a href="http://habrahabr.ru/post/195562/">first version was</a> already on Habr√©, and the second version is slightly different from the first.  Let's look at a brief clipping from the second version.  A reactive manifest states that reactive applications have several important properties: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Responsiveness </h3><br>  The application responds as quickly as possible.  Responsiveness is the basis of usability and utility, for the simple reason that long interface delays do not add a desire to use it, and also responsiveness means that problems can be quickly detected and effectively solved.  Responsive systems focus on delivering fast and consistent response times, using suitable upper time boundaries to ensure consistent quality of service.  This constant and predictable behavior, in turn, simplifies error handling, enhances user confidence, and encourages them to further interact. <br><br><h3>  fault tolerance </h3><br>  The application remains responsive when a failure occurs.  This applies not only to high-availability, mission-critical systems ‚Äî any failure-unstable system will not be responsive in the event of a failure.  Stability is achieved through replication, localization, isolation and delegation.  Failures do not go beyond the module, and by isolating the modules from each other, you can be sure that individual parts of the application can fail and recover from a failure, while not causing the entire application to fall.  Recovery of each failed module is delegated to another, external module, and high availability is achieved through replication.  Module clients do not have a headache with module failure handling. <br><br><h3>  Elasticity </h3><br>  The app remains responsive under various loads.  Reactive applications can respond to changes in load by increasing or decreasing the resources intended for its processing.  This implies an architecture that does not have locking points or central bottlenecks, which is reflected in the ability to sharding and replication of modules, and the further distribution of the load between them.  The result of this is scalability with the help of cheap commonly used hardware (hello, google!). <br><br><h3>  Message Orientation </h3><br>  Reactive applications focus on asynchronous message passing to set boundaries between modules that provide weak connectivity, isolation, location transparency, and provides means for delegating errors as messages.  Introducing explicit message passing provides opportunities for load balancing, elasticity, and flow control by generating and monitoring message queues, and reducing bandwidth when needed.  Location transparency allows the same error handling logic to be used on the cluster as well as on the same node.  Non-blocking communications allow message recipients to consume resources only when they are active, which leads to a smaller overhead monitor when an application is running. <br><br><div style="text-align:center;"><img src="http://www.reactivemanifesto.org/images/reactive-traits.svg"></div><br><br><h2>  CQRS </h2><br>  CQRS stands for Command Query Responsibility Segregation (division of responsibility into teams and requests).  This approach to building the application architecture, in contrast to the widely used CRUD (Create Retrieve Update Delete), implies that it is possible to use different models for updating and reading information.  A natural question arises, why do we need such perversions?  The fact is that based on the fact that the reading model and the writing model are separated, we can optimize them for these tasks.  For example, if data is better suited for reading tasks, then no one bothers us to do this.  It is more convenient to read if the data in the graph database - please.  I want to store everything in the Key-Value store - for God's sake.  Moreover, if you want to add new features to the read model, then all you need to do after adding them is to regenerate the model (it‚Äôs worth making a reservation that if we have events for many gigabytes, then this process will not be so fast, but we can always make snapshot, which will significantly increase the speed of recovery). <br><br>  In principle, over the normalization of the Read-model, you can not bother at all, for the same reason.  Using CQRS to optimize read operations in our application, we ensure the responsiveness of our application.  What do we still have in order for our application to be truly reactive?  Correct, elasticity and resiliency.  We implement these features using the Event Sourcing pattern. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c4f/7db/f87/c4f7dbf878f64863ada5d4f22e9b95e1.png"></div><br><br><h2>  Event sourcing </h2><br>  The meaning of ES is that we do not store the current state of our data model, but the entire history of changes that change the state of our application (in fact, not all changes, but only those that matter to us).  To get the current state, we simply summarize the changes from all existing events.  What do we mean by an event, and how does an event differ from a team?  The team means that someone wants from us, besides, it can be ignored.  An event is something that happened, an unchangeable fact. <br><br>  The advantage of this approach is that we never delete or change anything.  As you may have guessed, this gives us ample opportunities to scale our application, and as a database we can use well-proven NoSQL solutions such as Cassandra or HBase.  EventSourcing gives us resiliency and elasticity. <br><br><h2>  Stop talking, show us the code. </h2><br>  So, as mentioned earlier, we will implement the whole thing using the <a href="http://typesafe.com/products/typesafe-reactive-platform">Typesafe stack</a> . <br><br>  The architecture of our application will look like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d1b/29d/c81/d1b29dc811a0476e95831bf7d4471c90.png"></div><br><br>  The user has the ability to read and send messages.  Sending and receiving messages occurs through the web socket, which the UserConnection actor has access to.  This actor sends messages to the RoomWriter actor, which, in addition to writing messages to the log, is engaged in kicking the RoomReader actor, which reads messages from the log and sends them back to the UserConnection actor.  In addition to all this, we have the Receptionist actor, which handles the issuance of names and ensures that the application does not have users with two identical names.  C architecture more or less figured out, now begin to write code. <br><br><h2>  RoomWriter </h2><br>  The very first we implement the actor that records incoming messages in the log. <br><br><div class="spoiler">  <b class="spoiler_title">RoomWriter Class Code</b> <div class="spoiler_text"><pre><code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RoomWriter</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">roomLogId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersistentActor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-type"><span class="hljs-type">RoomWriter</span></span>._ <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">persistenceId</span></span></span><span class="hljs-function"> </span></span>= roomLogId <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> listeners = mutable.<span class="hljs-type"><span class="hljs-type">Set</span></span>.empty[<span class="hljs-type"><span class="hljs-type">ActorRef</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receiveRecover</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-type"><span class="hljs-type">Actor</span></span>.emptyBehavior <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receiveCommand</span></span></span><span class="hljs-function"> </span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> msg: <span class="hljs-type"><span class="hljs-type">Message</span></span> =&gt; persistAsync(msg) { _ =&gt; listeners foreach (_ ! <span class="hljs-type"><span class="hljs-type">Update</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Listen</span></span>(ref) =&gt; listeners add context.watch(ref) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Terminated</span></span>(ref) =&gt; listeners remove ref } }</code> </pre> </div></div><br>  What is it written here?  As you might guess, we declared the RoomWriter class, which has three parts: <br><ul><li>  identifier persistenceId, which is necessary to uniquely identify the events that were produced by this actor; </li><li>  a set of listeners containing a set of links to actors that should be notified that something has changed in the log; </li><li>  two methods, receiveRecover, which is called when replaying messages from the log that occurs when creating an actor, and receiveCommand, which is used to process messages during normal operation. </li></ul><br>  Let's look at the receiveCommand method in more detail.  This method handles three different messages: <br><ul><li>  when a Message is received, it is asynchronously written to the log, and a message is sent to each listener that the log has been updated. </li><li>  when we receive a Listen, we begin to follow the life cycle of the actor, the link to which lies in the message, among other things, the link to the actor is added to the set of listeners </li><li>  A terminated message containing a link to the deceased actor will be received if the actor over the life cycle of which we are watching will suddenly die.  If this happens (the user has closed the browser), then we remove this actor from the mailing list. </li></ul><br>  The rule of good tone is the declaration of all processed messages and the factory method for creating an actor in a companion object: <br><br><div class="spoiler">  <b class="spoiler_title">RoomWriter companion object code</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RoomWriter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Listen</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">ref: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ActorRef</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Message</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">author: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, content: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, time: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Update</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">props</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">roomId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span></span>= <span class="hljs-type"><span class="hljs-type">Props</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">RoomWriter</span></span>(roomId)) }</code> </pre></div></div><br>  With RoomWriter, we figured out, now is the time to look at the RoomReader actor, which receives updates from the log, and sends them through the hierarchy above. <br><br><h2>  RoomReader </h2><br><div class="spoiler">  <b class="spoiler_title">RoomReader class</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RoomReader</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">roomLogId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, roomWriter: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ActorRef</span></span></span></span><span class="hljs-class"><span class="hljs-params">, userConnection: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ActorRef</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersistentView</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-type"><span class="hljs-type">RoomWriter</span></span>._ roomWriter ! <span class="hljs-type"><span class="hljs-type">Listen</span></span>(self) <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">persistenceId</span></span></span><span class="hljs-function"> </span></span>= roomLogId <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">viewId</span></span></span><span class="hljs-function"> </span></span>= roomLogId + <span class="hljs-string"><span class="hljs-string">"-view"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function"> </span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> msg @ <span class="hljs-type"><span class="hljs-type">Message</span></span>(_, _,sendingTime) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> currentTime - sendingTime &lt; tenMinutes =&gt; userConnection ! msg <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> msg: <span class="hljs-type"><span class="hljs-type">Message</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Update</span></span> =&gt; self ! akka.persistence.<span class="hljs-type"><span class="hljs-type">Update</span></span>() } }</code> </pre></div></div><br>  RoomReader depends on the log identifier, depending on which it will receive its updates.  In our case, this identifier will match with the identifier of the actor RoomWriter, which will mean that everything that RoomWriter writes to the log will come to RoomReader.  Consider how message processing takes place: <br><ul><li>  when a Message is received, the time it is sent is checked, and if the message is older than ten minutes, it will not be shown to the user.  This is done so that thousands of previously accumulated messages do not arrive to the user. </li><li>  when receiving Update, the actor reads the log, and sends the read messages to the user. </li></ul><br>  As in the previous case, our companion object: <br><div class="spoiler">  <b class="spoiler_title">RoomReader Companion Object Code</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RoomReader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">currentTime</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-type"><span class="hljs-type">System</span></span>.currentTimeMillis() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> tenMinutes = <span class="hljs-type"><span class="hljs-type">Duration</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-type"><span class="hljs-type">MINUTES</span></span>).toMillis <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">props</span></span></span></span>(roomLogId: <span class="hljs-type"><span class="hljs-type">String</span></span>, roomWriter: <span class="hljs-type"><span class="hljs-type">ActorRef</span></span>, userConnection: <span class="hljs-type"><span class="hljs-type">ActorRef</span></span>) = <span class="hljs-type"><span class="hljs-type">Props</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">RoomReader</span></span>(roomLogId, roomWriter, userConnection) ) }</code> </pre></div></div><br><br>  We proceed to the most interesting part, the UserConnection actor, which is responsible for processing messages from the web socket. <br><br><h2>  Userconnection </h2><br><div class="spoiler">  <b class="spoiler_title">Class code userconnection</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserConnection</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">receptionist: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ActorRef</span></span></span></span><span class="hljs-class"><span class="hljs-params">, roomWriter: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ActorRef</span></span></span></span><span class="hljs-class"><span class="hljs-params">, out: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ActorRef</span></span></span></span><span class="hljs-class"><span class="hljs-params">, roomLogId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Actor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> actors.<span class="hljs-type"><span class="hljs-type">UserConnection</span></span>._ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function"> </span></span>= waitingForUsername <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitingForUsername</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Receive</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">WebSocketInMsg</span></span>(<span class="hljs-type"><span class="hljs-type">RegisterMeWithName</span></span>, username) =&gt; receptionist ! <span class="hljs-type"><span class="hljs-type">UsernameRequest</span></span>(username) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Ack</span></span>(username) =&gt; context become readyToChat(username) context actorOf <span class="hljs-type"><span class="hljs-type">RoomReader</span></span>.props(roomLogId, roomWriter, self) out ! <span class="hljs-type"><span class="hljs-type">WebSocketOutMsg</span></span>(currentTime, <span class="hljs-string"><span class="hljs-string">"system"</span></span>, <span class="hljs-string"><span class="hljs-string">"welcome"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">NAck</span></span> =&gt; out ! <span class="hljs-type"><span class="hljs-type">WebSocketOutMsg</span></span>(currentTime, <span class="hljs-string"><span class="hljs-string">"system"</span></span>, <span class="hljs-string"><span class="hljs-string">"taken"</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readyToChat</span></span></span></span>(username: <span class="hljs-type"><span class="hljs-type">String</span></span>): <span class="hljs-type"><span class="hljs-type">Receive</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">WebSocketInMsg</span></span>(<span class="hljs-type"><span class="hljs-type">SendMessage</span></span>, message) =&gt; roomWriter ! <span class="hljs-type"><span class="hljs-type">Message</span></span>(username, message, currentMillis) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Message</span></span>(author, content, time) =&gt; out ! <span class="hljs-type"><span class="hljs-type">WebSocketOutMsg</span></span>(formatTime(time), author, content) } }</code> </pre></div></div><br>  This actor has one feature that distinguishes it from others: it can change its behavior and state.  Initially, he is in a state of waiting for a username.  In this state, it can accept client requests for a name, and forward them to the actor responsible for issuing names.  Upon successful receipt of the name, the actor enters the state of readiness for the chat, and begins to send messages between parts of the system. <br><br>  This companion turned out to be quite large this time: <br><br><div class="spoiler">  <b class="spoiler_title">Companion object code for the UserConnection class</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserConnection</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">props</span></span></span></span>(receptionist: <span class="hljs-type"><span class="hljs-type">ActorRef</span></span>, roomWriter: <span class="hljs-type"><span class="hljs-type">ActorRef</span></span>, out: <span class="hljs-type"><span class="hljs-type">ActorRef</span></span>, roomLogId: <span class="hljs-type"><span class="hljs-type">String</span></span>) = <span class="hljs-type"><span class="hljs-type">Props</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">UserConnection</span></span>(receptionist, roomWriter, out, roomLogId) ) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WebSocketInMsg</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">messageType: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, messageText: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WebSocketOutMsg</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">time: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, from: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, messageText: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UsernameRequest</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ack</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">username: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NAck</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegisterMeWithName</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> <span class="hljs-type"><span class="hljs-type">SendMessage</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> formatter = <span class="hljs-type"><span class="hljs-type">DateTimeFormat</span></span>.forPattern(<span class="hljs-string"><span class="hljs-string">"HH:mm:ss"</span></span>).withLocale(<span class="hljs-type"><span class="hljs-type">Locale</span></span>.<span class="hljs-type"><span class="hljs-type">US</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">currentTime</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-type"><span class="hljs-type">DateTime</span></span>.now().toString(formatter) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">currentMillis</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-type"><span class="hljs-type">System</span></span>.currentTimeMillis() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">formatTime</span></span></span></span>(timeStamp: <span class="hljs-type"><span class="hljs-type">Long</span></span>) = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">DateTime</span></span>(timeStamp).toString(formatter) }</code> </pre></div></div><br><br>  The last actor to be given our attention is the Receptionist. <br><br><h2>  Receptionist </h2><br><div class="spoiler">  <b class="spoiler_title">Receptionist class code</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Receptionist</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Actor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> takenNames = mutable.<span class="hljs-type"><span class="hljs-type">Map</span></span>(<span class="hljs-string"><span class="hljs-string">"system"</span></span> -&gt; self) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function"> </span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">UsernameRequest</span></span>(username) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (takenNames contains username) { sender() ! <span class="hljs-type"><span class="hljs-type">NAck</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { takenNames += (username -&gt; context.watch(sender())) sender() ! <span class="hljs-type"><span class="hljs-type">Ack</span></span>(username) } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Terminated</span></span>(ref) =&gt; takenNames collectFirst { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (name, actor) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> actor == ref =&gt; name } foreach takenNames.remove } }</code> </pre></div></div><br>  Its task is to issue names to users: it contains an associative array that maps names to actorRefs.  Just like in RoomWriter, we follow the life cycle of the actors to whom we gave out the names, and in case of their death, remove their names from the list of registered names. <br><br>  Do not forget about the companion object, we place the factory method there to create the actor: <br><br><div class="spoiler">  <b class="spoiler_title">Companion object code of the Receptionist class</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Receptionist</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">props</span></span></span></span>() = <span class="hljs-type"><span class="hljs-type">Props</span></span>[<span class="hljs-type"><span class="hljs-type">Receptionist</span></span>] }</code> </pre></div></div><br><h2>  Controller </h2><br>  At the moment we are finished with all the actors that we had plans for implementation.  Now let's look at how we can connect a web socket and an actor.  For this, we will use the tools that the play framework can offer us.  We implement the controller of our application as follows: <br><br><div class="spoiler">  <b class="spoiler_title">Controller code</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> logId = <span class="hljs-string"><span class="hljs-string">"akka-is-awesome"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> roomWriter = <span class="hljs-type"><span class="hljs-type">Akka</span></span>.system.actorOf(<span class="hljs-type"><span class="hljs-type">RoomWriter</span></span>.props(logId), <span class="hljs-string"><span class="hljs-string">"writer"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> receptionist = <span class="hljs-type"><span class="hljs-type">Akka</span></span>.system.actorOf(<span class="hljs-type"><span class="hljs-type">Receptionist</span></span>.props(), <span class="hljs-string"><span class="hljs-string">"receptionist"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">index</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-type"><span class="hljs-type">Action</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> request =&gt; <span class="hljs-type"><span class="hljs-type">Ok</span></span>(views.html.chat()) } <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> <span class="hljs-type"><span class="hljs-type">InMsgFormat</span></span> = <span class="hljs-type"><span class="hljs-type">Json</span></span>.format[<span class="hljs-type"><span class="hljs-type">WebSocketInMsg</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> <span class="hljs-type"><span class="hljs-type">InMsgFrameFormatter</span></span> = <span class="hljs-type"><span class="hljs-type">FrameFormatter</span></span>.jsonFrame[<span class="hljs-type"><span class="hljs-type">WebSocketInMsg</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> <span class="hljs-type"><span class="hljs-type">OutMsgFormat</span></span> = <span class="hljs-type"><span class="hljs-type">Json</span></span>.format[<span class="hljs-type"><span class="hljs-type">WebSocketOutMsg</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> <span class="hljs-type"><span class="hljs-type">OutMsgFrameFormatter</span></span> = <span class="hljs-type"><span class="hljs-type">FrameFormatter</span></span>.jsonFrame[<span class="hljs-type"><span class="hljs-type">WebSocketOutMsg</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">socket</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-type"><span class="hljs-type">WebSocket</span></span>.acceptWithActor[<span class="hljs-type"><span class="hljs-type">WebSocketInMsg</span></span>, <span class="hljs-type"><span class="hljs-type">WebSocketOutMsg</span></span>] { request =&gt; out =&gt; <span class="hljs-type"><span class="hljs-type">UserConnection</span></span>.props(receptionist, roomWriter, out, logId) } }</code> </pre></div></div><br>  First, we create two actors: roomWriter and receptionist.  They are dependencies for the UserConnection actor.  Next, we describe how to format messages for transmission through the webcast.  Finally, we describe how we handle incoming connections to the web socket.  The helper built into the Play Framework makes it incredibly easy to do. <br><br>  It's time to create a web interface.  For the layout we will use the twitter bootstrap framework, and angular.js - to implement the business logic on the client. <br><br><div class="spoiler">  <b class="spoiler_title">Client part of the code</b> <div class="spoiler_text"><pre> <code class="javascript hljs">angular.module(<span class="hljs-string"><span class="hljs-string">'chatApp'</span></span>, []) .controller(<span class="hljs-string"><span class="hljs-string">'ChatCtrl'</span></span>, [<span class="hljs-string"><span class="hljs-string">'$scope'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$scope</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wsUri = <span class="hljs-string"><span class="hljs-string">"ws://"</span></span>+<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location.host+<span class="hljs-string"><span class="hljs-string">"/ws"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> websocket = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebSocket(wsUri); $scope.name = <span class="hljs-string"><span class="hljs-string">""</span></span>; $scope.messages = []; $scope.registered = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; $scope.taken = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; $scope.sendMessage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ websocket.send(angular.toJson({ <span class="hljs-string"><span class="hljs-string">"messageType"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"messageText"</span></span>:$scope.messageText })); $scope.messageText = <span class="hljs-string"><span class="hljs-string">""</span></span>; }; $scope.sendName = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$scope.registered) { websocket.send(angular.toJson({ <span class="hljs-string"><span class="hljs-string">"messageType"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"messageText"</span></span>: $scope.name })); } }; websocket.onmessage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msg = angular.fromJson(e.data); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(e.data); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$scope.registered) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (msg.from) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"system"</span></span>: handleSystemMsg(msg.messageText); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $scope.messages.push(msg); $scope.$apply(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> chatWindow = $(<span class="hljs-string"><span class="hljs-string">"#chat-window"</span></span>); chatWindow.scrollTop(chatWindow[<span class="hljs-number"><span class="hljs-number">0</span></span>].scrollHeight); } }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleSystemMsg</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">msg</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (msg) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"welcome"</span></span>: $scope.registered = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"taken"</span></span>: $scope.taken = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }]);</code> </pre></div></div><br>  What our html page will look like: <br><br><div class="spoiler">  <b class="spoiler_title">Html code of the application</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-app</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chatApp"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http-equiv</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"X-UA-Compatible"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"IE=edge"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"viewport"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"width=device-width, initial-scale=1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"description"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"author"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Akka WebSocket Chat<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Bootstrap core CSS --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://ajax.googleapis.com/ajax/libs/angularjs/1.3.5/angular.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Custom styles for this template --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@routes.Assets.at("</span></span></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stylesheets</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">main.css</span></span></span><span class="hljs-tag">")" </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@routes.Assets.at("</span></span></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">javascripts</span></span></span><span class="hljs-tag">/</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">chatApp.js</span></span></span><span class="hljs-tag">")"&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-controller</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ChatCtrl"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar navbar-inverse navbar-fixed-top"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">role</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navigation"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"container"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-header"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-brand"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#"</span></span></span><span class="hljs-tag">&gt;</span></span>Reactive Messenger<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-form navbar-left"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-submit</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sendName()"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-show</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"!registered"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-group"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-control"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">placeholder</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Username"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">required</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-default"</span></span></span><span class="hljs-tag">&gt;</span></span>Set name<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"container"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chat col-lg-6"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chat-window"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"list-group"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"list-group-item"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-repeat</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message in messages"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"label label-info"</span></span></span><span class="hljs-tag">&gt;</span></span>{{message.time}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"label label-default"</span></span></span><span class="hljs-tag">&gt;</span></span>{{message.from}}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> {{message.messageText}} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-submit</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sendMessage()"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"input-group"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ng-model</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"messageText"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-control"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">required</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"input-group-btn"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-default"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag">&gt;</span></span> Send<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"glyphicon glyphicon-send"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">aria-hidden</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- /input-group --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- /.col-lg-6 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- /.container --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Bootstrap core JavaScript ================================================== --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Placed at the end of the document so the pages load faster --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br><br><h2>  Scaling out </h2><br>  We have a prototype of the application, but before rolling it out into production, we should pump it a little.  We will pump it in the following way: <br><ul><li>  Let's replace our ersatz magazine with something really good.  In this case, we will take Cassandra, and will use it to store events. </li><li>  Default Java serialization does not differ in its stability when changing the format of messages or the speed in their serialization.  It is worth replacing it with Google Protobuf or Kryo.  In this case, we will use Protobuf. </li><li>  Users of our messenger want to stay up to date with the latest news, and do not want to read messages older than half an hour.  To do this, we will change the logic of our actors, and we will create a snapshot every half hour, so we do not have to restore the entire message history every time a user connects. </li><li>  In order for the application to process a large number of users, it is worth making it distributed. </li></ul><br>  When you run an application on multiple servers, its architecture will change very slightly.  Due to the fact that the actors in Akka have the property location transparency, we can safely pull away our application on several servers.  Moreover, our actors will not even guess that they are now separated and work on different servers communicating over the network.  All we need is to add some code, and Akka will do the rest of the work for us. <br>  I'll run ahead and provide a picture of how our application will look after all the improvements.  In general, the architecture will undergo minor changes, but the idea will remain the same. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/4e8/529/63a/4e852963a6a349859cbb7f008cc05da9.png"></div><br><br>  To use cassandra as a magazine, we need <br><ol><li>  install cassandra on nodes, </li><li>  use the plugin to keep the log in cassandra. </li></ol><br>  The first paragraph is well described in the official manual, so there is no special reason to bring it here.  It is worth noting only that it is not necessary to make all the nodes of the cassanda seed-nodes, for a cluster of three machines one sid will be enough. <br><br>  Regarding the second, we need to specify the type of log in the config, and register the addresses of the cassandra nodes.  This can be done as follows: <br><div class="spoiler">  <b class="spoiler_title">Akka-persistence configuration</b> <div class="spoiler_text"><pre> <code class="javascript hljs">akka.persistence.journal.plugin = <span class="hljs-string"><span class="hljs-string">"cassandra-journal"</span></span> cassandra-journal.contact-points = [<span class="hljs-string"><span class="hljs-string">"ip1,ip2,ip3"</span></span>] akka.persistence.snapshot-store.plugin = <span class="hljs-string"><span class="hljs-string">"cassandra-snapshot-store"</span></span> cassandra-snapshot-store.contact-points = [<span class="hljs-string"><span class="hljs-string">"ip1,ip2,ip3"</span></span>]</code> </pre></div></div><br>  After connecting cassandra, we will write our class to serialize and deserialize messages: first, we will use the protobuff code generator to generate the necessary classes, and then with their help we will make a serializer. <br><br>  This is how the protobuf file will look like: <br><br><div class="spoiler">  <b class="spoiler_title">Content of the protobuf file</b> <div class="spoiler_text"><pre> <code class="cpp hljs">option java_package = <span class="hljs-string"><span class="hljs-string">"actors.messages"</span></span>; option optimize_for = SPEED; message ChatMessage { optional <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> author = <span class="hljs-number"><span class="hljs-number">1</span></span>; optional <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> content = <span class="hljs-number"><span class="hljs-number">2</span></span>; optional int64 timestamp = <span class="hljs-number"><span class="hljs-number">3</span></span>; }</code> </pre></div></div><br>  After the generation of the required class by the protobuf, we will write our serializer: <br><br><div class="spoiler">  <b class="spoiler_title">Message Serializer Code</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChatMessageSerializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">identifier</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Int</span></span> = <span class="hljs-number"><span class="hljs-number">193823</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">includeManifest</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Boolean</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toBinary</span></span></span></span>(obj: <span class="hljs-type"><span class="hljs-type">AnyRef</span></span>): <span class="hljs-type"><span class="hljs-type">Array</span></span>[<span class="hljs-type"><span class="hljs-type">Byte</span></span>] = obj <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">ChatMessage</span></span>(author, content, timestamp) =&gt; <span class="hljs-type"><span class="hljs-type">ProtoChatMessage</span></span>.newBuilder() .setAuthor(author) .setContent(content) .setTimestamp(timestamp) .build() .toByteArray <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> _ =&gt; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">IllegalArgumentException</span></span>(<span class="hljs-string"><span class="hljs-string">"unknown type "</span></span> + obj.getClass) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromBinary</span></span></span></span>(bytes: <span class="hljs-type"><span class="hljs-type">Array</span></span>[<span class="hljs-type"><span class="hljs-type">Byte</span></span>], manifest: <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">Class</span></span>[_]]): <span class="hljs-type"><span class="hljs-type">AnyRef</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> proto = <span class="hljs-type"><span class="hljs-type">ProtoChatMessage</span></span>.parseFrom(bytes) <span class="hljs-type"><span class="hljs-type">ChatMessage</span></span>(proto.getAuthor, proto.getContent, proto.getTimestamp) } }</code> </pre></div></div><br>  So, we now have a normal log, and a way to write to it.  Now we need to think of a way to save messages no longer than 10 minutes.  To do this, we write our own buffer that will save messages in the last 10 minutes. <br><br><div class="spoiler">  <b class="spoiler_title">Buffer code</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FixedTimeMessageBuffer</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">duration: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Traversable</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ChatMessage</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> list = <span class="hljs-type"><span class="hljs-type">ListBuffer</span></span>[<span class="hljs-type"><span class="hljs-type">ChatMessage</span></span>]() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">now</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-type"><span class="hljs-type">System</span></span>.currentTimeMillis() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">old</span></span></span><span class="hljs-function"> </span></span>= now - duration <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">append</span></span></span></span>(elem: <span class="hljs-type"><span class="hljs-type">ChatMessage</span></span>) = { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (elem.timestamp &gt; old) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (list.nonEmpty &amp;&amp; list.head.timestamp &lt; old) { list.remove(<span class="hljs-number"><span class="hljs-number">0</span></span>) } list.append(elem) } } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toList</span></span></span><span class="hljs-function"> </span></span>= list.toList <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replace</span></span></span></span>(newList: <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">ChatMessage</span></span>]) = { list.clear() list ++= newList } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foreach</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">U</span></span>](f: <span class="hljs-type"><span class="hljs-type">ChatMessage</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">U</span></span>) = list.foreach(f) }</code> </pre></div></div><br>  We chose ListBuffer as the data structure for storing messages - for the reason that we only add elements to the end and remove them from the beginning.  ListBuffer allows you to do these operations for a constant time.  In the future, we will apply this buffer in our Reader actor in order to limit the number of messages sent to newly connected clients. <br><br>  Consider how we divide actors across the network.  In order for our application not to fall when one node is disconnected, and waiting for it to be turned on, we need to write the appropriate logic in the actor.  Actor RoomWriter should notify RoomReader about new messages, so it will be useful for him to know the state of RoomReader.  This logic is well described by the introduction of two states in the actor. <br><br><div class="spoiler">  <b class="spoiler_title">New methods for the RoomReader class</b> <div class="spoiler_text"><pre> <code class="scala hljs">... sendIdentifyRequest() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendIdentifyRequest</span></span></span></span>(): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = { log.info(<span class="hljs-string"><span class="hljs-string">s"Trying connecting to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$roomReaderPath</span></span></span><span class="hljs-string">"</span></span>) context.actorSelection(roomReaderPath) ! <span class="hljs-type"><span class="hljs-type">Identify</span></span>(roomReaderPath) context.system.scheduler.scheduleOnce(<span class="hljs-number"><span class="hljs-number">3.</span></span>seconds, self, <span class="hljs-type"><span class="hljs-type">ReceiveTimeout</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receiveRecover</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-type"><span class="hljs-type">Actor</span></span>.emptyBehavior <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receiveCommand</span></span></span><span class="hljs-function"> </span></span>= identifying <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">identifying</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Receive</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> msg: <span class="hljs-type"><span class="hljs-type">ChatMessage</span></span> =&gt; persistAsync(msg) { m =&gt; log.info(<span class="hljs-string"><span class="hljs-string">s"Message </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$m</span></span></span><span class="hljs-string"> persisted, but the reader isn't available"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">ActorIdentity</span></span>(`roomReaderPath`, <span class="hljs-type"><span class="hljs-type">Some</span></span>(actor)) =&gt; log.info(<span class="hljs-string"><span class="hljs-string">s"Successfully connected to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$roomReaderPath</span></span></span><span class="hljs-string">"</span></span>) context.watch(actor) context.become(active(actor)) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">ActorIdentity</span></span>(`roomReaderPath`, <span class="hljs-type"><span class="hljs-type">None</span></span>) =&gt; log.info(<span class="hljs-string"><span class="hljs-string">s"Remote actor is not available: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$roomReaderPath</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">ReceiveTimeout</span></span> =&gt; sendIdentifyRequest() <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> _ =&gt; log.info(<span class="hljs-string"><span class="hljs-string">"Not ready yet"</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">active</span></span></span></span>(reader: <span class="hljs-type"><span class="hljs-type">ActorRef</span></span>): <span class="hljs-type"><span class="hljs-type">Receive</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> msg: <span class="hljs-type"><span class="hljs-type">ChatMessage</span></span> =&gt; persistAsync(msg) { _ =&gt; reader ! <span class="hljs-type"><span class="hljs-type">Update</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"snap"</span></span> =&gt; saveSnapshot(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Terminated</span></span>(`reader`) =&gt; log.info(<span class="hljs-string"><span class="hljs-string">"reader terminated"</span></span>) sendIdentifyRequest() context.become(identifying) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">ReceiveTimeout</span></span> =&gt; <span class="hljs-comment"><span class="hljs-comment">// ignore } ...</span></span></code> </pre></div></div><br>  In the sendIdentifyRequest method, we try to get the ActorRef of the remote actor by sending it a Identify message.  All actors understand this message, and in response they send us the ActorRef we need.  After receiving the ActorRef, we go back to normal and begin work.  It should be noted that we are also starting to monitor the life cycle of the remote actor and, if it is not available, we will try to reach it again. <br><br>  In order to implement such a logic of work for the UserConnection actor, we will create a separate actor that will act as an intermediary in communicating with the backend. <br><br><div class="spoiler">  <b class="spoiler_title">BackendTalker class code</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BackendTalker</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">roomWriterPath: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, roomReaderPath: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Actor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ActorLogging</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-type"><span class="hljs-type">BackendTalker</span></span>._ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> listeners = collection.mutable.<span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">ActorRef</span></span>]() sendReaderIdentifyRequest() sendWriterIdentifyRequest() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendReaderIdentifyRequest</span></span></span></span>(): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = { log.info(<span class="hljs-string"><span class="hljs-string">"sending identify request to reader"</span></span>) context.actorSelection(roomReaderPath) ! <span class="hljs-type"><span class="hljs-type">Identify</span></span>(roomReaderPath) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> context.dispatcher context.system.scheduler.scheduleOnce(<span class="hljs-number"><span class="hljs-number">3.</span></span>seconds, self, <span class="hljs-type"><span class="hljs-type">ReaderReceiveTimeout</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendWriterIdentifyRequest</span></span></span></span>(): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = { log.info(<span class="hljs-string"><span class="hljs-string">"sending identify request to writer"</span></span>) context.actorSelection(roomWriterPath) ! <span class="hljs-type"><span class="hljs-type">Identify</span></span>(roomWriterPath) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> context.dispatcher context.system.scheduler.scheduleOnce(<span class="hljs-number"><span class="hljs-number">3.</span></span>seconds, self, <span class="hljs-type"><span class="hljs-type">WriterReceiveTimeout</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function"> </span></span>= identifying <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">identifying</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Receive</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">ActorIdentity</span></span>(`roomWriterPath`, <span class="hljs-type"><span class="hljs-type">Some</span></span>(actor)) =&gt; log.info(<span class="hljs-string"><span class="hljs-string">s"Successfully identified writer at </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$roomWriterPath</span></span></span><span class="hljs-string">"</span></span>) context.watch(actor) context.become(waitingForReader(actor)) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">ActorIdentity</span></span>(`roomReaderPath`, <span class="hljs-type"><span class="hljs-type">Some</span></span>(actor)) =&gt; log.info(<span class="hljs-string"><span class="hljs-string">s"Successfully identified reader at </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$roomReaderPath</span></span></span><span class="hljs-string">"</span></span>) listeners.foreach(actor ! <span class="hljs-type"><span class="hljs-type">Listen</span></span>(_)) context.watch(actor) context.become(waitingForWriter(actor)) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">ActorIdentity</span></span>(path, <span class="hljs-type"><span class="hljs-type">None</span></span>) =&gt; log.info(<span class="hljs-string"><span class="hljs-string">s"Remote actor not available: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$path</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">ReaderReceiveTimeout</span></span> =&gt; sendReaderIdentifyRequest() <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">WriterReceiveTimeout</span></span> =&gt; sendWriterIdentifyRequest() <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> msg: <span class="hljs-type"><span class="hljs-type">ChatMessage</span></span> =&gt; listeners += context.watch(sender()) sender() ! <span class="hljs-type"><span class="hljs-type">ChatMessage</span></span>(<span class="hljs-string"><span class="hljs-string">"system"</span></span>, <span class="hljs-string"><span class="hljs-string">"Connection problem, try again later"</span></span>, <span class="hljs-type"><span class="hljs-type">System</span></span>.currentTimeMillis()) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Terminated</span></span>(userCon) =&gt; listeners -= userCon <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> _ =&gt; log.info(<span class="hljs-string"><span class="hljs-string">"Not ready yet"</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitingForReader</span></span></span></span>(writer: <span class="hljs-type"><span class="hljs-type">ActorRef</span></span>): <span class="hljs-type"><span class="hljs-type">Receive</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">ActorIdentity</span></span>(`roomReaderPath`, <span class="hljs-type"><span class="hljs-type">Some</span></span>(reader)) =&gt; log.info(<span class="hljs-string"><span class="hljs-string">s"Successfully identified reader at </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$roomReaderPath</span></span></span><span class="hljs-string">"</span></span>) listeners.foreach(reader ! <span class="hljs-type"><span class="hljs-type">Listen</span></span>(_)) context.watch(reader) context.become(active(reader, writer)) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">ActorIdentity</span></span>(`roomReaderPath`, <span class="hljs-type"><span class="hljs-type">None</span></span>) =&gt; log.info(<span class="hljs-string"><span class="hljs-string">s"Reader actor not available: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$roomReaderPath</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">ReaderReceiveTimeout</span></span> =&gt; sendReaderIdentifyRequest() <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">WriterReceiveTimeout</span></span> =&gt; sendWriterIdentifyRequest() <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Terminated</span></span>(`writer`) =&gt; log.info(<span class="hljs-string"><span class="hljs-string">"writer terminated"</span></span>) sendWriterIdentifyRequest() context.become(identifying) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> msg: <span class="hljs-type"><span class="hljs-type">ChatMessage</span></span> =&gt; listeners += context.watch(sender()) sender() ! <span class="hljs-type"><span class="hljs-type">ChatMessage</span></span>(<span class="hljs-string"><span class="hljs-string">"system"</span></span>, <span class="hljs-string"><span class="hljs-string">"Connection problem, try again later"</span></span>, <span class="hljs-type"><span class="hljs-type">System</span></span>.currentTimeMillis()) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Terminated</span></span>(userCon) =&gt; listeners -= userCon <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> _ =&gt; log.info(<span class="hljs-string"><span class="hljs-string">"Not ready yet"</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitingForWriter</span></span></span></span>(reader: <span class="hljs-type"><span class="hljs-type">ActorRef</span></span>): <span class="hljs-type"><span class="hljs-type">Receive</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">ActorIdentity</span></span>(`roomWriterPath`, <span class="hljs-type"><span class="hljs-type">Some</span></span>(writer)) =&gt; log.info(<span class="hljs-string"><span class="hljs-string">s"Successfully identified writer at </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$roomWriterPath</span></span></span><span class="hljs-string">"</span></span>) context.watch(writer) context.become(active(reader, writer)) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">ActorIdentity</span></span>(`roomWriterPath`, <span class="hljs-type"><span class="hljs-type">None</span></span>) =&gt; log.info(<span class="hljs-string"><span class="hljs-string">s"Reader actor not available: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$roomWriterPath</span></span></span><span class="hljs-string">"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">ReaderReceiveTimeout</span></span> =&gt; sendReaderIdentifyRequest() <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">WriterReceiveTimeout</span></span> =&gt; sendWriterIdentifyRequest() <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Terminated</span></span>(`reader`) =&gt; log.info(<span class="hljs-string"><span class="hljs-string">"reader terminated"</span></span>) sendReaderIdentifyRequest() context.become(identifying) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> msg: <span class="hljs-type"><span class="hljs-type">ChatMessage</span></span> =&gt; listeners += context.watch(sender()) sender() ! <span class="hljs-type"><span class="hljs-type">ChatMessage</span></span>(<span class="hljs-string"><span class="hljs-string">"system"</span></span>, <span class="hljs-string"><span class="hljs-string">"Connection problem, try again later"</span></span>, <span class="hljs-type"><span class="hljs-type">System</span></span>.currentTimeMillis()) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Terminated</span></span>(userCon) =&gt; listeners -= userCon <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> _ =&gt; log.info(<span class="hljs-string"><span class="hljs-string">"Not ready yet"</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">active</span></span></span></span>(reader: <span class="hljs-type"><span class="hljs-type">ActorRef</span></span>, writer: <span class="hljs-type"><span class="hljs-type">ActorRef</span></span>): <span class="hljs-type"><span class="hljs-type">Receive</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> l: <span class="hljs-type"><span class="hljs-type">Listen</span></span> =&gt; reader ! l <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> msg: <span class="hljs-type"><span class="hljs-type">ChatMessage</span></span> =&gt; writer ! msg <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Terminated</span></span>(`reader`) =&gt; log.info(<span class="hljs-string"><span class="hljs-string">"reader terminated"</span></span>) sendReaderIdentifyRequest() context.become(waitingForReader(writer)) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Terminated</span></span>(`writer`) =&gt; log.info(<span class="hljs-string"><span class="hljs-string">"writer terminated"</span></span>) sendWriterIdentifyRequest() context.become(waitingForWriter(reader)) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">ReaderReceiveTimeout</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">WriterReceiveTimeout</span></span> =&gt; <span class="hljs-comment"><span class="hljs-comment">// ignore } }</span></span></code> </pre></div></div><br>  In it, we implement the logic of waiting for remote actors by analogy with what we did in the RoomWriter actor.  In this case, we need to expect connection to two actors at once, so the logic of the work is a bit more complicated. <br><br>  The final touch remains: we will rewrite RoomReader a bit in order to limit the number of messages that users receive. <br><br>  To do this, we will add a couple of lines in it. <br><br>  In the constructor, we define our buffer for storing messages, and write an auxiliary method for working with it.  In addition, we will launch the scheduler, which every 10 minutes will give the command to create snapshots.  It is worth noting that the command is given by sending a message to the actor, and we do not call the saveSnapshot method directly.  This is done specifically in order not to violate the principle that the work with mutable data of the actor should be done only by the actor.  Violating this principle, we can get subtle bugs. <br><br><div class="spoiler">  <b class="spoiler_title">Supplement to RoomReader</b> <div class="spoiler_text"><pre> <code class="scala hljs">context.system.scheduler.schedule(tenMinutes, tenMinutes, self, <span class="hljs-type"><span class="hljs-type">Snap</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> state = <span class="hljs-type"><span class="hljs-type">FixedTimeMessageBuffer</span></span>(tenMinutes) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateState</span></span></span></span>(msg: <span class="hljs-type"><span class="hljs-type">ChatMessage</span></span>) = state.append(msg)</code> </pre></div></div><br>  In the receive method, we implement the ability to save snapshots after a special message arrives.  We also implement the correct recovery of the state from snapshot. <br><br><div class="spoiler">  <b class="spoiler_title">Supplement to RoomReader</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> msg:<span class="hljs-type"><span class="hljs-type">ChatMessage</span></span> =&gt; updateState(msg) sendAll(msg) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Listen</span></span>(ref) =&gt; listeners add context.watch(ref) state.foreach(ref ! _) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Snap</span></span> =&gt; saveSnapshot(state.toList) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">SnapshotOffer</span></span>(_, snapshot: <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">ChatMessage</span></span>]) =&gt; state.replace(snapshot)</code> </pre></div></div><br>  Summarizing, we can say that we have implemented a modern web application, made in the spirit of reactive programming.  It allows you to quickly respond to user requests and also has some degree of stability.  However, it has much to improve.  In order for our application to work even in the case of the fall of individual nodes, we should use the akka-cluster module, which allows you to quickly implement decentralized applications that do not have a single point of failure.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition, we need to somehow handle the situation when the flow of messages is too large and the actors do not have time to process it. </font><font style="vertical-align: inherit;">To work with this, there is an experimental module akka-streams. </font><font style="vertical-align: inherit;">We will find out about this and many other things in the next article.</font></font></div><p>Source: <a href="https://habr.com/ru/post/257477/">https://habr.com/ru/post/257477/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257463/index.html">AI, BigData & HPC Digest # 0. Pilot issue</a></li>
<li><a href="../257465/index.html">Multiklet R1 - the first tests</a></li>
<li><a href="../257469/index.html">Issue with SCVMM Admin Console after installing Update Rollup 6</a></li>
<li><a href="../257471/index.html">Post Hawk switched to https</a></li>
<li><a href="../257475/index.html">Top 3 among the reasons for the refusal to use the callback widget</a></li>
<li><a href="../257479/index.html">Infrastructure of the Radio Access Network as an investment</a></li>
<li><a href="../257481/index.html">Reference Code</a></li>
<li><a href="../257483/index.html">And again about the ears</a></li>
<li><a href="../257487/index.html">What is Junos Fusion?</a></li>
<li><a href="../257489/index.html">Intel Enterprise Edition - ‚ÄúShade‚Äù for Luster</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>