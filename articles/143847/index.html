<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Once again about the electronic library for PocketBook</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings to you, Habr! 

 This article is just a detailed commentary on the text ‚ÄúElectronic library for PocketBook: automatic processing‚Äù by dsd_cor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Once again about the electronic library for PocketBook</h1><div class="post__text post__text-html js-mediator-article">  Greetings to you, Habr! <br><br>  This article is just a detailed commentary on the text <a href="http://habrahabr.ru/post/143492/">‚ÄúElectronic library for PocketBook: automatic processing‚Äù</a> by <a href="https://geektimes.ru/users/dsd_corp/" class="user_link">dsd_corp</a> , since I, being ethereal (readonly) in spirit, cannot (for now) leave the usual comments.  However, I will not discuss the policy of Habr, but let me get down to business. <br><br>  First, I would like to thank the author for his article.  I learned a lot of useful information about the PocketBook 360 ¬∞ I have used for a long time and put a trash bin on it in relative order.  The script, as promised by the author, turned out to be portable (I have Linux), except for a slight inconvenience with encodings. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Below I just give my comments. <br><a name="habracut"></a><br><ol><li> The directory where the actual books are stored is best named so that it starts with a dot.  The device itself follows the ancient yuniksovoy tradition of "files from the point - for sharpening" and does not show them.  That is, the script should change <code>$storagename</code> to, for example, <code>'.zipstorage'</code> . </li><li>  I found that the names of the files created are written in cp1251 encoding (have they really not been converted to Unicode in Windows yet?).  It seemed to me very inconvenient, so I tried to edit the script to make a kosher utf8.  Initially naively made <br><br> <code>sed -i 's/windows-1251/utf8/g' *php *.inc</code> <br> <br>  etc., but it turned out bad, because the script does some pretty non-trivial things, in particular, it understands what the original encoding of the input fb2-files and correctly recodes.  In addition, I see text in PHP almost for the first time in my life.  Therefore, I returned everything as it was and just did <br><br> <code>convmv -f cp1251 -t utf8 -r --notest out_dir/dest/</code> <br> <br>  every time after the execution of the script. </li><li>  The fact that references by authors are laid out too deeply (the letters A-Z / first letter / first three letters / author) seemed uncomfortable to me.  At least, when there are not very many books, it is not justified.  I figured out how to do better, namely: to balance the tree, limiting the number of elements in the upper levels, so that they fit on one page (for example, it is 10 at my settings).  Then the path will look like 'Ave-Arts / Aksakov', that is, it will turn out approximately as in the naming of the volumes of the encyclopedia.  Depending on the number of books, additional levels may be needed, of which there should be about a logarithm of the number of authors.  It seems that such a thing is scientifically called a prefix tree.  I have not yet implemented this feature, but simply shortened the initial layout to 'first letter / author'. </li><li>  Sometimes (probably, on broken fb2-files) the script can behave inadequately - it clogs up all the memory and starts swapping.  I did not debug;  it is probably easier for me to rewrite the functionality in a more familiar language than to deal with PHP.  True, I'm not sure that I will get at least to this, especially since I have overtaken almost all of my library, and so far everything is satisfactory. </li><li>  Experimenting with how link files work, I didn‚Äôt immediately understand how file systems are named from the device point of view.  Namely, an external SD card is mounted in / mnt / ext2, and an internal memory is mounted in / mnt / ext1.  (When I experimented, I wrote directly to the internal memory, and the links with '/ mnt / ext2' did not work for me.) This naming is rather counterintuitive - ext2 causes a definite association with the name of the file system (however, vfat is still on the card).  Therefore, when applying the script, it is necessary to remember that it prepares files for the first section of the external card.  Otherwise, in the end you need to do something like this: <br><br> <code>find out_dir/dest/ -name '*.flk' -exec sed -i 's/ext2/ext1/' '{}' \;</code> <br> <br>  I also tried to use relative, rather than absolute flk-links, but they seem to not work at all.  If anyone knows anything about relative links, let them share. <br></li><li>  About copying efficiency.  I did not experience any special problems (only one and a half gig), but there are some considerations for optimization.  First, the idea of ‚Äã‚Äãziping files seems dubious - we have a device with a very slow processor and relatively fast storage media.  Therefore, the time of opening files may deteriorate due to compression.  However, tests are needed here.  Secondly, to speed up pouring onto a card, you can prepare an image of a partition and then copy it onto the card entirely with the dd utility.  How to make an image of a partition on a file I even almost remember - for this you need a losetup utility that turns a file into a device that you can use to mkfs and mount. </li></ol><br><br>  <b>UPD</b> <br><br><h4>  How to copy an image </h4><br>  As a result of the work of the cataloger, a cloud of small files appears, which are then copied for a long time to the file system of the flash drive.  You can try to speed up this process by creating a disk (or even on tmpfs, if you like) copies of the image of a flash drive partition, and then copy the entire image.  The benefit from this is not obvious, because as a result you will have to copy bytes than if you copy by file.  In addition, unnecessary depreciation of the flash drive may increase.  Nevertheless, I present a recipe suitable for any (not too ancient) Linux.  (Commands beginning with a sharp require root's rights, the rest can be made an ordinary user.) <br><br><ol><li>  First, you need to know the exact size of the desired section of the flash drive.  Suppose the device is defined as / dev / sdc: <br><br> <code># fdisk -l /dev/sdc <br> ... <br> Disk /dev/sdc: 4 GB, 4127195136 bytes <br> 64 heads, 32 sectors/track, 3936 cylinders <br> Units = cylinders of 2048 * 512 = 1048576 bytes <br> <br> Device Boot Start End Blocks Id System <br> /dev/sdc1 1 3934 4028400 83 Linux</code> <br> <br>  Here we have a partition size of 4028400 blocks of 512 bytes. <br></li><li>  Next, you need to create a file on disk exactly the same size.  Since the dd utility has the bs (block size) option, we do not even need to multiply 4028400 by 512. However, in this case, the block size does not matter for dd, the main thing is that bs * count is exactly the required size in bytes. <br><br> <code>$ dd if=/dev/zero of=image bs=512 count=4028400</code> <br> </li><li>  Create a file system on the resulting file: <br> <code>$ /sbin/mkdosfs image</code> <br> </li><li>  Mount the image file as a device (this requires the nuclear loop module, which is in the cores of all modern distributions by default), copy the files, unmount: <br> <code>$ mkdir mnt <br> # mount -o loop image mnt <br> # cp -r ...... mnt <br> # umount mnt <br> $ rmdir mnt</code> <br> </li><li>  Now copy the image file to the partition location (it‚Äôs important not to make a mistake with the device name): <br> <code># dd if=image of=/dev/sdc1</code> <br> </li></ol><br>  Done!  You can mount the USB flash drive and make sure that its contents are as expected. <br><br>  It happens that the device has broken blocks, then everything becomes more complicated.  In this case, you can copy the image of the section to a file, instead of creating it again (steps 1-3): <br><br> <code># dd if=/dev/sdc1 of=image conv=noerror</code> <br> <br>  The idea is that the file system stores meta information about its bad blocks, so we can copy the data to the image file, without fear that they will end up on the BB.  However, I did not check it and I can be mistaken. <br><br>  Aerobatics is to keep the current image of the flash drive on a home computer and have a utility that economically copies the <i>difference</i> between the new image and the old one to the USB flash drive. <br><br></div><p>Source: <a href="https://habr.com/ru/post/143847/">https://habr.com/ru/post/143847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143839/index.html">American dream, or Half a year in the top. In the mind</a></li>
<li><a href="../143840/index.html">About the organization of the desktop, works and documents</a></li>
<li><a href="../143842/index.html">Buy a computer with Windows 7 - get Windows 8 for $ 15</a></li>
<li><a href="../143843/index.html">Ultrabook review Acer Aspire S3</a></li>
<li><a href="../143846/index.html">Network on DHCP Option82 - it's just</a></li>
<li><a href="../143848/index.html">Twitter got to user mail</a></li>
<li><a href="../143849/index.html">Offshore Masters</a></li>
<li><a href="../143850/index.html">Are you ready to temporarily transfer access to your main social network account to a third party for a fee?</a></li>
<li><a href="../143851/index.html">Rate your contribution to Facebook</a></li>
<li><a href="../143852/index.html">Yahoo introduced a new analytical tool for advertisers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>