<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>GraalVM: mixed in a bunch of C and Scala</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I don‚Äôt know how you are, but I‚Äôm recently impressed by articles about new Java technologies - Graal, Truffle and everything. It looks as if you had i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>GraalVM: mixed in a bunch of C and Scala</h1><div class="post__text post__text-html js-mediator-article"><p>  I don‚Äôt know how you are, but I‚Äôm recently impressed by articles about new Java technologies - Graal, Truffle and everything.  It looks as if you had invented a language before, wrote an interpreter, was glad which language was good and saddened, which was slow, the native compiler and / or JIT wrote to it, and you still need a debugger ... LLVM is, thanks to that.  After reading <a href="https://habr.com/post/319424/">this article</a> , I got the impression (somewhat grotesque) that after writing a special type of interpreter, the work can, in principle, be completed.  The feeling that now the button "Make it Zashib" has become available to compiler programmers.  No, of course, JIT-languages ‚Äã‚Äãslowly start, they need time to warm up.  But, in the end, the time and qualifications of the programmer are also not free - in what world of information technology would we live if we still wrote everything in assembly language?  No, maybe everything would, of course, fly (this is if the programmer competently laid out the instructions), but I have some doubts about the total complexity of actively used programs ... </p><br><p>  In general, I understand perfectly well that in the dilemma ‚Äútime spent by a programmer vs the ideality of the product received (‚Äú handwork ‚Äù)‚Äù, the border can be moved until the end of the centuries, so let's just try to use the traditional SQLite library today without loading the native code in its pure form.  We will use a ready-made truffle language implementation for LLVM IR, called Sulong. </p><a name="habracut"></a><br><p>  <em><em>Disclaimer:</em> this article should not be viewed as a story by pros to beginners, but as a kind of laboratory work by a novice who is just trying to get comfortable with the technology.</em>  <em>And another thing: LLVM IR cannot be considered completely platform independent.</em> </p><br><p>  So, we will need to take, in fact, the sources of SQLite, write the linking code on <del>  Java </del>  Scala (well, sorry ...), and also get GraalVM with strapping and Clang (with its help we will compile SQLite into LLVM IR, which we will load into our Scala code). </p><br><p>  Immediately make a reservation that everything will happen on Ubuntu 18.04 LTS (64 bit).  With Mac OS X there are no big problems, I want to believe, it will not arise either, but if I have Graal and all its necessary components under Windows, I‚Äôm not sure.  However, even if now is not, probably, will appear later. </p><br><h1 id="podgotovka">  Training </h1><br><ol><li>  We download our experimental rabbit <a href="https://www.sqlite.org/">SQLite</a> (in fact, everything is already in the repository attached to the article). </li><li>  We read the official article <a href="https://www.sqlite.org/quickstart.html">SQLite In 5 Minutes Or Less</a> .  Since SQLite in this case is used only as an example, this is exactly what is needed.  <a href="https://www.sqlite.org/howtocompile.html">How To Compile SQLite is</a> also useful. </li><li> Download GraalVM Community Edition <a href="https://www.graalvm.org/downloads/">from here</a> and unpack it.  I would not recommend to give in to provocations to add him to <code>PATH</code> - why do we need <code>node</code> and <code>lli</code> , identical to natural ones? </li><li>  Install clang - in my case it is Clang 6 from the Ubuntu repository </li></ol><br><p>  Also in my test project, the <a href="https://www.scala-sbt.org/">sbt</a> build system will be used.  To edit the project, I personally prefer the IntelliJ Idea Community with the standard Scala plugin. </p><br><p>  And here I personally started the first rake: on the GraalVM website it is said that this is just a directory with JDK.  Well, if so, then add it to the Idea as a simple JDK.  <em>"1.8"</em> - said Idea.  Hmm, strange.  Go to the console in the directory with the Grail, say <code>bin/javac -version</code> - really 1.8.  Well, eight, so eight - not scary.  The terrible thing is that the <code>org.graal</code> packages and all that Idea does not see, and we will need them.  Well, let's go to <code>File -&gt; Other Settings -&gt; Default Project Structure...</code> , there in the JDK settings we see that in the Classpath there are jar files from <code>jre/lib</code> and <code>jre/lib/ext</code> .  I didn‚Äôt check everything.  But what we supposedly need: </p><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs ruby">trosinenko@trosinenko-<span class="hljs-symbol"><span class="hljs-symbol">pc:</span></span>~<span class="hljs-regexp"><span class="hljs-regexp">/tmp/graal</span></span><span class="hljs-regexp"><span class="hljs-regexp">/graalvm-1.0.0-rc1/jre</span></span><span class="hljs-regexp"><span class="hljs-regexp">/lib$ find . -name '*.jar' ./truffle</span></span><span class="hljs-regexp"><span class="hljs-regexp">/truffle-dsl-processor.jar ./truffle</span></span><span class="hljs-regexp"><span class="hljs-regexp">/truffle-api.jar ./truffle</span></span><span class="hljs-regexp"><span class="hljs-regexp">/truffle-nfi.jar ./truffle</span></span><span class="hljs-regexp"><span class="hljs-regexp">/locator.jar ./truffle</span></span><span class="hljs-regexp"><span class="hljs-regexp">/truffle-tck.jar ./polyglot</span></span><span class="hljs-regexp"><span class="hljs-regexp">/polyglot-native-api.jar ./boot</span></span><span class="hljs-regexp"><span class="hljs-regexp">/graaljs-scriptengine.jar ./boot</span></span><span class="hljs-regexp"><span class="hljs-regexp">/graal-sdk.jar ./management</span></span>-agent.jar ./rt.jar ./jsse.jar ./resources.jar ./jvmci/jvmci-hotspot.jar ./jvmci/graal.jar ./jvmci/jvmci-api.jar ./installer/installer.jar ./ext/cldrdata.jar ./ext/sunjce_provider.jar ./ext/nashorn.jar ./ext/sunec.jar ./ext/zipfs.jar ./ext/sunpkcs11.jar ./ext/jaccess.jar ./ext/localedata.jar ./ext/dnsns.jar ./jce.jar ./svm/builder/objectfile.jar ./svm/builder/svm.jar ./svm/builder/pointsto.jar ./svm/library-support.jar ./graalvm/svm-driver.jar ./graalvm/launcher-common.jar ./graalvm/sulong-launcher.jar ./graalvm/graaljs-launcher.jar ./charsets.jar ./jvmci-services.jar ./security/policy/unlimited/US_export_policy.jar ./security/policy/unlimited/local_policy.jar ./security/policy/limited/US_export_policy.jar ./security/policy/limited/local_policy.jar</code> </pre> </div></div><br><p>  From the total listing, we see some more subdirectories, and, judging by what was added for the usual JDK, <code>./security</code> does not interest us.  In this case, using the method "" + "- unfolded-directory-shift-click-click, OK" add the contents of the subdirectories <code>truffle</code> , <code>polyglot</code> , <code>boot</code> and <code>graalvm</code> .  If something is not found later - we will add more - it‚Äôs something everyday ... </p><br><h1 id="sozdayom-proekt-na-scala">  We create the project on Scala </h1><br><p>  So <em>it seems</em> , the idea has been customized.  Let's try to create a sbt-project.  Actually, there are no pitfalls, everything is intuitive, the main thing is not to forget to specify our new JDK. </p><br><p>  Now just create a new scala file and <del>  copy-paste </del>  we creatively process the code written in <a href="https://www.graalvm.org/docs/reference-manual/polyglot/">Polyglot reference</a> in the <code>Start Language Java</code> section of <code>Start Language Java</code> by clicking in Target Language - LLVM. </p><br><p>  <em>By the way, I recommend to pay attention to the abundance of other Start Language: JavaScript, R, Ruby and even just C, but this is a completely different story, which I haven‚Äôt read yet ...</em> </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQLiteTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> polyglot = <span class="hljs-type"><span class="hljs-type">Context</span></span>.newBuilder().allowAllAccess(<span class="hljs-literal"><span class="hljs-literal">true</span></span>).build() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> file: <span class="hljs-type"><span class="hljs-type">File</span></span> = ??? <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> source = <span class="hljs-type"><span class="hljs-type">Source</span></span>.newBuilder(<span class="hljs-string"><span class="hljs-string">"llvm"</span></span>, file).build() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cpart = polyglot.eval(source) ??? }</code> </pre> <br><p>  We will not inherit our <code>object</code> from <code>App</code> or make the fields private - then you can access them from the Scala-console (its configuration has already been added to the project). </p><br><p>  As a result, we almost (by as much as 80%) rolled over an example from as many as five meaningful lines - it's time to sit back and read at last <del>  what did we write </del>  Javadoc, especially since just calling <code>main()</code> is somehow boring, and in general, our model example is SQLite, so you need to understand what to write instead of the fifth line.  Polyglot reference is fine, but API documentation is needed.  To find it, you need to walk around the repository, there is a <a href="">readme</a> , and in them there are <a href="http://www.graalvm.org/sdk/javadoc/org/graalvm/polyglot/package-summary.html">links to Javadoc</a> . </p><br><p>  <em>In the meantime, the meaning of what was written to us is not yet clear, ask JS. The answer to the Main Question: choose the Scala console configuration in the Idea, and ...</em> </p><br><pre> <code class="hljs vhdl">scala&gt; import org.graalvm.polyglot.<span class="hljs-keyword"><span class="hljs-keyword">Context</span></span> val polyglot = <span class="hljs-keyword"><span class="hljs-keyword">Context</span></span>.newBuilder().allowAllAccess(<span class="hljs-literal"><span class="hljs-literal">true</span></span>).build() polyglot.eval(<span class="hljs-string"><span class="hljs-string">"js"</span></span>, <span class="hljs-string"><span class="hljs-string">"6 * 7"</span></span>) import org.graalvm.polyglot.<span class="hljs-keyword"><span class="hljs-keyword">Context</span></span> scala&gt; polyglot: org.graalvm.polyglot.<span class="hljs-keyword"><span class="hljs-keyword">Context</span></span> = org.graalvm.polyglot.<span class="hljs-keyword"><span class="hljs-keyword">Context</span></span>@<span class="hljs-number"><span class="hljs-number">68e24</span></span>e7 scala&gt; res0: org.graalvm.polyglot.Value = <span class="hljs-number"><span class="hljs-number">42</span></span></code> </pre> <br><p>  <em>... well, it works, the answer is.</em>  <em>And leave the question as an exercise for the reader.</em> </p><br><p>  Let's go back to the example code.  The variable <code>polyglot</code> contains a context in which different languages ‚Äã‚Äãlive - someone is turned off, someone is turned on, and someone has even been lazily initialized.  In this harsh world, even for accessing files, you need to ask for permission, so in the example we simply <a href="http://www.graalvm.org/sdk/javadoc/org/graalvm/polyglot/Context.Builder.html">disable the restrictions</a> using <code>allowAllAccess(true)</code> . </p><br><p>  Next we create a Source object with our LLVM bitcode.  We indicate the language and file from which to download this "source code".  You can also use the source line itself (we have already seen this), the URL (including from resources in the JAR file), and just an instance of <code>java.io.Reader</code> .  Next, we calculate the resulting source in the context, and get the <a href="http://www.graalvm.org/sdk/javadoc/org/graalvm/polyglot/Value.html">Value</a> .  In accordance with the documentation for this method, we will never get <code>null</code> , but there is a <code>Value</code> , which is a <code>Null</code> .  But we still need to download something specific, so ... </p><br><h1 id="sobiraem-sqlite">  We collected SQLite </h1><br><p>  <em>... but for a replacement for fopen ()</em> <em><br></em>  <em>- From <a href="https://www.sqlite.org/about.html">About SQLite</a> .</em>  <em>As you can see, letting run SQLite in GraalVM was not a terrible mistake for developers.</em> </p><br><p>  On the advice of the already <a href="https://www.sqlite.org/howtocompile.html">mentioned</a> part of the documentation SQLite, as well as <a href="https://www.graalvm.org/docs/getting-started/">instructions Graal</a> draw up a command line.  Here she is: </p><br><pre> <code class="hljs tex">clang -g -c -O1 -emit-llvm sqlite3. <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>-DSQLITE_OMIT_LOAD_EXTENSION <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>-DSQLITE_THREADSAFE=0 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>-o ../../sqlite3.bc</code> </pre> <br><p>  <code>-O1</code> least <code>-O1</code> is required for the correct operation of the code inside Sulong, <code>-g</code> save us the names (for these two, as well as other options, see <a href="https://www.graalvm.org/docs/reference-manual/languages/llvm/">the documentation</a> for details), we use <code>SQLITE_OMIT_LOAD_EXTENSION</code> not to depend on <code>libdl.so</code> in our test example ( how we would do it, it is not clear from the start), and since it is not clear how to link with pthread, and why, we disable thread safety (otherwise it will fail with startup).  That's all. </p><br><h1 id="zapuskaem-nash-proekt">  We start our project </h1><br><p>  Now we have what to write in the second line: </p><br><pre> <code class="hljs vhdl"> val <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">File</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">File</span></span>(<span class="hljs-string"><span class="hljs-string">"./sqlite3.bc"</span></span>)</code> </pre> <br><p>  Now we can pull the necessary functions from the library: </p><br><pre> <code class="scala hljs"> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sqliteOpen = cpart.getMember(<span class="hljs-string"><span class="hljs-string">"sqlite3_open"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sqliteExec = cpart.getMember(<span class="hljs-string"><span class="hljs-string">"sqlite3_exec"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sqliteClose = cpart.getMember(<span class="hljs-string"><span class="hljs-string">"sqlite3_close"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sqliteFree = cpart.getMember(<span class="hljs-string"><span class="hljs-string">"sqlite3_free"</span></span>)</code> </pre> <br><p>  And it works - it remains only to call them in the correct order - and that‚Äôs all!  Well, for example, <code>sqlite3_open</code> requires a string with the file name and a pointer to a pointer to a structure (the insides of which do not interest us at all from the word).  Hmm ... and how to form the second argument?  The function of creating pointers is needed - probably, it is Sulong-specific.  Add <code>sulong.jar</code> to Classpath, restart the entire sbt shell.  And nothing.  Whether long, shortly, did not find anything smarter to create the <code>lib</code> directory in the root of the sbt project (the standard directory for unmanaged jars) and execute in it </p><br><pre> <code class="hljs pgsql">find ../../graalvm<span class="hljs-number"><span class="hljs-number">-1.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>-rc1/jre/languages/ -<span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-string"><span class="hljs-string">'*.jar'</span></span> -exec ln -s {} . \;</code> </pre> <br><p>  After sbt refresh compilation completed successfully.  That just does not start anything ... Well, we return the Classpath in place.  In general, I thought I would finish the fifth line.  Well, I‚Äôll retell Javadoc for each of the five, it‚Äôs a small article, and everyone will say: ‚ÄúDo we have Twitter here or what?‚Äù ... </p><br><p>  Probably three hours passed, and I tried to wrap the second argument of the <code>sqlite3_open</code> function ... </p><br><p>  At some point it dawned on me: it‚Äôs necessary, like in a joke: ‚ÄúWhat are you starting with‚Äú War and Peace ‚Äù, read‚Äú Kolobok ‚Äù- just for your level‚Äù ... So <code>sqlite3.c</code> temporarily replaced with <code>test.c</code> </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *x</span></span></span><span class="hljs-function">)</span></span> { *x = <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> </pre> <br><p>  Having stumbled a little more into all sorts of API type conversion APIs of varying degrees of privacy, I was tired to say the least.  In my head there were only anecdotes.  For example: "iOS is an intuitive system. To understand it, logic is powerless ‚Äî intuition is needed."  And indeed, what is the main principle of GraalVM and of all this ‚Äî everything should be transparent and relaxed, so you should reject the slightest experience with FFI and think like a developer of a convenient system.  We need a container with int.  Pass <code>new java.lang.Integer(0)</code> - write to the zero address.  But what we were taught on the basics of C: the difference between the array and the pointer to the zero element is very conditional.  In fact, the function <code>f</code> simply takes an array of ints and writes a value to the zero element.  We try: </p><br><pre> <code class="scala hljs">scala&gt; <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> x = <span class="hljs-type"><span class="hljs-type">Array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> java.lang.<span class="hljs-type"><span class="hljs-type">Integer</span></span>(<span class="hljs-number"><span class="hljs-number">12</span></span>)) x: <span class="hljs-type"><span class="hljs-type">Array</span></span>[<span class="hljs-type"><span class="hljs-type">Integer</span></span>] = <span class="hljs-type"><span class="hljs-type">Array</span></span>(<span class="hljs-number"><span class="hljs-number">12</span></span>) scala&gt; <span class="hljs-type"><span class="hljs-type">SQLiteTest</span></span>.cpart.getMember(<span class="hljs-string"><span class="hljs-string">"f"</span></span>).execute(x) res0: org.graalvm.polyglot.<span class="hljs-type"><span class="hljs-type">Value</span></span> = <span class="hljs-type"><span class="hljs-type">LLVMTruffleObject</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>) scala&gt; x res1: <span class="hljs-type"><span class="hljs-type">Array</span></span>[<span class="hljs-type"><span class="hljs-type">Integer</span></span>] = <span class="hljs-type"><span class="hljs-type">Array</span></span>(<span class="hljs-number"><span class="hljs-number">42</span></span>)</code> </pre> <br><p>  <strong>TADAM !!!</strong> </p><br><p>  Here, it would seem, to quickly write the <code>query</code> function and finish on this, but whatever you pass as the second argument: neither <code>Array(new Object)</code> or <code>Array(Array(new Object))</code> - it refuses to work, cursing at <code>strlen</code> inside LLVM- bitcode O_O (by the way, LLVM IR, in contrast to the usual machine code from so-ki is quite a typed). </p><br><p>  Even later, I stopped throwing away the idea that just passing to <code>execute()</code> as the first argument <code>java.lang.String</code> and even <code>Array[Byte]</code> is too intuitive, and reworking our <code>void f()</code> confirmed this. </p><br><p>  As a result, in the built-in Sulong binding ( <code>SQLiteTest.polyglot.getBindings("llvm")</code> ), a function with a promising name <code>__sulong_byte_array_to_native</code> was found.  We try: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> str = <span class="hljs-type"><span class="hljs-type">SQLiteTest</span></span>.polyglot.getBindings(<span class="hljs-string"><span class="hljs-string">"llvm"</span></span>) .getMember(<span class="hljs-string"><span class="hljs-string">"__sulong_byte_array_to_native"</span></span>) .execute(<span class="hljs-string"><span class="hljs-string">"toc.db"</span></span>.getBytes) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Array</span></span>[<span class="hljs-type"><span class="hljs-type">Object</span></span>](<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-type"><span class="hljs-type">SQLiteTest</span></span>.sqliteOpen.execute(str, db) scala&gt; str: org.graalvm.polyglot.<span class="hljs-type"><span class="hljs-type">Value</span></span> = <span class="hljs-type"><span class="hljs-type">LLVMTruffleObject</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>:<span class="hljs-number"><span class="hljs-number">139990504321152</span></span>) scala&gt; db: <span class="hljs-type"><span class="hljs-type">Array</span></span>[<span class="hljs-type"><span class="hljs-type">Object</span></span>] = <span class="hljs-type"><span class="hljs-type">Array</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>) scala&gt; res0: org.graalvm.polyglot.<span class="hljs-type"><span class="hljs-type">Value</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> scala&gt; <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> str = <span class="hljs-type"><span class="hljs-type">SQLiteTest</span></span>.polyglot.getBindings(<span class="hljs-string"><span class="hljs-string">"llvm"</span></span>) .getMember(<span class="hljs-string"><span class="hljs-string">"__sulong_byte_array_to_native"</span></span>) .execute(<span class="hljs-string"><span class="hljs-string">"toc123.db"</span></span>.getBytes) <span class="hljs-type"><span class="hljs-type">SQLiteTest</span></span>.sqliteOpen.execute(str, db) str: org.graalvm.polyglot.<span class="hljs-type"><span class="hljs-type">Value</span></span> = <span class="hljs-type"><span class="hljs-type">LLVMTruffleObject</span></span>(<span class="hljs-literal"><span class="hljs-literal">null</span></span>:<span class="hljs-number"><span class="hljs-number">139990517528064</span></span>) scala&gt; res1: org.graalvm.polyglot.<span class="hljs-type"><span class="hljs-type">Value</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Works!!!  Oh, why does it work with the wrong file name too? .. with bated breath, we look into the project directory - and there is already a new one <code>toc123.db</code> .  Hooray! </p><br><p>  So, let's rewrite an example from the SQLite documentation on Scala: </p><br><pre> <code class="scala hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">query</span></span></span></span>(dbFile: <span class="hljs-type"><span class="hljs-type">String</span></span>, queryString: <span class="hljs-type"><span class="hljs-type">String</span></span>): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> filenameStr = toCString(dbFile) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> ptrToDb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Array</span></span>[<span class="hljs-type"><span class="hljs-type">Object</span></span>](<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> rc = sqliteOpen.execute(filenameStr, ptrToDb) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> db = ptrToDb.head <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rc.asInt() != <span class="hljs-number"><span class="hljs-number">0</span></span>) { println(<span class="hljs-string"><span class="hljs-string">s"Cannot open </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$dbFile</span></span></span><span class="hljs-string">: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${sqliteErrmsg.execute(db)}</span></span></span><span class="hljs-string">!"</span></span>) sqliteClose.execute(db) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> zErrMsg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Array</span></span>[<span class="hljs-type"><span class="hljs-type">Object</span></span>](<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> execRc = sqliteExec.execute(db, toCString(queryString), ???, zErrMsg) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (execRc.asInt != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> errorMessage = zErrMsg.head.asInstanceOf[<span class="hljs-type"><span class="hljs-type">Value</span></span>] assert(errorMessage.isString) println(<span class="hljs-string"><span class="hljs-string">s"Cannot execute query: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${errorMessage.asString}</span></span></span><span class="hljs-string">"</span></span>) sqliteFree.execute(errorMessage) } sqliteClose.executeVoid(db) } }</code> </pre> <br><p>  Here is just one catch - a callback.  Well, when no one sees, a student engineer describes a core made of wood, and I will try to write a callback in JavaScript: </p><br><pre> <code class="scala hljs"> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> callback = polyglot.eval(<span class="hljs-string"><span class="hljs-string">"js"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"function(unused, argc, argv, azColName) { | print("</span></span>argc = <span class="hljs-string"><span class="hljs-string">" + argc); | print("</span></span>argv = <span class="hljs-string"><span class="hljs-string">" + argv); | print("</span></span>azColName = <span class="hljs-string"><span class="hljs-string">" + azColName); | return 0; |} "</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>.stripMargin) <span class="hljs-comment"><span class="hljs-comment">// ... val execRc = sqliteExec.execute(db, toCString(queryString), callback, Int.box(0), zErrMsg)</span></span></code> </pre> <br><p>  And here is what we get: </p><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">io</span></span>.github.trosinenko.<span class="hljs-type"><span class="hljs-type">SQLiteTest</span></span>.query(<span class="hljs-string"><span class="hljs-string">"toc.db"</span></span>, <span class="hljs-string"><span class="hljs-string">"select * from toc;"</span></span>) argc = <span class="hljs-number"><span class="hljs-number">5</span></span> argv = <span class="hljs-keyword"><span class="hljs-keyword">foreign</span></span> {} azColName = <span class="hljs-keyword"><span class="hljs-keyword">foreign</span></span> {} argc = 5 argv = <span class="hljs-keyword"><span class="hljs-keyword">foreign</span></span> {} azColName = <span class="hljs-keyword"><span class="hljs-keyword">foreign</span></span> {} argc = 5 argv = <span class="hljs-keyword"><span class="hljs-keyword">foreign</span></span> {} azColName = <span class="hljs-keyword"><span class="hljs-keyword">foreign</span></span> {}</code> </pre> <br><p>  Well, magic is not enough.  In addition, it turns out that in case of an error in <code>zErrMsg</code> is some kind of incomprehensible object, which itself is not convertible into a string.  Well, <code>lib.bc</code> and load <code>lib.bc</code> , and in its source code <code>lib.c</code> we write the following: </p><br><pre> <code class="hljs rust">#include &lt;polyglot.h&gt; void *fromCString(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> polyglot_from_string(<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>); }</code> </pre> <br><p>  Why <code>polyglot_from_string</code> inaccessible right through bindings, I did not understand, so we‚Äôll get it out and make a harness: </p><br><pre> <code class="scala hljs"> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> lib_fromCString = lib.getMember(<span class="hljs-string"><span class="hljs-string">"fromCString"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromCString</span></span></span></span>(ptr: <span class="hljs-type"><span class="hljs-type">Value</span></span>): <span class="hljs-type"><span class="hljs-type">String</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptr.isNull) <span class="hljs-string"><span class="hljs-string">"&lt;null&gt;"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> lib_fromCString.execute(ptr).asString() }</code> </pre> <br><p>  Well, with the return of error messages sorted out, but the callback, let's still write on Scala: </p><br><pre> <code class="scala hljs"> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> lib_copyToArray = lib.getMember(<span class="hljs-string"><span class="hljs-string">"copy_to_array_from_pointers"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> callback = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">ProxyExecutable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span></span>(arguments: <span class="hljs-type"><span class="hljs-type">Value</span></span>*): <span class="hljs-type"><span class="hljs-type">AnyRef</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> argc = arguments(<span class="hljs-number"><span class="hljs-number">1</span></span>).asInt() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> xargv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Array</span></span>[<span class="hljs-type"><span class="hljs-type">Long</span></span>](argc) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> xazColName = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Array</span></span>[<span class="hljs-type"><span class="hljs-type">Long</span></span>](argc) lib_copyToArray.execute(xargv, arguments(<span class="hljs-number"><span class="hljs-number">2</span></span>)) lib_copyToArray.execute(xazColName, arguments(<span class="hljs-number"><span class="hljs-number">3</span></span>)) (<span class="hljs-number"><span class="hljs-number">0</span></span> until argc) foreach { i =&gt; <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> name = fromCString(polyglot.asValue(xazColName(i) ^ <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> value = fromCString(polyglot.asValue(xargv(i) ^ <span class="hljs-number"><span class="hljs-number">1</span></span>)) println(<span class="hljs-string"><span class="hljs-string">s"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$name</span></span></span><span class="hljs-string"> = </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$value</span></span></span><span class="hljs-string">"</span></span>) } println(<span class="hljs-string"><span class="hljs-string">"========================"</span></span>) <span class="hljs-type"><span class="hljs-type">Int</span></span>.box(<span class="hljs-number"><span class="hljs-number">0</span></span>) } }</code> </pre> <br><p>  At the same time, in our <code>lib.c</code> we will add this sort of transfer magic from the sish array to Polyglot: </p><br><pre> <code class="hljs matlab">void copy_to_array_from_pointers(void *arr, void **ptrs) { int <span class="hljs-built_in"><span class="hljs-built_in">size</span></span> = polyglot_get_array_size(arr); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; <span class="hljs-built_in"><span class="hljs-built_in">size</span></span>; ++<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>) { polyglot_set_array_element(arr, <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>, ((uintptr_t)ptrs[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>]) ^ <span class="hljs-number"><span class="hljs-number">1</span></span>); } }</code> </pre><br><p>  Pay attention to <em>the ^ 1 pointer</em> - you need this because someone is too clever: namely, <code>polyglot_set_array_element</code> is a variadic-function with exactly three arguments, which accepts both primitive types and pointers to Polyglot values.  As a result, it works: </p><br><pre> <code class="scala hljs">io.github.atrosinenko.<span class="hljs-type"><span class="hljs-type">SQLiteTest</span></span>.query(<span class="hljs-string"><span class="hljs-string">"toc.db"</span></span>, <span class="hljs-string"><span class="hljs-string">"select * from toc;"</span></span>) name = sqlite3 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span> title = <span class="hljs-type"><span class="hljs-type">Database</span></span> <span class="hljs-type"><span class="hljs-type">Connection</span></span> <span class="hljs-type"><span class="hljs-type">Handle</span></span> uri = c3ref/sqlite3.html ======================== name = sqlite3_int64 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span> title = <span class="hljs-number"><span class="hljs-number">64</span></span>-<span class="hljs-type"><span class="hljs-type">Bit</span></span> <span class="hljs-type"><span class="hljs-type">Integer</span></span> <span class="hljs-type"><span class="hljs-type">Types</span></span> uri = c3ref/int64.html ======================== name = sqlite3_uint64 <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span> title = <span class="hljs-number"><span class="hljs-number">64</span></span>-<span class="hljs-type"><span class="hljs-type">Bit</span></span> <span class="hljs-type"><span class="hljs-type">Integer</span></span> <span class="hljs-type"><span class="hljs-type">Types</span></span> uri = c3ref/int64.html ======================== ...</code> </pre> <br><p>  It remains to add the <code>main</code> method: </p><br><pre> <code class="scala hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>(args: <span class="hljs-type"><span class="hljs-type">Array</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>]): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = { query(args(<span class="hljs-number"><span class="hljs-number">0</span></span>), args(<span class="hljs-number"><span class="hljs-number">1</span></span>)) polyglot.close() }</code> </pre> <br><p>  in which, in fact, the context needs to be closed, but I did not do this in the object itself, because after initializing <code>SQLiteTest</code> we, of course, still need it for the Scala console. </p><br><p>  This concludes my story, and the reader proposes: </p><br><ol><li>  Trying to compile it all with the help of SubstrateVM in the native binary, as if there was no Scala here </li><li>  (*) Do the same, but with profile guided optimization </li></ol><br><p>  The resulting files: </p><br><div class="spoiler">  <b class="spoiler_title">SQLiteTest.scala</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> io.github.atrosinenko <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.<span class="hljs-type"><span class="hljs-type">File</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.graalvm.polyglot.proxy.<span class="hljs-type"><span class="hljs-type">ProxyExecutable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.graalvm.polyglot.{<span class="hljs-type"><span class="hljs-type">Context</span></span>, <span class="hljs-type"><span class="hljs-type">Source</span></span>, <span class="hljs-type"><span class="hljs-type">Value</span></span>} <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQLiteTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> polyglot: <span class="hljs-type"><span class="hljs-type">Context</span></span> = <span class="hljs-type"><span class="hljs-type">Context</span></span>.newBuilder().allowAllAccess(<span class="hljs-literal"><span class="hljs-literal">true</span></span>).build() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadBcFile</span></span></span></span>(file: <span class="hljs-type"><span class="hljs-type">File</span></span>): <span class="hljs-type"><span class="hljs-type">Value</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> source = <span class="hljs-type"><span class="hljs-type">Source</span></span>.newBuilder(<span class="hljs-string"><span class="hljs-string">"llvm"</span></span>, file).build() polyglot.eval(source) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cpart: <span class="hljs-type"><span class="hljs-type">Value</span></span> = loadBcFile(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">File</span></span>(<span class="hljs-string"><span class="hljs-string">"./sqlite3.bc"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> lib: <span class="hljs-type"><span class="hljs-type">Value</span></span> = loadBcFile(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">File</span></span>(<span class="hljs-string"><span class="hljs-string">"./lib.bc"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sqliteOpen: <span class="hljs-type"><span class="hljs-type">Value</span></span> = cpart.getMember(<span class="hljs-string"><span class="hljs-string">"sqlite3_open"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sqliteExec: <span class="hljs-type"><span class="hljs-type">Value</span></span> = cpart.getMember(<span class="hljs-string"><span class="hljs-string">"sqlite3_exec"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sqliteErrmsg: <span class="hljs-type"><span class="hljs-type">Value</span></span> = cpart.getMember(<span class="hljs-string"><span class="hljs-string">"sqlite3_errmsg"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sqliteClose: <span class="hljs-type"><span class="hljs-type">Value</span></span> = cpart.getMember(<span class="hljs-string"><span class="hljs-string">"sqlite3_close"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sqliteFree: <span class="hljs-type"><span class="hljs-type">Value</span></span> = cpart.getMember(<span class="hljs-string"><span class="hljs-string">"sqlite3_free"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> bytesToNative: <span class="hljs-type"><span class="hljs-type">Value</span></span> = polyglot.getBindings(<span class="hljs-string"><span class="hljs-string">"llvm"</span></span>).getMember(<span class="hljs-string"><span class="hljs-string">"__sulong_byte_array_to_native"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toCString</span></span></span></span>(str: <span class="hljs-type"><span class="hljs-type">String</span></span>): <span class="hljs-type"><span class="hljs-type">Value</span></span> = { bytesToNative.execute(str.getBytes()) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> lib_fromCString: <span class="hljs-type"><span class="hljs-type">Value</span></span> = lib.getMember(<span class="hljs-string"><span class="hljs-string">"fromCString"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromCString</span></span></span></span>(ptr: <span class="hljs-type"><span class="hljs-type">Value</span></span>): <span class="hljs-type"><span class="hljs-type">String</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptr.isNull) <span class="hljs-string"><span class="hljs-string">"&lt;null&gt;"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> lib_fromCString.execute(ptr).asString() } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> lib_copyToArray: <span class="hljs-type"><span class="hljs-type">Value</span></span> = lib.getMember(<span class="hljs-string"><span class="hljs-string">"copy_to_array_from_pointers"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> callback: <span class="hljs-type"><span class="hljs-type">ProxyExecutable</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">ProxyExecutable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span></span>(arguments: <span class="hljs-type"><span class="hljs-type">Value</span></span>*): <span class="hljs-type"><span class="hljs-type">AnyRef</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> argc = arguments(<span class="hljs-number"><span class="hljs-number">1</span></span>).asInt() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> xargv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Array</span></span>[<span class="hljs-type"><span class="hljs-type">Long</span></span>](argc) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> xazColName = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Array</span></span>[<span class="hljs-type"><span class="hljs-type">Long</span></span>](argc) lib_copyToArray.execute(xargv, arguments(<span class="hljs-number"><span class="hljs-number">2</span></span>)) lib_copyToArray.execute(xazColName, arguments(<span class="hljs-number"><span class="hljs-number">3</span></span>)) (<span class="hljs-number"><span class="hljs-number">0</span></span> until argc) foreach { i =&gt; <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> name = fromCString(polyglot.asValue(xazColName(i) ^ <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> value = fromCString(polyglot.asValue(xargv(i) ^ <span class="hljs-number"><span class="hljs-number">1</span></span>)) println(<span class="hljs-string"><span class="hljs-string">s"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$name</span></span></span><span class="hljs-string"> = </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$value</span></span></span><span class="hljs-string">"</span></span>) } println(<span class="hljs-string"><span class="hljs-string">"========================"</span></span>) <span class="hljs-type"><span class="hljs-type">Int</span></span>.box(<span class="hljs-number"><span class="hljs-number">0</span></span>) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">query</span></span></span></span>(dbFile: <span class="hljs-type"><span class="hljs-type">String</span></span>, queryString: <span class="hljs-type"><span class="hljs-type">String</span></span>): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> filenameStr = toCString(dbFile) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> ptrToDb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Array</span></span>[<span class="hljs-type"><span class="hljs-type">Object</span></span>](<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> rc = sqliteOpen.execute(filenameStr, ptrToDb) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> db = ptrToDb.head <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rc.asInt() != <span class="hljs-number"><span class="hljs-number">0</span></span>) { println(<span class="hljs-string"><span class="hljs-string">s"Cannot open </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$dbFile</span></span></span><span class="hljs-string">: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${fromCString(sqliteErrmsg.execute(db))}</span></span></span><span class="hljs-string">!"</span></span>) sqliteClose.execute(db) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> zErrMsg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Array</span></span>[<span class="hljs-type"><span class="hljs-type">Object</span></span>](<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> execRc = sqliteExec.execute(db, toCString(queryString), callback, <span class="hljs-type"><span class="hljs-type">Int</span></span>.box(<span class="hljs-number"><span class="hljs-number">0</span></span>), zErrMsg) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (execRc.asInt != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> errorMessage = zErrMsg.head.asInstanceOf[<span class="hljs-type"><span class="hljs-type">Value</span></span>] println(<span class="hljs-string"><span class="hljs-string">s"Cannot execute query: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${fromCString(errorMessage)}</span></span></span><span class="hljs-string">"</span></span>) sqliteFree.execute(errorMessage) } sqliteClose.execute(db) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>(args: <span class="hljs-type"><span class="hljs-type">Array</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>]): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = { query(args(<span class="hljs-number"><span class="hljs-number">0</span></span>), args(<span class="hljs-number"><span class="hljs-number">1</span></span>)) polyglot.close() } }</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">lib.c</b> <div class="spoiler_text"><pre> <code class="hljs mel">#include &lt;polyglot.h&gt; void *fromCString(const char *str) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> polyglot_from_string(str, <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>); } void copy_to_array_from_pointers(void *arr, void **ptrs) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> = polyglot_get_array_size(arr); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>; ++i) { polyglot_set_array_element(arr, i, ((uintptr_t)ptrs[i]) ^ <span class="hljs-number"><span class="hljs-number">1</span></span>); } }</code> </pre></div></div><br><p>  <a href="https://github.com/atrosinenko/graalvm-llvm-example">Link to the repository</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/358700/">https://habr.com/ru/post/358700/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358690/index.html">We pack in containers, deploy, monitor - the program Root Conf</a></li>
<li><a href="../358692/index.html">Selection: 6 open frameworks for creating backtesters of trading strategies in Python</a></li>
<li><a href="../358694/index.html">UPD Broadcast. We invite you to the New PostgreSQL 11 features mitap</a></li>
<li><a href="../358696/index.html">We update Angular to the 6th version in the project without use of CLI</a></li>
<li><a href="../358698/index.html">13 interesting points from the javascript style guide from google</a></li>
<li><a href="../358702/index.html">How to run dynamic retargeting effectively in a mobile application</a></li>
<li><a href="../358704/index.html">Dirty tricks video game developers</a></li>
<li><a href="../358706/index.html">Applications for Tarantool. Part 3. Testing and launch</a></li>
<li><a href="../358708/index.html">Frontend 2018: the variety of frameworks and the lack of middles</a></li>
<li><a href="../358710/index.html">Q & A Explorer. April feature for Power BI Desktop</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>