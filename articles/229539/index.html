<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Get Zabbix statistics from Kyocera devices</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! 
 From such a seemingly uncomplicated Kyocera device, I wanted to receive various statistics on the use of the printer and scanner. It would ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Get Zabbix statistics from Kyocera devices</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/fe6/a3f/2db/fe6a3f2db5514500587caa30e915b21c.png"><br><h5>  Hi Habr! </h5><br>  From such a seemingly uncomplicated Kyocera device, I wanted to receive various statistics on the use of the printer and scanner.  It would seem that everything is simple: we take SNMP and get, but ... <a name="habracut"></a><br><br><h5>  SNMP </h5><br>  Making sure that our device gives something via SNMP, I went to Google to find the <a href="http://ru.wikipedia.org/wiki/Management_Information_Base">MIB</a> for our device.  However, it was possible to find information only about the fact that it does not exist.  Kyocera does not want to share such information, for some reason.  Naturally, the idea of ‚Äã‚Äãa slightly routine search for the necessary values ‚Äã‚Äãon your own comes to mind.  The algorithm is not the most difficult - snmpwalk, print, snmpwalk, diff. <br>  Here is what was found: <br><br> <code>user@host:~# snmpwalk -v 2c -c public 192.168.101.239</code> <br> <code>iso.3.6.1.2.1.43.10.2.1.4.1.1 = Counter32: 242</code> <br> <br>  And here is the first oddity: the value is somewhat different from that specified in the web panel of the device itself (and in the printer menu): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/f2b/2e3/e9d/f2b2e3e9d3cc8a2049c4831a140c9a6b.png"><br><br>  Search in SNMP-issue of numbers, at least somewhat similar to what is written in the web panel of the device did not give the slightest result.  Attempts to catch a change in a counter, such as a scan, have failed.  Nothing has changed.  There was a slight suspicion that the necessary data through SNMP is simply not available. <br>  But if there are values, it means someone needs it!  It turns out that Kyocera has its own software for monitoring and controlling their devices - <a href="http://www.kyoceradocumentsolutions.eu/index/document_solutions/networkdevicemanagement/KYOCERA_Net_Viewer.html">KYOCERA Net Viewer.</a> <br>  Fill out an application form, enter an email, get an email with a one-time link ... You should know why such difficulties, but oh well. <br>  The program is quite simple and shows us the same numbers as in the web muzzle.  And if she gets them like that, then we can. <br>  The first to come to my mind was the Wireshark combine, so I will use it. <br><br>  And here weird number two: in addition to sharing SNMP traffic, we also have HTTP here! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/72b/c47/cf9/72bc47cf913a900be3aa1f39dcd1d96d.png"><br><br><h5>  HTTP </h5><br>  Further investigation leads us to the fact that the printer and software communicate XML'kami through <a href="http://ru.wikipedia.org/wiki/SOAP">SOAP.</a> <br>  The principle is very simple: POST request a special XML is sent to the printer containing the request.  In our case, the request is ‚ÄúALL_COUNTER‚Äù, that is, we want to get all the counters.  The printer may, in response, send meter readings or the message ‚ÄúDEEP_SLEEP_NOW_ERROR‚Äù, which is understandable from without translation.  Waking up the printer is somehow not at all necessary.  He already woke up from our request, just send the request again and get the XML with counters. <br>  All values ‚Äã‚Äãare specified as &lt;parameter&gt; number &lt;/ parameter&gt;.  We make a small parser and get a <a href="http://pastebin.com/s6mxds4L">script</a> ( <a href="http://paste.ubuntu.com/7787902/">mirror</a> ), giving us the necessary numbers in a convenient form. <br><br>  For <a href="http://www.kyoceradocumentsolutions.eu/index/products/product/ecosysm2535dn.html">M2535dn</a> I was interested in the following counters: <br><ul><li>  <b>accounting_print_black_and_white_copy_counter</b> : Number of b / w pages printed using a copier </li><li>  <b>accounting_print_black_and_white_printer_counter</b> : Number of b / w pages printed using a printer </li><li>  <b>accounting_print_combine_none_counter</b> : General counter of printed pages </li><li>  <b>accounting_scan_copy_counter</b> : Number of pages scanned using a copier </li><li>  <b>accounting_scan_other_counter</b> : Number of other scanned pages (on a USB flash drive, network, etc.) </li><li>  <b>device_life_counter</b> : (?) Total count of printed pages over the entire life of the device </li></ul><br>  The difference in metering of <b>accounting_scan_copy_counter</b> and <b>accounting_print_black_and_white_copy_counter</b> is simple: 2 copies of one original were made.  One page went to the copier from the scanner, and the printer from the copier printed two.  In addition to these counters, you can get a lot more interesting things: the number of printed A4, a5, letter and other pages, the number of pages printed using duplex, copied in 2in1 and 4in1 modes, for color devices you can get the number of color-and-color and color copies separately .  The <b>device_life_counter</b> counter <b>gives the</b> printer to us via SNMP, but this value is not displayed either in the web interface or in special software.  I did not quite understand the meaning of this parameter.  Yesterday it was different from the total counter by 3, today it is already 8. I am waiting for your ideas in the comments. <br><br><h5>  Zabbix </h5><br>  Now you need to connect it to our monitoring in Zabbix.  We will use <a href="https://www.zabbix.com/documentation/ru/2.0/manual/config/items/itemtypes/external">external verification.</a>  The script must be placed in the <a href="https://www.zabbix.com/documentation/ru/2.0/manual/appendix/config/zabbix_server">ExternalScripts</a> directory, given the right to execute and slightly increase the timeout for running scripts, by default it is 3s: <br><br> <code>user@host:~# cat /etc/zabbix/zabbix_server.conf | grep Timeout | grep -v ^#</code> <br> <code>Timeout=10</code> <br> <br>  It now remains to figure out a new template and fill it with data elements: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1dc/af1/181/1dcaf118104f5bb4c635059505963b0d.png"><br><br>  Template for Zabbix (Settings ‚Üí Templates ‚Üí Import): <a href="http://pastebin.com/jgMvMJ8G">tyts</a> and <a href="http://pastebin.mozilla-russia.org/111331">mirror</a> . <br><br>  A small note: you should not set too small a check interval, this can lead to a decrease in the performance of the monitoring system as a whole.  We apply to the nodes of the network, customize graphs, reports, and further on the mood. <br>  That's all, all good Friday and great weekend! <br><br>  PS Not all of us are perfect and please report any errors in the text to the LAN. </div><p>Source: <a href="https://habr.com/ru/post/229539/">https://habr.com/ru/post/229539/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../229523/index.html">Checking the tariff and costs for mobile</a></li>
<li><a href="../229525/index.html">Cisco Identity Services Engine</a></li>
<li><a href="../229527/index.html">Checking PIN code of bank cards</a></li>
<li><a href="../229529/index.html">Sleep REM-phase modulator</a></li>
<li><a href="../229535/index.html">Conversion of a wireless USB Wi-Fi adapter TP-LINK TL-WN722N to Philips PTA01 adapter for Philips 55PFL7606H TV and others</a></li>
<li><a href="../229541/index.html">I will study at the Computer Science Center</a></li>
<li><a href="../229543/index.html">How to create and earn SaaS (Part 10 / Business Model Metrics)</a></li>
<li><a href="../229545/index.html">Astronomers have finally seen Voyager 1 entering interstellar space.</a></li>
<li><a href="../229549/index.html">Face recognition</a></li>
<li><a href="../229551/index.html">Microsoft issues an urgent update to block fake SSL certificates</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>