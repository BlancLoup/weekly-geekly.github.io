<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PostgreSQL features for those who migrated from MySQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Last week, steep varanio literally read DevConf a bottomhole report for all those who migrated to the Postgres from MySQL, but still do not use the fu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PostgreSQL features for those who migrated from MySQL</h1><div class="post__text post__text-html js-mediator-article"><p>  <em>Last week, steep <a href="https://habrahabr.ru/users/varanio/" class="user_link">varanio</a> literally read DevConf a bottomhole report for all those who migrated to the Postgres from MySQL, but still do not use the full database.</em>  <em>Based on the speech, this publication was born.</em> </p><br><p>  <em>We are pleased to announce that preparations for PG Day'17 Russia are in full swing!</em>  <em>We have published the <a href="https://pgday.ru/ru/2017/schedule%3Futm_source%3Dhabrahabr%26utm_medium%3Dblog%26utm_campaign%3Dvaranio4"><strong>full schedule of the</strong></a> upcoming event.</em>  <em><a href="https://pgday.ru/ru/2017/request/registration%3Futm_source%3Dhabrahabr%26utm_medium%3Dblog%26utm_campaign%3Dvaranio4"><strong>We invite everyone</strong></a> to come and talk with Anton personally</em> </p><br><p><img src="https://habrastorage.org/web/a63/c71/e0c/a63c71e0c6d4455cbd9c5ebbeb43bc7d.jpg"></p><br><p>  Since the report on DevConf caused generally positive reviews, I decided to issue it in the form of an article for those who for some reason could not attend the conference. </p><br><p>  Why did the idea of ‚Äã‚Äãsuch a report come about?  The fact is that PostgreSQL is now clearly a hype technology, and many are switching to this DBMS.  Sometimes - for objective reasons, sometimes - simply because it is fashionable. </p><br><p>  But quite often there is such a situation, when some conditional programmer Vasya wrote yesterday on MySQL, and today he suddenly started writing at Posgres.  How will he write?  Yes, in general, as before, using only the most minimal set of new base features.  Practice shows that years pass before the DBMS begins to be used more or less fully. </p><a name="habracut"></a><br><h2>  Not holivar </h2><br><p>  Immediately disclaimer: this is not an article "Muskul vs posgres".  It is up to you to go to the post office or not.  Uber, for example, switched back to MySQL for some reason. </p><br><p>  We must pay tribute to Oracle, they are clearly moving MySQL in the right direction.  5.7 made strict mode by default.  In the eighth version, CTE and window functions are promised, as well as getting rid of the MyISAM engine in system tables.  Those.  it is clear that resources are being invested in the base, and users' descriptions are studied very seriously. </p><br><p>  However, PostgreSQL is still full of unique features.  As a result, I tried to make a brief overview of the capabilities of the developer base. </p><br><h2>  Built-in data types </h2><br><p>  Many types of data are built into the database, in addition to the usual numeric and string.  As well as operators for their interaction. </p><br><p>  For example, there are types cidr, inet, macaddr for working with ip addresses. </p><br><pre><code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- ,   ip  '128.0.0.1'  cidr '127.0.0.0/24' --    &amp;&amp; select '127.0.0.0/24'::cidr &amp;&amp; '128.0.0.1'; --  false</span></span></code> </pre> <br><p>  Or for example, time with timezone (timestamptz), time interval, etc. </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--     -? SELECT NOW() AT TIME ZONE 'America/New_York'; --        -? SELECT NOW() AT TIME ZONE 'America/New_York' - NOW() AT TIME ZONE 'Europe/Moscow'; -- : -07:00:00</span></span></code> </pre> <br><p>  When I was preparing this slide, I decided to look out of curiosity, and what time shift relative to UTC was 100 years ago, in 1917: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'1917-06-17 00:00:00 UTC'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> zone <span class="hljs-string"><span class="hljs-string">'Europe/Moscow'</span></span>; <span class="hljs-comment"><span class="hljs-comment">-- : 1917-06-17 02:31:19</span></span></code> </pre> <br><p>  Those.  Muscovites lived on time UTC + 02: 31: 19. </p><br><p>  In addition to these, there are other built-in data types: UUID, JSONB, XML, bit strings, etc. </p><br><h2>  Type array </h2><br><p>  Separately, it is necessary to consider the type of "array".  Arrays have long been well integrated into PostgreSQL.  Multidimensional arrays, slices, intersection, union operators, etc.  There are many functions for working with arrays. </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">---     SELECT ARRAY [1, 2, 8, 10] &amp;&amp; ARRAY [1, 2, 3, 4, 5]; ---      ? SELECT ARRAY [1, 2] &lt;@ ARRAY [1, 2, 3, 4, 5]</span></span></code> </pre> <br><p>  There is a very convenient function, which is called: array.  An argument is a certain SELECT query, and the output is the result of the query as an array. </p><br><p>  There is an inverse function: unnest.  It takes an array and returns it as the result of the query.  This is convenient, for example, when you need to manually insert several identical records with different id, but you do not want to do copy-paste: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span>, added_at) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> user_id, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">'2010-03-03 10:56:40'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unnest</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">1232</span></span>, <span class="hljs-number"><span class="hljs-number">534</span></span>, <span class="hljs-number"><span class="hljs-number">233</span></span>, <span class="hljs-number"><span class="hljs-number">100500</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> u(user_id)</code> </pre> <br><h2>  Create your own types </h2><br><p>  Own types can be created in three ways.  First, if you know the C language, then you can create a base type, along with some int or varchar.  Example from the manual: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span> box ( INTERNALLENGTH = <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">INPUT</span></span> = my_box_in_function, <span class="hljs-keyword"><span class="hljs-keyword">OUTPUT</span></span> = my_box_out_function );</code> </pre> <br><p>  Those.  create a couple of functions that can do your type from cstring and vice versa.  Then you can use this type, for example, in a table declaration: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> myboxes ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, description box );</code> </pre> <br><p>  The second method is a composite type.  For example, to store complex numbers: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span> complex <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( r <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span>, i <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> );</code> </pre> <br><p>  And then use this: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> math ( <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> complex ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> math (<span class="hljs-keyword"><span class="hljs-keyword">result</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ((<span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">-0.6</span></span>)::complex); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">result</span></span>).i <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> math; <span class="hljs-comment"><span class="hljs-comment">-- : -0.6</span></span></code> </pre> <br><p>  The third type you can create is the domain type.  A domain type is simply an alias to an existing type with a different name, i.e.  name that matches your business logic. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DOMAIN</span></span> us_postal_code <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>;</code> </pre> <br><p>  us_postal_code is more semantic than some abstract text or varchar. </p><br><h2>  Create your own operators </h2><br><p>  You can make your own operators.  For example, the addition of complex numbers (we defined the complex type above): </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   , ,   SQL CREATE OR REPLACE FUNCTION sum_complex(x COMPLEX, y COMPLEX) RETURNS COMPLEX AS $$ SELECT xr + yr, xi + yi; $$ language sql; --   ""    CREATE OPERATOR + ( PROCEDURE = sum_complex, LEFTARG = COMPLEX, RIGHTARG = COMPLEX );</span></span></code> </pre> <br><h2>  Create custom rules for type conversion </h2><br><p>  Let's do some spherical example in vacuum.  Create RUR and USD types, and a rule for converting one type to another.  Since I don‚Äôt know si well, for example let's make a simple composite type: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span> USD <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TYPE</span></span> RUR <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> <span class="hljs-built_in"><span class="hljs-built_in">FLOAT</span></span> ); <span class="hljs-comment"><span class="hljs-comment">--      (  60,    ) CREATE FUNCTION usd2rur(value USD) RETURNS RUR AS $$ SELECT value.sum * 60.0; $$ LANGUAGE SQL; --    ,    "". CREATE CAST ( USD AS RUR ) WITH FUNCTION usd2rur(USD) AS ASSIGNMENT;</span></span></code> </pre> <br><p>  Actually, that's all, now you can use.  How much will there be 100 bucks in rubles? </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'(100.0)'</span></span>::usd::rur;</code> </pre> <br><p>  The result will be: </p><br><pre> <code class="hljs lisp">rur -------- (<span class="hljs-number"><span class="hljs-number">6000</span></span>) (<span class="hljs-number"><span class="hljs-number">1</span></span> row)</code> </pre> <br><h2>  Types in PostgreSQL extensions </h2><br><p>  There are extensions where data types are described and everything that is needed for them.  For example, the <code>ip4r</code> extension describing types for IP addresses and their ranges. </p><br><p>  If you look at the sources <a href="">https://github.com/RhodiumToad/ip4r/blob/master/ip4r--2.2.sql</a> , you will see that the extension is simply, in fact, a set of <code>CREATE TYPE</code> , <code>CREATE OPERATOR</code> , <code>CREATE CAST</code> and etc. </p><br><p>  The rules for indexing are described.  For example, the type <code>ip4r</code> (range of IP addresses) can be indexed by the GIST index by the <code>&amp;&amp;</code> operator (and others).  Thus, you can make a table to search for cities by IP. </p><br><p>  Or, for example, there is an extension <code>uri</code> , which makes a type in which you can store your link so that you can easily draw out a schema or a host from it (I have not tried it in production yet, only I plan). </p><br><h2>  Indices </h2><br><p>  In addition to the standard <code>btree</code> there are others: <code>GIN</code> (can be used for some array operations, for jsonb, for full-text search), <code>GIST</code> , <code>brin</code> , etc. </p><br><h2>  Partial indexes </h2><br><p>  There are situations when you have 10 million rows in a table, and only 100 of them, for example, in the status ‚ÄúPayment is being processed‚Äù.  And you constantly pull this status "handled" somehow like this: <code>select ... where status = 2</code> . </p><br><p>  It is clear that we need an index here.  But such an index will take up a lot of space, while really you need a very small part of it. </p><br><p>  In the post index, you can make an index not for the entire table, but for the rows defined by a given condition: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> my_money_status_idx <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> my_money(<span class="hljs-keyword"><span class="hljs-keyword">status</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre> <br><p>  This index will work well on <code>select * from my_money where status = 2</code> requests and at the same time take up little space. </p><br><h2>  Expression indexes </h2><br><p>  In the post index, you can do indices not in one column, but in any expression.  For example, you can index the first name with the last name: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> people_names <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> people ((first_name || <span class="hljs-string"><span class="hljs-string">' '</span></span> || last_name));</code> </pre> <br><p>  And then such a request will quickly work: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> people <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (first_name || <span class="hljs-string"><span class="hljs-string">' '</span></span> || last_name) = <span class="hljs-string"><span class="hljs-string">'John Smith'</span></span>;</code> </pre> <br><h2>  Constraints </h2><br><p>  In addition to standard UNIQUE and NOT NULL, you can also do other integrity checks in the database.  In the domain type, you can write check: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DOMAIN</span></span> us_postal_code <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHECK</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">VALUE</span></span> ~ <span class="hljs-string"><span class="hljs-string">'^\d{5}$'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUE</span></span> ~ <span class="hljs-string"><span class="hljs-string">'^\d{5}-\d{4}$'</span></span> );</code> </pre> <br><p>  which checks that only 5 digits or 5 digits, a hyphen and 4 digits will be in the us_postal_code column.  Of course, you can write here not only regular, but also any other conditions. </p><br><p>  Also check can be written in the table: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, email <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CHECK</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">length</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">length</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) &lt;= <span class="hljs-number"><span class="hljs-number">300</span></span>) );</code> </pre> <br><p>  Those.  The name must have at least one character, and not more than 300. </p><br><p>  Generally speaking, the types themselves are also a kind of restriction, an additional check that the base does.  For example, if you have a type complex (see above), consisting essentially of two numbers, then you will not accidentally insert a string there: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> math (<span class="hljs-keyword"><span class="hljs-keyword">result</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ((<span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>)::complex); ERROR: invalid input syntax for type double precision: ""</code> </pre> <br><p>  Thus, sometimes a composite type may be preferable to jsonb, because in json you can cram anything at all. </p><br><h2>  Partial uniqueness and uniqueness by expression </h2><br><p>  In contrast to the simple uniqueness of UNIQUE or PRIMARY KEY, you can make uniqueness among the specific rowset specified by the condition.  For example, email should be unique among undeleted users: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> users_unique_idx <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span>(email) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> deleted = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre> <br><p>  Another funny thing: you can make uniqueness not by one field, but by any expression.  For example, you can make it so that in the table the sum of two columns will not be repeated: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> test_summ ( a <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, b <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> test_summ_unique_idx <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> test_summ ((a + b)); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> test_summ <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> test_summ <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">--   </span></span></code> </pre> <br><h2>  Constraint Exclude </h2><br><p>  The EXCLUDE keyword allows you to make it so that when you insert / update a string, this string will be compared with others for a given operator.  For example, a table containing non-overlapping IP ranges (checked by the intersection operator <code>&amp;&amp;</code> ): </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ip_ranges ( ip_range ip4r, <span class="hljs-keyword"><span class="hljs-keyword">EXCLUDE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> gist (ip_range <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> &amp;&amp;) );</code> </pre> <br><p>  In general, the usual UNIQUE is, in essence, EXCLUDE with the <code>=</code> operator. </p><br><h2>  Stored procedures </h2><br><p>  Stored procedures can be written in SQL, pl / pgsql, javascript, (pl / v8), python, etc.  For example, it is possible in the language R to calculate some statistics and return from it a graph with the result. <br>  This is a separate big topic, I advise you to look for the report of Ivan Panchenko on this subject. </p><br><h2>  CTE (Common Table Expressions) </h2><br><p>  It will be in MySQL 8, but anyway, let's briefly dwell on this. </p><br><p>  CTE is easy.  You take a piece of the request and make it separately under some name. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> subquery1 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ... <span class="hljs-comment"><span class="hljs-comment">--      . ), subquery2 AS ( SELECT ... --    ,  ) SELECT * --    FROM subquery1 JOIN subquery 2 ON ...</span></span></code> </pre> <br><p>  From the point of view of query optimization, it is necessary to take into account that each such CTE subquery is executed separately.  This can be either a plus or a minus. </p><br><p>  For example, if you have 20 joins with subqueries and groupings, the query planner may not understand your intentions and the query plan will be suboptimal.  Then you can make a part of the query in the cte-subquery, and the rest is already filtered in the main query. </p><br><p>  And vice versa, if you decide to simply submit part of the request to the CTE for readability, then sometimes this can go sideways for you. </p><br><p>  In CTE, you can use not only SELECT queries, but also UPDATE. </p><br><p>  Example: update users with age&gt; 20 years, and in the same request to give the names of the updated along with some country there. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> users_updated <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> age &gt; <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURNING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, country <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> countries <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> users.country_id = countries.id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> users_updated );</code> </pre> <br><p>  But here we must understand that sometimes with the help of CTE you can shoot yourself well in the foot. <br>  Such a request is syntactically correct, but the meaning is complete nonsense: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> update1 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> money = money + <span class="hljs-number"><span class="hljs-number">1</span></span> ), update2 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> money = money - <span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> money <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">test</span></span>;</code> </pre> <br><p>  It seems that we have added a ruble, then we have taken away the ruble, and it should remain as it is. </p><br><p>  But the fact is that when they are executed, update1 and update2 will take the initial version of the table, i.e.  in fact, it turns out that one update will overwrite the changes of the other.  Therefore, with the update inside the CTE, you need to know exactly what you are doing and why. </p><br><h2>  Window functions </h2><br><p>  I have already written about window functions in detail here: <a href="https://habrahabr.ru/post/268983/">https://habrahabr.ru/post/268983/</a> .  Window functions also promise in MySQL 8. </p><br><h2>  miscellanea </h2><br><h4 id="filter">  Filter </h4><br><p>  For aggregate functions (for example, COUNT or SUM), you can add a FILTER condition, i.e.  aggregate not all strings, but only limited by some expression: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) FILTER (<span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> age &gt; <span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">old</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) FILTER (<span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> age &lt;= <span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> young <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span>;</code> </pre> <br><p>  Those.  we counted people over twenty and those over twenty. </p><br><h4 id="watch">  \ watch </h4><br><p>  Everyone knows that psql has commands for viewing different objects, for example, <code>\d</code> , <code>\dt+</code> , etc. <br>  There is a special command called <code>\watch</code> .  Those.  you execute the query, then write <br>  <code>\watch 5</code> and your request will be executed every 5 seconds until canceled. <br>  This works not only with select, but also with any other, for example with update (for example, when you need to update a large table slowly by a bit). </p><br><h4 id="materialized-view">  Materialized View </h4><br><p>  It's like a View, only cached (materialized).  The cache can be updated using the REFRESH MATERIALIZED VIEW command.  There is also the CONCURRENTLY keyword so that Postgres does not lock SELECT queries when updating. </p><br><h4 id="listen--notify">  Listen / Notify </h4><br><p>  I haven‚Äôt tried it in production yet, so I don‚Äôt know if this is applicable in practice (if someone used, share your experience in the comments).  The bottom line is that you can subscribe to some event, and you can also notify subscribers that an event has occurred, by passing a string with add.  information. </p><br><h4 id="fdw">  Fdw </h4><br><p>  The Foreign Data Wrappers mechanism allows you to use some external data as simple tables.  Those.  For example, you can zajdoynit postgresovuyu table, muscular table, and csv file. </p><br><h4 id="sequences">  Sequence </h4><br><p>  SEQUENCE is the latest version of the MySQL th AUTO_INCREMENT.  Unlike MySQL, sequence can exist separately from the tables or vice versa, "tick" for several tables at once.  You can set various parameters, such as increment size, looping, and so on. </p><br><h2>  Instead of conclusions </h2><br><p>  This is the tip of the iceberg, in fact.  There are still a lot of nuances that are not mentioned in the article at all, because no article is enough for everything.  For only one stored procedure, you can write a book.  Or look, for example, the full list of sql-commands of the current version: <a href="https://www.postgresql.org/docs/9.6/static/sql-commands.html">https://www.postgresql.org/docs/9.6/static/sql-commands.html</a> </p><br><p>  The main thing that I wanted to show in the article: despite its high-level nature, PostgreSQL is a very old DBMS, in which there is a lot of things, and which is very well expanded.  Therefore, when switching to it from MySQL, it is recommended to look through the manual, read articles, etc. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/331460/">https://habr.com/ru/post/331460/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331450/index.html">Post-mortem Age of Empires</a></li>
<li><a href="../331452/index.html">Make QR Codes Great Again or Apple‚Äôs Camera Revolution</a></li>
<li><a href="../331454/index.html">Using music instead of a language course in learning a foreign language</a></li>
<li><a href="../331456/index.html">How we gopher apples fed or effective backend on Go for iOS</a></li>
<li><a href="../331458/index.html">The history of the development and life of one small game. Release</a></li>
<li><a href="../331462/index.html">Web sockets for php. Choosing a web server server</a></li>
<li><a href="../331466/index.html">Lessons from three million downloads on the AppStore</a></li>
<li><a href="../331468/index.html">Use template + constexpr to create mask masks for microcontroller peripherals at compile time (C ++ 14)</a></li>
<li><a href="../331470/index.html">How to overdo the door lock</a></li>
<li><a href="../331472/index.html">Introduction to ServiceNow and IT Infrastructure Management: Digest # 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>