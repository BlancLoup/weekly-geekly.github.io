<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AngularJS: how I abandoned ng-include and linked the states of two controllers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last article I talked about my first encounter with AngularJS. A year has passed since then, now I have new projects and other, often less triv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>AngularJS: how I abandoned ng-include and linked the states of two controllers</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/post/182348/">last article</a> I talked about my first encounter with AngularJS.  A year has passed since then, now I have new projects and other, often less trivial tasks.  Here I will describe a few nuances that I had to face in the process of working on one of the systems.  I hope readers can benefit from my practices. <br><br><h4>  Search and anchor </h4><br>  Suppose that we received the task to develop a client part for our new project.  This is a directory in which hundreds of thousands of documents will be stored.  Since it is quite large, the API provides the ability to load items page by page (with the indication of the initial index) and also filter by individual fields in the document. <br>  And in order for users not to get lost in the system and share information with each other, the client must save their status in the address bar. <br><br>  Well, the task is clear.  Getting started. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  To store the filter values, create a <b>$ query</b> service.  He will have two methods: <br><br><ul><li>  <b>push (query)</b> - gets an object with a set of filters and adds them to the address bar (search field). </li><li>  <b>parse ()</b> - converts search back to the filter set. </li></ul><br><blockquote>  There should be a retreat.  Since the page uses several templates (for example, for pagination), a hash (#) is automatically added to the address bar.  This is due to the fact that <a href="https://docs.angularjs.org/api/ng/directive/ngInclude">ng-include</a> uses the <a href="https://docs.angularjs.org/api/ng/service/%24location">$ location</a> service, in the presence of which angular begins to assume that we are making a one-page application. </blockquote><br>  Accordingly, an object of the form <br><br><pre><code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">index</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">size</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span> }</code> </pre> <br>  will turn into <br><blockquote> <code><a href="http://localhost/"></a> localhost:1337/catalog#?index=0&amp;size=20</code> </blockquote> <br>  But wait.  Users want to not only get the status of the page, but also mark a separate document on it. <br>  Official documentation in this case advises using <a href="https://docs.angularjs.org/api/ng/service/%24anchorScroll">$ anchorScroll</a> or <i>scrollTo</i> . <br><br>  Those.  now we get the following: <br><blockquote> <code><a href="http://localhost/"></a> localhost:1337/catalog#?index=0&amp;size=20&amp;scrollTo=5</code> </blockquote> <br>  At this point, my aesthetic sense appealed to the search for another solution. <br><br>  The first thought was to abandon <i>ng-include</i> , so that the address bar is no longer subjected to violence by the angulyar.  But then what to do with the templates?  There was only one way out: write your own directive for working with templates. <br><br><h4>  With blackjack and templates </h4><br>  There were no problems with the directive.  To work with templates, angular uses the <a href="https://docs.angularjs.org/api/ng/service/%24templateCache">$ templateCache</a> service.  You can put a piece of html-code into it using <a href="https://docs.angularjs.org/api/ng/directive/script">text / ng-template</a> or <b>put ()</b> method.  Also, by analogy with <i>ng-include</i> , we will consider the execution of the atload code <i>onload</i> . <br><br>  Directive code: <br><br><pre> <code class="javascript hljs">app.directive(<span class="hljs-string"><span class="hljs-string">'template'</span></span>, [<span class="hljs-string"><span class="hljs-string">'$templateCache'</span></span>, <span class="hljs-string"><span class="hljs-string">'$compile'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$templateCache, $compile</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">scope</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">link</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope, element, attrs</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tpl = $compile($templateCache.get(attrs.orgnTemplate))(scope); tpl.scope().$<span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(attrs.onload || <span class="hljs-string"><span class="hljs-string">''</span></span>); element.after(tpl); element.remove(); } } }]);</code> </pre><br><br>  Now we can use the templates as follows: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-template</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"paging"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-onload</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"foo = 'bar'"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Having solved the problem with <i>$ location</i> , I rewrote the <i>$ query</i> service a bit so that it now works exclusively with the history API. <br><blockquote>  By the way, do not try to use them together.  This will lead to an endless loop. </blockquote><br>  So now the address bar is clearer and more pleasant looking: <br><blockquote> <code><a href="http://localhost/"></a> localhost:1337/catalog?index=0&amp;size=20#5</code> </blockquote> <br>  And moving along anchors no longer requires additional code. <br><br><h4>  Ease of communication </h4><br>  Having broken the page into separate templates and controllers, I unexpectedly ran into another problem: the controllers must interact with each other.  Even if they are not in parental relationships.  And in some cases (again, pagination), the controllers must synchronize their state. <br><br>  The first option was to interact between controllers through events.  In this case, for each action, the controllers send each other events.  Unfortunately, in my case the number and variety of events per square centimeter of code began to go over all reasonable limits.  I decided to abandon optimization and make a separate mechanism for the exchange of information, regardless of the current <i>scope</i> . <br><br>  So the <b>$ store</b> service appeared.  In the first version, he had one method: <br><br><ul><li>  <b>value (key, value)</b> - saves or retrieves the value by key. </li></ul><br>  The following code has been added to the controllers: <br><br><pre> <code class="javascript hljs">$scope.$watch(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $store.value(<span class="hljs-string"><span class="hljs-string">'foo'</span></span>); }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ doSomething(data); }, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br>  Now that I needed to synchronize the state of two or more controllers, I just overwritten the value in the key: <br><br><pre> <code class="javascript hljs">$store.value(<span class="hljs-string"><span class="hljs-string">'stream'</span></span>, data);</code> </pre><br><blockquote>  Do not forget that all services are singletones, so when adding a service to several controllers at the same time, we get access to the same object. </blockquote><br>  Later, when I automated some data transfer between two templates (for example, the list of elements was now automatically attached to pagination using my <i>$ id</i> ), the <b>alias ()</b> method was added to the service: <br><br><ul><li>  <b>alias (key, values ‚Äã‚Äã...)</b> - adds or returns a list of synonyms for the specified key. </li></ul><br>  Thus, I have the opportunity to specify <i>alias</i> in the <i>onload</i> attribute of the template directive.  Roughly speaking, if the controller suddenly needs to request a status, this can be done not by the original key, which may be unavailable, but by a predetermined value. <br><br><h4>  Instead of an afterword </h4><br>  It turned out that the seemingly trivial task turned into a full-fledged refactoring.  However, after its completion, at least, in my opinion, the code has become much easier to read and more predictable in work.  I no longer get lost in endless events, eat only healthy food and do sports.  I hope this article will help others find peace of mind and learn something new.  Good luck and have a nice day! <br></div><p>Source: <a href="https://habr.com/ru/post/229225/">https://habr.com/ru/post/229225/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../229205/index.html">How to tame a dragon using Intel technology?</a></li>
<li><a href="../229211/index.html">How to eat whale or the story of creating a line of mobile products</a></li>
<li><a href="../229213/index.html">Learning Java EE 7</a></li>
<li><a href="../229215/index.html">Completion of Livolo light load switches</a></li>
<li><a href="../229217/index.html">Sports technologization: smart devices for professionals and amateurs</a></li>
<li><a href="../229227/index.html">Behavioral factors and a comprehensive assessment of the effectiveness of the interaction of advertising with Central Asia (part 2: assessment criteria)</a></li>
<li><a href="../229229/index.html">A serious loss of Blizzard, adding to the team Oculus Rift and the new publisher of the game Boom Beach - the main mobile news of the week</a></li>
<li><a href="../229231/index.html">We write in C / C ++ in Windows under KolibriOS</a></li>
<li><a href="../229235/index.html">My web-interface management smart apartment</a></li>
<li><a href="../229237/index.html">How-to: How to buy shares of technology companies on the example of "Yandex"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>