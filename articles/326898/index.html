<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Chat bot for VKontakte on Python on Callback API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chat bots have already become very common, and appear in all instant messengers daily. 

 In this article we will step by step analyze the creation of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Chat bot for VKontakte on Python on Callback API</h1><div class="post__text post__text-html js-mediator-article">  Chat bots have already become very common, and appear in all instant messengers daily. <br><br>  In this article we will step by step analyze the creation of a bot with a set of simple commands and find out how to further expand its functionality.  The article will be useful for the most newbies who have never tried to create chat bots. <br><a name="habracut"></a><br>  When I wanted to create a bot, I studied the available examples of bots for VKontakte and tried to achieve maximum simplification of their structure. <br><br>  To create a bot, I used Python 3.5 (probably, other versions of the 3rd python are also suitable) and additional libraries <a href="http://flask.pocoo.org/">Flask</a> and <a href="https://pypi.python.org/pypi/vk">VK</a> .  They will need to be installed.  On installing Flask there are many articles in Russian.  If you have Pycharm, then it is most likely installed with it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's start with the API itself.  For our bot, we will use the Callback API, available for group messages.  First of all, we need to create or already have a VKontakte group with connected messages. <br><br>  In the <b>community management</b> section ‚Üí <b>working with the API,</b> you need to create a key with access to community messages. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ccd/e7d/68a/ccde7d68a82a18b99adc50e43bc4a097.jpg" alt="image"></div><br>  To work with Callback, you need to have a web server that will receive requests for any events from the API, process them and send response requests.  That is, we will write a ‚Äúsite‚Äù that will only respond to requests sent to it and send its own. <br><br>  As we write on python, the easiest thing to use is hosting for python.  I used free <a href="https://www.pythonanywhere.com/">hosting</a> for Python.  There you need to register, and then create an application for Python 3.5 on Flask (you can create it in the Web section).  The initial file will be created: <br><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># A very simple Flask Hello World app for you to get started with... from flask import Flask app = Flask(__name__) @app.route('/') def hello_world(): return 'Hello from Flask!'</span></span></code> </pre> <br>  The only function that is now in the file is responsible for filling the page at the address issued during registration.  If you go to the browser at username.pythonanywhere.com (with your nickname), you can only see the text ‚ÄúHello from Flask!‚Äù. <br><br>  In the future, the code will be described in blocks and after the completion of the whole block it will be possible to check, and in the process the code may be marked with an environment as erroneous.  Do not be afraid of this, it is better to just finish the block to the end. <br><br>  So, <u>BLOCK 1</u> . <br>  To process requests sent to the site, add the following code at the end of the document: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@app.route('/', methods=['POST']) def processing(): return 'xxxxxxxx'</span></span></code> </pre><br>  Where instead of X, we substitute "the string that the server should return".  She is listed in the group management in the Callback API section. <br><br>  This feature will allow us to connect our site for notifications to the group. <br><br>  Now we can check the work.  Only need to restart the application.  On the hosting, after the files have been modified and saved, in order for the site to work with new data, you need to reload it in the Web tab.  After adding this code, we can enter the corresponding address username.pythonanywhere.com in the address bar of the server in the VKontakte group and click "Confirm". <br><br>  A green notification should appear indicating that the server address has been successfully connected. <br><br>  When you click "Confirm", VKontakte tries to contact our server and make sure that it really belongs to the group owner, and "waits" for the server to return a confirmation code in response to the request. <br><br>  <u>BLOCK 2</u> <br>  We can proceed to the next step.  Add the ability to write messages on behalf of the community.  It's time to install on the hosting library VK.  In the Consoles section, launch the bash-console and execute the command (or the corresponding one for the selected version of python): <br><br><pre> <code class="bash hljs">pip3.5 install --user vk</code> </pre> <br>  How to install modules is described <a href="https://help.pythonanywhere.com/pages/InstallingNewModules">here</a> . <br><br>  Let's change the code of our function for processing incoming requests: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@app.route('/', methods=['POST']) def processing(): # json   POST- data = json.loads(request.data) #        if 'type' not in data.keys(): return 'not vk' if data['type'] == 'confirmation': return confirmation_token elif data['type'] == 'message_new': session = vk.Session() api = vk.API(session, v=5.0) user_id = data['object']['user_id'] api.messages.send(access_token=token, user_id=str(user_id), message=',   !') #   ,     return 'ok'</span></span></code> </pre><br>  The message that the processing was successful, you need the server VKontakte.  If an error occurs, or some other response arrives, the server will continue to send a notification about the incoming message at intervals (until we process it). <br><br>  The structure of the incoming request announcing a new message is as follows: <br><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"message_new"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"object"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-number"><span class="hljs-number">43</span></span>, <span class="hljs-attr"><span class="hljs-attr">"date"</span></span>:<span class="hljs-number"><span class="hljs-number">1492522323</span></span>, <span class="hljs-attr"><span class="hljs-attr">"out"</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"user_id"</span></span>:xxxxxxxx, <span class="hljs-attr"><span class="hljs-attr">"read_state"</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>:<span class="hljs-string"><span class="hljs-string">" ... "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"body"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>}, <span class="hljs-attr"><span class="hljs-attr">"group_id"</span></span>:xxxxxxxxxxx}</code> </pre> <br>  Vkontakte transmits to our site three objects: ‚Äútype‚Äù, ‚Äúobject‚Äù, ‚Äúgroup_id‚Äù, and inside ‚Äúobject‚Äù information about the message itself is stored. <br><br>  All requests can be viewed in the <a href="https://vk.com/dev/methods">documentation</a> VKontakte. <br><br>  We also add new ‚Äúimport‚Äù to the beginning of the file: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Flask, request, json <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> settings <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> vk</code> </pre><br>  We created a new file in the same folder settings.py, in which the necessary login data is saved: <br><br><pre> <code class="python hljs">token = <span class="hljs-string"><span class="hljs-string">'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'</span></span> confirmation_token = <span class="hljs-string"><span class="hljs-string">'xxxxxxxx'</span></span></code> </pre> <br>  They need to be replaced with your tokens.  We created the first one at the beginning of the article, the second - the confirmation code to connect the group with the server. <br><br>  Now our bot can greet incoming messages and confirm their belonging to the group, the code of which we gave it. <br><br>  We can check it and write some message to it, only it is necessary to enable notifications about incoming messages in the group settings in the Callback API section. <br><br>  To bot began to send messages, you need to restart the application.  After that, we write the bot again and, if everything is all right, proceed to the next step. <br><br>  <u>BLOCK 3</u> <br>  If everything went well, and the bot greeted you in response to your message, proceed to the next step.  We will export all the interaction with the library vk to another file, I called it vkapi: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> vk session = vk.Session() api = vk.API(session, v=<span class="hljs-number"><span class="hljs-number">5.0</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user_id, token, message, attachment=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> api.messages.send(access_token=token, user_id=str(user_id), message=message, attachment=attachment)</code> </pre><br>  So far there is only one function and initialization of the VKontakte session, then we will add others.  Potentially, the function can also send attachments.  Later we will take advantage of this opportunity. <br><br>  Next we get the file - message handler.  It will process incoming messages, determine the appropriate commands when they appear, and issue the necessary answers. <br><br>  File "messageHandler.py": <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> vkapi <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_answer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(body)</span></span></span><span class="hljs-function">:</span></span> message = <span class="hljs-string"><span class="hljs-string">",   !"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_answer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data, token)</span></span></span><span class="hljs-function">:</span></span> user_id = data[<span class="hljs-string"><span class="hljs-string">'user_id'</span></span>] message = get_answer(data[<span class="hljs-string"><span class="hljs-string">'body'</span></span>].lower()) vkapi.send_message(user_id, token, message)</code> </pre><br>  It remains to connect our new files to the main one.  Change the request processing function in the main file: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@app.route('/', methods=['POST']) def processing(): data = json.loads(request.data) if 'type' not in data.keys(): return 'not vk' if data['type'] == 'confirmation': return confirmation_token elif data['type'] == 'message_new': messageHandler.create_answer(data['object'], token) return 'ok'</span></span></code> </pre><br>  And add the corresponding import to the beginning of the file: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> messageHandler</code> </pre> <br>  We can check what we did by reloading the application. <br><br>  <u>UNIT 4</u> <br>  Let's start creating teams.  Create a class of commands. <br><br>  File "command_system.py": <br><br><pre> <code class="python hljs">command_list = [] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Command</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.__keys = [] self.description = <span class="hljs-string"><span class="hljs-string">''</span></span> command_list.append(self) @property <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">keys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.__keys @keys.setter <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">keys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, mas)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> mas: self.__keys.append(k.lower()) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre><br>  The class has a keys property where keys will be stored by which you can refer to this command.  All keys are stored in lowercase letters when setting the property, and they should be compared with the user's messages converted to lowercase form so that the register does not affect the success of the command call. <br><br>  The description field will be used to display information on bot commands.  The process function will be executed to form a response message. <br><br>  There is a general list in which all commands are saved when they are initialized.  He is outside the classroom.  This list will be used to search for the command that the user requested with his message. <br><br>  Now we will create several commands for our bot.  For convenience of loading, we will place the files in which we initialize the commands in the ‚Äúcommands‚Äù folder. <br><br>  I will create several files, but you can also place commands in one file. <br><br>  "Hello.py" <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> command_system <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> message = <span class="hljs-string"><span class="hljs-string">', !\n  -.'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message, <span class="hljs-string"><span class="hljs-string">''</span></span> hello_command = command_system.Command() hello_command.keys = [<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'hello'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>] hello_command.description = <span class="hljs-string"><span class="hljs-string">' '</span></span> hello_command.process = hello</code> </pre> <br>  "Cat.py" <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> command_system <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> vkapi <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> settings <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#      attachment = vkapi.get_random_wall_picture(-32015300, settings.access_token) message = '   :)\n      .' return message, attachment cat_command = command_system.Command() cat_command.keys = ['', '', '', '', '', 'cat'] cat_command.description = '   ' cat_command.process = cat</span></span></code> </pre><br>  For the team sending the seal, we need a new token and a new function in the ‚Äúvkapi‚Äù file, which returns a random picture from the wall of the group or user.  In this case, we will receive a random photograph from the wall of a public with cats. <br><br>  Let's start by getting a token.  We need a service access key.  To do this, create a new Standalone application.  It can be created by <a href="https://vk.com/apps%3Fact%3Dmanage">reference</a> .  Then, when the application is created, you need to go to its settings and copy what is in the ‚ÄúService Access Key‚Äù field. <br>  This should be added to our file with tokens. <br>  "Settings.py" <br><pre> <code class="python hljs">token = <span class="hljs-string"><span class="hljs-string">'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'</span></span> confirmation_token = <span class="hljs-string"><span class="hljs-string">'xxxxxxxx'</span></span> access_token = <span class="hljs-string"><span class="hljs-string">'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'</span></span></code> </pre> <br><br>  We now turn to the creation of a new method vkapi.  Here we slightly expand the range of API methods used. <br><br>  This method looks like this: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_random_wall_picture</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(group_id, token)</span></span></span><span class="hljs-function">:</span></span> max_num = api.photos.get(owner_id=group_id, album_id=<span class="hljs-string"><span class="hljs-string">'wall'</span></span>, count=<span class="hljs-number"><span class="hljs-number">0</span></span>, access_token=token)[<span class="hljs-string"><span class="hljs-string">'count'</span></span>] num = random.randint(<span class="hljs-number"><span class="hljs-number">1</span></span>, max_num) photo = api.photos.get(owner_id=str(group_id), album_id=<span class="hljs-string"><span class="hljs-string">'wall'</span></span>, count=<span class="hljs-number"><span class="hljs-number">1</span></span>, offset=num, access_token=token)[<span class="hljs-string"><span class="hljs-string">'items'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'id'</span></span>] attachment = <span class="hljs-string"><span class="hljs-string">'photo'</span></span> + str(group_id) + <span class="hljs-string"><span class="hljs-string">'_'</span></span> + str(photo) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> attachment</code> </pre><br>  We add it to the file "vkapi".  Also, in the beginning of the ‚Äúvkapi‚Äù file, add the necessary import: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> random</code> </pre> <br>  And the last team <br><br>  "Info.py" <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> command_system <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">info</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> message = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> command_system.command_list: message += c.keys[<span class="hljs-number"><span class="hljs-number">0</span></span>] + <span class="hljs-string"><span class="hljs-string">' - '</span></span> + c.description + <span class="hljs-string"><span class="hljs-string">'\n'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message, <span class="hljs-string"><span class="hljs-string">''</span></span> info_command = command_system.Command() info_command.keys = [<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'help'</span></span>] info_command.desciption = <span class="hljs-string"><span class="hljs-string">'  '</span></span> info_command.process = info</code> </pre><br>  Final file hierarchy: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/761/497/7fb/7614977fb3b17d9557f385f4e0f80b26.png" alt="image"><br>  botFlask is the main file that accepts incoming requests. <br><br>  Now that we have described the commands, we need to ensure that our list of commands is full, and we can understand which of the commands the user has addressed, since the ‚Äúcommand_list‚Äù list is filled only at the time of launching files with specific commands. <br><br>  We will automatically launch for execution all files from the ‚Äúcommands‚Äù folder when you launch our bot. <br><br>  To do this, in the file ‚ÄúmessageHandler.py‚Äù we add a function: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load_modules</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#    ,       files = os.listdir("mysite/commands") modules = filter(lambda x: x.endswith('.py'), files) for m in modules: importlib.import_module("commands." + m[0:-3])</span></span></code> </pre><br>  In this function, we load the list of files from the directory with commands, filter only the python files and import them into our program, which ensures that the list is filled with commands. <br><br>  Call this function is added to the "create_answer".  Now we will change the get_answer function so that it invokes the appropriate response. <br><br>  The final file view: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> vkapi <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> importlib <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> command_system <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> command_list <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load_modules</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#    ,       files = os.listdir("mysite/commands") modules = filter(lambda x: x.endswith('.py'), files) for m in modules: importlib.import_module("commands." + m[0:-3]) def get_answer(body): #        message = ",   .  '',    " attachment = '' for c in command_list: if body in c.keys: message, attachment = c.process() return message, attachment def create_answer(data, token): load_modules() user_id = data['user_id'] message, attachment = get_answer(data['body'].lower()) vkapi.send_message(user_id, token, message, attachment)</span></span></code> </pre><br>  That's all, our bot is ready!  Now you know how to create a basis for a bot and add new commands for it. <br><br>  <u>UNIT 5</u> <br>  The rest of this article will be about one improvement that I consider necessary.  However, the bot will work without it. <br><br>  <b>Approximate command recognition</b> <br><br>  If the user made a mistake in one character, most likely, he meant the most similar command.  Therefore, it would be good if our bot still gave an answer, and did not say "I do not understand you." <br><br>  For approximate recognition we will use the Damerau-Levenshtein distance.  It shows how many operations for deleting, inserting, replacing and moving characters can move from one line to another. <br><br>  The algorithm for finding this distance is described, for example, on Wikipedia. <br><br>  Add to the file ‚ÄúmessageHandler.py‚Äù function: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">damerau_levenshtein_distance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s1, s2)</span></span></span><span class="hljs-function">:</span></span> d = {} lenstr1 = len(s1) lenstr2 = len(s2) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">-1</span></span>, lenstr1 + <span class="hljs-number"><span class="hljs-number">1</span></span>): d[(i, <span class="hljs-number"><span class="hljs-number">-1</span></span>)] = i + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">-1</span></span>, lenstr2 + <span class="hljs-number"><span class="hljs-number">1</span></span>): d[(<span class="hljs-number"><span class="hljs-number">-1</span></span>, j)] = j + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(lenstr1): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(lenstr2): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> s1[i] == s2[j]: cost = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: cost = <span class="hljs-number"><span class="hljs-number">1</span></span> d[(i, j)] = min( d[(i - <span class="hljs-number"><span class="hljs-number">1</span></span>, j)] + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-comment"><span class="hljs-comment"># deletion d[(i, j - 1)] + 1, # insertion d[(i - 1, j - 1)] + cost, # substitution ) if i and j and s1[i] == s2[j - 1] and s1[i - 1] == s2[j]: d[(i, j)] = min(d[(i, j)], d[i - 2, j - 2] + cost) # transposition return d[lenstr1 - 1, lenstr2 - 1]</span></span></code> </pre><br>  It implements the algorithm for finding this distance, if you wish, you can change or improve it. <br><br>  According to the rows, it will give the number of operations to convert one to another.  Now let's change the get_answer method: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_answer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(body)</span></span></span><span class="hljs-function">:</span></span> message = <span class="hljs-string"><span class="hljs-string">",   .  '',    "</span></span> attachment = <span class="hljs-string"><span class="hljs-string">''</span></span> distance = len(body) command = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> key = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> command_list: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> c.keys: d = damerau_levenshtein_distance(body, k) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> d &lt; distance: distance = d command = c key = k <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> distance == <span class="hljs-number"><span class="hljs-number">0</span></span>: message, attachment = c.process() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message, attachment <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> distance &lt; len(body)*<span class="hljs-number"><span class="hljs-number">0.4</span></span>: message, attachment = command.process() message = <span class="hljs-string"><span class="hljs-string">'     "%s"\n\n'</span></span> % key + message <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message, attachment</code> </pre><br>  In this function, we calculate the distance for the message and each of the keys.  If the match is not accurate, we write how the bot recognized each of the commands that were sent to it.  In case the distance has exceeded 40% of the length of the submitted message, we consider that the user has made a mistake too much and return the message by default, where we offer to ask for help. <br><br>  That's all, working (at the time of writing), the code is laid out on the <a href="https://github.com/strorinWind/bot">githaba</a> . <br><br>  I hope this article will make your life a little easier if you decide to create your own bot for VK. </div><p>Source: <a href="https://habr.com/ru/post/326898/">https://habr.com/ru/post/326898/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326886/index.html">How we made a completely new KOMPAS-3D: History in seven chapters ‚Üí part 2</a></li>
<li><a href="../326890/index.html">Rx. We comprehend retryWhen and repeatWhen on examples from Android development</a></li>
<li><a href="../326892/index.html">Research: businesses pay more attention to threats, not data protection</a></li>
<li><a href="../326894/index.html">ITMO University Digest: materials for those who want to join Data Science</a></li>
<li><a href="../326896/index.html">Transfer of intentions</a></li>
<li><a href="../326900/index.html">As I made the fastest resize of images. Part 2, SIMD</a></li>
<li><a href="../326902/index.html">Experience implementing Tarantool in the service Calltouch</a></li>
<li><a href="../326904/index.html">To hell with motivation, you need discipline</a></li>
<li><a href="../326906/index.html">What we should build automation. Using the HTTP API in Google Sheets</a></li>
<li><a href="../326910/index.html">MTS and Ericsson are testing 5G in motion at Spartak Stadium - ONLINE Broadcast</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>