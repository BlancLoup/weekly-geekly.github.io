<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New optimizations for x86 in the expected GCC 5.0</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, the actual development of new optimizations in GCC 5.0 can be considered complete. The GCC 5.0 product is now in the stage3 phase, that is, there ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>New optimizations for x86 in the expected GCC 5.0</h1><div class="post__text post__text-html js-mediator-article">  So, the actual development of new optimizations in GCC 5.0 can be considered complete.  The GCC 5.0 product is now in the <a href="https://gcc.gnu.org/develop.html">stage3</a> phase, that is, there is a refinement of the already implemented optimizations.  In this and subsequent articles I will discuss the optimizations implemented in GCC 5.0 for x86 and their impact on the performance of programs for the <b>Intel Atom</b> and <b>Intel Core</b> line <b>processors</b> .  Today we will talk about vectorization of group memory calls.  In subsequent articles, I will talk about accelerations in the 32-bit PIC mode and additional vectorization gain. <br><a name="habracut"></a><br>  As you have probably guessed, the vectorization of group memory calls has been significantly improved in GCC 5.0.  The group memory reference is an iterable sequence of calls.  For example: <br><br><pre><code class="hljs matlab">x = a[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>], y = a[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>], z = a[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>]</code> </pre> <br>  iterated over <b>i</b> is a group of loads from memory of length 3. The length of the group of calls to memory is the distance between the lowest and highest addresses in the group.  For the example above, this is <i>(i + 2) - (i) + 1 = 3</i> <br>  The number of memory hits in a group does not exceed its length.  For example: <br><br><pre> <code class="hljs matlab">x = a[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>], z = a[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>]</code> </pre> <br>  iterated on <b>i</b> is a group of length 3, despite the fact that there are only 2 memory references. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      GCC 4.9 vectorizes groups where length is a power of 2 (2, 4, 8 ...). <br><br>  GCC 5.0 vectorizes groups where the length is 3 or degree 2 (2, 4, 8 ...).  Other lengths are not vectorized, as they are very rare in real applications. <br><br>  Most often, the vectorization of the memory reference group is used when working with arrays of structures. <br><br>  1. Converting images, say, in the structure of RGB.  <a href="https://gcc.gnu.org/bugzilla/show_bug.cgi%3Fid%3D52252">An example</a> . <br>  2. Work with N-dimensional coordinates (say, to normalize three-dimensional points).  <a href="https://gcc.gnu.org/bugzilla/show_bug.cgi%3Fid%3D61403">An example</a> . <br>  3. Multiplication of vectors by a constant matrix: <br><br><pre> <code class="hljs markdown">a[<span class="hljs-string"><span class="hljs-string">i</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">0</span></span>] = 7 <span class="hljs-bullet"><span class="hljs-bullet">* b[i][0] - 3 *</span></span> b[<span class="hljs-string"><span class="hljs-string">i</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">1</span></span>]; a[<span class="hljs-string"><span class="hljs-string">i</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">1</span></span>] = 2 * b[<span class="hljs-string"><span class="hljs-string">i</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">0</span></span>] + b[<span class="hljs-string"><span class="hljs-string">i</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">1</span></span>];</code> </pre><br>  In general, in GCC 5.0 (compared to 4.9) <br><br><ul><li>  A vectorization of a group of memory hits of length 3 has appeared. </li><li>  Significantly improved vectorization of a group of downloads from memory for any length </li><li>  They began to use techniques of vectorization of groups of memory hits that are optimal for a particular x86 processor. </li></ul><br>  The following tables provide an estimate of the performance gains when using GCC 5.0 on byte structures (the largest number of elements in a vector) compared with GCC 4.9.  The following cycle is used for evaluation: <br><br><pre> <code class="hljs matlab"> int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">j</span></span>, k; byte *in = a, *out = b; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (k = <span class="hljs-number"><span class="hljs-number">0</span></span>; k &lt; STGSIZE; k++) { byte s = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">j</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">j</span></span> &lt; LDGSIZE; <span class="hljs-built_in"><span class="hljs-built_in">j</span></span>++) s += in[<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>] * c[<span class="hljs-built_in"><span class="hljs-built_in">j</span></span>][k]; out[k] = s; } in += LDGSIZE; out += STGSIZE; }</code> </pre><br>  Where: <br><ul><li>  <b>c</b> is a constant matrix: </li></ul><br><pre> <code class="hljs markdown">const byte c[<span class="hljs-string"><span class="hljs-string">8</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">8</span></span>] = {1, -1, 1, -1, 1, -1, 1, -1, 1, 1, -1, -1, 1, 1, -1, -1, 1, 1, 1, 1, -1, -1, -1, -1, -1, 1, -1, 1, -1, 1, -1, 1, -1, -1, 1, 1, -1, -1, 1, 1, -1, -1, -1, -1, 1, 1, 1, 1, -1, -1, -1, 1, 1, 1, -1, 1, 1, -1, 1, 1, 1, -1, -1, -1};</code> </pre><br>  Such a matrix is ‚Äã‚Äãused to minimize computations within the cycle to relatively fast additions and subtractions. <br><ul><li>  <b>in</b> and <b>out</b> - pointers to global arrays "a [1024 * LDGSIZE]" and "b [1024 * STGSIZE]" </li><li>  <b>byte</b> is unsigned char </li><li>  LDGSIZE and STGSIZE are macros that define the length of a group of loadings from memory and save to memory, respectively. </li></ul><br><br>  Compile options "-Ofast" plus "-march = slm" for <a href="http://en.wikipedia.org/wiki/Silvermont">Silvermont</a> , "-march = core-avx2" for <a href="https://ru.wikipedia.org/wiki/Haswell">Haswell,</a> and all combinations -DLDGSIZE = {1,2,3,4,8} -DSTGSIZE = {1,2 3,4,8} <br><br>  The performance gain of GCC 5.0 compared to 4.9 (how many times it accelerated, the more - the better). <br><br>  <b><a href="http://en.wikipedia.org/wiki/Silvermont">Silvermont</a> : Intel Atom (TM) CPU C2750 @ 2.41GHz</b> <br><br>  Gain up to 6.5 times! <br><br><img width="300" src="http://habrastorage.org/files/309/33b/873/30933b873bf94f7692da7d13418890d9.png" alt="image"><br><br>  As can be seen from the table, the results for groups in the memory of length 3 are not very good.  This is because such a conversion requires 8 instructions "pshufb", the duration of which in Silvermont is about 5 cycles.  Despite this, the vectorization of other commands in the cycle may give a greater increase.  This can be seen in the example of a group of downloads from memory lengths of 2, 3, 4 and 8. <br><br>  Example GCC assembler for a group of downloads from memory length 2: <br><table width="300"><tbody><tr><td>  GCC 4.9 </td><td>  GCC 5.0 </td></tr><tr><td>  movdqa .LC0 (% rip),% xmm7 <br>  movdqa .LC1 (% rip),% xmm6 <br>  movdqa .LC2 (% rip),% xmm5 <br>  movdqa .LC3 (% rip),% xmm4 <br>  movdqu a (% rax,% rax),% xmm1 <br>  movdqu a + 16 (% rax,% rax),% xmm0 <br>  movdqa% xmm1,% xmm3 <br>  pshufb% xmm7,% xmm3 <br>  movdqa% xmm0,% xmm2 <br>  pshufb% xmm5,% xmm1 <br>  pshufb% xmm6,% xmm2 <br>  pshufb% xmm4,% xmm0 <br>  por% xmm2,% xmm3 <br>  por% xmm0,% xmm2 <br></td><td>  movdqa .LC0 (% rip),% xmm3 <br>  movdqu a (% rax,% rax),% xmm0 <br>  movdqu a + 16 (% rax,% rax),% xmm1 <br>  movdqa% xmm3,% xmm4 <br>  pand% xmm0,% xmm3 <br>  psrlw $ 8,% xmm0 <br>  pand% xmm1,% xmm4 <br>  psrlw $ 8,% xmm1 <br>  packuswb% xmm4,% xmm3 <br>  packuswb% xmm1,% xmm0 <br></td></tr></tbody></table>  Here, as in the <a href="https://ru.wikipedia.org/wiki/Haswell">Haswell</a> example below, it is worth noting that most of the ".LC" constants will be invariants in a loop, but only if there are free registers.  Otherwise, they will have to be installed directly in phufb: "pshufb .LC0,% xmm3".  Such pshufb will be larger by the size of the address and potentially take longer to execute. <br><br>  <b><a href="https://ru.wikipedia.org/wiki/Haswell">Haswell</a> : Intel Core (TM) i7-4770K CPU @ 3.50GHz</b> <b><br></b> <br>  Gain up to 3 times! <br><br><img width="300" src="http://habrastorage.org/files/4de/ed5/fbd/4deed5fbdeee418b9072a33f12a8404d.png" alt="image"><br><br>  In this case, the results for groups in memory of length 3 are much better, since in <a href="https://ru.wikipedia.org/wiki/Haswell">Haswell the</a> instruction ‚Äúpshufb‚Äù is executed in 1 clock cycle.  Moreover, the greatest increase here is precisely for the implemented vectorization of groups of memory calls of length 3. <br><br>  Example GCC assembler for a group of downloads from memory length 2: <br><table width="300"><tbody><tr><td>  GCC 4.9 </td><td>  GCC 5.0 </td></tr><tr><td>  vmovdqa .LC0 (% rip),% ymm7 <br>  vmovdqa .LC1 (% rip),% ymm6 <br>  vmovdqa .LC2 (% rip),% ymm5 <br>  vmovdqa .LC3 (% rip),% ymm4 <br>  vmovdqu a (% rax,% rax),% ymm0 <br>  vmovdqu a + 32 (% rax,% rax),% ymm2 <br>  vpshufb% ymm7,% ymm0,% ymm1 <br>  vpshufb% ymm5,% ymm0,% ymm0 <br>  vpshufb% ymm6,% ymm2,% ymm3 <br>  vpshufb% ymm4,% ymm2,% ymm2 <br>  vpor% ymm3,% ymm1,% ymm1 <br>  vpor% ymm2,% ymm0,% ymm0 <br>  vpermq $ 216,% ymm1,% ymm1 <br>  vpermq $ 216,% ymm0,% ymm0 <br></td><td>  vmovdqa .LC0 (% rip),% ymm3 <br>  vmovdqu a (% rax,% rax),% ymm0 <br>  vmovdqu a + 32 (% rax,% rax),% ymm2 <br>  vpand% ymm0,% ymm3,% ymm1 <br>  vpsrlw $ 8,% ymm0,% ymm0 <br>  vpand% ymm2,% ymm3,% ymm4 <br>  vpsrlw $ 8,% ymm2,% ymm2 <br>  vpackuswb% ymm4,% ymm1,% ymm1 <br>  vpermq $ 216,% ymm1,% ymm1 <br>  vpackuswb% ymm2,% ymm0,% ymm0 <br>  vpermq $ 216,% ymm0,% ymm0 <br></td></tr></tbody></table>  From the above, the conclusion follows: using GCC 5.0, you can significantly speed up the performance of applications similar to those described above.  You can start trying now!  Most edits are planned to be ported to Android NDK. <br><br>  Compilers used in measurements: <br><ul><li>  <a href="">GCC 4.9</a> , </li><li>  <a href="https://gcc.gnu.org/viewcvs/gcc/trunk/%3Fpathrev%3D218160">GCC 5.0 trunk, revision 218160</a> . </li></ul><br>  You can download the example on which measurements were taken from the <a href="https://software.intel.com/en-us/blogs/2014/11/24/what-is-new-for-x86-in-upcoming-gcc-50">original text of the article in English</a> . </div><p>Source: <a href="https://habr.com/ru/post/244137/">https://habr.com/ru/post/244137/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244127/index.html">14 effective tips for content marketing for small businesses (part 2)</a></li>
<li><a href="../244129/index.html">Search for a site for hackathon. HackDay Experience</a></li>
<li><a href="../244131/index.html">How to easily and simply teach your Asterisk to call through the desired operator</a></li>
<li><a href="../244133/index.html">Redirect users by rules to Squid</a></li>
<li><a href="../244135/index.html">Climate Control at Arduino</a></li>
<li><a href="../244139/index.html">Keyboard Octodon: Throwing and Metamorphosis</a></li>
<li><a href="../244141/index.html">Media Player for Translators - feci quod potui</a></li>
<li><a href="../244143/index.html">Bypassing the protection of the iOS client Dropbox</a></li>
<li><a href="../244145/index.html">Interview with Moses Uretsky, co-founder and director of Digital Ocean</a></li>
<li><a href="../244151/index.html">OpenVZ, Quagga and LiveMigration</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>