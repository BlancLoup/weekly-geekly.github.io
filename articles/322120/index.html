<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A tale about how I treated a server with WP, or 700 users online on 2 cores</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, Friday is clear, brave young man or red maid! 

 You can believe me, you can not believe me, but this tale began with a couple of news on my...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A tale about how I treated a server with WP, or 700 users online on 2 cores</h1><div class="post__text post__text-html js-mediator-article">  Good day, Friday is clear, brave young man or red maid! <br><br>  You can believe me, you can not believe me, but this tale began with a couple of news on my e-mail and here is such a picture, beauty unwritten: <br><br><img src="https://blog-static.saraeff.net/uploads/2017/02/07-02-2017-07-52-50_c1a2cc12bc770476.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This is 500 brave good fellows online (by dispatch from Google) on the overseas engine, wordpress called, on the server Intel Xeon E3 1245v2 (soyoustart, E3-SSD-3).  A manuscript was attached to the canvas to help in optimizing this economy. <br><a name="habracut"></a><br>  <strong>Disclaimer:</strong> <em>This article shows quick diagnostics of a buggy server and lists configs that you might find useful.</em>  <em>If you have something to supplement or criticize, do not hesitate to write about it in the comments, for one head is worse than two, two is worse than three, and n-1 is worse than n.</em>  <em>Infections, torn from the server are flooded with gist with acc.</em>  <em>comments as private, clear the stump that you should not run them on the system, for this there is a debug and <a href="http://ideone.com/">ideone.com</a> .</em> <br><br>  I was still lazily hanging on Skype and wanted to remove the damage on the phone, as a rule it works, because copy-paste does not lie until the spaces after the passwords are copied. <br><br><pre><code class="hljs swift">netstat -ntu | awk '{<span class="hljs-built_in"><span class="hljs-built_in">print</span></span> $<span class="hljs-number"><span class="hljs-number">5</span></span>}'| cut -d: -f1 | <span class="hljs-built_in"><span class="hljs-built_in">sort</span></span> | uniq -<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> | <span class="hljs-built_in"><span class="hljs-built_in">sort</span></span> -nr | more</code> </pre> <br>  gave out: <br><br><img src="https://blog-static.saraeff.net/uploads/2017/02/07-02-2017-07-56-43_07bd0919a3a6ee81.png"><br><br>  After the command: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">iptables</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-I</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">INPUT</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-s</span></span> 188<span class="hljs-selector-class"><span class="hljs-selector-class">.138</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.89</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.112</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-j</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DROP</span></span></code> </pre> <br>  It became beautiful: <br><br><img src="https://blog-static.saraeff.net/uploads/2017/02/07-02-2017-08-03-48_dbf3116661e20590.png" width="699" height="293"><br><br>  But all php reared, including filled phpinfo (). <br><br>  Still driven by the desire to solve remotely and not wanting to connect, I asked to run <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">tcpdump</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-i</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eth0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dst</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span> 188<span class="hljs-selector-class"><span class="hljs-selector-class">.138</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.89</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.112</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-v</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-XX</span></span></code> </pre> <br>  and then unban: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">iptables</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-D</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">INPUT</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-s</span></span> 188<span class="hljs-selector-class"><span class="hljs-selector-class">.138</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.89</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.112</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-j</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DROP</span></span></code> </pre> <br>  After that they sent me a log: <br><br><pre> <code class="hljs go"> Host: broin.top Accept: *<span class="hljs-comment"><span class="hljs-comment">/* 0x0000: 0007 b400 0102 3860 7713 ffbe 0800 4500 ......8`w.....E. 0x0010: 006f 900d 4000 4006 0592 2e69 6086 bc8a .o..@.@....i`... 0x0020: 5970 d8f5 0050 3be0 6f97 6bd8 b0e4 8018 Yp...P;.ok.... 0x0030: 00e5 a54b 0000 0101 080a 03dd ffa0 4221 ...K..........B! 0x0040: da17 4745 5420 2f6c 6e6b 2f69 6e6a 2e70 ..GET./lnk/inj.p 0x0050: 6870 2048 5454 502f 312e 310d 0a48 6f73 hp.HTTP/1.1..Hos 0x0060: 743a 2062 726f 696e 2e74 6f70 0d0a 4163 t:.broin.top..Ac 0x0070: 6365 7074 3a20 2a2f 2a0d 0a0d 0a cept:.*/</span></span>*.... <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span>:<span class="hljs-number"><span class="hljs-number">17.765232</span></span> IP (tos <span class="hljs-number"><span class="hljs-number">0x0</span></span>, ttl <span class="hljs-number"><span class="hljs-number">64</span></span>, id <span class="hljs-number"><span class="hljs-number">50803</span></span>, offset <span class="hljs-number"><span class="hljs-number">0</span></span>, flags [DF], proto TCP (<span class="hljs-number"><span class="hljs-number">6</span></span>), length <span class="hljs-number"><span class="hljs-number">52</span></span>) server.s<span class="hljs-number"><span class="hljs-number">.55540</span></span> &gt; xray874.dedicatedpanel.com.http: Flags [.], cksum <span class="hljs-number"><span class="hljs-number">0xa510</span></span> (incorrect -&gt; <span class="hljs-number"><span class="hljs-number">0x6231</span></span>), ack <span class="hljs-number"><span class="hljs-number">15929</span></span>, win <span class="hljs-number"><span class="hljs-number">477</span></span>, options [nop,nop,TS val <span class="hljs-number"><span class="hljs-number">64880546</span></span> ecr <span class="hljs-number"><span class="hljs-number">1109514777</span></span>], length <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0x0000</span></span>: <span class="hljs-number"><span class="hljs-number">0007</span></span> b400 <span class="hljs-number"><span class="hljs-number">0102</span></span> <span class="hljs-number"><span class="hljs-number">3860</span></span> <span class="hljs-number"><span class="hljs-number">7713</span></span> ffbe <span class="hljs-number"><span class="hljs-number">0800</span></span> <span class="hljs-number"><span class="hljs-number">4500</span></span> .....<span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-string"><span class="hljs-string">`w.....E. 0x0010: 0034 c673 4000 4006 cf66 2e69 6086 bc8a .4.s@.@..fi`</span></span>... <span class="hljs-number"><span class="hljs-number">0x0020</span></span>: <span class="hljs-number"><span class="hljs-number">5970</span></span> d8f4 <span class="hljs-number"><span class="hljs-number">0050</span></span> <span class="hljs-number"><span class="hljs-number">8d</span></span>4b <span class="hljs-number"><span class="hljs-number">3</span></span>a3b a61a <span class="hljs-number"><span class="hljs-number">0724</span></span> <span class="hljs-number"><span class="hljs-number">8010</span></span> Yp...PK:;...$.. <span class="hljs-number"><span class="hljs-number">0x0030</span></span>: <span class="hljs-number"><span class="hljs-number">01d</span></span>d a510 <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">0101</span></span> <span class="hljs-number"><span class="hljs-number">080</span></span>a <span class="hljs-number"><span class="hljs-number">03d</span></span>d ffa2 <span class="hljs-number"><span class="hljs-number">4221</span></span> ..............B! <span class="hljs-number"><span class="hljs-number">0x0040</span></span>: da19 .. <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span>:<span class="hljs-number"><span class="hljs-number">17.765486</span></span> IP (tos <span class="hljs-number"><span class="hljs-number">0x0</span></span>, ttl <span class="hljs-number"><span class="hljs-number">64</span></span>, id <span class="hljs-number"><span class="hljs-number">50804</span></span>, offset <span class="hljs-number"><span class="hljs-number">0</span></span>, flags [DF], proto TCP (<span class="hljs-number"><span class="hljs-number">6</span></span>), length <span class="hljs-number"><span class="hljs-number">52</span></span>) server.s<span class="hljs-number"><span class="hljs-number">.55540</span></span> &gt; xray874.dedicatedpanel.com.http: Flags [.], cksum <span class="hljs-number"><span class="hljs-number">0xa510</span></span> (incorrect -&gt; <span class="hljs-number"><span class="hljs-number">0x5c72</span></span>), ack <span class="hljs-number"><span class="hljs-number">17377</span></span>, win <span class="hljs-number"><span class="hljs-number">500</span></span>, options [nop,nop,TS val <span class="hljs-number"><span class="hljs-number">64880546</span></span> ecr <span class="hljs-number"><span class="hljs-number">1109514777</span></span>], length <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0x0000</span></span>: <span class="hljs-number"><span class="hljs-number">0007</span></span> b400 <span class="hljs-number"><span class="hljs-number">0102</span></span> <span class="hljs-number"><span class="hljs-number">3860</span></span> <span class="hljs-number"><span class="hljs-number">7713</span></span> ffbe <span class="hljs-number"><span class="hljs-number">0800</span></span> <span class="hljs-number"><span class="hljs-number">4500</span></span> .....<span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-string"><span class="hljs-string">`w.....E. 0x0010: 0034 c674 4000 4006 cf65 2e69 6086 bc8a .4.t@.@..ei`</span></span>... <span class="hljs-number"><span class="hljs-number">0x0020</span></span>: <span class="hljs-number"><span class="hljs-number">5970</span></span> d8f4 <span class="hljs-number"><span class="hljs-number">0050</span></span> <span class="hljs-number"><span class="hljs-number">8d</span></span>4b <span class="hljs-number"><span class="hljs-number">3</span></span>a3b a61a <span class="hljs-number"><span class="hljs-number">0</span></span>ccc <span class="hljs-number"><span class="hljs-number">8010</span></span> Yp...PK:;...... <span class="hljs-number"><span class="hljs-number">0x0030</span></span>: <span class="hljs-number"><span class="hljs-number">01f</span></span>4 a510 <span class="hljs-number"><span class="hljs-number">0000</span></span> <span class="hljs-number"><span class="hljs-number">0101</span></span> <span class="hljs-number"><span class="hljs-number">080</span></span>a <span class="hljs-number"><span class="hljs-number">03d</span></span>d ffa2 <span class="hljs-number"><span class="hljs-number">4221</span></span> ..............B!</code> </pre><br>  It can be seen that <code>http://broin.top/lnk/inj.php</code> twitching, here is the link to <a href="https://gist.github.com/nikitasius/95e774e7f02b3bbf9c52b5fe78d18ce6">gist</a> and <a href="https://gist.github.com/nikitasius/ffea37b463c306a59f1bf2ba12f3086a">decoded</a> . <br>  My laziness prompted the unfortunate admin, saying to find all the moments of turning on this outrage.  Files were found, the paths relative to the "root of the site": <br><br><ul><li>  / cgi-bin / <a href="https://gist.github.com/nikitasius/0411a5c6645918205007ec27d4131c61">.bt</a> </li><li>  / cgi-bin / <a href="https://gist.github.com/nikitasius/8637526db18c8d622cbe6ab1b3328c2a">.crc</a> </li></ul><br>  I then asked me to drop index.php from WP and got this miracle <br><br><pre> <code class="hljs css">@<span class="hljs-keyword"><span class="hljs-keyword">include_once</span></span>('./<span class="hljs-keyword"><span class="hljs-keyword">wp</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">includes</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">wp</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">mod</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">php</span></span>');</code> </pre> <br>  As a result, under the distribution got a pack of files in <strong>/ wp-includes /</strong> : <br><br><ul><li>  9f120c79d956d543a1cd44902f0f50056b3338cc1136effb6c208bf46fcf74fd <a href="https://gist.github.com/nikitasius/42091270882f3762e95b664f51e57c35">wp-010617.php</a> </li><li>  d0eb12533eed5d316504573976e611a71fd066f8fe5591422f6f49cdcaa8ff5e <a href="https://gist.github.com/nikitasius/e3032d69a06c0b0c51f56d9a56e8eb87">wp-0bf.php</a> </li><li>  cfb91fbc45eb7a74791a7845e7b18c2b8771b217ee27150a6f8422a1a073cc6d <a href="https://gist.github.com/nikitasius/25ba12d8169f329f83c5c3c0104ac81c">wp-accuracy.php</a> </li><li>  d67051bc4d20782f770dac771cfdf68e876156a0b012be2462f8a436dad07ceb <a href="https://gist.github.com/nikitasius/ce52e21ab3339bbb737dcf5540163503">wp-file.php</a> </li><li>  5503f88744374570f9168216ee174ced87c80ef17d8f17accb2001f985862267 <a href="https://gist.github.com/nikitasius/d5a7086a40ab155d3537b2af840f1d2b">wp-fiscal.php</a> </li><li>  ee53973940016c403f457762e0c270d9729a101337bcdf3d6e4667b050549316 <a href="https://gist.github.com/nikitasius/7df3b4599ccf4ca27abe649312458163">wp-mod.php</a> </li><li>  5361bdbd75b368e79d17a47282f0ce6cd2759ccfdef8833ff38fe2a5dee95170 <a href="https://gist.github.com/nikitasius/afd0b4ece440a0aea5640f45f31271ec">wp-obf.php</a> </li><li>  89e96f69b8cb9d54959b300cc03b1312a0500c24ddffb6659e6acb688a1cfd8d <a href="https://gist.github.com/nikitasius/709e668f1208d98a47eb8619b4f8ba5d">wp-pas.php</a> </li><li>  6c752d54255ead4b7db10e00f7b53ba9132b0c143c5bb3f667e2a81eb98801cc <a href="https://gist.github.com/nikitasius/5b94bda0ec6842eb983cd5ed5911681a">wp-wso.php</a> </li></ul><br>  In general, it was no longer possible to stand aside, and I took ssh access to a modest freshly installed (February 2017) debian 7, php 5.4, ISP demo panel flavored with proftpd ... with apache to the heap (by the same sites php-fpm taxied) ... <br><br>  After searching for php files in different directories, I ran into <strong>/ wp-content / uploads /</strong> : <br><br><ul><li>  cfb91fbc45eb7a74791a7845e7b18c2b8771b217ee27150a6f8422a1a073cc6d <a href="https://gist.github.com/nikitasius/eb44e33f687f7657a3238c0800042516">wp-accuracy.php</a> </li><li>  5503f88744374570f9168216ee174ced87c80ef17d8f17accb2001f985862267 <a href="https://gist.github.com/nikitasius/a27f47ba9093e3b89f6b7986e9ab6071">wp-fiscal.php</a> </li><li>  9b53f3e7243b78e6d0978817aab98c58e4598aa6a3c012ed10621b6e59c9283e <a href="https://gist.github.com/nikitasius/4e0e83c294a4e100210c78d39a79224d">wp-uso.php</a> </li></ul><br>  Then in the folder <strong>/ wp-content / plugins /</strong> , I did not download similar files: <br><br><ul><li>  cfb91fbc45eb7a74791a7845e7b18c2b8771b217ee27150a6f8422a1a073cc6d <a href="https://gist.github.com/nikitasius/eb44e33f687f7657a3238c0800042516">wp-accuracy.php</a> </li><li>  510785b58d10fc7687a63548adffc4cee82b68974fe1c349824d90cbfbfe39e7 <a href="https://gist.github.com/nikitasius/8ed5f0f6911e2df6423f2bf9222c708a">wp-dojika.php</a> </li><li>  d67051bc4d20782f770dac771cfdf68e876156a0b012be2462f8a436dad07ceb <a href="https://gist.github.com/nikitasius/ce52e21ab3339bbb737dcf5540163503">wp-file.php</a> </li><li>  5503f88744374570f9168216ee174ced87c80ef17d8f17accb2001f985862267 <a href="https://gist.github.com/nikitasius/a27f47ba9093e3b89f6b7986e9ab6071">wp-fiscal.php</a> </li><li>  86a4d9ef20d506eab64ece2ef1c6555bc2404c4ded0aac6a846d64837e1a509b <a href="https://gist.github.com/nikitasius/c275e4111ff11c1dd22f4373c0f30bc6">wp-jojiro.php</a> </li><li>  5361bdbd75b368e79d17a47282f0ce6cd2759ccfdef8833ff38fe2a5dee95170 <a href="https://gist.github.com/nikitasius/afd0b4ece440a0aea5640f45f31271ec">wp-obf.php</a> </li><li>  5361bdbd75b368e79d17a47282f0ce6cd2759ccfdef8833ff38fe2a5dee95170 <a href="https://gist.github.com/nikitasius/afd0b4ece440a0aea5640f45f31271ec">wp-orekio.php</a> </li><li>  89e96f69b8cb9d54959b300cc03b1312a0500c24ddffb6659e6acb688a1cfd8d <a href="https://gist.github.com/nikitasius/709e668f1208d98a47eb8619b4f8ba5d">wp-pas.php</a> </li><li>  6c752d54255ead4b7db10e00f7b53ba9132b0c143c5bb3f667e2a81eb98801cc <a href="https://gist.github.com/nikitasius/5b94bda0ec6842eb983cd5ed5911681a">wp-wso.php</a> </li></ul><br>  wp-dojika.php is a Game of trones fan as wp-jojiro.php. <br><br>  As you can see - they obfustsirovany.  In one way or another, the next step I chose all php with <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">grep</span></span> -A <span class="hljs-number"><span class="hljs-number">3</span></span> -B <span class="hljs-number"><span class="hljs-number">3</span></span> --include=\<span class="hljs-regexp"><span class="hljs-regexp">*.php</span></span> -rnw <span class="hljs-string"><span class="hljs-string">'/path/to/www/'</span></span> -e <span class="hljs-string"><span class="hljs-string">".*base64_decode.*"</span></span></code> </pre> <br>  and found another one, <a href="https://gist.github.com/nikitasius/24fbb88baa412dea239bc8d2b0e22586">WAIpro.php</a> , from which <a href="https://gist.github.com/nikitasius/26306c111fd0d9ccf897fb2a3889b770">such a</a> decoded file is torn out, which pulls a lot of different nasty things, like for example <strong>apiword.press/addadmin_1.txt</strong> ( <a href="https://gist.github.com/nikitasius/2ba2184e68438428cf76721a8fe71f87">gist</a> ). <br><br>  Files have been moved for future picking. <br><br>  Traffic dropped very much.  After a day of going in and seeing the increased traffic, I ordered: <br><br><pre> <code class="hljs matlab">tcpdump -<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> eth0 dst port <span class="hljs-number"><span class="hljs-number">25</span></span> -v -XX</code> </pre> <br>  I got a sheet that was spinning faster than an army fan from the same name adegdot.  After shutting down php, the problem did not disappear.  I do not believe, I said and entered <code>crontab -u admin -e</code> . <br><br>  ... and, cherry on the cake, was the conclusion: <br><br><pre> <code class="hljs pgsql">crontab -u <span class="hljs-keyword"><span class="hljs-keyword">admin</span></span> -e</code> </pre> <br><pre> <code class="hljs javascript">*<span class="hljs-regexp"><span class="hljs-regexp">/10 * * * * /</span></span><span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/tmp/eumqvTiN &gt;<span class="hljs-regexp"><span class="hljs-regexp">/dev/</span></span><span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  Then sha256sum: <br><br><pre> <code class="hljs go"><span class="hljs-number"><span class="hljs-number">694f</span></span>c1f7f17d5f3c447fcdb83fa6177b736b241430e70309a4b3111ef1d0e3b9 eumqvTiN</code> </pre> <br>  Which is someone other than <a href="https://virustotal.com/en/file/694fc1f7f17d5f3c447fcdb83fa6177b736b241430e70309a4b3111ef1d0e3b9/analysis/1486762026/">Linux / Mumblehard.U</a> .  How he got there ... honestly to understand it was already too lazy.  Fortunately, the unfortunate admin had his old virtual (OVH VPS SSD 3), paid until February 21, with which this was transferred by another goreadmin on February 4 due to the fact that she (virtual) could not cope with the load.  And the "unfortunate admin" came out to me on February 6 with a simple request to optimize this economy. <br><br>  As a result, the site (as it is possible) was cleared of the biak stuck on it, transferred to the rearranged old virtual machine (which boldly sent spam to the full width of the channel), and now it shows the following modest numbers, the value is in peak (700 users online by googleAnal, cache 3 seconds): <br><br><img src="https://blog-static.saraeff.net/uploads/2017/02/Screenshot-02172017-022614-PM_ec941423b3882c1c.png"><br><br>  The configuration is quite simple: php-fpm 7.0.16 (7.1.1 is not perceived by some plugins) <br><br><pre> <code class="hljs actionscript">./configure --prefix=/opt/php<span class="hljs-number"><span class="hljs-number">-7.0</span></span> --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-pdo-pgsql --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-zlib-dir --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-freetype-dir --enable-mbstring --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-libxml-dir=/usr --enable-soap --enable-calendar --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-curl --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-mcrypt --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-zlib --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-gd --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-pgsql --disable-rpath --enable-inline-optimization --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-bz2 --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-zlib --enable-sockets --enable-sysvsem --enable-sysvshm --enable-pcntl --enable-mbregex --enable-exif --enable-bcmath --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-mhash --enable-zip --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-pcre-regex --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-pdo-mysql --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-mysqli --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-mysql-sock=/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/run/mysqld/mysqld.sock --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-jpeg-dir=/usr --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-png-dir=/usr --enable-gd-<span class="hljs-keyword"><span class="hljs-keyword">native</span></span>-ttf --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-openssl --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-fpm-user=www-data --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-fpm-group=www-data --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-libdir=/lib/x86_64-linux-gnu --enable-ftp --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-imap --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-imap-ssl --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-kerberos --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-gettext --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-xmlrpc --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-xsl --enable-opcache --enable-fpm --enable-intl</code> </pre> <br>  + memcached <br><br>  fpm-fpm sits in chroot, <br><br><pre> <code class="hljs pgsql">[wwwsomeone] <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> = <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">9001</span></span> <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span>.allowed_clients = <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = wwwsomeone <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> = wwwsomeone pm = dynamic pm.max_children = <span class="hljs-number"><span class="hljs-number">50</span></span> pm.start_servers = <span class="hljs-number"><span class="hljs-number">10</span></span> pm.min_spare_servers = <span class="hljs-number"><span class="hljs-number">5</span></span> pm.max_spare_servers = <span class="hljs-number"><span class="hljs-number">10</span></span> chroot = /<span class="hljs-type"><span class="hljs-type">path</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>/folder chdir = / catch_workers_output = yes</code> </pre><br>  Nginx is also on a fairly simple configuration (fpm is hooked up on the port, not on the socket), and the cache looks like: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">fastcgi_cache_key</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$scheme</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$server_name</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$server_port</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$request_uri</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_cache</span></span> mapcgi; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_cache_lock</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_cache_lock_timeout</span></span> <span class="hljs-number"><span class="hljs-number">6s</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_cache_valid</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">301</span></span> <span class="hljs-number"><span class="hljs-number">302</span></span> <span class="hljs-number"><span class="hljs-number">304</span></span> <span class="hljs-number"><span class="hljs-number">3s</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_cache_valid</span></span> <span class="hljs-number"><span class="hljs-number">403</span></span> <span class="hljs-number"><span class="hljs-number">404</span></span> <span class="hljs-number"><span class="hljs-number">10s</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_no_cache</span></span> <span class="hljs-variable"><span class="hljs-variable">$cookie_wordpress_auth_cookie</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_cache_methods</span></span> GET HEAD;</code> </pre> <br>  Where <code>$cookie_wordpress_auth_cookie</code> checks for wordpress_auth_cookie cookies and disables the caching of responses.  Now the cache is, why the load fell the most: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">fastcgi_cache_lock_timeout</span></span> <span class="hljs-number"><span class="hljs-number">10s</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_cache_valid</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">301</span></span> <span class="hljs-number"><span class="hljs-number">302</span></span> <span class="hljs-number"><span class="hljs-number">304</span></span> <span class="hljs-number"><span class="hljs-number">2m</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_cache_valid</span></span> <span class="hljs-number"><span class="hljs-number">403</span></span> <span class="hljs-number"><span class="hljs-number">404</span></span> <span class="hljs-number"><span class="hljs-number">30s</span></span>;</code> </pre> <br>  The cache is on the remdisk (tmpfs) with a capacity of 1 GB.  If anyone is interested in tests of the same PPS (but empty), then <a href="https://gist.github.com/nikitasius/d75cb2ac0a3ee7016c1e0e2aa695e0d4">here they are</a> (gist). <br><br>  Dynamics is given at 12 r / sec, static at 256 r / sec.  Basically, the cache is all over the head ... 470 online without the nginx cache: <br><br><img src="https://blog-static.saraeff.net/uploads/2017/02/Screenshot-02172017-085035-PM_e255651efc1220b4.png"><br><br>  Here with the nginx cache: <br><br><img src="https://blog-static.saraeff.net/uploads/2017/02/Screenshot-02172017-085611-PM_0d0f9b570c1e59aa.png"><br><br>  <s>MySQL</s> MariaDB is different from the default code below: <br><br><pre> <code class="hljs pgsql">[mysqld] <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = mysql pid-file = /var/run/mysqld/mysqld.pid socket = /var/run/mysqld/mysqld.sock port = <span class="hljs-number"><span class="hljs-number">3306</span></span> basedir = /usr datadir = /var/lib/mysql tmpdir = /tmp #init-<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>=<span class="hljs-string"><span class="hljs-string">'SET NAMES utf8'</span></span> lc-messages-dir = /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/mysql <span class="hljs-keyword"><span class="hljs-keyword">language</span></span> = /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/mysql/english skip-<span class="hljs-keyword"><span class="hljs-keyword">external</span></span>-locking bind-address = <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">collation</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> = utf8_unicode_ci <span class="hljs-type"><span class="hljs-type">character</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> = utf8 event_scheduler = <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> innodb_file_per_table = <span class="hljs-number"><span class="hljs-number">1</span></span> innodb_flush_method=O_DIRECT innodb_lock_wait_timeout = <span class="hljs-number"><span class="hljs-number">50</span></span> innodb_buffer_pool_size = <span class="hljs-number"><span class="hljs-number">1</span></span>G join_buffer_size = <span class="hljs-number"><span class="hljs-number">32</span></span>M max_connections = <span class="hljs-number"><span class="hljs-number">1024</span></span> max_allowed_packet = <span class="hljs-number"><span class="hljs-number">256</span></span>M max_join_size = <span class="hljs-number"><span class="hljs-number">4096000</span></span> myisam_sort_buffer_size = <span class="hljs-number"><span class="hljs-number">32</span></span>M myisam-recover = BACKUP thread_cache_size = <span class="hljs-number"><span class="hljs-number">16</span></span> key_buffer_size=<span class="hljs-number"><span class="hljs-number">32</span></span>M net_buffer_length = <span class="hljs-number"><span class="hljs-number">16</span></span>K read_buffer_size=<span class="hljs-number"><span class="hljs-number">64</span></span>M read_rnd_buffer_size = <span class="hljs-number"><span class="hljs-number">8</span></span>M sort_buffer_size = <span class="hljs-number"><span class="hljs-number">32</span></span>M bulk_insert_buffer_size = <span class="hljs-number"><span class="hljs-number">256</span></span>M expire_logs_days = <span class="hljs-number"><span class="hljs-number">10</span></span> max_binlog_size = <span class="hljs-number"><span class="hljs-number">100</span></span>M # tmp_table_size = <span class="hljs-number"><span class="hljs-number">1</span></span>G max_heap_table_size = <span class="hljs-number"><span class="hljs-number">1</span></span>G # table_cache = <span class="hljs-number"><span class="hljs-number">8192</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>-files-<span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> = <span class="hljs-number"><span class="hljs-number">262144</span></span> <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">isolation</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">READ</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">COMMITTED</span></span> query_cache_type = <span class="hljs-number"><span class="hljs-number">2</span></span> query_cache_limit = <span class="hljs-number"><span class="hljs-number">2</span></span>M query_cache_size = <span class="hljs-number"><span class="hljs-number">256</span></span>M connect_timeout=<span class="hljs-number"><span class="hljs-number">30</span></span> wait_timeout=<span class="hljs-number"><span class="hljs-number">300</span></span></code> </pre> <br>  Logs of access and nginx errors are written actively (1.5GB per day), the flight is normal for 3 days and the server is clean, judging by the logs and activity in general, including the fpm log. <br><br>  Also in the fpm log already in the fresh PRT: <br><br><pre> <code class="hljs sql">[16-Feb-2017 23:06:42] WARNING: [pool www] child 15075 said into stderr: "NOTICE: PHP message: PHP Fatal error: Uncaught Error: <span class="hljs-keyword"><span class="hljs-keyword">Call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> undefined <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> mysql_escape_string() <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /www/wp-<span class="hljs-keyword"><span class="hljs-keyword">content</span></span>/themes/------/functions.php:<span class="hljs-number"><span class="hljs-number">60</span></span><span class="hljs-string"><span class="hljs-string">"</span></span></code> </pre> <br><ul><li>  3622502af8083e53ced808af6ca7aca0bd3cb088d1df309964ab865f51ec90ca <a href="https://gist.github.com/nikitasius/efb2df45cd308d0a6edda6264c5f0163">functions.php</a> </li></ul><br>  After that, there were searches for files that may be similar to functions.php in one way or another (similar commands), but nothing suspicious was found. <br><br>  The next step will be to lock sites for cloudflare, playing <code>add_header Cache-Control "public, max-age=123456789";</code>  for content without authorization and <code>add_header Cache-Control "private, max-age=0";</code>  when cookies are present in the response and enable their firewall, providing additional protection for the ‚Äúhapless admin‚Äù and his blogs. <br><br>  Warm sun and a real weekend! </div><p>Source: <a href="https://habr.com/ru/post/322120/">https://habr.com/ru/post/322120/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../322104/index.html">How to reduce the number of unsubscribe from the newsletter</a></li>
<li><a href="../322106/index.html">Problems of ergonomics of the workplace. Chapter from the book ‚ÄúErgonomic workplace design‚Äù 2017</a></li>
<li><a href="../322108/index.html">Wordpress + CloudFlare - fresh move to https</a></li>
<li><a href="../322112/index.html">SDS, Cloudless Cloud, Aruba, and Composable Infrastructure: New HPE Webinars</a></li>
<li><a href="../322116/index.html">Problems encountered in the development of android-applications</a></li>
<li><a href="../322130/index.html">Testing the Documented API with the Apiary Dredd Utility</a></li>
<li><a href="../322132/index.html">Detailed introduction to rvalue links for those who lacked a short</a></li>
<li><a href="../322134/index.html">[Bughunting] Blind XSS vulnerability on omnidesk support sites</a></li>
<li><a href="../322138/index.html">The worst technological forecasts for the last 150 years</a></li>
<li><a href="../322140/index.html">Graphic description of ownership and borrowing in Rust</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>