<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple solution for on-the-fly image processing with result caching</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today, in almost any web application that uses images, there is a need to form reduced copies of these images with some possible additional modificati...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple solution for on-the-fly image processing with result caching</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/52e/b83/360/52eb8336005c45c7353b271a6bdbe67e.png" align="left">  Today, in almost any web application that uses images, there is a need to form reduced copies of these images with some possible additional modification, for example: watermark, shades of gray, sepia, etc. <br>  For details, let's designate such a list of requirements: <br><br><ol><li>  resize images for any size (adding new sizes should not cause a headache) </li><li>  image modification: adding a watermark, applying effects to grayscale, sepia and generally adding new effects should not be a difficult task </li><li>  image processing should not affect the main thread (page loading speed) </li><li>  To speed up the loading of images on the page, the solution should allow to bypass the limit of simultaneous connections in browsers, <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html">more about the limit</a> ( <a href="http://lib.ru/WEBMASTER/rfc2068/section-8.html">rus</a> ) </li><li>  to avoid the possibility of clogging the server by explicitly passing the resize parameters to the url </li><li>  cache the results of work </li></ol><br><a name="habracut"></a><br><h4>  Decision </h4><br>  To begin with, I argue the choice of means for solving this problem.  Among the considered libraries for working with images in PHP, I identified 3 main ones: <a href="https://github.com/meze/wideimage">Wideimage</a> , <a href="https://github.com/masterexploder/PHPThumb">PHPThumb</a> , <a href="https://github.com/avalanche123/Imagine">Imagine</a> .  The last one was my choice, since the first two have not been updated for a very long time and it is not clear whether.  I chose <a href="http://twig.sensiolabs.org/">Twig</a> as a template engine for which I adapted this solution.  Well, I chose Nginx and Apache as web servers.  Nginx - for dedicated servers, and Apache for performance on the ball hosting. <br><br>  <a href="https://github.com/esvit/bazalt-thumbs">GitHub Repository</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Ready solution looks like this: <br>  in PHP <br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> thumb(<span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/images/Chrysanthemum.jpg'</span></span>, <span class="hljs-string"><span class="hljs-string">'200x100'</span></span>, [ <span class="hljs-string"><span class="hljs-string">"watermark"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"right top"</span></span> ]);</code> </pre> <br>  on Twig <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ image|thumb("</span></span></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">200x200</span></span></span><span class="hljs-tag">", { "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">watermark</span></span></span><span class="hljs-tag">"</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">right</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bottom</span></span></span><span class="hljs-tag">", "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">grayscale</span></span></span><span class="hljs-tag">"</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">true</span></span></span><span class="hljs-tag"> }) }}" /&gt;</span></span></code> </pre><br>  For this filter to be available, you need to connect an extension for Twig. <br><pre> <code class="php hljs">$twig-&gt;addExtension(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \Bazalt\Thumbs\Extension());</code> </pre><br><br><h5>  1. Resize images for any size </h5><br>  As you can see, the second parameter of the <code>thumb</code> function takes the size of the image, the default algorithm is to cut the edges to the specified size, if after a proportional reduction in size, one of the sides climbs.  If one of the parameters is set to 0, the image will be proportionally reduced, and the size of the second side will be proportionally calculated, for example, an image with a size of 400x300 with a size parameter of '200x0' will have a size of 200x150 and with a size of '0x200' - 266x200. <br><br><h5>  2. Image modification </h5><br>  The extension of the image modification functionality is made very simple.  There is an <a href="https://github.com/esvit/bazalt-thumbs/blob/master/src/Bazalt/Thumbs/Operations.php">Operations</a> class, which in the basic version has only the <code>size</code> function, in order to add its functionality it just needs to inherit and describe the necessary functions in it.  The third parameter of the function <code>thumb</code> is responsible just for calling these additional modifiers, this is an array of the key which is the name of the function, and the value of the option that will be passed to this function. <br><br><div class="spoiler">  <b class="spoiler_title">An example of several modifiers</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Operations</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bazalt</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Thumbs</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Operations</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">watermark</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\Imagine\Image\ImageInterface $image, $options, $allOptions)</span></span></span><span class="hljs-function"> </span></span>{ $imagine = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \Imagine\Gd\Imagine(); $wm = $imagine-&gt;open(<span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/images/watermark.png'</span></span>); $size = $image-&gt;getSize(); $wmSize = $wm-&gt;getSize(); <span class="hljs-keyword"><span class="hljs-keyword">list</span></span>($x, $y) = explode(<span class="hljs-string"><span class="hljs-string">' '</span></span>, $options); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_numeric($x)) { $x = ($x == <span class="hljs-string"><span class="hljs-string">'right'</span></span>) ? ($size-&gt;getWidth() - $wmSize-&gt;getWidth()) : <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($x &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) $x = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_numeric($y)) { $y = ($y == <span class="hljs-string"><span class="hljs-string">'bottom'</span></span>) ? ($size-&gt;getHeight() - $wmSize-&gt;getHeight()) : <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($y &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) $y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } $point = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \Imagine\Image\Point($x, $y); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image-&gt;paste($wm, $point); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">grayscale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\Imagine\Image\ImageInterface $image, $options, $allOptions)</span></span></span><span class="hljs-function"> </span></span>{ $image-&gt;effects()-&gt;grayscale(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sepia</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\Imagine\Image\ImageInterface $image, $options, $allOptions)</span></span></span><span class="hljs-function"> </span></span>{ $image-&gt;effects() -&gt;grayscale() -&gt;colorize(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \Imagine\Image\Color(<span class="hljs-string"><span class="hljs-string">'#643200'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } }</code> </pre><br></div></div><br><br><h5>  3. Removal of image processing from the main stream </h5><br>  It is bad to process the image immediately in the place where it is found in the code, because as the number of images grows, the page loading speed grows.  The solution is simple - the generation of the processed image only upon request to it.  There are a lot of ready-made solutions on the Internet, which differs from mine already created by the fact that I propose to save the image processing parameters not in the url as GET request parameters or parts of the url itself, but to create some configuration file and write the path to the image, dimensions thumbnails and all other options.  Looking ahead, I immediately want to note that this also solves point 5 of the requirements. <br><br><h5>  4. Bypassing the limit of simultaneous connections in browsers </h5><br>  According to the HTTP 1.1 standard, the browser cannot load at the same time more than 2 requests from the same domain.  Decision?  Make several subdomains for static ( <b>cookieless domain</b> ) at the same time and traffic will be saved due to the fact that extra cookies will not be transmitted. <br><br>  You can use one of 3 options in the code: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//           //    -,  `php -S localhost:8080` \Bazalt\Thumbs\Image::initStorage(__DIR__ . '/static', '/thumb.php?file=/static'); //       - \Bazalt\Thumbs\Image::initStorage(__DIR__ . '/static', '/static'); //      -  cookieless  \Bazalt\Thumbs\Image::initStorage(__DIR__ . '/static', 'http://img%s.example.com/static'); //   %s     0x0-0xF    // img0.example.com, img1.example.com, ..., imge.example.com, imgf.example.com</span></span></code> </pre><br><br>  <i>On a large project, a CDN option is being considered, but this is beyond the scope of this article.</i> <br><br><h5>  5. Avoiding the possibility of server clogging by explicitly passing the resize parameters to the url </h5><br>  As partially described in paragraph 3 in the url for which the thumbnail is generated, there are no explicit indications of the parameters, which protects against busting the parameters in the url.  Of course, this problem could be solved by generating a secret key in addition to the request parameters and checking it on the server, but I believe that passing parameters to the url has its limitations.  I also want to emphasize a plus in my decision that you can configure the web server so that it will check the presence of thumbnails even without a request to the script. <br><br><h5>  6. Caching work results </h5><br>  The thumb function simply generates a configuration file if it isn‚Äôt already.  The name of this file is calculated by the hash of the processing parameters and the name of the image file.  The name of the configuration file is the same as the name of the thumbnail plus some extension.  For example, if the address " <code>/static/d1/7e/d17e248758722c42d8c88d21d8b538d7.jpg</code> " should be a thumbnail, then the configuration file will be called " <code>/static/d1/7e/d17e248758722c42d8c88d21d8b538d7.jpg.pre</code> " <br>  Processing is done when the browser sends a second request for a thumbnail. <br><br>  Settings for nginx: <br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /static/ { <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /www/public; <span class="hljs-attribute"><span class="hljs-attribute">try_files</span></span> <span class="hljs-variable"><span class="hljs-variable">$uri</span></span> /thumb.php?file=<span class="hljs-variable"><span class="hljs-variable">$uri</span></span>; }</code> </pre><br><br>  For Apache: <br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">RewriteCond</span></span></span></span> <span class="hljs-variable"><span class="hljs-variable">%{REQUEST_URI}</span></span> ^(/static/) RewriteCond <span class="hljs-variable"><span class="hljs-variable">%{SCRIPT_FILENAME}</span></span> !-f RewriteRule ^(.*)$ thumb.php?file=<span class="hljs-number"><span class="hljs-number">$1</span></span><span class="hljs-meta"><span class="hljs-meta"> [L]</span></span></code> </pre><br><br>  As you can see from the settings, if the file already exists, the web server gives it directly, and if not, then the thumb.php file will be called, which will create a thumbnail and save it to disk <br>  <i>These settings are not perfect, just to show the idea.</i> <br><br>  As a result, we have a simple solution to such a frequent task, I tried to describe all the pitfalls I encountered, if I missed something, I will be grateful for the piecework comments. </div><p>Source: <a href="https://habr.com/ru/post/181898/">https://habr.com/ru/post/181898/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../181880/index.html">Comparison of the effectiveness of minimizers CSS-and JavaScript-code</a></li>
<li><a href="../181882/index.html">AngularJS best practices</a></li>
<li><a href="../181886/index.html">6 indicators of web production efficiency</a></li>
<li><a href="../181890/index.html">Lower limit for CAPTCHA, White House</a></li>
<li><a href="../181896/index.html">Solving a problem of Russian open source projects</a></li>
<li><a href="../181900/index.html">State sites of Russia do not use the Open Document format. A small study + survey</a></li>
<li><a href="../181904/index.html">EVE Online and Dust 514 servers under DDoS attack and turned off</a></li>
<li><a href="../181906/index.html">LiveDC - Quick access to p2p files</a></li>
<li><a href="../181908/index.html">Texet TM-607TV: phone disguised as an Android smartphone</a></li>
<li><a href="../181910/index.html">Recovery of iPhoto when the import hangs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>