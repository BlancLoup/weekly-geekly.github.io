<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DoctrineSolrBundle - Search by Solct-based Doctrine entity on Symfony2 / 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="DoctrineSolrBundle 


 Good afternoon, I want to submit my symfony 2 bundle to automatically synchronize the Doctrine entity in Solr and the subsequen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DoctrineSolrBundle - Search by Solct-based Doctrine entity on Symfony2 / 3</h1><div class="post__text post__text-html js-mediator-article"><h3>  DoctrineSolrBundle </h3><br><p>  Good afternoon, I want to submit my symfony 2 bundle to automatically synchronize the Doctrine entity in Solr and the subsequent search.  The bundle is designed to work with Solr at the Doctrine entity level and avoids writing low-level solr queries.  The installation process and detailed documentation can be viewed on <a href="https://github.com/mdiyakov/DoctrineSolrBundle">github</a> . </p><br><h3>  Opportunities </h3><br><p>  The main (not all) search capabilities of the <a href="https://lucene.apache.org/solr/guide/6_6/the-standard-query-parser.html">standard Solr query parser are implemented</a> : </p><br><ul><li>  <a href="https://lucene.apache.org/solr/guide/6_6/the-standard-query-parser.html">Wildcard Searches</a> </li><li>  <a href="https://lucene.apache.org/solr/guide/6_6/the-standard-query-parser.html">Fuzzy searches</a> </li><li>  <a href="https://lucene.apache.org/solr/guide/6_6/the-standard-query-parser.html">Range searches</a> </li><li>  <a href="https://lucene.apache.org/solr/guide/6_6/the-standard-query-parser.html">Boosting a Term with ^</a> </li></ul><br><p>  Support for <a href="https://lucene.apache.org/solr/guide/6_6/suggester.html">SuggestComponent is</a> also implemented <a href="https://lucene.apache.org/solr/guide/6_6/suggester.html">.</a> </p><a name="habracut"></a><br><h3>  Configuration example </h3><br><p>  After installation, you need to configure a bundle in config.yml to get started.  An example of a minimal configuration of a bundle: </p><br><pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">mdiyakov_doctrine_solr</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">indexed_entities</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">page</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">class</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">AppBundle</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Entity</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Page</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">schema</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">page</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: type, value: page } <span class="hljs-selector-tag"><span class="hljs-selector-tag">schemes</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">page</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">document_unique_field</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: <span class="hljs-string"><span class="hljs-string">'uid'</span></span> } <span class="hljs-selector-tag"><span class="hljs-selector-tag">config_entity_fields</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">config_field_name</span></span>: <span class="hljs-string"><span class="hljs-string">'type'</span></span>, document_field_name: <span class="hljs-string"><span class="hljs-string">'type'</span></span>, discriminator: true } <span class="hljs-selector-tag"><span class="hljs-selector-tag">fields</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">entity_field_name</span></span>: <span class="hljs-string"><span class="hljs-string">'id'</span></span>, document_field_name: <span class="hljs-string"><span class="hljs-string">'entity_id'</span></span>, field_type: int, entity_primary_key: true } <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">entity_field_name</span></span>: <span class="hljs-string"><span class="hljs-string">'textField'</span></span>, document_field_name: <span class="hljs-string"><span class="hljs-string">'text'</span></span>, priority: <span class="hljs-number"><span class="hljs-number">100</span></span>, suggester: true }</code> </pre> <br><p>  As a result, after each creation, the updates of the "AppBundle \ Entity \ Page" entities will be indexed by the id and textField fields, as well as the type configuration field.  If an entity instance is deleted, the corresponding solr document will be deleted. </p><br><p>  The "schemes" section describes indexing schemes.  The indexing scheme includes a description of the fields of the entity (fields), the configuration fields (config_entity_fields) that should be indexed in solr.  And also the "document_unique_field" indicating a unique field for the schemes.xml in solr.  In addition, there is an optional client field in case you need to use several solr core for different indexing schemes (more on this <a href="">here</a> ).  In fact, each scheme in the schemes reflects a specific solr core. </p><br><p>  The configuration field is a field that is specified in the "indexed_entities" section within the framework of the entity config.  It can be used to index the parameters specified in parameters.yml, for example: </p><br><pre> <code class="hljs css">.... <span class="hljs-selector-tag"><span class="hljs-selector-tag">class</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">AppBundle</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Entity</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Page</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">schema</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">page</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: app_version, value: %app_version% } <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: host, value: %host% } ... ....</code> </pre> <br><p>  For each indexed entity, at least one configuration field with a unique value relative to all indexed entities designated as discriminator must be specified: true in schemes.  For example: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">mdiyakov_doctrine_solr</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">indexed_entities</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">page</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">class</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">AppBundle</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Entity</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Article</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">schema</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">page</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: type, value: article } <span class="hljs-selector-tag"><span class="hljs-selector-tag">news</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">class</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">AppBundle</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Entity</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">News</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">schema</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">page</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">name</span></span>: type, value: news } <span class="hljs-selector-tag"><span class="hljs-selector-tag">schemes</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">page</span></span>: ... <span class="hljs-selector-tag"><span class="hljs-selector-tag">config_entity_fields</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">config_field_name</span></span>: <span class="hljs-string"><span class="hljs-string">'type'</span></span>, document_field_name: <span class="hljs-string"><span class="hljs-string">'discriminator'</span></span>, discriminator: true }</code> </pre> <br><p>  Since  and AppBundle \ Entity \ Article and AppBundle \ Entity \ News use the same "page" scheme then acc.  their primary key uniqueness is lost  there may be News and Article with the same id.  To avoid ambiguity, a configuration field is used that is used as a discriminator, the value of which is added to the primary key entity and the result is recorded in a unique document field. </p><br><p>  It is also possible to set filters for indexed entities used before the entity is indexed in solr.  Depending on the result of the filter, an entity can be indexed, deleted, or skipped during indexing.  Example: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">indexed_entities</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">page</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">class</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">AppBundle</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Entity</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Page</span></span> ... <span class="hljs-selector-tag"><span class="hljs-selector-tag">filters</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ big_id, published, ... ]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">news</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">class</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">AppBundle</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Entity</span></span>\<span class="hljs-selector-tag"><span class="hljs-selector-tag">News</span></span> ... <span class="hljs-selector-tag"><span class="hljs-selector-tag">filters</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ published, ... ]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">schemes</span></span>: .... <span class="hljs-selector-tag"><span class="hljs-selector-tag">filters</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">fields</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">big_id</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">entity_field_name</span></span>: <span class="hljs-string"><span class="hljs-string">"id"</span></span>, entity_field_value: <span class="hljs-number"><span class="hljs-number">3</span></span>, operator: <span class="hljs-string"><span class="hljs-string">"&gt;="</span></span> } <span class="hljs-selector-tag"><span class="hljs-selector-tag">published</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">entity_field_name</span></span>: <span class="hljs-string"><span class="hljs-string">"published"</span></span>, entity_field_value: true, operator: <span class="hljs-string"><span class="hljs-string">"="</span></span> }</code> </pre> <br><p>  Corresponding  if after Page or News has been <b>created</b> and for example the field "published" = false, then the indexing will be skipped and nothing will be written to solr. </p><br><p>  If the Page or News were <b>updated</b> and for example the field "published" = false, then the solr document corresponding to this entity instance will be deleted in solr </p><br><p>  The same is true for the big_id filter, if the value of the id field is &lt;3. "big_id" and "published" are arbitrary names for filters, which can be anything.  There is also the possibility of a task symfony service as a filter that is applied to an entity instance and not to a separate field, details are <a href="">here.</a> <br>  For successful indexing, the conditions for all filters must be met. </p><br><h3>  Indexing </h3><br><p>  An entity is indexed every time $ em-&gt; flush is executed and implemented via <a href="https://symfony.com/doc/current/bundles/DoctrineBundle/entity-listeners.html">https://symfony.com/doc/current/bundles/DoctrineBundle/entity-listeners.html</a> </p><br><p>  In the case when you need to perform primary indexing for all entities in the database, the console command is implemented: </p><br><pre> <code class="hljs pgsql">app/console doctrine-solr:<span class="hljs-keyword"><span class="hljs-keyword">index</span></span></code> </pre> <br><p>  Details of her work and arguments can be found on <a href="">github</a> . </p><br><h3>  Search example: </h3><br><p>  After the configuration is set and indexing is done, you can search both within the framework of a separate entity and within the framework of the scheme.  Example: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// MyController //... // @var \Mdiyakov\DoctrineSolrBundle\Finder\ClassFinder $finder $finder = $this-&gt;get('ds.finder')-&gt;getClassFinder(Article::class); /** @var Article[] $searchResults */ $searchResults = $finder-&gt;findSearchTermByFields($searchTerm, ['title']);</span></span></code> </pre> <br><p>  The result will be an array consisting only of Article :: class. </p><br><p>  If the scheme is used by several entities, for example: </p><br><pre> <code class="hljs scala"> indexed_entities: page: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">AppBundle</span></span>\<span class="hljs-type"><span class="hljs-type">Entity</span></span>\<span class="hljs-type"><span class="hljs-type">Article</span></span> schema: page ... news: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">AppBundle</span></span>\<span class="hljs-type"><span class="hljs-type">Entity</span></span>\<span class="hljs-type"><span class="hljs-type">News</span></span> schema: page ... ...</code> </pre> <br><p>  then you can search for all entities using this scheme: </p><br><pre> <code class="php hljs">$schemaFinder = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;get(<span class="hljs-string"><span class="hljs-string">'ds.finder'</span></span>)-&gt;getSchemaFinder(<span class="hljs-string"><span class="hljs-string">'page'</span></span>); $schemaFinder-&gt;addSelectClass(Article::class); $schemaFinder-&gt;addSelectClass(News::class); <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> object[] **/</span></span> $result = $schemaFinder-&gt;findSearchTermByFields($searchTerm, [<span class="hljs-string"><span class="hljs-string">'title'</span></span>, <span class="hljs-string"><span class="hljs-string">'category'</span></span>]);</code> </pre> <br><p>  The result will be an array consisting of Article and News instances sorted in acc.  with relevance. </p><br><p>  Read more about search methods <a href="">here.</a> </p><br><h3>  Conclusion </h3><br><p>  This is an introductory article that does not fully describe all the possibilities.  If you are interested in the bundle, here are a couple of links to quickly navigate through the rest of the bundle features: </p><br><ul><li>  use of <a href="">SuggestComponent</a> </li><li>  building your queries <a href="">Query Building</a> </li><li>  implementation of your <a href="">ClassFinder</a> </li></ul><br><p>  <strong>UPD:</strong> Added support for symfony 3 and php 7 </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/350134/">https://habr.com/ru/post/350134/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350124/index.html">Online shooter on Unreal Engine 4 for 90 hours (video creation + source)</a></li>
<li><a href="../350126/index.html">Compiler bug? Linker? No, Windows kernel bug</a></li>
<li><a href="../350128/index.html">Instruction: what to do if you do not have time to deadline</a></li>
<li><a href="../350130/index.html">Open Data Day in Moscow 2018</a></li>
<li><a href="../350132/index.html">GObject: Inheritance and Interfaces</a></li>
<li><a href="../350136/index.html">Random evolutionary strategies in machine learning</a></li>
<li><a href="../350138/index.html">How to whale eat java application and not choke</a></li>
<li><a href="../350140/index.html">Asynchronous work with PostgreSQL in C</a></li>
<li><a href="../350142/index.html">Development of an external battery on four LiFePO4 batteries</a></li>
<li><a href="../350144/index.html">Richard Hamming: Chapter 29. You get what you measure</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>