<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Development of a particle system on the DirectX 9 platform. Part I</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This post will be about how to develop your own, and quite productive (on my computer, 1,000,000 particles in real time are quietly drawn and animated...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Development of a particle system on the DirectX 9 platform. Part I</h1><div class="post__text post__text-html js-mediator-article">  This post will be about how to develop your own, and quite productive (on my computer, 1,000,000 particles in real time are quietly drawn and animated), a system of particles.  We will write in C ++, DirectX 9 will be used as a platform. <br><br>  The second part is available <a href="http://habrahabr.ru/post/149933/">here</a> . <br><br>  An example of one of the frames of visualization (clickable): <br> <a href=""><img src="https://habrastorage.org/storage2/cf1/d44/a81/cf1d44a819282c6d2bfced2b1e65837b.jpg"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  To begin with, it is worth saying why C ++ and DirectX9, and not, say, XNA, or GDI in general.  Before you decide, I looked at \ tried many options: HTML + JS (when developing the concept), C # and GDI, C ++ and GDI, C # and XNA.  All of these options did not allow us to achieve the required performance (real-time rendering of more than 50,000 particles), so I began to consider more serious options.  The first thing that came to mind was DirectDraw, but no one has been developing it for a long time, so the choice fell on Direct3D.  I could use OpenGL, but D3D is somehow closer to me. <br><br><h4>  0. Concept and requirements </h4><br>  The system will draw and animate the particles.  Animation will produce a certain formula (as an example, I used the law of the world).  You can interact with the system from the outside by transmitting some kind of data in real time. <br><br><h5>  Requirements. </h5><br>  We want our particle system to be productive enough so that it can be used for real-time rendering, needs to be flexible in customization, allows sprites, various effects and post effects to be applied. <br><br>  Let's go in order: <br>  1. <i>Performance.</i>  Perhaps, something faster than C \ C ++ will be difficult to find, and Direct3D is widely used in the development of computer games.  We have enough opportunities for him. <br>  2. <i>Rendering in real time.</i>  Actually Direct3D (OpenGL) for this and use.  The selected candidate is suitable. <br>  3. <i>Flexibility in customization.</i>  In DirectX there is such a wonderful thing as shaders.  You can do anything without rewriting anything else except them. <br>  4. <i>Sprites.</i>  DirectX is fairly easy to use.  Fit <br>  5. <i>Effects, post effects.</i>  To implement this, we will help the shaders. <br><br>  Now about the subtleties that need to be considered in order to achieve sufficient performance.  Because  Since the number of particles is very large, it‚Äôs better to render them in one piece, so as not to lose in performance due to the huge number of calls to the functions of rendering.  Well, you also need to take care of the memory, so the best option would be to store the data as an array of points. <br><br>  We have solved all theoretical questions, now we will move on to implementation. <br><br><h4>  1. Initialize Direct3D and create camera </h4><br>  To work, we need our own development environment \ compiler and <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D6812">DirectX SDK</a> <br><br>  The first thing you need to do is create a Direct3D9 object, after the device for the output and a window where everything will be displayed. <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//      WNDCLASSEX wc = {sizeof(WNDCLASSEX), CS_VREDRAW|CS_HREDRAW|CS_OWNDC, WndProc, 0, 0, hInstance, NULL, NULL, (HBRUSH)(COLOR_WINDOW+1), NULL, L"RenderToTextureClass", NULL}; RegisterClassEx(&amp;wc); //   HWND hMainWnd = CreateWindowW(L"RenderToTextureClass", L"Render to texture", WS_POPUP, 0, 0, Width, Height, NULL, NULL, hInstance, NULL); //   Direct3D LPDIRECT3D9 d3d = Direct3DCreate9(D3D_SDK_VERSION); //      D3DPRESENT_PARAMETERS PresentParams; memset(&amp;PresentParams, 0, sizeof(D3DPRESENT_PARAMETERS)); PresentParams.Windowed = TRUE; //     //         . //       D3DSWAPEFFECT_DISCARD. PresentParams.SwapEffect = D3DSWAPEFFECT_DISCARD; LPDIRECT3DDEVICE9 device = NULL; //   d3d-&gt;CreateDevice(D3DADAPTER_DEFAULT, //     D3DDEVTYPE_HAL, //    hMainWnd, //      D3DCREATE_HARDWARE_VERTEXPROCESSING, //      &amp;PresentParams, // ,     &amp;device); //   ,     , //  . device-&gt;SetRenderState(D3DRS_LIGHTING,FALSE); //      device-&gt;SetRenderState(D3DRS_ZENABLE, FALSE); //    </span></span></code> </pre> <br></div></div><br>  In the code above, we create a regular window in which drawing will take place.  Next is the Direct3D object.  Finally, the device object that we will use for drawing. <br><br>  A few words about hardware acceleration.  Many calculations can be performed using a processor, emulating a video card, but since  a regular processor is not very suitable for these purposes (it has, at best, 4 cores, and there are dozens or even hundreds in a video card), then this will have an effect on speed.  In some cases, very much.  Therefore, it is better to use hardware acceleration whenever possible. <br><br>  You should also not forget about the installation of the projection matrix and the camera.  In short, the projection matrix is ‚Äã‚Äãused to convert 3D data to 2D, and the camera describes what we see and where we look. <br><br>  But here I will introduce one simplification, orthogonal to the projection matrix, since  in fact, our particles are flat points, and they do not need special calculations of perspective; we can do without a camera.  In the orthogonal projection, Z is actually not taken into account, and objects do not change size depending on their position in space. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//   D3DXMATRIX matrixView; D3DXMATRIX matrixProjection; //   D3DXMatrixLookAtLH( &amp;matrixView, &amp;D3DXVECTOR3(0,0,0), &amp;D3DXVECTOR3(0,0,1), &amp;D3DXVECTOR3(0,1,0)); //   D3DXMatrixOrthoOffCenterLH(&amp;matrixProjection, 0, Width, Height, 0, 0, 255); //      device-&gt;SetTransform(D3DTS_VIEW,&amp;matrixView); device-&gt;SetTransform(D3DTS_PROJECTION,&amp;matrixProjection);</span></span></code> </pre><br><br><h4>  2. Creation of particles and buffer for them </h4><br>  All the preparations we made, it remains only to create particles and start drawing. <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VertexData</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x,y,z; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Particle</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x, y, vx, vy; }; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">deque</span></span>&lt;Particle&gt; particles;</code> </pre><br>  <b>VertexData is</b> used to store data about a particle in a GPU (vertex buffer), and contains the coordinates of our particle in space.  This structure has a special format, and in fact, the graphics processor will take from it information what and where to draw. <br>  <b>Particle</b> will represent our particle, and contains coordinates and speed. <br>  In the same <b>particles</b> will be stored information about all of our particles.  We will use this information to calculate the motion of particles. <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//      srand(clock()); Particle tmp; for( int i = 0; i&lt;particleCount; ++i ) { tmp.x = rand()%Width; tmp.y = rand()%Height; particles.push_back( tmp ); } LPDIRECT3DVERTEXBUFFER9 pVertexObject = NULL; LPDIRECT3DVERTEXDECLARATION9 vertexDecl = NULL; size_t count = particles.size(); VertexData *vertexData = new VertexData[count]; for(size_t i=0; i&lt;count; ++i) { vertexData[i].x = particles[i].x; vertexData[i].y = particles[i].y; vertexData[i].z = 0.f; vertexData[i].u = 0; vertexData[i].v = 0; } void *pVertexBuffer = NULL; //    device-&gt;CreateVertexBuffer( count*sizeof(VertexData), //    D3DUSAGE_WRITEONLY, //  GPU,         D3DFVF_XYZ, //     XYZ D3DPOOL_DEFAULT, //      &amp;pVertexObject, //   ,     NULL); //  .  NULL //  ,       pVertexObject-&gt;Lock(0, count*sizeof(VertexData), &amp;pVertexBuffer, 0); //     memcpy(pVertexBuffer, vertexData, count*sizeof(VertexData)); pVertexObject-&gt;Unlock(); delete[] vertexData; vertexData = nullptr; //      //    3 float,   0- ,    D3DVERTEXELEMENT9 decl[] = { { 0, 0, D3DDECLTYPE_FLOAT3, D3DDECLMETHOD_DEFAULT, D3DDECLUSAGE_POSITION, 0 }, D3DDECL_END() }; //      device-&gt;CreateVertexDeclaration(decl, &amp;vertexDecl);</span></span></code> </pre><br></div></div><br>  I will comment on some points. <br>  When creating the buffer, we pass the <b>D3DUSAGE_WRITEONLY</b> parameter, telling the GPU that we will not read the data from the buffer.  This will allow the graphics processor to perform the necessary optimizations, and increase the rendering speed. <br>  <b>VertexDeclaration is</b> usually used to work with shaders.  If shaders are not required, then you can do without creating this object. <br><br><h4>  3. particle rendering </h4><br>  Now the particles need to be drawn.  This is done very simply: <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    device-&gt;Clear( 0, NULL, D3DCLEAR_TARGET, D3DCOLOR_XRGB(0,0,0), 1.0f, 0 ); //    device-&gt;SetStreamSource(0, pVertexObject, 0, sizeof(VertexData)); // ,     device-&gt;SetVertexDeclaration(vertexDecl); device-&gt;BeginScene(); //  device-&gt;DrawPrimitive(D3DPRIMITIVETYPE::D3DPT_POINTLIST, //    -  0, //   0-  particles.size()); //   ,     device-&gt;EndScene();</span></span></code> </pre><br>  One important note: <b>BeginScene ()</b> must be called each time before drawing, and <b>EndScene ()</b> after it is finished. <br><br><h4>  Animation </h4><br>  And of course without animation, otherwise what a particle system is.  As an example, I used the Law of the World. <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    POINT pos; GetCursorPos(&amp;pos); RECT rc; GetClientRect(hMainWnd, &amp;rc); ScreenToClient(hMainWnd, &amp;pos); const int mx = pos.x; const int my = pos.y; const auto size = particles.size(); float force; float distSquare; VertexData *pVertexBuffer; //   ,   pVertexObject-&gt;Lock(0, 0, (void**)&amp;pVertexBuffer, D3DLOCK_DISCARD); for(int i = 0; i &lt; size; ++i ) { auto &amp;x = particles[i].x; auto &amp;y = particles[i].y; distSquare= pow( x - mx, 2 ) + pow( y - my, 2 ); if( dist &lt; 20 ) { force = 0; } else { force = G / distSquare; } const float xForce = (mx - x) * force; const float yForce = (my - y) * force; particles[i].vx *= Resistance; particles[i].vy *= Resistance; particles[i].vx += xForce; particles[i].vy += yForce; x+= particles[i].vx; y+= particles[i].vy; if( x &gt; Width ) x -= Width; else if( x &lt; 0 ) x += Width; if( y &gt; Height ) y -= Height; else if( y &lt; 0 ) y += Height; pVertexBuffer[i].x = particles[i].x; pVertexBuffer[i].y = particles[i].y; } pVertexObject-&gt;Unlock();</span></span></code> </pre><br></div></div><br>  When locking the buffer, I specified the <b>D3DLOCK_DISCARD</b> flag, it allows the graphics processor to continue drawing particles from the old buffer.  We at the same time return a new one.  This little trick reduces downtime. <br><br>  This concludes the first part of the article.  The <a href="http://habrahabr.ru/post/149933/">next part</a> will describe the texturing of particles, vertex and pixel shaders, as well as effects and post effects.  Also at the end of the 2nd part you will see links to the demo and its full source code. </div><p>Source: <a href="https://habr.com/ru/post/149932/">https://habr.com/ru/post/149932/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../149926/index.html">Google Analytics to collect javascript errors</a></li>
<li><a href="../149927/index.html">Convenient service for personal finance</a></li>
<li><a href="../149928/index.html">The strangest hardware on which you can find a web server</a></li>
<li><a href="../149930/index.html">Apple is the most expensive company in history.</a></li>
<li><a href="../149931/index.html">Twitter Bootstrap 2.1.0 Released</a></li>
<li><a href="../149933/index.html">Development of a particle system based on DirectX 9. Part II</a></li>
<li><a href="../149934/index.html">vPass: Javascript page for maximum security and minimum of pain when working with passwords</a></li>
<li><a href="../149935/index.html">Stop worrying. Stress management methods</a></li>
<li><a href="../149936/index.html">Comment on the article about the K28A project</a></li>
<li><a href="../149938/index.html">Is search engine optimization important?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>