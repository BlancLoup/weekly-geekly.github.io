<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SMB Multichannel in Windows Server 2012</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="SMB Multichannel is one of the features of the SMB 3.0 protocol, designed to improve performance and fault tolerance at the network connection level w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SMB Multichannel in Windows Server 2012</h1><div class="post__text post__text-html js-mediator-article">  SMB Multichannel is one of the features of the SMB 3.0 protocol, designed to improve performance and fault tolerance at the network connection level when working with file servers.  To use this feature, the SMB client and SMB server must support SMB 3.0, which, in turn, is implemented in <a href="http://technet.microsoft.com/ru-ru/evalcenter/hh670538.aspx%3Fwt.mc_id%3DTEC_108_1_5">Windows Server 2012</a> and <a href="http://technet.microsoft.com/ru-ru/windows/hh771457.aspx%3Focid%3Dwc-tn-eval">Windows 8</a> . <a name="habracut"></a><br><br><h1>  What are the benefits of SMB Multichannel? </h1><br>  SMB Multichannel allows you to simultaneously use multiple network connections to the file server, thereby providing: <br><ul><li>  <b>Increased throughput</b> .  The SMB client and server can transfer more data by simultaneously using multiple network connections established using one high-speed network adapter, such as 10GbE, or several network adapters.  In the case of several network adapters, SMB Multichannel actually aggregates their bandwidths. </li><li>  <b>Fault tolerance</b> .  Performing network operations, such as copying a file, are not interrupted if one or more connections are lost until at least one connection continues to exist.  Loss of connection can occur either due to problems in the network environment (cable break, switch failure, etc.), or due to problems with the network adapter.  Thus, when using multiple network adapters, SMB Multichannel provides fault tolerance at the physical network card level.  But once again, only for SMB operations </li></ul><br><h1>  What are the requirements for SMB Multichannel? </h1><br>  For SMB Multichannel to work, two requirements must be met: <br><ul><li>  SMB 3.0 on the client and on the server.  Currently this version of the protocol is implemented in Windows Server 2012 and Windows 8. </li><li>  One of the supported configurations discussed below </li></ul><br><h1>  Supported Configurations </h1><br>  For SMB Multichannel to work, the client and server must support at least one of the following configurations: <br><ul><li>  Multiple network adapters with the same speed </li><li>  One or more network adapters with RSS (Receive Side Scaling) </li><li>  Two or more network adapters grouped together using NIC Teaming </li><li>  One or more network adapters with RDMA (Remote Direct Memory Access) </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/f0e/2c2/a0d/f0e2c2a0d05d31d08bddd9bcef61753a.jpg" alt="image"><br><br>  As a result, SMB Multichannel will not work if the computer has one network adapter that does not support RSS, or if there are several adapters, but they work at different speeds.  In the latter case, the traffic will be transmitted on the fastest adapter. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Some explanations regarding individual configurations. <br><br>  <b>Network adapter with RSS support</b> <br><br>  In the absence of SMB Multichannel, when an SMB client accesses a SMB server, an SMB session is opened, within which one TCP / IP connection is established.  Traffic processing on this connection is performed by one of the available processor cores.  If the network adapter does not support RSS, then in principle all network traffic is processed by one core, usually CPU0.  If the network adapter supports RSS, the processing of network traffic is distributed among the available processor cores.  However, without SMB Multichannel, only one connection is established in one session, and RSS cannot do anything to help this particular session. <br><br>  In the case of SMB Multichannel, if the network adapter supports RSS, the SMB protocol establishes several connections within one session (by default, 4 to the RSS interface), and RSS, in turn, distributes traffic processing through these connections to the available cores. <br><br>  Accordingly, even with the use of a single RSS adapter, SMB Multichannel makes it possible to speed up network operations and more effectively utilize the available bandwidth.  And above all, this is true for 10GbE adapters. <br><br>  What SMB Multichannel cannot provide for us in a configuration with one physical adapter is fault tolerance, since it is clear that if a single adapter fails, then we lose all the connections. <br><br>  In Windows Server 2012 and Windows 8, the easiest way to determine which adapters and with which current settings support RSS is through the PowerShell cmdlet. <pre><code class="javascript hljs">Get-NetAdapterRss</code> </pre> <br><img src="https://habrastorage.org/getpro/habr/post_images/79e/149/046/79e1490461a3b3493c9e091f042f4fcd.png" alt="image"><br><br>  <b>Two or more adapters combined using NIC Teaming</b> <br><br>  Using NIC Teaming is not a requirement for SMB Multichannel.  If the system, for example, has two gigabit adapters, then SMB Multichannel can use them without any timing.  However, combining adapters into a timing group will provide an additional advantage in terms of fault tolerance.  Without a timeout, SMB Multichannel will only provide fault tolerance for SMB traffic, along with NIC Teaming you will get fault tolerance of any network traffic.  At the same time both with timing and without it, SMB Multichannel aggregates the available bandwidths of the available adapters. <br><br>  <b>One or more network adapters with RDMA (Remote Direct Memory Access)</b> <br><br>  RDMA technology provides low latency when transferring data over a network and reducing processor load.  SMB Multichannel establishes for each SMB session two connections per RDMA interface.  If there are several RDMA adapters, fault tolerance is additionally provided.  It should be noted that if you combine RDMA interfaces into a group using NIC Teaming tools in Windows Server 2012, then the OS treats these interfaces as non-RDMA.  That is, in the timing, the capabilities of RDMA are not available to you.  By analogy with RSS, you can get information about adapters with RDMA support and their configuration using the cmdlet <pre> <code class="javascript hljs">Get-NetAdapterRdma</code> </pre> <br><br>  <b>Multiple network adapters with the same speed</b> <br><br>  This is the easiest configuration option in which SMB Multichannel just works.  If the adapters do not support RSS, then one connection is established per interface. <br><br>  And now is the time to discuss the SMB Multichannel setup. <br><br><h1>  SMB Multichannel setup </h1><br>  The beauty of technology is that it is automatically configured.  If the OS detects one of the supported configurations (see above), then SMB Multichannel is automatically applied.  However, you can make sure that the technology is enabled by <pre> <code class="javascript hljs">Get-SmbClientConfiguration</code> </pre>  or <pre> <code class="javascript hljs">Get-SmbServerConfiguration</code> </pre> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b7a/d59/b7a/b7ad59b7a5f38525db92cc5eb41bea2e.png" alt="image"><br><br>  Additionally, <pre> <code class="javascript hljs">Get-SmbClientNetworkInterface</code> </pre>  will show you whether RSS and RDMA are enabled for the available interfaces. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cd0/cca/d61/cd0ccad612289f92b182137133ad351e.png" alt="image"><br><br>  I have already mentioned the number of connections to be established for different types of network interfaces (4 per RSS-adapter, 2 per RDMA-adapter, 1 per ordinary NIC).  By default, SMB Multichannel uses a maximum of 8 connections for each client / server pair.  And this number can limit the number of connections per network interface.  For example, if you have three RSS-adapters, then three connections will be established through the first, three through the second and two through the third. <br><br>  It is recommended to use the default SMB Multichannel settings.  However, these settings are subject to change.  For example, the maximum number of connections per client / server pair is set as follows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b0e/189/538/b0e1895389dda9a0d049d989ec22fd48.png" alt="image"><br><br>  Finally, if for some reason you need to disable SMB Multichannel, for example, for testing or diagnostics, you can do this with the following two commands on the server and client, respectively: <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">Set</span></span>-SmbServerConfiguration -EnableMultiChannel $<span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span>-SmbClientConfiguration -EnableMultiChannel $<span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre> <br>  The same commands with a value of $ true will re-enable the technology. <br><br><h1>  SMB Multichannel in action </h1><br>  If your system has one of the supported configurations, then when you open a shared folder on the SMB server, Multichannel will establish several connections.  You can verify this with <pre> <code class="javascript hljs">Get-SmbMultichannelConnection</code> </pre> <br>  In my environment with two gigabit cards, it looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e3f/ace/fad/e3facefad2fe84c55daa8277d8115d3e.png" alt="image"><br><br>  Next, by running the file copy from a network share, in Performance Monitor you can observe that copying is done using both network adapters. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7cf/8d3/231/7cf8d323144fa2e866ace7f6511b4f8e.png" alt="image"><br><br>  Turning off one of the adapters, you will see that the copy operation is not interrupted, and the entire load will be transferred to the remaining adapter. <br><br>  You can see how SMB Multichannel works in dynamics, and also compare how an OS behaves when technology is disabled, you can in my <a href="http://www.techdays.ru/videos/4488.html">web caste</a> (scroll before demonstrating SMB Multichannel). <br><br>  Thus, with SMB Multichannel, you can improve the efficiency and reliability of network operations.  In combination with other Windows Server 2012 technologies, such as SMB Scale Out, SMB Transparent Failover, and a number of others (we‚Äôll talk about them in other posts), you can provide a high level of accessibility of running services at different levels with OS tools: disk subsystem, cluster node, network interface. </div><p>Source: <a href="https://habr.com/ru/post/151451/">https://habr.com/ru/post/151451/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151445/index.html">"Supercomputer" of 64 Raspberry Pi and Lego</a></li>
<li><a href="../151446/index.html">Open data in Russia. Preparing priorities for government agencies. Poll</a></li>
<li><a href="../151447/index.html">Steve Wozniak criticized the decision of the court on Apple vs. Samsung</a></li>
<li><a href="../151448/index.html">Tips for developers from Tag Games</a></li>
<li><a href="../151450/index.html">Comparison of code review techniques</a></li>
<li><a href="../151453/index.html">Creative use of web fonts</a></li>
<li><a href="../151454/index.html">3 sides of the coin or why the user is against automation</a></li>
<li><a href="../151455/index.html">Chinese computers and Linux in teaching Ukrainian children</a></li>
<li><a href="../151456/index.html">Connecting static resources from templates</a></li>
<li><a href="../151457/index.html">eBay changed logo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>