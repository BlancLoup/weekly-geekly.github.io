<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Metaclasses in Python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As one of the StackOverflow users said, ‚Äúusing SO is like doing a list with a hashtable instead of a linked list‚Äù. We again turn to this remarkable re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Metaclasses in Python</h1><div class="post__text post__text-html js-mediator-article">  <i>As one of the StackOverflow users said, ‚Äúusing SO is like doing a list with a hashtable instead of a linked list‚Äù.</i>  <i>We again turn to this remarkable resource, which comes across extremely detailed and understandable answers to a variety of questions.</i> <i><br><br></i>  <i>This time we will discuss what metaclasses are, how, where and why to use them, and also why it is usually not worth doing.</i> <br><a name="habracut"></a><br><h1>  Classes as objects </h1><br>  Before you study metaclasses, you need to understand the classes well, and the classes in Python are a very specific thing (based on ideas from the Smalltalk language). <br><br>  In most languages, a class is just a piece of code that describes how to create an object.  In general, this is also true for Python: <br><pre><code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectCreator</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> ... &gt;&gt;&gt; my_object = ObjectCreator() &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> my_object &lt;__main__.ObjectCreator object at <span class="hljs-number"><span class="hljs-number">0x8974f2c</span></span>&gt;</code> </pre> <br>  But in Python, a class is something more - classes are also objects. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Once the <code>class</code> keyword is used, Python executes the command and creates <i>an object</i> .  Instruction <br><pre> <code class="python hljs"> &gt;&gt;&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectCreator</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> ...</code> </pre><br>  will create an object in memory called <code>ObjectCreator</code> . <br><br>  This object (class) itself can create objects (instances), therefore it is a class. <br><br>  However, this is an object, and therefore: <br><ul><li>  it can be assigned to a variable, </li><li>  you can copy it </li><li>  you can add an attribute to it, </li><li>  it can be passed to the function as an argument, </li></ul><br><br><h1>  Dynamic class creation </h1><br>  Since classes are objects, you can create them on the go, just like any object. <br><br>  For example, you can create a class in a function using the <code>class</code> keyword: <br><pre> <code class="python hljs"> &gt;&gt;&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">choose_class</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name)</span></span></span><span class="hljs-function">:</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> name == <span class="hljs-string"><span class="hljs-string">'foo'</span></span>: ... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Foo <span class="hljs-comment"><span class="hljs-comment">#  ,    ... else: ... class Bar(object): ... pass ... return Bar ... &gt;&gt;&gt; MyClass = choose_class('foo') &gt;&gt;&gt; print MyClass #   ,    &lt;class '__main__.Foo'&gt; &gt;&gt;&gt; print MyClass() #      &lt;__main__.Foo object at 0x89c6d4c&gt;</span></span></code> </pre><br>  However, this is not very dynamic, because you still need to write the whole class yourself. <br><br>  Since classes are objects, they must be generated by something. <br><br>  When the <code>class</code> keyword is used, Python creates this object automatically.  But like most things in Python, there is a way to do it manually. <br><br>  Remember the <code>type</code> function?  Good old function that allows you to determine the type of object: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">print</span></span> type(<span class="hljs-number"><span class="hljs-number">1</span></span>) &lt;type <span class="hljs-string"><span class="hljs-string">'int'</span></span>&gt; &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> type(<span class="hljs-string"><span class="hljs-string">"1"</span></span>) &lt;type <span class="hljs-string"><span class="hljs-string">'str'</span></span>&gt; &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> type(ObjectCreator) &lt;type <span class="hljs-string"><span class="hljs-string">'type'</span></span>&gt; &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> type(ObjectCreator()) &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectCreator</span></span></span><span class="hljs-class">'&gt;</span></span></code> </pre><br>  In fact, the <code>type</code> function has a completely different use: it can also create classes on the fly.  <code>type</code> takes a class description as input and convokes the class. <br><br>  (I know, it‚Äôs foolish that the same function can be used for two completely different things depending on the arguments passed. This is done for backward compatibility) <br><br>  <code>type</code> works as follows: <br><pre> <code class="python hljs"> type(&lt; &gt;, &lt;  &gt;, <span class="hljs-comment"><span class="hljs-comment">#  ,    &lt;,     &gt;)</span></span></code> </pre><br>  For example, <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyShinyClass</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre><br>  can be created manually as follows: <br><pre> <code class="python hljs"> &gt;&gt;&gt; MyShinyClass = type(<span class="hljs-string"><span class="hljs-string">'MyShinyClass'</span></span>, (), {}) <span class="hljs-comment"><span class="hljs-comment">#  - &gt;&gt;&gt; print MyShinyClass &lt;class '__main__.MyShinyClass'&gt; &gt;&gt;&gt; print MyShinyClass() #    &lt;__main__.MyShinyClass object at 0x8997cec&gt;</span></span></code> </pre><br>  You may have noticed that we use ‚ÄúMyShinyClass‚Äù both as the name of the class and as the name for a variable containing a reference to the class.  They may be different, but why complicate things? <br><br>  <code>type</code> accepts a dictionary that defines class attributes: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> ... bar = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span></code> </pre><br>  can be rewritten as <br><pre> <code class="python hljs"> &gt;&gt;&gt; Foo = type(<span class="hljs-string"><span class="hljs-string">'Foo'</span></span>, (), {<span class="hljs-string"><span class="hljs-string">'bar'</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>})</code> </pre><br>  and use as a regular class <br><pre> <code class="python hljs"> &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> Foo &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class">'&gt; &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">print</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bar</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">True</span></span></span><span class="hljs-class"> &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class"> &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">print</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">at</span></span></span><span class="hljs-class"> 0</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x8a9b84c</span></span></span><span class="hljs-class">&gt; &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">print</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bar</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">True</span></span></span></span></code> </pre><br>  Of course, you can inherit from it: <br><pre> <code class="python hljs"> &gt;&gt;&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FooChild</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Foo)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre><br>  will turn into <br><pre> <code class="python hljs"> &gt;&gt;&gt; FooChild = type(<span class="hljs-string"><span class="hljs-string">'FooChild'</span></span>, (Foo,), {}) &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> FooChild &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FooChild</span></span></span><span class="hljs-class">'&gt; &gt;&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">print</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FooChild</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bar</span></span></span><span class="hljs-class"> # </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bar</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inherited</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">True</span></span></span></span></code> </pre><br>  At some point, you will want to add methods to your class.  To do this, simply define a function with the desired signature and assign it as an attribute: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">echo_bar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> self.bar ... &gt;&gt;&gt; FooChild = type(<span class="hljs-string"><span class="hljs-string">'FooChild'</span></span>, (Foo,), {<span class="hljs-string"><span class="hljs-string">'echo_bar'</span></span>: echo_bar}) &gt;&gt;&gt; hasattr(Foo, <span class="hljs-string"><span class="hljs-string">'echo_bar'</span></span>) &gt;&gt;&gt; hasattr(FooChild, <span class="hljs-string"><span class="hljs-string">'echo_bar'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> &gt;&gt;&gt; my_foo = FooChild() &gt;&gt;&gt; my_foo.echo_bar() <span class="hljs-keyword"><span class="hljs-keyword">True</span></span></code> </pre><br>  It is already clear what I'm getting at: in Python, classes are objects and you can create classes on the go. <br><br>  This is exactly what Python does when the <code>class</code> keyword is used, and it does this using metaclasses. <br><br><h1>  What is a metaclass (finally) </h1><br>  Metaclass is the ‚Äúthing‚Äù that creates classes. <br><br>  We create a class to create objects, right?  And classes are objects.  Metaclass is what creates these very objects.  They are classes of classes, you can imagine it as follows: <br><pre> <code class="python hljs"> MyClass = MetaClass() MyObject = MyClass()</code> </pre><br>  We have already seen that <code>type</code> allows you to do something like this: <br><pre> <code class="python hljs"> MyClass = type(<span class="hljs-string"><span class="hljs-string">'MyClass'</span></span>, (), {})</code> </pre><br>  This is because the <code>type</code> function is actually a metaclass.  <code>type</code> is a metaclass that Python internally uses to create all classes. <br><br>  The natural question is: why does he spell his name in lower case, not <code>Type</code> ? <br><br>  I suppose it's just to match <code>str</code> , the class for creating string objects, and <code>int</code> , the class for creating integer objects.  <code>type</code> is just a class for creating class objects. <br><br>  This is easily verified using the <code>__class__</code> attribute: <br><br>  In python, everything (in general, everything!) Is objects.  Including numbers, strings, functions, and classes ‚Äî they are all objects and all were created from a class: <br><pre> <code class="python hljs"> &gt;&gt;&gt; age = <span class="hljs-number"><span class="hljs-number">35</span></span> &gt;&gt;&gt; age.__class__ &lt;type <span class="hljs-string"><span class="hljs-string">'int'</span></span>&gt; &gt;&gt;&gt; name = <span class="hljs-string"><span class="hljs-string">'bob'</span></span> &gt;&gt;&gt; name.__class__ &lt;type <span class="hljs-string"><span class="hljs-string">'str'</span></span>&gt; &gt;&gt;&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> &gt;&gt;&gt; foo.__class__ &lt;type <span class="hljs-string"><span class="hljs-string">'function'</span></span>&gt; &gt;&gt;&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bar</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> &gt;&gt;&gt; b = Bar() &gt;&gt;&gt; b.__class__ &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__main__</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bar</span></span></span><span class="hljs-class">'&gt;</span></span></code> </pre><br>  And what is <code>__class__</code> for each <code>__class__</code> ? <br><pre> <code class="python hljs"> &gt;&gt;&gt; a.__class__.__class__ &lt;type <span class="hljs-string"><span class="hljs-string">'type'</span></span>&gt; &gt;&gt;&gt; age.__class__.__class__ &lt;type <span class="hljs-string"><span class="hljs-string">'type'</span></span>&gt; &gt;&gt;&gt; foo.__class__.__class__ &lt;type <span class="hljs-string"><span class="hljs-string">'type'</span></span>&gt; &gt;&gt;&gt; b.__class__.__class__ &lt;type <span class="hljs-string"><span class="hljs-string">'type'</span></span>&gt;</code> </pre><br>  So, a metaclass is just a thing that creates class objects. <br><br>  If you want, you can call it a ‚Äúclass factory‚Äù <br><br>  <code>type</code> is a built-in metaclass that Python uses, but of course you can create your own. <br><br><h1>  <code>__metaclass__</code> attribute </h1><br>  When writing a class, you can add the attribute <code>__metaclass__</code> : <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> __metaclass__ = something... [...]</code> </pre><br>  In this case, Python will use the specified metaclass when creating the <code>Foo</code> class. <br><br>  Carefully, there is a subtlety! <br><br>  Although you write <code>class Foo(object)</code> , an object class is not yet created in memory. <br><br>  Python will look for <code>__metaclass__</code> in the class definition.  If he finds it, he uses it to create the class <code>Foo</code> .  If not, it will use <code>type</code> . <br><br>  That is when you write <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Bar)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre><br>  Python does the following: <br><br>  Does the <code>Foo</code> class have the attribute <code>__metaclass__</code> ? <br><br>  If so, it creates in memory an object class named <code>Foo</code> , using what is specified in <code>__metaclass__</code> . <br><br>  If Python does not find <code>__metaclass__</code> , he searches for <code>__metaclass__</code> in the parent class <code>Bar</code> and tries to do the same. <br><br>  If <code>__metaclass__</code> is not in any of the parents, Python will search for <code>__metaclass__</code> at the <i>module</i> level. <br><br>  And if he can't find any <code>__metaclass__</code> at all, he uses <code>type</code> to create a class object. <br><br>  Now an important question: what can be put in <code>__metaclass__</code> ? <br><br>  Answer: anything that can create classes. <br><br>  And what creates classes?  <code>type</code> or any of its subclasses, as well as anything that uses them. <br><br><h1>  Custom metaclasses </h1><br>  The main purpose of metaclasses is to automatically change the class at the time of creation. <br><br>  This is usually done for an API when you want to create classes in accordance with the current context. <br><br>  Imagine a stupid example: you decided that all classes in your module attribute names should be written in upper case.  There are several ways to do this, but one of them is to set <code>__metaclass__</code> at the module level. <br><br>  In this case, all classes of this module will be created using the specified meclass, and we just have to force the metaclass to translate the names of all attributes into upper case. <br><br>  Fortunately, <code>__metaclass__</code> can be any callable object, not necessarily a formal class (I know that something with the word ‚Äúclass‚Äù in the name does not have to be a class, what nonsense? However, this is useful). <br><br>  So we start with a simple example using a function. <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#        , #     `type` def upper_attr(future_class_name, future_class_parents, future_class_attr): """  -,        """ #   ,    '__' attrs = ((name, value) for name, value in future_class_attr.items() if not name.startswith('__')) #      uppercase_attr = dict((name.upper(), value) for name, value in attrs) #     `type` return type(future_class_name, future_class_parents, uppercase_attr) __metaclass__ = upper_attr #        class Foo(object): #    __metaclass__ ,       bar = 'bip' print hasattr(Foo, 'bar') # Out: False print hasattr(Foo, 'BAR') # Out: True f = Foo() print f.BAR # Out: 'bip'</span></span></code> </pre><br>  And now the same thing, only using the real class: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># ,  `type`     ,  `str`  `int`, #       class UpperAttrMetaclass(type): #  __new__   __init__ #       , #     __init__   ,    . #     __new__,     , #    #       ,     , #    __new__. #    -  __init__,  . #        __call__, #      . def __new__(upperattr_metaclass, future_class_name, future_class_parents, future_class_attr): attrs = ((name, value) for name, value in future_class_attr.items() if not name.startswith('__')) uppercase_attr = dict((name.upper(), value) for name, value in attrs) return type(future_class_name, future_class_parents, uppercase_attr)</span></span></code> </pre><br>  But this is not exactly OOP.  We directly call <code>type</code> and do not overload the call to the <code>__new__</code> parent.  Let's do that: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UpperAttrMetaclass</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(upperattr_metaclass, future_class_name, future_class_parents, future_class_attr)</span></span></span><span class="hljs-function">:</span></span> attrs = ((name, value) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> name, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> future_class_attr.items() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> name.startswith(<span class="hljs-string"><span class="hljs-string">'__'</span></span>)) uppercase_attr = dict((name.upper(), value) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> name, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attrs) <span class="hljs-comment"><span class="hljs-comment">#   type.__new__ #  ,   return type.__new__(upperattr_metaclass, future_class_name, future_class_parents, uppercase_attr)</span></span></code> </pre><br>  You may have noticed the additional argument <code>upperattr_metaclass</code> .  There is nothing special about it: the method always receives the current instance as the first argument.  In the same way as you use <code>self</code> in normal methods. <br><br>  Of course, the names I used here are so long for clarity, but like <code>self</code> , there is an agreement on the naming of all these arguments.  So the real metaclass looks something like this: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UpperAttrMetaclass</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, name, bases, dct)</span></span></span><span class="hljs-function">:</span></span> attrs = ((name, value) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> name, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dct.items() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> name.startswith(<span class="hljs-string"><span class="hljs-string">'__'</span></span>)) uppercase_attr = dict((name.upper(), value) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> name, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attrs) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> type.__new__(cls, name, bases, uppercase_attr)</code> </pre><br>  You can do even better by using <code>super</code> , which will cause inheritance (since, of course, you can create a metaclass inherited from a metaclass inherited from <code>type</code> ): <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UpperAttrMetaclass</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(type)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__new__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, name, bases, dct)</span></span></span><span class="hljs-function">:</span></span> attrs = ((name, value) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> name, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dct.items() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> name.startswith(<span class="hljs-string"><span class="hljs-string">'__'</span></span>)) uppercase_attr = dict((name.upper(), value) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> name, value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attrs) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> super(UpperAttrMetaclass, cls).__new__(cls, name, bases, uppercase_attr)</code> </pre><br>  That's all.  There is nothing more to say about metaclasses. <br><br>  The reason for the complexity of code using metaclasses is not in the metaclasses themselves.  It is that metaclasses are usually used for all sorts of sophisticated things based on introspection, manipulation by inheritance, variables like <code>__dict__</code> and the like. <br><br>  Indeed, metaclasses are especially useful for all "black magic", and, therefore, complex pieces.  But by themselves they are simple: <br><ul><li>  intercept class creation </li><li>  change class </li><li>  return the modified </li></ul><br><br><h1>  Why use metaclasses instead of functions? </h1><br>  Since <code>__metaclass__</code> accepts any callable object, why would you suddenly use a class if it‚Äôs obviously more difficult? <br><br>  There are several reasons for this: <br><ul><li>  The destination is clearer.  When you see <code>UpperAttrMetaclass(type)</code> , you immediately know what will happen next. </li><li>  You can use OOP.  Metaclasses can be inherited from metaclasses, overloading parent methods. </li><li>  Better structured code.  You will not use metaclasses for such simple things as in the example above.  Usually it is something complicated.  The ability to create multiple methods and group them in one class is very useful to make the code more readable. </li><li>  You can use <code>__new__</code> , <code>__init__</code> and <code>__call__</code> .  Of course, you can usually do everything in <code>__new__</code> , but some are more comfortable using <code>__init__</code> </li><li>  They are called meta <i>classes</i> , damn it!  That should mean something! </li></ul><br><br><h1>  Why use metaclasses at all? </h1><br>  Finally, the main question.  Why would anyone use some incomprehensible (and error-prone) feature? <br><br>  Well, usually do not use: <br><blockquote>  Metaclasses are deep magic, about which 99% of users do not even need to think.  If you think whether you need to use them - you do not need (people who really need them, know exactly why they need them, and do not need an explanation of why). <br>  ~ Guru Python Tim Peters <br></blockquote><br>  The main use of metaclasses is to create an API.  A typical example is Django ORM. <br><br>  It allows you to write something like this: <br><pre> <code class="python hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> name = models.CharField(max_length=<span class="hljs-number"><span class="hljs-number">30</span></span>) age = models.IntegerField()</code> </pre><br>  However, if you run the following code: <br><pre> <code class="python hljs"> guy = Person(name=<span class="hljs-string"><span class="hljs-string">'bob'</span></span>, age=<span class="hljs-string"><span class="hljs-string">'35'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> guy.age</code> </pre><br>  you get not <code>IntegerField</code> , but <code>int</code> , and the value can be obtained directly from the database. <br><br>  This is possible because <code>models.Model</code> defines <code>__metaclass__</code> , which <code>__metaclass__</code> some magic and turns the <code>Person</code> class that we just defined with a simple expression into a complex database binding. <br><br>  Django makes something complex looking simple by exposing a simple API and using metaclasses, recreating the code from the API and doing all the work imperceptibly. <br><br><h1>  At last </h1><br>  First, you learned that classes are objects that can instantiate. <br><br>  In fact, classes are instances too.  Instances of metaclasses. <br><pre> <code class="python hljs"> &gt;&gt;&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> &gt;&gt;&gt; id(Foo) <span class="hljs-number"><span class="hljs-number">142630324</span></span></code> </pre><br>  Anything is an object in Python: an instance of a class or an instance of a metaclass. <br><br>  Except <code>type</code> . <br><br>  <code>type</code> is its own metaclass.  It cannot be reproduced on pure Python and is done with a small cheat at the implementation level. <br><br>  Secondly, metaclasses are complex.  You do not need to use them to easily change classes.  This can be done in two different ways: <br><ul><li>  by hands </li><li>  class decorators </li></ul><br>  In 99% of cases, when you need to change the class, it is better to use these two. <br><br>  But in 99% of cases you don‚Äôt need to change classes at all :-) </div><p>Source: <a href="https://habr.com/ru/post/145835/">https://habr.com/ru/post/145835/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145829/index.html">Skype 4.0 for Linux</a></li>
<li><a href="../145830/index.html">Overview of WEB programmers salaries</a></li>
<li><a href="../145832/index.html">Clustering on the client or how to show 10,000 points on the map</a></li>
<li><a href="../145833/index.html">Skype 5.8 for Mac OS X</a></li>
<li><a href="../145834/index.html">BlackBerry 10 Jam World Tour in Moscow June 26</a></li>
<li><a href="../145836/index.html">What interesting things I learned at DevConf 2012</a></li>
<li><a href="../145837/index.html">Crowdfunding (skladchiny) in Russia: Interviews with the coordinators of the project "Tugize"</a></li>
<li><a href="../145842/index.html">Simple trading bot for The Settlers Online</a></li>
<li><a href="../145843/index.html">Analyzing the capabilities of mass auditing based on leaked hashes from LinkedIn</a></li>
<li><a href="../145844/index.html">User rating site content</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>