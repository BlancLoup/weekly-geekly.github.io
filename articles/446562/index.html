<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asynchrony in programming</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the area of ‚Äã‚Äãdeveloping high-load multi-threaded or distributed applications, there are often discussions about asynchronous programming. Today we...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asynchrony in programming</h1><div class="post__text post__text-html js-mediator-article"><p>  In the area of ‚Äã‚Äãdeveloping high-load multi-threaded or distributed applications, there are often discussions about asynchronous programming.  Today we will plunge into asynchrony in detail and study what it is when it occurs, how it affects the code and programming language that we use.  We will understand why we need Futures and Promises and touch upon the Korutin and operating systems.  This will make the trade-offs arising during software development more explicit. </p><br><p>  The material is based on a transcript of a report by Ivan Puzyrevsky, a teacher at the Yandex Data Analysis School. </p><br><p><img src="https://habrastorage.org/webt/zl/f-/6v/zlf-6v_wphtcesgmq7cvpvfctbk.png"></p><a name="habracut"></a><br><h1 id="videozapis">  Videotape </h1><br><iframe width="560" height="315" src="https://www.youtube.com/embed/g7dno0SupKY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><a name="section1"></a><br><h1 id="1-soderzhanie">  1. Content </h1><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><ul><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">1. Content</a> </li><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">2. Introduction</a> </li><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">3. Basic concepts</a> <br><ul><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">3.1.</a>  <a href="https://habr.com/ru/company/jugru/blog/446562/">Execution thread</a> </li><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">3.2.</a>  <a href="https://habr.com/ru/company/jugru/blog/446562/">Multitasking and concurrency</a> </li></ul></li><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">4. Blocking and waiting</a> <br><ul><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">4.1.</a>  <a href="https://habr.com/ru/company/jugru/blog/446562/">Non-blocking wait</a> </li></ul></li><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">5. Futures / Promises</a> <br><ul><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">5.1.</a>  <a href="https://habr.com/ru/company/jugru/blog/446562/">Future &amp; Promise interface</a> </li><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">5.2.</a>  <a href="https://habr.com/ru/company/jugru/blog/446562/">Composition Computing</a> </li><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">5.3.</a>  <a href="https://habr.com/ru/company/jugru/blog/446562/">Examples</a> </li><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">5.4.</a>  <a href="https://habr.com/ru/company/jugru/blog/446562/">Any combinator</a> </li><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">5.5.</a>  <a href="https://habr.com/ru/company/jugru/blog/446562/">All-Combinator</a> </li><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">5.6.</a>  <a href="https://habr.com/ru/company/jugru/blog/446562/">Callback adaptation</a> </li></ul></li><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">6. How to make the code more readable with the help of Corutin</a> <br><ul><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">6.1.</a>  <a href="https://habr.com/ru/company/jugru/blog/446562/">Korutiny</a> </li><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">6.2.</a>  <a href="https://habr.com/ru/company/jugru/blog/446562/">Draft implementation of WaitFor</a> </li><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">6.3.</a>  <a href="https://habr.com/ru/company/jugru/blog/446562/">How the planning cycle works</a> </li><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">6.4.</a>  <a href="https://habr.com/ru/company/jugru/blog/446562/">Coroutine TS</a> </li></ul></li><li>  <a href="https://habr.com/ru/company/jugru/blog/446562/">7. What did you get?</a> </li></ul></div></div><br><a name="section2"></a><br><h1 id="2-vvedenie">  2. Introduction </h1><br><p> Hello everyone, my name is Ivan Puzyrevsky, I work for Yandex.  For the last six years I have been working on the infrastructure for storing and processing data; now I have moved to a product - in the search for travel, hotels and tickets.  Since I worked for a long time in the infrastructure, I have accumulated quite a lot of experience how to write different loaded applications.  Our infrastructure operates <code>24*7*365</code> every day non-stop, continuously on thousands of machines.  Naturally, you need to write code so that it works reliably and efficiently and solves the tasks that the company sets for us. </p><br><p>  Today we will talk about asynchrony.  What is asynchrony?  This is a mismatch of something with something in time.  From this description it‚Äôs not at all clear what I‚Äôm going to talk about today.  To somehow clarify the question, I need an example a la ‚ÄúHello, world!‚Äù.  Asynchrony usually occurs in the context of writing network applications, so I will have a network equivalent of ‚ÄúHello, world!‚Äù.  This application is ping-pong.  The code looks like this: </p><br><pre> <code class="cpp hljs">socket s; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> x; x = read_from_socket(s, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == <span class="hljs-string"><span class="hljs-string">"ping"</span></span>) { write_to_socket(s, <span class="hljs-string"><span class="hljs-string">"pong"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p>  I create a socket, read a string from there, and check if it is ping, then I write back pong.  Very simple and straightforward.  What happens when you see such code on your computer screen?  We think of this code as a sequence of such steps: </p><br><p><img src="https://habrastorage.org/webt/va/3e/dk/va3edk8_ja838w9qo7apppwyy50.png"></p><br><p>  From the point of view of real physical time, everything is a bit shifted. </p><br><p><img src="https://habrastorage.org/webt/od/wo/4g/odwo4gzguqz7nr_odgsksityvda.png"></p><br><p>  Those who actually wrote this code and run it know that after the read step and after the step <br>  write goes a rather noticeable time interval when our program seems to be doing nothing from the point of view of our code, but under the hood there is a machine, which we call ‚Äúinput-output‚Äù. </p><br><p><img src="https://habrastorage.org/webt/ye/jl/67/yejl67r3goweaiupb1wjieg5i2a.png"><br>  During I / O, packets are exchanged over the network and all associated heavy, low-level work.  Let's conduct a mental experiment: let's take such a single program, run it on a single physical processor and pretend that we don't have any operating system, what will we get?  The processor can not stop, it continues to take cycles, without executing any instructions, just wasting energy. </p><br><p><img src="https://habrastorage.org/webt/pg/lu/xp/pgluxpmbkl8ho9w-2docuab2iqg.png"></p><br><p>  The question arises whether we can do something useful during this period of time.  A very natural question, the answer to which would allow us to save processor power and use them for something useful, while our application seems to be doing nothing. </p><br><a name="section3"></a><br><h1 id="3-osnovnye-ponyatiya">  3. Basic concepts </h1><br><a name="section3-1"></a><br><h2 id="31-potok-vypolneniya">  3.1.  Execution thread </h2><br><p>  How can we approach this task?  Let's agree on the concepts.  I will say ‚Äúflow of execution,‚Äù meaning some sensible sequence of elementary operations or steps.  Meaningfulness will be determined by the context in which I speak of the flow of execution.  That is, if we are talking about a single-threaded algorithm (Aho-Korasik, search by graph), then this algorithm itself - there is already a thread of execution.  He takes some steps to solve the problem. </p><br><p>  If I am talking about a database, then one thread of execution can be part of the actions performed by the database to service one incoming request.  Same for web servers.  If I write some kind of mobile or web application, then to service a single user operation, for example, a click on a button, network interactions, interaction with local storage, and so on occur.  The sequence of these actions from the point of view of my mobile application will also be a separate meaningful flow of execution.  From the point of view of the operating system, the process or thread of the process is also a meaningful thread of execution. </p><br><a name="section3-2"></a><br><h2 id="32-mnogozadachnost-i-parallelizm">  3.2.  Multitasking and concurrency </h2><br><p>  The cornerstone of performance is the ability to do this trick: when I have one execution thread that contains emptiness in my physical temporal sweep, then fill these voids with something useful ‚Äî perform the steps of other execution threads. </p><br><p><img src="https://habrastorage.org/webt/vw/x1/si/vwx1sijti5ahggnjozkymza2hna.png"></p><br><p>  Databases typically serve many clients at the same time.  If we can combine work on multiple threads of execution within a single thread of a higher level, this is called multitasking.  That is, multitasking is when I, within the framework of one larger stream of execution, perform actions that are subordinate to the solution of smaller tasks. </p><br><p>  It is important not to confuse the concept of multitasking with parallelism.  Parallelism - <br>  these are properties of the execution environment, which makes it possible to make progress in different execution threads in one step of time, in one step.  If I have two physical processors, then they can execute two instructions in one clock cycle.  If the program is running on a single processor, then it will take two bars of time to execute the same two instructions. </p><br><p><img src="https://habrastorage.org/webt/nq/n5/yf/nqn5yf1pee8kwgi3rw1lxmnyomi.png"></p><br><p>  It is important not to confuse these concepts, as they fall into different categories.  Multitasking is a property of your program that it is internally structured as a variable work on different tasks.  Parallelism is a property of the execution environment that allows you to work on several tasks in one measure of time. </p><br><p>  In many ways, asynchronous code and writing asynchronous code is writing multitasking code.  The main difficulty is in how I code tasks and how to manage them.  Therefore, today we will talk about this - about writing multi-tasking code. </p><br><a name="section4"></a><br><h1 id="4-blokirovanie-i-ozhidanie">  4. Blocking and waiting </h1><br><p><img src="https://habrastorage.org/getpro/habr/post_images/da7/042/897/da7042897d750697821baf6381db92ea.png"></p><br><p>  Let's start with some simple example.  Let's go back to the ping-pong: </p><br><pre> <code class="cpp hljs">socket s; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> x; x = read_from_socket(s, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == <span class="hljs-string"><span class="hljs-string">"ping"</span></span>) { write_to_socket(s, <span class="hljs-string"><span class="hljs-string">"pong"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p>  As we have already discussed, after the read and white lines, the execution thread falls asleep, is blocked.  Usually we say, "the flow is blocked." </p><br><pre> <code class="cpp hljs">socket s; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> x; x = read_from_socket(s, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* thread is blocked here */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == <span class="hljs-string"><span class="hljs-string">"ping"</span></span>) { write_to_socket(s, <span class="hljs-string"><span class="hljs-string">"pong"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* thread is blocked here */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p>  This means that the flow of execution has reached a point where it is necessary for an event to proceed to continue.  In particular, in the case of our network application, it is necessary for the data to arrive over the network or, on the contrary, we have a buffer for writing data to the network.  Events may be different.  If we are talking about time aspects, we can wait for the timer to trigger or for another process to complete.  Events here are a kind of abstract thing, it is important to understand about them that they can be expected. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c91/02f/7ca/c9102f7ca66291666b9df9c05ce7f46e.png"></p><br><p>  When we write simple code, we implicitly give control of the expectation of events to a higher level.  In our case, the operating system.  She, as the essence of a higher level, is responsible for choosing which task will be performed further, and she is also responsible for tracking the occurrence of events. </p><br><p>  Our code, which we write as developers, is structured at the same time regarding the work on one task.  The example code fragment processes one connection: it reads ping from one connection and writes pong to one connection. </p><br><p>  The code is clear.  You can read it and understand what it does, how it works, what problem it solves, what invariants it has, and so on.  At the same time, we very poorly manage the planning of tasks in such a model.  In general, operating systems have concepts of priorities, but if you wrote soft real-time systems, then you know that the tools available in Linux are not enough to create sufficiently sane real-time systems. </p><br><p>  Further, the operating system is a complex thing, and switching the context from our application to the kernel costs a few microseconds, which, with some simple counting, gives us an estimate of about 20-100 thousand context switches per second.  This means that if we write a web server, we can process about 20 thousand requests in one second, assuming that processing requests is ten times more expensive than the work of the system. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c12/68f/503/c1268f5037154f9f0f5ac5bc82dfc531.png"></p><br><a name="section4-1"></a><br><h2 id="41-neblokiruyuschee-ozhidanie">  4.1.  Non-blocking wait </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ffe/97f/c42/ffe97fc42eca8beb2dae841358b31b8e.png"></p><br><p>  If you come to the situation that you need to work with the network more efficiently, then you start looking for help on the Internet and come to the use of select / epoll.  It is written on the Internet that if you want to serve thousands of connections at the same time, you need an epoll, because it is a good mechanism and so on.  You open the documentation and see something like this: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">select</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nfds, fd_set* readfds, fd_set* writefds, fd_set* exceptfds, struct timeval* timeout)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FD_CLR</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, fd_set* </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">  </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FD_ISSET</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, fd_set* </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FD_SET</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, fd_set* </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FD_ZERO</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fd_set* </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">epoll_ctl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> epfd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> op, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, struct epoll_event* event)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">epoll_wait</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> epfd, struct epoll_event* events, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> maxevents, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeout)</span></span></span></span>;</code> </pre> <br><p>  Functions in which the interface contains either a set of descriptors that you work with (in the select case) or a set of events that pass <br>  across the boundaries of your operating system kernel application that you need to handle (in the case of epoll). </p><br><p>  It is also worth adding that you can come not to select / epoll, but to a library like libuv, which has no events in the API, but will have many callbacks.  The library interface will say: "Dear friend, to read the socket, provide a callback, which I will call when the data is available." </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uv_timer_start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_timer_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* handle, uv_timer_cb cb, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeout, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> repeat)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*uv_timer_cb)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_timer_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* handle)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uv_read_start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_stream_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* stream, uv_alloc_cb alloc_cb, uv_read_cb read_cb)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uv_read_stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_stream_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">*)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*uv_read_cb)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_stream_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* stream, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ssize_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nread, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_buf_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* buf)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uv_write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_write_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* req, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_stream_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* handle, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_buf_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bufs[], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nbufs, uv_write_cb cb)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*uv_write_cb)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_write_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* req, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> status)</span></span></span></span>;</code> </pre> <br><p>  What has changed compared to our synchronous code in the previous chapter?  The code has become asynchronous.  This means that we in the application took the logic to determine the point in time when the occurrence of events is monitored.  Explicit select / epoll calls are points where we request information about the events from the operating system.  We also took a choice in the code of our application, on which task to work further. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/458/28b/5f2/45828b5f2463ec94abf292e8a5db86bf.png"></p><br><p>  From the examples of interfaces, it can be noted that there are basically two mechanisms for introducing multitasking.  One kind of "pull" when we <br>  We pull out many of the events that we are waiting for, and then somehow react to them.  In this approach, it is easy to absorb the overhead of one <br>  an event and therefore achieve a high throughput of communication about the multitude of events that have occurred.  Usually, all network elements like kernel interaction with a network card or interactions between you and the operating system are based on poll mechanisms. </p><br><p>  The second way is a ‚Äúpush‚Äù type mechanism, when a certain external entity obviously comes, interrupts the execution flow and says: ‚ÄúNow, please process the event that has now arrived.‚Äù  This is an approach with callbacks, with unix signals, with interruptions at the processor level, when an external entity intrudes into your execution flow and says: ‚ÄúNow, please, we are working on this event.‚Äù  Such an approach appeared in order to reduce the delay between the occurrence of an event and the reaction to it. </p><br><p>  Why do we, C ++ developers, who write and solve concrete applied problems, may want to drag an event model into our code?  If we drag and drop the work on many tasks and their management into our code, then due to the lack of transition to the core and back, we can work a little faster and perform more useful actions per unit of time. </p><br><p>  What does this lead to in terms of the code that we write?  Take, for example, nginx - a high-performance HTTP server, very common.  If you read his code, it is built on an asynchronous model.  The code is quite difficult to read.  When you ask yourself what exactly happens when processing a single HTTP request, it turns out that there are a lot of fragments in the code, separated by different files, in different corners of the code base.  Each fragment does a small amount of work as part of serving the entire HTTP request.  For example: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ngx_http_request_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ngx_event_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ev)</span></span></span><span class="hljs-function"> </span></span>{ ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c-&gt;close) { ngx_http_terminate_request(r, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ev-&gt;write) { r-&gt;write_event_handler(r); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { r-&gt;read_event_handler(r); } ... } <span class="hljs-comment"><span class="hljs-comment">/* where the handler... */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*ngx_http_event_handler_pt)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ngx_http_request_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *r)</span></span></span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ngx_http_request_s</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> ngx_http_event_handler_pt read_event_handler; <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> }; <span class="hljs-comment"><span class="hljs-comment">/* ...is set when switching to the next processing stage */</span></span> r-&gt;read_event_handler = ngx_http_request_empty_handler; r-&gt;read_event_handler = ngx_http_block_reading; r-&gt;read_event_handler = ngx_http_test_reading; r-&gt;read_event_handler = ngx_http_discarded_request_body_handler; r-&gt;read_event_handler = ngx_http_read_client_request_body_handler; r-&gt;read_event_handler = ngx_http_upstream_rd_check_broken_connection; r-&gt;read_event_handler = ngx_http_upstream_read_request_handler;</code> </pre> <br><p>  There is a request structure that is forwarded to the event handler when the socket signals readiness or write access.  Further, this handler is constantly switched along with the program, depending on the state of the request processing.  Either we read the headers, or we read the request body, or we ask upstream data - in general, many different states. </p><br><p>  Such code is difficult to read, because, in its essence, it is described in terms of reaction to events.  We are in such and such a state and react in a certain way to the events that have occurred.  There is a lack of a complete picture of the entire process of processing an HTTP request. </p><br><p>  Another option - which is commonly used in JavaScript - is to build code on the basis of callbacks, when we send our callback to the interface call, which usually has some nested callback on the occurrence of the event, and so on. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> LibuvStreamWrap::ReadStart() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> uv_read_start(stream(), [](<span class="hljs-keyword"><span class="hljs-keyword">uv_handle_t</span></span>* handle, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> suggested_size, <span class="hljs-keyword"><span class="hljs-keyword">uv_buf_t</span></span>* buf) { <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;LibuvStreamWrap*&gt;(handle-&gt;data)-&gt;OnUvAlloc(suggested_size, buf); }, [](<span class="hljs-keyword"><span class="hljs-keyword">uv_stream_t</span></span>* stream, <span class="hljs-keyword"><span class="hljs-keyword">ssize_t</span></span> nread, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uv_buf_t</span></span>* buf) { <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;LibuvStreamWrap*&gt;(stream-&gt;data)-&gt;OnUvRead(nread, buf); }); } <span class="hljs-comment"><span class="hljs-comment">/* ...for example, parsing http... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (p=data; p != data + len; p++) { ch = *p; reexecute: <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (CURRENT_STATE()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_start_req_or_res: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_or_resp_H: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_HT: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_HTT: <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_HTTP: <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_http_major: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_http_dot: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span></code> </pre> <br><p>  The code is again very fragmented, there is no understanding of the current state of how we work on the request.  A lot of information is transmitted through the closures, and you need to put mental effort into reconstructing the logic of processing a single request. </p><br><p>  Thus, by introducing multitasking into our code (the logic of the choice of working tasks and their multiplexing), we get effective code and control over the prioritization of tasks, but very much lose readability.  This code is difficult to read and difficult to maintain. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/da5/a8a/151/da5a8a1517fb18945a330ae4c2b6d722.png"></p><br><p>  Why?  Imagine I have a simple case, for example, I read a file and transfer it over the network.  In a non-blocking version, this linear state machine will correspond to this case: </p><br><ul><li>  Initial state </li><li>  Start reading file </li><li>  Waiting for a response from the file system, </li><li>  Write file to socket </li><li>  The final state. </li></ul><br><p>  Now, let's say I want to add information from the database to this file.  Simple option: </p><br><ul><li>  initial state </li><li>  I read the file </li><li>  read the file </li><li>  read from the database </li><li>  read from the database </li><li>  working with a socket </li><li>  written to the socket. </li></ul><br><p>  It seems like a linear code, but the number of states has increased. </p><br><p>  Then you start to think that it would be nice to parallelize two steps - reading from a file and from a database.  The wonders of combinatorics begin: you are in the initial state, requesting the reading of the file and the data from the database.  Then you can either come to the state where there is data from the database, but there is no file, or vice versa - there is data from the file, but not from the database.  Next you need to go into a state where you have one of the two.  Again, these are two states.  Then you need to go into a state where you have both ingredients.  Then write them in the socket and so on. </p><br><p>  The more complex the application, the more states, the more code fragments that need to be combined in your head.  Inconvenient.  Or you write noodles from kollbekov which is inconvenient to read.  If a spreading system is written, then one day there comes a time when it can no longer be tolerated. </p><br><a name="section5"></a><br><h1 id="5-futurespromises">  5. Futures / Promises </h1><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f93/0ea/b0a/f930eab0a9a5556b0db5d21f23d98190.png"></p><br><p>  To solve a problem, you need to look at the situation easier. </p><br><p><img src="https://habrastorage.org/webt/-v/6e/gb/-v6egbslm8_jjhwcsevjffbe35s.png"></p><br><p>  There is a program, it has black and red circles.  Our execution flow is black circles;  sometimes they are interspersed with red when the stream cannot continue its work.  The problem is that for our black flow you need to get into the next black circle, which will not be known when. </p><br><p>  The problem is that when we write code in a programming language, we explain to the computer what to do right now.  A computer is a conventionally simple thing that is awaiting instructions that we write in the programming language.  She is waiting for instructions on the next circle, and in our programming language there are not enough means to say: "In the future, please, when some event comes, do something." </p><br><p><img src="https://habrastorage.org/webt/vp/8f/mx/vp8fmxhtnkukhqym-baw3g4mzyg.png"></p><br><p>  In the programming language, we operate with understandable, momentary actions: a function call, arithmetic operations, and so on.  They describe the specific next next step.  At the same time, in order to process the application logic, we need to describe not the next physical step, but the next logical step: what should we do when data from the database appears, for example. </p><br><p><img src="https://habrastorage.org/webt/6m/by/ma/6mbyma_pagz74dx-j2ch1ixpxpg.png"></p><br><p>  Therefore, we need a mechanism to combine these fragments.  In the case when we wrote the synchronous code, we hid the question completely under the hood and said that the operating system would do this, allowed it to interrupt and reschedule our execution threads. </p><br><p>  In level 1, we opened this Pandora's box, and it introduced a lot of switch, case, conditions, branches, and states into the code.  I want some kind of compromise, so that the code is relatively readable, but retains all the advantages of level 1. </p><br><p>  Fortunately for us, in 1988, people involved in distributed systems, Barbara Liskov and Lyuba Shirira, realized the problem, and came to the need for linguistic changes.  In the programming language, you need to add constructions that allow you to express temporal connections between events - at the current time and at an uncertain moment in the future. </p><br><p>  This is called Promises.  The concept is cool, but it has been gathering for twenty years on a shelf.       ‚Äî  ,   Twitter,      Ruby on Rails  Scala,     ,  ,      ,      future  .     Your Server as a Function.   ,        . </p><br><p>   Scala,    , ++ ? </p><br><p>    ,   Future.      T c  :       ,  -    . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class"> &lt;T&gt;</span></span></code> </pre> <br><p>         ,    ,  ,     .   ,   ¬´¬ª,  ,      .     Future     ¬´¬ª,  Promise ‚Äî  ¬´¬ª.        ;  ,  JavaScript, Promise ‚Äî      ,   Java ‚Äì   Future. </p><br><p>   ,     .     ,       ,     boost::future ( std::future) ‚Äî      ,     . </p><br><a name="section5-1"></a><br><h2 id="51-interfeys-future--promise">  5.1.  Future &amp; Promise </h2><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> T&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">T* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryGet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::function&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&amp;)&gt; cb)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">R</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Then</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">:</span></span>:function&lt;R(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp;)&gt; f); <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">R</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Then</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">:</span></span>:function&lt;Future&lt;R&gt;(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp;)&gt; f); }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MakeFuture</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">);</span></span></code> </pre> <br><p>  , ,  - ,      .  , ,      ,   . ,      ,       ‚Äî   ,   ,   .       Then,      . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Promise</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Set</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&amp; value)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TrySet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&amp; value)</span></span></span></span>; Future&lt;T&gt; ToFuture() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Promise</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NewPromise</span></span></span><span class="hljs-class">();</span></span></code> </pre> <br><p>   .      ,       .    ¬´, , ,      ¬ª. </p><br><a name="section5-2"></a><br><h2 id="52-kompoziciya-vychisleniy">  5.2.   </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/676/e68/6b7/676e686b75c6875ba0a914567bc46839.png"></p><br><p>    ?  ,         .  Then ‚Äî  ,      . </p><br><p> ,      ‚Äî future --,     -  t ‚Äî       .    , ,   ,        f,  -     r. </p><br><p>          t     f.        ,  ,      r. </p><br><p>   :    t,      ,   r      .       : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">template</span></span></span><span class="hljs-class"> &lt;class R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt;:</span></span>:Then(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::function&lt;R(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp;)&gt; f) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> promise = NewPromise&lt;R&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;Subscribe([promise] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp; t) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> r = f(t); promise.Set(r); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promise.ToFuture(); }</code> </pre> <br><p>  : </p><br><ul><li>  <code>Promise</code>  <code>R</code> , </li><li>    <code>Future&lt;T&gt;</code>    <code>t</code> , </li><li>   ,    <code>r = f(t)</code> , </li><li>  <code>r</code>   <code>Promise</code> , </li><li>      <code>Promise</code> . </li></ul><br><p>      <code>f</code> ,     <code>R</code> ,  <code>Future&lt;R&gt;</code> ,         <code>R</code> .  : </p><br><ul><li>          <code>T</code> , </li><li>  ,     <code>T</code> ,  ,      <code>R</code> , </li><li>     ,      <code>R</code> ,    ,        . </li></ul><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">template</span></span></span><span class="hljs-class"> &lt;class R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt;:</span></span>:Then(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::function&lt;Future&lt;R&gt;(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp;)&gt; f) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> promise = NewPromise&lt;R&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;Subscribe([promise] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp; t) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> that = f(t); that.Subscribe([promise] (R r) { promise.Set(r); }); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promise.ToFuture(); }</code> </pre> <br><p>        ,   -    t.        f,        r,    .    ,       ,   . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/3c6/92f/064/3c692f06489d41c745a0d1b51085b278.png"></p><br><p>    ,    Then   : </p><br><ul><li>   <code>Promise</code> , </li><li>  <code>Subscribe</code>   -, </li><li>  <code>Promise</code> ,   <code>Future</code> . </li></ul><br><p>      ,       .    ,       ,    ,            . </p><br><p>     ,   ,          ,     -.   ,  ,   -,   Subscribe.       ,    ,   ,  -  .   ,    . </p><br><a name="section5-3"></a><br><h2 id="53-primery">  5.3.  Examples </h2><br><p>       AsyncComputeValue,      GPU,        .   Then,    ,        (2v+1) <sup>2</sup> . </p><br><pre> <code class="cpp hljs">Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; value = AsyncComputeValue(); <span class="hljs-comment"><span class="hljs-comment">//    value.Subscribe([] (int v) { std::cerr &lt;&lt; "Value is: " &lt;&lt; v &lt;&lt; std::endl; });</span></span></code> </pre> <br><p>      .  ,    :   (2v+1) <sup>2</sup>       .       ,            . </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//  (2v+1)^2 Future&lt;int&gt; anotherValue = value .Then([] (int v) { return 2 * v; }) .Then([] (int u) { return u + 1; }) .Then([] (int w) { return w * w; });</span></span></code> </pre> <br><p>     ,     ,       .       . </p><br><p>  .   :   ,       ;       ;       . </p><br><pre> <code class="cpp hljs">Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; GetDbKey(); Future&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; LoadDbValue(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> key); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; SendToMars(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> message); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; ExploreOuterSpace() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetDbKey() <span class="hljs-comment"><span class="hljs-comment">// Future&lt;int&gt; .Then(&amp;LoadDbValue) // Future&lt;string&gt; .Then(&amp;SendToMars); // Future&lt;void&gt; } ExploreOuterSpace().Subscribe( [] () { std::cout &lt;&lt; "Mission Complete!" &lt;&lt; std::endl; });</span></span></code> </pre> <br><p>         ‚Äî ExploreOuterSpace.           Then;    ‚Äî    ‚Äî    ,     .         ( ) .      . </p><br><a name="section5-4"></a><br><h2 id="54-any-kombinator">  5.4. Any- </h2><br><p>  :     <code>Future</code>    ,       ,      . ,  ,          : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Any</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f2</span></span></span><span class="hljs-class">) {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> promise = NewPromise&lt;T&gt;(); f1.Subscribe([promise] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp; t) { promise.TrySet(t); }); f2.Subscribe([promise] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp; t) { promise.TrySet(t); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promise.ToFuture(); } <span class="hljs-comment"><span class="hljs-comment">//    </span></span></code> </pre> <br><p>   ,      Any-,      Future  :   ,   .      ,    ,  . </p><br><p>   ,  ,       ,     ,  ,    .      ¬´   DB1,    DB2,        ‚Äî  - ¬ª. </p><br><a name="section5-5"></a><br><h2 id="55-all-kombinator">  5.5. All- </h2><br><p>    .                  ,       ,  ,     ( T1  T2),    T1  T2   ,        ,   . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T2</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;std::tuple&lt;T1, T2&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">All</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T1&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T2&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f2</span></span></span><span class="hljs-class">) {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> promise = NewPromise&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;T1, T2&gt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_shared&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;T1, T2&gt; &gt;(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> counter = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_shared&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::atomic&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; &gt;(<span class="hljs-number"><span class="hljs-number">2</span></span>); f1.Subscribe([promise, result, counter] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T1&amp; t1) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::get&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>&gt;(*result) = t1; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (--(*counter) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { promise.Set(*result)); } }); f2.Subscribe([promise, result, counter] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T2&amp; t2) { <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promise.ToFuture(); } <span class="hljs-comment"><span class="hljs-comment">//    </span></span></code> </pre> <br><p>    nginx.   ,      ,        .     nginx    ¬´ ¬ª, ¬´  ¬ª, ¬´    ¬ª   .  All-         ,     .      . </p><br><a name="section5-6"></a><br><h2 id="56-adaptaciya-obratnogo-vyzova">  5.6.    </h2><br><p>   Future  Promises ‚Äî     legacy-,   .     callback-    ,     ,   :   Future,     ,   callback-  Future. </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//   cb     void LegacyAsyncComputeStuff(std::function&lt;void(int)&gt; cb); //      Future Future&lt;int&gt; ModernAsyncComputeStuff() { auto promise = NewPromise&lt;int&gt;(); LegacyAsyncComputeStuff( [promise] (int value) { promise.Set(value); }); return promise.ToFuture(); }</span></span></code> </pre> <br><p> :      ,              Future  . </p><br><a name="section6"></a><br><h1 id="6-kak-sdelat-kod-chitaemee-s-pomoschyu-korutin"> 6.        </h1><br><p><img src="https://habrastorage.org/getpro/habr/post_images/19a/093/212/19a093212125673ff89cc4196c59583a.png"></p><br><p>   ,     ,     .  . </p><br><pre> <code class="cpp hljs">Future&lt;Request&gt; GetRequest(); Future&lt;Payload&gt; QueryBackend(Request req); Future&lt;Response&gt; HandlePayload(Payload pld); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; Reply(Request req, Response rsp); <span class="hljs-comment"><span class="hljs-comment">// req  2 :  QueryBackend   Reply GetRequest().Subscribe( [] (Request req) { auto rsp = QueryBackend(req) .Then(&amp;HandlePayload) .Then(Bind(&amp;Reply, req)); });</span></span></code> </pre> <br><p>      .    Request,   -   .  ,     .  ,   ,        ,    .  ,   -      . </p><br><p>  ,  ,     .  What to do?   ‚Äî  ,    request  payload,     ‚Äî  ,      . </p><br><p> ,   Java   Netty. ,      ,        .  ,        ,    . </p><br><p>      ,    GetRequest, QueryBackend, HandlePayload   Reply   ,     Future. </p><br><p>     ,   ,   Future   T ‚Äî   WaitFor. <br></p><pre> <code class="cpp hljs">Future&lt;Request&gt; GetRequest(); Future&lt;Payload&gt; QueryBackend(Request req); Future&lt;Response&gt; HandlePayload(Payload pld); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; Reply(Request req, Response rsp); <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">future</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-comment"><span class="hljs-comment">// req  2 :  QueryBackend   Reply GetRequest().Subscribe( [] (Request req) { auto rsp = QueryBackend(req) .Then(&amp;HandlePayload) .Then(Bind(&amp;Reply, req)); });</span></span></code> </pre> <br><p>      : </p><br><pre> <code class="cpp hljs">Future&lt;Request&gt; GetRequest(); Future&lt;Payload&gt; QueryBackend(Request req); Future&lt;Response&gt; HandlePayload(Payload pld); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; Reply(Request req, Response rsp); <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">future</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> req = WaitFor(GetRequest()); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> pld = WaitFor(QueryBackend(req)); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> rsp = WaitFor(HandlePayload(pld)); WaitFor(Reply(req, rsp));</code> </pre> <br><p>   :    Future,    .    .         ,    .      . </p><br><p>     .                    .     -  0,     ,  , mutex+cvar  future.        .          ,     . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/99d/f77/3e4/99df773e4d1922427ab7dc98fde28b8f.png"></p><br><a name="section6-1"></a><br><h2 id="61-korutiny">  6.1.  </h2><br><p>  ,        .        ,  ,     ,   ,    - ,   .     ,    <i>-</i> . </p><br><p>       ‚Äî ¬´¬ª      ,  ,    .       .     .  : boost::asio  boost::fiber. </p><br><p>         ,                .  How to do it? </p><br><a name="section6-2"></a><br><h2 id="62-chernovik-realizacii-waitfor">  6.2.   WaitFor </h2><br><p>   , , boost::context,        :  ,   ;  ,              .    x86/64       ,       ,         . </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//      class MachineContext; //     from,    to void SwitchContext(MachineContext* from, MachineContext* to); //      ‚Äì boost::context //    // * x86_64-ASM (push...-movq(rsp,eip)-pop...-jmpq) // * makecontext/swapcontext // * setjmp/longjmp</span></span></code> </pre> <br><p>      ,       goto:    ,     ,        ,   . </p><br><p>      ,  -   .     Fiber ‚Äî   .       +Future.  ,      ,         Future,    . </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fiber</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> MachineContext context_; Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; future_; };</code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Scheduler</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Future&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; future)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; MachineContext loop_context_; Fiber* current_fiber_; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">deque</span></span>&lt;Fiber*&gt; run_queue_; };</code> </pre> <br><p>  Future   ,     ,    ,     .    :   Loop,      ,    ,   ,        ,    . </p><br><p>     WaitFor? </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">thread_local</span></span> Scheduler* ThisScheduler; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">future</span></span></span><span class="hljs-class">) {</span></span> ThisScheduler-&gt;WaitFor(future.As&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt;()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> future.Get(); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Scheduler::WaitFor(Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; future) { current_fiber_-&gt;future_ = future; SwitchContext(¬§t_fiber_-&gt;context_, &amp;loop_context_); }</code> </pre> <br><p>   :  ,   -   ,      ,      Future  void,        .           . </p><br><p>  <code>Future&lt;void&gt;</code>   ,     ,    -  . </p><br><p>   WaitFor    :   : ¬´     Fiber   Future¬ª,        ( )       . </p><br><p>  ,        : <br> <code>ThisScheduler-&gt;WaitFor</code>  <code>return future.Get()</code> ,         . </p><br><p>      ?  ,       Future,      . </p><br><a name="section6-3"></a><br><h2 id="63-kak-ustroen-cikl-planirovaniya">  6.3.     </h2><br><p>   -  , ,    ,     -     ,    .    SwitchContext   ,    2 ‚Äî       . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Scheduler::Loop() { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// (1)     (= !) current_fiber_ = run_queue_.front(); run_queue_.pop_front(); SwitchContext(&amp;loop_context_, ¬§t_fiber_-&gt;context_); // (2) ,      //‚Ä¶</span></span></code> </pre> <br><p>   ?   ,   ,    ,     Future,       Future, ,     ,           . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Scheduler::Loop() { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// (1)     ‚Ä¶ // (2) ,      if (current_fiber_-&gt;future_) { current_fiber_-&gt;future_.Subscribe( [this, fiber = current_fiber_] { fiber-&gt;future_ = nullptr; run_queue_.push_back(fiber); }); } //‚Ä¶</span></span></code> </pre> <br><p>   ,      .       : </p><br><p>     WaitFor ‚Äî   . </p><br><p><img src="https://habrastorage.org/webt/_4/m8/ao/_4m8aoag2egfc2mzczah2xf6a9i.png"></p><br><p>    Switch-    . </p><br><p><img src="https://habrastorage.org/webt/sa/hg/kz/sahgkzqleux5-htiqo-58lb0gua.png"></p><br><p>     Future    (  ),   ,         .   -               Fiber. </p><br><p><img src="https://habrastorage.org/webt/hg/cm/gc/hgcmgclv5raicu_tlfywmw0yrpi.png"></p><br><p>   WaitFor     Future ,     - , Future  .     : </p><br><pre> <code class="cpp hljs">Future&lt;Request&gt; GetRequest(); Future&lt;Payload&gt; QueryBackend(Request req); Future&lt;Response&gt; HandlePayload(Payload pld); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; Reply(Request req, Response rsp); <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">future</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> req = WaitFor( GetRequest()); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> pld = WaitFor( QueryBackend(req)); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> rsp = WaitFor( HandlePayload(pld)); WaitFor( Reply(req, rsp));</code> </pre> <br><p>    ,    ,      ,   .         ,    ,    . </p><br><a name="section6-4"></a><br><h2 id="64-coroutine-ts">  6.4. Coroutine TS </h2><br><p>    ?   ‚Äî .   Coroutine TS,        ,  WaitFor  CoroutineWait,    CoroutineTS ‚Äî  -  .     ,         - . ,    Waiter  Co,     ,    . </p><br><a name="section7"></a><br><h1 id="7-chto-poluchili"> 7.  ? </h1><br><p>   .           ,   ,    ,    .     ,       ,     ,    . </p><br><p>     ‚Äî  .    ,                  .       .     ,     . ,         ,        ,         ,      . </p><br><p>       -    ,        ,               .    ,  .      ,                ,          . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e02/3b7/924/e023b79240490a7b561152aa0972b3ac.png"></p><br><p>         ,   ?    ,     . </p><br><p>   .       ,     ,   ,  ,      .       .       ,     ,     ,    ,    . </p><br><p>    nginx,  ,  ,  ,       ,    .        ,     ,  ,    future  promises. </p><br><p>     ,       ,    ,     ,       ,      ,      ,      . </p><br><p>       futures, promises  actors.    .             ,    . </p><br><p> :      , ,   ,     .               ,    , ,      ,   .     ? ,   . </p><br><blockquote>  Minute advertising. 19-20      C++ Russia 2019.      , , Grimm Rainer    <a href="https://cppconf.ru/talks/6hdip4v8eo46ii6eeoiw2a/%3Futm_source%3Dhabr%26utm_medium%3D446562">¬´Concurrency and parallelism in C++17 and C++20/23¬ª</a> ,      <a href="https://cppconf.ru/talks/71pfrakjfyajckbsyeudkg/%3Futm_source%3Dhabr%26utm_medium%3D446562">   C++</a> .      <a href="https://cppconf.ru/%3Futm_source%3Dhabr%26utm_medium%3D446562"> </a> ,    <a href="https://cppconf.ru/registration/%3Futm_source%3Dhabr%26utm_medium%3D446562"> </a> .  ,         ,    <a href="https://cppconf.ru/buy/online/%3Futm_source%3Dhabr%26utm_medium%3D446562">-</a> . </blockquote></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/446562/">https://habr.com/ru/post/446562/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../446550/index.html">Pattern Problems Coordinator and what's the RouteComposer</a></li>
<li><a href="../446552/index.html">Working with APDU commands using the EToken example</a></li>
<li><a href="../446554/index.html">Resident program of Yandex, or How to become an ML-engineer as an experienced backend</a></li>
<li><a href="../446558/index.html">Exotic data structures: Modified Merkle Patricia Trie</a></li>
<li><a href="../446560/index.html">‚ÄúExchange of courtesies‚Äù: what is the essence of the conflict between the two most famous streaming companies</a></li>
<li><a href="../446566/index.html">Project Zero. How Amazon wants to deal with fakes</a></li>
<li><a href="../446568/index.html">Large-scale update CMS Umbraco 8: what's new</a></li>
<li><a href="../446570/index.html">The history of the first GPU: Rendition V√©rit√© 1000</a></li>
<li><a href="../446572/index.html">Editor.js is an excellent editor saving source code in JSON format.</a></li>
<li><a href="../446576/index.html">Import substitution, or how Russian Helicopters did something wrong</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>