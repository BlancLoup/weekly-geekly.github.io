<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We stabilize PHP in battle - what and why the web server ‚Äúdrops‚Äù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="You are responsible for the stability of the web project in PHP. The load is constantly growing, features are added, customers are satisfied. One day,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We stabilize PHP in battle - what and why the web server ‚Äúdrops‚Äù</h1><div class="post__text post__text-html js-mediator-article">  You are responsible for the stability of the web project in PHP.  The load is constantly growing, features are added, customers are satisfied.  One day, mysterious mistakes begin to appear ... <br><img src="https://habrastorage.org/storage2/b5d/e0f/48a/b5de0f48aa716872541e4f3afa180961.jpg"><br><h4>  Errors of server software </h4><br>  ... which programmers do not know how to fix, because  The server software ‚Äúbreaks down‚Äù, for example, a bunch of apache-PHP ‚Äî and the client receives a maintenance work page in response to a request.  A web developer often doesn‚Äôt have deep knowledge of C programming on unix / linux, and a sysadmin often, unfortunately, doesn‚Äôt dive deeper into bash.  Real hardcore :-) <br><br><h4>  Unstable server scripts </h4><br>  Often, certain pages of a web project start to go crazy.  For example, running for 15 minutes and finding out what they are doing is not easy.  <a href="http://habrahabr.ru/company/bitrix/blog/144482/">In the last post on this topic,</a> I described one of the methods for determining what a PHP script does on a combat server, but it feels like we need a more powerful tool. <br><br>  In practice, I often encounter projects that are confronted with a similar class of ‚Äúserver software‚Äù errors, and the team does not always know what to do.  In the apache log, segmentation violation messages (segmentation fault) often appear, clients get an error page, and a web developer with a sysadmin puzzles, plays with different versions of PHP / apache / precompiler, compiles PHP from source with different options again and again , they write about bugs, and they prove that these bugs are not PHP, but their code, and so on to infinity ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the article I want to tell you how to quickly and easily find the reason why PHP crumbled on the combat server and eliminate it - without plunging into the wonderful world of system programming in C for unix :-) You will need a wish and one cup of coffee. <br><br><a name="habracut"></a><br><br><h4>  We look in the error log of the web server </h4><br>  If you see something similar in the apache error log, then the article is for you: <br> <code>[Mon Oct 01 12:32:09 2012] [notice] child pid 27120 exit signal Segmentation fault (11) <br></code> <br><img src="https://habrastorage.org/storage2/744/0ab/b70/7440abb70199ef101acc192576681716.jpg"><br>  In this case, it is useless to look for detailed information in the PHP error log - the process itself crashed, not the script.  If you don‚Äôt make a nice page about maintenance work on nginx in advance, then customers will see an ascetic error "50 *". <br><br>  I would like to give someone in the face, but to whom?  :-) To escape from destructive decisions, recall the theory. <br><br>  What is ‚Äúsignal‚Äù?  It can be said a means that the operating system uses to tell the process that, for example, it is not right :-) Takes and, breaking the laws of mathematics, divides into ... 0, or by violent actions causes stack overflow.  In this case, we see the signal with the number 11 and the name "SIGSEGV".  The list of signals can be viewed by running ‚Äúkill -l‚Äù: <br> <code>... <br> 11) SIGSEGV <br> ... <br></code> <br><br>  <s>Some signals, such as SIGSEGV, cannot be intercepted, so your apache-PHP process will be mercilessly killed by the kernel without trial.</s>  It turns out that it is possible to intercept it, but you need to go to the source :-) <br><br><h4>  And for what they killed it? </h4><br>  Now we will find the reason why apache-PHP was killed?  To do this, you need to configure the process to create a memory dump at the time of the kill :-) or coredump.  Yes, yes - an obsolete 50-year term is still used, meaning the saving of data <a href="http://en.wikipedia.org/wiki/Core_dump">from magnetic cores</a> .  The next time the process is killed by the operating system, the file will be created by the kernel - the place and its name <a href="http://www.kernel.org/doc/man-pages/online/pages/man5/core.5.html">can be configured</a> .  If you are in the console, just type "man 5 core". <br><img src="https://habrastorage.org/storage2/1e5/6b4/35e/1e56b435ec82ea0f2c65505a7e9f39e4.jpg"><br>  For example, you can add files to daddy like this: <br>  echo "/tmp/httpd-core.%p"&gt; / proc / sys / kernel / core_pattern <br><br>  If nothing is set, the system will create a file with the name ‚Äúcore. # Process_number #‚Äù in the working directory of the process. <br><br>  Just make sure the apache-php process has write access to it. <br><br>  That's not all.  By default, most likely, generation of coredump files is disabled on your system.  You can enable it by inserting a line at the beginning of the web server startup script: <br> <code>ulimit - unlimited</code> <br>  or, to make the configuration permanent, edit the "/etc/security/limits.conf" file.  There you can insert: <br> <code>apache - core -1 <br></code> <br>  Details on the file format - "man limits.conf". <br><br>  However, while I didn‚Äôt set up a folder for coredump files for apache, <a href="httpd.apache.org/docs/2.2/mod/mpm_common.html">nothing worked</a> ("/etc/httpd/conf/httpd.conf"): <br> <code>CoreDumpDirectory /tmp <br></code> <br><img src="https://habrastorage.org/storage2/484/cbb/9d5/484cbb9d517a2c1518338ce3c0f4fb29.jpg"><br>  Now restart the Apache: <br> <code>service httpd restart <br></code> <br><br>  We are testing.  Manually kill the process: <br>  ps aux |  grep httpd <br>  ... <br>  kill -11 12345 <br><br>  We look in "/ var / log / httpd / error_log": <br> <code>[Mon Oct 01 16:12:08 2012] [notice] child pid 22596 exit signal Segmentation fault (11), possible coredump in /tmp <br></code> <br><br>  In "/ tmp" we will now find a file with a name like "/tmp/httpd-core.22596" <br><br>  You have learned how to get a memory dump of the killed process.  Now we are waiting for the process to be killed in a natural way. <br><br><h4>  At the crime scene - interpret coredump </h4><br>  It is important to know that if PHP is compiled without debugging symbols (the --enable-debug key, -g for gcc at compilation) - we will lose a lot of useful information.  However, if you compiled PHP from source, even without this option, and the source is nearby - this may be enough for analysis. <br>  There is also a very common misconception that the debug build affects performance and memory footprint used by the process.  It does not affect, but only increases the size of the executable file.  Therefore, if you can not understand the cause of the error without the debug build, ask the sysadmin to assemble the PHP module with debugging symbols. <br><img src="https://habrastorage.org/storage2/a08/9fb/28d/a089fb28df880bcc38990700cbc9a30c.jpg"><br>  How to open coredump?  Of course, the old and ‚Äúvery kind‚Äù utility is <a href="http://ru.wikipedia.org/wiki/GNU_Debugger">gdb</a> , originally written by the supreme apostle of the <s>free</s> free software movement <a href="http://en.wikipedia.org/wiki/Richard_Stallman">Richard Stallman</a> . <br>  Understanding how the debugger works will not take long.  It is possible for a couple of hours to absorb <a href="http://www.dirac.org/linux/gdb/">one of the most entertaining textbooks</a> , or you can ask a sysadmin to do it ;-) <br><br>  Usually open coredump like this: <br>  gdb path_to_executable_file_webserver path_to_coredump <br><br>  All self-respecting C developers in unix of course know how to use this debugger, they probably do it every day, but, unfortunately, they may not be in your team.  And there is another unpleasant BUT ... <br><br><h4>  PHP debugging in gdb - black magic </h4><br>  The fact is that the PHP script compiled into bytecode is ... not exactly a C program ;-) It is necessary, though quite a bit, <br>  understand the insides of the Zend engine - and you <a href="https://bugs.php.net/bugs-generating-backtrace.php">will understand everything pretty quickly</a> .  Namely, you need to find the last call to the execute function in the trace, go to this stack frame and examine the local variables (op_array), as well as look into the global variables of the Zend engine: <br><pre> <code class="hljs lua">(gdb) frame <span class="hljs-number"><span class="hljs-number">3</span></span> #<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">0x080f1cc4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">execute</span></span> (op_array=<span class="hljs-number"><span class="hljs-number">0x816c670</span></span>) at ./zend_execute.c:<span class="hljs-number"><span class="hljs-number">1605</span></span> (gdb) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *)(executor_globals.function_state_ptr-&gt;<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">)</span></span>-&gt;common.function_name $<span class="hljs-number"><span class="hljs-number">14</span></span> = <span class="hljs-number"><span class="hljs-number">0x80fa6fa</span></span> <span class="hljs-string"><span class="hljs-string">"pg_result_error"</span></span> (gdb) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *)executor_globals.active_op_array-&gt;function_name $<span class="hljs-number"><span class="hljs-number">15</span></span> = <span class="hljs-number"><span class="hljs-number">0x816cfc4</span></span> <span class="hljs-string"><span class="hljs-string">"result_error"</span></span> (gdb) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *)executor_globals.active_op_array-&gt;filename $<span class="hljs-number"><span class="hljs-number">16</span></span> = <span class="hljs-number"><span class="hljs-number">0x816afbc</span></span> <span class="hljs-string"><span class="hljs-string">"/home/yohgaki/php/DEV/segfault.php"</span></span></code> </pre><br><img src="https://habrastorage.org/storage2/078/e95/403/078e95403d86302e65a5fca59f83cbe3.jpg"><br>  You can get confused in op_array, so the command to view the type of this structure is useful: <br><pre> <code class="hljs objectivec">(gdb) ptype op_array type = <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> _zend_op_array { zend_uchar type; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *function_name; zend_class_entry *scope; zend_uint fn_flags; <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> _zend_function *prototype; zend_uint num_args; zend_uint required_num_args; zend_arg_info *arg_info; zend_bool pass_rest_by_reference; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> return_reference; zend_uint *refcount; zend_op *opcodes; zend_uint last; zend_uint size; zend_compiled_variable *vars; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> last_var; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size_var; zend_uint T; zend_brk_cont_element *brk_cont_array; zend_uint last_brk_cont; zend_uint current_brk_cont; zend_try_catch_element *try_catch_array; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> last_try_catch; HashTable *static_variables; zend_op *start_op; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> backpatch_count; zend_bool done_pass_two; zend_bool uses_this; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *filename; zend_uint line_start; zend_uint line_end; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *doc_comment; zend_uint doc_comment_len; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *reserved[<span class="hljs-number"><span class="hljs-number">4</span></span>]; } *</code> </pre><br><br>  The debugging process consists of walking between stack frames (‚Äúframe N‚Äù), switching to each call of the execute function and examining its local arguments (‚Äúprint name‚Äù, ‚Äúptype name‚Äù).  The smaller the frame number, the deeper you are.  Sometimes it is useful to visit PHP extension and see where the error occurred and why (at least try to understand the reason). <br><br><pre> <code class="hljs mel">(gdb) frame ## (gdb) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> op_array.function_name $1 = <span class="hljs-number"><span class="hljs-number">0x2aaab7ca0c10</span></span> <span class="hljs-string"><span class="hljs-string">"myFunction"</span></span> (gdb) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> op_array.filename $2 = <span class="hljs-number"><span class="hljs-number">0x2aaab7ca0c20</span></span> <span class="hljs-string"><span class="hljs-string">"/var/www/file.php"</span></span></code> </pre><br><br>  And so on‚Ä¶ <br><br>  If you choked coffee :-), then just remember that going through the frames of the call stack using the "frame # N #" command, you can see only certain elements of this structure - and you can determine <b>which PHP file the PHP function was called, what function did it call</b> , etc.  - and get to the cause of "Segmentation Fault" or another error that killed the process.  And explain to programmers what the reason is and correct it!  Quickly and, you have to be optimistic - forever. <br><br><h4>  Common causes of errors </h4><br>  Start browsing coredump files (or assign it to a sysadmin) and you will quickly learn how to classify errors into groups: <br>  1) Problems in PHP extensions.  In this case, either disable the extension, or try playing its settings.  You know for sure that the problem is in it, the matter is small. <br>  2) The problem with recursion, stack.  You may step on an error in which a library function, for example, pcre, enters recursion and calls itself twenty thousand times.  You can either tweak the library settings or, if lazy, add a larger stack process ("/etc/init.d/httpd"): <br><br>  ulimit -s "set the value to more" <br><br>  And the current value can be viewed with the command: ‚Äúulimit -a‚Äù (man ulimit, then look for ‚Äúulimit‚Äù). <br>  3) Problems in the PHP core - here you need to write to PHP developers :-) <br><br>  In general, the range of causes of the error will be seriously reduced.  What we need. <br><img src="https://habrastorage.org/storage2/44c/61a/a25/44c61aa250900b46363c4e4a15352929.jpg"><br><h4>  Debugging a running process </h4><br>  That's not all.  If you can not get coredump - you can connect to the running process and walk on it.  While you are inside the process, its execution is suspended (‚Äúps aux | grep apache | grep 'T'‚Äù - it will be in the state of tracing).  When you leave it, it will continue to run again.  You can connect as follows: <br>  gdb -p process_id <br><br><h4>  Results </h4><br>  In the article, we learned how to ‚Äúcorrectly prepare‚Äù server software errors, do apache-PHP debug builds, create coredump files and interpret them correctly using a symbolic debugger.  We also learned that from a coredump file you can find a specific PHP file and the function that caused the error. <br><br>  Now you can create a checklist for the manager to deal with mysterious server errors that neither the web developers nor the sysadmins can figure out: <br><br><ol><li>  Enable collecting coredump files on the server (sysadmin) </li><li>  If necessary, rebuild apache-php with debugging symbols (sysadmin) </li><li>  Using gdb (the weekend to study it), investigate the cause of the error (a system administrator with a web developer) </li><li>  Take measures to eliminate it or reduce the frequency of appearance: change settings, update software, write to bugtracker, disable PHP extension, etc. </li></ol><br><br>  In conclusion, I invite everyone to our cloud service <a href="http://www.bitrix24.ru/">Bitrix24</a> , in which we effectively use all the technologies described in the article. <br><br>  Good luck and stable work of web projects! </div><p>Source: <a href="https://habr.com/ru/post/153001/">https://habr.com/ru/post/153001/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../152983/index.html">AirOn Element - chasofon in the steel case</a></li>
<li><a href="../152989/index.html">The Evolution of Digital Advertising</a></li>
<li><a href="../152993/index.html">Paul Graham. In pursuit of growth. Part 2</a></li>
<li><a href="../152995/index.html">What do you need to do in your youth or how to become a rich IT person</a></li>
<li><a href="../152997/index.html">Updated jQuery documentation</a></li>
<li><a href="../153003/index.html">HoloEverywhere</a></li>
<li><a href="../153005/index.html">Evernote data protection: how we get rid of broken disks</a></li>
<li><a href="../153007/index.html">‚ÄúRunet today‚Äù, October 1, 2012. Experts of the issue: Sergey Mitrofanov, Dmitry Torshin</a></li>
<li><a href="../153009/index.html">Writing the first simple telit firmware</a></li>
<li><a href="../153011/index.html">Russian Design Cup: results, reviews, impressions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>