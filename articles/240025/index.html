<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ruby on rails: production and deploy for dummies</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A year ago, I brought my first rail application to an acceptable form. The issue of using ready-made code in production did not interest me earlier. W...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ruby on rails: production and deploy for dummies</h1><div class="post__text post__text-html js-mediator-article">  A year ago, I brought my first rail application to an acceptable form.  The issue of using ready-made code in production did not interest me earlier.  Why should I?  An uncomplicated language, a concise framework - it is clearly something not more complicated than overcoming the mental brake after PHP. <br><br>  The Rails development team recommends using <a href="https://www.phusionpassenger.com/">Phusion Passenger</a> , it is something like mod_php - installed, posted files and flew.  At the time of studying the issue on the forums there were enough battles about the performance of solutions;  Passenger in them was not listed as a favorite. <br><br>  For advice on alternatives, I asked the technical director of the site with a million unik per day ‚Äî he sent me to google on the topic of Nginx and Unicorn.  Instructions for setting up the production, found in Habr√©, dated 2009 year.  Among other things, it simply overwhelmed the flaws of the lessons ‚ÄúHow to draw an owl‚Äù. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Some parts of the process are chewed in English here and there, but the monolithic tutorial was never caught.  In the traditions of the rail community lies the principle that the results and problem-solving experience should be shared. <br><a name="habracut"></a><br>  The text will hardly seem interesting to the experienced railkeepers, but if they find time for comments, I will be grateful and will make the necessary corrections. <br><br>  <b>- What will be discussed?</b> <br>  - This instruction will help beginners to choose and configure hosting, as well as prepare an existing project for the initial deployment and systematic rolling out updates. <br><br>  <b>- And more?</b> <br>  - We will use Ubuntu 14.04, RVM, Nginx, Unicorn and Capistrano.  The text consists of two chapters: project preparation and server settings.  All local manipulations are described in Mac OS X. For the execution of procedures, a modern IDE like <a href="http://www.jetbrains.com/ruby/">RubyMine</a> will not be superfluous; if not, <a href="http://macromates.com/download">TextMate will do</a> .  All described actions are fixed in a <a href="https://github.com/eboyko/deneb">special repository</a> . <br><br><h2>  Chapter One Hosting </h2><br><h3>  Hosting selection </h3><br>  Sweet couple Nginx and Unicorn has a very impressive appetite for RAM, and the rails themselves require the installation of a number of additional software.  These restrictions clearly indicate the need for a VPS.  There is an option to use specialized hosting like <a href="https://www.heroku.com/">Heroku</a> , but for beginners it will be useful to do the setup process by hand. <br><br>  In the context of this text, I will use the newly created <a href="https://www.digitalocean.com/">Digital Ocean</a> droplet based on Ubuntu 14.04.  (Promotional codes for a month ‚Äî two free uses on the Internet are enough, who needs a referral with ten dollars in the account ‚Äî I will give a link.) <br><br><h4>  Updating system packages </h4><br>  We go into the system under the root and update the packages: <br><br><pre><code class="bash hljs">sudo apt-get update sudo apt-get upgrade</code> </pre> <br><h4>  Installing Git and NodeJS </h4><br><pre> <code class="bash hljs">sudo apt-get install git-core nodejs</code> </pre><br><h3>  Create user </h3><br>  I assume that you (like me) have a commercial interest in deployment.  Let's create a separate user (in other words, the client), in the home directory of which we will deploy the application.  In addition to the obvious, this approach provides advantages in the form of a separate RVM (ruby version manager), which allows the use of different versions of the interpreter and gems for different clients and applications.  We will create a <code>demo</code> user and add it to the <code>sudo</code> group. <br><br><pre> <code class="bash hljs">sudo adduser demo sudo adduser demo sudo</code> </pre><br>  We close the session, log in as a <code>demo</code> user. <br><br><h3>  Cancel password request for sudo </h3><br>  Some deployment procedures will require superuser privileges.  To ensure that commands are executed using Capistrano and do not cause errors, you must disable the password request.  Edit the <code>sudoers</code> : sudo nano / etc / sudoers file. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   : %sudo ALL=(ALL:ALL) ALL #     : %sudo ALL=(ALL) NOPASSWD:ALL</span></span></code> </pre><br>  The official Capistrano documentation <a href="http://capistranorb.com/documentation/getting-started/authentication-and-authorisation/">explains</a> that the native deployment phases do not require sudo;  however, if it comes to automating all processes, you cannot do without passwordless sudo. <br><br><h3>  SSH key generation </h3><br>  You will need two pairs of keys.  With the help of one of them, you (and Capistrano) will be authorized on the server from the local computer.  The second pair will give the server access to the repository (the so-called deployment key).  In both cases, leave the code phrases empty. <br><br><h4>  First pair (must be generated <em>locally</em> ): </h4><br><pre> <code class="bash hljs">ssh-keygen -t rsa -b 2048</code> </pre><br>  If you are familiar with the procedure for generating and using keys, then choose the path to the file and durability to your liking;  otherwise, keep the default. <br><br>  Now you need to copy the contents of the public key (by default <code>~/.ssh/id_rsa.pub</code> on the local computer) and add it to the <code>~/.ssh/authorized_keys</code> file on the server.  After this simple manipulation with SSH, you can connect to the server without a password.  If not, check the server permissions: 700 for <code>~/.ssh</code> and 600 for <code>~/.ssh/*</code> . <br><br><h4>  The second pair (on the server): </h4><br><pre> <code class="bash hljs">ssh-keygen -t rsa -b 2048</code> </pre><br>  Similarly, the contents from the server <code>~/.ssh/id_rsa.pub</code> need to be added to the list of deployment keys (in Github, you can find them in the settings of each repository). <br><br><h3>  Installing fresh nginx </h3><br>  The Nginx version available in Ubuntu is often older than in the official developer repository.  I try to use the latest version, but if you have other views, install Nginx on your own and skip this part. <br><br>  We will add the official Ubuntu repositories to the sudo nano system list /etc/apt/sources.list.  Add lines to the end of the file: <br><br><pre> <code class="cmake hljs"><span class="hljs-comment"><span class="hljs-comment"># Nginx official repository deb http://nginx.org/packages/ubuntu/ trusty nginx deb-src http://nginx.org/packages/ubuntu/ trusty nginx</span></span></code> </pre><br>  Remember that the settings used are relevant only for Ubuntu 14.04.  For information on installing on other versions of the OS look <a href="http://nginx.org/en/linux_packages.html">on the developer's site</a> .  To install Nginx from these repositories, you will also need to download and add the key to the system: <br><br><pre> <code class="bash hljs">wget http://nginx.org/keys/nginx_signing.key sudo apt-key add nginx_signing.key</code> </pre><br>  Now you can update the list of available packages and install Nginx: <br><br><pre> <code class="bash hljs">sudo apt-get update sudo apt-get install nginx</code> </pre><br>  Remove default configs from <code>/etc/nginx/conf.d</code> .  (Of course, do not try to do it if you are not working on a ‚Äúclean‚Äù server.) We will create a virtual host for the application in the next chapter. <br><br><pre> <code class="bash hljs">sudo rm /etc/nginx/conf.d/* sudo service nginx restart</code> </pre><br><h3>  <abbr title="Ruby version manager">RVM</abbr> installation </h3><br><pre> <code class="bash hljs">\curl -sSL https://get.rvm.io | bash -s stable <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> ~/.rvm/scripts/rvm</code> </pre><br>  In the case of a clean server, you will also need to install some dependencies: <br><br><pre> <code class="bash hljs">rvm requirements</code> </pre><br>  It remains to install directly the Ruby version you need for your application.  For example, the new stable version 2.1.3: <br><br><pre> <code class="bash hljs">rvm install 2.1.3 rvm --default use 2.1.3</code> </pre><br>  You can check the installation correctness using the commands ruby ‚Äã‚Äã-v and rvm info <br><br><h3>  Installing Application Components </h3><br>  Surely, your application will use a number of components (not including gems), like a database or Imagemagick GPU, you will have to complete the installation yourself.  Here you should add a small remake (if you forget about that - the automatic deployment will end with an error): the rails sometimes require additional packages to work with some components.  For example, to use MySQL, you will need to install, among other things, the <code>libmysqlclient-dev</code> package. <br><br><h2>  Chapter Two Preparing the Application </h2><br><h3>  Using git </h3><br>  I assume that you already have a ready application.  The first rule - the project must be under the control of Git.  This is the de facto standard in the rail world (even the .gitignore file in the root of the rail applications that are being created is clearly hinting at this).  Moreover, the latest versions of the Capistrano gem, which will be directly responsible for deployment, natively support only this system. <br><br><h3>  What is Capistrano </h3><br>  The official definition of Capistrano is: ‚ÄúA remote server automation and deployment tool‚Äù.  From the user's point of view, Capistrano is the thing that will allow you to execute an arbitrary set of commands on a remote server via SSH.  There are other deployment tools (for example, Mina), but so far Capistrano is also a standard, especially since it allows you to run parallel deployment of applications directly to a number of servers, including those separated by roles. <br><br><h3>  Capistrano working principle </h3><br>  On the server, the structure of the application under the control of Capistrano as a whole consists of three directories: <code>repo</code> , <code>releases</code> and <code>shared</code> .  The first is a copy of the repository, the second is the releases, the third is the common files needed by the application and not dependent on the release.  Also present at the root is the symlink <code>current</code> , which refers to the current release version and the Deployed log file. <br><br>  When you (from your local computer) give the Capistrano command to execute a deployment, an SSH connection to the server is established and the execution of a simple algorithm begins.  To begin, Capistrano checks the remote repository and gets the missing commits.  After a new release is created (in the <code>releases</code> directory).  The current version of the code is shifted there and a number of tests are also performed there. <br><br>  Simply put, for each new release, Capistrano executes familiar commands like <code>bundle install</code> , <code>rake db:migrate</code> , <code>rake assets:precompile</code> , constantly checking for conflicts and errors.  We missed the semicolon in <code>default.scss</code> , did not commit the current <code>Gemfile.lock</code> , connected Paperclip, but forgot to install on the Imagemagic server?  In all these cases, Capistrano will show an error and stop the installation without affecting the current running release.  If the deployment was successful, but the result did not suit you, with the help of Capistrano, you can <code>rollback</code> to the previous release. <br><br><h3>  Organization of configuration files </h3><br>  Each release for Capistrano is a separate entity.  At the next deployment, it is completely replaced, so a number of files must be stored outside the application structure (as a rule, content downloaded by users and application-generated content, as well as a number of configs). <br><br>  We will need a common directory, the necessary files from which we will link to each new release during the deployment;  Let's call it shared and create it locally at the root of the mkdir project ./shared, after adding an exception to .gitignore.  (I, of course, will not add an exception to the educational repository.) <br><br>  Now in the general directory we will create in advance the future structure.  First we need the <code>config</code> and <code>run</code> folders.  In the <code>config</code> put up the <code>secrets.yml</code> <code>database.yml</code> and <code>secrets.yml</code> .  (Personally, I prefer to move these two files from the config on the local computer, and then create links to them.) <br><br><pre> <code class="bash hljs">mv ./config/database.yml ./shared/config ln -fs ./shared/config/database.yml ./config/database.yml mv ./config/secrets.yml ./shared/config ln -fs ./shared/config/secrets.yml ./config/secrets.yml</code> </pre><br><h3>  Nginx configuration </h3><br>  Here - in <code>shared/config</code> , - we will create a config for Nginx <code>shared/config/nginx.conf</code> .  In its basic form, it consists of two small parts: an upstream and a typical virtual host.  <b>Be especially careful</b> with the paths (in this and all further) in configuration files.  90% of the errors that occurred during the delay were related to them. <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> unicorn { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> unix:/home/demo/application/shared/run/unicorn.sock fail_timeout=<span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> default; <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /home/demo/application/current/public; <span class="hljs-attribute"><span class="hljs-attribute">try_files</span></span> <span class="hljs-variable"><span class="hljs-variable">$uri</span></span>/index.html <span class="hljs-variable"><span class="hljs-variable">$uri</span></span>.html <span class="hljs-variable"><span class="hljs-variable">$uri</span></span> <span class="hljs-variable"><span class="hljs-variable">@app</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span><span class="hljs-regexp"><span class="hljs-regexp"> ^~</span></span> /assets/ { <span class="hljs-attribute"><span class="hljs-attribute">expires</span></span> max; <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> Cache-Control public; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-variable"><span class="hljs-variable">@app</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://unicorn; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-For <span class="hljs-variable"><span class="hljs-variable">$proxy_add_x_forwarded_for</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$http_host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_redirect</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">error_page</span></span> <span class="hljs-number"><span class="hljs-number">500</span></span> <span class="hljs-number"><span class="hljs-number">502</span></span> <span class="hljs-number"><span class="hljs-number">503</span></span> <span class="hljs-number"><span class="hljs-number">504</span></span> /<span class="hljs-number"><span class="hljs-number">500</span></span>.html; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> = /<span class="hljs-number"><span class="hljs-number">500</span></span>.html { <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /home/demo/application/current/public; } }</code> </pre><br>  We use our VPS for a single application, so the host will be used by default.  (No need to explain that in a different situation you will have to explicitly specify server_name and take care of the uniqueness of the names of the upstream?) <br><br><h3>  Unicorn configuration </h3><br>  Since we have created an upstream, which indicated the path to the Unicorn socket, let's move on to its configuration.  You must add the Unicorn gem to the <code>Gemfile</code> .  <strong>Do not forget</strong> that the addition of new gems must be accompanied by the implementation of bundle install and the commit to the repository.  If we forget about git push, then the old version of the code will be uploaded to the server, which, due to the absence of the specified gems, will cause errors during the delay. <br><br><pre> <code class="ruby hljs">group <span class="hljs-symbol"><span class="hljs-symbol">:production</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> gem <span class="hljs-string"><span class="hljs-string">'unicorn'</span></span>, <span class="hljs-string"><span class="hljs-string">'~&gt; 4.8.3'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  In the <code>shared/config</code> directory, create a file <code>unicorn.rb</code> .  For the most part in it, we must point the way to the component parts of our application.  For convenience, this can be done using variables. <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#      root = '/home/demo/application' rails_root = "#{root}/current" # ,    Unicorn- pidfile = "#{root}/shared/run/unicorn.pid" pidfile_old = pidfile + '.oldbin' pid pidfile #   worker_processes 1 preload_app true timeout 30 #    listen "#{root}/shared/run/unicorn.sock", :backlog =&gt; 1024 #   - stderr_path "#{rails_root}/log/unicorn_error.log" stdout_path "#{rails_root}/log/unicorn.log" #    GC.copy_on_write_friendly = true if GC.respond_to?(:copy_on_write_friendly=) #  ,     before_exec do |server| ENV["BUNDLE_GEMFILE"] = "#{rails_root}/Gemfile" end #          before_fork do |server, worker| defined?(ActiveRecord::Base) and ActiveRecord::Base.connection.disconnect! if File.exists?(pidfile_old) &amp;&amp; server.pid != pidfile_old begin Process.kill("QUIT", File.read(pidfile_old).to_i) rescue Errno::ENOENT, Errno::ESRCH end end end after_fork do |server, worker| defined?(ActiveRecord::Base) and ActiveRecord::Base.establish_connection end</span></span></code> </pre><br>  Some system values ‚Äã‚Äãare also indicated ( <a href="http://unicorn.bogomips.org/Unicorn/Configurator.html">full list and documentation</a> ).  You should pay attention to the number of workers - <code>worker_processes</code> , - each of which uses a certain amount of memory (how much it depends on the application) and <code>timeout</code> (usually from 15 to 30 seconds).  Many people also mention <code>preload_app</code> (the value of which <code>false</code> can shorten the start time of the worker);  let's look at <code>true</code> , and then you decide for yourself. <br><br><h3>  Connect and configure Capistrano </h3><br><h4>  Necessary gems </h4><br>  In the <code>Gemfile</code> you need to add Capistrano and a series of gems that implement its connection to RVM, Bundler and Rails. <br><br><pre> <code class="ruby hljs">group <span class="hljs-symbol"><span class="hljs-symbol">:development</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> gem <span class="hljs-string"><span class="hljs-string">'capistrano'</span></span>, <span class="hljs-string"><span class="hljs-string">'~&gt; 3.2.1'</span></span> gem <span class="hljs-string"><span class="hljs-string">'capistrano-rvm'</span></span>, <span class="hljs-string"><span class="hljs-string">'~&gt; 0.1.1'</span></span> gem <span class="hljs-string"><span class="hljs-string">'capistrano-bundler'</span></span>, <span class="hljs-string"><span class="hljs-string">'~&gt; 1.1.3'</span></span> gem <span class="hljs-string"><span class="hljs-string">'capistrano-rails'</span></span>, <span class="hljs-string"><span class="hljs-string">'~&gt; 1.1.2'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  It remains to complete bundle install, and then initialize Capistrano with cap install.  A set of files will be created, a list of which you will see in the console.  We will work with three of them: <code>Capfile</code> , <code>config/deploy.rb</code> and <code>config/deploy/production.rb</code> .  (In <code>config/deploy</code> Capistrano creates default <code>staging.rb</code> and <code>production.rb</code> files. We will only configure the combat server using <code>production.rb</code> .) <br><br><h4>  <code>Capfile</code> update </h4><br>  All gems related to Capistrano, the functionality of which we are going to use, must be connected to the <code>Capfile</code> created in the root.  Take a look at the default file and uncomment the necessary lines or use the following content: <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'capistrano/setup'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'capistrano/deploy'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'capistrano/rvm'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'capistrano/bundler'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'capistrano/rails'</span></span> Dir.glob(<span class="hljs-string"><span class="hljs-string">'lib/capistrano/tasks/*.rb'</span></span>).each { <span class="hljs-params"><span class="hljs-params">|r|</span></span> import r }</code> </pre><br><h4>  Setting up a production server </h4><br>  Open the file <code>config/deploy/production.rb</code> and carefully look at its contents.  It will help you understand the format and customization options.  In general, if you use authentication with an SSH key, you will not have to write any exotics;  just one line: <br><br><pre> <code class="ruby hljs">server <span class="hljs-string"><span class="hljs-string">'178.62.252.46'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">user:</span></span> <span class="hljs-string"><span class="hljs-string">'demo'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">roles:</span></span> <span class="hljs-string"><span class="hljs-string">%w{web app}</span></span></code> </pre><br><h3>  Deploy scenario </h3><br>  We got to the most interesting part of the file <code>config/deploy.rb</code> .  It is he who describes the parameters, procedures and scenario of the upcoming deployment.  I will describe each block of the file, but if you want to look at it in its final form, use the repository. <br><br><h4>  Required parameters </h4><br>  First of all, you need to specify the version of Capistrano for which this script is intended: <br><br><pre> <code class="ruby hljs">lock <span class="hljs-string"><span class="hljs-string">'3.2.1'</span></span></code> </pre><br>  Capistrano requires a number of required parameters: <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#  set :repo_url, 'git</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@github</span></span></span><span class="hljs-comment">.com:eboyko/deneb.git' #   set :rails_env, 'production'</span></span></code> </pre><br>  As well as the <code>deploy_to</code> parameter, which determines the path for deploying the application on the server.  Above, we have already said that we mean commercial interest, so we will make the script file more universal using variables and set the missing parameter: <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#   set :username, 'demo' #   set :application, 'application' #    set :deploy_to, "/home/#{fetch(:username)}/#{fetch(:application)}"</span></span></code> </pre><br>  Let's also set the <code>log_level</code> parameter (default value <code>:debug</code> makes Capistrano too talkative): <br><br><pre> <code class="ruby hljs">set <span class="hljs-symbol"><span class="hljs-symbol">:log_level</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:info</span></span></code> </pre><br>  <strong>Notice</strong> that Capistrano global variables (like <code>shared_path</code> ) can be used directly;  set with <code>set</code> - via <code>fetch</code> method. <br><br><h5>  Release-independent data </h5><br>  We have already considered the need for a working release to access data created by previous versions.  For example, you store files uploaded by users in <code>public/upload</code> .  To connect them to each new release, in <code>config/deploy.rb</code> you can set the parameter <code>:linked_dirs</code> : <br><br><pre> <code class="ruby hljs">set <span class="hljs-symbol"><span class="hljs-symbol">:linked_dirs</span></span>, <span class="hljs-string"><span class="hljs-string">%w{public/upload}</span></span></code> </pre><br>  At every <code>public/upload</code> link will be replaced by a symlink leading to the <code>shared/public/upload</code> directory, where data accumulated during previous releases.  Similarly, with <code>:linked_files</code> , separate files are linked: <br><br><pre> <code class="ruby hljs">set <span class="hljs-symbol"><span class="hljs-symbol">:linked_files</span></span>, <span class="hljs-string"><span class="hljs-string">%w{config/secrets.yml config/database.yml}</span></span></code> </pre><br>  <strong>Note</strong> that adding to the <code>:linked_files</code> specified files ( <code>config/secrets.yml</code> and <code>config/database.yml</code> ) is mandatory.  Otherwise, the deployment will fail with an error due to the lack of connection to the database. <br><br><h4>  Procedures </h4><br>  Capistrano allows you to create sets of procedures that can be combined into namespaces for convenience.  Namespace <code>:deploy</code> already exists, it can only be supplemented;  all the procedures included in it for the <code>production</code> server can be called with the cap production deploy command <br><br><h5>  Set-up </h5><br>  As a result of the previous steps, we have formed the <code>shared</code> directory, in which, among other things, the configuration files ( <code>shared/config</code> ) are located.  The logical first step is to upload them to the server.  To do this, all in the same <code>config/deploy.rb</code> , in the namespace <code>:setup</code> , we will write the procedure: <br><br><pre> <code class="ruby hljs">namespace <span class="hljs-symbol"><span class="hljs-symbol">:setup</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> desc <span class="hljs-string"><span class="hljs-string">'     '</span></span> task <span class="hljs-symbol"><span class="hljs-symbol">:upload_config</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> on roles <span class="hljs-symbol"><span class="hljs-symbol">:all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> execute <span class="hljs-symbol"><span class="hljs-symbol">:mkdir</span></span>, <span class="hljs-string"><span class="hljs-string">"-p </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">"</span></span> [<span class="hljs-string"><span class="hljs-string">'shared/config'</span></span>, <span class="hljs-string"><span class="hljs-string">'shared/run'</span></span>].each <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|f|</span></span> upload!(f, shared_path, <span class="hljs-symbol"><span class="hljs-symbol">recursive:</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  As you understand, the procedure involves creating <code>shared_path</code> (because there is no structure on the server yet) and loading the local <code>shared/config</code> directory there.  You can execute it with the cap production setup: upload_config command <br><br><h5>  Nginx Management </h5><br>  I noted above that Capistrano is essentially a way to execute arbitrary commands on a remote server.  We downloaded configuration files, including for Nginx.  Now we will write several procedures for management: creating a symlink to the config and reload / restart of the service (they will need <code>sudo</code> rights). <br><br><pre> <code class="ruby hljs">namespace <span class="hljs-symbol"><span class="hljs-symbol">:nginx</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> desc <span class="hljs-string"><span class="hljs-string">'   /etc/nginx/conf.d  nginx.conf '</span></span> task <span class="hljs-symbol"><span class="hljs-symbol">:append_config</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> on roles <span class="hljs-symbol"><span class="hljs-symbol">:all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> sudo <span class="hljs-symbol"><span class="hljs-symbol">:ln</span></span>, <span class="hljs-string"><span class="hljs-string">"-fs </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/config/nginx.conf /etc/nginx/conf.d/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{fetch(</span></span><span class="hljs-symbol"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-symbol">:application</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">.conf"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> desc <span class="hljs-string"><span class="hljs-string">' nginx'</span></span> task <span class="hljs-symbol"><span class="hljs-symbol">:reload</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> on roles <span class="hljs-symbol"><span class="hljs-symbol">:all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> sudo <span class="hljs-symbol"><span class="hljs-symbol">:service</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:nginx</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:reload</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> desc <span class="hljs-string"><span class="hljs-string">' nginx'</span></span> task <span class="hljs-symbol"><span class="hljs-symbol">:restart</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> on roles <span class="hljs-symbol"><span class="hljs-symbol">:all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> sudo <span class="hljs-symbol"><span class="hljs-symbol">:service</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:nginx</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:restart</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> after <span class="hljs-symbol"><span class="hljs-symbol">:append_config</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:restart</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Noticed a nice little thing?  - You can set the sequence of execution of various procedures both within one namespace, and between them. <br><br><h5>  Office Unicorn </h5><br>  Surely there is already a heme that extends Capistrano in the Unicorn control plane, but I was very interested to find out how it actually works and works.  Therefore, now, similarly to the previous examples, we will write two procedures (start and end) for Unicorn. <br><br><pre> <code class="ruby hljs">set <span class="hljs-symbol"><span class="hljs-symbol">:unicorn_config</span></span>, <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/config/unicorn.rb"</span></span> set <span class="hljs-symbol"><span class="hljs-symbol">:unicorn_pid</span></span>, <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{shared_path}</span></span></span><span class="hljs-string">/run/unicorn.pid"</span></span> namespace <span class="hljs-symbol"><span class="hljs-symbol">:application</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> desc <span class="hljs-string"><span class="hljs-string">' Unicorn'</span></span> task <span class="hljs-symbol"><span class="hljs-symbol">:start</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> on roles(<span class="hljs-symbol"><span class="hljs-symbol">:app</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> execute <span class="hljs-string"><span class="hljs-string">"cd </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{release_path}</span></span></span><span class="hljs-string"> &amp;&amp; ~/.rvm/bin/rvm default do bundle exec unicorn_rails -c </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{fetch(</span></span><span class="hljs-symbol"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-symbol">:unicorn_config</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string"> -E </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{fetch(</span></span><span class="hljs-symbol"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-symbol">:rails_env</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string"> -D"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> desc <span class="hljs-string"><span class="hljs-string">' Unicorn'</span></span> task <span class="hljs-symbol"><span class="hljs-symbol">:stop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> on roles(<span class="hljs-symbol"><span class="hljs-symbol">:app</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> execute <span class="hljs-string"><span class="hljs-string">"if [ -f </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{fetch(</span></span><span class="hljs-symbol"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-symbol">:unicorn_pid</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string"> ] &amp;&amp; [ -e /proc/$(cat </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{fetch(</span></span><span class="hljs-symbol"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-symbol">:unicorn_pid</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">) ]; then kill -9 `cat </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">#{fetch(</span></span><span class="hljs-symbol"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-symbol">:unicorn_pid</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">`; fi"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Do not forget to set the values ‚Äã‚Äãof the parameters <code>:unicorn_config</code> and <code>:unicorn_pid</code> . <br><br><h5>  Procedures before and after deployment </h5><br>  After deploying, we need to delete the oldest releases (by default, Capistrano stores the last five), clear the caches and restart Unicorn.  The main working block <code>:deploy</code> will look something like this: <br><br><pre> <code class="ruby hljs">namespace <span class="hljs-symbol"><span class="hljs-symbol">:deploy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> after <span class="hljs-symbol"><span class="hljs-symbol">:finishing</span></span>, <span class="hljs-string"><span class="hljs-string">'application:stop'</span></span> after <span class="hljs-symbol"><span class="hljs-symbol">:finishing</span></span>, <span class="hljs-string"><span class="hljs-string">'application:start'</span></span> after <span class="hljs-symbol"><span class="hljs-symbol">:finishing</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:cleanup</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><h4>  Putting procedures in separate files </h4><br>  In order not to clutter up the file <code>deploy.rb</code> , written procedures can (and maybe need) be moved beyond its limits.  In <code>Capfile</code> last line is responsible for importing such tasks from the <code>lib/capistrano/tasks</code> directory, this is the place to move this part of the logic. <br><br><h3>  Deploy execution </h3><br>  From now on, all you need to do to roll out a new version of your application is to commit the changes, do git push and use the cap production deploy command. <br><br>  By analogy, you can configure a <code>staging</code> server, deploy to which to perform cap staging deploy. <br><br>  Something does not work?  - Leave a comment, let's add an article. <br><br><h3>  Updates are expected: </h3><br>  - a brief overview of the available application servers (in the context of the choice of Unicorn); <br>  - process management (unicorn worker killer and some manager); <br>  - selection and configuration of an analogue of RVM; <br>  - installing Nginx using PPA; <br>  - changes regarding passwordless sudo; </div><p>Source: <a href="https://habr.com/ru/post/240025/">https://habr.com/ru/post/240025/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../240013/index.html">The house that built Klose or Leaf-Spine architecture: changing L2 to L3</a></li>
<li><a href="../240015/index.html">How to get rid of the step gradient after reinstalling Windows 8.1 on a laptop</a></li>
<li><a href="../240017/index.html">On the London hackathon "Mastercard" won the application for organizing parties with friends</a></li>
<li><a href="../240019/index.html">Git and Microsoft SQL Server</a></li>
<li><a href="../240021/index.html">Visualization algorithms for garbage collection</a></li>
<li><a href="../240029/index.html">Online training: features of the new version of BigBlueButton</a></li>
<li><a href="../240033/index.html">Web application development</a></li>
<li><a href="../240039/index.html">RAR Print - homemade 3D printer from CD roms</a></li>
<li><a href="../240041/index.html">9 reasons to switch to open source</a></li>
<li><a href="../240045/index.html">Tips and recipes for novice Android programmers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>