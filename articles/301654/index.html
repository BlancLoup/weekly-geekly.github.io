<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fast video encoding for Linux with Nvidia NVENC with SDK 7.5 and ffmpeg 3.0.2 on Nvidia GTX 960/970/980</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article was written based on the article Effective video encoding in Linux with Nvidia NVENC: part 1, general , however, has its own characterist...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fast video encoding for Linux with Nvidia NVENC with SDK 7.5 and ffmpeg 3.0.2 on Nvidia GTX 960/970/980</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/065/847/0f1/0658470f1a2b267895472031365f60cf.png" alt="image"><br><br>  This article was written based on the article <a href="https://habrahabr.ru/post/262507/">Effective video encoding in Linux with Nvidia NVENC: part 1, general</a> , however, has its own characteristics and, unlike the original article, at the time of which the patch was not written, I‚Äôm applied to the revised <a href="http://developer.download.nvidia.com/compute/redist/ffmpeg/1511-patch/FFMPEG-with-NVIDIA-Acceleration-on-Ubuntu_UG_v01.pdf">Patch Nvidia Acceleration</a> to FFmpeg 3.0.2, getting in addition to the nvenc encoder also a fast resize filter - nvresize. <br><br>  In total, I was able to hardware encode video in H.264 and HEVC using the <b>Nvidia GTX 960</b> video card on a fairly weak computer (Xeon L5420) with a speed (for H.264) exceeding the capacity of this processor up to 10 times (and 3 times relative to Core i7)!  And on my favorite Debian 8 Jessie. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, let's begin! <br><a name="habracut"></a><br><h4>  Technology </h4><br>  Nvidia NVENC is a technology that enables video encoding in H.264 and HEVC on GPU computing power.  Important note: at the time of this writing (May 2016), only qualitative cards of the second generation Maxwell can provide any high-quality and fast coding, and for desktop these are: GM206 (GTX 950, GTX 960), GM204 (GTX 970 and GTX 980) ( Information: there are more expensive professional Nvidia Tesla / Quadro / GRID professional lines, the full list can be found <a href="https://developer.nvidia.com/nvidia-video-codec-sdk">here</a> ).  Moreover, the NVENC module works at the same speed on all cards and the number of CUDA cores does not affect performance, however strange it may sound, so it makes sense to take older versions if the platform is used (besides coding) for games, even more so that the cards are on GM206 more appropriate because  In addition to the encoder, they also received a hardware HEVC decoder.  Important note: the entire GeForce line has a license limitation of 2 simultaneous streams.  You can try to get around it by the method specified <a href="https://habrahabr.ru/post/262563/">in the second part of the article</a> <a href="https://habrahabr.ru/users/yourchief/" class="user_link">YourChief</a> <br><br><h4>  Implementation (FFmpeg) </h4><br>  All the variety of implementations of Nvidia CUDA can be viewed <a href="https://developer.nvidia.com/gpu-accelerated-libraries">at the link</a> .  From myself I want to say that for video the most common is the popular tool - FFmpeg.  We will use it. <br><br><h4>  Hardware </h4><br>  Although it is banal, but I will list the minimum necessary set of hardware requirements (based on real experience): <br><ol><li>  Motherboard: with support for PCI-E.  I recommend the Intel platform because of the close connection of Intel-Nvidia and personal affection.  AMD fans forgive me! </li><li>  Processor: dual core, not lower than Core2 Duo.  I recommend the Core i3 and some cheap Xeon (yes!). </li><li>  Memory: DDR2 / 3/4, at least 2 GB.  An interesting fact, with two coding streams, the total memory consumption I have is ~ 0.7 GB. </li><li>  Video card: any Nvidia 900 Series video card (I recommend GM206: GTX 950, GTX 960 or GM204: GTX 970, GTX 980).  2 GB or 4 GB, gaming or not - it does not matter!  The main thing is to keep track of the dimensions and keep in mind that with all the GTX 960 models I have seen, additional power is connected from above. </li><li>  ATX PSU with additional power connector (6 pin for our task is enough).  I recommend a power of at least 400 watts. </li></ol><br><h4>  Software </h4><br>  The further narrative is based on a certain basis of systems, programs, and their specific versions.  I would especially note that I specifically used Debian, and not Ubuntu, for which there are even offs.  SDKs  I wanted to try to customize everything in my favorite distribution. <br><ol><li>  Operating system: <a href="http://debian.org/">Debian</a> 8 Jessie with an optional <a href="http://deb-multimedia.org/">Deb Multimedia</a> repository </li><li>  Nvidia <a href="https://developer.nvidia.com/cuda-downloads">CUDA</a> 7.5.18 </li><li>  Nvidia <a href="https://developer.nvidia.com/nvidia-video-codec-sdk">SDK</a> 6.0.1 </li><li>  <a href="http://ffmpeg.org/download.html">FFmpeg</a> 3.0.2 </li><li>  <a href="http://developer.download.nvidia.com/compute/redist/ffmpeg/1511-patch/FFMPEG-with-NVIDIA-Acceleration-on-Ubuntu_UG_v01.pdf">Patch Nvidia Acceleration</a> , changed by me for compatibility with FFmpeg 3.0.2 </li></ol><br><h4>  Assembly </h4><br>  The most important of the files is the first one, with the driver.  Only he is needed if you immediately want to install the package after it is built. <br><div class="spoiler">  <b class="spoiler_title">Download the files that we need for further work.</b>  <b class="spoiler_title">Size ~ 1.3 GB.</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src wget <span class="hljs-string"><span class="hljs-string">'http://developer.download.nvidia.com/compute/cuda/7.5/Prod/local_installers/cuda_7.5.18_linux.run'</span></span> wget --no-check-certificate <span class="hljs-string"><span class="hljs-string">'https://developer.nvidia.com/video-sdk-601'</span></span> -O <span class="hljs-string"><span class="hljs-string">'video-sdk-601.zip'</span></span> wget <span class="hljs-string"><span class="hljs-string">'http://developer.download.nvidia.com/compute/redist/ffmpeg/1511-patch/cudautils.zip'</span></span> wget <span class="hljs-string"><span class="hljs-string">'http://ffmpeg.org/releases/ffmpeg-3.0.2.tar.bz2'</span></span> wget <span class="hljs-string"><span class="hljs-string">'http://kuzko.com/dl/ffmpeg_NVIDIA_gpu_acceleration.3.0.2.patch'</span></span></code> </pre> <div class="spoiler">  <b class="spoiler_title">MD5 files</b> <div class="spoiler_text"><pre> <code class="bash hljs">4b3bcecf0dfc35928a0898793cf3e4c6 cuda_7.5.18_linux.run 24af45272ed2881f88ed534d3211b584 video-sdk-601.zip f3f890bd314a568c47191810453cad2c cudautils.zip 7db5efb1070872823143e1365fdfcd53 ffmpeg-3.0.2.tar.bz2 a4f59f92675e02a0fa5c6cd124eda64e ffmpeg_NVIDIA_gpu_acceleration.3.0.2.patch</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">SHA1 files</b> <div class="spoiler_text"><pre> <code class="bash hljs">0f366a88968b9eee01044de197e27764bc1567d6 cuda_7.5.18_linux.run e57c7b4cfb298d4c725a0bb4477928e228dabb1c video-sdk-601.zip edc818bef432d708466c5454974b9851523a86ba cudautils.zip c40731a221fbfaa50671d69fe894bedd664f91e2 ffmpeg-3.0.2.tar.bz2 f305832ed42beeff7d7c26a00f79668b63b322ec ffmpeg_NVIDIA_gpu_acceleration.3.0.2.patch</code> </pre> </div></div><br></div></div><br>  Add a Deb Multimedia repository (it is required if you want to get / use FFmpeg, which is as close as possible to the one that Deb Multimedia puts out).  This repository is required for my build! <br><div class="spoiler">  <b class="spoiler_title">For the lazy</b> <div class="spoiler_text">  Create a file with one line: <pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">'deb http://www.deb-multimedia.org jessie main non-free\ndeb http://www.deb-multimedia.org jessie-backports main'</span></span> &gt; /etc/apt/sources.list.d/deb-multimedia.list</code> </pre>  Next, perform <pre> <code class="bash hljs">apt-get update</code> </pre>  And set the keyring: <pre> <code class="bash hljs">apt-get install deb-multimedia-keyring</code> </pre> </div></div><br>  Now we update the system and install the packages required for driver assembly.  This step is also needed! <br><div class="spoiler">  <b class="spoiler_title">Necessary actions</b> <div class="spoiler_text"><pre> <code class="bash hljs">apt-get update apt-get -y dist-upgrade apt-get -y install build-essential checkinstall dkms ccache pkg-config libglu1-mesa-dev libx11-dev libxi-dev libxmu-dev libxcb-shm0</code> </pre></div></div><br>  Install Nvidia Driver, accept the agreement (accept), all other answers by default.  If you are warned that the system is not suitable, do not worry, this is normal!  You can pass the -silent key for quick installation, but better go for yourself. <br><div class="spoiler">  <b class="spoiler_title">Necessary actions</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src chmod +x cuda_7.5.18_linux.run ./cuda_7.5.18_linux.run</code> </pre> </div></div><br>  The choice of further action is up to you.  You can either trust me and download the finished deb file (created through checkinstall) and skip the next steps, or build manually by installing the necessary libraries and building the package yourself through checkinstall. <br><div class="spoiler">  <b class="spoiler_title">I am a Jedi, why should I be afraid?</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src wget <span class="hljs-string"><span class="hljs-string">'http://kuzko.com/dl/ffmpeg_3.0.2-nvenc-7.5.18-nvresize-cudautils-20160523-1_amd64.deb'</span></span> dpkg -i ffmpeg_3.0.2-nvenc-7.5.18-nvresize-cudautils-20160523-1_amd64.deb apt-get -f install</code> </pre> </div></div><br>  If you chose the bright side of the force, then let's continue, install the libraries required for the assembly (for this, among other things, Deb Multimedia was needed), prepare the header files, cudautils and apply the patch: <br><div class="spoiler">  <b class="spoiler_title">Necessary actions</b> <div class="spoiler_text"><pre> <code class="bash hljs">apt-get install -y --force-yes unzip libfdk-aac-dev libopencv-dev libiec61883-dev libavc1394-dev libass-dev libbluray-dev libbs2b-dev libkvazaar-dev libilbc2 libilbc-dev libopenh264-dev libsnappy-dev libsoxr-dev libxv1 libxcb-shape0 libxcb-shm0 yasm frei0r-plugins-dev libgnutls28-dev libopenjpeg-dev libopus-dev libpulse-dev librtmp-dev libspeex-dev libutvideo-dev libvidstab-dev libvo-amrwbenc-dev libvpx-dev libx265-dev libzvbi-dev libssl-dev libcdio-dev libcdio-paranoia-dev <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src unzip video-sdk-601.zip; /bin/cp -prf nvidia_video_sdk_6.0.1/Samples/common/inc/nvCPUOPSys.h /usr/include /bin/cp -prf nvidia_video_sdk_6.0.1/Samples/common/inc/nvEncodeAPI.h /usr/include /bin/cp -prf nvidia_video_sdk_6.0.1/Samples/common/inc/nvFileIO.h /usr/include /bin/cp -prf nvidia_video_sdk_6.0.1/Samples/common/inc/NvHWEncoder.h /usr/include /bin/cp -prf nvidia_video_sdk_6.0.1/Samples/common/inc/nvUtils.h /usr/include unzip cudautils.zip <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> cudautils make <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src tar jxf ffmpeg-3.0.2.tar.bz2 <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ffmpeg-3.0.2 sed -i <span class="hljs-string"><span class="hljs-string">'s/ctx-&gt;outputs\[i\]-&gt;closed/ctx-&gt;outputs\[i\]-&gt;status/g'</span></span> ../ffmpeg_NVIDIA_gpu_acceleration.3.0.2.patch patch -Np1 -i ../ffmpeg_NVIDIA_gpu_acceleration.3.0.2.patch</code> </pre> </div></div><br>  Now we are ready to execute the three basic package building commands (configure / make / checkinstall). <br>  I will note a few points that you can change for yourself: <ol><li>  --Enable-nvenc and --enable-nvresize have been added (where without them!) </li><li>  Modified --extra-cflags and --extra-ldflags to include cudautils </li><li>  Removed --enable-opencl (could not find a library for it) and --enable-libtesseract (an extra module in my opinion) </li><li>  FFmpeg is going without --enable-shared, although nothing prevents you from getting it back </li><li>  make -j10 can be changed to specific to your system (I used a build machine, where threads + 2 = 10) </li><li>  I inserted dependencies in checkinstall to ensure that when installing from scratch, it was enough to run apt-get -f install and install the required packages, and not search for something else via ldd </li><li>  Also, due to the imperfection of checkinstall, we had to perform several optional actions (deleting conflicting dev packages and creating the / usr / share / ffmpeg folder) </li></ol><div class="spoiler">  <b class="spoiler_title">So, we go for coffee, but only after working configure</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ffmpeg-3.0.2 ./configure --prefix=/usr --extra-cflags=<span class="hljs-string"><span class="hljs-string">'-g -O2 -fstack-protector-strong -Wformat -Werror=format-security -I../cudautils '</span></span> --extra-ldflags=<span class="hljs-string"><span class="hljs-string">'-Wl,-z,relro -L../cudautils '</span></span> --cc=<span class="hljs-string"><span class="hljs-string">'ccache cc'</span></span> --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libmp3lame --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-gpl --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-nonfree --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libvorbis --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-pthreads --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libfaac --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libxvid --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-postproc --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-x11grab --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libgsm --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libtheora --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libopencore-amrnb --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libopencore-amrwb --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libx264 --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libspeex --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-nonfree --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libvpx --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libschroedinger --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-encoder=libschroedinger --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-version3 --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libopenjpeg --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-librtmp --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-avfilter --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libfreetype --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-decoder=amrnb --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libvo-amrwbenc --libdir=/usr/lib/x86_64-linux-gnu --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-vda --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libbluray --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libcdio --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-gnutls --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-frei0r --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-openssl --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libass --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libopus --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-fontconfig --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libpulse --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-mipsdsp --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-mips32r2 --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-msa --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-mipsfpu --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-mipsdspr2 --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libvidstab --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libzvbi --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-avresample --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libutvideo --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libfdk-aac --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libx265 --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libbs2b --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libilbc --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libopenh264 --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libkvazaar --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libsnappy --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libsoxr --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libiec61883 --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-vaapi --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libdc1394 --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-altivec --shlibdir=/usr/lib/x86_64-linux-gnu --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-nvenc --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-nvresize make -j10 apt-get -y remove libswscale-dev libavcodec-dev libswresample-dev libavutil-dev mkdir -p /usr/share/ffmpeg checkinstall --pkgname=ffmpeg --pkgversion <span class="hljs-string"><span class="hljs-string">"10:3.0.2-nvenc-7.5.18-nvresize-cudautils-`date +%Y%m%d`"</span></span> --backup=no --requires=<span class="hljs-string"><span class="hljs-string">'libcdio-paranoia1,libjack0,libasound2,libsdl1.2debian,libdc1394-22,libavc1394-0,libiec61883-0,libvidstab1.0,libbs2b0,libva1,libzvbi0,libx265-79,libx264-148,libvpx1,libvo-amrwbenc0,libutvideo15,libtheora0,libspeex1,libsoxr0,libsnappy1,libschroedinger-1.0-0,libopus0,libopenjpeg5,libopenh264-1,libopencore-amrwb0,libopencore-amrnb0,libmp3lame0,libkvazaar3,libilbc2,libgsm1,libfdk-aac1,libfaac0,libbluray1,libass5,libxcb-xfixes0,libcrystalhd3,libxvidcore4,libxv1,libxcb-shape0,libxcb-shm0'</span></span> --default</code> </pre> </div></div><br>  If as a result you received a deb file, then accept my congratulations! <br>  By the way, checkinstall can swear when installing a package.  Not scary.  Install (if not installed) the package manually via <i>dpkg -i ffmpeg_3.0.2-nvenc-7.5.18-nvresize-cudautils-20160523-1_amd64.deb</i> and then <i>apt-get -f install</i> to install the dependencies. <br><br><h4>  Nvenc and nvresize options </h4><br>  For some reason, not everyone knows what parameters nvenc and nvresize takes, and for this you just need to run ffmpeg with the -h key: <br><div class="spoiler">  <b class="spoiler_title">ffmpeg -h encoder = nvenc_h264</b> <div class="spoiler_text"><pre> <code class="bash hljs">Encoder nvenc_h264 [NVIDIA NVENC h264 encoder]: General capabilities: delay Threading capabilities: none Supported pixel formats: yuv420p nv12 nvenc_h264 AVOptions: -preset &lt;string&gt; E..V.... Set the encoding preset (one of slow = hq 2pass, medium = hq, fast = hp, hq, hp, bd, ll, llhq, llhp, default) (default <span class="hljs-string"><span class="hljs-string">"hq"</span></span>) -profile &lt;string&gt; E..V.... Set the encoding profile (high, main, baseline) -level &lt;string&gt; E..V.... Set the encoding level restriction (auto, 1.0, 1.0b, 1.1, 1.2, ..., 4.2, 5.0, 5.1) -tier &lt;string&gt; E..V.... Set the encoding tier (main or high) -cbr &lt;boolean&gt; E..V.... Use cbr encoding mode (default <span class="hljs-literal"><span class="hljs-literal">false</span></span>) -2pass &lt;boolean&gt; E..V.... Use 2pass encoding mode (default auto) -gpu &lt;int&gt; E..V.... Selects <span class="hljs-built_in"><span class="hljs-built_in">which</span></span> NVENC capable GPU to use. First GPU is 0, second is 1, and so on. (from 0 to INT_MAX) (default 0) -delay &lt;int&gt; E..V.... Delays frame output by the given amount of frames. (from 0 to INT_MAX) (default INT_MAX) -enableaq &lt;boolean&gt; E..V.... <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to 1 to <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> AQ (default <span class="hljs-literal"><span class="hljs-literal">false</span></span>)</code> </pre> </div></div><div class="spoiler">  <b class="spoiler_title">ffmpeg -h encoder = nvenc_hevc</b> <div class="spoiler_text"><pre> <code class="bash hljs">Encoder nvenc_hevc [NVIDIA NVENC hevc encoder]: General capabilities: delay Threading capabilities: none Supported pixel formats: yuv420p nv12 nvenc_hevc AVOptions: -preset &lt;string&gt; E..V.... Set the encoding preset (one of slow = hq 2pass, medium = hq, fast = hp, hq, hp, bd, ll, llhq, llhp, default) (default <span class="hljs-string"><span class="hljs-string">"hq"</span></span>) -profile &lt;string&gt; E..V.... Set the encoding profile (high, main, baseline) -level &lt;string&gt; E..V.... Set the encoding level restriction (auto, 1.0, 1.0b, 1.1, 1.2, ..., 4.2, 5.0, 5.1) -tier &lt;string&gt; E..V.... Set the encoding tier (main or high) -cbr &lt;boolean&gt; E..V.... Use cbr encoding mode (default <span class="hljs-literal"><span class="hljs-literal">false</span></span>) -2pass &lt;boolean&gt; E..V.... Use 2pass encoding mode (default auto) -gpu &lt;int&gt; E..V.... Selects <span class="hljs-built_in"><span class="hljs-built_in">which</span></span> NVENC capable GPU to use. First GPU is 0, second is 1, and so on. (from 0 to INT_MAX) (default 0) -delay &lt;int&gt; E..V.... Delays frame output by the given amount of frames. (from 0 to INT_MAX) (default INT_MAX) -enableaq &lt;boolean&gt; E..V.... <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to 1 to <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> AQ (default <span class="hljs-literal"><span class="hljs-literal">false</span></span>)</code> </pre> </div></div>  Important: s and size are not specified in the help, although vf_nvresize.c has them!  I‚Äôll also add that s and size are strings, not WxH, so you need to transfer hd1080, hd720, pal, ntsc, and other string notation permissions.  A full list of them can be found <a href="https://www.ffmpeg.org/ffmpeg-utils.html">here</a> . <br><div class="spoiler">  <b class="spoiler_title">ffmpeg -h filter = nvresize</b> <div class="spoiler_text"><pre> <code class="bash hljs">Filter nvresize GPU accelerated video resizer. Inputs: <span class="hljs-comment"><span class="hljs-comment">#0: default (video) Outputs: dynamic (depending on the options) nvresize AVOptions: outputs &lt;int&gt; ..FV.... set number of outputs (from 1 to 16) (default 1) readback &lt;int&gt; ..FV.... read result back to FB (from 0 to 1) (default 0) size &lt;string&gt; ..FV.... set video size (default false) s, &lt;string&gt; ..FV.... set video size (default false) gpu &lt;int&gt; ..FV.... Selects which NVENC capable GPU to use. First GPU is 0, second is 1, and so on. (from 0 to INT_MAX) (default 0) force_original_aspect_ratio &lt;int&gt; ..FV.... decrease or increase w/h if necessary to keep the original AR (from 0 to 2) (default 0)</span></span></code> </pre> </div></div><br><h4>  Expediency.  What is all this for? </h4><br>  I will not give detailed benchmarks here (unless the community asks me to do certain tests), they are enough on the Internet, and the encoding speed directly by the card is about the same and depends more on the original video, the resolution / bitrate of the encoded and additional processing (audio coding, overlay filters). <br><div class="spoiler">  <b class="spoiler_title">Here are some numbers for a test (cheap and ancient!) System on the Xeon L5420 (4 cores at 2.5 GHz)</b> <div class="spoiler_text">  576p source, x264, bitrate set to 3000k: <br>  frame = 7500 fps = 58 q = -1.0 Lsize = 107951kB time = 00: 05: 00.00 bitrate = 2947.8kbits / s speed = <b>2.32x</b> <br>  576p source, nvenc_h264, bitrate set to 3000k: <br>  frame = 7500 fps = 804 q = -0.0 Lsize = 116997kB time = 00: 05: 00.00 bitrate = 3194.8kbits / s speed = <b>32.2x</b> <br>  At 1080p source (37 megabits of source, 10-15 megabits), the speed is <b>0.42x</b> and <b>4.2x</b> - again Nvidia is about <b>10 times</b> faster. <br>  <b>When encoding 1080p in HEVC, it is painful to look at the processor, there are digits 0.08x and below, the card gives about 3x.</b> <br></div></div><br>  For the system on the Core i7, the difference is not so big, but still the card is 3-4 times faster than x265 on HEVC 1080p (15000k) and 13 times on HEVC 576p (3000k).  And this despite the fact that the i7 processor itself usually costs as much as a GTX 960 and is more expensive. <br><br>  As for the quality.  I am a perfectionist, but I think that there are many uses for hardware coding, because  The decline in quality is actually noticeably weak (watched both on a Dell 24 "monitor and on a 60" TV - all from close range) and only with so-called  pixel hunting.  But speed makes it possible to solve problems that are usually not able to run in real time on the processor. <br><br>  I deliberately omitted details on the speed of nvresize, except for its parameters, since  Although this is a very interesting and fast filter, its use is beyond the scope of this article. <br><br>  I hope that my work will not be wasted and will help even more people to join the technology of hardware coding, bypassing some of the pitfalls, the solution of which I spent a lot of time.  <b>But it was worth it!</b> <br><br><h4>  Article updates </h4><br><ul><li>  TODO: Apply patch to ffmpeg 3.1, since  there appeared a hardware decoder (cuvid), which seriously helps with heavy coding. </li><li>  08/18/2016: Fixed a patch before applying: ctx-&gt; outputs [i] -&gt; closed to ctx-&gt; outputs [i] -&gt; status, the file itself decided not to change yet so that the hashes converge. </li><li>  05/25/2016: Added the GTX 950 to the list of supported, this is the latest GM206, like the GTX 960 and removed the inappropriate remark about the Quadro line, which also came out on the basis of GM204 and GM206. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/301654/">https://habr.com/ru/post/301654/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../301644/index.html">We are testing asynchronous code.</a></li>
<li><a href="../301646/index.html">Template Description Language Snakeskin</a></li>
<li><a href="../301648/index.html">Dependency Injection Container from PHPixie</a></li>
<li><a href="../301650/index.html">Every vacancy on ‚ÄúMy Circle‚Äù is qualified by specialists</a></li>
<li><a href="../301652/index.html">Cisco learning old school</a></li>
<li><a href="../301656/index.html">7 signs that you are the future boss</a></li>
<li><a href="../301658/index.html">How to complete long-term goals</a></li>
<li><a href="../301662/index.html">How is content distribution strategy different from posting on Facebook?</a></li>
<li><a href="../301664/index.html">Paul Graham: How to make a Pittsburgh start-up hub</a></li>
<li><a href="../301666/index.html">Paul Graham: How to Know (How You Know)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>