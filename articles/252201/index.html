<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitoring for the poor or SAR + MySQL + Gnuplot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Why precisely SAR? 
 I have been monitoring for quite some time. Therefore, due to the nature of my activity, I often encounter unusual situations whe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitoring for the poor or SAR + MySQL + Gnuplot</h1><div class="post__text post__text-html js-mediator-article"><h4>  Why precisely SAR? </h4><br>  I have been monitoring for quite some time.  Therefore, due to the nature of my activity, I often encounter unusual situations when I have to invent various ‚Äúbicycles‚Äù in order to monitor the host.  For example, we will consider the situation when we have a server (virtuals or VDS), which is very limited in resources. <br><br>  There are many good monitoring systems like Zabbix, Nagios, Cacti, etc.  But for our situation, all of them are not suitable, for obvious reasons - they themselves consume resources, which we have so few.  Immediately the question arises, how to be?  And here SAR is in a hurry to help us. <br><a name="habracut"></a><br><h4>  Installing and configuring SAR </h4><br>  <b>SAR</b> (System Activity Report) is a very powerful utility for collecting statistical information about system performance.  Included in the sysstat package.  Therefore, if you do not have the sysstat package on your server, install it.  For example, for Debian: <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt-get install sysstat</span></span></code> </pre> <br>  Then we need to configure the SAR itself.  We include sysstat, for this we edit the file: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vim /etc/default/sysstat</span></span></code> </pre><br>  And we change the string ENABLED = "false" to ENABLED = "true".  After that we need to correct the task in cron. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># vim /etc/cron.d/sysstat</span></span></code> </pre><br>  I collect data every minute, so on my system it looks like this (you may be a little different): <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Activity reports every 1 minutes everyday * * * * * root command -v debian-sa1 &gt; /dev/null &amp;&amp; debian-sa1 1 1 # Additional run at 23:59 to rotate the statistics file 59 23 * * * root command -v debian-sa1 &gt; /dev/null &amp;&amp; debian-sa1 60 2</span></span></code> </pre><br>  Restart the sysstat service: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># service sysstat restart</span></span></code> </pre><br>  At this setting is over. <br><br><h4>  Using SAR </h4><br>  I will not describe in detail how to use SAR.  There are many articles on the Internet for this, and SAR itself provides quite extensive documentation.  All you need is man sar, and there, I think, you will understand. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  We learn SAR to flood reports in MySQL </h4><br>  Yes, you read it right.  Of course, we can use the SAR for its intended purpose, call it from the console and receive reports in this form: <br><pre> <code class="bash hljs">$ sar -s 07:00:00 -e 07:10:00 Linux 3.2.0-4-amd64 (mind-x) 02.03.2015 _x86_64_ (1 CPU) 07:00:01 CPU %user %nice %system %iowait %steal %idle 07:01:01 all 0,64 0,00 0,15 0,10 0,00 99,11 07:02:01 all 0,03 0,00 0,02 0,00 0,00 99,95 07:03:01 all 0,03 0,00 0,02 0,00 0,00 99,95 07:04:01 all 0,03 0,00 0,02 0,02 0,00 99,93 07:05:01 all 0,05 0,00 0,03 0,00 0,00 99,92 07:06:01 all 0,63 0,00 0,17 0,10 0,00 99,11 07:07:01 all 0,03 0,00 0,02 0,00 0,00 99,95 07:08:01 all 0,02 0,00 0,02 0,00 0,00 99,97 07:09:01 all 0,03 0,00 0,02 0,00 0,00 99,95 : all 0,17 0,00 0,05 0,02 0,00 99,76</code> </pre><br>  But you must admit that after a long working day you don‚Äôt feel like looking at these numbers, your eyes hurt, etc.  What to do?  How to work with such important information? <br><br>  I admit, I spent the whole evening thinking about this problem.  All decisions seemed strange to me.  Perhaps the solution I came up with is also strange, but why did I want to make SAR friends with MySQL?  I will try to explain further. <br><br>  If you read the SAR part carefully, then you probably noticed that SAR rotates its journals after midnight.  This is done specifically to break magazines by day.  I wanted to receive data continuously (after all, we will build graphs on them) so that I can select only the column I need, for a certain time, etc.  And then I wondered why not to fill all these reports into the database?  Since the server was already MySQL, the choice became obvious. <br><br><h4>  So, SAR and MySQL are friends </h4><br>  I rummaged through the whole Internet about this, but there is practically no information, just a couple of articles, the result of which the script was read.  But before we analyze it, let's prepare the base. <br><br>  Create a sysstat database: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> <span class="hljs-string"><span class="hljs-string">`sysstat`</span></span>;</code> </pre><br>  Create user sysstat (you can give this user any other rights). <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> <span class="hljs-string"><span class="hljs-string">'sysstat'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IDENTIFIED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">'some_pass'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">PRIVILEGES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> sysstat.* <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> <span class="hljs-string"><span class="hljs-string">'sysstat'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>;</code> </pre><br>  We create tables, it looks like this for me: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`host_health_cpu`</span></span> ( <span class="hljs-string"><span class="hljs-string">`datetime`</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0000-00-00 00:00:00'</span></span>, <span class="hljs-string"><span class="hljs-string">`pct_user`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`pct_nice`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`pct_system`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`pct_iowait`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`pct_steal`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`pct_idle`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`host_health_memory`</span></span> ( <span class="hljs-string"><span class="hljs-string">`datetime`</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0000-00-00 00:00:00'</span></span>, <span class="hljs-string"><span class="hljs-string">`kbmemfree`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`kbmemused`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`per_memused`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`kbbuffers`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`kbcached`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`kbcommit`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`per_commit`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`kbactive`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`kbinact`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`host_health_la`</span></span> ( <span class="hljs-string"><span class="hljs-string">`datetime`</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0000-00-00 00:00:00'</span></span>, <span class="hljs-string"><span class="hljs-string">`runq_sz`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`plist_sz`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ldavg_1`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ldavg_5`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`ldavg_15`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`host_health_net`</span></span> ( <span class="hljs-string"><span class="hljs-string">`datetime`</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0000-00-00 00:00:00'</span></span>, <span class="hljs-string"><span class="hljs-string">`iface`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">7</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`rxpck_persec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`txpck_persec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`rxbyt_persec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`txbyt_persec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`rxcmp_persec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`txcmp_persec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`rxcst_persec`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8;</code> </pre><br>  Everything, now we have everything ready, in order to fill the reports in MySQL. <br><br><h4>  Parse the script </h4><br>  In the script, we will use the <b>sadf</b> utility, which can display data collected by SAR in various formats, for example, in CSV, JSON, XML.  We will need a CSV.  The script itself is not very big and not difficult to understand, I will add only that I delete the first 2 columns from the sadf output, they contain information about the host and the interval between data deletions.  In our case there is only one host, and I already know the interval, so I don‚Äôt need this information. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #  WORKDIR=/var/cache/sar FMATDIR=/var/cache/sar_data SADF=`which sadf` HEAD=`which head` AWK=`which awk` #      cd ${WORKDIR} COPY=`which cp` SAR_LOG=/var/log/sysstat cd ${SAR_LOG} LATEST_DATA=`ls -tlr ${SAR_LOG} | tail -1 | awk '{print $9}'` ${COPY} ${LATEST_DATA} ${WORKDIR} for file in *; do #    6 .     $TIME UNIXTIME=$((`date +%s`-300)) TIME=`date -d@${UNIXTIME} +%H:%M:%S` #  CPU ${SADF} -d ${file} -s ${TIME} -t | cut -d ';' -f3,5- &gt; "${FMATDIR}"/"${file}"-host_health_cpu.csv #  ${SADF} -d ${file} -s ${TIME} -t -- -n DEV | cut -d ';' -f3- &gt; "${FMATDIR}"/"${file}"-host_health_net.csv #   LA ${SADF} -d ${file} -s ${TIME} -t -- -q | cut -d ';' -f3- &gt; "${FMATDIR}"/"${file}"-host_health_la.csv #    ${SADF} -d ${file} -s ${TIME} -t -- -r | cut -d ';' -f3- &gt; "${FMATDIR}"/"${file}"-host_health_memory.csv done #   MySQL cd ${FMATDIR} MYSQL=`which mysql` USER='user' PASS='some_pass' HOST='localhost' DB='sysstat' for file in *.csv; do ${MYSQL} -u${USER} -p${PASS} -h${HOST} -D${DB} -e "LOAD DATA LOCAL INFILE '${FMATDIR}/${file}' INTO TABLE `echo ${file} | sed 's/.csv//g' | awk -F'-' '{print $2}'` FIELDS TERMINATED BY ';' IGNORE 1 LINES;" done #   rm -fr ${FMATDIR}/*.csv rm -fr ${WORKDIR}/sa*</span></span></code> </pre><br>  In general, such a script.  In order to start the fill, add it to cron.  We will call every 5 minutes. <br><pre> <code class="bash hljs"> */5 * * * * bash /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/sar.sh</code> </pre><br>  An interesting feature of SAR is that when we call it as sar -s, indicating the start time, this time itself is not included in the report, therefore calling the sar script in the last 6 minutes, in the output we get the report in 5 minutes.  This must be taken into account.  Otherwise there will be ‚Äúholes‚Äù or duplicates in MySQL. <br><br>  As a result, you get about the following: <br><pre> <code class="bash hljs">mysql&gt; SELECT * FROM host_health_memory WHERE datetime &gt; NOW() - INTERVAL 10 MINUTE; +---------------------+-----------+-----------+-------------+-----------+----------+----------+------------+----------+---------+ | datetime | kbmemfree | kbmemused | per_memused | kbbuffers | kbcached | kbcommit | per_commit | kbactive | kbinact | +---------------------+-----------+-----------+-------------+-----------+----------+----------+------------+----------+---------+ | 2015-03-02 08:36:01 | 1381896 | 679396 | 32.00 | 104044 | 155520 | 803420 | 38.00 | 484244 | 142688 | | 2015-03-02 08:37:01 | 1377476 | 683816 | 33.00 | 104068 | 155668 | 810284 | 39.00 | 487632 | 142808 | | 2015-03-02 08:38:01 | 1377476 | 683816 | 33.00 | 104096 | 155672 | 810284 | 39.00 | 487668 | 142804 | | 2015-03-02 08:39:01 | 1377476 | 683816 | 33.00 | 104120 | 155680 | 810524 | 39.00 | 487832 | 142804 | | 2015-03-02 08:40:01 | 1372416 | 688876 | 33.00 | 104160 | 155684 | 819104 | 39.00 | 490708 | 142816 | | 2015-03-02 08:41:01 | 1377104 | 684188 | 33.00 | 104276 | 155700 | 810524 | 39.00 | 488008 | 142808 | | 2015-03-02 08:42:01 | 1379228 | 682064 | 33.00 | 104288 | 155708 | 816640 | 39.00 | 486392 | 142632 | | 2015-03-02 08:43:01 | 1378980 | 682312 | 33.00 | 104328 | 155708 | 816744 | 39.00 | 486680 | 142628 | | 2015-03-02 08:44:01 | 1378608 | 682684 | 33.00 | 104356 | 155716 | 816932 | 39.00 | 486936 | 142636 | | 2015-03-02 08:45:01 | 1371564 | 689728 | 33.00 | 104392 | 155720 | 827704 | 40.00 | 491912 | 142648 | +---------------------+-----------+-----------+-------------+-----------+----------+----------+------------+----------+---------+</code> </pre><br><h4>  What to do with this data? </h4><br>  You can do anything with them.  I wrote a little higher that on the basis of this data we will draw graphs.  This can be done in any way possible.  It all depends on your imagination. <br><br><h4>  Gnuplot </h4><br>  My choice fell on <b>Gnuplot</b> .  This is a fairly handy tool for building graphs, charts, etc.  Gnuplot has a lot of documentation on his <a href="http://gnuplot.sourceforge.net/">home site</a> , so we‚Äôll skip some of its features and how to use it. <br><br>  I wrote this script here: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash sleep 10 #    width="640" high="480" outfile="graph.svg" format="svg" NO_ARGS=0 E_OPTERROR=65 if [ $# -eq "$NO_ARGS" ] #    ? then echo "   !     : -o     (  \"graph.svg\") -f     (  \"svg\") -w   (  \"640\") -h   (  \"480\") -t     ." exit $E_OPTERROR fi #   while getopts ":h:w:t:f:o:" Option do case $Option in h) high="$OPTARG";; w) width="$OPTARG";; f) format="$OPTARG";; o) outfile="$OPTARG";; t) type="$OPTARG";; esac done shift $(($OPTIND - 1)) #     /tmp/datatmp if [ ${type} == 'cpu' ] then #   title="   CPU, %" QUERY="select time(datetime), pct_idle as idle, pct_iowait as iowait, pct_system as system, pct_user as user from host_health_cpu where now() - interval 1 hour &lt; datetime;" format_y='set format y "%.0f%%";' elif [ ${type} == 'mem' ] then title=" , B" QUERY="select time(datetime),(kbmemfree * 1024) as Free,(kbmemused * 1024) as Used,(kbbuffers * 1024) as Buffers,(kbcached * 1024) as Cached from host_health_memory where now() - interval 1 hour &lt; datetime;" format_y="set format y '%.1s%cB'" elif [ ${type} == "net" ] then title="   , B/s" QUERY='select time(datetime), (rxbyt_persec * 1024) as Rx, (txbyt_persec * 1024) as Tx from host_health_net where now() - interval 1 hour &lt; datetime and iface="eth0";' format_y="set format y '%.1s%cB/s'" elif [ ${type} == "la" ] then title="Load Average" QUERY="select time(datetime),ldavg_1 as LoadAvg1, ldavg_5 LoadAvg5,ldavg_15 as LoadAvg15 from host_health_la where now() - interval 1 hour &lt; datetime;" format_y="set format y '%.2f'" fi #         MYSQL=`which mysql` USER="user" PASS="some_pass" DB="sysstat" ${MYSQL} -u${USER} -p${PASS} -D${DB} -B -r -e "${QUERY}" &gt;&gt; /tmp/datatmp_${type} #    . cols=`awk '{print NF}' /tmp/datatmp_${type} | sort -nu | tail -n 1` #   hour_ago=`${MYSQL} -u${USER} -p${PASS} -D${DB} -N -e "select time(datetime) from host_health_cpu where now() - interval 1 hour &lt; datetime limit 1;"` now=`${MYSQL} -u${USER} -p${PASS} -D${DB} -N -e "select time(datetime) from host_health_cpu where now() - interval 1 hour &lt; datetime order by datetime desc limit 1;"` #  gnuplot &lt;&lt; EOP #      set terminal ${format} size ${width},${high} #   set output ${outfile} #  set key autotitle columnhead set key outside center bottom set key horizontal #  set style fill transparent solid 0.5 noborder set title "${title}" #       set xdata time set timefmt "%H:%M:%S" set xrange ["${hour_ago}":"${now}"] set xtics format "%H:%M" #   set xlabel "" set ylabel "${title}" set grid set yrange [0:*] ${format_y} #  . plot for [i=2:${cols}] "/tmp/datatmp_${type}" using 1:i smooth unique with filledcurve x1 EOP #  . rm /tmp/datatmp_${type} echo "Image write to \"${outfile}\"" exit 0;</span></span></code> </pre><br>  Run it like this: <br><pre> <code class="bash hljs">$ sar-plot.sh -t mem -o /path/to/memory.svg</code> </pre><br>  The result is such a schedule for 1 hour. <br><img src="//habrastorage.org/files/67c/337/2b7/67c3372b71d2427ea220efc6746f5b98.png"><br>  If we add this script to cron and call it, for example, once every 5 minutes, we will always have fresh graphics.  For example, I have done this: <br><pre> <code class="bash hljs">*/5 * * * * bash /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/sar-plot.sh -t cpu -o /path/to/images/cpu.svg */5 * * * * bash /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/sar-plot.sh -t mem -o /path/to/images/memory.svg */5 * * * * bash /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/sar-plot.sh -t net -o /path/to/images/network.svg */5 * * * * bash /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/sar-plot.sh -t la -o /path/to/images/la.svg</code> </pre><br>  Further, these images can be added to the HTML-page, to make it automatically updated.  Thus, we can monitor the performance of the host almost in real time (with a delay of 5 minutes).  What is basically enough for us. <br><br><h4>  Conclusion </h4><br>  <b>SAR</b> is a very convenient tool, indispensable in the work of a system administrator.  The monitoring method described by me is well suited for those who are very limited in resources, do not want to be raised on the Zabbix server or for various other reasons. <br>  You can develop this solution for you: <br><ul><li>  Add other metrics that are not described in the article, for example, you can add statistics on the activity of the disk subsystem. </li><li>  You can draw graphics in any other way, for example, using Javascript libraries. </li><li>  You can modify the system so that when any critical values ‚Äã‚Äãare reached, alerts are displayed on your web page, and, for example, messages are sent to your email. </li></ul><br>  It all depends on your desire.  Good luck! </div><p>Source: <a href="https://habr.com/ru/post/252201/">https://habr.com/ru/post/252201/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252191/index.html">How to combine services for teamwork: Sameroom project</a></li>
<li><a href="../252193/index.html">Swift Books</a></li>
<li><a href="../252195/index.html">GDC 2015: a major news digest. March, 3rd</a></li>
<li><a href="../252197/index.html">The world's best ghost with a motor, or integration testing of complex client-server applications</a></li>
<li><a href="../252199/index.html">Zend Certification. Not so devil</a></li>
<li><a href="../252209/index.html">Simple do-it-yourself cooling pad for laptop</a></li>
<li><a href="../252211/index.html">Galvanization of a corpse: how was it possible to revive a beaten HDD to store anything unnecessary</a></li>
<li><a href="../252213/index.html">The Seventh Annual Microsoft Research Summer School in Machine Learning and Intelligence - Cooperation with ACM Europe</a></li>
<li><a href="../252215/index.html">Full C ++ website and some couch analytics</a></li>
<li><a href="../252217/index.html">Air Native Extensions (ANE) Development for OS X</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>