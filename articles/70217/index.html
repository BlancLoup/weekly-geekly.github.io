<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Is R # right: call to .ToString () is redundant?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This post is published at the request of mstyura habrauser , which does not have enough karma to publish. If you liked the article, thank the author a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Is R # right: call to .ToString () is redundant?</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  This post is published at the request of mstyura <a href="https://habrahabr.ru/users/mstyura/" class="user_link">habrauser</a> , which does not have enough karma to publish.  If you liked the article, thank the author and help him with karma. </blockquote><br>  I want to share with the Habrosocommunity the result of my research on packaging / unpacking significant types.  Two things led me to write this topic: Richter <a href="http://www.piter.com/book.phtml%3F978591180303">'s</a> book <a href="http://www.piter.com/book.phtml%3F978591180303">‚ÄúCLR via c #‚Äù</a> and <a href="http://www.jetbrains.com/resharper/">R # itself</a> .  The latter, in my opinion, gave "dishonest" comments to my code. <br><a name="habracut"></a><br><h2>  What is the matter? </h2><br>  The fact is that I wrote a fairly standard code, like this one <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">string</font> str = <font color="#A31515">"habrahabr"</font> ; <br> <font color="#0000ff">int</font> val = 0; <br> <font color="#0000ff">var</font> resultString = str + val.ToString();</font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Resharper did not like my explicit call to the ToString () method of the val variable, but I naturally didn‚Äôt like what it tells me what to do when I know for sure that in this case it‚Äôs better to do what I wrote.  Let's see who is right.  To begin, I propose to figure out what operations will occur when executing the code proposed by R #, that is, this <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">string</font> str = <font color="#A31515">"habrahabr"</font> ; <br> <font color="#0000ff">int</font> val = 0; <br> <font color="#0000ff">var</font> resultString = str + val;</font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  In the last line we see the operation of adding two variables of different types, the result of which will be a string.  Since the variables are of different types, the next version of the <font color="#0000ff">string</font> System method will be called.  <font color="#2B91AF">String</font> .Concat ( <font color="#0000ff">object</font> , <font color="#0000ff">object</font> ).  Those.  the actual program code will be as follows <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">string</font> str = <font color="#A31515">"habrahabr"</font> ; <br> <font color="#0000ff">int</font> val = 0; <br> <font color="#0000ff">var</font> resultString = System. <font color="#2B91AF">String</font> .Concat(str, val);</font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  When passing the str (string - reference type) and val (integer - significant type) parameters to the Concat method for the second parameter, a packing operation will be performed, because we are trying to pass a significant int type to the method, and he expects a reference object. <br><br><h2>  What is packaging? </h2><br>  For exact definition, I turned to Richter <a href="http://www.piter.com/book.phtml%3F978591180303">‚Äôs</a> book <a href="http://www.piter.com/book.phtml%3F978591180303">‚ÄúCLR via c #‚Äù</a> .  So: <br><blockquote>  Packing (boxing) is the conversion of a meaningful type into a reference.  When packing an instance of a significant type, the following occurs. <br>  1. The managed heap is allocated memory.  Its volume is determined by the length of the significant type and the two additional members required for all objects in the managed heap ‚Äî a pointer to the type object and the SyncBlockIndex index. <br>  2. Fields of significant type are copied to the memory just allocated on the heap. <br>  3. Returns the address of the object.  This address is an object reference;  the significant type has become reference. </blockquote><br><h2>  And if you still call ToString () </h2><br>  If you call the ToString () method on the val variable before passing it to the System.String.Concat () method, the compiler will choose the next version of the overloaded <font color="#0000ff">string</font> System <font color="#0000ff">string</font> method.  <font color="#2B91AF">String</font> .Concat ( <font color="#0000ff">string</font> , <font color="#0000ff">string</font> ), because  Objects of the same reference type <font color="#0000ff">string</font> will be already input.  In this case, the packing operation will not be performed, which implies allocating memory for the significant type on the heap, copying there all the bytes of the original variable of the significant type, and returning the pointer to the allocated memory. <br><br><h2>  What is it compiled to? </h2><br>  Without calling ToString () <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  .locals init ([0] <font color="#0000ff">string</font> str, [1] int32 val, [2] <font color="#0000ff">string</font> resultString) </li><li>  IL_0000: nop </li><li>  IL_0001: ldstr <font color="#A31515">"habrahabr"</font> </li><li>  IL_0006: stloc.0 </li><li>  IL_0007: ldc.i4.0 </li><li>  IL_0008: stloc.1 </li><li>  IL_0009: ldloc.0 </li><li>  IL_000a: ldloc.1 </li><li>  IL_000b: <font><b>box</b></font> [mscorlib] System.  <font color="#2B91AF">Int32</font> </li><li>  IL_0010: call <font color="#0000ff">string</font> [mscorlib] System.  <font color="#2B91AF">String</font> :: Concat ( <font color="#0000ff">object</font> , <font color="#0000ff">object</font> ) </li><li>  IL_0015: stloc.2 </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  With a call tostring () <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  .locals init ([0] <font color="#0000ff">string</font> str, [1] int32 val, [2] <font color="#0000ff">string</font> resultString) </li><li>  IL_0000: nop </li><li>  IL_0001: ldstr <font color="#A31515">"habrahabr"</font> </li><li>  IL_0006: stloc.0 </li><li>  IL_0007: ldc.i4.0 </li><li>  IL_0008: stloc.1 </li><li>  IL_0009: ldloc.0 </li><li>  IL_000a: ldloca.s val </li><li>  IL_000c: call instance <font color="#0000ff">string</font> [mscorlib] System.  <font color="#2B91AF">Int32</font> :: ToString () </li><li>  IL_0011: call <font color="#0000ff">string</font> [mscorlib] System.  <font color="#2B91AF">String</font> :: Concat ( <font color="#0000ff">string</font> , <font color="#0000ff">string</font> ) </li><li>  IL_0016: stloc.2 </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br>  The main difference in the given IL codes is the box instruction that performs the packing operation, the opposite unpacking command corresponds to the unbox instruction, I do not consider it here. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Performance impact </h2><br>  Obviously, it is difficult to judge the performance of the above code, since  a single packing operation occurs fairly quickly.  We write the next cycle <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; 10000000; i++) <br> { <br> <font color="#0000ff">var</font> s = <font color="#A31515">"habrahabr"</font> + i; <br> }</font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  To measure runtime, we use the <font color="black">Stopwatch</font> class from the System.Diagnostics namespace, since  It gives a much more accurate result than using DateTime.  For example, on my machine, calling two consecutive DateTime.Now gives the difference 00: 00: 00.0010000, and starting and immediately stopping <font color="black">Stopwatch</font> - 00: 00: 00.0000015.  The difference is the Windows with the naked eye. <br>  The final code with which we will test the packing operation will be as follows. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">namespace</font> BoxingTraining <br> { <br> <font color="#0000ff">using</font> System; <br> <font color="#0000ff">using</font> System.Diagnostics; <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> Program <br> { <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">void</font> Main() <br> { <br> <font color="#0000ff">var</font> time = Stopwatch.StartNew(); <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; 10000000; i++) <br> { <br> <font color="#0000ff">var</font> s = <font color="#A31515">"habrahabr"</font> + i; <br> } <br> <font color="#2B91AF">Console</font> .WriteLine(time.Elapsed.ToString()); <br> } <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Below is a table with the results of running the above code when packing the value of int (4 bytes) <br><table><tbody><tr><td rowspan="2">  The number of iterations in the loop </td><td colspan="2">  Time, s. </td><td rowspan="2">  Difference, c. </td><td rowspan="2">  Winning,% </td></tr><tr><td>  Without ToString () </td><td>  With ToString () </td></tr><tr><td>  100,000 </td><td>  0.0324421 </td><td>  0.0314838 </td><td>  0,0009583 </td><td>  3.043788 </td></tr><tr><td>  1,000,000 </td><td>  0.3329810 </td><td>  0,2927090 </td><td>  0.0402720 </td><td>  13.75837 </td></tr><tr><td>  10,000,000 </td><td>  3.5344330 </td><td>  3.2425843 </td><td>  0.2918487 </td><td>  9,000497 </td></tr><tr><td>  100,000,000 </td><td>  35.9022937 </td><td>  35,4208982 </td><td>  0.4813955 </td><td>  1.359072 </td></tr></tbody></table><br>  As you can see, the results, though not in favor of packaging, are not as terrible as they might have seemed at once.  Further, we can assume that the size of the type (the value of the occupied memory) can also affect the result, and the next step will be the packaging of a single value of type char, byte and some kind of heavy, self-written structure. <br>  The code for testing the packaging of any variables of significant type. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">namespace</font> boxingTraining <br> { <br> <font color="#0000ff">using</font> System; <br> <font color="#0000ff">using</font> System.Diagnostics; <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> Program <br> { <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">void</font> Main() <br> { <br> <font color="#0000ff">var</font> time = Stopwatch.StartNew(); <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; 1000000; i++) <br> { <br> <font color="#0000ff">var</font> s = <font color="#A31515">"habrahabr"</font> + <font color="#A31515">  </font> ; <br> } <br> <font color="#2B91AF">Console</font> .WriteLine(time.Elapsed.ToString()); <br> } <br> } <br> }</font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  The result table for char (2 bytes) <br><table><tbody><tr><td rowspan="2">  The number of iterations in the loop </td><td colspan="2">  Time, s. </td><td rowspan="2">  Difference, c. </td><td rowspan="2">  Winning,% </td></tr><tr><td>  Without ToString () </td><td>  With ToString () </td></tr><tr><td>  100,000 </td><td>  0,0120120 </td><td>  0,0080280 </td><td>  0,003984 </td><td>  49.62631 </td></tr><tr><td>  1,000,000 </td><td>  0.0925545 </td><td>  0.0738690 </td><td>  0.0186855 </td><td>  25,29546 </td></tr><tr><td>  10,000,000 </td><td>  0.8949694 </td><td>  0.7298598 </td><td>  0.1651096 </td><td>  22.6221 </td></tr><tr><td>  100,000,000 </td><td>  9,1908556 </td><td>  6,9977169 </td><td>  2,1931387 </td><td>  31,34077 </td></tr></tbody></table><br>  Result table for byte (1 byte) <br><table><tbody><tr><td rowspan="2">  The number of iterations in the loop </td><td colspan="2">  Time, s. </td><td rowspan="2">  Difference, c. </td><td rowspan="2">  Winning,% </td></tr><tr><td>  Without ToString () </td><td>  With ToString () </td></tr><tr><td>  100,000 </td><td>  0.0264363 </td><td>  0.0242211 </td><td>  0,0022152 </td><td>  9,145745 </td></tr><tr><td>  1,000,000 </td><td>  0.2600672 </td><td>  0,2304188 </td><td>  0.0296484 </td><td>  12,86718 </td></tr><tr><td>  10,000,000 </td><td>  2.5563460 </td><td>  2,2713021 </td><td>  0.2850439 </td><td>  12,5498 </td></tr><tr><td>  100,000,000 </td><td>  25,1847944 </td><td>  22,3063352 </td><td>  2,8784592 </td><td>  12,90422 </td></tr></tbody></table><br>  A small lyrical digression.  When I wrote this topic and came to this point, habrauzer <a href="https://habrahabr.ru/users/aldanko/" class="user_link">Aldanko</a> , with whom I consulted when writing this article, strongly recommended testing for more standard types to see how they behave in this situation and to investigate the effect of the internal device on packing operation. <br>  Let's test for the following types System.Int16 (2 bytes), System.Int64 (8 bytes), System.Single (4 bytes), System.Double (8 bytes) and System.Decimal (16 bytes). <br>  For System.Int16 <br><table><tbody><tr><td rowspan="2">  The number of iterations in the loop </td><td colspan="2">  Time, s. </td><td rowspan="2">  Difference, c. </td><td rowspan="2">  Winning,% </td></tr><tr><td>  Without ToString () </td><td>  With ToString () </td></tr><tr><td>  100,000 </td><td>  0.0268269 </td><td>  0.0252753 </td><td>  0,001552 </td><td>  6.1388 </td></tr><tr><td>  1,000,000 </td><td>  0,2508171 </td><td>  0,2283134 </td><td>  0.022504 </td><td>  9,856496 </td></tr><tr><td>  10,000,000 </td><td>  2,5840173 </td><td>  2,2771103 </td><td>  0,306907 </td><td>  13,47792 </td></tr><tr><td>  100,000,000 </td><td>  25.5575014 </td><td>  22,6322024 </td><td>  2,925299 </td><td>  12,92538 </td></tr></tbody></table><br>  For System.Int64 <br><table><tbody><tr><td rowspan="2">  The number of iterations in the loop </td><td colspan="2">  Time, s. </td><td rowspan="2">  Difference, c. </td><td rowspan="2">  Winning,% </td></tr><tr><td>  Without ToString () </td><td>  With ToString () </td></tr><tr><td>  100,000 </td><td>  0.0313252 </td><td>  0.0261576 </td><td>  0,005168 </td><td>  19,75564 </td></tr><tr><td>  1,000,000 </td><td>  0.2730405 </td><td>  0.2520212 </td><td>  0.021019 </td><td>  8,34029 </td></tr><tr><td>  10,000,000 </td><td>  2.7573422 </td><td>  2.3089744 </td><td>  0.448368 </td><td>  19,41848 </td></tr><tr><td>  100,000,000 </td><td>  26,6876964 </td><td>  23.3565123 </td><td>  3.331184 </td><td>  14,26234 </td></tr></tbody></table><br>  For System.Single <br><table><tbody><tr><td rowspan="2">  The number of iterations in the loop </td><td colspan="2">  Time, s. </td><td rowspan="2">  Difference, c. </td><td rowspan="2">  Winning,% </td></tr><tr><td>  Without ToString () </td><td>  With ToString () </td></tr><tr><td>  100,000 </td><td>  0.0488271 </td><td>  0.0435174 </td><td>  0,00531 </td><td>  12,20133 </td></tr><tr><td>  1,000,000 </td><td>  0.4585808 </td><td>  0.4277303 </td><td>  0.030851 </td><td>  7.212606 </td></tr><tr><td>  10,000,000 </td><td>  4,5009957 </td><td>  4,2313242 </td><td>  0.269671 </td><td>  6.373218 </td></tr><tr><td>  100,000,000 </td><td>  44,9906154 </td><td>  42,5702807 </td><td>  2,420335 </td><td>  5,685503 </td></tr></tbody></table><br>  For System.Double <br><table><tbody><tr><td rowspan="2">  The number of iterations in the loop </td><td colspan="2">  Time, s. </td><td rowspan="2">  Difference, c. </td><td rowspan="2">  Winning,% </td></tr><tr><td>  Without ToString () </td><td>  With ToString () </td></tr><tr><td>  100,000 </td><td>  0.0477293 </td><td>  0.0454006 </td><td>  0,002329 </td><td>  5,129227 </td></tr><tr><td>  1,000,000 </td><td>  0.4774911 </td><td>  0.4507611 </td><td>  0.02673 </td><td>  5.92997 </td></tr><tr><td>  10,000,000 </td><td>  4,7426156 </td><td>  4.5235923 </td><td>  0.219023 </td><td>  4.8418 </td></tr><tr><td>  100,000,000 </td><td>  47.4816881 </td><td>  44.3383082 </td><td>  3.14338 </td><td>  7.089535 </td></tr></tbody></table><br>  For System.Decimal <br><table><tbody><tr><td rowspan="2">  The number of iterations in the loop </td><td colspan="2">  Time, s. </td><td rowspan="2">  Difference, c. </td><td rowspan="2">  Winning,% </td></tr><tr><td>  Without ToString () </td><td>  With ToString () </td></tr><tr><td>  100,000 </td><td>  0.0342277 </td><td>  0.0302381 </td><td>  0,00399 </td><td>  13,19395 </td></tr><tr><td>  1,000,000 </td><td>  0.3082451 </td><td>  0.2852763 </td><td>  0.022969 </td><td>  8.051422 </td></tr><tr><td>  10,000,000 </td><td>  3.0517615 </td><td>  2,8142709 </td><td>  0.237491 </td><td>  8,438797 </td></tr><tr><td>  100,000,000 </td><td>  30.7824241 </td><td>  27.8104480 </td><td>  2.971976 </td><td>  10.68655 </td></tr></tbody></table><br>  As you can see, the call toString () is always faster.  In principle, it cannot be slow, because  if it is not called, it will be called anyway, but before that, an object of a significant type will be wrapped. <br><h2>  Performance of user structures </h2><br>  I have already tested the most common standard types.  It is time to write your structure.  On the advice of the same habrayuzer, <a href="https://habrahabr.ru/users/aldanko/" class="user_link">Aldanko</a> will write a structure containing 1600 fields of type byte (1 byte) and 100 fields of type Decimal (16 byte).  The first structure is as follows. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">struct</font> DecimalStruct <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">decimal</font> Field1; <br> <font color="#0000ff">public</font> <font color="#0000ff">decimal</font> Field2; <br> <font color="#0000ff">public</font> <font color="#0000ff">decimal</font> Field3; <br> <font color="#0000ff">public</font> <font color="#0000ff">decimal</font> Field4; <br> ... <br> <font color="#0000ff">public</font> <font color="#0000ff">decimal</font> Field97; <br> <font color="#0000ff">public</font> <font color="#0000ff">decimal</font> Field98; <br> <font color="#0000ff">public</font> <font color="#0000ff">decimal</font> Field99; <br> <font color="#0000ff">public</font> <font color="#0000ff">decimal</font> Field100; <br> <font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">string</font> ToString() <br> { <br> <font color="#0000ff">return</font> <font color="#A31515">"DecimalStruct"</font> ; <br> } <br> }</font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  You can <a href="http://cid-e1505f1cb0216150.skydrive.live.com/self.aspx/For%2520Habrahabr/DecimalStruct.txt">download the</a> full version of the code. <br>  Structure with 1600 byte type fields <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">struct</font> ByteStruct <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">byte</font> Field1; <br> <font color="#0000ff">public</font> <font color="#0000ff">byte</font> Field2; <br> <font color="#0000ff">public</font> <font color="#0000ff">byte</font> Field3; <br> <font color="#0000ff">public</font> <font color="#0000ff">byte</font> Field4; <br> ... <br> <font color="#0000ff">public</font> <font color="#0000ff">byte</font> Field1597; <br> <font color="#0000ff">public</font> <font color="#0000ff">byte</font> Field1598; <br> <font color="#0000ff">public</font> <font color="#0000ff">byte</font> Field1599; <br> <font color="#0000ff">public</font> <font color="#0000ff">byte</font> Field1600; <br> <font color="#0000ff">public</font> <font color="#0000ff">override</font> <font color="#0000ff">string</font> ToString() <br> { <br> <font color="#0000ff">return</font> <font color="#A31515">"ByteStruct"</font> ; <br> } <br> }</font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  You can <a href="http://cid-e1505f1cb0216150.skydrive.live.com/self.aspx/For%2520Habrahabr/ByteStruct.txt">download the</a> full version of the code. <br>  Correspondingly, the code for which we will test the packing operation will be as follows <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">namespace</font> boxingTraining <br> { <br> <font color="#0000ff">using</font> System; <br> <font color="#0000ff">using</font> System.Diagnostics; <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> Program <br> { <br> <font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#0000ff">void</font> Main() <br> { <br> <font color="#0000ff">var</font> myStruct = <font color="#0000ff">new</font> ByteStruct(); <font color="#008000">// new DecimalStruct()</font> <br> <font color="#0000ff">var</font> time = Stopwatch.StartNew(); <br> <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; 100000; i++) <br> { <br> <font color="#0000ff">var</font> s = <font color="#A31515">"habrahabr"</font> + myStruct; <font color="#008000">// myStruct.ToString()</font> <br> } <br> <font color="#2B91AF">Console</font> .WriteLine(time.Elapsed.ToString()); <br> } <br> } <br> }</font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  The purpose of these frauds is to see how the internal structure of the structure will affect the time of the packing operation, namely, to copy the internal data into a managed heap. <br>  So the results.  For ByteStruct <br><table><tbody><tr><td rowspan="2">  The number of iterations in the loop </td><td colspan="2">  Time, s. </td><td rowspan="2">  Difference, c. </td><td rowspan="2">  Winning,% </td></tr><tr><td>  Without ToString () </td><td>  With ToString () </td></tr><tr><td>  100,000 </td><td>  0.0553811 </td><td>  0,0072760 </td><td>  0.048105 </td><td>  661.1476 </td></tr><tr><td>  1,000,000 </td><td>  0.5218077 </td><td>  0.0591120 </td><td>  0.462696 </td><td>  782,7441 </td></tr><tr><td>  10,000,000 </td><td>  5,2083878 </td><td>  0.5520037 </td><td>  4.656384 </td><td>  843,5422 </td></tr><tr><td>  100,000,000 </td><td>  61,8142750 </td><td>  5,5449448 </td><td>  56,26933 </td><td>  1014,786 </td></tr></tbody></table><br>  Total for DecimalString <br><table><tbody><tr><td rowspan="2">  The number of iterations in the loop </td><td colspan="2">  Time, s. </td><td rowspan="2">  Difference, c. </td><td rowspan="2">  Winning,% </td></tr><tr><td>  Without ToString () </td><td>  With ToString () </td></tr><tr><td>  100,000 </td><td>  0.0815664 </td><td>  0,0068541 </td><td>  0.074712 </td><td>  1090.038 </td></tr><tr><td>  1,000,000 </td><td>  0.8208648 </td><td>  0.0638818 </td><td>  0.756983 </td><td>  1184,974 </td></tr><tr><td>  10,000,000 </td><td>  6.9349283 </td><td>  0.6249309 </td><td>  6,309997 </td><td>  1009,711 </td></tr><tr><td>  100,000,000 </td><td>  54,7189205 </td><td>  6,8453349 </td><td>  47.87359 </td><td>  699,3608 </td></tr></tbody></table><br>  As can be seen from the above tests on voluminous structures, the ToString call gives a gain up to 10 times.  True so that it is clearly visible, you need to repeat the packing operation more than once. <br><br><h2>  findings </h2><br>  What can we conclude from this mini-study?  At least it is obvious to me.  For reference types, a call to ToString () will not give any benefit and its use in string operations will be redundant, but for meaningful types, a call to ToString () is necessary.  When you call it, we avoid a fairly resource-intensive operation - packaging, which in certain cases can significantly degrade the performance of the code.  Well, R # turned out to be wrong, cursing that, the call ToString () of a meaningful type is redundant when concatenating strings.  It can be not produced, but you can pay the performance. <br><br> <a href="http://progg.ru/%25D0%259F%25D1%2580%25D0%25B0%25D0%25B2-%25D0%25BB%25D0%25B8-R-call-to-ToString-is-redundant-NET-%25D0%25A5%25D0%25B0%25D0%25B1%25D1%2580%25D0%25B0%25D1%2585%25D0%25B0%25D0%25B1%25D1%2580"><img alt="Progg it" src="http://progg.ru/image.axd?url=http%3A%2F%2Fhabrahabr.ru%2Fblogs%2Fnet%2F70217%2F"></a> <br></div><p>Source: <a href="https://habr.com/ru/post/70217/">https://habr.com/ru/post/70217/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../70211/index.html">Second week with intel</a></li>
<li><a href="../70212/index.html">Warranty service for iPhone from M-Video with Megaphone smack</a></li>
<li><a href="../70214/index.html">Mega negative about the MTS stock</a></li>
<li><a href="../70215/index.html">Free AJAX CDN</a></li>
<li><a href="../70216/index.html">Print someone else's logo without his knowledge</a></li>
<li><a href="../70220/index.html">Bug when installing MS SQL Server 2008</a></li>
<li><a href="../70222/index.html">Animal level +1</a></li>
<li><a href="../70225/index.html">(Evil) use of C # 4.0 Dynamic - Typeless Lambda Calculus, Church Numerals, and all-all-all ... (part 1)</a></li>
<li><a href="../70226/index.html">Stable Windows XP, or correct system setup after installation</a></li>
<li><a href="../70230/index.html">Open Source wins the Trojan market</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>