<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Parallel Extensions for .net 3.5</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The number of cores in processors is growing year by year. But many programs still know how to use only one thing. In a small note I want to talk abou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Parallel Extensions for .net 3.5</h1><div class="post__text post__text-html js-mediator-article"><img hspace="5" alt="Aquafresh :-)" align="left" src="https://habrastorage.org/getpro/habr/post_images/13a/2bc/ab7/13a2bcab7567b80364a07e1028667da5.png">  The number of cores in processors is growing year by year.  But many programs still know how to use only one thing.  In a small note I want to talk about the addition to the <code>System.Threading</code> library, which is called <em>Parallel Extensions</em> .  This addition allows you to perform tasks on a high level on all available cores / processors. <br><br>  This article is only a brief introductory overview of <em>Parallel Extensions</em> .  Also at the end of the article you will find links to resources that reveal the topic in detail. <br><br>  If interested, feel free to dive under the cat. <br><a name="habracut"></a><br><h1>  A bit of history </h1><br>  <em>Parallel Extensions</em> (PE) library - a joint project of the .net team and Microsoft Research - first saw the light of day on November 29, 2007.  It is designed so that developers can use modern multi-core architectures without bothering with labor-intensive flow control.  Programs written using the library automatically use all available system cores.  If the program is run on an old single-core computer, then execution will occur sequentially, with almost no loss in performance.  Thus, the use of PE reveals all the advantages of multi-core technologies, while maintaining performance on single-core systems. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The last update of the library was in June 2008.  Now it has the status of <em>Community Technology Preview</em> and, most likely, will be included in version 4.net. <br><br><h1>  Library Composition </h1><br>  PE consists of three main components: <br><ul><li>  Task Parallel Library (TPL) - provides such imperative methods as <code>Parallel.For</code> , <code>Parallel.Foreach</code> and <code>Parallel.Invoke</code> to perform parallel computing.  All work on creating and terminating threads, depending on the processors available, is performed by the library automatically. </li><li>  Parallel LINQ (PLINQ) is an add-on over LINQ to Objects and LINQ to XML that allows you to perform parallel queries.  In most cases, it is enough to write <code>AsParallel()</code> at the beginning of the request so that all subsequent operators are executed in parallel.  Internally uses TPL. </li><li>  Coordination Data Structures (CDS) is a set of structures used to synchronize and coordinate the execution of parallel tasks.  We will not consider it in this article. </li></ul><br>  I want to warn you that this library does not resolve issues related to streaming security of objects.  If you are using non- <em>ThreadSafe</em> objects, then you must ensure that the object is used only by one thread. <br><br><h1>  What do we do </h1><br>  As an example, I propose to take the search for prime numbers from 2 to a given limit.  We will check all the numbers from this interval using the following static method: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">class</font> Prime&lt;br&gt;  {&lt;br&gt; <font color="#008000">/// &lt;summary&gt;</font> &lt;br&gt; <font color="#008000">/// Determines whether the specified candidate is prime.</font> &lt;br&gt; <font color="#008000">/// &lt;/summary&gt;</font> &lt;br&gt; <font color="#008000">/// &lt;param name="candidate"&gt;The candidate.&lt;/param&gt;</font> &lt;br&gt; <font color="#008000">/// &lt;returns&gt;</font> &lt;br&gt; <font color="#008000">///   &lt;c&gt;true&lt;/c&gt; if the specified candidate is prime; otherwise, &lt;c&gt;false&lt;/c&gt;.</font> &lt;br&gt; <font color="#008000">/// &lt;/returns&gt;</font> &lt;br&gt; <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">bool</font> IsPrime( <font color="#0000ff">int</font> candidate)&lt;br&gt;    {&lt;br&gt; <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> d = 2; d &lt;= candidate/2; d++)&lt;br&gt;      {&lt;br&gt; <font color="#0000ff">if</font> (candidate%d == 0)&lt;br&gt; <font color="#0000ff">return</font> <font color="#0000ff">false</font> ;&lt;br&gt;      }&lt;br&gt; <font color="#0000ff">return</font> candidate &gt; 1;&lt;br&gt;    }&lt;br&gt;  }</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  For convenience, we will create an interface: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">interface</font> IPrimeFinder&lt;br&gt;  {&lt;br&gt; <font color="#008000">/// &lt;summary&gt;</font> &lt;br&gt; <font color="#008000">/// Finds primes up to the specified limit.</font> &lt;br&gt; <font color="#008000">/// &lt;/summary&gt;</font> &lt;br&gt; <font color="#008000">/// &lt;param name="limit"&gt;The limit.&lt;/param&gt;</font> &lt;br&gt; <font color="#008000">/// &lt;returns&gt;List of primes&lt;/returns&gt;</font> &lt;br&gt; <font color="#2B91AF">List</font> &lt; <font color="#0000ff">int</font> &gt; Find ( <font color="#0000ff">int</font> limit );&lt;br&gt;  }</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br><h1>  Reference calculation </h1><br>  As a reference, we will consider a simple for loop from 2 to <code>limit</code> : <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#2B91AF">List</font> &lt; <font color="#0000ff">int</font> &gt; Find( <font color="#0000ff">int</font> limit)&lt;br&gt;    {&lt;br&gt; <font color="#0000ff">var</font> result = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt; <font color="#0000ff">int</font> &gt;();&lt;br&gt;&lt;br&gt; <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 2; i &lt; limit; i++)&lt;br&gt;      {&lt;br&gt; <font color="#0000ff">if</font> (Prime.IsPrime(i))&lt;br&gt;          result.Add(i);&lt;br&gt;      }&lt;br&gt;&lt;br&gt; <font color="#0000ff">return</font> result;&lt;br&gt;    }</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  If we run our program, we will see something like the following schedule for CPU usage when searching for all prime numbers up to 200,000: <br><br><img alt="CPU load" src="https://habrastorage.org/getpro/habr/post_images/e8e/d42/2f2/e8ed422f21f5d8c4a84d09ce2cca697b.png"><br><br>  The processor only works in half power.  Let's try to fix it. <br><br><h1>  Parallel.For </h1><br>  The big advantage of this library is that to create a multi-threaded code, a minimum of changes are required.  In our case, the <code>Parallel.For()</code> method takes three parameters: the beginning of the interval, the end, and the delegate to execute.  Note that the modification does not affect the body of the loop: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#2B91AF">List</font> &lt; <font color="#0000ff">int</font> &gt; Find( <font color="#0000ff">int</font> limit)&lt;br&gt;    {&lt;br&gt; <font color="#0000ff">var</font> result = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt; <font color="#0000ff">int</font> &gt;();&lt;br&gt;&lt;br&gt;      Parallel.For(2, <font color="#008000">//start from</font> &lt;br&gt;             limit, <font color="#008000">//up to</font> &lt;br&gt;             i =&gt; <font color="#008000">//action variable</font> &lt;br&gt;             {&lt;br&gt; <font color="#0000ff">if</font> (Prime.IsPrime(i))&lt;br&gt;                 result.Add(i);&lt;br&gt;             });&lt;br&gt;&lt;br&gt; <font color="#0000ff">return</font> result;&lt;br&gt;    }</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  The changes are minimal, but let's look at the CPU usage schedule: <br><br><img alt="Full cpu load" src="https://habrastorage.org/getpro/habr/post_images/a93/23e/1ce/a9323e1cec9087001a51f283577ad4f2.png"><br><br>  Both cores are used.  And the execution time was reduced almost twice (one cell - 5 seconds).  It is worth noting that <code>List&lt;T&gt;</code> allows you to add elements in different threads.  But if we tried to go through the list using foreach, we would get an error.  All work with synchronization and lies on the user. <br><br><h1>  AsParallel () </h1><br>  LINQ has become one of my favorite innovations in .net.  It allows you to reduce many designs to one line.  This is how our example written with LINQ will look like: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">Enumerable.Range ( 2, limit - 1 ).Where ( Prime.IsPrime ).ToList ( );</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Briefly and clearly.  In order to make this query parallel, you need to add just one word <code>AsParallel()</code> : <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">Enumerable.Range(2, limit - 1).AsParallel().Where(Prime.IsPrime).ToList();</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  All that is written after <code>AsParallel()</code> will be executed in parallel threads using all processors.  As can be seen in the case of LINQ, no changes affecting the content of the source code were required.  Moreover, this option is more secure in terms of threads: in this case, PLINQ itself synchronizes execution.  You can also use aggregate functions. <br><br><h1>  Parallel.Invoke () </h1><br>  <code>Parallel.Invoke()</code> is mainly used to perform versatile tasks.  In our version, we divide all the numbers from the range into 10 parts and perform the calculation in the form of parallel tasks.  To do this, create an additional helper method that takes as its arguments the upper bound, the number of subranges and the number of the subrange to be calculated: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">private</font> <font color="#0000ff">static</font> <font color="#2B91AF">List</font> &lt; <font color="#0000ff">int</font> &gt; CheckRange( <font color="#0000ff">int</font> n, <font color="#0000ff">int</font> limit, <font color="#0000ff">int</font> factor)&lt;br&gt;    {&lt;br&gt; <font color="#0000ff">var</font> local_result = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt; <font color="#0000ff">int</font> &gt;();&lt;br&gt; <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = n*(limit/factor); i &lt; (n + 1)*(limit/factor); i++)&lt;br&gt;      {&lt;br&gt; <font color="#0000ff">if</font> (Prime.IsPrime(i))&lt;br&gt;          local_result.Add(i);&lt;br&gt;      }&lt;br&gt; <font color="#0000ff">return</font> local_result;&lt;br&gt;    }</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  As an argument, <code>Parallel.Invoke()</code> in our case takes an array of delegates.  The new code will look like this: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#2B91AF">List</font> &lt; <font color="#0000ff">int</font> &gt; Find( <font color="#0000ff">int</font> limit)&lt;br&gt;    {&lt;br&gt; <font color="#0000ff">var</font> result = <font color="#0000ff">new</font> <font color="#2B91AF">List</font> &lt; <font color="#0000ff">int</font> &gt;();&lt;br&gt;      Parallel.Invoke(() =&gt; result.AddRange(CheckRange(0, limit, 10)),&lt;br&gt;              () =&gt; result.AddRange(CheckRange(1, limit, 10)),&lt;br&gt;              () =&gt; result.AddRange(CheckRange(2, limit, 10)),&lt;br&gt;              () =&gt; result.AddRange(CheckRange(3, limit, 10)),&lt;br&gt;              () =&gt; result.AddRange(CheckRange(4, limit, 10)),&lt;br&gt;              () =&gt; result.AddRange(CheckRange(5, limit, 10)),&lt;br&gt;              () =&gt; result.AddRange(CheckRange(6, limit, 10)),&lt;br&gt;              () =&gt; result.AddRange(CheckRange(7, limit, 10)),&lt;br&gt;              () =&gt; result.AddRange(CheckRange(8, limit, 10)),&lt;br&gt;              () =&gt; result.AddRange(CheckRange(9, limit, 10)));&lt;br&gt;&lt;br&gt; <font color="#0000ff">return</font> result;&lt;br&gt;    }</font> &lt;br&gt;&lt;br&gt; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Of course, we have greatly changed the code, but this is not a typical situation. <br><br><h1>  Some statistics </h1><br>  For clarity, here is the speed chart: <br><br><img alt="Execution time" src="https://habrastorage.org/getpro/habr/post_images/0e9/ead/e24/0e9eade2440c7e1c8059d1ffdc1d29cb.png"><br><br>  And the CPU usage schedule (stretched a bit): <br><br><img alt="CPU load" src="https://habrastorage.org/getpro/habr/post_images/7e2/91b/6aa/7e291b6aa367af5acd98a0b7abb9a8e4.png"><br><br>  On the load graph, patterns from three methods using parallel computations and one reference are clearly visible. <br><br>  Even with a small amount of computation, when the processors are not fully loaded, the use of PE gives almost a twofold increase in speed.  There is a small overhead when you first access the library.  The choice of the type of parallel computing has practically no effect on speed. <br><br><h1>  Give two! </h1><br><ol><li>  <a href="http://www.microsoft.com/downloads/details.aspx%3FFamilyId%3D348F73FD-593D-4B3C-B055-694C50D2B0F3%26displaylang%3Den">Parallel Extensions</a> download page </li><li>  Example <a href="">Sources</a> : <a href="">Look4Prime</a> </li></ol><br><br><h1>  And it's all?!? </h1><br>  No, not all.  Here are links for more in-depth study: <br><ul><li>  Division <a href="http://msdn.microsoft.com/en-us/concurrency/default.aspx">Parallel Computing</a> </li><li>  <a href="http://blogs.msdn.com/pfxteam/">Parallel FX Team Blog</a> </li><li>  <a href="http://en.wikipedia.org/wiki/Parallel_FX_Library">Parallel FX Library</a> on Wikipedia </li><li>  <a href="http://msdn.microsoft.com/en-us/magazine/cc163329.aspx">Running Queries On Multi-Core Processors</a> </li></ul><br><br></div><p>Source: <a href="https://habr.com/ru/post/45732/">https://habr.com/ru/post/45732/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../45726/index.html">CorePy: programming in assembler in Python</a></li>
<li><a href="../45727/index.html">Peter Nalitch - new album on the system "Pay What You Want"</a></li>
<li><a href="../45728/index.html">You can take a picture and a matchbox</a></li>
<li><a href="../45729/index.html">Control of lost time: learn to observe balance</a></li>
<li><a href="../45730/index.html">Apparently django-thaw began</a></li>
<li><a href="../45734/index.html">Discuss how to deal with automatic spam?</a></li>
<li><a href="../45736/index.html">nginx: another allocator</a></li>
<li><a href="../45737/index.html">Mumbai terrorists and new US IT policy</a></li>
<li><a href="../45738/index.html">Bored, my friends ...</a></li>
<li><a href="../45739/index.html">Openit.com.ua [Not] v_kkrita kraina</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>