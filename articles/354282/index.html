<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configure BGP to bypass locks, or ‚ÄúHow I stopped being afraid and fell in love with the RKN‚Äù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Well, okay, about ‚Äúloved‚Äù is an exaggeration. Rather, "could coexist with." 


 As you all know, from April 16, 2018, Roskomnadzor with extremely broa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configure BGP to bypass locks, or ‚ÄúHow I stopped being afraid and fell in love with the RKN‚Äù</h1><div class="post__text post__text-html js-mediator-article"><p>  Well, okay, about ‚Äúloved‚Äù is an exaggeration.  Rather, "could coexist with." </p><br><p>  As you all know, from April 16, 2018, Roskomnadzor with extremely broad strokes blocks access to resources on the network, adding to the ‚ÄúUnified Register of Domain Names, website page indexes on the Internet and network addresses to identify sites on the Internet, containing information whose distribution in the Russian Federation is prohibited "(in the text - just a register) by / 10 sometimes.  As a result, citizens of the Russian Federation and business suffer, losing access to the absolutely legal resources they need. </p><br><p>  After I said in the comments to one of the articles on Habr√© that I was ready to help the victims with setting up the bypass scheme, several people asked me for such help.  When everything worked for them, one of them recommended to describe the methodology in the article.  Upon reflection, I decided to break my silence on the site and try for once to write something intermediate between the project and the post on Facebook, i.e.  habrapost  The result is in front of you. </p><a name="habracut"></a><br><h2 id="disclaimer">  Disclaimer </h2><br><p>  Since it is not very legal to publish ways to bypass access to information that is prohibited on the territory of the Russian Federation, the purpose of this article will be to talk about a method that allows you to automate access to resources allowed on the territory of the Russian Federation, but because of someone else‚Äôs actions through your provider.  And access to other resources, obtained as a result of actions from the article, is an annoying side effect and the purpose of the article is by no means the case. </p><br><p>  Also, since I am primarily a network architect by profession, vocation and life, programming and Linux are not my strengths.  Therefore, of course, you can write better scripts, security issues in the VPS can be worked out deeper, etc.  Your suggestions will be gratefully accepted if they are detailed enough - I will gladly add them to the text of the article. </p><br><h2 id="tldr">  TL; DR </h2><br><p>  We automate access to resources through your existing tunnel, using a copy of the registry and BGP protocol.  The goal is to remove all traffic addressed to blocked resources to the tunnel.  Minimum explanation, mostly step by step instructions. </p><br><h2 id="chto-vam-dlya-etogo-potrebuetsya">  What do you need for this? </h2><br><p>  Unfortunately, this post is not for everyone.  In order to use this technique, you will need to bring together several elements: </p><br><ol><li>  You must have a linux server somewhere outside the lock box.  Or at least the desire to have such a server - the benefit is it now costs from $ 9 / year, and perhaps less.  The method is also suitable if you have a separate VPN tunnel, then the server can be located inside the blocking field. </li><li>  Your router must be smart enough to be able to <br><ul><li>  Any VPN client you like (I prefer OpenVPN, but this could be PPTP, L2TP, GRE + IPSec, and any other option that creates a tunnel interface); </li><li>  BGPv4 protocol.  Which means that for SOHO it can be Mikrotik or any router with OpenWRT / LEDE / similar custom firmware, allowing you to install Quagga or Bird.  Using a PC router is also not forbidden.  In the case of an enterprise, see the BGP support in the documentation for your border router. </li></ul></li><li>  You should have an understanding of the use of Linux and network technologies, including the BGP protocol.  Or at least want to get such an idea.  Since I am not ready to embrace the immense this time, you will have to study some incomprehensible moments for you on your own.  However, of course, I will answer specific questions in the comments and are unlikely to be the only one to answer, so do not hesitate to ask. </li></ol><br><h2 id="chto-ispolzuetsya-v-primere">  What is used in the example </h2><br><ul><li>  A copy of the registry - from <a href="https://github.com/zapret-info/z-i">https://github.com/zapret-info/zi</a> </li><li>  <a href="https://www.ubuntu.com/">VPS - Ubuntu 16.04</a> </li><li>  Routing Service - <a href="http://bird.network.cz/">bird 1.6.3</a> </li><li>  Router - <a href="https://mikrotik.com/product/RB962UiGS-5HacT2HnT">Mikrotik hAP ac</a> </li><li>  Working folders - since we work from the root, most of all will be placed in the home folder of the root.  Respectively: <br><ul><li>  / root / blacklist - working folder with compilation script </li><li>  / root / zi - registry copy with github </li><li>  / etc / bird - standard bird service settings folder </li></ul></li><li>  The external IP address of the VPS with the routing server and the tunnel termination point is 194.165.22.146, ASN 64998;  external IP-address of the router - 81.177.103.94, ASN 64999 </li><li>  The IP addresses inside the tunnel are 172.30.1.1 and 172.30.1.2, respectively. </li></ul><br><p><img src="https://habrastorage.org/webt/bl/dp/iq/bldpiqe7mg7qgikqpodxl1udykg.png" alt="image"></p><br><p>  Of course, you can use any other routers, operating systems and software products, adjusting the decision according to their logic. </p><br><h2 id="kratko---logika-resheniya">  Briefly - decision logic </h2><br><ol><li>  Preparatory actions <br><ol><li>  We get VPS </li><li>  Raise the tunnel from the router to the VPS </li></ol></li><li>  We receive and regularly update the copy of the registry </li><li>  Install and configure the routing service </li><li>  Create a list of static routes for the routing service based on the registry </li><li>  We connect the router to the service and configure sending all the traffic through the tunnel. </li></ol><br><h2 id="sobstvenno-reshenie">  Actually the decision </h2><br><h3 id="podgotovitelnye-deystviya">  Preparatory actions </h3><br><p>  In the vastness of the network there are many services that provide VPS for extremely reasonable money.  So far I have found and use the option for $ 9 / year, but even if I don‚Äôt really bother, there are a lot of options for 1E / month on every corner.  The question of choosing a VPS is far beyond the scope of this article, so if someone doesn‚Äôt understand something about this, ask in the comments. </p><br><p>  If you use VPS not only for the routing service, but also for the tunnel termination on it - you need to raise this tunnel and, almost unambiguously, configure NAT for it.  There are a large number of instructions on these actions in the network, here I will not repeat them.  The main requirement for such a tunnel is that it must create a separate interface on your router supporting the tunnel in the direction of the VPS.  Most of the VPN technologies used meet this requirement ‚Äî for example, OpenVPN in tun mode is perfect. </p><br><h3 id="poluchenie-kopii-reestra">  Getting a copy of the registry </h3><br><p>  As Jabrail said, "He who bothers us will help us."  Since the VKN creates a registry of prohibited resources, it would be a sin to not use this registry to solve our problem.  We will receive a copy of the registry with github. </p><br><p>  We go to your Linux server, fall into the root context ( <em>sudo su -</em> ) and install git if it is not already installed. </p><br><pre><code>apt install git</code></pre><br>
<p>       .</p><br>
<pre><code>cd ~ &amp;&amp; git clone --depth=1 https://github.com/zapret-info/z-i&nbsp;</code></pre><br>
<p>    (    20 ,        ).    <em>crontab -e</em>      :</p><br>
<pre><code>*/20 * * * * cd ~/z-i &amp;&amp; git pull &amp;&amp; git gc</code></pre><br>
<p> ,          .     <em>/root/z-i/.git/hooks/post-merge</em>   :</p><br>
<pre><code>#!/usr/bin/env bash
changed_files="$(git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD)"
check_run() {
    echo "$changed_files" | grep --quiet "$1" &amp;&amp; eval "$2"
}
check_run dump.csv "/root/blacklist/makebgp"</code></pre><br>
<p>     </p><br>
<pre><code>chmod +x /root/z-i/.git/hooks/post-merge</code></pre><br>
<p> makebgp,    ,    .</p><br>
<h3 id="ustanovka-i-nastroyka-servisa-marshrutizacii">    </h3><br>
<p> bird.  ,    Ubuntu     bird      ,         PPA  .</p><br>
<pre><code>add-apt-repository ppa:cz.nic-labs/bird
apt update
apt install bird</code></pre><br>
<p>    bird  IPv6 ‚Äî        .</p><br>
<pre><code>systemctl stop bird6
systemctl disable bird6</code></pre><br>
<p>      bird (<em>/etc/bird/bird.conf</em>),     (   ,            )</p><br>
<pre><code>log syslog all;
router id 172.30.1.1;

protocol kernel {
        scan time 60;
        import none;
#       export all;   # Actually insert routes into the kernel routing table
}

protocol device {
        scan time 60;
}

protocol direct {
        interface "venet*", "tun*"; # Restrict network interfaces it works with
}

protocol static static_bgp {
        import all;
        include "pfxlist.txt";
        #include "iplist.txt";
}

protocol bgp OurRouter {
        description "Our Router";
        neighbor 81.177.103.94 as 64999;
        import none;
        export where proto = "static_bgp";
        local as 64998;
        passive off;
        multihop;
}
</code></pre><br>
<p>router id ‚Äî  ,    IPv4-,    .        32-    IPv4-,        IPv4-   (   VPS). </p><br>
<p>protocol direct ,       .      ,    .     ,           IPv4-. </p><br>
<p>protocol static ‚Äî  ,        ip- (   , ,   /32)   .     ‚Äî   .  ,   ip-   ,   ‚Äî   .  ,        78 ,    ip- ‚Äî 85898.         ,         ip ‚Äî      .        85     .</p><br>
<p>protocol bgp, ,  bgp-   . ip- ‚Äî      (      ), 64998  64999 ‚Äî   .          16- ,       AS   ,  RFC6996 ‚Äî 64512-65534  (  32- ASN,       ).    eBGP ,           . </p><br>
<p>   ,    IP- ,        private (RFC1918)  shared (RFC6598) ,         ,        . </p><br>
<p>  ,            ‚Äî        protocol bgp   IP- .          ,   .     ,   IP-  .</p><br>
<h3 id="obrabotka-reestra-dlya-servisa-marshrutizacii">    </h3><br>
<p>  , ,     ip-,       protocol static.               ,   <em>/root/blacklist/makebgp</em></p><br>
<pre><code>#!/bin/bash
cut -d";" -f1 /root/z-i/dump.csv| tr '|' '\n' |  tr -d ' ' &gt; /root/blacklist/tmpaddr.txt
cat /root/blacklist/tmpaddr.txt | grep / | sed 's_.*_route &amp; reject;_' &gt; /etc/bird/pfxlist.txt
cat /root/blacklist/tmpaddr.txt | sort | uniq | grep -Eo "([0-9]{1,3}[\.]){3}[0-9]{1,3}" | sed 's_.*_route &amp;/32 reject;_' &gt; /etc/bird/iplist.txt
/etc/init.d/bird reload
logger 'bgp list compiled'</code></pre><br>
<p>    </p><br>
<pre><code>chmod +x /root/blacklist/makebgp</code></pre><br>
<p>          /etc/bird. </p><br>
<p> ,    bird    ,         ,    .     ,   :</p><br>
<pre><code>systemctl start bird
birdc show route</code></pre><br>
<p>      80  (   ,    ,         )   :</p><br>
<pre><code>54.160.0.0/12      unreachable [static_bgp 2018-04-19] * (200)</code></pre><br>
<p></p><br>
<pre><code>birdc show protocol</code></pre><br>
<p>    .      (.  ),  OurRouter    start ( Connect  Active),        up ( Established). ,         :</p><br>
<pre><code>BIRD 1.6.3 ready.
name     proto    table    state  since       info
kernel1  Kernel   master   up     2018-04-19
device1  Device   master   up     2018-04-19
static_bgp Static   master   up     2018-04-19
direct1  Direct   master   up     2018-04-19
RXXXXXx1 BGP      master   up     13:10:22    Established
RXXXXXx2 BGP      master   up     2018-04-24  Established
RXXXXXx3 BGP      master   start  2018-04-22  Connect       Socket: Connection timed out
RXXXXXx4 BGP      master   up     2018-04-24  Established
RXXXXXx5 BGP      master   start  2018-04-24  Passive
</code></pre><br>
<h3 id="podklyuchenie-routera"> </h3><br>
<p> , ,    ,   ‚Äî  .  ,           ‚Äî      . </p><br>
<p>    .   ‚Äî  BGP-       nexthop,     (     p2p )  ip- ,      ethernet). </p><br>
<p>,  Mikrotik  RouterOS    </p><br>
<pre><code>/routing bgp instance set default as=64999 ignore-as-path-len=yes router-id=172.30.1.2
/routing bgp peer add in-filter=dynamic-in multihop=yes name=VPS remote-address=194.165.22.146 remote-as=64998 ttl=default
/routing filter add action=accept chain=dynamic-in protocol=bgp comment="Set nexthop" set-in-nexthop=172.30.1.1</code></pre><br>
<p>  Cisco IOS ‚Äî  </p><br>
<pre><code>router bgp 64999
  neighbor 194.165.22.146 remote-as 64998
  neighbor 194.165.22.146 route-map BGP_NEXT_HOP in
  neighbor 194.165.22.146 ebgp-multihop 250
!
route-map BGP_NEXT_HOP permit 10
  set ip next-hop 172.30.1.1</code></pre><br>
<p>  ,          BGP-,     ,  nexthop  ,     .     ‚Äî      .</p><br>
<p>        ,     ‚Äî   ,  . </p><br>
<p> ,     BGP-,         ,         ,      bird     ,   ip-,   </p><br>
<pre><code>systemctl reload bird</code></pre><br>
<p> ,      85  .     ,     :) </p><br>
<h2 id="itogo"></h2><br>
<p>         ,         IP-   .</p><br>
<p>, ,  . ,      ip-    perl  python.    perl,     Net::CIDR::Lite,  85    60 ( ), , ,     ,  . </p><br>
<p>       ISO/OSI,       /,       ,    .      github   nxdomain.txt,          , ,  SwitchyOmega  Chrome. </p><br>
<p>  ,     ,      ,    -    (,     -   ).              ,       ,      .</p><br>
<p>   ‚Äî ,  .</p><br>
<p>UPD.  <a href="https://habr.com/users/navion/" class="user_link">navion</a>  <a href="https://habr.com/users/teranyu/" class="user_link">TerAnYu</a>    git,    .</p><br>
<p>UPD2. , ,   ,          VPS  .     .<br>
      ‚Äî ,           VPN-         (,       ).        ,        .         ,    "  OpenVPN"     ,   VPS,  "  OpenVPN"     ‚Äî  ,        ,      .</p><br>
<p>UPD3. <a href="https://habr.com/users/unsacrificed/" class="user_link">Unsacrificed</a>  ,    dump.csv    bird    ip-.   "    "      . <a href="https://habr.com/post/354282/">https://habr.com/post/354282/#comment_10782712</a></p><br>
<p>UPD4.     (   ):<br>
1)  <em>systemctl reload bird</em>     <em>birdc configure</em>.<br>
2)   Mikrotik     IP    <em>/routing filter add action=accept chain=dynamic-in protocol=bgp comment="Set nexthop" set-in-nexthop=172.30.1.1</em>        ,   <em>/routing filter add action=accept chain=dynamic-in protocol=bgp comment="Set nexthop" set-in-nexthop-direct=&lt; &gt;</em></p><br>
<p>UPD5.    <a href="https://antifilter.download/"></a><a href="https://antifilter.download/">https://antifilter.download</a>,       ip-.    .           "route‚Ä¶ reject".<br>
  , ,       .</p><br>
<p>UPD6.     ,    ,    ‚Äî <a href="https://habr.com/post/359268/"></a>.</p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/354282/">https://habr.com/ru/post/354282/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../354270/index.html">Insolence and enthusiasm for rapid growth from Aviasales</a></li>
<li><a href="../354274/index.html">Using libpam when setting up SOCKS Dante server</a></li>
<li><a href="../354276/index.html">"End of the World" will not be</a></li>
<li><a href="../354278/index.html">Right-sided assignment and other unusual programming techniques in C #</a></li>
<li><a href="../354280/index.html">Javascript es6: write less - do more</a></li>
<li><a href="../354284/index.html">Basics of programming on the SAS Base. Lesson 3. Reading text files</a></li>
<li><a href="../354286/index.html">ESET: Lazarus Cyber ‚Äã‚ÄãGroup Switches to Central America</a></li>
<li><a href="../354290/index.html">Summ3r 0f h4ck: Digital Security Internship 2018</a></li>
<li><a href="../354292/index.html">Developing a game server on Nadron</a></li>
<li><a href="../354294/index.html">PYCON RUSSIA 2018 will be held July 22-23. Save the date</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>