<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Software raids: migration from Windows raid0 to Linux mdadm raid5</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A report on how we migrated from Windows raid0 to Linux raid5, which pitfalls we met and how we overcame them. 

 Prehistory. The design department is...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Software raids: migration from Windows raid0 to Linux mdadm raid5</h1><div class="post__text post__text-html js-mediator-article">  A report on how we migrated from Windows raid0 to Linux raid5, which pitfalls we met and how we overcame them. <br><a name="habracut"></a><br>  Prehistory.  The design department is served by a file server running Windows 2003. Initially, it was designed to exchange data, but over time it was used to store files for a long time, despite the fact that it had a software raid0.  The time has come for the next hardware upgrade.  After the purchase, ‚Äúunexpectedly‚Äù it turned out that the new Windows 2003 motherboard does not start, the driver manufacturer does not release and recommends using a newer version of Windows, which is unacceptable for licensing reasons. <br><br>  As a result, two decisions were made: <br><ul><li>  Move server to virtual machine under KVM </li><li>  Use raid5 for storing data. </li></ul><br>  There are no questions about virtualization - it was done more than once.  The main problem is the zero raid, organized by means of Windows.  Time was spent trying to mount windows-raid0 in linux - failed, despite descriptions on the Internet that it was possible. <br><br>  The second problem: on the Windows server, the hard drives for raid0 are two, 2TB each, the entire array is filled with data and there is nowhere to copy them.  New winchesters also bought two but already at 3TB.  The management of the department initially wanted to attach them to the existing zero raid and get a virtual disk for storing data in 10TB. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      By explaining, we managed to convince of the incorrectness of this approach, but we could not convince the third hard drive to be purchased on 3TB, so we decided to act in sequence: <br><br>  1) Build a raid5 with one missing hard drive <br><br><pre><code class="hljs objectivec">mdtest<span class="hljs-meta"><span class="hljs-meta"># mdadm --create /dev/md4 -l 5 -n 3 /dev/sda1 /dev/sdb1 missing</span></span></code> </pre> <br>  2) Transfer raid5 to Windows and copy it using its means <br><br>  3) Upon completion of copying from the remaining disks, assemble raid0 and transfer it as the third block device to raid5 <br><br><pre> <code class="hljs objectivec">mdtest<span class="hljs-meta"><span class="hljs-meta"># mdadm --create /dev/md3 -l 0 -n 2 /dev/sdc1 /dev/sdd1 mdtest# mdadm --add /dev/md4 /dev/md3</span></span></code> </pre> <br>  We tested this option in a virtual machine with a smaller amount of data - everything turns out great, after completing the test we have raid5, we perform several hard reboots, disable-enable virtual hard drives - the raid lives as expected - self-healing and no data loss. <br><br>  It is very embarrassing that, after the data is copied, there is a degraded array and it is restored due to the two hard drives from which they were copied, in the event of a failure at this stage - the complete loss of all information.  So you need the data somewhere previously backed up.  But everything is complicated by the fact that there are only two 1TB of free hard drives.  The situation is heating up, in the morning the data on the server should be at least read access. <br><br>  The audit of other servers showed that we have a server with 2TB of free space, this saves the situation, we can save the image of one of the two 2TB hard drives and use raid5 to restore it in the stripe with the 1TB hard drive, in case of a failure all data is safe.  The final scheme: <br><br> <code>/dev/md3 - raid0: 1TB + 2TB</code> <br> <code>/dev/md4 - raid5: 2x3TB + /dev/md3</code> <br> <br><h5>  Getting to action on real data </h5><br>  We assemble raid5 without one hard drive, run Windows 2003 for Linux in KVM, start copying and see that the write speed is very low 3-6MB / s, while writing from under Linux to the same degraded raid5 (three times the amount of data from RAM) at an average speed of 80MB / s, but due to the fact that the original data can be copied only from under Windows, this does not help.  Yes, we know that the write speed on a degraded raid5 is reduced, but where does the difference between Linux and Windows come from? <br><br>  For the test, we tried to copy data from a Windows disk to a single disk - 100MB / s.  Maybe the implementation of mdadm is such that Windows feels bad in writing operations in the raid?  It is unlikely - we have several Windows running on top of raid1 compiled into mdadm.  For the sake of experiment we collected raid1, the speed of copying from under Windows in the same range as on a single disk is about 100MB / s. <br><br>  Our mistakes are that we believed the article where it was stated from the context: ‚Äúinitially assembled in mdadm raid5 from two hard drives and one missing is zero-raid implementation‚Äù, and also that we only tested under Linux, we start copying during tests from - Under Windows, the problem was known before. <br><br>  <i>The test environment should be fully productive</i> . <br><br><h5>  Back to the tests </h5><br>  The decision is made to assemble raid0 from two 3TB hard drives, copy the data, and then rebuild this array into raid5. <br><br>  1) Create raid0 <br><br><pre> <code class="hljs objectivec">mdtest<span class="hljs-meta"><span class="hljs-meta"># mdadm --create /dev/md4 -l 0 -n 2 /dev/sda1 /dev/sdb1</span></span></code> </pre> <br>  2) Copy the data, this time from under Windows, the write speed is 60-100MB / s <br><br>  3) Convert raid0 to raid1 <br><br><pre> <code class="hljs delphi">mdtest# mdadm /dev/md4 --grow --level=<span class="hljs-number"><span class="hljs-number">5</span></span> mdadm: level <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> /dev/md4 changed <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> raid5</code> </pre> <br>  This operation is performed instantly. <code>mdadm -D /dev/md4</code> reports that we have raid5 <br><br><pre> <code class="hljs objectivec">mdtest<span class="hljs-meta"><span class="hljs-meta"># mdadm -D /dev/md4 /dev/md4: Raid Level : raid5 Raid Devices : 3 Total Devices : 2 State : clean, degraded Active Devices : 2 Working Devices : 2 Failed Devices : 0 Spare Devices : 0 Number Major Minor RaidDevice State 0 252 0 0 active sync /dev/dm-0 1 252 1 1 active sync /dev/dm-1 2 0 0 2 removed</span></span></code> </pre><br>  4) Add the third block device <br><br><pre> <code class="hljs objectivec">mstest<span class="hljs-meta"><span class="hljs-meta"># mdadm --add /dev/md4 /dev/md3 mdadm: added /dev/md3</span></span></code> </pre> <br>  We look at the status: <br><pre> <code class="hljs objectivec">mdtest<span class="hljs-meta"><span class="hljs-meta"># mdadm -D /dev/md4 /dev/md4: Raid Level : raid5 Raid Devices : 3 Total Devices : 3 State : clean, degraded, recovering Active Devices : 2 Working Devices : 3 Failed Devices : 0 Spare Devices : 1 Rebuild Status : 2% complete Number Major Minor RaidDevice State 0 252 0 0 active sync /dev/dm-0 1 252 1 1 active sync /dev/dm-1 3 252 2 2 spare rebuilding /dev/dm-2</span></span></code> </pre><br>  Tests completed successfully. <br><br><h5>  Actual migration </h5><br><ol><li>  We collected mdadm-raid0 [md4] from two 3TB hard drives. </li><li>  In Windows, the data from windows-raid0 was copied onto mdadm-raid0. </li><li>  Saved the image of the second hard drive from windows-raid0 on a nearby server (2TB). </li><li>  Converted mdadm-raid0 to mdadm-raid5. </li><li>  We collected mdadm-raid0 [md3] from a 1TB disk and a second disk from windows-raid0. </li><li>  Added mdadm-raid5 to the third block device mdadm-raid0 [md3]. </li></ol><br><br><h5>  Notes </h5><br>  During raid5 rebuilding, <a href="http://romanrm.ru/mdadm-raid">optimization</a> was performed to speed up, stripe_cache_size was increased to a maximum of 32768: <code>echo 32768 &gt; /sys/block/md4/md/stripe_cache_size</code> .  Write Intent Bitmap was disabled: <code>mdadm --grow --bitmap=none /dev/md4</code> . <br><br>  If windows-raid0 is filled to the limit, then there is a strong data fragmentation on it, to defragment to 4TB for a long time, we left the position by copying in several streams <a href="http://social.technet.microsoft.com/Forums/windows/en-US/33971726-eeb7-4452-bebf-02ed6518743e/microsoft-richcopy">using Microsoft Richcopy</a> <br><br>  Very sensible tutorials on mdadm commands " <a href="http://xgu.ru/wiki/%25D0%259F%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25BD%25D1%258B%25D0%25B9_RAID_%25D0%25B2_Linux">Software RAID in Linux</a> ". </div><p>Source: <a href="https://habr.com/ru/post/185030/">https://habr.com/ru/post/185030/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../185012/index.html">Interaction with the modem in the Android OS</a></li>
<li><a href="../185014/index.html">On-line broadcast from the Open Day of the JetBrains</a></li>
<li><a href="../185018/index.html">EU court decided to collect tax from printer manufacturers due to possible copyright violations</a></li>
<li><a href="../185020/index.html">PayPal launches Galactic program to prepare payment systems for space commercialization</a></li>
<li><a href="../185022/index.html">QIWI Plastic for you - on special conditions</a></li>
<li><a href="../185032/index.html">Critical review of the study of the availability of Internet resources Runet</a></li>
<li><a href="../185034/index.html">Public beta Sublime Text 3 released</a></li>
<li><a href="../185036/index.html">About the fight against pirates and promotion in the Chinese market of Android applications</a></li>
<li><a href="../185038/index.html">How we did Peat TV</a></li>
<li><a href="../185044/index.html">MySQL bug got a birthday cake</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>