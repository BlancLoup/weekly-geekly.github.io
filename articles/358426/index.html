<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Receiving user data (voluntary)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! We continue our experimental series of articles, watching which you can in real time influence the course of creating a game on UWP. Today o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Receiving user data (voluntary)</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  We continue our experimental series of articles, watching which you can in real time influence the course of creating a game on UWP.  Today on the agenda - getting user data.  Indeed, in almost all applications, this is a necessary procedure.  Join now! <br><br><img src="https://habrastorage.org/webt/8p/vr/ts/8pvrtsu9xoqdearjdnkptp9b1eg.jpeg"><a name="habracut"></a><br><br><ul><li>  <a href="https://habrahabr.ru/company/microsoft/blog/349402/"><b>Part 1: Where to start</b></a> </li><li>  <b><a href="https://habr.com/company/microsoft/blog/351972/">Part 2: Advanced Splash Screen</a></b> </li><li>  <b><a href="https://habr.com/company/microsoft/blog/354426/">Part 3: The style of the mother's son's girlfriend</a></b> </li><li>  <b><a href="https://habr.com/company/microsoft/blog/358426/">Part 4: Receiving user data (voluntary)</a></b> </li><li>  <b><a href="https://habr.com/company/microsoft/blog/414261/">Part 5: Where do you keep the data?</a></b> </li></ul><br>  <i>I give the floor to the author, <a href="https://habrahabr.ru/users/lxgdark/">Alexey Plotnikov</a> .</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      User identification is the cornerstone of most modern applications and, especially, games.  It is difficult to imagine a game without social functions such as rating tables, achievements and clans.  In applications that lack social functions, identification is needed in order, for example, to improve the synchronization process between devices.  For the most part, it was the synchronization problems that became the starting point for my research on this issue. <br><br>  Each UWP application has a dedicated cloud storage (roaming data), in which it can save data available from any device, provided that the user uses the same MS account.  Unfortunately, this repository has some serious limitations. <br><br>  First, the data that can be placed in the cloud is limited in size.  For most tasks, the allocated size is sufficient, but this is still a limitation.  A far more important limitation is the principle of putting data into the cloud.  The internal algorithm of this function takes into account many factors such as, for example, energy saving or limited Internet connection and ultimately the synchronization process between devices can not only take more than ten minutes, but is not guaranteed at all (more <a href="https://docs.microsoft.com/ru-ru/windows/uwp/design/app-settings/store-and-retrieve-app-data">here</a> ). <br><br>  Such restrictions are completely unsuitable for my tasks, so it was decided to implement the synchronization process on my own and the first thing I faced was the issue of identifying devices belonging to the same player. <br><br>  Many games and applications use the Facebook account for synchronization, although in most cases this is due to the transfer of existing algorithms to the Microsoft Store, and not the convenience of implementation.  Others have their own services, in which the player needs to register, but this is also an unnecessary complication.  As a result, the most logical solution is, of course, to use a Microsoft account, which the user definitely has, since without it, it is impossible to purchase and install applications from the Windows store.  It remains the case for small - to obtain user data to identify it on different devices. <br><br>  Delving into the question, I learned that Microsoft account data is obtained using the Microsoft Live API, which is associated with some difficulties.  The fact is that in order to receive any data about the user, he must log in to his account, and we must get an access token, which will allow us to request them.  This procedure is designed for security and is part of the <a href="https://ru.wikipedia.org/wiki/OAuth">OAuth</a> authentication standard, but its self-implementation for novice developers seems complicated and inconvenient. <br><br>  Fortunately, the creators of UWP understood the potential horror that OAuth can cause a novice developer and created an elegant and fairly simple way to work with a Microsoft account (and not only).  This tool is called "Account Manager Web Accounts" and that is what we consider next. <br><br>  Create an empty project and replace the head grid in the MainPage.xaml file with the following XAML: <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">HorizontalAlignment</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Center"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">VerticalAlignment</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Center"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"LoginButton"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"LoginButton_Click"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextBlock</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UserIdTextBlock"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextBlock</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UserNameTextBlock"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Image</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UserAvatarImage"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"50"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  XAML is quite simple and does not require an explanation, so go to the event of pressing the button and insert the following code: <br><br><pre> <code class="xml hljs">AccountsSettingsPane.Show()</code> </pre> <br>  Do not forget to add the import of the Windows.UI.ApplicationSettings namespace, otherwise this code will not work. <br><br>  Now the application can be executed and look at the result. <br><br><img src="https://habrastorage.org/webt/xv/an/fs/xvanfss1vdulzinru56wcgf7m6o.png"><br><br>  An empty window is not exactly what we expected, but it is just a shell that you first need to fill.  We will fill it with so-called ‚Äúteams‚Äù, which in our case will be a list of accounts available for entry. <br><br>  The Web Account Manager tool is very flexible and allows you to create these commands either manually or download them from the required provider.  In the second case, the FindAccountProviderAsync function is used, where the ‚Äú <a href="https://login.microsoft.com/">login.microsoft.com</a> ‚Äù address <a href="https://login.microsoft.com/">acts as the account provider</a> . <br><br>  However, it is impossible to fill the panel with commands before it is initialized, so the first thing to do is to subscribe to the corresponding event.  Add this line before the panel display code and immediately create the procedure called by the event: <br><br><pre> <code class="cs hljs">AddHandler AccountsSettingsPane.GetForCurrentView().AccountCommandsRequested, AddressOf BuildPaneAsync ‚Ä¶ <span class="hljs-function"><span class="hljs-function">Private Sub </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuildPaneAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sender As AccountsSettingsPane, e As AccountsSettingsPaneCommandsRequestedEventArgs</span></span></span><span class="hljs-function">) '     End Sub</span></span></code> </pre> <br>  By the way, in the official manual, a subscription to the AccountCommandsRequested event occurs at the moment of switching to the current page, and the reply is made when switching from it.  It makes sense if you select a separate page for the authentication process, but I think this approach is not flexible enough. <br><br>  Fill BuildPaneAsync: <br><br><pre> <code class="cs hljs">Dim Deferral = e.GetDeferral Dim msaProvider = Await WebAuthenticationCoreManager.FindAccountProviderAsync(<span class="hljs-string"><span class="hljs-string">"https://login.microsoft.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"consumers"</span></span>) Dim command = <span class="hljs-function"><span class="hljs-function">New </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WebAccountProviderCommand</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">msaProvider, AddressOf GetMsaTokenAsync</span></span></span><span class="hljs-function">) e.WebAccountProviderCommands.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">command</span></span></span><span class="hljs-function">) Deferral.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Complete</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span></code> </pre> <br>  And immediately perform a few additional actions: <br><br><ul><li>  Add the Async keyword to the procedure; </li><li>  Add import of the Windows.Security.Authentication.Web.Core namespace; </li><li>  Create a GetMsaTokenAsync procedure with a command parameter of type WebAccountProviderCommand </li></ul><br>  We will deal with this code.  First, since it may take time to get the list of commands, we need to delay the display of the panel until it is full.  For this, a deferred Deferral object is created.  Next, using the previously mentioned function FindAccountProviderAsync, the provider is loaded.  Note that a parameter with the value "consumers" is also passed to this function.  This tells the vendor that we want to get a standard Microsoft account, not an organization account (then there would be ‚Äúorganizations‚Äù). <br><br>  After we create a new command using the received provider, specify the procedure that is called when you click on the command, and add the result to the panel.  The last line we inform that the panel is formed and it can be displayed. <br><br><img src="https://habrastorage.org/webt/bx/bj/oq/bxbjoqm-xlilrjxcvxyvpuupfus.png"><br><br>  Now, after launching and clicking on the ‚ÄúLogin‚Äù button, a filled-in panel with several login options is displayed.  You may be confused by the fact that we added one command to the panel, but there are two on it.  In fact, this is another reason why I like the ‚ÄúWeb Account Manager‚Äù, as it has independently determined the current user account and suggested it as the main login option, and in case the user wants to use another account, it‚Äôs created separate option.  From the point of view of internal logic, both options are identical and ultimately send us to the GetMsaTokenAsync procedure that we created earlier. <br><br>  Further actions can be divided into several stages.  First, inside GetMsaTokenAsync, you need to make a request to the data provider indicating the type of data we request, and then form the result of this request: <br><br><pre> <code class="cs hljs">Dim request As WebTokenRequest = <span class="hljs-function"><span class="hljs-function">New </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WebTokenRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">command.WebAccountProvider, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"wl.basic"</span></span></span></span></span><span class="hljs-function">) Dim result As WebTokenRequestResult</span></span> = Await WebAuthenticationCoreManager.RequestTokenAsync(request)</code> </pre> <br>  Notice the ‚Äúwl.basic‚Äù parameter that is passed to the first function.  This is an indication of the permissions that the application receives when working with user data.  By specifying different permissions, we can work with the address book, calendar, photos, and many other data, but we need only the name, avatar, and user ID, so wl.basic is used, which is sufficient in this case.  Full list of permissions can be found <a href="https://msdn.microsoft.com/ru-ru/library/hh243646.aspx">here</a> . <br><br>  After successfully obtaining the result of the request, we can create an object of type WebAccount, which will help to get access tokens for the account: <br><br><pre> <code class="cs hljs">If result.ResponseStatus = WebTokenRequestStatus.Success Then Dim account As WebAccount = result.ResponseData(<span class="hljs-number"><span class="hljs-number">0</span></span>).WebAccount ApplicationData.Current.LocalSettings.Values(<span class="hljs-string"><span class="hljs-string">"CurrentUserProviderId"</span></span>) = account.WebAccountProvider.Id ApplicationData.Current.LocalSettings.Values(<span class="hljs-string"><span class="hljs-string">"CurrentUserId"</span></span>) = account.<span class="hljs-function"><span class="hljs-function">Id </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BackgroundConnectUser</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) End If</span></span></code> </pre> <br>  To use this code, you will need to import the <i>Windows.Security.Credentials</i> and <i>Windows.Storage</i> namespaces. <br><br>  The resulting markers are relevant for the current user for a long time, which means we do not need to repeat the login procedure all the time.  Instead, we save these tokens to the local settings of the application, in order to use them in the future for background authentication.  Actually, we proceed to background authentication by calling the BackgroundConnectUser procedure. <br><br>  First, add the imports that we need to work further code: <br><br><pre> <code class="cs hljs">Imports System.Net.Http Imports Windows.Data.Json</code> </pre> <br>  Now go to BackgroundConnectUser and load the saved tokens: <br><br><pre> <code class="cs hljs">Dim providerId As String = ApplicationData.Current.LocalSettings.Values(<span class="hljs-string"><span class="hljs-string">"CurrentUserProviderId"</span></span>) Dim accountId As String = ApplicationData.Current.LocalSettings.Values(<span class="hljs-string"><span class="hljs-string">"CurrentUserId"</span></span>)</code> </pre> <br>  If the markers are not empty, then we form the provider and account objects from them to get the token, and also execute the query: <br><br><pre> <code class="cs hljs">Dim provider As WebAccountProvider = Await WebAuthenticationCoreManager.FindAccountProviderAsync(providerId) Dim account As WebAccount = Await WebAuthenticationCoreManager.FindAccountAsync(provider, accountId) Dim request As WebTokenRequest = <span class="hljs-function"><span class="hljs-function">New </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WebTokenRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">provider, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"wl.basic"</span></span></span></span></span><span class="hljs-function">) Dim result As WebTokenRequestResult</span></span> = Await WebAuthenticationCoreManager.GetTokenSilentlyAsync(request, account)</code> </pre> <br>  In case of success, you can get an API access token and execute immediate requests: <br><br><pre> <code class="cs hljs">If result.ResponseStatus = WebTokenRequestStatus.Success Then Dim token As String = result.ResponseData(<span class="hljs-number"><span class="hljs-number">0</span></span>).Token Dim restApi = <span class="hljs-function"><span class="hljs-function">New </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Uri</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"https://apis.live.net/v5.0/me?access_token="</span></span></span></span><span class="hljs-function"><span class="hljs-params"> + token</span></span></span><span class="hljs-function">) Dim client</span></span> = <span class="hljs-function"><span class="hljs-function">New </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HttpClient</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) Dim infoResult</span></span> = Await client.GetAsync(restApi) Dim Content As String = Await infoResult.Content.ReadAsStringAsync() Dim jsonO = JsonObject.Parse(Content) UserIdTextBlock.Text = jsonO(<span class="hljs-string"><span class="hljs-string">"id"</span></span>).GetString UserNameTextBlock.Text = jsonO(<span class="hljs-string"><span class="hljs-string">"name"</span></span>).GetString UserAvatarImage.Source = <span class="hljs-function"><span class="hljs-function">New </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BitmapImage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">New Uri(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"https://apis.live.net/v5.0/me/picture?access_token="</span></span></span></span><span class="hljs-function"><span class="hljs-params"> + token</span></span></span><span class="hljs-function">)) End If</span></span></code> </pre> <br>  Addresses of requests for receiving user data can be found in the Microsoft Live API documentation, but we are only interested in two: ‚Äúhttps://apis.live.net/v5.0/me‚Äù for general data and ‚Äúhttps: // apis. live.net/v5.0/me/picture ‚Äùto get an avatar.  The user data is returned in Json format, so a parser is used for convenient parsing. <br><br>  Finally, you can run the program and make sure that nothing works anyway.  This is due to the fact that the Microsoft Live API does not provide data just like that.  To use them, an application must have an identifier in Microsoft Live to which data access permissions are then bound.  Fortunately, the identifier is generated automatically when creating a new application in the developer‚Äôs dashboard.  To download this identifier in the current project, simply connect it with the Windows store.  To do this, go to the menu "Project&gt; Store&gt; Link application to Store ..." and select the desired name from the list (or register a new one).  We don‚Äôt need to do anything else, because the necessary data in the Microsoft Live API will be transferred automatically. <br><br>  Re-run the project and finally see the result. <br><br><img src="https://habrastorage.org/webt/vy/lx/my/vylxmy8essj0q3y0wyykhradhsu.png"><br><br>  At this point, consideration of receiving user data could be completed if I set myself the goal of simply retelling material from the official manual. <br><br>  Below, I will give the complete code of the project with the changes made, and then I will explain every valid change and justify it. <br><br>  XAML: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">HorizontalAlignment</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Center"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">VerticalAlignment</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Center"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel.Resources</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">local:ConnectStatusToEnabledConverter</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ConnectStatusToEnabledConverter"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel.Resources</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Orientation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Horizontal"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"LoginButton"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"LoginButton_Click"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IsEnabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding ConnectStatus, Converter={StaticResource ConnectStatusToEnabledConverter}, ConverterParameter=0}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"LogOutButton"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10,0,0,0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"LogOutButton_Click"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IsEnabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding ConnectStatus, Converter={StaticResource ConnectStatusToEnabledConverter}, ConverterParameter=2}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextBlock</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0,0,0,20"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding ConnectStatus}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextBlock</span></span></span><span class="hljs-tag">&gt;</span></span> : <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Run</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">FontWeight</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Bold"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding UserId}"</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextBlock</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextBlock</span></span></span><span class="hljs-tag">&gt;</span></span> : <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Run</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">FontWeight</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Bold"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding UserName}"</span></span></span><span class="hljs-tag">/&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextBlock</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Image</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"50"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Source</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{Binding UserAvatar}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">HorizontalAlignment</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Left"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackPanel</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Window Code</b> <div class="spoiler_text"><pre> <code class="cs hljs">Imports Windows.Security.Authentication.Web.Core Imports Windows.UI.ApplicationSettings Imports Windows.Security.Credentials Imports Windows.Storage Imports System.Net.Http Imports Windows.Data.Json Imports Windows.<span class="hljs-function"><span class="hljs-function">System Public NotInheritable Class MainPage Inherits Page Private CurUser As New UserManager Private Sub </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainPage_Loaded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sender As Object, e As RoutedEventArgs</span></span></span><span class="hljs-function">) Handles Me.Loaded DataContext</span></span> = <span class="hljs-function"><span class="hljs-function">CurUser End Sub Private Async Sub </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoginButton_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sender As Object, e As RoutedEventArgs</span></span></span><span class="hljs-function">) If Not Await CurUser.BackgroundConnectUser Then CurUser.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConnectUser</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) End If End Sub Private Async Sub </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LogOutButton_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sender As Object, e As RoutedEventArgs</span></span></span><span class="hljs-function">) CurUser.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LogOutUser</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Await CurUser.GetWebAccount</span></span></span><span class="hljs-function">) End Sub End Class Public Class UserManager Implements INotifyPropertyChanged #Region " " Public Event </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PropertyChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sender As Object, e As PropertyChangedEventArgs</span></span></span><span class="hljs-function">) Implements INotifyPropertyChanged.PropertyChanged Private Sub </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPropertyChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PropertyName As String</span></span></span><span class="hljs-function">) RaiseEvent </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PropertyChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Me, New PropertyChangedEventArgs(PropertyName</span></span></span><span class="hljs-function">)) End Sub #End Region Private UserIdValue As String Private UserNameValue As String Private UserAvatarValue As BitmapImage Private ConnectStatusValue As UserConnectStatusEnum</span></span> = UserConnectStatusEnum.None <span class="hljs-meta"><span class="hljs-meta">#Region "" ''' &lt;summary&gt; ''' ID   ''' &lt;/summary&gt; ''' &lt;returns&gt;&lt;/returns&gt; Public Property UserId As String Get Return UserIdValue End Get Set(value As String) UserIdValue = value OnPropertyChanged("UserId") End Set End Property ''' &lt;summary&gt; '''    ''' &lt;/summary&gt; ''' &lt;returns&gt;&lt;/returns&gt; Public Property UserName As String Get Return UserNameValue End Get Set(value As String) UserNameValue = value OnPropertyChanged("UserName") End Set End Property ''' &lt;summary&gt; '''   ''' &lt;/summary&gt; ''' &lt;returns&gt;&lt;/returns&gt; Public Property UserAvatar As BitmapImage Get Return UserAvatarValue End Get Set(value As BitmapImage) UserAvatarValue = value OnPropertyChanged("UserAvatar") End Set End Property ''' &lt;summary&gt; '''   ''' &lt;/summary&gt; ''' &lt;returns&gt;&lt;/returns&gt; Public Property ConnectStatus As UserConnectStatusEnum Get Return ConnectStatusValue End Get Set(value As UserConnectStatusEnum) ConnectStatusValue = value OnPropertyChanged("ConnectStatus") End Set End Property #End Region #Region "   " ''' &lt;summary&gt; '''     ''' &lt;/summary&gt; Public Sub ConnectUser() AddHandler AccountsSettingsPane.GetForCurrentView().AccountCommandsRequested, AddressOf BuildPaneAsync AccountsSettingsPane.Show() End Sub Public Async Sub LogOutUser(account As WebAccount) ApplicationData.Current.LocalSettings.Values.Remove("CurrentUserProviderId") ApplicationData.Current.LocalSettings.Values.Remove("CurrentUserId") Await account.SignOutAsync() UserId = "" UserName = "" UserAvatar = New BitmapImage ConnectStatus = UserConnectStatusEnum.None End Sub Public Async Function BackgroundConnectUser() As Task(Of Boolean) Dim result As Boolean = False Dim account As WebAccount = Await GetWebAccount() If account Is Nothing Then Return result ConnectStatus = UserConnectStatusEnum.Logon Dim request As WebTokenRequest = New WebTokenRequest(account.WebAccountProvider, "wl.basic") Dim requestResult As WebTokenRequestResult = Await WebAuthenticationCoreManager.GetTokenSilentlyAsync(request, account) If requestResult.ResponseStatus = WebTokenRequestStatus.Success Then Try Dim token As String = requestResult.ResponseData(0).Token Dim restApi = New Uri("https://apis.live.net/v5.0/me?access_token=" + token) Dim client = New HttpClient() Dim infoResult = Await client.GetAsync(restApi) Dim Content As String = Await infoResult.Content.ReadAsStringAsync() Dim jsonO = JsonObject.Parse(Content) UserId = jsonO("id").GetString UserName = jsonO("name").GetString UserAvatar = New BitmapImage(New Uri("https://apis.live.net/v5.0/me/picture?access_token=" + token)) ConnectStatus = UserConnectStatusEnum.Ssuccessful result = True Catch ex As Exception ConnectStatus = UserConnectStatusEnum.None End Try Else ConnectStatus = UserConnectStatusEnum.None End If Return result End Function #End Region #Region " ,   " ''' &lt;summary&gt; '''      ''' &lt;/summary&gt; ''' &lt;param name="sender"&gt;&lt;/param&gt; ''' &lt;param name="e"&gt;&lt;/param&gt; Private Async Sub BuildPaneAsync(sender As AccountsSettingsPane, e As AccountsSettingsPaneCommandsRequestedEventArgs) RemoveHandler AccountsSettingsPane.GetForCurrentView().AccountCommandsRequested, AddressOf BuildPaneAsync Dim Deferral = e.GetDeferral Dim msaProvider = Await WebAuthenticationCoreManager.FindAccountProviderAsync("https://login.microsoft.com", "consumers") Dim command = New WebAccountProviderCommand(msaProvider, AddressOf GetMsaTokenAsync) e.WebAccountProviderCommands.Add(command) e.HeaderText = "          Microsoft" Dim settingsCmd As SettingsCommand = New SettingsCommand("settings_privacy", " ", Async Sub() Await Launcher.LaunchUriAsync(New Uri("https://privacy.microsoft.com/ru-ru/")) End Sub) e.Commands.Add(settingsCmd) Deferral.Complete() End Sub ''' &lt;summary&gt; '''     ''' &lt;/summary&gt; ''' &lt;param name="command"&gt;&lt;/param&gt; Private Async Sub GetMsaTokenAsync(command As WebAccountProviderCommand) ConnectStatus = UserConnectStatusEnum.Logon Dim request As WebTokenRequest = New WebTokenRequest(command.WebAccountProvider, "wl.basic") Dim result As WebTokenRequestResult = Await WebAuthenticationCoreManager.RequestTokenAsync(request) If result.ResponseStatus = WebTokenRequestStatus.Success Then Dim account As WebAccount = result.ResponseData(0).WebAccount ApplicationData.Current.LocalSettings.Values("CurrentUserProviderId") = account.WebAccountProvider.Id ApplicationData.Current.LocalSettings.Values("CurrentUserId") = account.Id Await BackgroundConnectUser() Else ConnectStatus = UserConnectStatusEnum.None End If End Sub ''' &lt;summary&gt; '''        ''' &lt;/summary&gt; ''' &lt;returns&gt;&lt;/returns&gt; Public Async Function GetWebAccount() As Task(Of WebAccount) Dim providerId As String = ApplicationData.Current.LocalSettings.Values("CurrentUserProviderId") Dim accountId As String = ApplicationData.Current.LocalSettings.Values("CurrentUserId") If (providerId Is Nothing And accountId Is Nothing) Then Return Nothing End If Dim provider As WebAccountProvider = Await WebAuthenticationCoreManager.FindAccountProviderAsync(providerId) Dim account As WebAccount = Await WebAuthenticationCoreManager.FindAccountAsync(provider, accountId) Return account End Function ''' &lt;summary&gt; '''    ''' &lt;/summary&gt; Public Enum UserConnectStatusEnum ''' &lt;summary&gt; '''    ''' &lt;/summary&gt; None = 0 ''' &lt;summary&gt; '''   ''' &lt;/summary&gt; Logon = 1 ''' &lt;summary&gt; '''   ''' &lt;/summary&gt; Ssuccessful = 2 End Enum #End Region End Class Public Class ConnectStatusToEnabledConverter Implements IValueConverter Public Function Convert(value As Object, targetType As Type, parameter As Object, language As String) As Object Implements IValueConverter.Convert Return CStr(parameter).IndexOf(CStr(value)) &gt; -1 End Function Public Function ConvertBack(value As Object, targetType As Type, parameter As Object, language As String) As Object Implements IValueConverter.ConvertBack Throw New NotImplementedException() End Function End Class</span></span></code> </pre> <br></div></div><br>  The page layout has not undergone very large adjustments.  The most important difference is the addition of a logout button, as well as strings to track connection status.  The remaining changes made the mapping of data more visual because in the end, the task of the page is to demonstrate the result of executing the code in which the main changes took place.  Consider them. <br><br>  First of all, I completely took the logic of working with the web account manager into a separate class.  This is done in order to have access to this code from anywhere in the application.  For example, in the article ‚Äú <a href="https://habrahabr.ru/company/microsoft/blog/351972/">Advanced</a> Splash <a href="https://habrahabr.ru/company/microsoft/blog/351972/">Screen</a> ‚Äù I mentioned the lengthy operations that I had to perform inside the splash screen and the process of getting user data in the BackgroundConnectUser is just such an operation. <br><br>  As a result of transferring the code to a separate class, practically nothing remained in the class of the page itself.  All the work inside the page is reduced to the reaction to pressing two buttons and setting the data context for the page (in the procedure MainPage_Loaded).  It is not difficult to guess that the instance of the UserManager class in which the main work already takes place acts as the data context.  The class implements the INotifyPropertyChanged interface, which allows binding to its fields from the page markup. <br><br>  The migrated code received some changes, and I will try to parse them in the same order in which the initial example was created: <br><br><ul><li>  ConnectUser procedure.  It essentially duplicates the code that was previously called by clicking on the "Login" button.  Calling this procedure is needed only if we do not have markers for the background connection. </li><li>  BuildPaneAsync has received some significant, and not so changes.  To begin, unsubscribe from the AccountCommandsRequested event, which we do not need after calling this procedure.  Next comes the already known code, which is complemented by the installation of a subtitle in the dispatcher window and the addition of a link to the privacy policy.  Both of these items are optional and are implemented entirely at your discretion.  Moreover, in the second case, you can add a link that executes any of your code, and it is not necessarily a link to a page with a privacy policy. <br><br><img src="https://habrastorage.org/webt/ue/sx/nw/uesxnwjzzdoxgegtq2gzceabrl4.png"><br><br></li><li>  After clicking on the ‚ÄúContinue‚Äù button, the execution of the GetMsaTokenAsync procedure starts, so the first line in it sets the Logon status, to which you can respond to display progress indicators or block interface elements.  Then comes the code already familiar to us, but with the addition of a reaction to situations where the input was canceled or did not pass successfully.  I admit, over this seemingly banal place I fought the whole day.  The hitch is that when you first execute this code, immediately after the window with the choice of login options, another window appears asking for permission to access the data.  Between switching between these two windows, a relatively long period of time (up to 2 seconds) can pass, therefore it is logical to maintain the Logon status during this period in order to avoid re-pressing the ‚ÄúLogin‚Äù button.  However, the user may refuse to provide access to the data, or simply close the second window (press the "Back" button on the mobile device), so in the case of such actions you need to return the initial status to None, which is what we are doing in the Else block. </li><li>  The BackgroundConnectUser procedure in the new variation has become an asynchronous function, so that we can appropriately respond to an unsuccessful (or successful) attempt to get background data.  Since this function can be called from different places (for example, from the splash screen), we must make sure that the loaded access tokens are not empty.  For the convenience of loading saved markers, a separate GetWebAccount function has been created and, if there are no markers in the local settings, then it returns Nothing.  If the WebAccount object is unsuccessful, we return the default result (False), and if it is received successfully, set the status in the Logon and continue the procedure.  Then we repeat the already known actions with the only difference that in case of a denial of receipt of the token, you need to return the status to None, and with a successful request, Ssuccessful. </li><li>  The LogOutUser procedure contains code not used previously.  It implements the ability to exit your account and delete markers from saved settings.  Be sure to implement this feature in your application, as this will give the user complete freedom in terms of ensuring privacy, not to mention the potential need to log in with other credentials. </li><li>  Well, the last thing to mention is the ConnectStatus property that I created in this class.  This property is of the type of its own enumerator UserConnectStatusEnum and is required to set the login status.  This is an important element of interaction with the class, because by binding to this property we can block buttons that are not desirable to be pressed at the moment of executing certain sections of the code or, on the contrary, unblock those that are available only after completing the input.  So that the binding of the IsEnabled property to ConnectStatus is interpreted correctly, the ConnectStatusToEnabledConverter converter is also created. </li></ul><br>  This is where my implementation for Web Account Manager ends. -      - ,     ,       ,              ,      ,     . <br><br> ,    ,                  .         . </div><p>Source: <a href="https://habr.com/ru/post/358426/">https://habr.com/ru/post/358426/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358412/index.html">Analysis of the VIPER architecture using the example of a small iOS application on Swift 4</a></li>
<li><a href="../358414/index.html">Navigation with architectural components from Google. Part 1. Introduction</a></li>
<li><a href="../358416/index.html">Battle of Net Neutrality: New Hope</a></li>
<li><a href="../358418/index.html">10 years of life and experience of the company "Flant" in one post</a></li>
<li><a href="../358422/index.html">Making the Marketplace integrated into the online cash desk cloud</a></li>
<li><a href="../358428/index.html">What awaits the IaaS market: trends in brief</a></li>
<li><a href="../358432/index.html">How to make Vue.js and Electron work together</a></li>
<li><a href="../358434/index.html">Just add water: H2O.ai development</a></li>
<li><a href="../358436/index.html">Ubuntu DSVM Review: Alchemy</a></li>
<li><a href="../358438/index.html">How not to miss a single message</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>