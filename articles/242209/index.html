<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing plugins with AppDomain is fun</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How often have you written plugins for your applications? 

 In the article I want to tell you how to write plugins using AppDomain, and cross domain ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing plugins with AppDomain is fun</h1><div class="post__text post__text-html js-mediator-article">  How often have you written plugins for your applications? <br><br>  In the article I want to tell you how to write plugins using AppDomain, and cross domain operations.  We will write plugins for my existing TCPChat application. <br><br>  Who wants to bike - go under the cat. <br><a name="habracut"></a><br>  Chat is <a href="https://github.com/Nirklav/TCPChat">here</a> . <br>  And you can read about the architecture of the application <a href="http://habrahabr.ru/post/228021/">here</a> .  In this case, we are only interested in the model.  It has not changed fundamentally, and it will be enough to know about the main entities ( <a href="">Root of the</a> <a href="">model</a> / <a href="">A</a> <a href="">PI</a> / <a href="https://github.com/Nirklav/TCPChat/tree/master/Engine/API/StandardAPI/ClientCommands">Coma</a> <a href="https://github.com/Nirklav/TCPChat/tree/master/Engine/API/StandardAPI/ServerCommands">ndy</a> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>About what needs to be implemented in the application:</b> <br><br>  It is necessary to have a possibility to extend the command set with the help of plug-ins, while the code in plug-ins should be executed in another domain. <br>  Obviously, the commands will not be called by themselves, so you also need to add the ability to change the UI.  To do this, we will provide the ability to add menu items, as well as create your own windows. <br><br>  At the end, I will write a plugin with which you can remotely take a screenshot of any user. <br><br>  <b>What is AppDomain for?</b> <br><br>  The application domain is needed to execute code with limited rights, as well as to unload libraries while the application is running.  As you know, assemblies from the application domain cannot be unloaded, but please, the domain. <br><br>  In order to unload the domain was possible, the interaction between them is minimized. <br>  In fact, we can: <br><ul><li>  Run code in another domain. </li><li>  Create an object and push it by value. </li><li>  Create an object and promote it by reference. </li></ul><br>  <b>A little bit about promotion:</b> <br><br>  Promotion, can occur by reference or value. <br>  Everything is relatively simple with meaning.  The class is serialized in one domain, passed by an array of bytes to another, deserialized, and we get a copy of the object.  In this case, it is necessary that the assembly be loaded into both domains.  If it is necessary that the assembly is not loaded into the main domain, then it is better that the plug-in folder is not added to the folder list where your application will look for the default assembly (AppDomain.BaseDirectory / AppDomainSetup.PrivateBinPath).  In this case, there will be an exception stating that the type could not be found, and you will not receive a silently loaded assembly. <br><br>  To perform a link promotion, the class must implement <a href="http://msdn.microsoft.com/ru-ru/library/system.marshalbyrefobject%2528v%3Dvs.110%2529.aspx">MarshalByRefObject</a> .  For each such object, after calling the CreateInstanceAndUnwrap method, a representative is created in the calling domain.  This is an object that contains all the methods of a real object (there are no fields there).  In these methods, with the help of special mechanisms, it calls the methods of a real object located in another domain and, accordingly, the methods are also performed in the domain in which the object was created.  It is also worth saying that the lifetime of the representatives is limited.  After creation, they live 5 minutes, and after each call of a method, their lifetime becomes 2 minutes.  The lease time can be changed; for this, you can override the <a href="http://msdn.microsoft.com/en-us/library/system.marshalbyrefobject.initializelifetimeservice%2528v%3Dvs.110%2529.aspx">InitializeLifetimeService</a> method in MarshalByRefObject. <br>  Promotion through the link does not require uploading to the main domain of the assembly with a plugin. <br><br>  Retreat about the field: <br>  This is one of the reasons to use not open fields, but properties.  Access to the field through a representative can be obtained, but it all works much more slowly.  Moreover, in order for it to work more slowly, it is not necessary to use cross-domain operations, it is enough to inherit from MarshalByRefObject. <br><br>  <b>More details about code execution:</b> <br><br>  Code execution is performed using the <a href="http://msdn.microsoft.com/en-us/library/system.appdomain.docallback%2528v%3Dvs.110%2529.aspx">AppDomain.DoCallBack ()</a> method. <br>  At the same time, the delegate moves to another domain, so you need to be sure that this is possible. <br>  These are small problems that I stumbled upon: <br><ol><li>  This is an instance method, and the host class cannot be advanced.  As is known, the delegate for each signed method stores 2 main fields, a reference to an instance of the class, and a pointer to the method. </li><li>  You used closures.  By default, the class that creates the compiler is not marked as serializable and does not implement <a href="http://msdn.microsoft.com/ru-ru/library/system.marshalbyrefobject%2528v%3Dvs.110%2529.aspx">MarshalByRefObject</a> .  (Further see paragraph 1) </li><li>  If you inherit a class from MarshalByRefObject, create it in domain 1 and try to execute its instance method in another domain 2, then the domain boundary will be crossed 2 times and the code will be executed in domain 1. </li></ol><br>  <b>Let's get started</b> <br><br>  First of all, you need to know which plug-ins the application can download.  In one assembly there can be several plug-ins, and we need to provide for each plug-in a separate domain.  Therefore, you need to write an information loader, which will also work in a separate domain, and after the loader has completed its work, this domain will be unloaded. <br><br>  The structure for storing the boot information about the plugin is marked with the Serializable attribute, since  it will be promoted between domains. <br><pre><code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">Serializable</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> PluginInfo { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> assemblyPath; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> typeName; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PluginInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> assemblyPath, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> typeName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.assemblyPath = assemblyPath; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.typeName = typeName; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AssemblyPath { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> assemblyPath; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TypeName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> typeName; } } }</code> </pre> <br><br>  Loader information itself.  You can note that the Proxy class is inherited from MarshalByRefObject, because  its fields will be used for input and output parameters.  And he will be created in the bootloader domain. <br><br><pre> <code class="hljs cs"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PluginInfoLoader</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Proxy</span></span> : <span class="hljs-title"><span class="hljs-title">MarshalByRefObject</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] PluginLibs { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FullTypeName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;PluginInfo&gt; PluginInfos { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadInfos</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> assemblyPath <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> PluginLibs) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> assembly = AppDomain.CurrentDomain.Load(AssemblyName.GetAssemblyName(assemblyPath).FullName); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> type <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> assembly.GetExportedTypes()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type.IsAbstract) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentBaseType = type.BaseType; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (currentBaseType != <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(currentBaseType.FullName, FullTypeName, StringComparison.OrdinalIgnoreCase) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { PluginInfos.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PluginInfo(assemblyPath, type.FullName)); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } currentBaseType = currentBaseType.BaseType; } } } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;PluginInfo&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadFrom</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> typeName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] inputPluginLibs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> domainSetup = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AppDomainSetup(); domainSetup.ApplicationBase = AppDomain.CurrentDomain.BaseDirectory; domainSetup.PrivateBinPath = <span class="hljs-string"><span class="hljs-string">"plugins;bin"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> permmisions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PermissionSet(PermissionState.None); permmisions.AddPermission(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReflectionPermission(ReflectionPermissionFlag.MemberAccess)); permmisions.AddPermission(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SecurityPermission(SecurityPermissionFlag.Execution)); permmisions.AddPermission(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UIPermission(UIPermissionWindow.AllWindows)); permmisions.AddPermission(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileIOPermission(FileIOPermissionAccess.PathDiscovery | FileIOPermissionAccess.Read, inputPluginLibs)); List&lt;PluginInfo&gt; result; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pluginLoader = AppDomain.CreateDomain(<span class="hljs-string"><span class="hljs-string">"Plugin loader"</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, domainSetup, permmisions); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> engineAssemblyPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, <span class="hljs-string"><span class="hljs-string">@"bin\Engine.dll"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> proxy = (Proxy)pluginLoader.CreateInstanceAndUnwrap(AssemblyName.GetAssemblyName(engineAssemblyPath).FullName, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Proxy).FullName); proxy.PluginInfos = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;PluginInfo&gt;(); proxy.PluginLibs = inputPluginLibs; proxy.FullTypeName = typeName; proxy.LoadInfos(); result = proxy.PluginInfos; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { AppDomain.Unload(pluginLoader); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre><br><br>  To limit the loader's capabilities, I transfer a set of permissions to the domain to it.  As you can see in the listing, 3 permissions are set: <br><ul><li>  <b>ReflectionPermission</b> permission to use reflections. </li><li>  <b>SecurityPermission</b> permission to execute managed code. </li><li>  <b>FileIOPermission</b> permission to read files transferred in the second parameter. </li></ul><br>  Some of the permissions (almost all) can be specified as partial access, and full.  Partial is given using specific permissions enumerations.  For full access or, conversely, a ban, you can separately transfer the status: <br>  PermissionState.None - to ban. <br>  PermissionState.Unrestricted - for full resolution. <br><br>  More details about what other permissions you can read <a href="http://msdn.microsoft.com/en-us/library/System.Security.Permissions%2528v%3Dvs.110%2529.aspx">here</a> .  You can also see what the parameters of the default domains <a href="http://msdn.microsoft.com/en-us/library/03kwzyfc%2528v%3Dvs.90%2529.aspx">here</a> . <br><br>  In the method for creating a domain, I pass an instance of the class AppDomainSetup.  For him, only 2 fields are set, by which he understands where he needs to look for assemblies by default. <br><br>  Further, after an unremarkable creation of a domain, we call the CreateInstanceAndUnwrap method on it, passing the complete assembly name and type to the parameters.  The method will create an object in the loader domain and perform promotion, in this case, by reference. <br><br>  <b>Plugins:</b> <br><br>  Plug-ins in my implementation are divided into client and server.  Server provide only commands.  A separate menu item will be created for each client plug-in and it, like the server one, can give a set of commands for the chat. <br><br>  Both plugins have an initialization method in which I push the wrapper over the model and save it in a static field.  Why is this not done in the constructor? <br>  The name of the loaded plug-in is unknown and it will be detected only after the creation of the object.  Suddenly a plugin with that name has already been added?  Then it should be unloaded.  If there is still no plug-in namesake, then initialization is performed.  This ensures initialization only in case of successful loading. <br><br>  This is the base class of the plugin itself: <br><br><pre> <code class="hljs cpp"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> abstract <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Plugin</span></span></span><span class="hljs-class">&lt;TModel&gt; :</span></span> CrossDomainObject where TModel : CrossDomainObject { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> TModel Model { get; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Thread processThread; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TModel model)</span></span></span><span class="hljs-function"> </span></span>{ Model = model; processThread = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(ProcessThreadHandler); processThread.IsBackground = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; processThread.Start(); Initialize(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessThreadHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { Thread.Sleep(TimeSpan.FromMinutes(<span class="hljs-number"><span class="hljs-number">1</span></span>)); Model.Process(); OnProcess(); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> abstract <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> Name { get; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> abstract </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnProcess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre><br><br>  CrossDomainObject is an object that contains only 1 method - Process, which ensures the extension of the lifetime of the representative.  From the chat side, the plug-in manager calls it once per minute to all plug-ins.  From the side of the plugin, he himself calls the Process method on the model wrapper. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CrossDomainObject</span></span> : <span class="hljs-title"><span class="hljs-title">MarshalByRefObject</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Process</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } }</code> </pre><br><br>  Base classes for server and client plug-in: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ServerPlugin</span></span> : <span class="hljs-title"><span class="hljs-title">Plugin</span></span>&lt;<span class="hljs-title"><span class="hljs-title">ServerModelWrapper</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> List&lt;ServerPluginCommand&gt; Commands { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ClientPlugin</span></span> : <span class="hljs-title"><span class="hljs-title">Plugin</span></span>&lt;<span class="hljs-title"><span class="hljs-title">ClientModelWrapper</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> List&lt;ClientPluginCommand&gt; Commands { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> MenuCaption { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InvokeMenuHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre><br><br>  The plug-in manager is responsible for unloading, loading and owning plug-ins. <br>  Consider downloading: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadPlugin</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PluginInfo info</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> domainSetup = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AppDomainSetup(); domainSetup.ApplicationBase = AppDomain.CurrentDomain.BaseDirectory; domainSetup.PrivateBinPath = <span class="hljs-string"><span class="hljs-string">"plugins;bin"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> permmisions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PermissionSet(PermissionState.None); permmisions.AddPermission(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UIPermission(PermissionState.Unrestricted)); permmisions.AddPermission(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SecurityPermission( SecurityPermissionFlag.Execution | SecurityPermissionFlag.UnmanagedCode | SecurityPermissionFlag.SerializationFormatter | SecurityPermissionFlag.Assertion)); permmisions.AddPermission(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileIOPermission( FileIOPermissionAccess.PathDiscovery | FileIOPermissionAccess.Write | FileIOPermissionAccess.Read, AppDomain.CurrentDomain.BaseDirectory)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> domain = AppDomain.CreateDomain( <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"Plugin Domain [{0}]"</span></span>, Path.GetFileNameWithoutExtension(info.AssemblyPath)), <span class="hljs-literal"><span class="hljs-literal">null</span></span>, domainSetup, permmisions); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pluginName = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> plugin = (TPlugin)domain.CreateInstanceFromAndUnwrap(info.AssemblyPath, info.TypeName); pluginName = plugin.Name; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (plugins.ContainsKey(pluginName)) { AppDomain.Unload(domain); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } plugin.Initialize(model); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> container = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PluginContainer(domain, plugin); plugins.Add(pluginName, container); OnPluginLoaded(container); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { OnError(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"plugin failed: {0}"</span></span>, pluginName), e); AppDomain.Unload(domain); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } }</code> </pre><br><br>  Similar to the loader, at the beginning we initialize and create a domain.  Then, using the AppDomain.CreateInstanceFromAndUnwrap method, we create an object.  After its creation, the name of the plugin is analyzed, if one has already been added, then the domain is unloaded along with the plugin.  If there is no such plug-in, it is initialized. <br><br>  More code manager can be found <a href="">here</a> . <br><br>  One of the problems that was solved quite simply was the provision of plug-in access to the model.  My model root is static, and in another domain it will not be initialized, because  Types and static fields for each domain are different. <br>  The problem was solved by writing a wrapper, in which the objects of the model are saved, and an instance of this wrapper is being promoted.  Model objects only needed to be added to the MarshalByRefObject base classes.  The exception is the client and server (server just out of symmetry) API that also had to be wrapped.  The client API is created after the plug-in manager, and at the time of loading the add-ons it simply does not exist.  <a href="">An example of client wrapper</a> . <br><br>  For client and server plug-ins, I wrote 2 different managers that implement the basic PluginManager.  Both have a TryGetCommand method, which is called in the corresponding API if a native command with such an ID is not found.  Below is the implementation of the GetCommand API method. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IClientCommand </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCommand</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] message</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"message"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.Length &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"message.Length &lt; 2"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> id = BitConverter.ToUInt16(message, <span class="hljs-number"><span class="hljs-number">0</span></span>); IClientCommand command; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (commandDictionary.TryGetValue(id, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> command)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> command; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ClientModel.Plugins.TryGetCommand(id, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> command)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> command; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ClientEmptyCommand.Empty; }</code> </pre><br></div></div><br>  <b>Writing a plugin:</b> <br><br>  Now, based on the written code, you can try to implement a plugin. <br>  I will write a plugin which, by clicking on a menu item, opens a window with a button and a text field.  In the handler of the button, a command will be sent to the user, the nickname of which we entered in the field.  The team will take a snapshot and save it to a folder.  After that, post it in the main room and send us an answer. <br>  This will be a P2P interaction, so you won't need to write a server plugin. <br><br>  To begin, create a project, choose a class library.  And add to it in the links 3 main assemblies: Engine.dll, Lidgren.Network.dll, OpenAL.dll.  Do not forget to put the correct version of the .NET Framework, I am going to have chat for 3.5, and accordingly the plugins must also be the same version, or lower. <br><br>  Next, we implement the main class of the plugin, which provides 2 commands.  And on the menu item handler opens a dialog box. <br>  It is worth noting that the plug-in managers on their side are caching teams, so it is necessary for the plugin to keep links to them.  And the Commands property returned the same command instances. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ScreenClientPlugin</span></span> : <span class="hljs-title"><span class="hljs-title">ClientPlugin</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ClientPluginCommand&gt; commands; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> List&lt;ClientPluginCommand&gt; Commands { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> commands; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Initialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { commands = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;ClientPluginCommand&gt; { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClientMakeScreenCommand(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClientScreenDoneCommand() }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InvokeMenuHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dialog = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PluginDialog(); dialog.ShowDialog(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"ScreenClientPlugin"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> MenuCaption { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">" "</span></span>; } } }</code> </pre><br><br>  The dialog box looks like this: <br><img src="https://habrastorage.org/files/d9b/0d9/598/d9b0d9598a9e41078425be433633262e.png"><br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Window</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ScreenshotPlugin.PluginDialog"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:x</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Screen"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">SizeToContent</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"WidthAndHeight"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ResizeMode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"NoResize"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid.RowDefinitions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RowDefinition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Auto"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RowDefinition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Auto"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid.RowDefinitions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextBox</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Row</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10, 10, 10, 5"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">MinWidth</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"200"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UserNameTextBox"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Row</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10, 5, 10, 10"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Padding</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5, 2, 5, 2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Button_Click"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Window</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PluginDialog</span></span> : <span class="hljs-title"><span class="hljs-title">Window</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PluginDialog</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InitializeComponent(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Button_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { ScreenClientPlugin.Model.Peer.SendMessage(UserNameTextBox.Text, ClientMakeScreenCommand.CommandId, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); } }</code> </pre><br></div></div><br><br>  When transferring files, I used the already written chat functionality using the API. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ClientMakeScreenCommand</span></span> : <span class="hljs-title"><span class="hljs-title">ClientPluginCommand</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> CommandId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">50000</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ClientMakeScreenCommand.CommandId; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ClientCommandArgs args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (args.PeerConnectionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> screenDirectory = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, <span class="hljs-string"><span class="hljs-string">"screens"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Directory.Exists(screenDirectory)) Directory.CreateDirectory(screenDirectory); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> fileName = Path.GetFileNameWithoutExtension(Path.GetRandomFileName()) + <span class="hljs-string"><span class="hljs-string">".bmp"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> fullPath = Path.Combine(screenDirectory, fileName); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Bitmap bmpScreenCapture = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bitmap(Screen.PrimaryScreen.Bounds.Width, Screen.PrimaryScreen.Bounds.Height)) <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Graphics graphic = Graphics.FromImage(bmpScreenCapture)) { graphic.CopyFromScreen( Screen.PrimaryScreen.Bounds.X, Screen.PrimaryScreen.Bounds.Y, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, bmpScreenCapture.Size, CopyPixelOperation.SourceCopy); bmpScreenCapture.Save(fullPath); } ScreenClientPlugin.Model.API.AddFileToRoom(ServerModel.MainRoomName, fullPath); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> messageContent = Serializer.Serialize(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClientScreenDoneCommand.MessageContent { FileName = fullPath }); ScreenClientPlugin.Model.Peer.SendMessage(args.PeerConnectionId, ClientScreenDoneCommand.CommandId, messageContent); } }</code> </pre><br><br>  The most interesting thing happens in the last 3 lines.  Here we use the API to add a file to the room.  After that we send the command response.  At a peer, a method overload is called that takes a set of bytes, since  our object cannot be serialized in the main chat build. <br><br>  Below is the implementation of the command that will receive the answer.  She will announce to the entire main room, that we have taken a screenshot of the poor user. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ClientScreenDoneCommand</span></span> : <span class="hljs-title"><span class="hljs-title">ClientPluginCommand</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> CommandId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">50001</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ClientScreenDoneCommand.CommandId; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ClientCommandArgs args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (args.PeerConnectionId == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> receivedContent = Serializer.Deserialize&lt;MessageContent&gt;(args.Message); ScreenClientPlugin.Model.API.SendMessage( <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"    {0}."</span></span>, args.PeerConnectionId), ServerModel.MainRoomName); } [Serializable] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MessageContent</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> fileName; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FileName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fileName; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { fileName = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } } }</code> </pre><br><br>  I can post a complete project with a plugin, but I don‚Äôt know where.  (For a separate repository on the githab, it is very small, I think). <br><br>  <b>UPD</b> : posted a plugin on <a href="https://github.com/Nirklav/ScreenshotPlugin">github</a> . <br><br>  <b>UPD 2</b> : The article uses pooling to support the lifetime of the plugins, which is weird.  In <a href="https://github.com/Nirklav/TCPChat">the github implementation,</a> I <b>later</b> implemented a normal model. </div><p>Source: <a href="https://habr.com/ru/post/242209/">https://habr.com/ru/post/242209/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../242199/index.html">Why does the speed of writing to the RAID decrease as the SSD fills, or why do we need TRIM</a></li>
<li><a href="../242201/index.html">Pattern matching with macros</a></li>
<li><a href="../242203/index.html">Why is the future behind remote work (part 2)</a></li>
<li><a href="../242205/index.html">Osquery exposes the OS as a relational database</a></li>
<li><a href="../242207/index.html">ah - better than history</a></li>
<li><a href="../242211/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ132 (October 27 - November 2, 2014)</a></li>
<li><a href="../242213/index.html">Backing up virtual machines in a QEMU / KVM hypervisor environment</a></li>
<li><a href="../242217/index.html">IceCash 1.3. Linux workplace cashier on php, with the driver Shtrih-M</a></li>
<li><a href="../242219/index.html">Create your own Debian LiveCD boot disk</a></li>
<li><a href="../242221/index.html">Fractals, Fortran and OpenMP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>