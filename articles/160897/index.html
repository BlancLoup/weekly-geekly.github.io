<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>On some non-obvious hacks when working with the entity framework and unique constraints</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A couple of years ago, when the trees were big and green, evil donetchiki came to me, and they said - yeah, I got caught! I had to help my colleagues ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>On some non-obvious hacks when working with the entity framework and unique constraints</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/f9b/21f/666/f9b21f666c0138141eb7855080ef4c6d.png" alt="image" align="left"><br>  A couple of years ago, when the trees were big and green, <s>evil donetchiki came to me, and they said - yeah, I got caught!</s>  I had to help my colleagues in one very strange project. <br><br>  Namely - imagine a pack of <i>digital calculators</i> , which analysts make once a month, in their favorite MS Office package.  And once a month it became necessary to chew on these numbers and load them into a database running MS SQL. <br><br>  And of course - this mega-tool should have been done quickly.  To then transfer to the support cheap whether the Malays, or Hindus.  So it was also recommended to do as clear as possible. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><h4>  How they started to solve the problem </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/8a0/ab7/d7e/8a0ab7d7e9530f11ef95445356f98618.png" alt="image" align="left"><br>  Evil dotnetchiki decided to simplify their lives for themselves - not to make the insert into their hands, if there are so many columns in the corresponding report that Excel gives them three-letter names.  And in the ancient database a huge stack of tables, in some of which the number of columns is simply amazing. <br><br>  Therefore, it was done like this - the database was slipped into the visual studio, and they got a huge code for the entity framework.  Instead of sawing with a jigsaw and preparing a prepared statement with a hundred questions in values ‚Äã‚Äã(...), the usual filling of entity objects followed by context.SaveChanges (). <br><br>  <i>I note - the right decision.</i>  <i>And the premature optimizations are known to be evil.</i> <br><br><h4>  What came with this approach </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/e4d/374/d6d/e4d374d6dd01b3815535e22772d94001.png" alt="image" align="left"><br>  <i>I smell the smell of burning.</i>  <i>Immediately run to the kitchen, take out the meat from the patch.</i>  <i>I cut the burnt sword with a two-handed sword and immediately swallow it, as the Coal sticks into the room.</i>  <i>Hot!</i>  <i>But portray.</i> <i><br></i>  <i>- What is it, Master?</i> <i><br></i>  <i>- The steamy kiten.</i>  <i>The latest fashion!</i> <i><br></i>  <i>- Do not fill in - you know about fashion only from the dictionary, - it tries.</i>  <i>- Although really delicious!</i> <i><br></i> <br><br>  It was smooth on paper ... Unique constraints far from all tsiferki agreed to eat. <br><br>  The amazing fact is that if the entity framework gets a database level exception, then the <s>running boar becomes a pose</s> on the recommendation of the microsoftware, we have only one way to shoot this context and create the next one.  In this case, this means that you need to pull the master from the old context, or re-create it, and preferably not by copying all the fields in catch (). <br><br>  And of course, to make it more interesting - you cannot mix objects from different contexts. <br><br>  The re-creation backup in many cases turned out to be non-trivial, and how the Malays will support these hacks is a big question. <br><br>  And at this moment <s>these sinister brought an iron and a soldering iron!</s>  reached me. <br><br><h4>  What had to be done </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/139/8aa/350/1398aa350959f67c899db93e555dec7a.png" alt="image" align="left"><br>  <i>Karapet is outraged.</i> <i><br></i>  <i>- Harmful!</i>  <i>They asked for a hundred kilograms of energy, but how much!</i>  <i>You tell me so and say - you need a lot, why deceive Karapet?</i>  <i>I don‚Äôt feel sorry, we need five tons - say so, Karapet, give us five tons ... They are harmful to the wickedness!</i> <br><br>  As it turned out, the entity CancelChanges in the entity framework is not provided.  And its presence would give a chance not to complicate. <br><br>  As it is easy to guess, it was necessary to invent. <br><br>  To begin with, we define the approach - rummage through the context, and catch the very <s>sick tooth</s> element that leads to such a sad result.  And - throw it out of context.  The data of course from this in the database will not appear - but the context will remain working, which is what we need.  And with the crooked data let the analysts understand, our task is to write to them - where such was found. <br><br><h5>  Where to go? </h5><br><img src="https://habrastorage.org/getpro/habr/post_images/79b/107/157/79b1071577c37588ce3dee4067d1b99f.png" alt="image" align="left"><br>  <i>- Afa, pull yourself together!</i> <i><br></i>  <i>I clasp myself with hands, get off the floor on biogras.</i> <i><br></i>  <i>- Took it.</i>  <i>Where to go?</i> <i><br></i> <br><br>  In the examples I focused for insertions as the most obscure.  Similarly, it understands and update.  I do not bring a footcloth, as it differs little from the above, and it is easier to keep track of updates.  Delete we just do not have - this is the paranoia of fellow bankers, how to remove something from the database?  No no! <br><br>  Having smoked manuals and how should google, we define the following data structure: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyEntry</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> EntityObject entity; <span class="hljs-comment"><span class="hljs-comment">// entity object,  public string name; //    EF public Dictionary&lt;string, EntityKey&gt; refmap; // foreign keys -  - ,   //         FK      public Dictionary&lt;string, EntityObject&gt; objmap; //   public Dictionary&lt;EntityObject, string&gt; keymap; //     public MyEntry(string s, EntityObject o) { entity = o; name = s; refmap = new Dictionary&lt;string, EntityKey&gt;(); objmap = new Dictionary&lt;string, EntityObject&gt;(); keymap = new Dictionary&lt;EntityObject, string&gt;(); } }</span></span></code> </pre> <br><br>  Now we can do magic.  This is how it is determined - what was added to the context after the last SaveChanges (): <br><br><pre> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-comment">// t  derived class  EntityContext var added = t.ObjectStateManager.GetObjectStateEntries(EntityState.Added);</span></span></code> </pre><br><br>  so that we can now determine what it was, and pass it on to us for detailed examination.  Like that. <br><br><pre> <code class="cs hljs"> List&lt;MyEntry&gt; allDataToProceed = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;MyEntry&gt;(); <span class="hljs-comment"><span class="hljs-comment">//     foreach (var a in added) { //  EF        .  //      if (!(a.IsRelationship)) { //   -    "Foo", Foo a MyEntry e = new MyEntry(a.EntitySet.Name, a.Entity); allDataToProceed.Add(e); //     foreign keys    IEnumerable&lt;IRelatedEnd&gt; relEnds = ((IEntityWithRelationships)a.Entity).RelationshipManager.GetAllRelatedEnds(); foreach (var rel in relEnds) { //     FKs List&lt;EntityObject&gt; fks = new List&lt;EntityObject&gt;(); foreach (var obj in rel) fks.Add((EntityObject)obj); //         -  var relname = rel.RelationshipName; if (fks.Count == 1) { //   -    ,   if (fks[0].EntityKey.EntityKeyValues != null) e.refmap[relname] = fks[0].EntityKey; else { //     -  , //    .  -   //      //       FK     e.keymap[fks[0]] = fks[0].EntityKey.EntitySetName; e.objmap[relname] = fks[0]; } } } } }</span></span></code> </pre><br><br>  The only thing left to do is to bring the context back to life. <br><br><pre> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-comment">//       foreach (var a1 in added) a1.Delete(); t.SaveChanges();</span></span></code> </pre><br><br>  and start an exorcism session - and what is it that we have here come up with such a strange thing, and most importantly - where to put it. <br><br><h5>  Do not yell at home either </h5><br><img src="https://habrastorage.org/getpro/habr/post_images/afe/de6/528/afede65280aa3cda71f36a07fa9f09c2.png" alt="image" align="left"><br>  <i>From the pressure of the screen bursts.</i>  <i>I take a broom and collect fragments - I am the leader of the expedition.</i>  <i>Angle wants to say something - what is his squeaky voice at a depth of three kilometers.</i>  <i>Telling him</i> <i><br></i>  <i>- Do not yell at home.</i> <i><br></i>  <i>Thinking, add</i> <i><br></i>  <i>- And not at home, too, do not yell.</i> <i><br></i> <br><br>  The first thing we need to do is take into account foreign keys.  If any object is created as part of a master-slave chain, then you don‚Äôt need to add the master and the slave separately, otherwise you can break the referral integrity. <br><br><pre> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-comment">//           FK //       List&lt;EntityObject&gt; usedInRefs = new List&lt;EntityObject&gt;(); foreach (var a1 in allDataToProceed) { foreach (var dup in a1.objmap.Values) usedInRefs.Add(dup); } //   for (int j = 0; j &lt; allDataToProceed.Count; ++j) { if (usedInRefs.Contains(allDataToProceed[j].entity)) { allDataToProceed.RemoveAt(j); --j; } }</span></span></code> </pre><br><br>  And finally, things are easy - it remains to stuff in the database what you can stuff.  To do this, restore our copy of foreign keys and add it to the context.  Succeeded?  fine, no - that means this is our bad tooth. <br><br><pre> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-comment">//     -      foreach (var a1 in allDataToProceed) { try { //    FKs  master/slave IEnumerable&lt;IRelatedEnd&gt; relEnds = ((IEntityWithRelationships)a1.entity).RelationshipManager.GetAllRelatedEnds(); foreach (var rel in relEnds) { var relname = rel.RelationshipName; EntityKey key = null; //          EF //         if (a1.refmap.ContainsKey(relname)) key = a1.refmap[relname]; EntityObject o = key != null ? o = (EntityObject)t.GetObjectByKey(key) : null; //     -      // master/slave  if (o == null &amp;&amp; a1.objmap.ContainsKey(relname)) { o = a1.objmap[relname]; if (a1.keymap.ContainsKey(o)) t.AddObject(a1.keymap[o], o); else o = null; } //    -    if (o != null) rel.Add(o); } //       t.AddObject(a1.name, a1.entity); t.SaveChanges(); } catch (Exception e2) { //        -     //      added = t.ObjectStateManager.GetObjectStateEntries(EntityState.Added); foreach (var a2 in added) a2.Delete(); //   -    ,      } }</span></span></code> </pre><br><br>  Voila  <i>We did it!</i> <br><br>  Perhaps this approach will be useful to someone. </div><p>Source: <a href="https://habr.com/ru/post/160897/">https://habr.com/ru/post/160897/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160885/index.html">Virtual Jeopardy! with watson</a></li>
<li><a href="../160887/index.html">Asynchronous loading of Backbone.js data</a></li>
<li><a href="../160889/index.html">Available Touchscreen Ultrabook ASUS S400CA</a></li>
<li><a href="../160891/index.html">The idea of ‚Äã‚Äãthe online game "Tarantinki": user + ES vs user</a></li>
<li><a href="../160893/index.html">The father of the Internet Vint Cerf called supporters of the introduction of control over the Network dinosaurs with a tiny brain</a></li>
<li><a href="../160899/index.html">Qt 4.8.4 is here!</a></li>
<li><a href="../160901/index.html">What a good programmer!</a></li>
<li><a href="../160903/index.html">Cloud PHP hosting now in Russia</a></li>
<li><a href="../160905/index.html">Microsoft Security Essentials Failed AV-Test Certification</a></li>
<li><a href="../160907/index.html">About Scar, Focus Factor and Buns</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>