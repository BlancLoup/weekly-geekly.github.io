<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Developing a compiler for the cool language in C # language under .NET (Part 2 + Bonuses)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habrahabr! 

 Introduction 
 In this article, I, as promised, will continue the description of the development of the compiler for the Cool langua...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Developing a compiler for the cool language in C # language under .NET (Part 2 + Bonuses)</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habrahabr! <br><br><h4>  Introduction </h4><br>  In this article, I, as promised, will continue the description of the development of the compiler for the Cool language, begun in <a href="http://habrahabr.ru/blogs/compilers/136528/">this</a> article. <br><br>  I recall that the compilation process <s>for Feng Shui</s> includes several stages, which are depicted in the figure below to the left.  My compiler contains only three stages, which are shown in the same figure to the right. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><img src="https://habrastorage.org/getpro/habr/post_images/98b/3ca/ec1/98b3caec1928ce34a33e12f1a4f479be.png"><br><br>  About lexical and parser it was told in the first article. <br><br>  The main task of the <b>semantic analyzer</b> is to check the source program for semantic consistency with the definition of the language.  This is mainly a <i>type check</i> , i.e.  when the compiler checks if each operator has operands of the appropriate type. <br><br>  <b>The intermediate code</b> generation is needed to generate an intermediate representation of the source code, which should be <i>easily generated</i> and <i>easily translated</i> into the target machine language.  For example, a <a href="http://en.wikipedia.org/wiki/Three_address_code">triaddress code</a> is used as such a representation. <br><br>  The <b>machine-independent code optimization</b> phase <b>is</b> used to make the intermediate code more qualitative (faster or, more rarely, short). <br><br>  <b>Code generation</b> is a direct translation of the intermediate representation into a set of assembler or virtual machine commands. <br><br>  The <b>machine-dependent optimization</b> phase is similar to machine-independent optimization, except that special instructions of the target machine (for example, <i>SSE</i> ) are used to optimize the code.  It is clear that in our case the <a href="http://en.wikipedia.org/wiki/Common_Language_Runtime">CLR</a> takes on these responsibilities. <br><br>  As can be seen from the diagram, in one stage I have combined three stages from the diagram on the left.  This is explained both by the impossibility of generating an intermediate code using the <b>System.Reflection.Emit</b> tool (since a sequence of CIL instructions is generated that cannot be changed) and by the lack of attention to the architecture as a whole. <br><br><h4>  Architecture </h4><br>  Wow, I don‚Äôt know where to start! <br>  I will describe the stages of my code generator, which will be considered: <br><ol><li>  Class definition </li><li>  Definition of functions and fields </li><li>  Generating code constructors and functions </li></ol><br><h5>  Class definition </h5><br>  It is known that the source code in the Cool language is a set of classes.  Naturally, there should be <i>an entry point</i> , and nothing will be done. <br>  So, the entry point is the main function in the Main class.  Both class and function need to be registered manually.  But more on this later. <br><br>  In System.Reflection.Emit there are special classes <i>AssemblyBuilder</i> and <i>ModuleBuilder</i> , which are used to build a dynamic assembly and generate CIL code. <br>  To declare the description of any class method is used <br><pre><code class="cs hljs">TypeBuilder ModuleBuilder.DefineType(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> className, TypeAttributes attr, Type parent)</code> </pre> <br>  In which <b>className</b> is the name of the class, <b>attr</b> is its attributes and <b>parent</b> is the parent (if any). <br>  <b>TypeBuilder</b> is a dynamic type, which will then be used when generating code (for example, for the new operator). <br><br>  So, at this stage, in the syntactic tree obtained from the parser, nodes with the type ‚Äúclass‚Äù are bypassed, as shown in the figure below, and all classes that are in the source code are determined using the method mentioned above. <br><img src="https://habrastorage.org/getpro/habr/post_images/bc1/bc4/6ca/bc1bc46ca4e0ee097929e46e1a2cabda.png"><br>  Optional symbols of the language are displayed in yellow (Here is the name of the parent class. If there is no parent, then the class is inherited from <i>Object</i> ). <br><br>  I want to note that at this stage only class definitions are created, without their descriptions of the functions and fields within them.  If, however, functions and fields are described immediately, then you may encounter an error that the class is not defined, although it is simply described later. <br><br>  I also want to say that it would be more correct to sort the descriptions in the source code in the correct order before defining classes (for example, the description of class B, which is inherited from A, and then the description of class A).  But this, unfortunately, is not implemented for me, therefore all classes should be described in the order in which they are used. <br><br>  So, at this stage a dictionary has been received. <br><pre> <code class="cs hljs">Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, TypeBuilder&gt; ClassBuilders_;</code> </pre><br>  in which the key is the name of the class, and the value is its builder. <br><br>  In conclusion, I want to say that after generating all the code, the dynamic types need to be <i>finalized</i> using the CreateType method (this is done in the <b>FinalAllClasses</b> function). <br><br><h5>  Definition of functions and fields </h5><br>  After determining the classes, in each class you need to define its functions and methods for further use.  This is done using methods <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> FieldBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DefineField</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fieldName, Type type, FieldAttributes attributes</span></span></span><span class="hljs-function">)</span></span></code> </pre><br>  and <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MethodBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DefineMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name, MethodAttributes attributes, Type returnType, Type[] parameterTypes)</span></span></span></span>;</code> </pre><br>  respectively. <br><br>  At the end of this stage, two-dimensional dictionaries are filled. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, FieldObjectDef&gt;&gt; Fields_; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, MethodDef&gt;&gt; Functions_;</code> </pre><br><br>  The key of the dictionary of the first dimension is the name of the class, the second is the name of the function or field.  The values ‚Äã‚Äãare the descriptors of a function or field, respectively (These classes will be discussed later). <br><br>  The problem of sorting descriptions of functions and fields in the source code is not here, as it is when defining classes.  Because at the stage of defining classes, information about other classes is used to determine inheritance, and it is used directly in the DefineType function.  But, since information on other functions is not needed to define a function (code generation does not occur here), then references to other functions are not needed.  So it is possible to generate definitions of functions and fields in any order. <br><br><h5>  Generating code constructors and functions </h5><br>  And here we are at the most interesting.  Here, a recursive traversal of the bodies of functions and constructors of all classes occurs directly. <br><br>  So, from the previous step a dictionary of all method descriptors (MethodBuilder) for all classes was obtained. <br>  To add a CIL instruction to a method, you must first obtain a special ILGenerator object using <br>  <code>var ilGenerator = methodBuilder.GetILGenerator()</code> , and then use the Emit method of this generator. <br>  There are many forms of the Emit method: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Emit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OpCode opcode</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Emit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OpCode opcode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Emit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OpCode opcode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Emit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OpCode opcode, ConstructorInfo con</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Emit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OpCode opcode, LocalBuilder local</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Emit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OpCode opcode, FieldInfo field</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Emit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OpCode opcode, MethodInfo meth</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Emit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OpCode opcode, Type cls</span></span></span><span class="hljs-function">)</span></span>;</code> </pre><br>  OpCode is a virtual .NET machine instruction.  A good list of instructions with descriptions is listed <a href="http://en.wikipedia.org/wiki/List_of_CIL_instructions">here</a> . <br>  And the second argument (it is not always there) is the ‚Äúbuilder‚Äù or the descriptor of the class or method that was obtained in the previous two stages. <br><br>  The current function and the current class are the function and the class, respectively, in which the code is currently being generated (bypassing the syntax tree). <br><br>  For a start, I will explain which classes in my code generator I entered to describe the arguments of functions, local variables, temporary local variables, and class fields.  The base class is <b>ObjectDef</b> , which contains the abstract Load (), Remove () methods for loading, and freeing the corresponding object. <br><ul><li>  <i>FieldObjectDef</i> - used to describe a field of any class (in a Cool field, this is a feature).  When generating code for functions and constructors of the current class, an array of field descriptions is used, which was described above. </li><li>  <i>LocalObjectDef</i> - used to describe all local variables in the body of the current function or constructor (In Cool, local variables are declared using the <i>let</i> operator). </li><li>  <i>ValueObjectDef</i> is a kind of local variable for storing data transmitted by values.  In Cool, such classes are Int, String, Bool. </li><li>  <i>ArgObjectDef</i> - the argument of the current function.  Contains the number, name and type of the argument. </li></ul><br>  As you have already noticed, in Cool, every result is an expression.  And inside each constructor and each function is also just one <b>expr</b> .  This is the most important point of my code generator and for processing this design was introduced <i>EmitExpression</i> function <i>(ITree expressionNode)</i> .  The code is shown below (I have shortened it, replacing some pieces with commented three points): <br><br><pre> <code class="cs hljs">ObjectDef result; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (expressionNode.Type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CoolGrammarLexer.ASSIGN: result = EmitAssignOperation(expressionNode); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  ... case CoolGrammarLexer.EQUAL: result = EmitEqualOperation(expressionNode); break; case CoolGrammarLexer.PLUS: case CoolGrammarLexer.MINUS: case CoolGrammarLexer.MULT: case CoolGrammarLexer.DIV: result = EmitArithmeticOperation(expressionNode); break; //... case CoolGrammarLexer.Term: if (expressionNode.ChildCount == 1) result = EmitExpression(expressionNode.GetChild(0)); else result = EmitExplicitInvoke(expressionNode); break; case CoolGrammarLexer.ImplicitInvoke: result = EmitInplicitInvoke(expressionNode); break; case CoolGrammarLexer.IF: result = EmitIfBranch(expressionNode); break; case CoolGrammarLexer.Exprs: for (int i = 0; i &lt; expressionNode.ChildCount - 1; i++) { var objectDef = EmitExpression(expressionNode.GetChild(i)); objectDef.Remove(); } result = EmitExpression(expressionNode.GetChild(expressionNode.ChildCount - 1)); break; //... case CoolGrammarLexer.INTEGER: result = EmitInteger(expressionNode); break; } return result;</span></span></code> </pre><br>  As you can see, depending on the type of tree node (expressionNode), the function responsible for the generation of instructions of this operator is called from a long case. <br><br>  To return the result in the generated function, use the simple <b>OpCodes.Ret</b> instruction after generating the expression code (If the function returns nothing, for example, Main, you need to add <b>OpCodes.Pop</b> before Ret so that the stack does not overflow). <br><br>  To determine <i>the entry point</i> , use the <i>SetEntryPoint</i> method <i>(MethodInfo entryMethod)</i> , which is defined in <i>AssemblyBuilder</i> .  Also, the entry point method needs to specify the <i>STAThreadAttribute</i> attribute, which indicates that the application is running in the same thread.  The code for defining the functions and entry points is in my DefineFunction. <br><br>  <i>Question</i> : how to generate code for constructions of the following type: <br>  math: Math ‚Üê new Math;  (assignment to the field of some expression, here new Math). <br><br>  <i>Answer</i> : First of all, you need to understand that the C # compiler and, accordingly, our compiler, does not generate any calculations on the fly - this is impossible.  Those.  I want to say that the expression on the right will be evaluated in the default constructor. <br>  And after the expression code (here new Math) is generated, the instruction <b>OpCodes.Stfld</b> or <b>OpCodes.Stsfld is</b> added to the body of this constructor for non-static and static fields, respectively. <br><br><h4>  Description of some CIL instructions and designs </h4><br>  CIL is a <a href="http://en.wikipedia.org/wiki/Stack-oriented_programming_language">stack language</a> , which means all operations are performed using the stack.  For example, the function call to count the Fibonacci number from the Math class is encoded as follows: <br><br><pre> <code class="cs hljs">ldsfld <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Math</span></span> <span class="hljs-title"><span class="hljs-title">Main</span></span>::<span class="hljs-title"><span class="hljs-title">math</span></span> <span class="hljs-title"><span class="hljs-title">ldsfld</span></span> <span class="hljs-title"><span class="hljs-title">int32</span></span> <span class="hljs-title"><span class="hljs-title">Main</span></span>::<span class="hljs-title"><span class="hljs-title">i</span></span> <span class="hljs-title"><span class="hljs-title">callvirt</span></span> <span class="hljs-title"><span class="hljs-title">instance</span></span> <span class="hljs-title"><span class="hljs-title">int32</span></span> <span class="hljs-title"><span class="hljs-title">Math</span></span>::<span class="hljs-title"><span class="hljs-title">fibonacci</span></span>(<span class="hljs-title"><span class="hljs-title">int32</span></span>) <span class="hljs-title"><span class="hljs-title">stloc</span></span>.0</code> </pre><br>  Here, the instance <i>math is</i> first loaded onto the stack, then the argument passed is of type <i>int</i> .  After that, the function fibonacci is called using the <b>OpCodes.callvirt</b> instruction (A normal <b>OpCodes.call</b> instruction <b>is</b> used when calling the internal function of a class, then the class descriptor is not required to be passed).  The last <b>stloc.0</b> instruction stores the return value in a local variable numbered 0. <br>  Well, in accordance with the above, I want to note that the first argument for any function is a pointer to an instance of the class from which it is called (this), even if there are no arguments in explicit form. <br><br>  A more detailed description of CIL can be seen for example on <a href="http://en.wikipedia.org/wiki/Common_Intermediate_Language">Wikipedia.</a> <a href="http://en.wikipedia.org/wiki/Common_Intermediate_Language"><br></a>  , but I'd rather describe how to encode some syntactic constructs using Reflection.Emit. <br><br><h5>  Arithmetically operations and comparison operations </h5><br>  These operations are simply encoded - first they are pushed onto the stack. <br>  operands, and then the <b>opcode</b> : for arithmetic operations, these are <b>OpCodes.Add, OpCodes.Sub, OpCodes.Mul, OpCodes.Div</b> , and for comparison operations, <b>OpCodes.Ceq, OpCodes.Clt, OpCodes.Cgt</b> . <br><br>  I want to note that in CIL there is no instruction for comparisons "less than or equal to" or "greater than or equal to", so three instructions are used to generate such comparisons, instead of one (here "&lt;=" is equivalent to "not&gt;"): <br><br><pre> <code class="cs hljs">OpCodes.Cgt OpCodes.Ldc_I4_0 OpCodes.Ceq</code> </pre><br>  OpCodes.Ceq compares the two items in the stack and returns 1 if they are equal, and 0 if they are not equal. <br><br><h5>  If construct </h5><br>  Compared to the coding of arithmetic operations, there is a difficulty in coding this instruction, which consists in the need to somehow mark the labels of conditional and unconditional jumps.  However, this is done easily.  Using the DefineLabel method in the ILGenerator, labels are created, which must then be used to mark the code using the MarkLabel method.  These labels are then used when encoding instructions for conditional and unconditional jumps.  Accordingly, <b>OpCodes.Brfalse</b> is a conditional transition that occurs when the value of the top of the stack is zero.  And <b>OpCodes.Br</b> is an unconditional transition.  For clarity, I gave the code: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> ObjectDef </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EmitIfBranch</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ITree expressionNode</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> checkObjectDef = EmitExpression(expressionNode.GetChild(<span class="hljs-number"><span class="hljs-number">0</span></span>)); checkObjectDef.Load(); checkObjectDef.Remove(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exitLabel = CurrentILGenerator_.DefineLabel(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> elseLabel = CurrentILGenerator_.DefineLabel(); CurrentILGenerator_.Emit(OpCodes.Brfalse, elseLabel); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ifObjectDef = EmitExpression(expressionNode.GetChild(<span class="hljs-number"><span class="hljs-number">1</span></span>)); ifObjectDef.Load(); ifObjectDef.Remove(); CurrentILGenerator_.Emit(OpCodes.Br, exitLabel); CurrentILGenerator_.MarkLabel(elseLabel); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> elseObjectDef = EmitExpression(expressionNode.GetChild(<span class="hljs-number"><span class="hljs-number">2</span></span>)); elseObjectDef.Load(); elseObjectDef.Remove(); CurrentILGenerator_.MarkLabel(exitLabel); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LocalObjectDef.AllocateLocal(GetMostNearestAncestor(ifObjectDef.Type, elseObjectDef.Type)); }</code> </pre><br><h5>  While construct </h5><br>  This design is a lot like <b>If</b> .  Just do not forget that inside the body of this structure, you should always make <b>Pop</b> , because  the inner expression is evaluated, and its result is not used.  (In Cool, this operator always returns void). <br><br><h5>  Operators '@' and 'Case' </h5><br>  The @ operator essentially corresponds to the expression (a as B) .methodName in C # code, and the Case statement uses dynamic type checking and it corresponds to the expression a is B in C #. <br>  These operators, unfortunately, were not implemented by me. <br>  However, I can say that a cast to a specific type is implemented using the <b>castclass &lt;class&gt;</b> instruction (A cast to a type and a method call is immediately implemented using <b>constrained. &lt;ThisType&gt; [prefix]</b> ) <br>  A check of dynamic types is implemented using the <b>isinst &lt;class&gt;</b> instruction. <br><br><h5>  Processing Id Tokens </h5><br>  If the type of the tree node corresponds to the type Id, then the following actions are performed (in the <b>EmitIdValue</b> function): <br><ol><li>  Identifier search in local variables, if not found, then </li><li>  Identifier search in function arguments, if not found, then </li><li>  Search for identifier in the fields of the current class, if not found, then </li><li>  Generate an error that Id is not defined </li></ol><br>  In this section, I described the CIL instructions and code generation for syntax structures that seem to be the most interesting and complex.  For all other CIL instructions, you can refer to the wiki page, which is located at the end of the topic.  And you can see the code generation in more detail in the source code. <br><br><h4>  Error processing </h4><br>  Compiler errors are different: <s>black, white, red</s> <b>lexical</b> , <b>syntactic</b> , <b>semantic,</b> and <b>general</b> . <br><br>  For all of them, the abstract class <b>CompilerError</b> was created, containing the error number, position in the code (line and column), type of error and its description. <br><br>  It is impossible to control lexical and syntactic errors (at least in this project I did not begin to deal with <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B0%25D0%25BA%25D1%2581%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9_%25D0%25B0%25D0%25BD%25D0%25B0%25D0%25BB%25D0%25B8%25D0%25B7">error recovery</a> at ANTLR <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B0%25D0%25BA%25D1%2581%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9_%25D0%25B0%25D0%25BD%25D0%25B0%25D0%25BB%25D0%25B8%25D0%25B7">at the lexer and parser levels</a> ).  Here, exceptions are simply caught and error instances corresponding to them are created.  All this can be viewed in the file CoolCompier.cs <br><br>  But the check for semantic errors, mainly type checking, is implemented in all functions ‚Äúemitters‚Äù.  Type checking is implemented in a banal way.  However, this approach allows recognition of several semantic errors in a single pass.  Here is an example: an arithmetic operation, even if an error was detected, the syntax tree traversal continues: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> ObjectDef </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EmitArithmeticOperation</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ITree expressionNode</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> returnObject1 = EmitExpression(expressionNode.GetChild(<span class="hljs-number"><span class="hljs-number">0</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> returnObject2 = EmitExpression(expressionNode.GetChild(<span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (returnObject1.Type != IntegerType || returnObject1.Type != returnObject2.Type) CompilerErrors.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArithmeticOperatorError( returnObject1.Type, returnObject2.Type, CompilerErrors.Count, expressionNode.Line, expressionNode.GetChild(<span class="hljs-number"><span class="hljs-number">1</span></span>).CharPositionInLine, expressionNode.GetChild(<span class="hljs-number"><span class="hljs-number">0</span></span>).CharPositionInLine)); ... }</code> </pre><br>  Well, to the errors of a general kind, I attributed the errors like ‚ÄúThe file is occupied by another process‚Äù, ‚ÄúThe entry point was not found‚Äù, etc. It is not very interesting to talk about them. <br><br><h4>  Interface </h4><br><h5>  Syntax highlighting </h5><br>  As a component for working with code, as I said, I used <a href="http://www.codeproject.com/KB/edit/AvalonEdit.aspx">AvalonEdit</a> under WPF. <br><br>  For syntax highlighting, a special file with the .xshd extension is used, which describes the font styles for various words and rules. <br><br>  For example, comments are indicated as: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">color</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Comment"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">begin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"--"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">color</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Comment"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">multiline</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">begin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"\(\*"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"\*\)"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  Keywords like this: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Color</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Keywords"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">foreground</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Blue"</span></span></span><span class="hljs-tag"> /&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Keywords</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">color</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Keywords"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Word</span></span></span><span class="hljs-tag">&gt;</span></span>classWord&gt; <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Word</span></span></span><span class="hljs-tag">&gt;</span></span>elseWord&gt; <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Word</span></span></span><span class="hljs-tag">&gt;</span></span>falseWord&gt; ... Keywords&gt;</code> </pre><br><br>  There are also rules that are needed to determine which sequence of characters is a number or a string and how to highlight them: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Rule</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">foreground</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DarkBlue"</span></span></span><span class="hljs-tag">&gt;</span></span> \b0[xX][0-9a-fA-F]+ # hex number |\b ( \d+(\.[0-9]+)? #number with optional floating point | \.[0-9]+ #or just starting with floating point ) ([eE][+-]?[0-9]+)? # optional exponent Rule&gt;</code> </pre><br><br>  All other highlighting rules can be found in the file <b>CoolHighlighting.xshd</b> . <br><br><h5>  Folding and autocompletion </h5><br>  Folding and unfolding of blocks is possible in this editor and implemented in <b>CoolFoldingStrategy.cs</b> .  The code is not mine, so I will refrain from commenting on it.  Let me just say that thanks to him, everything that is between curly braces can be collapsed or expanded.  Maybe it will seem to someone not very correct, since cycles should not have such an opportunity. <br><br>  Also, with the help of this component, you can make auto-completion, but I didn‚Äôt do it, because for that you had to do another architecture at the very beginning, which would allow generating a semantic tree regardless of the code generation. <br><br>  Finally, on the part of the interface I will describe how to associate the errors found with lines of code.  In the code shown below, a scroll occurs and the carriage returns to the place where a specific error occurred: <br><br><pre> <code class="cs hljs">tbEditor.ScrollTo((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)compilerError.Line, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)compilerError.ColumnStart); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> offset = tbEditor.Document.GetOffset((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)compilerError.Line, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)compilerError.ColumnStart); tbEditor.Select(offset, <span class="hljs-number"><span class="hljs-number">0</span></span>); tbEditor.Focus();</code> </pre><br>  <b>tbEditor</b> is an instance of the editor component; <br>  <b>compilerError</b> - error (described in the previous section); <br><br>  And of course this section will not be complete without a screen of the compiler itself: <br><br><img src="http://habrastorage.org/storage2/226/a04/b80/226a04b8030a10388d078957c6af08cd.png"><br><br>  The code editor is on the upper left, the log and the list of errors are in the lower left.  On the right are the buttons to compile the code (you can also just press F5 to compile and run, and F6 just to compile). <br>  For clarity, the program displays a list of tokens and a syntax tree (on the right).  When you double-click on a token or a syntactic structure, the cursor is moved and the carriage returns to the right place. <br><br><h4>  Further architecture improvements </h4><br>  If I started writing a compiler for the Cool language again with the knowledge that I now have, and with sufficient motivation, I would probably single out two more compilation stages - the construction of a semantic tree and the generation of three- or four-address intermediate code. <br><br>  The semantic tree, as I already said, will allow the implementation of auto substitution and verification of semantic errors in real time before code generation. <br><br>  The three-address intermediate code will allow the use of optimization techniques that cannot be applied with the current approach.  For example, the convolution of commands of this kind and other optimizations: <br><blockquote> <code><font color="black">stloc.0 <br> ldloc.0</font></code> </blockquote> <br><h4>  Source Description (Bonuses) </h4><br>  I decided to post a <s>collection of bydlokod</s> all the labs that I had on the course ‚ÄúDesigning Compilers‚Äù in 2011 at Moscow State Technical University.  N. Bauman (11 option).  I think they will be useful to someone. <br><br>  Description of all laboratory: <br><ol><li>  <b>Task 1. Splitting grammar.</b>  In this lab, <b>the grammar splitting algorithm</b> is implemented.  A detailed description and sequence of steps can be found in the textbook ‚ÄúAho A., Ulman J. Theory of syntactic analysis, translation and compilation‚Äù in the second volume on page 102. I can only add that they use algorithms for removing useless (RemoveUselessSymbols) and unreachable (RemoveUnreachableSymbols a) characters from grammar. <br>  I remember that at that time I was still playing with LINQ.  So the code in these functions is far from efficient and beautiful, but rather short.  :) <br><br></li><li>  <b>Task 2. Recognition of chains of a regular language.</b>  Here are the following subtasks: <br><ol><li>  The solution of the standard system with regular coefficients. <br>  <i>Explanation</i> : You need to build a regular expression from the left-side grammar.  Those.  ‚ÄúSolve‚Äù a system with regular coefficients (RMS).  Ratios are terminals, and unknowns are non-terminals. <br>  For example, for such a grammar: <br><br> <code>Œ£ = {0, 1} <br> N = {S, A, B} <br> P = {S ‚Üí 0‚àôA|1‚àôS|Œª, A ‚Üí 0‚àôB|1‚àôA, B ‚Üí 0‚àôS|1‚àôB} <br> S = S</code> <br>  The following expression is obtained (there is a small error, but not the essence): <br><br> <code>S = 1*+1*‚àô0‚àô1*‚àô0‚àô1*‚àô0‚àô1*+1*‚àô0‚àô1*‚àô0‚àô(0‚àô1*‚àô0‚àô1*‚àô0)*‚àô0‚àô1* <br> A = 1*‚àô0‚àô1*‚àô0‚àô1*+1*‚àô0‚àô(0‚àô1*‚àô0‚àô1*‚àô0)*‚àô0‚àô1* <br> B = 1*‚àô0‚àô1*+(0‚àô1*‚àô0‚àô1*‚àô0)*‚àô0‚àô1* <br></code> <br><img src="http://habrastorage.org/storage2/2cb/70f/e74/2cb70fe74b69bcd8bd03984f340e96fb.png"><br><br>  When working on this laba it struck me that by overloading the usual operations in algebra '+', '*', '/', to the corresponding operations 'or', 'concatenation' and 'iteration' in the context of regular expressions, it is possible to solve the IBS method Gauss as well as we solve the usual SLAU!  The only thing is that in order to optimize something has been changed. <br><br>  However, overloading these operations is also a non-trivial task, because these are not numbers, but strings and rules are different here: during concatenation, you need to ‚Äúglue‚Äù strings, for operation 'or' you just need to leave them in the same form, zero is the empty set (√ò), the unit is lambda (Œª).  Accordingly, it is necessary to optimize these lines in the case of multiplication or addition by 0 or 1, otherwise they will quickly ‚Äúswell‚Äù. <br></li><li>  Using a regular expression, which is a solution to the standard system of equations with regular coefficients, construct an NFA (Nondeterministic State Machine). </li><li>  Deterministic to simulate the NKA.  In short, this is a modified depth search. </li></ol><br></li><li>  <b>Problem 3. Coca-Younger-Kasami algorithm</b> <br>  Here it was required to implement a syntactic parsing using <a href="http://en.wikipedia.org/wiki/CYK_algorithm">the Coca-Younger-Kasami algorithm</a> <br><br>   ,      <a href="http://en.wikipedia.org/wiki/Chomsky_normal_form">  </a> ,     .      <a href="http://ru.wikipedia.org/wiki/%25D0%259B%25D0%25B5%25D0%25BA%25D1%2581%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9_%25D0%25B0%25D0%25BD%25D0%25B0%25D0%25BB%25D0%25B8%25D0%25B7"></a> ,       ,    . <br><br>                . <br><br></li><li> <b> 4.   </b> <br>    <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B5%25D0%25BA%25D1%2583%25D1%2580%25D1%2581%25D0%25B8%25D0%25B2%25D0%25BD%25D1%258B%25D0%25B9_%25D1%2581%25D0%25BF%25D1%2583%25D1%2581%25D0%25BA">  </a> .         LL(*)  ( ANTLR).     .       . <br><br><img src="http://habrastorage.org/storage2/d63/f6c/393/d63f6c39368e39b518b99988ffcfc3c7.png"><br><br></li><li> <b> 5-8.    Cool</b> <br>         <s>----</s>    Cool   .NET,        . <br><br> ,  ,         Cool, ,  , : <br><ul><li> <b>Example1.cool</b> ‚Äî     ( ,    ,       ). </li><li> <b>BinaryTree.cool</b> ‚Äî   ,      ‚Äî      (,  ,   ).         <a href="">     </a> </li></ul></li><li>  ,       (      .pdf): <br><ol><li> <b>Evaluating Simple C Expressions</b> ‚Äî  -        . </li><li> <b>iFlop</b> ‚Äî     iFlop   . </li></ol></li></ol><br>  ,       ,         <a href="http://research.microsoft.com/en-us/downloads/f1303e46-965f-401a-87c3-34e1331d32c5/default.aspx">Microsoft.GLEE</a> .   <a href="http://research.microsoft.com/pubs/64284/gd2007-glee.pdf"> </a> ,     -    ,     ,             . (,         ). <br>     ,     .          <code>Edge AddEdge(string source, string target)</code> ,   <b>source</b> ‚Äî   , <b>target</b> ‚Äî   . <br>  Those.      ,    . <br><br>       ,    <code>Edge AddNode(string nodeId)</code> <br>        Edge,      ( ,  ,   .) <br><br>     ,      Microsoft :) <br><br>            <a href="https://www.lucidchart.com/">lucidchart.com</a> . <br><br><h4>  Literature </h4><br>     <a href="http://habrahabr.ru/blogs/gtd/136084/"> </a>  ,         ,   ,  . <br>   ¬´. ,   , 2008,  . ,  . ,  ,  . ¬ª. <br>     <a href="http://en.wikipedia.org/wiki/List_of_CIL_instructions">List of CIL instructions</a> ,    . <br><br><h4>   <a href="https://github.com/KvanTTT/Cool-Compiler">GitHub</a> </h4><br>  Everything! </div><p>Source: <a href="https://habr.com/ru/post/136714/">https://habr.com/ru/post/136714/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136706/index.html">Saturday Notes: On Dead Languages ‚Äã‚Äãand Living Practice</a></li>
<li><a href="../136708/index.html">Sky Map give in open source, Picnik photo editor close</a></li>
<li><a href="../136709/index.html">Iranian web developer sentenced to death</a></li>
<li><a href="../136710/index.html">Ericsson and ZTE were able to negotiate</a></li>
<li><a href="../136712/index.html">Toshiba introduced a waterproof tablet with wireless charging</a></li>
<li><a href="../136715/index.html">WebMoney allowed to display WMU in cash through UkrPoshta</a></li>
<li><a href="../136716/index.html">The terms of the MSDN Academic Alliance program have changed since January 16</a></li>
<li><a href="../136717/index.html">US Congress allowed to withdraw work from the public domain</a></li>
<li><a href="../136718/index.html">Meridian Mobile is already available for download.</a></li>
<li><a href="../136720/index.html">Plugin for input mask numbers in input</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>