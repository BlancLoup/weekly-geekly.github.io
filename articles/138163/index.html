<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimization ORDER BY - what many people forget</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Much has been written on the topic of optimizing MySQL queries, everyone knows how to optimize SELECT, INSERT, what needs to be jointed by key, etc. e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimization ORDER BY - what many people forget</h1><div class="post__text post__text-html js-mediator-article">  Much has been written on the topic of optimizing MySQL queries, everyone knows how to optimize SELECT, INSERT, what needs to be jointed by key, etc.  etc. <br><br>  But there is one moment, also repeatedly described in all manuals, but for some reason everyone forgets about it. <br><a name="habracut"></a><br><h4>  Optimization of ORDER BY in queries with joins. </h4><br>  <i>Justification: I used the search, I did not find it!</i> <br><br>  Most believe that if ORDER BY occurs by index, then there are no problems, but this is not always the case.  Recently, I dealt with a single query that wildly braked the base, although it seemed like all the indices were in the right places.  ORDER BY was the last place I poked, and the problem was there. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A small excerpt from the optimization manuals: <br><br>  === <br>  <b>How MySQL Optimizes ORDER BY</b> <br>  The following are some cases where MySQL can not use indexes to perform ORDER BY <br>  ... <br>  Several tables are linked, and columns are made <br>  sorting ORDER BY, refer not only to the first non-constant <br>  (const) table used to fetch rows (this is the first table <br>  in the EXPLAIN output, which does not use the constant, const, string fetching method). <br>  ... <br>  === <br><br>  For ORDER BY it is important that the table according to which the sorting will be performed comes first.  However, by default, in whatever order you would not join the tables, the optimizer built into mysql will rearrange them in the order that it considers necessary.  That is, if you put the desired table first in the query, this does not mean that it will actually be the first. <br><br>  Fortunately, the mysql optimizer can be told to join the tables in the order we specified, for this you need to add the command STRAIGHT_JOIN to the SELECT: <br><br>  SELECT STRAIGHT_JOIN ... FROM table JOIN ... ... ORDER BY table.row <br><br>  Checking on the mysql database of the PHPBB3 forum containing about 300,000 posts: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.*, p.*, u.username <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> phpbb3_topics <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t, phpbb3_posts <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> p, phpbb3_users <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t.topic_replies&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> p.poster_id=u.user_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> topic_first_post_id&lt;&gt;p.post_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> topic_approved=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> p.topic_id=t.topic_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.forum_id=<span class="hljs-string"><span class="hljs-string">'16'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> p.post_id&lt;<span class="hljs-string"><span class="hljs-string">'244103'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> post_id <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span></code> </pre> <br><br>  <b>Query took 12.2571 sec</b> <br><br>  in explain we see the terrible: Using where;  Using temporary;  Using filesort <br><br>  Changing the order of the tables (the cache of the muscle is reset by the reboot): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STRAIGHT_JOIN</span></span> t.*, p.*, u.username <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> phpbb3_posts <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> p, phpbb3_topics <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t, phpbb3_users <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t.topic_replies&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> p.poster_id=u.user_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> topic_first_post_id&lt;&gt;p.post_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> topic_approved=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> p.topic_id=t.topic_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t.forum_id=<span class="hljs-string"><span class="hljs-string">'13'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> p.post_id&lt;<span class="hljs-string"><span class="hljs-string">'234103'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> post_id <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span></code> </pre> <br><br>  <b>Query took 0.0447 sec</b> <br><br>  in explain: Using where; <br><br>  With such a forced rearrangement of the tables, we accelerated the execution of the query <b>300 times</b> ! <br><br>  This does not mean that you should always use STRAIGHT_JOIN and follow the order of the tables yourself.  But <b>in some cases</b> it is necessary. <br><br>  PS This request is used by Yandex for indexing phpbb forums.  Before optimization, the Yandex bot put the server <a href="http://www.php.ru/">php.ru</a> every night for several hours (the server is not very powerful).  Yandex‚Äôs blog had a discussion on this topic, but it was closed a couple of years ago and the decision was not voiced there. </div><p>Source: <a href="https://habr.com/ru/post/138163/">https://habr.com/ru/post/138163/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../138156/index.html">Controller for home brewery Mega Brewery. Part II</a></li>
<li><a href="../138157/index.html">‚ÄúSimple Business‚Äù - Organization Management Complex ". Version 1.6.1.6</a></li>
<li><a href="../138159/index.html">Leaflet library version 0.3 released</a></li>
<li><a href="../138161/index.html">We will evaluate your activity. Inexpensively</a></li>
<li><a href="../138162/index.html">Using bat files to deploy applications</a></li>
<li><a href="../138164/index.html">Update WIN and add Unlim</a></li>
<li><a href="../138166/index.html">Ulteo is a free solution for delivering desktops</a></li>
<li><a href="../138168/index.html">Exact calculation of geometric predicates</a></li>
<li><a href="../138170/index.html">IM + developers received funding of $ 10 million</a></li>
<li><a href="../138171/index.html">The history of computer viruses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>