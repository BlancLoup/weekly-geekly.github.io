<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to work with events in Flussonic</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Working with events in Flussonic for monitoring 
 Users often ask the question: how to make it so that Flussonic would send a letter when the stream d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to work with events in Flussonic</h1><div class="post__text post__text-html js-mediator-article"><h2>  Working with events in Flussonic for monitoring </h2><br>  Users often ask the question: how to make it so that Flussonic would send a letter when the stream drops. <br><br>  By turning on the bore you can mutter that it is not clear what a fall is, and so on.  There are a lot of questions, because the bitrate of the stream is non-zero, frames are coming, and there will be white noise or a black screen.  The flow seems to work, but in fact it does not.  But consider the solution of the original problem with the help of the new event system. <br><a name="habracut"></a><br>  The easiest option would be naive, but working.  Add to the streamer config: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">notify</span></span> no_video {  <span class="hljs-attribute"><span class="hljs-attribute">sink</span></span> /etc/flussonic/no_video.lua; }</code> </pre> <br>  in the <code>/etc/flussonic/no_video.lua</code> file <code>/etc/flussonic/no_video.lua</code> write: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">event</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pairs</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">events</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">do</span></span></span><span class="hljs-function"> --     ,     </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">event</span></span></span><span class="hljs-function">.</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">event</span></span></span></span> == <span class="hljs-string"><span class="hljs-string">"source_lost"</span></span> or <span class="hljs-keyword"><span class="hljs-keyword">event</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">event</span></span> == <span class="hljs-string"><span class="hljs-string">"stream_stopped"</span></span> then --    ,     mail.send({<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> = <span class="hljs-string"><span class="hljs-string">"flussonic@streamer1.mycdn"</span></span>, to = <span class="hljs-string"><span class="hljs-string">"marketing@team.mycdn"</span></span>, subject = <span class="hljs-string"><span class="hljs-string">"Source lost"</span></span>, body = <span class="hljs-string"><span class="hljs-string">"source lost on "</span></span>..<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>.media}) --        end end</code> </pre><br><h3>  Prefiltration </h3><br>  It is important not to put a personal email here, because when you run such a code on the production, many letters will have to be raked. <br><br>  A huge number of events are constantly generated inside the video streamer: for every open / closed session, for every fragment recorded in the archive, etc., so we‚Äôll start optimizing this code by using pre-filtering in the config file: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">notify</span></span> no_video { <span class="hljs-attribute"><span class="hljs-attribute">sink</span></span> /etc/flussonic/no_video.lua; <span class="hljs-attribute"><span class="hljs-attribute">only</span></span> event=source_lost,source_ready,stream_stopped; }</code> </pre><br>  This is important because filtering occurs in the code that sends the event, and not in the handler, as a result, you can cool off the code and not load one core, and this is very important on multi-core machines. <br><br><h3>  Configuration </h3><br>  A freshly written lua script will certainly be popular, plus you may want to send letters to one people for one group of threads, and to others for other threads.  You can write the script once, and keep its settings in the flusonic configuration: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">notify</span></span> no_video { <span class="hljs-attribute"><span class="hljs-attribute">sink</span></span> /etc/flussonic/no_video.lua; <span class="hljs-attribute"><span class="hljs-attribute">only</span></span> event=source_lost,source_ready,stream_stopped; <span class="hljs-attribute"><span class="hljs-attribute">to</span></span> marketing<span class="hljs-variable"><span class="hljs-variable">@team</span></span>.mycdn; <span class="hljs-attribute"><span class="hljs-attribute">from</span></span> flussonic<span class="hljs-variable"><span class="hljs-variable">@streamer1</span></span>.mycdn; }</code> </pre><br>  and in the script we use the <code>args</code> parameter: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">event</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pairs</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">events</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">do</span></span></span><span class="hljs-function">  </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">event</span></span></span><span class="hljs-function">.</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">event</span></span></span></span> == <span class="hljs-string"><span class="hljs-string">"source_lost"</span></span> or <span class="hljs-keyword"><span class="hljs-keyword">event</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">event</span></span> == <span class="hljs-string"><span class="hljs-string">"stream_stopped"</span></span> then   mail.send({<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> = args.<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>, to = args.to, subject = <span class="hljs-string"><span class="hljs-string">"Source lost"</span></span>, body = <span class="hljs-string"><span class="hljs-string">"source lost on "</span></span>..<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>.media})  end end</code> </pre><br>  We will slightly correct this script to send not many, but one letter and only if the problem was: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> body = "" <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> count = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k,event <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pairs(events) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> event.event == "source_lost" <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> event.event == "stream_stopped" <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>   count = count + <span class="hljs-number"><span class="hljs-number">1</span></span>   body = body.."  "..event.media.."\n"  <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> mail.send({<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> = args.<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> = args.<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>, subject = "Source lost", body = "source lost on: \n"..body}) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><h3>  Debounce </h3><br>  The script that we have turned out is still far from perfect and it will immediately become clear on a less live production, for example, with a bunch of custom cameras. <br><br>  Let's find a way to reduce mail traffic and make letters more useful.  Having received a message about the fall of the stream, we will not immediately send a letter, but wait for 30 seconds to collect who else has fallen. <br><br>  To do this, we use the built-in timer mechanism in Flussonic for event handlers.  The fact is that Flussonic saves the state of the handler between requests and starts the handler with this state in turn in one stream. <br><br>  Be careful with this: if you accumulate all the events in a buffer, you can drop the server. <br><br>  As soon as the first fall event arrives, we will wind up the timer and not send anything until it expires.  During this time, we will accumulate information about the fallen flows and then send it all at once. <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> new_dead_streams <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> new_dead_streams = {} <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> some_stream_died = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k,evt <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pairs(events) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> evt.event == "stream_stopped" <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> evt.event == "source_lost" <span class="hljs-keyword"><span class="hljs-keyword">then</span></span>  new_dead_streams[evt.media] = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>  some_stream_died = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> notify_timer <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> some_stream_died <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> notify_timer = flussonic.timer(<span class="hljs-number"><span class="hljs-number">30000</span></span>, "handle_timer", "go") <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> handle_timer(arg) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> body = "Local time "..flussonic.now().."\n" <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-type"><span class="hljs-type">name</span></span>,flag <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pairs(new_dead_streams) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>  body = body.."  "..name.."\n" <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>  new_dead_streams = {} mail.send({<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> = args.<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> = args.<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>, subject = "Source lost", body = body}) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  The <code>flussonic.timer</code> function first parameter takes the time to call the function in milliseconds, then the name of the function and then the argument. <br><br>  It is not possible to transfer a locally declared table, so be careful with this: send a number or string or use a global variable. <br><br><h3>  To hell with mail, let's be weak </h3><br>  Let's change the mailing list to push in the channel in the slak.  You need to go to <code>https://YOURTEAM.slack.com/apps/manage/custom-integrations</code> , from there go to the incoming webhooks <br><br>  There you will receive a view URL: <br><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/hooks.slack.com/services</span></span><span class="hljs-regexp"><span class="hljs-regexp">/NB8hv62/</span></span>ERBAdLVT/VW9teYkRPMp2NMbU</code> </pre> <br>  change <code>mail.send</code> to: <br><br><pre> <code class="hljs pgsql">  message = {<span class="hljs-type"><span class="hljs-type">text</span></span>= body, username= "flussonic" }  http.post(args.slack_url, {["content-type"] = "application/json"}, <span class="hljs-type"><span class="hljs-type">json</span></span>.encode(message))</code> </pre><br>  and change the configuration: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">notify</span></span> no_video { <span class="hljs-attribute"><span class="hljs-attribute">sink</span></span> /etc/flussonic/no_video.lua; <span class="hljs-attribute"><span class="hljs-attribute">only</span></span> event=source_lost,source_ready,stream_stopped; <span class="hljs-attribute"><span class="hljs-attribute">slack_url</span></span> https://hooks.slack.com/services/NB8hv62/ERBAdLVT/VW9teYkRPMp2NMbU; }</code> </pre><br><h3>  Why do we need args? </h3><br>  It would seem: why pass some parameters to the script, if the script can be corrected? <br><br>  Firstly, our practice is such that users who even Linux for the first time see us regularly turn to us for help, and editing the lua script for them is simply an unthinkable task: it‚Äôs easier to give them a script written by us from the package and put the necessary parameters into the config . <br><br>  Secondly, the same script can be used with different parameters for different streams.  It can be much easier for an experienced user to pass arguments through the config, and not through the heightened conditions in the script itself. <br><br><h3>  What is there under the hood? </h3><br>  In Flussonic, the system of events was a long time ago, almost since 2012, but the previous implementation was frankly lame.  Guided by the name of the module from stdlib, the <a href="http://erlang.org/doc/man/gen_event.html">gen_event</a> module was chosen to implement this mechanism. <br><br>  In short: never use <code>gen_event</code> , it is not needed anywhere.  One of the most important reasons: if a handler fails for gen_event for some reason, it silently silently (or with a small curse in the logs) will be deleted and there will be no restart. <br><br>  We have changed the internal structure of event handling.  Each handler described in the config is launched in a separate <code>gen_server</code> and will be restarted in case of a crash.  Each such process handler tries on each message to collect in a pack the maximum number of already committed events (but not more than a limit, about a thousand) and pass them all together to the processor.  This approach should reduce the overhead of sending over HTTP or writing to a file. <br><br>  This alteration made it possible to transfer the filtering of events to the sending process: so if you have a thousand streams on the server, and you only need to keep track of three, then not one core will be involved in filtering, but all 48 or how many you have.  This is an essential point for system scalability. <br><br>  A subtle, but important, nuance is that event handlers know how to monitor overloading and, in principle, even reset events.  If things are very bad, then flussonic will not endlessly accumulate events in the queues, but will start throwing them out.  Checking for congestion is very nontrivial, because in such cases it is impossible to pour the length of the queue of messages of the receiving process, so we do this through an independent check by the process sending events of our own liveliness. <br><br><h3>  Conclusion </h3><br>  In this article, I talked a little bit about how: <br><br>  # make your event handler in Flussonic on lua <br>  # send mail from lua: <code>mail.send</code> # make HTTP request with json body: <code>http.post</code> and <code>json.encode</code> # use timer: <code>flussonic.timer</code> . </div><p>Source: <a href="https://habr.com/ru/post/328108/">https://habr.com/ru/post/328108/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328098/index.html">Headquarters Touch Instinct. Tour of the St. Petersburg office</a></li>
<li><a href="../328100/index.html">Security Week 18: A hole in all systems with Intel Core, Apple took away a certificate from a Trojan, ran the wizard flooded the planet</a></li>
<li><a href="../328102/index.html">Phase modulation of the radio signal in the FPGA</a></li>
<li><a href="../328104/index.html">A detailed commentary by Dan Abramov on the article ‚ÄúThings that no one will tell you about React‚Äù</a></li>
<li><a href="../328106/index.html">Analysis of the report of Roman Nevolin about F #</a></li>
<li><a href="../328110/index.html">How I did a "<" monoid</a></li>
<li><a href="../328112/index.html">How to learn 100 English words per day</a></li>
<li><a href="../328114/index.html">PHDays HackQuest 2017: RanSomWare - a small cryptor on GO</a></li>
<li><a href="../328116/index.html">The story of creating a classic RTS at home from scratch (Part 2: "Resurrection"). Continuation of the article: GUI</a></li>
<li><a href="../328118/index.html">The story of creating a classic RTS at home from scratch (Part 2: "Resurrection") End of article: Network</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>