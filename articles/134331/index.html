<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A practical episode of the fight against DDoS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One young man loved to swear on a thematic resource. And for this he was regularly banned. And once they took, and not unban. 

 Offended the young ma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A practical episode of the fight against DDoS</h1><div class="post__text post__text-html js-mediator-article">  One young man loved to swear on a thematic resource.  And for this he was regularly banned.  And once they took, and not unban. <br><br>  Offended the young man, and decided to take revenge.  I saved up money, took it and ordered a DDoS resource.  Fortunately, this is not a criminal offense in the Russian Federation, unfortunately, a punishable act. <br><br>  The DDoS, for which the young man managed to accumulate, was to send the same HTTP requests to the army of bots. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As usual, for picky administrators there were no satisfactory looking solutions that simply read the HTTP log and give out the addresses that should be banned. <br>  Therefore, I had to build my own amusement park, with this and these same ones.  A comrade <a href="https://habrahabr.ru/users/metakey/" class="user_link">metakey</a> managed to write the logic of assigning an ip to a ban, and your humble servant - set up the rest of the harness. <br><br>  Those who (prefers) read Hemingway in the original can immediately <a href="https://github.com/unicodefreak/log2ban">go here</a> .  There and the code can also be found. <br><br><a name="habracut"></a><br><br>  For all others and just lazy - I will continue here.  Sorry, that without pictures.  But everything in the case ... <br><br><h4>  log2ban </h4><br><br><h5>  How log2ban works </h5><br><br>  To detect bots, each request to the server is marked with an identifier from the properties of the request (for example, from an IP address and URL: "1.2.3.4/login.php").  When the number of calls with a specific ID reaches the set limit, within the time window of the discovery, the client IP is passed as an argument for an external command (BAN_IP_COMMAND) or collected for a batch block (see ‚ÄúList Blocking‚Äù). <br><br>  Log2ban is working on server logs in real time, and is not intended for use as a log archive analyzer.  You should use the firewall tools to block the system itself (settings and scripts for ipset are attached in the example). <br><br>  The script reads the log in real time, using, for example, "tail -f" or a similar command, as specified in the configuration.  If the command sends EOF, log2ban will exit.  If the command stops writing journal entries to standard output, the log2ban process will hang forever. <br><br><h5>  Customization </h5><br><br>  The default Apache / Nginx log template is supported.  Changes made to the format should be reflected in the variable ACCESS_LOG_RECORD_FORMAT. <br><br>  You can also configure discovery rules.  The most important parameter is TOLERANCE_MARGIN (the number of hits in the window).  The second most important are WINDOW_SIZE (window size in slots) and SLOT_INTERVAL.  (slot size in seconds) A shorter interval and an increased size means better detection (and worse performance). <br><br>  To change the rules for calculating IDs, change the "create_server_hit_id" function. <br><br>  To change the rules for skipping lines in the logs, change the function "skip".  By default, requests for static file types are skipped. <br><br><h5>  Blocking lists </h5><br><br>  To use blocking by lists, turn on the database, process the logs for a while, and then execute <br><br> <code>python log2ban.py print (banned | allbanned)</code> <br> <br>  print the collected IP addresses to stdout.  ‚ÄúBanned‚Äù will print only new IP addresses (since the last print banned), while ‚Äúallbanned‚Äù will print each prohibited IP, regardless of whether it was previously printed or not. <br><br>  After several days, the IP addresses will be unbanned to get their list: <br><br> <code>python log2ban.py print (unbanned)</code> <br> <br>  This command will print every IP that was banned during the current_time period - DAYS_UNBAN, and will delete the entries from the database. <br><br><h5>  Performance </h5><br><br>  log2ban is fast enough by itself, but for very fast-growing logs, processing requests can be a problem.  Consider disabling the registration of requests for static resources, such as images, scripts and style sheets.  Further optimization may include a simpler log format (CSV), instead of using the default format, which is processed by the apachelog module through regular expressions. <br><br><h4>  Firewall installation and integration </h4><br><br>  The process is described for Debian Squeeze 6.0, for other distributions it may differ. <br><br>  Install ipset: <br><br> <code>sudo apt-get install module-assistant xtables-addons-source <br> sudo module-assistant prepare <br> sudo module-assistant auto-install xtables-addons-source <br> depmod -a <br></code> <br><br>  Check that it works. <br> <code>ipset -L <br></code> <br><br>  If you get a non-empty response, such as the error 'Module ip_set not found', then ipset is not installed correctly.  Googling this problem for your specific installation.  The general idea is that the ip_set kernel module should be locally compiled and loaded into the kernel. <br><br>  Install MongoDB, Python, and PIP: <br><br> <code><br> sudo apt-get install mongodb python-pip <br></code> <br><br>  Install modules for python: <br><br> <code>sudo pip install apachelog pexpect pymongo <br></code> <br><br>  Clone the log2ban repository: <br><br> <code>git clone git://github.com/unicodefreak/log2ban.git <br></code> <br><br>  In the log2ban.py file, configure the following command, if necessary. <br><br> <code>ECHO_LOG_COMMAND = "tail -f /var/log/nginx/access.log" <br></code> <br><br>  Add the following text to /etc/logrotate.d/nginx: <br><br> <code>/var/log/nginx/*log { <br> daily <br> rotate 10 <br> missingok <br> notifempty <br> compress <br> sharedscripts <br> postrotate <br> [ ! -f /var/run/nginx.pid ] || kill -USR1 `cat /var/run/nginx.pid` <br> /etc/init.d/log2ban stop <br> /etc/init.d/log2ban start <br> endscript <br> } <br></code> <br><br>  Install scripts <br><br> <code>sudo mkdir /opt/log2ban <br> sudo cp log2ban/log2ban.py /opt/log2ban/ <br> sudo cp log2ban/ipset-control.sh /opt/log2ban/ <br> sudo cp log2ban/init-scripts/log2ban-debian.sh /etc/init.d/log2ban <br> sudo chmod +x /etc/init.d/log2ban <br> sudo chmod +x /opt/log2ban/ipset-control.sh <br></code> <br><br>  Run MongoDB <br> <code>sudo /etc/init.d/mongodb start <br></code> <br><br>  Run log2ban <br><br> <code>sudo /etc/init.d/log2ban start <br></code> <br><br>  Add the following command to the root cron script, for example, to update addresses every 5 minutes <br> <code>*/5 * * * * /opt/log2ban/ipset_control.sh update <br></code> <br><br>  Let him work for a while.  Check if any IPs are blocked: <br> <code>sudo ipset -L <br></code> <br><br>  If the list is similar to the truth, then the last step is to connect iptables. <br><br>  Add a line: <br><br> <code>-A INPUT -m set --match-set autoban src -j DROP <br></code> <br>  in the /etc/firewall.conf file and execute <br><br> <code>sudo /etc/init.d/networking restart <br></code> <br><br>  Everything, you can open the champagne ... and other drinks to taste. </div><p>Source: <a href="https://habr.com/ru/post/134331/">https://habr.com/ru/post/134331/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134319/index.html">The company that created STALKER, ceased to exist</a></li>
<li><a href="../134324/index.html">One of the patents in the Oracle v. Android lawsuit was rejected</a></li>
<li><a href="../134326/index.html">Validating CSS in Visual Studio 2010 using the CSSCop extension</a></li>
<li><a href="../134327/index.html">MongodbLogger - add logs of your Rails 3 application to MongoDB</a></li>
<li><a href="../134329/index.html">WebOS will become open source</a></li>
<li><a href="../134333/index.html">HP plans to release new tablets on webOS in 2013</a></li>
<li><a href="../134334/index.html">XenApp: Installation and Configuration Experience</a></li>
<li><a href="../134338/index.html">How many pages of search engine information do you study before rephrasing a query?</a></li>
<li><a href="../134340/index.html">Petersburg startup: media and an online catalog for parents, building an effective platform for web promotion</a></li>
<li><a href="../134343/index.html">MirrorLink technology in your car</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>