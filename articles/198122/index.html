<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mail.Ru Mail's transition to 64-bit architecture: how it was</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For several months, the fronts of Mail.Ru Mail have become 64bit. Better late than never, we decided, and today I will tell why we did it, what we wen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mail.Ru Mail's transition to 64-bit architecture: how it was</h1><div class="post__text post__text-html js-mediator-article">  For several months, the fronts of Mail.Ru Mail have become 64bit.  Better late than never, we decided, and today I will tell why we did it, what we went through for this and how we did it. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/52b/ab6/b8f/52bab6b8f27ce4580f11fbeb2715e46e.jpg"><br><br>  <b>And so it works</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For a long time, our Mail worked on 32 bits on the first Apache and Perl 5.8 running CentOS 5. The idea to switch frontend to more modern software and 64-bit architecture wandered in our minds a long time ago, just a year and a half ago only two people - one admin and one developer - for some week without sleep they raised a test server on which our bright future spun.  However, in those days we had more urgent tasks, and the server was safely forgotten.  Periodically, they returned to this idea, but everything happened in the mode ‚ÄúWhat if so?  ‚ÄúOh, something broke!‚Äù, And again everything was rolled away and put off for a long time. <br><a name="habracut"></a><br>  <b>Time has come</b> <br><br>  Finally it's time for a change.  At some point, we realized that it could not continue like this: full support for CentOS 5 ceases in 2014, Perl 5.10 on some tasks shows a 30% increase in speed, not to mention the fact that 32-bit architecture in the 21st century is somewhat behind the desired. <br>  In addition, after we <a href="http://habrahabr.ru/company/mailru/blog/158603/">transferred Mail to HTTPS</a> , the load average on the front-end servers increased, so that more efficient Perl became more relevant than ever. <br><br>  <b>Transition difficulties</b> <br><br>  First of all, we had to rewrite the code points that directly interact with Apache.  Since Apache's ErrorLog is tied up with our monitoring system, we had to teach the new server how to log errors in the way we need.  The result is a self-written Apache 2 error logging module, available by <a href="https://github.com/Mons/Apache2-Warn">reference</a> . <br>  In addition, we had to deal with dependencies: all the packages we used historically collected under the c5x32 architecture and in this form were added to the repository.  In the changed realities, everything, including modules under nginx, had to be reassembled for c6x64. <br>  The captcha generation module has also been completely rewritten. <br>  However, banners gave us the most trouble.  Our entire layout is built on slots, the contents of which, including banners, are taken from a template engine written in C and deeply integrated into Apache.  The module responsible for the banners picks up the Apache headers and is already targeting them.  To make it all take off under Apache 2, it was necessary not only to work hard, but also to shake the guys from the relevant department. <br><br>  <b>Binary Protocols</b> <br><br>  In Mail.Ru Mail, interaction often occurs via binary protocols.  First of all, this communication with our data warehouse Tarantool.  In addition to the database, even between our services, for example, a Perl server and a C server, the data is transmitted in binary form.  This is good, fast and convenient, until it comes to changing architecture. <br>  Every time you need to encrypt data or add modulo, the probability that the results of the operation on x32 and x64 will be different, becomes non-zero.  Complicated by the fact that these differences manifest themselves only on specific data, so looking for, catching and fixing these cases is not a trivial task. <br>  For example, the first line of code below will work on different architectures in completely different ways. <br>  my $ crypted_userid = $ user -&gt; {'ID'} ^ 41262125215; <br>  getpage ('project_url_api? user_id ='. $ crypted_userid); <br>  This difference in behavior leads to problems in completely unexpected places and even on different projects.  For example, the new results of executing the code with the user‚Äôs user-led data led to the fact that, thanks to our common authorization system, changing the password by one user led to the unlocking of a completely different user from another service. <br>  The same encryption problem was found in the Mail itself.  After sending the letter, the user is sent to the URL, which, among other things, contains encrypted recipients (no one wants his email to be sent to the address bar in the clear).  What happened after we started building a URL on a 64-bit architecture is easy to guess: instead of a list of recipients, a random set of characters appeared. <br>  Of course, these problems are now solved, but their trapping took considerable time. <br><br>  <b>A total of two</b> <br><br>  The transition itself was completed in two months.  Before this happened, for about six months our Mail worked on both old fronts and new ones.  We carefully monitored the behavior of these two systems: there were two separate graphs on our dashboards, on which we monitored where there were more errors and what worked faster.  A funny story is connected with them - once in the middle of the night everyone was lifted up to their ears, because on the performance graphs of the new fronts the lines were higher - it turned out that they were working much slower.  Then, however, it turned out that we were so optimized that the scale for the new fronts automatically changed an order of magnitude, and in fact they work 10 times faster.  However, we managed to get scared. <br>  In addition, under the conditions of the two systems, it is impossible to just simply retrieve and process the Apache requester.  You have to do the following: <br>  sub GetApacheRequest { <br>  $ Env {mod_perl} = ~ m {mod_perl / 2}?  Apache2 :: RequestUtil-&gt; request (): Apache-&gt; request (); <br>  } <br>  Packaging packages for the Post also began to be full of conditions of the form <br>  % if 0% {? centos} == 6 <br>  ... <br>  % if 0% {? centos} == 5 <br>  ... <br>  And there are lots of places like this. <br>  In addition to monitoring and making changes to two branches at once, we, of course, had to test new iterations twice as long, but our testers coped. <br><br>  <b>Reward for the works</b> <br><br>  So, what did we get as a result of this painstaking and sometimes nervous work? <br><ul><li>  <b>Full support for CentOS</b> 6 - new patches, current system status </li><li>  <b>Fast regulars in Perl 5.10.</b>  Scripts that perform analysis and parsing fly even faster. </li><li>  <b>Apache 2 picks up the new config and scripts without restarting.</b>  Layout of the code and configs does not lead to the 500th error (theoretically, the first Apache was also able to, but getting him to do it normally without disconnecting the front from the load is a fiction task) </li><li>  <b>Total refactoring.</b>  Switching to new software is a great reason to get rid of unnecessary dependencies, unnecessary entities and unused modules. </li><li>  <b>Using <a href="http://puppetlabs.com/puppet/what-is-puppet">Puppet</a></b> .  We decided to go for a walk, we decided, and at the same time switched to Puppet.  Now the layout of new features and hotfix deployment has become much easier. </li></ul><br>  One would expect that the transition from 32 to 64 bits would have a detrimental effect on the memory consumption of Apache, which is already trying to eat everything that they give.  The amount of memory allocated for one process, of course, has grown, and there is no getting away from it.  However, everything began to work faster, so fewer processes cope with the tasks, so that, in general, the cost of memory has not increased.  Around profit. <br>  Perl 5.10, by the way, gives us an additional advantage: the simplicity of the transition to 5.16 compared to the painful transition from 5.8.8.  So wait for the new Perl in our Mail. <br>  If you have any questions, I suggest to discuss them in the comments. <br><br>  <i>Ilya Zaretsky,</i> <i><br></i>  <i>Team Leader Backend Mail Development</i> </div><p>Source: <a href="https://habr.com/ru/post/198122/">https://habr.com/ru/post/198122/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../198112/index.html">Translation of the book ‚ÄúAvailable 3D printing for science, education and sustainable development‚Äù (Low-cost 3D Printing for Science, Education and Sustainable Development), 2013</a></li>
<li><a href="../198114/index.html">Impractical triage - meaningless and merciless</a></li>
<li><a href="../198116/index.html">Compile the code from the code to reproduce the race of the two processes.</a></li>
<li><a href="../198118/index.html">Intergeo 2013. Essen. Germany. Laser scan</a></li>
<li><a href="../198120/index.html">So that you live on donate!</a></li>
<li><a href="../198124/index.html">100,000 years since the invention of the wheel</a></li>
<li><a href="../198126/index.html">Retinafy everything</a></li>
<li><a href="../198128/index.html">Free mobile phone calls via Tele2</a></li>
<li><a href="../198132/index.html">02 Collector: Friday content, 3D and typography</a></li>
<li><a href="../198134/index.html">The user selected the domain for "renewal of registration with malicious intent"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>