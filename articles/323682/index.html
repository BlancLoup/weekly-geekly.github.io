<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The problem of saving context in asynchronous programming in scala</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At some point in the project there is a question of tracking the progress of the operation, receiving or storing some information about it. For this, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The problem of saving context in asynchronous programming in scala</h1><div class="post__text post__text-html js-mediator-article">  At some point in the project there is a question of tracking the progress of the operation, receiving or storing some information about it.  For this, the context of the operation serves as best as possible, for example, the context of a client session.  If it is interesting to you how it can be made rather without serious consequences, I ask under kat. <br><a name="habracut"></a><br>  In the java world, often (but not always), each operation is performed in its own thread.  And here everything turns out pretty simple, you can use the <b>ThreadLocal</b> object and receive it at any time during the operation: <br><br><pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;Context&gt; global = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThreadLocal&lt;Context&gt;; } <span class="hljs-comment"><span class="hljs-comment">//-     Context context = new Context(...); Context.global.set(context); try { someService.someMethod(); } finally { Context.global.set(null); }</span></span></code> </pre> <br>  In scala, often, things are not so simple, and in the course of an operation, the flow can change repeatedly, for example, in very asynchronous applications.  And the way with <b>ThreadLocal is</b> no longer suitable (as is the case with switching threads in java, of course). <br><br>  The first thing that comes to mind is to pass the context through the function's implicite argument. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span></span>(bar: <span class="hljs-type"><span class="hljs-type">Bar</span></span>)(<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> context: <span class="hljs-type"><span class="hljs-type">Context</span></span>)</code> </pre><br>  But it will litter the protocol of services.  Having broken a little head, a rather simple idea came: to bind the context to the objects of the service, and distribute it to internal services as functions are called. <br><br>  Suppose our context looks like this: <br><br><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">//data -       class Context(val operationId: String, val data: TrieMap[String, String] = TrieMap.empty)</span></span></code> </pre><br>  Create traits with which to label context-sensitive objects: <br><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContextualObject</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">context</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">Context</span></span>] } <span class="hljs-comment"><span class="hljs-comment">//,     trait ChangeableContextualObject[T &lt;: ContextualObject] extends ContextualObject { def withContext(ctx: Option[Context]): T } //    trait EmptyContext { _: ContextualObject =&gt; override protected val context: Option[Context] = None }</span></span></code> </pre><br>  Now we will announce our services and implementations: <br><br><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">//,       trait ServiceA extends ChangeableContextualObject[ServiceA] { def someSimpleOperation: Int def someLongOperation(implicit executionContext: ExecutionContext): Future[Int] } trait ServiceAImpl extends ServiceA { override def someSimpleOperation: Int = 1 override def someLongOperation(implicit executionContext: ExecutionContext): Future[Int] = { Future(someSimpleOperation) .map { res =&gt; // -    ,    context.foreach(_.data.put("ServiceA.step1", res.toString)) res * Random.nextInt(10) } .map { res =&gt; context.foreach(_.data.put("ServiceA.step2", res.toString)) res - Random.nextInt(5) } .andThen { case Success(res) =&gt; context.foreach(_.data.put("ServiceA.step3", res.toString)) } } //      override def withContext(ctx: Option[Context]): ServiceA = new ServiceAImpl { ctx.foreach(_.data.put("ServiceA.withContext", "true")) override protected def context: Option[Context] = ctx } } object ServiceAImpl { def apply(): ServiceAImpl = new ServiceAImpl with EmptyContext }</span></span></code> </pre><br>  And the second service that will use the first one: <br><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceB</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChangeableContextualObject</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ServiceB</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">someOperationWithoutServiceA</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">someOperationWithServiceA</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> executionContext: <span class="hljs-type"><span class="hljs-type">ExecutionContext</span></span>): <span class="hljs-type"><span class="hljs-type">Future</span></span>[<span class="hljs-type"><span class="hljs-type">Boolean</span></span>] } <span class="hljs-comment"><span class="hljs-comment">/** *         : *            ? *     EmptyContext   , *       withContext. * ,  ,      cake pattern    */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceBImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceB</span></span></span><span class="hljs-class"> </span></span>{ self =&gt; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serviceA</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">ServiceA</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">someOperationWithoutServiceA</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Int</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">someOperationWithServiceA</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> executionContext: <span class="hljs-type"><span class="hljs-type">ExecutionContext</span></span>): <span class="hljs-type"><span class="hljs-type">Future</span></span>[<span class="hljs-type"><span class="hljs-type">Boolean</span></span>] = { serviceA.someLongOperation.map { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> res <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> res % <span class="hljs-number"><span class="hljs-number">2</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span> =&gt; context.foreach(_.data.put(<span class="hljs-string"><span class="hljs-string">"ServiceB.res"</span></span>, <span class="hljs-string"><span class="hljs-string">"even"</span></span>)) <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> res =&gt; context.foreach(_.data.put(<span class="hljs-string"><span class="hljs-string">"ServiceB.res"</span></span>, <span class="hljs-string"><span class="hljs-string">"odd"</span></span>)) <span class="hljs-literal"><span class="hljs-literal">false</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">withContext</span></span></span></span>(ctx: <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">Context</span></span>]): <span class="hljs-type"><span class="hljs-type">ServiceB</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">ServiceBImpl</span></span> { ctx.foreach(_.data.put(<span class="hljs-string"><span class="hljs-string">"ServiceB.withContext"</span></span>, <span class="hljs-string"><span class="hljs-string">"true"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> context: <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">Context</span></span>] = ctx <span class="hljs-comment"><span class="hljs-comment">// ,  ,        //      lazy val, //        ,     . //       override protected lazy val serviceA: ServiceA = self.serviceA.withContext(ctx) } } object ServiceBImpl { //    -        , //    ,        . //      : // class Builder(val serviceA: ServiceA) extends ServiceBImpl with EmptyContext //    : // new ServiceBImpl.Builder(serviceA) // , ,   ,     . def apply(a: ServiceA): ServiceBImpl = new ServiceBImpl with EmptyContext { //         val override protected val serviceA: ServiceA = a } }</span></span></code> </pre><br>  As a result, in the place of the call we will receive the following code: <br><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Context</span></span>(<span class="hljs-string"><span class="hljs-string">"opId"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> serviceBWithContext = serviceB.withContext(<span class="hljs-type"><span class="hljs-type">Some</span></span>(context)) serviceBWithContext.someOperationWithoutServiceA context.data.get(<span class="hljs-string"><span class="hljs-string">"ServiceB.withContext"</span></span>) <span class="hljs-comment"><span class="hljs-comment">// Some("true") context.data.get("ServiceA.withContext") // None serviceBWithContext.someOperationWithServiceA.andThen { case _ =&gt; context.data.get("ServiceA.withContext") // Some("true") context.data.get("ServiceA.step1") // Some("1") }</span></span></code> </pre><br>  Everything is quite simple - thus, in the course of the operation there will be the same context.  But it is necessary for this to find some real use.  For example, we recorded important information during the operation, and now we want to log this information.  The simplest option was to create a logger for each context, and when writing to the message log, assign this information to it.  But there is a logging problem that occurs outside of your code (for example, in a third-party library). <br><br>  To ensure that the context can be used outside of our code, we will make <b>ThreadLocal</b> with our context: <br><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Context</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> global: <span class="hljs-type"><span class="hljs-type">ThreadLocal</span></span>[<span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">Context</span></span>]] = <span class="hljs-type"><span class="hljs-type">ThreadLocal</span></span>.withInitial[<span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">Context</span></span>]](() =&gt; <span class="hljs-type"><span class="hljs-type">None</span></span>) <span class="hljs-comment"><span class="hljs-comment">//    def runWith[T](context: Context)(operation: =&gt; T): T = { runWith(Some(context))(operation) } //    def runWith[T](context: Option[Context])(operation: =&gt; T): T = { val old = global.get() global.set(context) //         try operation finally global.set(old) } }</span></span></code> </pre><br>  For example, if you use the <b>logback-classic</b> library for logging, then you can write your Layout to log these parameters. <br><br><div class="spoiler">  <b class="spoiler_title">Possible implementation</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OperationContextLayout</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LayoutBase</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ILoggingEvent</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> separator: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-type"><span class="hljs-type">System</span></span>.getProperty(<span class="hljs-string"><span class="hljs-string">"line.separator"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doLayout</span></span></span></span>(event: <span class="hljs-type"><span class="hljs-type">ILoggingEvent</span></span>): <span class="hljs-type"><span class="hljs-type">String</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">StringBuilder</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) sb.append(event.getFormattedMessage) .append(separator) appendContextParams(sb) appendStack(event, sb) sb.toString() } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">appendContextParams</span></span></span></span>(sb: <span class="hljs-type"><span class="hljs-type">StringBuilder</span></span>): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = { <span class="hljs-type"><span class="hljs-type">Context</span></span>.global.get().foreach { ctx =&gt; sb.append(<span class="hljs-string"><span class="hljs-string">"operationId="</span></span>) .append(ctx.operationId) ctx.data.readOnlySnapshot().foreach { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (key, value) =&gt; sb.append(<span class="hljs-string"><span class="hljs-string">" "</span></span>).append(key).append(<span class="hljs-string"><span class="hljs-string">"="</span></span>).append(value) } sb.append(separator) } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">appendStack</span></span></span></span>(event: <span class="hljs-type"><span class="hljs-type">ILoggingEvent</span></span>, sb: <span class="hljs-type"><span class="hljs-type">StringBuilder</span></span>): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event.getThrowableProxy != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> converter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">ThrowableProxyConverter</span></span> converter.setOptionList(<span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-string"><span class="hljs-string">"full"</span></span>).asJava) converter.start() sb.append() } } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Possible config</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"STDOUT"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ch.qos.logback.core.ConsoleAppender"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">encoder</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ch.qos.logback.core.encoder.LayoutWrappingEncoder"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">layout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"operation.context.logging.OperationContextLayout"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">encoder</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">level</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"debug"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender-ref</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"STDOUT"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  And we will try to secure something: <br><br><pre> <code class="scala hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runWithoutA</span></span></span></span>(): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> context = <span class="hljs-type"><span class="hljs-type">Some</span></span>(createContext()) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> res = serviceB.withContext(context).someOperationWithoutServiceA <span class="hljs-type"><span class="hljs-type">Context</span></span>.runWith(context) { <span class="hljs-comment"><span class="hljs-comment">// Result of someOperationWithoutServiceA: '1' // operationId=GPapC6JKmY ServiceB.withContext=true logger.info(s"Result of someOperationWithoutServiceA: '$res'") } }</span></span></code> </pre><br><pre> <code class="scala hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runWithA</span></span></span></span>(): <span class="hljs-type"><span class="hljs-type">Future</span></span>[_] = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> context = <span class="hljs-type"><span class="hljs-type">Some</span></span>(createContext()) serviceB.withContext(context).someOperationWithServiceA.andThen { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> _ =&gt; <span class="hljs-type"><span class="hljs-type">Context</span></span>.runWith(context) { <span class="hljs-comment"><span class="hljs-comment">// someOperationWithServiceA completed // operationId=XU1SGXPq1N ServiceB.res=even ServiceA.withContext=true ServiceB.withContext=true ServiceA.step1=1 ServiceA.step2=7 ServiceA.step3=4 logger.info("someOperationWithServiceA completed") } } }</span></span></code> </pre><br>  And the question remains: what about the external code that runs in the <b>ExecutionContext</b> ?  But no one bothers us to write a wrapper for him: <br><br><div class="spoiler">  <b class="spoiler_title">Possible implementation of a wrapper</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContextualExecutionContext</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">context: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Option</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Context</span></span></span></span><span class="hljs-class"><span class="hljs-params">], executor: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ExecutionContext</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExecutionContext</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span></span>(runnable: <span class="hljs-type"><span class="hljs-type">Runnable</span></span>): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = executor.execute(() =&gt; { <span class="hljs-type"><span class="hljs-type">Context</span></span>.runWith(context)(runnable.run()) }) <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reportFailure</span></span></span></span>(cause: <span class="hljs-type"><span class="hljs-type">Throwable</span></span>): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = { <span class="hljs-type"><span class="hljs-type">Context</span></span>.runWith(context)(executor.reportFailure(cause)) } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContextualExecutionContext</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContextualExecutionContextOps</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">val executor: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ExecutionContext</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnyVal</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">withContext</span></span></span></span>(context: <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">Context</span></span>]): <span class="hljs-type"><span class="hljs-type">ContextualExecutionContext</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">ContextualExecutionContext</span></span>(context, executor) } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Possible implementation of an external system</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeExternalObject</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> logger: <span class="hljs-type"><span class="hljs-type">Logger</span></span> = <span class="hljs-type"><span class="hljs-type">LoggerFactory</span></span>.getLogger(classOf[<span class="hljs-type"><span class="hljs-type">SomeExternalObject</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">externalCall</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> executionContext: <span class="hljs-type"><span class="hljs-type">ExecutionContext</span></span>): <span class="hljs-type"><span class="hljs-type">Future</span></span>[<span class="hljs-type"><span class="hljs-type">Int</span></span>] = { <span class="hljs-type"><span class="hljs-type">Future</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>).andThen { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">Success</span></span>(res) =&gt; logger.debug(<span class="hljs-string"><span class="hljs-string">s"external res </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$res</span></span></span><span class="hljs-string">"</span></span>) } } }</code> </pre><br>  Let's try to make a call in our <b>ExecutionContext</b> : <br><br></div></div><br><pre> <code class="scala hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runExternal</span></span></span></span>(): <span class="hljs-type"><span class="hljs-type">Future</span></span>[_] = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> context = <span class="hljs-type"><span class="hljs-type">Some</span></span>(createContext()) <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> executor = global.withContext(context) <span class="hljs-comment"><span class="hljs-comment">// external res 1 // operationId=8Hf277SV7B someExternalObject.externalCall }</span></span></code> </pre><br>  That's the whole idea.  In fact, the use of context is not limited to logging.  You can store anything in this context.  For example, a cast of some state, if you want all services during the operation to work with the same data.  And so on and so forth. <br><br>  If there is a need for the implementation of tracking the context when communicating actors, write in the comments, add the article.  If you have ideas about a different implementation, also write in the comments, it will be interesting to read. <br><br>  <b>PS</b> The source code of the project used in the article <a href="https://github.com/eld0727/scala-operation-context">github.com/eld0727/scala-operation-context</a> . <br>  <b>PPS</b> I am sure that this approach can be applied to other languages ‚Äã‚Äãthat allow you to create anonymous classes, and this is just a possible implementation on scala. </div><p>Source: <a href="https://habr.com/ru/post/323682/">https://habr.com/ru/post/323682/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../323670/index.html">And you hto such? The evolution of MySQL and MariaDB authentication protocols in faces</a></li>
<li><a href="../323672/index.html">Instagram redesign: experience analyzing and rethinking the interface</a></li>
<li><a href="../323674/index.html">Getting started in STM32CubeMX. Part 3</a></li>
<li><a href="../323676/index.html">GameDev from scratch: From the hackathon to your own game development studio. Part 2</a></li>
<li><a href="../323680/index.html">Thief: creating a narrative with level design and mechanics</a></li>
<li><a href="../323684/index.html">Duke Nukem 3D Source Code Analysis: Part 2</a></li>
<li><a href="../323686/index.html">Great overview of the best designers of mobile applications in 2017</a></li>
<li><a href="../323688/index.html">LIFT: Learned Invariant Feature Transform</a></li>
<li><a href="../323692/index.html">Universal grammar analyzer of natural languages ‚Äã‚Äãfrom scratch. Release 1</a></li>
<li><a href="../323694/index.html">How Discord stores billions of messages</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>