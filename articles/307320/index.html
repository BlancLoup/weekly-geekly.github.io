<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multigrain: Features of PoS Terminal Malware</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Multigrain is a malware for PoS terminals that specializes in stealing information from bank cards using RAM-Scraping techniques (it directly accesses...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multigrain: Features of PoS Terminal Malware</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/b04/6a1/66f/b046a166f50148e6b14e5b1fb743f75d.jpg"><br><br>  <b>Multigrain is a malware for PoS terminals</b> that specializes in stealing information from bank cards using RAM-Scraping techniques (it directly accesses RAM from certain processes to obtain information about cards).  This has become a very popular method, since  international law prohibits storing this information on disk (even temporarily). <br><br>  Another feature of Multigrain is that it uses DNS calls to communicate with the outside world (and thus it can send stolen information).  In this article, we will analyze the malware itself, as well as how it performs its communications. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In April of this year, FireEye <a href="https://www.fireeye.com/blog/threat-research/2016/04/multigrain_pointo.html">published an</a> analysis of this malware, and it seems that this was the first time that they discovered the Multigrain variant.  In this article, the analysis was related to a sample that was discovered in PandaLabs anti-virus laboratory in November 2015 (MD5: A0973ADAF99975C1EB12CC1E333D302F), and since then we have been able to detect new variants or updates of this malicious program, since  fundamentally they worked the same way. <br><br><h4>  <b>Multigrain in detail: technical analysis</b> </h4><br>  We started analyzing Multigrain, because this code, which shows the characteristics of RAM-Scraping, is typical of PoS malware.  We can clearly see this in procedure 00405A10, shown below. <br><br><img src="https://habrastorage.org/files/8ec/644/233/8ec6442332864f42b7899de69c6f0e22.png"><br><br>  In this procedure, we find typical calls from a process that performs RAM-Scraping in the memory of running processes: <br><br>  ‚Ä¢ <b>CreateToolhelp32Snapshot</b> to get the process list pointer; <br>  ‚Ä¢ <b>Process32FirstW and Process32NextW</b> to get a snapshot of the list of processes after calling the previous API; <br>  ‚Ä¢ <b>OpenProcess is</b> used later to get a list of memory pages with <b>VirtualQueryEx</b> ; <br>  ‚Ä¢ Finally, with <b>ReadProcessMemory,</b> you can read the content from previous pages. <br><br>  Once the buffer is received, using the content from each page, the malware will perform the corresponding "scrapping".  To do this, it uses (in the same procedure) the second pseudocode: <br><br><img src="https://habrastorage.org/files/db8/793/4b3/db87934b335847dbbcfb2970994a54cb.png"><br><br>  If possible TRACKS1 / 2 sequences are detected, associated with the code from the magnetic stripe of a bank card in the buffers from the analyzed memory, the functions sub_406100 and sub_405D10 are called.  Now the malware is ready to prepare the data so that it can be stolen later. <br><br>  This PoS malware is only interested in two processes called ‚Äúspcwin.exe‚Äù and ‚Äúbrain.exe‚Äù.  If none of them is detected, then the ‚Äúscrapping‚Äù will not be performed. <br><br><img src="https://habrastorage.org/files/01e/0c9/cf2/01e0c9cf2ad3468c8cee5456a45c07a6.png"><br><br><h4>  <b>Data exfiltration</b> </h4><br>  Exfiltration is performed during DNS queries (UDP, port 53) from procedure 00402C40, as shown in the following pseudocode: <br><br><img src="https://habrastorage.org/files/c2a/91c/4d1/c2a91c4d177248bb8ff8ac7081364d0f.png"><br><br>  Apparently, information leakage is carried out at three different points (two procedures) from the program: <br><br><img src="https://habrastorage.org/files/8bb/342/6e8/8bb3426e8dc74d79aa70b3786ec1e92f.png"><br><br>  In the first procedure (address 00401DA0), the ‚Äúinstall.‚Äù Subdomain is used for the stolen information.  In the second procedure (address 00402580), the ‚Äúlog.‚Äù Subdomain is used for this. <br><br>  In these exfiltration procedures, we find various references to functions that encode information using "base32".  This is due to the fact that in order to steal information from a bank card, it is first encrypted using "base32", and then DNS requests are made in the format: install. &lt;Base32_CCs&gt; .domain <br><br><h4>  <b>Network information</b> </h4><br>  Apparently, the domain for the sample: <b>dojfgj.com</b> <br>  Whois Information: <br>  Domain Name: DOJFGJ.COM <br>  Registry Domain ID: 1979271903_DOMAIN_COM-VRSN <br>  Registrar WHOIS Server: whois.enom.com <br>  Registrar URL: <a href="http://www.enom.com/">www.enom.com</a> <br>  Updated Date: 2015-11-13T07: 16: 58.00Z <br>  Creation Date: 2015-11-13T15: 16: 00.00Z <br>  Registrar Registration Expiration Date: 2016-11-13T15: 16: 00.00Z <br>  Registrar: ENOM, INC. <br>  Registrar IANA ID: 48 <br>  Reseller: NAMECHEAP.COM <br>  Domain Status: ok <a href="https://www.icann.org/epp">www.icann.org/epp#ok</a> <br>  Registry Registrant ID: <br>  Registrant Name: WHOISGUARD PROTECTED <br>  Registrant Organization: WHOISGUARD, INC. <br>  Registrant Street: PO BOX 0823-03411 <br>  Registrant City: PANAMA <br>  Registrant State / Province: PANAMA <br>  Registrant Postal Code: 00000 <br>  Registrant Country: PA <br>  Registrant Phone: +507.8365503 <br>  Registrant Phone Ext: <br>  Registrant Fax: +51.17057182 <br>  Registrant Fax Ext: <br>  Registrant Email: CC7F8D40E4FA4188AE5EA89A35925E6B.PROTECT@WHOISGUARD.COM <br>  Registry Admin ID: <br>  Admin Name: WHOISGUARD PROTECTED <br>  Admin Organization: WHOISGUARD, INC. <br>  Admin Street: PO BOX 0823-03411 <br>  Admin City: PANAMA <br>  Admin State / Province: PANAMA <br>  Admin Postal Code: 00000 <br>  Admin Country: PA <br>  Admin Phone: +507.8365503 <br>  Admin Phone Ext: <br>  Admin Fax: +51.17057182 <br>  Admin Fax Ext: <br>  Admin Email: CC7F8D40E4FA4188AE5EA89A35925E6B.PROTECT@WHOISGUARD.COM <br>  Registry Tech ID: <br>  Tech Name: WHOISGUARD PROTECTED <br>  Tech Organization: WHOISGUARD, INC. <br>  Tech Street: PO BOX 0823-03411 <br>  Tech City: PANAMA <br>  Tech State / Province: PANAMA <br>  Tech Postal Code: 00000 <br>  Tech Country: PA <br>  Tech Phone: +507.8365503 <br>  Tech Phone Ext: <br>  Tech Fax: +51.17057182 <br>  Tech Fax Ext: <br>  Tech Email: CC7F8D40E4FA4188AE5EA89A35925E6B.PROTECT@WHOISGUARD.COM <br>  Name Server: NS1.DOJFGJ.COM <br>  Name Server: NS2.DOJFGJ.COM <br><br>  If we analyze this domain, we can see that it leads to the internal IP address "192.168.0.3".  The domain is associated with two DNS servers.  To get their current addresses, we need to do a ‚Äúwhois‚Äù: <br><br>  $ whois ns2.dojfgj.com <br>  Server Name: NS1.DOJFGJ.COM <br>  IP Address: 104.156.246.159 <br><br>  <b>The ‚Äútraceroute‚Äù command of this IP address shows us its origin:</b> <br><br>  $ traceroute 104.156.246.159 <br>  traceroute to 104.156.246.159 (104.156.246.159), 30 hops max, 60 byte packets <br>  1 104.131.0.253 (104.131.0.253) 0.423 ms 104.131.0.254 (104.131.0.254) 0.404 ms 0.437 ms <br>  2 162.243.188.229 (162.243.188.229) 0.422 ms 0.394 ms 162.243.188.241 (162.243.188.241) 0.293 ms <br>  3 xe-0-9-0-17.r08.nycmny01.us.bb.gin.ntt.net (129.250.204.113) 3.503 ms 4.078 ms 4.102 ms <br>  4 ae-2.r25.nycmny01.us.bb.gin.ntt.net (129.250.3.97) 1.160 ms ae-3.r25.nycmny01.us.bb.gin.ntt.net (129.250.6.208) 1.226 ms 1.171 ms <br>  5 ae-9.r22.asbnva02.us.bb.gin.ntt.net (129.250.2.149) 6.985 ms 6.926 ms 7.013 ms <br>  6 ae-0.r23.asbnva02.us.bb.gin.ntt.net (129.250.3.85) 6.952 ms 7.091 ms 7.057 ms <br>  7 ae-1.r20.miamfl02.us.bb.gin.ntt.net (129.250.2.87) 42.672 ms 33.314 ms 33.257 ms <br>  8 ae-1.r05.miamfl02.us.bb.gin.ntt.net (129.250.2.185) 35.530 ms 35.327 ms 38.280 ms <br>  9 xe-0-6-0-0.r05.miamfl02.us.ce.gin.ntt.net (129.250.207.174) 32.063 ms 31.912 ms 31.755 ms <br>  ten * * * <br>  11 104.156.246.159.vultr.com (104.156.246.159) 33.398 ms 31.757 ms 32.283 ms <br><br>  <b>As we can see, it corresponds to an Internet provider in Miami, which manages a range of IP addresses:</b> <br><br>  NetRange: 104.156.244.0 - 104.156.247.255 <br>  CIDR: 104.156.244.0/22 <br>  NetName: NET-104-156-244-0-22 <br>  NetHandle: NET-104-156-244-0-1 <br>  Parent: CHOOPA (NET-104-156-224-0-1) <br>  NetType: Reassigned <br>  OriginAS: <br>  Organization: Vultr Holdings, LLC (VHL-57) <br><br><h4>  <b>Vitality</b> </h4><br>  In order to remain ‚Äúrobust‚Äù in the system (Windows PoS), the malware being analyzed automatically installs itself as a service and selects the name ‚ÄúWindows Module Extension‚Äù, as seen in the following screenshot (procedure 00406C20): <br><br><img src="https://habrastorage.org/files/960/41b/af0/96041baf07bd4c5fa5c3481341ca41bf.png"><br><br>  The hacker can make exceptions while he is registering himself as a service: he checks the current region using ‚Äúipinfo.io‚Äù and depending on the answer the system can register as a service or not.  This is especially useful if a hacker, for example, wants to avoid performing an attack on PoS systems in certain countries. <br><br>  The malicious program accepts "i" as a parameter (from "install"), in this case it sets the "scrapping" process and sends the stolen information. <br><br><img src="https://habrastorage.org/files/d53/d6a/8fb/d53d6a8fb9ea43d1bb30b3da8c7afba7.png"><br><br>  If this parameter is not specified (‚Äúi‚Äù), and in the event that the ‚Äúspcwin.exe‚Äù or ‚Äúbrain.exe‚Äù processes are not found, the service will not be installed, and in addition to this, the malicious program will be automatically destroyed.  Both processes are related to PoS software. </div><p>Source: <a href="https://habr.com/ru/post/307320/">https://habr.com/ru/post/307320/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307310/index.html">How to quickly raise the management accounting system in an advertising agency from scratch and without a budget</a></li>
<li><a href="../307312/index.html">Mathematics for artificial neural networks for beginners, part 2 - gradient descent</a></li>
<li><a href="../307314/index.html">The relationship between the monetization of games and the behavior of gamers</a></li>
<li><a href="../307316/index.html">Storing the ssh config in an ansible project and solving the tunnel problem when using the relative path</a></li>
<li><a href="../307318/index.html">Web application for working with markdown notes</a></li>
<li><a href="../307324/index.html">When unit testing is really needed</a></li>
<li><a href="../307326/index.html">Project Management in L & D</a></li>
<li><a href="../307328/index.html">Systematization of publications in the web. Part 3 of 3: Strategy placement of scientific publications</a></li>
<li><a href="../307330/index.html">How to hire programmers. Interview with Katerina Gavrilova from DigitalHR</a></li>
<li><a href="../307332/index.html">Code samples from the summer school on Node.js and JavaScript in KPI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>