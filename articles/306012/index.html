<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to work from AWS Lambda with Elasticache and DynamoDB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Since February 2016, AWS Lambda has been able to access resources inside the Virtual Private Cloud , but by default all lambdas work outside of VPC. S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to work from AWS Lambda with Elasticache and DynamoDB</h1><div class="post__text post__text-html js-mediator-article">  Since February 2016, AWS Lambda has been able to access resources inside the <a href="https://aws.amazon.com/ru/blogs/aws/new-access-resources-in-a-vpc-from-your-lambda-functions/">Virtual Private Cloud</a> , but by default all lambdas work outside of VPC.  Since this opportunity has appeared relatively recently and there are not so many articles on how to implement it, we would like to share our experience with you. <a name="habracut"></a><br><br>  We have developed a mobile application built on AWS.  The Lambda service was great for writing a small server logic, moreover, it is easily scalable. <br><br>  The lambda task was posed rather trivial: perform a query to DynamoDB and cache the most popular queries using Elasticache.  The problem we faced is related to setting up access from VPC to internal and external Amazon resources. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In our case, it was necessary to ensure the availability of the Elasticache service (in VPC) and DynamoDB (outside VPC).  To achieve this goal, a structure has been deployed in VPC, which is represented in the diagram: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/3d2/8c2/1c9/3d28c21c9425429998ff3db00a286290.png" alt="VPC block diagram"></div><br><br>  The following is an instruction on how to create such a VPC operation scheme from the AWS Console. <br><br>  <b>VPC Setup</b> <br>  First you need to create a VPC, if you have not already done so.  Create two subnets (Subnets) public and private. <br><br>  The second step is to create a routing table (Route Tables).  By default, you have already created one main table, it will serve as a private table.  It remains only to create a public table.  When creating, you must specify our VPC. <br><br>  For each subnet (public and private), select the corresponding routing table. <br><br>  Next, we create an internet gateway that will provide access to all services outside the VPC and to external addresses as a whole.  After attaching the created gateway to our VPC.  We also create a NAT gateway, which we attach to the public subnet. <br><br>  And after all it remains only to configure the routing table: <br><br><ul><li>  Create a route in a public table for the created Internet gateway.  Example: </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/files/486/62e/12c/48662e12c254496a87e0ad6e121676bf.png" alt="Public Routing Table"></div><br><br><ul><li>  Create a route in a private table for NAT.  Example: </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cb1/b1c/1b8/cb1b1c1b85f04b768741cccbd35bfb3c.png" alt="Private routing table"></div><br><br>  <b>Elasticache setup</b> <br><br>  In our example, we consider connecting Elasticache to a private subnet.  To do this, in the Elasticache panel, create a group for the private subnet (Cache Subnet Group).  And then when creating a cluster, we indicate the created group. <br><br>  After all, it remains only to find the group in the Security Groups for our VPC in the VPC panel (it is created automatically) and add a rule for the port of our cluster (the default redis is 6379; memcached is 11211).  Example: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7a6/bab/ee3/7a6babee318044729ed68883eb4202ee.png" width="370" alt="Rules for security group"></div><br><br>  Let's check how it all goes with us.  In the lambda settings, select VPC and private network.  Run the code: <br><br><pre><code class="java hljs">from __future__ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> print_function <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> boto3 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> decimal <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> elasticache_auto_discovery from pymemcache.client.hash <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> HashClient CACHE_ENDPOINTS = <span class="hljs-string"><span class="hljs-string">'exaplecache.wjbxgg.cfg.euw1.cache.amazonaws.com:11211'</span></span> <span class="hljs-function"><span class="hljs-function">def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decimal_default</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(obj)</span></span></span><span class="hljs-function">: </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isinstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(obj, decimal.Decimal)</span></span></span><span class="hljs-function">: return </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">float</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(obj)</span></span></span><span class="hljs-function"> raise TypeError def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lambda_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event, context)</span></span></span><span class="hljs-function">: nodes_endpoints </span></span>= elasticache_auto_discovery.discover(CACHE_ENDPOINTS) nodes = map(lambda x: (x[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(x[<span class="hljs-number"><span class="hljs-number">2</span></span>])), nodes_endpoints) memcache_client = HashClient(nodes, timeout=<span class="hljs-number"><span class="hljs-number">60</span></span>, connect_timeout=<span class="hljs-number"><span class="hljs-number">2</span></span>) table = boto3.resource(<span class="hljs-string"><span class="hljs-string">'dynamodb'</span></span>).Table(<span class="hljs-string"><span class="hljs-string">'Photo'</span></span>) response = table.scan(Limit=<span class="hljs-number"><span class="hljs-number">20</span></span>) memcache_client.set(<span class="hljs-string"><span class="hljs-string">'example'</span></span>, json.dumps(response[<span class="hljs-string"><span class="hljs-string">'Items'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>=decimal_default)) cache_elements = memcache_client.get(<span class="hljs-string"><span class="hljs-string">'example'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> json.loads(cache_elements) == response[<span class="hljs-string"><span class="hljs-string">'Items'</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"It works!"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Doesn't work"</span></span></code> </pre> <br><br>  And after the launch we will see the coveted result: <br><img src="https://habrastorage.org/files/fa8/810/ece/fa8810ece6364df78fd9723e217c10c6.jpg" alt="image"><br><br>  <b>Conclusion</b> <br>  Working with Amazon services inside and outside the VPC opens up many possibilities for using AWS Lambda.  The configuration scheme for VPC presented in this article can be used as a universal solution to provide access to any other services inside and outside the VPC. <br><br>  <i>Useful links:</i> <br>  <a href="http://docs.aws.amazon.com/lambda/latest/dg/vpc.html">Lambda in vpc</a> <br>  <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Subnets.html">Your VPC and Subnets</a> <br>  <a href="http://docs.aws.amazon.com/AmazonElastiCache/latest/UserGuide/GettingStarted.html">Getting Started with Amazon ElastiCache</a> </div><p>Source: <a href="https://habr.com/ru/post/306012/">https://habr.com/ru/post/306012/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306002/index.html">Tablecloths or how to deploy Remote Desktop Services on Windows Server 2012 R2</a></li>
<li><a href="../306004/index.html">How I Received a Code Signing Certificate from Comodo</a></li>
<li><a href="../306006/index.html">Composite site: Bitrix technology in each CMS</a></li>
<li><a href="../306008/index.html">Stretch the Canvas and elements inside it across the entire client area</a></li>
<li><a href="../306010/index.html">Switching from Hand Mode to Intel RealSense SDK R4 (v6.0) to Cursor Mode in Intel RealSense SDK 2016 R1</a></li>
<li><a href="../306014/index.html">Grammy Award Winner, Professional Circus and Apple Veteran Change Careers</a></li>
<li><a href="../306016/index.html">Features of installation and update 3CX v15</a></li>
<li><a href="../306018/index.html">Modern Code. Program Modern</a></li>
<li><a href="../306020/index.html">HR work in the eyes of the developer</a></li>
<li><a href="../306022/index.html">Log in to VK for people</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>