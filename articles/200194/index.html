<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work with the mdadm utility. Change array type, chunk size, extension</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 By writing this article, I was prompted by the lack of intelligible information in Russian about working with the mdadm utility, which ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work with the mdadm utility. Change array type, chunk size, extension</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  By writing this article, I was prompted by the lack of intelligible information in Russian about working with the mdadm utility, which implements various types of RAID on linux.  In principle, the main provisions of the work of this utility are covered in sufficient detail.  You can read about it, for example, <a href="http://xgu.ru/wiki/%25CF%25F0%25EE%25E3%25F0%25E0%25EC%25EC%25ED%25FB%25E9_RAID_%25E2_Linux">one</a> , <a href="http://ru.wikipedia.org/wiki/Mdadm">two</a> , <a href="http://wiki.dieg.info/mdadm">three</a> . <br><br><h4>  Convert RAID1 to RAID5 </h4><br>  The main message was the conversion of RAID1, created when installing the Ubuntu array of two disks to RAID5.  I started, as usual with googling, and came across an earlier <a href="http://habrahabr.ru/post/100952/">article on Habr√©</a> . Unfortunately, tested on virtual machines, this method guaranteed to kill the ability to boot from the root partition.  What is the reason for this, with a newer version of mdadm, or with the specifics of testing (the root partition on the array, work from the live CD is required) was not found. <br><a name="habracut"></a><br>  System version <br><pre><code class="bash hljs">root@u1:/home/alf<span class="hljs-comment"><span class="hljs-comment"># uname -a Linux u1 3.2.0-23-generic #36-Ubuntu SMP Tue Apr 10 20:39:51 UTC 2012 x86_64 x86_64 x86_64 GNU/Linux</span></span></code> </pre> <br><br>  The disk layout in my case was easier than ever, I modeled it on a test virtual machine, highlighting 20 gigs for the disks: <br><img src="https://habrastorage.org/getpro/habr/post_images/df8/708/0f3/df87080f33405003bb95bde304e3fff6.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The root partition is located on the <b>/ dev / sda2</b> <b>/ dev / sdb2</b> devices assembled into an array and has the name <b>/ dev / md0</b> in the base system.  The boot partition is located on both disks, <b>/ boot</b> to a separate disk is not allocated. <br>  In the <b>mdadm</b> version <b>v3.2.5</b> , which is installed by default in Ubuntu, the RAID conversion procedure is possible in the 1-&gt; 5 direction, and is not possible back.  It is executed by the change array <b>command ‚Äìgrow, -G</b> .  Before converting, insert a USB flash drive into the device and mount it to save the backup superblock.  In case of failures from it we will recover an array.  Mount it in <b>/ mnt / sdd1</b> <br> <code>mkdir /mnt/sdd1</code> <br> <code>mount /dev/sdd1 /mnt/sdd1</code> <br> <code>mdadm --grow /dev/md0 --level=5 --backup-file=/mnt/sdd1/backup1</code> <br> <br>  The operation usually takes place very quickly and painlessly.  It should be noted here that the resulting RAID5-type array on two disks is actually a RAID1 array, with the possibility of expansion.  It will become a full-fledged RAID5 only when adding at least one more disk. <br>  It is extremely important that our boot partition is located on this array and after a reboot, GRUB will not automatically load the modules to start.  To do this, we update the bootloader <br> <code>update-grub</code> <br> <br>  If you still forgot to do the update, and after rebooting, you received <br><pre> <code class="bash hljs">cannot load raid5rec grub rescue&gt;</code> </pre><br>  Do not despair, you just boot from the LiveCD, copy the <b>/ boot</b> directory to the USB flash drive, reboot from the main partition again to <b>grub rescue&gt;</b> and load the RAID5 module from the USB flash drive according to common instructions, for <a href="http://adw0rd.com/2010/4/5/grub-rescue/">example</a> . <br>  Add the line <b>insmod /boot/grub/raid5rec.mod</b> <br>  After downloading from the main section, do not forget to <b>update-grub</b> <br><br><h4>  RAID5 array expansion </h4><br>  Expansion of the modified array is described in all sources and is not a problem.  Do not turn off the power. <br><ol><li>  Clone the structure of an existing disk <br> <code>sfdisk ‚Äìd /dev/sda | sfdisk /dev/sdc</code> </li> <li>  Add a disk to the array <br> <code>mdadm /dev/md0 --add /dev/sdc2</code> </li> <li>  Expand array <br> <code>mdadm --grow /dev/md0 --raid-device=3 --backup-file=/mnt/sdd1/backup2</code> </li> <li>  We are waiting for the end of reconfiguration and watch the process <br> <code>watch cat /proc/mdstat</code> </li> <li>  Installing the boot sector on a new disk <br> <code>grub-install /dev/sdc</code> </li> <li>  Update the bootloader <br> <code>update-grub</code> </li> <li>  Expanding free space to the maximum, works on a live and mounted partition. <br> <code>resize2fs /dev/md0</code> </li> <li>  We look at the resulting array <br> <code>mdadm --detail /dev/md0</code> </li> <li>  We look at the free space <br> <code>df -h</code> </li> </ol><br><br><h4>  Changing the Chunk Size of an existing RAID5 array </h4><br>  There is no <b>Chunk Size</b> concept in RAID1 because  This is the block size, which in turn is written to different disks.  When converting an array type to RAID5, this parameter appears in the output of detailed information about the array: <br><pre> <code class="bash hljs">Mdadm ‚Äìdetail /dev/md0 /dev/md0: Version : 1.2 Creation Time : Tue Oct 29 03:57:36 2013 Raid Level : raid5 Array Size : 20967352 (20.00 GiB 21.47 GB) Used Dev Size : 20967352 (20.00 GiB 21.47 GB) Raid Devices : 2 Total Devices : 2 Persistence : Superblock is persistent Update Time : Tue Oct 29 04:35:16 2013 State : clean Active Devices : 2 Working Devices : 2 Failed Devices : 0 Spare Devices : 0 Layout : left-symmetric Chunk Size : 8K Name : u1:0 (<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> to host u1) UUID : cec71fb8:3c944fe9:3fb795f9:0c5077b1 Events : 20 Number Major Minor RaidDevice State 0 8 2 0 active sync /dev/sda2 1 8 18 1 active sync /dev/sdb2</code> </pre><br><br>  In this case, the chunk size is selected according to the rule: The largest common divisor of the array size (in our case, 20967352K) and the maximum automatically set chunk size (which is 64K).  In my case, the maximum chunk size is 8K (20967352/8 = 2620919 is not divided further by 2). <br><br>  If you plan to add disks in the future, increasing the size of the array, then you should change the size of the chunk at some point.  About performance you can read an interesting <a href="https://romanrm.net/mdadm-raid">article</a> . <br>  To change the chunk parameter in an array, you must align its size with the multiplier.  Before this, it is important to change the partition size, since  if you cut through the live maximum partition, you will most likely wipe the superblock of the partition, and are guaranteed to corrupt the file system. <br><br>  How to calculate the necessary partition size for the chunk size you need?  We take the maximum current size of the partition in kilobytes <br> <code>mdadm --detail /dev/md0 | grep Array</code> <br>  We divide completely into the <b>chunk</b> size we need and (the number of disks in the array is 1, for RAID5).  The resulting number is again multiplied by the <b>chunk</b> size and by (the number of disks in the array is -1), and the result will be the partition size we need. <br>  (41934704/256) / 2 = 81903;  81903 * 256 * 2 = 41934336 <br><br>  It is impossible to reduce the size of the partition to a working, mounted partition, and since it is our root, we reboot from any LiveCD (I like <a href="">RescueCD</a> , it loads <b>mdadm</b> automatically) <br><ol><li>  We check the running arrays <br> <code>Cat /proc/mdstat</code> <br>  We discover that our array is in RO mode <br><img src="https://habrastorage.org/getpro/habr/post_images/a5b/739/b72/a5b739b72498df50cf5b6804c1538c86.png"></li><li>  We rebuild it as usual <br> <code>Mdadm --stop /dev/md127</code> <br> <code>Mdadm --assemble --scan</code> <br> <img src="https://habrastorage.org/getpro/habr/post_images/e54/e77/3c5/e54e773c5c14a9eabdb574785486dd7c.png"></li><li>  We perform an array check for errors with autocorrection <br> <code>e2fsck -f /dev/md127</code> </li> <li>  We change the size of the active partition by specifying <b>-S 256</b> as the parameter so that the utility understands that this partition will be located on the RAID array and add the letter K to the end of the new size of the array so that the utility does not count this number as the number of blocks <br> <code>resize2fs -p S 256 /dev/md127 41934336K</code> </li> <li>  To resize the array, use again the <b>--grow</b> parameter in the <b>mdadm</b> utility.  It is necessary to take into account that the array changes on each disk, and therefore in the parameters we indicate not the total required size of the array, but the size of the array on each disk, respectively, it is necessary to divide by (the number of disks in the array -1).  The operation is instantaneous <br> <code>41934336/2=20967168</code> <br> <code>mdadm --grow /dev/md127 --size=20967168</code> </li> <li>  Reboot to normal mode, change the chunk size, remembering to pre-mount the USB flash drive for the superblock backup, and wait for the array to re-synchronize. <br> <code>mdadm --grow /dev/md0 --chunk=256 --backup-file=/mnt/sdd1/backup3</code> <br> <code>watch cat /proc/mdstat</code> </li> </ol><br>  The operation is long, much longer than adding a disc, prepare to wait.  Power, as usual, can not be turned off. <br><br><h4>  Array recovery </h4><br>  If at some stage of working with the array via mdadm you had a failure, then to restore the array from the backup (did you remember to specify the file for the backup?) You need to boot from the liveCD and rebuild the array again indicating the correct sequence of disks included in array and an indication of the superblock to load <br> <code>mdadm --assemble /dev/md0 /dev/sda2 /dev/sdb2 /dev/sdc2 --backup-file=/mnt/sdd1/backup3</code> <br>  In my case, the last operation to change the <b>chunk</b> array transferred it to the <b>* reshape state</b> , however, the reassembly process itself did not start for a long time.  I had to reboot from the liveCD and restore the array.  After that, the process of rebuilding the array started, and at the end of it, the <b>Chunk Size</b> size was already new, 256K. <br><br><h4>  Conclusion </h4><br>  I hope this article will help you to change your home storage systems painlessly, and maybe someone will suggest that the mdadm utility is not as incomprehensible as it seems. <br><br><h4>  Additionally read </h4><br>  <a href="http://www.spinics.net/lists/raid/msg36182.html">www.spinics.net/lists/raid/msg36182.html</a> <br>  <a href="http://www.spinics.net/lists/raid/msg40452.html">www.spinics.net/lists/raid/msg40452.html</a> <br>  <a href="http://enotty.pipebreaker.pl/2010/01/30/zmiana-parametrow-md-raid-w-obrazkach/">enotty.pipebreaker.pl/2010/01/30/zmiana-parametrow-md-raid-w-obrazkach</a> <br>  <a href="http://serverhorror.wordpress.com/2011/01/27/migrating-raid-levels-in-linux-with-mdadm/">serverhorror.wordpress.com/2011/01/27/migrating-raid-levels-in-linux-with-mdadm</a> <br>  <a href="http://lists.debian.org/debian-kernel/2012/09/msg00490.html">lists.debian.org/debian-kernel/2012/09/msg00490.html</a> <br>  <a href="http://www.linux.org.ru/forum/admin/9549160">www.linux.org.ru/forum/admin/9549160</a> <br>  For special gourmet <a href="http://fossies.org/dox/mdadm-3.3/Grow_8c_source.html">fossies.org/dox/mdadm-3.3/Grow_8c_source.html</a> </div><p>Source: <a href="https://habr.com/ru/post/200194/">https://habr.com/ru/post/200194/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../200168/index.html">Working with SQL Server in Hybrid Cloud Scripts</a></li>
<li><a href="../200172/index.html">USB support in KolibriOS: what's inside? Part 5: logic level</a></li>
<li><a href="../200180/index.html">FSB does not classify Google Glass as special tools.</a></li>
<li><a href="../200190/index.html">How I filled up an interview on Twitter</a></li>
<li><a href="../200192/index.html">Development of client-server infrastructure in javascript (part 1 - client)</a></li>
<li><a href="../200196/index.html">IPTV on Android</a></li>
<li><a href="../200198/index.html">Why I refused to use Smarty</a></li>
<li><a href="../200200/index.html">Analogue ambilight from LED strip WS2812, arduino and kinder surprise</a></li>
<li><a href="../200202/index.html">Personnel crisis or how we were looking for a programmer</a></li>
<li><a href="../200208/index.html">New Impress Application Server Functionality for Node.js</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>