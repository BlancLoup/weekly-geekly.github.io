<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The experience of identifying one bug or how not to make out your code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At once I will state that nothing innovative is proposed in the article. I just describe one small case of working with someone else's code. Experienc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The experience of identifying one bug or how not to make out your code</h1><div class="post__text post__text-html js-mediator-article">  At once I will state that nothing innovative is proposed in the article.  I just describe one small case of working with someone else's code.  Experienced developers, perhaps, will smile, for surely they themselves came across this, and maybe even worse.  Those for whom this is all new, please take note of how not to draw up your code, especially if we are talking about a public plugin.  The article further describes how to work with an outsider plugin for wordpress.  After my ‚Äúadventures‚Äù I really do not want to mention the name of the plugin in any way, so in the pieces of the source code I changed the name of variables, functions, in order to exclude the possibility of referring to the plugin as much as possible. <br><a name="habracut"></a><br>  Often I see how people speak badly about php-programmers and about php in general as a programming language.  I myself did not encounter language problems - I write small projects for myself, I don‚Äôt use third-party frameworks and enjoy life.  Sometimes make familiar with the requests.  If the task is interesting or just low-cost, then usually I do not refuse.  And an acquaintance asked me to see why the autoposting plugin on various social networks does not work with Instagram as it should.  Without thinking for a long time, I figured that there is nothing difficult in this - I‚Äôll open the sublime text, download the source code for the plugin, search for the posting code on Instagram and correct what I need, but it wasn‚Äôt there ... <br><br>  I set up FtpSync, downloaded the plug-in folder, opened the file suitable for the name and saw something like this: <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!function_exists(<span class="hljs-string"><span class="hljs-string">'CutFromTo'</span></span>)){ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CutFromTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($string, $from, $to)</span></span></span></span>{$fstart = stripos($string, $from); $tmp = substr($string,$fstart+strlen($from)); $flen = stripos($tmp, $to); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> substr($tmp,<span class="hljs-number"><span class="hljs-number">0</span></span>, $flen);}}</code> </pre> <br>  That's right: several operations in one line file with a total number of lines more than a thousand.  Then I realized that the case was bad and opened phpstorm, through Tools -&gt; Deployment I set up access to ftp.  Then, using Ctrl + Shift + Alt + L, I put the code in order and it became more readable: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!function_exists(<span class="hljs-string"><span class="hljs-string">'CutFromTo'</span></span>)) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CutFromTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($string, $from, $to)</span></span></span><span class="hljs-function"> </span></span>{ $fstart = stripos($string, $from); $tmp = substr($string, $fstart + strlen($from)); $flen = stripos($tmp, $to); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> substr($tmp, <span class="hljs-number"><span class="hljs-number">0</span></span>, $flen); } }</code> </pre><br>  The problem with the plug-in was that when posting a picture, an error was displayed instead of the header with an approximate content ‚ÄúCan not upload image to / tmp / FILE_NAME‚Äù, but the picture was successfully filled.  Searching through files (Ctrl + Shift + F) I quickly got to the only place in the code where such text is used.  (By the way, a similar error text with different variations of the statement of words in the sentence was in different places of the code. The developers should have put the text into a constant or created a function to get different variations depending on the parameters. In general, the presence of copy / paste programming.) <br><br>  My friend tried to google the error and even found a user‚Äôs topic on the plugin‚Äôs authors ‚Äôforum with the same problem.  Representatives of the plugin clearly tried to explain that a person should understand php better, indicated that their code uses only system functions and the problem is not on their side, by offering to read the FAQ.  In general, support is low. <br><br>  By a simple test of adding a word to a string, I tried to make sure that the function that I found in the code is being called, but no.  After a little surprise, I began to track the call chain when I pressed the button.  In exactly the same negligently formatted javascript code, I found which action is sent via ajax, again, by searching, I found a place in the php code and using <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> ‚Äúaga‚Äù;</code> </pre><br>  I constantly checked that I was moving the right way until I came to this place in the code: <br><br><pre> <code class="php hljs">$nt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SomeClass(); $nt-&gt;debug = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($options[<span class="hljs-string"><span class="hljs-string">'ck'</span></span>])) $nt-&gt;ck = $options[<span class="hljs-string"><span class="hljs-string">'ck'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($options[<span class="hljs-string"><span class="hljs-string">'proxy'</span></span>]) &amp;&amp; !<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($options[<span class="hljs-string"><span class="hljs-string">'proxyOn'</span></span>])) { $nt-&gt;proxy[<span class="hljs-string"><span class="hljs-string">'proxy'</span></span>] = $options[<span class="hljs-string"><span class="hljs-string">'proxy'</span></span>][<span class="hljs-string"><span class="hljs-string">'proxy'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($options[<span class="hljs-string"><span class="hljs-string">'proxy'</span></span>][<span class="hljs-string"><span class="hljs-string">'up'</span></span>])) $nt-&gt;proxy[<span class="hljs-string"><span class="hljs-string">'up'</span></span>] = $options[<span class="hljs-string"><span class="hljs-string">'proxy'</span></span>][<span class="hljs-string"><span class="hljs-string">'up'</span></span>]; }; $loginErr = $nt-&gt;connect($options[<span class="hljs-string"><span class="hljs-string">'uName'</span></span>], $pass); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$loginErr) $ret = $nt-&gt;post($msg, $imgURL, $options[<span class="hljs-string"><span class="hljs-string">'imgAct'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $badOut[<span class="hljs-string"><span class="hljs-string">'Error'</span></span>] .= <span class="hljs-string"><span class="hljs-string">'Something went wrong - '</span></span> . print_r($loginErr, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $ret = $badOut; }</code> </pre><br>  Separately, a picture from phpstorm ide: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/077/270/c2e/077270c2e1344d53d547ee8aaba5a050.png" alt="image"><br><br>  So I came to an undeclared class.  First of all I downloaded from the server all the other sources of the engine and plug-ins and searched all the files and tried to find the definition of the class.  I was quite surprised when nothing was found.  In other words, posting a picture takes place in a class that is not in the source code. <br><br>  I asked a friend what kind of plugin it is, as a result of which it turned out that the plugin is public, specifically this modification (posting on Instagram) is paid for in it and its developers are Hindus.  All other social networks work well.  My surprise from what was happening only intensified, but okay. <br><br>  The following code: <br><br><pre> <code class="php hljs">$reflector = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReflectionClass(<span class="hljs-string"><span class="hljs-string">'SomeClass'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $reflector-&gt;getFileName();</code> </pre><br>  I got to the file in a different plugin and in the indicated line of code I found the call to the 'eval' function: <br><br><pre> <code class="php hljs">$t = get_site_option(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;c); $d = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;k . <span class="hljs-string"><span class="hljs-string">'decode'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($t)) { $t = $d($t); <span class="hljs-keyword"><span class="hljs-keyword">eval</span></span>($t); }</code> </pre><br>  A plugin with such a function is a paid add-on for connecting Instagram as well.  The source code for working with ‚Äúpremium‚Äù networks is stored in the database and is loaded from the database with the help of 'eval' each time it is loaded. <br><br>  Finally, I got to the code in which the output is not an actual error, now I had to open the code in phpstorm for further analysis, for which I just wrote the code from the database to a file and in order to change something I do require instead of eval: <br><br><pre> <code class="php hljs">$t = get_site_option(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;c); $fileName = $path . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;c . <span class="hljs-string"><span class="hljs-string">'.php'</span></span>; $d = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;k . <span class="hljs-string"><span class="hljs-string">'decode'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($t)) { $t = $d($t); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file_exists($fileName)) { <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> $fileName; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">eval</span></span>($t); file_put_contents($fileName, <span class="hljs-string"><span class="hljs-string">"&lt;?php $t ?&gt;"</span></span>); } }</code> </pre><br>  The plugin provides for the intermediate saving of the published image in the / tmp folder in the system, and if it does not work out, then in the WordPress folder for downloads.  The line with the error is used in several places of the code and the rest of the code for writing and checking for writing in different temporary folders, the developers simply copied and slightly modified the error text.  Actually, only the file saving error was recorded in the variable: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_writebale($path)) { $variable = ‚Äúcan not upload image from /tmp/FILENAME‚Äù; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!tryToSaveImageInWordpressFolder()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $variable; } }</code> </pre><br>  It is not clear for what reasons the same variable was later used in the code for the caption attribute when posting to an instagram: <br><br><pre> <code class="php hljs">sendImageToInstagram(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'caption'</span></span> =&gt; $variable));</code> </pre><br>  Changed the variable and ready.  5 minutes to identify and fix the bug and about 2 hours to find the location of the necessary code with the specified bug. <br><br>  Perhaps, it would be necessary to draw some conclusions from the whole situation.  In fact, there is no high morality in this.  After the "adventures" I just wanted to share.  So as I wrote in the introduction, this is just a small story from my experience with someone else's code, bad code.  Hopefully, the story still smiled at someone, someone might have noticed something new in the approach of analyzing someone else's code, and someone may have taken a note of how best to design their code. <br><br>  In the process of analysis, I ran into a variety of stamp problems, the most basic of which are: <br><br><ul><li>  ridiculous code design: several operations in one line, </li><li>  active use of copy / paste programming, </li><li>  using the same variable for different purposes, which was the final bug, </li><li>  Another big reading problem was in the concatenation of function names when the name of the called function from several lines is collected ($ func = $ prefix. "_". $ name) is flexible, yes, but in the future using, for example, Alt + F7 in ide loses the ability to track the use of such functions and increases the difficulty of reading, I would recommend using switch and constants. </li></ul><br>  There were many other minor omissions that made the code a little more unreadable for outsiders.  The biggest problem is that php syntax allows you to do all this and people, unfortunately, use this freedom for other purposes.  I understand that the developers, keeping the source code in the database of the engine for which they are taking money, thus tried to make it less accessible, but this is an extremely wrong approach.  The most banal argument: based on my experience, this approach did not work - I still got to paid sources without too much difficulty, but because of the time I wasted, my desire to distribute this paid code for free only intensified, and so it was zero.  Thoughts even appeared to write your own plugin with exactly the same functionality in order to deliberately compete with developers.  In general, if you still can't hide the source, then make it readable for other developers.  This definitely will not negatively affect your profitability, but it will very well affect your reputation and will only increase your ability to earn more in the future. </div><p>Source: <a href="https://habr.com/ru/post/342670/">https://habr.com/ru/post/342670/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342654/index.html">Self-oscillations and resonance</a></li>
<li><a href="../342658/index.html">What happens in Kubernetes when starting the kubectl run? Part 1</a></li>
<li><a href="../342660/index.html">UniRx - Rx for Unity3d</a></li>
<li><a href="../342666/index.html">Facebook or Google? Where it is more profitable to advertise in 2017</a></li>
<li><a href="../342668/index.html">How to write your first Linux device driver. Part 3</a></li>
<li><a href="../342674/index.html">About the rotation matrix in simple words</a></li>
<li><a href="../342676/index.html">Detailed analysis of the crackme01_x64 solution</a></li>
<li><a href="../342680/index.html">‚ÄúLike a ram on a new gate‚Äù or custom ‚Äúpseudo-3D‚Äù objects in NanoCAD using the MultiCAD.NET API</a></li>
<li><a href="../342684/index.html">Glass brick fences, online translator plot, remote Boeing hacking</a></li>
<li><a href="../342686/index.html">Optimize frontend. Part 1. Why I don‚Äôt like the word treeshaking or where the webpack deceives you</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>